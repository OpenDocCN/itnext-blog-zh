<html>
<head>
<title>Wiring up an API server with Express and Swagger</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Express和Swagger连接API服务器</h1>
<blockquote>原文：<a href="https://itnext.io/wiring-up-an-api-server-with-express-and-swagger-9bffe0a0d6bd?source=collection_archive---------1-----------------------#2018-08-09">https://itnext.io/wiring-up-an-api-server-with-express-and-swagger-9bffe0a0d6bd?source=collection_archive---------1-----------------------#2018-08-09</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><figure class="iq ir gq gs is it gi gj paragraph-image"><div role="button" tabindex="0" class="iu iv di iw bf ix"><div class="gi gj ip"><img src="../Images/8d4b780bb448e030e57d225f48d21108.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*29pH8VLfrb6xVR_Biiq5kg.jpeg"/></div></div><figcaption class="ja jb gk gi gj jc jd bd b be z dk translated">我给我的家用电脑编程。把自己传送到未来。(作者图片。)</figcaption></figure><div class=""/><p id="b93a" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated"><code class="fe lb lc ld le b"><a class="ae lf" href="https://expressjs.com" rel="noopener ugc nofollow" target="_blank">ExpressJS</a></code>是使用<code class="fe lb lc ld le b">NodeJS</code>编写API服务器的首选框架，<code class="fe lb lc ld le b"><a class="ae lf" href="https://swagger.io" rel="noopener ugc nofollow" target="_blank">Swagger</a></code>是一种出色的方式来指定API的细节，允许您使用一系列方便的工具来确保API的一致性、文档化和可测试性。</p><p id="6884" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">为了避免重复，最好也使用API的Swagger定义来告诉Express如何将传入路径映射到路由控制器函数。</p><p id="9d62" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">为了让这变得简单，我写了一个名为<code class="fe lb lc ld le b"><a class="ae lf" href="https://www.npmjs.com/package/swagger-routes-express" rel="noopener ugc nofollow" target="_blank">swagger-routes-express</a></code>的小软件包(最近更新，除了<code class="fe lb lc ld le b">Swagger 2</code>之外，还支持<code class="fe lb lc ld le b"> OpenAPI 3</code>)。</p><h1 id="4f33" class="lg lh jg bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">例子</h1><p id="cb9c" class="pw-post-body-paragraph kd ke jg kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ik bi translated">下面是一个用Swagger在文件<code class="fe lb lc ld le b">my-api.yml</code>中定义的简单API，该文件位于项目的根目录下。</p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="0b00" class="mr lh jg le b gz ms mt l mu mv">swagger: "2.0"<br/>info:<br/>  description: Something about the API<br/>  version: "1.0.0"<br/>  title: My Cool API<br/>basePath: "/api/v1"<br/>schemes:<br/>  - "https"<br/>paths:<br/>  /ping:<br/>    get:<br/>      tags:<br/>        - "root"<br/>      summary: "Get Server Information"<br/>      operationId: "ping"<br/>      produces:<br/>      - "application/json"<br/>      responses:<br/>        200:<br/>          description: "success"<br/>          schema:<br/>            $ref: "#/definitions/ServerInfo"<br/>definitions:<br/>  ServerInfo:<br/>    type: "object"<br/>    properties:<br/>      name:<br/>        type: "string"<br/>      description:<br/>        type: "string"<br/>      version:<br/>        type: "string"<br/>      uptime:<br/>        type: "number"</span></pre><p id="eeb8" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">有一条路径<code class="fe lb lc ld le b">GET /ping</code>，它返回一个<code class="fe lb lc ld le b">JSON</code>响应:</p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="f024" class="mr lh jg le b gz ms mt l mu mv">{<br/>  "name": "My Cool API",<br/>  "description": "Something about the API",<br/>  "version": "1.0.0",<br/>  "uptime": 101<br/>}</span></pre><p id="35a3" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">Swagger doc为名为<code class="fe lb lc ld le b">‘ping’</code>的<code class="fe lb lc ld le b">GET /ping</code>路线定义了一个<code class="fe lb lc ld le b">operationId</code>。</p><p id="dba5" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">在我们服务器的<code class="fe lb lc ld le b">src</code>文件夹中，我们将如下定义<code class="fe lb lc ld le b">ping</code>控制器</p><p id="c222" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated"><code class="fe lb lc ld le b">src/api/ping.js</code></p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="a76a" class="mr lh jg le b gz ms mt l mu mv">const {<br/>  name,<br/>  version,<br/>  description<br/>} = require('../../package.json')</span><span id="ac8e" class="mr lh jg le b gz mw mt l mu mv">const ping = (req, res) =&gt; {<br/>  res.json({<br/>    name,<br/>    description,<br/>    version,<br/>    uptime: process.uptime()<br/>  })<br/>}</span><span id="34bb" class="mr lh jg le b gz mw mt l mu mv">module.exports = ping</span></pre><p id="83c4" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">在<code class="fe lb lc ld le b">src/api/index.js</code>中，我们将确保它被导出:</p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="c926" class="mr lh jg le b gz ms mt l mu mv">const ping = require('./ping')<br/>module.exports = { ping }</span></pre><p id="3f88" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">定义一个<code class="fe lb lc ld le b">async</code>函数来创建和配置Express应用程序本身。</p><p id="e37a" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">这将使用<code class="fe lb lc ld le b"><a class="ae lf" href="https://www.npmjs.com/package/swagger-parser" rel="noopener ugc nofollow" target="_blank">swagger-parser</a></code>库来解析我们的swagger api <code class="fe lb lc ld le b">YAML</code>文件(因此需要成为<code class="fe lb lc ld le b">async</code>)，并将解析后的信息传递给<code class="fe lb lc ld le b">swaggerRouter</code>进行配置。</p><p id="c290" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated"><code class="fe lb lc ld le b">src/makeApp.js</code></p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="c897" class="mr lh jg le b gz ms mt l mu mv">const express = require('express')<br/>const SwaggerParser = require('swagger-parser')<br/>const swaggerRoutes = require('swagger-routes-express')<br/>const api = require('./api')</span><span id="d516" class="mr lh jg le b gz mw mt l mu mv">const makeApp = async () =&gt; {<br/>  const parser = new SwaggerParser()<br/>  const apiDescription = await parser.validate('my-api.yml')<br/>  const connect = swaggerRoutes(api, apiDescription)</span><span id="42fa" class="mr lh jg le b gz mw mt l mu mv">  const app = express()<br/>  // do any other app stuff,<br/>  // such as wire in passport, use cors etc.</span><span id="2e76" class="mr lh jg le b gz mw mt l mu mv">  // then connect the routes<br/>  <strong class="le jh">connect</strong>(app)</span><span id="ba1e" class="mr lh jg le b gz mw mt l mu mv">  // add any error handlers last<br/>  return app<br/>}</span><span id="e5d6" class="mr lh jg le b gz mw mt l mu mv">module.exports = makeApp</span></pre><p id="8069" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">在<code class="fe lb lc ld le b">src/index.js</code>中，我们启动服务器:</p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="afe7" class="mr lh jg le b gz ms mt l mu mv">const makeApp = require('./makeApp')</span><span id="c3a2" class="mr lh jg le b gz mw mt l mu mv">makeApp()<br/>  .then(app =&gt; app.listen(3000))<br/>  .then(() =&gt; {<br/>    console.log('Server started')<br/>  })<br/>  .catch(err =&gt; {<br/>    console.error('caught error', err)<br/>  })</span></pre><p id="10f0" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">瞧——运行它，对<code class="fe lb lc ld le b"> GET /ping</code>的调用将调用<code class="fe lb lc ld le b">ping</code>控制器。</p><h1 id="3675" class="lg lh jg bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">添加特定于路由的安全中间件</h1><p id="6997" class="pw-post-body-paragraph kd ke jg kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ik bi translated">大多数API需要为特定的路由添加某种级别的身份验证和访问控制。在Swagger文档中，您可以逐个路径地添加安全信息。</p><p id="7481" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">向Swagger文档添加一个<code class="fe lb lc ld le b">GET /api/v1/things</code>路径:</p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="4ae1" class="mr lh jg le b gz ms mt l mu mv">/things:<br/>  get:<br/>    summary: "Find things"<br/>    description: "Returns a list of things"<br/>    operationId: "v1/things/listThings"<br/>    produces:<br/>    - "application/json"<br/>    responses:<br/>      200:<br/>        description: "success"<br/>        schema:<br/>          $ref: "#/definitions/ArrayOfThings"<br/>    security:<br/>    - slack:<br/>      - "identity.basic"<br/>      - "identity.email"</span></pre><p id="b5ad" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">在实际的应用程序中，您需要添加<code class="fe lb lc ld le b">ArrayOfThings</code>的定义和安全定义，但是为了简洁起见，忽略它们。</p><p id="8295" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">给<code class="fe lb lc ld le b">src/api/index.js</code>增加一个<code class="fe lb lc ld le b">listThings</code>控制器，将<code class="fe lb lc ld le b">v1/things/listThings</code>映射到<code class="fe lb lc ld le b">v1_things_listThings</code>(你可以通过<code class="fe lb lc ld le b">option</code>改变<code class="fe lb lc ld le b">pathSeparator</code>，见下文)。</p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="2000" class="mr lh jg le b gz ms mt l mu mv">const ping = require('./ping')<br/>const v1_things_listThings = require('./v1/things/listThings')</span><span id="262d" class="mr lh jg le b gz mw mt l mu mv">module.exports = { ping, v1_things_listThings }</span></pre><p id="dfc4" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">您需要告诉<code class="fe lb lc ld le b">swaggerRouter</code>如何将文档中定义的安全范围与实际的认证中间件相关联。通常你会使用passport来建立基于标准的认证中间件，但是最终中间件只是一个带有<code class="fe lb lc ld le b">req, res, next</code>签名的函数。让我们在<code class="fe lb lc ld le b">src/auth/isAllowed.js</code>中定义一个，它只是在标准的<code class="fe lb lc ld le b">Authorization</code>请求头中查找文本<code class="fe lb lc ld le b">'LET THE RIGHT ONE IN'</code>。</p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="58f6" class="mr lh jg le b gz ms mt l mu mv">module.exports = (req, res, next) =&gt; {<br/>  if (req.get('authorization') === 'LET THE RIGHT ONE IN') {<br/>    return next()<br/>  }<br/>  return res.status(401).end()<br/>}</span></pre><p id="3e24" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">现在，在我们的makeApp函数中，我们需要向<code class="fe lb lc ld le b">swaggerRouter</code>传递一些选项。</p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="7d7e" class="mr lh jg le b gz ms mt l mu mv">const connect = swaggerRoutes(api, apiDescription, {<br/>  scopes: {<br/>    'identity.basic,identity.email': isAllowed<br/>  }<br/>})</span></pre><p id="c17e" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">现在<code class="fe lb lc ld le b">connect</code>函数将知道如何将路径与范围<code class="fe lb lc ld le b">identity.basic</code>相关联，并将<code class="fe lb lc ld le b">identity.email</code>与<code class="fe lb lc ld le b">isAllowed</code>中间件相关联。</p><h2 id="08a9" class="mr lh jg bd li mx my dn lm mz na dp lq ko nb nc lu ks nd ne ly kw nf ng mc nh bi translated">基本路径呢？</h2><p id="40d7" class="pw-post-body-paragraph kd ke jg kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ik bi translated">与上面定义的<code class="fe lb lc ld le b">ping</code>路径不同，<code class="fe lb lc ld le b">/things</code>与API的<code class="fe lb lc ld le b">basePath</code>、<code class="fe lb lc ld le b">'api/v1'</code>连接在一起。由于<code class="fe lb lc ld le b">root</code>标签的缘故，<code class="fe lb lc ld le b">swaggerRouter</code>知道<code class="fe lb lc ld le b">ping</code>路径不在基本路径下。您可以在下面列出的选项中对此进行更改。</p><h2 id="8ee1" class="mr lh jg bd li mx my dn lm mz na dp lq ko nb nc lu ks nd ne ly kw nf ng mc nh bi translated">缺少控制器怎么办？</h2><p id="8670" class="pw-post-body-paragraph kd ke jg kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ik bi translated">如果Swagger doc定义了一个不能映射到现有路线控制器函数的<code class="fe lb lc ld le b">operationId</code>，那么<code class="fe lb lc ld le b">connector</code>将在它的位置插入一个默认的<code class="fe lb lc ld le b">notImplemented</code>函数，返回<code class="fe lb lc ld le b">res.status(501).end()</code>。</p><p id="b64f" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">如果没有<code class="fe lb lc ld le b">operationId</code>与路径相关联，那么<code class="fe lb lc ld le b">connector</code>将插入一个默认的<code class="fe lb lc ld le b">notFound</code>函数，该函数返回<code class="fe lb lc ld le b">res.status(404).end()</code>。</p><p id="abb9" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">您可以通过传递给<code class="fe lb lc ld le b">swaggerRouter</code>的选项覆盖默认功能，如下所述。</p><h1 id="8596" class="lg lh jg bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">选择</h1><p id="7911" class="pw-post-body-paragraph kd ke jg kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ik bi translated"><code class="fe lb lc ld le b">swaggerRouter</code>功能的全套允许选项如下:</p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="a0ac" class="mr lh jg le b gz ms mt l mu mv">{<br/>  notImplemented, // a default function is supplied,<br/>  notFound, // a default function is supplied<br/>  scopes: {},<br/>  apiSeparator: '_',<br/>  rootTag: 'root'<br/>}</span></pre><h1 id="e9b9" class="lg lh jg bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">其他工具</h1><p id="2363" class="pw-post-body-paragraph kd ke jg kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ik bi translated"><code class="fe lb lc ld le b"><a class="ae lf" href="https://github.com/gargol/swagger-express-validator" rel="noopener ugc nofollow" target="_blank">swagger-express-validator</a></code>根据它们的Swagger定义验证API路由控制器的输入和输出。当结合全面的集成测试时，您可以断言您的服务器的正确性。</p><p id="5b79" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated"><code class="fe lb lc ld le b"><a class="ae lf" href="https://github.com/scottie1984/swagger-ui-express" rel="noopener ugc nofollow" target="_blank">swagger-ui-express</a></code>实用程序将您的Swagger定义文档作为一个交互式web用户界面，确保访问您的API的第三方能够访问与其代码一致的文档。</p><h1 id="345c" class="lg lh jg bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">链接</h1><ul class=""><li id="7104" class="ni nj jg kf b kg me kk mf ko nk ks nl kw nm la nn no np nq bi translated"><a class="ae lf" href="https://expressjs.com" rel="noopener ugc nofollow" target="_blank">快递</a></li><li id="fd3d" class="ni nj jg kf b kg nr kk ns ko nt ks nu kw nv la nn no np nq bi translated"><a class="ae lf" href="https://swagger.io" rel="noopener ugc nofollow" target="_blank">大摇大摆</a></li><li id="db8d" class="ni nj jg kf b kg nr kk ns ko nt ks nu kw nv la nn no np nq bi translated"><code class="fe lb lc ld le b"><a class="ae lf" href="https://www.npmjs.com/package/swagger-routes-express" rel="noopener ugc nofollow" target="_blank">swagger-routes-express</a></code>在NPM</li><li id="86da" class="ni nj jg kf b kg nr kk ns ko nt ks nu kw nv la nn no np nq bi translated"><code class="fe lb lc ld le b"><a class="ae lf" href="https://github.com/davesag/swagger-routes-express" rel="noopener ugc nofollow" target="_blank">swagger-routes-express</a></code>GitHub中的源代码</li><li id="48b0" class="ni nj jg kf b kg nr kk ns ko nt ks nu kw nv la nn no np nq bi translated"><code class="fe lb lc ld le b"><a class="ae lf" href="https://github.com/gargol/swagger-express-validator" rel="noopener ugc nofollow" target="_blank">swagger-express-validator</a></code></li><li id="dc10" class="ni nj jg kf b kg nr kk ns ko nt ks nu kw nv la nn no np nq bi translated"><code class="fe lb lc ld le b"><a class="ae lf" href="https://github.com/scottie1984/swagger-ui-express" rel="noopener ugc nofollow" target="_blank">swagger-ui-express</a></code></li></ul><p id="4487" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi">—</p><p id="f5f2" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">像这样但不是订户？你可以通过<a class="ae lf" href="https://davesag.medium.com/membership" rel="noopener">davesag.medium.com</a>加入来支持作者。</p></div></div>    
</body>
</html>