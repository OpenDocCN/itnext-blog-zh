<html>
<head>
<title>How to debug ASP.NET Core in Kubernetes from Visual Studio 2019?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何从Visual Studio 2019调试Kubernetes中的ASP.NET核心？</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-debug-asp-net-core-in-kubernetes-from-visual-studio-2019-1e9d16099d99?source=collection_archive---------1-----------------------#2021-02-07">https://itnext.io/how-to-debug-asp-net-core-in-kubernetes-from-visual-studio-2019-1e9d16099d99?source=collection_archive---------1-----------------------#2021-02-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="0bc3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于最初的<a class="ae kl" href="https://pavel-agarkov.medium.com/debugging-asp-net-core-app-running-in-kubernetes-minikube-from-visual-studio-2017-on-windows-6671ddc23d93" rel="noopener">帖子</a>已经过时，这里是VS2019的新帖子</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/067b9b44a6fd8e20e26102c2eb1c2631.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*b8vPokRXh4fNrpSAPDfHCw.png"/></div></figure><h1 id="f45c" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">准备工作站</h1><p id="f8dc" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">对于本教程，我们需要:</p><ul class=""><li id="fd94" class="lx ly iq jp b jq jr ju jv jy lz kc ma kg mb kk mc md me mf bi translated"><a class="ae kl" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-on-windows-using-chocolatey-or-scoop" rel="noopener ugc nofollow" target="_blank"> kubectl </a> -安装并配置为访问集群</li><li id="fc5e" class="lx ly iq jp b jq mg ju mh jy mi kc mj kg mk kk mc md me mf bi translated">Visual Studio 2019</li></ul><p id="7d48" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是假设您已经有一个kubernetes集群、一个docker映像构建管道和一个将dotnet应用程序发布到该集群的方法。</p><h1 id="8621" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">准备docker图像</h1><p id="07fc" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">为了远程调试dotnet应用程序，我们还需要一个远程调试器。可以按需安装，但我更喜欢在docker映像构建期间这样做:</p><pre class="kn ko kp kq gt ml mm mn mo aw mp bi"><span id="e47e" class="mq kv iq mm b gy mr ms l mt mu">RUN apt-get update \<br/>    &amp;&amp; apt-get install -y --no-install-recommends unzip \<br/>    &amp;&amp; rm -rf /var/lib/apt/lists/* \<br/>    &amp;&amp; curl -sSL <a class="ae kl" href="https://aka.ms/getvsdbgsh" rel="noopener ugc nofollow" target="_blank">https://aka.ms/getvsdbgsh</a> | \<br/>       bash /dev/stdin -v latest -l /vsdbg</span></pre><p id="796f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在我之前的<a class="ae kl" rel="noopener ugc nofollow" target="_blank" href="/debugging-asp-net-core-in-kubernetes-from-vscode-294a728031e6">文章</a>中阅读如何有条件地只为开发环境做这件事。</p><p id="124b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还需要在调试配置中构建我们的应用程序。比如像这样:</p><pre class="kn ko kp kq gt ml mm mn mo aw mp bi"><span id="01ff" class="mq kv iq mm b gy mr ms l mt mu">RUN dotnet publish -c Debug</span></pre><h1 id="de54" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">准备Visual Studio</h1><p id="5e31" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">为了让monorepos和团队更方便，我做了一个Visual Studio扩展:</p><ul class=""><li id="04db" class="lx ly iq jp b jq jr ju jv jy lz kc ma kg mb kk mc md me mf bi translated">将<code class="fe mv mw mx mm b">launch.json</code>复制到<code class="fe mv mw mx mm b">bin</code>目录</li><li id="19e2" class="lx ly iq jp b jq mg ju mh jy mi kc mj kg mk kk mc md me mf bi translated">替换<code class="fe mv mw mx mm b">launch.json</code>中的环境变量</li><li id="05ae" class="lx ly iq jp b jq mg ju mh jy mi kc mj kg mk kk mc md me mf bi translated">在<code class="fe mv mw mx mm b">launch.json</code>中用绝对路径替换相对路径</li><li id="c31b" class="lx ly iq jp b jq mg ju mh jy mi kc mj kg mk kk mc md me mf bi translated">开始远程调试</li></ul><p id="1644" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了继续，我们需要安装这个<a class="ae kl" href="https://marketplace.visualstudio.com/items?itemName=xpasza.RemoteDebugLauncher" rel="noopener ugc nofollow" target="_blank">扩展</a>并重启Visual Studio。</p><div class="my mz gp gr na nb"><a href="https://marketplace.visualstudio.com/items?itemName=xpasza.RemoteDebugLauncher" rel="noopener  ugc nofollow" target="_blank"><div class="nc ab fo"><div class="nd ab ne cl cj nf"><h2 class="bd ir gy z fp ng fr fs nh fu fw ip bi translated">远程调试启动器- Visual Studio市场</h2><div class="ni l"><h3 class="bd b gy z fp ng fr fs nh fu fw dk translated">Visual Studio的扩展-远程调试器启动器</h3></div><div class="nj l"><p class="bd b dl z fp ng fr fs nh fu fw dk translated">marketplace.visualstudio.com</p></div></div><div class="nk l"><div class="nl l nm nn no nk np ks nb"/></div></div></a></div><h1 id="2fba" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">准备项目</h1><p id="098e" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">用下面的内容创建一个新文件<code class="fe mv mw mx mm b">kube-debug.sh</code>,并把它放在根解决方案文件夹中，这样我们可以在我们所有的项目中重用它:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="23c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来在项目的<code class="fe mv mw mx mm b">Properties</code>文件夹中创建<code class="fe mv mw mx mm b">launch.json</code>文件，其内容如下，稍后将被调试:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="f660" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个文件也可以放在项目文件夹中，甚至放在根解决方案文件夹中，但是我希望它和默认的<code class="fe mv mw mx mm b">launchSettings.json</code>放在同一个地方——因为它们本质上非常相似。希望它们能在未来的版本中合并…</p><p id="6dfa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里的<code class="fe mv mw mx mm b">%SolutionRootForBash%</code>将被替换为根解决方案文件夹路径，但是因为我们使用了<code class="fe mv mw mx mm b">bash</code>，所以它也将<code class="fe mv mw mx mm b">\</code>替换为<code class="fe mv mw mx mm b">/</code>。但是如果你喜欢<code class="fe mv mw mx mm b">powershell</code>，那么你将需要<code class="fe mv mw mx mm b">%SolutionRoot%</code>。你可以在我之前的<a class="ae kl" href="https://medium.com/@pavel.agarkov/debugging-asp-net-core-app-running-in-kubernetes-minikube-from-visual-studio-2017-on-windows-6671ddc23d93" rel="noopener">文章</a>的<code class="fe mv mw mx mm b">powershell</code>中找到类似的脚本。检查源代码<a class="ae kl" href="https://github.com/pavel-agarkov/RemoteDebugLauncherExtension/blob/6c70a8363cc3a727b9e3fba12a4929d56eb25ceb/RemoteDebugLauncher/LaunchCommand.cs#L97-L101" rel="noopener ugc nofollow" target="_blank">代码</a>以找到更多替换。</p><p id="8985" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里的<code class="fe mv mw mx mm b">app.kubernetes.io/name=my-app-name</code>和<code class="fe mv mw mx mm b">my-app-namespace</code>应替换为当前应用的真实值。对于<code class="fe mv mw mx mm b">--selector</code>，我们可以使用部署规范中的匹配标签。</p><p id="8f91" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">⚠:我们已经准备好开始调试了，但是首先不要忘记为<code class="fe mv mw mx mm b">livenessProbe</code>增加<code class="fe mv mw mx mm b">timeoutSeconds</code>或者完全禁用它。否则，每当我们在断点处暂停时，kubernetes就会重启应用程序。</p><h1 id="0b03" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">开始调试</h1><p id="f857" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">要开始调试，只需在项目上下文菜单中选择<strong class="jp ir">远程调试</strong>:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="nt nu di nv bf nw"><div class="gh gi ns"><img src="../Images/25bb2137df7629ca8b36e03336ed1d1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mRRG4d7EijoRoF39Fu5sRQ.png"/></div></div></figure><p id="ce70" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里，我们正在从Windows调试一个运行在kubernetes集群中的应用程序:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/5a2fa90510747019553b9cb0719af93d.png" data-original-src="https://miro.medium.com/v2/resize:fit:748/format:webp/1*k_jA6Z2g47E8lKVX91HgeA.png"/></div></figure><h1 id="e513" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">⚠警告⚠</h1><p id="b8b5" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">按下🟥 <strong class="jp ir">停止调试(Shift+F5) </strong>将关闭集群中运行的应用！k8s会重启，但还是…</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/b3b5caea0dd7bbc9838b7d474145f89a.png" data-original-src="https://miro.medium.com/v2/resize:fit:638/format:webp/1*BJWK17VC1nCy61JlObAvrw.png"/></div></figure><p id="9fce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要真正停止调试，我们需要使用❌ <strong class="jp ir">分离所有</strong>来代替！</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/446350bbe8d108d296eeedb36a743753.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/format:webp/1*Rk55ofEzw-XFYuQk0Xpb0g.png"/></div></figure></div></div>    
</body>
</html>