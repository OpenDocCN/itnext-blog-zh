<html>
<head>
<title>Ubuntu — How to use Intel Optane Memory for SSD Caching</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ubuntu —如何使用英特尔Optane内存进行固态硬盘缓存</h1>
<blockquote>原文：<a href="https://itnext.io/ubuntu-how-to-use-intel-optane-memory-for-ssd-caching-42839b9ab3b9?source=collection_archive---------7-----------------------#2020-03-25">https://itnext.io/ubuntu-how-to-use-intel-optane-memory-for-ssd-caching-42839b9ab3b9?source=collection_archive---------7-----------------------#2020-03-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="47ce" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">如何使用英特尔Optane内存进行固态硬盘缓存</h1><p id="332b" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">最近，Opvizor的Michael订购了一台新的笔记本电脑——HP ProBook 650 G5。下面是他使用Ubuntu启用英特尔Optane的故事。</p><p id="2f62" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">沉迷于Linux，很明显决定清除Windows并安装Ubuntu，目前是18.04 LTS。<br/>但是且慢:</p><p id="75c8" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">该机器配备了“带固态存储的英特尔OPTANE内存H10”。</strong></p><p id="1b9c" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">那是什么？<br/> </strong>问谷歌帮:</p><p id="ec02" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">它是一个带有额外的非易失性高速缓存的固态磁盘。该缓存由Optane内存构成，比DRAM慢，但比闪存快，而且是非易失性的。<br/>对Windows用户来说很容易——有预装的英特尔RST驱动程序，它将Optane内存设置为固态硬盘的缓存。但是在Linux中呢？英特尔对此不提供驱动程序支持。</p><p id="65ed" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">然而，使用Optane内存并不难。网上很多人建议把它作为一个独立的，快速的，但也很小的磁盘来使用。</p><p id="e2b9" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">但我的工作负载各不相同，我不想浪费时间来决定在Optane上放什么，在flash上放什么。所以我也想使用Optane内存作为缓存，就像Windows用户所做的那样。</p><h1 id="f6bb" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">Linux中的Optane内存</h1><p id="9f52" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在物理层，设备分为两个独立的nvme设备:</p><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="b0da" class="lx jo iq lt b gy ly lz l ma mb">lspci | grep "Non-Volatile"<br/>02:00.0 Non-Volatile memory controller: Intel Corporation Device 0975 (rev 03)<br/>03:00.0 Non-Volatile memory controller: Intel Corporation Device 0975</span></pre><p id="ca8d" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">这些设备被映射为/dev/nvme0和/dev/nvme1，由于nvme技术，可用的块设备是/dev/nvme0n1和/dev/nvme1n1(也称为nvme命名空间)。</p><p id="18f8" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">所以第一步是禁用BIOS选项“高级/系统选项/为英特尔Optane配置存储控制器”。查看控制器的可选ROM，确保不再有组合设备。</p><p id="4389" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">这些选项旨在让RST驱动程序识别由这两个组件构成的设备。但是在Linux中，我们将在没有RST的情况下这样做，所以不需要那个选项。</p><p id="f4fd" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">请注意:由于在Linux中不支持使用Optane内存的RST缓存，所以您不能在配置了RST缓存的情况下双启动Windows和Linux。要么关闭Windows中的Optane，要么将Windows放入Linux操作系统中的VM。为了让事情不复杂，下面就不考虑双开机了。</p><h1 id="9dd0" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">装置</h1><h1 id="23ec" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">第一步</h1><p id="df33" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">从常规安装开始，使用带有LVM和LUKS加密的完整SSD (/dev/nvme0n1)。对于后面的步骤，LVM是强制性的，加密是可选的，但假设已启用。因此，在安装程序中，这些是选项:</p><figure class="lo lp lq lr gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mc"><img src="../Images/c0360064db3dec6ee21dcde869396357.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8w6aM1BageQnXBEO.png"/></div></div></figure><p id="bb6d" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">安装后，最终的磁盘布局非常简单:</p><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="0b9e" class="lx jo iq lt b gy ly lz l ma mb">Device           Start        End   Sectors   Size Type<br/>/dev/nvme0n1p1    2048    1050623   1048576   512M EFI System<br/>/dev/nvme0n1p2 1050624    2549759   1499136   732M Linux filesystem<br/>/dev/nvme0n1p3 2549760 1000214527 997664768 475.7G Linux filesystem</span></pre><p id="e7f9" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">nvme0n1p1持有<em class="mk"> /boot/efi </em>，<em class="mk"> nvme0n1p2 </em>持有<em class="mk"> /boot </em>，<em class="mk"> nvme0n1p3 </em>持有一个LUKS容器，该容器被LVM用作卷组<em class="mk"> ubuntu-vg </em>的物理设备。LVM为交换和根提供逻辑卷。</p><h1 id="d690" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">配置LUKS</h1><p id="c0ee" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">成功引导到新系统后，下一步是配置LUKS加密层:</p><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="6517" class="lx jo iq lt b gy ly lz l ma mb"># Setup the LUKS container holding the crypted Optane Memory:<br/>sudo cryptsetup luksFormat /dev/nvme1n1<br/><br/># Open the LUKS device:<br/>sudo cryptsetup luksOpen /dev/nvme1n1 nvme1n1_crypt<br/><br/># Add the LUKS device to the existing volume group:<br/>sudo vgextend ubuntu-vg /dev/mapper/nvme1n1_crypt<br/><br/># Get the UUID of the LUKS container:<br/>sudo blkid /dev/nvme1n1<br/><br/># Copy the blkid to you clipboard. Now edit the file /etc/crypttab, e.g. with the command <br/>sudo pico /etc/crypttab</span></pre><p id="83c0" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><em class="mk"> /etc/crypttab </em>的目的是保存加密设备的列表。这些信息对于引导系统至关重要。设备<em class="mk"> nvme0n1p3_crypt </em>应该已经有一行了。现在添加nvme1n1_crypt行，使用上一步中的UUID。</p><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="9386" class="lx jo iq lt b gy ly lz l ma mb">nvme0n1p3_crypt UUID=a4850a5a-3f97-4bf4-a965-63b162c0f88d none luks,discard<br/>nvme1n1_crypt   UUID=f338d02f-de8d-478f-80ec-175d0d88db58 none luks</span></pre><p id="db63" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">当然，你的UUIDs会有所不同。丢弃选项不适用于基于Optane的设备，因为Optane内存的工作方式与闪存不同，因此不需要丢弃。</p><h1 id="a841" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">lvmcache</h1><p id="eeb9" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">缓存是用<a class="ae ml" href="https://wiki.archlinux.org/index.php/LVM#LVM_cache" rel="noopener ugc nofollow" target="_blank"> lvmcache </a>构建的，给出了一个简洁的解释。使用命令:</p><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="d746" class="lx jo iq lt b gy ly lz l ma mb">sudo lvcreate --type cache --cachemode writeback -l100%FREE -n root_cachepool ubuntu-vg/root /dev/mapper/nvme1n1_crypt</span></pre><p id="25bb" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">给出这个命令后，您使用完整的optane内存创建了一个缓存池。由于精简资源调配功能，该池为内核驱动程序dm-cache所需的缓存和元数据设备提供服务。</p><p id="b7aa" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">缓存是为逻辑卷根(保存根文件系统)创建的。缓存模式设置为写回，这非常好，因为您使用的是非易失性内存！</p><h1 id="cde7" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">不要重启！</h1><p id="eaa5" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">现在:不要重启，因为机器不会再次启动！你必须做一些额外的工作。启用universe-repositories并安装精简配置工具。</p><p id="e275" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">这些将需要在启动时检查缓存设备的一致性。</p><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="e725" class="lx jo iq lt b gy ly lz l ma mb">sudo apt update <br/>sudo apt install thin-provisioning-tools</span></pre><h1 id="08fd" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">编写精简资源调配工具脚本</h1><p id="f42b" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">下载脚本thin-provisioning-tools并将其安装到目录/usr/share/initramfs-tools/hooks:</p><p id="b81c" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">下载<a class="ae ml" href="https://storage.googleapis.com/opvizor/thin-provisioning-tools" rel="noopener ugc nofollow" target="_blank">精简配置工具</a></p><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="6e1d" class="lx jo iq lt b gy ly lz l ma mb">sudo chown root:root ~/Downloads/thin-provisioning-tools<br/>sudo chmod 0755 ~/Downloads/thin-provisioning-tools<br/>sudo mv ~/Downloads/thin-provisioning-tools /usr/share/initramfs-tools/hooks/</span></pre><p id="e4a2" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">该脚本基于这篇<a class="ae ml" href="https://bugs.launchpad.net/ubuntu/+source/lvm2/+bug/1634697" rel="noopener ugc nofollow" target="_blank">文章</a>，添加了对lvmcache的支持。这个脚本的目的是将精简配置工具的二进制文件放到初始ramdisk上，并加载所需的内核模块进行缓存。</p><h1 id="9c0d" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">结束</h1><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="e21b" class="lx jo iq lt b gy ly lz l ma mb">sudo update-initramfs -k all -u</span></pre><p id="b64e" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">这些初始ramdisk支持:</p><ul class=""><li id="e3d8" class="mm mn iq kn b ko lj ks lk kw mo la mp le mq li mr ms mt mu bi translated">基于Optane存储器的第二LUKS器件</li><li id="de2f" class="mm mn iq kn b ko mv ks mw kw mx la my le mz li mr ms mt mu bi translated">运行缓存所需的内核驱动程序</li><li id="e2df" class="mm mn iq kn b ko mv ks mw kw mx la my le mz li mr ms mt mu bi translated">启动缓存卷所需的用于检查缓存卷的工具</li></ul><p id="4488" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">现在，您将被保存以重新启动。当被问两次LUKS密码时不要害怕:一次是nvme0n1p3_crypt，一次是nvme1n1_crypt。</p><h1 id="5da2" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">结果</h1><p id="8c52" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">要快速了解缓存的使用情况，可以发出以下命令</p><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="55c4" class="lx jo iq lt b gy ly lz l ma mb">sudo lvdisplay /dev/ubuntu-vg/root</span></pre><p id="017c" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">您可以随着时间的推移重复该命令。您将看到缓存中充满了数据，当查看命中/未命中比率时，您将看到效率在提高。例如</p><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="a487" class="lx jo iq lt b gy ly lz l ma mb">--- Logical volume ---<br/>  LV Path                /dev/ubuntu-vg/root<br/>  LV Name                root<br/>  VG Name                ubuntu-vg<br/>  LV UUID                xrD6tK-Ovfn-pweo-EuR2-bvid-xBsg-36GZ5b<br/>  LV Write Access        read/write<br/>  LV Creation host, time ubuntu, 2020-03-18 11:09:25 +0100<br/>  LV Cache pool name     root_cachepool<br/>  LV Cache origin name   root_corig<br/>  LV Status              available<br/>  # open                 1<br/>  LV Size                464,00 GiB<br/>  Cache used blocks      39,17%<br/>  Cache metadata blocks  11,07%<br/>  Cache dirty blocks     0,01%<br/>  Cache read hits/misses 625340 / 443779<br/>  Cache wrt hits/misses  985117 / 2027530<br/>  Cache demotions        0<br/>  Cache promotions       172267<br/>  Current LE             118784<br/>  Segments               1<br/>  Allocation             inherit<br/>  Read ahead sectors     auto<br/>  - currently set to     256<br/>  Block device           253:5</span></pre><h1 id="c9e7" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">附加注释</h1><p id="a64d" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果您决定从配置中删除缓存，请运行</p><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="ab75" class="lx jo iq lt b gy ly lz l ma mb">sudo lvconvert --uncache ubuntu-vg/root</span></pre><p id="9f26" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">通常，Ubuntu 18.04会为交换创建一个逻辑卷。考虑用根文件系统中的交换文件来替换它。逻辑卷交换不使用Optane内存进行缓存，但是逻辑卷根目录可以。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><p id="fa63" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><em class="mk">原载于2020年3月25日https://www.opvizor.com</em><a class="ae ml" href="https://www.opvizor.com/ubuntu-how-to-use-intel-optane-memory-for-ssd-caching" rel="noopener ugc nofollow" target="_blank"><em class="mk"/></a><em class="mk">。</em></p></div></div>    
</body>
</html>