<html>
<head>
<title>The way to integrate Trino ETL Jobs using dbt-trino with Airflow on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用dbt-trino和Kubernetes上的Airflow集成Trino ETL作业的方法</h1>
<blockquote>原文：<a href="https://itnext.io/the-way-to-integrate-trino-etl-jobs-using-dbt-trino-with-airflow-on-kubernetes-51cc851a366?source=collection_archive---------1-----------------------#2022-10-14">https://itnext.io/the-way-to-integrate-trino-etl-jobs-using-dbt-trino-with-airflow-on-kubernetes-51cc851a366?source=collection_archive---------1-----------------------#2022-10-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/8b260be24d559a311acbd2d6f4235446.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*puSW1HhAq2XMK5_Z"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Todd Quackenbush 在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="c89d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Trino是数据仓库中最流行的查询引擎。最近，trino可以用于运行长时间运行的ETL作业，具有容错执行配置以及交互式查询，这意味着，我认为，在大多数情况下，您可以用trino替换Hive。</p><p id="5e4e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这种trino etl作业可以使用<code class="fe lb lc ld le b"><a class="ae kc" href="https://github.com/starburstdata/dbt-trino" rel="noopener ugc nofollow" target="_blank">dbt-trino</a></code>来执行，但是如果您想要将trino etl作业的dbt模型与kubernetes上的Airflow之类的工作流集成，没有简单的方法可以做到这一点。在这里，我将讨论如何使用dbt将trino etl作业与kubernetes上运行的airflow集成。</p></div><div class="ab cl lf lg hu lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ij ik il im in"><p id="0dda" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了理解本文中使用的代码，克隆下面的git repo。</p><pre class="lm ln lo lp gt lq le lr ls aw lt bi"><span id="e6db" class="lu lv iq le b gy lw lx l ly lz"><a class="ae kc" href="https://github.com/mykidong/dbt-trino-example.git" rel="noopener ugc nofollow" target="_blank">https://github.com/mykidong/dbt-trino-example.git</a></span></pre><h1 id="0909" class="ma lv iq bd mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw bi translated">在本地运行trino dbt模型</h1><p id="9e5f" class="pw-post-body-paragraph kd ke iq kf b kg mx ki kj kk my km kn ko mz kq kr ks na ku kv kw nb ky kz la ij bi translated">让我们使用安装在本地机器上的dbt来执行trino dbt模型。</p><p id="1d19" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">安装dbt-trino。</p><pre class="lm ln lo lp gt lq le lr ls aw lt bi"><span id="c492" class="lu lv iq le b gy lw lx l ly lz">sudo yum install python3-devel -y;<br/>sudo yum groupinstall 'development tools' -y;<br/>sudo pip3 install --upgrade pip;<br/>sudo pip3 install dbt-core;<br/>sudo pip3 install dbt-trino;</span></pre><p id="fe6b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">参见示例dbt配置文件<code class="fe lb lc ld le b">dbt-trino-example/components/dbt/example/profiles.yml</code>。</p><pre class="lm ln lo lp gt lq le lr ls aw lt bi"><span id="b64f" class="lu lv iq le b gy lw lx l ly lz">trino:<br/>  target: dev<br/>  outputs:<br/>    dev:<br/>      type: trino<br/>      method: ldap<br/>      user: anyuser<br/>      password: anypassword<br/>      host: trino-gateway-hostname<br/>      port: 443<br/>      database: iceberg<br/>      schema: silver<br/>      threads: 8<br/>      http_scheme: https<br/>      session_properties:<br/>        query_max_run_time: 5d<br/>        exchange_compression: True</span></pre><p id="aa7d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要连接trino和TLS，您可以使用<a class="ae kc" rel="noopener ugc nofollow" target="_blank" href="/trino-gateway-8e654366df5e"> trino gateway </a>安装trino cluster。看一下输出配置，<code class="fe lb lc ld le b">database</code>是指trino的目录，类似于<code class="fe lb lc ld le b">iceberg</code>目录，<code class="fe lb lc ld le b">schema</code>与trino的<code class="fe lb lc ld le b">schema</code>相同。也就是说，输出数据将在trino的<code class="fe lb lc ld le b">iceberg</code>目录中的<code class="fe lb lc ld le b">silver</code>模式中创建或更新。</p><p id="49c6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们来看看示例模型<code class="fe lb lc ld le b">dbt-trino-example/components/dbt/example/silver/models/hive_to_iceberg.sql</code>。</p><pre class="lm ln lo lp gt lq le lr ls aw lt bi"><span id="ce1b" class="lu lv iq le b gy lw lx l ly lz">{{<br/>  config(<br/>    pre_hook = "set session query_max_run_time='10m'",<br/>    materialized = "incremental",<br/>    incremental_strategy = "append",<br/>    on_table_exists = "drop",<br/>    format = "ORC",<br/>    using = "ICEBERG"<br/>  )<br/>}}<br/>SELECT<br/>   baseproperties.eventtype,<br/>   itemid, <br/>   price <br/>FROM hive.default.test_parquet</span></pre><p id="3238" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">执行该模型后，将从<code class="fe lb lc ld le b">hive</code>目录和<code class="fe lb lc ld le b">default</code>模式中的表<code class="fe lb lc ld le b">test_parquet</code>创建并追加<code class="fe lb lc ld le b">iceberg</code>目录和<code class="fe lb lc ld le b">silver</code>模式中的表<code class="fe lb lc ld le b">hive_to_iceberg</code>。这是一种将hive数据转换为iceberg表的简单方法。</p><p id="a4d3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，您可以为trino运行dbt模型。</p><pre class="lm ln lo lp gt lq le lr ls aw lt bi"><span id="6a3a" class="lu lv iq le b gy lw lx l ly lz">cd ~/dbt-trino-example/components/dbt/example/silver;<br/><br/># debug.<br/>dbt debug --project-dir ./ --profiles-dir ../;<br/><br/># run<br/>dbt run --project-dir ./ --profiles-dir ../<br/><br/># run a specific model.<br/>dbt run --project-dir ./ --profiles-dir ../ -m models/example.sql</span></pre><h1 id="90a1" class="ma lv iq bd mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw bi translated">在Kubernetes上运行trino dbt模型</h1><p id="34e4" class="pw-post-body-paragraph kd ke iq kf b kg mx ki kj kk my km kn ko mz kq kr ks na ku kv kw nb ky kz la ij bi translated">要在kubernetes上运行dbt模型，首先要构建dbt docker映像。</p><pre class="lm ln lo lp gt lq le lr ls aw lt bi"><span id="b9be" class="lu lv iq le b gy lw lx l ly lz">FROM k8s.gcr.io/git-sync/git-sync:v3.6.1<br/><br/>ENV <em class="nc">LANG</em>='en_US.UTF-8' <em class="nc">LANGUAGE</em>='en_US:en' <em class="nc">LC_ALL</em>='en_US.UTF-8'<br/><br/>ENTRYPOINT []<br/><br/>USER root<br/><br/>ENV <em class="nc">DEBIAN_FRONTEND </em>noninteractive<br/><br/>RUN set -eux; \<br/>    apt-get update; \<br/>    apt-get install -y curl --no-install-recommends; \<br/>    apt install python3-pip -y; \<br/>    pip3 install --upgrade pip; \<br/>    pip3 install dbt-core==1.2.1; \<br/>    pip3 install dbt-trino==1.2.2;<br/><br/># print dbt version.<br/>RUN dbt --version<br/><br/># print git sync version.<br/>RUN /git-sync --version<br/><br/># set time zone.<br/>ENV <em class="nc">TZ</em>="Asia/Seoul"<br/><br/># print date.<br/>RUN echo "current date: $(date)"</span></pre><p id="c7f0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正如在docker文件中看到的，这个dbt docker映像扩展了<code class="fe lb lc ld le b"><a class="ae kc" href="https://github.com/kubernetes/git-sync" rel="noopener ugc nofollow" target="_blank">git-sync</a></code>。我的方法是首先克隆dbt模型代码所在的git repo，并从这些代码运行dbt模型。像这样构建和推送dbt docker映像。</p><pre class="lm ln lo lp gt lq le lr ls aw lt bi"><span id="a663" class="lu lv iq le b gy lw lx l ly lz">cd ~/dbt-trino-example/components/dbt/docker;<br/><br/><br/>chmod a+x build-docker.sh;<br/><br/>export TAG=1.2.2;<br/>./build-docker.sh \<br/>--image=cloudcheflabs/dbt:${TAG} \<br/>;</span></pre><p id="3268" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">把码头报告换成你的。</p><p id="eced" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">运行pod并在pod中执行dbt模型。</p><pre class="lm ln lo lp gt lq le lr ls aw lt bi"><span id="0879" class="lu lv iq le b gy lw lx l ly lz">kubectl run --rm dbt -it --image cloudcheflabs/dbt:1.2.2 --image-pull-policy='Always' -- sh;</span></pre><p id="91ea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从git repo克隆dbt代码。</p><pre class="lm ln lo lp gt lq le lr ls aw lt bi"><span id="6546" class="lu lv iq le b gy lw lx l ly lz">/git-sync \<br/>-repo https://yourgitrepo \<br/>-branch main \<br/>-username anyuser \<br/>-password yourtoken \<br/>-root /tmp/git/dbt-trino-example \<br/>-one-time</span></pre><p id="b52b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并运行指定的trino dbt模型。</p><pre class="lm ln lo lp gt lq le lr ls aw lt bi"><span id="f8f6" class="lu lv iq le b gy lw lx l ly lz">cd /tmp/git/dbt-trino-example/dbt-trino-example.git/components/dbt/example/silver &amp;&amp; \<br/>dbt clean &amp;&amp; \<br/>dbt run \<br/>--profiles-dir ../ \<br/>--project-dir ./ \<br/>-m models/example.sql</span></pre><p id="d5b6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以运行一个命令来克隆和运行模型代码，如下所示。</p><pre class="lm ln lo lp gt lq le lr ls aw lt bi"><span id="bc50" class="lu lv iq le b gy lw lx l ly lz">kubectl run --rm dbt -it --image cloudcheflabs/dbt:1.2.2 --image-pull-policy='Always' -- \<br/>/bin/sh -c '<br/>/git-sync \<br/>-repo https://yourgitrepo \<br/>-branch main \<br/>-username anyuser \<br/>-password yourtoken \<br/>-root /tmp/git/dbt-trino-example \<br/>-one-time &amp;&amp; \<br/>cd /tmp/git/dbt-trino-example/dbt-trino-example.git/components/dbt/example/silver &amp;&amp; \<br/>dbt clean &amp;&amp; \<br/>dbt run \<br/>--profiles-dir ../ \<br/>--project-dir ./ \<br/>-m models/example.sql<br/>'</span></pre><p id="693b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，您将看到以下日志。</p><pre class="lm ln lo lp gt lq le lr ls aw lt bi"><span id="fac9" class="lu lv iq le b gy lw lx l ly lz">If you don't see a command prompt, try pressing enter.<br/>I1014 10:39:38.539098       7 main.go:748] "level"=0 "msg"="syncing git" "rev"="HEAD" "hash"="98dfabb29a8f28834428dae5737a6fad5b48a3b2"<br/>I1014 10:39:39.592321       7 main.go:783] "level"=0 "msg"="adding worktree" "path"="/tmp/git/dbt-trino-example/98dfabb29a8f28834428dae5737a6fad5b48a3b2" "branch"="origin/main"<br/>I1014 10:39:39.598263       7 main.go:844] "level"=0 "msg"="reset worktree to hash" "path"="/tmp/git/dbt-trino-example/98dfabb29a8f28834428dae5737a6fad5b48a3b2" "hash"="98dfabb29a8f28834428dae5737a6fad5b48a3b2"<br/>I1014 10:39:39.598290       7 main.go:849] "level"=0 "msg"="updating submodules"<br/>01:39:41  Running with dbt=1.2.1<br/>01:39:41  Partial parse save file not found. Starting full parse.<br/>01:39:42  Found 2 models, 0 tests, 0 snapshots, 0 analyses, 271 macros, 0 operations, 0 seed files, 0 sources, 0 exposures, 0 metrics<br/>01:39:42  <br/>01:39:43  Concurrency: 8 threads (target='dev')<br/>01:39:43  <br/>01:39:43  1 of 1 START incremental model silver.example .................................. [RUN]<br/>01:39:52  1 of 1 OK created incremental model silver.example ............................. [SUCCESS in 9.78s]<br/>01:39:52  <br/>01:39:52  Finished running 1 incremental model in 0 hours 0 minutes and 10.83 seconds (10.83s).<br/>01:39:52  <br/>01:39:52  Completed successfully<br/>01:39:52  <br/>01:39:52  Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1<br/>Session ended, resume using 'kubectl attach dbt -c dbt -i -t' command when the pod is running<br/>pod "dbt" deleted</span></pre><h1 id="f30e" class="ma lv iq bd mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw bi translated">从kubernetes上的气流运行trino dbt模型</h1><p id="fb56" class="pw-post-body-paragraph kd ke iq kf b kg mx ki kj kk my km kn ko mz kq kr ks na ku kv kw nb ky kz la ij bi translated">我们已经准备好在kubernetes上运行trino etl作业的trino dbt模型了。要使用helm chart在kubernetes上安装airflow，请参见<a class="ae kc" href="https://airflow.apache.org/docs/helm-chart/stable/index.html" rel="noopener ugc nofollow" target="_blank">https://air flow . Apache . org/docs/helm-chart/stable/index . html</a>。</p><p id="fb37" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要从airflow的任务在kubernetes上创建dbt pod，您需要将RBAC添加到在kubernetes上运行的airflow的服务帐户中。</p><pre class="lm ln lo lp gt lq le lr ls aw lt bi"><span id="ef73" class="lu lv iq le b gy lw lx l ly lz">cat &lt;&lt;EOF &gt; rbac.yaml<br/>---<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRole<br/>metadata:<br/>  annotations:<br/>    rbac.authorization.kubernetes.io/autoupdate: "true"<br/>  labels:<br/>    kubernetes.io/bootstrapping: rbac-defaults<br/>  name: airflow<br/>rules:<br/>  - apiGroups:<br/>      - '*'<br/>    resources:<br/>      - '*'<br/>    verbs:<br/>      - '*'<br/>  - nonResourceURLs:<br/>      - '*'<br/>    verbs:<br/>      - '*'<br/><br/><br/>---<br/>apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: airflow-scheduler<br/>  labels:<br/>    app.kubernetes.io/name: airflow<br/>  namespace: airflow<br/><br/>---<br/>apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: airflow-triggerer<br/>  labels:<br/>    app.kubernetes.io/name: airflow<br/>  namespace: airflow<br/><br/>---<br/>apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: airflow-webserver<br/>  labels:<br/>    app.kubernetes.io/name: airflow<br/>  namespace: airflow<br/><br/>---<br/>apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: airflow-worker<br/>  labels:<br/>    app.kubernetes.io/name: airflow<br/>  namespace: airflow<br/><br/><br/><br/>---<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  annotations:<br/>    rbac.authorization.kubernetes.io/autoupdate: "true"<br/>  labels:<br/>    kubernetes.io/bootstrapping: rbac-defaults<br/>  name: airflow-scheduler<br/>roleRef:<br/>  apiGroup: rbac.authorization.k8s.io<br/>  kind: ClusterRole<br/>  name: airflow<br/>subjects:<br/>  - kind: ServiceAccount<br/>    name: airflow-scheduler<br/>    namespace: airflow<br/><br/>---<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  annotations:<br/>    rbac.authorization.kubernetes.io/autoupdate: "true"<br/>  labels:<br/>    kubernetes.io/bootstrapping: rbac-defaults<br/>  name: airflow-triggerer<br/>roleRef:<br/>  apiGroup: rbac.authorization.k8s.io<br/>  kind: ClusterRole<br/>  name: airflow<br/>subjects:<br/>  - kind: ServiceAccount<br/>    name: airflow-triggerer<br/>    namespace: airflow<br/><br/>---<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  annotations:<br/>    rbac.authorization.kubernetes.io/autoupdate: "true"<br/>  labels:<br/>    kubernetes.io/bootstrapping: rbac-defaults<br/>  name: airflow-webserver<br/>roleRef:<br/>  apiGroup: rbac.authorization.k8s.io<br/>  kind: ClusterRole<br/>  name: airflow<br/>subjects:<br/>  - kind: ServiceAccount<br/>    name: airflow-webserver<br/>    namespace: airflow<br/><br/>---<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  annotations:<br/>    rbac.authorization.kubernetes.io/autoupdate: "true"<br/>  labels:<br/>    kubernetes.io/bootstrapping: rbac-defaults<br/>  name: airflow-worker<br/>roleRef:<br/>  apiGroup: rbac.authorization.k8s.io<br/>  kind: ClusterRole<br/>  name: airflow<br/>subjects:<br/>  - kind: ServiceAccount<br/>    name: airflow-worker<br/>    namespace: airflow<br/>EOF<br/><br/>kubectl apply -f rbac.yaml;</span></pre><p id="9896" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在使用<code class="fe lb lc ld le b">KubernetesPodOperator</code>创建DAG来运行trino dbt模型。</p><pre class="lm ln lo lp gt lq le lr ls aw lt bi"><span id="d0fb" class="lu lv iq le b gy lw lx l ly lz">dbt_generate_command = f"""<br/>        git-sync \<br/>        -repo https://yourgitrepo \<br/>        -branch main \<br/>        -username anyuser \<br/>        -password yourtoken \<br/>        -root /tmp/git/dbt-trino-example \<br/>        -one-time &amp;&amp; \<br/>        cd /tmp/git/dbt-trino-example/dbt-trino-example.git/components/dbt/example/silver &amp;&amp; \<br/>        dbt clean &amp;&amp; \<br/>        dbt run \<br/>        --profiles-dir ../ \<br/>        --project-dir ./ \<br/>        -m models/example.sql<br/>        """<br/><br/>t = KubernetesPodOperator(<br/>    task_id="run-dbt-model",<br/>    namespace='dbt',<br/>    image='cloudcheflabs/dbt:1.2.2',<br/>    name="dbt-trino-job",<br/>    is_delete_operator_pod=True,<br/>    get_logs=True,<br/>    cmds=["/bin/sh", "-c", dbt_generate_command],<br/>    dag=dag,<br/>)</span></pre><p id="8a30" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lb lc ld le b">dbt_generate_command</code>与前一节中用于从git repo克隆dbt模型和运行dbt模型的命令相同。任务<code class="fe lb lc ld le b">t</code>将创建dbt pod并运行命令在kubernetes上执行trino dbt模型。</p></div><div class="ab cl lf lg hu lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ij ik il im in"><p id="900c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就是这样。</p></div></div>    
</body>
</html>