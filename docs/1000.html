<html>
<head>
<title>Step over nginx buffer issue</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">跳过nginx缓冲区问题</h1>
<blockquote>原文：<a href="https://itnext.io/step-over-nginx-buffer-issue-94a498bedb82?source=collection_archive---------0-----------------------#2018-07-02">https://itnext.io/step-over-nginx-buffer-issue-94a498bedb82?source=collection_archive---------0-----------------------#2018-07-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/b375838b997685fb94aa1afac51513fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TrNJZqECEj0eVuJDeNKtNQ.png"/></div></div></figure><div class=""/><h1 id="3318" class="jy jz jb bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">背景</h1><p id="a89e" class="pw-post-body-paragraph kw kx jb ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在我的日常开发工作中，我一直使用nginx作为反向代理。今天升级nginx后，它不知何故停止了正常工作:从webpack构建的一个vendor.js文件没有得到正确的服务。我从chrome控制台得到以下错误:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="da85" class="me jz jb ma b gy mf mg l mh mi">GET http://nginx.example.com/dist/js/vendor.js net::ERR_CONTENT_LENGTH_MISMATCH</span></pre><p id="9a35" class="pw-post-body-paragraph kw kx jb ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">我快速环顾四周，发现:</p><ul class=""><li id="db33" class="mo mp jb ky b kz mj ld mk lh mq ll mr lp ms lt mt mu mv mw bi translated">网络选项卡显示vendor.js请求的状态代码为200。</li><li id="b61e" class="mo mp jb ky b kz mx ld my lh mz ll na lp nb lt mt mu mv mw bi translated">回复头好像没问题。不过chrome网络标签里没有什么可以预览的。</li><li id="2e08" class="mo mp jb ky b kz mx ld my lh mz ll na lp nb lt mt mu mv mw bi translated">vendor.js的内容长度与文件的实际大小相匹配。</li><li id="73db" class="mo mp jb ky b kz mx ld my lh mz ll na lp nb lt mt mu mv mw bi translated"><code class="fe nc nd ne ma b"># ls -l : get the size in byte -rw-r--r-- 1 michaelzheng staff 4844863 Jul 2 17:00 vendor.js # ls -lh : get the size in human readable format -rw-r--r-- 1 michaelzheng staff 4.6M Jul vendor.js</code></li><li id="4acf" class="mo mp jb ky b kz mx ld my lh mz ll na lp nb lt mt mu mv mw bi translated">直接通过浏览器或者<code class="fe nc nd ne ma b">curl</code>加载vendor.js效果很好。</li></ul><h1 id="674b" class="jy jz jb bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">调试</h1><ul class=""><li id="74be" class="mo mp jb ky b kz la ld le lh nf ll ng lp nh lt mt mu mv mw bi translated">找到nginx配置文件的位置(即nginx.conf)</li><li id="7d4b" class="mo mp jb ky b kz mx ld my lh mz ll na lp nb lt mt mu mv mw bi translated"><code class="fe nc nd ne ma b">nginx -t</code></li><li id="fab6" class="mo mp jb ky b kz mx ld my lh mz ll na lp nb lt mt mu mv mw bi translated">找到错误日志的位置，它通常在nginx.conf中定义</li><li id="a16c" class="mo mp jb ky b kz mx ld my lh mz ll na lp nb lt mt mu mv mw bi translated">检查错误</li><li id="4914" class="mo mp jb ky b kz mx ld my lh mz ll na lp nb lt mt mu mv mw bi translated"><code class="fe nc nd ne ma b"># tail -f nginx 2018/07/02 22:29:27 [crit] 14586#0: *3641 open() "/usr/local/var/run/nginx/proxy_temp/1/08/0000000081" failed (13: Permission denied) while reading upstream, client: 127.0.0.1, server: nginx.example.com, request: "GET /dist/js/vendor.js HTTP/1.1", upstream: "http://127.0.0.1:8080/dist/js/vendor.js", host: "nginx.example.com", referrer: "http://nginx.example.com/testabc"</code></li><li id="58cb" class="mo mp jb ky b kz mx ld my lh mz ll na lp nb lt mt mu mv mw bi translated">现在我们可以清楚地看到这与缓冲目录<code class="fe nc nd ne ma b">proxy_temp</code>的权限问题有关。</li></ul><h1 id="f45b" class="jy jz jb bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">解决方法</h1><ul class=""><li id="9565" class="mo mp jb ky b kz la ld le lh nf ll ng lp nh lt mt mu mv mw bi translated">解决方案1 —授予权限</li><li id="cd3e" class="mo mp jb ky b kz mx ld my lh mz ll na lp nb lt mt mu mv mw bi translated"><code class="fe nc nd ne ma b">chown -R nobody:admin proxy_temp</code></li><li id="b1ac" class="mo mp jb ky b kz mx ld my lh mz ll na lp nb lt mt mu mv mw bi translated">您需要首先运行命令<code class="fe nc nd ne ma b">ps aux | grep nginx</code>来找出nginx进程的所有者，通常是<code class="fe nc nd ne ma b">nobody</code></li><li id="d289" class="mo mp jb ky b kz mx ld my lh mz ll na lp nb lt mt mu mv mw bi translated">解决方案2 —禁用缓冲，将<a class="ae lu" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_buffering" rel="noopener ugc nofollow" target="_blank"> proxy_buffering </a>设置为<code class="fe nc nd ne ma b">off</code></li><li id="20df" class="mo mp jb ky b kz mx ld my lh mz ll na lp nb lt mt mu mv mw bi translated">解决方案3 —使用<a class="ae lu" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_temp_path" rel="noopener ugc nofollow" target="_blank"> proxy_temp_path </a>指令，将缓冲区目录更改为nginx流程所有者有权访问的其他目录。</li></ul><h1 id="5a74" class="jy jz jb bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">通知；注意</h1><ul class=""><li id="a98a" class="mo mp jb ky b kz la ld le lh nf ll ng lp nh lt mt mu mv mw bi translated">如果您想关注我的博客系列的最新消息/文章，请<a class="ae lu" href="https://github.com/n0ruSh/blogs/" rel="noopener ugc nofollow" target="_blank">【观看】</a>订阅。</li></ul></div></div>    
</body>
</html>