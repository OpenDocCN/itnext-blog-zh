<html>
<head>
<title>Cleaning up after your nodes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">清理完节点后</h1>
<blockquote>原文：<a href="https://itnext.io/cleaning-up-after-your-nodes-b51b96fc63c5?source=collection_archive---------4-----------------------#2018-06-19">https://itnext.io/cleaning-up-after-your-nodes-b51b96fc63c5?source=collection_archive---------4-----------------------#2018-06-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="ca18" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由<a class="ae kl" href="https://www.linkedin.com/in/scott-morris-6490388/" rel="noopener ugc nofollow" target="_blank">斯科特·莫里斯</a></p><p id="5bc4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<a class="ae kl" href="https://opsline.com" rel="noopener ugc nofollow" target="_blank"> Opsline </a>中，我们经常使用<a class="ae kl" href="https://www.chef.io/" rel="noopener ugc nofollow" target="_blank"> Chef </a>对部署在云中的基础设施进行配置管理。在我们的典型配置中，EC2实例通过自动扩展组启动，并由<code class="fe km kn ko kp b">chef-client</code>在第一次引导时进行配置。Chef客户端进程向Chef服务器注册新实例，创建Chef“节点”和“客户端”对象，并创建用户友好的Route53记录来寻址新实例。</p><p id="ed7c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">但是当… </strong>发生了什么</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div class="gh gi kq"><img src="../Images/0d020e0c13aaaaf1203107a53184c3fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/0*1AT0SgInuLYmZupE"/></div></figure><p id="82c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当实例终止时，实例的Chef节点对象、客户机对象和Route53记录仍然存在。为了解决这个问题，我们创建了一个名为Lambda-Mop的工具。每当实例被自动缩放组终止或启动后引导失败时，此工具处理chef节点、客户机和Route53记录的删除。</p><h1 id="5d81" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated"><strong class="ak">工作原理</strong></h1><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi lw"><img src="../Images/e7e7d0be839d58280455cf479f258fc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Lcx5Ck5fa28rSUos"/></div></div></figure><p id="9dba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Lambda-Mop利用几种AWS服务:</p><p id="692e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">AWS Lambda</strong>—Lambda-Mop的主要组件是一个Lambda python函数。该功能有两种触发方式:</p><ol class=""><li id="f606" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mg mh mi mj bi translated">当一个自动缩放组终止一个现有的实例并将<code class="fe km kn ko kp b">autoscaling:EC2_INSTANCE_TERMINATE</code>信号连同实例id一起发送到已配置的SNS缩放通知ARN时。</li><li id="6b45" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">当新启动的实例在引导期间失败时，它可能没有向Chef服务器注册其实例id，从而阻止通过实例id查找节点/客户机对象。在这种情况下，我们有一个小的Python脚本(在引导过程中下载到实例)，它将通过<code class="fe km kn ko kp b">cfn-signal</code>检测引导失败，并向类型为<code class="fe km kn ko kp b">lambda_mop:DELETE</code>的SNS主题发送一个定制事件，包含相关的Chef节点名称和/或IP地址。然后Lambda-Mop使用这些信息来删除匹配的Chef对象和Route53记录。</li></ol><p id="57ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">SNS</strong>—SNS主题从自动缩放组或EC2实例本身接收信号。Lambda-Mop订阅了这个SNS话题。</p><p id="0c55" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> KMS </strong> —为了与Chef服务器通信，Lambda-Mop需要一个已经向Chef服务器注册的私钥。我们使用KMS加密这个私钥，并将其存储在S3桶中，Lambda-Mop从那里下载并解密它。</p><h1 id="081d" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">建立基础设施</h1><ol class=""><li id="ed82" class="mb mc iq jp b jq mp ju mq jy mr kc ms kg mt kk mg mh mi mj bi translated">为实例创建自动缩放组。我们使用CloudFormation来设置ASG，以及通知信号配置。</li></ol><pre class="kr ks kt ku gt mu kp mv mw aw mx bi"><span id="f91a" class="my kz iq kp b gy mz na l nb nc">"AutoScalingGroup": {<br/>  "Type": "AWS::AutoScaling::AutoScalingGroup",<br/>  "Properties": {<br/>    "MinSize": { "Ref": "AutoScalingMinSize" },<br/>    "MaxSize": { "Ref": "AutoScalingMaxSize" },<br/>    "DesiredCapacity": { "Ref": "AutoScalingDesiredCapacity" },<br/>    "NotificationConfiguration": {<br/>      "TopicARN": { "Ref": "ScalingNotificationsTopicArn" },<br/>      "NotificationTypes": [<br/>        "autoscaling:EC2_INSTANCE_LAUNCH",<br/>        "autoscaling:EC2_INSTANCE_LAUNCH_ERROR",<br/>        "autoscaling:EC2_INSTANCE_TERMINATE",<br/>        "autoscaling:EC2_INSTANCE_TERMINATE_ERROR"<br/>      ]<br/>    }<br/>… (further ASG configuration)<br/>}</span></pre><p id="5d11" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.创建<a class="ae kl" href="https://docs.aws.amazon.com/sns/latest/dg/CreateTopic.html" rel="noopener ugc nofollow" target="_blank"> SNS主题</a>(在上面的ASG配置中引用为<code class="fe km kn ko kp b">ScalingNotificationsTopicArn</code>)</p><p id="b991" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.创建由SNS主题消息触发的<a class="ae kl" href="https://docs.aws.amazon.com/lambda/latest/dg/get-started-create-function.html" rel="noopener ugc nofollow" target="_blank"> Lambda函数</a></p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="5b73" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.创建一个<a class="ae kl" href="https://docs.aws.amazon.com/kms/latest/developerguide/create-keys.html" rel="noopener ugc nofollow" target="_blank"> KMS密钥</a>用于加密厨师私钥</p><p id="57da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.使用<a class="ae kl" href="https://pychef.readthedocs.io/en/latest/api.html" rel="noopener ugc nofollow" target="_blank"> Chef API </a>在Chef服务器中搜索实例</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="daa1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">6.使用Chef API从Chef服务器中删除实例的节点和客户端对象</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="dffd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">7.为了支持新实例在引导期间失败的边缘情况，使用脚本向Lambda-Mop发信号通知应该从Chef服务器和Route53中移除该实例</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nd ne l"/></div></figure></div><div class="ab cl nf ng hu nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="ij ik il im in"><p id="5ca8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在招人！想来帮助我们解决DevOps领域的一些复杂问题吗？请将你的简历发至work@opsline.com<a class="ae kl" href="mailto:work@opsline.com" rel="noopener ugc nofollow" target="_blank"><em class="nm"/></a><em class="nm">给我们写信，我们会保持联系。</em></p></div></div>    
</body>
</html>