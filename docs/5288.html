<html>
<head>
<title>Solving ArgoCD Secret Management with the argocd-vault-plugin</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用argocd-vault-plugin解决ArgoCD秘密管理</h1>
<blockquote>原文：<a href="https://itnext.io/argocd-secret-management-with-argocd-vault-plugin-539f104aff05?source=collection_archive---------0-----------------------#2021-02-03">https://itnext.io/argocd-secret-management-with-argocd-vault-plugin-539f104aff05?source=collection_archive---------0-----------------------#2021-02-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/3cf2b76e5591deed974d9e3533b9636c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*ZgOSU7IIsZgJllZJPnhjCw.png"/></div></figure><p id="eb74" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">* *更新:我们已经将argocd-vault-plugin库转移到argoproj-labs组织，您现在可以在这里找到用途<a class="ae ks" href="https://github.com/argoproj-labs/argocd-vault-plugin" rel="noopener ugc nofollow" target="_blank">https://github.com/argoproj-labs/argocd-vault-plugin</a></p></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><p id="3392" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">GitOps已经迅速成为DevOps领域的热门话题之一。GitOps是由<a class="ae ks" href="https://www.weave.works/" rel="noopener ugc nofollow" target="_blank"> Weaveworks </a>在<a class="ae ks" href="https://www.weave.works/blog/gitops-operations-by-pull-request" rel="noopener ugc nofollow" target="_blank"> 2017 </a>推出的，此后一直呈上升趋势。我不会在本文中深入讨论为什么要使用GitOps，但是你可以在这里阅读更多关于它的内容。在讨论GitOps时总会出现的一个问题是秘密管理。每次涉及GitOps的演讲、演示或演示，总有人会提出这样的问题:“你如何用GitOps处理秘密？”，这是一个非常好的问题。</p><p id="47d6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">当我们的团队评估迁移到GitOps时，我们决定使用<a class="ae ks" href="https://argoproj.github.io/argo-cd/" rel="noopener ugc nofollow" target="_blank"> ArgoCD </a>作为我们的GitOps解决方案。ArgoCD提供了一个稳定的工具，可以快速可靠地处理在许多不同的<a class="ae ks" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>集群上部署数百个微服务。</p><p id="7062" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一旦我们选择了GitOps工具，就该考虑如何解决秘密问题了。与此同时，我们开始将我们的秘密转移到<a class="ae ks" href="https://www.vaultproject.io/" rel="noopener ugc nofollow" target="_blank"> HashiCorp保险库</a>，所以我们知道我们需要一些东西来弥合ArgoCD和保险库之间的差距。我们查看了一些现有的工具，我们发现的一个问题是，这个问题的潜在解决方案有很高的准入门槛。无论是必须手动加密机密还是部署操作员来做一些工作，这些解决方案都不太适合我的团队正在尝试做的事情。</p><p id="6ebc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，我们决定构建自己的工具，名为argocd-vault-plugin。</p></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><h1 id="d01c" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">什么是argocd-vault-plugin？</h1><p id="1ad6" class="pw-post-body-paragraph ju jv iq jw b jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr ij bi translated">argocd-vault-plugin是一个定制的argocd插件，用于从HashiCorp Vault中检索机密，并将它们注入到Kubernetes YAML文件中。在ArgoCD中，如果您需要内置的受支持工具之外的东西，有一种方法可以集成自定义插件，我们希望利用这种模式。这个插件背后的一个想法是以一种不需要操作员或自定义资源的方式编写它。这使得我们能够参数化任何Kubernetes资源，甚至自定义资源，而不仅仅是秘密。</p><p id="1d5e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">该插件的工作方式是，首先基于一个路径从Vault中检索值，该路径可以被指定为环境变量或yaml文件中的注释，然后将值注入到模板化的输出YAML中，该模板化的输出YAML使用<code class="fe md me mf mg b">&lt;&gt;</code>作为模板标记。例如:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="71eb" class="mp lb iq mg b gy mq mr l ms mt">kind: Secret<br/>apiVersion: v1<br/>metadata:<br/>  name: example-secret<br/>  annotations:<br/>    avp.kubernetes.io/path: "path/to/secret"<br/>type: Opaque<br/>stringData:<br/>  password: &lt;password-vault-key&gt;</span></pre><p id="7fb9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在上面的yaml中，你可以看到我们有一个普通的Kubernetes秘密定义。然而，有些事情不太正常。在数据下面，我们有一个名为<code class="fe md me mf mg b">password</code>的秘密，但是它的值是<code class="fe md me mf mg b">&lt;password-vault-key&gt;</code>，如果插件在Vault中找到<code class="fe md me mf mg b">password-vault-key</code>密钥，它将在这里注入一个值。</p><p id="19e9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，当插件运行时，它将从yaml中获取<code class="fe md me mf mg b">avp.kubernetes.io/path</code>注释，并使用它来寻找我们想要注入到这个Kubernetes秘密中的秘密。因此，我们采用了<code class="fe md me mf mg b">avp.kubernetes.io/path</code>注释，并将其与<code class="fe md me mf mg b">&lt;&gt;</code>符号中的值相结合。因此，这个场景中的最终路径将是带有保险库密钥<code class="fe md me mf mg b">password-vault-key.</code>的<code class="fe md me mf mg b">path/to/secret</code>，因此当插件完成运行时，我们将得到如下所示的yaml:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="3f58" class="mp lb iq mg b gy mq mr l ms mt">kind: Secret<br/>apiVersion: v1<br/>metadata:<br/>  name: example-secret<br/>  annotations:<br/>    avp.kubernetes.io/path: "path/to/secret"<br/>type: Opaque<br/>stringData:<br/>  password: some-password # From the key password-vault-key in Vault</span></pre><p id="189b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">可以在这里查看所有支持的后端和认证类型，<a class="ae ks" href="https://argocd-vault-plugin.readthedocs.io/en/stable/backends/" rel="noopener ugc nofollow" target="_blank">https://argocd-vault-plugin . readthe docs . io/en/stable/back ends/</a>。</p><h1 id="8c50" class="la lb iq bd lc ld mu lf lg lh mv lj lk ll mw ln lo lp mx lr ls lt my lv lw lx bi translated">如何安装和使用插件</h1><h2 id="2d6d" class="mp lb iq bd lc mz na dn lg nb nc dp lk kf nd ne lo kj nf ng ls kn nh ni lw nj bi translated">先决条件</h2><p id="4ffb" class="pw-post-body-paragraph ju jv iq jw b jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr ij bi translated">在开始本教程之前，请确保您已经部署/启用了这三样东西。我们不会在本文中向您展示如何做到这一点，但是您可以在下面找到关于如何部署必要工具的文档。</p><ul class=""><li id="c97a" class="nk nl iq jw b jx jy kb kc kf nm kj nn kn no kr np nq nr ns bi translated">ArgoCD—<a class="ae ks" href="https://argoproj.github.io/argo-cd/getting_started/" rel="noopener ugc nofollow" target="_blank">https://argoproj.github.io/argo-cd/getting_started/</a></li><li id="1ac0" class="nk nl iq jw b jx nt kb nu kf nv kj nw kn nx kr np nq nr ns bi translated">跳马—<a class="ae ks" href="https://www.vaultproject.io/docs/platform/k8s/helm/run" rel="noopener ugc nofollow" target="_blank">https://www.vaultproject.io/docs/platform/k8s/helm/run</a></li><li id="755d" class="nk nl iq jw b jx nt kb nu kf nv kj nw kn nx kr np nq nr ns bi translated">批准启用—<a class="ae ks" href="https://www.vaultproject.io/docs/auth/approle" rel="noopener ugc nofollow" target="_blank">https://www.vaultproject.io/docs/auth/approle</a></li></ul><h2 id="eb19" class="mp lb iq bd lc mz na dn lg nb nc dp lk kf nd ne lo kj nf ng ls kn nh ni lw nj bi translated">使插件可供ArgoCD使用</h2><p id="722b" class="pw-post-body-paragraph ju jv iq jw b jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr ij bi translated">为了使用该插件，我们首先需要下载该插件，然后向ArgoCD注册该插件以用作自定义插件。有几种不同的方法可以做到这一点，您可以在这里阅读<a class="ae ks" href="https://argoproj.github.io/argo-cd/operator-manual/custom_tools/" rel="noopener ugc nofollow" target="_blank"/>但是对于这个例子，我们将使用卷装载策略。为此，我们必须定制argocd-repo-server部署:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="45fe" class="mp lb iq mg b gy mq mr l ms mt">containers:<br/>- name: argocd-repo-server<br/>  volumeMounts:<br/>  - name: custom-tools<br/>    mountPath: /usr/local/bin/argocd-vault-plugin<br/>    subPath: argocd-vault-plugin<br/>volumes:<br/>- name: custom-tools<br/>  emptyDir: {}<br/>initContainers:<br/>- name: download-tools<br/>  image: alpine:3.8<br/>  command: [sh, -c]<br/>  args:<br/>    - wget -O argocd-vault-plugin<br/>      https://github.com/argoproj-labs/argocd-vault-plugin/releases/download/v1.6.0/argocd-vault-plugin_1.6.0_linux_amd64<br/><br/>      <!-- -->chmod +x argocd-vault-plugin &amp;&amp;\<br/>      mv argocd-vault-plugin /custom-tools/<br/>  volumeMounts:<br/>    - mountPath: /custom-tools<br/>      name: custom-tools</span></pre><p id="b6f0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">回头看看这段代码，很少有事情发生。首先，我们创建一个名为<code class="fe md me mf mg b">custom-tools</code>的空白卷，用于将argocd-vault-plugin二进制文件从initContainer移动到主容器。然后，我们通过InitContainer下载argocd-vault-plugin二进制文件，然后将二进制文件移动到一个路径<code class="fe md me mf mg b">custom-tools</code>中，稍后将会用到这个路径。然后我们在<code class="fe md me mf mg b">custom-tools</code>路径上安装了一个卷，这样我们就可以在主容器中访问它。现在，在argocd-repo-server容器中，我们添加了一个卷挂载，指向我们之前创建的<code class="fe md me mf mg b">custom-tools</code>卷，并在<code class="fe md me mf mg b">usr/local/bin</code>中挂载该卷，以使插件对容器可用。至此，您应该能够通过exec或ssh进入argocd-repo-server pods并看到以下内容:</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nz oa di ob bf oc"><div class="gh gi ny"><img src="../Images/74a95edf733fe6f4b27371adf92c1093.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VAGE7AXGwf8h77SAFPVYQQ.png"/></div></div></figure><p id="8387" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一旦插件可用，下一步就是向ArgoCD本身注册插件。这是非常直接的一步。有一个名为argocd-cm的配置图。只需转到该配置图并添加:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="82f2" class="mp lb iq mg b gy mq mr l ms mt">data:<br/>  configManagementPlugins: |-<br/>    - name: argocd-vault-plugin<br/>      generate:<br/>        command: ["argocd-vault-plugin"]<br/>        args: ["generate", "./"]</span></pre><p id="dcfd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在添加了<code class="fe md me mf mg b">configManagementPlugins</code>部分并保存了配置图之后，您可以重启argocd-repo-server部署，然后您应该会在argocd中看到作为选项的插件:</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nz oa di ob bf oc"><div class="gh gi od"><img src="../Images/e08b7a7d85281c3ed9af227f46f9d3a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R6JhNZHXVlBS8yBgjq6FCA.png"/></div></div></figure><h2 id="0072" class="mp lb iq bd lc mz na dn lg nb nc dp lk kf nd ne lo kj nf ng ls kn nh ni lw nj bi translated">配置插件</h2><p id="589f" class="pw-post-body-paragraph ju jv iq jw b jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr ij bi translated">此时，我们应该已经安装并注册了argocd-vault-plugin来运行ArgoCD。下一步是配置插件指向你的Vault实例。</p><p id="726f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">有几种不同的方法来配置插件(环境变量、Kubernetes Secret、配置文件)，但是为了本教程的缘故，我们将继续使用环境变量。将AppRole配置为身份验证方法需要5个变量。这些是:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="0275" class="mp lb iq mg b gy mq mr l ms mt">VAULT_ADDR: "<!-- -->http://vault:8082"     # Path to your Vault Instance<br/>AVP_TYPE: vault                     # The Backend Type<br/>AVP_AUTH_TYPE: approle              # Auth method we are using<br/>AVP_ROLE_ID: role_id                # AppRole Role ID<br/>AVP_SECRET_ID: secret_id            # AppRole Secret ID</span></pre><p id="9c5b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们将把这些内容作为一个秘密添加到Kubernetes的argocd名称空间中。创建一个名为<code class="fe md me mf mg b">argocd-vault-plugin-credentials.yaml</code>的文件，并将其粘贴到该文件中。请确保用您的实际保管库值替换这些值。</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="2958" class="mp lb iq mg b gy mq mr l ms mt">kind: Secret<br/>apiVersion: v1<br/>metadata:<br/>  name: argocd-vault-plugin-credentials<br/>  namespace: argocd<br/>type: Opaque<br/>data:<br/>  AVP_AUTH_TYPE: approle<br/>  AVP_ROLE_ID: your_role_id<br/>  AVP_SECRET_ID: your_secret_id<br/>  AVP_TYPE: vault<br/>  VAULT_ADDR: your_vault_addr</span></pre><p id="f268" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后，您希望在Kubernetes中创建秘密，您可以通过运行以下命令来实现(确保您的Kubernetes上下文指向正确的集群):</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="0bd7" class="mp lb iq mg b gy mq mr l ms mt">kubectl apply -f argocd-vault-plugin-credentials.yaml -n argocd</span></pre><p id="0258" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">剩下唯一要做的事情就是让这个秘密作为argocd-repo-server pod中的环境变量可用。回到最初添加initContainer的argocd-repo-server部署，并添加一个指向刚刚创建的秘密的<code class="fe md me mf mg b">envFrom</code>。</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="fe8f" class="mp lb iq mg b gy mq mr l ms mt">containers:<br/>- name: argocd-repo-server<br/>  volumeMounts:<br/>  - name: custom-tools<br/>    mountPath: /usr/local/bin/argocd-vault-plugin<br/>    subPath: argocd-vault-plugin<br/>  <strong class="mg ir">envFrom:<br/>    - secretRef:<br/>        name: argocd-vault-plugin-credentials</strong></span></pre><p id="9a98" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">就是这样！现在，您应该有一个指向您的保管库的已配置插件。我们现在已经准备好测试插件了！</p><h2 id="3109" class="mp lb iq bd lc mz na dn lg nb nc dp lk kf nd ne lo kj nf ng ls kn nh ni lw nj bi translated">使用插件部署ArgoCD应用程序</h2><p id="811d" class="pw-post-body-paragraph ju jv iq jw b jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr ij bi translated">我们要做的第一件事是在Vault中创建一个秘密。因此，转到您的保险库，用密钥<code class="fe md me mf mg b">sample</code>和值<code class="fe md me mf mg b">secret.</code>在名为<code class="fe md me mf mg b">avp/test</code>的路径下创建一个秘密。您要做的第一件事是启用保险库kv-v2存储。您还需要授予您适当的角色id权限，以便能够访问<code class="fe md me mf mg b">avp</code>路径。你可以在https://www.vaultproject.io/docs/concepts/policies<a class="ae ks" href="https://www.vaultproject.io/docs/concepts/policies" rel="noopener ugc nofollow" target="_blank">找到文档。</a></p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="35e6" class="mp lb iq mg b gy mq mr l ms mt">vault secrets enable -version=2 avp</span></pre><p id="8650" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="6971" class="mp lb iq mg b gy mq mr l ms mt">vault kv put avp/test sample=secret</span></pre><p id="fe20" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果您接下来阅读相同的路径，您应该会看到如下内容:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="8c1f" class="mp lb iq mg b gy mq mr l ms mt">====== Metadata ======<br/>Key             Value<br/>---             -----<br/>version         1</span><span id="6470" class="mp lb iq mg b gy oe mr l ms mt">====== Data ======<br/>Key          Value<br/>---          -----<br/>sample       secret</span></pre><p id="c519" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在我们可以转到ArgoCD，使用argocd-vault-plugin部署应用程序。</p><p id="8540" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">打开ArgoCD并创建新的应用程序</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div class="gh gi of"><img src="../Images/a4f600a2af6b2757ce47ba3a633bf78f.png" data-original-src="https://miro.medium.com/v2/resize:fit:908/format:webp/1*u4zQXcHgLVzzOaEk-Ci3hA.png"/></div></figure><p id="68fa" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们将把它命名为<code class="fe md me mf mg b">sample-secret</code>,并放在默认项目中</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nz oa di ob bf oc"><div class="gh gi og"><img src="../Images/560f7072936a26f6507d8c0f5a17e6a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2L4yLIAt-FUETvPQB7rlDg.png"/></div></div></figure><p id="8746" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我有一个样本回购，我们将使用拉在<a class="ae ks" href="https://github.com/werne2j/arogcd-vault-plugin-demo" rel="noopener ugc nofollow" target="_blank">https://github.com/werne2j/arogcd-vault-plugin-demo</a>一个示例秘密文件</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nz oa di ob bf oc"><div class="gh gi oh"><img src="../Images/b2311e60d2877d434cf7b5ffd1151d84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zphVYoWjhSwtJfK3SSMEXA.png"/></div></div></figure><p id="887b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们将把秘密放在集群中(在安装ArgoCD的集群中)和默认的名称空间中</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nz oa di ob bf oc"><div class="gh gi oi"><img src="../Images/c79b5a691c79b55e56a9246fd854b10e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O4kAmbcfVyM8kQupvXnV4A.png"/></div></div></figure><p id="d373" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">最后需要的是指定要使用的argocd-vault-plugin插件</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nz oa di ob bf oc"><div class="gh gi oj"><img src="../Images/32ed3efb2a98412c538ef60436b96219.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rYjGAAhNXoLqQxSDjVTNuA.png"/></div></div></figure><p id="d1a5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在我们可以点击创建按钮，看看它是否工作！</p><p id="aea7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您应该会看到在ArgoCD UI中创建了一个应用程序</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nz oa di ob bf oc"><div class="gh gi ok"><img src="../Images/edcf15af9c0b8f88f517d876d7c9b936.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rCsXs4nWT5cdciN0aVvBLQ.png"/></div></div></figure><p id="253d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果你点击这个应用程序，你会看到这个:</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nz oa di ob bf oc"><div class="gh gi ol"><img src="../Images/3f3a636cc5c9e6c312f575821a09e129.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sYEoh9NUiWPNg0nIitDmlw.png"/></div></div></figure><p id="c3fb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果是的话，你已经成功地使用了argocd-vault-plugin！我们可以通过寻找Kubernetes中的秘密并检查其价值来证实这一点:</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nz oa di ob bf oc"><div class="gh gi om"><img src="../Images/1fe3f2adbe7a240e977b70011261ffe4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q0s7yy0jGt6nS5_5Q2AFFw.png"/></div></div></figure><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nz oa di ob bf oc"><div class="gh gi on"><img src="../Images/4edb86aa8b4cad795ba19c6a18194e1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yQLKdT2l1VoEprsNSd9ABQ.png"/></div></div></figure><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nz oa di ob bf oc"><div class="gh gi oo"><img src="../Images/04557d6055eec1a971ba024eff1c477b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZD_cq9D411w6Vz5wZv4KLg.png"/></div></div></figure><p id="c90a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然而，我们还没有完成！该插件的一个优点是，如果Vault中的值发生变化，我们可以毫不费力地更新集群中的值。因此，更新vault中的值:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="0365" class="mp lb iq mg b gy mq mr l ms mt">vault kv put avp/test sample=new_secret</span></pre><p id="f07b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在在ArgoCD中，你可以进行一次硬刷新，这将执行一次插件的预演</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div class="gh gi op"><img src="../Images/c9f663d2524b583959987402c306be62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1048/format:webp/1*u-7bHPehJBhbQXaTUm9kmw.png"/></div></figure><p id="4cab" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，您应该注意到应用程序不同步:</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nz oa di ob bf oc"><div class="gh gi oq"><img src="../Images/0f123e93eb6e07fbffb286129a77f273.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OOPKlpUvLP_OX48q0IwBTA.png"/></div></div></figure><p id="2b7f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这意味着插件执行了模拟运行，并确定输出与集群中当前的输出不同。现在我们要做的就是同步应用程序，我们应该看到应用程序变回绿色！</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nz oa di ob bf oc"><div class="gh gi or"><img src="../Images/e961c327fd68f903870034ee397ca1d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y4hVK-buFzKZbOCPPJjFvg.png"/></div></div></figure></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><p id="d7e3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">感谢您的阅读！我真的希望这个工具能在你的GitOps之旅中帮助你！如果你对argocd-vault-plugin感兴趣，并且你想了解更多或者为这个项目做贡献，你可以在Github上找到我们！</p><div class="os ot gp gr ou ov"><a href="https://github.com/argoproj-labs/argocd-vault-plugin" rel="noopener  ugc nofollow" target="_blank"><div class="ow ab fo"><div class="ox ab oy cl cj oz"><h2 class="bd ir gy z fp pa fr fs pb fu fw ip bi translated">GitHub-argoproj-labs/argocd-vault-plugin:一个argocd插件，用于从Secret…</h2><div class="pc l"><h3 class="bd b gy z fp pa fr fs pb fu fw dk translated">一个Argo CD插件，用于从各种秘密管理工具(HashiCorp Vault，IBM Cloud Secrets Manager…</h3></div><div class="pd l"><p class="bd b dl z fp pa fr fs pb fu fw dk translated">github.com</p></div></div><div class="pe l"><div class="pf l pg ph pi pe pj js ov"/></div></div></a></div></div></div>    
</body>
</html>