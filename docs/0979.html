<html>
<head>
<title>Tag your Docker images while building with Maven</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Maven构建时标记您的Docker图像</h1>
<blockquote>原文：<a href="https://itnext.io/tag-your-docker-images-while-building-with-maven-915c8043d2e0?source=collection_archive---------1-----------------------#2018-06-27">https://itnext.io/tag-your-docker-images-while-building-with-maven-915c8043d2e0?source=collection_archive---------1-----------------------#2018-06-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="0471" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我最近的故事中，我解释了我如何“在Kubernetes上发布Spring Boot应用程序”。在这个故事中，我想解释一下我是如何标记由com . Spotify . Docker-maven-plugin从Spring Boot源代码构建的Docker图像的。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><p id="f449" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">BIZIMKILER你要做的第一件事就是把com . Spotify . docker-maven-plugin添加到你的pom.xml中。在我的环境中，我既可以通过spring boot maven插件在本地运行它，也可以通过com . Spotify . docker-maven-plugin进行dockerize。这是我的示例配置</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi kt"><img src="../Images/a156ee966dfee95162cd0cddc6046b48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DtN-vjSw-xgDyxvsc9IG0A.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">构建my pom.xml的一部分</figcaption></figure><p id="df89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的构建配置只对与同一个模块相关联的Dockerfile有意义。这是档案。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi lj"><img src="../Images/56939a378aa1c8e4393cc8af454cf8ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*miqx_2V_-PNMiPx0mTJyAg.png"/></div></div></figure><p id="549a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">pom.xml的JAR_FILE参数在Dockerfile中用来指出Spring Boot构建的JAR包。那是主要的应用。但这个故事关注的重要部分是为Docker图像定义的标签。</p><p id="18d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请仔细注意pom.xml的<strong class="jp ir">存储库</strong>和<strong class="jp ir">标签</strong>节点。这些节点配置dockerfile-maven-plugin，用特定的构建标签标记容器化的Docker映像。标签节点包含两部分:</p><p id="9072" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi lk translated">这是我们在pom.xml之上定义的一个变量</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div class="gh gi lt"><img src="../Images/59c62af26397ad6492703ee0f67be8da.png" data-original-src="https://miro.medium.com/v2/resize:fit:952/format:webp/1*zx4-k6P0oWANkRPTMQ9jYA.png"/></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">pom.xml顶部定义项目(模块)变量</figcaption></figure><p id="8a12" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是我们如何为每个构建定义${revision}?我们使用詹金斯的全球资产。</p><p id="a09e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Jenkins构建Docker映像的工作中，我们给出以下命令:</p><pre class="ku kv kw kx gt lu lv lw lx aw ly bi"><span id="0be2" class="lz ma iq lv b gy mb mc l md me">./mvnw install dockerfile:build -Drevision=${PROJECTREVISION} -Dgit-revision=$GIT_COMMIT</span></pre><p id="6e2d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个命令通过使用dockerfile-maven-plugin构建docker映像。您可以看到，pom.xml中使用的这个命令设置了<strong class="jp ir"> revision和git-revision参数。</strong></p><p id="1cf0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嗯哼！${PROJECTREVISION}和$GIT_COMMIT变量怎么样？</p><p id="e84d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">＄{ project revision }来自Jenkins管理员设置的Jenkins全局属性。(在我的例子中，我每周为每个scrum增加版本)</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi lj"><img src="../Images/1039303e72f93a121cf5f38d113ee88e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qQoppSAI6ZrcUx61dm-V1A.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">詹金斯的全球财产</figcaption></figure><p id="a211" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">$GIT_COMMIT变量由Jenkins环境自动设置。当Jenkins从主分支获取最新的源代码时，这个变量被设置为GIT提供者(在我的例子中是Gitlab)给出的提交id</p><p id="2e2b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://wiki.jenkins.io/display/JENKINS/Building+a+software+project" rel="noopener ugc nofollow" target="_blank">这里是你可以在Kenkins构建中使用的env变量</a></p><p id="fee2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi lk translated"><span class="l ll lm ln bm lo lp lq lr ls di"> 2 </span> ${git-revision}:如上所述，这个pom.xml变量是由Jenkins env变量在Jenkins命令上设置的。</p><p id="8a44" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个版本的末尾，您得到了一个标记有项目版本和git提交Id的Docker映像。以下是我在Jenkins中使用的完整命令，用于构建该图像并将其推送到Google容器注册表</p><pre class="ku kv kw kx gt lu lv lw lx aw ly bi"><span id="591d" class="lz ma iq lv b gy mb mc l md me">./mvnw install dockerfile:build -Drevision=${PROJECTREVISION} -Dgit-revision=$GIT_COMMIT<br/>docker push gcr.io/mygooglecloudproject/core:${PROJECTREVISION}.$GIT_COMMIT</span></pre><p id="5cde" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我的Google容器注册表示例，它为每个主分支提交标记了各种图像。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi mf"><img src="../Images/6f2bdb2ed8982330d42d2483f41e4a75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V1GIj-RW6c1MRdF6IkMNhA.png"/></div></div></figure></div></div>    
</body>
</html>