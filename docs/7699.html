<html>
<head>
<title>Micro-Training: AKS Auditing API Calls</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">微型培训:AKS审计API调用</h1>
<blockquote>原文：<a href="https://itnext.io/micro-training-aks-auditing-api-calls-321682f45773?source=collection_archive---------7-----------------------#2022-12-21">https://itnext.io/micro-training-aks-auditing-api-calls-321682f45773?source=collection_archive---------7-----------------------#2022-12-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="7a75" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这需要在集群上安装<a class="ae kl" href="https://learn.microsoft.com/en-us/azure/azure-monitor/containers/container-insights-enable-aks?tabs=azure-cli" rel="noopener ugc nofollow" target="_blank"> container insights </a>，并正确配置日志分析工作区。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><p id="e0e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从集群诊断设置区域启用KubeAudit诊断设置。</p><pre class="kt ku kv kw gt kx ky kz bn la lb bi"><span id="5272" class="lc ld iq ky b be le lf l lg lh">Monitoring -&gt; Diagnostic settings -&gt; Add diagnostic setting</span></pre><pre class="li kx ky lj lk aw ll bi"><span id="bbc8" class="lm ld iq ky b gy ln lo l lp lh">Enter a name -&gt; Kubernetes Audit -&gt; Send to Log Analytics workspace</span><span id="c5cc" class="lm ld iq ky b gy lq lo l lp lh">Save</span></pre><figure class="kt ku kv kw gt ls gh gi paragraph-image"><div class="gh gi lr"><img src="../Images/4a9bcfd92e0f9f381fb96ca66c20f979.png" data-original-src="https://miro.medium.com/v2/resize:fit:872/0*qECEYj7SUN8m90IK"/></div></figure></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><ul class=""><li id="eb15" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk ma mb mc md bi translated">监控-&gt;日志</li><li id="cdb5" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk ma mb mc md bi translated">退出弹出的查询</li><li id="dad5" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk ma mb mc md bi translated">摄入一段时间后，您应该会看到AzureMetrics表。</li></ul></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><figure class="kt ku kv kw gt ls gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/5bc329060e31693b6aee572c945eaa7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:584/format:webp/1*zUo_UGgKm5ZkWPeVC4kWLQ.png"/></div></figure><p id="3a13" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行下面的查询，该查询将解析日志和提取数据，以突出显示从特定资源进行了多少次调用、什么动词、状态代码、资源和用户代理。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><pre class="kt ku kv kw gt kx ky kz bn la lb bi"><span id="50e1" class="lc ld iq ky b be le lf l lg lh">//Audit call Breakdown<br/>AzureDiagnostics<br/>| where Category == 'kube-audit'<br/>| extend JSON = parse_json(log_s)<br/>| extend stage = JSON.stage<br/>| where stage == "ResponseComplete"<br/>| extend verb = tostring(JSON.verb)<br/>| extend statusCode = tostring(JSON.responseStatus.code)<br/>| extend userAgent = tostring(JSON.userAgent)<br/>| extend user = tostring(JSON.user.username)<br/>| extend sourceIPs = tostring(JSON.sourceIPs)<br/>| extend resourceType = tostring(JSON.objectRef.resource)<br/>| extend resourceName = tostring(JSON.objectRef.name)<br/>| extend requestUri = tostring(JSON.requestURI)<br/>| summarize calls = count(), resource = any(resourceName), userAgent = any(userAgent) by requestUri, verb, statusCode</span></pre><figure class="kt ku kv kw gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi mk"><img src="../Images/5a947fee98a966a1bb34f7dc37296cb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R8gExa1wwG-94RcE6Tl2wg.png"/></div></div></figure></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><p id="e099" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你喜欢这样的东西，请鼓掌，如果有你想看的特别的东西，请告诉我。</p><h1 id="5b3b" class="mp ld iq bd mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl bi translated">其他感兴趣的链接</h1><ul class=""><li id="70fe" class="lv lw iq jp b jq nm ju nn jy no kc np kg nq kk ma mb mc md bi translated"><a class="ae kl" href="https://learn.microsoft.com/en-us/azure/azure-monitor/containers/container-insights-onboard" rel="noopener ugc nofollow" target="_blank">集装箱见解</a></li><li id="9571" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk ma mb mc md bi translated"><a class="ae kl" href="https://learn.microsoft.com/en-us/azure/azure-monitor/essentials/data-collection" rel="noopener ugc nofollow" target="_blank">日志分析数据收集</a></li><li id="045f" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk ma mb mc md bi translated"><a class="ae kl" href="https://learn.microsoft.com/en-us/azure/azure-monitor/agents/log-analytics-agent" rel="noopener ugc nofollow" target="_blank">日志分析代理</a></li><li id="50ae" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk ma mb mc md bi translated"><a class="ae kl" href="https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/" rel="noopener ugc nofollow" target="_blank"> KQL语言</a></li></ul></div></div>    
</body>
</html>