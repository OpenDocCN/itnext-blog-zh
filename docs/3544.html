<html>
<head>
<title>Breaking Down Containers | Part 1 — Namespaces</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">分解容器|第1部分—名称空间</h1>
<blockquote>原文：<a href="https://itnext.io/breaking-down-containers-part-1-namespaces-9668b86d003d?source=collection_archive---------6-----------------------#2020-01-06">https://itnext.io/breaking-down-containers-part-1-namespaces-9668b86d003d?source=collection_archive---------6-----------------------#2020-01-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/d9c3e5d4e4100e3688c8ba664a9b1e06.png" data-original-src="https://miro.medium.com/v2/resize:fit:826/format:webp/0*HLFPe1qc2UbhX0FP.png"/></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk translated">子进程和父进程的名称空间可以不同</figcaption></figure><p id="0d54" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在继续之前，有一些事情需要注意</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="41f2" class="li lj it le b gy lk ll l lm ln">1. This is not an introductory article, kindly learn about containers from the Part 0 article<br/>2. Containers are not Docker, Docker is not a Container<br/>3. Docker is a container runtime and there are more tools like docker: runc, runv etc<br/>4. Docker wasn't the first container runtime, it was the easiest to use due to it's configuration file called the Dockerfile which had almost english like reference to already generic scripts and its automated resolve for configurations I would outline in parts 3 &amp; 4.<br/>5. Code samples for this and subsequent articles are available in the following link: <a class="ae lo" href="https://github.com/Tiemma/oci-containers/tree/master/container" rel="noopener ugc nofollow" target="_blank">https://github.com/Tiemma/oci-containers/tree/master/container</a><br/>6. Follow up on the command line exercises to understand the content outlined here</span></pre><p id="14ff" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在阅读第1部分之前，请继续阅读第0部分，以理解这里讨论的内容:</p><div class="lp lq gp gr lr ls"><a rel="noopener  ugc nofollow" target="_blank" href="/breaking-down-containers-part-0-system-architecture-37afe0e51770"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd iu gy z fp lx fr fs ly fu fw is bi translated">分解容器|第0部分—系统架构</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">本文中需要注意的事项</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">itnext.io</p></div></div><div class="mb l"><div class="mc l md me mf mb mg jv ls"/></div></div></a></div></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><p id="ef26" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">对于这一点，我们将在下面详细介绍:</p><ol class=""><li id="ea52" class="mo mp it kd b ke kf ki kj km mq kq mr ku ms ky mt mu mv mw bi translated">系统调用</li><li id="dbf0" class="mo mp it kd b ke mx ki my km mz kq na ku nb ky mt mu mv mw bi translated">过程文件系统</li><li id="fa69" class="mo mp it kd b ke mx ki my km mz kq na ku nb ky mt mu mv mw bi translated">克鲁特</li><li id="b21f" class="mo mp it kd b ke mx ki my km mz kq na ku nb ky mt mu mv mw bi translated">名称空间</li></ol></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h1 id="0d48" class="nc lj it bd nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny bi translated">系统调用</h1><p id="2aed" class="pw-post-body-paragraph kb kc it kd b ke nz kg kh ki oa kk kl km ob ko kp kq oc ks kt ku od kw kx ky im bi translated">在我们开始这篇文章之前，我想概述一些事情来帮助理解为什么这篇文章要向C方向发展，因为受过更多教育的读者已经知道，使用这些API的大多数命令不需要编写代码就可以使用，例如chroot。</p><p id="3d0a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Linux内核是用C编写的，因此，许多通过API公开的系统和内核级功能都是用C编写的。当我说API时，我并不是指web REST或GraphQL，它们似乎掩盖了它的真正含义。</p><p id="6890" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">API是一种功能的抽象，它隐藏了该功能的所有复杂性，并通过允许单个接入点来使用它而使其更易于使用。例如，勺子是一种API，用于食用盘中的食物，同时为食物从盘中到嘴提供通道。没有勺子，我们吃东西会有困难，因为我们的嘴不适合直接从盘子里吃东西。</p><p id="ee3c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这种情况下，系统调用是内核的API，允许对内核级功能进行功能性访问。在Linux编程中，这些API是使用C库公开的</p><blockquote class="oe of og"><p id="cd3d" class="kb kc oh kd b ke kf kg kh ki kj kk kl oi kn ko kp oj kr ks kt ok kv kw kx ky im bi translated">公开chroot系统调用的API示例。</p><p id="0b3f" class="kb kc oh kd b ke kf kg kh ki kj kk kl oi kn ko kp oj kr ks kt ok kv kw kx ky im bi translated"><strong class="kd iu">#包含&lt;unistd . h&gt;T1】</strong></p><p id="9717" class="kb kc oh kd b ke kf kg kh ki kj kk kl oi kn ko kp oj kr ks kt ok kv kw kx ky im bi translated"><strong class="kd iu">int ch root(const char *</strong><em class="it">path</em><strong class="kd iu">)；</strong></p></blockquote><p id="cfcb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">你可以从这个网站上看到一些Linux系统调用</p><div class="lp lq gp gr lr ls"><a href="http://asm.sourceforge.net/syscall.html" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd iu gy z fp lx fr fs ly fu fw is bi translated">Linux/i386系统调用</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">版权所有(C) 1999-2000由康斯坦丁Boldyshev这份名单还没有准备好，并正在大力建设中，很多…</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">asm.sourceforge.net</p></div></div></div></a></div><p id="e9c5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果查看Linux系统调用，您会看到一些命令引用，如umount、chown，甚至更简单的命令，如<strong class="kd iu"> mkdir </strong>。</p><p id="8824" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了访问系统调用并确保清楚地展示容器的一些特性，使用C来展示深入的容器功能以及Docker和其他容器运行时所基于的其他linux衍生工具。</p></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h1 id="d4e4" class="nc lj it bd nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny bi translated"><strong class="ak">进程文件系统&lt;进程文件系统&gt;T11】</strong></h1><p id="0305" class="pw-post-body-paragraph kb kc it kd b ke nz kg kh ki oa kk kl km ob ko kp kq oc ks kt ku od kw kx ky im bi translated">在Linux中，正如第0部分所述，一切都是文件。因此，Linux使用与进程文件系统相同的概念来管理进程数据，对于进程文件系统，运行进程的所有配置及其配置都可以通过写入进程文件来管理。</p><div class="lp lq gp gr lr ls"><a href="https://web.archive.org/web/20190429231927/http://www.tldp.org/LDP/Linux-Filesystem-Hierarchy/html/proc.html" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd iu gy z fp lx fr fs ly fu fw is bi translated">/proc</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">proc非常特殊，因为它也是一个虚拟文件系统。它有时被称为流程信息…</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">web.archive.org</p></div></div></div></a></div><p id="6ee7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这包含了一个包含进程数据的虚拟文件系统。linux机器上的每个进程都有一个进程ID；在这个文件系统中，我们可以使用进程ID从文件系统中检索每个进程的详细信息并配置详细信息。</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="9ff6" class="li lj it le b gy lk ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~</strong>$ ls /proc</span><span id="ac83" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">1</strong>     <strong class="le iu">1095</strong>  <strong class="le iu">1153</strong>  <strong class="le iu">1201</strong>  <strong class="le iu">13</strong>    <strong class="le iu">17</strong>    <strong class="le iu">1838</strong>  <strong class="le iu">1900</strong>  <strong class="le iu">20</strong>   <strong class="le iu">21</strong>   <strong class="le iu">26</strong>   <strong class="le iu">30</strong>   <strong class="le iu">335</strong>  <strong class="le iu">37</strong>   <strong class="le iu">419</strong>  <strong class="le iu">429</strong>  <strong class="le iu">468</strong>  <strong class="le iu">8</strong>   <strong class="le iu">89</strong>   <strong class="le iu">947</strong>        cgroups   devices      fb           ioports    keys         loadavg  modules  pagetypeinfo  <strong class="le iu">self</strong>      <strong class="le iu">sys</strong>            <strong class="le iu">tty</strong>                vmstat</span><span id="fd76" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">10</strong>    <strong class="le iu">11</strong>    <strong class="le iu">1189</strong>  <strong class="le iu">122</strong>   <strong class="le iu">14</strong>    <strong class="le iu">1704</strong>  <strong class="le iu">1857</strong>  <strong class="le iu">1929</strong>  <strong class="le iu">203</strong>  <strong class="le iu">210</strong>  <strong class="le iu">27</strong>   <strong class="le iu">31</strong>   <strong class="le iu">336</strong>  <strong class="le iu">4</strong>    <strong class="le iu">42</strong>   <strong class="le iu">433</strong>  <strong class="le iu">6</strong>    <strong class="le iu">85</strong>  <strong class="le iu">9</strong>    <strong class="le iu">96</strong>         cmdline   diskstats    filesystems  <strong class="le iu">irq</strong>        kmsg         locks    <strong class="le iu">mounts</strong>   partitions    slabinfo  sysrq-trigger  uptime             zoneinfo</span><span id="6d5e" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">1032</strong>  <strong class="le iu">1105</strong>  <strong class="le iu">1193</strong>  <strong class="le iu">1222</strong>  <strong class="le iu">15</strong>    <strong class="le iu">1714</strong>  <strong class="le iu">1858</strong>  <strong class="le iu">1930</strong>  <strong class="le iu">204</strong>  <strong class="le iu">22</strong>   <strong class="le iu">28</strong>   <strong class="le iu">32</strong>   <strong class="le iu">34</strong>   <strong class="le iu">40</strong>   <strong class="le iu">420</strong>  <strong class="le iu">45</strong>   <strong class="le iu">7</strong>    <strong class="le iu">86</strong>  <strong class="le iu">90</strong>   <strong class="le iu">acpi</strong>       consoles  dma          <strong class="le iu">fs</strong>           kallsyms   kpagecgroup  mdstat   <strong class="le iu">mpt</strong>      sched_debug   softirqs  <strong class="le iu">sysvipc</strong>        version</span><span id="2730" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">1038</strong>  <strong class="le iu">1106</strong>  <strong class="le iu">1195</strong>  <strong class="le iu">1256</strong>  <strong class="le iu">16</strong>    <strong class="le iu">18</strong>    <strong class="le iu">1892</strong>  <strong class="le iu">1933</strong>  <strong class="le iu">206</strong>  <strong class="le iu">24</strong>   <strong class="le iu">283</strong>  <strong class="le iu">327</strong>  <strong class="le iu">35</strong>   <strong class="le iu">41</strong>   <strong class="le iu">421</strong>  <strong class="le iu">453</strong>  <strong class="le iu">765</strong>  <strong class="le iu">87</strong>  <strong class="le iu">913</strong>  buddyinfo  cpuinfo   <strong class="le iu">driver</strong>       interrupts   kcore      kpagecount   meminfo  mtrr     schedstat     stat      <strong class="le iu">thread-self</strong>    version_signature</span><span id="5b16" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">105</strong>   <strong class="le iu">1141</strong>  <strong class="le iu">12</strong>    <strong class="le iu">1274</strong>  <strong class="le iu">1695</strong>  <strong class="le iu">1836</strong>  <strong class="le iu">19</strong>    <strong class="le iu">2</strong>     <strong class="le iu">207</strong>  <strong class="le iu">25</strong>   <strong class="le iu">29</strong>   <strong class="le iu">33</strong>   <strong class="le iu">36</strong>   <strong class="le iu">418</strong>  <strong class="le iu">428</strong>  <strong class="le iu">454</strong>  <strong class="le iu">789</strong>  <strong class="le iu">88</strong>  <strong class="le iu">933</strong>  <strong class="le iu">bus</strong>        crypto    execdomains  iomem        key-users  kpageflags   misc     <strong class="le iu">net</strong>      <strong class="le iu">scsi</strong>          swaps     timer_list     vmallocinfo</span><span id="a4d7" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~</strong>$<br/><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~</strong>$ cat /proc/cgroups</span><span id="b27f" class="li lj it le b gy ol ll l lm ln">#subsys_name hierarchy num_cgroups enabled</span><span id="53fc" class="li lj it le b gy ol ll l lm ln">cpuset 9 1 1</span><span id="5b33" class="li lj it le b gy ol ll l lm ln">cpu 2 36 1</span><span id="f9bf" class="li lj it le b gy ol ll l lm ln">cpuacct 2 36 1</span><span id="1280" class="li lj it le b gy ol ll l lm ln">blkio 8 36 1</span><span id="6465" class="li lj it le b gy ol ll l lm ln">memory 4 64 1</span><span id="d560" class="li lj it le b gy ol ll l lm ln">devices 3 36 1</span><span id="83d1" class="li lj it le b gy ol ll l lm ln">freezer 5 1 1</span><span id="8807" class="li lj it le b gy ol ll l lm ln">net_cls 6 1 1</span><span id="bfbc" class="li lj it le b gy ol ll l lm ln">perf_event 7 1 1</span><span id="9175" class="li lj it le b gy ol ll l lm ln">net_prio 6 1 1</span><span id="a929" class="li lj it le b gy ol ll l lm ln">hugetlb 11 1 1</span><span id="a9ca" class="li lj it le b gy ol ll l lm ln">pids 10 41 1</span><span id="6a79" class="li lj it le b gy ol ll l lm ln">rdma 12 1 1</span></pre><p id="2ff1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这里我们看到一个数字列表和其他文件，记下我们要返回的组。请记住，在第0部分中，容器是进程，因此在cgroups中运行的所有容器都将在主机上显示为进程。</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="92c2" class="li lj it le b gy lk ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~</strong>$ # Now let us start a long running process</span><span id="30a4" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~</strong>$ tail -f main.c &amp; echo $!</span><span id="b774" class="li lj it le b gy ol ll l lm ln">[1] 1930</span><span id="647a" class="li lj it le b gy ol ll l lm ln">1930</span></pre><p id="0ed4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在Linux中，我们有特殊的参数可以用来提取某些信息。我们用<strong class="kd iu"> $？</strong>为进程退出代码，但这里我们使用<strong class="kd iu"> $！</strong>获取进程ID。</p><p id="43fb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">更多详情请点击此处:</p><div class="lp lq gp gr lr ls"><a href="https://www.gnu.org/software/bash/manual/html_node/Special-Parameters.html" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd iu gy z fp lx fr fs ly fu fw is bi translated">特殊参数(Bash参考手册)</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">3.4.2特殊参数shell对几个参数进行了特殊处理。这些参数只能被引用…</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">www.gnu.org</p></div></div></div></a></div><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="9790" class="li lj it le b gy lk ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~</strong>$ # Let's get the process ID</span><span id="18af" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~</strong>$ export PID=$!</span><span id="7647" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~</strong>$ echo $PID</span><span id="bd0a" class="li lj it le b gy ol ll l lm ln">1930</span><span id="0a93" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~</strong>$ echo $?</span><span id="903e" class="li lj it le b gy ol ll l lm ln">0<br/><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~</strong>$ ls /proc/$PID</span><span id="9cb2" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">attr</strong>       auxv    clear_refs  comm             cpuset  environ  <strong class="le iu">fd</strong>      gid_map  limits    <strong class="le iu">map_files</strong>  mem        mounts      <strong class="le iu">net</strong>  numa_maps  oom_score      pagemap      personality  <strong class="le iu">root</strong>   schedstat  setgroups  smaps_rollup  stat   status   <strong class="le iu">task</strong>    timerslack_ns  wchan</span><span id="5fef" class="li lj it le b gy ol ll l lm ln">autogroup  cgroup  cmdline     coredump_filter  <strong class="le iu">cwd</strong>     <strong class="le iu">exe</strong>      <strong class="le iu">fdinfo</strong>  io       loginuid  maps       mountinfo  mountstats  <strong class="le iu">ns</strong>   oom_adj    oom_score_adj  patch_state  projid_map   sched  sessionid  smaps      stack         statm  syscall  timers  uid_map</span><span id="70e1" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~</strong>$</span></pre><p id="5dba" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们可以检查进程的状态，如果我在<strong class="kd iu"> top </strong>上运行一个用于显示正在运行的程序的详细信息的strace，我们注意到它同样使用了proc文件系统。这是因为所有过程细节都存储在文件中，即每个过程ID文件夹中的<strong class="kd iu"> statm </strong>和<strong class="kd iu"> status </strong>文件。</p><blockquote class="oe of og"><p id="8df5" class="kb kc oh kd b ke kf kg kh ki kj kk kl oi kn ko kp oj kr ks kt ok kv kw kx ky im bi translated"><strong class="kd iu"> /proc/PID/statm </strong></p><p id="9b97" class="kb kc oh kd b ke kf kg kh ki kj kk kl oi kn ko kp oj kr ks kt ok kv kw kx ky im bi translated">处理内存状态信息。</p><p id="9fb1" class="kb kc oh kd b ke kf kg kh ki kj kk kl oi kn ko kp oj kr ks kt ok kv kw kx ky im bi translated"><strong class="kd iu">/进程/PID/状态</strong></p><p id="248b" class="kb kc oh kd b ke kf kg kh ki kj kk kl oi kn ko kp oj kr ks kt ok kv kw kx ky im bi translated">人类可读形式的流程状态。</p></blockquote><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="b59c" class="li lj it le b gy lk ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~</strong>$ strace top | grep proc</span><span id="e136" class="li lj it le b gy ol ll l lm ln">...</span><span id="1347" class="li lj it le b gy ol ll l lm ln"># Checks if the process folder exists along with its details using the stat system call<br/># <a class="ae lo" href="http://man7.org/linux/man-pages/man2/stat.2.html" rel="noopener ugc nofollow" target="_blank">http://man7.org/linux/man-pages/man2/stat.2.html</a></span><span id="0893" class="li lj it le b gy ol ll l lm ln"><br/>stat("/proc/1193", {st_mode=S_IFDIR|0555, st_size=0, ...}) = 0</span><span id="c07b" class="li lj it le b gy ol ll l lm ln">openat(AT_FDCWD, "/proc/1193/stat", O_RDONLY) = 9</span><span id="7732" class="li lj it le b gy ol ll l lm ln">read(9, "1193 (unattended-upgr) S 1 1193 "..., 2048) = 187</span><span id="a1bf" class="li lj it le b gy ol ll l lm ln">close(9)                                = 0</span><span id="d03b" class="li lj it le b gy ol ll l lm ln"># Openat is the same as the open syscall but is relative to the directory it's called in<br/># <a class="ae lo" href="https://linux.die.net/man/2/openat" rel="noopener ugc nofollow" target="_blank">https://linux.die.net/man/2/openat</a><br/></span><span id="fc67" class="li lj it le b gy ol ll l lm ln">openat(AT_FDCWD, "/proc/1193/statm", O_RDONLY) = 9</span><span id="05cf" class="li lj it le b gy ol ll l lm ln">read(9, "46919 5099 3119 948 0 4194 0\n", 2048) = 29</span><span id="a158" class="li lj it le b gy ol ll l lm ln">close(9)                                = 0</span><span id="120b" class="li lj it le b gy ol ll l lm ln">openat(AT_FDCWD, "/proc/1193/status", O_RDONLY) = 9</span><span id="9dec" class="li lj it le b gy ol ll l lm ln">read(9, "Name:\tunattended-upgr\nUmask:\t002"..., 2048) = 1296</span><span id="8fc0" class="li lj it le b gy ol ll l lm ln">close(9)</span><span id="a679" class="li lj it le b gy ol ll l lm ln">...</span><span id="4f30" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~</strong>$ cat /proc/$PID/status</span><span id="f418" class="li lj it le b gy ol ll l lm ln">Name: tail</span><span id="74d3" class="li lj it le b gy ol ll l lm ln">Umask: 0002</span><span id="eec6" class="li lj it le b gy ol ll l lm ln">State: S (sleeping)</span><span id="59fb" class="li lj it le b gy ol ll l lm ln">Tgid: 1930</span><span id="ce8a" class="li lj it le b gy ol ll l lm ln">Ngid: 0</span><span id="9902" class="li lj it le b gy ol ll l lm ln">Pid: 1930</span><span id="6a5a" class="li lj it le b gy ol ll l lm ln">PPid: 1838</span><span id="4453" class="li lj it le b gy ol ll l lm ln">TracerPid: 0</span><span id="b954" class="li lj it le b gy ol ll l lm ln">Uid: 1000 1000 1000 1000</span><span id="982a" class="li lj it le b gy ol ll l lm ln">Gid: 1000 1000 1000 1000</span><span id="0770" class="li lj it le b gy ol ll l lm ln">FDSize: 256</span><span id="f19e" class="li lj it le b gy ol ll l lm ln">Groups: 999 1000</span><span id="a04b" class="li lj it le b gy ol ll l lm ln">NStgid: 1930</span><span id="0265" class="li lj it le b gy ol ll l lm ln">NSpid: 1930</span><span id="79e6" class="li lj it le b gy ol ll l lm ln">NSpgid: 1930</span><span id="05e4" class="li lj it le b gy ol ll l lm ln">NSsid: 1838</span><span id="7e94" class="li lj it le b gy ol ll l lm ln">VmPeak:     7960 kB</span><span id="45be" class="li lj it le b gy ol ll l lm ln">VmSize:     7960 kB</span><span id="ea3b" class="li lj it le b gy ol ll l lm ln">VmLck:        0 kB</span><span id="9c3f" class="li lj it le b gy ol ll l lm ln">VmPin:        0 kB</span><span id="399f" class="li lj it le b gy ol ll l lm ln">VmHWM:      780 kB</span><span id="7652" class="li lj it le b gy ol ll l lm ln">VmRSS:      780 kB</span><span id="8e93" class="li lj it le b gy ol ll l lm ln">RssAnon:       64 kB</span><span id="f26a" class="li lj it le b gy ol ll l lm ln">RssFile:      716 kB</span><span id="ce33" class="li lj it le b gy ol ll l lm ln">RssShmem:        0 kB</span><span id="560a" class="li lj it le b gy ol ll l lm ln">VmData:      176 kB</span><span id="0db7" class="li lj it le b gy ol ll l lm ln">VmStk:      132 kB</span><span id="9cfa" class="li lj it le b gy ol ll l lm ln">VmExe:       64 kB</span><span id="f12d" class="li lj it le b gy ol ll l lm ln">VmLib:     2112 kB</span><span id="1c99" class="li lj it le b gy ol ll l lm ln">VmPTE:       60 kB</span><span id="fe83" class="li lj it le b gy ol ll l lm ln">VmSwap:        0 kB</span><span id="3d37" class="li lj it le b gy ol ll l lm ln">HugetlbPages:        0 kB</span><span id="cea7" class="li lj it le b gy ol ll l lm ln">CoreDumping: 0</span><span id="62b0" class="li lj it le b gy ol ll l lm ln">Threads: 1</span><span id="1f56" class="li lj it le b gy ol ll l lm ln">SigQ: 0/3841</span><span id="b544" class="li lj it le b gy ol ll l lm ln">SigPnd: 0000000000000000</span><span id="9725" class="li lj it le b gy ol ll l lm ln">ShdPnd: 0000000000000000</span><span id="1319" class="li lj it le b gy ol ll l lm ln">SigBlk: 0000000000000000</span><span id="ddfe" class="li lj it le b gy ol ll l lm ln">SigIgn: 0000000000000000</span><span id="60c6" class="li lj it le b gy ol ll l lm ln">SigCgt: 0000000000000000</span><span id="67fb" class="li lj it le b gy ol ll l lm ln">CapInh: 0000000000000000</span><span id="558c" class="li lj it le b gy ol ll l lm ln">CapPrm: 0000000000000000</span><span id="ac74" class="li lj it le b gy ol ll l lm ln">CapEff: 0000000000000000</span><span id="edc0" class="li lj it le b gy ol ll l lm ln">CapBnd: 0000003fffffffff</span><span id="4204" class="li lj it le b gy ol ll l lm ln">CapAmb: 0000000000000000</span><span id="b364" class="li lj it le b gy ol ll l lm ln">NoNewPrivs: 0</span><span id="d645" class="li lj it le b gy ol ll l lm ln">Seccomp: 0</span><span id="2678" class="li lj it le b gy ol ll l lm ln">Speculation_Store_Bypass: vulnerable</span><span id="c26a" class="li lj it le b gy ol ll l lm ln">Cpus_allowed: 3</span><span id="58af" class="li lj it le b gy ol ll l lm ln">Cpus_allowed_list: 0-1</span><span id="b097" class="li lj it le b gy ol ll l lm ln">Mems_allowed: 00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000001</span><span id="bb2c" class="li lj it le b gy ol ll l lm ln">Mems_allowed_list: 0</span><span id="7c00" class="li lj it le b gy ol ll l lm ln">voluntary_ctxt_switches: 1</span><span id="82d7" class="li lj it le b gy ol ll l lm ln">nonvoluntary_ctxt_switches: 1</span></pre><p id="f3ef" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">上面的细节是流程的状态细节，像Seccomp这样的活动都嵌入在流程状态中。</p><p id="b5bd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果我们对cgroup文件进行cat，我们将获得第0部分中概述的cgroup列表的以下详细信息。这里我们开始了解linux是如何管理cgroups的。当我们在一个名称空间下设置启用了cgroups的流程时，我们会看到这种差异。</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="ece4" class="li lj it le b gy lk ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~</strong>$ cat /proc/$PID/cgroup</span><span id="7fa8" class="li lj it le b gy ol ll l lm ln">12:rdma:/</span><span id="90fb" class="li lj it le b gy ol ll l lm ln">11:hugetlb:/</span><span id="96d5" class="li lj it le b gy ol ll l lm ln">10:pids:/user.slice/user-1000.slice/session-1.scope</span><span id="ee23" class="li lj it le b gy ol ll l lm ln">9:cpuset:/</span><span id="6cde" class="li lj it le b gy ol ll l lm ln">8:blkio:/user.slice</span><span id="84b7" class="li lj it le b gy ol ll l lm ln">7:perf_event:/</span><span id="11c4" class="li lj it le b gy ol ll l lm ln">6:net_cls,net_prio:/</span><span id="5c49" class="li lj it le b gy ol ll l lm ln">5:freezer:/</span><span id="82a7" class="li lj it le b gy ol ll l lm ln">4:memory:/user.slice</span><span id="ee2c" class="li lj it le b gy ol ll l lm ln">3:devices:/user.slice</span><span id="77fd" class="li lj it le b gy ol ll l lm ln">2:cpu,cpuacct:/user.slice</span><span id="cdf7" class="li lj it le b gy ol ll l lm ln">1:name=systemd:/user.slice/user-1000.slice/session-1.scope</span><span id="d9d2" class="li lj it le b gy ol ll l lm ln">0::/user.slice/user-1000.slice/session-1.scope</span></pre><p id="3f41" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果我们对名称空间<code class="fe om on oo le b">ns</code>做同样的事情，我们会得到随机过程的以下细节</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="bd42" class="li lj it le b gy lk ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~</strong>$ sudo ls -l /proc/1900/ns</span><span id="4ac3" class="li lj it le b gy ol ll l lm ln">total 0</span><span id="d7f3" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 15 15:03 cgroup -&gt; 'cgroup:[4026531835]'</span><span id="e604" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 15 15:03 ipc -&gt; 'ipc:[4026531839]'</span><span id="ee46" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 15 15:03 mnt -&gt; 'mnt:[4026531840]'</span><span id="8cc0" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 15 15:03 net -&gt; 'net:[4026531993]'</span><span id="30c4" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 15 15:03 pid -&gt; 'pid:[4026531836]'</span><span id="1b27" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 15 15:03 pid_for_children -&gt; 'pid:[4026531836]'</span><span id="ee43" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 15 15:03 user -&gt; 'user:[4026531837]'</span><span id="93c7" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 15 15:03 uts -&gt; 'uts:[4026531838]'</span></pre><p id="1b86" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果我们对自己的流程做同样的事情，我们会得到同样的结果。这就是我们如何识别这两个进程在同一个名称空间中运行，尽管前一个进程由不同的用户<strong class="kd iu"> root所有。</strong></p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="fad3" class="li lj it le b gy lk ll l lm ln"># You can also use the <strong class="le iu">readlink</strong> command to view the details about the individual namespace of a process</span><span id="c53a" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~/oci-containers/container</strong>$ readlink /proc/$PID/ns/mnt</span><span id="b6e3" class="li lj it le b gy ol ll l lm ln">mnt:[4026531840]</span></pre><p id="bfa7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">名称空间不是用户定义的，事实上我们可以在不同用户环境中的程序间共享不同的名称空间。</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="1a09" class="li lj it le b gy lk ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~</strong>$ sudo ls -l /proc/$PID/ns</span><span id="017f" class="li lj it le b gy ol ll l lm ln">total 0<br/><strong class="le iu"># Notice it's vagrant and not root here</strong></span><span id="5e17" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 15 15:03 cgroup -&gt; 'cgroup:[4026531835]'</span><span id="e164" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 15 15:03 ipc -&gt; 'ipc[4026531839]'</span><span id="d59a" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 15 15:03 mnt -&gt; 'mnt[4026531840]'</span><span id="aa4f" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 15 15:03 net -&gt; 'net[4026531993]'</span><span id="150c" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 15 15:03 pid -&gt; 'pid[4026531836]'</span><span id="e94c" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 15 15:03 pid_for_children -&gt;'pid:[4026531836]'</span><span id="dc6e" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 15 15:03 user -&gt; 'user:[4026531837]'</span><span id="2327" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 15 15:03 uts -&gt; 'uts[4026531838]'</span></pre><p id="3642" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当我们开始在名称空间中运行进程并使用cgroups限制资源时，我们将回头讨论所有这些和其他细节。</p></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h1 id="4ffc" class="nc lj it bd nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny bi translated"><strong class="ak"> CHROOT </strong></h1><p id="17b2" class="pw-post-body-paragraph kb kc it kd b ke nz kg kh ki oa kk kl km ob ko kp kq oc ks kt ku od kw kx ky im bi translated">这意味着“<strong class="kd iu"> CH </strong>安歌<strong class="kd iu"> ROOT </strong>”，它提供了一种将文件系统的根目录更改为另一个的方法。</p><p id="32bc" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在Linux中，我们在<strong class="kd iu"> unistd.h </strong>库下有chroot库。</p><div class="lp lq gp gr lr ls"><a href="http://man7.org/linux/man-pages/man0/unistd.h.0p.html" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd iu gy z fp lx fr fs ly fu fw is bi translated">unistd.h.0p - Linux手册页</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">unistd.h(0P) POSIX程序员手册unistd.h(0P)该手册页是POSIX程序员手册的一部分。的…</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">man7.org</p></div></div><div class="mb l"><div class="op l md me mf mb mg jv ls"/></div></div></a></div><p id="e937" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Chroot允许我们将根从我们的文件系统更改到另一个文件系统。因为chroot使用linux文件系统，这是一个用于一堆文件夹的时髦词汇，所以我们需要准备一个基本的linux文件系统。要做到这一点，我们可以使用图像，而不是docker图像。映像是包含linux文件系统的压缩文件夹。您可以使用以下命令从docker容器中提取一个:</p><blockquote class="oe of og"><p id="59db" class="kb kc oh kd b ke kf kg kh ki kj kk kl oi kn ko kp oj kr ks kt ok kv kw kx ky im bi translated">RM-r ./root fs；mkdir rootfsdocker export $(docker create alpine)| tar-C rootfs-xvf-</p></blockquote><p id="99e5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了使代码入口点过程更容易，我用C编写了一个入口点，这里有到repo的链接</p><div class="lp lq gp gr lr ls"><a href="https://github.com/Tiemma/oci-containers/tree/master" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd iu gy z fp lx fr fs ly fu fw is bi translated">tiemma/OCI-集装箱</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">这个报告是在这里的功能内容的容器，有关容器运行时，OCI规范和如何…</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">github.com</p></div></div><div class="mb l"><div class="oq l md me mf mb mg jv ls"/></div></div></a></div><blockquote class="oe of og"><p id="051e" class="kb kc oh kd b ke kf kg kh ki kj kk kl oi kn ko kp oj kr ks kt ok kv kw kx ky im bi translated">流浪起来</p><p id="2f50" class="kb kc oh kd b ke kf kg kh ki kj kk kl oi kn ko kp oj kr ks kt ok kv kw kx ky im bi translated">流浪宋承宪</p></blockquote><p id="479a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">由于所使用的库，代码不仅在Linux机器上工作，在POSIX兼容的系统上也可以使用C库。更多受过教育的读者知道，由于其POSIX API兼容性，它可以在Mac和其他操作系统上使用，但它不具有与linux库变体相同的标志。我默认为流浪者，以确保环境复制，因为这在测试中的问题较少。</p><div class="lp lq gp gr lr ls"><a href="https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man2/mount.2.html" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd iu gy z fp lx fr fs ly fu fw is bi translated">用于安装的Mac OS X手册页(2)</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">本文档是Mac OS X手册页。手册页是一种提供文档的命令行技术。你…</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">developer.apple.com</p></div></div></div></a></div><div class="lp lq gp gr lr ls"><a href="https://en.wikipedia.org/wiki/POSIX#POSIX-oriented_operating_systems" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd iu gy z fp lx fr fs ly fu fw is bi translated">可移植性操作系统接口</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">可移植操作系统接口(POSIX)是由IEEE计算机协会为…</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">en.wikipedia.org</p></div></div></div></a></div><p id="fb6b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一个浮动文件可以用来启动一个配置为使用<strong class="kd iu"> ubuntu 18:04 </strong>的linux机器，并且还可以提供实例。</p><p id="0328" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一旦进入流浪者外壳，你就可以访问位于<strong class="kd iu"> oci-containers/container </strong>文件夹中代码库旁边的终端。在本文的整个期间，这将是代码库的参考报告。</p><p id="8cc1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们开始测试，我们首先编译<strong class="kd iu"> C </strong>代码并得到二进制代码</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="402f" class="li lj it le b gy lk ll l lm ln"># You can change <strong class="le iu">chroot</strong> to be any name you desire</span><span id="0b2b" class="li lj it le b gy ol ll l lm ln">cd oci-containers/container/</span><span id="bfc2" class="li lj it le b gy ol ll l lm ln">gcc main.c -o containers</span></pre><p id="3109" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这将编译代码并构建一个名为<strong class="kd iu"> containers </strong>的二进制文件。为了测试chroot，让我们使用一个alpine二进制文件&lt; apk &gt;来访问我们的linux映像上没有的功能，它是一个<strong class="kd iu">a</strong>lpine<strong class="kd iu">p</strong>AC<strong class="kd iu">k</strong>年龄管理器。</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="a81e" class="li lj it le b gy lk ll l lm ln"><strong class="le iu"><br/>vagrant@ubuntu-bionic</strong>:<strong class="le iu">~</strong>$ apk</span><span id="b07f" class="li lj it le b gy ol ll l lm ln"><strong class="le iu"># Without chroot, we get this</strong></span><span id="2bfe" class="li lj it le b gy ol ll l lm ln">Command 'apk' not found, did you mean:</span><span id="7dd2" class="li lj it le b gy ol ll l lm ln">command 'apm' from snap atom (1.41.0)</span><span id="c648" class="li lj it le b gy ol ll l lm ln">command 'ark' from snap ark (19.08.0)</span><span id="12e5" class="li lj it le b gy ol ll l lm ln">command 'apf' from deb apf-firewall</span><span id="640e" class="li lj it le b gy ol ll l lm ln">command 'apg' from deb apg</span><span id="035b" class="li lj it le b gy ol ll l lm ln">command 'awk' from deb gawk</span><span id="e5b5" class="li lj it le b gy ol ll l lm ln">command 'awk' from deb mawk</span><span id="129c" class="li lj it le b gy ol ll l lm ln">command 'awk' from deb original-awk</span><span id="0303" class="li lj it le b gy ol ll l lm ln">command 'ark' from deb ark</span><span id="99eb" class="li lj it le b gy ol ll l lm ln">command 'ask' from deb ask</span><span id="e612" class="li lj it le b gy ol ll l lm ln">command 'apm' from deb apmd</span><span id="a5c1" class="li lj it le b gy ol ll l lm ln">command 'apt' from deb apt</span><span id="bb6e" class="li lj it le b gy ol ll l lm ln">command 'ack' from deb ack</span><span id="873a" class="li lj it le b gy ol ll l lm ln">See 'snap info &lt;snapname&gt;' for additional versions.</span></pre><p id="f2e1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们使用我们设计的脚本来访问alpine映像并运行apk命令。</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="27b8" class="li lj it le b gy lk ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~/oci-containers/container</strong>$ sudo ./containers image mount chroot </span><span id="077d" class="li lj it le b gy ol ll l lm ln">image: 210716097704</span><span id="6320" class="li lj it le b gy ol ll l lm ln">Extracting base image for chroot using Docker and command: {rm -r ./rootfs; mkdir rootfs; docker export $(docker create alpine) | tar -C rootfs -xvf -}</span><span id="9ccd" class="li lj it le b gy ol ll l lm ln">Executing command: rm -r ./rootfs; mkdir rootfs; docker export $(docker create alpine) | tar -C rootfs -xvf -</span><span id="0f42" class="li lj it le b gy ol ll l lm ln">Output:</span><span id="596e" class="li lj it le b gy ol ll l lm ln">.dockerenv</span><span id="e356" class="li lj it le b gy ol ll l lm ln">bin/<br/><strong class="le iu">...some other files...</strong></span><span id="ef46" class="li lj it le b gy ol ll l lm ln">var/tmp/<br/></span><span id="eebc" class="li lj it le b gy ol ll l lm ln">mount: 210720935288</span><span id="3869" class="li lj it le b gy ol ll l lm ln">Mounting directories for chroot {proc sys dev}</span><span id="1495" class="li lj it le b gy ol ll l lm ln">Mounting directory /proc on ./rootfs/proc</span><span id="9044" class="li lj it le b gy ol ll l lm ln">No errors happened, talk about a lucky run!</span><span id="0397" class="li lj it le b gy ol ll l lm ln">Mounted directory /proc on ./rootfs/proc successfully</span><span id="0922" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">... some other outputs ....</strong></span><span id="8fc7" class="li lj it le b gy ol ll l lm ln">chroot: 6953391102356</span><span id="a4a6" class="li lj it le b gy ol ll l lm ln">Chrooting into environment</span><span id="17d7" class="li lj it le b gy ol ll l lm ln">No errors happened, talk about a lucky run!</span><span id="98d4" class="li lj it le b gy ol ll l lm ln">Chrooted into directory ./rootfs successfully<br/></span><span id="092c" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">Executing command: ls</strong></span><span id="6b19" class="li lj it le b gy ol ll l lm ln">Output:</span><span id="c74f" class="li lj it le b gy ol ll l lm ln">bin<br/><strong class="le iu">...some other files...</strong></span><span id="e993" class="li lj it le b gy ol ll l lm ln">var</span><span id="cc36" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">Executing command: apk </strong></span><span id="6ccf" class="li lj it le b gy ol ll l lm ln"><strong class="le iu"># Notice this command works after a chroot</strong></span><span id="6e87" class="li lj it le b gy ol ll l lm ln">Output:</span><span id="1cfd" class="li lj it le b gy ol ll l lm ln">apk-tools 2.10.4, compiled for x86_64.<br/></span><span id="1de1" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">...some other outputs...</strong></span><span id="4a6f" class="li lj it le b gy ol ll l lm ln">Use apk &lt;command&gt; --help for command-specific help.</span><span id="7422" class="li lj it le b gy ol ll l lm ln">Use apk --help --verbose for a full command listing.</span><span id="68d1" class="li lj it le b gy ol ll l lm ln">This apk has coffee making abilities.</span><span id="3358" class="li lj it le b gy ol ll l lm ln"><br/><strong class="le iu"># Here we exit the chroot environment </strong></span><span id="cfc3" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">Running 'exit' on the next prompt to get out of chroot&gt;&gt;&gt;&gt;</strong></span><span id="1732" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">Executing command: exit</strong></span><span id="8750" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">Output:</strong></span><span id="023b" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">Exiting chroot environments</strong><br/></span><span id="3c9f" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">Executing command: apk</strong></span><span id="157f" class="li lj it le b gy ol ll l lm ln"><strong class="le iu"># Notice this command now works even after exiting the shell which means we are still in the chroot</strong></span><span id="2ca6" class="li lj it le b gy ol ll l lm ln">Output:</span><span id="8c05" class="li lj it le b gy ol ll l lm ln">apk-tools 2.10.4, compiled for x86_64.</span><span id="8a3c" class="li lj it le b gy ol ll l lm ln">Installing and removing packages:</span><span id="75f6" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">...some other outputs...</strong></span><span id="bd7b" class="li lj it le b gy ol ll l lm ln">Use apk &lt;command&gt; --help for command-specific help.</span><span id="43c5" class="li lj it le b gy ol ll l lm ln">Use apk --help --verbose for a full command listing.</span><span id="eb31" class="li lj it le b gy ol ll l lm ln">This apk has coffee making abilities.</span><span id="a120" class="li lj it le b gy ol ll l lm ln">&gt;&gt;&gt;&gt;&gt;&gt;</span><span id="65ef" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">Sike!, You can't exit out of the chroot cause that'd be a jail break and you'd access the main shell of the user</strong></span></pre><p id="37f1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了继续，现在让我们手动进入chroot并运行apk，您会注意到我们得到了确切的响应，但是这次shell关闭了。我们得到它是因为我们在主外壳中运行。</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="bd65" class="li lj it le b gy lk ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~/oci-containers/container</strong>$ sudo chroot rootfs/ apk</span><span id="6b35" class="li lj it le b gy ol ll l lm ln">apk-tools 2.10.4, compiled for x86_64.</span><span id="e585" class="li lj it le b gy ol ll l lm ln">Installing and removing packages:</span><span id="7d05" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">...some other outputs...</strong></span><span id="7f5d" class="li lj it le b gy ol ll l lm ln">Use apk &lt;command&gt; --help for command-specific help.</span><span id="b468" class="li lj it le b gy ol ll l lm ln">Use apk --help --verbose for a full command listing.</span><span id="572a" class="li lj it le b gy ol ll l lm ln">This apk has coffee making abilities.</span></pre></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><blockquote class="or"><p id="9814" class="os ot it bd ou ov ow ox oy oz pa ky dk translated">为什么我要做这一切？</p></blockquote></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><p id="082a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这是为了展示chroot相对于docker exec的威力。您会注意到，我们没有隔离的运行时环境，因为资源没有在名称空间中隔离。<br/>我们使用<strong class="kd iu"> ifconfig </strong>检查这一点，看看我们是如何没有网络隔离的，即使没有安装<strong class="kd iu"> proc </strong>。</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="204a" class="li lj it le b gy lk ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~/oci-containers/container</strong>$ sudo ./containers unmount</span><span id="8b4c" class="li lj it le b gy ol ll l lm ln">unmount: 229485381690395</span><span id="ea45" class="li lj it le b gy ol ll l lm ln">Unmounting directories for chroot {proc sys dev}</span><span id="b6ef" class="li lj it le b gy ol ll l lm ln">Errors for mounts:</span><span id="9d16" class="li lj it le b gy ol ll l lm ln">No errors happened, talk about a lucky run!<br/></span><span id="d771" class="li lj it le b gy ol ll l lm ln">Mount: Success</span><span id="cdde" class="li lj it le b gy ol ll l lm ln">Unmounted directory /proc on ./rootfs/proc successfully<br/></span><span id="7d86" class="li lj it le b gy ol ll l lm ln">Errors for mounts:</span><span id="3c17" class="li lj it le b gy ol ll l lm ln">No errors happened, talk about a lucky run!<br/></span><span id="9e99" class="li lj it le b gy ol ll l lm ln">Mount: Success</span><span id="a265" class="li lj it le b gy ol ll l lm ln">Unmounted directory /sys on ./rootfs/sys successfully<br/></span><span id="4727" class="li lj it le b gy ol ll l lm ln">Errors for mounts:</span><span id="8a8d" class="li lj it le b gy ol ll l lm ln">No errors happened, talk about a lucky run!<br/></span><span id="b23a" class="li lj it le b gy ol ll l lm ln">Mount: Success</span><span id="918d" class="li lj it le b gy ol ll l lm ln">Unmounted directory /dev on ./rootfs/dev successfully</span><span id="beeb" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~/oci-containers/container</strong>$ sudo chroot rootfs/ ifconfig</span><span id="3d55" class="li lj it le b gy ol ll l lm ln">ifconfig: <strong class="le iu">/proc/net/dev:</strong> No such file or directory</span><span id="ba96" class="li lj it le b gy ol ll l lm ln">docker0   Link encap:Ethernet  HWaddr 02:42:D8:C2:F1:8E</span><span id="5382" class="li lj it le b gy ol ll l lm ln">inet addr:172.17.0.1  Bcast:172.17.255.255  Mask:255.255.0.0</span><span id="60f4" class="li lj it le b gy ol ll l lm ln">UP BROADCAST MULTICAST  MTU:1500  Metric:1</span><span id="9d15" class="li lj it le b gy ol ll l lm ln">enp0s3    Link encap:Ethernet  HWaddr 02:7C:06:17:A1:8B</span><span id="44bb" class="li lj it le b gy ol ll l lm ln">inet addr:10.0.2.15  Bcast:10.0.2.255  Mask:255.255.255.0</span><span id="8e8a" class="li lj it le b gy ol ll l lm ln">UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><span id="5f2f" class="li lj it le b gy ol ll l lm ln">lo        Link encap:Local Loopback</span><span id="cc15" class="li lj it le b gy ol ll l lm ln">inet addr:127.0.0.1  Mask:255.0.0.0</span><span id="a75e" class="li lj it le b gy ol ll l lm ln">UP LOOPBACK RUNNING  MTU:65536  Metric:1</span></pre></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h1 id="baf5" class="nc lj it bd nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny bi translated">名称空间</h1><p id="f8b5" class="pw-post-body-paragraph kb kc it kd b ke nz kg kh ki oa kk kl km ob ko kp kq oc ks kt ku od kw kx ky im bi translated">从前面chroot的上下文中，我们可以看到，我们现在可以使用来自非本地文件系统的命令，尽管这不允许将exec之外的文件系统隔离到外部文件系统中。</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="747b" class="li lj it le b gy lk ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~/oci-containers/container</strong>$ sudo ./containers namespace</span><span id="f4e7" class="li lj it le b gy ol ll l lm ln">namespace: 249899181367082546</span><span id="a518" class="li lj it le b gy ol ll l lm ln">Exec into a shell in a new namespace</span><span id="9728" class="li lj it le b gy ol ll l lm ln">Executing command: rm -r /newroot</span><span id="9502" class="li lj it le b gy ol ll l lm ln">Output:</span><span id="d3be" class="li lj it le b gy ol ll l lm ln">Exec command: Success</span><span id="7014" class="li lj it le b gy ol ll l lm ln">mkdir: Success<br/></span><span id="61f2" class="li lj it le b gy ol ll l lm ln">Mounting tmpfs filesystem for pivot_root</span><span id="71fc" class="li lj it le b gy ol ll l lm ln">Errors for mounts:</span><span id="9e8a" class="li lj it le b gy ol ll l lm ln">No errors happened, talk about a lucky run!</span><span id="8206" class="li lj it le b gy ol ll l lm ln">Mount: Success<br/></span><span id="fb6f" class="li lj it le b gy ol ll l lm ln">Executing command: find . -depth -xdev -print | cpio -pd --quiet /newroot</span><span id="d6bc" class="li lj it le b gy ol ll l lm ln">Output:</span><span id="98e8" class="li lj it le b gy ol ll l lm ln">Exec command: Success</span><span id="56b6" class="li lj it le b gy ol ll l lm ln">pivot_root: Success</span><span id="7f04" class="li lj it le b gy ol ll l lm ln">Errors for chroot:</span><span id="1e4a" class="li lj it le b gy ol ll l lm ln">No errors happened, talk about a lucky run!</span><span id="dc9d" class="li lj it le b gy ol ll l lm ln">chroot: Success</span><span id="8021" class="li lj it le b gy ol ll l lm ln">Chrooted into directory / successfully<br/></span><span id="0abd" class="li lj it le b gy ol ll l lm ln"><strong class="le iu"># The Chroot doesn't protect me from isolating my network configurations for example, all my adapters are shared if I don't unshare first.</strong></span><span id="6253" class="li lj it le b gy ol ll l lm ln">/ # <strong class="le iu">ifconfig</strong></span><span id="5dda" class="li lj it le b gy ol ll l lm ln">ifconfig: /proc/net/dev: No such file or directory</span><span id="4e3c" class="li lj it le b gy ol ll l lm ln">docker0   Link encap:Ethernet  HWaddr 02:42:92:BD:5F:2B</span><span id="e1da" class="li lj it le b gy ol ll l lm ln">inet addr:172.17.0.1  Bcast:172.17.255.255  Mask:255.255.0.0</span><span id="b8b3" class="li lj it le b gy ol ll l lm ln">UP BROADCAST MULTICAST  MTU:1500  Metric:1</span><span id="dc0c" class="li lj it le b gy ol ll l lm ln">enp0s3    Link encap:Ethernet  HWaddr 02:7C:06:17:A1:8B</span><span id="2ac3" class="li lj it le b gy ol ll l lm ln">inet addr:10.0.2.15  Bcast:10.0.2.255  Mask:255.255.255.0</span><span id="da57" class="li lj it le b gy ol ll l lm ln">UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><span id="a4a8" class="li lj it le b gy ol ll l lm ln">lo        Link encap:Local Loopback</span><span id="e44a" class="li lj it le b gy ol ll l lm ln">inet addr:127.0.0.1  Mask:255.0.0.0</span><span id="f856" class="li lj it le b gy ol ll l lm ln">UP LOOPBACK RUNNING  MTU:65536  Metric:1</span></pre><p id="8e28" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">名称空间是我们用来定义我们可以看到什么，从而隔离我们不希望共享的环境。在上一篇文章中，我们介绍了不同种类的名称空间，这里已经对它们进行了概述。</p><p id="6cbd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，是时候看看它们的实际应用了，它们对你看待容器的方式产生了巨大的改变。</p><p id="788f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们从定义希望使用的名称空间开始。linux中的名称空间是由sched.h库中的unshare提供的。</p><div class="lp lq gp gr lr ls"><a href="http://man7.org/linux/man-pages/man2/unshare.2.html" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd iu gy z fp lx fr fs ly fu fw is bi translated">unshare(2) - Linux手册页</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">UNSHARE(2) Linux程序员手册UNSHARE(2)UNSHARE——解除流程执行上下文部分的关联unshare()…</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">man7.org</p></div></div><div class="mb l"><div class="pb l md me mf mb mg jv ls"/></div></div></a></div><div class="lp lq gp gr lr ls"><a href="https://code.woboq.org/gcc/include/sched.h.html" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd iu gy z fp lx fr fs ly fu fw is bi translated">sched.h源代码[include/sched.h] - Woboq代码浏览器</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">版权所有(C) 1996-2017自由软件基金会。</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">code.woboq.org</p></div></div></div></a></div><p id="bcbe" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了开始了解名称空间，让我们记下进程的当前名称空间。我们需要验证我们确实改变了名称空间。</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="e448" class="li lj it le b gy lk ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~/oci-containers/container</strong>$ tail -f run.h &amp;</span><span id="b8a0" class="li lj it le b gy ol ll l lm ln">[1] 2238</span><span id="fe87" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~/oci-containers/container</strong>$ ls -l /proc/$!/ns</span><span id="3e5d" class="li lj it le b gy ol ll l lm ln">total 0</span><span id="cd28" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 10:23 <strong class="le iu">cgroup</strong> -&gt; <strong class="le iu">'cgroup:[4026531835]'</strong></span><span id="e8f5" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 10:23 <strong class="le iu">ipc</strong> -&gt; <strong class="le iu">'ipc:[4026531839]'</strong></span><span id="5ef1" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 10:23 <strong class="le iu">mnt</strong> -&gt; <strong class="le iu">'mnt:[4026531840]'</strong></span><span id="c659" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 10:23 <strong class="le iu">net</strong> -&gt; <strong class="le iu">'net:[4026531993]'</strong></span><span id="5a99" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 10:23 <strong class="le iu">pid</strong> -&gt; <strong class="le iu">'pid:[4026531836]'</strong></span><span id="80b0" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 10:23 <strong class="le iu">pid_for_children</strong> -&gt; <strong class="le iu">'pid:[4026531836]'</strong></span><span id="b783" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 10:23 <strong class="le iu">user</strong> -&gt; <strong class="le iu">'user:[4026531837]'</strong></span><span id="3610" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 10:23 <strong class="le iu">uts</strong> -&gt; <strong class="le iu">'uts:[4026531838]'</strong></span></pre><p id="6a35" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下一件事是初始化名称空间。为此，我们可以使用方便的chroot脚本传递unshare参数来设置名称空间。</p><p id="ae1e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">检查<strong class="kd iu"> unshare_command </strong>函数，我们可以看到这些标志在起作用。</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="2216" class="li lj it le b gy lk ll l lm ln">case 'i':<br/>    flags |= CLONE_NEWIPC;<br/>    yellow("Added IPC flag");<br/>    break;<br/>case 'm':<br/>    flags |= CLONE_NEWNS;<br/>    yellow("Added mount flag");<br/>    break;<br/>case 'n':<br/>    flags |= CLONE_NEWNET;<br/>    yellow("Added network flag");<br/>    break;<br/>case 'p':<br/>    flags |= CLONE_NEWPID;<br/>    yellow("Added PID flag");<br/>    break;<br/>case 'u':<br/>    flags |= CLONE_NEWUTS;<br/>    yellow("Added UTS flag");<br/>    break;<br/>case 'U':<br/>    flags |= CLONE_NEWUSER;<br/>    yellow("Added user flag");<br/>    break;<br/>case 'c':<br/>    flags |= CLONE_NEWCGROUP;<br/>    yellow("Added cgroup flag");<br/>    break;<br/>default:<br/>    printf("\nInvalid flag supplied: %d", opts[i]);<br/>    break;<br/>}</span></pre><p id="9001" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这里，我们添加了标志，以便能够为希望运行的进程创建特定的名称空间。</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="1668" class="li lj it le b gy lk ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~/oci-containers/container</strong>$ gcc main.c -o containers</span><span id="ae2e" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~/oci-containers/container</strong>$ sudo ./containers unshare</span><span id="3a2a" class="li lj it le b gy ol ll l lm ln">unshare: 229485388532699</span><span id="80de" class="li lj it le b gy ol ll l lm ln">Setting up namespaces</span><span id="d914" class="li lj it le b gy ol ll l lm ln"><strong class="le iu"># We execute a command to make the root directory private<br/># In linux, pivot_root doesn't work with a shared subtree for a root mount point<br/># We can fix this by making the root mount point private<br/># mount("none", "/", NULL, MS_REC|MS_PRIVATE, NULL);</strong></span><span id="9189" class="li lj it le b gy ol ll l lm ln">Executing command: mount --make-rprivate /</span><span id="b2e6" class="li lj it le b gy ol ll l lm ln">Output:</span><span id="9595" class="li lj it le b gy ol ll l lm ln">Exec command: Success</span><span id="fb16" class="li lj it le b gy ol ll l lm ln"><strong class="le iu"># Here's where we define the namespace flags for the unshare command<br/># Unshare is what we use to define which namespaces we'd like to define for our processes to run in</strong></span><span id="e865" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">```main.c<br/></strong>char opts[9] = "inmuc";<br/>unshare_command(opts);</span><span id="8c82" class="li lj it le b gy ol ll l lm ln">```</span><span id="7f82" class="li lj it le b gy ol ll l lm ln">Adding namespace flags</span><span id="6428" class="li lj it le b gy ol ll l lm ln">Added IPC flag</span><span id="c273" class="li lj it le b gy ol ll l lm ln">Added network flag</span><span id="3faa" class="li lj it le b gy ol ll l lm ln">Added mount flag</span><span id="4d62" class="li lj it le b gy ol ll l lm ln">Added UTS flag</span><span id="0c70" class="li lj it le b gy ol ll l lm ln">Added cgroup flag<br/></span><span id="8a82" class="li lj it le b gy ol ll l lm ln">Running the unshare command, return status: 0</span><span id="39d1" class="li lj it le b gy ol ll l lm ln">New PID after unshare is 2332</span><span id="5f4d" class="li lj it le b gy ol ll l lm ln">unshare: Success</span></pre><p id="d9c6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">非共享标志是我们用来定义我们想要应用的名称空间的标志。</p><p id="64a6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">参考第0部分中的详细信息，我们得到了下表:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="2fce" class="li lj it le b gy lk ll l lm ln"><strong class="le iu"><em class="oh"> CLONE FLAG .   MAN DOC .             FUNCTION .   </em></strong>      <strong class="le iu">CLONE_NEWIPC    ipc_namespaces</strong>(7)     System V IPC,<br/>                                               POSIX message         <br/><strong class="le iu">CLONE_NEWNET    network_namespaces</strong>(7) Network devices,<br/>                                                stacks, ports,    <br/><strong class="le iu">CLONE_NEWNS     mount_namespaces</strong>(7)   Mount points      <br/><strong class="le iu">CLONE_NEWPID    pid_namespaces</strong>(7)     Process IDs<br/><strong class="le iu">CLONE_NEWUSER   user_namespaces</strong>(7)    User and group IDs       <strong class="le iu">CLONE_NEWUTS    uts_namespaces</strong>(7)     Hostname and NIS</span></pre><blockquote class="oe of og"><p id="4ee1" class="kb kc oh kd b ke kf kg kh ki kj kk kl oi kn ko kp oj kr ks kt ok kv kw kx ky im bi translated">【http://man7.org/linux/man-pages/man7/namespaces.7.html】来源:<a class="ae lo" href="http://man7.org/linux/man-pages/man7/namespaces.7.html" rel="noopener ugc nofollow" target="_blank"><em class="it"/></a></p></blockquote><p id="c9fb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这种情况下，我们省略了<strong class="kd iu"> CLONE_NEWPID </strong>和<strong class="kd iu"> CLONE_NEWUSER </strong>标志<strong class="kd iu"> </strong>，因为CLONE_NEWPID与我们为设置pivot_root和CLONE_NEWUSER的命令创建新进程相冲突，它为我们提供了一个没有权限在我们的名称空间中运行进程的新用户。它们将在安装过程的后期运行。</p><p id="8173" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">从这里，我们可以继续到chroot，但是这次是在名称空间中。我们再次运行chroot脚本，但是这次使用了unshare标志。这创建了一个tmpfs文件系统供我们挂载。<strong class="kd iu"> pivot_root </strong>要求挂载一个有效的linux文件系统，并且旧根目录的文件夹(我们当前的ubuntu os)位于该文件夹下。</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="1be0" class="li lj it le b gy lk ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~/oci-containers/container</strong>$ sudo ./containers unshare namespace</span><span id="e5a8" class="li lj it le b gy ol ll l lm ln">unshare: 229485388532699</span><span id="9745" class="li lj it le b gy ol ll l lm ln">Setting up namespaces</span><span id="4eeb" class="li lj it le b gy ol ll l lm ln"><strong class="le iu"># We execute a command to make the root directory private<br/># In linux, pivot_root doesn't work with a shared subtree for a root mount point<br/># We can fix this by making the root mountpoint private<br/># mount("none", "/", NULL, MS_REC|MS_PRIVATE, NULL);</strong></span><span id="d8fe" class="li lj it le b gy ol ll l lm ln">Executing command: mount --make-rprivate /</span><span id="b9b3" class="li lj it le b gy ol ll l lm ln">Output:</span><span id="0fd2" class="li lj it le b gy ol ll l lm ln">Exec command: Success</span><span id="369f" class="li lj it le b gy ol ll l lm ln"><strong class="le iu"># Here's where we define the namespace flags for the unshare command<br/># Unshare is what we use to define which namespaces we'd like to define for our processes to run in</strong></span><span id="a86a" class="li lj it le b gy ol ll l lm ln">Adding namespace flags</span><span id="8218" class="li lj it le b gy ol ll l lm ln">Added IPC flag</span><span id="c6cc" class="li lj it le b gy ol ll l lm ln">Added network flag</span><span id="c5cf" class="li lj it le b gy ol ll l lm ln">Added mount flag</span><span id="9d71" class="li lj it le b gy ol ll l lm ln">Added UTS flag</span><span id="5369" class="li lj it le b gy ol ll l lm ln">Added cgroup flag</span><span id="eed8" class="li lj it le b gy ol ll l lm ln">Running the unshare command, return status: 0</span><span id="7e25" class="li lj it le b gy ol ll l lm ln">New PID after unshare is 2332</span><span id="c513" class="li lj it le b gy ol ll l lm ln">unshare: Success</span><span id="949e" class="li lj it le b gy ol ll l lm ln">namespace: 249899181367082546</span><span id="6f48" class="li lj it le b gy ol ll l lm ln">Exec into a shell in a new namespace</span><span id="0d69" class="li lj it le b gy ol ll l lm ln"><strong class="le iu"># Here we delete the folder and recreate it, nothing fancy!</strong></span><span id="f3f9" class="li lj it le b gy ol ll l lm ln">Executing command: rm -r /newroot</span><span id="0e39" class="li lj it le b gy ol ll l lm ln">Output:</span><span id="f832" class="li lj it le b gy ol ll l lm ln">Exec command: Success</span><span id="5ef0" class="li lj it le b gy ol ll l lm ln"><br/><strong class="le iu"># Here we created the newroot and newroot/oldroot folders </strong></span><span id="8cf7" class="li lj it le b gy ol ll l lm ln">mkdir: Success</span><span id="e5c9" class="li lj it le b gy ol ll l lm ln"><br/><strong class="le iu"># We then mount the tmpfs filesystem to newroot</strong></span><span id="ae32" class="li lj it le b gy ol ll l lm ln">Mounting tmpfs filesystem for pivot_root</span><span id="ca08" class="li lj it le b gy ol ll l lm ln">Errors for mounts:</span><span id="baa1" class="li lj it le b gy ol ll l lm ln">No errors happened, talk about a lucky run!</span><span id="070e" class="li lj it le b gy ol ll l lm ln">Mount: Success</span><span id="e03b" class="li lj it le b gy ol ll l lm ln"><strong class="le iu"># We copy the filesystem from rootfs to /newroot</strong></span><span id="cb99" class="li lj it le b gy ol ll l lm ln">Executing command: find . -depth -xdev -print | cpio -pd --quiet /newroot</span><span id="4049" class="li lj it le b gy ol ll l lm ln">Output:</span><span id="b243" class="li lj it le b gy ol ll l lm ln">Exec command: Success</span><span id="48fd" class="li lj it le b gy ol ll l lm ln">pivot_root: Success</span><span id="529a" class="li lj it le b gy ol ll l lm ln"><strong class="le iu"><br/># And we finally chroot</strong></span><span id="5f75" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">Errors for chroot:</strong></span><span id="8499" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">No errors happened, talk about a lucky run!</strong></span><span id="6bf3" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">chroot: Success</strong></span><span id="2098" class="li lj it le b gy ol ll l lm ln"><br/><strong class="le iu"># We unmount the oldroot folder so only the container exists</strong></span><span id="75f3" class="li lj it le b gy ol ll l lm ln">Chrooted into directory / successfully</span><span id="174f" class="li lj it le b gy ol ll l lm ln">Unmounting oldroot</span><span id="bc92" class="li lj it le b gy ol ll l lm ln">unmount: Success</span><span id="d710" class="li lj it le b gy ol ll l lm ln">Setting up PID namespaces</span><span id="1539" class="li lj it le b gy ol ll l lm ln">Adding namespace flags</span><span id="8b7d" class="li lj it le b gy ol ll l lm ln">Added PID flag<br/></span><span id="0e51" class="li lj it le b gy ol ll l lm ln">Running the unshare command, return status: 0</span><span id="082d" class="li lj it le b gy ol ll l lm ln">New PID after unshare is 2149</span><span id="43b0" class="li lj it le b gy ol ll l lm ln">unshare: Success</span><span id="4f07" class="li lj it le b gy ol ll l lm ln">unshare_pid: Success<br/></span><span id="d5ea" class="li lj it le b gy ol ll l lm ln">/ #</span></pre><p id="0459" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">从这里，你会注意到我们像以前一样进入了一个壳。让我们像以前一样检查这个环境。通常的<strong class="kd iu"> apk </strong>命令和以前一样工作，但是有所改变。</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="709d" class="li lj it le b gy lk ll l lm ln">/ # apk</span><span id="e7cf" class="li lj it le b gy ol ll l lm ln">Output:</span><span id="afee" class="li lj it le b gy ol ll l lm ln">apk-tools 2.10.4, compiled for x86_64.</span><span id="6249" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">...some other outputs...</strong></span><span id="e26a" class="li lj it le b gy ol ll l lm ln">Use apk &lt;command&gt; --help for command-specific help.</span><span id="ee5e" class="li lj it le b gy ol ll l lm ln">Use apk --help --verbose for a full command listing.</span><span id="97c0" class="li lj it le b gy ol ll l lm ln">This apk has coffee making abilities.</span><span id="9e35" class="li lj it le b gy ol ll l lm ln">/ # ls</span><span id="8190" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">bin</strong>      <strong class="le iu">dev</strong>      <strong class="le iu">etc</strong>      <strong class="le iu">home</strong>     <strong class="le iu">lib</strong>      <strong class="le iu">media</strong>    <strong class="le iu">mnt</strong>     <strong class="le iu">opt</strong>      <strong class="le iu">proc</strong>     <strong class="le iu">root</strong>     <strong class="le iu">run</strong>      <strong class="le iu">sbin</strong>     <strong class="le iu">srv</strong>      <strong class="le iu">sys</strong>      <strong class="le iu">tmp</strong>     <strong class="le iu">usr</strong>      <strong class="le iu">var</strong></span></pre><p id="b43e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">还记得我们为命名空间添加的标志吗</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="1dc7" class="li lj it le b gy lk ll l lm ln">Added IPC flag</span><span id="15b5" class="li lj it le b gy ol ll l lm ln">Added network flag</span><span id="d0f1" class="li lj it le b gy ol ll l lm ln">Added mount flag</span><span id="f739" class="li lj it le b gy ol ll l lm ln">Added UTS flag</span><span id="2121" class="li lj it le b gy ol ll l lm ln">Added cgroup flag</span><span id="7cac" class="li lj it le b gy ol ll l lm ln">Added PID flag</span></pre><p id="7b47" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们像以前一样启动尾部进程，检查网络标志和其他名称空间</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="8322" class="li lj it le b gy lk ll l lm ln"><strong class="le iu">As opposed to the previous ifconfig, we get nothing here because the network namespace was applied. As opposed to the previous run without a namespace, this isolates the network configuration</strong></span><span id="2290" class="li lj it le b gy ol ll l lm ln">/ # ifconfig</span><span id="d2d0" class="li lj it le b gy ol ll l lm ln">/ # touch file</span><span id="e435" class="li lj it le b gy ol ll l lm ln">/ # tail -f file &amp;</span><span id="177b" class="li lj it le b gy ol ll l lm ln">/ # ps</span><span id="c9db" class="li lj it le b gy ol ll l lm ln">PID   USER     TIME  COMMAND</span><span id="edf5" class="li lj it le b gy ol ll l lm ln">1 root      0:00 sh</span><span id="6769" class="li lj it le b gy ol ll l lm ln">12 root      0:00 tail -f file</span><span id="70f8" class="li lj it le b gy ol ll l lm ln">13 root      0:00 ps</span><span id="d107" class="li lj it le b gy ol ll l lm ln">/ # echo $!</span><span id="76e1" class="li lj it le b gy ol ll l lm ln">12</span><span id="3d2c" class="li lj it le b gy ol ll l lm ln">/ # ls -l /proc/$!/ns/</span><span id="38d2" class="li lj it le b gy ol ll l lm ln">total 0</span><span id="cd68" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx    1 root     root             0 Dec 21 15:19 <strong class="le iu">cgroup</strong> -&gt; cgroup:[<strong class="le iu">4026532178</strong>]</span><span id="a7ef" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx    1 root     root             0 Dec 21 15:19 <strong class="le iu">ipc</strong> -&gt; ipc:[<strong class="le iu">4026532177</strong>]</span><span id="712c" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx    1 root     root             0 Dec 21 15:19 <strong class="le iu">mnt</strong> -&gt; mnt:[<strong class="le iu">4026532175</strong>]</span><span id="f42d" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx    1 root     root             0 Dec 21 15:19 <strong class="le iu">net</strong> -&gt; net:[<strong class="le iu">4026532180</strong>]</span><span id="650d" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx    1 root     root             0 Dec 21 15:19 <strong class="le iu">pid</strong> -&gt; pid:[<strong class="le iu">4026531836</strong>]</span><span id="2013" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx    1 root     root             0 Dec 21 15:19 <strong class="le iu">pid_for_children</strong> -&gt; pid:[<strong class="le iu">4026531836</strong>]</span><span id="338f" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx    1 root     root             0 Dec 21 15:19 <strong class="le iu">user</strong> -&gt; user:[4026531837]</span><span id="cad1" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx    1 root     root             0 Dec 21 15:19 <strong class="le iu">uts</strong> -&gt; uts:[<strong class="le iu">4026532176</strong>]</span></pre><p id="71c1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">与我们之前的结果相比:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="f2bd" class="li lj it le b gy lk ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~/oci-containers/container</strong>$ ls -l /proc/2238/ns</span><span id="2830" class="li lj it le b gy ol ll l lm ln">total 0</span><span id="b035" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 10:23 <strong class="le iu">cgroup</strong> -&gt; <strong class="le iu">'cgroup:[4026531835]'</strong></span><span id="25a4" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 10:23 <strong class="le iu">ipc</strong> -&gt; <strong class="le iu">'ipc:[4026531839]'</strong></span><span id="cb3b" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 10:23 <strong class="le iu">mnt</strong> -&gt; <strong class="le iu">'mnt:[4026531840]'</strong></span><span id="dfbd" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 10:23 <strong class="le iu">net</strong> -&gt; <strong class="le iu">'net:[4026531993]'</strong></span><span id="34b1" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 10:23 <strong class="le iu">pid</strong> -&gt; <strong class="le iu">'pid:[4026532234]'</strong></span><span id="a8f3" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 10:23 <strong class="le iu">pid_for_children</strong> -&gt; <strong class="le iu">'pid:[4026532234]'</strong></span><span id="74db" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 10:23 <strong class="le iu">user</strong> -&gt; <strong class="le iu">'user:[</strong>4026531837<strong class="le iu">]'</strong></span><span id="45e4" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 10:23 <strong class="le iu">uts</strong> -&gt; <strong class="le iu">'uts:[4026531838]'</strong></span></pre><p id="8fdd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您会注意到mnt、cgroup、ipc、net、pid和uts名称空间是不同的，它们被加粗以便于查看。因此，你会意识到我们现在对这些资源有了命名空间。</p><p id="9d8f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了最终确定这一点，让我们退出，看看我们的主机是否发生了变化。</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="c65a" class="li lj it le b gy lk ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~/oci-containers/container</strong>$ tail -f run.h &amp;</span><span id="a996" class="li lj it le b gy ol ll l lm ln">[1] 2043</span><span id="a1e7" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~/oci-containers/container</strong>$         perror("Error executing command");</span><span id="b123" class="li lj it le b gy ol ll l lm ln">}</span><span id="bf99" class="li lj it le b gy ol ll l lm ln">while (fgets(line, sizeof line, fp))</span><span id="29f7" class="li lj it le b gy ol ll l lm ln">{</span><span id="f44c" class="li lj it le b gy ol ll l lm ln">blue(line);</span><span id="41b2" class="li lj it le b gy ol ll l lm ln">}</span><span id="6750" class="li lj it le b gy ol ll l lm ln">pclose(fp);</span><span id="aede" class="li lj it le b gy ol ll l lm ln">perror("Exec command");</span><span id="660c" class="li lj it le b gy ol ll l lm ln">printf("\n");</span><span id="06d3" class="li lj it le b gy ol ll l lm ln">}</span><span id="17cb" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~/oci-containers/container</strong>$ ls -l /proc/$!/ns</span><span id="f11c" class="li lj it le b gy ol ll l lm ln">total 0</span><span id="0154" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 15:27 <strong class="le iu">cgroup</strong> -&gt; <strong class="le iu">'cgroup:[4026531835]'</strong></span><span id="4ad8" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 15:27 <strong class="le iu">ipc</strong> -&gt; <strong class="le iu">'ipc:[4026531839]'</strong></span><span id="fc09" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 15:27 <strong class="le iu">mnt</strong> -&gt; <strong class="le iu">'mnt:[4026531840]'</strong></span><span id="29d5" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 15:27 <strong class="le iu">net</strong> -&gt; <strong class="le iu">'net:[4026531993]'</strong></span><span id="38c1" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 15:27 <strong class="le iu">pid</strong> -&gt; <strong class="le iu">'pid:[4026531836]'</strong></span><span id="a900" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 15:27 <strong class="le iu">pid_for_children</strong> -&gt; <strong class="le iu">'pid:[4026531836]'</strong></span><span id="6d2e" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 15:27 <strong class="le iu">user</strong> -&gt; <strong class="le iu">'user:[4026531837]'</strong></span><span id="8b7c" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 vagrant vagrant 0 Dec 21 15:27 <strong class="le iu">uts</strong> -&gt; <strong class="le iu">'uts:[4026531838]'</strong></span></pre><p id="36f6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">从这里，你会发现它们和上面的一样。这是在名称空间中运行进程的一个例子。来自unshare的以前的shell与我们自己的环境完全不同，在那里执行的所有进程只能在对某些资源的访问受限的环境中安全地运行。</p></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><blockquote class="or"><p id="f217" class="os ot it bd ou ov ow ox oy oz pa ky dk translated">那么我在哪里使用它，它和Docker有什么不同吗？</p></blockquote></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><p id="0231" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们来看看这个叫做<strong class="kd iu">的另一部分。这就是我们理解像<code class="fe om on oo le b">docker exec</code>这样的命令如何工作的地方。</strong></p><p id="e173" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们可以启动容器，通过检查外壳的进程id来记录外壳返回的pid。这是在容器启动时由docker自动处理的。</p><p id="07f9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了测试这一点，让我们再次启动我们的容器，但这次让我们在后台运行它。我制作了一个名为<code class="fe om on oo le b">nsenter.sh</code>的奇特脚本来帮助在那之后访问容器。</p><p id="627b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在打开另一个选项卡并运行nsenter命令</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="4e4f" class="li lj it le b gy lk ll l lm ln"><strong class="le iu"># Let's run the command for starting the container in a different tty, /dev/tty2</strong></span><span id="e923" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~/oci-containers/container</strong>$ sudo openvt -c 2 -f ./containers unshare namespace<br/> <strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~/oci-containers/container</strong>$ ps -a</span><span id="ab67" class="li lj it le b gy ol ll l lm ln">PID TTY          TIME CMD</span><span id="6b3d" class="li lj it le b gy ol ll l lm ln">3123 tty2     00:00:00 sh  <strong class="le iu"># This is our container and it's a process :-)</strong></span><span id="0e6b" class="li lj it le b gy ol ll l lm ln">3140 pts/1    00:00:00 ps</span><span id="a057" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~/oci-containers/container</strong>$ cat nsenter.sh</span><span id="76f6" class="li lj it le b gy ol ll l lm ln">#!/bin/bash<br/></span><span id="624d" class="li lj it le b gy ol ll l lm ln">run_command_ns(){</span><span id="8e17" class="li lj it le b gy ol ll l lm ln">nsenter -t $PID -G $GROUP_ID -S $USER_ID -a "$1"</span><span id="e046" class="li lj it le b gy ol ll l lm ln">}</span><span id="7172" class="li lj it le b gy ol ll l lm ln">USER_ID=0</span><span id="4e13" class="li lj it le b gy ol ll l lm ln">GROUP_ID=0</span><span id="eff0" class="li lj it le b gy ol ll l lm ln">PID=$(ps -a | grep "\ssh$" | head -n1 | awk '{split($0,a," "); print a[1]}')</span><span id="6b90" class="li lj it le b gy ol ll l lm ln">echo "PID: $PID"<br/></span><span id="2509" class="li lj it le b gy ol ll l lm ln">echo "Viewing the namespaces of the container, remember that containers are processes"</span><span id="ce61" class="li lj it le b gy ol ll l lm ln">ls -l "/proc/$PID/ns"</span><span id="cd9b" class="li lj it le b gy ol ll l lm ln">echo "Enter nsenter for container with PID $PID"</span><span id="d07f" class="li lj it le b gy ol ll l lm ln"># echo "65534 0 4294967295" &gt; /proc/$PID/uid_map</span><span id="6f1b" class="li lj it le b gy ol ll l lm ln"># echo "65534 0 4294967295" &gt; /proc/$PID/gid_map<br/></span><span id="4935" class="li lj it le b gy ol ll l lm ln">run_command_ns "$1"</span><span id="606a" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~/oci-containers/container</strong>$ sudo bash nsenter.sh apk</span><span id="0959" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">Viewing the namespaces of the container, remember that containers are processes</strong></span><span id="765e" class="li lj it le b gy ol ll l lm ln">total 0</span><span id="e37a" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 22 08:26 cgroup -&gt; 'cgroup:[4026532178]'</span><span id="cd13" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 22 08:26 ipc -&gt; 'ipc:[4026532177]'</span><span id="9a51" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 22 08:26 mnt -&gt; 'mnt:[4026532175]'</span><span id="bb12" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 22 08:26 net -&gt; 'net:[4026532180]'</span><span id="3aba" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 22 08:26 pid -&gt; 'pid:[4026531836]'</span><span id="a920" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 22 08:27 pid_for_children -&gt; 'pid:[4026531836]'</span><span id="c216" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 22 08:26 user -&gt; 'user:[4026531837]'</span><span id="dd23" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 22 08:26 uts -&gt; 'uts:[4026532176]'</span><span id="045e" class="li lj it le b gy ol ll l lm ln">Enter nsenter for container with PID 3123</span><span id="50d4" class="li lj it le b gy ol ll l lm ln">apk-tools 2.10.4, compiled for x86_64.</span><span id="49f7" class="li lj it le b gy ol ll l lm ln"><strong class="le iu">...some other outputs...</strong></span><span id="d45b" class="li lj it le b gy ol ll l lm ln">Use apk &lt;command&gt; --help for command-specific help.</span><span id="8b8f" class="li lj it le b gy ol ll l lm ln">Use apk --help --verbose for a full command listing.</span><span id="eeb6" class="li lj it le b gy ol ll l lm ln">This apk has coffee making abilities.</span></pre><p id="63f4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">同样，我可以通过给<strong class="kd iu"> nsenter.sh </strong>脚本指定一个参数来更改我想要使用的命令。</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="ba32" class="li lj it le b gy lk ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~/oci-containers/container</strong>$ sudo bash nsenter.sh &lt;command_to_run&gt;</span></pre><p id="cb92" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您知道，这看起来非常类似于docker exec命令，在这里您传递希望在容器中执行的命令。</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="97b0" class="li lj it le b gy lk ll l lm ln">docker exec -it ubuntu_bash bash<br/># Docker would substitute the "<strong class="le iu">bash</strong>" command with the PID of the bash command in the ubuntu_bash container <br/># This is one of the reasons why you need a running container to exec, it has to use the context of the initial container to run the needed command</span><span id="2fe2" class="li lj it le b gy ol ll l lm ln">Source code here: <a class="ae lo" href="https://sourcegraph.com/github.com/docker/docker-ce@d49c4ca453ce4d1161ce5fb2482be7538bf73e07/-/blob/components/engine/daemon/exec.go#L263" rel="noopener ugc nofollow" target="_blank">https://sourcegraph.com/github.com/docker/docker-ce@d49c4ca453ce4d1161ce5fb2482be7538bf73e07/-/blob/components/engine/daemon/exec.go#L263</a></span><span id="66df" class="li lj it le b gy ol ll l lm ln">systemPid, err := d.containerd.Exec(ctx, c.ID, ec.ID, p, cStdin != nil, ec.InitializeStdio)</span></pre><p id="979b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">试着输入一个alpine中没有的命令，比如<strong class="kd iu"> bash </strong>,看看它是否不起作用。</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="429b" class="li lj it le b gy lk ll l lm ln"><strong class="le iu">vagrant@ubuntu-bionic</strong>:<strong class="le iu">~/oci-containers/container</strong>$ sudo bash nsenter.sh bash</span><span id="d5f4" class="li lj it le b gy ol ll l lm ln">Viewing the namespaces of the container, remember that containers are processes</span><span id="901f" class="li lj it le b gy ol ll l lm ln">total 0</span><span id="4427" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 22 08:26 cgroup -&gt; 'cgroup:[4026532178]'</span><span id="ba43" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 22 08:26 ipc -&gt; 'ipc:[4026532177]'</span><span id="aa5d" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 22 08:26 mnt -&gt; 'mnt:[4026532175]'</span><span id="44e2" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 22 08:26 net -&gt; 'net:[4026532180]'</span><span id="758e" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 22 08:26 pid -&gt; 'pid:[4026531836]'</span><span id="4295" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 22 08:27 pid_for_children -&gt; 'pid:[4026531836]'</span><span id="70c1" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 22 08:26 user -&gt; 'user:[4026531837]'</span><span id="bf9b" class="li lj it le b gy ol ll l lm ln">lrwxrwxrwx 1 root root 0 Dec 22 08:26 uts -&gt; 'uts:[4026532176]'</span><span id="fd8a" class="li lj it le b gy ol ll l lm ln">Enter nsenter for container with PID 2419</span><span id="0cac" class="li lj it le b gy ol ll l lm ln">nsenter: failed to execute bash: No such file or directory</span></pre><p id="6b76" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这是一个在名称空间中运行命令并通过chroot和名称空间使用映像来完成文件系统以外的任务的示例。</p></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h1 id="b7aa" class="nc lj it bd nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny bi translated">那么下一步是什么？</h1><p id="9e2b" class="pw-post-body-paragraph kb kc it kd b ke nz kg kh ki oa kk kl km ob ko kp kq oc ks kt ku od kw kx ky im bi translated">在下一部分(第2部分)中，我将更深入地讨论cgroups，各种cgroups如何联合起来帮助解决资源限制问题。</p><h1 id="ca5e" class="nc lj it bd nd ne pc ng nh ni pd nk nl nm pe no np nq pf ns nt nu pg nw nx ny bi translated">资源</h1><div class="lp lq gp gr lr ls"><a href="http://asm.sourceforge.net/syscall.html" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd iu gy z fp lx fr fs ly fu fw is bi translated">Linux/i386系统调用</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">版权所有(C) 1999-2000由康斯坦丁Boldyshev这份名单还没有准备好，并正在大力建设中，很多…</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">asm.sourceforge.net</p></div></div></div></a></div><div class="lp lq gp gr lr ls"><a href="http://man7.org/linux/man-pages/man2/pivot_root.2.html" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd iu gy z fp lx fr fs ly fu fw is bi translated">pivot_root(2) - Linux手册页</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">pivot_root()改变调用进程的挂载名称空间中的根挂载。更准确地说，它移动了根…</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">man7.org</p></div></div></div></a></div><div class="lp lq gp gr lr ls"><a href="http://man7.org/linux/man-pages/man2/syscalls.2.html" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd iu gy z fp lx fr fs ly fu fw is bi translated">系统调用(2) - Linux手册页</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">系统调用是应用程序和Linux内核之间的基本接口。系统调用和库…</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">man7.org</p></div></div><div class="mb l"><div class="ph l md me mf mb mg jv ls"/></div></div></a></div><div class="lp lq gp gr lr ls"><a href="http://man7.org/linux/man-pages/man7/namespaces.7.html" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd iu gy z fp lx fr fs ly fu fw is bi translated">名称空间(7) - Linux手册页</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">命名空间(7) Linux程序员手册命名空间(7)命名空间——Linux命名空间概述命名空间包装了一个…</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">man7.org</p></div></div><div class="mb l"><div class="pi l md me mf mb mg jv ls"/></div></div></a></div><div class="lp lq gp gr lr ls"><a href="http://man7.org/linux/man-pages/man2/unshare.2.html" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd iu gy z fp lx fr fs ly fu fw is bi translated">unshare(2) - Linux手册页</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">UNSHARE(2) Linux程序员手册UNSHARE(2)UNSHARE——解除流程执行上下文部分的关联unshare()…</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">man7.org</p></div></div><div class="mb l"><div class="pb l md me mf mb mg jv ls"/></div></div></a></div><div class="lp lq gp gr lr ls"><a href="http://man7.org/linux/man-pages/man2/setns.2.html" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd iu gy z fp lx fr fs ly fu fw is bi translated">setns(2) - Linux手册页</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">SETNS(2) Linux程序员手册SETNS(2) setns -在给定文件描述符的情况下，将线程与名称空间重新关联…</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">man7.org</p></div></div><div class="mb l"><div class="pj l md me mf mb mg jv ls"/></div></div></a></div><div class="lp lq gp gr lr ls"><a href="http://man7.org/linux/man-pages/man5/proc.5.html" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd iu gy z fp lx fr fs ly fu fw is bi translated">proc(5) - Linux手册页</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">PROC(5) Linux程序员手册PROC(5) proc -进程信息伪文件系统PROC文件系统是一个</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">man7.org</p></div></div><div class="mb l"><div class="pk l md me mf mb mg jv ls"/></div></div></a></div><div class="lp lq gp gr lr ls"><a href="http://man7.org/linux/man-pages/man1/nsenter.1.html" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd iu gy z fp lx fr fs ly fu fw is bi translated">nsenter(1) - Linux手册页</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">这个页面是util-Linux(Linux实用程序的随机集合)项目的一部分。关于项目的信息可以…</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">man7.org</p></div></div><div class="mb l"><div class="pl l md me mf mb mg jv ls"/></div></div></a></div></div></div>    
</body>
</html>