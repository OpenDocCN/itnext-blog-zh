<html>
<head>
<title>Identifying Security Vulnerabilities Using NPM Audit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用NPM审计识别安全漏洞</h1>
<blockquote>原文：<a href="https://itnext.io/identifying-security-vulnerabilities-using-npm-audit-9c590eec9615?source=collection_archive---------1-----------------------#2019-06-08">https://itnext.io/identifying-security-vulnerabilities-using-npm-audit-9c590eec9615?source=collection_archive---------1-----------------------#2019-06-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="389e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我最近收到了一封来自Github的电子邮件，通知我我的一个回购存在一定的安全漏洞。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/6c8e584e95e79f9e70b99e9e7de8bbf3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4rffIkSNF1FijTTKNkqX_g.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">Github邮件的主题</figcaption></figure><p id="be16" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这不是我第一次收到这样的邮件。过去，一收到这封邮件，我会立即着手消除检测到的漏洞。但是在这一次，我想分享一下是个好主意，也许可以解释一下我通常是如何解决这个问题的。</p><p id="59ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面报道的repo，<strong class="jp ir"> <em class="lb"> ssr-react-app </em> </strong>，是我用来摆弄<a class="ae lc" href="https://nextjs.org/" rel="noopener ugc nofollow" target="_blank"> Next.js </a>及其服务器端渲染实现的一个测试repo。这是很久以前的事了。因为这篇文章不是关于这些的，所以我不会深究细节。我们将严格遵循手头的主题，即下面的问题。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ld"><img src="../Images/58d667e6621694e84b6934976cfe0153.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vowOtxRjZU1VNbCLKqi3vA.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">Github安全漏洞电子邮件正文</figcaption></figure><p id="b142" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在已安装的<strong class="jp ir"> js-yaml </strong>版本中检测到一个已知的<strong class="jp ir">高严重性</strong>安全漏洞。</p><p id="f2f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们开始讨论如何解决这个问题的各种方法之前，我们需要了解这样的事情是如何发生的。为了对开源社区做出贡献，许多开发人员出去寻找可用解决方案中的差距，或者还没有发布解决方案的其他开发人员所面临的挑战。</p><p id="8296" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们大多数人使用其他开发者以库的形式构建的大量代码。使用所述库的原因各不相同——构建定制解决方案的时间限制、没有必要重新发明轮子的感觉、某些库作者的简单欣赏等等。不管是什么原因，在软件开发的过程中，我们经常发现自己将库拉入到代码库中。在Javascript环境中，就像我的例子，包是从NPM(节点包管理器)中提取的。</p><p id="3152" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">NPM是不同作者发布的数千个软件包的注册表。由于这些包解决了特定的问题，有时它们可能会在代码中引入漏洞。这可能来自包本身，或者它所使用的依赖关系——我们称之为级联依赖关系。例如，安装Node.js web应用程序框架<a class="ae lc" href="https://expressjs.com/" rel="noopener ugc nofollow" target="_blank"> Express </a>，会额外安装它所依赖的40多个其他包！安全性是一个很大的问题，尤其是当我们谈论将软件产品交付生产时。视而不见的反响很大。</p><p id="b4d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">漏洞的例子从跨站点脚本问题(占所有安全问题的80%以上)到拒绝服务问题，如事件循环阻塞、内存耗尽和正则表达式安全攻击。这些安全漏洞可能导致服务器崩溃和数据被盗。</p><p id="8fdf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">像<a class="ae lc" href="https://snyk.io/test/" rel="noopener ugc nofollow" target="_blank"> Snyk </a>这样的在线服务可以用来测试Github repos、npm包和docker映像中的已知漏洞。但是在我们的例子中，我们将直接跳到终端，探索<em class="lb"> npm audit </em>和<em class="lb"> npm audit fix </em>命令。</p><h1 id="4053" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">NPM审计</h1><p id="8524" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">npm审计用于跟踪并报告您环境中的NPM模块的安全漏洞。每个漏洞都有严重级别(低、中、高、严重)。不言而喻，但标记为高或关键的问题需要立即解决。检测到问题后，NPM审计会为您提供一个选项，通过将软件包升级到已修复已识别问题的已发布版本来修复这些问题。</p><p id="26e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">回到<strong class="jp ir"> <em class="lb"> ssr-react-app </em> </strong>。下面是package.json文件。记下<em class="lb">依赖关系</em>属性。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mh"><img src="../Images/50ff191a9ad7aeb295184bd3eee373b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*37U0qYf3AbWRXLvPJXBu9g.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">ssr-react-app package.json</figcaption></figure><p id="5daf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Github报告的检测到的包js-yaml在我们的package.json中指定的依赖项中丢失了！奇怪吗？我们很快会回到这个话题。</p><p id="7d4a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步是导航到我的应用程序文件夹的根目录，并运行<em class="lb"> npm audit </em>命令。下面是结果。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mi"><img src="../Images/53ae84689883dffd81f786d2d9f703ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rifYMoc7uF_QysNom6Xngg.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">国家预防机制审计的结果</figcaption></figure><p id="7352" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们来剖析一下这个。我们检测到三个漏洞(两个严重性中等，一个严重性高)。</p><p id="dbb4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">每个漏洞都有一个<strong class="jp ir">严重性级别</strong>和<strong class="jp ir">类型的漏洞</strong>、<strong class="jp ir">包的名称</strong>、<strong class="jp ir">对</strong>的依赖性(这表明该包是否是另一个已安装的包的依赖性)以及一个<strong class="jp ir">更多信息</strong>列，该列提供了一个链接，该链接提供了关于漏洞性质的更多详细信息。我强烈推荐你点击更多信息链接。如果我们的目标是解决一个问题，那么我们必须首先理解它。</p><p id="73f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上述输出中报告的第二个漏洞是<strong class="jp ir"> js-yaml </strong>。但如果你仔细观察，你会发现这是一个<strong class="jp ir"> zeit/next-css </strong>的依赖。这是级联依赖的结果——我们之前提到过。</p><p id="6e20" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lb"> npm审计</em>命令有一个<em class="lb"> json </em>标志，以json格式输出相同的信息。该输出可以选择性地写入文件。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mi"><img src="../Images/28fde5879ee3b14bf24fcc6934cf0a93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lkNJYbQYrA_B7mZWZM5GtQ.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">将npm审核导出到JSON文件</figcaption></figure><p id="0cda" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">JSON输出可以被输入到可视化工具或解析器中，在持续集成(CI)过程中，解析器会提取出问题的总数。</p><p id="c779" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行<em class="lb"> npm审计修复</em>命令尝试修复这些漏洞。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mj"><img src="../Images/0f871629fa864300a23293df7949223f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H9wMeGvmC2-RPXgxTjyd4A.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">npm审核修复命令的结果</figcaption></figure><p id="b3f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们走吧。3个问题中的3个得到解决。<em class="lb"> axios </em>包已经从0.18.0升级到0.19.0。此外，还添加了来自4个贡献者的3个包，并更新了3个包。这似乎已经修复了漏洞。但是哪里都没有提到js-yaml。它真的升级了吗？嗯，看起来可能不是这样，但是一个快速的<em class="lb"> git diff package-lock.json </em>将会证明事实并非如此。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mk"><img src="../Images/c069975ff0afa32f1b72b0440da41a3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bnH7nsQ-sZ3cWDijPVDPbg.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">git diff package-lock.json命令的代码片段</figcaption></figure><p id="7261" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这毫无疑问地证明了js-yaml包确实从3.12.2版升级到了3.13.1版，其中实现了漏洞修复。</p><p id="e934" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在运行<em class="lb"> npm audit fix </em>命令时，语义版本控制是需要注意的。如果升级是补丁或次要版本，则升级会自动进行。然而，如果升级需要转换到主版本，那么必须传递一个<em class="lb"> force </em>标志。小心这面旗。与具有向后兼容性的次要版本和补丁版本不同，主要版本通常具有突破性的变化。因此，在运行该命令之前，请参考软件包文档。</p><p id="4197" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您只是想看看在运行<em class="lb"> npm审计修复</em>时可能会升级什么，而不一定会影响更改，那么<em class="lb">试运行</em>标志就是您所需要的。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ml"><img src="../Images/05212309f6ca65a723828c8f05cb5cb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rCfrvjyjqLbFsSh1pp8k8A.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">npm审核修复—模拟运行命令</figcaption></figure><p id="3c38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">fix命令还提供了一个仅用于<em class="lb">的</em>标志，用于定位环境包，即<em class="lb"> dev </em>或<em class="lb"> prod </em>。<em class="lb"> prod </em>参数将指向package.json文件中<em class="lb"> dependencies </em>属性中的包，而dev参数将指向<em class="lb"> devDependencies </em>。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mm"><img src="../Images/455327b23c6f82ae1001fc5de33581ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4JlR-LSRwbStrR3pMRYqKA.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">npm审核修复—仅=产品</figcaption></figure><h1 id="5b2d" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">如果没有发布的修复程序呢？</h1><p id="25ef" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">有时可能会报告某些问题，但没有发布可用的修复程序。在这种情况下:</p><ol class=""><li id="75f7" class="mn mo iq jp b jq jr ju jv jy mp kc mq kg mr kk ms mt mu mv bi translated">通过发现所报告风险的根源并通过创建问题来报告它，来帮助包的维护者。您甚至可以继续使用您实现的解决方案进行拉取请求。</li><li id="7563" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk ms mt mu mv bi translated">使用包的分叉版本并对其进行修复。然后，您可以在应用程序中引用分叉版本。</li></ol><h1 id="3bee" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">NPM审计的好处</h1><ol class=""><li id="3e6a" class="mn mo iq jp b jq mc ju md jy nb kc nc kg nd kk ms mt mu mv bi translated">利用开源社区中其他贡献者的工作</li><li id="980b" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk ms mt mu mv bi translated">问题被清楚地识别出来，并标上严重程度</li><li id="af9c" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk ms mt mu mv bi translated">如果发布了解决方案，则提供现成的选项来修复检测到的漏洞</li></ol><h1 id="12db" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">包扎</h1><p id="1066" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">手动检查所有依赖项及其级联依赖项来寻找安全漏洞是一项乏味的工作。我们必须依靠社区来发现安全问题，报告/解决它们。这就是npm audit的意义所在——利用这个庞大的社区，它不仅编写我们使用的代码，还识别和修复所有代码中的漏洞。</p><p id="d306" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">需要注意的是，通过对输入数据进行适当的清理，也可以降低触发这些漏洞的可能性。</p><p id="f24a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用npm audit消除漏洞并不能消除代码本身(即应用程序开发人员编写的代码)中存在的漏洞。适当的编码标准和设计模式也对此有很大帮助。</p></div></div>    
</body>
</html>