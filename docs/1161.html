<html>
<head>
<title>Animated React + d3 Metaballs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">动画反应+ d3变形球</h1>
<blockquote>原文：<a href="https://itnext.io/animated-react-metaballs-dff3b3a6dee2?source=collection_archive---------6-----------------------#2018-08-01">https://itnext.io/animated-react-metaballs-dff3b3a6dee2?source=collection_archive---------6-----------------------#2018-08-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/6c6c167ae9a32725360806caa6b6976d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*J3iD6fkeEvNxhcWS_Kgvag.gif"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">反应变形球:反应和d3的动画变形球</figcaption></figure><p id="da11" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">前一段时间，我写了关于<a class="ae la" href="https://medium.com/@tbarrasso/advanced-meta-metaballs-864bbf0a945c" rel="noopener">高级元球</a>的文章，描述了它们的效用，并概述了一种算法，用于计算给定一组圆的SVG路径。然而，我没有包括示例代码或动画信息。</p><p id="e160" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这就是反应变形球的用武之地。这是一个使用React和d3构建的简单组件。下面是这个项目的概述，如何使用它，以及我在动画方面的一些尝试。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="4e58" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">反应变形球</h1><p id="9e30" class="pw-post-body-paragraph kc kd iq ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ij bi translated">你可以在npm 上找到react-metaballs 的<a class="ae la" href="https://tombarr.github.io/react-metaballs/index.html" rel="noopener ugc nofollow" target="_blank">演示，在GitHub </a>上找到<a class="ae la" href="https://www.npmjs.com/package/react-metaballs" rel="noopener ugc nofollow" target="_blank">包和</a><a class="ae la" href="https://github.com/Tombarr/react-metaballs" rel="noopener ugc nofollow" target="_blank">源代码。</a></p><h2 id="2b40" class="ml lj iq bd lk mm mn dn lo mo mp dp ls kn mq mr lw kr ms mt ma kv mu mv me mw bi translated">装置</h2><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="2b5a" class="ml lj iq nc b gy ng nh l ni nj">npm install react-metaballs</span></pre><h2 id="fddb" class="ml lj iq bd lk mm mn dn lo mo mp dp ls kn mq mr lw kr ms mt ma kv mu mv me mw bi translated">使用</h2><p id="a923" class="pw-post-body-paragraph kc kd iq ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ij bi translated">安装完成后，<code class="fe nk nl nm nc b">Metaballs</code>组件可以按如下方式导入</p><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="f50e" class="ml lj iq nc b gy ng nh l ni nj">import ReactMetaballs from 'react-metaballs'</span></pre><p id="bc49" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">数据被格式化为包含三个值的对象数组:</p><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="4ba4" class="ml lj iq nc b gy ng nh l ni nj">const circles = [<br/>  {<br/>    cx: 200,<br/>    cy: 100,<br/>    r: 64<br/>  }, // ...<br/>];</span></pre><p id="35bc" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><code class="fe nk nl nm nc b">cx</code> —在x轴上居中</p><p id="2dac" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><code class="fe nk nl nm nc b">cy</code> —在y轴上居中</p><p id="1d81" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><code class="fe nk nl nm nc b">r</code> —半径</p><p id="9139" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">坐标是相对于整体的，这意味着围绕创建SVG <code class="fe nk nl nm nc b"><a class="ae la" href="https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/viewBox" rel="noopener ugc nofollow" target="_blank">viewBox</a></code>的所有圆构建一个矩形。然后，它使用<a class="ae la" href="https://medium.com/sketch-app/mastering-the-bezier-curve-in-sketch-4da8fdf0dbbb" rel="noopener">贝塞尔曲线</a>围绕所有圆构建一个单独的<code class="fe nk nl nm nc b">path</code>元素。</p><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="fe94" class="ml lj iq nc b gy ng nh l ni nj">class App extends Component {<br/>  render () {<br/>    return (<br/>      &lt;Metaballs<br/>        easement={d3.easeBackOut}<br/>        circles={circles} /&gt;<br/>    )<br/>  }<br/>}</span></pre><p id="c4c4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">最终的输出呈现了一个<code class="fe nk nl nm nc b">svg</code>元素，该元素按照<code class="fe nk nl nm nc b"><a class="ae la" href="https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/preserveAspectRatio" rel="noopener ugc nofollow" target="_blank">preserveAspectRatio</a></code>属性的定义随其容器一起缩放。这就是SVG中的<em class="nn">可伸缩</em>，我们定义了一个浏览器知道如何放大或缩小的向量。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="8ae4" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">动画</h1><p id="0403" class="pw-post-body-paragraph kc kd iq ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ij bi translated">如果您持有对<code class="fe nk nl nm nc b">Metaballs</code>元素的引用，那么有一个<code class="fe nk nl nm nc b">updateCircles</code>方法负责两组数据之间的转换。</p><p id="0a67" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">例如，要在两种状态之间转换:</p><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="d6f2" class="ml lj iq nc b gy ng nh l ni nj">this.metaballRef.current.updateCircles(newCircles)</span></pre><p id="cd3d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">最初的过渡是用CSS中的一行代码编写的，但是由于兼容性问题，这种方法被放弃了。</p><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="57be" class="ml lj iq nc b gy ng nh l ni nj">path {<br/>    transition: d 300ms ease-in-out;<br/>}</span></pre><p id="000f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">要是动画也这么简单就好了。这实际上在谷歌Chrome中可以工作，但只有<a class="ae la" href="https://stackoverflow.com/questions/46454102/css-d-path-attribute-doesnt-work-in-safari-firefox" rel="noopener ugc nofollow" target="_blank">谷歌Chrome </a>:(对于其他现代浏览器，有SVG <code class="fe nk nl nm nc b">animate</code>元素，但这也有<a class="ae la" href="https://caniuse.com/#feat=svg-smil" rel="noopener ugc nofollow" target="_blank">兼容性问题</a>。其他关于<a class="ae la" href="https://www.aaron-powell.com/posts/2017-08-08-react-svg-animations/" rel="noopener ugc nofollow" target="_blank"> React SVG动画</a>的指南建议<code class="fe nk nl nm nc b">requestAnimationFrame</code>，但这似乎很可能会导致问题，并且很难操纵动画属性，如缓动。</p><p id="b595" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">输入<code class="fe nk nl nm nc b">d3</code>(双关语)！<code class="fe nk nl nm nc b">d3</code>提供大量选项，并支持轻松制作<code class="fe nk nl nm nc b"><a class="ae la" href="https://bost.ocks.org/mike/path/" rel="noopener ugc nofollow" target="_blank">d</a></code> <a class="ae la" href="https://bost.ocks.org/mike/path/" rel="noopener ugc nofollow" target="_blank">属性的动画</a>。通过创建一个封装了<code class="fe nk nl nm nc b">path</code>元素的组件，制作<code class="fe nk nl nm nc b">d</code>属性的动画变得很容易:</p><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="98f8" class="ml lj iq nc b gy ng nh l ni nj">componentWillReceiveProps(nextProps) {<br/>    if (this.props.path !== nextProps.path) {<br/>        let { duration, easement = d3.easeLinear } = this.props;<br/>        this.path.transition()<br/>                 .ease(easement)<br/>                 .attr('d', nextProps.path)<br/>                 .on('end', () =&gt; this.setState({<br/>                     path: nextProps.path<br/>                 }))<br/>                 .duration(duration);<br/>    }<br/>}</span></pre><p id="6dba" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">对于纯粹主义者来说，这违反了所有的规则。从d3的角度来看，我们并没有真正绑定到数据，只是使用d3作为补间库。从React的角度来看，我们正在直接操作DOM，并使用即将被弃用的<code class="fe nk nl nm nc b"><a class="ae la" href="https://reactjs.org/docs/react-component.html#unsafe_componentwillreceiveprops" rel="noopener ugc nofollow" target="_blank">componentWillReceiveProps</a></code>方法。但是肯定还有其他人以这种方式使用<a class="ae la" href="https://swizec.com/blog/using-d3js-transitions-in-react/swizec/6797" rel="noopener ugc nofollow" target="_blank"> React + d3 </a>，并且取得了很好的效果。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><p id="0799" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">暂时就这样了。我希望在未来探索<code class="fe nk nl nm nc b"><a class="ae la" href="https://github.com/react-tools/react-move" rel="noopener ugc nofollow" target="_blank">react-move</a></code>，它承诺以一种与两个框架一致的方式来实现我们的React + d3。瓦隆·瓦赫哈尔的代码和关于<a class="ae la" href="http://varun.ca/metaballs/" rel="noopener ugc nofollow" target="_blank">元球</a>数学的文章值得称赞。</p><p id="ec4b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">你可以在<a class="ae la" href="https://github.com/Tombarr/react-metaballs" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到源代码。关于样式和用例的想法，请参见我之前关于<a class="ae la" href="https://medium.com/@tbarrasso/pretty-svg-metaballs-f8d2a4c6f594" rel="noopener">漂亮变形球</a>的文章。</p></div></div>    
</body>
</html>