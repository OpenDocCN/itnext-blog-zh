<html>
<head>
<title>Auto-scaling RSpec tests on Buildkite CI with parallel jobs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有并行作业的Buildkite CI上的自动缩放RSpec测试</h1>
<blockquote>原文：<a href="https://itnext.io/auto-scaling-rspec-tests-on-buildkite-ci-with-parallel-jobs-be75c635572a?source=collection_archive---------4-----------------------#2021-03-19">https://itnext.io/auto-scaling-rspec-tests-on-buildkite-ci-with-parallel-jobs-be75c635572a?source=collection_archive---------4-----------------------#2021-03-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="56bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您的RSpec测试套件运行几个小时，那么您可以使用Buildkite代理通过并行作业将其缩短到几分钟。您将学习如何在最佳CI构建时间内为您的Ruby on Rails项目运行并行测试。我还将向您展示一些对Buildkite CI有用的东西，例如:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/3d55b68559360e33a7c3149d8cb329c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ME9x7a3fhA-jrVbm.jpeg"/></div></div></figure><ul class=""><li id="8d76" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">通过使用151个并行Buildkite代理和<a class="ae lg" href="https://docs.knapsackpro.com/knapsack_pro-ruby/guide/" rel="noopener ugc nofollow" target="_blank">backpack _ pro Ruby gem</a>，耗时13小时32分钟的真实RSpec测试套件仅在5分20秒内执行。</li><li id="eb11" class="kx ky iq jp b jq lh ju li jy lj kc lk kg ll kk lc ld le lf bi translated">如何在<a class="ae lg" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=medium-auto-scaling-buildkite-ci-build-agents-for-rspec-run-parallel-jobs-in-minutes-instead-of-hours" rel="noopener ugc nofollow" target="_blank">背包Pro </a>中使用队列模式在并行作业之间分发测试文件，以优化CI机器的使用。</li><li id="0554" class="kx ky iq jp b jq lh ju li jy lj kc lk kg ll kk lc ld le lf bi translated">CI Buildkite并行配置的简单示例。</li><li id="8198" class="kx ky iq jp b jq lh ju li jy lj kc lk kg ll kk lc ld le lf bi translated">使用AWS的弹性CI堆栈进行Buildkite配置的高级示例。</li><li id="2ab8" class="kx ky iq jp b jq lh ju li jy lj kc lk kg ll kk lc ld le lf bi translated">为什么您可能想要使用AWS Spot实例</li><li id="cf62" class="kx ky iq jp b jq lh ju li jy lj kc lk kg ll kk lc ld le lf bi translated">如何通过并行Buildkite代理之间的测试实例(测试用例)自动分割慢速RSpec测试文件</li></ul><h1 id="64a7" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">一个真正的RSpec测试套件需要13个小时，而执行只需5分钟</h1><p id="ee4e" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">我将向您展示运行RSpec并行测试的真实项目的结果。我们在这里看到的项目是巨大的，它的RSpec测试运行时间是13小时32分钟。超级慢。您可以想象创建一个git commit，然后等待13个小时，第二天发现您的代码破坏了项目中的其他内容。你不能那样工作！</p><p id="3c61" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">解决方案是使用Buildkite代理在许多CI机器上并行运行测试。每台CI机器都安装了一个Buildkite代理，它将运行RSpec测试套件的一部分。下面你可以看到一个在151个并行Buildkite代理上运行约13小时测试套件的例子。这允许在仅仅5分20秒内运行整个RSpec测试套件！</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mp"><img src="../Images/df999ec90886e51632d41306b4d8490a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eQgmQCRN8PiYQftL.png"/></div></div></figure><p id="4bf7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上图来自背包Pro <a class="ae lg" href="https://knapsackpro.com/dashboard?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=medium-auto-scaling-buildkite-ci-build-agents-for-rspec-run-parallel-jobs-in-minutes-instead-of-hours" rel="noopener ugc nofollow" target="_blank">用户仪表盘</a>。151并行作业很多机器。需要整个屏幕才能显示151个小节。你只能在图上看到最后几个条形。条形图显示了RSpec测试文件是如何在并行机器之间分割的。</p><p id="0b60" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以看到每台并行机器在相似的时间完成工作。所有条形的右边缘彼此非常接近。这是重要的部分。您希望确保RSpec工作在并行作业之间平均分配。这样您可以避免瓶颈——运行太多测试文件的缓慢工作。我会告诉你怎么做。</p><h1 id="c8ee" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">如何使用backpack Pro中的队列模式在并行作业之间分发测试文件，以优化CI机器的使用</h1><p id="966d" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">为了尽可能快地运行CI构建，我们需要尽可能多地利用我们的可用资源。这意味着运行RSpec测试的工作应该在并行机器之间平均分配。</p><p id="d013" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">测试套件越大，运行它的时间就越长，当您在网络中的许多机器之间分割运行测试时，会发生更多的边缘情况。一些可能的边缘情况:</p><ul class=""><li id="753b" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">一些测试文件比其他文件需要更长的时间来运行(例如E2E测试文件)</li><li id="896a" class="kx ky iq jp b jq lh ju li jy lj kc lk kg ll kk lc ld le lf bi translated">一些测试用例失败了，运行得更快，一些没有失败，运行得更久。这会影响CI机器运行测试所花费的总时间。</li><li id="a4d7" class="kx ky iq jp b jq lh ju li jy lj kc lk kg ll kk lc ld le lf bi translated">一些测试用例需要更长的时间，因为它们必须连接网络/外部API等——这增加了它们执行时间的不确定性</li><li id="e500" class="kx ky iq jp b jq lh ju li jy lj kc lk kg ll kk lc ld le lf bi translated">一些并行机器在引导时间上花费更多的时间:</li><li id="32ea" class="kx ky iq jp b jq lh ju li jy lj kc lk kg ll kk lc ld le lf bi translated">安装Ruby gems需要更长时间</li><li id="f0b8" class="kx ky iq jp b jq lh ju li jy lj kc lk kg ll kk lc ld le lf bi translated">从缓存中加载Ruby gems很慢</li><li id="a32e" class="kx ky iq jp b jq lh ju li jy lj kc lk kg ll kk lc ld le lf bi translated">或者只是CI提供程序还没有开始您的工作</li><li id="269f" class="kx ky iq jp b jq lh ju li jy lj kc lk kg ll kk lc ld le lf bi translated">或者，您的可用代理池中没有足够的可用机器</li></ul><p id="dc00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">多种因素会破坏并行节点之间的工作分布。</p><p id="896d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的最终目标是确保所有机器在相似的时间完成工作，因为这意味着每台机器都收到了与其可用能力相适应的工作负载。这意味着，如果一台机器很晚才开始工作，它将只运行一小部分测试。如果另一台机器很早就开始工作，它将运行更多的测试。这将使平行机之间的结束时间变得均匀。多亏了backpack _ pro Ruby gem中的队列模式，所有这些都是可能的，它会为你并行运行测试。<a class="ae lg" href="https://docs.knapsackpro.com/2020/how-to-speed-up-ruby-and-javascript-tests-with-ci-parallelisation" rel="noopener ugc nofollow" target="_blank">队列模式在并行作业之间动态分割测试文件，以确保作业同时完成</a>。</p><p id="1f9a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以看到一个为Ruby on Rails项目跨两个并行Buildkite代理运行一个小型RSpec测试套件的例子。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mq mr l"/></div></figure><h1 id="9029" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">CI Buildkite并行配置的简单示例</h1><p id="408f" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">这是一个非常简单的Buildkite配置示例，可以运行2个并行任务，正如你在截图中看到的。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ms"><img src="../Images/617ca886621e5a3fbcb03a45b6ed1813.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SU3RGp-P5pzeFhzx.png"/></div></div></figure><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="e6a8" class="my ln iq mu b gy mz na l nb nc"><em class="nd"># .buildkite/pipeline.yml</em><br/>env:<br/>  <em class="nd"># You should hide you secrets like API token</em><br/>  <em class="nd"># Please follow </em><a class="ae lg" href="https://buildkite.com/docs/pipelines/secrets" rel="noopener ugc nofollow" target="_blank"><em class="nd">https://buildkite.com/docs/pipelines/secrets</em></a><br/>  KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC: "204abb31f698a6686120a40efeff31e5"<br/>  <em class="nd"># allow to run the same set of test files on job retry</em><br/>  <em class="nd"># </em><a class="ae lg" href="https://github.com/KnapsackPro/knapsack_pro-ruby#knapsack_pro_fixed_queue_split-remember-queue-split-on-retry-ci-node" rel="noopener ugc nofollow" target="_blank"><em class="nd">https://github.com/KnapsackPro/knapsack_pro-ruby#knapsack_pro_fixed_queue_split-remember-queue-split-on-retry-ci-node</em></a><br/>  KNAPSACK_PRO_FIXED_QUEUE_SPLIT: true<br/><br/>steps:<br/>  - command: "bundle exec rake knapsack_pro:queue:rspec"<br/>    parallelism: 2</span></pre><p id="a498" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，您应该像backpack Pro API令牌一样隐藏您的凭证，而不是将其提交到您的存储库中。你可以参考<a class="ae lg" href="https://buildkite.com/docs/pipelines/secrets" rel="noopener ugc nofollow" target="_blank"> Buildkite秘密文档</a>。</p><h1 id="ff2a" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">AWS的高级Buildkite配置和弹性CI堆栈</h1><p id="e699" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">当您想要在十几台甚至数百台并行机上运行您的大型RSpec项目时，您需要强大的资源。在这种情况下，你可以遵循关于AWS设置的<a class="ae lg" href="https://buildkite.com/docs/tutorials/elastic-ci-stack-aws" rel="noopener ugc nofollow" target="_blank"> Buildkite教程</a>。面向AWS的弹性CI堆栈在您自己的AWS帐户中为您提供了一个私有的、自动扩展的Buildkite代理集群。</p><h1 id="806e" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">AWS Spot实例可以为您节省资金</h1><p id="e61c" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">AWS提供了Spot实例。这些机器很便宜，但可以随时被AWS收回。这意味着您可以为您的CI运行廉价的机器，但是AWS可能会不时地杀死您的并行机器之一。这样的场景可以由<a class="ae lg" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=medium-auto-scaling-buildkite-ci-build-agents-for-rspec-run-parallel-jobs-in-minutes-instead-of-hours" rel="noopener ugc nofollow" target="_blank">背包Pro </a>来处理。它记得分配给运行测试的AWS机器的测试文件集。当机器被撤回并且稍后被Buildkite重试特性重试时，正确的测试文件将如你所期望的那样被执行。</p><h1 id="c9ca" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">Buildkite重试功能</h1><p id="7471" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">Buildkite配置允许<a class="ae lg" href="https://buildkite.com/docs/pipelines/command-step#automatic-retry-attributes" rel="noopener ugc nofollow" target="_blank">自动重试你的任务</a>。当您使用AWS Spot实例时，这很有帮助。当AWS在测试运行时由于撤销而关闭您的机器时，Buildkite可以自动在新的机器上运行新的作业。</p><p id="2d70" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">自动重试的另一个用例是当您有<a class="ae lg" href="https://docs.knapsackpro.com/2021/fix-intermittently-failing-ci-builds-flaky-tests-rspec" rel="noopener ugc nofollow" target="_blank">片状Ruby测试</a>时，它们有时会通过绿色或失败红色。在这种情况下，您可以使用Buildkite重试失败的作业。</p><p id="48b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我的建议是将<a class="ae lg" href="https://knapsackpro.com/faq/question/how-to-retry-failed-tests-flaky-tests?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=medium-auto-scaling-buildkite-ci-build-agents-for-rspec-run-parallel-jobs-in-minutes-instead-of-hours" rel="noopener ugc nofollow" target="_blank"> rspec-retry gem </a>作为首选。RSpec-retry gem将只重试失败的测试用例，而不是所有分配给并行机器的测试文件。你可以尝试的第二个选择是依靠<a class="ae lg" href="https://buildkite.com/docs/pipelines/command-step#automatic-retry-attributes" rel="noopener ugc nofollow" target="_blank"> Buildkite重试特性</a>。它将重试CI节点和backpack Pro API分配给它的所有测试。</p><h1 id="c000" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">如何通过并行Buildkite代理之间的测试实例(测试用例)自动分割大型慢速RSpec测试文件</h1><p id="2af0" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">慢速RSpec测试文件通常与E2E测试相关，如水豚功能规格的浏览器测试。他们可以跑几分钟，有时甚至几十分钟。如果并行作业必须运行单个测试文件10分钟，而其他并行作业在5分钟内完成几个较小的测试文件，那么它们可能会成为瓶颈。</p><p id="413c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有一个解决方案！您可以将backpack Pro与<a class="ae lg" href="https://knapsackpro.com/faq/question/how-to-split-slow-rspec-test-files-by-test-examples-by-individual-it?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=medium-auto-scaling-buildkite-ci-build-agents-for-rspec-run-parallel-jobs-in-minutes-instead-of-hours" rel="noopener ugc nofollow" target="_blank"> RSpec split by examples特性</a>一起使用，该特性将自动检测项目中的慢速RSpec测试文件，并通过测试示例(测试案例)在并行Buildkite代理之间拆分它们。</p><h1 id="2dca" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">摘要</h1><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/e9ac4ed2188550dd7821414841612cf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/0*oX4lCGhGS8X88-nF.jpg"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">建筑风筝</figcaption></figure><p id="50c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如您所看到的，将Buildkite CI等一些元素与AWS等云基础设施解决方案相结合，并使用backpack Pro对测试文件进行最佳分割，可以显著改善您团队的工作。有了<a class="ae lg" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=medium-auto-scaling-buildkite-ci-build-agents-for-rspec-run-parallel-jobs-in-minutes-instead-of-hours" rel="noopener ugc nofollow" target="_blank">背包Pro </a>你可以获得巨大的成果和超快的CI构建。欢迎<a class="ae lg" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=medium-auto-scaling-buildkite-ci-build-agents-for-rspec-run-parallel-jobs-in-minutes-instead-of-hours" rel="noopener ugc nofollow" target="_blank">尝试一下</a>并加入其他快乐的Buildkite用户。</p><h1 id="b3a5" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">相关文章</h1><p id="ed25" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">如果你正在寻找Docker配置，你也可以在文章末尾看到存储库示例:<a class="ae lg" href="https://docs.knapsackpro.com/2017/auto-balancing-7-hours-tests-between-100-parallel-jobs-on-ci-buildkite-example" rel="noopener ugc nofollow" target="_blank">在Buildkite CI </a>上自动平衡100个并行任务之间的7小时测试。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/0f96852ffe3421de1b2969904271f037.png" data-original-src="https://miro.medium.com/v2/resize:fit:160/format:webp/0*PFQDyQ7u9sSLv0Dg.png"/></div></figure></div><div class="ab cl nk nl hu nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ij ik il im in"><p id="ee5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nd">原载于2021年3月19日https://docs.knapsackpro.com</em><em class="nd">的</em> <a class="ae lg" href="https://docs.knapsackpro.com/2021/auto-scaling-buildkite-ci-build-agents-for-rspec-run-parallel-jobs-in-minutes-instead-of-hours" rel="noopener ugc nofollow" target="_blank"> <em class="nd">。</em></a></p></div></div>    
</body>
</html>