<html>
<head>
<title>K8s raise StatefulSet volume size with low impact</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">K8s在低影响的情况下提高了固定卷的大小</h1>
<blockquote>原文：<a href="https://itnext.io/k8s-raise-statefulset-volume-size-with-low-impact-33fe1e2576f6?source=collection_archive---------2-----------------------#2020-06-28">https://itnext.io/k8s-raise-statefulset-volume-size-with-low-impact-33fe1e2576f6?source=collection_archive---------2-----------------------#2020-06-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="76ac" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在一个简单的示例应用程序中逐步展示</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/95cb512d76fec4c8dacc94b1fda61033.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zDZy1H1z-u6BaBTI8W_BPw.jpeg"/></div></div></figure><h2 id="9b3a" class="ku kv it bd kw kx ky dn kz la lb dp lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">TL；速度三角形定位法(dead reckoning)</h2><ol class=""><li id="1f61" class="lq lr it ls b lt lu lv lw ld lx lh ly ll lz ma mb mc md me bi translated">确保您的storageclass提供程序支持调整大小</li><li id="5339" class="lq lr it ls b lt mf lv mg ld mh lh mi ll mj ma mb mc md me bi translated">提高PVC的体积大小</li><li id="a10f" class="lq lr it ls b lt mf lv mg ld mh lh mi ll mj ma mb mc md me bi translated">优雅地重新启动所有状态设置窗格</li><li id="c115" class="lq lr it ls b lt mf lv mg ld mh lh mi ll mj ma mb mc md me bi translated">删除状态集，但保持窗格运行</li><li id="b338" class="lq lr it ls b lt mf lv mg ld mh lh mi ll mj ma mb mc md me bi translated">使用更新的卷声明模板大小再次创建StatefulSet</li></ol><h2 id="8bf1" class="ku kv it bd kw kx ky dn kz la lb dp lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">创建一个测试集群</h2><p id="be19" class="pw-post-body-paragraph mk ml it ls b lt lu ju mm lv lw jx mn ld mo mp mq lh mr ms mt ll mu mv mw ma im bi translated">为了进行测试，我们使用GCP创建了一个示例k8s集群:</p><pre class="kj kk kl km gt mx my mz na aw nb bi"><span id="fc74" class="ku kv it my b gy nc nd l ne nf">gcloud container clusters create test --num-nodes 3 --zone europe-west3-b --machine-type n1-standard-2 --node-version=1.16 --cluster-version=1.16</span></pre><h1 id="211e" class="ng kv it bd kw nh ni nj kz nk nl nm lc jz nn ka lg kc no kd lk kf np kg lo nq bi translated">在容器中提升PVC</h1><p id="8c36" class="pw-post-body-paragraph mk ml it ls b lt lu ju mm lv lw jx mn ld mo mp mq lh mr ms mt ll mu mv mw ma im bi translated">在我们开始在一个状态集合中提高PVC之前，最好先在一个简单的单个pod上进行测试。</p><h2 id="7ba7" class="ku kv it bd kw kx ky dn kz la lb dp lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">设置</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="f95a" class="pw-post-body-paragraph mk ml it ls b lt nt ju mm lv nu jx mn ld nv mp mq lh nw ms mt ll nx mv mw ma im bi translated">这将导致:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/da2c10073dd2cc4740da6c7db3be4bb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RiHvxmBrIaAYp9fBhXD7jw.png"/></div></div><figcaption class="nz oa gj gh gi ob oc bd b be z dk translated">我们看到，由于k8s的自动资源调配，PV是自动创建的</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/95949ee08d683c851604d5311ffd35f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o06WuCdRlrv3PbXNn5xePQ.png"/></div></div><figcaption class="nz oa gj gh gi ob oc bd b be z dk translated">pod安装了卷</figcaption></figure><h2 id="a0c7" class="ku kv it bd kw kx ky dn kz la lb dp lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">提高PVC</h2><p id="7e3e" class="pw-post-body-paragraph mk ml it ls b lt lu ju mm lv lw jx mn ld mo mp mq lh mr ms mt ll mu mv mw ma im bi translated">首先我们更新PVC ( <code class="fe oe of og my b">kubectl edit pvc pvc-one</code>):</p><pre class="kj kk kl km gt mx my mz na aw nb bi"><span id="ea32" class="ku kv it my b gy nc nd l ne nf"># <!-- -->kubectl edit pvc pvc-one<br/>apiVersion: v1<br/>kind: PersistentVolumeClaim<br/>metadata:<br/>...<br/>spec:<br/>  accessModes:<br/>  - ReadWriteOnce<br/>  resources:<br/>    requests:<br/><strong class="my iu">      storage: 10Gi</strong><br/>  storageClassName: standard<br/>  volumeMode: Filesystem<br/>  volumeName: pvc-b52bc9ee-fed4-4778-8cd3-62fb24f7635d<br/>status:<br/>  accessModes:<br/>  - ReadWriteOnce<br/>  capacity:<br/>    storage: 3Gi<br/>  phase: Bound</span></pre><p id="1c5f" class="pw-post-body-paragraph mk ml it ls b lt nt ju mm lv nu jx mn ld nv mp mq lh nw ms mt ll nx mv mw ma im bi translated">等到<code class="fe oe of og my b">kubectl describe pvc pvc-one</code>显示它正在等待pod重启:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/f29997db921384888dde1b6e0283b3fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uTVJfuyWOk0bVLlQkHFDQQ.png"/></div></div><figcaption class="nz oa gj gh gi ob oc bd b be z dk translated">kubectl描述pvc pvc-one</figcaption></figure><p id="269a" class="pw-post-body-paragraph mk ml it ls b lt nt ju mm lv nu jx mn ld nv mp mq lh nw ms mt ll nx mv mw ma im bi translated">现在删除并重新创建pod，然后应该完成以下神奇操作:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/201f06e1bfb553f25f7c00db3c5cb4dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1GrGlXuRsf0Spuzfcmot4w.png"/></div></div><figcaption class="nz oa gj gh gi ob oc bd b be z dk translated">PVC和PV有新尺寸</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/3b922f82d841ef87c23af29b2af53bf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G4TEJcFPAUk4797tCjHLLw.png"/></div></div><figcaption class="nz oa gj gh gi ob oc bd b be z dk translated">Pod显示已装载卷的新大小</figcaption></figure><h1 id="8f97" class="ng kv it bd kw nh ni nj kz nk nl nm lc jz nn ka lg kc no kd lk kf np kg lo nq bi translated">在规定的时间内提高PVC</h1><h2 id="f062" class="ku kv it bd kw kx ky dn kz la lb dp lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">设置</h2><p id="9185" class="pw-post-body-paragraph mk ml it ls b lt lu ju mm lv lw jx mn ld mo mp mq lh mr ms mt ll mu mv mw ma im bi translated">让我们创建一个非常简单的StatefulSet示例:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="6415" class="pw-post-body-paragraph mk ml it ls b lt nt ju mm lv nu jx mn ld nv mp mq lh nw ms mt ll nx mv mw ma im bi translated">这导致:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/eeaa7dcee10fdc9ef353c553b21a5b25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o1bxWNpi0YwAg-gpIUkPbg.png"/></div></div></figure><h2 id="c718" class="ku kv it bd kw kx ky dn kz la lb dp lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">提高PVC</h2><p id="e68c" class="pw-post-body-paragraph mk ml it ls b lt lu ju mm lv lw jx mn ld mo mp mq lh mr ms mt ll mu mv mw ma im bi translated">我们修补PVCs的速度比手工编辑更快:</p><pre class="kj kk kl km gt mx my mz na aw nb bi"><span id="e65f" class="ku kv it my b gy nc nd l ne nf">kubectl patch pvc sts-sts-0 -p '{ "spec": { "resources": { "requests": { "storage": "15Gi" }}}}'</span><span id="18ea" class="ku kv it my b gy ol nd l ne nf">kubectl patch pvc sts-sts-1 -p '{ "spec": { "resources": { "requests": { "storage": "15Gi" }}}}'</span><span id="5a18" class="ku kv it my b gy ol nd l ne nf">kubectl patch pvc sts-sts-2 -p '{ "spec": { "resources": { "requests": { "storage": "15Gi" }}}}'</span></pre><p id="5ca5" class="pw-post-body-paragraph mk ml it ls b lt nt ju mm lv nu jx mn ld nv mp mq lh nw ms mt ll nx mv mw ma im bi translated">现在，等到每条PVC都有了正确的状态:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/927baabff3dd00b5bdd75b1d06648b3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dxp1g6sq_15pQqEftIjd_Q.png"/></div></div><figcaption class="nz oa gj gh gi ob oc bd b be z dk translated">检查每个PVC的状况</figcaption></figure><p id="c4ec" class="pw-post-body-paragraph mk ml it ls b lt nt ju mm lv nu jx mn ld nv mp mq lh nw ms mt ll nx mv mw ma im bi translated">然后，我们必须重新启动每个状态设置舱:</p><pre class="kj kk kl km gt mx my mz na aw nb bi"><span id="1b35" class="ku kv it my b gy nc nd l ne nf"><strong class="my iu">### since k8s 1.15</strong><br/>kubectl rollout restart sts sts</span><span id="f057" class="ku kv it my b gy ol nd l ne nf"><strong class="my iu">### before k8s 1.15<br/></strong># recreate every pod gracefully after each other<br/>kubectl delete pod sts-0<br/>kubectl delete pod sts-1<br/>kubectl delete pod sts-2</span><span id="8fd3" class="ku kv it my b gy ol nd l ne nf"># OR we could use scaling down+up real fast but this<br/># might cause downtime!<br/>kubectl scale sts sts --replicas 0 &amp;&amp; kubectl scale sts sts --replicas 3</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/c946ce4a666e8e913947e7f0d6ac6d7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mguFu5Jayh1uYSX_OJPvaA.png"/></div></div><figcaption class="nz oa gj gh gi ob oc bd b be z dk translated">PVC和PV有新尺寸</figcaption></figure><h2 id="75d9" class="ku kv it bd kw kx ky dn kz la lb dp lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">更新StatefulSet volumeClaimTemplate</h2><p id="ecb1" class="pw-post-body-paragraph mk ml it ls b lt lu ju mm lv lw jx mn ld mo mp mq lh mr ms mt ll mu mv mw ma im bi translated">如果我们在这里停下来，只增加PVC大小，而不增加StatefulSet volumeClaimTemplate，那么增加StatefulSet将导致新的pod具有错误大小的PVC。</p><p id="00c9" class="pw-post-body-paragraph mk ml it ls b lt nt ju mm lv nu jx mn ld nv mp mq lh nw ms mt ll nx mv mw ma im bi translated">因此，我们更新了本地YAML文件中的StatefulSet:</p><pre class="kj kk kl km gt mx my mz na aw nb bi"><span id="108a" class="ku kv it my b gy nc nd l ne nf"># sts.yaml<br/>apiVersion: apps/v1<br/>kind: StatefulSet<br/>metadata:<br/>  name: sts<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app: nginx<br/>  serviceName: nginx<br/>  replicas: 3<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: nginx<br/>    spec:<br/>      terminationGracePeriodSeconds: 10<br/>      containers:<br/>      - name: nginx<br/>        image: nginx<br/>        ports:<br/>        - containerPort: 80<br/>          name: web<br/>        volumeMounts:<br/>        - name: sts<br/>          mountPath: /usr/share/nginx/html<br/>  volumeClaimTemplates:<br/>  - metadata:<br/>      name: sts<br/>    spec:<br/>      accessModes: [ "ReadWriteOnce" ]<br/>      resources:<br/>        requests:<br/>          <strong class="my iu">storage</strong>: <strong class="my iu">15Gi</strong></span></pre><p id="2aae" class="pw-post-body-paragraph mk ml it ls b lt nt ju mm lv nu jx mn ld nv mp mq lh nw ms mt ll nx mv mw ma im bi translated">现在，我们删除StatefulSet，而不删除pods，以降低影响。然后我们再次创建StatefulSet:</p><pre class="kj kk kl km gt mx my mz na aw nb bi"><span id="9ede" class="ku kv it my b gy nc nd l ne nf">kubectl delete sts sts --cascade=false <strong class="my iu"># keep pods running</strong><br/>kubectl -f sts.yaml create</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/b7cd495e39ce4e961aba1fa289692450.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fLFEV-vX3C3X_nngSmvHvg.png"/></div></div></figure><h1 id="93dc" class="ng kv it bd kw nh ni nj kz nk nl nm lc jz nn ka lg kc no kd lk kf np kg lo nq bi translated">结束</h1><p id="8344" class="pw-post-body-paragraph mk ml it ls b lt lu ju mm lv lw jx mn ld mo mp mq lh mr ms mt ll mu mv mw ma im bi translated">在未来的k8s版本中，我们也许能够更新正在运行的StatefulSet的volumeClaimTemplates。</p><p id="2b58" class="pw-post-body-paragraph mk ml it ls b lt nt ju mm lv nu jx mn ld nv mp mq lh nw ms mt ll nx mv mw ma im bi translated">你有改进建议吗？请留言评论。</p><h1 id="4d4e" class="ng kv it bd kw nh ni nj kz nk nl nm lc jz nn ka lg kc no kd lk kf np kg lo nq bi translated">成为Kubernetes认证</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><a href="https://killer.sh"><div class="gh gi op"><img src="../Images/cf3901a56841fcb55f9e4e17b9f07672.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Kbj17_6VncUuoBqNsAzzg.png"/></div></a><figcaption class="nz oa gj gh gi ob oc bd b be z dk translated"><a class="ae oq" href="https://killer.sh" rel="noopener ugc nofollow" target="_blank"> https://killer.sh </a></figcaption></figure></div></div>    
</body>
</html>