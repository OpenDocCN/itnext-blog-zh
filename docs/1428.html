<html>
<head>
<title>How To Build A Money Data Type In JavaScript 🔊</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用JavaScript构建货币数据类型🔊</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-build-a-money-data-type-in-javascript-7b622beabe00?source=collection_archive---------4-----------------------#2018-10-11">https://itnext.io/how-to-build-a-money-data-type-in-javascript-7b622beabe00?source=collection_archive---------4-----------------------#2018-10-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="c62e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">浮点陷阱的替代方案</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/c179d1e6e9c94762fd869d37d4b59d5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7KJLRKjFcbRSk-qjhad7JA.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">一场<a class="ae kv" href="https://en.wikipedia.org/wiki/Fire_breathing" rel="noopener ugc nofollow" target="_blank">喷火</a>表演中巨大火焰的画面。背景很暗。火从右边来，一个隐藏在屏幕外的人执行技术(<a class="ae kv" href="https://commons.wikimedia.org/wiki/File:Flame_of_fire.jpg" rel="noopener ugc nofollow" target="_blank">来源</a>)</figcaption></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="kw kx l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">听听音频版！</figcaption></figure></div><div class="ab cl ky kz hu la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ij ik il im in"><p id="2f12" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">上次我写了一个<a class="ae kv" href="https://medium.com/@fagnerbrack/the-missing-practical-step-by-step-test-driven-development-a7140ca4b71" rel="noopener">逐步的例子</a>，关于如何使用JavaScript将<a class="ae kv" href="https://8thlight.com/blog/georgina-mcfadyen/2016/06/27/inside-out-tdd-vs-outside-in.html" rel="noopener ugc nofollow" target="_blank">从内向外测试驱动开发</a>应用到一个问题上。那个帖子使用了<code class="fe mb mc md me b">Number</code>类型来表示美元。</p><p id="e00b" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">根据<a class="ae kv" href="https://es5.github.io/#x8.5" rel="noopener ugc nofollow" target="_blank"> JavaScript规范</a>,<code class="fe mb mc md me b">Number</code>类型是一个“<a class="ae kv" href="https://en.wikipedia.org/wiki/Double-precision_floating-point_format#IEEE_754_double-precision_binary_floating-point_format:_binary64" rel="noopener ugc nofollow" target="_blank">双精度64位二进制格式IEEE 754 </a>值。您不应该使用IEEE 754的实现来表示任何需要精确的数据。钱是其中之一。</p><p id="6f77" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">有<a class="ae kv" href="http://wiki.c2.com/?FloatingPointCurrency" rel="noopener ugc nofollow" target="_blank">也有</a>多<a class="ae kv" href="https://husobee.github.io/money/float/2016/09/23/never-use-floats-for-currency.html" rel="noopener ugc nofollow" target="_blank">内容</a>出来<a class="ae kv" href="https://stackoverflow.com/questions/3730019/why-not-use-double-or-float-to-represent-currency" rel="noopener ugc nofollow" target="_blank">有</a>关于<a class="ae kv" href="https://spin.atomicobject.com/2014/08/14/currency-rounding-errors/" rel="noopener ugc nofollow" target="_blank">这个主题</a>。因此，这篇文章通过编码示例展示了如何创建一个能够正确处理货币类型的模型</p><blockquote class="mf"><p id="1b3d" class="mg mh iq bd mi mj mk ml mm mn mo ma dk translated">您不应该在JavaScript中使用“数字”类型来表示钱</p></blockquote><p id="9b50" class="pw-post-body-paragraph lf lg iq lh b li mp jr lk ll mq ju ln lo mr lq lr ls ms lu lv lw mt ly lz ma ij bi translated">放债人杰克开始使用<a class="ae kv" href="https://medium.com/@fagnerbrack/the-missing-practical-step-by-step-test-driven-development-a7140ca4b71" rel="noopener">上一篇文章</a>中的函数计算一些贷款。在某个时刻，他试图计算贷款金额“2585美元”结果是“$52.73”后跟“999999999999”</p><p id="159d" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">杰克对此很不高兴。五年前，他的朋友为一个黑手党女王做会计。一天，她发现一个账户上有一个奇怪的分数，于是起了疑心。</p><p id="46c1" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">她解雇了他。就像…用真火！</p><p id="568a" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">好吧，杰克现在不是为黑手党工作。然而，他不喜欢在某些情况下计算可能产生不正确的结果。</p><p id="a809" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">你需要修复它。</p><blockquote class="mf"><p id="31b8" class="mg mh iq bd mi mj mk ml mm mn mo ma dk translated">杰克不喜欢火</p></blockquote><p id="887b" class="pw-post-body-paragraph lf lg iq lh b li mp jr lk ll mq ju ln lo mr lq lr ls ms lu lv lw mt ly lz ma ij bi translated">在《企业应用架构模式》一书中，马丁·福勒<a class="ae kv" href="https://martinfowler.com/eaaCatalog/money.html" rel="noopener ugc nofollow" target="_blank">为货币价值的表示提供了一个解决方案</a>。他建议你可以创建一个模型，让<a class="ae kv" href="https://hackernoon.com/affordance-in-software-design-12cc0d9d2721" rel="noopener ugc nofollow" target="_blank">提供给</a>一些算术运算。但是，代码在“amount”之上运行计算，amount是一个内部非小数属性，不受浮点问题的影响。</p><p id="b869" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">您可以将可视化表示从逻辑中分离出来，并以分钟为单位运行所有的数学运算。</p><p id="aadf" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">如果您将分表示为非小数的<code class="fe mb mc md me b">Number</code>,您就不需要担心浮点问题。稍后，您可以将<code class="fe mb mc md me b">Number</code>转换为<code class="fe mb mc md me b">String</code>，并根据您想要输出的货币决定将<a class="ae kv" href="https://en.wikipedia.org/wiki/Decimal_separator" rel="noopener ugc nofollow" target="_blank">小数点分隔符</a>放在哪里。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu kx l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">一个<a class="ae kv" href="https://gist.github.com/FagnerMartinsBrack/0f1f2a8d06fb708dd74dc78e4cd9d3aa" rel="noopener ugc nofollow" target="_blank">文本文件</a>包含不同货币中小数点的位置和样式的例子。</figcaption></figure><p id="7111" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">鉴于这是一个一般的编程问题，而不是一个非常具体的问题领域，编程语言至少应该提供开箱即用的解决方案。</p><p id="330c" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">不幸的是，JavaScript没有小数或货币类型，我不建议你花时间<a class="ae kv" href="https://en.wikipedia.org/wiki/Not_invented_here" rel="noopener ugc nofollow" target="_blank">重新发明</a>它。有一些库是值得研究的，比如<a class="ae kv" href="https://github.com/sarahdayan/dinero.js" rel="noopener ugc nofollow" target="_blank"> dinero.js </a>。</p><p id="2806" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">不过，对于这篇文章，让我们从头开始创建一个<code class="fe mb mc md me b">Money</code>类型。</p><p id="c16e" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">根据“<a class="ae kv" href="https://github.com/FagnerMartinsBrack/jack-the-moneylender/blob/d0de7c4f03fc3c85af62a392a747a9bff9f6f0c7/index.html#L9-L17" rel="noopener ugc nofollow" target="_blank">支付美元的利息</a>”函数，唯一必要的操作是减法、乘法和“大于”没有必要花时间去开发你现在不需要的<a class="ae kv" href="https://hackernoon.com/affordance-in-software-design-12cc0d9d2721" rel="noopener ugc nofollow" target="_blank">启示</a><a class="ae kv" href="https://en.wikipedia.org/wiki/You_aren%27t_gonna_need_it" rel="noopener ugc nofollow" target="_blank"/>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu kx l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://github.com/FagnerMartinsBrack/jack-the-moneylender/blob/d0de7c4f03fc3c85af62a392a747a9bff9f6f0c7/index.html#L9-L17" rel="noopener ugc nofollow" target="_blank">函数“支付美元利息”的JavaScript代码</a>如果你想知道这是怎么来的，看看<a class="ae kv" href="https://medium.com/@fagnerbrack/the-missing-practical-step-by-step-test-driven-development-a7140ca4b71" rel="noopener">之前的帖子</a>。该代码使用本机运算符进行减法、乘法和“大于”比较。</figcaption></figure><p id="4640" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">新模型的构造器接受一个带有美元符号(“$1.00”)的<code class="fe mb mc md me b">String</code>。此时不需要支持多种货币，所以使用这种符号是安全的。</p><p id="d438" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">此外，新模型要求消费者始终指定两个十进制数字“. 00”，即使值是整数，如“$5.00”，而不是省略数字，如“$1”。这样逻辑就更简单了。这个问题比较容易推理。</p><pre class="kg kh ki kj gt mv me mw mx aw my bi"><span id="c485" class="mz na iq me b gy nb nc l nd ne">Money('$0.01');<br/>Money('$0.10');<br/>Money('$1.00');<br/>Money('$10.00');<br/>Money('$12.45');</span></pre><p id="8f16" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">减法运算减去以美分为单位的值。稍后，它会生成可视化表示，并在必要时添加负号前缀。</p><p id="6546" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">为了产生直观的表示，您将小数点放在倒数第二位。如果小数点位置在第一个数字之前结束，用零填充缺少的字符。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu kx l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://gist.github.com/FagnerMartinsBrack/e7c07a64aa2538cc137b405a94cc71e5" rel="noopener ugc nofollow" target="_blank">名为“至小数点”的功能的代码</a>该算法显示了如何将小数点放在正确的位置。</figcaption></figure><p id="f596" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">乘法比减法更难。将美元乘以美分有意义吗？也许吧。让我们试试。</p><p id="0735" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><strong class="lh ir"> <em class="nf">注:</em> </strong> <em class="nf">参见</em> <a class="ae kv" href="https://medium.com/@fagnerbrack/the-reason-it-wouldnt-make-sense-to-multiply-dollar-amounts-against-other-types-of-dollar-amounts-8bef9dff364" rel="noopener"> <em class="nf">此评论</em> </a> <em class="nf">了解为什么将美元乘以美分没有意义的更多信息。</em></p><p id="7817" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">为了解决杰克的<a class="ae kv" href="https://medium.com/@fagnerbrack/the-missing-practical-step-by-step-test-driven-development-a7140ca4b71" rel="noopener">利息问题</a>，你需要计算1.00美元乘以0.09美元。因此，在乘法因子中使用其他美元值而不是a <code class="fe mb mc md me b">Number</code>似乎是合理的。</p><p id="0d8b" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">因为你将两个美元值乘以美分，如果你将2美元乘以2美元，你将得到40000美分。这表示为$400.00，但结果应该是$4.00。</p><p id="528a" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">如果你把计算结果除以100，你会得到400美分的正确输出。但是，您可以通过从乘法结果中去掉最后两位来避免数学除法。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu kx l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://gist.github.com/FagnerMartinsBrack/69d14b8468e709ee980a54889a1b8dec" rel="noopener ugc nofollow" target="_blank">一个文本文件</a>，显示以分为单位的乘法运算，以及如何将最右边的数字切掉。</figcaption></figure><p id="1669" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">当然，这两种解决方案都是以损失超过2位小数的精度为代价的。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu kx l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://gist.github.com/FagnerMartinsBrack/bae566c2df9a4f851cbcddcc82dcdcd0" rel="noopener ugc nofollow" target="_blank">代码</a>显示乘法逻辑的实现。</figcaption></figure><p id="40a4" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">您可以看到没有进一步优化的最终结果，在“Jack，The Moneylender”存储库的新提交(T7)中，包括测试(T10)。</p><p id="38fa" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我使用TDD来产生这个代码，就像我为Jack做的第一个交付物<a class="ae kv" href="https://medium.com/@fagnerbrack/the-missing-practical-step-by-step-test-driven-development-a7140ca4b71" rel="noopener">一样。然而，这篇文章并不是要告诉你如何做TDD这是为了理解如何解决浮点数缺乏精度的问题。</a></p><blockquote class="mf"><p id="ad9c" class="mg mh iq bd mi mj mk ml mm mn mo ma dk translated">有许多方法来表示金钱。其中之一就是用美分来表示。</p></blockquote><p id="fda2" class="pw-post-body-paragraph lf lg iq lh b li mp jr lk ll mq ju ln lo mr lq lr ls ms lu lv lw mt ly lz ma ij bi translated">没有什么可以阻止你提高精度和扩展到美分以上，比如支持<a class="ae kv" href="https://en.wikipedia.org/wiki/Mill_(currency)" rel="noopener ugc nofollow" target="_blank">百万货币</a>或<a class="ae kv" href="https://en.wikipedia.org/wiki/Bitcoin#Units" rel="noopener ugc nofollow" target="_blank">比特币(satoshis) </a>的部分。为了做到这一点并保持向后兼容性，假设丢失的数字的值为零。如果要从satoshis降尺度到美分，代码也不会破；只有你会失去超过2位小数的精度。</p><p id="35da" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">浮点数是一个陷阱。他们正确地拟合了问题；直到他们没有。到那时，再做任何改变都可能为时已晚。</p><p id="5145" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">不要用JavaScript <code class="fe mb mc md me b">Number</code>类型的分数表示来表示钱。事实上，不要对任何需要精度的东西使用浮点。</p><p id="3b50" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">可怕的事情发生时，你不需要和黑手党扯上关系。如果你不关心软件设计，那么以后可能就要有人来灭火了。</p><p id="9383" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">甚至可以是自己。</p></div><div class="ab cl ky kz hu la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ij ik il im in"><p id="1d9c" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">感谢阅读。如果你有一些反馈，请通过<a class="ae kv" href="https://twitter.com/FagnerBrack" rel="noopener ugc nofollow" target="_blank"> Twitter </a>、<a class="ae kv" href="https://www.facebook.com/fagner.brack" rel="noopener ugc nofollow" target="_blank">脸书</a>或<a class="ae kv" href="http://github.com/FagnerMartinsBrack" rel="noopener ugc nofollow" target="_blank"> Github </a>联系我。</p><p id="6380" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">感谢<a class="ae kv" href="https://joneaves.wordpress.com/" rel="noopener ugc nofollow" target="_blank"> Jon Eaves </a>、<strong class="lh ir"> Stephan Classen </strong>和<a class="ae kv" href="http://jay.bazuzi.com/" rel="noopener ugc nofollow" target="_blank"> Jay Bazuzi </a>对这篇文章的深刻见解。</p></div></div>    
</body>
</html>