<html>
<head>
<title>Deploy a Laravel Application to Kubernetes using Gitlab CI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Gitlab CI将Laravel应用程序部署到Kubernetes</h1>
<blockquote>原文：<a href="https://itnext.io/deploy-a-laravel-application-to-kubernetes-using-gitlab-ci-2538a6bbd373?source=collection_archive---------2-----------------------#2019-05-09">https://itnext.io/deploy-a-laravel-application-to-kubernetes-using-gitlab-ci-2538a6bbd373?source=collection_archive---------2-----------------------#2019-05-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="a47a" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">初学者指南</h2><div class=""/><div class=""><h2 id="64c7" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">CI/CD的快乐。推送您的代码，等待4分钟，它会自动部署，无需停机。</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/38bd3de135cfe935e96c6cbee82de86b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NO7nbqO-3NsSITtdHR0o4w.jpeg"/></div></div></figure><h1 id="78f7" class="ld le it bd lf lg lh li lj lk ll lm ln ki lo kj lp kl lq km lr ko ls kp lt lu bi translated">先决条件</h1><p id="3195" class="pw-post-body-paragraph lv lw it lx b ly lz kd ma mb mc kg md me mf mg mh mi mj mk ml mm mn mo mp mq im bi translated">本文假设您对Docker和Kubernetes、Gitlab CI有基本的了解，并且已经建立了一个Kubernetes集群。</p><h1 id="cec5" class="ld le it bd lf lg lh li lj lk ll lm ln ki lo kj lp kl lq km lr ko ls kp lt lu bi translated">启动一个Laravel项目</h1><p id="6503" class="pw-post-body-paragraph lv lw it lx b ly lz kd ma mb mc kg md me mf mg mh mi mj mk ml mm mn mo mp mq im bi translated">你首先需要一个Laravel应用程序，使用composer启动一个新项目。</p><pre class="ks kt ku kv gt mr ms mt mu aw mv bi"><span id="1a6d" class="mw le it ms b gy mx my l mz na">composer create-project --prefer-dist laravel/laravel blog</span></pre><h1 id="4583" class="ld le it bd lf lg lh li lj lk ll lm ln ki lo kj lp kl lq km lr ko ls kp lt lu bi translated">将你的Laravel项目归档</h1><p id="53d4" class="pw-post-body-paragraph lv lw it lx b ly lz kd ma mb mc kg md me mf mg mh mi mj mk ml mm mn mo mp mq im bi translated">有很多方法可以将你的Laravel项目归档。你可以使用dockerhub的官方Nginx和PHP图片，但是我发现设置它们有点麻烦。</p><p id="0389" class="pw-post-body-paragraph lv lw it lx b ly nb kd ma mb nc kg md me nd mg mh mi ne mk ml mm nf mo mp mq im bi translated">因此，我没有使用各种不同的docker图像，而是使用了一组现成的docker图像，即<a class="ae ng" href="https://github.com/thecodingmachine" rel="noopener ugc nofollow" target="_blank">the coding machine</a>/<a class="ae ng" href="https://github.com/thecodingmachine/docker-images-php" rel="noopener ugc nofollow" target="_blank">docker-images-PHP</a>。</p><p id="d1cf" class="pw-post-body-paragraph lv lw it lx b ly nb kd ma mb nc kg md me nd mg mh mi ne mk ml mm nf mo mp mq im bi translated">为了构建一个生产就绪的映像，我们将使用<code class="fe nh ni nj ms b">thecodingmachine/php:7.3-v2-slim-apache</code>作为我们的基础映像。docker文件如下所示:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi nk"><img src="../Images/9f063ba5eb15863d2ab4ebcf826cd748.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K51MqnYB2dmNolhUm66kWg.png"/></div></div></figure><p id="a4fb" class="pw-post-body-paragraph lv lw it lx b ly nb kd ma mb nc kg md me nd mg mh mi ne mk ml mm nf mo mp mq im bi translated">稍后我们将配置Gitlab CI来自动构建docker映像。</p><h1 id="9248" class="ld le it bd lf lg lh li lj lk ll lm ln ki lo kj lp kl lq km lr ko ls kp lt lu bi translated">创建Kubernetes部署文件</h1><p id="e10b" class="pw-post-body-paragraph lv lw it lx b ly lz kd ma mb mc kg md me mf mg mh mi mj mk ml mm mn mo mp mq im bi translated">这里是部署Laravel应用程序所需的所有yaml文件。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="nl nm l"/></div></figure><h2 id="c496" class="mw le it bd lf nn no dn lj np nq dp ln me nr ns lp mi nt nu lr mm nv nw lt iz bi translated">部署</h2><p id="8f60" class="pw-post-body-paragraph lv lw it lx b ly lz kd ma mb mc kg md me mf mg mh mi mj mk ml mm mn mo mp mq im bi translated">我们的deployment.yaml实际上包含两个部署。一个用于我们的主Laravel应用程序，另一个用于Laravel Horizon。如果您不打算使用Horizon，只需将其删除即可。</p><p id="a93d" class="pw-post-body-paragraph lv lw it lx b ly nb kd ma mb nc kg md me nd mg mh mi ne mk ml mm nf mo mp mq im bi translated">有一个init容器来优化配置和路由加载。为了在init容器和app容器之间共享应用程序代码，它使用了一个emptyDir。</p><p id="6b95" class="pw-post-body-paragraph lv lw it lx b ly nb kd ma mb nc kg md me nd mg mh mi ne mk ml mm nf mo mp mq im bi translated">还有一个affinity设置，告诉Kubernetes尽最大努力在不同节点之间调度pod，以避免停机。</p><h2 id="84fc" class="mw le it bd lf nn no dn lj np nq dp ln me nr ns lp mi nt nu lr mm nv nw lt iz bi translated">克朗乔布</h2><p id="68cb" class="pw-post-body-paragraph lv lw it lx b ly lz kd ma mb mc kg md me mf mg mh mi mj mk ml mm mn mo mp mq im bi translated">我们使用cronjob.yaml，它利用Kubernete的cronjob每分钟运行一次<code class="fe nh ni nj ms b">php artisan schedule:run</code>。我们觉得这是一种更健壮的调度cron的方式，通过微调<code class="fe nh ni nj ms b">activeDeadlineSeconds</code>、<code class="fe nh ni nj ms b">backoffLimit</code>和<code class="fe nh ni nj ms b">startingDeadlingSeconds</code>来确保我们的cron得到调度。</p><h2 id="627c" class="mw le it bd lf nn no dn lj np nq dp ln me nr ns lp mi nt nu lr mm nv nw lt iz bi translated">配置映射，入口和服务</h2><p id="2a7c" class="pw-post-body-paragraph lv lw it lx b ly lz kd ma mb mc kg md me mf mg mh mi mj mk ml mm mn mo mp mq im bi translated">我们的ingress.yaml和service.yaml相当标准，我们使用CloudFlare DNS验证从Let's Encrypt获取HTTPS证书(有评论)。</p><p id="6435" class="pw-post-body-paragraph lv lw it lx b ly nb kd ma mb nc kg md me nd mg mh mi ne mk ml mm nf mo mp mq im bi translated">至于configmap，建议使用secret来存储数据库密码等敏感信息。</p></div><div class="ab cl nx ny hx nz" role="separator"><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc"/></div><div class="im in io ip iq"><p id="6f71" class="pw-post-body-paragraph lv lw it lx b ly nb kd ma mb nc kg md me nd mg mh mi ne mk ml mm nf mo mp mq im bi translated">这里有一个GitHub回购，如果你想克隆它。合并请求也是赞赏的！</p><div class="oe of gp gr og oh"><a href="https://github.com/mkhmylife/laravel-k8s" rel="noopener  ugc nofollow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd jd gy z fp om fr fs on fu fw jc bi translated">mkhmylife/laravel-k8s</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">在GitHub上创建一个帐户，为mkhmylife/laravel-k8s的开发做出贡献。</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">github.com</p></div></div><div class="oq l"><div class="or l os ot ou oq ov lb oh"/></div></div></a></div><h1 id="750c" class="ld le it bd lf lg lh li lj lk ll lm ln ki lo kj lp kl lq km lr ko ls kp lt lu bi translated">设置Gitlab配置项</h1><p id="520c" class="pw-post-body-paragraph lv lw it lx b ly lz kd ma mb mc kg md me mf mg mh mi mj mk ml mm mn mo mp mq im bi translated">现在我们已经准备好了我们的应用程序和kubernetes配置，我们可以继续设置Gitlab CI来自动化我们的部署。(我们假设您正在使用Kubernetes令牌认证)</p><h2 id="b564" class="mw le it bd lf nn no dn lj np nq dp ln me nr ns lp mi nt nu lr mm nv nw lt iz bi translated">设置CI/CD环境变量</h2><p id="2477" class="pw-post-body-paragraph lv lw it lx b ly lz kd ma mb mc kg md me mf mg mh mi mj mk ml mm mn mo mp mq im bi translated">在Repo &gt; Settings &gt; CI / CD中，我们需要将Kubernetes集群凭证存储到Gitlab CI的环境变量中。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ow"><img src="../Images/ecf9dc69e215b3f514ae09a065431011.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h2ediw3OfaExpVn5aAzSMg.png"/></div></div></figure><p id="17c7" class="pw-post-body-paragraph lv lw it lx b ly nb kd ma mb nc kg md me nd mg mh mi ne mk ml mm nf mo mp mq im bi translated">将<code class="fe nh ni nj ms b">Dockerfile</code>移动到项目的根目录，然后创建一个名为<code class="fe nh ni nj ms b">k8</code>的文件夹，并将所有的kubernetes yaml文件存储在其中。创建一个名为<code class="fe nh ni nj ms b">.gitlab-ci.yml</code>的文件，包含以下内容:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="5e71" class="pw-post-body-paragraph lv lw it lx b ly nb kd ma mb nc kg md me nd mg mh mi ne mk ml mm nf mo mp mq im bi translated">CI/CD脚本包含两个步骤。首先是构建我们的Laravel应用程序并推送到Amazon ECR(您可以根据自己的喜好将其配置到另一个Docker图像报告)。然后，它继续将我们的Laravel应用程序映像部署到我们的Kubernetes集群。</p><p id="7286" class="pw-post-body-paragraph lv lw it lx b ly nb kd ma mb nc kg md me nd mg mh mi ne mk ml mm nf mo mp mq im bi translated">在第36和37行中，<code class="fe nh ni nj ms b">$KUBE_URL</code>和<code class="fe nh ni nj ms b">$KUBE_TOKEN</code>是我们上面设置的两个环境变量。</p><p id="b7e7" class="pw-post-body-paragraph lv lw it lx b ly nb kd ma mb nc kg md me nd mg mh mi ne mk ml mm nf mo mp mq im bi translated">在第40行，我们要求kubectl应用我们的k8s配置文件。</p><p id="7026" class="pw-post-body-paragraph lv lw it lx b ly nb kd ma mb nc kg md me nd mg mh mi ne mk ml mm nf mo mp mq im bi translated">在第41行，这是一个黑客触发吊舱重新部署。由于我们已经将<code class="fe nh ni nj ms b">imagePullPolicy</code>设置为<code class="fe nh ni nj ms b">always</code>，Kubernetes会自动将我们的docker图像重新拉到最新版本。结合我们部署的滚动更新策略，部署更新中应该没有停机时间。</p><p id="7c90" class="pw-post-body-paragraph lv lw it lx b ly nb kd ma mb nc kg md me nd mg mh mi ne mk ml mm nf mo mp mq im bi translated">在生产中，我们实际上使用<a class="ae ng" href="https://github.com/kubernetes-sigs/kustomize" rel="noopener ugc nofollow" target="_blank"> Kustomize </a>来维护多个Git分支和环境的部署。但是我们正在寻找切换到头盔，因为它似乎是一个更容易和更受欢迎的部署方法。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ow"><img src="../Images/78664e814aaf20d31db010f1e20c37c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tWQ2EBR36xRN_jwxzw_Yzw.png"/></div></div><figcaption class="ox oy gj gh gi oz pa bd b be z dk translated">CI/CD的快乐。推送您的代码，等待4分钟，它会自动部署，无需停机。</figcaption></figure><p id="a21d" class="pw-post-body-paragraph lv lw it lx b ly nb kd ma mb nc kg md me nd mg mh mi ne mk ml mm nf mo mp mq im bi translated">就是这样！CI/CD的快乐。只需推送您的代码，等待4分钟，它就会自动部署到<a class="ae ng" href="https://www.hyperair.com/en-US" rel="noopener ugc nofollow" target="_blank">https://www.hyperair.com/en-US</a>，无需停机。</p></div></div>    
</body>
</html>