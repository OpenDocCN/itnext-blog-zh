<html>
<head>
<title>Conditional build on GitLab</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于GitLab的条件构建</h1>
<blockquote>原文：<a href="https://itnext.io/conditional-build-gitlab-ee039b1d4fba?source=collection_archive---------4-----------------------#2022-05-09">https://itnext.io/conditional-build-gitlab-ee039b1d4fba?source=collection_archive---------4-----------------------#2022-05-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/40364c77aa389a1933121cd080a6bea5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*64vgCHosZXNV-gOsBQQhAA.jpeg"/></div></div></figure><p id="1447" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个博客的老读者知道我正在使用<a class="ae kw" href="https://jekyllrb.com/" rel="noopener ugc nofollow" target="_blank"> Jekyll </a>来生成静态站点。我正在使用GitLab:当我按下<code class="fe kx ky kz la b">master</code>分支时，它触发生成作业。</p><p id="effc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然而，Jekyll是基于Ruby的，需要几个Gem依赖项。我还添加了一些插件。出于这个原因，我创建了一个<a class="ae kw" href="https://blog.frankel.ch/musings-dockerfile-jekyll/" rel="noopener ugc nofollow" target="_blank"> Docker映像，其中包含所有必需的依赖关系</a>。我定期通过Bundler更新<code class="fe kx ky kz la b">Gemfile.lock</code>中的版本。之后，我需要重建Docker映像。</p><p id="4263" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，两份工作是必要的:</p><ol class=""><li id="40d9" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv lg lh li lj bi translated">在包含影响Docker映像的更改的推送之后，构建它</li><li id="8e12" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated">任何推送之后，生成站点。</li></ol><p id="18cd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，触发条件是以下文件中的任何一个是否被更改:<code class="fe kx ky kz la b">Gemfile.lock</code>、<code class="fe kx ky kz la b">Dockerfile</code>、<code class="fe kx ky kz la b">.gitlab-ci.yml</code>。</p><p id="a663" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">问题是如何在满足条件的情况下只运行构建<strong class="ka ir">版本</strong>，因为这是一个昂贵且耗时的操作。GitLab的构建文件配置为此提供了一个解决方案。在作业中，您可以配置一个<code class="fe kx ky kz la b">only</code>子句，使其仅在满足条件时运行。条件可以是:</p><ul class=""><li id="4660" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv lp lh li lj bi translated">一个引用，<em class="lq">，例如</em>，一个分支，或者一个标签</li><li id="ecb5" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lp lh li lj bi translated">触发<em class="lq">，例如</em>，推送，web UI或API调用</li><li id="234d" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lp lh li lj bi translated">变量的值</li><li id="ca33" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lp lh li lj bi translated">对特定文件的更改</li><li id="8c55" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lp lh li lj bi translated">其他几个</li></ul><p id="ed6d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">倒数第二个选项是我们问题的答案。我们可以配置一组文件，如果其中任何一个文件被更改，构建应该会运行。否则，什么都不做。</p><p id="7494" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它转化为以下结构:</p><pre class="lr ls lt lu gt lv la lw lx aw ly bi"><span id="2224" class="lz ma iq la b gy mb mc l md me">stages:<br/>  - image                                        # 1<br/>  - deploy                                       # 1</span><span id="e9af" class="lz ma iq la b gy mf mc l md me">build:                                           # 2<br/>  stage: image                                   # 2<br/>  image:<br/>    name: gcr.io/kaniko-project/executor:debug<br/>    entrypoint: [""]<br/>  script: # Build the Docker image<br/>  only:<br/>    refs:<br/>      - master                                   # 4<br/>    changes:<br/>      - Gemfile.lock                              # 5<br/>      - Dockerfile                                # 5<br/>      - .gitlab-ci.yml                           # 5</span><span id="5015" class="lz ma iq la b gy mf mc l md me">pages:                                           # 3<br/>  stage: deploy                                  # 3<br/>  image:<br/>    name: registry.gitlab.com/nfrankel/nfrankel.gitlab.io:latest<br/>  script: # Generate the site<br/>  only:<br/>    refs:<br/>      - master</span></pre><ol class=""><li id="044a" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv lg lh li lj bi translated">定义两个阶段</li><li id="301c" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated">在<code class="fe kx ky kz la b">image</code>阶段定义<code class="fe kx ky kz la b">build</code>工作。该作业创建Docker图像(通过Kaniko)</li><li id="0fe2" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated">在<code class="fe kx ky kz la b">deploy</code>阶段定义<code class="fe kx ky kz la b">pages</code>工作。该作业通过Jekyll生成网站</li><li id="ae3e" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated">仅构建<code class="fe kx ky kz la b">master</code>分支</li><li id="d7fd" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated">仅当这些文件中的任何一个发生更改时才构建映像</li></ol><p id="d7b5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此时，每次更改都会触发构建:映像构建作业在站点生成之前运行，但是如果映像没有更改，GitLab会跳过前者。</p><p id="10ab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">更进一步:</strong></p><ul class=""><li id="d92a" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv lp lh li lj bi translated"><a class="ae kw" href="https://docs.gitlab.com/ee/ci/yaml/index.html#onlychanges--exceptchanges" rel="noopener ugc nofollow" target="_blank">仅:变更/除外:变更</a></li><li id="66c7" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lp lh li lj bi translated"><a class="ae kw" href="https://docs.gitlab.com/ee/ci/jobs/job_control.html#onlychanges--exceptchanges-examples" rel="noopener ugc nofollow" target="_blank">仅:变更/除外:变更示例</a></li><li id="3657" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lp lh li lj bi translated"><a class="ae kw" href="https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#running-your-workflow-only-when-a-push-affects-specific-files" rel="noopener ugc nofollow" target="_blank"> GitHub:仅在推送影响特定文件时运行您的工作流</a></li></ul></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><p id="92e4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="lq">原载于</em> <a class="ae kw" href="https://blog.frankel.ch/conditional-build-gitlab/" rel="noopener ugc nofollow" target="_blank"> <em class="lq">一个Java怪胎</em></a><em class="lq">2022年5月8日</em></p></div></div>    
</body>
</html>