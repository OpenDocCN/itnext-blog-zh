<html>
<head>
<title>Run parallel tests in your workflow stages with Jenkins Pipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Jenkins Pipeline在您的工作流程阶段运行并行测试</h1>
<blockquote>原文：<a href="https://itnext.io/run-parallel-tests-in-your-workflow-stages-with-jenkins-pipeline-38003cf01075?source=collection_archive---------1-----------------------#2018-12-30">https://itnext.io/run-parallel-tests-in-your-workflow-stages-with-jenkins-pipeline-38003cf01075?source=collection_archive---------1-----------------------#2018-12-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="3b72" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Jenkins Pipeline是一套插件，允许为CI上的测试环境创建从简单到复杂的构建阶段。我们可以使用Jenkins Pipeline同时运行几个阶段，这得益于跨几个阶段的并行测试套件，可以更快地完成测试。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/1f601fd4c75d2367067a3876c70fa44f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yvBEYPoFo6GNYbZm.jpg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">詹金斯</figcaption></figure><p id="d1c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了使用<a class="ae lb" href="https://jenkins.io/doc/book/pipeline/" rel="noopener ugc nofollow" target="_blank"> Jenkins Pipeline </a>运行并行阶段，我们将需要一个适当的Jenkinsfile，它通过管道领域特定语言(DSL)语法将我们的交付管道表示为代码。</p><p id="9db2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要解决的另一个问题是，如何将我们的测试套件划分到并行的阶段，使得在所有阶段执行的测试套件的每个子集都能同时完成工作。在相似的时间内完成所有阶段的测试很重要，这样才能尽快运行我们的CI构建并消除瓶颈阶段。</p><h1 id="b49d" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">如何在并行的Jenkins阶段中平均划分测试套件</h1><p id="0625" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">为了将我们的测试划分到并行阶段，我们可以使用<a class="ae lb" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=jenkins-pipeline-how-to-run-parallel-tests-in-your-workflow-stages" rel="noopener ugc nofollow" target="_blank">背包Pro </a>，它允许跨阶段(也称为CI节点)动态分配测试。这样，我们将在最佳时间内运行我们的并行测试。</p><p id="3044" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里，您可以了解更多动态测试套件分配是如何工作的，以及它可以帮助解决哪些问题。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><h1 id="b1dd" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">并行管道的Jenkinsfile</h1><p id="294c" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">在这个例子中，我将向您展示如何在并行的Jenkins阶段中分割您的Ruby和JavaScript测试。</p><p id="140e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是Ruby的例子，如何分割Cucumber和RSpec测试套件。在<a class="ae lb" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=jenkins-pipeline-how-to-run-parallel-tests-in-your-workflow-stages" rel="noopener ugc nofollow" target="_blank">背包专业版</a>上还可以找到其他测试跑步者，如Minitest、Test::Unit等:</p><pre class="km kn ko kp gt mh mi mj mk aw ml bi"><span id="d6bd" class="mm ld iq mi b gy mn mo l mp mq">timeout(time: 60, unit: 'MINUTES') {<br/>  node() {<br/>    stage('Checkout') {<br/>      checkout([/* checkout code from git */])<br/><br/>      // determine git commit hash because we need to pass it to knapsack_pro<br/>      COMMIT_HASH = sh(returnStdout: true, script: 'git rev-parse HEAD').trim()<br/><br/>      stash 'source'<br/>    }<br/>  }<br/><br/>  def num_nodes = 4; // define your total number of CI nodes (how many parallel jobs will be executed)<br/>  def nodes = [:]<br/><br/>  for (int i = 0; i &lt; num_nodes; i++) {<br/>    def index = i;<br/>    nodes["ci_node_${i}"] = {<br/>      node() {<br/>        stage('Setup') {<br/>          unstash 'source'<br/>          // other setup steps<br/>        }<br/><br/>        def knapsack_options = """\<br/>            KNAPSACK_PRO_CI_NODE_TOTAL=${num_nodes}\<br/>            KNAPSACK_PRO_CI_NODE_INDEX=${index}\<br/>            KNAPSACK_PRO_COMMIT_HASH=${COMMIT_HASH}\<br/>            KNAPSACK_PRO_BRANCH=${env.BRANCH_NAME}\<br/>        """<br/><br/>        // example how to run cucumber tests in Knapsack Pro Regular Mode<br/>        stage('Run cucumber') {<br/>          sh """${knapsack_options} bundle exec rake knapsack_pro:cucumber"""<br/>        }<br/><br/>        // example how to run rspec tests in Knapsack Pro Queue Mode<br/>        // Queue Mode should be as a last stage so it can autobalance build if tests in regular mode were not perfectly distributed<br/>        stage('Run rspec') {<br/>          sh """KNAPSACK_PRO_CI_NODE_BUILD_ID=${env.BUILD_TAG} ${knapsack_options} bundle exec rake knapsack_pro:queue:rspec"""<br/>        }<br/>      }<br/>    }<br/>  }<br/><br/>  parallel nodes // run CI nodes in parallel<br/>}</span></pre><p id="627c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是如何拆分Cypress测试的JavaScript示例。你可以在这里了解更多关于赛普拉斯测试赛跑者的<a class="ae lb" href="https://docs.knapsackpro.com/2018/run-javascript-e2e-tests-faster-with-cypress-on-parallel-ci-nodes" rel="noopener ugc nofollow" target="_blank">分裂E2E测试。</a></p><pre class="km kn ko kp gt mh mi mj mk aw ml bi"><span id="a228" class="mm ld iq mi b gy mn mo l mp mq">timeout(time: 60, unit: 'MINUTES') {<br/>  node() {<br/>    stage('Checkout') {<br/>      checkout([/* checkout code from git */])<br/><br/>      // determine git commit hash because we need to pass it to Knapsack Pro<br/>      COMMIT_HASH = sh(returnStdout: true, script: 'git rev-parse HEAD').trim()<br/><br/>      stash 'source'<br/>    }<br/>  }<br/><br/>  def num_nodes = 4; // define your total number of CI nodes (how many parallel jobs will be executed)<br/>  def nodes = [:]<br/><br/>  for (int i = 0; i &lt; num_nodes; i++) {<br/>    def index = i;<br/>    nodes["ci_node_${i}"] = {<br/>      node() {<br/>        stage('Setup') {<br/>          unstash 'source'<br/>          // other setup steps<br/>        }<br/><br/>        def knapsack_options = """\<br/>            KNAPSACK_PRO_CI_NODE_TOTAL=${num_nodes}\<br/>            KNAPSACK_PRO_CI_NODE_INDEX=${index}\<br/>            KNAPSACK_PRO_COMMIT_HASH=${COMMIT_HASH}\<br/>            KNAPSACK_PRO_BRANCH=${env.BRANCH_NAME}\<br/>            KNAPSACK_PRO_CI_NODE_BUILD_ID=${env.BUILD_TAG}\<br/>        """<br/><br/>        // example how to run tests with Knapsack Pro<br/>        stage('Run tests') {<br/>          sh """${knapsack_options} $(npm bin)/knapsack-pro-cypress"""<br/>        }<br/>      }<br/>    }<br/>  }<br/><br/>  parallel nodes // run CI nodes in parallel<br/>}</span></pre><p id="b216" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Jenkins Pipeline为您提供了一个连续交付(CD)管道，它是您将软件从版本控制直接交付给用户的过程的自动化表达。通过快速运行CI构建来节省工程团队的时间非常重要。一种方法是<a class="ae lb" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=jenkins-pipeline-how-to-run-parallel-tests-in-your-workflow-stages" rel="noopener ugc nofollow" target="_blank">测试套件并行化，这可以用backpack Pro的Ruby和JavaScript测试</a>以最佳方式完成。</p></div><div class="ab cl mr ms hu mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="ij ik il im in"><p id="5ac9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="my">最初发表于</em><a class="ae lb" href="https://docs.knapsackpro.com/2018/jenkins-pipeline-how-to-run-parallel-tests-in-your-workflow-stages" rel="noopener ugc nofollow" target="_blank">T5【docs.knapsackpro.com】</a><em class="my">。</em></p></div></div>    
</body>
</html>