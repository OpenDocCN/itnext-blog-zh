<html>
<head>
<title>Kubernetes Ingress Control using Gloo</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Gloo的Kubernetes入口控制</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-ingress-control-using-gloo-3dca70924ed3?source=collection_archive---------0-----------------------#2019-03-29">https://itnext.io/kubernetes-ingress-control-using-gloo-3dca70924ed3?source=collection_archive---------0-----------------------#2019-03-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="4946" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Kubernetes非常棒，它使得创建和管理高度分布式的应用程序变得更加容易。一个挑战是，你如何与世界其他地方分享你的伟大的Kubernetes托管的应用程序。许多人倾向于使用<a class="ae ko" href="https://kubernetes.io/docs/concepts/services-networking/ingress/" rel="noopener ugc nofollow" target="_blank"> Kubernetes Ingress </a>对象，本文将向您展示如何使用开源的<a class="ae ko" href="https://solo.io" rel="noopener ugc nofollow" target="_blank">solo . io</a>T6】Gloo来满足这一需求。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi kp"><img src="../Images/e72cc0ac1a996daefd4395534462cd9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/0*pCLggbBrQCn-WPgf.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">Solo.io Gloo作为Kubernetes入口</figcaption></figure><p id="2760" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae ko" href="https://medium.com/solo-io/announcing-gloo-the-function-gateway-3f0860ef6600" rel="noopener"> Gloo是一个函数网关</a>，它为用户提供了许多好处，包括复杂的函数级路由、深度服务发现以及OpenAPI (Swagger)定义的内省、gRPC反射、Lambda发现等等。Gloo可以充当入口控制器，即根据入口对象中定义的路径路由规则，将Kubernetes外部流量路由到Kubernetes集群托管的服务。我非常相信通过例子展示技术，所以让我们快速浏览一个例子，向您展示什么是可能的。</p><h1 id="f2e9" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">先决条件</h1><p id="7bcb" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">这个例子假设您正在一个本地<a class="ae ko" href="https://kubernetes.io/docs/setup/minikube/" rel="noopener ugc nofollow" target="_blank"> minikube </a>实例上运行，并且您也有<a class="ae ko" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank"> kubectl </a>在运行。你可以在你最喜欢的云提供商管理的Kubernetes集群上运行这个例子，你只需要做一些调整。你还需要安装Gloo。让我们用<a class="ae ko" href="https://brew.sh/" rel="noopener ugc nofollow" target="_blank">自制软件</a>来为我们设置这一切。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="1c8f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将所有内容下载并安装到您的本地计算机上，并开始所有工作需要几分钟时间。假设一切顺利，命令(<code class="fe mg mh mi mj b">kubectl</code>)应该已经返回了<code class="fe mg mh mi mj b">minikube</code>，这意味着您的本地minikube集群正在运行，并且您的Kubernetes集群配置已经为minikube正确设置。</p><p id="d93b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我们深入研究入口对象之前，还有一件事，让我们设置一个部署在Kubernetes上的示例服务，我们可以参考它。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="me mf l"/></div></figure><h1 id="5a45" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">设置示例Petstore的入口</h1><p id="a393" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">让我们设置一个基本的Ingress对象，将所有HTTP流量路由到我们的petstore服务。为了让这变得更有趣和更有挑战性，谁不喜欢好的技术挑战呢，让我们也配置一个主机域，这将需要一点额外的<code class="fe mg mh mi mj b">curl</code>魔法来正确调用我们本地的Kubernetes集群。下面的入口定义将把对<code class="fe mg mh mi mj b">http://gloo.example.com</code>的所有请求路由到我们集群中监听端口8080的petstore服务。petstore服务提供了一些监听查询路径<code class="fe mg mh mi mj b">/api/pets</code>的REST函数，这些函数将返回我们(小)商店中宠物库存的JSON。</p><p id="3fbf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您在公共云Kubernetes实例中尝试这个例子，您很可能需要配置一个云负载平衡器。确保您为在<code class="fe mg mh mi mj b">gloo-system</code>名称空间中运行的<code class="fe mg mh mi mj b">service/ingress-proxy</code>配置了负载平衡器。</p><p id="de21" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">重要的细节是:</p><ul class=""><li id="6abf" class="mk ml it js b jt ju jx jy kb mm kf mn kj mo kn mp mq mr ms bi translated">注释<code class="fe mg mh mi mj b">kubernetes.io/ingress.class: gloo</code>，这是将入口标记为由特定入口控制器(即Gloo)处理的标准方式。当我们增加Gloo作为集群默认入口控制器的能力时，这个需求将很快消失</li><li id="978a" class="mk ml it js b jt mt jx mu kb mv kf mw kj mx kn mp mq mr ms bi translated">路径通配符<code class="fe mg mh mi mj b">/.*</code>表示将所有流量路由到我们的petstore服务</li></ul><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="ea43" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以通过以下命令验证Kubernetes是否正确创建了入口。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="0631" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了测试，我们将使用<code class="fe mg mh mi mj b">curl</code>来调用我们的本地集群。就像我前面说过的，通过在我们的入口中定义一个<code class="fe mg mh mi mj b">host: gloo.example.com</code>，我们需要做更多的事情来调用它，而不需要对DNS或我们的本地/etc/hosts文件做任何事情。我将使用最近的<code class="fe mg mh mi mj b">curl --connect-to</code>选项，您可以在<a class="ae ko" href="https://curl.haxx.se/docs/manpage.html#--connect-to" rel="noopener ugc nofollow" target="_blank"> curl手册页</a>中了解更多相关信息。</p><p id="4f66" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">glooctl命令行工具帮助我们使用<code class="fe mg mh mi mj b">glooctl proxy url --name &lt;ingress name&gt;</code>命令获取代理的本地主机IP和端口。它返回一个带有协议前缀的完整URL，我们需要去掉这个前缀才能和curl一起使用。下面的两个命令将使用一点点命令行魔法来使这个例子在您的本地机器上工作。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="c346" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">它应该返回下面的JSON</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="me mf l"/></div></figure><h2 id="1b4c" class="my lc it bd ld mz na dn lh nb nc dp ll kb nd ne lp kf nf ng lt kj nh ni lx nj bi translated">TLS配置</h2><p id="9ff5" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">如今，大多数人都希望使用TLS来保护您的通信。Gloo Ingress可以充当TLS终结器，我们将快速浏览一下它的设置。</p><p id="a438" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">任何执行TLS的Kubernetes Ingress都需要创建一个Kubernetes TLS secret，所以让我们创建一个自签名证书，用于我们的示例<code class="fe mg mh mi mj b">gloo.example.com</code>域。以下两个命令将创建一个证书，并在minikube中创建一个名为<code class="fe mg mh mi mj b">my-tls-secret</code>的TLS秘密。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="e558" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在让我们用所需的TLS配置来更新我们的入口对象。重要的是TLS主机和规则主机匹配，并且<code class="fe mg mh mi mj b">secretName</code>匹配先前部署的Kubernetes secret的名称。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="8237" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果一切顺利，我们应该将我们的宠物商店改为现在收听<code class="fe mg mh mi mj b">https://gloo.example.com</code>。让我们尝试一下，再次使用我们的curl magic，我们需要它来解析主机和端口以及验证我们的证书。注意，这次我们向glooctl请求<code class="fe mg mh mi mj b">--port https</code>，我们在端口443上卷曲<code class="fe mg mh mi mj b">https://gloo.example.com</code>。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="me mf l"/></div></figure><h1 id="56c7" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">后续步骤</h1><p id="a735" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">这是Gloo如何作为Kubernetes入口控制器的快速浏览，只需对现有的Kubernetes清单做很小的更改。请尝试一下，并通过我们的<a class="ae ko" href="https://slack.solo.io/" rel="noopener ugc nofollow" target="_blank">社区Slack频道</a>告诉我们您的想法。</p><p id="4c1f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你对启动Gloo超能力感兴趣，请尝试网关模式下的Gloo<code class="fe mg mh mi mj b">glooctl install gateway</code>，它会解锁一组Kubernetes CRDs(自定义资源),为你提供一种更标准、更强大的方式来进行更高级的流量转移、速率限制等，而不会在你的Kubernetes集群中产生注释气味。查看这些其他文章，了解Gloo额外能力的更多细节。</p><ul class=""><li id="952c" class="mk ml it js b jt ju jx jy kb mm kf mn kj mo kn mp mq mr ms bi translated"><a class="ae ko" href="https://medium.com/solo-io/routing-with-gloo-function-gateway-301765bb103e" rel="noopener">带Gloo功能网关的路由</a></li><li id="7879" class="mk ml it js b jt mt jx mu kb mv kf mw kj mx kn mp mq mr ms bi translated"><a class="ae ko" href="https://medium.com/solo-io/canary-deployments-with-solo-io-gloo-function-gateway-using-request-headers-b78fc15c806b" rel="noopener">带Gloo功能网关的Canary部署</a></li><li id="77ad" class="mk ml it js b jt mt jx mu kb mv kf mw kj mx kn mp mq mr ms bi translated"><a class="ae ko" href="https://medium.com/solo-io/canary-deployments-with-gloo-function-gateway-using-weighted-destinations-b3365ea7af7d" rel="noopener">使用加权目的地的Gloo功能网关的Canary部署</a></li></ul></div><div class="ab cl nk nl hx nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="im in io ip iq"><p id="c94c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="nr">原载于</em><a class="ae ko" href="https://scott.cranton.com/kubernetes-ingress-controlling-with-gloo.html" rel="noopener ugc nofollow" target="_blank"><em class="nr">scott.cranton.com</em></a><em class="nr">。</em></p></div></div>    
</body>
</html>