<html>
<head>
<title>Mocking ExpressJS Request and Response objects</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">模仿ExpressJS请求和响应对象</h1>
<blockquote>原文：<a href="https://itnext.io/mocking-expressjs-request-and-response-objects-63405e9c58ff?source=collection_archive---------1-----------------------#2018-08-12">https://itnext.io/mocking-expressjs-request-and-response-objects-63405e9c58ff?source=collection_archive---------1-----------------------#2018-08-12</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><figure class="iq ir gq gs is it gi gj paragraph-image"><div role="button" tabindex="0" class="iu iv di iw bf ix"><div class="gi gj ip"><img src="../Images/79157eb9d56b247117da4677767b7703.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tGP1jbyD3w29a3xOzzEm8g.jpeg"/></div></div><figcaption class="ja jb gk gi gj jc jd bd b be z dk translated">新德里街道上的请求和响应(图片由作者的照片生成)</figcaption></figure><div class=""/><p id="cc12" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">当单元测试<code class="fe lb lc ld le b"><a class="ae lf" href="https://expressjs.com" rel="noopener ugc nofollow" target="_blank">ExpressJS</a></code>路由控制器和中间件时，你需要创建虚拟的<code class="fe lb lc ld le b">req</code>和<code class="fe lb lc ld le b">res</code>对象作为参数传入。<code class="fe lb lc ld le b">req</code> param需要一堆属性，最典型的是<code class="fe lb lc ld le b">body</code>、<code class="fe lb lc ld le b">query</code>和<code class="fe lb lc ld le b">params</code>对象，以及用于访问头的<code class="fe lb lc ld le b">get</code>函数。<code class="fe lb lc ld le b">res</code>参数通常需要<code class="fe lb lc ld le b">end</code>、<code class="fe lb lc ld le b">json</code>、<code class="fe lb lc ld le b">send</code>和<code class="fe lb lc ld le b">status</code>函数，以及您的函数使用的任何其他东西。在<code class="fe lb lc ld le b">status</code>函数的情况下，你的假<code class="fe lb lc ld le b">res</code>对象需要确保它的<code class="fe lb lc ld le b">status</code>函数是可链接的。</p><p id="8dfc" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">为了简单起见，我发布了<code class="fe lb lc ld le b"><a class="ae lf" href="https://www.npmjs.com/package/mock-req-res" rel="noopener ugc nofollow" target="_blank">mock-req-res</a></code> <a class="ae lf" href="https://www.npmjs.com/package/mock-req-res" rel="noopener ugc nofollow" target="_blank">，</a>，它们公开了<code class="fe lb lc ld le b">mockRequest</code>和<code class="fe lb lc ld le b">mockResponse</code>函数，您的单元测试可以使用它们来生成一致且有用的模拟<code class="fe lb lc ld le b">req</code>和<code class="fe lb lc ld le b">res</code>对象。</p><h1 id="e51f" class="lg lh jg bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">模拟请求</h1><pre class="me mf mg mh gu mi le mj mk aw ml bi"><span id="50f2" class="mm lh jg le b gz mn mo l mp mq">const req = mockRequest(options)</span></pre><p id="6f96" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated"><code class="fe lb lc ld le b">options</code>可以是你想要的任何东西。默认值为:</p><pre class="me mf mg mh gu mi le mj mk aw ml bi"><span id="0a8e" class="mm lh jg le b gz mn mo l mp mq">body: {},<br/>cookies: {},<br/>query: {},<br/>params: {}</span></pre><p id="12e0" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated"><code class="fe lb lc ld le b">get</code>功能作为<code class="fe lb lc ld le b"><a class="ae lf" href="https://sinonjs.org" rel="noopener ugc nofollow" target="_blank">sinon</a></code>T24提供。</p><h1 id="db4b" class="lg lh jg bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">模拟回应</h1><pre class="me mf mg mh gu mi le mj mk aw ml bi"><span id="d3cb" class="mm lh jg le b gz mn mo l mp mq">const res = mockResponse(options)</span></pre><p id="bfa6" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">默认的<code class="fe lb lc ld le b">options</code>有:</p><pre class="me mf mg mh gu mi le mj mk aw ml bi"><span id="fdcd" class="mm lh jg le b gz mn mo l mp mq">clearCookie: spy(),<br/>cookie: spy(),<br/>download: spy(),<br/>end: spy(),<br/>format: spy(),<br/>json: spy(),<br/>jsonp: spy(),<br/>redirect: spy(),<br/>render: spy(),<br/>send: spy(),<br/>sendFile: spy(),<br/>sendStatus: spy(),<br/>set: spy(),<br/>type: spy()</span></pre><p id="0c2a" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">在这种情况下，大多数默认函数都被设置为<code class="fe lb lc ld le b"><a class="ae lf" href="https://sinonjs.org" rel="noopener ugc nofollow" target="_blank">sinon</a></code> <code class="fe lb lc ld le b">spies</code>，所以您的测试可以简单地使用<code class="fe lb lc ld le b">expect(res.end).to.have.been.calledOnce</code>。就像<code class="fe lb lc ld le b">request</code>对象一样，<code class="fe lb lc ld le b">get</code>函数被存根化，允许您的测试控制<code class="fe lb lc ld le b">get</code>返回什么。</p><p id="d985" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated"><code class="fe lb lc ld le b">status</code>和<code class="fe lb lc ld le b">vary</code>函数都被存根化并设置为返回<code class="fe lb lc ld le b">response</code>对象，允许链接。</p><h1 id="f851" class="lg lh jg bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">选择</h1><p id="fc71" class="pw-post-body-paragraph kd ke jg kf b kg mr ki kj kk ms km kn ko mt kq kr ks mu ku kv kw mv ky kz la ik bi translated"><code class="fe lb lc ld le b">mockRequest</code>和<code class="fe lb lc ld le b">mockResponse</code>函数都返回包含最常用默认值的对象。可以向它们传递一个<code class="fe lb lc ld le b">options</code>对象，该对象的根级别值只是与那些默认值合并，任何重复的值都会覆盖默认值。因此，如果你需要一个<code class="fe lb lc ld le b">request</code>对象的特定属性，那么只需将它作为<code class="fe lb lc ld le b">option</code>传入即可。</p><h1 id="cf67" class="lg lh jg bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">用法示例</h1><p id="aaae" class="pw-post-body-paragraph kd ke jg kf b kg mr ki kj kk ms km kn ko mt kq kr ks mu ku kv kw mv ky kz la ik bi translated">假设你有一个<code class="fe lb lc ld le b">ExpressJS</code>路径控制器功能如下:</p><pre class="me mf mg mh gu mi le mj mk aw ml bi"><span id="38e0" class="mm lh jg le b gz mn mo l mp mq">const save = require('../../utils/saveThing') // assume this exists.</span><span id="0797" class="mm lh jg le b gz mw mo l mp mq">const createThing = (req, res) =&gt; {<br/>  const { name, description } = req.body<br/>  if (!name || !description) throw new Error('Invalid Properties')<br/>  const saved = save({ name, description })<br/>  res.json(saved)<br/>}</span></pre><p id="e076" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">要对此进行单元测试，您可以使用<code class="fe lb lc ld le b"><a class="ae lf" href="https://mochajs.org" rel="noopener ugc nofollow" target="_blank">Mocha</a></code>、<code class="fe lb lc ld le b"><a class="ae lf" href="http://www.chaijs.com" rel="noopener ugc nofollow" target="_blank">Chai</a></code>、<code class="fe lb lc ld le b"><a class="ae lf" href="https://sinonjs.org" rel="noopener ugc nofollow" target="_blank">Sinon</a></code>和<code class="fe lb lc ld le b"><a class="ae lf" href="https://github.com/thlorenz/proxyquire" rel="noopener ugc nofollow" target="_blank">Proxyquire</a></code>，如下所示:</p><pre class="me mf mg mh gu mi le mj mk aw ml bi"><span id="aff2" class="mm lh jg le b gz mn mo l mp mq">const { expect } = require('chai')<br/>const { stub, match } = require('sinon')<br/>const { mockRequest, mockResponse } = require('mock-req-res')<br/>const proxyquire = require('proxyquire')</span><span id="e4cc" class="mm lh jg le b gz mw mo l mp mq">describe('src/api/things/createThing', () =&gt; {<br/>  const mockSave = stub()</span><span id="9f17" class="mm lh jg le b gz mw mo l mp mq">  const createThing = proxyquire('../../src/api/things/createThing', {<br/>    '../../utils/saveThing': mockSave<br/>  })</span><span id="98bd" class="mm lh jg le b gz mw mo l mp mq">  const res = mockResponse()</span><span id="0e4d" class="mm lh jg le b gz mw mo l mp mq">  const resetStubs = () =&gt; {<br/>    mockSave.resetHistory()<br/>    res.json.resetHistory()<br/>  }</span><span id="fc98" class="mm lh jg le b gz mw mo l mp mq">  context('happy path', () =&gt; {<br/>    const name = 'some name'<br/>    const description = 'some description'</span><span id="e48d" class="mm lh jg le b gz mw mo l mp mq">    const req = mockRequest({ body: { name, description }})<br/>    const expected = { name, description, id: 1 }<br/>    <br/>    before(() =&gt; {<br/>      save.returns(expected)<br/>      createThing(req, res)<br/>    })</span><span id="a864" class="mm lh jg le b gz mw mo l mp mq">    after(resetStubs)</span><span id="f579" class="mm lh jg le b gz mw mo l mp mq">    it('called save with the right data', () =&gt; {<br/>      expect(save).to.have.been.calledWith(match({<br/>        name,<br/>        description<br/>      }))<br/>    })</span><span id="c05a" class="mm lh jg le b gz mw mo l mp mq">    it('called res.json with the right data', () =&gt; {<br/>      expect(res.json).to.have.been.calledWith(match(expected))<br/>    })<br/>  })</span><span id="ff47" class="mm lh jg le b gz mw mo l mp mq">  // and also test the various unhappy path scenarios.<br/>})</span></pre><h1 id="80e4" class="lg lh jg bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">摘要</h1><p id="b988" class="pw-post-body-paragraph kd ke jg kf b kg mr ki kj kk ms km kn ko mt kq kr ks mu ku kv kw mv ky kz la ik bi translated">当您需要测试的函数数量增加时，或者您发现自己正在编写大量的微服务时，使用标准库来模仿<code class="fe lb lc ld le b">request</code>和<code class="fe lb lc ld le b">response</code>对象可以为您节省大量令人厌烦的重复工作。</p><p id="5af9" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated"><code class="fe lb lc ld le b">mock-req-res</code>库尽可能的小，只需要<code class="fe lb lc ld le b">sinon</code>作为对等依赖。</p><h1 id="1d24" class="lg lh jg bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">链接</h1><ul class=""><li id="6649" class="mx my jg kf b kg mr kk ms ko mz ks na kw nb la nc nd ne nf bi translated"><code class="fe lb lc ld le b"><a class="ae lf" href="https://expressjs.com" rel="noopener ugc nofollow" target="_blank">ExpressJS</a></code>:用于<code class="fe lb lc ld le b">NodeJS</code>的标准web服务器框架，</li><li id="4a15" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b"><a class="ae lf" href="https://sinonjs.org" rel="noopener ugc nofollow" target="_blank">Sinon</a></code>:强大的嘲讽库，</li><li id="585b" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated">让你的测试富有表现力，</li><li id="2d25" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b"><a class="ae lf" href="https://github.com/thlorenz/proxyquire" rel="noopener ugc nofollow" target="_blank">Proxyquire</a></code>:将你自己的模拟对象注入到你正在测试的模块中，</li><li id="5090" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b"><a class="ae lf" href="https://mochajs.org" rel="noopener ugc nofollow" target="_blank">Mocha</a></code>:强大的测试自动化库，</li><li id="d9cb" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated">NPM的图书馆，还有</li><li id="f175" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated">GitHub中的<code class="fe lb lc ld le b"><a class="ae lf" href="https://github.com/davesag/mock-req-res" rel="noopener ugc nofollow" target="_blank">mock-req-res</a></code>源代码。</li></ul><p id="0448" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi">—</p><p id="f5f2" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">像这样但不是订户？您可以通过davesag.medium.com的<a class="ae lf" href="https://davesag.medium.com/membership" rel="noopener">加入来支持作者。</a></p></div></div>    
</body>
</html>