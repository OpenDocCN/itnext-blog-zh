<html>
<head>
<title>How to Download and Test Files in Headless Chrome</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Headless Chrome中下载和测试文件</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-download-and-test-files-in-headless-chrome-100dcef58ea3?source=collection_archive---------6-----------------------#2018-12-20">https://itnext.io/how-to-download-and-test-files-in-headless-chrome-100dcef58ea3?source=collection_archive---------6-----------------------#2018-12-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/d38494ba13c1ca8584ddbe7b92479ec4.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*LlmRetaEqA_ZGzmrvNcCGQ.jpeg"/></div></figure><p id="7fb4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">挑战在于下载一个excel文件并在无头浏览器(Chrome)中检查其内容。多亏了我的同事，我们终于可以完成这项任务了。虽然这是Excel文件的一个示例，但是您可以将它用于其他类型的文件。</p><p id="0868" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我正在使用<a class="ae ks" href="http://webdriver.io" rel="noopener ugc nofollow" target="_blank"> WebdriverIO </a>和Mocha进行我们的回归测试，我用来下载文件的包是<a class="ae ks" href="https://www.npmjs.com/package/download-file" rel="noopener ugc nofollow" target="_blank">下载文件</a>。这很简单。</p><p id="c338" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">步骤1:编写您的异步测试:</strong></p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="a27d" class="lc ld iq ky b gy le lf l lg lh">const page = require('./page.js');</span><span id="a336" class="lc ld iq ky b gy li lf l lg lh">describe('Assert file download function:', () =&gt; {    <br/>    before( () =&gt; {        <br/>        browser.url('/');                            <br/>    });   <br/>    <br/>    it('Download an Excel file', async () =&gt; {         <br/>        await page.downloadExcelFile();                <br/>        await page.assertExcelFile();      <br/>    });<br/>});</span></pre><p id="63e3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">第二步:编写下载并断言函数</strong></p><p id="b5d6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下载之前，您需要安装此软件包:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="6ed6" class="lc ld iq ky b gy le lf l lg lh">npm install download-file</span></pre><p id="6dd8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后写你的下载函数。这将有助于下载您的excel文件，并将其放在<strong class="jw ir"> <em class="lj"> tempDownload </em> </strong>文件夹中。</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="1cce" class="lc ld iq ky b gy le lf l lg lh">// page.js</span><span id="38f9" class="lc ld iq ky b gy li lf l lg lh">downloadExcelFile() {<br/>   // Get excel url                   <br/>   let excelUrl = $(this.excelBtn).getAttribute('href');        <br/>        <br/>   let options = {<br/>        directory: './tempDownload',<br/>        filename: 'file-name.xlsx'          <br/>   }</span><span id="1d54" class="lc ld iq ky b gy li lf l lg lh">   return new Promise(async (reject) =&gt; {<br/>        download(excelUrl, options, err =&gt; {                <br/>              reject(err);          <br/>        });            <br/>   });     <br/>}</span></pre><p id="8981" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">他们编写你的测试函数。只是为了让你知道我正在使用<a class="ae ks" href="https://www.npmjs.com/package/xlsx" rel="noopener ugc nofollow" target="_blank"><strong class="jw ir"><em class="lj">xlsx</em></strong></a>包来读取一个excel文件的内容。</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="4ad1" class="lc ld iq ky b gy le lf l lg lh">// page.js</span><span id="77e2" class="lc ld iq ky b gy li lf l lg lh">async assertExcelFile() {                <br/>     const filePath = path.join('your-download-dir', 'file-name.xlsx');</span><span id="fb9f" class="lc ld iq ky b gy li lf l lg lh">     browser.call(() =&gt; {<br/>            return waitForFileExists(filePath, 10000);<br/>     });</span><span id="f36b" class="lc ld iq ky b gy li lf l lg lh">     let workbook = XLSX.readFile(filePath);        <br/>     let firstSheetName = workbook.SheetNames[0];<br/>     let workSheet = workbook.Sheets[firstSheetName];<br/>     // Do what ever you want here. Remember to read the document</span><span id="8151" class="lc ld iq ky b gy li lf l lg lh">     // Remove temporary download folder<br/>     rmdir('your-download-dir');<br/>}</span></pre><p id="a302" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">你可能想知道<strong class="jw ir">waitforfilexists</strong>和<strong class="jw ir"> rmdir </strong>从何而来。它们是额外的功能，帮助在测试前检查文件是否存在，并确保测试后下载文件夹将被删除。</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="0a21" class="lc ld iq ky b gy le lf l lg lh">// wait_for_file_exists.js</span><span id="e5ed" class="lc ld iq ky b gy li lf l lg lh">const fs = require('fs')<br/>const path = require('path')</span><span id="6035" class="lc ld iq ky b gy li lf l lg lh">// pulled from <a class="ae ks" href="https://stackoverflow.com/a/47764403" rel="noopener ugc nofollow" target="_blank">https://stackoverflow.com/a/47764403</a><br/>module.exports = function waitForFileExists(filePath, timeout) {<br/>  return new Promise(function (resolve, reject) {<br/>    let timer = setTimeout(function () {<br/>      watcher.close();<br/>      reject(new Error('File did not exists and was not created during the timeout.'));<br/>    }, timeout);<br/>    <br/>    fs.access(filePath, fs.constants.R_OK, function (err) {<br/>      if (!err) {        <br/>        clearTimeout(timer);<br/>        watcher.close();<br/>        resolve();<br/>      }<br/>    });</span><span id="605b" class="lc ld iq ky b gy li lf l lg lh">    let dir = path.dirname(filePath);<br/>    let basename = path.basename(filePath);<br/>    let watcher = fs.watch(dir, function (eventType, filename) {<br/>      if (eventType === 'rename' &amp;&amp; filename === basename) {<br/>        clearTimeout(timer);<br/>        watcher.close();<br/>        resolve();<br/>      }<br/>    });<br/>  });<br/>}</span></pre><p id="422e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于删除文件夹功能:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="40d2" class="lc ld iq ky b gy le lf l lg lh">// rmdir.js</span><span id="8a2a" class="lc ld iq ky b gy li lf l lg lh">const path = require('path')<br/>const fs = require('fs')</span><span id="8620" class="lc ld iq ky b gy li lf l lg lh">// Pulled from <a class="ae ks" href="https://gist.github.com/tkihira/2367067" rel="noopener ugc nofollow" target="_blank">https://gist.github.com/tkihira/2367067</a><br/>module.exports = function rmdir(dir) {<br/>  let list = fs.readdirSync(dir);<br/>  for(let i = 0; i &lt; list.length; i++) {<br/>    let filename = path.join(dir, list[i]);<br/>    let stat = fs.statSync(filename);</span><span id="5e8f" class="lc ld iq ky b gy li lf l lg lh">if(filename == "." || filename == "..") {<br/>      // pass these files<br/>    } else if(stat.isDirectory()) {<br/>      // rmdir recursively<br/>      rmdir(filename);<br/>    } else {<br/>      // rm fiilename<br/>      fs.unlinkSync(filename);<br/>    }<br/>  }<br/>  fs.rmdirSync(dir);<br/>}</span></pre><p id="c31d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从现在开始，你可以在Chrome headless中下载任何文件。我还没和其他车手试过。</p><p id="110a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">希望对此有所帮助；)</p></div></div>    
</body>
</html>