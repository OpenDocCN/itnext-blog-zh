<html>
<head>
<title>Deploying Cassandra in Kubernetes with Casskop</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">和卡斯科普一起在库贝内特斯部署卡珊德拉</h1>
<blockquote>原文：<a href="https://itnext.io/deploying-cassandra-in-kubernetes-with-casskop-98956edfe32b?source=collection_archive---------2-----------------------#2019-08-04">https://itnext.io/deploying-cassandra-in-kubernetes-with-casskop-98956edfe32b?source=collection_archive---------2-----------------------#2019-08-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/320db31ef7e6bd443fec4ee83b50818a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ea5ZtrKBydLA14RzW9GT7w.jpeg"/></div></div></figure><p id="8151" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">CassKop是Cassandra的Kubernetes操作员。它可以创建、配置和管理运行在Kubernetes上的Cassandra集群。卡斯科普有很多有趣的特点。其中一个特性是数据中心和机架感知部署，这是本文的重点。</p><p id="ab93" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">CassKop引入了一个新的自定义资源定义<code class="fe kx ky kz la b">CassandraCluster</code>，它允许您指定一些东西，比如:</p><ul class=""><li id="4978" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv lg lh li lj bi translated">CPU和内存资源</li><li id="287d" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated"><a class="ae kw" href="https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity" rel="noopener ugc nofollow" target="_blank">节点反亲和</a></li><li id="f249" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated">资源限制</li><li id="216d" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated">存储类</li><li id="300b" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated">拓扑(就数据中心和机架配置而言)</li></ul><p id="d497" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这篇文章探讨了如何配置一些不同的Cassandra集群拓扑。</p><h1 id="c49f" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">安装CassKop</h1><p id="db9e" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">卡斯科普可作为<a class="ae kw" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank">舵</a>图。Helm是部署操作员的最简单方法。设置Helm超出了这篇文章的范围；因此，我将简单地向您介绍<a class="ae kw" href="https://helm.sh/docs/using_helm/#installing-helm" rel="noopener ugc nofollow" target="_blank">用户指南</a>中有关其安装的详细信息。请务必同时查看<a class="ae kw" href="https://helm.sh/docs/using_helm/#role-based-access-control" rel="noopener ugc nofollow" target="_blank">为舵柄设置RBAC</a>。</p><p id="c2eb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最新的操舵图可以在GitHub的CassKop库中找到。首先要做的是添加存储库:</p><pre class="ms mt mu mv gt mw la mx my aw mz bi"><span id="ed5a" class="na lq iq la b gy nb nc l nd ne">$ helm repo add casskop <a class="ae kw" href="https://Orange-OpenSource.github.io/cassandra-k8s-operator/helm" rel="noopener ugc nofollow" target="_blank">https://Orange-OpenSource.github.io/cassandra-k8s-operator/helm</a></span></pre><p id="96be" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后部署CassKop:</p><pre class="ms mt mu mv gt mw la mx my aw mz bi"><span id="6c48" class="na lq iq la b gy nb nc l nd ne">$ helm install --name casskop casskop/cassandra-operator<br/>NAME:   casskop<br/>LAST DEPLOYED: Tue Jul 30 21:13:51 2019<br/>NAMESPACE: default<br/>STATUS: DEPLOYEDRESOURCES:<br/>==&gt; v1/Deployment<br/>NAME                        READY  UP-TO-DATE  AVAILABLE  AGE<br/>casskop-cassandra-operator  0/1    1           0          1s==&gt; v1/Pod(related)<br/>NAME                                         READY  STATUS             RESTARTS  AGE<br/>casskop-cassandra-operator-79f77bb4c8-b4mf7  0/1    ContainerCreating  0         1s==&gt; v1/RoleBinding<br/>NAME                AGE<br/>cassandra-operator  1s==&gt; v1/ServiceAccount<br/>NAME                SECRETS  AGE<br/>cassandra-operator  1        1s==&gt; v1beta1/Role<br/>NAME                AGE<br/>cassandra-operator  1sNOTES:<br/>Congratulations. You have just deployed CassKop the Cassandra Operator.<br/>Check its status by running:<br/>kubectl --namespace default get pods -l "release=casskop"Visit <a class="ae kw" href="https://github.com/Orange-OpenSource/cassandra-k8s-operator" rel="noopener ugc nofollow" target="_blank">https://github.com/Orange-OpenSource/cassandra-k8s-operator</a> for instructions on hot to create &amp; configure Cassandra clusters using the operator.</span></pre><p id="686b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">继续之前，请确保操作员已成功部署:</p><pre class="ms mt mu mv gt mw la mx my aw mz bi"><span id="f5d5" class="na lq iq la b gy nb nc l nd ne">$ kubectl get pods -l name=cassandra-operator<br/>NAME                                          READY   STATUS    RESTARTS   AGE<br/>casskop-cassandra-operator-79f77bb4c8-b4mf7   1/1     Running   0          108s</span></pre><h1 id="3bab" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">部署简单集群</h1><p id="e25f" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">我们从最小的<code class="fe kx ky kz la b">CassandraCluster</code>开始，它没有定义任何数据中心或机架。</p><pre class="ms mt mu mv gt mw la mx my aw mz bi"><span id="7eb3" class="na lq iq la b gy nb nc l nd ne"># simple-cluster.yamlapiVersion: "db.orange.com/v1alpha1"<br/>kind: "CassandraCluster"<br/>metadata:<br/>  name: simple-cluster<br/>  labels:<br/>    cluster: simple-cluster<br/>spec:<br/>  <strong class="la ir">nodesPerRacks: 3</strong><br/>  resources:<br/>    requests:<br/>      cpu: 400m<br/>      memory: 1Gi<br/>    limits:<br/>      cpu: 400m<br/>      memory: 1Gi</span></pre><p id="ae05" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为既没有定义数据中心也没有定义机架，<code class="fe kx ky kz la b">nodesPerRacks</code>实际上指定了集群的大小。</p><p id="d338" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用以下内容创建集群:</p><pre class="ms mt mu mv gt mw la mx my aw mz bi"><span id="076f" class="na lq iq la b gy nb nc l nd ne">$ kubectl apply -f simple-cluster.yaml</span></pre><p id="b1c3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最终我们会看到三个豆荚组成了卡珊德拉星团。让我们查询一下pod:</p><pre class="ms mt mu mv gt mw la mx my aw mz bi"><span id="553e" class="na lq iq la b gy nb nc l nd ne">$ kubectl get pods  -l cassandracluster=simple-cluster<br/>NAME                         READY   STATUS    RESTARTS   AGE<br/>simple-cluster-dc1-rack1-0   1/1     Running   0          12h<br/>simple-cluster-dc1-rack1-1   1/1     Running   0          12h<br/>simple-cluster-dc1-rack1-2   1/1     Running   0          12h</span></pre><p id="8ac3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">注:</strong> CassKop增加了<code class="fe kx ky kz la b">cassandracluster</code>标签。</p><p id="8f08" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">卡斯科普并没有直接创造豆荚。这些豆荚是由卡斯科普创建的一个声明集管理的。</p><pre class="ms mt mu mv gt mw la mx my aw mz bi"><span id="81c2" class="na lq iq la b gy nb nc l nd ne">$ kubectl get statefulset -l cassandracluster=simple-cluster<br/>NAME                       DESIRED   CURRENT   AGE<br/>simple-cluster-dc1-rack1    3         3        12h</span></pre><p id="68a0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">状态集要求使用无头服务来负责pod的网络识别。让我们查询无头服务:</p><pre class="ms mt mu mv gt mw la mx my aw mz bi"><span id="03ad" class="na lq iq la b gy nb nc l nd ne">$ kubectl get svc -l cassandracluster=simple-cluster | awk {'print $1" " $2" "$3" "$4'} | column -t<br/>NAME                          TYPE       CLUSTER-IP  EXTERNAL-IP<br/>simple-cluster               ClusterIP  None        &lt;none&gt;<br/>simple-cluster-exporter-jmx  ClusterIP  None        &lt;none&gt;</span></pre><p id="16f9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们有我们的无头服务<code class="fe kx ky kz la b">simple-cluster</code>。另一个服务是<code class="fe kx ky kz la b">simple-cluster-exporter-jmx</code>，用于向普罗米修斯公开指标。</p><p id="ddc1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在让我们用<code class="fe kx ky kz la b">nodetool</code>检查Cassandra集群的状态:</p><pre class="ms mt mu mv gt mw la mx my aw mz bi"><span id="7e4b" class="na lq iq la b gy nb nc l nd ne">$ kubectl exec simple-cluster-dc1-rack1-0 -- nodetool status<br/>Datacenter: dc1<br/>===============<br/>Status=Up/Down<br/>|/ State=Normal/Leaving/Joining/Moving<br/>--  Address    Load       Tokens       Owns (effective)  Rack<br/>UN  10.0.2.18  69.94 KiB  256          69.0%             rack1<br/>UN  10.0.5.6   87.38 KiB  256          65.0%             rack1<br/>UN  10.0.3.7   104.86 KiB  256         65.9%             rack1</span></pre><p id="2277" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">注意:</strong>为了提高可读性，已经从输出中删除了主机ID列。</p><p id="7a05" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所有三个Cassandra节点都处于<code class="fe kx ky kz la b">Up/Normal</code>状态。卡珊德拉集群此时已全面投入运行。通过最低限度的规范，我们能够启动并运行一个集群。</p><h1 id="4585" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">告密者</h1><p id="b666" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">我想简单说说在<code class="fe kx ky kz la b">cassandra.yaml</code>中配置了<code class="fe kx ky kz la b">endpoint_snitch</code>属性的飞贼。Cassandra开箱即用默认为<code class="fe kx ky kz la b">SimpleSnitch</code>。卡斯科普配置卡桑德拉节点使用<code class="fe kx ky kz la b">GossipingPropertyFileSnitch</code>。</p><h1 id="642c" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">多个机架</h1><p id="afc3" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">接下来，我们将看一个涉及多个机架的稍微复杂一点的示例:</p><pre class="ms mt mu mv gt mw la mx my aw mz bi"><span id="0548" class="na lq iq la b gy nb nc l nd ne"># racks-cluster.yamlapiVersion: "db.orange.com/v1alpha1"<br/>kind: "CassandraCluster"<br/>metadata:<br/>  name: racks-cluster<br/>spec:<br/>  nodesPerRacks: 2<br/>  resources:<br/>    requests:<br/>      cpu: 400m<br/>      memory: 1Gi<br/>    limits:<br/>      cpu: 400m<br/>      memory: 1Gi<br/>  <strong class="la ir">topology:<br/>    dc:<br/>      - name: dc1</strong><br/>        <strong class="la ir">rack:<br/>          - name: rack1<br/>          - name: rack2<br/>          - name: rack3</strong></span></pre><p id="b1a9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里我们第一次看到了<code class="fe kx ky kz la b">topology</code>属性。它声明了一个数据中心和三个机架。<code class="fe kx ky kz la b">topology</code>接受数据中心列表。每个数据中心接受一个机架列表。这个规格应该产生一个Cassandra集群，其中6个节点分布在三个机架上。</p><p id="dd23" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们查询一下pod:</p><pre class="ms mt mu mv gt mw la mx my aw mz bi"><span id="ae34" class="na lq iq la b gy nb nc l nd ne">$ kubectl get pods -l cassandracluster=racks-cluster<br/>NAME                        READY   STATUS    RESTARTS   AGE<br/>racks-cluster-dc1-rack1-0   1/1     Running   0          18m<br/>racks-cluster-dc1-rack1-1   1/1     Running   0          17m<br/>racks-cluster-dc1-rack2-0   1/1     Running   0          15m<br/>racks-cluster-dc1-rack2-1   1/1     Running   0          14m<br/>racks-cluster-dc1-rack3-0   1/1     Running   0          13m<br/>racks-cluster-dc1-rack3-1   1/1     Running   0          11m</span></pre><p id="bfea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们如预期的有六个豆荚。我之前提到过，CassKop创建了一个StatefulSet来管理pod。让我们查询StatefulSet:</p><pre class="ms mt mu mv gt mw la mx my aw mz bi"><span id="6c73" class="na lq iq la b gy nb nc l nd ne">$ kubectl get statefulset -l cassandracluster=racks-cluster<br/>NAME                      DESIRED   CURRENT   AGE<br/>racks-cluster-dc1-rack1   2         2         21m<br/>racks-cluster-dc1-rack2   2         2         18m<br/>racks-cluster-dc1-rack3   2         2         15m</span></pre><p id="c192" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这次我们有三个状态集。CassKop为每个机架创建一个状态集。</p><p id="20e9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们查询无头服务:</p><pre class="ms mt mu mv gt mw la mx my aw mz bi"><span id="675a" class="na lq iq la b gy nb nc l nd ne">$ kubectl get svc -l cassandracluster=racks-cluster | awk {'print $1" " $2" "$3" "$4'} | column -t<br/>NAME                          TYPE       CLUSTER-IP  EXTERNAL-IP<br/>racks-cluster               ClusterIP  None        &lt;none&gt;<br/>racks-cluster-exporter-jmx  ClusterIP  None        &lt;none&gt;</span></pre><p id="0b5a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">可以对多个状态集使用同一个无头服务。这正是卡斯科普所做的。</p><p id="e7c0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在让我们用<code class="fe kx ky kz la b">nodetool</code>检查Cassandra集群的状态:</p><pre class="ms mt mu mv gt mw la mx my aw mz bi"><span id="b119" class="na lq iq la b gy nb nc l nd ne">$ kubectl exec racks-cluster-dc1-rack1-0 -- nodetool status<br/>Datacenter: dc1<br/>===============<br/>Status=Up/Down<br/>|/ State=Normal/Leaving/Joining/Moving<br/>--  Address    Load       Tokens       Owns (effective)  Rack<br/>UN  10.0.2.19  87.34 KiB  256          30.5%             rack2<br/>UN  10.0.4.5   92.34 KiB  256          32.8%             rack1<br/>UN  10.0.0.6   81.63 KiB  256          31.9%             rack3<br/>UN  10.0.5.7   69.94 KiB  256          36.0%             rack1<br/>UN  10.0.3.8   87.38 KiB  256          33.9%             rack2<br/>UN  10.0.1.8   69.92 KiB  256          35.0%             rack3</span></pre><p id="613b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">注意:</strong>为了提高可读性，已经从输出中删除了主机ID列。</p><p id="14af" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所有六个Cassandra节点都处于<code class="fe kx ky kz la b">Up/Normal</code>状态，并如预期的那样分布在三个机架上。</p><h1 id="162e" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">多个数据中心</h1><p id="c4c1" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">最后，我们将看看多DC部署。</p><pre class="ms mt mu mv gt mw la mx my aw mz bi"><span id="af67" class="na lq iq la b gy nb nc l nd ne"># multidc-cluster.yamlapiVersion: "db.orange.com/v1alpha1"<br/>kind: "CassandraCluster"<br/>metadata:<br/>  name: multidc-cluster<br/>spec:<br/>  nodesPerRacks: 2<br/>  resources:<br/>    requests:<br/>      cpu: 400m<br/>      memory: 1Gi<br/>    limits:<br/>      cpu: 400m<br/>      memory: 1Gi<br/>  topology:<br/>    <strong class="la ir">dc:<br/>      - name: dc1<br/>        rack:<br/>          - name: rack1<br/>          - name: rack2<br/>          - name: rack3<br/>      - name: dc2<br/>        nodesPerRacks: 3<br/>        rack:<br/>          - name: rack1<br/>          - name: rack2</strong></span></pre><p id="2dfd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意，除了声明数据中心<code class="fe kx ky kz la b">dc1</code>和<code class="fe kx ky kz la b">dc2</code>之外，我们还为<code class="fe kx ky kz la b">dc2</code>设置了<code class="fe kx ky kz la b">nodesPerRacks</code>。CassKop强制数据中心内每个机架的节点数量保持不变。每个机架的节点数量可能因数据中心而异。每个数据中心的机架数量也可能不同。这为配置集群拓扑提供了很大的灵活性。</p><p id="e12f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个规范应该产生一个包含12个Cassandra节点的Cassandra集群。让我们查询一下pod:</p><pre class="ms mt mu mv gt mw la mx my aw mz bi"><span id="2b7b" class="na lq iq la b gy nb nc l nd ne">$ kubectl get pods -l cassandracluster=multidc-cluster | awk {'print $1" " $2" "$3'} | column -t<br/>NAME                         READY  STATUS<br/>multidc-cluster-dc1-rack1-0  1/1    Running<br/>multidc-cluster-dc1-rack1-1  1/1    Running<br/>multidc-cluster-dc1-rack2-0  1/1    Running<br/>multidc-cluster-dc1-rack2-1  1/1    Running<br/>multidc-cluster-dc1-rack3-0  1/1    Running<br/>multidc-cluster-dc1-rack3-1  1/1    Running<br/>multidc-cluster-dc2-rack1-0  1/1    Running<br/>multidc-cluster-dc2-rack1-1  1/1    Running<br/>multidc-cluster-dc2-rack1-2  1/1    Running<br/>multidc-cluster-dc2-rack2-0  1/1    Running<br/>multidc-cluster-dc2-rack2-1  1/1    Running<br/>multidc-cluster-dc2-rack2-2  1/1    Running</span></pre><p id="4c0b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们有12个豆荚。让我们查询状态集:</p><pre class="ms mt mu mv gt mw la mx my aw mz bi"><span id="ce3d" class="na lq iq la b gy nb nc l nd ne">$ kubectl get statefulset -l cassandracluster=multidc-cluster<br/>NAME                        DESIRED   CURRENT   AGE<br/>multidc-cluster-dc1-rack1   2         2         8h<br/>multidc-cluster-dc1-rack2   2         2         8h<br/>multidc-cluster-dc1-rack3   2         2         7h58m<br/>multidc-cluster-dc2-rack1   3         3         7h55m<br/>multidc-cluster-dc2-rack2   3         3         7h51m</span></pre><p id="502c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">正如所料，我们有五个状态设置，每个机架一个。</p><p id="323f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在让我们查询无头服务:</p><pre class="ms mt mu mv gt mw la mx my aw mz bi"><span id="25a8" class="na lq iq la b gy nb nc l nd ne">$ kubectl get svc -l cassandracluster=multidc-cluster | awk {'print $1" " $2" "$3" "$4'} | column -t<br/>NAME                          TYPE       CLUSTER-IP  EXTERNAL-IP<br/>multidc-cluster               ClusterIP  None        &lt;none&gt;<br/>multidc-cluster-exporter-jmx  ClusterIP  None        &lt;none&gt;</span></pre><p id="42eb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">希望现在很清楚，无论数据中心和机架的数量有多少，CassKop只创建一组无头服务。</p><p id="66d5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，让我们用<code class="fe kx ky kz la b">nodetool</code>检查Cassandra集群的状态:</p><pre class="ms mt mu mv gt mw la mx my aw mz bi"><span id="662c" class="na lq iq la b gy nb nc l nd ne">$ kubectl exec multidc-cluster-dc1-rack1-0 -- nodetool status<br/>Datacenter: dc1<br/>===============<br/>Status=Up/Down<br/>|/ State=Normal/Leaving/Joining/Moving<br/>--  Address    Load       Tokens       Owns (effective)  Rack<br/>UN  10.0.2.2   200.27 KiB  256          14.3%            rack2<br/>UN  10.0.4.6   299.47 KiB  256          14.4%            rack2<br/>UN  10.0.0.7   314.06 KiB  256          15.5%            rack3<br/>UN  10.0.5.9   294.07 KiB  256          15.0%            rack1<br/>UN  10.0.1.9   270.8 KiB   256          16.3%            rack3<br/>UN  10.0.3.10  289.84 KiB  256          15.6%            rack1<br/>Datacenter: dc2<br/>===============<br/>Status=Up/Down<br/>|/ State=Normal/Leaving/Joining/Moving<br/>--  Address    Load       Tokens       Owns (effective)  Rack<br/>UN  10.0.2.22  327.84 KiB  256          15.9%            rack1<br/>UN  10.0.4.7   233.92 KiB  256          14.9%            rack2<br/>UN  10.0.0.8   254.63 KiB  256          14.8%            rack2<br/>UN  10.0.5.10  243.91 KiB  256          15.7%            rack1<br/>UN  10.0.1.10  254.97 KiB  256          15.5%            rack2<br/>UN  10.0.3.11  309.45 KiB  256          15.9%            rack1</span></pre><p id="44e4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">注意:</strong>为了提高可读性，已经从输出中删除了主机ID列。</p><p id="68ec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们有12个Cassandra节点分布在两个数据中心。<code class="fe kx ky kz la b">dc1</code>有六个节点分布在三个机架上。<code class="fe kx ky kz la b">dc2</code>有六个节点分布在两个机架上。一切都检查过了！</p><h1 id="5bae" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">结论</h1><p id="ffe6" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">CassKop在配置Kubernetes中运行的Cassandra集群的拓扑时提供了很大的灵活性。数据中心是Cassandra的核心功能，CassKop通过使其创建的每个集群都能够感知数据中心来充分利用该功能。</p></div></div>    
</body>
</html>