<html>
<head>
<title>Pathfinding: Kubernetes Windows Nodes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">寻路:Kubernetes窗口节点</h1>
<blockquote>原文：<a href="https://itnext.io/pathfinding-kubernetes-windows-nodes-dca316a479eb?source=collection_archive---------4-----------------------#2019-02-22">https://itnext.io/pathfinding-kubernetes-windows-nodes-dca316a479eb?source=collection_archive---------4-----------------------#2019-02-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="96c5" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">向Kubernetes注入微软以及为什么不应该这么做的指南。</h2></div><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi kn"><img src="../Images/3396f30873700f8a70661fb4bec5c8a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HkNEavL1N_5IHv2wsvK9uA.jpeg"/></div></div><figcaption class="kz la gj gh gi lb lc bd b be z dk translated">是的，我们会试着说服这个操作系统执行我们的命令。</figcaption></figure><p id="3b90" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">我们都经历过。您的团队有一个运行在云中的良好的Kubernetes集群；当其他团队正在无缝地部署他们的服务和应用程序时，有人过来问了一个可怕的问题:</p><blockquote class="lz ma mb"><p id="a90c" class="ld le mc lf b lg lh jr li lj lk ju ll md ln lo lp me lr ls lt mf lv lw lx ly ij bi translated">嘿，我们能在我们的Kubernetes集群中部署一个Windows程序吗？</p></blockquote><p id="8449" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">你的大脑会立即形成太多的问题和尖刻的回答，无法有效地选择一个，所以你唯一能脱口而出的是:</p><blockquote class="lz ma mb"><p id="6487" class="ld le mc lf b lg lh jr li lj lk ju ll md ln lo lp me lr ls lt mf lv lw lx ly ij bi translated">为什么？</p></blockquote><p id="77a7" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">…但那是另一个故事的主题。您在这里是因为您对如何在Kubernetes集群中运行Windows worker节点感兴趣。所以让我们开始吧。</p><p id="14f4" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">注意:这是大量研究、实验和猜测的结果。这只不过是我的团队采取的方法的概述，在我们认为它是“生产就绪”之前，这个设置的几个方面需要改进。</p><h2 id="791c" class="mg mh iq bd mi mj mk dn ml mm mn dp mo lm mp mq mr lq ms mt mu lu mv mw mx my bi translated">环境</h2><p id="6c17" class="pw-post-body-paragraph ld le iq lf b lg mz jr li lj na ju ll lm nb lo lp lq nc ls lt lu nd lw lx ly ij bi translated">这个“指南”不会涵盖Kubernetes集群的Windows worker节点的一般设置，因为它只会涵盖我的团队通过<a class="ae ne" href="https://github.com/kubernetes/kops" rel="noopener ugc nofollow" target="_blank"> kops </a>在AWS上使用Windows和Kubernetes的经验。</p><h2 id="a694" class="mg mh iq bd mi mj mk dn ml mm mn dp mo lm mp mq mr lq ms mt mu lu mv mw mx my bi translated">目标</h2><p id="04c0" class="pw-post-body-paragraph ld le iq lf b lg mz jr li lj na ju ll lm nb lo lp lq nc ls lt lu nd lw lx ly ij bi translated">这个项目的基本目标是为我们的Windows worker节点定义一个AWS自动伸缩组，这样我们就可以将节点视为牲口，让AWS自动为我们提供新节点。</p><p id="dc2f" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">最终，我们希望通过kops的InstanceGroup资源类型来管理我们的Windows节点，这样我们就可以相对容易地执行滚动更新和升级。</p></div><div class="ab cl nf ng hu nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="ij ik il im in"><h1 id="e1e0" class="nm mh iq bd mi nn no np ml nq nr ns mo jw nt jx mr jz nu ka mu kc nv kd mx nw bi translated">第一步:单个Windows节点</h1><h2 id="ab1f" class="mg mh iq bd mi mj mk dn ml mm mn dp mo lm mp mq mr lq ms mt mu lu mv mw mx my bi translated">启动Windows EC2实例</h2><p id="117a" class="pw-post-body-paragraph ld le iq lf b lg mz jr li lj na ju ll lm nb lo lp lq nc ls lt lu nd lw lx ly ij bi translated">在让自动扩展组运行之前，我们需要首先让单个节点工作，作为概念验证。我们将使用<a class="ae ne" href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/kubernetes/joining-windows-workers" rel="noopener ugc nofollow" target="_blank">这个来自微软的关于将Windows节点加入Kubernetes集群的指南</a>作为基线。</p><p id="c440" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">请注意，根据该指南，我们有第一个警告:<em class="mc">我们只能将Windows节点加入到一个使用法兰绒作为容器网络插件的集群中。</em></p><p id="d428" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">所以第一步，如果你还没有一个，是在AWS中创建一个基本的沙盒Kubernetes集群，使用法兰绒作为网络解决方案。对于这个探索性的目的，集群的其他属性并不太重要。作为参考，我们有一个由一个主节点和一个工作节点组成的集群，这两个节点都使用CoreOS AMIs。</p><p id="b975" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">有了沙盒集群后，您需要在同一个VPC中启动一个Windows EC2实例，其配置与单个工作节点相同。最初，我们只是通过AWS网络界面来做这件事，但我们最终创建了一个小的平台配置，因为我们必须重复这个过程很多很多次。作为参考，要设置的关键配置值有:</p><ol class=""><li id="471b" class="nx ny iq lf b lg lh lj lk lm nz lq oa lu ob ly oc od oe of bi translated">我们使用的EC2 AMI是基于<strong class="lf ir">Windows _ Server-1809-English-Core-containers latest-2019 . 02 . 13</strong>(<code class="fe og oh oi oj b">ami-0fe3fb8879ef6147c</code>代表我们集群所在的<code class="fe og oh oi oj b">eu-west-3</code>)。我们选择此图像的原因是因为Windows版本与微软指南中使用的版本相匹配。</li><li id="e068" class="nx ny iq lf b lg ok lj ol lm om lq on lu oo ly oc od oe of bi translated">EC2实例要驻留的VPC和子网，只需确保它们与其他工作节点的配置相匹配。</li><li id="8fb7" class="nx ny iq lf b lg ok lj ol lm om lq on lu oo ly oc od oe of bi translated">自动分配公共IP地址，设置为启用，除非您想要将VPC连接到您的VPN。</li><li id="1ee5" class="nx ny iq lf b lg ok lj ol lm om lq on lu oo ly oc od oe of bi translated">我的角色，因为我们试图创建一个工作者节点，我们只需将它设置为与我们的集群的工作者节点相同，<code class="fe og oh oi oj b">nodes.${cluster_name}</code>。</li><li id="6846" class="nx ny iq lf b lg ok lj ol lm om lq on lu oo ly oc od oe of bi translated">安全组，推理同上，只是将其设置为用于集群节点的安全组，<code class="fe og oh oi oj b">nodes.${cluster_name}</code>。</li><li id="e007" class="nx ny iq lf b lg ok lj ol lm om lq on lu oo ly oc od oe of bi translated">密钥对，选择一个已经存储在本地计算机上的密钥对，或者创建一个新的密钥对并下载它。</li></ol><p id="f3b9" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">现在您可以启动您的Windows EC2实例了！不幸的是，现在您必须通过RDP与它交互，而不是任何类型的远程shell，为此，您必须等待几分钟，然后才能使用前面提到的密钥对从AWS解密管理员密码。准备就绪后，您将能够使用您首选的RDP客户端登录并启动Powershell会话。</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi op"><img src="../Images/8ea99ef1af1eedd9279ba34d2cc8bc25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iMy-zMLMt-OLaWeqU-A5gw.png"/></div></div><figcaption class="kz la gj gh gi lb lc bd b be z dk translated">啊，窗户的乐趣。🙄</figcaption></figure><h2 id="8dec" class="mg mh iq bd mi mj mk dn ml mm mn dp mo lm mp mq mr lq ms mt mu lu mv mw mx my bi translated">准备好你的系统</h2><p id="40a8" class="pw-post-body-paragraph ld le iq lf b lg mz jr li lj na ju ll lm nb lo lp lq nc ls lt lu nd lw lx ly ij bi translated">进入实例后的第一步是准备一些基本目录并设置一些环境变量。《微软指南》涵盖了这一点，因此我们只向您介绍这一点。</p><p id="558a" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">我们在本指南中创建的唯一附加目录是<code class="fe og oh oi oj b">C:/k/downloads</code>,在将各种Kubernetes资源的下载文件提取并安装到系统之前，我们会将它们存储在这里。</p><h2 id="0aad" class="mg mh iq bd mi mj mk dn ml mm mn dp mo lm mp mq mr lq ms mt mu lu mv mw mx my bi translated">安装Kubernetes资源</h2><p id="b214" class="pw-post-body-paragraph ld le iq lf b lg mz jr li lj na ju ll lm nb lo lp lq nc ls lt lu nd lw lx ly ij bi translated">现在您可以与机器交互了，是时候开始遵循微软的指示了，从安装用于Kubernetes基础设施的<code class="fe og oh oi oj b">windows/nanoserver</code>映像开始。请记住，提取与您的主机Windows操作系统版本相同的映像！</p><p id="4283" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">幸运的是，您可以跳过Docker的设置，因为所选的AMI已经安装了Docker并准备好了。</p><pre class="ko kp kq kr gt oq oj or os aw ot bi"><span id="d1ab" class="mg mh iq oj b gy ou ov l ow ox">docker pull mcr.microsoft.com/windows/nanoserver:1809<br/>docker tag mcr.microsoft.com/windows/nanoserver:1809 microsoft/nanoserver:latest</span></pre><p id="506a" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">一旦完成，下一步将是设置目录，该目录将包含Kubernetes所需的所有配置和服务。微软选择了<code class="fe og oh oi oj b">C:/k</code>，事实证明，<strong class="lf ir">坚持这个糟糕的命名决定</strong>很重要。是的，我们试着变得更好，我们试着把它改为<code class="fe og oh oi oj b">C:/kubernetes</code>，但是我们后来使用的许多脚本完全依赖于<code class="fe og oh oi oj b">C:/k</code>作为所有资源的基本目录。</p><p id="0ac5" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">此时，您的下一步是获得一个kube配置文件的副本，它将允许您的实例与集群进行对话。如果你跟随微软指南，你会注意到官方的解决方案<em class="mc">是将kubeconfig文件</em> <strong class="lf ir"> <em class="mc">从一个主节点复制到我们的新实例</em> </strong>。</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/17e339b8e0e13845c6a299f0eb115ce8.png" data-original-src="https://miro.medium.com/v2/resize:fit:594/format:webp/1*h0Il8esfCsZI78LwcUuw1A.png"/></div><figcaption class="kz la gj gh gi lb lc bd b be z dk translated">你是个大师哈利！</figcaption></figure><p id="97c6" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">这就出现了一个问题，因为您需要这自动发生。您的节点甚至无法连接到主节点，因为如果不先联系集群，它就不知道如何连接。</p><p id="d2c0" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">我们使用的解决方法是将kops下载到您的节点上，并使用它来导出kubeconfig文件。您的节点只需要知道kops状态存储的位置和集群的名称。幸运的是这是已知的，您可以使用<code class="fe og oh oi oj b">wget</code>在Powershell中下载文件！</p><pre class="ko kp kq kr gt oq oj or os aw ot bi"><span id="8cd0" class="mg mh iq oj b gy ou ov l ow ox">wget <a class="ae ne" href="https://github.com/kubernetes/kops/releases/download/1.11.0/kops-windows-amd64" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes/kops/releases/download/1.11.0/kops-windows-amd64</a> -OutFile c:/k/kops.exe</span></pre><p id="271e" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">一旦你有了kops可执行文件，运行<code class="fe og oh oi oj b">kops export kubecfg --state=s3://${kops_state_store_location} ${cluster_name}</code>就简单了！除了您的EC2实例角色没有给予您足够的权限来读取<code class="fe og oh oi oj b">export</code>命令所需的所有内容。将EC2角色实例从<code class="fe og oh oi oj b">nodes.${cluster_name}</code>更改为<code class="fe og oh oi oj b">master.${cluster_name}</code>是一个快速但肮脏的修复方法，它将允许您导出一个正常工作的kubeconfig文件。</p><p id="c097" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">下一步是下载Kubernetes节点二进制文件，其中将包含用于验证kubeconfig文件的<code class="fe og oh oi oj b">kubectl</code>。当您在shell上下载资源时，您也可以开始下载法兰绒资源。</p><pre class="ko kp kq kr gt oq oj or os aw ot bi"><span id="e99d" class="mg mh iq oj b gy ou ov l ow ox">wget <a class="ae ne" href="https://dl.k8s.io/v1.12.5/kubernetes-node-windows-amd64.tar.gz" rel="noopener ugc nofollow" target="_blank">https://dl.k8s.io/v1.12.5/kubernetes-node-windows-amd64.tar.gz</a> -OutFile c:/k/downloads/knode.tar.gz<br/>wget <a class="ae ne" href="https://github.com/Microsoft/SDN/archive/master.zip" rel="noopener ugc nofollow" target="_blank">https://github.com/Microsoft/SDN/archive/master.zip</a> -OutFile c:/k/downloads/flannel.zip</span></pre><p id="e23b" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated"><strong class="lf ir">有趣的事实:</strong> <em class="mc">如果您将下载调用打包到后台作业中，它在Powershell中下载文件的速度会明显加快。</em></p><p id="71d4" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">我不知道为什么上面的事实是真的，但它减少了实例花费在下载上的时间大约80%。我有一些假设，但我不会在这里深入探讨。要知道，对于这些“下载和安装/设置”作业，您可以用<code class="fe og oh oi oj b">Start-Job -ScriptBlock {code here}</code>包装它们，然后用<code class="fe og oh oi oj b">Get-Job | Wait-Job</code>等待它们全部完成。这将帮助您显著减少实例启动时间。</p><p id="fdd7" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">一旦Kubernetes二进制文件下载完成，我们只需要将它们移到我们的路径中。</p><pre class="ko kp kq kr gt oq oj or os aw ot bi"><span id="a169" class="mg mh iq oj b gy ou ov l ow ox">tar -xzvf c:/k/downloads/knode.tar.gz -C c:/k/downloads<br/>mv c:/k/downloads/kubernetes/node/bin/*.exe c:/k/</span></pre><p id="5934" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">最后，你只需要安装法兰绒。</p><pre class="ko kp kq kr gt oq oj or os aw ot bi"><span id="d3b1" class="mg mh iq oj b gy ou ov l ow ox">Expand-Archive c:/k/downloads/flannel.zip -DestinationPath c:/k/downloads/flannel<br/>mv c:/k/downloads/flannel/SDN-master/Kubernetes/flannel/l2bridge/* c:/k/</span></pre><h2 id="ae3d" class="mg mh iq bd mi mj mk dn ml mm mn dp mo lm mp mq mr lq ms mt mu lu mv mw mx my bi translated">配置Kubernetes资源</h2><p id="dcc0" class="pw-post-body-paragraph ld le iq lf b lg mz jr li lj na ju ll lm nb lo lp lq nc ls lt lu nd lw lx ly ij bi translated">现在您已经拥有了您需要的一切，您只需要收集由法兰绒提供的启动脚本的所有必要信息。您需要四条网络信息，您的实例的私有IP地址、Kubernetes集群CIDR范围、Kubernetes服务CIDR范围和Kubernetes DNS服务地址。我们的解决方案相当简单(回复:愚蠢，但工作),可能有一个更好的方法来收集信息，但在这里。</p><pre class="ko kp kq kr gt oq oj or os aw ot bi"><span id="25f9" class="mg mh iq oj b gy ou ov l ow ox"># Gather the node's IP address.<br/>$env:HostIP = (<br/>  Get-NetIPConfiguration |<br/>  Where-Object {<br/>    $_.IPv4DefaultGateway -ne $null -and<br/>    $_.NetAdapter.Status -ne "Disconnected"<br/>  }<br/>).IPv4Address.IPAddress</span><span id="693c" class="mg mh iq oj b gy oz ov l ow ox"># Gather Kubernetes cluster and service CIDRs.<br/>$env:KubeClusterCIDR = (<br/>  kubectl cluster-info dump |<br/>  Select-String -Pattern ("--cluster-cidr=\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/\d{1,2}") -AllMatches |<br/>  % { $_.Matches } | % { $_.Value } |<br/>  Select-String -Pattern("\d.*") -AllMatches |<br/>  % { $_.Matches } | % { $_.Value } |<br/>  Select-Object -Last 1<br/>)</span><span id="7dba" class="mg mh iq oj b gy oz ov l ow ox">$env:KubeServiceCIDR = (<br/>  kubectl cluster-info dump |<br/>  Select-String -Pattern ("--service-cluster-ip-range=\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/\d{1,2}") -AllMatches |<br/>  % { $_.Matches } | % { $_.Value } |<br/>  Select-String -Pattern("\d.*") -AllMatches |<br/>  % { $_.Matches } | % { $_.Value } |<br/>  Select-Object -Last 1<br/>)</span><span id="59d8" class="mg mh iq oj b gy oz ov l ow ox"># Gather Kuberenetes cluster DNS service cluster IP address.<br/>$env:KubeDNSServiceIP = (<br/>  kubectl describe svc -n kube-system kube-dns |<br/>  Select-String -Pattern ("IP:.*\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}") -AllMatches |<br/>  % { $_.Matches } | % { $_.Value } |<br/>  Select-String -Pattern("\d.*") -AllMatches |<br/>  % { $_.Matches } | % { $_.Value } |<br/>  Select-Object -Last 1<br/>)</span></pre><p id="42de" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">有了这些值，在尝试加入集群之前，您只需要再改变一个棋子。有一个<code class="fe og oh oi oj b">net-conf.json</code>文件，你需要把你的kube的集群CIDR范围，取代默认的<code class="fe og oh oi oj b">10.244.0.0/16</code>。我们只是简单地调用了<code class="fe og oh oi oj b">replace</code>。</p><pre class="ko kp kq kr gt oq oj or os aw ot bi"><span id="736f" class="mg mh iq oj b gy ou ov l ow ox">cp c:/k/net-conf.json c:/k/net-conf-template.json<br/>(Get-Content c:/k/net-conf-template.json).replace("10.244.0.0/16", $env:KubeClusterCIDR) | Set-Content c:/k/net-conf.json</span></pre><p id="2558" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">…这样，所有的配置都准备就绪了！是时候尝试加入您的集群了！</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div class="gh gi pa"><img src="../Images/d2cb66b95022e448c721c4f8528dc349.png" data-original-src="https://miro.medium.com/v2/resize:fit:624/1*KFAYbegPKPAte4_DB-13dA.gif"/></div><figcaption class="kz la gj gh gi lb lc bd b be z dk translated">要是我在这个项目中也这么开心就好了。</figcaption></figure><h2 id="97be" class="mg mh iq bd mi mj mk dn ml mm mn dp mo lm mp mq mr lq ms mt mu lu mv mw mx my bi translated">加入集群</h2><p id="9732" class="pw-post-body-paragraph ld le iq lf b lg mz jr li lj na ju ll lm nb lo lp lq nc ls lt lu nd lw lx ly ij bi translated">现在您已经准备好加入您的集群了，您只需要运行包含在法兰绒下载中的<code class="fe og oh oi oj b">start.ps1</code>脚本，将网络配置作为参数，够简单了吧？</p><p id="de0a" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated"><strong class="lf ir">没有</strong>。</p><p id="2a29" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">为了不让这个故事变成一场该死的冒险，我们将直接切入正题。这个<code class="fe og oh oi oj b">start.ps1</code>脚本有一些缺陷。我们没有使用提供的脚本，而是将我们自己的版本构建到我们正在整合的用户数据中。也许在将来微软会有一个版本来修复我们遇到的问题，但是现在我们会把它们列在这里。</p><ol class=""><li id="c688" class="nx ny iq lf b lg lh lj lk lm nz lq oa lu ob ly oc od oe of bi translated">作为userdata脚本的一部分运行时，位于此处<a class="ae ne" href="https://github.com/Microsoft/SDN/blob/aca9b0c05ace7630605fce907703e0ae589ce054/Kubernetes/flannel/l2bridge/start.ps1#L64" rel="noopener ugc nofollow" target="_blank">的<code class="fe og oh oi oj b">Start-BitsTransfer</code>调用一直失败。我们不确定原因，但简单地使用<code class="fe og oh oi oj b">wget</code>作为替代品就解决了这个问题。</a></li><li id="e3bf" class="nx ny iq lf b lg ok lj ol lm om lq on lu oo ly oc od oe of bi translated">位于的<a class="ae ne" href="https://github.com/Microsoft/SDN/blob/aca9b0c05ace7630605fce907703e0ae589ce054/Kubernetes/flannel/l2bridge/start.ps1#L91" rel="noopener ugc nofollow" target="_blank">处的<code class="fe og oh oi oj b">StartFlanneld</code>调用经常会失败并挂在“等待网络创建”处。这是微软的一个已知问题，这里用</a><a class="ae ne" href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/kubernetes/common-problems#after-launching-startps1-flanneld-is-stuck-in-waiting-for-the-network-to-be-created" rel="noopener ugc nofollow" target="_blank">表示</a>，他们的解决方案是“哈哈，再试一次”。我们的解决方案是，在我们看到<code class="fe og oh oi oj b">cbr0</code>网络之前，将它包裹在一个重试循环中，并且将kubelet注册行移动到我们尝试启动法兰绒之前，如果它没有完成，则在大约15秒后终止StartFlanneld作业。</li></ol><pre class="ko kp kq kr gt oq oj or os aw ot bi"><span id="748b" class="mg mh iq oj b gy ou ov l ow ox">...<br/>$hasCbr0Network = $false<br/>while(-not $hasCbr0Network) {<br/>  powershell $BaseDir/start-kubelet.ps1 -RegisterOnly<br/>  Start-Sleep (Get-Random -Minimum 0 -Maximum 5)<br/>  $job = Start-Job -ScriptBlock {<br/>    ipmo c:/k/helper.psm1<br/>    StartFlanneld -ipaddress $env:HostIP -NetworkName $NetworkName<br/>  }<br/>  $job | Wait-Job -Timeout 15<br/>  $job | Where-Object {$_.State -ne "Completed"} | Stop-Job<br/>  Start-Sleep 1<br/>  $hasCbr0Network = (Get-HnsNetwork | ? Name -eq "cbr0")<br/>}<br/>...</span></pre><p id="51b0" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">一旦这些更改到位，我们就能够一致地将新节点引入集群！重要的是要注意，节点可能会在集群中来回切换，因为它可能需要几次尝试才能满足法兰绒的要求。如果你想知道随机等待时间，它可能会被删除。这主要是一个实验，因为对于任何恒定的等待时间，我们都会得到不一致的结果。</p><p id="9e16" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">万岁。现在您应该有一个单独的Windows节点连接到您的Kubernetes集群了！现在是时候将其打包成一个更易于管理的解决方案了。</p></div><div class="ab cl nf ng hu nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="ij ik il im in"><h1 id="e589" class="nm mh iq bd mi nn no np ml nq nr ns mo jw nt jx mr jz nu ka mu kc nv kd mx nw bi translated">下一步是什么？Kops实例组</h1><p id="dbff" class="pw-post-body-paragraph ld le iq lf b lg mz jr li lj na ju ll lm nb lo lp lq nc ls lt lu nd lw lx ly ij bi translated">现在您已经有了userdata脚本，是时候为您的Windows节点创建一个kops管理的InstanceGroup资源了。不幸的是，kops没有覆盖它为InstanceGroup生成的用户数据，但是它有能力添加额外的用户数据。这适用于我们的情况，因为生成的用户数据都是基于shell的，无论如何都会被Powershell忽略。</p><p id="21ae" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">所以我们只需要将我们的用户数据脚本复制粘贴到我们的规范中，并用<code class="fe og oh oi oj b">&lt;powershell&gt;${userdata}&lt;/powershell&gt;</code>标签包装它，简单吗？</p><p id="e277" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated"><strong class="lf ir">没有</strong>。不幸的是，由于实例启动时我们有太多的事情要做，所以我们的用户数据实际上太长了！现在，我们可能已经能够缩小用户数据以使其低于限制，但是因为我们已经达到了限制，所以可以说，如果我们以后需要添加更多数据，我们可以很容易地再次达到限制。</p><p id="b95e" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">那么我们做了什么作为变通办法呢？我们最终将userdata脚本上传到S3，然后用两行代码替换了InstanceGroup中的额外userdata，一行用于下拉S3对象，另一行用于运行它。<em class="mc">不要忘记向实例策略添加适当的权限，以允许节点提取userdata脚本！</em></p><p id="f54f" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">一旦所有这些都完成了，您应该能够部署您的InstanceGroup，几分钟后，您会看到Windows节点连接到您的集群！</p><p id="5dad" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated"><em class="mc">最后</em>。</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div class="gh gi pb"><img src="../Images/d297972c6eeb121e889ad31c6fc2dffd.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/format:webp/1*dK3FeHXeIhJmDY7Wen-Yhw.png"/></div><figcaption class="kz la gj gh gi lb lc bd b be z dk translated">所有这些微软诡计的最终结果。</figcaption></figure></div><div class="ab cl nf ng hu nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="ij ik il im in"><h1 id="1ffe" class="nm mh iq bd mi nn no np ml nq nr ns mo jw nt jx mr jz nu ka mu kc nv kd mx nw bi translated">警告和未来工作</h1><p id="10f3" class="pw-post-body-paragraph ld le iq lf b lg mz jr li lj na ju ll lm nb lo lp lq nc ls lt lu nd lw lx ly ij bi translated">因此，在所有这些结束时，在它真正“生产就绪”之前，仍有相当多的工作要做。</p><ol class=""><li id="ba8f" class="nx ny iq lf b lg lh lj lk lm nz lq oa lu ob ly oc od oe of bi translated"><strong class="lf ir">未完全测试</strong>。推出一些节点后，我对系统进行了一些基本测试，添加了基于Windows的容器的部署和守护进程集。事情运行顺利，尽管提取容器图像本身似乎很慢。</li><li id="2466" class="nx ny iq lf b lg ok lj ol lm om lq on lu oo ly oc od oe of bi translated"><strong class="lf ir">只有半管理的</strong>。如果您更改了Kubernetes版本之类的变量，您还需要更新S3的userdata Powershell脚本。如果有办法在kops中将变量注入到userdata模板中就好了。</li><li id="dc92" class="nx ny iq lf b lg ok lj ol lm om lq on lu oo ly oc od oe of bi translated"><strong class="lf ir">滚动更新</strong>。kops不会检测到用户数据脚本的变化，您需要在Windows节点实例组上强制任何滚动更新。</li><li id="8529" class="nx ny iq lf b lg ok lj ol lm om lq on lu oo ly oc od oe of bi translated"><strong class="lf ir">节点权限。</strong>由于我们必须为Windows节点提供额外的权限，以便它们可以使用kops导出kube配置文件，因此它们拥有的权限比实际需要的多。</li><li id="2cd1" class="nx ny iq lf b lg ok lj ol lm om lq on lu oo ly oc od oe of bi translated"><strong class="lf ir">能见度</strong>。根据我的经验，这是Windows平台的一个主要问题。不仅当你试图获取Windows机器上的日志时感觉像拔牙，而且我们还有被锁定在kops管理的Windows节点之外的问题。kops似乎创建了自己的密钥对，因为我们在创建沙盒集群时没有指定密钥对，这是有问题的，因为我们没有解密Windows密码的密钥。😬</li></ol></div><div class="ab cl nf ng hu nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="ij ik il im in"><h1 id="6d71" class="nm mh iq bd mi nn no np ml nq nr ns mo jw nt jx mr jz nu ka mu kc nv kd mx nw bi translated">最后的想法</h1><p id="e0d9" class="pw-post-body-paragraph ld le iq lf b lg mz jr li lj na ju ll lm nb lo lp lq nc ls lt lu nd lw lx ly ij bi translated">经过这一切，我认为你应该只依赖Windows节点<em class="mc">,如果你的软件绝对需要它，并且所有打破这一要求的尝试都得到了公平的审判。然而，这也不全是坏事，至少下次有人问你:</em></p><blockquote class="lz ma mb"><p id="1b4c" class="ld le mc lf b lg lh jr li lj lk ju ll md ln lo lp me lr ls lt mf lv lw lx ly ij bi translated">嘿，我们能在我们的Kubernetes集群中部署一个Windows程序吗？</p></blockquote><p id="4fa8" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">您可以回答:</p><blockquote class="lz ma mb"><p id="870e" class="ld le mc lf b lg lh jr li lj lk ju ll md ln lo lp me lr ls lt mf lv lw lx ly ij bi translated">是的，但是为什么呢？</p></blockquote></div></div>    
</body>
</html>