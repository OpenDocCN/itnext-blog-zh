<html>
<head>
<title>Telegram bot in Go: charts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">围棋电报机器人:图表</h1>
<blockquote>原文：<a href="https://itnext.io/telegram-bot-in-go-charts-2226265b04cc?source=collection_archive---------2-----------------------#2019-06-06">https://itnext.io/telegram-bot-in-go-charts-2226265b04cc?source=collection_archive---------2-----------------------#2019-06-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/922d2b3574b5a7648170b1ebd26533de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GE0Ku3x55KfG5yMz.jpg"/></div></div></figure><p id="684f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">自从我写了关于我正在建造的机器人的文章以来，已经有很长时间了。生活发生了。很多。现在，当事情安定下来，我可能又有时间和精力来编写更多的机器人程序，并在这个过程中写一些东西。</p><p id="2319" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上次机器人学了一些<a class="ae kw" href="https://medium.com/@detunized/telegram-bot-in-go-speak-robot-16c54d655455" rel="noopener">文本命令</a>。现在是时候画一些漂亮的画了。今天我想添加几个图表命令。</p><p id="61da" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用Telegram API可以发送图像(以及视频或任何其他文档)，它不仅限于文本消息。我所需要的是一种生成图像并把它发送出去的方法。快速搜索后，我偶然发现了<a class="ae kw" href="https://github.com/wcharczuk/go-chart" rel="noopener ugc nofollow" target="_blank">围棋图</a>。将图表渲染成内存中的PNG和SVG文件，这正是我所需要的。这里有一个例子:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lb"><img src="../Images/cf65942954b9d7c2cee9a6208a4560d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HoFbIL8_HgcjV9rj.png"/></div></div></figure><p id="a776" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不过，我对可视化股票价格不太感兴趣。我有自己的数据要处理。第一步是画一些简单的东西。上次我添加了显示10个最常记录的事件的<code class="fe kx ky kz la b">/top</code>命令。如果能以条形图的形式看到，那就更好了。有请<code class="fe kx ky kz la b">/topChart</code>号指挥。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lg"><img src="../Images/6dcbe69452dbdc0f2e9ffc5f1b0cb1f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*u-0YNPoxrmAwHmCi.png"/></div></div></figure><p id="a51c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这样的图表看起来有点太小太丑了，但是一旦你点击它们，它们就会放大。这个图表的代码非常简单:</p><pre class="lc ld le lf gt lh la li lj aw lk bi"><span id="d08e" class="ll lm iq la b gy ln lo l lp lq">func (c context) topChart(args string) {<br/>    num := parseTopArgs(args)<br/><br/>    // Get values from the DB and convert<br/>    values := make([]chart.Value, 0, num)<br/>    for _, e := range c.getTopEvents(num) {<br/>        values = append(<br/>            values,<br/>            chart.Value{Label: e.name, Value: float64(e.count)},<br/>        )<br/>    }<br/><br/>    // Chart settings<br/>    response := chart.BarChart{<br/>        Title:      fmt.Sprintf("Top %d events", num),<br/>        TitleStyle: chart.StyleShow(),<br/>        Background: chart.Style{<br/>            Padding: chart.Box{<br/>                Top: 40,<br/>            },<br/>        },<br/>        Width:    num * 100,<br/>        Height:   512,<br/>        BarWidth: 80,<br/>        XAxis:    chart.StyleShow(),<br/>        YAxis: chart.YAxis{<br/>            Style:          chart.StyleShow(),<br/>            ValueFormatter: chart.IntValueFormatter,<br/>            Range: &amp;chart.ContinuousRange{<br/>                Min: 0,<br/>                Max: values[0].Value,<br/>            },<br/>        },<br/>        Bars: values,<br/>    }<br/><br/>    // Render and send<br/>    c.sendChart(response)<br/>}</span></pre><p id="0598" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了获得这些值，我使用了以下查询:</p><pre class="lc ld le lf gt lh la li lj aw lk bi"><span id="0516" class="ll lm iq la b gy ln lo l lp lq">SELECT name, COUNT(name) freq FROM events<br/>    WHERE user = ?<br/>    GROUP BY name<br/>    ORDER BY freq DESC<br/>    LIMIT 10</span></pre><p id="6adb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并且用<code class="fe kx ky kz la b">go-chart</code>渲染购物车是微不足道的</p><pre class="lc ld le lf gt lh la li lj aw lk bi"><span id="3fb4" class="ll lm iq la b gy ln lo l lp lq">buffer := &amp;bytes.Buffer{}<br/>err := chartSettings.Render(chart.PNG, buffer)</span></pre><p id="3e77" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在,<code class="fe kx ky kz la b">buffer</code>保存了PNG文件的字节。它可以保存到磁盘或通过Telegram API发送，如下所示:</p><pre class="lc ld le lf gt lh la li lj aw lk bi"><span id="5d6b" class="ll lm iq la b gy ln lo l lp lq">image := tgbotapi.FileBytes{Name: "chart.png", Bytes: buffer.Bytes()}<br/>_, err := c.bot.Send(tgbotapi.NewPhotoUpload(c.message.Chat.ID, image))</span></pre><p id="3d71" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">很简单。</p><p id="454b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">另一个想法是使用条形图显示特定事件的每日活动，如下所示:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lr"><img src="../Images/5a0bffc8448f6d655743554af75a14df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*usrCy0tXfIQ7quHI.png"/></div></div></figure><p id="64a9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">近看是这样的:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ls"><img src="../Images/c1c9d115a43bbc6c6b187b0120be98e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ip4HSoTYq8FapKSG.png"/></div></div></figure><p id="758c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我认为非常酷的是为选定的事件绘制类似于GitHub活动的图表。在GitHub上看起来是这样的:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lt"><img src="../Images/08dd1959186eb87d1d0ede45a92f3e83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Nev8uBrQtRnVSy1G.png"/></div></div></figure><p id="f979" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">容易吗？不完全是。我花了很多时间试图复制它。我一开始试着给自己省点麻烦，用堆叠条形图，但是没用。于是我只好从头开始，卷起袖子自己干。大约五百行之后，我得到了这个:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lu"><img src="../Images/9cb2b4fb5df032dceb137e6e2d69b75b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jJwNy9sA9dqBxRqW.png"/></div></div></figure><p id="61ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">足够满足我的需求了。这篇文章包含了相当多的代码。也许我会另发一篇帖子，描述使用<code class="fe kx ky kz la b">go-chart</code>绘制图表的过程。这是可行的。问题是测试。特别是如果你想支持各种不同的选项，比如可配置的轴标签、图例、标题、字体大小等等。挺繁琐的。我声明:<strong class="ka ir">在我的机器上工作！</strong>发货！</p><h2 id="104f" class="ll lm iq bd lv lw lx dn ly lz ma dp mb kj mc md me kn mf mg mh kr mi mj mk ml bi translated">下一步是什么</h2><p id="7ca6" class="pw-post-body-paragraph jy jz iq ka b kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">这个机器人似乎拥有所有的基本特征。当然，它们不是很坚固，也不是很完美，但是它们还可以工作。是时候开始用了。我需要想办法把它部署到某个地方并让它运行起来。DevOps的东西。我想知道我是否需要一个Kubernetes集群。</p><p id="8839" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你好奇，可以在GitHub 上找到代码<a class="ae kw" href="https://github.com/detunized/since-bot/tree/day-6" rel="noopener ugc nofollow" target="_blank">。这个版本被标记为<code class="fe kx ky kz la b">day-6</code>。</a></p></div><div class="ab cl mr ms hu mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="ij ik il im in"><p id="e756" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="my">原载于2019年6月6日【detunized.net】<a class="ae kw" href="https://detunized.net/posts/2019-06-06-telegram-bot-in-go-charts/" rel="noopener ugc nofollow" target="_blank"><em class="my"/></a><em class="my">。在</em><a class="ae kw" href="https://twitter.com/detunized_net" rel="noopener ugc nofollow" target="_blank"><em class="my">Twitter</em></a><em class="my">或</em><a class="ae kw" href="https://www.linkedin.com/in/dmitryyakimenko" rel="noopener ugc nofollow" target="_blank"><em class="my">LinkedIn</em></a><em class="my">上关注我。</em></em></p></div></div>    
</body>
</html>