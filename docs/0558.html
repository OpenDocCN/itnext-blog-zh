<html>
<head>
<title>The most common mistake of writing API requests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">编写API请求最常见的错误</h1>
<blockquote>原文：<a href="https://itnext.io/the-most-common-mistake-of-writing-api-requests-4eda46dce03d?source=collection_archive---------1-----------------------#2018-04-01">https://itnext.io/the-most-common-mistake-of-writing-api-requests-4eda46dce03d?source=collection_archive---------1-----------------------#2018-04-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/bcf9365fda0aa91bd7c50b7328373d5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3CmYl1uiZF4XMNfBlKoFuA.png"/></div></div></figure><p id="2871" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">大家好！今天我将再次谈论API请求组织，并且我将提出一点建议</p><p id="92eb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">大多数被认为是“最佳实践”的指南甚至框架文档都告诉我们要遵循以下方法</p><p id="f51e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你在Vue.js和Vuex上，你可能经常会看到这样的smth:</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi kw"><img src="../Images/aa6151d4a15424203e71aa98ac6f0b69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nFAcH5pDZH_WVfhKxERnaw.png"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">官方示例来自<a class="ae lf" href="https://vuex.vuejs.org/en/actions.html#dispatching-actions" rel="noopener ugc nofollow" target="_blank"> <strong class="bd lg"> Vuex文档</strong> </a></figcaption></figure><p id="3721" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您在React和Redux上，您会看到更多的变体，但您通常只会看到以下内容的包装:</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lh"><img src="../Images/d3532199ecd876514844c0d5f0c720a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YPpEPKbJC3J6OTamjMO5ZA.png"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">官方示例来自<a class="ae lf" href="https://redux.js.org/advanced/async-actions#actions.js-(with-fetch)" rel="noopener ugc nofollow" target="_blank"> <strong class="bd lg"> Redux docs </strong> </a></figcaption></figure><p id="4405" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我敢打赌，你的大多数Vuex/Redux动作只是做API请求，然后更新状态。不是吗？</p><p id="a2e4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是..如果我说只是<strong class="ka ir">错</strong>呢？<em class="li">*有人马上关闭帖子* </em></p><h1 id="7634" class="lj lk iq bd lg ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">那么，什么是错的？</h1><p id="9470" class="pw-post-body-paragraph jy jz iq ka b kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr mk kt ku kv ij bi translated">我将跳过创建仅包装API请求的愚蠢动作的争论。这是一个样板代码，但这不是一个大问题。</p><p id="047b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里只有一个非常错误的时刻。</p><blockquote class="ml mm mn"><p id="6002" class="jy jz li ka b kb kc kd ke kf kg kh ki mo kk kl km mp ko kp kq mq ks kt ku kv ij bi translated">Redux/Vuex(在适用的地方加下划线)是一个<strong class="ka ir">状态</strong>管理，<strong class="ka ir">不是API </strong>。它应该只关心数据及其变化，但也处理API请求</p></blockquote><p id="27d2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">想象一下，我们有一些存储模块，我们应该保持正确的状态。我们有一些API为我们做一部分工作(添加客户端令牌，处理结果等)。</p><p id="424d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我将使用Vuex作为代码示例。因此，我们将创建执行API请求的动作，然后更新我们的状态</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mr"><img src="../Images/7f50473333acf4cdb9ed2ec9b7bdb7af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BYKFrhPsU8e_nHcR37-0mg.png"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">典型的商店模块。不是吗？</figcaption></figure><p id="d530" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，我们只需调用我们的行动，并感觉良好</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c25f1faf4081f31a0c83561caddaa41f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ADcFWEGw2xUXSEaIRUtbwQ.png"/></div></div></figure><p id="2487" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是如果我做了呢..这个？..</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/a8b9eeeeff6cdd3250ece5f75e515405.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8DEfN9RNNFHP5ZliQoY1Og.png"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">不对不对！！！</figcaption></figure><p id="ecb9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，状态中没有更新。商店操作日志中没有信息。它刚刚发生，你的应用程序不知道。不管你使用什么工具，这只是一个最常见的架构错误。</p><p id="aa33" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您认为<em class="li">文档只提供了显示%technology_name%如何工作的基本示例</em>，请尝试找到其他示例。</p><h1 id="5c29" class="lj lk iq bd lg ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">什么是替代方案？</h1><p id="c01d" class="pw-post-body-paragraph jy jz iq ka b kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr mk kt ku kv ij bi translated">我的观点是—</p><blockquote class="mt"><p id="264a" class="mu mv iq bd mw mx my mz na nb nc kv dk translated">如果你有一些API总是必须在请求后做一些事情，那么它应该由API方法来完成，而不是由它的包装器或其他应用程序部件来完成</p></blockquote><p id="ffef" class="pw-post-body-paragraph jy jz iq ka b kb nd kd ke kf ne kh ki kj nf kl km kn ng kp kq kr nh kt ku kv ij bi translated">这就是为什么我们需要API层的原因。</p><p id="46fd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">到目前为止，我发表了一篇关于我的新图书馆——API case的文章。它解决了这个问题，你不需要<em class="li">创造自己的自行车</em>。你可以在这里阅读更多关于Apicase的内容:</p><div class="ni nj gp gr nk nl"><a rel="noopener  ugc nofollow" target="_blank" href="/how-not-to-suffer-with-apis-8aa75f890fe6"><div class="nm ab fo"><div class="nn ab no cl cj np"><h2 class="bd ir gy z fp nq fr fs nr fu fw ip bi translated">如何不受API的困扰</h2><div class="ns l"><h3 class="bd b gy z fp nq fr fs nr fu fw dk translated">重新思考Apicase和为什么我仍然没有使用axios</h3></div><div class="nt l"><p class="bd b dl z fp nq fr fs nr fu fw dk translated">itnext.io</p></div></div><div class="nu l"><div class="nv l nw nx ny nu nz jw nl"/></div></div></a></div><p id="b1ca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我不想在这里深究Apicase，但我认为这是解释和展示我的想法的最佳方式。</p><p id="343c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">想法是写依赖于API请求<strong class="ka ir">的逻辑在这些请求</strong>里面。在Apicase中，可以和events + meta一起使用。元在请求中通过有效负载传递。在请求开始/进展/完成/失败等时调用事件。</p><p id="9439" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以，<em class="li">存储动作</em> <strong class="ka ir">不应该</strong>调用<em class="li"> API请求</em>，而是<em class="li"> API请求</em> <strong class="ka ir">应该</strong>调用存储动作<em class="li"/>。</p><p id="0863" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我将基于Vue.js编写例子，因为它是我最喜欢的前端框架。所以，让我们写一些猴子代码，然后我们会尽量使它更简单。</p><h2 id="d5bd" class="oa lk iq bd lg ob oc dn lo od oe dp ls kj of og lw kn oh oi ma kr oj ok me ol bi translated">第一步。提交存储</h2><p id="20df" class="pw-post-body-paragraph jy jz iq ka b kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr mk kt ku kv ij bi translated">Apicase有两个很好的特性可以轻松实现这个想法:</p><ul class=""><li id="6923" class="om on iq ka b kb kc kf kg kj oo kn op kr oq kv or os ot ou bi translated">接受请求的事件<code class="fe ov ow ox oy b">context</code></li><li id="05f6" class="om on iq ka b kb oz kf pa kj pb kn pc kr pd kv or os ot ou bi translated">Context有<code class="fe ov ow ox oy b">meta</code>选项，你可以传递任何你想要的东西，这样它就可以在事件中使用</li></ul><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/af026032d0d1a3bade1837fc5d5ea643.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D9OLl2j0HxoBnM7nAMIbkA.png"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated"><strong class="bd lg">完成</strong>事件的服务。如果我们有store —提交一些更改</figcaption></figure><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/200b451dce774a43740c94bb030f687a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yJXxI80mijMa2lNSX0AfhA.png"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">只需传递有效负载和存储请求</figcaption></figure><p id="4f35" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">看起来好多了，但还是不安全。我们可以只做请求而不存储。因此，如果没有存储通过，我们将抛出一个错误。</p><h2 id="133e" class="oa lk iq bd lg ob oc dn lo od oe dp ls kj of og lw kn oh oi ma kr oj ok me ol bi translated">第二步。添加一些检查</h2><p id="9be3" class="pw-post-body-paragraph jy jz iq ka b kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr mk kt ku kv ij bi translated">Apicase有两个特性:</p><ul class=""><li id="3307" class="om on iq ka b kb kc kf kg kj oo kn op kr oq kv or os ot ou bi translated">具有无限继承性的服务，允许你拆分和“堆叠”有效负载、元、钩子等。</li><li id="6e66" class="om on iq ka b kb oz kf pa kj pb kn pc kr pd kv or os ot ou bi translated">在请求之前/之后调用的中间件(称为“钩子”)，可以修改有效负载、改变响应状态、中止请求、重试请求等。</li></ul><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/847bb0bcc0bf2900e618db0d8642ed6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Th8hcCVdqq8GzR9E_bcofg.png"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">我觉得更安全，你呢？</figcaption></figure><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b800bed9029f778e811968af79e21863.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SiOmag1BpqwYIYWmOUp5FA.png"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">现在，如果没有经过存储，我们就不能进行请求</figcaption></figure><p id="021f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是它提供了大量的样板代码。我们将进入第3步！</p><h2 id="eca4" class="oa lk iq bd lg ob oc dn lo od oe dp ls kj of og lw kn oh oi ma kr oj ok me ol bi translated">第三步。减少样板文件</h2><p id="b1a5" class="pw-post-body-paragraph jy jz iq ka b kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr mk kt ku kv ij bi translated">因此，我们不想为此复制粘贴事件。我建议为此编写<em class="li">提交助手</em>:</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pe"><img src="../Images/0c4cf1c918d9ce2881dff310ec68a43c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QKS5-0D5NcJqwvxYDm40Xw.png"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">将它移出我们的API</figcaption></figure><p id="9da9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后我们可以减少一些样板代码:</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/8873b8b36211bbe54d73be4188a16e15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yb9Vj_yph2nnLmj3fo3kdg.png"/></div></div></figure><p id="456f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们也可以通过存储在树中:</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/77f168e2077341ad06a712519b5cea89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pVpnfZYgUq4it5lJ_Kd3Ow.png"/></div></div></figure><p id="1b6b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，商店中的更新是真正有保证的:</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="gh gi pf"><img src="../Images/b46441da44d7d928930cbfa289398aad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1256/format:webp/1*RWDLUd6tin8ZUO8hidhBrg.png"/></div></figure><h2 id="2232" class="oa lk iq bd lg ob oc dn lo od oe dp ls kj of og lw kn oh oi ma kr oj ok me ol bi translated">关于API层的说明</h2><p id="a37c" class="pw-post-body-paragraph jy jz iq ka b kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr mk kt ku kv ij bi translated">总之，我想说的是，向Apicase服务添加这样的特性可能会使您的API层与您的应用程序密不可分。如果你想在不同的应用中使用相同的API层，这里还有一个指南:</p><div class="ni nj gp gr nk nl"><a rel="noopener  ugc nofollow" target="_blank" href="/move-your-api-outside-your-application-b07ba6809412"><div class="nm ab fo"><div class="nn ab no cl cj np"><h2 class="bd ir gy z fp nq fr fs nr fu fw ip bi translated">将您的API移到应用程序之外</h2><div class="ns l"><h3 class="bd b gy z fp nq fr fs nr fu fw dk translated">修复我之前帖子的错误</h3></div><div class="nt l"><p class="bd b dl z fp nq fr fs nr fu fw dk translated">itnext.io</p></div></div><div class="nu l"><div class="pg l nw nx ny nu nz jw nl"/></div></div></a></div><p id="54c0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你对Apicase有有趣的想法或问题，你可以在回复中写或者在Twitter上提到@apicase。随意讨论；)</p><p id="391b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">文档:<a class="ae lf" href="https://kelin2025.gitbooks.io/apicase/" rel="noopener ugc nofollow" target="_blank">点此</a> <br/> Github回购:<a class="ae lf" href="http://github.com/apicase/core" rel="noopener ugc nofollow" target="_blank">点此</a> <br/>推特:<a class="ae lf" href="http://twitter.com/apicase" rel="noopener ugc nofollow" target="_blank">点此</a></p></div></div>    
</body>
</html>