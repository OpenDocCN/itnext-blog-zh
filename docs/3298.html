<html>
<head>
<title>What is: SAML — an overview, its structure, and requests tracing between a Jenkins and Okta SSO</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">什么是:SAML——概述，它的结构，以及Jenkins和Okta SSO之间的请求跟踪</h1>
<blockquote>原文：<a href="https://itnext.io/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso-811ef4b758d7?source=collection_archive---------4-----------------------#2019-11-17">https://itnext.io/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso-811ef4b758d7?source=collection_archive---------4-----------------------#2019-11-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/d39d0d81f627735ee3ca3be54a79a545.png" data-original-src="https://miro.medium.com/v2/resize:fit:260/format:webp/0*t7r_5zwkBKgnhzio.jpg"/></div></figure><p id="4856" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在为Jenkins配置SAML SSO的过程中，我遇到了一个问题，一些属性没有从Okta传递到Jenkins实例。</p><p id="2dd3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，在这篇文章中，我们将尝试弄清楚SAML的一般含义，简要概述它的架构和主要组件，并进行一些SAML请求跟踪/嗅探，以了解在使用SAML SSO的身份验证过程中到底传递了哪些数据。</p><p id="d23b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">由于有很多关于SAML的技术信息，我们将只仔细看看在Jenkins &lt;=&gt; Okta通信中使用的组件。</p><p id="1635" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">查看以下关于我们詹金斯-奥克塔整合的帖子:</p><ul class=""><li id="637d" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/jenkins-saml-authentication-via-okta-and-users-groups/" rel="noopener ugc nofollow" target="_blank">Jenkins:Okta SSO和用户组的SAML认证</a></li><li id="ea2a" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/jenkins-saml-okta-users-groups-and-role-based-security-plugin/" rel="noopener ugc nofollow" target="_blank"> Jenkins: SAML、Okta、用户组和基于角色的安全插件</a></li></ul><p id="e6db" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这篇文章中，我主要使用了2008年3月25日发布的安全断言标记语言(SAML) V2.0技术概述，所以这里可能会有一些不准确的地方，但总体上看起来是正确的(我希望如此)。</p><p id="1db3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">关于SAML的其他有用资料有:</p><ul class=""><li id="b76b" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated"><a class="ae lb" href="https://en.wikipedia.org/wiki/SAML_2.0" rel="noopener ugc nofollow" target="_blank"> SAML 2.0 </a></li><li id="284c" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://www.samltool.com/generic_sso_res.php" rel="noopener ugc nofollow" target="_blank"> SAML响应(IdP - &gt; SP) </a></li><li id="bb62" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://www.varonis.com/blog/what-is-saml/" rel="noopener ugc nofollow" target="_blank">什么是SAML，它是如何工作的？</a></li><li id="8ff5" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://auth0.com/blog/how-saml-authentication-works/#L4--Add-your-Service-Provider-metadata-to-the-Identity-Provider" rel="noopener ugc nofollow" target="_blank">SAML认证如何工作</a></li><li id="d399" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated">所有的SAML XML规范都可以在这里找到:<a class="ae lb" href="http://docs.oasis-open.org/security/saml/v2.0/" rel="noopener ugc nofollow" target="_blank">http://docs.oasis-open.org/security/saml/v2.0/</a></li></ul><p id="5b5b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="lh">因为这里有很多文字，最初是用俄语</em>  <em class="lh">写在这个博客里的</em><a class="ae lb" href="https://rtfm.co.ua/what-is-saml-obzor-struktura-i-trassirovka-zaprosov-na-primere-jenkins-i-okta-saml-sso/" rel="noopener ugc nofollow" target="_blank"><em class="lh">——我为这里的错误/印刷错误道歉。请随意填写，对它们以及下述过程中的任何错误发表评论。</em></a></p><ul class=""><li id="c18d" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#SAML_an_overview" rel="noopener ugc nofollow" target="_blank"> SAML:概述</a></li><li id="eb11" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#SAML_roles" rel="noopener ugc nofollow" target="_blank"> SAML角色</a></li><li id="8f48" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#SAML_Use_Cases" rel="noopener ugc nofollow" target="_blank"> SAML用例</a></li><li id="bee0" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#SAML_Participants" rel="noopener ugc nofollow" target="_blank"> SAML参与者</a></li><li id="85e5" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#Web_Single_Sign-On_Use_Case" rel="noopener ugc nofollow" target="_blank"> Web单点登录用例</a></li><li id="e796" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#IdP-initiated_Web_SSO" rel="noopener ugc nofollow" target="_blank"> IdP发起的Web SSO </a></li><li id="bcaa" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#SP-initiated_Web_SSO" rel="noopener ugc nofollow" target="_blank"> SP发起的Web单点登录</a></li><li id="d3f5" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#SAML_Architecture" rel="noopener ugc nofollow" target="_blank"> SAML架构</a></li><li id="c2e3" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#SAML_statement" rel="noopener ugc nofollow" target="_blank"> SAML语句</a></li><li id="201e" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#SAML_asserts" rel="noopener ugc nofollow" target="_blank"> SAML断言</a></li><li id="95cd" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated">SAML协议</li><li id="c0c0" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#SAML_bindings" rel="noopener ugc nofollow" target="_blank"> SAML绑定</a></li><li id="66f4" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#SAML_profiles" rel="noopener ugc nofollow" target="_blank"> SAML配置文件</a></li><li id="bfdc" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#SAML_Metadata" rel="noopener ugc nofollow" target="_blank"> SAML元数据</a></li><li id="3037" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#Authentication_context" rel="noopener ugc nofollow" target="_blank">认证上下文</a></li><li id="390f" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#SAML_XML_Constructs_and_Examples" rel="noopener ugc nofollow" target="_blank"> SAML XML结构和示例</a></li><li id="9b82" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#Relationship_of_SAML_Components" rel="noopener ugc nofollow" target="_blank">SAML组件的关系</a></li><li id="5cf5" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#saml-chrome-panel" rel="noopener ugc nofollow" target="_blank"> saml镀铬面板</a></li><li id="0101" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#The_Assertion_Subject_and_Statement_Structure" rel="noopener ugc nofollow" target="_blank">断言、主语和语句结构</a></li><li id="e9af" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#Attribute_Statement_Structure" rel="noopener ugc nofollow" target="_blank">属性语句结构</a></li><li id="5cab" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#SAML_Profiles" rel="noopener ugc nofollow" target="_blank"> SAML配置文件</a></li><li id="5f76" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#Web_Browser_SSO_Profile" rel="noopener ugc nofollow" target="_blank">网络浏览器单点登录配置文件</a></li><li id="e07d" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/#Jenkins_and_Okta_SP-Initiated_SSO_RedirectPOST_Binding" rel="noopener ugc nofollow" target="_blank"> Jenkins和Okta — SP发起的单点登录:重定向/后绑定</a></li></ul><h2 id="187f" class="li lj iq bd lk ll lm dn ln lo lp dp lq kf lr ls lt kj lu lv lw kn lx ly lz ma bi translated">SAML:概述</h2><p id="d68f" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">SAML单点登录认证至少包括两个主要方——一个<em class="lh">服务提供者(SP) </em>和一个<em class="lh">身份提供者(IdP) </em>，过程本身由<em class="lh">信任建立</em>过程和实际的认证过程组成。</p><p id="b1f0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，在我们的例子中，Jenkins实例将扮演<em class="lh">服务提供者</em>的角色，Okta将是<em class="lh">身份提供者</em>。</p><p id="d1ae" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">简而言之，身份验证流程有以下流程:</p><ol class=""><li id="04e0" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr mg ky kz la bi translated">用户在浏览器中打开Jenkins URL</li><li id="c7be" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr mg ky kz la bi translated">Jenkins将这个用户重定向到一个SSO URL，Okta</li><li id="4ca8" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr mg ky kz la bi translated">Okta对用户进行身份验证，并将信息发送回Jenkins</li><li id="9608" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr mg ky kz la bi translated">Jenkins执行授权检查，例如通过基于角色的安全插件和配置的角色</li></ol><p id="a2f1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了传递关于用户的数据，SAML使用一个<em class="lh">断言</em>对象，该对象包含所有必要的信息——用户用户名、其认证状态、组等，这取决于一个<em class="lh">断言</em>类型。</p><p id="77ec" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">哪些<em class="lh">断言</em>在特定情况下是必要的——SAML在其<em class="lh"> SAML协议</em>中定义(将在本文的<a class="ae lb" href="https://rtfm.co.ua/en/?p=22524#SAML_protocols" rel="noopener ugc nofollow" target="_blank"> <em class="lh"> SAML协议</em> </a>部分讨论)，SAML协议通过HTTP或SOAP传递，这在SAML <em class="lh">绑定</em>中定义(参见<a class="ae lb" href="https://rtfm.co.ua/en/?p=22524#SAML_bindings" rel="noopener ugc nofollow" target="_blank"> <em class="lh"> SAML绑定</em> </a> <em class="lh">部分</em>)。</p><p id="6ab3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">反过来，<em class="lh"> SAML协议</em>、<em class="lh">绑定</em>和使用过的<em class="lh">断言</em>被合并到<em class="lh">概要文件(</em>参见<a class="ae lb" href="https://rtfm.co.ua/?p=22481#SAML_profiles" rel="noopener ugc nofollow" target="_blank"> <em class="lh"> SAML概要文件</em> </a> <em class="lh"> ) </em>，例如——<em class="lh">Web浏览器SSO概要文件(</em>参见<a class="ae lb" href="https://rtfm.co.ua/en/?p=22524#Web_Browser_SSO_Profile" rel="noopener ugc nofollow" target="_blank"> <em class="lh"> Web浏览器SSO概要文件</em> </a> <em class="lh"> ) 【T41)，或者LDAP</em></p><h2 id="0dfd" class="li lj iq bd lk ll lm dn ln lo lp dp lq kf lr ls lt kj lu lv lw kn lx ly lz ma bi translated">SAML角色</h2><ul class=""><li id="5ff4" class="ks kt iq jw b jx mb kb mc kf mh kj mi kn mj kr kx ky kz la bi translated"><strong class="jw ir">身份提供者</strong> ( <em class="lh"> IdP </em>):生成关于主体的<em class="lh">断言</em>(带有认证数据的对象或文档)的系统。例如，它可以是一个用户，IdP为其生成一个断言，声明John Smith已成功通过身份验证，并且他具有诸如组和邮箱<br/> <em class="lh">身份提供者</em>也称为<em class="lh"> SAML授权方</em> и <em class="lh">断言方</em>。</li><li id="1b84" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><strong class="jw ir">服务提供者</strong> ( <em class="lh"> SP </em>):使用来自IdP的信息的系统。在此期间，<em class="lh">服务提供者</em>依赖于<em class="lh">断言</em>的认证数据，但仍然可以应用额外的本地策略来确定用户在该SP内部拥有哪些权限<br/> <em class="lh">服务提供者</em>也称为<em class="lh">依赖方</em>，因为它们<em class="lh">依赖于来自从<em class="lh">身份提供者</em> ( <em class="lh">断言方【T79】接收的断言的</em>信息</em></li></ul><h2 id="3520" class="li lj iq bd lk ll lm dn ln lo lp dp lq kf lr ls lt kj lu lv lw kn lx ly lz ma bi translated">SAML用例</h2><p id="da9e" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">在深入研究之前，让我们先简要概述一下SAML用例。</p><h2 id="3735" class="li lj iq bd lk ll lm dn ln lo lp dp lq kf lr ls lt kj lu lv lw kn lx ly lz ma bi translated">SAML参与者</h2><p id="1225" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">在SAML认证信息交换过程中，至少包括双方——一个<em class="lh"> SAML声明方</em>和一个<em class="lh"> SAML依赖方</em>。</p><p id="b128" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="lh"> SAML断言方</em> —创建<em class="lh"> SAML断言</em>的系统，以及相应的<em class="lh"> SAML依赖方</em> —使用那些断言的一方。</p><p id="399f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">当<em class="lh"> SAML声明方</em>或<em class="lh"> SAML依赖方</em>执行请求时，它成为<em class="lh"> SAML请求方</em>方，第二方成为<em class="lh"> SAML响应方</em>方。</p><p id="9c8c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在SAML身份验证过程中，流程中的参与者由SAML角色操作，这些角色描述SAML服务、SAML协议和要使用的断言类型。</p><p id="9921" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，对于SSO，SAML定义了SAML角色<em class="lh">身份提供者(IdP) </em>和<em class="lh">服务提供者(SP) </em>，如上所述。</p><p id="31ab" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">另一个例子可以是<em class="lh">属性权限</em>角色，当一方在响应另一方<em class="lh">属性请求者</em>的属性请求时生成一个断言。</p><p id="41e6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在大多数SAML <em class="lh">断言</em>中，有一个<em class="lh">主题</em>需要被认证。这样的主体可以是用户或者例如专用服务器。</p><p id="efd3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">通常，一个<em class="lh">断言</em>包含类似于“<em class="lh">这是John Smith，他有一个邮箱“john.smith@google.com”，并且他通过了密码认证机制</em>的认证。</p><p id="1cba" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">反过来，服务提供商将自己决定它需要哪些信息，并根据它自己的本地访问策略来授权或拒绝John的访问。</p><h2 id="b75e" class="li lj iq bd lk ll lm dn ln lo lp dp lq kf lr ls lt kj lu lv lw kn lx ly lz ma bi translated">Web单点登录用例</h2><p id="87a9" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">IdP启动的Web SSO</p><p id="51d9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">多域Web单点登录</strong> —最常用的SAM Web SSO用例之一。</p><p id="a56e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这种情况下，用户在某个网站上有一个登录会话(例如安全上下文)，例如<em class="lh">airline.example.com</em>。在某个时间点，用户会直接或间接地被重定向到合作伙伴的网站，比如说<em class="lh">cars.example.co.uk</em>，在本例中它扮演服务提供商的角色。一个IdP网站(本例中的<em class="lh">airline.example.com</em>为这个SP(【cars.example.co.uk】T42)创建一个断言，确认这个用户是已知的、经过身份验证的，并且有一组属性。</p><p id="5982" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因为SP<em class="lh">cars.example.co.uk</em>信任它的IdP<em class="lh">airline.example.com</em>——它为这个用户创建一个本地认证会话:</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/0681b74668857dce96162e7c6d78ef25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1100/format:webp/0*Amd6zqcdHX86c2vs.png"/></div></figure><p id="f2a7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用这种方法，用户首先在IdP上进行身份验证，然后才能访问SP上的受保护资源。</p><p id="28c0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这种方式被称为<strong class="jw ir"> <em class="lh"> IdP发起的Web SSO </em> </strong>。</p><p id="1f0e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">SP启动的Web单点登录</p><p id="b0e0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一个更广泛的使用案例是VIсe versa——当用户第一次访问服务提供商资源时，服务提供商资源将该用户重定向到IdP服务以对其进行身份验证。</p><p id="8b31" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">用户在IdP上执行身份验证步骤后，该IdP将创建一个断言，SP将使用该断言来检查用户在该SP上的权限。</p><p id="2818" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这种方式被称为<strong class="jw ir"> <em class="lh"> SP发起的Web单点登录</em> </strong>。</p><h2 id="d660" class="li lj iq bd lk ll lm dn ln lo lp dp lq kf lr ls lt kj lu lv lw kn lx ly lz ma bi translated">SAML架构</h2><p id="252a" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">SAML由一堆组装在一起的构建块“组成”,允许构建各种方式来使用SAML。</p><p id="5a1e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这些组件描述了用于传递身份数据、认证信息和用户属性的机制。</p><h2 id="03e8" class="li lj iq bd lk ll lm dn ln lo lp dp lq kf lr ls lt kj lu lv lw kn lx ly lz ma bi translated">SAML语句</h2><p id="0327" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">如前所述，在SAML认证过程中，使用了包含一组<em class="lh">语句</em>的<em class="lh">断言</em>，这些语句包含关于用户的信息。例如，一个资产可以包含一个关于用户的<em class="lh">姓名</em> " <em class="lh">约翰·史密斯</em>"的声明，以及另一个关于其电子邮件"<em class="lh">john.smith@google.com</em>"的声明，并且他的<em class="lh">组</em>是<em class="lh"> DevOps </em>。</p><p id="74bb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">SAML描述了三种主要的语句类型:</p><ul class=""><li id="3c77" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated"><em class="lh">认证语句</em>:由成功认证用户的一方创建(例如，由IdP角色中的Okta创建)</li><li id="3511" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><em class="lh">属性声明</em>:一组属性，例如用户的邮箱</li><li id="d9d7" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><em class="lh">授权决策语句</em>:一组授权规则，例如该用户允许的动作</li></ul><h2 id="6896" class="li lj iq bd lk ll lm dn ln lo lp dp lq kf lr ls lt kj lu lv lw kn lx ly lz ma bi translated">SAML断言</h2><p id="3b5f" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">SAML <em class="lh">断言</em>包含关于被认证对象的数据(上面讨论的<em class="lh">语句</em>)。一个断言包含一个断言的主体(例如，一个用户)、该断言有效的条件以及一组语句。</p><p id="bb25" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">SAML断言结构和字段在<a class="ae lb" href="https://docs.oasis-open.org/security/saml/v2.0/saml-schema-assertion-2.0.xsd" rel="noopener ugc nofollow" target="_blank"> SAML断言XML模式</a>中描述。</p><h2 id="8aba" class="li lj iq bd lk ll lm dn ln lo lp dp lq kf lr ls lt kj lu lv lw kn lx ly lz ma bi translated">SAML协议</h2><p id="a202" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">通常，断言是在收到SP请求的IdP端创建的。为了传递这些请求，使用SAML协议，该协议在<a class="ae lb" href="https://docs.oasis-open.org/security/saml/v2.0/saml-schema-protocol-2.0.xsd" rel="noopener ugc nofollow" target="_blank"> SAML定义的协议XML模式</a>中描述了这些消息的结构和内容。</p><p id="f686" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这些协议中的一些是<em class="lh">认证请求协议</em>、<em class="lh">单一注销协议</em>、<em class="lh">断言查询以及请求协议</em>等。</p><h2 id="e889" class="li lj iq bd lk ll lm dn ln lo lp dp lq kf lr ls lt kj lu lv lw kn lx ly lz ma bi translated">SAML绑定</h2><p id="9abd" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">通过HTTP或SOAP等底层网络协议传递这些消息的方式在<em class="lh"> SAML绑定</em>中设置。</p><p id="3ed7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">那些绑定是<em class="lh"> HTTP重定向绑定</em>、<em class="lh"> HTTP POST绑定</em>、<em class="lh"> HTTP工件绑定、</em>等。</p><p id="8c90" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下面我们将对<em class="lh"> HTTP重定向绑定</em>进行一个概述，它在Jenkins &lt; = &gt; Okta认证期间使用(参见本文的<a class="ae lb" href="https://rtfm.co.ua/?p=22481#SP-Initiated_SSO_RedirectPOST_Bindings" rel="noopener ugc nofollow" target="_blank"> SP发起的SSO:重定向/POST绑定</a>部分)。</p><h2 id="b361" class="li lj iq bd lk ll lm dn ln lo lp dp lq kf lr ls lt kj lu lv lw kn lx ly lz ma bi translated">SAML配置文件</h2><p id="1aae" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">最后是定义SAML用例的SAML概要文件，例如<a class="ae lb" href="https://rtfm.co.ua/?p=22481&amp;Web_Browser_SSO_Profile" rel="noopener ugc nofollow" target="_blank"> <em class="lh"> Web浏览器SSO概要文件</em> </a>。</p><p id="28c2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">概要文件描述了SAML断言、协议和绑定的内容，这些内容将一起用于解决特定的业务需求。</p><p id="151b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">还有<em class="lh">属性配置文件</em>，它与消息协议或绑定无关，但是描述了如何通过使用<em class="lh">断言</em>来交换关于属性的信息。</p><h2 id="da3b" class="li lj iq bd lk ll lm dn ln lo lp dp lq kf lr ls lt kj lu lv lw kn lx ly lz ma bi translated">SAML元数据</h2><p id="6688" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">元数据定义了在IdP和Sp之间分发配置信息的方式。例如，关于所使用的SAML绑定、参与者的角色(IdP、SP)、支持的属性、加密细节等，在它自己的<a class="ae lb" href="https://docs.oasis-open.org/security/saml/v2.0/saml-schema-metadata-2.0.xsd" rel="noopener ugc nofollow" target="_blank"> SAML元数据XML模式</a>中。</p><h2 id="1b45" class="li lj iq bd lk ll lm dn ln lo lp dp lq kf lr ls lt kj lu lv lw kn lx ly lz ma bi translated">认证上下文</h2><p id="c636" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">在某些情况下，服务提供商可能需要有关IdP端使用的身份验证类型的更详细信息。</p><p id="eb63" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这种情况下，使用一个<em class="lh"> SAML认证上下文</em>，它被添加到在它们之间传递的<em class="lh">断言</em>的<em class="lh">认证语句</em>中。</p><p id="1426" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">除此之外，在SAML请求生成期间，SP可以在其向IdP侧的请求中指定认证上下文，要求使用指定的特定机制来认证用户，例如，使用双因素认证来认证用户。</p><p id="13d8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所有这些都可以用下一个方案显示:</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/c4ce41cfb806f06aa38dc8e85bc62a5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:968/format:webp/0*fUVMCFuQJ8r_tiga.png"/></div></figure><h2 id="ff49" class="li lj iq bd lk ll lm dn ln lo lp dp lq kf lr ls lt kj lu lv lw kn lx ly lz ma bi translated">SAML XML结构和示例</h2><h2 id="0301" class="li lj iq bd lk ll lm dn ln lo lp dp lq kf lr ls lt kj lu lv lw kn lx ly lz ma bi translated">SAML组件的关系</h2><p id="af92" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">SAML asserts包含一个或多个<em class="lh">语句</em>，通过HTTP、SOAP或其他数据传输协议通过网络传递:</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/d699363ef2681f7a66d5df8c615803f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:480/0*ctw753gOtqiuXYyv.gif"/></div></figure><p id="8793" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">SAML-铬合金面板</p><p id="81f5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了进行SAML请求跟踪和解析，让我们使用Chrome的<code class="fe mr ms mt mu b"><a class="ae lb" href="https://github.com/milton-lai/saml-chrome-panel" rel="noopener ugc nofollow" target="_blank">saml-chrome-panel</a></code>扩展。</p><p id="9da2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">安装它，打开Chrome开发者工具，打开Jenkins选项卡，登录，让我们调查一下我们的Jenkins和Okta之间传输了哪些数据。</p><h2 id="35cb" class="li lj iq bd lk ll lm dn ln lo lp dp lq kf lr ls lt kj lu lv lw kn lx ly lz ma bi translated">断言、主题和语句结构</h2><p id="beb2" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">让我们仔细看看断言、主语及其语句:</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi mv"><img src="../Images/fa1fe56358281be927b9318ea1fcdd8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kuMruogSYIjOsM8o.png"/></div></div></figure><pre class="ml mm mn mo gt na mu nb nc aw nd bi"><span id="8dba" class="li lj iq mu b gy ne nf l ng nh">&lt;saml2:Assertion ID="id5145226399860569827675102" IssueInstant="2019-11-02T12:37:19.440Z"<br/>        Version="2.0" xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion"<br/>        xmlns:xs="http://www.w3.org/2001/XMLSchema"&gt;<br/>        &lt;saml2:Issuer Format="urn:oasis:names:tc:SAML:2.0:nameid-format:entity"<br/>            xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion"&gt;http://www.okta.com/exk1pgr3yktuVLp5a357&lt;/saml2:Issuer&gt;<br/>...<br/>       &lt;saml2:Subject xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion"&gt;<br/>            &lt;saml2:NameID Format="urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress"&gt;arseniy@example.com&lt;/saml2:NameID&gt;<br/>            &lt;saml2:SubjectConfirmation Method="urn:oasis:names:tc:SAML:2.0:cm:bearer"&gt;&lt;saml2:SubjectConfirmationData InResponseTo="_oyzxonwjrhnetdqqctfwbbfwmvgtrfa9jy1xu2o"<br/>                NotOnOrAfter="2019-11-02T12:42:19.440Z"<br/>                Recipient="https://ci.example.com/securityRealm/finishLogin"/&gt;&lt;/saml2:SubjectConfirmation&gt;<br/>        &lt;/saml2:Subject&gt;<br/>        &lt;saml2:Conditions NotBefore="2019-11-02T12:32:19.440Z" NotOnOrAfter="2019-11-02T12:42:19.440Z"<br/>            xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion"&gt;<br/>            &lt;saml2:AudienceRestriction&gt;<br/>                &lt;saml2:Audience&gt;https://ci.example.com/securityRealm/finishLogin&lt;/saml2:Audience&gt;<br/>            &lt;/saml2:AudienceRestriction&gt;<br/>        &lt;/saml2:Conditions&gt;<br/>        &lt;saml2:AuthnStatement AuthnInstant="2019-11-02T12:37:16.992Z"<br/>            SessionIndex="_oyzxonwjrhnetdqqctfwbbfwmvgtrfa9jy1xu2o"<br/>            xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion"&gt;<br/>            &lt;saml2:AuthnContext&gt;<br/>                &lt;saml2:AuthnContextClassRef&gt;urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport&lt;/saml2:AuthnContextClassRef&gt;<br/>            &lt;/saml2:AuthnContext&gt;<br/>        &lt;/saml2:AuthnStatement&gt;<br/>...</span></pre><p id="25bd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这个XML片段中，我们可以看到一个<em class="lh">断言</em>示例和一个<em class="lh">认证语句</em>:</p><ol class=""><li id="2509" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr mg ky kz la bi translated">在前缀为<code class="fe mr ms mt mu b">saml:</code>的第一行，声明了SAML <em class="lh">断言</em>(<code class="fe mr ms mt mu b">&lt;saml2:Assertion&gt;</code>)及其生成时间(<code class="fe mr ms mt mu b">&lt;IssueInstant&gt;</code>)</li><li id="2d0f" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr mg ky kz la bi translated">接下来，使用SAML版本— <code class="fe mr ms mt mu b">Version</code></li><li id="0372" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr mg ky kz la bi translated">创建此断言的IdP的唯一标识符— <code class="fe mr ms mt mu b">&lt;saml2:Issuer&gt;</code></li><li id="a5df" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr mg ky kz la bi translated">然后，在<code class="fe mr ms mt mu b">&lt;saml2:Subject&gt;</code>块中，添加关于已认证主题的信息- <code class="fe mr ms mt mu b">&lt;saml2:NameID&gt;arseniy@example.com&lt;/saml2:NameID&gt;</code>以及他在电子邮件视图中的标识符- <code class="fe mr ms mt mu b">Format="urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress"</code></li><li id="141c" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr mg ky kz la bi translated">在<code class="fe mr ms mt mu b">&lt;saml2:Conditions&gt;</code>中，条件被指定为认为该断言有效，例如，时间范围(<code class="fe mr ms mt mu b">NotBefore</code> и <code class="fe mr ms mt mu b">NotOnOrAfter</code>)</li><li id="319d" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr mg ky kz la bi translated">最后在<code class="fe mr ms mt mu b">&lt;saml2:AuthnStatement&gt;</code>中，使用一种认证类型来认证该用户- ( <code class="fe mr ms mt mu b">&lt;saml2:AuthnContextClassRef&gt;urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport&lt;/saml2:AuthnContextClassRef&gt;</code>)</li></ol><h2 id="7a41" class="li lj iq bd lk ll lm dn ln lo lp dp lq kf lr ls lt kj lu lv lw kn lx ly lz ma bi translated">属性语句结构</h2><p id="f5c2" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">下一部分是<code class="fe mr ms mt mu b">&lt;AttributeStatement&gt;</code>:</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi mv"><img src="../Images/efb6e3017a3d84632afd8c23ee3a7d68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lkf8-Ucp4QWG2Gqb.png"/></div></div></figure><pre class="ml mm mn mo gt na mu nb nc aw nd bi"><span id="5b81" class="li lj iq mu b gy ne nf l ng nh">...<br/>        &lt;saml2:AttributeStatement xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion"&gt;<br/>            &lt;saml2:Attribute Name="Group" NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:basic"&gt;<br/>                &lt;saml2:AttributeValue xmlns:xs="http://www.w3.org/2001/XMLSchema"<br/>                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string"&gt;Everyone&lt;/saml2:AttributeValue&gt;<br/>                &lt;saml2:AttributeValue xmlns:xs="http://www.w3.org/2001/XMLSchema"<br/>                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string"&gt;DevOps&lt;/saml2:AttributeValue&gt;<br/>            &lt;/saml2:Attribute&gt;<br/>        &lt;/saml2:AttributeStatement&gt;<br/>...</span></pre><p id="546c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">除了上面讨论的关于认证的信息之外，IdP还可以传递关于被认证对象的属性。</p><ul class=""><li id="5c57" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated">这里是<code class="fe mr ms mt mu b">&lt;saml2:Attribute Name="Group"&gt;</code>，使用<em class="lh"> SAML </em> <em class="lh">基本属性概要</em> ( <code class="fe mr ms mt mu b">NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:basic"</code>)，一个属性用两个值传递——一个组<code class="fe mr ms mt mu b">&lt;saml2:AttributeValue&gt;Everyone&lt;/saml2:AttributeValue&gt;</code>，另一个组<code class="fe mr ms mt mu b">&lt;saml2:AttributeValue&gt;DevOps&lt;/saml2:AttributeValue&gt;</code></li></ul><h2 id="b9cb" class="li lj iq bd lk ll lm dn ln lo lp dp lq kf lr ls lt kj lu lv lw kn lx ly lz ma bi translated">SAML配置文件</h2><p id="fe8b" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">正如已经提到的，SAML为不同的用例定义了一堆不同的概要文件。</p><p id="db87" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在Jenkins和Okta的案例中，使用了最广泛使用的SAML认证类型<em class="lh"> Web浏览器SSO配置文件</em>。</p><h2 id="f4ac" class="li lj iq bd lk ll lm dn ln lo lp dp lq kf lr ls lt kj lu lv lw kn lx ly lz ma bi translated">Web浏览器SSO配置文件</h2><p id="c174" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated"><strong class="jw ir"> Web浏览器单点登录配置文件</strong>定义了交换SAML消息以实现Web单点登录的流程，具体为:</p><ol class=""><li id="dd60" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr mg ky kz la bi translated">首先，它描述了一个认证初始化向量— <em class="lh"> IdP发起的</em>或<em class="lh"> SP发起的</em></li><li id="852b" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr mg ky kz la bi translated">第二，必须使用哪些SAML绑定来通过网络传递这些消息</li></ol><p id="f888" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们已经在上面讨论了IdP启动的和SP启动的角色，在我们的例子中，它将是SP启动的(用户打开Jenkins URL，它从IdP请求这个用户认证)。</p><p id="da3f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">当用户第一次打开它的Okta帐户，然后点击那里的Jenkins图标，那么Okta将扮演一个初始化者的角色，并将生成一个assert，该assert将被传递给Jenkins实例。</p><p id="d361" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">该配置文件定义的第二件事是用于在IdP和SP之间传递数据的<em class="lh">绑定</em>。</p><p id="ac6f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，可以使用<em class="lh"> HTTP重定向绑定</em>、<em class="lh"> HTTP POST绑定</em>或<em class="lh"> HTTP工件绑定</em>将<em class="lh">认证请求</em>从SP传送到IdP，并且可以使用<em class="lh"> HTTP POST绑定</em>或<em class="lh"> HTTP工件绑定</em>将<em class="lh">响应消息</em>从IdP传送到SP。</p><p id="fda1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这样，在同一个认证会话中，可以使用一种绑定类型发送<em class="lh">认证请求</em>，使用另一种绑定类型发送<em class="lh">响应消息</em>，这由IdP和SP配置描述。</p><p id="ad51" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">分别有各种身份验证过程类型:</p><ul class=""><li id="dd9b" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated"><strong class="jw ir"> <em class="lh"> SP发起的单点登录使用重定向绑定</em> </strong>将<code class="fe mr ms mt mu b">&lt;AuthnRequest&gt;</code>消息从SP传递到IdP，并使用<em class="lh"> POST绑定</em>将<code class="fe mr ms mt mu b">&lt;Response&gt;</code>消息从IdP传递到SP</li><li id="37fc" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><strong class="jw ir"> <em class="lh"> SP发起的单点登录使用<code class="fe mr ms mt mu b">&lt;AuthnRequest&gt;</code>消息的后绑定</em> </strong>和<em class="lh">工件绑定</em>来传输<code class="fe mr ms mt mu b">&lt;Response&gt;</code>消息</li><li id="062f" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><strong class="jw ir"> <em class="lh"> IDP发起的SSO使用POST Binding </em> </strong>将<code class="fe mr ms mt mu b">&lt;Response&gt;</code>消息从IDP传送到SP；<code class="fe mr ms mt mu b">&lt;AuthnRequest&gt;</code>根本不用</li></ul><p id="347c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Jenkins和Okta — SP启动的单点登录:重定向/后绑定</p><p id="9ec5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">最后，让我们通过使用<strong class="jw ir"> SP发起的SSO: Redirect/POST Bindings </strong>来详细说明Jenkins和Okta之间的整个SSO认证过程，这很容易通过HTTP方法从<code class="fe mr ms mt mu b">saml-chrome-panel</code>输出中识别:</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/c7add2503c2def7277698e8de9c3b74e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1098/format:webp/0*YvkIG0UXwQXbiJf1.png"/></div></figure><p id="7d39" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这个过程可以示意性地显示如下:</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/b0205988d92f826e9af72090906af6a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1074/0*qfvvSHb2KWcW3mW2.gif"/></div></figure><p id="62e8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里是一步一步的SSO认证:</p><ol class=""><li id="4e2f" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr mg ky kz la bi translated">用户打开了一个<em class="lh">sp.example.com</em>页面(在这种情况下是Jenkins URL)，并且他没有活动的登录会话(例如<em class="lh">安全上下文</em>)。SP将保存用户请求的URL</li><li id="55ba" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr mg ky kz la bi translated">SP用302或303重定向代码向用户的浏览器返回请求，在HTTP <em class="lh">位置</em>头中将指定一个SSO服务URL，在URL变量<code class="fe mr ms mt mu b">SAMLRequest</code>中将传递一个<code class="fe mr ms mt mu b">&lt;AuthnRequest&gt;</code>请求体</li></ol><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi nk"><img src="../Images/010c5dade10b674a6341187cc289c71b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jaaOpNV9PoxbJcBd.png"/></div></div></figure><ol class=""><li id="f402" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr mg ky kz la bi translated">然后，浏览器将处理接收到的重定向，并向一个IdP URL发出HTTP <code class="fe mr ms mt mu b">GET</code>，在那里传递<code class="fe mr ms mt mu b">SAMLRequest</code></li><li id="b40d" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr mg ky kz la bi translated">SSO服务检查用户是否已经有一个活动的登录会话，该会话必须符合从SP (Jenkins)传入的<code class="fe mr ms mt mu b">AuthnRequest</code>中所请求的身份验证类型。如果找不到这样的会话，那么用户必须首先在IdP上使用他的登录名和密码进行身份验证</li><li id="943e" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr mg ky kz la bi translated">用户在IdP上被认证，其中为他创建了一个<em class="lh">安全上下文</em></li><li id="6c1c" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr mg ky kz la bi translated">IdP单点登录服务生成一个SAML <code class="fe mr ms mt mu b">&lt;Response&gt;</code>，其中包含一个带有这个用户安全上下文的断言。SAML <code class="fe mr ms mt mu b">&lt;Response&gt;</code>被放入名为<code class="fe mr ms mt mu b">SAMLResponse</code>的HTTP <code class="fe mr ms mt mu b">FORM</code>中:</li></ol><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi nl"><img src="../Images/7e027b04ad4244407ef5cc92af413f71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3CmEmNTg40rYq1BI.png"/></div></div></figure><ol class=""><li id="1830" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr mg ky kz la bi translated"><code class="fe mr ms mt mu b">SAMLResponse</code>体在<code class="fe mr ms mt mu b">&lt;saml2p:Response&gt;</code>元素中以base64编码传输:</li></ol><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi nm"><img src="../Images/866d32af177e003055dae29e5b0ae9ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eB5qcNpK6iWXroBM.png"/></div></div></figure><ol class=""><li id="6687" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr mg ky kz la bi translated">生成的HTML作为HTTP响应传递给用户的浏览器。</li><li id="29ce" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr mg ky kz la bi translated">浏览器将通过<code class="fe mr ms mt mu b">SAMLResponse</code> <br/>向SP (Jenkins)发出<code class="fe mr ms mt mu b">POST</code>请求。SP将检查&lt; <code class="fe mr ms mt mu b">Response&gt;</code>内容，并将为此用户创建新的本地安全上下文</li><li id="fb13" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr mg ky kz la bi translated">最后一步，SP可以执行一个额外用户的<em class="lh">授权</em>来检查这个用户在这个系统中有哪些权限。例如，詹金斯可以通过使用<a class="ae lb" href="https://rtfm.co.ua/en/jenkins-saml-okta-users-groups-and-role-based-security-plugin/" rel="noopener ugc nofollow" target="_blank">基于角色的安全插件</a>来授权用户</li></ol><p id="cec8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">嗯，大体就是这样。</p></div><div class="ab cl nn no hu np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="ij ik il im in"><p id="6d6e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="lh">最初发布于</em> <a class="ae lb" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/" rel="noopener ugc nofollow" target="_blank"> <em class="lh"> RTFM: Linux、DevOps和系统管理</em> </a> <em class="lh">。</em></p></div></div>    
</body>
</html>