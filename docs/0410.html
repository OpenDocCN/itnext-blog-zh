<html>
<head>
<title>Run Multiple Isolated Web Applications on Containers with a Single IP for Free</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用单个IP在容器上免费运行多个独立的Web应用程序</h1>
<blockquote>原文：<a href="https://itnext.io/run-multiple-isolated-web-applications-on-containers-with-a-single-ip-for-free-52d216f3e810?source=collection_archive---------2-----------------------#2018-03-06">https://itnext.io/run-multiple-isolated-web-applications-on-containers-with-a-single-ip-for-free-52d216f3e810?source=collection_archive---------2-----------------------#2018-03-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="36c4" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">架构逻辑介绍和构建自动化NGINX反向代理容器的分步指南，该容器使用一个公共IP地址为软件定义的局域网内多个基于容器的应用提供服务。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/fcb1c0180e0c32d4175441618de8982f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UiehBzynKsPb_YbhphFSlA.png"/></div></div></figure><p id="68b4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><a class="ae lq" href="https://www.linkedin.com/cws/share?url=https%3A%2F%2Fitnext.io%2Frun-multiple-isolated-web-applications-on-containers-with-a-single-ip-for-free-52d216f3e810" rel="noopener ugc nofollow" target="_blank"> <em class="lr">点击这里在LinkedIn </em>上分享这篇文章</a></p><p id="7725" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您像我一样，总是为客户构建新的应用程序和各种技术解决方案，那么拥有一个经济高效的测试环境来按需构建新的应用程序，对于向客户交付经过良好测试的解决方案至关重要。过去，测试环境非常昂贵，我的办公室里有一架架服务器。接下来是虚拟机和云，这大大降低了测试环境的成本。最近，容器在完全取代虚拟机和/或在云中的虚拟机实例上运行方面变得非常流行。这里有一个来自Google的很好的比较表，解释了容器相对于虚拟机的优势，一目了然:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ls"><img src="../Images/e16f062ac0601c5f968807dadc8ee807.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xq7Hv14NtAcrnM1QJHOGJg.png"/></div></div><figcaption class="lt lu gj gh gi lv lw bd b be z dk translated">上图来自:【https://cloud.google.com/containers/ T4】</figcaption></figure><p id="6f62" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我通常告诉不熟悉这个概念的人，容器是一种新的、改进的方法，可以在很多情况下做虚拟机所做的事情，但使用的资源要少得多，因此与使用虚拟机相比，你可以运行更多的“服务器实例”。这就是我们能够完成我将要演示的任务的原因，因为如果我尝试在我的T2微虚拟机上运行3个以上的虚拟机，它可能会崩溃并死亡。如果你仍然对这整个容器的事情有点困惑，我发现CIO杂志有一篇很棒的<a class="ae lq" href="https://www.cio.com/article/2924995/software/what-are-containers-and-why-do-you-need-them.html" rel="noopener ugc nofollow" target="_blank">文章</a>，用通俗的语言全面地解释了事情。</p><p id="47ee" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在有很多方法来创建基于容器的环境，包括一些较新的产品，如AWS <a class="ae lq" href="https://aws.amazon.com/ecs/" rel="noopener ugc nofollow" target="_blank"> ECS </a>，AWS <a class="ae lq" href="https://aws.amazon.com/eks/" rel="noopener ugc nofollow" target="_blank"> EKS </a>，AWS <a class="ae lq" href="https://aws.amazon.com/fargate/" rel="noopener ugc nofollow" target="_blank"> Fargate </a>，<a class="ae lq" href="https://azure.microsoft.com/en-us/services/container-service/" rel="noopener ugc nofollow" target="_blank">Microsoft AKS</a>，GCP <a class="ae lq" href="https://cloud.google.com/kubernetes-engine/" rel="noopener ugc nofollow" target="_blank"> Kubernetes引擎</a>，阿里云的<a class="ae lq" href="https://www.alibabacloud.com/product/container-service" rel="noopener ugc nofollow" target="_blank">容器服务</a>，等等。我相信你也会注意到“<a class="ae lq" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>”这个词出现在这些服务中，他们称之为“生产级容器编排”；本质上是一个复杂的抽象层，具有软件定义的环境，在部署和管理大型容器集群时非常有用；在我看来，这是大规模容器部署的绝对必要条件。然而，虽然我对这些服务中的大多数感到非常兴奋，但它们都超出了本主题的范围，因为我打算逐步构建一个超级简单的环境，允许您旋转位于NGINX  <a class="ae lq" href="https://en.wikipedia.org/wiki/Reverse_proxy" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu">反向代理</strong> </a> <strong class="kw iu">容器后面的容器，所有这些容器都驻留在一个小型AWS EC2</strong><a class="ae lq" href="https://aws.amazon.com/ec2/instance-types/" rel="noopener ugc nofollow" target="_blank"><strong class="kw iu">T2-微</strong> </a> <strong class="kw iu">实例中。</strong> <strong class="kw iu">这样，你就可以在一个外部IP上托管多个与多个域/子域相关联的小型web应用</strong>。另外，顺便提一下，FWIW，我有一个<a class="ae lq" href="https://aws.amazon.com/ec2/instance-types/" rel="noopener ugc nofollow" target="_blank">T2-纳诺</a>实例，作为同一个<a class="ae lq" href="https://aws.amazon.com/vpc/" rel="noopener ugc nofollow" target="_blank"> VPC </a>中的<a class="ae lq" href="https://www.openssh.com/" rel="noopener ugc nofollow" target="_blank"> SSH </a> / <a class="ae lq" href="https://openvpn.net/" rel="noopener ugc nofollow" target="_blank"> OpenVPN </a>网关，这样我可以阻止对容器主机的直接远程访问，出于安全原因，我不会在这里讨论细节。关于货币成本的好消息是，如果你在AWS 注册了一个<a class="ae lq" href="https://aws.amazon.com/free/" rel="noopener ugc nofollow" target="_blank">新账户，你就可以在一年内免费使用我刚刚谈到的这些资源，在他们开始对超额使用收费之前，有非常慷慨的限制</a><a class="ae lq" href="https://aws.amazon.com/free/#details" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="3561" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在开始，但在我们开始之前，让我再次从上往下展示该图，以帮助可视化实施:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/fcb1c0180e0c32d4175441618de8982f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UiehBzynKsPb_YbhphFSlA.png"/></div></div><figcaption class="lt lu gj gh gi lv lw bd b be z dk translated">在左侧，您将看到AWS架构，而在右侧，您将看到EC2 T2微实例内部的架构。</figcaption></figure><p id="0459" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了这个演练的目的，我将假设你足够精通注册一个新的AWS帐户，并使用Ubuntu 16.04映像启动一个T2微实例。我将从实例启动并运行的地方开始，并且您已经通过ssh登录到实例，不管您是直接SSH到实例，还是像我一样通过网关主机或一些人所说的堡垒主机登录。</p><p id="099c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我将我的EC2实例命名为chimp，我使用的域名是我的域名，dragon-ventures.com。我们开始吧！</p><p id="f3c3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">首先，让我们确保Ubuntu是最新的，然后安装<a class="ae lq" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker </a>:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="6eaf" class="mc md it ly b gy me mf l mg mh">sudo apt-get update<br/>sudo apt-get upgrade<br/>sudo apt-get install docker.io</span></pre><p id="ab24" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">安装完成后，您可以执行以下操作来确保它正常工作:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="b497" class="mc md it ly b gy me mf l mg mh">ubuntu@chimp:~$ <strong class="ly iu">sudo docker ps<br/></strong>CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES<br/>ubuntu@chimp:~$</span></pre><p id="1a42" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">因为我们还没有运行任何东西，所以在列下面没有显示任何东西是正常的。从这里开始，您就可以配置基于容器的环境了。这太简单了，对吧？</p><p id="e6c7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">因此，让NGINX反向代理容器在自己的网络上运行。我们应该从零开始建造东西吗？没有。已经有一个现有的<a class="ae lq" href="https://github.com/jwilder/nginx-proxy" rel="noopener ugc nofollow" target="_blank"> Docker镜像</a>由<a class="ae lq" href="https://github.com/jwilder" rel="noopener ugc nofollow" target="_blank"> Jason Wilder </a>创建，它可以帮助你用一个命令行部署一个自动化的反向代理容器，但是在我们这样做之前，让我们确保我们已经创建了一个名为nginx-proxy的网络，代理容器后面的所有容器都将位于这个网络中:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="9cda" class="mc md it ly b gy me mf l mg mh">ubuntu@chimp:~$ <strong class="ly iu">sudo docker network create nginx-proxy</strong><br/>2ba0a9b09db49f1524b1b4b6cd3d5d16b8cdf38e61690a1301f4015c319e9e73</span></pre><p id="3e8d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你成功了，你会看到一串随机的字符，这是你的网络的唯一标识。创建网络后，因为我们希望http和https都能工作，所以现在您可以准备一个选择的本地目录，并放置一些为您的域创建的SSL证书，这些证书来自类似于<a class="ae lq" href="https://zerossl.com/" rel="noopener ugc nofollow" target="_blank"> ZeroSSL </a>或您选择的任何其他证书提供商。然后，您可以选择一个您认为安全的目录来存储ssl证书，但是出于本演练的目的，为了方便起见，我选择了/home/ubuntu/ssl:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="6e95" class="mc md it ly b gy me mf l mg mh">ubuntu@chimp:~$ <strong class="ly iu">mkdir ssl</strong></span></pre><p id="ef03" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">有几种方法可以将您的SSL证书/密钥上传到服务器，我假设您已经知道如何上传，但这里有一个从我的ssh网关实例(可能是您的本地计算机)上传dragon-ventures.com.crt和dragon-ventures.com.key的例子，这是在zerossl.com生成的容器主机实例。请注意，证书和密钥必须以用于自动化工作的域名命名:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="d32c" class="mc md it ly b gy me mf l mg mh">ubuntu@bastion:~$ <strong class="ly iu">scp -i aws.pem dragon-ventures.com.crt</strong> <strong class="ly iu">ubuntu@chimp.dragon-ventures.com:~/ssl/</strong></span><span id="15fe" class="mc md it ly b gy mi mf l mg mh">ubuntu@bastion:~$ <strong class="ly iu">scp -i aws.pem dragon-ventures.com.key</strong> <strong class="ly iu">ubuntu@chimp.dragon-ventures.com:~/ssl/</strong></span></pre><p id="0868" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">请注意，对于托管额外的域，您所要做的就是将名为domain.com.crt和domain.com.key的证书和密钥分别放入您正在使用的目录中，而不是/home/ubuntu/ssl，这样它就可以自动将这些证书用于关联容器。</p><p id="a70e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在，我们准备用我们的一个liner启动自动化NGINX反向代理容器:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="36d6" class="mc md it ly b gy me mf l mg mh">ubuntu@chimp:~$<strong class="ly iu"> sudo docker run -d --name nginx-proxy --net nginx-proxy -p 80:80 -p 443:443 -e HTTPS_METHOD=noredirect -e HSTS=off -v /home/ubuntu/ssl:/etc/nginx/certs -v /var/run/docker.sock:/tmp/docker.sock:ro jwilder/nginx-proxy</strong><br/>Unable to find image 'jwilder/nginx-proxy:latest' locally<br/>latest: Pulling from jwilder/nginx-proxy<br/>e7bb522d92ff: Pull complete <br/>6edc05228666: Pull complete <br/>cd866a17e81f: Pull complete <br/>d9f2d6a1f8f6: Pull complete <br/>e9c7e986c8c1: Pull complete <br/>a51bcd518fd9: Pull complete <br/>66df98413ed2: Pull complete <br/>aff8c6473b42: Pull complete <br/>1c91fd608be1: Pull complete <br/>7319453a5fbe: Pull complete <br/>Digest: sha256:41506b2095779e6e64f34e26ccba35cb3668ee56a735cd740ac8c183af583294<br/>Status: Downloaded newer image for jwilder/nginx-proxy:latest<br/>a02048ca47b59325fc9e4ea9d4f4717c2cb63a4d4a78c94c3709c5d3e4bbd012</span></pre><p id="923d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">信不信由你，你现在已经在一个定制的网络上拥有了一个自动化的反向代理容器。超快的对吧？接下来，让我们通过启动一个新容器来进行测试。为了简单起见，假设我们想为wordpress上的客户建立一个新网站。嗯，你猜对了。实际上已经有一个wordpress容器图片可供我们使用。</p><p id="bb9e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">首先，因为wordpress映像默认只支持端口80而不支持SSL，所以我们需要定制wordpress映像来支持SSL和端口443。</p><p id="966d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">以下步骤纯属个人喜好，出于组织目的，因此我可以轻松地引用我创建的不同Docker文件，这些文件定义了定制的Docker映像。其背后的逻辑是，我为我定制的每个容器创建一个带有子目录的顶层目录。我还将ssl证书复制到容器子目录中的ssl子目录中，因为Docker build只能从Docker文件所在的目录及其子目录开始。</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="00bf" class="mc md it ly b gy me mf l mg mh">ubuntu@chimp:~$ <strong class="ly iu">mkdir -p containers/wordpress/ssl<br/></strong>ubuntu@chimp:~$ <strong class="ly iu">cp ssl/dragon-ventures.* containers/wordpress/ssl<br/></strong>ubuntu@chimp:~$ <strong class="ly iu">cd containers/wordpress/</strong><br/>ubuntu@chimp:~$ <strong class="ly iu">vim Dockerfile</strong></span></pre><p id="0f58" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">将以下内容粘贴到文件中:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="9e7e" class="mc md it ly b gy me mf l mg mh">FROM wordpress:4.8.0-php7.1-apache</span><span id="2aaa" class="mc md it ly b gy mi mf l mg mh">RUN apt-get update &amp;&amp; \<br/>        apt-get install -y  --no-install-recommends ssl-cert &amp;&amp; \<br/>        rm -r /var/lib/apt/lists/* &amp;&amp; \<br/>        a2enmod ssl &amp;&amp; \<br/>        a2ensite default-ssl</span><span id="524f" class="mc md it ly b gy mi mf l mg mh">EXPOSE 80<br/>EXPOSE 443</span></pre><p id="ec0e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">请注意，这个容器将使用自签名证书，但这在这种情况下不会有太大影响，因为反向代理容器将使用真实证书卸载SSL。然而，对于我的真实测试环境，我实际上增加了几个步骤，使容器也使用真实证书，但我不会在这里介绍它们。</p><p id="9771" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们现在准备好构建自定义图像，我将它标记为dv/wordpress:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="984a" class="mc md it ly b gy me mf l mg mh">ubuntu@chimp:~/containers/wordpress$<strong class="ly iu"> sudo docker build -t dv/wordpress .</strong><br/>Sending build context to Docker daemon 2.048 kB<br/>Step 1/6 : FROM wordpress:4.8.0-php7.1-apache<br/>4.8.0-php7.1-apache: Pulling from library/wordpress<br/>ad74af05f5a2: Pull complete <br/>a1e75557f244: Pull complete <br/>6ab4f72a86ad: Pull complete <br/>55e3508d42ca: Pull complete <br/>88792c88e1bc: Pull complete <br/>1d8a48cffe59: Pull complete <br/>0c30cf9b4233: Pull complete <br/>37ec3cd3c9fb: Pull complete <br/>1925fdff3f6a: Pull complete <br/>f1a75ee98d0d: Pull complete <br/>b9e0483f0c09: Pull complete <br/>8c5d8b4070d7: Pull complete <br/>ffd7c73efd91: Pull complete <br/>31b2a59ece05: Pull complete <br/>df9af0decc33: Pull complete <br/>b0b6fe59a468: Pull complete <br/>9c183d73d613: Pull complete <br/>a3be0b191a8e: Pull complete <br/>Digest: sha256:241f092e70d128d047f2fc162904e1dba89dbe4c2f0e225d5791ff596ed2c96f<br/>Status: Downloaded newer image for wordpress:4.8.0-php7.1-apache<br/> ---&gt; 56649ecf398a<br/>Step 2/6 : RUN apt-get update &amp;&amp;  apt-get install -y  --no-install-recommends ssl-cert &amp;&amp;  rm -r /var/lib/apt/lists/* &amp;&amp;  a2enmod ssl &amp;&amp;  a2ensite default-ssl<br/> ---&gt; Running in 1bcd6bbeb433<br/>Get:1 <a class="ae lq" href="http://security.debian.org" rel="noopener ugc nofollow" target="_blank">http://security.debian.org</a> jessie/updates InRelease [63.1 kB]<br/>Ign <a class="ae lq" href="http://deb.debian.org" rel="noopener ugc nofollow" target="_blank">http://deb.debian.org</a> jessie InRelease<br/>Get:2 <a class="ae lq" href="http://deb.debian.org" rel="noopener ugc nofollow" target="_blank">http://deb.debian.org</a> jessie-updates InRelease [145 kB]<br/>Get:3 <a class="ae lq" href="http://deb.debian.org" rel="noopener ugc nofollow" target="_blank">http://deb.debian.org</a> jessie Release.gpg [2434 B]<br/>Get:4 <a class="ae lq" href="http://deb.debian.org" rel="noopener ugc nofollow" target="_blank">http://deb.debian.org</a> jessie Release [148 kB]<br/>Get:5 <a class="ae lq" href="http://security.debian.org" rel="noopener ugc nofollow" target="_blank">http://security.debian.org</a> jessie/updates/main amd64 Packages [631 kB]<br/>Get:6 <a class="ae lq" href="http://deb.debian.org" rel="noopener ugc nofollow" target="_blank">http://deb.debian.org</a> jessie-updates/main amd64 Packages [23.1 kB]<br/>Get:7 <a class="ae lq" href="http://deb.debian.org" rel="noopener ugc nofollow" target="_blank">http://deb.debian.org</a> jessie/main amd64 Packages [9064 kB]<br/>Fetched 10.1 MB in 8s (1145 kB/s)<br/>Reading package lists...<br/>Reading package lists...<br/>Building dependency tree...<br/>Reading state information...<br/>Suggested packages:<br/>  openssl-blacklist<br/>The following NEW packages will be installed:<br/>  ssl-cert<br/>0 upgraded, 1 newly installed, 0 to remove and 45 not upgraded.<br/>Need to get 20.9 kB of archives.<br/>After this operation, 104 kB of additional disk space will be used.<br/>Get:1 <a class="ae lq" href="http://deb.debian.org/debian/" rel="noopener ugc nofollow" target="_blank">http://deb.debian.org/debian/</a> jessie/main ssl-cert all 1.0.35 [20.9 kB]<br/>debconf: delaying package configuration, since apt-utils is not installed<br/>Fetched 20.9 kB in 1s (13.5 kB/s)<br/>Selecting previously unselected package ssl-cert.<br/>(Reading database ... 13657 files and directories currently installed.)<br/>Preparing to unpack .../ssl-cert_1.0.35_all.deb ...<br/>Unpacking ssl-cert (1.0.35) ...<br/>Setting up ssl-cert (1.0.35) ...<br/>debconf: unable to initialize frontend: Dialog<br/>debconf: (TERM is not set, so the dialog frontend is not usable.)<br/>debconf: falling back to frontend: Readline<br/>Considering dependency setenvif for ssl:<br/>Module setenvif already enabled<br/>Considering dependency mime for ssl:<br/>Module mime already enabled<br/>Considering dependency socache_shmcb for ssl:<br/>Enabling module socache_shmcb.<br/>Enabling module ssl.<br/>See /usr/share/doc/apache2/README.Debian.gz on how to configure SSL and create self-signed certificates.<br/>To activate the new configuration, you need to run:<br/>  service apache2 restart<br/>Enabling site default-ssl.<br/>To activate the new configuration, you need to run:<br/>  service apache2 reload<br/> ---&gt; 6c5155317d89<br/>Removing intermediate container 1bcd6bbeb433<br/>Step 3/6 : ADD ssl/dv.crt /etc/ssl/certs/<br/> ---&gt; 732f061b3bf2<br/>Removing intermediate container 909a2770fd40<br/>Step 4/6 : ADD ssl/dv.key /etc/ssl/private/<br/> ---&gt; 2b675e639d1a<br/>Removing intermediate container b07c19546149<br/>Step 5/6 : EXPOSE 80<br/> ---&gt; Running in 3efc852f72b9<br/> ---&gt; 50201abe9632<br/>Removing intermediate container 3efc852f72b9<br/>Step 6/6 : EXPOSE 443<br/> ---&gt; Running in 723b660431bf<br/> ---&gt; 5e4dac2c8e9c<br/>Removing intermediate container 723b660431bf<br/>Successfully built 5e4dac2c8e9c</span></pre><p id="c1ae" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在已经完成了定制图像的构建。让我们为wordpress容器设置一个mysql服务器:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="46ee" class="mc md it ly b gy me mf l mg mh">ubuntu@chimp:~$ <strong class="ly iu">sudo docker run -d --name share-mysql --expose 3306 --net nginx-proxy -e MYSQL_ROOT_PASSWORD=my-secret-pw mysql:latest</strong><br/>Unable to find image 'mysql:latest' locally<br/>latest: Pulling from library/mysql<br/>8176e34d5d92: Pull complete <br/>17e372a8ec90: Pull complete <br/>47b869561d3a: Pull complete <br/>c90ab4483f28: Pull complete <br/>d6af16572c5c: Pull complete <br/>6d16794d04ac: Pull complete <br/>aaf442a8fe75: Pull complete <br/>7c6fa8f07ec4: Pull complete <br/>ece17b689642: Pull complete <br/>c55b06e76eaf: Pull complete <br/>661fabfb4fc2: Pull complete <br/>Digest: sha256:227d5c3f54ee3a70c075b1c3013e72781564000d34fc8c7ec5ec353c5b7ef7fa<br/>Status: Downloaded newer image for mysql:latest<br/>addbb43072a94d7d1e7ebced10083a3980f01af84b619621d267f8e05f436232</span></pre><p id="ba1c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意，我们已经在上面的docker run命令中将mysql root密码设置为“my-secret-pw”。以后记住这一点很重要。现在，我们可以让我们的自定义映像物有所值了:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="1f65" class="mc md it ly b gy me mf l mg mh">ubuntu@chimp:~$<strong class="ly iu"> sudo docker run -d --name share --expose 80 --expose 443 --net nginx-proxy --link share</strong><strong class="ly iu">-mysql:mysql</strong><strong class="ly iu"> -e VIRTUAL_HOST=share.dragon-ventures.com -e VIRTUAL_PROTO=http -e VIRTUAL_PORT=80 -e VIRTUAL_PROTO=https -e VIRTUAL_PORT=443 -e HTTPS_METHOD=noredirect dv/wordpress</strong><br/>02dce41c606cb30bc5b1240606f0d83c2d5e6a80f31fc910069639637ce2276d</span></pre><p id="927e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意，我已经为wordpress容器指定了链接到share-mysql数据库，这给了它访问mysql所需的权限。</p><p id="6d67" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">就是这样…真的！因此，让我们通过编辑hosts文件并使用浏览器查看它来看看它是否真的有效:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="fadb" class="mc md it ly b gy me mf l mg mh">sudo vim /etc/hosts</span></pre><p id="600a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">将以下内容插入主机文件:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="c73c" class="mc md it ly b gy me mf l mg mh">[Your EC2 Instance Public IP] share.dragon-ventures.com</span></pre><p id="b6b9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后打开浏览器查看！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mj"><img src="../Images/e231fb6aa4c7014213ea5958d518e026.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K2oWbQBgJWfJHkwRGrWz_w.png"/></div></div></figure><p id="e535" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">嘭！看起来不错！然而，拥有一个基于容器的环境和一个反向代理服务器的意义在于，你可以托管多个应用程序(<strong class="kw iu">在一个真实的用例中，有多个大不相同的服务器配置，而不是两个容器有相同的配置</strong>)，所以让我设置wordpress，并给站点一个不同的外观，目的是区分这个站点和我们将创建的新站点，新站点只是作为一个<strong class="kw iu">概念证明，NGINX实际上路由到多个容器</strong>。为了做到这一点，我们必须首先准备好mysql服务器。让我们从安装mysql-client开始:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="eb1c" class="mc md it ly b gy me mf l mg mh">sudo apt-get install mysql-client</span></pre><p id="5274" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后，通过查找容器id来识别mysql容器的IP地址，然后根据识别的容器id执行inspect命令，如下所示:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="9375" class="mc md it ly b gy me mf l mg mh">ubuntu@chimp:~$ <strong class="ly iu">sudo docker ps</strong><br/>CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                                      NAMES<br/>02dce41c606c        dv/wordpress          "docker-entrypoint..."   17 minutes ago      Up 17 minutes       80/tcp, 443/tcp                            share<br/><strong class="ly iu">addbb43072a9</strong>        mysql:latest          "docker-entrypoint..."   25 minutes ago      Up 25 minutes       3306/tcp                                   share-mysql<br/>a02048ca47b5        jwilder/nginx-proxy   "/app/docker-entry..."   About an hour ago   Up About an hour    0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp   nginx-proxy<br/>ubuntu@chimp:~$ <strong class="ly iu">sudo docker inspect addbb43072a9 |grep IPAddress</strong><br/>            "SecondaryIPAddresses": null,<br/>            "IPAddress": "",<br/>                    "IPAddress": "<strong class="ly iu">172.18.0.3</strong>",</span></pre><p id="bacf" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们现在可以连接到mysql数据库，并按如下方式准备数据库:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="772d" class="mc md it ly b gy me mf l mg mh">ubuntu@chimp:~/ssl$ <strong class="ly iu">mysql -h 172.18.0.3 -u root -p</strong><br/>Enter password: <br/>Welcome to the MySQL monitor.  Commands end with ; or \g.<br/>Your MySQL connection id is 4<br/>Server version: 5.7.21 MySQL Community Server (GPL)</span><span id="b20a" class="mc md it ly b gy mi mf l mg mh">Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span><span id="e704" class="mc md it ly b gy mi mf l mg mh">Oracle is a registered trademark of Oracle Corporation and/or its<br/>affiliates. Other names may be trademarks of their respective<br/>owners.</span><span id="3eea" class="mc md it ly b gy mi mf l mg mh">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><span id="e661" class="mc md it ly b gy mi mf l mg mh">mysql&gt; <strong class="ly iu">create database sharedb;<br/></strong>Query OK, 1 row affected (0.00 sec)</span><span id="ebf0" class="mc md it ly b gy mi mf l mg mh">mysql&gt; <strong class="ly iu">GRANT ALL PRIVILEGES ON sharedb.* TO wpuser IDENTIFIED BY 'secret';<br/></strong>Query OK, 0 rows affected, 1 warning (0.00 sec)</span><span id="c314" class="mc md it ly b gy mi mf l mg mh">mysql&gt; \q</span></pre><p id="58ae" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后让我们回到浏览器，让wordpress站点运行起来:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mk"><img src="../Images/0241910768755549b8200eb4f4697db7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CiKu8mFVHKZTfzHQX7EQcw.png"/></div></div><figcaption class="lt lu gj gh gi lv lw bd b be z dk translated">关于在设置配置屏幕中输入什么内容的参考</figcaption></figure><p id="bf7a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">浏览安装动作，点击地址【https://share.dragon-ventures.com T4】，你将会在这里结束:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ml"><img src="../Images/3c2dede6f39c6a06bec12300f8d39a40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QICLOSHRmbxKixZX227_cA.png"/></div></div></figure><p id="c026" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">现在让我们制作第二个网站，portal.dragon-ventures.com: </strong></p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="b09f" class="mc md it ly b gy me mf l mg mh">ubuntu@chimp:~$ <strong class="ly iu">sudo docker run -d --name portal-mysql --expose 3306 --net nginx-proxy -e MYSQL_ROOT_PASSWORD=my-secret-pw mysql:latest</strong><br/>'e73f179192f2ab4644a760833355673d528d79269eaff83d06e864912227b572<br/>ubuntu@chimp:~$ <strong class="ly iu">sudo docker run -d --name portal --expose 80 --expose 443 --net nginx-proxy --link portal-mysql:mysql -e VIRTUAL_HOST=portal.dragon-ventures.com -e VIRTUAL_PROTO=http -e VIRTUAL_PORT=80 -e VIRTUAL_PROTO=https -e VIRTUAL_PORT=443 -e HTTPS_METHOD=noredirect dv/wordpress<br/></strong>f08fde106687b039996747bf78d8605581fca6c18384b252606995f9b427937a</span></pre><p id="896d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">再次编辑主机文件，并添加:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="f055" class="mc md it ly b gy me mf l mg mh">[Your EC2 Instance Public IP]   portal.dragon-ventures.com</span></pre><p id="9381" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后在浏览器上查，看！尽管portal.dragon-ventures.com指向同一个IP地址，它却去了不同的网站！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mm"><img src="../Images/b4e76b4e6da0ec516393bff15cfa04bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UsvC6joq6uN5gEvIM612oQ.png"/></div></div></figure><p id="a35b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在，让我们打开一个新的浏览器窗口，再次尝试share.dragon-ventures.com:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mn"><img src="../Images/6a317bb5016759ba89eae37a31bbb881.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5NPkHO21ipt3LNRdi_pAgQ.png"/></div></div></figure><p id="779a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">你有它！您可以继续添加更多的容器，直到EC2实例上的容量用完，或者您也可以取下容器并快速旋转它们，以便仅在需要时开发或展示解决方案。看看5个容器和主机一起使用的资源有多少，即使只有几台计算机访问网站:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/3974938b4287d69450f3b179b5be66b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1126/format:webp/1*6rHsAKQW9kvVZQwuG0uw_A.png"/></div></figure><p id="4dce" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当然，这显然是针对小规模测试环境的，正如我之前提到的，对于高流量测试环境和大型生产环境，内部<a class="ae lq" href="https://kubernetes.io" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>或一个出色的云产品才是正确的选择！</p><p id="e0eb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">测试愉快！</p></div><div class="ab cl mp mq hx mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="im in io ip iq"><p id="1b36" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">可能有助于您探索/管理环境的其他基本命令:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="d17a" class="mc md it ly b gy me mf l mg mh"># Stop container<br/>sudo docker stop [container]</span><span id="d67d" class="mc md it ly b gy mi mf l mg mh"># Start container<br/>sudo docker start [container]</span><span id="7a2d" class="mc md it ly b gy mi mf l mg mh"># Access container shell<br/>sudo docker exec -ti [container] /bin/bash</span></pre><p id="95d4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu"> SUDO </strong>:如果你不喜欢每次执行docker命令都键入SUDO，你可以将你的用户添加到/etc/group中的docker组，注销，重新登录，然后你就可以开始运行没有sudo的docker命令了。虽然我个人更喜欢要求sudo，因为它让我在做事情之前自然地三思。除了用户偏好之外，选择一个或另一个也有一些安全问题；一个引发另一个棘手问题的话题。</p></div><div class="ab cl mp mq hx mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="im in io ip iq"><p id="deff" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这篇文章的目的是为我将来的实施提供参考，同时也是为那些需要帮助的人提供指导。更重要的是，如果有任何专家阅读这篇文章，可以指出我的逻辑缺陷，或者告诉我如何才能做得更好，以便我可以学习和改进，我将不胜感激。</p><p id="4ff5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><em class="lr">提前感谢那些会给我写信的人！</em></p></div></div>    
</body>
</html>