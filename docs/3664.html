<html>
<head>
<title>How-To: DDOS protection with Google Cloud Armor for GCP GKE Managed Istio Add-on Service</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">操作方法:GCP GKE托管Istio附加服务的Google Cloud Armor DDOS防护</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-ddos-protection-with-google-cloud-armor-for-gcp-gke-managed-istio-add-on-service-e29d42ffdb18?source=collection_archive---------2-----------------------#2020-01-27">https://itnext.io/how-to-ddos-protection-with-google-cloud-armor-for-gcp-gke-managed-istio-add-on-service-e29d42ffdb18?source=collection_archive---------2-----------------------#2020-01-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="3261" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我在之前的<a class="ae kp" href="https://medium.com/contino-engineering/istio-proxy-ingress-ssl-certificate-integration-the-old-fashioned-way-no-sds-d4a740f48cdf" rel="noopener">博文中确实提到过“<code class="fe kl km kn ko b">part deux'</code>即将到来——代理入口SSL证书集成的老式方式(无SDS)</a>——所以就在这里。</p><p id="3549" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">起初，你用容器和<code class="fe kl km kn ko b">this is it!</code>工作，然后你发现了Kubernetes的新世界，然后<code class="fe kl km kn ko b">this</code>又变成了<code class="fe kl km kn ko b">it</code>。现在，添加Istio服务网格的“类固醇”,我们正在将整个系统端到端地与谷歌云集成，试图拼凑出我们如何才能做到两全其美。很简单，对吧？</p><p id="e305" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好吧，剧透一下，这很管用。喝杯咖啡，这会很有趣的，我保证。</p><h1 id="a32b" class="kq kr iq bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">HTTP(S)负载平衡器GKE入口+ Istio (NEG) + SSL管理器集成</h1><p id="e743" class="pw-post-body-paragraph jn jo iq jp b jq lo js jt ju lp jw jx jy lq ka kb kc lr ke kf kg ls ki kj kk ij bi translated">因为这是一个跨越多个特性和产品的相当复杂的集成，所以让我们包括一些相关的关键字，以便更容易地发现，正如我们所谈到的；<br/> - HTTP(S)负载均衡器<br/> - GKE GCE入口控制器<br/> -用于GKE(GCE)入口控制器的Backend config<br/>-cloud armor+用于Istio (NEG)的WAF保护<br/> -作为HTTP(S)后端的Istio Ingressgatway集成<br/>-Istio Ingres gateway+virtual service；运行状况检查和应用流量路由</p><p id="43a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的目标是在GKE集群上配置Istio Ingressgateway(托管或非托管),作为Google HTTP(S)负载平衡器的后端(NEG)。<br/>通过这样做，我们能够从<a class="ae kp" href="https://cloud.google.com/kubernetes-engine/docs/concepts/backendconfig" rel="noopener ugc nofollow" target="_blank"> BackendConfig </a>配置特性中受益，其中一个特性允许我们在边缘启用<a class="ae kp" href="https://cloud.google.com/armor/" rel="noopener ugc nofollow" target="_blank">ClourArmor</a>Google security附加产品，该产品提供企业DDoS防御。</p><p id="4682" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">这种完全集成将使这种设置具有:</strong></p><ul class=""><li id="810d" class="lt lu iq jp b jq jr ju jv jy lv kc lw kg lx kk ly lz ma mb bi translated">GCE负载平衡器(非Istio入口网关)的完全SSL端接</li><li id="3100" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">任播IP</li><li id="587b" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">完整的Istio Mesh具有集成、数据包路由、流量控制和发布管理功能</li><li id="8d6f" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">云装甲支持、DDoS防护+ WAF特性</li><li id="5fc4" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">云身份感知代理</li><li id="ad75" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">更多信息，请再次参见<a class="ae kp" href="https://cloud.google.com/kubernetes-engine/docs/concepts/backendconfig" rel="noopener ugc nofollow" target="_blank"> Backendconfig </a></li></ul><p id="896e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这需要配置HTTP(s)负载平衡器并配置Istio以通过GKE (gce)入口接受流量，以及相关的<a class="ae kp" href="https://cloud.google.com/kubernetes-engine/docs/concepts/backendconfig" rel="noopener ugc nofollow" target="_blank"> BackendConfig </a> <br/>除了CloudArmor功能，还有其他额外的好处，因为您可以使用BackendConfig来配置HTTP(S)负载平衡的这些功能:</p><p id="da6e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">- <a class="ae kp" href="https://cloud.google.com/kubernetes-engine/docs/how-to/cdn-backendconfig" rel="noopener ugc nofollow" target="_blank">云CDN </a> <br/> - <a class="ae kp" href="https://cloud.google.com/iap/docs/enabling-kubernetes-howto" rel="noopener ugc nofollow" target="_blank">身份感知代理(IAP) </a> <br/> - <a class="ae kp" href="https://cloud.google.com/kubernetes-engine/docs/how-to/configure-backend-service" rel="noopener ugc nofollow" target="_blank">超时、连接清空超时、会话关联</a></p><p id="657d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这不同于默认的Istio服务网格模型实现，后者提供了<code class="fe kl km kn ko b">service</code>类型，而不是传统的<code class="fe kl km kn ko b">ingress</code>。</p><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi mh"><img src="../Images/da51fdb6a0ed8d2033daf9fdf53fa818.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5rAfynXSz4G4kdIT.png"/></div></div></figure><p id="3ec7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个有效的双重过滤，双重安全设置，在每个独立的层工作。</p><p id="78fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦你考虑到Istio服务网格，<code class="fe kl km kn ko b">Ingress</code>类型就不再是Istio的BAU选项。Istio入口网关服务实际上是一个<code class="fe kl km kn ko b">LoadBalancer</code>类型的<code class="fe kl km kn ko b">service</code>。<br/>这可以和经典的<code class="fe kl km kn ko b">HorizontalPodAutoscaler </code>一起在BAU工作，但是，这导致了谷歌控制台内不兼容的服务供应，因此像<strong class="jp ir">云装甲/WAF、IAP </strong>这样的附加产品是不可能的。</p><p id="05de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">通过5个“简单”步骤实现操作目标的行动清单:</strong></p><ul class=""><li id="48ac" class="lt lu iq jp b jq jr ju jv jy lv kc lw kg lx kk ly lz ma mb bi translated">创建启用了云运行和Istio的GKE集群</li><li id="89bd" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">创建一个Istio虚拟服务来处理运行状况检查请求</li><li id="22ed" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">修改Istio入口网关的Kubernetes服务对象，以便它可以由Kubernetes入口对象公开</li><li id="3b18" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">通过创建Kubernetes入口对象来配置HTTP(S)负载平衡</li><li id="2ac8" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">部署一个示例Nginx服务来验证解决方案。</li></ul><p id="a4de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是应得的荣誉——这个实现的灵感来自Google文档中关于使用Istio和CloudRun实现HTTP(S)负载平衡器的内容<a class="ae kp" href="https://cloud.google.com/solutions/integrating-https-load-balancing-with-istio-and-cloud-run-for-anthos-deployed-on-gke" rel="noopener ugc nofollow" target="_blank"/></p><h1 id="6d93" class="kq kr iq bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">深入了解它们辉煌细节的每一步</h1><ul class=""><li id="d19a" class="lt lu iq jp b jq lo ju lp jy mt kc mu kg mv kk ly lz ma mb bi translated">启用<strong class="jp ir"> HttpLoadBalancing </strong>和<strong class="jp ir"> Istio附加组件</strong>来配置您的GKE集群</li><li id="e596" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated"><a class="ae kp" href="https://medium.com/contino-engineering/how-to-kubernetes-application-deployment-with-dns-management-ddf63b559b67" rel="noopener">部署DNS管理器</a>——像以前的帖子一样，消除DNS管理的辛劳。也因为我们可以。</li><li id="a067" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated"><a class="ae kp" href="https://medium.com/contino-engineering/how-to-automatic-ssl-certificate-management-for-your-kubernetes-application-deployment-94b64dfc9114" rel="noopener"> SSL管理器—如何指导部署cert-manager </a>，并使用ACME DNS验证来加密CA以颁发证书</li></ul><p id="4c58" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将GKE入口配置为与Istio Ingres Gateway一起工作，作为NEG后端+ BackendConfig，代理到Istio入口网关pod、NEGs Healtchecks。然后，另一个虚拟服务映射到达我们的演示Nginx应用程序:</p><ul class=""><li id="dc97" class="lt lu iq jp b jq jr ju jv jy lv kc lw kg lx kk ly lz ma mb bi translated">保留静态IP —因为应该是相关的</li><li id="6abe" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">配置云防护策略——任何“阻止我的IP”试验都可以</li></ul><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/4a121b05e981519fb90773ccf663b73e.png" data-original-src="https://miro.medium.com/v2/resize:fit:926/format:webp/0*D9q3NEpkh2Few_LV.png"/></div></figure><ul class=""><li id="b082" class="lt lu iq jp b jq jr ju jv jy lv kc lw kg lx kk ly lz ma mb bi translated">“BackendConfig”中的上述引用</li></ul><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi mx"><img src="../Images/b15bd671b016d360c446eb8fa7acebf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uxqfC5i2i1tzcEz-.png"/></div></div></figure><ul class=""><li id="c892" class="lt lu iq jp b jq jr ju jv jy lv kc lw kg lx kk ly lz ma mb bi translated">修补Istio Ingressgateway服务，使其对本次配置更新更加友好。值得指出的是，<code class="fe kl km kn ko b">service</code>将从<code class="fe kl km kn ko b">loadbalancer</code>类型变成<code class="fe kl km kn ko b">NodePort</code>类型。</li></ul><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi my"><img src="../Images/4c59e645c2737a74abcecfb8ffc84d5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*J9umm0mVCGlVqTEL.png"/></div></div></figure><p id="ec7d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">复制粘贴JSON</p><pre class="mi mj mk ml gt mz ko na nb aw nc bi"><span id="d9a9" class="nd kr iq ko b gy ne nf l ng nh">[  {    "op": "add",    "path": "/metadata/annotations/cloud.google.com~1neg",    "value": "{\"ingress\": true}"  },  {    "op": "replace",    "path": "/spec/type",    "value": "NodePort"  },  {    "op": "remove",    "path": "/status"  },  {    "op": "add",    "path": "/metadata/annotations/beta.cloud.google.com~1backend-config",    "value": "{\"ports\": {\"80\":\"cloudarmor-staging-test\"}}"  }]</span></pre><ul class=""><li id="a9ce" class="lt lu iq jp b jq jr ju jv jy lv kc lw kg lx kk ly lz ma mb bi translated">配置VirtualService来调整和接受LB <strong class="jp ir">健康检查</strong>对NEG(Istio Ingres gateway PODs)的调用。如果没有这个HTTP(S ),负载平衡器将永远无法正常运行，因此不会有流量转发到后端——Istio Ingres gateway作为我们的NEGs</li></ul><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi ni"><img src="../Images/63ce110f016475cd4ecf3100c61e1cdc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*54Bkk2mbW_5zyv4h.png"/></div></div></figure><p id="26dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">HTTP(S)负载平衡器必须将NEG标记为就绪—这是Istio Ingressgateway Pod</p><ul class=""><li id="97ba" class="lt lu iq jp b jq jr ju jv jy lv kc lw kg lx kk ly lz ma mb bi translated">如果相关，使用TLS机密配置(GCE)入口。您可以在下面参考它，因为<strong class="jp ir">证书管理器</strong>和<strong class="jp ir">外部dns </strong>应该在您的集群上运行，保留dns条目并在必要时颁发证书。</li></ul><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi nj"><img src="../Images/4a5c6c4c50369d5893ec434dbc2b1a61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7RW3FoiKqyX52Fl-.png"/></div></div></figure><p id="c77c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">默认后端为istio-Ingres gateway。</p><ul class=""><li id="582a" class="lt lu iq jp b jq jr ju jv jy lv kc lw kg lx kk ly lz ma mb bi translated">部署Nginx演示服务进行测试</li></ul><p id="a7d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kl km kn ko b">kubectl run nginx --image=nginx &amp;&amp; k expose deploy/nginx --name nginx --type ClusterIP --port 80 --target-port 80</code></p><ul class=""><li id="c5e6" class="lt lu iq jp b jq jr ju jv jy lv kc lw kg lx kk ly lz ma mb bi translated">创建一个单独的VirtualService，将域请求路由到专用的Nginx演示服务。</li></ul><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi nk"><img src="../Images/11dfb4cd6f1f95f33b227e4d8efefb54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*loc15JhZdZt4bvx_.png"/></div></div></figure><p id="1906" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一个虚拟服务路由配置，基于主机将流量重定向到我提供的虚拟<strong class="jp ir"> nginx </strong>服务- &gt;部署</p><p id="18af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.将自己的IP地址列入黑名单，测试<a class="ae kp" href="https://cloud.google.com/armor/docs/configure-security-policies" rel="noopener ugc nofollow" target="_blank">云装甲策略</a>！</p><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi nl"><img src="../Images/9b63046aae6d3480af75b78094430639.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qmVLxJfIKgdLUXE7.png"/></div></div></figure><p id="ff37" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">希望你喜欢这个。喜欢读书吗？</p><p id="8313" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">喜欢，鼓掌，一起分享这篇帖子！</strong></p><p id="544d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">加入对话。<strong class="jp ir"># Kubernetes-users</strong><a class="ae kp" href="https://kubernetes.slack.com/?redir=%2Fmessages%2Fkubernetes-users%2F" rel="noopener ugc nofollow" target="_blank">Kubernetes slack group</a>见</p><p id="68d2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> PS </strong>在<strong class="jp ir"> Contino </strong>有很多激动人心的Kubernetes项目正在进行。如果您正在寻找最新最棒的基础设施堆栈，或者正在寻找挑战，请联系我们！我们正在招聘，寻找各个层次的聪明人。在<strong class="jp ir"> Contino </strong>，我们自豪地为中型企业和大型企业提供最佳实践云转型项目。</p><p id="c90f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">地方官</p><h1 id="13ba" class="kq kr iq bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">顺便说一下，👏🏻*鼓掌*👏🏻如果你喜欢这篇文章，请举手(高达50倍)。它鼓励我继续写作，并帮助其他人找到它:)</h1></div></div>    
</body>
</html>