<html>
<head>
<title>How I reversed a NodeJS malware and found the author</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何逆转一个NodeJS恶意软件并找到作者</h1>
<blockquote>原文：<a href="https://itnext.io/how-i-reversed-a-nodejs-malware-and-found-the-author-7dd9531b389f?source=collection_archive---------0-----------------------#2022-01-30">https://itnext.io/how-i-reversed-a-nodejs-malware-and-found-the-author-7dd9531b389f?source=collection_archive---------0-----------------------#2022-01-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/843b8e3b721e40e95db1f4a7f625c399.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G4BpdI7ghuas3slz0ygdIw.jpeg"/></div></div></figure><div class=""/><p id="f1b8" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">给一点背景，我是一个关于开发的小服务器上的不和谐管理员，我们最近从我们的一个用户那里得到一个报告，有人试图让他下载一个EXE文件。</p><p id="fb54" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我做的第一件事是问记者他是否打开了文件，他回答说他打开了。他告诉我这个程序打开了几秒钟的控制台提示，然后退出了。大多数时候，当你从一个不可信的来源下载了一个文件时，这并不好…</p><p id="7516" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">所以我抓起我的电脑，下载了这个文件(我把它下载在一个Linux虚拟机上，所以如果它以某种方式被感染，我可以删除这个虚拟机)。<strong class="kd jf">调查时间到了。</strong></p><h1 id="ff45" class="kz la je bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">确定二进制文件的种类</h1><p id="756b" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">我的第一个想法是查找这个可执行文件中的内容。为此，我像这样使用了<code class="fe mc md me mf b">strings</code>命令:</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="0813" class="mo la je mf b gy mp mq l mr ms">&gt; strings file.exe</span></pre><p id="c5f1" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mc md me mf b">strings</code>命令在二进制文件中查找可打印的字符串。查看文件中嵌入的任何字符串(如URL或地址)会很有帮助。</p><p id="a353" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">大多数结果都是乱码，但是在某个时候，我看到了<code class="fe mc md me mf b">NodeRuntime</code>。我们现在可以说它是一个NodeJS捆绑的可执行文件！</p><p id="e33f" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这种可执行文件中，源代码总是出现在<code class="fe mc md me mf b">strings</code>输出的末尾。让我们来看看这些来源:</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="b9cd" class="mo la je mf b gy mp mq l mr ms">function a0_0x47b121(_0x44bb58,_0x4e9d60,_0x355d77,_0x4e9d34,_0x1a193e){return a0_0x1b80(_0x1a193e- -0x1e4,_0x44bb58);</span></pre><p id="3c06" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在很长的一行上，代码看起来模糊不清，被缩小了…</p><p id="5791" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我应用了下面的方法来理解混淆代码背后的逻辑。</p><h1 id="83c3" class="kz la je bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">第一种方法:不和谐</h1><p id="04a9" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">我知道这个二进制文件是通过Discord DMs分发的，所以我用grep查看代码中是否包含Discord这个词。答对了。</p><p id="10f7" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">几个函数包含了<code class="fe mc md me mf b">discord</code>这个词:<code class="fe mc md me mf b">listDiscords</code>、<code class="fe mc md me mf b">startDiscord</code>、<code class="fe mc md me mf b">killDiscord</code>、<code class="fe mc md me mf b">pwnBetterDiscord</code>。这最后一个功能看起来很有前途。</p><p id="c1e6" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我在Google和Github上查找<code class="fe mc md me mf b">pwnBetterDiscord</code>，找到了工具的来源:<a class="ae mt" href="https://github.com/Stanley-GF/PirateStealer" rel="noopener ugc nofollow" target="_blank">https://github.com/Stanley-GF/PirateStealer</a>。</p><h2 id="3789" class="mo la je bd lb mu mv dn lf mw mx dp lj km my mz ln kq na nb lr ku nc nd lv ne bi translated">盗版者</h2><p id="d07e" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">我们已经找到了捆绑应用中使用的源代码。让我们来看看。</p><p id="e0da" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">它从discord客户端窃取所有可以找到的信息，首先杀死Discord客户端，并用Javascript有效负载修补它，通过Discord webhook(一个可以向Discord服务器发送消息的URL)泄漏Discord凭据和信用卡信息等私人信息。</p><p id="6ad9" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">作者声称该工具仅用于教育目的，但他也出售高级功能和支持？这看起来不像是一个正义的“教育目的”主张…</p><h1 id="6a33" class="kz la je bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">从模糊代码中查找webhook URL</h1><p id="24db" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">代码中充满了许多试图混淆对主字符串混淆函数的访问的代理函数。多亏代码没有被完全混淆，我们才能找到<code class="fe mc md me mf b">webhook=a0_0x78da73(0x331,0x342,0x32c,0x2f1,0x324)</code>。让我们来玩一个游戏，提取所有需要破译这个代码的方法。为了简洁起见，我将把所有模糊函数重命名为<code class="fe mc md me mf b">fn1</code>、<code class="fe mc md me mf b">fn2</code> …以及它们的参数<code class="fe mc md me mf b">p1</code>、<code class="fe mc md me mf b">p2</code> …</p><p id="3765" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mc md me mf b">a0_0x78da73</code>(姑且称之为<code class="fe mc md me mf b">fn1</code>)接受5个参数，但它只关心第一个和最后一个:</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="7e6c" class="mo la je mf b gy mp mq l mr ms"><strong class="mf jf">function</strong> fn1(p1,p2,p3,p4,p5){return fn2(p5 - 0x26a,p1);}</span></pre><p id="76ac" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mc md me mf b">fn2</code>更复杂，有初始化向量和复杂的旋转，但是我们可以通过直接调用这个函数来绕过复杂性。就这么办吧！</p><p id="10f5" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我创建了一个名为<code class="fe mc md me mf b">find_webhook.js</code>的新文件，它复制了运行fn2和<code class="fe mc md me mf b">console.log(fn2(0x324 — 0x26a, 0x331)),</code>所需的代码……我们有了！输出为<code class="fe mc md me mf b">https://ptb.discord.com/api/webhooks/abcdefg/hijklmn</code>(出于保密原因，输出被审查)。</p><h2 id="98ec" class="mo la je bd lb mu mv dn lf mw mx dp lj km my mz ln kq na nb lr ku nc nd lv ne bi translated">查找脚本的用户</h2><p id="abfc" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">然后我用webhook给他们发消息，告诉他们我知道他们在做什么，并告诉他们用我的不和谐ID给我发DM，希望他们会回答我。他们做到了！</p><p id="9230" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">从那以后，没有更多的话要说，讨论不是很有成效，但至少我可以告诉我们共有的其他服务器，坏人也在他们的服务器上。</p><p id="8408" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我希望这篇文章能鼓励人们在从不可信的来源下载可执行文件时更加谨慎，并帮助其他人了解我们如何逆转现在越来越多使用的NodeJS恶意软件。</p><p id="e2ff" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你有任何建议或意见，不要犹豫，把它们贴在评论区，我会尽力回答。</p><p id="875e" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">另外，不要忘记关注，因为我将继续发布更多关于这个黑客和电子的高级主题。</p><p id="7b16" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你喜欢这篇文章，请考虑留下你的反馈。这种文章需要很长时间准备(除了我的日常工作，几乎有一周)，所以如果你想支持我，你可以在这里订阅<a class="ae mt" href="https://medium.com/@devops-guy/membership" rel="noopener">Medium membership</a>。这也给了你无限的媒体访问权。</p></div></div>    
</body>
</html>