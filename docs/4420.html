<html>
<head>
<title>How to use MongoDB Change Streams [Part 1]</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用MongoDB变更流[第1部分]</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-use-mongodb-change-streams-part-1-da9a5e94ba2?source=collection_archive---------4-----------------------#2020-06-26">https://itnext.io/how-to-use-mongodb-change-streams-part-1-da9a5e94ba2?source=collection_archive---------4-----------------------#2020-06-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="290f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇博文演示了如何将<code class="fe kl km kn ko b">MongoDB</code>中的<code class="fe kl km kn ko b"><a class="ae kp" href="https://docs.mongodb.com/manual/changeStreams/" rel="noopener ugc nofollow" target="_blank">Change Streams</a></code>与<a class="ae kp" href="https://pkg.go.dev/go.mongodb.org/mongo-driver/mongo" rel="noopener ugc nofollow" target="_blank">官方Go驱动程序</a>一起使用。我将使用<code class="fe kl km kn ko b"><a class="ae kp" href="https://docs.microsoft.com/azure/cosmos-db/introduction?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">Azure Cosmos DB</a></code>，因为它有对MongoDB API (服务器版本3.6)的<a class="ae kp" href="https://docs.microsoft.com/azure/cosmos-db/mongodb-feature-support-36?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">有线协议支持，其中也包括变更流。</a></p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi kq"><img src="../Images/74527f1eb263ffeb5f7f83b9b946bc76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4LEf5GmDfVWRs-wT.png"/></div></div></figure><p id="98c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">和我的其他一些博客一样，我打算把它分成两部分，只是为了更容易消化这些材料。第1部分(本文)将提供变更流处理器服务的介绍和概述，并引导您如何运行该应用程序，以便您可以见证变更流的运行。</p><p id="b9d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在第2部分中，我将检查代码并解释事情是如何在幕后工作的。</p><blockquote class="lc ld le"><p id="86ef" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq">代码在</em> <a class="ae kp" href="https://github.com/abhirockzz/mongodb-changestreams-processor" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> GitHub </em> </a>上有</p></blockquote><p id="325a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过这些博客，在实际应用的帮助下，您将了解到:</p><ul class=""><li id="9fc8" class="lj lk iq jp b jq jr ju jv jy ll kc lm kg ln kk lo lp lq lr bi translated"><code class="fe kl km kn ko b">Change Streams</code>及相关概念</li><li id="b309" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">了解应用程序及其如何使用变更流API</li><li id="de17" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">设置Azure Cosmos DB并完成端到端示例</li><li id="7b4e" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">了解一些你应该知道的极限情况/限制/约束</li></ul></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="3664" class="me mf iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">什么是变更流？</h1><p id="5dbb" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated"><a class="ae kp" href="https://docs.mongodb.com/manual/changeStreams/" rel="noopener ugc nofollow" target="_blank"> MongoDB更改流</a>特性为应用程序提供了对数据更改(创建、更新、删除)的即时访问。他们可以通过在全局(部署)、数据库或集合范围订阅这些更改来对这些更改做出反应。这可以用于各种解决方案，从传统的ETL作业到基于<code class="fe kl km kn ko b"><a class="ae kp" href="https://docs.microsoft.com/azure/architecture/patterns/cqrs?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">CQRS</a></code> <a class="ae kp" href="https://docs.microsoft.com/azure/architecture/patterns/cqrs?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">(命令和查询责任分离)</a>的架构、实时流处理、缓存失效等等！</p><blockquote class="lc ld le"><p id="f44a" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq">这将开发者从使用MongoDB </em> <code class="fe kl km kn ko b"><em class="iq">oplog</em></code>的复杂性中抽象出来</p></blockquote><h2 id="de39" class="nh mf iq bd mg ni nj dn mk nk nl dp mo jy nm nn ms kc no np mw kg nq nr na ns bi translated">它们为什么有用？</h2><p id="1375" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">您可以利用变更流的许多方式之一是构建一个定制的解决方案，该解决方案可以侦听MongoDB数据库变更事件，并将它们推送到一个可扩展的数据接收平台，例如用于Kafka的<a class="ae kp" href="https://docs.microsoft.com/azure/event-hubs/event-hubs-for-kafka-ecosystem-overview?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">Azure Event Hubs</a>。然后，您可以构建传统的Kafka客户端应用程序(消费者、流API)或使用<a class="ae kp" href="https://docs.microsoft.com/azure/azure-functions/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure函数</a>(类似于这个)利用无服务器处理</p><p id="aecf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我可能会在博客上发表其他场景及其各自的解决方案，作为后续文章。</p><blockquote class="lc ld le"><p id="9506" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq">在撰写本文时，Azure Cosmos DB支持与</em> <a class="ae kp" href="https://docs.microsoft.com/azure/azure-functions/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> Azure函数</em> </a> <em class="iq">的变更流集成，用于其</em> <code class="fe kl km kn ko b"><a class="ae kp" href="https://docs.microsoft.com/azure/azure-functions/functions-bindings-cosmosdb?toc=/azure/cosmos-db/toc.json&amp;bc=/azure/cosmos-db/breadcrumb/toc.json&amp;tabs=csharp&amp;WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"><em class="iq">SQL API</em></a></code></p></blockquote></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="991d" class="me mf iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">变更处理器服务的快速概述</h1><p id="c3a0" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">该应用程序是使用变更流功能的变更处理器服务。这是一个使用官方MongoDB Go驱动程序的<code class="fe kl km kn ko b"><a class="ae kp" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank">Go</a></code>应用程序，但是其概念应该适用于任何其本地驱动程序支持变更流的其他语言。</p><p id="e607" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它使用<code class="fe kl km kn ko b"><a class="ae kp" href="https://godoc.org/go.mongodb.org/mongo-driver/mongo#Collection.Watch" rel="noopener ugc nofollow" target="_blank">Watch</a></code> <a class="ae kp" href="https://godoc.org/go.mongodb.org/mongo-driver/mongo#Collection.Watch" rel="noopener ugc nofollow" target="_blank"> API </a>来订阅特定<code class="fe kl km kn ko b">Collection</code>中的变更事件提要，以便在创建、更新和删除文档时得到通知。它从变更事件有效负载(即受影响的文档)中提取相关信息，并将其保存到本地文件中。它还演示了如何使用<code class="fe kl km kn ko b">Resume Tokens</code>来保存处理进度。</p><blockquote class="lc ld le"><p id="3328" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq">虽然这个应用程序只是将变更事件保存到一个本地文件中(为了简单起见)，但是正如前面提到的，你显然可以做更多的事情！</em></p></blockquote><h2 id="456b" class="nh mf iq bd mg ni nj dn mk nk nl dp mo jy nm nn ms kc no np mw kg nq nr na ns bi translated">简历代币真的很重要…</h2><p id="9a8d" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">变更流是潜在的无限系列的记录。更改流<a class="ae kp" href="https://docs.mongodb.com/manual/changeStreams/#change-stream-resume-token" rel="noopener ugc nofollow" target="_blank">恢复令牌</a>允许您“从您停止的地方继续处理”——将其视为<code class="fe kl km kn ko b">checkpointing</code></p><blockquote class="lc ld le"><p id="8637" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq">与阿帕奇卡夫卡等系统中的</em> <code class="fe kl km kn ko b"><em class="iq">offset</em></code> <em class="iq">概念非常相似。</em></p></blockquote><p id="7b27" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果处理应用程序停止(或崩溃)，可能不希望错过在此期间发生的数据库更改。您可以使用令牌(下一节将详细介绍)来确保应用程序从它离开的地方启动，并且能够在它不运行的时间段内检测到更改事件。除此之外，如果您有一个resume令牌的历史/changelog，您可以灵活地选择其中的任何一个(就像回到过去)并从该时间点开始(重新)处理数据。</p><h2 id="c2f3" class="nh mf iq bd mg ni nj dn mk nk nl dp mo jy nm nn ms kc no np mw kg nq nr na ns bi translated">有几件事你应该知道</h2><p id="d607" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">请注意以下变更流行为与标准<code class="fe kl km kn ko b">MongoDB</code>不同的情况:</p><ul class=""><li id="79b8" class="lj lk iq jp b jq jr ju jv jy ll kc lm kg ln kk lo lp lq lr bi translated"><a class="ae kp" href="https://docs.microsoft.com/azure/cosmos-db/mongodb-change-streams?WT.mc_id=medium-blog-abhishgu#current-limitations" rel="noopener ugc nofollow" target="_blank">您需要为变更流程提供具体的选项</a></li><li id="7083" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated"><a class="ae kp" href="https://docs.microsoft.com/azure/cosmos-db/mongodb-change-streams?WT.mc_id=medium-blog-abhishgu#current-limitations" rel="noopener ugc nofollow" target="_blank">删除操作</a>目前不被支持——尽管有一个针对该的<a class="ae kp" href="https://docs.microsoft.com/azure/cosmos-db/mongodb-change-streams?WT.mc_id=medium-blog-abhishgu#examples" rel="noopener ugc nofollow" target="_blank">解决方法</a></li><li id="0d18" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">(目前)您只能观察集合(不是数据库或部署)</li></ul><p id="546e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们试用一下该应用程序，以便更好地理解变更流！</p></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="4f7e" class="me mf iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">设置Azure Cosmos DB</h1><h2 id="8e58" class="nh mf iq bd mg ni nj dn mk nk nl dp mo jy nm nn ms kc no np mw kg nq nr na ns bi translated">先决条件</h2><ul class=""><li id="8ba8" class="lj lk iq jp b jq nc ju nd jy nt kc nu kg nv kk lo lp lq lr bi translated">一个<a class="ae kp" href="https://docs.microsoft.com/azure/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">微软Azure账户</a>—<a class="ae kp" href="https://azure.microsoft.com/free/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">注册一个免费账户吧！</a></li><li id="039e" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated"><code class="fe kl km kn ko b">Azure CLI</code>或<code class="fe kl km kn ko b">Azure Cloud Shell</code> -如果你还没有安装<a class="ae kp" href="https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a>，你可以选择安装它(应该很快！)或者直接从浏览器使用<a class="ae kp" href="https://azure.microsoft.com/features/cloud-shell/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure云壳</a>。</li><li id="9be4" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated"><code class="fe kl km kn ko b"><a class="ae kp" href="https://golang.org/dl/" rel="noopener ugc nofollow" target="_blank">Go</a></code>已安装<a class="ae kp" href="https://golang.org/dl/" rel="noopener ugc nofollow" target="_blank">已安装</a></li></ul><p id="a649" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您需要创建一个启用了MongoDB API支持的Azure Cosmos DB帐户以及一个数据库和集合。按照以下步骤使用Azure门户设置Azure Cosmos DB:</p><ul class=""><li id="2214" class="lj lk iq jp b jq jr ju jv jy ll kc lm kg ln kk lo lp lq lr bi translated"><a class="ae kp" href="https://docs.microsoft.com/azure/cosmos-db/create-mongodb-java?WT.mc_id=medium-blog-abhishgu#create-a-database-account" rel="noopener ugc nofollow" target="_blank">创建一个Azure Cosmos DB帐户</a></li><li id="ccce" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated"><a class="ae kp" href="https://docs.microsoft.com/azure/cosmos-db/create-mongodb-java?WT.mc_id=medium-blog-abhishgu#add-a-collection" rel="noopener ugc nofollow" target="_blank">添加数据库和集合</a>并获取连接字符串</li></ul><blockquote class="lc ld le"><p id="caea" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq">了解有关如何在Azure Cosmos DB </em> 中使用数据库、容器和项目的更多信息 <a class="ae kp" href="https://docs.microsoft.com/azure/cosmos-db/databases-containers-items?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq"/></a></p></blockquote><p id="779d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想使用Azure CLI或云Shell，下面是你需要执行的命令序列:</p><p id="66de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kp" href="https://docs.microsoft.com/cli/azure/cosmosdb?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-cosmosdb-create" rel="noopener ugc nofollow" target="_blank">创建一个Azure Cosmos DB帐户</a>(注意<code class="fe kl km kn ko b">--kind MongoDB</code>)</p><pre class="kr ks kt ku gt nw ko nx ny aw nz bi"><span id="8129" class="nh mf iq ko b gy oa ob l oc od">az cosmosdb create --resource-group &lt;RESOURCE_GROUP&gt; --name &lt;COSMOS_DB_NAME&gt; --kind MongoDB</span></pre><p id="a91e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kp" href="https://docs.microsoft.com/cli/azure/cosmosdb/mongodb/database?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-cosmosdb-mongodb-database-create" rel="noopener ugc nofollow" target="_blank">创建数据库</a></p><pre class="kr ks kt ku gt nw ko nx ny aw nz bi"><span id="ec61" class="nh mf iq ko b gy oa ob l oc od">az cosmosdb mongodb database create --account-name &lt;COSMOS_DB_ACCOUN&gt; --name &lt;COSMOS_DB_NAME&gt; --resource-group &lt;RESOURCE_GROUP&gt;</span></pre><p id="b827" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，<a class="ae kp" href="https://docs.microsoft.com/cli/azure/cosmosdb/mongodb/collection?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-cosmosdb-mongodb-collection-create" rel="noopener ugc nofollow" target="_blank">在数据库中创建一个集合</a></p><pre class="kr ks kt ku gt nw ko nx ny aw nz bi"><span id="ff4e" class="nh mf iq ko b gy oa ob l oc od">az cosmosdb mongo collection create --account-name &lt;COSMOS_DB_ACCOUNT&gt; --database-name &lt;COSMOS_DB_NAME&gt; --name &lt;COSMOS_COLLECTION_NAME&gt; --resource-group-name &lt;RESOURCE_GROUP&gt; --shard &lt;SHARDING_KEY_PATH&gt;</span></pre><p id="1f3e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">获取连接字符串并保存它。你以后会用到它</p><pre class="kr ks kt ku gt nw ko nx ny aw nz bi"><span id="b97d" class="nh mf iq ko b gy oa ob l oc od">az cosmosdb list-connection-strings --name &lt;COSMOS_DB_ACCOUNT&gt; --resource-group &lt;RESOURCE_GROUP&gt; -o tsv --query connectionStrings[0].connectionString</span></pre></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="cbf3" class="me mf iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">尝试更换处理器服务</h1><p id="6818" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">你需要做的就是克隆GitHub repo，构建并运行服务</p><h2 id="cfa3" class="nh mf iq bd mg ni nj dn mk nk nl dp mo jy nm nn ms kc no np mw kg nq nr na ns bi translated">启动服务</h2><pre class="kr ks kt ku gt nw ko nx ny aw nz bi"><span id="cbbb" class="nh mf iq ko b gy oa ob l oc od">git clone <a class="ae kp" href="https://github.com/abhirockzz/mongodb-changestreams-processor" rel="noopener ugc nofollow" target="_blank">https://github.com/abhirockzz/mongodb-changestreams-processor</a></span><span id="ea08" class="nh mf iq ko b gy oe ob l oc od">go build -o change-processor</span></pre><p id="5773" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行应用程序之前，导出环境变量:</p><pre class="kr ks kt ku gt nw ko nx ny aw nz bi"><span id="80a5" class="nh mf iq ko b gy oa ob l oc od">export MONGODB_URI=[enter the Azure Cosmos DB connection string]<br/>export MONGODB_DATABASE=[name of the Azure Cosmos DB database you created]<br/>export MONGODB_COLLECTION=[name of the Azure Cosmos DB collection you created]<br/>export WITH_RESUME=[use false if you don't want to use resume tokens. this is true by default]</span></pre><p id="41df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如</p><pre class="kr ks kt ku gt nw ko nx ny aw nz bi"><span id="6ad3" class="nh mf iq ko b gy oa ob l oc od">export MONGODB_URI="mongodb://my-mongodb:&lt;primary access key for cosmosdb&gt;@my-mongodb.mongo.cosmos.azure.com:10255/?ssl=true&amp;replicaSet=globaldb&amp;retrywrites=false&amp;maxIdleTimeMS=120000&amp;appName=@my-mongodb@"</span><span id="b6de" class="nh mf iq ko b gy oe ob l oc od">export MONGODB_DATABASE=test_db<br/>export MONGODB_COLLECTION=test_collection<br/>export WITH_RESUME=false</span></pre><blockquote class="lc ld le"><p id="3ca8" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq">请确保</em> <code class="fe kl km kn ko b"><em class="iq">""</em></code> <em class="iq">【双引号】</em> <code class="fe kl km kn ko b"><em class="iq">MONGODB_URI</em></code></p></blockquote><p id="8e8d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动程序</p><pre class="kr ks kt ku gt nw ko nx ny aw nz bi"><span id="d305" class="nh mf iq ko b gy oa ob l oc od">./change-processor</span></pre><p id="26cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">程序启动并运行，输出如下:<code class="fe kl km kn ko b">started change stream...</code></p><h2 id="84c0" class="nh mf iq bd mg ni nj dn mk nk nl dp mo jy nm nn ms kc no np mw kg nq nr na ns bi translated">创造一些记录</h2><p id="1d64" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">连接Azure Cosmos DB执行数据库操作的方式有很多种。很明显，您可以使用您最喜欢的MongoDB语言支持以编程方式实现这一点，但是为了测试该服务，请尝试以下选项:</p><ul class=""><li id="bec9" class="lj lk iq jp b jq jr ju jv jy ll kc lm kg ln kk lo lp lq lr bi translated">Azure Cosmos DB数据浏览器(web界面)</li><li id="93d5" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated"><a class="ae kp" href="https://docs.microsoft.com/azure/cosmos-db/mongodb-robomongo?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Robo 3T采用Azure Cosmos DB的API for MongoDB </a></li><li id="dc1b" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated"><a class="ae kp" href="https://docs.microsoft.com/azure/cosmos-db/mongodb-compass?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> MongoDB Compass连接到Azure Cosmos DB的用于MongoDB的API</a></li><li id="76a6" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated"><a class="ae kp" href="https://docs.microsoft.com/azure/cosmos-db/mongodb-mongochef?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">使用Studio 3T连接到Azure Cosmos帐户</a></li></ul><p id="d613" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建记录后，您应该会在程序终端中看到以下输出:</p><pre class="kr ks kt ku gt nw ko nx ny aw nz bi"><span id="5bf7" class="nh mf iq ko b gy oa ob l oc od">saved change event to file: 'change_events'</span></pre><p id="3f7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您应该会看到<code class="fe kl km kn ko b">change_events</code>文件，其中包含已创建的文档。例如，在Azure Cosmos DB中创建的以下记录....</p><pre class="kr ks kt ku gt nw ko nx ny aw nz bi"><span id="4b2c" class="nh mf iq ko b gy oa ob l oc od">{<br/>    "name" : "foo55",<br/>    "email" : "foo55@bar.com",<br/>    "status" : "offline"<br/>}</span></pre><p id="5946" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">….将用一个<code class="fe kl km kn ko b">_id</code> (MongoDB对象ID)保存在<code class="fe kl km kn ko b">change_events</code>文件中:</p><pre class="kr ks kt ku gt nw ko nx ny aw nz bi"><span id="b8f3" class="nh mf iq ko b gy oa ob l oc od">{<br/>  "_id": {<br/>    "$oid": "5e8eec7712f1891a100bd449"<br/>  },<br/>  "name": "foo55",<br/>  "email": "foo55@bar.com",<br/>  "status": "online"<br/>}</span></pre><p id="6dc5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这只是更改事件的一部分，完整的有效负载如下所示:</p><blockquote class="lc ld le"><p id="796e" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq">变更流事件文档的顶级</em> <code class="fe kl km kn ko b"><em class="iq">_id</em></code> <em class="iq">字段充当恢复令牌(下面将详细介绍)</em></p></blockquote><pre class="kr ks kt ku gt nw ko nx ny aw nz bi"><span id="9989" class="nh mf iq ko b gy oa ob l oc od">{<br/>  "_id": {<br/>    "_data": {<br/>      "$binary": {<br/>        "base64": "W3sidG9rZW4iOiJcIjY5XCIiLCJyYW5nZSI6eyJtaW4iOiIiLCJtYXgiOiJGRiJ9fV0=",<br/>        "subType": "00"<br/>      }<br/>    }<br/>  },<br/>  "fullDocument": {<br/>    "_id": {<br/>      "$oid": "5e8eec7712f1891a100bd449"<br/>    },<br/>    "name": "foo56",<br/>    "email": "foo56@bar.com",<br/>    "status": "online"<br/>  },<br/>  "ns": {<br/>    "db": "test_db1",<br/>    "coll": "test_coll1"<br/>  },<br/>  "documentKey": {<br/>    "name": "foo56",<br/>    "_id": {<br/>      "$oid": "5e8eec7712f1891a100bd449"<br/>    }<br/>  }<br/>}</span></pre><h2 id="6439" class="nh mf iq bd mg ni nj dn mk nk nl dp mo jy nm nn ms kc no np mw kg nq nr na ns bi translated">更新记录</h2><p id="a0e5" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">例如，如果我将上述记录从<code class="fe kl km kn ko b">"status":"online"</code>更改为<code class="fe kl km kn ko b">"status":"offline"</code>，这将与更新的文档一起记录在<code class="fe kl km kn ko b">change_events</code>中</p><h2 id="9d1f" class="nh mf iq bd mg ni nj dn mk nk nl dp mo jy nm nn ms kc no np mw kg nq nr na ns bi translated">使用恢复令牌的检查点</h2><p id="ca65" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">要尝试这种方法，请停止您的应用程序(按下<code class="fe kl km kn ko b">ctrl+c</code>)。在程序终止之前，您应该会看到以下输出</p><pre class="kr ks kt ku gt nw ko nx ny aw nz bi"><span id="2cf2" class="nh mf iq ko b gy oa ob l oc od">^Cexit signalled. cancelling context<br/>saved token to file</span></pre><blockquote class="lc ld le"><p id="ad22" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq">检查一个名为</em> <code class="fe kl km kn ko b"><em class="iq">token</em></code> <em class="iq">的文件。它的内容并不重要——只要理解它就在那里，并且它包含二进制形式的resume令牌。</em></p></blockquote><p id="64ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，在变更流处理器没有运行的时候创建一些记录。一旦你这样做了，重启处理器，你应该看到你添加的记录被检测，处理并保存在<code class="fe kl km kn ko b">change_events</code>文件中。</p><h2 id="2741" class="nh mf iq bd mg ni nj dn mk nk nl dp mo jy nm nn ms kc no np mw kg nq nr na ns bi translated">删除记录</h2><p id="77a8" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated"><code class="fe kl km kn ko b"><a class="ae kp" href="https://docs.microsoft.com/azure/cosmos-db/mongodb-change-streams?WT.mc_id=medium-blog-abhishgu#current-limitations" rel="noopener ugc nofollow" target="_blank">Delete</a></code> <a class="ae kp" href="https://docs.microsoft.com/azure/cosmos-db/mongodb-change-streams?WT.mc_id=medium-blog-abhishgu#current-limitations" rel="noopener ugc nofollow" target="_blank">尚不支持</a>操作。这里建议的处理删除<a class="ae kp" href="https://docs.microsoft.com/azure/cosmos-db/mongodb-change-streams?WT.mc_id=medium-blog-abhishgu#examples" rel="noopener ugc nofollow" target="_blank">的方法之一</a>是将is视为一个<code class="fe kl km kn ko b">update</code>操作，使用一个附加属性(例如<code class="fe kl km kn ko b">deleted</code>并将其设置为<code class="fe kl km kn ko b">true</code>)并为特定文档设置一个<code class="fe kl km kn ko b">TTL</code>(生存时间)——这样，您可以将变更事件作为变更流的一部分</p><p id="2fb0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我要对样本记录进行这样的尝试，那么在<code class="fe kl km kn ko b">change_events</code>文件中应该有这样一个条目:</p><pre class="kr ks kt ku gt nw ko nx ny aw nz bi"><span id="3d3a" class="nh mf iq ko b gy oa ob l oc od">{<br/>  "_id": {<br/>    "$oid": "5e8eec7712f1891a100bd449"<br/>  },<br/>  "name": "foo55",<br/>  "email": "foo55@bar.com",<br/>  "status": "offline",<br/> <strong class="ko ir"> "deleted": true</strong><br/>}</span></pre><blockquote class="lc ld le"><p id="88fa" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq">通知</em>T9】</p></blockquote><p id="24d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好吧！目前就这些。我将在后续的博客文章(第2部分)中介绍一些实现细节</p></div></div>    
</body>
</html>