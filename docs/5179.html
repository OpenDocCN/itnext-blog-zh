<html>
<head>
<title>Upgrading to Terraform 0.14 Experience -WARNING!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">升级到Terraform 0.14体验-警告！</h1>
<blockquote>原文：<a href="https://itnext.io/upgrading-to-terraform-0-14-experience-warning-18ea3f4bc396?source=collection_archive---------0-----------------------#2021-01-04">https://itnext.io/upgrading-to-terraform-0-14-experience-warning-18ea3f4bc396?source=collection_archive---------0-----------------------#2021-01-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b427" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当假期平静下来的时候，我想我会尝试用Terraform 0.14来验证我们的模块。本文的目标是关注现有模块所需的变更，而不是全部变更。</p><p id="c591" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">HashiCorp在<a class="ae kl" href="https://www.terraform.io/upgrade-guides/0-14.html" rel="noopener ugc nofollow" target="_blank">发布了升级到Terraform v0.14的全部变更—由HashiCorp </a>发布的Terraform。</p><p id="74ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇博客中，我回顾了对提供者配置、敏感输出(这很好，但有一个阻塞错误)、更严格的linter和名为<em class="km"> alltrue </em>的新函数的更改。</p><h1 id="1554" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">提供商配置</h1><p id="8e3d" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">在Terraform 0.13中，HashiCorp引入了一种定义模块需求的新方法，如下所示:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="9a0e" class="lz ko iq lv b gy ma mb l mc md">terraform {<br/>  required_providers {<br/>    github = {<br/>      source = "hashicorp/github"<br/>      version = "4.1.0"<br/>    }<br/>  }<br/>}</span></pre><p id="34da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从0.14开始，它们为provider资源中版本的弃用铺平了道路。因此，如果您的代码中有这样的片段，您将会收到一个反对警告</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="3df2" class="lz ko iq lv b gy ma mb l mc md">provider "azurerm" {<br/>  version = "&gt;=2.17"<br/>  features {}<br/>}</span></pre><p id="2005" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">警告(原谅来自terratest的日志记录)</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="ccb7" class="lz ko iq lv b gy ma mb l mc md">TestCoreCompliance 2020-12-21T12:31:39-05:00 logger.go:66: Warning: Version constraints inside provider configuration blocks are deprecated<br/>TestCoreCompliance 2020-12-21T12:31:39-05:00 logger.go:66: <br/>TestCoreCompliance 2020-12-21T12:31:39-05:00 logger.go:66:   on ../provider.tf line 2, in provider "azurerm":<br/>TestCoreCompliance 2020-12-21T12:31:39-05:00 logger.go:66:    2:   version = "&gt;=2.17"<br/>TestCoreCompliance 2020-12-21T12:31:39-05:00 logger.go:66: <br/>TestCoreCompliance 2020-12-21T12:31:39-05:00 logger.go:66: Terraform 0.13 and earlier allowed provider version constraints inside the<br/>TestCoreCompliance 2020-12-21T12:31:39-05:00 logger.go:66: provider configuration block, but that is now deprecated and will be removed<br/>TestCoreCompliance 2020-12-21T12:31:39-05:00 logger.go:66: in a future version of Terraform. To silence this warning, move the provider<br/>TestCoreCompliance 2020-12-21T12:31:39-05:00 logger.go:66: version constraint into the required_providers block.</span></pre><p id="e0c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">准备弃用的快速解决方法是删除版本属性</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="f9ef" class="lz ko iq lv b gy ma mb l mc md">provider "azurerm" {<br/>  features {}<br/>}</span></pre><h1 id="b6b0" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">敏感输出</h1><p id="2072" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">我认为这个变化是一个很好的补充，但却是一个突破性的变化。当使用输出公开模块中的数据时，terraform允许您使用属性<strong class="jp ir"> sensitive = true </strong>将输出标记为敏感。这有效地在应用阶段从输出中隐藏了它。例如，您仍然可以使用<em class="km"> terraform output -json </em>来检索值。此外，敏感信息仍然存在于状态文件中。这种改变主要是为了让日志尽可能不包含敏感数据。</p><p id="e425" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">哈希公司已经将这种能力提升到了一个新的水平。如果任何资源或模块将其输出标记为敏感，Terraform将通过让您将输出标记为敏感来增强其敏感性。</p><p id="617d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，如果您习惯于输出一个完整的对象，如<strong class="jp ir">data . azure RM _ key _ vault _ secret</strong>，您将需要将输出标记为敏感，因为它的属性是敏感的(密钥)</p><figure class="lq lr ls lt gt mf gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi me"><img src="../Images/89d0cc9d449b2acf7f88e62546bbcb5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ciXNta8k6-IjlML68B2snw.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">输出配置示例</figcaption></figure><p id="84c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该功能的引入与依赖锁文件的引入紧密相关。依赖锁通过跟踪使用的每个模块的版本并将数据存储在名为<em class="km"> .terraform.lock.hcl </em>的文件中，允许可重复的部署。这个文件应该提交给源代码管理。有关依赖锁文件系统的全部细节，请查阅<a class="ae kl" href="https://www.terraform.io/docs/configuration/dependency-lock.html" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><blockquote class="mq mr ms"><p id="1ca1" class="jn jo km jp b jq jr js jt ju jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj kk ij bi translated">迄今为止，很少有上游模块将其输出标记为敏感。当他们开始利用这个特性时，我希望他们会相应地升级版本，因为这是一个突破性的变化。此外，您应该对上游模块进行版本控制，以确保当上游发生更改时，您可以将它们优雅地级联到您的模块输出中。</p></blockquote><p id="05b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">样本:</p><figure class="lq lr ls lt gt mf gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi mw"><img src="../Images/0a330c54a348c04abbac490de58ac9b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WxoQ2XcUMJ4tziUJP8cRBw.png"/></div></div></figure><p id="396a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，敏感值的引入有一个缺陷，当您有一个资源循环并且这些资源有敏感值时，这个缺陷就会显现出来。这会导致恐慌。因此，我们暂停了向Terraform 0.14的迁移，直到问题得到解决。</p><p id="687a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">HashiCorp的工作人员已经承认并重现了这个问题，我希望在0.14.4中会有一个修复。</p><p id="72fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">链接:<a class="ae kl" href="https://github.com/hashicorp/terraform/issues/27336" rel="noopener ugc nofollow" target="_blank">带有敏感值的for循环的模板出现混乱:“值已标记，因此必须先取消标记”问题# 27336 hashi corp/terraform(github.com)</a></p><h1 id="f51e" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">林挺改进</h1><p id="8bb0" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">我注意到林挺似乎更具侵略性。Terraform格式似乎在<em class="km">地图</em>输入变量上强制类型。它会将其更改为map(any)。参见下面的diff。</p><figure class="lq lr ls lt gt mf gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi mx"><img src="../Images/6c528d93f97c778df92010eff203d9ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tS_DqGlY0D1VRmXiOqyy6Q.png"/></div></div></figure><h1 id="130c" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">变量验证— alltrue函数</h1><p id="54aa" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">Terraform还引入了一个名为alltrue的新函数，它在输入验证中非常有用。例如，见下文:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="16b8" class="lz ko iq lv b gy ma mb l mc md">variable "network" {<br/>  description = "Network configuration object to define the CIDR ranges for the VNet and Subnets. Optionally, you can also configure a list of route tables"<br/>  type = object({<br/>    routes = optional(list(map(string)))<br/>    vnet   = list(string)<br/>    subnets = map(object({<br/>      address_prefixes    = list(string)<br/>      exclude_route_table = optional(bool)<br/>    }))<br/>  })<br/>  validation {<br/>    # The condition here identifies if the variable contains subnets outside of the expected <br/>    # "PAZ, OZ, RZ, MAZ, AzureBastionSubnet"<br/>    condition = alltrue([<br/>      for subnet in keys(var.network.subnets) :<br/>      contains(["PAZ", "OZ", "RZ", "MAZ", "AzureBastionSubnet"], subnet)<br/>    ])<br/>    error_message = "ERROR: Unexpected subnet(s) declared, expected PAZ|OZ|RZ|MAZ|AzureBastionSubnet."<br/>  }<br/>}</span></pre></div></div>    
</body>
</html>