<html>
<head>
<title>Build a voting website that doesn’t crash under load (in under an hour)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">建立一个在负载下不会崩溃的投票网站(在一个小时内)</h1>
<blockquote>原文：<a href="https://itnext.io/build-a-voting-website-that-doesnt-crash-under-load-in-under-an-hour-1c0948307773?source=collection_archive---------3-----------------------#2019-03-21">https://itnext.io/build-a-voting-website-that-doesnt-crash-under-load-in-under-an-hour-1c0948307773?source=collection_archive---------3-----------------------#2019-03-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="eef6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">高峰交通？不可预测的负载？听起来像是无服务器的工作。</em></p><p id="47bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请愿网站可能会经历需求的极端情况——当一项大众动议摆在公众面前时，不知从哪里冒出来成千上万的人。更糟糕的是，许多人在投票后留下来，按F5键浏览新的计票结果，给已经不堪重负的服务器增加了更多的负载:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="kr ks l"/></div></figure><p id="951e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的推文引用了今天英国的一篇主要新闻文章，显示了这种意外的需求如何导致自我造成的拒绝服务。我们怎样才能重新设计这个无服务器的网站，以便网站可以很快恢复呢？</p><p id="fcdd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">今天早上我给自己设定了一个挑战，要在一个小时内找到解决方案！这是我整理的。</p><h2 id="b9ff" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">第一步:投票功能。</h2><p id="e134" class="pw-post-body-paragraph jn jo iq jp b jq lm js jt ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk ij bi translated">我创建了一个空的DynamoDB表，将provisioning设置为‘On Demand’。接下来，我编写了两个函数——<strong class="jp ir">VoteYes</strong>和<strong class="jp ir">vote no</strong>——除了它们在表中增加的值之外，这两个函数是相同的:</p><pre class="km kn ko kp gt lr ls lt lu aw lv bi"><span id="ed73" class="kt ku iq ls b gy lw lx l ly lz">const AWS = require('aws-sdk')<br/>AWS.config.update({ region: process.env.REGION || 'us-east-1' })<br/>const ddb = new AWS.DynamoDB.DocumentClient()</span><span id="d4ed" class="kt ku iq ls b gy ma lx l ly lz">const params = {<br/>    TableName : "askJames-pollCounter",<br/>    Key: {<br/>        partitionKey: 'poll-001',<br/>        sortKey: 'total'<br/>    },<br/>    UpdateExpression: "set <strong class="ls ir">votesNo </strong>= <strong class="ls ir">votesNo </strong>+ :val",<br/>    ExpressionAttributeValues:{<br/>        ":val": 1<br/>    },<br/>    ReturnValues:"UPDATED_NEW"<br/>}</span><span id="8bab" class="kt ku iq ls b gy ma lx l ly lz">exports.handler = async (event) =&gt; {<br/>    return {<br/>        statusCode: 200,<br/>        isBase64Encoded: false,<br/>        headers: {<br/>            "Access-Control-Allow-Origin": "*"<br/>        },<br/>        body: JSON.stringify(await updateDynamoDB(params)),<br/>    }<br/>}</span><span id="0504" class="kt ku iq ls b gy ma lx l ly lz">const updateDynamoDB = async (params) =&gt; {<br/>    return new Promise((resolve, reject) =&gt; {<br/>        ddb.update(params, function (err, data) {<br/>            if (err) {<br/>                console.error('updateDynamoDB', err)<br/>                reject(err)<br/>            } else {<br/>                console.log('updateDynamoDB: ', data)<br/>                resolve(data)<br/>            }<br/>        })<br/>  })<br/>}</span></pre><p id="65d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我创建了一个<strong class="jp ir"> getVotes </strong>函数，该函数返回计数的摘要:</p><pre class="km kn ko kp gt lr ls lt lu aw lv bi"><span id="932b" class="kt ku iq ls b gy lw lx l ly lz">const AWS = require('aws-sdk')<br/>AWS.config.update({ region: process.env.REGION || 'us-east-1' })<br/>const ddb = new AWS.DynamoDB.DocumentClient()</span><span id="e3d3" class="kt ku iq ls b gy ma lx l ly lz">const params = {<br/>    TableName : "askJames-pollCounter",<br/>    Key: {<br/>        partitionKey: 'poll-001',<br/>        sortKey: 'total'<br/>    }<br/>}</span><span id="fce8" class="kt ku iq ls b gy ma lx l ly lz">exports.handler = async (event) =&gt; {<br/>    return {<br/>        statusCode: 200,<br/>        isBase64Encoded: false,<br/>        headers: {<br/>            "Access-Control-Allow-Origin": "*"<br/>        },<br/>        body: JSON.stringify(await updateDynamoDB(params)),<br/>    }<br/>}</span><span id="0b42" class="kt ku iq ls b gy ma lx l ly lz">const updateDynamoDB = async (params) =&gt; {<br/>    return new Promise((resolve, reject) =&gt; {<br/>        ddb.get(params, function (err, data) {<br/>            if (err) {<br/>                console.error('updateDynamoDB', err)<br/>                reject(err)<br/>            } else {<br/>                console.log('updateDynamoDB: ', data)<br/>                resolve(data)<br/>            }<br/>        })<br/>  })<br/>}</span></pre><p id="47b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我在API Gateway中将它们连接起来，以便我的前端可以调用它们:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mb"><img src="../Images/5cc13e950578665391d04f3085f68366.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yuUqX0XMPsY9sBcWdDdwRw.png"/></div></div></figure><p id="93a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个练习已经进行了20分钟，让我们对这些功能进行负载测试。使用<a class="ae mi" href="https://artillery.io/" rel="noopener ugc nofollow" target="_blank">大炮</a>，我模拟20个用户每秒钟点击API端点一分钟(每天170万次投票):</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/565e396ffafa072cb5fdf0b7b20f9e8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*zeAGzMQG9xkKnojuHp23mA.png"/></div></figure><p id="2be2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我调高了数值，又试了几次，都没有问题。</p><p id="ce22" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">200个状态代码显示每次测试100%成功执行。在另一个函数上运行这个负载测试，然后检查我的DynamoDB表:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/22a10619d08325a008891c64c2a0dde5.png" data-original-src="https://miro.medium.com/v2/resize:fit:978/format:webp/1*-NWIINx84oVK0yO5uU34Cw.png"/></div></figure><h2 id="d623" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">第二步:构建快速前端。</h2><p id="639c" class="pw-post-body-paragraph jn jo iq jp b jq lm js jt ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk ij bi translated">我建立了一个普通的Vue项目(<code class="fe ml mm mn ls b">vue create poll-counter</code>)，添加了vue-bootstrap和Axios，然后构建了一个带有一些投票按钮的简单页面:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mo"><img src="../Images/9b701af2a0826c6f70ce78496e10b26d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r_kP7suKnSpnPsHDoQM-CA.png"/></div></div></figure><p id="9768" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我连接投票按钮并设置一个刷新计时器，这样页面将每5秒更新一次投票计数:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/e5b6bc0d9bd460aec0971c2c96b742fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/1*h-sH4Q31Nwz6jwOi7-vy3A.png"/></div></figure><p id="192d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">之后，我<code class="fe ml mm mn ls b">npm run build</code>并复制结果的dist文件夹到一个启用静态网站托管的S3桶中:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mq"><img src="../Images/a109839d4b8b93c5ba7a004f13bef5f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xSkSQgdBuswWY7dAlKFsWw.png"/></div></div></figure><p id="9618" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我配置了一个指向这个bucket的CloudFront发行版和一个自定义域名——大约15分钟后，我们就上线了。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mr"><img src="../Images/b3bf860331e4958d4a28636c111e0f8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p6WI4kLhs5Seyd_GakydXw.png"/></div></div></figure><p id="8e98" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在<a class="ae mi" href="https://vote.jbes.dev/" rel="noopener ugc nofollow" target="_blank">https://vote.jbes.dev/</a>测试这个页面，在<a class="ae mi" href="https://gitlab.com/jbesw/askjames-pollcounter-vue" rel="noopener ugc nofollow" target="_blank">https://gitlab.com/jbesw/askjames-pollcounter-vue</a>从GitLab下载代码回购。</p><h2 id="9b95" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">最后的想法</h2><p id="f206" class="pw-post-body-paragraph jn jo iq jp b jq lm js jt ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk ij bi translated">无服务器非常适合这种解决方案。首先，前端是通过CloudFront从一个S3桶加载的，因此可以承受几乎无限数量的用户。</p><p id="6fa8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">API Gateway可扩展到每秒数亿次调用，并且仅受您的预算限制。实际上，我的AWS帐户的软限制将是主要瓶颈，但可以通过致电支持来解除这些限制。</p><p id="36a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">DynamoDB使用原子计数器维护投票计数的状态。我的解决方案中根本没有缓存，但在整个设计中可以在多个级别应用缓存，以提高性能并降低成本。</p><p id="b167" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它就在那里！一个小时，大约200行代码——一个可大规模扩展的投票平台，为黄金时段做好了准备。</p></div></div>    
</body>
</html>