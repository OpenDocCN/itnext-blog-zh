<html>
<head>
<title>Running Cilium CNI Plugin on OpenShift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在OpenShift上运行纤毛CNI插件</h1>
<blockquote>原文：<a href="https://itnext.io/running-cilium-cni-plugin-on-openshift-f161b9411400?source=collection_archive---------4-----------------------#2021-10-04">https://itnext.io/running-cilium-cni-plugin-on-openshift-f161b9411400?source=collection_archive---------4-----------------------#2021-10-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/75a3b52a447a11587149f7b457c0826b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vkL3aRe1KZ6uFYGm.jpg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><em class="kf">图像由</em> <a class="ae kg" href="https://pixabay.com/users/pollydot-160618/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=352206" rel="noopener ugc nofollow" target="_blank"> <em class="kf"> PollyDot </em> </a> <em class="kf">从</em> <a class="ae kg" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=352206" rel="noopener ugc nofollow" target="_blank"> <em class="kf"> Pixabay </em> </a></figcaption></figure><p id="4214" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">Cilium是OpenShift上<a class="ae kg" href="https://access.redhat.com/articles/5436171" rel="noopener ugc nofollow" target="_blank">认证的CNI插件</a>之一。它由Linux内核eBPF技术提供支持，不仅为Kubernetes提供了网络，还支持对应用程序透明的内核的可观察性和安全性控制。</p><p id="a9c5" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">这篇文章分享了我在OpenShift上对纤毛设置的探索。</p><h2 id="760a" class="lf lg it bd lh li lj dn lk ll lm dp ln ks lo lp lq kw lr ls lt la lu lv lw lx bi translated">OCP集群设置</h2><p id="2c39" class="pw-post-body-paragraph kh ki it kj b kk ly km kn ko lz kq kr ks ma ku kv kw mb ky kz la mc lc ld le im bi translated">Cilium CNI插件必须在集群设置期间安装。例如，必须在install-config.yaml中将网络类型更改为Cilium，</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="3177" class="lf lg it mi b gy mm mn l mo mp">...<br/>networking:<br/>  clusterNetwork:<br/>  - cidr: 10.128.0.0/14<br/>    hostPrefix: 23<br/>  <strong class="mi iu">networkType: Cilium</strong><br/>  serviceNetwork:<br/>  - 172.30.0.0/16<br/>...</span></pre><p id="9236" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">我们需要为集群添加一些自定义的纤毛资源。</p><p id="fe88" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">让我们首先创建清单，假设我们在复制了install-config.yaml的ocp-install目录中工作。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="1c3c" class="lf lg it mi b gy mm mn l mo mp">cd ocp-install<br/>openshift-install create manifests --dir .</span></pre><p id="c14b" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">克隆cilium-olm git repo(与ocp-install级别相同)</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="4421" class="lf lg it mi b gy mm mn l mo mp">cd ..<br/>git clone https://github.com/cilium/cilium-olm.git</span></pre><p id="1112" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">将默认清单文件复制到创建的清单目录中，</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="3d30" class="lf lg it mi b gy mm mn l mo mp">cp cilium-olm/manifests/cilium.v1.10.4/* ocp-install/manifests</span></pre><p id="2d9e" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">现在，根据更新的清单生成点火文件，</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="44d5" class="lf lg it mi b gy mm mn l mo mp">cd ocp-install<br/>openshift-install create ignition-configs --dir .</span></pre><p id="ca4d" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">将点火文件复制到HTTP服务器。</p><p id="ea81" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">然后，像往常一样安装OCP集群。你应该把OCP和纤毛一起作为CNI网络插件运行。登录到web控制台，您应该看到cilium操作符安装在Cilium命名空间中。</p><figure class="md me mf mg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mq"><img src="../Images/a379bf779dbae70c3b7a8eb488b35d93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I_KyFT-5rQJAFWjvuZ4zKA.png"/></div></div></figure><h2 id="d744" class="lf lg it bd lh li lj dn lk ll lm dp ln ks lo lp lq kw lr ls lt la lu lv lw lx bi translated"><strong class="ak">更新CiliumConfig </strong></h2><p id="bb85" class="pw-post-body-paragraph kh ki it kj b kk ly km kn ko lz kq kr ks ma ku kv kw mb ky kz la mc lc ld le im bi translated">我们将更新CiliumConfig CRD资源，使哈勃用户界面和监测。创建以下YAML文件，</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="c1e6" class="lf lg it mi b gy mm mn l mo mp">apiVersion: cilium.io/v1alpha1<br/>kind: CiliumConfig<br/>metadata: <br/>  name: cilium<br/>  namespace: cilium<br/>spec:<br/>  debug:<br/>    enabled: false<br/>  cni:<br/>    binPath: /var/lib/cni/bin<br/>    confPath: /var/run/multus/cni/net.d<br/>  endpointRoutes:<br/>    enabled: true<br/>  hubble:<br/>    enabled: true<br/>    metrics:<br/>      enabled:<br/>      - dns:query;ignoreAAAA<br/>      - drop<br/>      - tcp<br/>      - flow<br/>      - icmp<br/>      - http<br/>      serviceMonitor:<br/>        enabled: true<br/>    tls:<br/>      enabled: true<br/>    relay:<br/>      enabled: true<br/>    ui:<br/>      enabled: true<br/>      ingress:<br/>        enabled: true<br/>        hosts:<br/>          - hubble.apps.dev-cilium.ibmcloud.io.cpak<br/>  ipam:<br/>    mode: cluster-pool<br/>    operator:<br/>      clusterPoolIPv4MaskSize: "23"<br/>      clusterPoolIPv4PodCIDR: 10.128.0.0/14<br/>  kubeProxyReplacement: probe<br/>  nativeRoutingCIDR: 10.128.0.0/14<br/>  prometheus:<br/>    enabled: true<br/>    serviceMonitor:<br/>      enabled: true<br/>  operator:<br/>    prometheus:<br/>      enabled: true<br/>      serviceMonitor:<br/>        enabled: true</span></pre><p id="f7d6" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">请注意，我们已经启用了hubble relay和hubble UI，以便我们可以观察服务地图。我们还为操作员、纤毛和哈勃度量启用了普罗米修斯数据采集。由于OCP安装了Prometheus operator，我们使用Prometheus CRD资源服务监视器来监视指标。</p><h2 id="4694" class="lf lg it bd lh li lj dn lk ll lm dp ln ks lo lp lq kw lr ls lt la lu lv lw lx bi translated">修复纤毛-olm作用的RBAC问题</h2><p id="caab" class="pw-post-body-paragraph kh ki it kj b kk ly km kn ko lz kq kr ks ma ku kv kw mb ky kz la mc lc ld le im bi translated">应用YAML文件，您将很快看到由于RBAC限制，定义的CR无法正确协调。serviceMonitors和ingress是使用cilium命名空间中的服务帐户cilium-olm创建的。命名空间角色cilium-olm已绑定到服务帐户。该角色缺少对这两种资源的RBAC访问权限。</p><p id="d533" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">通过将权限附加到servicemonitors和ingresses来更新cilium-olm角色，如下所示，</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="7a6c" class="lf lg it mi b gy mm mn l mo mp">kind: Role<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>metadata:<br/>  name: cilium-olm<br/>  namespace: cilium<br/>rules:<br/>...<br/>- verbs:<br/>    - '*'<br/>  apiGroups:<br/>    - monitoring.coreos.com<br/>  resources:<br/>    - <strong class="mi iu">servicemonitors</strong><br/>- verbs:<br/>    - '*'<br/>  apiGroups:<br/>    - networking.k8s.io<br/>  resources:<br/>    - <strong class="mi iu">ingresses</strong><br/></span></pre><h2 id="d023" class="lf lg it bd lh li lj dn lk ll lm dp ln ks lo lp lq kw lr ls lt la lu lv lw lx bi translated">修复哈勃中继的SELinux权限问题</h2><p id="0ef3" class="pw-post-body-paragraph kh ki it kj b kk ly km kn ko lz kq kr ks ma ku kv kw mb ky kz la mc lc ld le im bi translated">现在，如果你登录hub-ui，你将看不到任何数据，也看不到任何服务地图。根本原因是由于SELinux禁止访问hubble创建的UNIX套接字文件，hubble-relay无法正常运行。</p><p id="2d0b" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">关于这个问题更详细的分析可以参考我上一篇论文<a class="ae kg" href="https://zhimin-wen.medium.com/selinux-policy-for-openshift-containers-40baa1c86aa5" rel="noopener">这里</a>。</p><p id="0a98" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">修复方法是创建以下类型强制(te)文件。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="9779" class="lf lg it mi b gy mm mn l mo mp">module myapp 1.0;<br/>require {<br/> type container_var_run_t;<br/> type container_t;<br/> class dir read;<br/> class sock_file write;<br/>}<br/>#============= container_t ==============<br/>allow container_t container_var_run_t:dir read;<br/>allow container_t container_var_run_t:sock_file write;</span></pre><p id="1514" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">编译到策略模块中，并通过运行以下命令加载到OCP集群的工作节点中，</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="c3de" class="lf lg it mi b gy mm mn l mo mp">sudo checkmodule -M -m -o myapp.mod myapp.te<br/>sudo semodule_package -o myapp.pp -m myapp.mod<br/>sudo semodule -i myapp.pp</span></pre><p id="9cc1" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">作为纤毛测试应用程序的一个例子，您现在应该能够在hub-ui中看到数据。</p><figure class="md me mf mg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mr"><img src="../Images/2231366f6db77832c72caad4c877fc94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4E9BWtQNW_SFqUw_zk883g.png"/></div></div></figure><h2 id="77cb" class="lf lg it bd lh li lj dn lk ll lm dp ln ks lo lp lq kw lr ls lt la lu lv lw lx bi translated">监视</h2><p id="adf3" class="pw-post-body-paragraph kh ki it kj b kk ly km kn ko lz kq kr ks ma ku kv kw mb ky kz la mc lc ld le im bi translated">我打开了用户工作负载监控，使用OCP的用户prometheus实例来收集纤毛数据。要允许serviceMonitor CRD从cilium命名空间开始抓取数据，请更改以下命名空间批注。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="7c25" class="lf lg it mi b gy mm mn l mo mp">oc label ns cilium openshift.io/cluster-monitoring=false --overwrite</span></pre><p id="ab62" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">按照我的另一篇论文<a class="ae kg" href="https://zhimin-wen.medium.com/custom-grafana-dashboard-for-user-workload-in-openshift-6dc2d4cad274" rel="noopener">中的描述安装Grafana仪表盘。我们还可以导入grafana网站发布的纤毛仪表板。下面显示了一个grafana仪表板示例，</a></p><figure class="md me mf mg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ms"><img src="../Images/16408ba0b6a7564b7c413dd100a565ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eDu_ZdLpPcyVjPDOvIBrLw.png"/></div></div></figure><p id="14ae" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">现在，OCP的纤毛设置已经完成。我们准备通过定义Cilium网络策略来控制网络流量。</p></div></div>    
</body>
</html>