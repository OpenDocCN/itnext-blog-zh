<html>
<head>
<title>Learn how to connect your microservices using Dapr and NATS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解如何使用Dapr和NATS连接您的微服务</h1>
<blockquote>原文：<a href="https://itnext.io/learn-how-to-connect-your-microservices-using-dapr-and-nats-aafea432a6e8?source=collection_archive---------3-----------------------#2019-11-21">https://itnext.io/learn-how-to-connect-your-microservices-using-dapr-and-nats-aafea432a6e8?source=collection_archive---------3-----------------------#2019-11-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="cd18" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/dapr/dapr/blob/master/docs/release_notes/v0.2.0.md" rel="noopener ugc nofollow" target="_blank"> Dapr版本0.2.0 </a>附带了一堆添加到运行时的<a class="ae kl" href="https://github.com/dapr/dapr/blob/master/docs/release_notes/v0.2.0.md#dapr-runtime" rel="noopener ugc nofollow" target="_blank">新组件。其中一个组件包括具有</a><a class="ae kl" href="https://nats.io/" rel="noopener ugc nofollow" target="_blank"> NATS </a>的pubsub功能，这是一个基于<a class="ae kl" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Go的</a>开源消息系统，用于云原生应用、物联网消息和微服务架构。这个博客将提供如何使用它的一步一步的演练。</p><blockquote class="km kn ko"><p id="57b9" class="jn jo kp jp b jq jr js jt ju jv jw jx kq jz ka kb kr kd ke kf ks kh ki kj kk ij bi translated"><em class="iq">代码一如既往的在GitHub </em>  <em class="iq">上</em> <a class="ae kl" href="https://github.com/abhirockzz/dapr-nats-pubsub" rel="noopener ugc nofollow" target="_blank"> <em class="iq">可用</em></a></p></blockquote><p id="6e31" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将在<code class="fe kt ku kv kw b">Kubernetes</code> ( <code class="fe kt ku kv kw b">minikube</code>)部署<code class="fe kt ku kv kw b">Dapr</code>，并在<code class="fe kt ku kv kw b">demo.nats.io:4222</code>使用NATS服务器进行演示。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi kx"><img src="../Images/4abc6e4ba6f6fb5d99dd9c65970cf2c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:504/format:webp/0*NU4Vh1lf-ydRGJdg.jpg"/></div></figure><h1 id="4dc3" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">你好Dapr！</h1><p id="dde0" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated"><a class="ae kl" href="http://dapr.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> Dapr </strong> </a>代表<em class="kp">分布式应用运行时</em>。它是一个开源、可移植的运行时，通过将构建这类应用程序的最佳实践编入独立的组件，来帮助开发人员构建有弹性的、微服务无状态和有状态的应用程序。</p><p id="8243" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你是Dapr的新手，我建议你从<a class="ae kl" href="https://github.com/dapr/docs/blob/master/overview.md" rel="noopener ugc nofollow" target="_blank">概述</a>和<a class="ae kl" href="https://github.com/dapr/docs/tree/master/concepts" rel="noopener ugc nofollow" target="_blank">概念</a>开始。尝试使用<a class="ae kl" href="https://github.com/dapr/docs/tree/master/getting-started" rel="noopener ugc nofollow" target="_blank">入门指南</a>，然后继续使用<a class="ae kl" href="https://github.com/dapr/samples/blob/master/README.md" rel="noopener ugc nofollow" target="_blank">样品</a>和<a class="ae kl" href="https://github.com/dapr/docs/tree/master/howto" rel="noopener ugc nofollow" target="_blank">操作指南</a>。随着进一步深入，您可以深入了解<a class="ae kl" href="https://github.com/dapr/docs/tree/master/reference/api" rel="noopener ugc nofollow" target="_blank"> Dapr运行时API参考</a>和<a class="ae kl" href="https://github.com/dapr/components-contrib" rel="noopener ugc nofollow" target="_blank">单个组件</a></p></div><div class="ab cl mi mj hu mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ij ik il im in"><h1 id="658d" class="lf lg iq bd lh li mp lk ll lm mq lo lp lq mr ls lt lu ms lw lx ly mt ma mb mc bi translated">设置</h1><p id="a736" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">安装<a class="ae kl" href="https://github.com/dapr/cli" rel="noopener ugc nofollow" target="_blank"> Dapr CLI </a>(需要安装<code class="fe kt ku kv kw b">Docker</code>)。遵循文档-<a class="ae kl" href="https://github.com/dapr/docs/blob/master/getting-started/environment-setup.md" rel="noopener ugc nofollow" target="_blank">https://github . com/dapr/docs/blob/master/getting-started/environment-setup . MD</a></p><p id="0ccc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你在苹果电脑上，只需:</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="b480" class="my lg iq kw b gy mz na l nb nc">curl -fsSL https://raw.githubusercontent.com/dapr/cli/master/install/install.sh | /bin/bash</span></pre><p id="0972" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将<code class="fe kt ku kv kw b">Dapr</code>安装到<code class="fe kt ku kv kw b">Kubernetes</code>(为了简单起见，我们将使用<code class="fe kt ku kv kw b">minikube</code>)。如果需要，请参见安装minikube 的文档。</p><p id="e84a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦<code class="fe kt ku kv kw b">minikube</code>设置好，确保你启动它</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="e48e" class="my lg iq kw b gy mz na l nb nc">minikube start</span></pre><p id="b00b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在您只需要一个命令就可以在Kuberneres上安装Dapr了！</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="d9e5" class="my lg iq kw b gy mz na l nb nc">dapr init --kubernetes</span></pre><p id="211c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您应该会看到这条消息</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="deaa" class="my lg iq kw b gy mz na l nb nc">Success! Dapr has been installed. To verify, run 'kubectl get pods -w' in your terminal</span></pre><blockquote class="km kn ko"><p id="4bbc" class="jn jo kp jp b jq jr js jt ju jv jw jx kq jz ka kb kr kd ke kf ks kh ki kj kk ij bi translated"><em class="iq">如果你想使用</em> <code class="fe kt ku kv kw b"><em class="iq">Helm</em></code> <em class="iq">安装</em> <code class="fe kt ku kv kw b"><em class="iq">Dapr</em></code> <em class="iq">，请查看</em><a class="ae kl" href="https://github.com/dapr/docs/blob/master/getting-started/environment-setup.md#using-helm-advanced" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://github . com/dapr/docs/blob/master/getting-started/environment-setup . MD # using-helm-advanced</em></a></p></blockquote><p id="b15a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了确认，当Dapr吊舱处于<code class="fe kt ku kv kw b">Running</code>状态时，使用以下命令并继续。相关的pod包括Dapr操作员、Dapr边车注射器和Dapr位置</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="9d44" class="my lg iq kw b gy mz na l nb nc">kubectl get pods -w</span></pre><p id="a5da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你已经准备好了！</p></div><div class="ab cl mi mj hu mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ij ik il im in"><h1 id="9262" class="lf lg iq bd lh li mp lk ll lm mq lo lp lq mr ls lt lu ms lw lx ly mt ma mb mc bi translated">尝试与NATS公共订阅Dapr</h1><p id="4ad1" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">从克隆repo开始，并切换到正确的目录</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="04df" class="my lg iq kw b gy mz na l nb nc">git clone https://github.com/abhirockzz/dapr-nats-pubsub<br/>cd dapr-nats-pubsub</span></pre><h2 id="b02f" class="my lg iq bd lh nd ne dn ll nf ng dp lp jy nh ni lt kc nj nk lx kg nl nm mb nn bi translated">部署NATS发布订阅组件</h2><p id="1be5" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">一个<code class="fe kt ku kv kw b">Component</code>是一个Dapr CRD(自定义资源定义)。这是配置——注意，我们在<code class="fe kt ku kv kw b">demo.nats.io:4222</code>使用的是由<code class="fe kt ku kv kw b">natsURL</code>指定的演示NATS服务器</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="fec3" class="my lg iq kw b gy mz na l nb nc">apiVersion: dapr.io/v1alpha1<br/>kind: Component <br/>metadata:<br/>  name: messagebus-nats<br/>spec:<br/>  type: pubsub.nats<br/>  metadata:<br/>  - name: natsURL<br/>    value: nats://demo.nats.io:4222</span></pre><p id="1ca7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要创建:</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="b662" class="my lg iq kw b gy mz na l nb nc">kubectl apply -f deploy/nats-pubsub.yaml<br/>//component.dapr.io/messagebus-nats created</span></pre><p id="b677" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">确认:</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="4976" class="my lg iq kw b gy mz na l nb nc">kubectl get component.dapr.io    </span><span id="f627" class="my lg iq kw b gy no na l nb nc">NAME              AGE<br/>messagebus-nats   12s</span></pre><h1 id="581c" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">部署订户应用程序</h1><p id="b6cd" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">这是一个简单的应用程序，订阅了一个名为<code class="fe kt ku kv kw b">testsubject</code>的主题。</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="4d0f" class="my lg iq kw b gy mz na l nb nc">http.HandleFunc(<strong class="kw ir">"/dapr/subscribe"</strong>, func(w http.ResponseWriter, r *http.Request) {<br/>	response := `["` + natsSubject + `"]`<br/>	fmt.Println("subscribed to NATS subject", natsSubject)<br/>	w.Write([]byte(response))<br/>})</span></pre><p id="cd24" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用程序本身被定义为Kubernetes <code class="fe kt ku kv kw b">Deployment</code>资源。它使用注释来确保Dapr边车是“注入”的</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="8041" class="my lg iq kw b gy mz na l nb nc">dapr.io/enabled: "true"<br/>dapr.io/id: "natsapp"<br/>dapr.io/port: "8080"<br/>dapr.io/log-level: "debug"</span></pre><p id="6463" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要创建应用程序:</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="9732" class="my lg iq kw b gy mz na l nb nc">kubectl apply -f deploy/app.yaml</span></pre><blockquote class="km kn ko"><p id="eb05" class="jn jo kp jp b jq jr js jt ju jv jw jx kq jz ka kb kr kd ke kf ks kh ki kj kk ij bi translated"><em class="iq">部署使用预构建的Docker映像(</em> <code class="fe kt ku kv kw b"><em class="iq">abhirockzz/dapr-nats-pubsub</em></code> <em class="iq">)，但是您可以使用</em> <code class="fe kt ku kv kw b"><em class="iq">nats-app</em></code> <em class="iq">文件夹</em>中提供的 <code class="fe kt ku kv kw b"><em class="iq">Dockerfile</em></code> <em class="iq">构建自己的映像</em></p></blockquote><p id="a10f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">检查新的<code class="fe kt ku kv kw b">Pod</code>并等待其<code class="fe kt ku kv kw b">transition</code>到<code class="fe kt ku kv kw b">Running</code>状态</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="380d" class="my lg iq kw b gy mz na l nb nc">kubectl get pods -l=app=natsapp -w</span></pre><p id="6e47" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此时，您可以检查应用程序以及Dapr sidecar容器的日志</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="7e0d" class="my lg iq kw b gy mz na l nb nc">//for the app<br/>kubectl logs &lt;POD_NAME&gt; -c natsapp</span><span id="a000" class="my lg iq kw b gy no na l nb nc">//logs for the Dapr sidecar<br/>kubectl logs &lt;POD_NAME&gt; -c daprd</span></pre><p id="884f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于该应用程序，您应该只看到以下日志，这些日志表明该应用程序已经订阅了NATS主题，并且正在侦听进一步的消息</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="f91e" class="my lg iq kw b gy mz na l nb nc">starting HTTP server....<br/>subscribed to NATS subject testsubject</span></pre><p id="cfc7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于Dapr sidecar，您应该看到类似这样的内容—请注意，NATS pubsub组件设置正确，Dapr能够连接到NATS并订阅组件中指定的NATS服务器。</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="590c" class="my lg iq kw b gy mz na l nb nc">time="2019-11-19T10:00:18Z" level=info msg="starting Dapr Runtime -- version 0.2.0 -- commit c75b111"<br/>time="2019-11-19T10:00:18Z" level=info msg="log level set to: debug"<br/>time="2019-11-19T10:00:18Z" level=info msg="kubernetes mode configured"<br/>time="2019-11-19T10:00:18Z" level=info msg="dapr id: natsapp"<br/><strong class="kw ir">time="2019-11-19T10:00:19Z" level=info msg="loaded component messagebus-nats (pubsub.nats)"<br/></strong>time="2019-11-19T10:00:19Z" level=info msg="application protocol: http. waiting on port 8080"<br/>time="2019-11-19T10:00:19Z" level=info msg="application discovered on port 8080"<br/><strong class="kw ir">time="2019-11-19T10:00:20Z" level=debug msg="connected to nats at nats://demo.nats.io:4222"<br/>time="2019-11-19T10:00:20Z" level=debug msg="nats: subscribed to subject testsubject with queue group natsapp"<br/></strong>time="2019-11-19T10:00:20Z" level=warning msg="failed to init actors: actors: state store must be present to initialize the actor runtime"<br/>time="2019-11-19T10:00:20Z" level=info msg="http server is running on port 3500"<br/>time="2019-11-19T10:00:20Z" level=info msg="gRPC server is running on port 50001"<br/>time="2019-11-19T10:00:20Z" level=info msg="dapr initialized. Status: Running. Init Elapsed 1211.203177ms"</span></pre><p id="b1a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">开始跟踪应用程序日志，因为您将需要检查端到端的功能</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="6cd8" class="my lg iq kw b gy mz na l nb nc">kubectl logs -f &lt;POD_NAME&gt; -c natsapp</span></pre><h2 id="4c86" class="my lg iq bd lh nd ne dn ll nf ng dp lp jy nh ni lt kc nj nk lx kg nl nm mb nn bi translated">部署客户端应用程序</h2><p id="f907" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">客户端应用程序是一个React前端应用程序，它是从<a class="ae kl" href="https://github.com/dapr/samples" rel="noopener ugc nofollow" target="_blank"> Dapr samples repo </a>中挑选出来的，并且为了这个场景的目的已经做了非常小的修改</p><p id="7595" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">切换到新的终端部署客户端应用程序。这也是一个Kubernetes <code class="fe kt ku kv kw b">Deployment</code>。它还包括一个<code class="fe kt ku kv kw b">LoadBalancer</code>,这样我们就可以在浏览器中访问这个应用程序</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="1b7d" class="my lg iq kw b gy mz na l nb nc">kubectl apply -f deploy/react-app.yaml</span></pre><p id="835e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">等待应用程序被部署</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="1c20" class="my lg iq kw b gy mz na l nb nc">kubectl get pods -l=app=react-form -w</span></pre><p id="b824" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦部署完毕，您就可以检查端到端的事件流了。</p><h2 id="ec44" class="my lg iq bd lh nd ne dn ll nf ng dp lp jy nh ni lt kc nj nk lx kg nl nm mb nn bi translated">使用前端应用程序制作/发布消息</h2><p id="8a0c" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">由于我们使用的是<code class="fe kt ku kv kw b">minikube</code>，我们可以在浏览器中打开React应用程序:</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="664c" class="my lg iq kw b gy mz na l nb nc">minikube service react-form</span></pre><p id="a530" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您应该会看到以下屏幕:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="nq nr di ns bf nt"><div class="gh gi np"><img src="../Images/c09d4377c19b08c74479ddcb231a7914.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WWAzt2bUyognOzEs.png"/></div></div></figure><p id="c566" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kt ku kv kw b">testsubject</code>是我们要向其发送消息的NATS主题(忽略下拉列表中的其他主题)。只需输入信息并按下<code class="fe kt ku kv kw b">Submit</code>按钮。这将使用NATS发布订阅组件的发布者部分，并向位于<code class="fe kt ku kv kw b">demo.nats.io:4222</code>的NATS服务器发送一条消息</p><p id="b8ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">检查跟踪订户应用程序日志的另一个终端——您应该看到日志以及您发送的消息，例如</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="7462" class="my lg iq kw b gy mz na l nb nc">Recieved Message from NATS - {"id":"48825607-1f10-4789-8d99-84b927c1900e","source":"react-form","type":"com.dapr.event.sent","specversion":"0.3","datacontenttype":"application/json","data":{"messageType":"testsubject","message":"looking dapr"}}</span></pre><p id="ba29" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">消息封装在<code class="fe kt ku kv kw b">Cloud Events</code>有效载荷中。你可以多发几条信息，复查一下结果。</p><h2 id="5e2f" class="my lg iq bd lh nd ne dn ll nf ng dp lp jy nh ni lt kc nj nk lx kg nl nm mb nn bi translated">水平缩放…</h2><p id="00ad" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">到目前为止，我们只有一个订户应用程序实例。Dapr中的NATS pubsub组件作为队列订阅者工作，这意味着您可以生成更多的实例，来自NATS服务器的事件将在它们之间分发。这导致了可水平扩展的系统</p><p id="8cc6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要扩大我们的部署:</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="5093" class="my lg iq kw b gy mz na l nb nc">kubectl scale deployment/natsapp --replicas=2</span></pre><p id="b63b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">等待新应用程序<code class="fe kt ku kv kw b">Pod</code>启动</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="61ad" class="my lg iq kw b gy mz na l nb nc">kubectl get pods -l=app=natsapp -w</span></pre><p id="7db1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦准备好了，就开始跟踪日志，就像第一个实例一样</p><pre class="ky kz la lb gt mu kw mv mw aw mx bi"><span id="8bcb" class="my lg iq kw b gy mz na l nb nc">kubectl logs -f &lt;NAME_OF_NEW_POD&gt; -c natsapp</span></pre><p id="5729" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用前端应用程序发送消息，并确认它们将在两个实例之间分发。您可以进一步扩展应用程序，并确认行为保持不变。</p><h2 id="b8da" class="my lg iq bd lh nd ne dn ll nf ng dp lp jy nh ni lt kc nj nk lx kg nl nm mb nn bi translated">换个应用怎么样？</h2><p id="c9bc" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">想象一下，你有一个完全不同的应用程序，它也想处理来自相同主题的消息，但处理它们的方式与现有的应用程序不同。好吧，你可以创建一个新的Dapr驱动的应用程序，方法和现有的一样，包括你的处理逻辑，并把它部署到Kubernetes。它也将收到与早期应用程序相同的一组消息。</p></div><div class="ab cl mi mj hu mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ij ik il im in"><h1 id="5909" class="lf lg iq bd lh li mp lk ll lm mq lo lp lq mr ls lt lu ms lw lx ly mt ma mb mc bi translated">摘要</h1><p id="3330" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">在这篇博文中，你看到了如何使用NATS作为一个公共订阅层在你的Dapr应用之间进行通信。您的应用程序甚至不知道NATS——它所做的只是使用Dapr HTTP API与Dapr运行时(只是一个sidecar)进行交互！</p><blockquote class="km kn ko"><p id="8451" class="jn jo kp jp b jq jr js jt ju jv jw jx kq jz ka kb kr kd ke kf ks kh ki kj kk ij bi translated"><em class="iq">使用gRPC或特定语言的SDK也是可行的</em></p></blockquote><p id="640d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在撰写本文时，<code class="fe kt ku kv kw b">Dapr</code>处于alpha状态(<code class="fe kt ku kv kw b">v0.2.0</code>)，并乐于接受社区贡献😃游览https://github.com/dapr/dapr<a class="ae kl" href="https://github.com/dapr/dapr" rel="noopener ugc nofollow" target="_blank"/>尽情享受吧！</p><p id="7986" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你觉得这篇文章有帮助，请喜欢并关注🙌很高兴通过<a class="ae kl" href="https://twitter.com/abhi_tweeter" rel="noopener ugc nofollow" target="_blank"> Twitter </a>获得反馈或发表评论。</p></div></div>    
</body>
</html>