<html>
<head>
<title>Building Multi-CPU Architecture Docker Images for ARM and x86 (3): Building in GitHub Action CI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为ARM和x86构建多CPU架构Docker映像(3):在GitHub Action CI中构建</h1>
<blockquote>原文：<a href="https://itnext.io/building-multi-cpu-architecture-docker-images-for-arm-and-x86-3-building-in-github-action-ci-a382feab5af9?source=collection_archive---------4-----------------------#2022-01-21">https://itnext.io/building-multi-cpu-architecture-docker-images-for-arm-and-x86-3-building-in-github-action-ci-a382feab5af9?source=collection_archive---------4-----------------------#2022-01-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d10d2f95e4fad64f967c0c365cee5cf3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7H8-4dxTqKEeTvcs"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@richygreat?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">rich Great</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="0dd0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在“<a class="ae kc" href="https://medium.com/p/2fa97869a99b" rel="noopener">为ARM和x86构建多CPU架构Docker映像(1):基础知识</a>”中，我们介绍了使用buildx/buildkit构建多拱Docker映像的一般工作流程。在本文中，我们将介绍如何让它在GitHub Action CI上运行。</p><h1 id="0012" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">跑步者环境</h1><p id="462d" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">使用<code class="fe me mf mg mh b">ubuntu-latest</code> runner环境将是让您的多拱管道在Github action CI上运行的最简单的选择。例如，您可以通过以下方式指定作业运行器环境:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="377b" class="mq lc iq mh b gy mr ms l mt mu">jobs:  <br/>  build-docker-images:    <br/>    name: Build Docker Images<br/>    runs-on: ubuntu-latest</span></pre><h1 id="b071" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">建立QEMU</h1><p id="3189" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated"><a class="ae kc" href="https://github.com/moby/buildkit" rel="noopener ugc nofollow" target="_blank"> Buildkit </a>在一台机器上为不同的目标平台构建Docker映像时，使用QEMU来模拟不同的目标平台。要设置/安装QEMU，我们可以使用`<a class="ae kc" href="https://github.com/docker/setup-qemu-action" rel="noopener ugc nofollow" target="_blank">docker/setup-QEMU-action</a>`:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="3233" class="mq lc iq mh b gy mr ms l mt mu">- name: Set up QEMU        <br/>  uses: docker/setup-qemu-action@v1</span></pre><h1 id="b9d5" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">安装Buildx</h1><p id="a282" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">要设置/安装buildx，我们可以使用`<a class="ae kc" href="https://github.com/docker/setup-buildx-action" rel="noopener ugc nofollow" target="_blank">docker/setup-buildx-action</a>`:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="6ec5" class="mq lc iq mh b gy mr ms l mt mu">- name: Set up Docker Buildx        <br/>  uses: docker/setup-buildx-action@v1</span></pre><h1 id="4b8d" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">完整的例子，建立多拱图像和推动到' GitHub软件包'注册表</h1><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="5f9a" class="mq lc iq mh b gy mr ms l mt mu">jobs:  <br/>  build-docker-images:    <br/>    name: Build Docker Images<br/>    runs-on: ubuntu-latest<br/>  steps:<br/>    - uses: actions/checkout@v2<br/>    - name: Set up QEMU        <br/>      uses: docker/setup-qemu-action@v1<br/>    - name: Set up Docker Buildx        <br/>      uses: docker/setup-buildx-action@v1<br/>    - name: Login to GitHub Package Registry        <br/>      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin<br/>    - name: Build &amp; Push Docker image<br/>      run: docker buildx build -t ghcr.io/${{ github.repository_owner }}/myimage:${GITHUB_SHA} -f [path to Dockerfile] --push --platform=linux/arm64,linux/amd64 [path to build context]</span></pre><h1 id="a1dc" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">将多拱图像重新标记和复制到Docker Hub</h1><p id="4c64" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">在CI管道中，我们经常将docker映像推送到CI平台提供的注册表中进行测试和验证。但是，最终，我们会希望将GitHub Packages Registry中的多拱Docker映像重新标记和复制到生产注册表中。例如码头中心。</p><p id="df12" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于多拱图像，我们不能使用旧的工作流程来使用<code class="fe me mf mg mh b">docker tag</code> &amp; <code class="fe me mf mg mh b">docker push</code>命令重新标记和推送docker图像到不同的注册表，因为它们只处理一个图像，而不是一个清单注册表条目后的多个图像。</p><p id="5815" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要解决这个问题，我们可以使用<code class="fe me mf mg mh b"><a class="ae kc" href="https://github.com/regclient/regclient" rel="noopener ugc nofollow" target="_blank">regclient</a></code>。它的命令语法非常简单。为了重新标记&amp;复制我们在前面的例子中构建的&amp;推送到GitHub Packages注册表的图像，并推送到Docker hub，我们可以运行:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="e294" class="mq lc iq mh b gy mr ms l mt mu">- name: Login to Docker Hub        <br/>  env:          <br/>    DH_TOKEN: ${{ secrets.DOCKER_HUB_PASSWORD }}               <br/>  run: docker login -u my-docker-hub-username -p ${DH_TOKEN}</span><span id="a197" class="mq lc iq mh b gy mv ms l mt mu">- name: Re-tag &amp; Push Docker Image to Docker Hub        <br/>  run: |          <br/>    # make config.json avaiable to regclient in docker container<br/>    chmod +r $HOME/.docker/config.json<br/>    # Run regclient in docker image<br/>    docker container run --rm --net host \<br/>      -v regctl-conf:/home/appuser/.regctl/ \            <br/>      -v $HOME/.docker/config.json:/home/appuser/.docker/config.json \            <br/>      regclient/regctl:v0.3.9 image copy ghcr.io/${{ github.repository_owner }}/myimage:${GITHUB_SHA} docker.io/xxxx/myimage:v1</span></pre></div></div>    
</body>
</html>