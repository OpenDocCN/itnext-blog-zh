<html>
<head>
<title>Fortio for Service Meshes — Pros vs. Cons</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">服务网格的Fortio优势与劣势</h1>
<blockquote>原文：<a href="https://itnext.io/fortio-for-service-meshes-pros-vs-cons-e0458c7d672b?source=collection_archive---------3-----------------------#2021-11-07">https://itnext.io/fortio-for-service-meshes-pros-vs-cons-e0458c7d672b?source=collection_archive---------3-----------------------#2021-11-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="52d9" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Fortio是您可以用于微服务测试的最佳工具吗？再想想！</h2></div><p id="f9ec" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Fortio是一个快速、小型(3Mb docker映像，最小依赖性)、可重复使用、可嵌入的go库以及命令行工具和服务器进程，服务器包括一个简单的web UI和REST API，用于触发运行并查看结果的图形表示(单个延迟图形和多个结果的比较性min、max、avg、qps和percentiles图形)。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/2795035e734d2c649736384051f90b9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J0H5mQYAb5Kjt_S3w5xGNQ.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">Fortio样本结果图(<a class="ae lu" href="https://github.com/fortio/fortio" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><p id="5963" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Fortio最初是Istio的负载测试工具，现在已经发展成为自己的项目。Fortio社区在过去几年一直非常活跃，并在多个版本中贡献了非常好的功能集。Fortio组件甚至可以用于不相关的项目，例如客户端和服务器端的<code class="fe lv lw lx ly b">log</code>、<code class="fe lv lw lx ly b">stats</code>或<code class="fe lv lw lx ly b">fhttp</code>工具。</p><h1 id="87eb" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated"><strong class="ak">功能:</strong></h1><ul class=""><li id="0d52" class="mr ms it kk b kl mt ko mu kr mv kv mw kz mx ld my mz na nb bi translated">请求回显，包括报头，添加具有概率分布的延迟或错误代码</li><li id="2622" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">TCP回应</li><li id="e380" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">TCP代理</li><li id="d021" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">HTTP扇出/分散和聚集代理服务器</li><li id="5631" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">除http之外的gRPC echo/health</li><li id="1c3b" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">Ping测试</li><li id="c824" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">基于TLS的测试</li><li id="5a3f" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">动态标志支持(<a class="ae lu" href="https://github.com/fortio/fortio/blob/master/dflag" rel="noopener ugc nofollow" target="_blank">https://github.com/fortio/fortio/blob/master/dflag</a>)</li><li id="e622" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated"><em class="nh">输入列表</em>:每秒查询次数、持续时间、延迟参数、HTTP/GRPC、服务器端能力、文件传输等。</li><li id="09e9" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated"><em class="nh">输出</em>:已解决的查询、查询错误、休眠消息、百分比延迟(P75、P90、P99等。)，直方图</li></ul><p id="427a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">其他详细信息:</strong></p><ul class=""><li id="f5e2" class="mr ms it kk b kl km ko kp kr ni kv nj kz nk ld my mz na nb bi translated">用Go写的</li><li id="406a" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">提供GET/POST方法</li><li id="47e6" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">会引入抖动，但不可定制</li><li id="4a81" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">提供直方图功能</li></ul><h1 id="a312" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">赞成还是反对</h1><h2 id="f360" class="nl ma it bd mb nm nn dn mf no np dp mj kr nq nr ml kv ns nt mn kz nu nv mp nw bi translated"><strong class="ak">优点:</strong></h2><ul class=""><li id="6ae5" class="mr ms it kk b kl mt ko mu kr mv kv mw kz mx ld my mz na nb bi translated">快速易用，易于定制</li><li id="1c79" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">可以建成一个图书馆</li><li id="f2e4" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">像样的日志消息</li><li id="a006" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">拥有活跃的社区支持</li><li id="0fbf" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">具有直方图等绘图功能</li><li id="0662" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">可以通过网络用户界面运行测试</li></ul><h2 id="4034" class="nl ma it bd mb nm nn dn mf no np dp mj kr nq nr ml kv ns nt mn kz nu nv mp nw bi translated"><strong class="ak">缺点:</strong></h2><ul class=""><li id="ce06" class="mr ms it kk b kl mt ko mu kr mv kv mw kz mx ld my mz na nb bi translated">没有专注于MTL的功能</li><li id="1a72" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">对于超过10000 QPS的负载，单个实例的伸缩性不好。</li><li id="29ac" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">Go scheduler并未针对高负载生成进行优化，其行为可能因运行时版本而异</li><li id="61a6" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">当响应与请求不匹配时增加睡眠时间</li><li id="25df" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">使用Linux内核堆栈，增加了自己的延迟</li><li id="ad2e" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">不适用于利用连接池进行开环或闭环测试的测试</li><li id="38dd" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">不符合L2/L3性能优化或RFC2544</li><li id="a232" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">它的垃圾收集可能会大大提高噪声基底，尤其是在TLS用例中</li><li id="7635" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">在为应用分配多个内核的情况下，不一定能够很好地扩展</li><li id="dc10" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">根据社区测试，Fortio似乎更多地以批处理方式执行请求，导致缺乏统一的负载分布</li><li id="3b10" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">延迟结果超过1000QPS时缺乏一致性的公开问题</li></ul><p id="4f3e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">由<a class="nx ny ep" href="https://medium.com/u/b7b39d3d5691?source=post_page-----e0458c7d672b--------------------------------" rel="noopener" target="_blank"> Otto van der Schaaf </a>合著的《Fortio与<a class="ae lu" href="https://github.com/giltene/wrk2" rel="noopener ugc nofollow" target="_blank"> Wrk2 </a>(此处<a class="ae lu" href="https://docs.google.com/document/d/10xeQuEjUjdmfFq36kGrxI6v78GKHspqn_Nb-pohKfOo/edit?pli=1#" rel="noopener ugc nofollow" target="_blank">发布</a>)之间的比较中，发现两者之间的性能结果存在以下问题/差异:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/dbb99a4d348bfcad0b05b05f3000bab3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1374/format:webp/1*GChJBHSPkVjAvNhpYYSKsQ.jpeg"/></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">在200个连接时，Wrk2的P50延迟远远低于Fortio，4CPUs ( <a class="ae lu" href="https://docs.google.com/document/d/10xeQuEjUjdmfFq36kGrxI6v78GKHspqn_Nb-pohKfOo/edit?pli=1#" rel="noopener ugc nofollow" target="_blank">来源</a>)</figcaption></figure><ul class=""><li id="8427" class="mr ms it kk b kl km ko kp kr ni kv nj kz nk ld my mz na nb bi translated">对于相似的配置，Wrk2和Fortio在原点引起不同的延迟，并且它们随着QPS的增加而不同</li><li id="7e84" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">Wrk2似乎产生更多可重复的结果，在测试运行之间显示更少的抖动，而</li><li id="d69a" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">Wrk2能够产生在时间上更好分布的负载。Fortio似乎更多地以批处理方式执行请求(通过手动检查访问日志来观察)</li><li id="17f2" class="mr ms it kk b kl nc ko nd kr ne kv nf kz ng ld my mz na nb bi translated">与Fortio相比，Wrk2更适合细粒度(亚毫秒级)延迟测量</li></ul><h1 id="7b70" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">那现在怎么办？</h1><p id="1110" class="pw-post-body-paragraph ki kj it kk b kl mt ju kn ko mu jx kq kr oa kt ku kv ob kx ky kz oc lb lc ld im bi translated">基准测试微服务或服务网格需要一个负载生成器来提供一致且可重复的性能。选择正确的工具可以提高或降低您的应用程序性能，因为它会导致不适当的调优混乱和生产中不可预测的行为。</p><p id="502e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据工作负载/应用程序的预期运行时条件仔细选择工具。如果您关心毫秒级延迟或在高QPS场景下的一致性能，您的负载生成器应该模拟benhavior和Wrk2与Fortio相比似乎更好。当您考虑1000QPS的范围，并且不太关心亚秒延迟时，您可以选择Fortio。我已经在本文中深入解释了一些细节:</p><div class="od oe gp gr of og"><a href="https://sunkur.medium.com/5-things-to-know-about-service-mesh-performance-a8331765e995" rel="noopener follow" target="_blank"><div class="oh ab fo"><div class="oi ab oj cl cj ok"><h2 class="bd iu gy z fp ol fr fs om fu fw is bi translated">关于服务网格性能的5件事</h2><div class="on l"><h3 class="bd b gy z fp ol fr fs om fu fw dk translated">服务网格性能是否足够简单，可以获得任意两个端点之间的指标？原来它要复杂得多…</h3></div><div class="oo l"><p class="bd b dl z fp ol fr fs om fu fw dk translated">sunkur.medium.com</p></div></div><div class="op l"><div class="oq l or os ot op ou lo og"/></div></div></a></div></div></div>    
</body>
</html>