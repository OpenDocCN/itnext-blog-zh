<html>
<head>
<title>Mock promisified AWS service operation calls with Jest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Jest模拟承诺的AWS服务操作调用</h1>
<blockquote>原文：<a href="https://itnext.io/mock-promisified-aws-service-operation-calls-with-jest-6f11a22a371?source=collection_archive---------1-----------------------#2018-08-28">https://itnext.io/mock-promisified-aws-service-operation-calls-with-jest-6f11a22a371?source=collection_archive---------1-----------------------#2018-08-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/eb8de494e344506f285f30eb1768b162.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5IVmxQk8nIcC_qJ4n2fWBw.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">那是你读了我的故事后想“这家伙屁都不懂”😆(<a class="ae kc" href="https://www.pexels.com/photo/photo-of-a-woman-thinking-941555/" rel="noopener ugc nofollow" target="_blank">https://www . pexels . com/photo/photo-of-a-woman-thinking-941555/</a>)</figcaption></figure><p id="6e2f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<a class="lb lc ep" href="https://medium.com/u/c174a2050171?source=post_page-----6f11a22a371--------------------------------" rel="noopener" target="_blank"> Mbanq </a>我们在AWS上运行大部分服务，并尽可能多地使用AWS Lambda。</p><p id="f88c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最近我一直在做一个小的npm包，它将帮助我们利用SSM和KMS来管理我们的系统配置。作为AWS的大多数服务，SSM和KMS合作得很好。</p><p id="4341" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了测试新编写的npm包，我们不得不模拟承诺的版本<code class="fe ld le lf lg b">ssm.getParameters(request)</code></p><pre class="lh li lj lk gt ll lg lm ln aw lo bi"><span id="5e55" class="lp lq iq lg b gy lr ls l lt lu">const AWS = require('aws-sdk')<br/>const ssm = AWS.SSM({ region: 'eu-west-1 }) ssm.getParameters(request).promise() // we have to mock the response from this call</span></pre><p id="6f19" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">嘲笑AWS有不同的方式。例如，有来自非常酷的<a class="ae kc" href="http://DWYL" rel="noopener ugc nofollow" target="_blank"> DWYL </a>的<a class="ae kc" href="https://github.com/dwyl/aws-sdk-mock" rel="noopener ugc nofollow" target="_blank"> aws-mock-sdk </a>包。不过，我决定带着纯粹的玩笑去。</p><figure class="lh li lj lk gt jr gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/04d76818f9088d2a0e86383d2dccea6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:428/format:webp/1*yZyG4rhfvTehkTsKtLxD9Q.png"/></div></figure><p id="2ea5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要使SSM的功能可测试，您必须考虑以下因素:</p><ul class=""><li id="dda8" class="lw lx iq kf b kg kh kk kl ko ly ks lz kw ma la mb mc md me bi translated">在你的函数调用中使用<strong class="kf ir"> ssm </strong>作为参数，例如<code class="fe ld le lf lg b">const load = (ssm, keys, expiryMs)</code>它将帮助你在编写测试时使用被模仿的<code class="fe ld le lf lg b">ssm</code>。当然，你也可以<code class="fe ld le lf lg b">module.exports = { ssm }</code>连同你想导出的其他函数，但我真的不喜欢这个主意</li><li id="5d21" class="lw lx iq kf b kg mf kk mg ko mh ks mi kw mj la mb mc md me bi translated">如果你想检查一个<code class="fe ld le lf lg b">async/await</code>函数中抛出的错误，你必须使用:<code class="fe ld le lf lg b">expect(yourFunc()).rejects.toEqual(new Error(`Error Message`))</code>。常规的<code class="fe ld le lf lg b">expect(yourFunc()).toThrowError(`Error Message`)</code> <a class="ae kc" href="https://github.com/facebook/jest/issues/1700#issuecomment-377890222" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">行不通的</strong> </a></li></ul></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><p id="08fc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好吧，现在你可能会问自己:</p><blockquote class="mr ms mt"><p id="e348" class="kd ke mu kf b kg kh ki kj kk kl km kn mv kp kq kr mw kt ku kv mx kx ky kz la ij bi translated">你怎么能嘲笑承诺的AWS服务操作调用呢？</p></blockquote><p id="b552" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可能想要模拟来自<code class="fe ld le lf lg b">ssm.getParameters(request).promise()</code>的成功响应，或者模拟这个函数调用抛出的<code class="fe ld le lf lg b">Error</code>。</p><h2 id="fd61" class="lp lq iq bd my mz na dn nb nc nd dp ne ko nf ng nh ks ni nj nk kw nl nm nn no bi translated">成功响应</h2><p id="3364" class="pw-post-body-paragraph kd ke iq kf b kg np ki kj kk nq km kn ko nr kq kr ks ns ku kv kw nt ky kz la ij bi translated">首先，用<code class="fe ld le lf lg b">promise</code>键创建一个js对象，用将返回一个<code class="fe ld le lf lg b">Promise</code>的<code class="fe ld le lf lg b">jest.fn().mockImplementation()</code>模拟<code class="fe ld le lf lg b">promise</code>的值，当解析后返回一个成功的响应。</p><p id="a8df" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后每当调用<code class="fe ld le lf lg b">getParameters()</code>函数时，返回创建的<code class="fe ld le lf lg b">ssmPromise</code>。</p><pre class="lh li lj lk gt ll lg lm ln aw lo bi"><span id="b274" class="lp lq iq lg b gy lr ls l lt lu">const AWS = require('aws-sdk')<br/>let ssm = new AWS.SSM() <br/>const ssmPromise = {  <br/>  promise: jest.fn().mockImplementation((request) =&gt; {    <br/>    return new Promise((resolve, reject) =&gt; {      <br/>      const response = {        <br/>        Parameters: [          <br/>          {            <br/>            Name: 'bar',            <br/>            Type: 'String',            <br/>            Value: 'barfoorista',            <br/>            Version: 1,            <br/>            LastModifiedDate: '2018-08-22T13:49:55.717Z',                   <br/>            ARN: 'arn:aws:ssm:eu-west-1:whatever:parameter/bar'               <br/>          },          <br/>          {            <br/>            Name: 'foo',            <br/>            Type: 'String',            <br/>            Value: 'foobarista',            <br/>            Version: 1,            <br/>            LastModifiedDate: '2018-08-22T13:49:41.486Z',            <br/>            ARN: 'arn:aws:ssm:eu-west-1:whatever:parameter/foo'          <br/>           }        <br/>         ],        <br/>         InvalidParameters: []      <br/>       }      <br/>       resolve(response)    <br/>     })  <br/>  })<br/>}<br/>ssm = { getParameters: () =&gt; { return ssmPromise } }</span></pre><h2 id="40ba" class="lp lq iq bd my mz na dn nb nc nd dp ne ko nf ng nh ks ni nj nk kw nl nm nn no bi translated">抛出一个错误</h2><p id="8842" class="pw-post-body-paragraph kd ke iq kf b kg np ki kj kk nq km kn ko nr kq kr ks ns ku kv kw nt ky kz la ij bi translated">通过使用您在测试顶部创建的<code class="fe ld le lf lg b">ssm</code>实例，您还可以一次性模仿<code class="fe ld le lf lg b">ssm.getParameters()</code>。</p><p id="9a9f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是一个你如何模仿<code class="fe ld le lf lg b">ssm.getParameters()</code>抛出<code class="fe ld le lf lg b">Error</code>的例子</p><pre class="lh li lj lk gt ll lg lm ln aw lo bi"><span id="f952" class="lp lq iq lg b gy lr ls l lt lu">ssm = {      <br/>  getParameters: () =&gt; {        <br/>    return {          <br/>      promise: jest.fn().mockImplementation((request) =&gt; {            <br/>        return new Promise((resolve, reject) =&gt; {              <br/>          return reject(new Error('foobar'))            <br/>        }).catch(() =&gt; console.log('Ok'))          <br/>      })        <br/>    }      <br/>  }    <br/>}</span></pre><p id="f1db" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<code class="fe ld le lf lg b">gist</code>(双关语)中，你可以看到测试的一部分，我们用它来测试我们的包。</p><figure class="lh li lj lk gt jr"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="8e32" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该软件包仍在开发中。一旦它发布，你就可以通过运行<code class="fe ld le lf lg b">npm i --save sreda</code>来安装它</p></div></div>    
</body>
</html>