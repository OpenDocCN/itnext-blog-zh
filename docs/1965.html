<html>
<head>
<title>Dockerized single-node EdgeFS with geo-transparent S3/NFS access</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有地理透明的S3/NFS访问的对接单节点EdgeFS</h1>
<blockquote>原文：<a href="https://itnext.io/dockerized-single-node-edgefs-with-geo-transparent-s3-nfs-access-1415b5ed5d27?source=collection_archive---------3-----------------------#2019-03-04">https://itnext.io/dockerized-single-node-edgefs-with-geo-transparent-s3-nfs-access-1415b5ed5d27?source=collection_archive---------3-----------------------#2019-03-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="8e79" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您碰巧需要一种快速简单的方法来启动具有地理透明数据访问的单节点S3/NFS集群，或者只是简单的单节点EdgeFS安装，本文可能会有所帮助！</p><p id="d649" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">什么是EdgeFS？这是CNCF鲁克项目的一个新的存储提供商，你可以在https://rook.io/docs/rook/master/edgefs-storage.html了解更多信息。但您也可以在所谓的“solo”模式下运行它，这是一种单节点Docker容器，能够随着部署的增长而扩展，只需连接更多节点和/或地理上分散的集群段即可。</p><p id="b78f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">EdgeFS的优势在于它能够将底层基础架构虚拟化为可扩展、高可用性的分布式存储系统。它的工作方式类似于“git ”,其中所有的修改都是全局不可变的、完全版本化的、自我验证的、分布式的，因此是容错的。因此，它支持对对象、文件和数据块常用存储协议的跨云和地理透明的高性能分布式访问。</p><h1 id="67f8" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">使用案例—地理分布的S3/NFS归档</h1><p id="3c7d" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">地理上分散且透明的S3/NFS可访问存档。数百万个大约1MB大小的小对象，可在2个以上的分段位置访问，用于非结构化归档模式读写，性能特征受分段内存、CPU和磁盘类型的限制。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/dfae1d34b05205a832a6d254d63d3f64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1108/format:webp/1*gV1pzJnFJ0WOxzijeBlYdg.png"/></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">分布式双向EdgeFS命名空间分段</figcaption></figure><p id="dac9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我想让这一步一步的说明尽可能简单，但同时演示随机1MB I/O访问的高性能用例的实现。因此，我将使用混合风格的EdgeFS目标部署，配备10个硬盘和2个固态硬盘，以实现更好的性价比。我的第一个段的磁盘配置如下所示:</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="19a3" class="mj kq it mf b gy mk ml l mm mn"># lsblk -o name,model,vendor,rota<br/>NAME           MODEL            VENDOR   ROTA<br/>sda            MICRON_M510DC_MT ATA         0<br/>sdb            MG04SCA40EE      TOSHIBA     1<br/>sdc            MG04SCA40EE      TOSHIBA     1<br/>sdd            MG04SCA40EE      TOSHIBA     1<br/>sde            MG04SCA40EE      TOSHIBA     1<br/>sdf            MICRON_M510DC_MT ATA         0<br/>sdh            MG04SCA40EE      TOSHIBA     1<br/>sdi            MG04SCA40EE      TOSHIBA     1<br/>sdj            MG04SCA40EE      TOSHIBA     1<br/>sdk            MG04SCA40EE      TOSHIBA     1<br/>sdl            MG04SCA40EE      TOSHIBA     1</span></pre><p id="d0ec" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">其他段可以位于相同或遥远的位置。在本文中，我们将配置连接2+ EdgeFS段的ISGW链路。</p><p id="d868" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">与其进入冗长的docker命令行解释，我想我们可以用一个优秀的<a class="ae ko" href="https://docs.docker.com/compose/install/" rel="noopener ugc nofollow" target="_blank"> docker-compose工具</a>来稍微自动化一下。您需要一个支持2.4格式的版本。</p><h1 id="4647" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">步骤0。下载docker-compose.yml文件</h1><p id="8876" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">Docker-compose文件列出了我们需要并设计在/edgefs目录中工作的所有服务。从<a class="ae ko" href="https://gist.github.com/dyusupov/d407cb89f8e8644f7a785cb35b62493c#file-docker-compose-yml" rel="noopener ugc nofollow" target="_blank">这个gist </a>下载并安装到一个空的/edgefs目录下。验证“docker-compose ps”返回成功。</p><h1 id="5d70" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">第一步。准备原始磁盘</h1><p id="72cc" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">使用原始磁盘的EdgeFS(未创建文件系统！)作为其存储介质。它将传统的块设备转换为虚拟化的键值数据库。配置单个节点目标的最简单方法是为节点上的每个原始磁盘手动执行“wipefs -a /dev/DEV”命令，并让EdgeFS配置向导构建其最佳配置。</p><h1 id="922a" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">第二步。配置目标</h1><p id="0a41" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">在启动docker-compose服务之前，我们需要配置EdgeFS目标服务。为了实验，我准备了几个我们可以玩的选项。</p><h2 id="70a0" class="mj kq it bd kr mo mp dn kv mq mr dp kz kb ms mt ld kf mu mv lh kj mw mx ll my bi translated">备选方案1。所有硬盘配置</h2><p id="d830" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">在此选项中，我们将忽略已安装的SSD，并命令我们的配置向导只选择HDD。此选项非常适用于低温、廉价和深度归档:</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="dfbd" class="mj kq it mf b gy mk ml l mm mn">docker-compose run --rm -e CCOW_LOG_STDOUT=1 target config node \<br/>    -i enp5s0f0 -d rtrd -p rtrdAllHDD -o \ '{"LmdbPageSize":32768,"HDDReadAhead":512,"DisableVerifyChid":true}'</span></pre><h2 id="8cf8" class="mj kq it bd kr mo mp dn kv mq mr dp kz kb ms mt ld kf mu mv lh kj mw mx ll my bi translated">选项2。混合硬盘/固态硬盘配置，固态硬盘上有元数据和WAL</h2><p id="169b" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">如果您只想对数据块使用循环介质，这是一个很好的选择。EdgeFS RT-RD在合并流I/O写入方面做得很好。我建议将此选项用于任何类型的活动归档:</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="7506" class="mj kq it mf b gy mk ml l mm mn">docker-compose run --rm -e CCOW_LOG_STDOUT=1 target config node \<br/>    -i enp5s0f0 -d rtrd -p rtrdMDOffload -o \ '{"LmdbPageSize":32768,"HDDReadAhead":512,"DisableVerifyChid":true}'</span></pre><p id="0634" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可能需要替换的上述配置的重要部分:“-i enp5s0f0”需要指向服务可用的接口名称，“-o …”命令支持最佳混合HDD/SSD配置和512k b HDD预读。</p><h2 id="ba74" class="mj kq it bd kr mo mp dn kv mq mr dp kz kb ms mt ld kf mu mv lh kj mw mx ll my bi translated">选项3。简单的选项，所有数据都在/edgefs/data目录中</h2><p id="fc16" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">此选项用于非生产用途。配置后，它将利用本地装载的位置/edgefs/data，并创建4个模拟设备。您会注意到“efscli”的汇总输出乘以4，但现在忽略它。因此，要启用这种模式，只需运行以下命令:</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="8e46" class="mj kq it mf b gy mk ml l mm mn">docker-compose run --rm -e CCOW_LOG_STDOUT=1 target config node \<br/>    -l localhost -i eth0 -d rtlfs</span></pre><p id="c1e6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您想要调整建议的配置，请传递“— help”标志。</p><p id="5757" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">完成后，您可以在/edgefs/etc目录中查看创建的配置。您可以多次运行config node命令，直到您对配置满意为止。</p><h1 id="f4a4" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">第三步。启动目标并初始化服务</h1><p id="6835" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">启动目标和预配置的服务。这包括休息管理服务、GUI、NFS和S3。</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="00af" class="mj kq it mf b gy mk ml l mm mn"># docker-compose up -d<br/>Creating edgefs_target_1<br/>Creating edgefs_nfs01_1<br/>Creating edgefs_mgmt_1<br/>Creating edgefs_s301_1<br/>Creating edgefs_ui_1<br/>Creating edgefs_isgw01_1</span><span id="c30b" class="mj kq it mf b gy mz ml l mm mn"># docker-compose logs -f</span></pre><p id="b14a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第一次启动可能需要几分钟，因为它需要准备磁盘。您可以监控其进度，也可以登录到工具箱:</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="8ed8" class="mj kq it mf b gy mk ml l mm mn"># docker-compose exec mgmt toolbox</span><span id="45db" class="mj kq it mf b gy mz ml l mm mn">Welcome to EdgeFS Toolbox.<br/>Hint: type efscli to begin</span><span id="91be" class="mj kq it mf b gy mz ml l mm mn"># efscli system status<br/>ServerID B86037FF3C399D636A270A2BB4E6780E node3075ub16 ONLINE</span></pre><h2 id="5a70" class="mj kq it bd kr mo mp dn kv mq mr dp kz kb ms mt ld kf mu mv lh kj mw mx ll my bi translated">初始化集群段“myspace”</h2><p id="1dd3" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">状态为在线后，初始化集群并创建系统对象:</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="899f" class="mj kq it mf b gy mk ml l mm mn">### initialize local cluster segment<br/>efscli system init</span><span id="4667" class="mj kq it mf b gy mz ml l mm mn">### initialize myspace/work/shared1<br/>efscli cluster create myspace<br/>efscli tenant create myspace/work<br/>efscli bucket create myspace/work/shared1 \<br/>    -s 512K -r 2 -R 1 -t 1 -c 3:1:xor -C 2h</span></pre><p id="cba8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">EdgeFS使用全局唯一的系统路径，格式为名称空间/租户/存储桶/对象。在上面的示例中，我们创建了“myspace/work/shared”存储桶，在对象版本超过2小时、复制计数为2且1个副本延迟、默认区块大小为512KB时，触发XOR擦除编码模式3:1。</p><p id="1e47" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们还可以连接到GUI，通过将web浏览器指向http://IPADDR:3000 (默认用户管理，默认密码是edgefs)来创建/监控/管理服务。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi na"><img src="../Images/3276043adfbb4548a02a1bebc6ae1be9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E03AAQ7SCT0K8ym5nF8k_w.png"/></div></div></figure><h2 id="ea3a" class="mj kq it bd kr mo mp dn kv mq mr dp kz kb ms mt ld kf mu mv lh kj mw mx ll my bi translated">EdgeFS中的擦除编码设计</h2><p id="89d6" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">EdgeFS中的EC有许多好处，特别是在我们的示例中，它被设计为后处理，它延迟编码，直到对象被认为是冷的(配置为自版本创建起经过2小时)。它通过删除一组3个区块的4个不再需要的副本并在后台添加1个奇偶校验区块来保留不可变的对象结构，因此，与普通复制相比，写入I/O路径不受影响。在编码过程中，最初的3个区块保持未编码，因此后续读取I/O不需要重建，因此对冷数据读取性能没有影响。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/570ec9a00c6a73367b433d024b5f9949.png" data-original-src="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*0UK5pt9Frw-2pDvYN2D_YQ.png"/></div></figure><p id="a158" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="ng">重要提示:</em>对于要触发的每个编码模式，集群需要有≥ n_data+n_parity故障域，并且存储桶复制计数必须≥ n_parity+1。例如，对于3:1:xor模式和设备级故障域(单节点)，集群段需要提供至少4个设备。</p><p id="3a3a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">总结一下:</p><ul class=""><li id="3ca0" class="nh ni it js b jt ju jx jy kb nj kf nk kj nl kn nm nn no np bi translated">当数据“变冷”时，编码作为后处理完成(可调)。对写入性能没有影响</li><li id="fd53" class="nh ni it js b jt nq jx nr kb ns kf nt kj nu kn nm nn no np bi translated">编码是“跨块”执行的。对读取性能没有影响:数据区块的完整副本保留在集群中</li><li id="1f9e" class="nh ni it js b jt nq jx nr kb ns kf nt kj nu kn nm nn no np bi translated">完全分布式丢失奇偶校验/区块重建</li><li id="94f7" class="nh ni it js b jt nq jx nr kb ns kf nt kj nu kn nm nn no np bi translated">支持冷-&gt;热数据修改(覆盖)</li><li id="f88f" class="nh ni it js b jt nq jx nr kb ns kf nt kj nu kn nm nn no np bi translated">支持灵活的模式:2:1:异或，3:1:异或，4:2:rs，6:2:rs，9:3:rs</li></ul><h1 id="b60d" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">第三步。创建S3、NFS和ISGW服务</h1><p id="5629" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">既然已经创建了集群命名空间段、租户和存储桶，我们就可以设置S3、NFS和ISGW服务定义了:</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="fcc4" class="mj kq it mf b gy mk ml l mm mn">### NFS service with myspace/work/shared1 export<br/>efscli service create nfs nfs01<br/>efscli service config nfs01 X-MH-ImmDir 1<br/>efscli service serve nfs01 myspace/work/shared1</span><span id="907b" class="mj kq it mf b gy mz ml l mm mn">### S3 service servicing myspace/work tenant<br/>efscli service create s3 s301<br/>efscli service serve s301 myspace/work</span><span id="3a32" class="mj kq it mf b gy mz ml l mm mn">### ISGW endpont link<br/>efscli service create isgw isgw01<br/>efscli service serve isgw01 myspace/work/shared1<br/>efscli service config isgw01 X-ISGW-Remote ccow://REMOTE_IP:14000<br/>efscli service config isgw01 X-Status enabled</span></pre><p id="f395" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此时，docker-compose脚本将在下一次策略重启时获取更改，服务应该可用。如果由于某种原因它没有启动，使用以下命令加速服务重启:</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="e72d" class="mj kq it mf b gy mk ml l mm mn">docker-compose logs -f nfs01         # monitor nfs service logs<br/>docker-compose logs -f s301          # monitor s3 service logs<br/>docker-compose logs -f isgw01        # monitor isgw01 service logs</span><span id="520a" class="mj kq it mf b gy mz ml l mm mn">docker-compose restart nfs01<br/>docker-compose restart s301<br/>docker-compose restart isgw01</span></pre><h1 id="829c" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">第四步。连接EdgeFS集群段</h1><p id="fd3c" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">EdgeFS段间网关链接是EdgeFS跨段、跨云全局名称空间同步功能的构建块。</p><p id="1e0f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">它异步分发已修改的数据块，并实现对文件、对象和块设备的无缝和地理上透明的访问。值得注意的是，文件或块设备由一个或多个对象组成，因此，在EdgeFS范围内，最终所有东西都是对象，全局不可变且自我验证。</p><p id="44d2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">打个比方，EdgeFS对修改的全局不变性的概念非常类似于“git”对存储库提交和分支的操作方式。因此，这种技术使EdgeFS用户能够构建和操作广泛分布的全局名称空间，同时大大简化了管理开销。ISGW端点链接会立即注意到在设置了ISGW链接的源站点上修改的文件或对象，从而传播更改。最终，所有连接的站点都将收到文件修改，其中只传输修改过的数据块。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nv"><img src="../Images/35b78ab6eab73c2f74780b763278aa29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FVqMsnByTLDkvYaA3bcW6g.png"/></div></div></figure><p id="5208" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ISGW link不仅减少了需要传输的数据量，还消除了传输中的重复数据。匹配文件更改的全局唯一加密签名将不会被传输，从而启用全局命名空间重复数据删除。</p><p id="823c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ISGW链接可以是双向的，即支持跨名称空间的相同文件/对象修改。它适用于许多应用程序逻辑可以确保变更序列化的用例。单个双向链接可以连接两个站点，但也可以根据需要创建尽可能多的非重叠链接。</p><p id="7e9a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ISGW link还可以透明地同步文件、对象、目录、存储桶或租户级快照，这些快照被分组到所谓的SnapView结构中。因此，例如，对块设备修改可以在整个全局命名空间中一致地查看。</p><p id="4055" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因为EdgeFS元数据也是全局不可变和唯一的，所以可以启用只传输元数据更改的模式。启用此模式后，用户可以构建高效的访问端点，在那里可以按需获取修改，这是通过内置的E-LRU回收策略创建全球和地理分布式缓存雾聚合的结果。</p><p id="c2ab" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">每个站点的本地I/O以物理或虚拟连接的媒体设备的速度执行。最终传输全局不可变的修改(版本),并且不会降低本地站点运行应用程序工作流的速度。</p><p id="6e37" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">假设此时2段都已配置了步骤1–3，我们现在可以创建双向ISGW链路。</p><p id="1aba" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">以下命令解释了如何创建段间链接:</p><h1 id="cd18" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">验证和性能</h1><p id="221b" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">现在是有趣的部分，让我们使用服务和验证功能，并获得我们想要的用例的最佳性能。</p><p id="57f6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们从主要场景开始，模拟创建100，000个1MB的S3对象。为此，我们需要安装CosBench:</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="f2f3" class="mj kq it mf b gy mk ml l mm mn">COS_HOST=10.3.30.75<br/>docker run --rm -d -p 19088:19088 -p 18088:18088 -e ip=$COS_HOST \<br/>    -e t=both -e n=1 -e u=true nexenta/cosbench</span></pre><p id="1636" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">登录<a class="ae ko" href="http://10.3.30.75:19088/controller/" rel="noopener ugc nofollow" target="_blank">http://$ COS _ HOST:19088/controller/</a>，提交<a class="ae ko" href="https://gist.github.com/dyusupov/dded61c4a3dc815de48a7d7dbb0c0206" rel="noopener ugc nofollow" target="_blank">本要点</a>的工作量。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/ee4af5d09a3b6f4a76c4541ee319ac86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*IVaIMi5pNyz4sK4HRgmU8Q.png"/></div></figure><p id="c1f4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了便于实验，现在让我们在NFS上空，在同一个铲斗上运行一个类似的测试。以下fio命令将完成这项工作:</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="6a61" class="mj kq it mf b gy mk ml l mm mn">### mount NFS share</span><span id="1b58" class="mj kq it mf b gy mz ml l mm mn">mkdir /mnt/shared1<br/>showmount -e $COS_HOST<br/>mount -t nfs $COS_HOST:/work/shared1 /mnt/shared1 -o tcp<br/>mkdir /mnt/shared1/dir1</span><span id="919c" class="mj kq it mf b gy mz ml l mm mn">### execute FIO test</span><span id="4a0a" class="mj kq it mf b gy mz ml l mm mn">fio -name=myjob -directory=/mnt/shared1/dir1 -ioengine=psync \<br/>    -norandommap -randrepeat=0 -allrandrepeat=0 -refill_buffers \<br/>    -blocksize=1M -nrfiles=1000 -filesize=1M -rw=write -buffered=0 \<br/>    -buffer_compress_percentage=0 -dedupe_percentage=0 \<br/>    -iodepth=2 -numjobs=10 -fallocate=none -group_reporting</span></pre><p id="2f6a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">总的来说，NFS更多的元数据密集型协议，因此，我不认为人们会希望使用所有的硬盘配置来处理大量的小文件。因此，我们将实验仅限于混合配置。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/83149309f16d24385430b9499e0478fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/1*hTjtrXhn8jy3pfPCyZTH1A.png"/></div></figure><p id="e59c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">NFS的性能与S3相似，只是元数据的开销微不足道。现在让我们探索一下我们是否能够透明地访问文件和对象:</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="fe1d" class="mj kq it mf b gy mk ml l mm mn">### Place an object via S3 and access via NFS</span><span id="5a50" class="mj kq it mf b gy mz ml l mm mn">curl <a class="ae ko" href="http://localhost:9982/shared1/path/to/obj1" rel="noopener ugc nofollow" target="_blank">http://$COS_HOST:9982/shared1/path/to/obj1</a> -X PUT<br/>ls /mnt/shared1/.objects/path/to/obj1</span><span id="02dd" class="mj kq it mf b gy mz ml l mm mn">### Place a file via NFS and access via S3</span><span id="3662" class="mj kq it mf b gy mz ml l mm mn">mkdir -p /mnt/shared1/dir/to; touch /mnt/shared1/dir/to/file1<br/>curl <a class="ae ko" href="http://localhost:9982/shared1/.nfs/dir/to/file1" rel="noopener ugc nofollow" target="_blank">http://$COS_HOST:9982/shared1/.nfs/dir/to/file1</a></span></pre><p id="19cc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">完全保留路径，并且可以在同一个群集段内透明地访问文件/对象。现在，让我们切换到第二个集群段，尝试访问同一个对象和文件:</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="2f22" class="mj kq it mf b gy mk ml l mm mn">### Second segment has our modifications and preserves transaprency</span><span id="7986" class="mj kq it mf b gy mz ml l mm mn">ls /mnt/shared1/.objects/path/to/obj1<br/>curl <a class="ae ko" href="http://localhost:9982/shared1/.nfs/dir/to/file1" rel="noopener ugc nofollow" target="_blank">http://$COS_HOST2:9982/shared1/.nfs/dir/to/file1</a></span><span id="a132" class="mj kq it mf b gy mz ml l mm mn">### We can also see all the objects and files that we created during <br/>### our performance tests</span><span id="0692" class="mj kq it mf b gy mz ml l mm mn">ls /mnt/shared1/dir1|wc -l<br/>10002</span><span id="3f86" class="mj kq it mf b gy mz ml l mm mn">### We can display syncing statistics<br/>efscli service show isgw01 -s</span><span id="cd02" class="mj kq it mf b gy mz ml l mm mn">X-Service-Name: isgw01<br/>X-Service-Type: isgw<br/>X-Description: Inter Segment Gateway<br/>X-Auth-Type: disabled<br/>X-Servers: -<br/>X-Container-Network: -<br/>X-ISGW-Basic-Auth: -<br/>X-ISGW-Direction: -<br/>X-ISGW-MDOnly: -<br/>X-ISGW-Encrypted-Tunnel: -<br/>X-ISGW-DFLocal: 0.0.0.0:49678<br/>X-ISGW-Replication: 3<br/>X-ISGW-Local: 0.0.0.0:14000<br/>X-ISGW-Remote: ccow://10.3.30.75:14000<br/>X-Status: enabled<br/>[<br/>  myspace/work/shared1<br/>]</span><span id="44f4" class="mj kq it mf b gy mz ml l mm mn">Stats: [<br/>myspace/work/shared1: {<br/>        "timestamp":         1551664249664,<br/>        "status":            "active",<br/>        "state":            "continuous",<br/>        "delay":             29664,<br/>        "version_manifests": 1,<br/>        "requests":          2,<br/>        "chunk_manifests":   0,<br/>        "data_chunks":       0,<br/>        "snapshots":         0,<br/>        "bytes":             693,<br/>        "latency":           81<br/>}<br/>]</span></pre><p id="bd8c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里假设所有链接的集群段都预先创建了myspace/work名称空间和租户。如果需要，我们可以在租户级别轻松覆盖源对象属性，从而提供一种利用集群段物理特征的方式，并以更具成本效益的方式利用基础架构。</p><h1 id="10db" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">拆卸</h1><p id="70e5" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">要清理并重新开始，这些命令会很有用:</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="a8ac" class="mj kq it mf b gy mk ml l mm mn">docker-compose down<br/>docker-compose run --rm -e CCOW_LOG_STDOUT=1 target toolbox \<br/>    nezap --do-as-i-say<br/>partprobe                  # refresh partitions tables<br/>rm -f ./var/run/flexhash*  # reset previously discovered FlexHash</span></pre><p id="d727" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">它会在/edgefs/etc中保留当前配置，同时会清理磁盘和缓存，以便可以重新创建或重新初始化配置。</p><h1 id="33d1" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">摘要</h1><p id="83d6" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">EdgeFS利用本地可用的资源，并将它们呈现为高可用性的集群段。由于其不可变的数据结构设计、通过低延迟协议的动态数据放置以及高度可扩展的无共享架构，实现了出色的性能特征。本地创建的集群段可以根据性能和容量要求进行扩展，只需向其中添加更多服务器即可。</p><p id="a5f5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">EdgeFS对于可以创建多少个集群段没有限制。全网状网络可以像传统主-从或双向链路一样工作。它工作的原因是元数据是全局唯一的和不可变的，因此允许跨段传输协议避免修改的分布(如果存在的话)。因此，段间网关上的重复数据消除可以极大地节省出口成本，因为它处理压缩数据块，不需要传输重复数据。</p><p id="a525" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">今天就试试吧！让我知道你的想法？</p><p id="3501" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">加入我们日益壮大的社区，了解更多信息，网址为:http://edgefs.io 和<a class="ae ko" href="http://rook.io" rel="noopener ugc nofollow" target="_blank"> http://rook.io </a></p></div></div>    
</body>
</html>