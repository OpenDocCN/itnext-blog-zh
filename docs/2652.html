<html>
<head>
<title>Using Bitbucket Pipelines to create a Docker image</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用位桶管道创建Docker映像</h1>
<blockquote>原文：<a href="https://itnext.io/using-bitbucket-pipelines-to-create-a-docker-image-ad40b99d4969?source=collection_archive---------1-----------------------#2019-07-04">https://itnext.io/using-bitbucket-pipelines-to-create-a-docker-image-ad40b99d4969?source=collection_archive---------1-----------------------#2019-07-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="0f5c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用管道创建Docker映像并将新创建的Docker映像推送到AWS ECR的示例。</p><p id="3679" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">场景:</strong>您正在使用一个AWS容器服务，并且需要构建一个Docker映像来部署它。</p><p id="cd48" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，我们将在项目的根目录下创建一个空白文件bitbucket-pipelines.yml，并复制到下面的模板中。</p><figure class="ko kp kq kr gt ks"><div class="bz fp l di"><div class="kt ku l"/></div></figure><p id="0d85" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">模板细分:</p><ul class=""><li id="a37a" class="kv kw it js b jt ju jx jy kb kx kf ky kj kz kn la lb lc ld bi translated">在<em class="le">图像下的第1行，</em>我们定义了每个构建步骤将使用的默认图像。</li><li id="7453" class="kv kw it js b jt lf jx lg kb lh kf li kj lj kn la lb lc ld bi translated">第4行在<em class="le">定义下，</em>我们定义我们的构建步骤和它们的逻辑。</li><li id="c639" class="kv kw it js b jt lf jx lg kb lh kf li kj lj kn la lb lc ld bi translated">在<em class="le">管道下的第6行，</em>我们定义何时触发我们的构建步骤。</li></ul><p id="57cf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从这里我们可以添加我们的第一个构建步骤和触发器。我们的第一个构建步骤将处理图像的构建并将其推送到AWS ECR。接下来，我们将设置我们的触发器，这样当变更被推/合并到主分支时，它将运行构建映像步骤。</p><figure class="ko kp kq kr gt ks"><div class="bz fp l di"><div class="kt ku l"/></div></figure><p id="1d16" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">构建步骤分解(第6行到第18行):</p><ul class=""><li id="b2a3" class="kv kw it js b jt ju jx jy kb kx kf ky kj kz kn la lb lc ld bi translated">第6行是显示在Bitbucket中的用户友好名称。</li><li id="1560" class="kv kw it js b jt lf jx lg kb lh kf li kj lj kn la lb lc ld bi translated">第7行定义了Bitbucket服务器上缓存的依赖项，以减少构建时间。</li><li id="e6b2" class="kv kw it js b jt lf jx lg kb lh kf li kj lj kn la lb lc ld bi translated">第9行定义了构建步骤中使用的服务，这些服务运行在独立但链接的容器中。</li><li id="bb2a" class="kv kw it js b jt lf jx lg kb lh kf li kj lj kn la lb lc ld bi translated">第11行定义了为这个构建步骤运行的命令。</li></ul><p id="6050" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">构建步骤脚本分解(从第12行开始):</p><ul class=""><li id="c170" class="kv kw it js b jt ju jx jy kb kx kf ky kj kz kn la lb lc ld bi translated">第12行是我们制作图像URI的地方，包括它所在的路径和标签。</li><li id="a220" class="kv kw it js b jt lf jx lg kb lh kf li kj lj kn la lb lc ld bi translated">第14行我们运行“aws ecr get-login”来检索带有正确凭证的docker登录命令，然后使用eval来运行返回的命令。</li><li id="3b14" class="kv kw it js b jt lf jx lg kb lh kf li kj lj kn la lb lc ld bi translated">第16行构建Docker图像，同时标记它。</li><li id="9b83" class="kv kw it js b jt lf jx lg kb lh kf li kj lj kn la lb lc ld bi translated">最后，第18行将新创建的图像推送到AWS ECR。</li></ul><p id="58da" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此时，你可能会想等等变量DOCKER_IMAGE_URL和BITBUCKET_BUILD_NUMBER是在哪里定义的？</p><p id="77ea" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Bitbucket pipelines提供了一组默认变量，这些变量以Bitbucket开头，这使得很容易将它们与用户定义的变量区分开来。另一方面，DOCKER_IMAGE_URL需要在Bitbucket中与其他3个变量一起定义，这可以通过以下方式完成:</p><ol class=""><li id="1534" class="kv kw it js b jt ju jx jy kb kx kf ky kj kz kn lk lb lc ld bi translated">转到Bitbucket中的存储库</li><li id="00e8" class="kv kw it js b jt lf jx lg kb lh kf li kj lj kn lk lb lc ld bi translated">点击左侧第二个菜单栏中的<em class="le">设置</em></li><li id="0545" class="kv kw it js b jt lf jx lg kb lh kf li kj lj kn lk lb lc ld bi translated">点击管道标题下的<em class="le">储存库变量</em></li></ol><p id="e7cf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">4个用户定义的变量:</p><figure class="ko kp kq kr gt ks"><div class="bz fp l di"><div class="kt ku l"/></div></figure><p id="0152" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，您已经完成了所有这些工作，您可以继续添加额外的构建步骤来简化构建和部署工作流。</p><h1 id="b212" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">奖金:</h1><p id="8b7c" class="pw-post-body-paragraph jq jr it js b jt mj jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn im bi translated">作为奖励，我包含了一个示例管道文件，它将:</p><ul class=""><li id="bc4c" class="kv kw it js b jt ju jx jy kb kx kf ky kj kz kn la lb lc ld bi translated">运行composer install(针对PHP)。</li><li id="552a" class="kv kw it js b jt lf jx lg kb lh kf li kj lj kn la lb lc ld bi translated">建立码头工人形象。</li><li id="e2e6" class="kv kw it js b jt lf jx lg kb lh kf li kj lj kn la lb lc ld bi translated">上传一个豆茎神器。</li><li id="e42e" class="kv kw it js b jt lf jx lg kb lh kf li kj lj kn la lb lc ld bi translated">部署到试运行和生产环境。</li></ul><p id="9a97" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面是我的示例库的链接。</p><figure class="ko kp kq kr gt ks"><div class="bz fp l di"><div class="kt ku l"/></div></figure><div class="mo mp gp gr mq mr"><a href="https://github.com/zimosworld/beanstalk-single-php-container" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd iu gy z fp mw fr fs mx fu fw is bi translated">zimos world/beanstalk-单PHP-容器</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">使用Terraform和Bitbucket管道的Beanstalk设置示例</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">github.com</p></div></div><div class="na l"><div class="nb l nc nd ne na nf ng mr"/></div></div></a></div></div></div>    
</body>
</html>