<html>
<head>
<title>What’s New in Jakarta Persistence 3.1 By Examples</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Jakarta Persistence 3.1的新特性示例</h1>
<blockquote>原文：<a href="https://itnext.io/whats-new-in-jakarta-persistence-3-1-by-examples-81b292e8b3a4?source=collection_archive---------1-----------------------#2022-11-13">https://itnext.io/whats-new-in-jakarta-persistence-3-1-by-examples-81b292e8b3a4?source=collection_archive---------1-----------------------#2022-11-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="cd49" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Jakarta Persistence(又名JPA) 3.1带来了一系列改进。</p><ul class=""><li id="24d3" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated"><code class="fe ku kv kw kx b">UUID</code>类现在被视为基本Java类型。为了支持<code class="fe ku kv kw kx b">Entity</code>级的UUID型<code class="fe ku kv kw kx b">ID</code>，JPA引进了一种新的UUID发电机。</li><li id="333c" class="kl km iq jp b jq ky ju kz jy la kc lb kg lc kk kq kr ks kt bi translated">JPQL和类型安全标准API中添加了几个数字函数和特定于日期/时间的函数。</li></ul><p id="056d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">更多详情请阅读<a class="ae ld" href="https://newsroom.eclipse.org/eclipse-newsletter/2022/march/what%E2%80%99s-new-jakarta-persistence-31" rel="noopener ugc nofollow" target="_blank">雅加达持久性3.1新特性</a>。</p><p id="8f39" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，让我们通过编写一些真实的示例代码来探索这些特性。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/29c027320a520928e823994777cb05c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gFXKiQoL1Di8pJaVGxvxgQ.jpeg"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">照片由<a href="”&lt;a" class="ae ld" rel="noopener ugc nofollow" target="_blank">&amp;UTM _ medium = referral&amp;UTM _ content = creditCopyText</a>"&gt;阿莱西奥·林&lt; /a &gt;于&lt;a href = "<a class="ae ld" href="https://unsplash.com/s/photos/china-building?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">https://unsplash.com/s/photos/china-building?UTM _ source = Unsplash&amp;UTM _ medium = referral&amp;UTM _ content = creditCopyText</a>"&gt;Unsplash&lt;/a&gt;</figcaption></figure><h1 id="c91f" class="lu lv iq bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">休眠6.1</h1><p id="9913" class="pw-post-body-paragraph jn jo iq jp b jq ms js jt ju mt jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">通过<a class="ae ld" href="https://maven.apache.org/archetypes/maven-archetype-quickstart/" rel="noopener ugc nofollow" target="_blank"> Maven Quickstart原型</a>生成一个简单的<strong class="jp ir"> Java应用</strong>项目。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="e3fc" class="nb lv iq kx b be nc nd l ne nf">mvn archetype:generate<br/>    -DarchetypeGroupId=org.apache.maven.archetypes<br/>    -DarchetypeArtifactId=maven-archetype-quickstart<br/>    -DarchetypeVersion=1.4</span></pre><p id="4559" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有一些交互式的步骤来指导你设置项目信息，如groupId，工件，版本等。在这个示例项目中，我们使用<code class="fe ku kv kw kx b">com.example</code>作为groupId，使用<code class="fe ku kv kw kx b">demo</code>作为artifactId。然后确认并开始生成项目源代码。</p><p id="e4f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完成后，在Java IDE中打开项目，例如IntelliJ IDEA(Community Edition是免费的)，或者Eclipse Java/Java EE bundle，或者NetBeans IDE，或者一个简单的文本编辑器，例如VS Code。</p><p id="c0c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">修改项目根文件夹中的<em class="ng"> pom.xml </em>，添加Hibernate 6.1、JUnit等。到项目依赖项中，并设置Maven编译器插件来使用Java 17编译源代码。</p><p id="73ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最终的<em class="ng"> pom.xml </em>如下所示。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="19bc" class="nb lv iq kx b be nc nd l ne nf">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br/>&lt;project <br/>         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br/>         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;<br/>    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span></pre><pre class="nh mx kx ni nj aw nk bi"><span id="b900" class="nl lv iq kx b gy nm nn l no nf">    &lt;groupId&gt;org.example&lt;/groupId&gt;<br/>    &lt;artifactId&gt;hibernate6&lt;/artifactId&gt;<br/>    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;<br/>    &lt;parent&gt;<br/>        &lt;groupId&gt;com.example&lt;/groupId&gt;<br/>        &lt;artifactId&gt;jakartaee10-sandbox-parent&lt;/artifactId&gt;<br/>        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;<br/>        &lt;relativePath&gt;..&lt;/relativePath&gt;<br/>    &lt;/parent&gt;</span><span id="89ec" class="nl lv iq kx b gy np nn l no nf">    &lt;name&gt;hibernate6&lt;/name&gt;<br/>    &lt;description&gt;Jakarta EE 10 Sandbox: Hibernate 6/JPA 3.1 example&lt;/description&gt;</span><span id="861f" class="nl lv iq kx b gy np nn l no nf">    &lt;properties&gt;<br/>        &lt;maven.compiler.release&gt;17&lt;/maven.compiler.release&gt;</span><span id="5c5a" class="nl lv iq kx b gy np nn l no nf">        &lt;!-- requires 6.1.2.Final or higher --&gt;<br/>        &lt;hibernate.version&gt;6.1.4.Final&lt;/hibernate.version&gt;<br/>        &lt;h2.version&gt;2.1.214&lt;/h2.version&gt;</span><span id="17b2" class="nl lv iq kx b gy np nn l no nf">        &lt;!-- test deps --&gt;<br/>        &lt;junit-jupiter.version&gt;5.9.1&lt;/junit-jupiter.version&gt;<br/>        &lt;assertj-core.version&gt;3.23.1&lt;/assertj-core.version&gt;</span><span id="93d7" class="nl lv iq kx b gy np nn l no nf">        &lt;slf4j.version&gt;2.0.3&lt;/slf4j.version&gt;<br/>        &lt;logback.version&gt;1.4.4&lt;/logback.version&gt;<br/>    &lt;/properties&gt;</span><span id="c102" class="nl lv iq kx b gy np nn l no nf">    &lt;dependencies&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;org.hibernate.orm&lt;/groupId&gt;<br/>            &lt;artifactId&gt;hibernate-core&lt;/artifactId&gt;<br/>            &lt;version&gt;${hibernate.version}&lt;/version&gt;<br/>        &lt;/dependency&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;jakarta.persistence&lt;/groupId&gt;<br/>            &lt;artifactId&gt;jakarta.persistence-api&lt;/artifactId&gt;<br/>            &lt;version&gt;3.1.0&lt;/version&gt;<br/>        &lt;/dependency&gt;</span><span id="1482" class="nl lv iq kx b gy np nn l no nf">        &lt;!-- H2 Database --&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;com.h2database&lt;/groupId&gt;<br/>            &lt;artifactId&gt;h2&lt;/artifactId&gt;<br/>            &lt;version&gt;${h2.version}&lt;/version&gt;<br/>        &lt;/dependency&gt;</span><span id="0069" class="nl lv iq kx b gy np nn l no nf">        &lt;!-- logging with logback --&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;<br/>            &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;<br/>            &lt;version&gt;${slf4j.version}&lt;/version&gt;<br/>        &lt;/dependency&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;<br/>            &lt;artifactId&gt;jcl-over-slf4j&lt;/artifactId&gt;<br/>            &lt;version&gt;${slf4j.version}&lt;/version&gt;<br/>        &lt;/dependency&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;<br/>            &lt;artifactId&gt;logback-core&lt;/artifactId&gt;<br/>            &lt;version&gt;${logback.version}&lt;/version&gt;<br/>        &lt;/dependency&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;<br/>            &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;<br/>            &lt;version&gt;${logback.version}&lt;/version&gt;<br/>        &lt;/dependency&gt;</span><span id="a354" class="nl lv iq kx b gy np nn l no nf">        &lt;!-- test dependencies --&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;<br/>            &lt;artifactId&gt;junit-jupiter&lt;/artifactId&gt;<br/>            &lt;version&gt;${junit-jupiter.version}&lt;/version&gt;<br/>            &lt;scope&gt;test&lt;/scope&gt;<br/>        &lt;/dependency&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;org.assertj&lt;/groupId&gt;<br/>            &lt;artifactId&gt;assertj-core&lt;/artifactId&gt;<br/>            &lt;version&gt;${assertj-core.version}&lt;/version&gt;<br/>            &lt;scope&gt;test&lt;/scope&gt;<br/>        &lt;/dependency&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;org.hibernate.orm&lt;/groupId&gt;<br/>            &lt;artifactId&gt;hibernate-testing&lt;/artifactId&gt;<br/>            &lt;version&gt;${hibernate.version}&lt;/version&gt;<br/>            &lt;scope&gt;test&lt;/scope&gt;<br/>            &lt;exclusions&gt;<br/>                &lt;exclusion&gt;<br/>                    &lt;groupId&gt;junit&lt;/groupId&gt;<br/>                    &lt;artifactId&gt;junit&lt;/artifactId&gt;<br/>                &lt;/exclusion&gt;<br/>            &lt;/exclusions&gt;<br/>        &lt;/dependency&gt;<br/>    &lt;/dependencies&gt;</span><span id="9e90" class="nl lv iq kx b gy np nn l no nf">    &lt;build&gt;<br/>        &lt;plugins&gt;<br/>            &lt;plugin&gt;<br/>                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br/>                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;<br/>                &lt;version&gt;3.10.1&lt;/version&gt;<br/>            &lt;/plugin&gt;<br/>            &lt;plugin&gt;<br/>                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br/>                &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;<br/>                &lt;version&gt;3.0.0-M7&lt;/version&gt;<br/>            &lt;/plugin&gt;<br/>        &lt;/plugins&gt;<br/>    &lt;/build&gt;<br/>&lt;/project&gt;</span></pre><p id="87c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意:要为所有基于特性的项目共享公共资源，创建一个父POM以将公共配置集中在一个地方，检查<a class="ae ld" href="https://github.com/hantsy/jakartaee10-sandbox/blob/master/pom.xml" rel="noopener ugc nofollow" target="_blank">父pom.xml文件</a>。</p><p id="caeb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个示例项目中，我们使用H2嵌入式数据库进行测试。Hibernate 6.1实现了Jakarta Persistence 3.1的特性，但是它在可传递依赖树中包含了一个Jakarta Persistence 3.0 API。</p><p id="50df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要使用Jakarta Persistence 3.1 API，我们必须显式添加<code class="fe ku kv kw kx b">jakarta.persistence:jakarta.persistence-api</code> 3.1。</p><p id="707e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<em class="ng">src/main/resources/META-INF</em>中，添加一个名为<em class="ng"> persistence.xml </em>的新文件。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="b361" class="nb lv iq kx b be nc nd l ne nf">&lt;persistence <br/>             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br/>             xsi:schemaLocation="https://jakarta.ee/xml/ns/persistence https://jakarta.ee/xml/ns/persistence/persistence_3_1.xsd"<br/>             version="3.1"&gt;</span></pre><pre class="nh mx kx ni nj aw nk bi"><span id="f490" class="nl lv iq kx b gy nm nn l no nf">    &lt;persistence-unit name="defaultPU" transaction-type="RESOURCE_LOCAL"&gt;</span><span id="2b24" class="nl lv iq kx b gy np nn l no nf">        &lt;description&gt;Hibernate test case template Persistence Unit&lt;/description&gt;<br/>        &lt;provider&gt;org.hibernate.jpa.HibernatePersistenceProvider&lt;/provider&gt;</span><span id="257c" class="nl lv iq kx b gy np nn l no nf">        &lt;exclude-unlisted-classes&gt;false&lt;/exclude-unlisted-classes&gt;</span><span id="6302" class="nl lv iq kx b gy np nn l no nf">        &lt;properties&gt;<br/>            &lt;property name="hibernate.archive.autodetection" value="class, hbm"/&gt;</span><span id="7940" class="nl lv iq kx b gy np nn l no nf">            &lt;property name="hibernate.dialect" value="org.hibernate.dialect.H2Dialect"/&gt;<br/>            &lt;property name="hibernate.connection.driver_class" value="org.h2.Driver"/&gt;<br/>            &lt;property name="hibernate.connection.url" value="jdbc:h2:mem:db1;DB_CLOSE_DELAY=-1"/&gt;<br/>            &lt;property name="hibernate.connection.username" value="sa"/&gt;</span><span id="c024" class="nl lv iq kx b gy np nn l no nf">            &lt;property name="hibernate.connection.pool_size" value="5"/&gt;</span><span id="343d" class="nl lv iq kx b gy np nn l no nf">            &lt;property name="hibernate.show_sql" value="true"/&gt;<br/>            &lt;property name="hibernate.format_sql" value="true"/&gt;<br/>            &lt;property name="hibernate.hbm2ddl.auto" value="create-drop"/&gt;</span><span id="c4ae" class="nl lv iq kx b gy np nn l no nf">            &lt;property name="hibernate.max_fetch_depth" value="5"/&gt;</span><span id="ebe0" class="nl lv iq kx b gy np nn l no nf">            &lt;property name="hibernate.cache.region_prefix" value="hibernate.test"/&gt;<br/>            &lt;property name="hibernate.cache.region.factory_class"<br/>                      value="org.hibernate.testing.cache.CachingRegionFactory"/&gt;</span><span id="2e1b" class="nl lv iq kx b gy np nn l no nf">            &lt;!--NOTE: hibernate.jdbc.batch_versioned_data should be set to false when testing with Oracle--&gt;<br/>            &lt;property name="hibernate.jdbc.batch_versioned_data" value="true"/&gt;</span><span id="3e2a" class="nl lv iq kx b gy np nn l no nf">            &lt;property name="jakarta.persistence.validation.mode" value="NONE"/&gt;<br/>            &lt;property name="hibernate.service.allow_crawling" value="false"/&gt;<br/>            &lt;property name="hibernate.session.events.log" value="true"/&gt;<br/>        &lt;/properties&gt;</span><span id="5b8f" class="nl lv iq kx b gy np nn l no nf">    &lt;/persistence-unit&gt;<br/>&lt;/persistence&gt;</span></pre><p id="d4cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个项目中，我们使用logback作为日志框架。在<em class="ng"> src/main/resources </em>中，添加一个<em class="ng"> logback.xml </em>来配置logback。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="c613" class="nb lv iq kx b be nc nd l ne nf">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br/>&lt;configuration&gt;</span></pre><pre class="nh mx kx ni nj aw nk bi"><span id="e370" class="nl lv iq kx b gy nm nn l no nf">    &lt;property name="LOGS" value="./logs"/&gt;</span><span id="b9ca" class="nl lv iq kx b gy np nn l no nf">    &lt;appender name="Console"<br/>              class="ch.qos.logback.core.ConsoleAppender"&gt;<br/>        &lt;layout class="ch.qos.logback.classic.PatternLayout"&gt;<br/>            &lt;Pattern&gt;<br/>                %green(%d{ISO8601}) %highlight(%-5level) [%blue(%t)] %yellow(%C{1.}): %msg%n%throwable<br/>            &lt;/Pattern&gt;<br/>        &lt;/layout&gt;<br/>    &lt;/appender&gt;</span><span id="9e54" class="nl lv iq kx b gy np nn l no nf">    &lt;appender name="RollingFile"<br/>              class="ch.qos.logback.core.rolling.RollingFileAppender"&gt;<br/>        &lt;file&gt;${LOGS}/app.log&lt;/file&gt;<br/>        &lt;encoder<br/>                class="ch.qos.logback.classic.encoder.PatternLayoutEncoder"&gt;<br/>            &lt;Pattern&gt;%d %p %C{1.} [%t] %m%n&lt;/Pattern&gt;<br/>        &lt;/encoder&gt;</span><span id="deef" class="nl lv iq kx b gy np nn l no nf">        &lt;rollingPolicy<br/>                class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy"&gt;<br/>            &lt;!-- rollover daily and when the file reaches 10 MegaBytes --&gt;<br/>            &lt;fileNamePattern&gt;${LOGS}/archived/app-%d{yyyy-MM-dd}.%i.log<br/>            &lt;/fileNamePattern&gt;<br/>            &lt;timeBasedFileNamingAndTriggeringPolicy<br/>                    class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP"&gt;<br/>                &lt;maxFileSize&gt;10MB&lt;/maxFileSize&gt;<br/>            &lt;/timeBasedFileNamingAndTriggeringPolicy&gt;<br/>        &lt;/rollingPolicy&gt;<br/>    &lt;/appender&gt;</span><span id="1bd7" class="nl lv iq kx b gy np nn l no nf">    &lt;!-- LOG everything at INFO level --&gt;<br/>    &lt;root level="info"&gt;<br/>        &lt;appender-ref ref="RollingFile"/&gt;<br/>        &lt;appender-ref ref="Console"/&gt;<br/>    &lt;/root&gt;</span><span id="ae78" class="nl lv iq kx b gy np nn l no nf">    &lt;!-- Debug hibernate SQL,  see: <a class="ae ld" href="https://thorben-janssen.com/hibernate-logging-guide/" rel="noopener ugc nofollow" target="_blank">https://thorben-janssen.com/hibernate-logging-guide/</a> --&gt;<br/>    &lt;logger name="org.hibernate.SQL" level="DEBUG"/&gt;<br/>    &lt;logger name="org.hibernate.type.descriptor.sql" level="trace"/&gt;</span><span id="ffd7" class="nl lv iq kx b gy np nn l no nf">    &lt;!-- Custom debug level for the application code --&gt;<br/>    &lt;logger name="com.example" level="debug" additivity="false"&gt;<br/>        &lt;appender-ref ref="RollingFile"/&gt;<br/>        &lt;appender-ref ref="Console"/&gt;<br/>    &lt;/logger&gt;<br/>&lt;/configuration&gt;</span></pre><p id="6788" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将<code class="fe ku kv kw kx b">org.hibernate.SQL</code>日志记录级别设置为<code class="fe ku kv kw kx b">DEBUG</code>，将<code class="fe ku kv kw kx b">org.hibernate.type.descriptor.sql</code>设置为<code class="fe ku kv kw kx b">trace</code>，这将帮助您在运行时挖掘Hibernate生成的sql。</p><h1 id="8437" class="lu lv iq bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">UUID基本类型支持</h1><p id="310d" class="pw-post-body-paragraph jn jo iq jp b jq ms js jt ju mt jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">JPA 3.1允许使用UUID作为基本Java类型，特别是它增加了一个UUID ID生成器。</p><p id="cc8e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个简单的<code class="fe ku kv kw kx b">Entity</code>。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="7b4e" class="nb lv iq kx b be nc nd l ne nf">@Entity<br/>public class Person {<br/>    @Id<br/>    @Column(name = "id", nullable = false)<br/>    @GeneratedValue(strategy = GenerationType.UUID)<br/>    private UUID id;<br/>    private String name;<br/>    private int age = 30;</span></pre><pre class="nh mx kx ni nj aw nk bi"><span id="a7d4" class="nl lv iq kx b gy nm nn l no nf">    public Person() {<br/>    }</span><span id="14ed" class="nl lv iq kx b gy np nn l no nf">    public Person(String name, int age) {<br/>        assert age &gt; 0;<br/>        this.name = name;<br/>        this.age = age;<br/>        this.birthDate = LocalDateTime.now().minusYears(this.age);<br/>    }</span><span id="4ecb" class="nl lv iq kx b gy np nn l no nf">    // getters and setters<br/>    // override equals and hashCode<br/>}</span></pre><p id="5495" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个实体类用一个<code class="fe ku kv kw kx b">@Entity</code>注释，可选地，你可以指定实体名，并用一个额外的<code class="fe ku kv kw kx b">@Table</code>注释添加表定义。</p><p id="19f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我们定义了一个UUID类型的ID，并使用了一个UUID生成策略。</p><p id="df0b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">JPA要求一个实体应该包含一个无参数的构造函数，如果你声明另一个有几个参数的构造函数，你应该显式声明这个无参数的构造函数。</p><p id="b80f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个简单的JUnit测试来验证UUID类型是否按预期工作。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="a5d9" class="nb lv iq kx b be nc nd l ne nf">class PersonUUIDTest {<br/>    private static final Logger log = LoggerFactory.getLogger(PersonUUIDTest.class);</span></pre><pre class="nh mx kx ni nj aw nk bi"><span id="d912" class="nl lv iq kx b gy nm nn l no nf">    private EntityManagerFactory entityManagerFactory;</span><span id="9ddb" class="nl lv iq kx b gy np nn l no nf">    @BeforeEach<br/>    void setUp() {<br/>        entityManagerFactory = Persistence.createEntityManagerFactory("defaultPU");<br/>        var entityManager = entityManagerFactory.createEntityManager();<br/>        entityManager.getTransaction().begin();<br/>        var deleteFromPerson = entityManager.createQuery("DELETE FROM Person").executeUpdate();<br/>        log.debug("Deleted {} persons", deleteFromPerson);<br/>        entityManager.getTransaction().commit();<br/>        entityManager.close();<br/>    }</span><span id="2a71" class="nl lv iq kx b gy np nn l no nf">    @Test<br/>    @DisplayName("insert person and verify person")<br/>    public void testInsertAndFindPerson() throws Exception {<br/>        var person = new Person("John", 30);<br/>        var entityManager = entityManagerFactory.createEntityManager();<br/>        entityManager.getTransaction().begin();<br/>        entityManager.persist(person);<br/>        entityManager.getTransaction().commit();<br/>        var id = person.getId();<br/>        assertNotNull(id);</span><span id="f668" class="nl lv iq kx b gy np nn l no nf">        try {<br/>            var foundPerson = entityManager.find(Person.class, id);<br/>            assertThat(foundPerson.getId()).isNotNull();<br/>            assertThat(foundPerson.getName()).isEqualTo("John");<br/>            assertThat(foundPerson.getAge()).isEqualTo(30);<br/>        } catch (Exception ex) {<br/>            ex.printStackTrace();<br/>        }<br/>    }</span><span id="a0c4" class="nl lv iq kx b gy np nn l no nf">    @AfterEach<br/>    void tearDown() {<br/>        entityManagerFactory.close();<br/>    }<br/>}</span></pre><p id="c039" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe ku kv kw kx b">@BeforeEach</code>方法中，我们将创建一个<code class="fe ku kv kw kx b">EntityManagerFactory</code>实例。在<code class="fe ku kv kw kx b">@AfterEach</code>中，我们调用<code class="fe ku kv kw kx b">EntityManagerFactory.close</code>来释放资源。</p><p id="e104" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe ku kv kw kx b">@BeforeEach</code>中，我们尝试清理个人数据。</p><p id="8fcd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在在<code class="fe ku kv kw kx b">testInsertAndFindPerson</code>测试中，我们插入一个新人，然后利用<code class="fe ku kv kw kx b">entityManager.find</code>找到插入的人。</p><p id="03b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">人员id用<code class="fe ku kv kw kx b">@ID</code>和<code class="fe ku kv kw kx b">@GeneratedValue</code>标注，当向表中插入人员时，hibernate会自动生成一个ID。持久化后，返回的实例将填充生成的id，它不应为空。</p><h1 id="b0e2" class="lu lv iq bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">数字函数</h1><p id="6774" class="pw-post-body-paragraph jn jo iq jp b jq ms js jt ju mt jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">JPA 3.1在文字JPQL查询和类型安全标准构建器API中添加了一组新的数值函数。</p><p id="3d67" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的<code class="fe ku kv kw kx b">Person</code>类中添加一些额外的属性。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="2a7e" class="nb lv iq kx b be nc nd l ne nf">public class Person{<br/>    private Integer yearsWorked = 2;<br/>    private LocalDateTime birthDate = LocalDateTime.now().minusYears(30);<br/>    private BigDecimal salary = new BigDecimal("12345.678");<br/>    private BigDecimal hourlyRate = new BigDecimal("34.56");</span></pre><pre class="nh mx kx ni nj aw nk bi"><span id="ce9e" class="nl lv iq kx b gy nm nn l no nf">    // setters and getters<br/>}</span></pre><p id="f2d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个新的测试来验证新的数字函数:<code class="fe ku kv kw kx b">ceiling</code>、<code class="fe ku kv kw kx b">floor</code>、<code class="fe ku kv kw kx b">round</code>、<code class="fe ku kv kw kx b">exp</code>、<code class="fe ku kv kw kx b">ln</code>、<code class="fe ku kv kw kx b">power</code>、<code class="fe ku kv kw kx b">sign</code>。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="6c76" class="nb lv iq kx b be nc nd l ne nf">@Test<br/>@DisplayName("&gt;&gt;&gt; test numeric functions")<br/>public void testNumericFunctions() throws Exception {<br/>    var person = new Person("John", 30);<br/>    var entityManager = entityManagerFactory.createEntityManager();<br/>    entityManager.getTransaction().begin();<br/>    entityManager.persist(person);<br/>    entityManager.getTransaction().commit();<br/>    var id = person.getId();<br/>    assertNotNull(id);</span></pre><pre class="nh mx kx ni nj aw nk bi"><span id="7417" class="nl lv iq kx b gy nm nn l no nf">    try {<br/>        var queryString = """<br/>                SELECT p.name as name,<br/>                CEILING(p.salary) as ceiling,<br/>                FLOOR(p.salary) as floor,<br/>                ROUND(p.salary, 1) as round,<br/>                EXP(p.yearsWorked) as exp,<br/>                LN(p.yearsWorked) as ln,<br/>                POWER(p.yearsWorked,2) as power,<br/>                SIGN(p.yearsWorked) as sign<br/>                FROM Person p<br/>                WHERE p.id=:id<br/>                """;<br/>        var query = entityManager.createQuery(queryString);<br/>        query.setParameter("id", id);<br/>        var resultList = query.getResultList();<br/>        log.debug("Result list: {}", resultList);<br/>        resultList.forEach(result -&gt; log.debug("result: {}", result));<br/>    } catch (Exception ex) {<br/>        ex.printStackTrace();<br/>    }<br/>}</span></pre><p id="63d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，让我们看看如何在标准API中使用它们。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="0802" class="nb lv iq kx b be nc nd l ne nf">@Test<br/>@DisplayName("&gt;&gt;&gt; test numeric functions")<br/>public void testNumericFunctions() throws Exception {<br/>    var person = new Person("John", 30);<br/>    var entityManager = entityManagerFactory.createEntityManager();<br/>    entityManager.getTransaction().begin();<br/>    entityManager.persist(person);<br/>    entityManager.getTransaction().commit();<br/>    var id = person.getId();<br/>    assertNotNull(id);</span></pre><pre class="nh mx kx ni nj aw nk bi"><span id="3489" class="nl lv iq kx b gy nm nn l no nf">    try {<br/>        // see: <a class="ae ld" href="https://hibernate.zulipchat.com/#narrow/stream/132096-hibernate-user/topic/New.20functions.20in.20JPA.203.2E1/near/289429903" rel="noopener ugc nofollow" target="_blank">https://hibernate.zulipchat.com/#narrow/stream/132096-hibernate-user/topic/New.20functions.20in.20JPA.203.2E1/near/289429903</a><br/>        var cb = (HibernateCriteriaBuilder) entityManager.getCriteriaBuilder();<br/>        var query = cb.createTupleQuery();<br/>        var root = query.from(Person.class);</span><span id="4a33" class="nl lv iq kx b gy np nn l no nf">        query.multiselect(root.get("name"),<br/>                cb.ceiling(root.get("salary")),<br/>                cb.floor(root.get("salary")),<br/>                cb.round(root.get("salary"), 1),<br/>                cb.exp(root.get("yearsWorked")),<br/>                cb.ln(root.get("yearsWorked")),<br/>                // see: <a class="ae ld" href="https://hibernate.atlassian.net/browse/HHH-15395" rel="noopener ugc nofollow" target="_blank">https://hibernate.atlassian.net/browse/HHH-15395</a><br/>                cb.power(root.get("yearsWorked"), 2),<br/>                cb.sign(root.get("yearsWorked"))<br/>        );<br/>        query.where(cb.equal(root.get("id"), id));<br/>        var resultList = entityManager.createQuery(query).getResultList();<br/>        log.debug("Result list: {}", resultList);</span><span id="73b7" class="nl lv iq kx b gy np nn l no nf">        resultList.forEach(result -&gt;<br/>                log.debug(<br/>                        "result: ({},{},{},{},{},{},{},{})",<br/>                        result.get(0, String.class),<br/>                        result.get(1, BigDecimal.class),<br/>                        result.get(2, BigDecimal.class),<br/>                        result.get(3, BigDecimal.class),<br/>                        result.get(4, Double.class),<br/>                        result.get(5, Double.class),<br/>                        result.get(6, Double.class),<br/>                        result.get(7, Integer.class)<br/>                )<br/>        );<br/>    } catch (Exception ex) {<br/>        fail(ex);<br/>    }<br/>}</span></pre><p id="3d87" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意，当使用Hibernate 6.1时，我们必须将<code class="fe ku kv kw kx b">CriteriaBuilder</code>转换为<code class="fe ku kv kw kx b">HibernateCriteriaBuilder</code>来体验新的数字函数。Hibernate 6.2将与JPA 3.1保持一致并解决这个问题。</p><h1 id="5dc5" class="lu lv iq bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">日期时间函数</h1><p id="af85" class="pw-post-body-paragraph jn jo iq jp b jq ms js jt ju mt jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">JPA 3.1增加了一系列日期时间函数，简化了Java 8日期时间API的使用。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="7c1e" class="nb lv iq kx b be nc nd l ne nf">@Test<br/>@DisplayName("&gt;&gt;&gt; test datetime functions")<br/>public void testDateTimeFunctions() throws Exception {<br/>    var person = new Person("John", 30);<br/>    var entityManager = entityManagerFactory.createEntityManager();<br/>    entityManager.getTransaction().begin();<br/>    entityManager.persist(person);<br/>    entityManager.getTransaction().commit();<br/>    var id = person.getId();<br/>    assertNotNull(id);</span></pre><pre class="nh mx kx ni nj aw nk bi"><span id="eacf" class="nl lv iq kx b gy nm nn l no nf">    try {<br/>        var queryString = """<br/>                SELECT p.name as name,<br/>                LOCAL TIME as localTime,<br/>                LOCAL DATETIME as localDateTime,<br/>                LOCAL DATE as localDate<br/>                FROM Person p<br/>                """;</span><span id="e937" class="nl lv iq kx b gy np nn l no nf">        var query = entityManager.createQuery(queryString);<br/>        var resultList = query.getResultList();<br/>        log.debug("Result list: {}", resultList);<br/>        resultList.forEach(result -&gt; log.debug("result: {}", result));<br/>    } catch (Exception ex) {<br/>        ex.printStackTrace();<br/>    }<br/>}</span></pre><p id="12b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ku kv kw kx b">LOCAL TIME</code>、<code class="fe ku kv kw kx b">LOCAL DATETIME</code>、<code class="fe ku kv kw kx b">LOCAL DATE</code>查询结果将直接作为Java 8 <code class="fe ku kv kw kx b">LocalTime</code>、<code class="fe ku kv kw kx b">LocalDateTime</code>、<code class="fe ku kv kw kx b">LocalDate</code>处理。</p><p id="ac6d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们看看在CriteriaBuilder APIs中的用法。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="4c20" class="nb lv iq kx b be nc nd l ne nf">@Test<br/>@DisplayName("&gt;&gt;&gt; test datetime functions")<br/>public void testDateTimeFunctions() throws Exception {<br/>    var person = new Person("John", 30);<br/>    var entityManager = entityManagerFactory.createEntityManager();<br/>    entityManager.getTransaction().begin();<br/>    entityManager.persist(person);<br/>    entityManager.getTransaction().commit();<br/>    var id = person.getId();<br/>    assertNotNull(id);</span></pre><pre class="nh mx kx ni nj aw nk bi"><span id="2bd4" class="nl lv iq kx b gy nm nn l no nf">    try {<br/>        var cb = (HibernateCriteriaBuilder) entityManager.getCriteriaBuilder();<br/>        var query = cb.createTupleQuery();<br/>        var root = query.from(Person.class);</span><span id="8de6" class="nl lv iq kx b gy np nn l no nf">        query.multiselect(root.get("name"),<br/>                cb.localTime(),<br/>                cb.localDateTime(),<br/>                cb.localDate()<br/>        );<br/>        query.where(cb.equal(root.get("id"), id));</span><span id="e7c1" class="nl lv iq kx b gy np nn l no nf">        var resultList = entityManager.createQuery(query).getResultList();<br/>        log.debug("Result list: {}", resultList);<br/>        resultList.forEach(result -&gt;<br/>                log.debug(<br/>                        "result: ({},{},{},{})",<br/>                        result.get(0, String.class),<br/>                        result.get(1, LocalTime.class),<br/>                        result.get(2, LocalDateTime.class),<br/>                        result.get(3, LocalDate.class)<br/>                )<br/>        );<br/>    } catch (Exception ex) {<br/>        fail(ex);<br/>    }<br/>}</span></pre><h1 id="ec69" class="lu lv iq bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated"><code class="fe ku kv kw kx b">EXTRACT</code>功能</h1><p id="ad6f" class="pw-post-body-paragraph jn jo iq jp b jq ms js jt ju mt jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">JPA 3.1引入了一个<code class="fe ku kv kw kx b">extract</code>函数来解码来自日期时间值的片段。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="fb54" class="nb lv iq kx b be nc nd l ne nf">@Test<br/>@DisplayName("&gt;&gt;&gt; test `EXTRACT` functions")<br/>public void testExtractFunctions() throws Exception {<br/>    var person = new Person("John", 30);<br/>    var entityManager = entityManagerFactory.createEntityManager();<br/>    entityManager.getTransaction().begin();<br/>    entityManager.persist(person);<br/>    entityManager.getTransaction().commit();<br/>    var id = person.getId();<br/>    assertNotNull(id);</span></pre><pre class="nh mx kx ni nj aw nk bi"><span id="61f4" class="nl lv iq kx b gy nm nn l no nf">    try {<br/>        var queryString = """<br/>                SELECT p.name as name,<br/>                EXTRACT(YEAR FROM p.birthDate) as year,<br/>                EXTRACT(QUARTER FROM p.birthDate) as quarter,<br/>                EXTRACT(MONTH FROM p.birthDate) as month,<br/>                EXTRACT(WEEK FROM p.birthDate) as week,<br/>                EXTRACT(DAY FROM p.birthDate) as day,<br/>                EXTRACT(HOUR FROM p.birthDate) as hour,<br/>                EXTRACT(MINUTE FROM p.birthDate) as minute,<br/>                EXTRACT(SECOND FROM p.birthDate) as second<br/>                FROM Person p<br/>                """;<br/>        var query = entityManager.createQuery(queryString);</span><span id="c11c" class="nl lv iq kx b gy np nn l no nf">        var resultList = query.getResultList();<br/>        log.debug("Result list: {}", resultList);<br/>        resultList.forEach(result -&gt; log.debug("result: {}", result));<br/>    } catch (Exception ex) {<br/>        ex.printStackTrace();<br/>    }<br/>}</span></pre><p id="4aa2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用新的<code class="fe ku kv kw kx b">extract</code>函数，我们可以在JPQL查询中从Java 8 DateTime类型属性中读取<code class="fe ku kv kw kx b">year</code>、<code class="fe ku kv kw kx b">quarter</code>、<code class="fe ku kv kw kx b">month</code>、<code class="fe ku kv kw kx b">week</code>、<code class="fe ku kv kw kx b">day</code>、<code class="fe ku kv kw kx b">hour</code>、<code class="fe ku kv kw kx b">minute</code>、<code class="fe ku kv kw kx b">second</code>值。</p><p id="ba7b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，在CriteriaBuilder APIs中没有映射的提取函数，有关更多详细信息，请查看问题:<a class="ae ld" href="https://github.com/jakartaee/persistence/pull/356" rel="noopener ugc nofollow" target="_blank">jakartaee/persistence # 356</a></p><h1 id="a8b4" class="lu lv iq bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">JakartaEE运行时</h1><p id="4709" class="pw-post-body-paragraph jn jo iq jp b jq ms js jt ju mt jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">接下来让我们一起去Jakarta EE 10兼容产品体验JPA 3.1的新特性。</p><p id="07fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们将准备一个Jakarta EE 10 web应用程序。</p><p id="927f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过<a class="ae ld" href="https://maven.apache.org/archetypes/maven-archetype-webapp/" rel="noopener ugc nofollow" target="_blank"> Maven Webapp原型</a>简单地生成一个web应用程序框架。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="d323" class="nb lv iq kx b be nc nd l ne nf">mvn archetype:generate<br/>    -DarchetypeGroupId=org.apache.maven.archetypes<br/>    -DarchetypeArtifactId=maven-archetype-webapp<br/>    -DarchetypeVersion=1.4</span></pre><p id="0ffb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后将Jakarta EE 10依赖项添加到项目pom.xml中，我们来看看修改后的pom.xml。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="8a0c" class="nb lv iq kx b be nc nd l ne nf">&lt;project  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br/>         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;<br/>    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;<br/>    &lt;groupId&gt;com.example&lt;/groupId&gt;<br/>    &lt;artifactId&gt;jpa-examples&lt;/artifactId&gt;<br/>    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;<br/>    &lt;packaging&gt;war&lt;/packaging&gt;<br/>    &lt;parent&gt;<br/>        &lt;groupId&gt;com.example&lt;/groupId&gt;<br/>        &lt;artifactId&gt;jakartaee10-sandbox-parent&lt;/artifactId&gt;<br/>        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;<br/>        &lt;relativePath&gt;..&lt;/relativePath&gt;<br/>    &lt;/parent&gt;</span></pre><pre class="nh mx kx ni nj aw nk bi"><span id="79e7" class="nl lv iq kx b gy nm nn l no nf">    &lt;name&gt;jpa-examples&lt;/name&gt;<br/>    &lt;description&gt;Jakarta EE 10 Sandbox: Persistence 3.1 Examples&lt;/description&gt;<br/>    &lt;properties&gt;<br/>    &lt;/properties&gt;</span><span id="36cc" class="nl lv iq kx b gy np nn l no nf">    &lt;dependencies&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;jakarta.platform&lt;/groupId&gt;<br/>            &lt;artifactId&gt;jakarta.jakartaee-api&lt;/artifactId&gt;<br/>        &lt;/dependency&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;org.eclipse.persistence&lt;/groupId&gt;<br/>            &lt;artifactId&gt;org.eclipse.persistence.jpa.modelgen.processor&lt;/artifactId&gt;<br/>            &lt;version&gt;4.0.0&lt;/version&gt;<br/>            &lt;scope&gt;provided&lt;/scope&gt;<br/>        &lt;/dependency&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;org.jboss.arquillian.junit5&lt;/groupId&gt;<br/>            &lt;artifactId&gt;arquillian-junit5-container&lt;/artifactId&gt;<br/>            &lt;scope&gt;test&lt;/scope&gt;<br/>        &lt;/dependency&gt;<br/>        &lt;!-- see: <a class="ae ld" href="https://github.com/arquillian/arquillian-core/issues/248" rel="noopener ugc nofollow" target="_blank">https://github.com/arquillian/arquillian-core/issues/248</a> --&gt;<br/>        &lt;!-- and <a class="ae ld" href="https://github.com/arquillian/arquillian-core/pull/246/files" rel="noopener ugc nofollow" target="_blank">https://github.com/arquillian/arquillian-core/pull/246/files</a> --&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;org.jboss.arquillian.protocol&lt;/groupId&gt;<br/>            &lt;artifactId&gt;arquillian-protocol-servlet-jakarta&lt;/artifactId&gt;<br/>            &lt;scope&gt;test&lt;/scope&gt;<br/>        &lt;/dependency&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;<br/>            &lt;artifactId&gt;junit-jupiter&lt;/artifactId&gt;<br/>            &lt;scope&gt;test&lt;/scope&gt;<br/>        &lt;/dependency&gt;<br/>    &lt;/dependencies&gt;<br/>&lt;/project&gt;</span></pre><p id="879c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的pom.xml中，我们还在测试范围中添加了JUnit 5和<a class="ae ld" href="https://arquillian.org" rel="noopener ugc nofollow" target="_blank"> Arquillian </a>相关的依赖项。通过容器特定的Aquillian适配器，我们可以在Jakarta EE应用服务器上运行测试。</p><p id="87a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个项目中，我们重用了在Hibernate小节中引入的<code class="fe ku kv kw kx b">Person</code>实体。</p><p id="a111" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们转到持久性配置。在<em class="ng">src/main/resources/META-INFO</em>文件夹中创建一个<em class="ng"> persistence.xml </em>。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="cf63" class="nb lv iq kx b be nc nd l ne nf">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br/>&lt;persistence version="3.0" <br/>             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br/>             xsi:schemaLocation="https://jakarta.ee/xml/ns/persistence https://jakarta.ee/xml/ns/persistence/persistence_3_0.xsd"&gt;<br/>    &lt;persistence-unit name="defaultPU" transaction-type="JTA"&gt;<br/>        &lt;jta-data-source&gt;java:comp/DefaultDataSource&lt;/jta-data-source&gt;<br/>        &lt;exclude-unlisted-classes&gt;false&lt;/exclude-unlisted-classes&gt;<br/>        &lt;properties&gt;<br/>            &lt;property name="jakarta.persistence.schema-generation.database.action" value="drop-and-create"/&gt;</span></pre><pre class="nh mx kx ni nj aw nk bi"><span id="c213" class="nl lv iq kx b gy nm nn l no nf">            &lt;!-- for  Glassfish/Payara/EclipseLink --&gt;<br/>            &lt;property name="eclipselink.logging.level.sql" value="FINE"/&gt;<br/>            &lt;property name="eclipselink.logging.level" value="FINE"/&gt;<br/>            &lt;property name="eclipselink.logging.parameters" value="true"/&gt;</span><span id="6d5e" class="nl lv iq kx b gy np nn l no nf">            &lt;!-- for WildFly/Hibernate --&gt;<br/>            &lt;property name="hibernate.show_sql" value="true"/&gt;<br/>            &lt;property name="hibernate.format_sql" value="true"/&gt;<br/>        &lt;/properties&gt;<br/>    &lt;/persistence-unit&gt;<br/>&lt;/persistence&gt;</span></pre><p id="57b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该配置与我们在Hibernate部分介绍的配置略有不同。</p><ul class=""><li id="4b3b" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">在容器环境中，我们希望选择<code class="fe ku kv kw kx b">JTA</code>作为事务类型。</li><li id="4dee" class="kl km iq jp b jq ky ju kz jy la kc lb kg lc kk kq kr ks kt bi translated">我们不设置数据库连接信息，而是配置一个内置的数据源。<code class="fe ku kv kw kx b">java:comp/DefaultDataSource</code>是所有Jakarta EE兼容产品的默认数据源。</li></ul><h1 id="4429" class="lu lv iq bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">创建Jakarta EE示例应用程序</h1><p id="0f4b" class="pw-post-body-paragraph jn jo iq jp b jq ms js jt ju mt jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">为了与我们的后端数据库进行交互，我们将创建一个简单完整的JAXRS应用程序，包括:</p><ul class=""><li id="88f9" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">一个EJB <code class="fe ku kv kw kx b">@Stateless</code> bean从数据库中读取数据</li><li id="52cc" class="kl km iq jp b jq ky ju kz jy la kc lb kg lc kk kq kr ks kt bi translated">并通过简单的JAXRS资源公开数据</li></ul><p id="d819" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好，让我们创建用<code class="fe ku kv kw kx b">@Stateless</code>标注的<code class="fe ku kv kw kx b">PersonRepository</code>类。在这个类中，注入一个带有注释<code class="fe ku kv kw kx b">@PersistenceContext</code>的<code class="fe ku kv kw kx b">EntityManager</code> bean，并添加一个新方法<code class="fe ku kv kw kx b">getAllResource</code>来执行JPQL查询以检索所有人员。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="7ba0" class="nb lv iq kx b be nc nd l ne nf">@Stateless<br/>public class PersonRepository {</span></pre><pre class="nh mx kx ni nj aw nk bi"><span id="702f" class="nl lv iq kx b gy nm nn l no nf">    @PersistenceContext<br/>    EntityManager entityManager;</span><span id="cc65" class="nl lv iq kx b gy np nn l no nf">    public List&lt;Person&gt; getAllPersons() {<br/>        return entityManager.createQuery("select p from Person p", Person.class)<br/>                .getResultList();<br/>    }<br/>}</span></pre><p id="9833" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，创建一个<code class="fe ku kv kw kx b">PersonResource</code>来向客户端公开人员。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="46c2" class="nb lv iq kx b be nc nd l ne nf">@RequestScoped<br/>@Path("/persons")<br/>public class PersonResource {</span></pre><pre class="nh mx kx ni nj aw nk bi"><span id="8298" class="nl lv iq kx b gy nm nn l no nf">    @Inject<br/>    PersonRepository personRepository;</span><span id="5889" class="nl lv iq kx b gy np nn l no nf">    @Path("")<br/>    @GET<br/>    @Produces(MediaType.APPLICATION_JSON)<br/>    public Response allPersons() {<br/>        var data = personRepository.getAllPersons();<br/>        return Response.ok(data).build();<br/>    }<br/>}</span></pre><p id="b1c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用<code class="fe ku kv kw kx b">RequestScoped</code>注释了<code class="fe ku kv kw kx b">PersonResource</code>，它是一个CDI bean，类上的<code class="fe ku kv kw kx b">@Path</code>定义了这个类中所有子资源的根路径。当HTTP客户端请求与HTTP GET方法匹配，URI为<code class="fe ku kv kw kx b">/persons</code>且HTTP头接受与<code class="fe ku kv kw kx b">application/json</code>兼容时，<code class="fe ku kv kw kx b">allPersons</code>将以JSON格式生成所有人员给客户端。</p><p id="a9c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要激活JAXRS特性，创建一个类来扩展JAXRS <code class="fe ku kv kw kx b">Application</code>，添加<code class="fe ku kv kw kx b">@ApplicationPath</code>来指定所有JAXRS资源的根上下文路径。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="b366" class="nb lv iq kx b be nc nd l ne nf">@ApplicationPath("/rest")<br/>public class RestActivator extends Application {<br/>}</span></pre><p id="8e0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们创建一个bean，在应用程序启动时添加一些样本数据。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="f530" class="nb lv iq kx b be nc nd l ne nf">@Startup<br/>@Singleton<br/>public class DataInitializer {</span></pre><pre class="nh mx kx ni nj aw nk bi"><span id="eed0" class="nl lv iq kx b gy nm nn l no nf">    @PersistenceContext<br/>    EntityManager entityManager;</span><span id="7ef0" class="nl lv iq kx b gy np nn l no nf">    @PostConstruct<br/>    public void init() {<br/>        List<br/>                .of(<br/>                        new Person("Jack", 20),<br/>                        new Person("Rose", 18)<br/>                )<br/>                .forEach(entityManager::persist);<br/>    }<br/>}</span></pre><h1 id="cbd9" class="lu lv iq bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">部署到雅加达EE集装箱</h1><p id="f809" class="pw-post-body-paragraph jn jo iq jp b jq ms js jt ju mt jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">将应用程序构建并打包到war档案中。打开终端，切换到项目根文件夹，并执行以下命令。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="58e1" class="nb lv iq kx b be nc nd l ne nf">mvn clean package -DskipTests -D"maven.test.skip=true"</span></pre><p id="a567" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完成后，在路径<em class="ng">target/JPA-examples . war</em>中有war包准备好了。</p><h2 id="40c8" class="nl lv iq bd lw nq nr dn ma ns nt dp me jy nu nv mi kc nw nx mm kg ny nz mq oa bi translated">玻璃鱼7.0</h2><ol class=""><li id="154e" class="kl km iq jp b jq ms ju mt jy ob kc oc kg od kk oe kr ks kt bi translated">下载<a class="ae ld" href="https://github.com/eclipse-ee4j/glassfish/releases" rel="noopener ugc nofollow" target="_blank">最新的GlassFish 7.0 </a>，将文件解压到一个位置，例如D:\glassfish7，标记为<em class="ng"> GlassFish_install </em>。</li><li id="189e" class="kl km iq jp b jq ky ju kz jy la kc lb kg lc kk oe kr ks kt bi translated">要启动GlassFish和Derby，打开一个终端，输入<em class="ng"> GlassFish_install/bin </em>，运行<code class="fe ku kv kw kx b">asadmin start-database</code>和<code class="fe ku kv kw kx b">asadmin start-domain domain1</code>。</li><li id="ae95" class="kl km iq jp b jq ky ju kz jy la kc lb kg lc kk oe kr ks kt bi translated">将上述war包复制到<em class="ng">Glassfish _ install/Glassfish/domains/domain 1/auto deploy</em>文件夹中。</li><li id="438c" class="kl km iq jp b jq ky ju kz jy la kc lb kg lc kk oe kr ks kt bi translated">打开<em class="ng">GlassFish _ install/GlassFish/domains/domain 1/logs/server . log</em>，等待部署完成。</li><li id="be74" class="kl km iq jp b jq ky ju kz jy la kc lb kg lc kk oe kr ks kt bi translated">打开另一个终端窗口，执行<code class="fe ku kv kw kx b">curl http://localhost:8080/jpa-examples/rest/persons</code>。您将在控制台中得到以下响应。</li></ol><ul class=""><li id="e89f" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">[{ "年龄":18，"出生日期":" 2004–11–06t 14:54:05.4504678 "，"性别":"男"，" hourlyRate":34.56，" id ":" d 8552d 71-ff7f-4650-b5 A0-ce 1c 5 FB 3 Fe 0 b "，"姓名":" Rose "，"薪水":12345.678，"工作年限":2}，{ "年龄":20，"出生日期:" "</li></ul><ol class=""><li id="5537" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk oe kr ks kt bi translated">要停止GlassFish和Derby，运行<code class="fe ku kv kw kx b">asadmin stop-database</code>和<code class="fe ku kv kw kx b">asadmin stop-domain domain1</code></li></ol><h2 id="cace" class="nl lv iq bd lw nq nr dn ma ns nt dp me jy nu nv mi kc nw nx mm kg ny nz mq oa bi translated">野花预览27</h2><ol class=""><li id="c741" class="kl km iq jp b jq ms ju mt jy ob kc oc kg od kk oe kr ks kt bi translated">下载最新的<a class="ae ld" href="https://wildfly.org" rel="noopener ugc nofollow" target="_blank"> WildFly预览</a>，解压文件到一个位置，例如:D:\ wild fly-Preview-27 . 0 . 0 . beta 1，标记为<em class="ng"> WildFly_install </em>。</li><li id="b9bf" class="kl km iq jp b jq ky ju kz jy la kc lb kg lc kk oe kr ks kt bi translated">打开一个终端，输入<em class="ng">wildly _ install/bin</em>，运行<code class="fe ku kv kw kx b">standalone</code>以默认的独立概要配置启动wildly。</li><li id="4396" class="kl km iq jp b jq ky ju kz jy la kc lb kg lc kk oe kr ks kt bi translated">将构建好的war复制到<em class="ng">wildly _ install/standalone/deployments</em>。</li><li id="dce4" class="kl km iq jp b jq ky ju kz jy la kc lb kg lc kk oe kr ks kt bi translated">等待部署进度完成，您可以使用GlassFish部分中的curl来验证应用程序。</li><li id="d0f0" class="kl km iq jp b jq ky ju kz jy la kc lb kg lc kk oe kr ks kt bi translated">在原WildFly启动控制台中发送一个<code class="fe ku kv kw kx b">CTLR+C</code>组合键来停止WildFly。</li></ol><h1 id="3e0f" class="lu lv iq bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">通过Maven插件部署应用程序</h1><h2 id="430e" class="nl lv iq bd lw nq nr dn ma ns nt dp me jy nu nv mi kc nw nx mm kg ny nz mq oa bi translated">通过Cargo插件部署到GlassFish</h2><p id="59de" class="pw-post-body-paragraph jn jo iq jp b jq ms js jt ju mt jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">GlassFish项目不包括管理GlassFish服务器的官方Maven插件。有一个名为<code class="fe ku kv kw kx b">cargo-maven3-plugin</code>的Maven插件，可以用来管理所有流行的Jakarta EE应用服务器和web服务器。</p><p id="d57b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">添加下面的<code class="fe ku kv kw kx b">profile</code>部分来使用cargo插件管理GlassFish服务器的生命周期。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="44c8" class="nb lv iq kx b be nc nd l ne nf">&lt;profile&gt;<br/>    &lt;id&gt;glassfish&lt;/id&gt;<br/>    &lt;activation&gt;<br/>        &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;<br/>    &lt;/activation&gt;<br/>    &lt;properties&gt;<br/>        &lt;cargo.zipUrlInstaller.downloadDir&gt;${project.basedir}/../installs&lt;/cargo.zipUrlInstaller.downloadDir&gt;<br/>    &lt;/properties&gt;<br/>    &lt;build&gt;<br/>        &lt;plugins&gt;<br/>            &lt;plugin&gt;<br/>                &lt;groupId&gt;org.codehaus.cargo&lt;/groupId&gt;<br/>                &lt;artifactId&gt;cargo-maven3-plugin&lt;/artifactId&gt;<br/>                &lt;configuration&gt;<br/>                    &lt;container&gt;<br/>                        &lt;containerId&gt;glassfish7x&lt;/containerId&gt;<br/>                        &lt;!-- &lt;artifactInstaller&gt;<br/>                            &lt;groupId&gt;org.glassfish.main.distributions&lt;/groupId&gt;<br/>                            &lt;artifactId&gt;glassfish&lt;/artifactId&gt;<br/>                            &lt;version&gt;${glassfish.version}&lt;/version&gt;<br/>                        &lt;/artifactInstaller&gt; --&gt;<br/>                        &lt;zipUrlInstaller&gt;<br/>                            &lt;url&gt;https://github.com/eclipse-ee4j/glassfish/releases/download/${glassfish.version}/glassfish-${glassfish.version}.zip&lt;/url&gt;<br/>                            &lt;downloadDir&gt;${cargo.zipUrlInstaller.downloadDir}&lt;/downloadDir&gt;<br/>                        &lt;/zipUrlInstaller&gt;<br/>                    &lt;/container&gt;<br/>                    &lt;configuration&gt;<br/>                        &lt;!-- the configuration used to deploy --&gt;<br/>                        &lt;home&gt;${project.build.directory}/glassfish7x-home&lt;/home&gt;<br/>                        &lt;properties&gt;<br/>                            &lt;cargo.remote.password&gt;&lt;/cargo.remote.password&gt;<br/>                            &lt;cargo.glassfish.removeDefaultDatasource&gt;true&lt;/cargo.glassfish.removeDefaultDatasource&gt;<br/>                        &lt;/properties&gt;<br/>                        &lt;datasources&gt;<br/>                            &lt;datasource&gt;<br/>                                &lt;driverClass&gt;org.apache.derby.jdbc.EmbeddedDriver&lt;/driverClass&gt;<br/>                                &lt;url&gt;jdbc:derby:derbyDB;create=true&lt;/url&gt;<br/>                                &lt;jndiName&gt;jdbc/__default&lt;/jndiName&gt;<br/>                                &lt;username&gt;APP&lt;/username&gt;<br/>                                &lt;password&gt;nonemptypassword&lt;/password&gt;<br/>                            &lt;/datasource&gt;<br/>                        &lt;/datasources&gt;<br/>                    &lt;/configuration&gt;<br/>                &lt;/configuration&gt;<br/>            &lt;/plugin&gt;<br/>        &lt;/plugins&gt;<br/>    &lt;/build&gt;<br/>&lt;/profile&gt;</span></pre><p id="516a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与NetBeans IDE或带有GlassFish Pack的Eclipse IDE中的方法不同，启动GlassFish将同时启动内置的Derby。Cargo没有像预期的那样启动内置的Derby，要在我们的项目中使用默认数据源，清除默认数据源并添加一个新的基于嵌入式Derby的默认数据源。</p><p id="badd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行以下命令。它将编译项目源代码并将应用程序打包到war档案中，然后启动托管的GlassFish服务器(使用新的<code class="fe ku kv kw kx b">cargo-domain</code>)，然后将包部署到这个正在运行的服务器中。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="2d05" class="nb lv iq kx b be nc nd l ne nf">mvn clean package cargo:run -DskipTests -Dmaven.test.skip=true</span></pre><p id="5fe1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意，当您第一次运行这个命令时，它将花费一些时间来下载GlassFish再发行版的副本，并将文件解压缩到build文件夹中。</p><p id="8266" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在另一个终端窗口中，执行<code class="fe ku kv kw kx b">curl http://localhost:8080/jpa-examples/rest/persons</code>来验证端点。</p><p id="01b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要停止服务器，只需在原来的GlassFish运行控制台中发送一个<code class="fe ku kv kw kx b">CTRL+C</code>。</p><h2 id="fa54" class="nl lv iq bd lw nq nr dn ma ns nt dp me jy nu nv mi kc nw nx mm kg ny nz mq oa bi translated">通过WildFly插件部署到WildFly</h2><p id="fbdd" class="pw-post-body-paragraph jn jo iq jp b jq ms js jt ju mt jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">WildFly项目本身提供了一个官方的WildFly Maven插件，我们将在一个新的Maven配置文件中配置它。</p><blockquote class="of og oh"><p id="59d8" class="jn jo ng jp b jq jr js jt ju jv jw jx oi jz ka kb oj kd ke kf ok kh ki kj kk ij bi translated"><em class="iq">货maven插件也支持野，勾选</em> <a class="ae ld" href="https://codehaus-cargo.github.io/cargo/WildFly+27.x.html" rel="noopener ugc nofollow" target="_blank"> <em class="iq">货野docs </em> </a> <em class="iq">。</em></p></blockquote><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="b8b4" class="nb lv iq kx b be nc nd l ne nf">&lt;profile&gt;<br/>    &lt;id&gt;wildfly&lt;/id&gt;<br/>    &lt;properties&gt;<br/>        &lt;!-- Wildfly server --&gt;<br/>        &lt;wildfly.artifactId&gt;wildfly-preview-dist&lt;/wildfly.artifactId&gt;<br/>        &lt;jboss-as.home&gt;${project.build.directory}/wildfly-preview-${wildfly.version}&lt;/jboss-as.home&gt;<br/>    &lt;/properties&gt;<br/>    &lt;build&gt;<br/>        &lt;plugins&gt;</span></pre><pre class="nh mx kx ni nj aw nk bi"><span id="db0e" class="nl lv iq kx b gy nm nn l no nf">            &lt;!-- unpack a copy of WildFly--&gt;<br/>            &lt;plugin&gt;<br/>                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br/>                &lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;<br/>                &lt;version&gt;${maven-dependency-plugin.version}&lt;/version&gt;<br/>                &lt;executions&gt;<br/>                    &lt;execution&gt;<br/>                        &lt;id&gt;unpack&lt;/id&gt;<br/>                        &lt;phase&gt;process-classes&lt;/phase&gt;<br/>                        &lt;goals&gt;<br/>                            &lt;goal&gt;unpack&lt;/goal&gt;<br/>                        &lt;/goals&gt;<br/>                        &lt;configuration&gt;<br/>                            &lt;artifactItems&gt;<br/>                                &lt;artifactItem&gt;<br/>                                    &lt;groupId&gt;org.wildfly&lt;/groupId&gt;<br/>                                    &lt;artifactId&gt;${wildfly.artifactId}&lt;/artifactId&gt;<br/>                                    &lt;version&gt;${wildfly.version}&lt;/version&gt;<br/>                                    &lt;type&gt;zip&lt;/type&gt;<br/>                                    &lt;overWrite&gt;false&lt;/overWrite&gt;<br/>                                    &lt;outputDirectory&gt;${project.build.directory}&lt;/outputDirectory&gt;<br/>                                &lt;/artifactItem&gt;<br/>                            &lt;/artifactItems&gt;<br/>                        &lt;/configuration&gt;<br/>                    &lt;/execution&gt;<br/>                &lt;/executions&gt;<br/>            &lt;/plugin&gt;</span><span id="d477" class="nl lv iq kx b gy np nn l no nf">            &lt;!-- The WildFly plugin deploys your war to a local running WildFly container --&gt;<br/>            &lt;!-- To use, run: mvn package wildfly:deploy --&gt;<br/>            &lt;!-- For Jakarta EE 9, use `wildfly-preview-dist` as artifactId instead to start and deploy applications--&gt;<br/>            &lt;!-- Run: mvn clean wildfly:run -PWildfly -Dwildfly.artifactId=wildfly-preview-dist -Dwildfly.version=22.0.0.Alpha1 --&gt;<br/>            &lt;!-- or set the `jboss-as.home` to run: mvn clean wildfly:run -PWildfly -Djboss-as.home=D:\appsvr\wildfly-preview-22.0.0.Alpha1--&gt;<br/>            &lt;plugin&gt;<br/>                &lt;groupId&gt;org.wildfly.plugins&lt;/groupId&gt;<br/>                &lt;artifactId&gt;wildfly-maven-plugin&lt;/artifactId&gt;<br/>                &lt;version&gt;${wildfly-maven-plugin.version}&lt;/version&gt;<br/>            &lt;/plugin&gt;<br/>        &lt;/plugins&gt;<br/>    &lt;/build&gt;<br/>    &lt;repositories&gt;<br/>        &lt;repository&gt;<br/>            &lt;id&gt;opensaml&lt;/id&gt;<br/>            &lt;url&gt;https://build.shibboleth.net/nexus/content/repositories/releases/&lt;/url&gt;<br/>        &lt;/repository&gt;<br/>    &lt;/repositories&gt;<br/>&lt;/profile&gt;</span></pre><p id="0679" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有了WildFly插件，我们可以将应用程序部署到嵌入式WildFly、托管WildFly服务器或远程运行WildFly服务器中。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="098b" class="nb lv iq kx b be nc nd l ne nf">mvn clean wildfly:run -Pwildfly -DskipTests -Dmaven.test.skip=true</span></pre><p id="f6e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">默认情况下，如果我们不设置<code class="fe ku kv kw kx b">jboss-as.home</code>或远程主机连接信息，它将引导一个嵌入式WildFly，并使用嵌入式服务器运行应用程序。</p><p id="d8b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我们配置Maven dependency插件来下载wildly的副本，将文件解压到项目构建目录，并设置一个<code class="fe ku kv kw kx b">jboss-as.home</code>属性，值是wildly的位置。WildFly插件将管理整个WildFly生命周期-启动WildFly服务器，将应用程序部署到正在运行的服务器中，(使用<code class="fe ku kv kw kx b">CTRL+C</code>热键)停止服务器。</p><h1 id="2576" class="lu lv iq bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">测试JPA特性</h1><p id="b9a9" class="pw-post-body-paragraph jn jo iq jp b jq ms js jt ju mt jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">这里我假设你以前熟悉<a class="ae ld" href="https://www.junit.org" rel="noopener ugc nofollow" target="_blank"> JUnit </a>和<a class="ae ld" href="https://arquillian.org" rel="noopener ugc nofollow" target="_blank"> Arquillian </a>。</p><blockquote class="of og oh"><p id="cb0b" class="jn jo ng jp b jq jr js jt ju jv jw jx oi jz ka kb oj kd ke kf ok kh ki kj kk ij bi translated"><em class="iq">对于Arqullian框架的新开发者，请阅读官方</em><a class="ae ld" href="https://arquillian.org/guides" rel="noopener ugc nofollow" target="_blank"><em class="iq">Arqullian指南</em> </a> <em class="iq">开始你的第一步。请注意，这些教程有多种语言版本，包括简体中文。</em></p><p id="c7ae" class="jn jo ng jp b jq jr js jt ju jv jw jx oi jz ka kb oj kd ke kf ok kh ki kj kk ij bi translated"><em class="iq">进入我的</em> <a class="ae ld" href="https://github.com/hantsy/jakartaee8-starter-boilerplate" rel="noopener ugc nofollow" target="_blank"> <em class="iq">雅加达EE 8入门样板项目</em> </a> <em class="iq">和</em> <a class="ae ld" href="https://github.com/hantsy/jakartaee9-starter-boilerplate" rel="noopener ugc nofollow" target="_blank"> <em class="iq">雅加达EE 9入门样板项目</em> </a> <em class="iq">更新你的基础知识。</em></p></blockquote><p id="8b87" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从Jakarta EE 9开始，它使用新的<code class="fe ku kv kw kx b">jakarta</code>名称空间，Arquillian 1.7.0.x开始支持这些变化。</p><p id="6922" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在接下来的步骤中，我们将配置一个托管的GlassFish Arquillian适配器来运行测试代码。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="50ce" class="nb lv iq kx b be nc nd l ne nf">&lt;profile&gt;<br/>    &lt;id&gt;arq-glassfish-managed&lt;/id&gt;<br/>    &lt;properties&gt;<br/>        &lt;skip.unit.tests&gt;true&lt;/skip.unit.tests&gt;<br/>        &lt;skip.integration.tests&gt;false&lt;/skip.integration.tests&gt;<br/>    &lt;/properties&gt;<br/>    &lt;dependencies&gt;<br/>        &lt;!-- Jersey --&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;org.glassfish.jersey.media&lt;/groupId&gt;<br/>            &lt;artifactId&gt;jersey-media-sse&lt;/artifactId&gt;<br/>            &lt;version&gt;${jersey.version}&lt;/version&gt;<br/>            &lt;scope&gt;test&lt;/scope&gt;<br/>        &lt;/dependency&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;org.glassfish.jersey.media&lt;/groupId&gt;<br/>            &lt;artifactId&gt;jersey-media-json-binding&lt;/artifactId&gt;<br/>            &lt;version&gt;${jersey.version}&lt;/version&gt;<br/>            &lt;scope&gt;test&lt;/scope&gt;<br/>        &lt;/dependency&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;org.glassfish.jersey.inject&lt;/groupId&gt;<br/>            &lt;artifactId&gt;jersey-hk2&lt;/artifactId&gt;<br/>            &lt;version&gt;${jersey.version}&lt;/version&gt;<br/>            &lt;scope&gt;test&lt;/scope&gt;<br/>        &lt;/dependency&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;org.glassfish.jersey.core&lt;/groupId&gt;<br/>            &lt;artifactId&gt;jersey-client&lt;/artifactId&gt;<br/>            &lt;version&gt;${jersey.version}&lt;/version&gt;<br/>            &lt;scope&gt;test&lt;/scope&gt;<br/>        &lt;/dependency&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;com.github.hantsy.arquillian-container-glassfish-jakarta&lt;/groupId&gt;<br/>            &lt;artifactId&gt;arquillian-glassfish-managed-jakarta&lt;/artifactId&gt;<br/>            &lt;version&gt;${arquillian-glassfish-jakarta.version}&lt;/version&gt;<br/>            &lt;scope&gt;test&lt;/scope&gt;<br/>        &lt;/dependency&gt;<br/>    &lt;/dependencies&gt;<br/>    &lt;build&gt;<br/>        &lt;testResources&gt;<br/>            &lt;testResource&gt;<br/>                &lt;directory&gt;src/test/resources&lt;/directory&gt;<br/>            &lt;/testResource&gt;<br/>            &lt;testResource&gt;<br/>                &lt;directory&gt;src/test/arq-glassfish-managed&lt;/directory&gt;<br/>            &lt;/testResource&gt;<br/>        &lt;/testResources&gt;<br/>        &lt;plugins&gt;<br/>            &lt;plugin&gt;<br/>                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br/>                &lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;<br/>                &lt;version&gt;${maven-dependency-plugin.version}&lt;/version&gt;<br/>                &lt;executions&gt;<br/>                    &lt;execution&gt;<br/>                        &lt;id&gt;unpack&lt;/id&gt;<br/>                        &lt;phase&gt;pre-integration-test&lt;/phase&gt;<br/>                        &lt;goals&gt;<br/>                            &lt;goal&gt;unpack&lt;/goal&gt;<br/>                        &lt;/goals&gt;<br/>                        &lt;configuration&gt;<br/>                            &lt;artifactItems&gt;<br/>                                &lt;artifactItem&gt;<br/>                                    &lt;groupId&gt;org.glassfish.main.distributions&lt;/groupId&gt;<br/>                                    &lt;artifactId&gt;glassfish&lt;/artifactId&gt;<br/>                                    &lt;version&gt;${glassfish.version}&lt;/version&gt;<br/>                                    &lt;type&gt;zip&lt;/type&gt;<br/>                                    &lt;overWrite&gt;false&lt;/overWrite&gt;<br/>                                    &lt;outputDirectory&gt;${project.build.directory}&lt;/outputDirectory&gt;<br/>                                &lt;/artifactItem&gt;<br/>                            &lt;/artifactItems&gt;<br/>                        &lt;/configuration&gt;<br/>                    &lt;/execution&gt;<br/>                &lt;/executions&gt;<br/>            &lt;/plugin&gt;<br/>            &lt;plugin&gt;<br/>                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br/>                &lt;artifactId&gt;maven-failsafe-plugin&lt;/artifactId&gt;<br/>                &lt;version&gt;${maven-failsafe-plugin.version}&lt;/version&gt;<br/>                &lt;configuration&gt;<br/>                    &lt;environmentVariables&gt;<br/>                        &lt;GLASSFISH_HOME&gt;${project.build.directory}/glassfish7&lt;/GLASSFISH_HOME&gt;<br/>                    &lt;/environmentVariables&gt;<br/>                &lt;/configuration&gt;<br/>            &lt;/plugin&gt;<br/>        &lt;/plugins&gt;<br/>    &lt;/build&gt;<br/>&lt;/profile&gt;</span></pre><p id="8258" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的配置中，我们添加了<code class="fe ku kv kw kx b">com.github.hantsy.arquillian-container-glassfish-jakarta:arquillian-glassfish-managed-jakarta</code>，这是我的官方<a class="ae ld" href="https://github.com/arquillian/arquillian-container-glassfish6" rel="noopener ugc nofollow" target="_blank"> Arquillian容器GlassFish项目</a>的<a class="ae ld" href="https://github.com/hantsy/arquillian-container-glassfish-jakarta" rel="noopener ugc nofollow" target="_blank">叉子</a>。</p><p id="97af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在<code class="fe ku kv kw kx b">pre-integration-test</code>阶段预发布了最新的GlassFish 7.0的副本。阿奎利亚测试将在<code class="fe ku kv kw kx b">integretion-test</code>阶段进行。</p><p id="0fb3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们创建一个简单的Arquillian测试来验证JPA 3.1中的UUID基本类型特性。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="17db" class="nb lv iq kx b be nc nd l ne nf">@ExtendWith(ArquillianExtension.class)<br/>public class UUIDStrategyTest {</span></pre><pre class="nh mx kx ni nj aw nk bi"><span id="c1a0" class="nl lv iq kx b gy nm nn l no nf">    private final static Logger LOGGER = Logger.getLogger(UUIDStrategyTest.class.getName());</span><span id="0689" class="nl lv iq kx b gy np nn l no nf">    @Deployment<br/>    public static WebArchive createDeployment() {<br/>        return ShrinkWrap.create(WebArchive.class)<br/>                .addClasses(Person.class, Gender.class)<br/>                .addAsResource("test-persistence.xml", "META-INF/persistence.xml")<br/>                .addAsWebInfResource(EmptyAsset.INSTANCE, "beans.xml");<br/>    }</span><span id="5395" class="nl lv iq kx b gy np nn l no nf">    @PersistenceContext<br/>    private EntityManager em;</span><span id="2214" class="nl lv iq kx b gy np nn l no nf">    @Inject<br/>    UserTransaction ux;</span><span id="cc92" class="nl lv iq kx b gy np nn l no nf">    @BeforeEach<br/>    public void before() throws Exception {<br/>        startTx();<br/>    }</span><span id="c794" class="nl lv iq kx b gy np nn l no nf">    private void startTx() throws Exception {<br/>        ux.begin();<br/>        em.joinTransaction();<br/>    }</span><span id="429b" class="nl lv iq kx b gy np nn l no nf">    @AfterEach<br/>    public void after() throws Exception {<br/>        endTx();<br/>    }</span><span id="6ef2" class="nl lv iq kx b gy np nn l no nf">    private void endTx() throws Exception {<br/>        try {<br/>            if( ux.getStatus() == Status.STATUS_ACTIVE ) {<br/>                ux.commit();<br/>            }<br/>        } catch (Exception e) {<br/>            ux.rollback();<br/>        }<br/>    }</span><span id="63cc" class="nl lv iq kx b gy np nn l no nf">    @Test<br/>    public void testPersistingPersons() throws Exception {<br/>        final Person person = new Person();<br/>        person.setName("Hantsy Bai");<br/>        em.persist(person);<br/>        endTx();</span><span id="de90" class="nl lv iq kx b gy np nn l no nf">        startTx();<br/>        final Person foundPerson = em.find(Person.class, person.getId());<br/>        assertNotNull(foundPerson.getId());<br/>        LOGGER.log(Level.INFO, "Found person: {0}", foundPerson);<br/>    }<br/>}</span></pre><p id="1bc2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">测试类上的<code class="fe ku kv kw kx b">@ExtendWith(ArquillianExtension.class)</code>注释支持Arquillian测试生命周期。</p><p id="525a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ku kv kw kx b">@Deployment</code>带注释的静态方法定义了将被打包到测试档案中并被部署到被管理的GlassFish服务器中的资源。使用包膜很容易创建精细的部署单元。</p><p id="89be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以像在简单的CDI bean中一样，在Arquillian测试中注入<code class="fe ku kv kw kx b">EntityManager</code>和<code class="fe ku kv kw kx b">UserTransaction</code>bean。</p><p id="4674" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个测试类中，我们设置了<code class="fe ku kv kw kx b">@BeforeEach</code>和<code class="fe ku kv kw kx b">@AfterEach</code>钩子来开始一个事务和结束事务。</p><p id="cbf9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">测试方法<code class="fe ku kv kw kx b">testPersistingPersons</code>看起来和普通的JUnit测试没有什么区别。首先，我们持久化一个person实体，并提交事务以确保它将按预期刷新到数据库中。然后执行一个简单的JPA查询来验证持久化数据。</p><p id="ef2a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">执行以下命令来运行测试。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="66b9" class="nb lv iq kx b be nc nd l ne nf">mvn clean verify -Parq-glassfish-managed</span></pre><p id="2b7b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">类似地，创建一个测试来验证Jakarta rumtimes中新的数字函数和日期时间函数。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="9d50" class="nb lv iq kx b be nc nd l ne nf">@ExtendWith(ArquillianExtension.class)<br/>public class JPQLFunctionsTest {</span></pre><pre class="nh mx kx ni nj aw nk bi"><span id="deb1" class="nl lv iq kx b gy nm nn l no nf">    private final static Logger LOGGER = Logger.getLogger(JPQLFunctionsTest.class.getName());</span><span id="77d7" class="nl lv iq kx b gy np nn l no nf">    @Deployment<br/>    public static WebArchive createDeployment() {<br/>        return ShrinkWrap.create(WebArchive.class)<br/>                .addClasses(Person.class, Gender.class)<br/>                .addAsResource("test-persistence.xml", "META-INF/persistence.xml")<br/>                .addAsWebInfResource(EmptyAsset.INSTANCE, "beans.xml");<br/>    }</span><span id="ce95" class="nl lv iq kx b gy np nn l no nf">    @PersistenceContext<br/>    private EntityManager em;</span><span id="aeb2" class="nl lv iq kx b gy np nn l no nf">    @Inject<br/>    UserTransaction ux;</span><span id="9953" class="nl lv iq kx b gy np nn l no nf">    @BeforeEach<br/>    public void before() throws Exception {<br/>        clearPersons();<br/>        startTx();<br/>    }</span><span id="d094" class="nl lv iq kx b gy np nn l no nf">    private void clearPersons() throws Exception {<br/>        startTx();<br/>        var builder = em.getCriteriaBuilder();<br/>        var deletePersonQuery = builder.createCriteriaDelete(Person.class);<br/>        var deletedPersons = em.createQuery(deletePersonQuery).executeUpdate();<br/>        LOGGER.log(Level.INFO, "Deleted {0} persons", deletedPersons);<br/>        endTx();<br/>    }</span><span id="c4a4" class="nl lv iq kx b gy np nn l no nf">    private void startTx() throws Exception {<br/>        ux.begin();<br/>        em.joinTransaction();<br/>    }</span><span id="e941" class="nl lv iq kx b gy np nn l no nf">    @AfterEach<br/>    public void after() throws Exception {<br/>        endTx();<br/>    }</span><span id="3ad7" class="nl lv iq kx b gy np nn l no nf">    private void endTx() throws Exception {<br/>        LOGGER.log(Level.INFO, "Transaction status: {0}", ux.getStatus());<br/>        try {<br/>            if (ux.getStatus() == Status.STATUS_ACTIVE) {<br/>                ux.commit();<br/>            }<br/>        } catch (Exception e) {<br/>            ux.rollback();<br/>        }<br/>    }</span><span id="6763" class="nl lv iq kx b gy np nn l no nf">    @Test<br/>    @DisplayName("&gt;&gt;&gt; test numeric functions")<br/>    public void testNumericFunctions() throws Exception {<br/>        var person = new Person("John", 30);<br/>        em.persist(person);<br/>        var id = person.getId();<br/>        assertNotNull(id);<br/>        endTx();</span><span id="2a08" class="nl lv iq kx b gy np nn l no nf">        startTx();<br/>        try {<br/>            var queryString = """<br/>                    SELECT p.name,<br/>                    CEILING(p.salary),<br/>                    FLOOR(p.salary),<br/>                    ROUND(p.salary, 1),<br/>                    EXP(p.yearsWorked),<br/>                    LN(p.yearsWorked),<br/>                    POWER(p.yearsWorked,2),<br/>                    SIGN(p.yearsWorked)<br/>                    FROM Person p<br/>                    WHERE p.id=:id<br/>                    """;<br/>            var query = em.createQuery(queryString);</span><span id="14cf" class="nl lv iq kx b gy np nn l no nf">            query.setParameter("id", id);<br/>            // for EclipseLinks<br/>            query.setHint(QueryHints.RESULT_TYPE, ResultType.Map);<br/>            List&lt;Map&lt;String, Object&gt;&gt; resultList = query.getResultList();<br/>            LOGGER.log(Level.INFO, "result size:{0}", resultList.size());<br/>            resultList.forEach(data -&gt; {<br/>                data.forEach((k, v) -&gt; LOGGER.log(Level.INFO, "field:{0}, value: {1}", new Object[]{k, v}));<br/>            });<br/>        } catch (Exception ex) {<br/>            fail(ex);<br/>        }<br/>    }</span><span id="3958" class="nl lv iq kx b gy np nn l no nf">    @Test<br/>    @DisplayName("&gt;&gt;&gt; test nen datetime functions")<br/>    public void testDateTimeFunctions() throws Exception {<br/>        var person = new Person("John", 30);<br/>        em.persist(person);<br/>        assertNotNull(person.getId());<br/>        endTx();</span><span id="34b7" class="nl lv iq kx b gy np nn l no nf">        startTx();<br/>        try {<br/>            var queryString = """<br/>                    SELECT p.name as name,<br/>                    LOCAL TIME as localTime,<br/>                    LOCAL DATETIME as localDateTime,<br/>                    LOCAL DATE as localDate<br/>                    FROM Person p<br/>                    """;<br/>            // for EclipseLinks<br/>            var query = em.createQuery(queryString);<br/>            // for EclipseLinks<br/>            query.setHint(QueryHints.RESULT_TYPE, ResultType.Map);<br/>            List&lt;Map&lt;String, Object&gt;&gt; resultList = query.getResultList();<br/>            LOGGER.log(Level.INFO, "result size:{0}", resultList.size());<br/>            resultList.forEach(data -&gt; {<br/>                data.forEach((k, v) -&gt; LOGGER.log(Level.INFO, "field:{0}, value: {1}", new Object[]{k, v}));<br/>            });<br/>        } catch (Exception ex) {<br/>            fail(ex);<br/>        }<br/>    }</span><span id="8083" class="nl lv iq kx b gy np nn l no nf">    @Test<br/>    @DisplayName("&gt;&gt;&gt; test `EXTRACT` functions")<br/>    public void testExtractFunctions() throws Exception {<br/>        var person = new Person("John", 30);<br/>        em.persist(person);<br/>        assertNotNull(person.getId());<br/>        endTx();</span><span id="9409" class="nl lv iq kx b gy np nn l no nf">        startTx();<br/>        try {<br/>            var queryString = """<br/>                    SELECT p.name as name,<br/>                    EXTRACT(YEAR FROM p.birthDate) as year,<br/>                    EXTRACT(QUARTER FROM p.birthDate) as quarter,<br/>                    EXTRACT(MONTH FROM p.birthDate) as month,<br/>                    EXTRACT(WEEK FROM p.birthDate) as week,<br/>                    EXTRACT(DAY FROM p.birthDate) as day,<br/>                    EXTRACT(HOUR FROM p.birthDate) as hour,<br/>                    EXTRACT(MINUTE FROM p.birthDate) as minute,<br/>                    EXTRACT(SECOND FROM p.birthDate) as second<br/>                    FROM Person p<br/>                    """;<br/>            var query = em.createQuery(queryString);<br/>            // for EclipseLinks<br/>            query.setHint(QueryHints.RESULT_TYPE, ResultType.Map);<br/>            List&lt;Map&lt;String, Object&gt;&gt; resultList = query.getResultList();<br/>            LOGGER.log(Level.INFO, "result size:{0}", resultList.size());<br/>            resultList.forEach(data -&gt; {<br/>                data.forEach((k, v) -&gt; LOGGER.log(Level.INFO, "field:{0}, value: {1}", new Object[]{k, v}));<br/>            });<br/>        } catch (Exception ex) {<br/>            fail(ex);<br/>        }<br/>    }<br/>}</span></pre><p id="e090" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者，创建一个测试来验证标准API。</p><pre class="lf lg lh li gt mx kx my bn mz na bi"><span id="35fe" class="nb lv iq kx b be nc nd l ne nf">@ExtendWith(ArquillianExtension.class)<br/>public class JPQLCriteriaBuilderTest {</span></pre><pre class="nh mx kx ni nj aw nk bi"><span id="1f7f" class="nl lv iq kx b gy nm nn l no nf">    private final static Logger LOGGER = Logger.getLogger(JPQLCriteriaBuilderTest.class.getName());</span><span id="7b71" class="nl lv iq kx b gy np nn l no nf">    @Deployment<br/>    public static WebArchive createDeployment() {<br/>        return ShrinkWrap.create(WebArchive.class)<br/>                .addClasses(Person.class, Gender.class)<br/>                .addAsResource("test-persistence.xml", "META-INF/persistence.xml")<br/>                .addAsWebInfResource(EmptyAsset.INSTANCE, "beans.xml");<br/>    }</span><span id="aa88" class="nl lv iq kx b gy np nn l no nf">    @PersistenceContext<br/>    private EntityManager em;</span><span id="49d4" class="nl lv iq kx b gy np nn l no nf">    @Inject<br/>    UserTransaction ux;</span><span id="db4d" class="nl lv iq kx b gy np nn l no nf">    @BeforeEach<br/>    public void before() throws Exception {<br/>        clearPersons();<br/>        startTx();<br/>    }</span><span id="1479" class="nl lv iq kx b gy np nn l no nf">    private void clearPersons() throws Exception {<br/>        startTx();<br/>        var builder = em.getCriteriaBuilder();<br/>        var deletePersonQuery = builder.createCriteriaDelete(Person.class);<br/>        var deletedPersons = em.createQuery(deletePersonQuery).executeUpdate();<br/>        LOGGER.log(Level.INFO, "Deleted {0} persons", deletedPersons);<br/>        endTx();<br/>    }</span><span id="8be9" class="nl lv iq kx b gy np nn l no nf">    private void startTx() throws Exception {<br/>        ux.begin();<br/>        em.joinTransaction();<br/>    }</span><span id="d2c8" class="nl lv iq kx b gy np nn l no nf">    @AfterEach<br/>    public void after() throws Exception {<br/>        endTx();<br/>    }</span><span id="b4cc" class="nl lv iq kx b gy np nn l no nf">    private void endTx() throws Exception {<br/>        LOGGER.log(Level.INFO, "Transaction status: {0}", ux.getStatus());<br/>        try {<br/>            if (ux.getStatus() == Status.STATUS_ACTIVE) {<br/>                ux.commit();<br/>            }<br/>        } catch (Exception e) {<br/>            ux.rollback();<br/>        }<br/>    }</span><span id="5df2" class="nl lv iq kx b gy np nn l no nf">    @Test<br/>    @DisplayName("&gt;&gt;&gt; test numeric functions")<br/>    public void testNumericFunctions() throws Exception {<br/>        var person = new Person("John", 30);<br/>        em.persist(person);<br/>        var id = person.getId();<br/>        assertNotNull(id);<br/>        endTx();</span><span id="221a" class="nl lv iq kx b gy np nn l no nf">        startTx();<br/>        try {<br/>            var cb = em.getCriteriaBuilder();<br/>            var query = cb.createTupleQuery();<br/>            var root = query.from(Person.class);</span><span id="07b0" class="nl lv iq kx b gy np nn l no nf">            query.multiselect(root.get("name"),<br/>                    cb.ceiling(root.get("salary")),<br/>                    cb.floor(root.get("salary")),<br/>                    cb.round(root.get("salary"), 1),<br/>                    cb.exp(root.get("yearsWorked")),<br/>                    cb.ln(root.get("yearsWorked")),<br/>                    cb.power(root.get("yearsWorked"), 2),<br/>                    cb.sign(root.get("yearsWorked"))<br/>            );<br/>            query.where(cb.equal(root.get("id"), id));</span><span id="049d" class="nl lv iq kx b gy np nn l no nf">            var resultList = em.createQuery(query).getResultList();<br/>            LOGGER.log(Level.INFO, "result size:{0}", resultList.size());<br/>            resultList.forEach(result -&gt;<br/>                    LOGGER.log(<br/>                            Level.INFO,<br/>                            // see: <a class="ae ld" href="https://github.com/eclipse-ee4j/eclipselink/issues/1593" rel="noopener ugc nofollow" target="_blank">https://github.com/eclipse-ee4j/eclipselink/issues/1593</a><br/>                            // John,12,345,12,345,12,345,7.389,0.693,4,1<br/>                            "tuple data :{0},{1},{2},{3},{4},{5},{6},{7}",<br/>                            new Object[]{<br/>                                    result.get(0, String.class),<br/>                                    result.get(1, BigDecimal.class), // it should return BigDecimal<br/>                                    result.get(2, BigDecimal.class),<br/>                                    result.get(3, BigDecimal.class),<br/>                                    result.get(4, Double.class),<br/>                                    result.get(5, Double.class),<br/>                                    result.get(6, Double.class),<br/>                                    result.get(7, Integer.class)<br/>                            }<br/>                    )<br/>            );<br/>        } catch (Exception ex) {<br/>            fail(ex);<br/>        }<br/>    }</span><span id="9ab3" class="nl lv iq kx b gy np nn l no nf">    @Test<br/>    @DisplayName("&gt;&gt;&gt; test nen datetime functions")<br/>    public void testDateTimeFunctions() throws Exception {<br/>        var person = new Person("John", 30);<br/>        em.persist(person);<br/>        var id = person.getId();<br/>        assertNotNull(id);<br/>        endTx();</span><span id="3ac7" class="nl lv iq kx b gy np nn l no nf">        startTx();<br/>        try {<br/>            var cb = em.getCriteriaBuilder();<br/>            var query = cb.createTupleQuery();<br/>            var root = query.from(Person.class);</span><span id="6c2c" class="nl lv iq kx b gy np nn l no nf">            query.multiselect(root.get("name"),<br/>                    cb.localTime(),<br/>                    cb.localDateTime(),<br/>                    cb.localDate()<br/>            );<br/>            query.where(cb.equal(root.get("id"), id));</span><span id="54ac" class="nl lv iq kx b gy np nn l no nf">            var resultList = em.createQuery(query).getResultList();<br/>            LOGGER.log(Level.INFO, "result size:{0}", resultList.size());<br/>            resultList.forEach(data -&gt;<br/>                    LOGGER.log(<br/>                            Level.INFO,<br/>                            "tuple data :{0},{1},{2},{3}",<br/>                            new Object[]{<br/>                                    data.get(0, String.class),<br/>                                    data.get(1, java.time.LocalTime.class),<br/>                                    data.get(2, java.time.LocalDateTime.class),<br/>                                    data.get(3, java.time.LocalDate.class)<br/>                            }<br/>                    )<br/>            );<br/>        } catch (Exception ex) {<br/>            fail(ex);<br/>        }<br/>    }<br/>}</span></pre><p id="52a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但遗憾的是，GlassFish 7.0.0中有一个bug——M9将无法通过测试<code class="fe ku kv kw kx b">JPQLFunctionsTest</code>，更多详情请查看Github问题<a class="ae ld" href="https://github.com/eclipse-ee4j/glassfish/issues/24120" rel="noopener ugc nofollow" target="_blank"> GlassFish #24120 </a>。</p><p id="dc2f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从我的github中查看<a class="ae ld" href="https://github.com/hantsy/jakartaee10-sandbox/tree/master/hibernate" rel="noopener ugc nofollow" target="_blank"> Hibernate </a>和<a class="ae ld" href="https://github.com/hantsy/jakartaee10-sandbox/tree/master/jpa" rel="noopener ugc nofollow" target="_blank"> Jakarta Persistence </a>的示例代码。</p></div></div>    
</body>
</html>