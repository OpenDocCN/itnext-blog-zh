<html>
<head>
<title>Hashicorp Vault on Kubernetes with Auto-Unseal</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes上的Hashicorp保险库具有自动解封功能</h1>
<blockquote>原文：<a href="https://itnext.io/hashicorp-vault-on-kubernetes-with-auto-unseal-b7e64edbe63e?source=collection_archive---------1-----------------------#2019-02-26">https://itnext.io/hashicorp-vault-on-kubernetes-with-auto-unseal-b7e64edbe63e?source=collection_archive---------1-----------------------#2019-02-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="5355" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">真的是自恢复和自动化友好的吗？有什么隐情？</p><p id="53fa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">机密管理和数据保护至关重要。然而，市场上的大多数解决方案并不是为<a class="ae ko" href="https://www.devsecops.org/" rel="noopener ugc nofollow" target="_blank"> DevSecOps </a>设计的，这意味着它们并没有将安全性作为代码来开发。相反，它们是由手动配置和雪花变化驱动的。此外，在一些组织中，他们不得不雇佣专门的供应商顾问来维护这个<a class="ae ko" href="https://martinfowler.com/bliki/SnowflakeServer.html" rel="noopener ugc nofollow" target="_blank">雪花服务器</a>。</p><h2 id="dbfb" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">DevSecOps宣言</h2><blockquote class="li lj lk"><p id="dbf5" class="jq jr ll js b jt ju jv jw jx jy jz ka lm kc kd ke ln kg kh ki lo kk kl km kn im bi translated"><strong class="js iu">倚在</strong>上空总是说“不”<br/> <strong class="js iu">数据&amp;安全科学</strong>上空恐惧， 不确定性和疑虑<br/> <strong class="js iu">开放贡献&amp;协作</strong>仅针对安全需求<br/> <strong class="js iu">使用API的可消费安全服务</strong>针对强制安全控制&amp;文书工作<br/> <strong class="js iu">业务驱动的安全分数</strong>超过橡皮图章安全<br/> <strong class="js iu">红色&amp;蓝色团队漏洞利用测试</strong>过度依赖扫描&amp;理论漏洞<br/> <strong class="js iu">全天候主动安全监控</strong>在获悉事件后过度反应<br/></p></blockquote><p id="6077" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Hashicorp Vault OSS为机密管理、加密即服务、特权访问管理、动态机密、租赁和续订等提供了功能全面且代码友好的解决方案。</p><p id="7de8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我已经尝试了几个令人印象深刻的功能，包括AWS认证后端，Kubernetes认证后端，动态MySQL秘密，动态AWS访问凭证，等等。他们非常容易设置和自动化友好。</p><h1 id="35a1" class="lp kq it bd kr lq lr ls ku lt lu lv kx lw lx ly la lz ma mb ld mc md me lg mf bi translated">哈希公司开源自动解封前</h1><p id="26e5" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">如您所知，自动解封以前仅适用于Vault Enterprise客户。2018年12月，Hashicorp公布了Vault 1.0和Vault OSS中的自动解封功能。</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi ml"><img src="../Images/473cd99205851e46d70c25d6f759935e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DqNz41pRcjlfpRgoYk6Dtg.png"/></div></div></figure><blockquote class="li lj lk"><p id="aaec" class="jq jr ll js b jt ju jv jw jx jy jz ka lm kc kd ke ln kg kh ki lo kk kl km kn im bi translated">开发自动解封是为了帮助降低解封保险库的操作复杂性，同时保持主密钥的安全。该功能将保护主密钥的责任从<em class="it">操作员</em>委托给受信任的<em class="it">设备</em>或<em class="it">服务</em>。</p></blockquote><p id="cba2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我们深入了解自动解封有多棒之前，让我们先来看看在旧版本的vault中我们必须手动做些什么。</p><p id="2ff7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">正如我们所知，有两种常见的方法使保险库舱密封:</p><ul class=""><li id="acc9" class="mx my it js b jt ju jx jy kb mz kf na kj nb kn nc nd ne nf bi translated">由于故障、部署或升级，保管库pod重新启动</li><li id="4d1d" class="mx my it js b jt ng jx nh kb ni kf nj kj nk kn nc nd ne nf bi translated">意向封存操作:<em class="ll">金库操作员封存</em></li></ul><p id="6a83" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这些情况下，Vault pods将无法通过Kubernetes就绪性探测，并停止为流量提供服务。每当我有一个这样的仪表板，我的心就死了一点，这是为什么。</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi nl"><img src="../Images/a78d3e9ac246d7b42c4dd17e49a1f9fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u6t11wOSqyVeUeLu1rGvnw.png"/></div></div></figure><p id="4c9a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如下面的命令所示，要让这些pod重新投入业务，我们必须手动<code class="fe nm nn no np b">kubectl port-foward</code>每个vault pod，并使用唯一的解封密钥运行<code class="fe nm nn no np b">vault operator unseal</code>至少3次。这需要3名操作员进行9次手动操作。</p><p id="b4b9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">说真的，谁想在凌晨3点起床，参加网络会议，找到解封键，并运行解封命令呢？😅</p><p id="9685" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">不仅运营成本如此之高，而且由于保险库停机导致的业务停机也是不可接受的。</strong></p><pre class="mm mn mo mp gt nq np nr ns aw nt bi"><span id="b1c0" class="kp kq it np b gy nu nv l nw nx"><strong class="np iu"># Check Vault Status, seems it is already sealed</strong><br/>(⎈ |:)bash-3.2$ vault status<br/>Key                Value<br/>---                -----<br/>Seal Type          shamir<br/><strong class="np iu">Sealed             true</strong><br/>Total Shares       5<br/>Threshold          3<br/><strong class="np iu">Unseal Progress    0/3</strong><br/>Unseal Nonce       n/a<br/>Version            0.10.1<br/>HA Enabled         true</span><span id="2ed2" class="kp kq it np b gy ny nv l nw nx"><strong class="np iu"># First Unseal, they key is hidden of course </strong><br/>(⎈ |:)bash-3.2$ vault operator unseal<br/>Unseal Key (will be hidden):<br/>Key                Value<br/>---                -----<br/>Seal Type          shamir<br/>Sealed             true<br/>Total Shares       5<br/>Threshold          3<br/><strong class="np iu">Unseal Progress    1/3</strong><br/>Unseal Nonce       12345678-2c03-320a-6dea-12345678<br/>Version            0.10.1<br/>HA Enabled         true</span><span id="5e87" class="kp kq it np b gy ny nv l nw nx"><strong class="np iu"># Second Unseal<br/></strong>(⎈ |:)bash-3.2$ vault operator unseal<br/>Unseal Key (will be hidden):<br/>Key                Value<br/>---                -----<br/>Seal Type          shamir<br/>Sealed             true<br/>Total Shares       5<br/>Threshold          3<br/><strong class="np iu">Unseal Progress    2/3</strong><br/>Unseal Nonce       12345678-2c03-320a-6dea-12345678<br/>Version            0.10.1<br/>HA Enabled         true</span><span id="1605" class="kp kq it np b gy ny nv l nw nx"><strong class="np iu"># Third Unseal is a charm!</strong><br/>(⎈ |:)bash-3.2$ vault operator unseal<br/>Unseal Key (will be hidden):<br/>Key                    Value<br/>---                    -----<br/>Seal Type              shamir<br/><strong class="np iu">Sealed                 false</strong><br/>Total Shares           5<br/>Threshold              3<br/>Version                0.10.1<br/>Cluster Name           vault-cluster-e17ad79e<br/>Cluster ID             ab0dd9a0-dfaa-25ef-0d30-12345678<br/>HA Enabled             true<br/>HA Cluster             <a class="ae ko" href="https://10.0.3.25:8201" rel="noopener ugc nofollow" target="_blank">https://10.0.3.25:8201</a><br/><strong class="np iu">HA Mode                standby</strong><br/>Active Node Address    <a class="ae ko" href="http://10.0.3.25:8200" rel="noopener ugc nofollow" target="_blank">http://10.0.3.25:8200</a></span></pre><h1 id="f7b2" class="lp kq it bd kr lq lr ls ku lt lu lv kx lw lx ly la lz ma mb ld mc md me lg mf bi translated">K8S图表中的自动解封</h1><p id="0816" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">我们的保险库部署管道非常简单，只有2个头盔图部署任务。</p><p id="b757" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，使用以下值将<a class="ae ko" href="https://github.com/helm/charts/tree/master/stable/consul" rel="noopener ugc nofollow" target="_blank">领事头盔图</a>部署为保险库存储后端。yaml。该图由OSS社区构建，如果您更喜欢官方的Hashicorp版本，您可以从<a class="ae ko" href="https://github.com/hashicorp/consul-helm" rel="noopener ugc nofollow" target="_blank">此处</a>获得。</p><p id="31ca" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请注意，领事副本大小为5。我们跨至少3个可用性区域(AZ)预配置了一个自动扩展组。AZ编号因地区和不同的云提供商而异(最低要求为3)。</p><p id="27ac" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">自动缩放组中的VM实例由Kubernetes用<code class="fe nm nn no np b"><em class="ll">kubectl label nodes &lt;node-name&gt; class=consul</em></code>T9来标记。下面的节点关联性和pod反关联性将确保5个咨询pod分布在至少3个az的5个节点上。</p><figure class="mm mn mo mp gt mq"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="8044" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第二步，使用vaule.yaml部署<a class="ae ko" href="https://github.com/helm/charts/tree/master/incubator/vault" rel="noopener ugc nofollow" target="_blank">金库舵图</a>，如下图。启用了以下一些关键功能:</p><ul class=""><li id="6a0b" class="mx my it js b jt ju jx jy kb mz kf na kj nb kn nc nd ne nf bi translated">咨询代理被用作与咨询服务对话的辅助工具</li><li id="0aeb" class="mx my it js b jt ng jx nh kb ni kf nj kj nk kn nc nd ne nf bi translated"><strong class="js iu">使用AWS KMS服务设置自动解封</strong></li><li id="4387" class="mx my it js b jt ng jx nh kb ni kf nj kj nk kn nc nd ne nf bi translated">Statsd-exporter作为sidecar运行，向Prometheus公开指标</li><li id="a23a" class="mx my it js b jt ng jx nh kb ni kf nj kj nk kn nc nd ne nf bi translated">Vault通过AWS证书管理器(ACM)作为具有SSL的负载平衡器服务公开</li></ul><figure class="mm mn mo mp gt mq"><div class="bz fp l di"><div class="nz oa l"/></div></figure><h1 id="3434" class="lp kq it bd kr lq lr ls ku lt lu lv kx lw lx ly la lz ma mb ld mc md me lg mf bi translated">自动解封:炸弹！</h1><p id="c12e" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">在几秒钟内，我们将启动并运行Consul和Vault服务。</p><p id="76a0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，让<em class="ll">用密钥份额和密钥阈值的配置初始化</em> vault。</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi ob"><img src="../Images/c0ee0e8a4e9a7ca8b33759213bb6a3d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lZSMB_L8Z36qI7z4BqgiSQ.png"/></div></div></figure><p id="baaa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个操作也可以在命令行中完成。</p><pre class="mm mn mo mp gt nq np nr ns aw nt bi"><span id="3bcf" class="kp kq it np b gy nu nv l nw nx">vault operator init -key-shares=5 -key-threshold=3</span></pre><p id="b10c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在初始化步骤之后，初始根令牌和恢复密钥都呈现给我们，并且可以作为文件下载。</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi oc"><img src="../Images/7d35a7ae13156c68f16d9b4216552e52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6oJYp_NuKYGzvWHAw-n8CQ.png"/></div></div></figure><p id="9959" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请注意，这些密钥只能访问和下载一次，您将无法再次获得它们。与命令行相同，它只会被打印到终端一次。</p><p id="6685" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">注意此时，<strong class="js iu">金库已经自动解封</strong>。事实上，我花了一段时间才意识到这一点，因为我的肌肉记忆仍然告诉我用其他操作者解封9次。为了确认内部到底发生了什么，我打开了vault pod日志，发现它正在使用指定的kms_key_id调用AWS KMS服务来自动解封自己。</p><p id="657a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们来看看自动解封的杀手级特性。<strong class="js iu">无论什么原因导致保险库pod重新启动，它们总是以未密封状态返回。</strong>我已经尝试过在分离舱内部杀死金库的过程；正在终止运行vault pod的虚拟机。我甚至做了一个<code class="fe nm nn no np b">helm delete --purge vault</code>，只要我再次部署它，它总是出现未密封状态。</p><h1 id="ae41" class="lp kq it bd kr lq lr ls ku lt lu lv kx lw lx ly la lz ma mb ld mc md me lg mf bi translated">有什么条件</h1><p id="dd5a" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">这听起来好得令人难以置信，对吗？一定有什么蹊跷。我们需要注入一些失败才能找到。</p><p id="0cfe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们倒回去检查一下我们之前做的一些准备工作。要使自动解封起作用，需要使用以下KMS权限部署保管库窗格。</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi od"><img src="../Images/0a2d7a843f8ce5de299cd9783efa119b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PSI_M0YDgPI0Yjb01lTBbg.png"/></div></div></figure><p id="5a09" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这些KMS权限附加到IAM策略，可以通过3种不同的方式进行部署，选择您最喜欢的方式:</p><ul class=""><li id="ee44" class="mx my it js b jt ju jx jy kb mz kf na kj nb kn nc nd ne nf bi translated">AWS实例概要文件:虚拟机级别，标准过程</li><li id="5d35" class="mx my it js b jt ng jx nh kb ni kf nj kj nk kn nc nd ne nf bi translated"><a class="ae ko" href="https://github.com/jtblin/kube2iam" rel="noopener ugc nofollow" target="_blank"> Kube2IAM </a>角色注释:Pod级别，更细粒度和自治</li><li id="46df" class="mx my it js b jt ng jx nh kb ni kf nj kj nk kn nc nd ne nf bi translated"><a class="ae ko" href="https://www.vaultproject.io/docs/configuration/seal/awskms.html#awskms-example" rel="noopener ugc nofollow" target="_blank"> AWS访问密钥和访问密码</a>(仅POC，不推荐)</li></ul></div><div class="ab cl oe of hx og" role="separator"><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj"/></div><div class="im in io ip iq"><h2 id="8ac3" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">故障注入案例1: KMS停机</h2><p id="9df0" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">有了这些信息，让我们通过删除IAM策略中的这些权限来模拟AWS KMS服务关闭，从而开始故障注入。这时，只有“KMS倒下了”。然而，只要保险库舱没有重启，所有3个舱都将保持健康和未密封。</p><p id="c32d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，在现实生活中，即使短期内无法获得KMS服务，对我们来说也不是什么大事。</p><h2 id="350f" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">故障注入情况2: KMS下降+ EC2在1 AZ内下降</h2><p id="6463" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">在下一个设置中，我删除了一个pod，让它重新启动，这可以模拟一个虚拟机故障。<br/> <em class="ll">可选:如果我们的ASG预选了4+AZ，我们也可以模拟一个AZ级别的故障。在此期间，新的吊舱将在第四AZ发射。这可以通过屏蔽NACL</em><a class="ae ko" href="https://en.wikipedia.org/wiki/Chaos_engineering#Chaos_Gorilla" rel="noopener ugc nofollow" target="_blank"><em class="ll">混乱大猩猩</em> </a> <em class="ll">来实现。</em></p><p id="1bc7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">正如预期的那样，保险库pod以密封状态返回，它通过了<em class="ll">活性探测</em>，但未通过<em class="ll">准备就绪探测</em>。</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi ol"><img src="../Images/b5311930fdf057c863e1ecb9343af049.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lMve0oqcaGqV-xmDM0537g.png"/></div></div><figcaption class="om on gj gh gi oo op bd b be z dk translated">Kubernetes:就绪探测失败</figcaption></figure><p id="3c5f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们更深入地研究下面的保险库pod日志。根据我们的失败注入，这个详细的错误消息非常有意义。如果这些KMS权限设置不正确，您也可能会在POC过程中看到类似的消息。</p><pre class="mm mn mo mp gt nq np nr ns aw nt bi"><span id="5a6e" class="kp kq it np b gy nu nv l nw nx">2019-02-21T21:59:28.288Z [INFO]  core: stored unseal keys supported, attempting fetch</span><span id="2893" class="kp kq it np b gy ny nv l nw nx">2019-02-21T21:59:28.623Z [WARN]  failed to unseal core: error="fetching stored unseal keys failed: failed to decrypt encrypted stored keys: error decrypting data encryption key: AccessDeniedException: The ciphertext refers to a customer master key that does not exist, does not exist in this region, or you are not allowed to access.</span><span id="6284" class="kp kq it np b gy ny nv l nw nx">status code: 400, request id: 123456-123456-123456-123456"</span></pre><p id="57b1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这时领事UI也给我们展示了匹配结果。只有一个保险舱被密封并处于<em class="ll">备用</em>模式。剩下的两个舱仍未密封，继续提供交通服务。Vault service仍在运行，对最终用户没有影响。</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi oq"><img src="../Images/05806cebff4cbf05183d435a9c59b5d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aqgk3qWhxy1FkYFUl4xkMQ.png"/></div></div></figure><p id="a772" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">剧透</strong>:一开始，我以为这是因为另外两个舱可以建立法定人数(2/3)并选出一个首领。然而，这不是真正的原因。我将在下一次测试中解释原因。</p><h2 id="1ec2" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">失败注射案例3: KMS下降+ EC2在2 AZs内下降</h2><p id="d764" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">让我们再杀死一个豆荚让它重新启动。不出所料，现在我们有2个<em class="ll">密封备用</em>保险库吊舱。然而，<strong class="js iu"> Vault service在这种严峻的形势下依然屹立不倒</strong>。这和动物园管理员这种基于法定人数的领袖选举制度不一样吧？让我们仔细看看下面的高可用性定义。</p><p id="0a48" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="ll">提示</em> </strong> <em class="ll">:这3个跳马模式名称指的是同一个概念，可以互换使用:</em> <strong class="js iu"> <em class="ll">主动、主、领导者。</em> </strong></p><blockquote class="li lj lk"><p id="bd45" class="jq jr ll js b jt ju jv jw jx jy jz ka lm kc kd ke ln kg kh ki lo kk kl km kn im bi translated">为了实现高可用性，<strong class="js iu">Vault服务器节点之一在数据存储中获取一个锁。成功的服务器节点随后成为活动节点</strong>；所有其他节点都成为备用节点。此时，如果备用节点收到请求，它们将根据集群的当前配置和状态转发请求或重定向客户端</p><p id="9e81" class="jq jr ll js b jt ju jv jw jx jy jz ka lm kc kd ke ln kg kh ki lo kk kl km kn im bi translated"><strong class="js iu">高可用性无法提高可扩展性。</strong>一般来说，Vault的瓶颈是数据存储本身，而不是Vault核心。例如:为了提高使用Consul的Vault的可伸缩性，通常应该扩展Consul而不是Vault。</p></blockquote><p id="99cd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从我们的测试结果来看，这个剩余的未密封的<em class="ll">跳马吊舱很快就取得了领导地位，并自己为交通服务。外部流量没有经历任何存储停机。这与上面的vault HA设计相匹配。👆</em></p><p id="a52a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="ll">简而言之，</em> </strong> <em class="ll"> </em> <strong class="js iu"> <em class="ll">金库集群不需要建立法定人数来选举领袖。无论哪个单元获得锁，都将成为活动/主单元。</em> </strong></p><h2 id="c8ec" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">故障注入:一个极端的例子</h2><p id="3c0e" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">在我们当前的单区域vault集群设置中，如下图所示，一个潜在的停止服务灾难场景可能是:</p><ul class=""><li id="fe46" class="mx my it js b jt ju jx jy kb mz kf na kj nb kn nc nd ne nf bi translated">AWS KMS下降了很长时间。</li><li id="90e3" class="mx my it js b jt ng jx nh kb ni kf nj kj nk kn nc nd ne nf bi translated">同时，我们失去了3个不同可用性区域中的所有3个保险存储箱。</li><li id="73bf" class="mx my it js b jt ng jx nh kb ni kf nj kj nk kn nc nd ne nf bi translated">同时，Consul群集(具有5个机架的HA)停止运行，从而阻止了Vault Service的运行。</li></ul><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div class="ab gu cl or"><img src="../Images/21810363dff0c835ad81ce282f02c525.png" data-original-src="https://miro.medium.com/v2/format:webp/0*qf4vV4sefK20a6pS.png"/></div></figure><p id="955f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如你所知，发生这种特定灾难场景的概率非常低。然而，意识到最坏的情况并有合理的预期总是让我们感觉更好。</p><h1 id="0b22" class="lp kq it bd kr lq lr ls ku lt lu lv kx lw lx ly la lz ma mb ld mc md me lg mf bi translated">全局扩展Vault</h1><p id="8337" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">到目前为止，我们已经构建了一个单区域HA Vault集群，它满足了我们对kubernetes友好、代码驱动和自我恢复的需求。为了更进一步，这里有一些选择。</p><p id="6388" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了使Vault Cluster HA可跨多个区域扩展，Hashircorp提供了一个开源工具<a class="ae ko" href="https://github.com/hashicorp/consul-replicate" rel="noopener ugc nofollow" target="_blank"> consul-replicate </a>，它提供了一个将值从一个区域复制到另一个区域的解决方案。目前，我正在基于此构建一个定制的多区域HA/DR自动化。希望这项工作能产生另一篇文章。</p><p id="8979" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">HashiCorp Vault Enterprise还通过提供两种复制模式解决了这些问题:性能(高级许可)和灾难恢复(专业许可)。如果有兴趣，你可以从<a class="ae ko" href="https://learn.hashicorp.com/vault/operations/ops-reference-architecture#deployment-topology-for-multiple-datacenters" rel="noopener ugc nofollow" target="_blank">这里</a>找到更多细节。</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi os"><img src="../Images/bc8f37ab1d1e49656b7ac6b66639aebb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jH5fQNdmsS0jtDI8.png"/></div></div></figure><p id="9b84" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">就是这样。我希望这是信息，可以帮助您了解保险库自动解封功能及其在故障期间的行为。</p><p id="7863" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我的下一篇文章中，我将分享我通过普罗米修斯使用<em class="ll">金库监控的经验，因为自我恢复设计总是在良好的监控堆栈下工作得更好。</em></p><h1 id="1061" class="lp kq it bd kr lq lr ls ku lt lu lv kx lw lx ly la lz ma mb ld mc md me lg mf bi translated">参考</h1><p id="a6df" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated"><a class="ae ko" href="https://www.devsecops.org/" rel="noopener ugc nofollow" target="_blank">https://www.devsecops.org/</a><br/><a class="ae ko" href="https://github.com/helm/charts/tree/master/incubator/vault" rel="noopener ugc nofollow" target="_blank">https://github.com/helm/charts/tree/master/incubator/vault</a><br/><a class="ae ko" href="https://learn.hashicorp.com/vault/operations/ops-autounseal-aws-kms" rel="noopener ugc nofollow" target="_blank">https://learn . hashi corp . com/vault/operations/ops-auto启封-AWS-kms</a><br/><a class="ae ko" href="https://www.hashicorp.com/resources/vault-1-0-how-to-auto-unseal-new-features" rel="noopener ugc nofollow" target="_blank">https://www . hashi corp . com/resources/vault-1-0-how-to-auto-启封-new-features</a><br/><a class="ae ko" href="https://www.vaultproject.io/docs/configuration/seal/awskms.html" rel="noopener ugc nofollow" target="_blank">https://www . vault project . io/docs/configuration/seal/AWS kms . html</a><br/></p></div></div>    
</body>
</html>