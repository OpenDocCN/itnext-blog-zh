<html>
<head>
<title>Performance programming in Flutter using Isolates — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用隔离物的颤振性能规划第一部分</h1>
<blockquote>原文：<a href="https://itnext.io/performance-programming-in-flutter-using-isolates-part-1-997a29011e88?source=collection_archive---------2-----------------------#2020-10-03">https://itnext.io/performance-programming-in-flutter-using-isolates-part-1-997a29011e88?source=collection_archive---------2-----------------------#2020-10-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/82370eeda08ec449d60f0a635489f9d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RFCxYDK1DGRaCWWZ-iQkIA.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><strong class="bd kc">性能</strong>应用在颤振中使用<strong class="bd kc">隔离</strong></figcaption></figure><p id="4af5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">众所周知，Flutter是一个单线程应用平台。那么</p><ul class=""><li id="73e8" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">多线程怎么做？</li><li id="e8c0" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">如何在一个线程中执行繁重的操作？</li><li id="2252" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">如何在不影响UI的情况下运行大操作？</li></ul><p id="18bb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是是的，所有这些都可以在分离株的帮助下实现。</p></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><h1 id="7f73" class="lw lx iq bd kc ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">看视频</h1><figure class="mt mu mv mw gt jr"><div class="bz fp l di"><div class="mx my l"/></div></figure><h1 id="d512" class="lw lx iq bd kc ly mz ma mb mc na me mf mg nb mi mj mk nc mm mn mo nd mq mr ms bi translated">什么是隔离？</h1><p id="c414" class="pw-post-body-paragraph kd ke iq kf b kg ne ki kj kk nf km kn ko ng kq kr ks nh ku kv kw ni ky kz la ij bi translated">隔离类似于UNIX中的线程，但有一点不同。<br/>像线程一样，隔离不共享内存。隔离借助消息进行通信。</p><p id="7171" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一个Flutter应用程序正在单个隔离区中运行。因此，如果我们在这个线程中运行繁重的操作，肯定会阻塞UI <br/>并破坏用户体验。在这种情况下，隔离物会有所帮助。</p><p id="4d78" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">使用隔离的两种方式</strong></p><ol class=""><li id="c537" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la nj lh li lj bi translated">使用隔离包中的“计算”功能(高级便捷功能)。</li><li id="fa8d" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la nj lh li lj bi translated">使用发送端口和接收端口进行消息传递(低级API)。</li></ol><p id="4ffc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">那么让我们开始… </strong></p><p id="bb5d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于这个例子，我将创建一个动画小部件，当我们在隔离中运行繁重的操作时，它在UI中运行。</p><p id="72a6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建一个名为“<strong class="kf ir"> AnimationWidget </strong>”的类。</p><p id="1c28" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将只制作这个小部件的边框动画。</p><p id="b151" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面是完整的<strong class="kf ir">动画小部件</strong>代码</p><pre class="mt mu mv mw gt nk nl nm nn aw no bi"><span id="7a68" class="np lx iq nl b gy nq nr l ns nt">class AnimationWidget extends StatefulWidget {<br/>  <a class="ae nu" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  AnimationWidgetState createState() {<br/>    return AnimationWidgetState();<br/>  }<br/>}<br/> <br/>class AnimationWidgetState extends State&lt;AnimationWidget&gt;<br/>    with TickerProviderStateMixin {<br/>  <br/>  AnimationController _animationController;<br/>  Animation&lt;BorderRadius&gt; _borderRadius;<br/> <br/>  <a class="ae nu" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  void initState() {<br/>    super.initState();<br/>    _animationController =<br/>        AnimationController(duration: const Duration(seconds: 1), vsync: this)<br/>          ..addStatusListener((status) {<br/>            if (status == AnimationStatus.completed) {<br/>              _animationController.reverse();<br/>            } else if (status == AnimationStatus.dismissed) {<br/>              _animationController.forward();<br/>            }<br/>          });<br/> <br/>    _borderRadius = BorderRadiusTween(<br/>      begin: BorderRadius.circular(100.0),<br/>      end: BorderRadius.circular(0.0),<br/>    ).animate(CurvedAnimation(<br/>      parent: _animationController,<br/>      curve: Curves.linear,<br/>    ));<br/> <br/>    _animationController.forward();<br/>  }<br/> <br/>  <a class="ae nu" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  Widget build(BuildContext context) {<br/>    return AnimatedBuilder(<br/>      animation: _borderRadius,<br/>      builder: (context, child) {<br/>        return Center(<br/>          child: Container(<br/>            child: FlutterLogo(<br/>              size: 200,<br/>            ),<br/>            alignment: Alignment.bottomCenter,<br/>            width: 350,<br/>            height: 200,<br/>            decoration: BoxDecoration(<br/>              gradient: LinearGradient(<br/>                begin: Alignment.topLeft,<br/>                colors: [Colors.blueAccent, Colors.redAccent],<br/>              ),<br/>              borderRadius: _borderRadius.value,<br/>            ),<br/>          ),<br/>        );<br/>      },<br/>    );<br/>  }<br/> <br/>  <a class="ae nu" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  void dispose() {<br/>    _animationController.dispose();<br/>    super.dispose();<br/>  }<br/>}</span></pre><p id="6143" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="nv"> BorderRadiusTween </em>用于动画显示小工具的边框。在这里，我们在动画完成时反转它，使它无限运行。</p><h1 id="fae7" class="lw lx iq bd kc ly mz ma mb mc na me mf mg nb mi mj mk nc mm mn mo nd mq mr ms bi translated">使用隔离物</h1><p id="d588" class="pw-post-body-paragraph kd ke iq kf b kg ne ki kj kk nf km kn ko ng kq kr ks nh ku kv kw ni ky kz la ij bi translated">宣告一个属于孤立者的未来。</p><p id="a2d1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe nw nx ny nl b">Future&lt;<strong class="kf ir">void</strong>&gt; computeFuture = Future.value();</code></p><p id="cbe3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将添加两个按钮，一个在主隔离线程上执行长时间运行的操作，另一个在单独的隔离线程中。</p><pre class="mt mu mv mw gt nk nl nm nn aw no bi"><span id="9b3e" class="np lx iq nl b gy nq nr l ns nt">addButton1() {<br/>    return FutureBuilder&lt;void&gt;(<br/>      future: computeFuture,<br/>      builder: (context, snapshot) {<br/>        return OutlineButton(<br/>          child: const Text('Main Isolate'),<br/>          onPressed: createMainIsolateCallback(context, snapshot),<br/>        );<br/>      },<br/>    );<br/>}<br/>addButton2() {<br/>    return FutureBuilder&lt;void&gt;(<br/>      future: computeFuture,<br/>      builder: (context, snapshot) {<br/>        return OutlineButton(<br/>          child: const Text('Secondary Isolate'),<br/>          onPressed: createSecondaryIsolateCallback(context, snapshot),<br/>        );<br/>      },<br/>    );<br/>}</span></pre><p id="6413" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">下面是回调函数。</strong></p><pre class="mt mu mv mw gt nk nl nm nn aw no bi"><span id="f7b6" class="np lx iq nl b gy nq nr l ns nt">VoidCallback createMainIsolateCallback(<br/>    BuildContext context, AsyncSnapshot snapshot) {<br/>  if (snapshot.connectionState == ConnectionState.done) {<br/>    return () {<br/>      setState(() {<br/>        computeFuture = computeOnMainIsolate().then((val) {<br/>          showSnackBar(context, 'Main Isolate Done $val');<br/>        });<br/>      });<br/>    };<br/>  } else {<br/>    return null;<br/>  }<br/>}<br/> <br/>VoidCallback createSecondaryIsolateCallback(<br/>    BuildContext context, AsyncSnapshot snapshot) {<br/>  if (snapshot.connectionState == ConnectionState.done) {<br/>    return () {<br/>      setState(() {<br/>        computeFuture = computeOnSecondaryIsolate().then((val) {<br/>          showSnackBar(context, 'Secondary Isolate Done $val');<br/>        });<br/>      });<br/>    };<br/>  } else {<br/>    return null;<br/>  }<br/>}<br/> <br/>Future&lt;int&gt; computeOnMainIsolate() async {<br/>  return await Future.delayed(Duration(milliseconds: 100), () =&gt; fib(40));<br/>}<br/> <br/>Future&lt;int&gt; computeOnSecondaryIsolate() async {<br/>  return await compute(fib, 40);<br/>}<br/> <br/>showSnackBar(context, message) {<br/>  Scaffold.of(context).showSnackBar(SnackBar(<br/>    content: Text(message),<br/>  ));<br/>}</span></pre><p id="8701" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用一个<strong class="kf ir">斐波那契</strong>函数来做一个长时间运行的操作。</p><pre class="mt mu mv mw gt nk nl nm nn aw no bi"><span id="f2df" class="np lx iq nl b gy nq nr l ns nt">int fib(int n) {<br/>  int number1 = n - 1;<br/>  int number2 = n - 2;<br/>  if (0 == n) {<br/>    return 0;<br/>  } else if (0 == n) {<br/>    return 1;<br/>  } else {<br/>    return (fib(number1) + fib(number2));<br/>  }<br/>}</span></pre><p id="17db" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">'<strong class="kf ir"><em class="nv">computeOnMainIsolate</em></strong>'函数将创建一个在主隔离线程上运行的延迟未来。<br/>‘<strong class="kf ir"><em class="nv">computeonsaryisolate</em></strong>’使用‘compute’函数创建一个新的隔离。新的隔离将接受函数和参数。</p><p id="a506" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们传入Fibonacci函数和参数。</p><p id="d1d0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，我们在SnackBar中显示结果。</p><p id="97b0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您运行应用程序并运行MainIsolate，您将看到它冻结动画和UI，直到它完成。但是如果我们运行二级隔离，我们会看到动画在运行的所有时间都运行得很流畅。这意味着，‘<em class="nv">compute</em>’正在生成一个新的隔离并在那里运行代码。因此，它不会影响主隔离的运行，用户界面将是平滑和响应。</p><p id="5ea6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="nv">观看完整的</em> <strong class="kf ir"> <em class="nv"> Youtube教程</em> </strong> <em class="nv">以上来看看它的行动。</em></p><p id="b455" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里是完整的例子。</p><pre class="mt mu mv mw gt nk nl nm nn aw no bi"><span id="2d15" class="np lx iq nl b gy nq nr l ns nt">import 'package:flutter/foundation.dart';<br/>import 'package:flutter/material.dart';<br/> <br/>class PerformancePage extends StatefulWidget {<br/>  <a class="ae nu" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  _PerformancePageState createState() =&gt; _PerformancePageState();<br/>}<br/> <br/>class _PerformancePageState extends State&lt;PerformancePage&gt; {<br/>  <br/>  Future&lt;void&gt; computeFuture = Future.value();<br/> <br/>  <a class="ae nu" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  Widget build(BuildContext context) {<br/>    return Scaffold(<br/>      appBar: AppBar(<br/>        title: Text('Performance using Isolate'),<br/>      ),<br/>      body: Container(<br/>        color: Colors.white,<br/>        child: Center(<br/>          child: Column(<br/>            mainAxisSize: MainAxisSize.min,<br/>            children: &lt;Widget&gt;[<br/>              AnimationWidget(),<br/>              addButton1(),<br/>              addButton2(),<br/>            ],<br/>          ),<br/>        ),<br/>      ),<br/>    );<br/>  }<br/> <br/>  addButton1() {<br/>    return FutureBuilder&lt;void&gt;(<br/>      future: computeFuture,<br/>      builder: (context, snapshot) {<br/>        return OutlineButton(<br/>          child: const Text('Main Isolate'),<br/>          onPressed: createMainIsolateCallback(context, snapshot),<br/>        );<br/>      },<br/>    );<br/>  }<br/> <br/>  addButton2() {<br/>    return FutureBuilder&lt;void&gt;(<br/>      future: computeFuture,<br/>      builder: (context, snapshot) {<br/>        return OutlineButton(<br/>          child: const Text('Secondary Isolate'),<br/>          onPressed: createSecondaryIsolateCallback(context, snapshot),<br/>        );<br/>      },<br/>    );<br/>  }<br/> <br/>  VoidCallback createMainIsolateCallback(<br/>      BuildContext context, AsyncSnapshot snapshot) {<br/>    if (snapshot.connectionState == ConnectionState.done) {<br/>      return () {<br/>        setState(() {<br/>          computeFuture = computeOnMainIsolate().then((val) {<br/>            showSnackBar(context, 'Main Isolate Done $val');<br/>          });<br/>        });<br/>      };<br/>    } else {<br/>      return null;<br/>    }<br/>  }<br/> <br/>  VoidCallback createSecondaryIsolateCallback(<br/>      BuildContext context, AsyncSnapshot snapshot) {<br/>    if (snapshot.connectionState == ConnectionState.done) {<br/>      return () {<br/>        setState(() {<br/>          computeFuture = computeOnSecondaryIsolate().then((val) {<br/>            showSnackBar(context, 'Secondary Isolate Done $val');<br/>          });<br/>        });<br/>      };<br/>    } else {<br/>      return null;<br/>    }<br/>  }<br/> <br/>  Future&lt;int&gt; computeOnMainIsolate() async {<br/>    return await Future.delayed(Duration(milliseconds: 100), () =&gt; fib(40));<br/>  }<br/> <br/>  Future&lt;int&gt; computeOnSecondaryIsolate() async {<br/>    return await compute(fib, 40);<br/>  }<br/> <br/>  showSnackBar(context, message) {<br/>    Scaffold.of(context).showSnackBar(SnackBar(<br/>      content: Text(message),<br/>    ));<br/>  }<br/>}<br/> <br/>int fib(int n) {<br/>  int number1 = n - 1;<br/>  int number2 = n - 2;<br/>  if (0 == n) {<br/>    return 0;<br/>  } else if (1 == n) {<br/>    return 1;<br/>  } else {<br/>    return (fib(number1) + fib(number2));<br/>  }<br/>}<br/> <br/>class AnimationWidget extends StatefulWidget {<br/>  <a class="ae nu" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  AnimationWidgetState createState() {<br/>    return AnimationWidgetState();<br/>  }<br/>}<br/> <br/>class AnimationWidgetState extends State&lt;AnimationWidget&gt;<br/>    with TickerProviderStateMixin {<br/>  //<br/>  AnimationController _animationController;<br/>  Animation&lt;BorderRadius&gt; _borderRadius;<br/> <br/>  <a class="ae nu" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  void initState() {<br/>    super.initState();<br/>    _animationController =<br/>        AnimationController(duration: const Duration(seconds: 1), vsync: this)<br/>          ..addStatusListener((status) {<br/>            if (status == AnimationStatus.completed) {<br/>              _animationController.reverse();<br/>            } else if (status == AnimationStatus.dismissed) {<br/>              _animationController.forward();<br/>            }<br/>          });<br/> <br/>    _borderRadius = BorderRadiusTween(<br/>      begin: BorderRadius.circular(100.0),<br/>      end: BorderRadius.circular(0.0),<br/>    ).animate(CurvedAnimation(<br/>      parent: _animationController,<br/>      curve: Curves.linear,<br/>    ));<br/> <br/>    _animationController.forward();<br/>  }<br/> <br/>  <a class="ae nu" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  Widget build(BuildContext context) {<br/>    return AnimatedBuilder(<br/>      animation: _borderRadius,<br/>      builder: (context, child) {<br/>        return Center(<br/>          child: Container(<br/>            child: FlutterLogo(<br/>              size: 200,<br/>            ),<br/>            alignment: Alignment.bottomCenter,<br/>            width: 350,<br/>            height: 200,<br/>            decoration: BoxDecoration(<br/>              gradient: LinearGradient(<br/>                begin: Alignment.topLeft,<br/>                colors: [Colors.blueAccent, Colors.redAccent],<br/>              ),<br/>              borderRadius: _borderRadius.value,<br/>            ),<br/>          ),<br/>        );<br/>      },<br/>    );<br/>  }<br/> <br/>  <a class="ae nu" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  void dispose() {<br/>    _animationController.dispose();<br/>    super.dispose();<br/>  }<br/>}</span></pre><p id="557c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意:隔离只接受静态函数或者方法不应该是类实例的一部分。</p><p id="712a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> <em class="nv">下一部即将到来…敬请期待… </em> </strong></p><p id="c330" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="nv">感谢阅读，如果你觉得我的帖子有用，请在下面留下你的宝贵意见，订阅我的</em> <a class="ae nu" href="https://www.youtube.com/channel/UC5lbdURzjB0irr-FTbjWN1A" rel="noopener ugc nofollow" target="_blank"> <em class="nv"> youtube频道</em> </a> <em class="nv">获取更多视频。</em></p></div></div>    
</body>
</html>