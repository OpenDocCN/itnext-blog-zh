<html>
<head>
<title>Ansible and Jenkins — automate your scritps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ansible和Jenkins —自动化您的脚本</h1>
<blockquote>原文：<a href="https://itnext.io/ansible-and-jenkins-automate-your-scritps-8dff99ef653?source=collection_archive---------1-----------------------#2019-04-27">https://itnext.io/ansible-and-jenkins-automate-your-scritps-8dff99ef653?source=collection_archive---------1-----------------------#2019-04-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/db13836938644bf20e34bfe0c53b994a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/1*_i41wKL-w9E4htidWZJ4fQ.png"/></div></figure><p id="b887" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我想在这篇文章中揭示的主题似乎是显而易见的，但我很惊讶有多少公司没有遵循这一最佳实践。</p><p id="b417" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">因为不耐烦:</p><ul class=""><li id="3f9b" class="kv kw it jz b ka kb ke kf ki kx km ky kq kz ku la lb lc ld bi translated">将你做过不止一次的每一个动作自动化。</li><li id="3009" class="kv kw it jz b ka le ke lf ki lg km lh kq li ku la lb lc ld bi translated">不要使用Jenkins静态groovy库。</li><li id="9956" class="kv kw it jz b ka le ke lf ki lg km lh kq li ku la lb lc ld bi translated">使用Jenkins + Ansible + Python实现自动化。</li></ul><h2 id="184f" class="lj lk it bd ll lm ln dn lo lp lq dp lr ki ls lt lu km lv lw lx kq ly lz ma mb bi translated">问题是</h2><p id="e337" class="pw-post-body-paragraph jx jy it jz b ka mc kc kd ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku im bi translated">任何开发人员在工作中总会面临这样的情况:某个动作需要重复。有时这些行动很紧急，需要很快完成。例如，您的生产停止，您需要在数据库上重建索引，或者在仪表板上重新填充图像，或者在您的分布式后端重新选举新的领导者。</p><p id="3a85" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">记住这三条黄金法则是有好处的，它们能让你的生活更轻松:</p><ul class=""><li id="63a0" class="kv kw it jz b ka kb ke kf ki kx km ky kq kz ku la lb lc ld bi translated">如果你重复一个动作超过两次，它应该是自动的。</li><li id="d570" class="kv kw it jz b ka le ke lf ki lg km lh kq li ku la lb lc ld bi translated">如果有几个步骤要完成，它们应该放在一个脚本中。</li><li id="f8fd" class="kv kw it jz b ka le ke lf ki lg km lh kq li ku la lb lc ld bi translated">当在运行这些操作之前有一些复杂的设置时，一切都应该记录下来。</li></ul><p id="bfa1" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">遵循这些规则会减少你通常花在救火上的时间。从商业前景来看，在这种自动化上花费时间似乎是不必要的，但在现实生活中，您可以腾出时间来开发新功能，并减少修复问题所需的时间。</p><p id="755d" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">另一个问题是总线因素。当您手动操作时，总会有人知道关键和独特的信息。如果这个人(去世)离开你的公司，你将无法快速解决问题，因为知识将会丢失。带有动作的文档脚本是你的朋友。</p><h2 id="1843" class="lj lk it bd ll lm ln dn lo lp lq dp lr ki ls lt lu km lv lw lx kq ly lz ma mb bi translated">自定义脚本</h2><p id="de5c" class="pw-post-body-paragraph jx jy it jz b ka mc kc kd ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku im bi translated">在某种程度上，所有的开发人员都会遵循上面提到的规则。他们开始通过创建脚本来自动化他们的操作。这很好，但这里隐藏着危险——这样的脚本通常用不同的编程语言编写，并存储在许多存储库中。</p><p id="8e0f" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">维持这样一个动物园是很难的。有时甚至很难找到解决特定问题的脚本。也许有些脚本甚至会重新实现几次。做好准备。</p><p id="af0e" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">另一个问题是环境。这样的脚本对其创建者的环境是友好的。现在假设你发现了一个旧的脚本，它是用你系统中没有安装的语言编写的。您应该如何快速运行它并解决问题？</p><h2 id="9817" class="lj lk it bd ll lm ln dn lo lp lq dp lr ki ls lt lu km lv lw lx kq ly lz ma mb bi translated">詹金斯共享图书馆</h2><p id="a0c9" class="pw-post-body-paragraph jx jy it jz b ka mc kc kd ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku im bi translated">这里的一个解决方案是让詹金斯解决你的问题。您有带脚本的groovy共享库，它可以修复您需要的问题。还有詹金斯·乔布斯，每一个都是你需要解决的问题。一个存储库中的所有内容。</p><p id="b79d" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">方法是好的，但不是实现。</p><p id="5fb4" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">开发这样的脚本真的很难。我在这方面遇到了很多问题，因为无法保证你在本地测试过的代码能在Jenkins上运行。主要原因在于不同的Groovy版本。</p><h2 id="f0e8" class="lj lk it bd ll lm ln dn lo lp lq dp lr ki ls lt lu km lv lw lx kq ly lz ma mb bi translated">Python脚本</h2><p id="7387" class="pw-post-body-paragraph jx jy it jz b ka mc kc kd ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku im bi translated">要解决版本问题，可以使用Python+<a class="ae mh" href="https://conda.io" rel="noopener ugc nofollow" target="_blank">Conda</a>/<a class="ae mh" href="https://docs.python.org/3/library/venv.html" rel="noopener ugc nofollow" target="_blank">venv</a>。Python本身非常适合编写脚本，并且非常普及。与Groovy相比，你的团队中更有可能有人了解Python。</p><p id="b19a" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在Conda的帮助下，你可以在任何地方使用相同的Python版本。</p><p id="8cab" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我也强烈推荐Python的<a class="ae mh" href="http://docopt.org/" rel="noopener ugc nofollow" target="_blank"> docopt </a>。你还记得自动化的第三条规则吗？当你的文档和代码放在一起时会更好，因为这降低了维护的难度。</p><p id="a7a1" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">脚本中的注释并不总是能够向您解释为什么以及如何运行该脚本，以及参数值是什么。docopt将为您处理参数和缺省值，并在提供的每个错误参数上打印帮助消息，或者只是根据需要打印。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="3624" class="lj lk it mn b gy mr ms l mt mu">#!/usr/bin/env python <br/>""" <br/>Very important script. It should be run when our prod freezes for some seconds. It will get all missed transactions, ask for confirmation and process results. </span><span id="24b5" class="lj lk it mn b gy mv ms l mt mu">Usage: <br/>    transaction.py --issuer=&lt;i&gt; --bank=&lt;b&gt; [--slack=&lt;s&gt;] <br/>    transaction.py -h | --help <br/>Options: <br/>-h --help     show this help message and exit <br/>--issuer=&lt;i&gt;  Which issuer to use for transaction confirmation.[default: primary] <br/>--bank=&lt;b&gt;    Which bank's backend to use. --slack=&lt;s&gt; slack callback to notify <br/>"""</span></pre><h2 id="a92a" class="lj lk it bd ll lm ln dn lo lp lq dp lr ki ls lt lu km lv lw lx kq ly lz ma mb bi translated">Ansible + Python</h2><p id="ef73" class="pw-post-body-paragraph jx jy it jz b ka mc kc kd ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku im bi translated">经过前一阶段，你有自我记录的独立于版本的脚本。一个开发者的梦想。有哪些可以改进的地方？</p><p id="2a7d" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">首先，它们仍然与python的依赖性有点耦合。如果你打算将这些python脚本作为公司的标准，你必须强迫每个人安装conda，以便能够运行这些脚本。</p><p id="6af4" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">第二，您仍然需要一个中央存储空间来存储这些脚本。真理的唯一来源，在那里可以找到任何问题的理想解决方案。</p><p id="2f94" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">为了解决这两个问题，你需要使用<a class="ae mh" href="https://www.ansible.com/" rel="noopener ugc nofollow" target="_blank"> Ansible </a>并为它的脚本建立一个单一的存储库(在大公司，你应该更喜欢每个部门的存储库)。</p><p id="a59e" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">每一个可以用脚本解决的问题都变成了角色。每个角色都有自己的自述文件，其中描述了问题和解决方案。Root的自述文件指向每个角色的自述文件，并附有它所解决的一个问题的小注释。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="2c34" class="lj lk it mn b gy mr ms l mt mu">## Problem <br/>Sometimes we have a pikes of a high load. During this load our slaves can loose master and some transactions won't be processed. <br/>## Solution <br/>Such missed transactions are saved by slaves in a special queue. This role gets these transactions, asks bank's confirmation for each and processes the results. <br/>## Run <br/>ansible-playbook resolve_transactions.yaml -i inventory/prod/hosts.ini -extra-vars "-i='primary' -b='my_bank'"</span></pre><p id="2186" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">它不会取代Python脚本，因为普通的ansible脚本更难调试和开发。取而代之的是，所有python脚本都进入角色内部的文件或模板中，并作为该剧的一部分被调用。</p><p id="a376" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">最小的场景通常包含conda创建和deps安装，以及运行脚本本身(为简单起见，该角色假设conda已安装)。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="422a" class="lj lk it mn b gy mr ms l mt mu">--- <br/>- block: <br/>    - name: "Copy requirements.txt" <br/>      copy: <br/>        src: "requirements.txt" <br/>        dest: "/tmp/{{ role_name }}/" <br/>    - name: "Copy python executable" <br/>      template: <br/>        src: "transaction.py.j2" <br/>        dest: "/tmp/{{ role_name }}/transaction.py" <br/>    - name: "Create Conda Env for {{ python_version }}" <br/>      shell: "conda create -p /tmp/{{ role_name }}/{{ conda_env }} --copy -y python={{ python_version }}" <br/>    - name: "Run my script" <br/>      shell: "source activate /tmp/{{ role_name }}/{{ conda_env }} &amp;&amp; {{ item }}" <br/>      with_items: <br/>        - pip install -r /tmp/{{ role_name }}/requirements.txt <br/>        - "python /tmp/{{ role_name }}/transaction.py --issuer={{ issuer }} --bank={{ bank }} --slack={{ slack }}" <br/>      args: <br/>        executable: /bin/bash <br/>  always: <br/>     - name: "Clean up" <br/>       file: <br/>         state: absent <br/>         path: "/tmp/{{ role_name }}/"</span></pre><p id="10b5" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在这里，您可以从可变系统中获益:</p><p id="dc1a" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">每个环境都存储组变量和全局变量，它们是所有变量的符号链接。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/c58bf28ad0618884af9da156794c0b89.png" data-original-src="https://miro.medium.com/v2/resize:fit:354/format:webp/0*dqS3znab4Cem6_Ui.png"/></div></figure><p id="a0eb" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">每个角色也可以有自己特定的<code class="fe mx my mz mn b">default</code>变量，这些变量被脚本的ansible输入覆盖。</p><p id="4df5" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">现在，您可以将一线支持转移到另一个部门，只需将他们指向一个包含完整文档和脚本的存储库。他们只需要知道如何运行ansible。</p><h2 id="8c50" class="lj lk it bd ll lm ln dn lo lp lq dp lr ki ls lt lu km lv lw lx kq ly lz ma mb bi translated">Jenkins + Ansible + Python</h2><p id="4a4d" class="pw-post-body-paragraph jx jy it jz b ka mc kc kd ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku im bi translated">一线支持的问题是，他们通常比一般的开发人员更便宜，资格更差。他们也可能运行Windows，不知道Ansible是什么。对他们来说，理想的解决方案是提供一个带有类似“如果你怀疑这个问题—按下那个按钮”的规则的文档。你可以在詹金斯的帮助下完成。首先确保你已经安装了一个可翻译的<a class="ae mh" href="https://wiki.jenkins.io/display/JENKINS/Ansible+Plugin" rel="noopener ugc nofollow" target="_blank">插件</a>。</p><p id="346d" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">第二步—为ssh的使用创建凭证。</p><p id="f4ce" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">第三，为您希望为其创建按钮的每个角色编写一个管道。您可以将它放在Readme前面的角色根目录中，并使存储库根目录的Jenkins管道扫描角色/中的所有管道，并在必要时创建子Jenkins管道。</p><p id="b806" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">典型的管道会有输入参数:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="3dde" class="lj lk it mn b gy mr ms l mt mu">parameters { <br/>    choice(choices: ['dev','prod', 'stage'], description: 'On which Environment should I run this script?', name: 'environment') <br/>}</span></pre><p id="c261" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">第一步应该是用ansible克隆您的repo:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="e077" class="lj lk it mn b gy mr ms l mt mu">stage(Clone Git repository') {<br/>  steps {<br/>    git branch: 'master', <br/>    credentialsId: &lt;some-uuid&gt;', <br/>    url: "${env.PROJECT_REPO}" <br/>  } <br/>}</span></pre><p id="a12d" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">称之为“可行剧本”:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="e1d7" class="lj lk it mn b gy mr ms l mt mu">stage('Run ansible script') {<br/>  steps { <br/>    script { <br/>       if (params.environment == 'prod') {<br/>         env.INVENTORY = "inventories/prod/hosts.ini" <br/>         env.ISSUER = "primary" <br/>       } else if(params.environment == 'dev') {<br/>         env.INVENTORY = "inventories/dev/hosts.ini"<br/>         env.ISSUER = "secondary" <br/>       } else if(params.environment == 'stage') {<br/>         env.INVENTORY = "inventories/stage/hosts.ini" <br/>         env.ISSUER = "secondary" <br/>       } else { <br/>         throw new Exception("Unknown environment: ${params.environment}") <br/>       }<br/>    } <br/>    ansiblePlaybook( <br/>            playbook: "${env.PLAYBOOK_ROOT}/deploy_service.yaml", <br/>            inventory: "${env.PLAYBOOK_ROOT}/${env.INVENTORY}",   <br/>            credentialsId: '&lt;your-credentials-id&gt;', <br/>            extras: '-e "i=' + "${ env.ISSUER }" + ' b='my_bank"+ '" -v') <br/>  }<br/>}</span></pre><p id="3be0" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">创建Jenkins职务后，您只需将它们链接到每个角色的自述文件，以及任何相关项目的自述文件。</p><h2 id="16d6" class="lj lk it bd ll lm ln dn lo lp lq dp lr ki ls lt lu km lv lw lx kq ly lz ma mb bi translated">总结</h2><ul class=""><li id="42d4" class="kv kw it jz b ka mc ke md ki na km nb kq nc ku la lb lc ld bi translated">自动化脚本允许您更快地修复问题，但它们也需要一些努力来使它们易于使用和独立于平台。</li><li id="54e2" class="kv kw it jz b ka le ke lf ki lg km lh kq li ku la lb lc ld bi translated">自我记录的脚本允许您减少新员工的总线因素和入职时间。</li><li id="18d5" class="kv kw it jz b ka le ke lf ki lg km lh kq li ku la lb lc ld bi translated">带有标准化工具的集中存储库允许您在将来将责任快速移交给另一个团队。</li><li id="1415" class="kv kw it jz b ka le ke lf ki lg km lh kq li ku la lb lc ld bi translated">Ansible + Jenkins允许您在Jenkins停机时，通过按下一个Jenkins按钮(即使您正在度假，并且只带着手机)或运行Ansible脚本来解决问题。</li><li id="d712" class="kv kw it jz b ka le ke lf ki lg km lh kq li ku la lb lc ld bi translated">Jenkins Buttons允许您降低资格要求和一线支持的价格。</li></ul><p id="0f9e" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">祝救火愉快！🙂</p></div></div>    
</body>
</html>