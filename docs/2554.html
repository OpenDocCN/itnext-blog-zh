<html>
<head>
<title>Kubernetes Workers Autoscaling based on RabbitMQ queue size</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes Workers基于RabbitMQ队列大小进行自动伸缩</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-workers-autoscaling-based-on-rabbitmq-queue-size-cb0803193cdf?source=collection_archive---------1-----------------------#2019-06-14">https://itnext.io/kubernetes-workers-autoscaling-based-on-rabbitmq-queue-size-cb0803193cdf?source=collection_archive---------1-----------------------#2019-06-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="9633" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kubernetes <strong class="jp ir">卧式自动秤</strong> ( <strong class="jp ir"> HPA </strong>)绝对能帮你省下一大笔钱。基于CPU利用率的HPA基本设置您可以轻松启动，但如果您希望基于外部服务或外部指标进行扩展，该怎么办呢？本文将帮助您正确设置它，并根据GKE环境的实际需要进行扩展。以下设置在kubernetes 1.10中运行良好，但在低于1.12的版本中，公制标签可能会有一些问题</p><h1 id="f546" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">1.部署<strong class="ak">定制度量堆栈驱动</strong>适配器</h1><pre class="lj lk ll lm gt ln lo lp lq aw lr bi"><span id="a1d7" class="ls km iq lo b gy lt lu l lv lw">kubectl create clusterrolebinding cluster-admin-binding --clusterrole cluster-admin --user "$(gcloud config get-value account)"</span><span id="43f1" class="ls km iq lo b gy lx lu l lv lw">kubectl create -f https://raw.githubusercontent.com/GoogleCloudPlatform/k8s-stackdriver/master/custom-metrics-stackdriver-adapter/deploy/production/adapter.yaml</span></pre><h1 id="29fb" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">2.普罗米修斯和斯塔克德瑞出口商</h1><p id="12a9" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">现在我们需要使用<a class="ae md" href="https://github.com/kbudde/rabbitmq_exporter" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">kbudde/RabbitMQ-exporter</strong></a>容器来部署rabbitmq指标导出器，它将使用prometheus和<a class="ae md" href="gcr.io/google-containers/prometheus-to-sd:v0.2.3" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">prometheus-to-SD</strong></a>来提供rabbit MQ指标，这两个工具会自动将Prometheus指标导出到stackdriver指标。我们可以将两者合并到一个部署中:</p><pre class="lj lk ll lm gt ln lo lp lq aw lr bi"><span id="4b3d" class="ls km iq lo b gy lt lu l lv lw"><strong class="lo ir">apiVersion</strong>: extensions/v1beta1<br/><strong class="lo ir">kind</strong>: Deployment<br/><strong class="lo ir">metadata</strong>:<br/>  <strong class="lo ir">name</strong>: amqp-metrics<br/><strong class="lo ir">spec</strong>:<br/>  <strong class="lo ir">replicas</strong>: 1<br/>  <strong class="lo ir">template</strong>:<br/>    <strong class="lo ir">metadata</strong>:<br/>      <strong class="lo ir">labels</strong>:<br/>        <strong class="lo ir">app</strong>: amqp-metrics<br/>    <strong class="lo ir">spec</strong>:<br/>      <strong class="lo ir">containers</strong>:<br/>      - <strong class="lo ir">name</strong>: prometheus<br/>        <strong class="lo ir">image</strong>: kbudde/rabbitmq-exporter:v0.29.0<br/>        <strong class="lo ir">env</strong>:<br/>        - <strong class="lo ir">name</strong>: RABBIT_URL<br/>          <strong class="lo ir">value</strong>: http://SOMERABBITMQHOST:15672<br/>        - <strong class="lo ir">name</strong>: RABBIT_USER<br/>          <strong class="lo ir">value</strong>: SOMEUSERNAME<br/>        - <strong class="lo ir">name</strong>: RABBIT_PASSWORD<br/>          <strong class="lo ir">value</strong>: SOMEPASSWORD<br/>        - <strong class="lo ir">name</strong>: PUBLISH_PORT<br/>          <strong class="lo ir">value</strong>: <strong class="lo ir">"9419"</strong><br/>        <em class="me"># amqp 3.6.9++<br/>        </em>- <strong class="lo ir">name</strong>: RABBIT_CAPABILITIES<br/>          <strong class="lo ir">value</strong>: <strong class="lo ir">"bert,no_sort"<br/>        resources</strong>:<br/>          <strong class="lo ir">requests</strong>:<br/>            <strong class="lo ir">cpu</strong>: 100m<br/>            <strong class="lo ir">memory</strong>: 100Mi<br/>      - <strong class="lo ir">name</strong>: prometheus-to-sd<br/>        <strong class="lo ir">image</strong>: gcr.io/google-containers/prometheus-to-sd:v0.2.3<br/>        <strong class="lo ir">command</strong>:<br/>        - /monitor<br/>        - --source=:http://localhost:9419<br/>        - --stackdriver-prefix=custom.googleapis.com<br/>        - --pod-id=$(POD_ID)<br/>        - --namespace-id=$(POD_NAMESPACE)<br/>        <strong class="lo ir">env</strong>:<br/>        - <strong class="lo ir">name</strong>: POD_ID<br/>          <strong class="lo ir">valueFrom</strong>:<br/>            <strong class="lo ir">fieldRef</strong>:<br/>              <strong class="lo ir">apiVersion</strong>: v1<br/>              <strong class="lo ir">fieldPath</strong>: metadata.uid<br/>        - <strong class="lo ir">name</strong>: POD_NAMESPACE<br/>          <strong class="lo ir">valueFrom</strong>:<br/>            <strong class="lo ir">fieldRef</strong>:<br/>              <strong class="lo ir">fieldPath</strong>: metadata.namespace<br/>        <strong class="lo ir">resources</strong>:<br/>          <strong class="lo ir">requests</strong>:<br/>            <strong class="lo ir">cpu</strong>: 100m<br/>            <strong class="lo ir">memory</strong>: 100Mi</span></pre><h1 id="e9ba" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">3.验证导出的指标并部署HPA</h1><p id="eab7" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">最后，我们能够在<a class="ae md" href="https://app.google.stackdriver.com/metrics-explorer" rel="noopener ugc nofollow" target="_blank">Google stack driver metrics explorer</a>中看到我们的指标</p><figure class="lj lk ll lm gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi mf"><img src="../Images/ea47e2cf1a0bc54b9f982fe81ed37ee6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HJdZ9MKgpjI45UyX5drd1A.png"/></div></div></figure><p id="cdb3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们准备使用导出的指标设置自动缩放器:</p><pre class="lj lk ll lm gt ln lo lp lq aw lr bi"><span id="3cb1" class="ls km iq lo b gy lt lu l lv lw"><strong class="lo ir">apiVersion</strong>: autoscaling/v2beta1<br/><strong class="lo ir">kind</strong>: HorizontalPodAutoscaler<br/><strong class="lo ir">metadata</strong>:<br/>  <strong class="lo ir">name</strong>: workers-hpa<br/><strong class="lo ir">spec</strong>:<br/>  <strong class="lo ir">scaleTargetRef</strong>:<br/>    <strong class="lo ir">apiVersion</strong>: apps/v1beta1<br/>    <strong class="lo ir">kind</strong>: Deployment<br/>    <strong class="lo ir">name</strong>: my-workers<br/>  <strong class="lo ir">minReplicas</strong>: 1<br/>  <strong class="lo ir">maxReplicas</strong>: 10<br/>  <strong class="lo ir">metrics</strong>:<br/>  - <strong class="lo ir">type</strong>: External<br/>    <strong class="lo ir">external</strong>:<br/>      <strong class="lo ir">metricName</strong>: <strong class="lo ir">"custom.googleapis.com|rabbitmq_queue_messages_ready"<br/>      metricSelector</strong>:<br/>        <strong class="lo ir">matchLabels</strong>:<br/>          <strong class="lo ir">metric.labels.queue</strong>: myqueue<br/>      <strong class="lo ir">targetValue</strong>: 20</span></pre><p id="4fd9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以在这里找到RabbitMQ的所有可用指标<a class="ae md" href="https://github.com/kbudde/rabbitmq_exporter" rel="noopener ugc nofollow" target="_blank">https://github.com/kbudde/rabbitmq_exporter,</a>您也可以使用以下标签作为过滤器:集群、vhost、队列、持久性、策略、自我(在1.10和1.11的部分版本中可能无法正常工作)</p><p id="53c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，如果RabbitMQ queue <em class="me"> myqueue </em>总共有超过20个未处理的作业，我们的部署<em class="me"> my-workers </em>将会增加</p><p id="58ba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<strong class="jp ir"> metricSelector </strong>您可以为不同的队列和工作部署创建不同的自动缩放器</p><h1 id="ad3f" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">4.验证HPA和部署</h1><p id="92d7" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">为了验证我们的HPA，我们可以使用<strong class="jp ir"> kubectl describe hpa </strong>命令</p><pre class="lj lk ll lm gt ln lo lp lq aw lr bi"><span id="eb38" class="ls km iq lo b gy lt lu l lv lw">kubectl describe hpa workers-hpa<br/>Name:                                                                    workers-hpa<br/>Namespace:                                                               default<br/>Labels:                                                                  &lt;none&gt;<br/>Annotations:                                                             kubectl.kubernetes.io/last-applied-configuration:<br/>                                                                           {"apiVersion":"autoscaling/v2beta1","kind":"HorizontalPodAutoscaler","metadata":{"annotations":{},"name":"workers-hpa","namespace":"defaul...<br/>CreationTimestamp:                                                       Thu, 20 Dec 2018 12:20:26 -0500<br/>Reference:                                                               Deployment/my-workers<br/>Metrics:                                                                 ( current / target )<br/>  "custom.googleapis.com|rabbitmq_queue_messages_ready" (target value):  0 / 20<br/>Min replicas:                                                            1<br/>Max replicas:                                                            10<br/>Deployment pods:                                                         1 current / 1 desired<br/>Conditions:<br/>  Type            Status  Reason               Message<br/>  ----            ------  ------               -------<br/>  AbleToScale     True    ScaleDownStabilized  recent recommendations were higher than current one, applying the highest recent recommendation<br/>  ScalingActive   True    ValidMetricFound     the HPA was able to successfully calculate a replica count from external metric custom.googleapis.com|rabbitmq_queue_messages_ready(&amp;LabelSelector{MatchLabels:map[string]string{metric.labels.queue: viral_marketing,resource.labels.cluster_name: apps-cloud,},MatchExpressions:[],})<br/>  ScalingLimited  False   DesiredWithinRange   the desired count is within the acceptable range</span></pre><h1 id="3dc5" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">结论</h1><p id="7ba5" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">外部指标开辟了一条将集群和应用效率提升到新水平的途径。尝试用其他指标进行实验，或者制定自己的指标。感谢您的阅读</p></div></div>    
</body>
</html>