<html>
<head>
<title>Advanced NestJS techniques — Part 2 — Logging outgoing HTTP requests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">高级NestJS技术—第2部分—记录传出的HTTP请求</h1>
<blockquote>原文：<a href="https://itnext.io/advanced-nestjs-techniques-part-2-logging-outgoing-http-requests-3c75d47c5768?source=collection_archive---------1-----------------------#2020-07-18">https://itnext.io/advanced-nestjs-techniques-part-2-logging-outgoing-http-requests-3c75d47c5768?source=collection_archive---------1-----------------------#2020-07-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="614f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在微服务架构中，您的NestJS后端很可能通过HTTP联系其他微服务或API。如果您想更深入地了解这些请求需要多长时间，请继续跟进。</p></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><p id="e43c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">NestJS提供了一个非常方便的HttpService，由来自“@nestjs/common”的HttpModule公开来执行HTTP请求。这项服务由Axios提供支持，Axios是目前Nodejs / browser世界中最流行的HTTP客户端。</p><p id="ae29" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Axios最强大的特性之一是可以定义请求和响应拦截器。</p><h1 id="0411" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">履行</h1><p id="19c6" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">关于如何用Axios记录响应时间，有很多例子，我们在这里就不再重复了。我们将重点介绍一种将它与NestJS集成的方法。</p><p id="6d65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们希望:</p><ul class=""><li id="29ed" class="lw lx iq jp b jq jr ju jv jy ly kc lz kg ma kk mb mc md me bi translated">抓取<strong class="jp ir">现有的HttpService </strong></li><li id="9367" class="lw lx iq jp b jq mf ju mg jy mh kc mi kg mj kk mb mc md me bi translated">访问底层的<strong class="jp ir"> Axios实例</strong></li><li id="371b" class="lw lx iq jp b jq mf ju mg jy mh kc mi kg mj kk mb mc md me bi translated">添加我们的日志拦截器</li><li id="5eec" class="lw lx iq jp b jq mf ju mg jy mh kc mi kg mj kk mb mc md me bi translated"><strong class="jp ir">将HttpService </strong>重新导出到应用程序的其余部分</li></ul><figure class="mk ml mm mn gt mo"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="d0ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">代码本身就说明了问题，但这里有一些附加注释:</p><ul class=""><li id="7e38" class="lw lx iq jp b jq jr ju jv jy ly kc lz kg ma kk mb mc md me bi translated">我不能100%肯定“onModuleInit”是放置注册拦截器的代码的最佳位置，但它在那里可能是无害的。</li><li id="cd14" class="lw lx iq jp b jq mf ju mg jy mh kc mi kg mj kk mb mc md me bi translated">只要至少AppModule导入了HttpModule，那么我们的其他模块是从NestJS导入HttpModule还是从我们的模块导入HttpModule就无关紧要了，因为我们的http module重新导出了来自NestJS的模块，并且HttpService singleton已经被修改了。</li><li id="d6c6" class="lw lx iq jp b jq mf ju mg jy mh kc mi kg mj kk mb mc md me bi translated">我希望我们可以将AXIOS实例本身注入到HttpModule构造函数(而不是HttpService)中，但不幸的是，即使AXIOS_INSTANCE_TOKEN注入令牌看起来是导出的，Axios实例却不是。</li></ul><p id="0a87" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，如果您使用/foo，您应该会看到一行漂亮的日志，如下所示:</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi mr"><img src="../Images/d324eb8c571558353b0c05f976831f81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FzdES1DmEY07VOMYYqrAzw.png"/></div></div></figure><p id="b2a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在这里找到完整的代码:<a class="ae ks" href="https://github.com/paztek/nestjs-http-service-example" rel="noopener ugc nofollow" target="_blank">https://github.com/paztek/nestjs-http-service-example</a></p></div></div>    
</body>
</html>