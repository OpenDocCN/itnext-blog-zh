<html>
<head>
<title>End-to-End Monitoring with Grafana Cloud with Minimal Effort</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">借助Grafana Cloud轻松实现端到端监控</h1>
<blockquote>原文：<a href="https://itnext.io/end-to-end-monitoring-with-grafana-cloud-with-minimal-effort-a3052d402149?source=collection_archive---------2-----------------------#2022-05-02">https://itnext.io/end-to-end-monitoring-with-grafana-cloud-with-minimal-effort-a3052d402149?source=collection_archive---------2-----------------------#2022-05-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e8ad" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Grafana Cloud提供完整的监控设置，包括指标、综合数据、日志、警报、跟踪等，全部免费</h2></div><p id="e143" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在构建应用程序时，监控通常在清单的最后，但它对于确保应用程序平稳运行以及快速发现和解决任何问题至关重要。</p><p id="a552" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">构建完整的监控—包括聚合日志记录、指标、跟踪、警报或综合探测—需要大量的精力和时间，更不用说构建和管理所需的基础架构了。因此，在本文中，我们将探讨如何使用Grafana Cloud快速、轻松地设置所有这一切，并且不需要任何基础设施，全部免费。</p><h1 id="6da7" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">基础设施提供商</h1><p id="0f40" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">中小型项目不保证建立完整的监控基础设施，因此托管解决方案是一个不错的选择。同时，没有人愿意花大价钱只为了让几个微服务活下去。</p><p id="6003" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是，有几个带有免费层的托管监控解决方案可以提供您可能需要的所有东西。</p><p id="aabd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先是<em class="mb"> Datadog </em>，它提供免费的<a class="ae mc" href="https://www.datadoghq.com/pricing/?product=infrastructure#infrastructure" rel="noopener ugc nofollow" target="_blank">基础设施监控</a>，这不会让我们走得太远，尤其是考虑到不包括警报</p><p id="c012" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">更好的选择是<em class="mb">新遗迹</em>，它有一个<a class="ae mc" href="https://newrelic.com/pricing" rel="noopener ugc nofollow" target="_blank">免费计划</a>，可能包括你可能需要的一切。一个缺点是New Relic使用了一套专有工具，这造成了供应商锁定，并使其难以迁移到另一个平台或拥有基础设施。</p><p id="49dc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第三，在我看来，这里最好的选择是<em class="mb"> Grafana Cloud </em>，它有一个相当慷慨的<a class="ae mc" href="https://grafana.com/pricing/" rel="noopener ugc nofollow" target="_blank">免费计划</a>，包括使用一套流行的开源工具(如Prometheus、Alertmanager、Loki和Tempo)进行日志记录、度量、警报和综合监控。这是我能找到的最好的免费平台，我们将用它来设置我们的监控。</p><p id="8fce" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了完整起见，我也看了Dynatrace、Instana、Splunk、Sumo Logic和AWS Managed Prometheus，那些都没有免费计划。</p><p id="af1a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正如我提到的，我只考虑免费选项。如果你需要在你的基础设施上运行一个监控栈，我强烈推荐使用<em class="mb">“普罗米修斯和朋友”</em>，也就是普罗米修斯、Alertmanager、灭霸和Grafana。最简单的部署选择是使用<a class="ae mc" href="https://github.com/prometheus-operator/prometheus-operator" rel="noopener ugc nofollow" target="_blank">普罗米修斯操作器</a>。</p><p id="b4a7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mb">注意:这不是赞助的(呵，我希望)，我只是决定在这个平台上转一圈，我真的很喜欢它，所以我决定为你和我未来的自己写一篇文章。</em></p><h1 id="248f" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">韵律学</h1><p id="a419" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">你可以在<a class="ae mc" href="https://grafana.com/products/cloud/" rel="noopener ugc nofollow" target="_blank">https://grafana.com/products/cloud/</a>注册Grafana Cloud帐户，假设你已经这样做了，你现在应该可以在<a class="ae mc" href="https://USERNAME.grafana.net/a/cloud-home-app" rel="noopener ugc nofollow" target="_blank">https://USERNAME.grafana.net/a/cloud-home-app</a>访问你的帐户。</p><p id="7f19" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将通过向客户发送Prometheus metrics开始构建我们的监控。在我们开始之前，我们需要访问Grafana Cloud为我们提供的Prometheus实例。您可以在位于<a class="ae mc" href="https://grafana.com/orgs/USERNAME" rel="noopener ugc nofollow" target="_blank">https://grafana.com/orgs/USERNAME</a>的Grafana云门户网站上找到您帐户中所有可用服务的实例。从那里你可以通过点击<em class="mb">细节</em>按钮导航到普罗米修斯配置。在那里，您将找到向实例发送数据所需的所有信息，即用户名、远程写端点和API密钥(您需要生成这些信息)。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi md"><img src="../Images/5289db9a397de786e5fbe91dcfe6c29b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EMMvJCU5n_boddMnToiI2A.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">Grafana云门户—作者图片</figcaption></figure><p id="4df5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">通常Prometheus抓取指标，在Grafana Cloud中，Prometheus实例配置为使用推送模型，其中您的应用程序必须使用<a class="ae mc" href="https://grafana.com/docs/agent/latest/" rel="noopener ugc nofollow" target="_blank"> Grafana Cloud Agent </a>推送指标。在上述Prometheus配置页面上，您还会看到示例<code class="fe mt mu mv mw b">remote_write</code>配置，您可以将它添加到您的代理中。</p><p id="208e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为此，我们将使用<code class="fe mt mu mv mw b">docker-compose</code>构建一个简单的应用程序和代理:</p><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="0964" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上面的配置为代理和sample Go应用程序提供了合理的默认设置。它通过环境变量设置Prometheus主机、用户名和API密钥(密码)，这些变量应该使用<code class="fe mt mu mv mw b">.env</code>文件提供。</p><p id="5246" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">除了上述<code class="fe mt mu mv mw b">docker-compose.yml</code>，您还需要代理配置，例如:</p><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="9643" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个配置告诉代理抓取在<code class="fe mt mu mv mw b">api:8080</code>运行的示例应用程序，并在<code class="fe mt mu mv mw b">/metrics</code>公开指标。它还告诉代理在推送指标时如何向Prometheus进行身份验证。</p><p id="acf6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在现实世界的应用程序中，您可能倾向于在HTTPS上运行<code class="fe mt mu mv mw b">/metrics</code>端点，但是这在这里是行不通的，所以要确保服务器监听HTTP，而不是HTTPS。</p><p id="6b12" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，在运行<code class="fe mt mu mv mw b">docker-compose up</code>之后，您应该能够使用<code class="fe mt mu mv mw b">curl localhost:8080/metrics</code>访问API指标，还可以看到代理的日志，例如:</p><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="4b2b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要查看代理本身收集和发送的度量，您可以使用<code class="fe mt mu mv mw b">curl localhost:12345/metrics</code>。</p><h1 id="adf1" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">仪表板</h1><p id="5e84" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">随着数据流向您的Prometheus实例，是时候在仪表板上可视化它了。导航至https://USERNAME.grafana.net/dashboards<a class="ae mc" href="https://USERNAME.grafana.net/dashboards" rel="noopener ugc nofollow" target="_blank">的</a>，点击以下屏幕中的<em class="mb">新仪表板</em>和<em class="mb">新面板</em>。选择<code class="fe mt mu mv mw b">grafanacloud-&lt;USERNAME&gt;-prom</code>作为数据源，您应该会看到<em class="mb">指标浏览器</em>字段填充了您的指标。</p><p id="52bf" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面你可以看到一个示例仪表板，显示了一个Go应用程序的内存消耗。仪表板被额外配置为显示20MB的阈值，该阈值可以在右侧面板的底部设置。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mz"><img src="../Images/ac5202ecac992318690808b5c95eb509.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ubHv5o7OQynn7g-3hR_ycQ.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">仪表板面板—按作者分类的图像</figcaption></figure><h1 id="565b" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">人工合成材料</h1><p id="5356" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">除了使用应用程序公开的指标来监控应用程序之外，您还可以利用综合监控来持续探测服务的状态代码、响应时间、DNS解析等。</p><p id="5eb3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Grafana Cloud提供合成监控，可在<a class="ae mc" href="https://USERNAME.grafana.net/a/grafana-synthetic-monitoring-app/home" rel="noopener ugc nofollow" target="_blank">https://username . grafana . net/a/grafana-synthetic-monitoring-app/home</a>访问。从那里您可以导航到<em class="mb">检查</em>选项卡并点击<em class="mb">添加新检查</em>。您可以从HTTP、PING、DNS、TCP或Traceroute选项中进行选择，这些选项在<a class="ae mc" href="https://grafana.com/docs/grafana-cloud/synthetic-monitoring/checks/" rel="noopener ugc nofollow" target="_blank">文档</a>中有解释。填写剩余字段应该是不言自明的，但是在选择探测位置时，要注意运行的探测越多，生成的日志就越多，这些日志会计入您的消耗/使用限制。</p><p id="ed79" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Grafana Cloud Synthetics的一个很好的特性是，你可以将它们导出为<em class="mb"> Terraform </em>配置，这样你就可以通过UI手动构建检查，并获得代码形式的配置。为此，导航至<a class="ae mc" href="https://USERNAME.grafana.net/plugins/grafana-synthetic-monitoring-app" rel="noopener ugc nofollow" target="_blank">https://username . grafana . net/plugins/grafana-synthetic-monitoring-app</a>并点击<em class="mb">生成配置</em>按钮。</p><p id="509f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">创建完支票后，您可以查看为每种类型的支票自动创建的仪表板。例如，HTTP check dashboard将如下所示:</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi na"><img src="../Images/cab0140841d6f08b771bed3de4d21fa7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1m5V6NgnUIyQua_wNEllQA.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">HTTP Synthetics —作者图片</figcaption></figure><p id="d836" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您正在监控配置了web analytics的网站，那么您会希望从分析收集中排除Grafana探针的IP。不幸的是没有静态IP的列表，但是你可以使用下面的<a class="ae mc" href="https://grafana.com/docs/grafana-cloud/reference/allow-list/#synthetic-monitoring" rel="noopener ugc nofollow" target="_blank"> DNS名称</a>来查找IP。</p><h1 id="b368" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">警报和通知</h1><p id="7805" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">度量和合成探测都为我们提供了大量数据，我们可以使用这些数据来创建警报。要创建新的警报，您可以导航至<a class="ae mc" href="https://USERNAME.grafana.net/alerting/list" rel="noopener ugc nofollow" target="_blank">https://USERNAME.grafana.net/alerting/list</a>并点击<em class="mb">新警报规则</em>。如果您使用Prometheus遵循上面的示例，那么您应该选择<code class="fe mt mu mv mw b">grafanacloud-&lt;USERNAME&gt;-prom</code>作为数据源。您应该已经看到两个准备好的查询字段，您可以在字段A中输入您的指标，在字段b中输入表达式来计算规则。完整的配置应该如下所示:</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nb"><img src="../Images/ac5c98e4383dcd1040b4ec9e54611a5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0iLSDewPMqGaOLbh5EdlJQ.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">警报-作者提供的图像</figcaption></figure><p id="6790" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当您滚动浏览可用指标时，您可能会注意到它现在还包括诸如<code class="fe mt mu mv mw b">probe_all_success_sum</code>(通常为<code class="fe mt mu mv mw b">probe_*</code>)之类的字段，这些是由前面部分中显示的合成监视器生成的指标，您也可以使用这些指标创建警报。一些有用的例子是:</p><ul class=""><li id="f208" class="nc nd it kk b kl km ko kp kr ne kv nf kz ng ld nh ni nj nk bi translated">SSL过期时间:</li></ul><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mx my l"/></div></figure><ul class=""><li id="2663" class="nc nd it kk b kl km ko kp kr ne kv nf kz ng ld nh ni nj nk bi translated">API可用性:</li></ul><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mx my l"/></div></figure><ul class=""><li id="9c28" class="nc nd it kk b kl km ko kp kr ne kv nf kz ng ld nh ni nj nk bi translated">Ping成功率:</li></ul><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mx my l"/></div></figure><ul class=""><li id="a862" class="nc nd it kk b kl km ko kp kr ne kv nf kz ng ld nh ni nj nk bi translated">代理看门狗:</li></ul><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="b167" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您还可以使用现有的合成监控仪表板来获得灵感——当您将鼠标悬停在仪表板中的任何面板上时，您将看到用于创建它的<em class="mb"> PromQL </em>查询。您还可以进入仪表板设置，使其可编辑，然后从每个面板复制查询。</p><p id="f924" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">准备好警报后，我们需要配置一个<em class="mb">联系点</em>，他们将向其发送通知。那些可以在<a class="ae mc" href="https://USERNAME.grafana.net/alerting/notifications" rel="noopener ugc nofollow" target="_blank">https://USERNAME.grafana.net/alerting/notifications</a>看到。默认情况下，会为您创建一个电子邮件联系方式，但是您应该填写其电子邮件地址，否则您将不会收到通知。您可以通过点击<em class="mb">新接触点</em>来添加更多接触点。</p><p id="75bd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，为了将警报路由到正确的联系点，我们需要在<a class="ae mc" href="https://USERNAME.grafana.net/alerting/routes" rel="noopener ugc nofollow" target="_blank">https://USERNAME.grafana.net/alerting/routes</a>配置<em class="mb">通知策略</em>，否则它将成为默认的电子邮件联系人。单击<em class="mb">新策略</em>并设置您选择的联系人，如果您只想向该联系人分配一部分提醒，还可以选择设置匹配标签。在我的例子中，我将警报和策略的标签都设置为<code class="fe mt mu mv mw b">channel=slack</code>。</p><p id="870a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是分别发送到电子邮件和Slack的结果警报。如果您不喜欢警报消息的默认模板，您可以通过单击<em class="mb">新模板</em>在<em class="mb">联系人</em>选项卡中添加您自己的模板。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nl"><img src="../Images/cab92722d6dac96601f7f434792561cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2XaPzlxRP1E20AnMxsD1jg.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">宽限通知-按作者排序的图像</figcaption></figure><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nm"><img src="../Images/f6d7937c5cc11d257506207254b002e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pn1TRraJSAhVvz8Gcm7D5Q.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">电子邮件通知—按作者分类的图像</figcaption></figure><h1 id="b2b6" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">日志</h1><p id="2d30" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">Grafana Cloud还允许您使用<em class="mb"> Loki </em>收集日志。实例是自动为您提供的。要开始将日志从您的应用程序发送到Grafana Cloud，您可以前往<em class="mb"> Grafana Cloud Portal </em>并检索Loki的凭据，与之前Prometheus的相同。</p><p id="066f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可以使用代理发送日志，或者如果你用Docker运行应用程序，你可以使用Loki日志插件，我们将在这里做。</p><p id="b550" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，您需要安装插件:</p><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="3a8c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">之后，您需要像这样更新<code class="fe mt mu mv mw b">docker-compose.yml</code>:</p><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="9771" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上面为每个容器设置了Docker Loki插件提供的日志驱动。如果你想为以<code class="fe mt mu mv mw b">docker run</code>开始的单个集装箱设置驱动程序，那么在这里检查单据<a class="ae mc" href="https://grafana.com/docs/loki/latest/clients/docker-driver/configuration/#change-the-logging-driver-for-a-container" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="b5d9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在使用更新的配置启动容器后，您可以通过检查<code class="fe mt mu mv mw b">agent</code>容器中的<code class="fe mt mu mv mw b">/tmp/positions.yaml</code>文件来验证代理是否找到了日志。</p><p id="dd50" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">随着日志流向Grafana Cloud，您可以通过选择<code class="fe mt mu mv mw b">grafanacloud-USERNAME-logs</code>作为数据源并查询您的项目和容器，在<a class="ae mc" href="https://USERNAME.grafana.net/explore" rel="noopener ugc nofollow" target="_blank">https://USERNAME.grafana.net/explore</a>中查看它们:</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi na"><img src="../Images/3e058b085bc173171d4a7ba6e17e5c93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IDR-jWx0jJr19Y8f0jeHRw.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">日志—按作者分类的图像</figcaption></figure><h1 id="5076" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">跟踪</h1><p id="bf3d" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">监控设置的最后一块拼图是使用<em class="mb">速度</em>的轨迹。同样，与Prometheus和Loki config类似，您可以从Grafana Cloud Portal获取Tempo的凭证和代理配置示例。</p><p id="8f85" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">代理需要的附加配置应该如下所示:</p><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="73a1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">另外<code class="fe mt mu mv mw b">docker-compose.yml</code>和<code class="fe mt mu mv mw b">.env</code>应该包括<code class="fe mt mu mv mw b">TEMPO_HOST</code>、<code class="fe mt mu mv mw b">TEMPO_USERNAME</code>和<code class="fe mt mu mv mw b">TEMPO_PASSWORD</code>的凭证变量。重启容器后，您应该在<code class="fe mt mu mv mw b">agent</code>日志中看到跟踪组件已经初始化:</p><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="ab24" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在上面的输出中，您可以看到收集器在<code class="fe mt mu mv mw b">0.0.0.0:4318</code>监听踪迹。因此，您应该配置您的应用程序，将遥测数据发送到此端点。参见<a class="ae mc" href="https://opentelemetry.io/docs/reference/specification/protocol/exporter/" rel="noopener ugc nofollow" target="_blank"> OpenTelemetry reference </a>找到与您的SDK相关的变量。</p><p id="06e3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要验证跟踪是否被收集并发送到Tempo，您可以运行<code class="fe mt mu mv mw b">curl -s localhost:12345/metrics | grep traces</code>，它将向您显示以下指标:</p><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mx my l"/></div></figure><h1 id="5bf7" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">结束语</h1><p id="60a3" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">最初，我对15天的Pro试用有些恼火，因为我想测试免费计划的局限性。然而，在试用到期后，我意识到我甚至没有超过免费计划的限制，也没有接触到专业/付费功能，所以免费计划似乎很慷慨，特别是如果你只是试图监控几个流量较低的微服务。</p><p id="848b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">即使使用免费计划，Grafana Cloud也能真正提供您需要的所有工具，以实际零成本为合理的大规模部署设置完整的监控。我还非常喜欢这样的做法，即只根据公制系列和对数线的数量来计算使用量，这样很容易跟踪。这也得益于全面的<em class="mb">计费/使用</em>仪表盘。</p><p id="01ef" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="mb">本文最初发布于</em><a class="ae mc" href="https://martinheinz.dev/blog/72?utm_source=medium&amp;utm_medium=referral&amp;utm_campaign=blog_post_72" rel="noopener ugc nofollow" target="_blank"><em class="mb">martinheinz . dev</em></a></p></div><div class="ab cl nn no hx np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="im in io ip iq"><p id="b5dc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae mc" href="https://medium.com/@martin.heinz/membership" rel="noopener">成为会员</a>阅读媒体上的每一个故事。<strong class="kk iu">你的会员费直接支持我和你阅读的其他作家。</strong>你还可以在媒体上看到所有的故事。</p><div class="nu nv gp gr nw nx"><a href="https://medium.com/@martin.heinz/membership" rel="noopener follow" target="_blank"><div class="ny ab fo"><div class="nz ab oa cl cj ob"><h2 class="bd iu gy z fp oc fr fs od fu fw is bi translated">通过我的推荐链接加入媒体-马丁·海因茨</h2><div class="oe l"><h3 class="bd b gy z fp oc fr fs od fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="of l"><p class="bd b dl z fp oc fr fs od fu fw dk translated">medium.com</p></div></div><div class="og l"><div class="oh l oi oj ok og ol mn nx"/></div></div></a></div></div><div class="ab cl nn no hx np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="im in io ip iq"><p id="009d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可能也喜欢…</p><div class="nu nv gp gr nw nx"><a href="https://towardsdatascience.com/ultimate-ci-pipeline-for-all-of-your-python-projects-27f9019ea71a" rel="noopener follow" target="_blank"><div class="ny ab fo"><div class="nz ab oa cl cj ob"><h2 class="bd iu gy z fp oc fr fs od fu fw is bi translated">所有Python项目的终极CI管道</h2><div class="oe l"><h3 class="bd b gy z fp oc fr fs od fu fw dk translated">您对Python项目持续集成管道的所有期望—启动并运行…</h3></div><div class="of l"><p class="bd b dl z fp oc fr fs od fu fw dk translated">towardsdatascience.com</p></div></div><div class="og l"><div class="om l oi oj ok og ol mn nx"/></div></div></a></div><div class="nu nv gp gr nw nx"><a href="https://towardsdatascience.com/improving-application-availability-with-pod-readiness-gates-4ebebc3fb28a" rel="noopener follow" target="_blank"><div class="ny ab fo"><div class="nz ab oa cl cj ob"><h2 class="bd iu gy z fp oc fr fs od fu fw is bi translated">通过Pod就绪关口提高应用程序可用性</h2><div class="oe l"><h3 class="bd b gy z fp oc fr fs od fu fw dk translated">当Pod就绪和活性探测不够好时，您能做什么？</h3></div><div class="of l"><p class="bd b dl z fp oc fr fs od fu fw dk translated">towardsdatascience.com</p></div></div><div class="og l"><div class="on l oi oj ok og ol mn nx"/></div></div></a></div></div></div>    
</body>
</html>