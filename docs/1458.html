<html>
<head>
<title>Packer: Machine Image As A Code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">打包机:作为代码的机器图像</h1>
<blockquote>原文：<a href="https://itnext.io/packer-machine-image-as-a-code-3d02729d82ca?source=collection_archive---------3-----------------------#2018-10-22">https://itnext.io/packer-machine-image-as-a-code-3d02729d82ca?source=collection_archive---------3-----------------------#2018-10-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/5600c32e93be9ba7ae5ea33363203b9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*c2yQjXC-9WIXFNfU"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://unsplash.com/@rawpixel?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> rawpixel </a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的“画灰色小猫的人的照片”</figcaption></figure><p id="0596" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这个云计算时代，许多公司都采用不可变的基础设施，将基础设施作为代码来简化配置管理和可靠性。在不可变的基础设施中，创建新的服务器，而不是在运行的服务器上进行更改。构建不可变的基础设施是困难的，并且需要一个复杂的过程来构建和测试它们。实现不可变基础设施的最佳方式是通过代码完成所有事情，包括服务器映像、作为代码的基础设施、使用代码的任何特定配置。我们已经在<a class="ae kc" href="https://medium.com/@mitesh_shamra/infrastructure-as-a-code-with-terraform-e7021bf28d7d" rel="noopener">基础设施中看到了使用terraform </a>的代码，使用ansible 的<a class="ae kc" href="https://medium.com/@mitesh_shamra/introduction-to-ansible-e5b56ee76b8c" rel="noopener">配置管理。在本帖中，我们将重点放在使用</a><a class="ae kc" href="https://packer.io/" rel="noopener ugc nofollow" target="_blank"> Hashicorp Packer </a>的机器图像上。</p><p id="f963" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当我们启动一组应用程序和服务来实现实例上的特定目的时，转到实例并设置它们可能需要一些时间。为了解决这个问题，我们可以使用机器映像，它作为一个静态单元，包含已安装的软件、应用程序和操作系统。在AWS环境中，AMI或Amazon机器映像是一个主映像，包含在云中启动实例服务器所需的信息。AMI就像启动实例所需的根卷的模板。它们包括操作系统、应用程序服务、应用程序以及其他文件或配置。一旦我们创建了一个AMI并注册了它，就可以用它来启动一个新的实例。</p><p id="bc97" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建机器映像的过程包括以下步骤:</p><ol class=""><li id="ce30" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">使用基本映像引导实例。</li><li id="ff8e" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">运行ansible或脚本之类的配置工具，将实例配置到所需的状态。</li><li id="0dd8" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">从该服务器创建新的机器映像</li></ol><p id="60f0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦创建了一个新的机器映像，那么从这个新的映像启动一个新的服务器将给出在这个实例上已经完成的所有配置。这有助于我们顺利完成部署过程。这也有助于快速扩展我们的服务。</p><p id="a154" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Hashicorp Packer是一个轻量级、易于使用的工具，它可以自动为多种平台创建任何类型的机器映像。Packer不是Ansible这样的配置管理工具的替代品。Packer与ansible等工具一起工作，在创建映像时安装软件。Packer使用配置文件创建机器映像。Packer使用构建器的概念来启动实例，运行供应器来配置应用程序或服务。安装完成后，它会关闭实例并保存新的烘焙机器实例以及任何所需的后处理。Packer只构建图像。</p><p id="c326" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用封隔器的优点:</p><ol class=""><li id="4549" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">快速基础架构部署:机器映像使我们能够更快地启动配置好的机器。</li><li id="5ccc" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">可扩展:Packer在映像创建期间为机器安装和配置所有软件，因此我们不需要运行任何配置管理工具。使用相同的AMI，我们可以生成任意数量的实例，而无需进行额外的配置。</li><li id="f95a" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">多提供商支持:Packer可用于为多个云提供商创建图像，如AWS、GCP、数字海洋等。</li><li id="6974" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">提供可测试性:机器映像可以被测试以验证它们正在工作。</li></ol><p id="f047" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用封隔器的缺点:</p><ol class=""><li id="acd8" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">可管理性:packer不提供AMI可管理性。您需要自己使用标签或版本来管理它们。继续删除旧的未使用的ami。</li></ol><p id="5aa8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">封隔器配置文件有三个主要部分:</p><p id="6a0d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">用户变量</strong>:用户变量用于参数化packer配置文件模板，这样我们就可以将机密、环境变量和其他参数排除在模板之外。它们有助于配置文件的移植。它们有助于分离出可以在模板中修改的部分。变量可以通过命令行、环境变量、Vault或文件传递。变量部分是一个键值映射，变量名分配给一个默认值。</p><p id="33b5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">构建器</strong>:构建器部分包含打包器用来生成机器映像的构建器列表。构建器负责创建一个实例并从中生成机器映像。一个构建器映射到一个机器映像。构建器包含的信息包括作为构建器名称的类型、构建器连接到AWS等平台所需的访问密钥。</p><p id="ccbe" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">Provisioners</strong>:Provisioners部分包含一个Provisioners列表，packer在创建机器映像之前使用它来安装和配置运行实例中的软件。置备程序是可选的。置备程序包含指定置备程序名称的类型，如Shell、Ansible等。</p><p id="2f8a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们通过一个例子来理解，在AWS提供的基础Amazon Linux 2 AMI之上安装nginx来创建一个新的AMI。我们将在用户变量部分移动所有将来可以更改的参数。我们将使用环境变量作为访问和密钥。我们使用用户变量部分中的env函数将默认值设置为环境变量值。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="30ef" class="ly lz iq lu b gy ma mb l mc md">"aws_access_key": "{{env `AWS_ACCESS_KEY_ID`}}",<br/>"aws_secret_key": "{{env `AWS_SECRET_ACCESS_KEY`}}",</span></pre><p id="63c9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">其他变量用默认值定义。您可以根据需要更改这些值。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="6ee5" class="ly lz iq lu b gy ma mb l mc md">"variables": {<br/>    "aws_access_key": "{{env `AWS_ACCESS_KEY_ID`}}",<br/>    "aws_secret_key": "{{env `AWS_SECRET_ACCESS_KEY`}}",<br/>    "region": "us-east-1",<br/>    "ssh_username": "ec2-user",<br/>    "base_ami": "ami-0e6d2e8684d4ccb3e",<br/>    "instance_type": "t2.micro"<br/>}</span></pre><p id="2f3c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将生成EBS支持的机器映像，因此需要在构建器部分将类型定义为“amazon-ebs”。因为我们要创建单个AMI，所以这里只有一个JSON部分。需要定义支持新图像所需的其他参数，如源AMI名称、访问密钥、密钥、区域等。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="9e3d" class="ly lz iq lu b gy ma mb l mc md">"builders": [<br/>    {<br/>      "type": "amazon-ebs",<br/>      "access_key": "{{user `aws_access_key`}}",<br/>      "secret_key": "{{user `aws_secret_key` }}",<br/>      "region": "{{user `region` }}",<br/>      "source_ami": "{{user `base_ami`}}",<br/>      "instance_type": "{{user `instance_type` }}",<br/>      "ssh_username": "{{user `ssh_username`}}",<br/>      "ami_name": "packer-base-{{timestamp}}",<br/>      "associate_public_ip_address": true<br/>    }<br/>]</span></pre><p id="4b1f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦构建器准备好了，我们就跳到供应器来定义需要运行什么脚本或配置管理。我们将运行shell命令来安装nginx。在Amazon Linux 2中，我们首先需要使用amazon-linux-extras来启用nginx。一旦启用，我们就可以使用yum命令安装并安装nginx。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="af67" class="ly lz iq lu b gy ma mb l mc md">"provisioners": [<br/>    {<br/>      "type": "shell",<br/>      "inline": [<br/>        "echo ENABLE NGINX",<br/>        "sudo amazon-linux-extras enable nginx1.12",<br/>        "echo INSTALL NGINX",<br/>        "sudo yum -y install nginx",<br/>        "echo START NGINX",<br/>        "sudo systemctl start nginx"<br/>      ]<br/>    }<br/>]</span></pre><p id="f26f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们需要使用validate命令来验证我们的packer文件是否有效。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="3a16" class="ly lz iq lu b gy ma mb l mc md">packer validate example.json</span></pre><p id="219a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们需要使用build命令执行packer JSON文件来生成一个新的AWS AMI。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="5935" class="ly lz iq lu b gy ma mb l mc md">packer build example.json</span></pre><p id="d85a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果在provisioner文件的执行过程中出错，我们最终会得到一条错误消息。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="e59c" class="ly lz iq lu b gy ma mb l mc md"><strong class="lu ir">Build 'amazon-ebs' errored: Script exited with non-zero exit status: 1</strong></span></pre><p id="eeb4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果一切正常，那么我们会得到下面提到的消息。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="6e4b" class="ly lz iq lu b gy ma mb l mc md"><strong class="lu ir">amazon-ebs output will be in this color.</strong></span><span id="ae2b" class="ly lz iq lu b gy me mb l mc md"><strong class="lu ir">==&gt; amazon-ebs: Prevalidating AMI Name: packer-base-1539107879</strong></span><span id="76da" class="ly lz iq lu b gy me mb l mc md">amazon-ebs: Found Image ID: ami-0e6d2e8684d4ccb3e</span><span id="b986" class="ly lz iq lu b gy me mb l mc md"><strong class="lu ir">==&gt; amazon-ebs: Creating temporary keypair: packer_5bbcec27-767b-384c-c5d7-c047ebc099c6</strong></span><span id="2f10" class="ly lz iq lu b gy me mb l mc md"><strong class="lu ir">==&gt; amazon-ebs: Creating temporary security group for this instance: packer_5bbcec2a-37e9-602c-9fdc-fd504f4d17a1</strong></span><span id="c852" class="ly lz iq lu b gy me mb l mc md"><strong class="lu ir">==&gt; amazon-ebs: Authorizing access to port 22 from 0.0.0.0/0 in the temporary security group...</strong></span><span id="8c61" class="ly lz iq lu b gy me mb l mc md"><strong class="lu ir">==&gt; amazon-ebs: Launching a source AWS instance...</strong></span><span id="f62a" class="ly lz iq lu b gy me mb l mc md"><strong class="lu ir">==&gt; amazon-ebs: Adding tags to source instance</strong></span><span id="7aae" class="ly lz iq lu b gy me mb l mc md">amazon-ebs: Adding tag: "Name": "Packer Builder"</span><span id="063d" class="ly lz iq lu b gy me mb l mc md">amazon-ebs: Instance ID: i-0b738eeecacf78658</span><span id="d3c4" class="ly lz iq lu b gy me mb l mc md"><strong class="lu ir">==&gt; amazon-ebs: Waiting for instance (i-0b738eeecacf78658) to become ready...</strong></span><span id="f4e0" class="ly lz iq lu b gy me mb l mc md"><strong class="lu ir">==&gt; amazon-ebs: Using ssh communicator to connect: 54.80.150.83</strong></span><span id="385f" class="ly lz iq lu b gy me mb l mc md"><strong class="lu ir">==&gt; amazon-ebs: Waiting for SSH to become available...</strong></span><span id="f2cf" class="ly lz iq lu b gy me mb l mc md"><strong class="lu ir">==&gt; amazon-ebs: Connected to SSH!</strong></span><span id="af6a" class="ly lz iq lu b gy me mb l mc md"><strong class="lu ir">==&gt; amazon-ebs: Provisioning with shell script: /var/folders/bz/90_0_cjj71b9vmsl6qsp8dwc0000gp/T/packer-shell802152345</strong></span><span id="904d" class="ly lz iq lu b gy me mb l mc md">amazon-ebs: ENABLE NGINX</span><span id="ce2c" class="ly lz iq lu b gy me mb l mc md">amazon-ebs:   0  ansible2                 available    [ =2.4.2  =2.4.6 ]</span><span id="fcc9" class="ly lz iq lu b gy me mb l mc md">amazon-ebs:   1  emacs                    available    [ =25.3 ]</span><span id="529f" class="ly lz iq lu b gy me mb l mc md">amazon-ebs:   2  httpd_modules            available    [ =1.0 ]</span><span id="6598" class="ly lz iq lu b gy me mb l mc md">.................<br/>Some More Message<br/>.................</span><span id="a77a" class="ly lz iq lu b gy me mb l mc md">amazon-ebs:   nginx-mod-mail.x86_64 1:1.12.2-1.amzn2.0.2</span><span id="8fa3" class="ly lz iq lu b gy me mb l mc md">amazon-ebs:   nginx-mod-stream.x86_64 1:1.12.2-1.amzn2.0.2</span><span id="2f74" class="ly lz iq lu b gy me mb l mc md">amazon-ebs:   stix-fonts.noarch 0:1.1.0-5.amzn2</span><span id="201c" class="ly lz iq lu b gy me mb l mc md">amazon-ebs:</span><span id="e0a9" class="ly lz iq lu b gy me mb l mc md">amazon-ebs: Complete!</span><span id="3d6f" class="ly lz iq lu b gy me mb l mc md">amazon-ebs: START NGINX</span><span id="342c" class="ly lz iq lu b gy me mb l mc md"><strong class="lu ir">==&gt; amazon-ebs: Stopping the source instance...</strong></span><span id="c1de" class="ly lz iq lu b gy me mb l mc md">amazon-ebs: Stopping instance, attempt 1</span><span id="e096" class="ly lz iq lu b gy me mb l mc md"><strong class="lu ir">==&gt; amazon-ebs: Waiting for the instance to stop...</strong></span><span id="723a" class="ly lz iq lu b gy me mb l mc md"><strong class="lu ir">==&gt; amazon-ebs: Creating unencrypted AMI packer-base-1539107879 from instance i-0b738eeecacf78658</strong></span><span id="4ba0" class="ly lz iq lu b gy me mb l mc md">amazon-ebs: AMI: ami-0c185c9c51c96be52</span><span id="0713" class="ly lz iq lu b gy me mb l mc md"><strong class="lu ir">==&gt; amazon-ebs: Waiting for AMI to become ready...</strong></span><span id="ec66" class="ly lz iq lu b gy me mb l mc md"><strong class="lu ir">==&gt; amazon-ebs: Terminating the source AWS instance...</strong></span><span id="1e51" class="ly lz iq lu b gy me mb l mc md"><strong class="lu ir">==&gt; amazon-ebs: Cleaning up any extra volumes...</strong></span><span id="40d6" class="ly lz iq lu b gy me mb l mc md"><strong class="lu ir">==&gt; amazon-ebs: No volumes to clean up, skipping</strong></span><span id="f1e0" class="ly lz iq lu b gy me mb l mc md"><strong class="lu ir">==&gt; amazon-ebs: Deleting temporary security group...</strong></span><span id="9740" class="ly lz iq lu b gy me mb l mc md"><strong class="lu ir">==&gt; amazon-ebs: Deleting temporary keypair...</strong></span><span id="3113" class="ly lz iq lu b gy me mb l mc md"><strong class="lu ir">Build 'amazon-ebs' finished.</strong></span><span id="f8d4" class="ly lz iq lu b gy me mb l mc md">==&gt; Builds finished. The artifacts of successful builds are:</span><span id="0b5f" class="ly lz iq lu b gy me mb l mc md">--&gt; amazon-ebs: AMIs were created:</span><span id="6ba7" class="ly lz iq lu b gy me mb l mc md">us-east-1: ami-0c185c9c51c96be52</span></pre><p id="c27f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦packer文件被成功执行，我们就会在最后打印出新生成的AMI名称。在这种情况下，我们最新的AMI名称是“ami-0c185c9c51c96be52”。</p><p id="87a0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">希望这篇文章能帮助你找到足够的动机来使用packer来支持AMI使用代码。</p><p id="d7a9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">完整的代码可以在这个git资源库中找到:<a class="ae kc" href="https://github.com/MiteshSharma/PackerAmi" rel="noopener ugc nofollow" target="_blank">https://github.com/MiteshSharma/PackerAmi</a></p><p id="97c6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> <em class="mf"> PS:如果你喜欢这篇文章，请鼓掌支持。欢呼</em>T5】</strong></p></div></div>    
</body>
</html>