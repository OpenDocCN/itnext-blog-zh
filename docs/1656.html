<html>
<head>
<title>Embracing failures and cutting infrastructure costs: Spot instances in Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">拥抱失败和削减基础设施成本:Kubernetes的现场实例</h1>
<blockquote>原文：<a href="https://itnext.io/embracing-failures-and-cutting-infrastructure-costs-spot-instances-in-kubernetes-6976781beacc?source=collection_archive---------0-----------------------#2018-12-21">https://itnext.io/embracing-failures-and-cutting-infrastructure-costs-spot-instances-in-kubernetes-6976781beacc?source=collection_archive---------0-----------------------#2018-12-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/14478e23589e0841ee87fce03a065324.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gW8C1v4ROBRDgJRQD1Vf2A.jpeg"/></div></div></figure><p id="13c5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在过去的几十年里，全球已经从内部数据中心转向由主流云提供商提供虚拟机(VM)，如<em class="kw">亚马逊网络服务</em>、<em class="kw"> Azure </em>、<em class="kw">谷歌云平台</em>。</p><blockquote class="kx ky kz"><p id="702f" class="jy jz kw ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">运行和管理您自己的物理机既困难又昂贵；你可能永远不会像任何顶级云提供商那样成功和高效。</p></blockquote><p id="784f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当您可以利用成熟的平台和功能时，还有什么不喜欢的呢，例如:</p><ul class=""><li id="d7be" class="ld le iq ka b kb kc kf kg kj lf kn lg kr lh kv li lj lk ll bi translated"><strong class="ka ir">垂直可伸缩性</strong> —您可以获得不同大小的实例</li><li id="0df0" class="ld le iq ka b kb lm kf ln kj lo kn lp kr lq kv li lj lk ll bi translated"><strong class="ka ir">水平可伸缩性</strong> —您可以获得(几乎)想要的任意多的实例</li><li id="21f0" class="ld le iq ka b kb lm kf ln kj lo kn lp kr lq kv li lj lk ll bi translated"><strong class="ka ir">灵活定价</strong> —您只需为您使用的产品付费</li><li id="5ed8" class="ld le iq ka b kb lm kf ln kj lo kn lp kr lq kv li lj lk ll bi translated"><strong class="ka ir">物流成本</strong> —您不必实际维护任何服务器(热控制、电力、备份、存储成本、防火等)</li><li id="a13e" class="ld le iq ka b kb lm kf ln kj lo kn lp kr lq kv li lj lk ll bi translated"><strong class="ka ir">可用性</strong> —在独立的数据中心调配虚拟机</li><li id="61fb" class="ld le iq ka b kb lm kf ln kj lo kn lp kr lq kv li lj lk ll bi translated"><strong class="ka ir">可靠性</strong> —如果你为一个实例付费，你会一直保留它，直到你完成为止。如果它坏了，你会立即(+-5分钟)得到一个替代品</li></ul><p id="b33c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本文中，我们将探讨典型云提供商的不同定价模式。我们将专注于一种策略，看看如果你愿意牺牲可靠性，它如何能够<strong class="ka ir">让你的账单减少80% </strong>。最后，我们将看到Kubernetes如何使可靠性的缺乏变得无关紧要，并允许您运行一个廉价但高度可用的集群。</p><h1 id="c0c1" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">现收现付:灵活性是有代价的</h1><p id="aad3" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">云提供商的典型定价模式基于现收现付方案。计算资源有不同的大小(即内存、CPU、磁盘等..)和一个小时的费用。<strong class="ka ir">你会收到实例运行时间的账单</strong>。</p><p id="bf21" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这种定价的灵活性非常好，也很公平，但是你必须小心你消费的东西。如果您让实例运行，而您不再需要它们，您将把钱扔出窗外。</p><blockquote class="kx ky kz"><p id="edc9" class="jy jz kw ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">但是，假设您可以预见一个虚拟机一整年的利用率。你的账单不应该有批量折扣吗？</p></blockquote><h1 id="d8ef" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">通过预订实例获得批量折扣</h1><p id="1a13" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">对于保留的实例，你需要<strong class="ka ir">承诺</strong>至少一整年的计算资源，如果你真的喜欢承诺，最多五年。你可以决定提前支付一部分费用。</p><p id="0481" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你得到的折扣将取决于你愿意承诺多长时间以及你可以预付多少钱。例如，在Amazon Web Services上，<em class="kw"> m4.large </em>实例类型的折扣如下:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/76f57516ea75957e96b02fce026acc78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7RGE0PwL6j5SysiDewgphA.png"/></div></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">大宗购买折扣</figcaption></figure><p id="dd96" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如您所见，预订实例提供的折扣<strong class="ka ir">通常在30%到40%之间</strong>。</p><blockquote class="kx ky kz"><p id="113c" class="jy jz kw ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">在保留的情况下，你基本上是用灵活性换取现金。</p></blockquote><p id="6559" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">虽然30%到40%听起来是合理的节省，但并不总是值得的。您能否预测未来1到5年的计算资源利用率？如果你正在云中建立一个前沿的创业公司，你能准确预测几年后你的流量会是什么样的吗？</p><blockquote class="kx ky kz"><p id="b4fe" class="jy jz kw ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">如果这听起来像是一场赌博，那它就是。或许承诺和预付并不是你节省云账单的唯一方式。</p></blockquote><h1 id="e147" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">现场实例:当便宜比可靠更好的时候</h1><p id="e5b6" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">AWS称它们为<a class="ae nd" href="https://aws.amazon.com/ec2/spot/" rel="noopener ugc nofollow" target="_blank"> Spot Instances </a>，Azure <a class="ae nd" href="https://docs.microsoft.com/en-us/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-use-low-priority" rel="noopener ugc nofollow" target="_blank">低优先级VM </a>和Google <a class="ae nd" href="https://cloud.google.com/compute/docs/instances/preemptible" rel="noopener ugc nofollow" target="_blank">可抢占VM </a>。我们将称它们为“点实例”，因为这似乎是最常见的术语。尽管它们的内部工作方式略有不同，但它们源于相同的基本原理。</p><p id="6944" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一个典型的云提供商购买大量组织在大型数据中心的强大服务器。为了最大限度地利用硬件，他们将这些计算机分成更小的虚拟机。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ne"><img src="../Images/dd89f565d2f0f170c8c3637b79c554a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*qH1LXbKbQ6woc23Fzjji7A.gif"/></div></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">云提供商通常将裸机服务器拆分成较小的虚拟机</figcaption></figure><p id="beec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">因为他们向每个人承诺横向可扩展性，所以他们需要保留大量未利用的硬件，以防有人突然需要额外的计算单元。然而，这留下了大量未使用的资源。</strong></p><p id="4dbe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">spot实例背后的想法是允许用户以低得多的成本利用这些额外的资源，但前提是您可能随时会丢失实例。如果您正在运行一个spot实例，而云提供商突然需要该资源来满足按需客户或预订客户的需求，您将会立即丢失您的实例。</p><p id="c6d0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">鉴于<strong class="ka ir">灵活性</strong>被用作保留实例的筹码，这里给出的是<strong class="ka ir">可靠性</strong>。不过，节省的好处要大得多。一般来说，你的账单会减少70%到80%。</p><p id="7aa4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">随之而来的是一个大问题:</p><blockquote class="kx ky kz"><p id="a6fd" class="jy jz kw ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated"><strong class="ka ir">您是否应该因为账单有70%到80%的折扣而赌上基础设施的稳定性？如果您随时都有可能失去一个节点，这对您的客户会有什么影响？</strong></p></blockquote><h1 id="da5f" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">拥抱失败</h1><p id="1633" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">对大规模系统的观察已经证明，您的应用程序<strong class="ka ir">最终会关闭</strong>。硬盘、网络、JVM等。如果你给他们足够的时间和要求，他们所有的T21都会失败。</p><blockquote class="kx ky kz"><p id="ee3e" class="jy jz kw ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">你对抗失败的主要武器是<strong class="ka ir">复制</strong>和<strong class="ka ir">冗余</strong>。</p></blockquote><p id="81b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您运行每个组件的几个副本，它可能对一定数量的故障具有弹性。您可以从故障中恢复的程度将取决于您愿意放置多少冗余。</p><p id="085b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不要忘记冗余意味着更多的计算资源。更多的计算资源导致更高的账单。</p><p id="495b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要考虑的另一点是spot实例的动态方面。基于闲置的资源，你可用的实例的大小将<strong class="ka ir">取决于什么是当前不受欢迎的</strong>。换句话说，<em class="kw">乞丐不能挑肥拣瘦</em>。</p><p id="6a06" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">也许本周你可以买到便宜的2GB内存实例，如果这是你的应用程序需要的内存量，那就太好了。如果这些实例变得不可用，并且您只能购买4GB内存的实例，那么下周您应该做什么？当然，您可以使用这些实例，但是您将付出两倍的代价，并且额外的内存将被浪费。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nf"><img src="../Images/98719e4d82ba3cbb8441ca66d23cf38e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*MA2u0B157ZeFnWM95A8XgA.gif"/></div></div></figure><p id="c890" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Spot实例是一个很好的交易，但是缺点可能是不可接受的。如何应对随机节点在毫无察觉的情况下消失？您的基础设施应该如何处理不断变化大小的节点？</p><blockquote class="kx ky kz"><p id="7232" class="jy jz kw ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">您需要的是一个持续监控节点并自动管理冗余的工具。</p></blockquote><p id="b07a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个工具应该在您的基础设施上扩展和分布应用程序的组件；当丢失或创建一个节点时，基础架构会重新平衡。</p><p id="ccfb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果没有这样的工具，似乎就无法管理随之而来的云基础设施。很可能已经有人建造了它。你很幸运，谷歌在几年前就面临这些问题，并且已经开源了他们的解决方案。</p><h1 id="5a44" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">将数据中心抽象为一台计算机</h1><p id="ceec" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">在传统的基础设施中，比如说21世纪初，你有固定数量的服务器和可预测数量的资源。</p><p id="e213" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">云基础设施——尤其是spot实例——已经完全改变了游戏规则。开发Kubernetes是为了监督管理不断变化的计算资源的日益增加的复杂性。</p><p id="3b67" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Kubernetes为您的所有计算资源提供了一个抽象层——不管有多少，也不管它们的大小。你只需要与一个<strong class="ka ir">单个</strong>实体:<strong class="ka ir">集群</strong>进行交互。</p><p id="dc8a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您的集群可以由10个小型虚拟机或2个大型裸机服务器组成，最终结果是一样的:<em class="kw">管理和扩展节点上工作负载的单一交互点</em>。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ne"><img src="../Images/e5974bcb04d8001888e07ed0073639eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*I27gVyyO7FryFRFNQoWA-Q.gif"/></div></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">Kubernetes让你忘记单个节点；你可以只想到“集群”</figcaption></figure><p id="5d9d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当你在你的基础设施上安装Kubernetes时，你选择一台计算机作为主节点，其余的作为T2节点加入集群。当您在集群中添加或删除节点时，Kubernetes会跟踪每个节点上的可用内存和CPU。</p><p id="889e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当集群准备就绪时，您向主节点发送部署请求。</p><blockquote class="kx ky kz"><p id="7141" class="jy jz kw ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">收到请求后，Kubernetes会调查工作节点的可用内存和CPU，并找到运行应用程序的最佳候选节点。</p></blockquote><p id="d032" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">作为用户，你不用担心你的应用在哪里运行；它在星团里。如果运行您的应用程序的节点死亡，它的工作负载将立即转移到其他节点。</p><p id="bfcc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有趣的是，Kubernetes并不关心一个worker节点的大小，只要它提供内存和CPU。</p><p id="8280" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当具有4GB内存和2个CPU的工作节点向集群注册时，主节点会跟踪总的可用和备用容量。它持续监视每个节点上的当前工作负载，并可以决定给定节点是否有足够的可用资源来运行应用程序。</p><p id="efdf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是库伯内特真正的美丽之一。<strong class="ka ir">你可以忘记有多少单独的节点加入了集群，它们有多大:你只看到一个统一的实体。</strong>但是，如果您有兴趣了解您的集群有多大，您可以将所有节点的内存和CPU相加，这将告诉您您的集群有多少总容量。</p><p id="074b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您有一个4GB/1vCPU和一个8GB/2 vCPU实例，那么您只有一个包含12GB和3个vcpu的集群。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ne"><img src="../Images/c39b3202133925f19af931caf311558c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*oDWxxE0wmWGVc1SmYzoeeQ.gif"/></div></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">Kubernetes跟踪可用的内存和CPU</figcaption></figure><p id="06f2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Kubernetes中另一个值得注意的特性是监控节点的正常运行时间。</p><blockquote class="kx ky kz"><p id="dc6b" class="jy jz kw ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">如果一个节点丢失，Kubernetes将从集群中删除其内存和CPU，并将所有应用程序迁移到其他工作节点。</p></blockquote><h1 id="677d" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">Kubernetes的自我修复基础设施</h1><p id="7055" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">主节点运行一系列同步循环，这些循环遵循一个简单的原则:作为用户，您指定所需的状态，例如“我想要我的应用程序的3个实例”。</p><p id="fc10" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">主节点定期检查当前状态，将其与所需状态进行比较，并进行任何必要的调整。例如，如果一个主节点注意到一个应用程序只有两个实例在运行，但您请求了三个，它会立即启动另一个实例。</p><blockquote class="kx ky kz"><p id="cc0e" class="jy jz kw ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">Kubernetes的大部分组件都是这样设计的:一个控制回路，不断地将当前状态调节到理想状态附近。</p></blockquote><p id="1dc1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">假设您有3个节点和一个应用程序的3个副本，每个节点上运行一个。当运行在spot实例上的节点被云提供商回收时，该节点上的应用程序将丢失。Kubernetes意识到您只有2个副本在运行，而不是3个，并立即在剩余的两个节点中的一个节点上启动另一个副本(当然，如果空间可用的话)。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ne"><img src="../Images/8f5ad43f9828b4b1ea31aea10e43dafc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*EqG5u4Bx_KeQWIUBGr6YmQ.gif"/></div></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">Kubernetes自动从节点故障中恢复</figcaption></figure><h1 id="d813" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">现场实例和Kubernetes:天作之合</h1><p id="676c" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">在过去的十年中，我们的行业已经大规模采用了微服务架构。一些人会认为这是一种时尚，另一些人则认为这只是SOA的更名。我认为微服务架构带来的最重要的变革不是我们决定编写更小的应用程序，而是从预防故障到拥抱故障的转变。</p><p id="83fa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">像<em class="kw">网飞</em>、<em class="kw">谷歌</em>和<em class="kw">亚马逊</em>这样的人最重要的见解是，在规模上<strong class="ka ir">，事情会出错</strong>。即使在最好和最昂贵的硬件上，故障的概率也严格地大于零。</p><p id="7a8d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw">那么如何围绕它进行设计呢？</em></p><blockquote class="kx ky kz"><p id="c71d" class="jy jz kw ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated"><strong class="ka ir">您使用混沌工程测试故障转移。</strong></p></blockquote><p id="cff3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">混沌工程</strong>建议你积极地在你的基础设施中制造故障，以确保你确实具有弹性。</p><blockquote class="kx ky kz"><p id="2345" class="jy jz kw ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">如果你需要记住一件事，那就是<strong class="ka ir">可用性和可靠性只有在你主动测试它们的时候才能实现</strong>。</p></blockquote><p id="92ac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果要确保应用程序的高可用性，需要定期杀死节点。</p><p id="ba7f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw">如果不能发现实例，还有什么更好的方法可以随机杀死节点呢？</em></p><p id="ae86" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，您不仅因为利用了闲置资源而节省了80%的云费用，而且还不断测试基础架构的弹性。</p><p id="4f69" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你从保留的实例中获得的宝贵的可靠性不再那么重要了。事实上，您实际上并不关心您的云提供商是否意外回收了您的节点；如果你有现代而有弹性的建筑，你甚至不会注意到。</p><p id="f5a9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">减单和混沌工程。这是双赢。</strong></p><h1 id="d836" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">热点实例热点提示</h1><p id="1dcc" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">如果您希望在Kubernetes集群中尝试spot实例，有几件事可以帮助您优化基础设施。</p><h1 id="e14e" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">明智地使用实例类型</h1><p id="1f77" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">选择不受欢迎的实例类型。例如，亚马逊网络服务上的m4实例很便宜，因为最近发布了m5实例系列。这使得m4实例不再流行，对你来说意味着更低的需求和更好的价格！</p><h1 id="94a0" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">最高投标价(仅AWS)</h1><p id="dac9" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">虽然Azure的低优先级虚拟机和Google可抢占虚拟机有固定的价格，但Spot实例的价格是通过投标过程确定的。作为用户，您可以指定愿意支付的每小时最高价格。如果AWS有足够的空闲虚拟机为每个人服务，每个人都可以以较低的价格获得实例。然而，随着需求的增加，价格会越来越高。</p><p id="84b8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择最高投标价允许你决定你愿意在中交换多少<strong class="ka ir">可靠性。一个<strong class="ka ir">的低出价</strong>将确保你的<strong class="ka ir">账单保持在低水平</strong>，但会增加失去一个节点</strong>的<strong class="ka ir">可能性。一个<strong class="ka ir">高出价</strong>(例如等于按需价格)将<strong class="ka ir">减少节点故障</strong>，但意味着你可能支付与按需价格相同的价格，即没有折扣。</strong></p><p id="815a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以选择将投标价格与3年的保留实例价格保持一致(通常比按需价格便宜约35%)。这样，您肯定不会在没有实际预订的情况下支付超过预订实例的费用。</p><p id="cf57" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">那也取决于你在做什么。如果你想以最低的价格做非关键的工作，你可能会有一个较低的投标价格，希望能得到便宜的资源，否则什么也得不到。</p><h1 id="cf4e" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">监控一切</h1><p id="c2c5" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">适当的监控将告诉您系统在节点故障后是否正常恢复。如果您的应用程序不能处理集群中丢失的spot实例，您需要很快知道。</p><p id="65e2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在您开始使用spot实例时，您可以设置当您的云提供商回收您的一个节点时的电子邮件通知。随着你的系统越来越健壮，你越来越自信，你可能不再需要这些了。</p><p id="6a04" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在AWS上，您可以尝试使用<a class="ae nd" href="https://github.com/mumoshu/kube-spot-termination-notice-handler" rel="noopener ugc nofollow" target="_blank"> Spot终止通知处理程序</a>,它可以在Spot实例终止发生之前得到通知，让您有时间将应用程序重新安排到其他节点上。</p><p id="dd1a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在AWS上，你还应该监控你支付了多少。如果投标价格最终接近按需价格，您可能应该找到另一个实例类型。记住<strong class="ka ir"> Kubernetes会帮你解决这个问题</strong>。拥有8GB内存的3个实例几乎等同于拥有4GB内存的6个实例。放聪明点！</p><h1 id="412d" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">准备替代方法</h1><p id="38b7" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">有提供实例的替代方法。例如，如果您在Amazon Web Services中配置集群，您可以在现收现付模式下准备额外的节点池，并将所需的数量设置为0。如果没有可用的spot实例，您总是可以让Kubernetes切换到其他节点池。</p><h1 id="0488" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">摘要</h1><p id="530b" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">Kubernetes被设计成<strong class="ka ir">抽象节点</strong>的大小，并在节点之间无缝<strong class="ka ir">移动组件。这使得它成为与<strong class="ka ir"> spot实例</strong>一起工作的完美候选。建立在spot实例之上的集群几乎不会比建立在保留的虚拟机上的集群更不可靠。在为您的Kubernetes集群选择节点时，可靠性不应该是您主要关心的问题。你要重点关注<strong class="ka ir">廉价内存和CPU </strong>！这呼应了谷歌的一个基本原则:</strong></p><blockquote class="kx ky kz"><p id="8cd0" class="jy jz kw ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated"><strong class="ka ir">你不需要有足够好软件的可靠硬件！</strong></p></blockquote><p id="6d06" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是请记住<strong class="ka ir">在Kubernetes上运行您的应用程序并不会使它们具有水平可伸缩性</strong>。您的<strong class="ka ir">职责是</strong>确保应用程序的多个副本可以同时运行，并且可以在不中断连接的情况下优雅地关闭。更重要的是，积极测试你的可用性是非常关键的。</p><p id="2c77" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择点实例将迫使你在削减开支的同时进行某种程度的混沌工程。如果你还没有跟上潮流，你现在就应该尝试一下！</p><p id="4c19" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您喜欢这篇文章，您可能会发现下面的文章很有趣:</p><ul class=""><li id="0329" class="ld le iq ka b kb kc kf kg kj lf kn lg kr lh kv li lj lk ll bi translated"><a class="ae nd" href="https://learnk8s.io/blog/installing-docker-and-kubernetes-on-windows" rel="noopener ugc nofollow" target="_blank">Windows 10上的Docker和Kubernetes入门</a>在这里，您将亲自动手，在您的Windows环境中安装Docker和Kubernetes。</li><li id="30e0" class="ld le iq ka b kb lm kf ln kj lo kn lp kr lq kv li lj lk ll bi translated"><a class="ae nd" href="http://learnk8s.io/blog/scaling-spring-boot-microservices/" rel="noopener ugc nofollow" target="_blank">利用消息队列、Spring Boot和Kubernetes扩展微服务</a>。了解如何使用水平窗格自动缩放器来动态调整应用程序群的大小。</li></ul></div></div>    
</body>
</html>