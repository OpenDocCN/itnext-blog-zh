<html>
<head>
<title>Running Kafka command-line tools</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">运行Kafka命令行工具</h1>
<blockquote>原文：<a href="https://itnext.io/running-kafka-command-line-tools-867a77a33afd?source=collection_archive---------2-----------------------#2020-12-09">https://itnext.io/running-kafka-command-line-tools-867a77a33afd?source=collection_archive---------2-----------------------#2020-12-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d7ea" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">事件流身份验证和授权</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2afa439b02d44f51e6bf37361daa83c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dOoB9rd3O3vpJhee.jpg"/></div></div></figure><p id="9b22" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Kafka提供了一套丰富的命令行工具来管理主题和集群。最新IBM事件流的默认设置(基于Strimzi操作符)给运行这些工具带来了一些挑战。</p><h2 id="3845" class="lq lr it bd ls lt lu dn lv lw lx dp ly ld lz ma mb lh mc md me ll mf mg mh mi bi translated">代理监听程序</h2><p id="e252" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">当Kafka资源作为操作员部署时，通常会应用强安全配置。请看下面的集群监听器设置摘录</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="a1cd" class="lq lr it mp b gy mt mu l mv mw">listeners:<br/>  external:<br/>    authentication:<br/>      type: scram-sha-512<br/>    type: route<br/>  tls:<br/>    authentication:<br/>      type: tls</span></pre><p id="ad98" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">经纪人将会监听</p><ol class=""><li id="a843" class="mx my it kw b kx ky la lb ld mz lh na ll nb lp nc nd ne nf bi translated">端口9094用于SRAM-SHA-512认证的外部连接。</li><li id="6cda" class="mx my it kw b kx ng la nh ld ni lh nj ll nk lp nc nd ne nf bi translated">用于内部通信的端口9093，其中使用了MTL。这里的m(mutual)表示客户端将对代理进行身份验证，代理也将对客户端进行身份验证。</li></ol><p id="6e5d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">由于只定义了这些侦听器，Kafka命令行常用的普通端口9092将不起作用。</p><h2 id="b522" class="lq lr it bd ls lt lu dn lv lw lx dp ly ld lz ma mb lh mc md me ll mf mg mh mi bi translated">KafkaUser资源—客户端验证和授权</h2><p id="e703" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">由于IBM event streams打开了授权，一旦用户通过了身份验证，就需要授权它对主题、消费者组和Kafka集群执行任何操作。在操作员模型中，这是通过KafkaUser资源实现的。</p><p id="d34e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们创建以下KafkaUser资源</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="c3e6" class="lq lr it mp b gy mt mu l mv mw">apiVersion: eventstreams.ibm.com/v1beta1<br/>kind: KafkaUser<br/>metadata:<br/>  name: super-user-tls<br/>  labels:<br/>    eventstreams.ibm.com/cluster: es<br/>spec:<br/>  authentication:<br/>    type: tls<br/>  authorization:<br/>    type: simple<br/>    acls:<br/>      - resource:<br/>          type: topic<br/>          name: '*'<br/>          patternType: literal<br/>        operation: All<br/>      - resource:<br/>          type: cluster<br/>          name: '*'<br/>          patternType: literal<br/>        operation: All<br/>      - resource:<br/>          type: group<br/>          name: '*'<br/>          patternType: literal<br/>        operation: All</span></pre><p id="667d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">有两个折叠，一个是认证，一个是授权。</p><p id="1416" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">客户端认证</strong></p><p id="baa0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">名为super-user-tls的用户将由mTLS进行身份验证。一旦这个用户被创建，同时，一个同名的秘密将被创建。秘密是这个用户的证书和密钥。看看这个，</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="77a8" class="lq lr it mp b gy mt mu l mv mw">$ kubectl -n eventstreams describe secret super-user-tls<br/>Name:         super-user-tls<br/>Namespace:    eventstreams<br/>Labels:       app.kubernetes.io/instance=super-user-tls<br/>              app.kubernetes.io/managed-by=strimzi-user-operator<br/>              app.kubernetes.io/name=strimzi-user-operator<br/>              app.kubernetes.io/part-of=eventstreams-super-user-tls<br/>              eventstreams.ibm.com/cluster=es<br/>              eventstreams.ibm.com/kind=KafkaUser<br/>Annotations:  &lt;none&gt;</span><span id="d3a1" class="lq lr it mp b gy nl mu l mv mw">Type:  Opaque</span><span id="49a7" class="lq lr it mp b gy nl mu l mv mw">Data<br/>====<br/>user.p12:       2402 bytes<br/>user.password:  12 bytes<br/>ca.crt:         1164 bytes<br/>user.crt:       1017 bytes<br/>user.key:       1704 bytes</span></pre><p id="aab3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们打印出用户证书</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="f417" class="lq lr it mp b gy mt mu l mv mw">$ kubectl -n eventstreams get secret super-user-tls -o jsonpath='{.data.user\.crt}' | base64 -di | openssl x509 -text | head -15</span><span id="d535" class="lq lr it mp b gy nl mu l mv mw">Certificate:<br/>    Data:<br/>        Version: 1 (0x0)<br/>        Serial Number:<br/>            8a:3f:a0:88:9a:cd:bf:78<br/>        Signature Algorithm: sha256WithRSAEncryption<br/>        Issuer: O = io.strimzi, CN = clients-ca v0<br/>        Validity<br/>            Not Before: Dec  8 15:39:15 2020 GMT<br/>            Not After : Dec  8 15:39:15 2021 GMT<br/>        Subject: <strong class="mp iu">CN = super-user-tls</strong><br/>        Subject Public Key Info:<br/>            Public Key Algorithm: rsaEncryption<br/>                RSA Public-Key: (2048 bit)<br/>                Modulus:</span></pre><p id="2c27" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当客户端试图通过代理使用此证书进行身份验证时，由于作为客户端CA的签名者受到代理的信任，因此由客户端CA签名的证书将会成功通过身份验证。该用户将被标识为CN名称super-user-tls。</p><p id="f3fb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">另一方面，经纪人的证书也必须经过验证，因为它是双向的。为此，必须将另一个CA(集群CA)呈现给客户端工具，以便客户端可以基于该CA验证代理的证书。</p><p id="6b38" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">客户授权</strong></p><p id="dace" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">KafkaUser资源的另一半是分配给该用户的授权。Kafka主题、消费群和集群都有非常精细的ACL控制。例如，主题有读、写、创建、描述等操作。</p><p id="653d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">出于测试目的，让我们通过将资源名称设置为*并将操作设置为all来创建一个拥有所有权限的超级用户。</p><h2 id="196a" class="lq lr it bd ls lt lu dn lv lw lx dp ly ld lz ma mb lh mc md me ll mf mg mh mi bi translated">Kafka命令行工具的K8s部署</h2><p id="944f" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">让我们创建一个K8s部署，在一个独立的pod而不是代理中运行Kafka命令行工具。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="39fd" class="lq lr it mp b gy mt mu l mv mw">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: kcmd<br/>  namespace: eventstreams<br/>  labels:<br/>    app: kcmd<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: kcmd<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: kcmd<br/>    spec:<br/>      containers:<br/>      - name: kcmd<br/>        image: cp.icr.io/cp/ibm-eventstreams-kafka@sha256:d116a3c77b2290bc9fb7dfe54ceda9ce4df46853d3446a0bfb1f114eab555763<br/>        command:<br/>        - sh<br/>        - -c<br/>        - while true; do sleep 100; done<br/>        volumeMounts:<br/>        - name: certs<br/>          mountPath: /certs<br/>        - name: cluster-ca<br/>          mountPath: /clusterCA</span><span id="4991" class="lq lr it mp b gy nl mu l mv mw">      volumes:<br/>      - name: certs<br/>        secret:<br/>          secretName: super-user-tls<br/>      - name: cluster-ca<br/>        secret:<br/>          secretName: es-cluster-ca-cert</span></pre><p id="6e19" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">使用与所有Kafka命令行工具都可用的代理相同的图像。容器命令只是一个等待的虚拟睡眠循环，我们可以执行pods来运行实际的Kafka工具。</p><p id="c17e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意安装在豆荚里的秘密。第一个是用户的证书密码，pkcs12格式可用。证书将由信任客户端CA的代理进行身份验证。另一方面，为了验证代理的证书，集群CA必须安装到pod中。</p><p id="631f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Exec进入pod，使用以下命令创建属性文件，</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="a8c8" class="lq lr it mp b gy mt mu l mv mw">echo security.protocol=SSL &gt; /tmp/ssl.properties</span><span id="358c" class="lq lr it mp b gy nl mu l mv mw">echo ssl.truststore.type=PKCS12 &gt;&gt; /tmp/ssl.properties<br/>echo ssl.truststore.location=/clusterCA/ca.p12 &gt;&gt; /tmp/ssl.properties<br/>echo ssl.truststore.password=$(cat /clusterCA/ca.password) &gt;&gt; /tmp/ssl.properties</span><span id="b68f" class="lq lr it mp b gy nl mu l mv mw">echo ssl.keystore.type=PKCS12 &gt;&gt; /tmp/ssl.properties<br/>echo ssl.keystore.location=/certs/user.p12 &gt;&gt; /tmp/ssl.properties<br/>echo ssl.keystore.password=$(cat /certs/user.password)  &gt;&gt; /tmp/ssl.properties</span></pre><p id="96eb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这个属性文件将作为参数提供给不同的Kafka命令行工具。下面显示了一个示例，</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="a0c5" class="lq lr it mp b gy mt mu l mv mw">security.protocol=SSL<br/>ssl.truststore.type=PKCS12<br/>ssl.truststore.location=/clusterCA/ca.p12<br/>ssl.truststore.password=LqEdssNJKmP2<br/>ssl.keystore.type=PKCS12<br/>ssl.keystore.location=/certs/user.p12<br/>ssl.keystore.password=kEH9oqXfRRpa</span></pre><p id="de48" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">keystore是存储用户证书的地方，证书将被发送到代理，以对用户进行相应的认证和授权。信任库用于客户端验证代理的证书。所以使用集群CA。所有证书和密钥都是PKCS12格式。</p><h2 id="7f68" class="lq lr it bd ls lt lu dn lv lw lx dp ly ld lz ma mb lh mc md me ll mf mg mh mi bi translated">运行Kafka工具</h2><p id="a7fd" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">准备好属性文件后，我们就可以运行Kafka命令行工具了</p><p id="d398" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们来描述一个话题，</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="73a0" class="lq lr it mp b gy mt mu l mv mw">export POD=$(oc -n eventstreams get pods | grep Running | grep kcmd | awk '{print $1}')</span><span id="9982" class="lq lr it mp b gy nl mu l mv mw">oc exec -i $POD -- sh -c "bin/kafka-topics.sh --describe --bootstrap-server es-kafka-bootstrap.eventstreams.svc:9093 --topic demo --command-config /tmp/ssl.properties"</span></pre><p id="a73c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">请注意，我们传入了bootstrap-server参数，其中包含bootstrap的K8s服务名和内部TLS端口9093。命令配置被定义到属性文件所在的位置。</p><p id="8e9e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">显示了结果，</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="291b" class="lq lr it mp b gy mt mu l mv mw">Topic: demo PartitionCount: 3 ReplicationFactor: 3 Configs: min.insync.replicas=2,retention.ms=604800000,message.format.version=2.6-IV0<br/> Topic: demo Partition: 0 Leader: 2 Replicas: 2,1,0 Isr: 2,1,0<br/> Topic: demo Partition: 1 Leader: 1 Replicas: 1,0,2 Isr: 2,0,1<br/> Topic: demo Partition: 2 Leader: 0 Replicas: 0,2,1 Isr: 2,1,0</span></pre><p id="c9cd" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在需要集群操作授权的情况下，我们还可以触发分区领导者的选举，</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="8878" class="lq lr it mp b gy mt mu l mv mw">bin/kafka-leader-election.sh --bootstrap-server es-kafka-bootstrap.eventstreams.svc:9093 --topic demo --partition 0 --election-type preferred --admin.config  /tmp/ssl.properties</span></pre><p id="81fa" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">命令输出如下所示。这并不奇怪，因为领导者应该是这样的。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="51da" class="lq lr it mp b gy mt mu l mv mw">Valid replica already elected for partitions</span></pre><p id="10ba" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果我们重新启动一个代理，而不等待默认的5分钟来进行领导者选举，我们可以在代理启动后强制进行选举，再次运行命令，</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="1901" class="lq lr it mp b gy mt mu l mv mw">Successfully completed leader election (PREFERRED) for partitions demo-0</span></pre></div></div>    
</body>
</html>