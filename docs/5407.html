<html>
<head>
<title>Jenkins: running workers in Kubernetes and Docker images build</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Jenkins:在Kubernetes和Docker映像构建中运行工人</h1>
<blockquote>原文：<a href="https://itnext.io/jenkins-running-workers-in-kubernetes-and-docker-images-build-83299a10f3ca?source=collection_archive---------0-----------------------#2021-02-27">https://itnext.io/jenkins-running-workers-in-kubernetes-and-docker-images-build-83299a10f3ca?source=collection_archive---------0-----------------------#2021-02-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/e8822ba4f0ebc80f9a9c9eb9eda0cc1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NLnZANJaarm5DibG1pA3bg.png"/></div></div></figure><p id="b63f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们有一个Jenkins实例，它在其主机上运行Docker容器中的作业。</p><p id="e59a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最终，我们面临一个问题，即当前的AWS Ec2实例t2.2xlarge (8个CPU，32个RAM)在峰值工作负载期间过载太多——没有足够的CPU时间，没有足够的内存。</p><p id="9c25" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，第一种解决方案可以是继续进行垂直扩展，例如扩展到c5.9large，并继续在主主机上运行构建，或者将一些工作转移到外部工作人员。</p><p id="b2e6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">目前，我们有三名这样的工作人员——Android构建在我们办公室的PC上运行，配备了Android studio，在办公室我们还有一批MacMini for iOS构建，此外我们还有AWS中的额外EC2，供我们的QA团队运行他们的UI自动测试。</p><p id="2dba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们添加在Kubernetes集群中运行作业的功能。</p><p id="2e14" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们正在使用AWS弹性Kubernetes服务，在这篇文章中，我们将检查如何为Jenkins使用<a class="ae kw" href="https://github.com/jenkinsci/kubernetes-plugin" rel="noopener ugc nofollow" target="_blank"> Kubernetes插件</a>。</p><ul class=""><li id="7202" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/jenkins-running-workers-in-kubernetes-and-docker-images-build/#Jenkins-master_spin_up_an_instance" rel="noopener ugc nofollow" target="_blank">詹金斯-主人:旋转一个实例</a></li><li id="6683" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/jenkins-running-workers-in-kubernetes-and-docker-images-build/#Docker_install" rel="noopener ugc nofollow" target="_blank">码头工人安装</a></li><li id="316d" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/jenkins-running-workers-in-kubernetes-and-docker-images-build/#Running_Jenkins_with_Docker" rel="noopener ugc nofollow" target="_blank">用Docker运行Jenkins】</a></li><li id="b1ec" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/jenkins-running-workers-in-kubernetes-and-docker-images-build/#Jenkins_Workers_in_Kubernetes" rel="noopener ugc nofollow" target="_blank">Kubernetes的詹金斯工人</a></li><li id="ba14" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/jenkins-running-workers-in-kubernetes-and-docker-images-build/#Jenkins_ServiceAccount" rel="noopener ugc nofollow" target="_blank">詹金斯服务账户</a></li><li id="f0a6" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/jenkins-running-workers-in-kubernetes-and-docker-images-build/#Jenkins_ServiceAccount_and_kubeconfig" rel="noopener ugc nofollow" target="_blank"> Jenkins ServiceAccount和kubeconfig </a></li><li id="d123" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/jenkins-running-workers-in-kubernetes-and-docker-images-build/#Jenkins_Kubernetes_Credentials" rel="noopener ugc nofollow" target="_blank">詹金斯·库伯内特的全权证书</a></li><li id="a4d4" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/jenkins-running-workers-in-kubernetes-and-docker-images-build/#Jenkins_Slaves_Pod_Template" rel="noopener ugc nofollow" target="_blank">詹金斯奴隶舱模板</a></li><li id="634a" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/jenkins-running-workers-in-kubernetes-and-docker-images-build/#Jenkins_Job" rel="noopener ugc nofollow" target="_blank">詹金斯的工作</a></li><li id="52d6" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/jenkins-running-workers-in-kubernetes-and-docker-images-build/#Docker_in_Docker_via_Docker_in_Kubernetes" rel="noopener ugc nofollow" target="_blank">库贝内特斯</a>码头工人</li></ul><h1 id="eb44" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">詹金斯大师:旋转一个实例</h1><p id="d7de" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">出于测试目的，让我们用Ubuntu 20.04创建一个专用的AWSес2，在那里添加一个Docker并设置一个Jenkins主实例。</p><h2 id="24a4" class="mo lm iq bd ln mp mq dn lr mr ms dp lv kj mt mu lz kn mv mw md kr mx my mh mz bi translated">Docker安装</h2><p id="ea81" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">创建一个ес2，用SSH连接，安装Docker:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="0c93" class="mo lm iq nf b gy nj nk l nl nm">root@ip-10–0–4–6:/home/ubuntu# apt update &amp;&amp; apt -y upgrade<br/>root@ip-10–0–4–6:/home/ubuntu# curl <a class="ae kw" href="https://get.docker.com/" rel="noopener ugc nofollow" target="_blank">https://get.docker.com/</a> | bash</span></pre><p id="b6ee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">和Docker作曲。</p><p id="280b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Github上找到<a class="ae kw" href="https://github.com/docker/compose/releases" rel="noopener ugc nofollow" target="_blank">最新版本</a>，写的时候是<a class="ae kw" href="https://github.com/docker/compose/releases/tag/1.28.4" rel="noopener ugc nofollow" target="_blank"> 1.28.4 </a>，下载:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="8d54" class="mo lm iq nf b gy nj nk l nl nm">root@ip-10–0–4–6:/home/ubuntu# curl -L “https://github.com/docker/compose/releases/download/1.28.4/docker-compose-$(uname -s)-$(uname -m)” -o /usr/local/bin/docker-compose]</span><span id="8d85" class="mo lm iq nf b gy nn nk l nl nm">root@ip-10–0–4–6:/home/ubuntu# chmod +x /usr/local/bin/docker-compose</span><span id="0a2c" class="mo lm iq nf b gy nn nk l nl nm">root@ip-10–0–4–6:/home/ubuntu# docker-compose — version<br/>docker-compose version 1.28.4, build cabd5cfb</span></pre><h2 id="fce5" class="mo lm iq bd ln mp mq dn lr mr ms dp lv kj mt mu lz kn mv mw md kr mx my mh mz bi translated">用Docker运行Jenkins</h2><p id="5ab4" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">在主机上创建一个目录来存储Jenkins的数据:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="f649" class="mo lm iq nf b gy nj nk l nl nm">root@ip-10–0–4–6:/home/ubuntu# mkdir jenkins_home</span></pre><p id="542d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">编写Docker撰写文件:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="8ce8" class="mo lm iq nf b gy nj nk l nl nm">version: '3.5'<br/><br/>networks:<br/>  jenkins:<br/>    name: jenkins<br/><br/>services:<br/><br/>  jenkins:<br/>    user: root<br/>    image: jenkins/jenkins:2.249.3<br/>     <br/>    networks:<br/>      - jenkins<br/>    ports:<br/>      - '8080:8080'<br/>      - '50000:50000'<br/>    volumes:<br/>      - /home/ubuntu/jenkins_home/:/var/lib/jenkins<br/>      - /var/run/docker.sock:/var/run/docker.sock<br/>      - /usr/bin/docker:/usr/bin/docker<br/>      - /usr/lib/x86_64-linux-gnu/libltdl.so.7:/usr/lib/x86_64-linux-gnu/libltdl.so.7<br/>    environment:<br/>      - JENKINS_HOME=/var/lib/jenkins<br/>      - JAVA_OPTS=-Duser.timezone=Europe/Kiev<br/>    logging:<br/>      driver: "journald"</span></pre><p id="3295" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行实例:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="8d7d" class="mo lm iq nf b gy nj nk l nl nm">root@ip-10–0–4–6:/home/ubuntu# docker-compose -f jenkins-compose.yaml up</span></pre><p id="4372" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在浏览器中打开其URL:</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/699a031b90cb84d76f8216382540eadd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mpLYJYQBsn83BBdm.png"/></div></div></figure><p id="607b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="np">管理员密码</em>可以在启动时的Docker Compose输出中找到，也可以在容器中的<code class="fe nq nr ns nf b">/var/lib/jenkins/secrets/initialAdminPassword</code>文件中获得:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="be96" class="mo lm iq nf b gy nj nk l nl nm">root@ip-10–0–4–6:/home/ubuntu# docker exec -ti ubuntu_jenkins_1 cat /var/lib/jenkins/secrets/initialAdminPassword<br/>15d***730</span></pre><p id="2782" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">登录，运行初始安装:</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/0c3fa1f4579c473b21854cfdd022a8bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MgaYdnBmiimL--54.png"/></div></div></figure><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/25379f93656dda4f250bf08d19ff6fd7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*u8lNNhCQRMJMC6HC.png"/></div></div></figure><p id="9a6d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建用户:</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/d78b73e86b944b07cf7b5b4aa3440b11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/format:webp/0*9xKSyYzbxvAzj8Up.png"/></div></figure><p id="3091" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成它并进入插件。</p><h1 id="6327" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">Kubernetes的詹金斯工人</h1><p id="a2aa" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">找到Kubernetes插件:</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/102ecc4278e20d1fb7f7dc803027bd99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VJjMhEc86186aLcw.png"/></div></div></figure><p id="a6a4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">安装后进入<em class="np">管理节点和云</em> &gt; <em class="np">配置云</em>:</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nx"><img src="../Images/17cdefdb9c96073b0d26463241232411.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jGWBvWfZgRbkg_0D.png"/></div></div></figure><p id="55a1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查Kubernetes:</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/5d64c99cc5610e66c95faf17df3efb29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1382/format:webp/0*ljFCzTGn1rT9rMp8.png"/></div></figure><p id="19da" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">设置集群API服务器的URL和名称空间:</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/0f58f8e93a1d73a3cb4e9b16ebb66625.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YQOUfxCTC8X9WXoN.png"/></div></div></figure><h2 id="7814" class="mo lm iq bd ln mp mq dn lr mr ms dp lv kj mt mu lz kn mv mw md kr mx my mh mz bi translated">詹金斯服务帐户</h2><p id="a99c" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">在集群中，创建一个命名空间和ServiceAccount，Jenkins将使用它们进行授权。</p><p id="7d44" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在生产设置中，最好通过附加了IAM-role的<a class="ae kw" href="https://rtfm.co.ua/en/aws-iam-users-keys-rotation-ec2-iam-roles-and-jenkins/" rel="noopener ugc nofollow" target="_blank"> EC2实例概要文件</a>来配置访问。</p><p id="1b3d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，在我们的<em class="np">dev-1–18-devo PS-Jenkins-slaves-ns</em>名称空间中添加一个映射到<a class="ae kw" href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#user-facing-roles" rel="noopener ugc nofollow" target="_blank">默认管理角色</a>的<a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-part-5-rbac-authorization-with-a-role-and-rolebinding-example/" rel="noopener ugc nofollow" target="_blank"> Kubernetes RoleBinding </a>(或者创建您自己的角色——这里的管理只是为了简单起见，因为这是一个PoC设置):</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="350e" class="mo lm iq nf b gy nj nk l nl nm">---<br/>apiVersion: v1<br/>kind: Namespace<br/>metadata:<br/>  name: dev-1-18-devops-jenkins-slaves-ns<br/>---<br/>apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: jenkins-slaves-service-account<br/>  namespace: dev-1-18-devops-jenkins-slaves-ns<br/>---<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: RoleBinding<br/>metadata:<br/>  name: jenkins-slaves-rolebinding<br/>  namespace: dev-1-18-devops-jenkins-slaves-ns<br/>roleRef:<br/>  apiGroup: rbac.authorization.k8s.io<br/>  kind: ClusterRole<br/>  name: admin<br/>subjects:                                                                                                                                                                     <br/>- kind: ServiceAccount                                                                                                                                                        <br/>  name: jenkins-slaves-service-account<br/>  namespace: dev-1-18-devops-jenkins-slaves-ns</span></pre><p id="4628" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署它:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="db6c" class="mo lm iq nf b gy nj nk l nl nm">$ kubectl apply -f jenkins-slaves-sa.yaml<br/>namespace/dev-1–18-devops-jenkins-slaves-ns created<br/>serviceaccount/jenkins-slaves-service-account created<br/>rolebinding.rbac.authorization.k8s.io/jenkins-slaves-rolebinding created</span></pre><h2 id="d145" class="mo lm iq bd ln mp mq dn lr mr ms dp lv kj mt mu lz kn mv mw md kr mx my mh mz bi translated">詹金斯服务帐户和kubeconfig</h2><p id="e3c8" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">接下来要做的是生成一个<a class="ae kw" href="https://rtfm.co.ua/kubernetes-kubectl-i-kubeconfig-obzor-fajla-dobavlenie-klastera-polzovatelya-i-konteksta/" rel="noopener ugc nofollow" target="_blank"> kubeconfig </a>，它将使用这个ServiceAccount。</p><p id="b7ef" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为此，我们需要获得一个EKS集群ARN、它的证书颁发机构、API服务器的地址以及ServiceAccount的一个<a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-serviceaccounts-jwt-tokens-authentication-and-rbac-authorization/" rel="noopener ugc nofollow" target="_blank"> JWT令牌</a>。</p><p id="5097" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">查找为您的服务帐户创建的密码:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="e6f8" class="mo lm iq nf b gy nj nk l nl nm">$ kubectl -n dev-1–18-devops-jenkins-slaves-ns get sa jenkins-slaves-service-account -o jsonpath=’{.secrets[0].name}’<br/>jenkins-slaves-service-account-token-jsbb7</span></pre><p id="0681" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">可以在AWS控制台中获取证书颁发机构和集群ARN:</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/3e69cd0fbf05328f8eeee60449759e94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*59tDyOavIZIv_uV1.png"/></div></div></figure><p id="8719" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从秘密中获取令牌，用<code class="fe nq nr ns nf b">base64</code>解密:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="5a70" class="mo lm iq nf b gy nj nk l nl nm">$ kubectl -n dev-1–18-devops-jenkins-slaves-ns get secret jenkins-slaves-service-account-token-jsbb7 -o jsonpath=’{.data.token}’ | base64 --decode<br/>eyJ…s7w</span></pre><p id="d900" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">编写一个<a class="ae kw" href="https://rtfm.co.ua/kubernetes-kubectl-i-kubeconfig-obzor-fajla-dobavlenie-klastera-polzovatelya-i-konteksta/" rel="noopener ugc nofollow" target="_blank"> kubeconfig </a>，例如一个<code class="fe nq nr ns nf b">jenkins-dev-1-18-kubeconfig.yaml</code>文件:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="1ce2" class="mo lm iq nf b gy nj nk l nl nm">apiVersion: v1<br/>clusters:<br/>- cluster:<br/>    certificate-authority-data: LS0...LQo=<br/>    server: <a class="ae kw" href="https://676***892.gr7.us-east-2.eks.amazonaws.com" rel="noopener ugc nofollow" target="_blank">https://676***892.gr7.us-east-2.eks.amazonaws.com</a><br/>  name: arn:aws:eks:us-east-2:534***385:cluster/bttrm-eks-dev-1-18<br/>contexts:<br/>- context:<br/>    cluster: arn:aws:eks:us-east-2:534***385:cluster/bttrm-eks-dev-1-18<br/>    user: jenkins-slaves-service-account<br/>    namespace: dev-1-18-devops-jenkins-slaves-ns<br/>  name: jenkins-slaves-service-account@bttrm-dev-1-18<br/>current-context: jenkins-slaves-service-account@bttrm-dev-1-18<br/>kind: Config<br/>users:<br/>- name: jenkins-slaves-service-account<br/>  user:<br/>    token: ZXl...N3c=</span></pre><p id="546a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查它是否工作:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="d1ce" class="mo lm iq nf b gy nj nk l nl nm">$ kubectl -n dev-1–18-devops-jenkins-slaves-ns --kubeconfig ../jenkins-dev-1–18-kubeconfig.yaml auth can-i get pod<br/>yes</span></pre><h2 id="386c" class="mo lm iq bd ln mp mq dn lr mr ms dp lv kj mt mu lz kn mv mw md kr mx my mh mz bi translated">Jenkins Kubernetes证书</h2><p id="dc6c" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">回到詹金斯那里，添加一个新的<em class="np">凭证</em>:</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/2c1bb11c554d6d663cf0ebefa7d43dfc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*j-074xq1NAfTM_oS.png"/></div></div></figure><figure class="na nb nc nd gt jr gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/983b4e6a507444a295abee9159f5b4a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1230/format:webp/0*Kv-AFWU2fDxzELnR.png"/></div></figure><p id="0cbe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查其连接—点击<em class="np">测试连接</em>，必须看到<em class="np">连接到Kubernetes 1.18+ </em>消息:</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/bf147225f2aa0bb476c9dbd6f8ca8157.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WkfqG9XxJYf_yDNg.png"/></div></div></figure><p id="9da7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">保存设置。</p><h2 id="4cde" class="mo lm iq bd ln mp mq dn lr mr ms dp lv kj mt mu lz kn mv mw md kr mx my mh mz bi translated">Jenkins Slaves Pod模板</h2><p id="ad58" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">转到<em class="np"> Pod模板</em>:</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oe"><img src="../Images/82fb7c3dcbe7723e0d5f0dd80c594c04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wD_IJshyj-Qe73Gj.png"/></div></div></figure><p id="283f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">填充pod及其默认容器的字段，将<code class="fe nq nr ns nf b">jenkinsci/jnlp-slave</code>设置为Docker图像:</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi of"><img src="../Images/3ff0e74657f36703683e435982ae9afd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MZI9yAAKPYjo34Iv.png"/></div></div></figure><h2 id="64fa" class="mo lm iq bd ln mp mq dn lr mr ms dp lv kj mt mu lz kn mv mw md kr mx my mh mz bi translated">詹金斯工作</h2><p id="09e4" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">使用<em class="np">管道</em>类型创建一个测试作业:</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div class="gh gi og"><img src="../Images/7383af0dd92700cbf22b2905fe9db7ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/0*GeUHIDBsyu7hY_n4.png"/></div></figure><p id="6e45" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">编写管道脚本:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="7dce" class="mo lm iq nf b gy nj nk l nl nm">podTemplate {<br/>    node(POD_LABEL) {<br/>        stage('Run shell') {<br/>            sh 'echo hello world'<br/>        }<br/>    }<br/>}</span></pre><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oh"><img src="../Images/e6782837a1ff3149d1313380912ae433.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DVSqSCLw1aI9g7a2.png"/></div></div></figure><p id="5966" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行作业并检查Jenkins的日志:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="0def" class="mo lm iq nf b gy nj nk l nl nm">…<br/>jenkins_1 | 2021–02–26 08:36:32.226+0000 [id=277] INFO hudson.slaves.NodeProvisioner#lambda$update$6: k8s-1-b5j7g-glscn-v0tfz provisioning successfully completed. We have now 2 computer(s)<br/>jenkins_1 | 2021–02–26 08:36:32.522+0000 [id=276] INFO o.c.j.p.k.KubernetesLauncher#launch: Created Pod: dev-1–18-devops-jenkins-slaves-ns/k8s-1-b5j7g-glscn-v0tfz<br/>…</span></pre><p id="8b40" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个豆荚正在库伯内特星团里创造:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="a743" class="mo lm iq nf b gy nj nk l nl nm">$ kubectl --kubeconfig ../jenkins-dev-1–18-kubeconfig.yaml get pod<br/>NAME READY STATUS RESTARTS AGE<br/>k8s-1-b5j7g-glscn-v0tfz 0/1 ContainerCreating 0 12s</span></pre><p id="efb6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">作业完成:</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oi"><img src="../Images/5c90bb0045a8d18b095bb6cf3c5970eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dfNWqSYmb6eaVMcM.png"/></div></div></figure><h1 id="65d5" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">码头工人在码头工人通过码头工人在Kubernetes</h1><p id="f1eb" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">我们的Jenkins作为Docker容器运行，它在Docker容器内部运行它的构建。这是我长期以来使用的一个好方法，因为它给了我们一个不在主机系统上安装库的机会，以更可控的方式来设置构建环境，并且我们的开发人员可以按照他们的意愿来配置它们。</p><p id="48f9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以，现在我们需要认识到这一点——但是是在库伯内特药膏上。</p><p id="e655" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将<a class="ae kw" href="https://plugins.jenkins.io/docker-workflow/" rel="noopener ugc nofollow" target="_blank"> Docker管道插件</a>安装到Jenkins上；</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oj"><img src="../Images/d8e027ad2f03fcedd2cdf188e3a8bc41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gMoDVh7e-OUOF_k7.png"/></div></div></figure><p id="0df3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并创建新的管道</p><p id="69ea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里我们需要另一个Docker图像— <code class="fe nq nr ns nf b"><a class="ae kw" href="https://hub.docker.com/_/docker?tab=tags&amp;page=1&amp;ordering=last_updated&amp;name=dind" rel="noopener ugc nofollow" target="_blank">docker.dind</a></code>，为此，我们需要另一个pod的模板。</p><p id="fdfa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以像我们之前一样通过Jenkins UI创建它，或者我们可以使用<code class="fe nq nr ns nf b"><a class="ae kw" href="https://github.com/jenkinsci/kubernetes-plugin#pod-and-container-template-configuration" rel="noopener ugc nofollow" target="_blank">podTemplate</a></code>直接在管道中描述它。</p><p id="9a1d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，让我们构建一个NGINX映像:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="e03f" class="mo lm iq nf b gy nj nk l nl nm">podTemplate(yaml: '''<br/>apiVersion: v1<br/>kind: Pod<br/>spec:<br/>  containers:<br/>  - name: docker<br/>    image: docker:19.03.1-dind<br/>    securityContext:<br/>      privileged: true<br/>    env:<br/>      - name: DOCKER_TLS_CERTDIR<br/>        value: ""<br/>''') {<br/>    node(POD_LABEL) {<br/>        git 'https://github.com/nginxinc/docker-nginx.git'<br/>        container('docker') {<br/>            sh 'docker version &amp;&amp; cd stable/alpine/ &amp;&amp; docker build -t nginx-example .'<br/>        }<br/>    }<br/>}</span></pre><p id="8aea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并运行作业:</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/271d87536555ba2b2a0b9645b24bb607.png" data-original-src="https://miro.medium.com/v2/resize:fit:1370/format:webp/0*YipmTTeLTYOL4_ZC.png"/></div></figure><figure class="na nb nc nd gt jr gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/dd64edc40f7fb9b59511b67da87e91b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/0*OfjWG7iqcXQSMz-E.png"/></div></figure><p id="c34f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成了。</p><h1 id="3fb6" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">有用的链接</h1><ul class=""><li id="1c4d" class="kx ky iq ka b kb mj kf mk kj om kn on kr oo kv lc ld le lf bi translated"><a class="ae kw" href="https://github.com/jenkinsci/kubernetes-plugin/tree/master/examples" rel="noopener ugc nofollow" target="_blank"> Kubernetes插件管道示例</a></li><li id="ffd8" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://pushbuildtestdeploy.com/jenkins-on-kubernetes-building-docker-images/" rel="noopener ugc nofollow" target="_blank">Kubernetes 上的 Jenkins —— 构建 Docker 映像(T1)</a></li></ul></div><div class="ab cl op oq hu or" role="separator"><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou"/></div><div class="ij ik il im in"><p id="c8e4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="np"> RTFM: Linux、DevOps 和系统管理 </em>  <em class="np">(T9 )</em></p></div></div>    
</body>
</html>