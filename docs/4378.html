<html>
<head>
<title>Stripe, React and Serverless — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">条带化、反应式和无服务器—第1部分</h1>
<blockquote>原文：<a href="https://itnext.io/stripe-react-and-serverless-part-1-3482e9332b4c?source=collection_archive---------5-----------------------#2020-06-19">https://itnext.io/stripe-react-and-serverless-part-1-3482e9332b4c?source=collection_archive---------5-----------------------#2020-06-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/18e3c010f3badbd04dbe751879e298ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UlKnSsK1YwOqksWfptj2bg.png"/></div></div></figure><div class=""/><p id="bc5d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本系列文章中，我们将讨论如何使用React和无服务器将<a class="ae kw" href="https://sigmetic.io" rel="noopener ugc nofollow" target="_blank"> Sigmetic </a>与Stripe集成。</p><p id="2d2b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在第1部分中，我们将使用<a class="ae kw" href="https://www.serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器</a>实现后端。<br/>在<a class="ae kw" href="https://sigmetic.io/blog/stripe-react-serverless-part2" rel="noopener ugc nofollow" target="_blank">第二部</a>中，我们将使用<a class="ae kw" href="https://stripe.com/en-dk/payments/elements" rel="noopener ugc nofollow" target="_blank">条纹元素</a>在React中集成前端。</p><p id="2ab4" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请记住，这可以通过多种方式实现，并且取决于特定的目的。</p><p id="b2dc" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于<a class="ae kw" href="https://sigmetic.io" rel="noopener ugc nofollow" target="_blank"> Sigmetic </a>，我们使用的设置包括:</p><ul class=""><li id="97c5" class="kx ky jb ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">经常性支付(即订阅模式)。</li><li id="c41b" class="kx ky jb ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">AWS Lambda使用<a class="ae kw" href="https://www.serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器</a>代理条带化请求</li><li id="f2ff" class="kx ky jb ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">使用<a class="ae kw" href="https://stripe.com/en-dk/payments/elements" rel="noopener ugc nofollow" target="_blank">条带元素</a>在React中收集支付信息</li><li id="f924" class="kx ky jb ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">我们在前端和后端都使用TypeScript。</li></ul><p id="fe44" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你正在寻找一个与上面类似的设置，你可能想继续阅读😎</p><h1 id="5514" class="ll lm jb bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">先决条件</h1><p id="705b" class="pw-post-body-paragraph jy jz jb ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated"><strong class="ka jc">在条带上创建账户</strong></p><p id="7c13" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您需要做的第一件事是在<a class="ae kw" href="https://stripe.com/" rel="noopener ugc nofollow" target="_blank"> Stripe </a>上创建一个帐户。<br/>您需要通过验证过程才能获得您的API密钥。这可能需要一两天的时间。</p><p id="eef0" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">用无服务器设置云功能</strong></p><p id="d88d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您需要使用无服务器为您的云功能创建一个设置。<br/> <a class="ae kw" href="https://sigmetic.io" rel="noopener ugc nofollow" target="_blank"> Sigmetic </a>托管在AWS上，使用的是Lambdas。但是你可以自由使用任何你喜欢的兼容无服务器的云提供商。</p><p id="17bb" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://www.serverless.com/framework/docs/getting-started/" rel="noopener ugc nofollow" target="_blank">看这里如何入门</a>。</p><h1 id="1349" class="ll lm jb bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">概观</h1><p id="2b4e" class="pw-post-body-paragraph jy jz jb ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">我们需要处理一系列案例，对于每一个案例，我们都需要一个云功能。</p><ul class=""><li id="c93c" class="kx ky jb ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">创建客户</li><li id="fb2a" class="kx ky jb ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">创建订阅</li><li id="f894" class="kx ky jb ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">处理订阅(例如取消或继续)</li><li id="e23e" class="kx ky jb ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">检索订阅</li><li id="5dc0" class="kx ky jb ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">检索付款方式</li><li id="cca9" class="kx ky jb ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">更新付款方式</li><li id="aa71" class="kx ky jb ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">重试发票付款</li><li id="58ad" class="kx ky jb ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">条纹网钩</li></ul><p id="da6b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">听起来很多，对吧？😩一旦你投入进去，它实际上没那么糟糕。</p><p id="4ca8" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将解释每一种情况，并提供设置它的代码💪所以，请和我们多呆一会儿，你很快就会有一个全新的Stripe！</p><h1 id="c0c9" class="ll lm jb bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">云函数</h1><p id="34fc" class="pw-post-body-paragraph jy jz jb ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">让我们开始创建我们的无服务器后端。我们将首先检查所有的云功能，然后我们将整个事情与前端集成。</p><p id="2a62" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">安装来自NPM的条纹</strong></p><p id="33dc" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">假设您已经建立了一个无服务器项目；从安装来自NPM的<code class="fe mo mp mq mr b">stripe</code>开始。</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="543c" class="na lm jb mr b gy nb nc l nd ne">npm install stripe</span></pre><p id="9d0d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如何构建文件夹并不重要，但是我们在<code class="fe mo mp mq mr b">src/lambdas/stripe/</code>中为所有的Stripe函数创建了一个文件夹。<br/>因为我们使用了TypeScript，所以我们可以在<code class="fe mo mp mq mr b">dist/lambdas/stripe/</code>中引用传输的js文件。</p><p id="4ea5" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">创建API密钥</strong></p><p id="c563" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您还需要转到您的Stripe <em class="nf">仪表板- &gt;开发人员- &gt; API密钥</em>并创建一组新的API密钥。</p><blockquote class="ng nh ni"><p id="7923" class="jy jz nf ka b kb kc kd ke kf kg kh ki nj kk kl km nk ko kp kq nl ks kt ku kv ij bi translated"><em class="jb"> ℹ️ </em>在开发过程中，轻触Stripe仪表盘中的“查看测试数据”开关</p></blockquote><p id="bcd7" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于云函数，我们将使用<em class="nf">密钥</em>。</p><h1 id="0ff0" class="ll lm jb bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><strong class="ak">创建客户</strong></h1><blockquote class="ng nh ni"><p id="379c" class="jy jz nf ka b kb kc kd ke kf kg kh ki nj kk kl km nk ko kp kq nl ks kt ku kv ij bi translated">客户对象允许您执行重复性收费，并跟踪与同一客户关联的多项收费。API允许您创建、删除和更新您的客户。您可以检索单个客户以及所有客户的列表。— <a class="ae kw" href="https://stripe.com/docs/api/customers" rel="noopener ugc nofollow" target="_blank">条纹文档</a></p></blockquote><p id="7fa0" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个新文件<code class="fe mo mp mq mr b">src/lambda/stripe/createCustomer.ts</code></p><p id="8940" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe mo mp mq mr b">serverless.yml</code>文件中添加函数:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="797c" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在文件<code class="fe mo mp mq mr b">src/lambda/stripe/createCustomer.ts</code>中，让我们从实例化Stripe开始:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="18fe" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，这个函数将在POST请求中被调用，所以让我们为我们的主体定义一个接口。我们希望正文包含电子邮件和用户名:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="6e8f" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，让我们定义我们的处理程序:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="39ee" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好了💪<br/>部署您的新云功能，尝试对指定的端点执行POST请求，并验证它是否创建了新的Stripe客户。</p><p id="b8c7" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您将能够在您的条带<em class="nf">仪表盘- &gt;客户中看到新客户。</em></p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="0c66" class="na lm jb mr b gy nb nc l nd ne">curl --header "Content-Type: application/json" \<br/>  --request POST \<br/>  --data '{"email": "<a class="ae kw" href="mailto:test@test.com" rel="noopener ugc nofollow" target="_blank">test@test.com</a>", "username":"Test McTest"}' \<br/>  <a class="ae kw" href="https://your-endpoint/stripe/create-customer" rel="noopener ugc nofollow" target="_blank">https://your-endpoint/stripe/create-customer</a></span></pre><h1 id="0e0e" class="ll lm jb bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><strong class="ak">创建订阅</strong></h1><p id="db4c" class="pw-post-body-paragraph jy jz jb ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">接下来，您将定义一个用于创建新订阅的函数。为此，你需要一个条纹产品。<br/>转到您的条带<em class="nf">仪表板- &gt;产品- &gt;添加产品</em> <br/>一旦您创建了一个产品，转到并获取该产品的<em class="nf">价格ID </em>。我们将在这个功能中使用它。</p><p id="35d1" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个新文件<code class="fe mo mp mq mr b">src/lambda/stripe/createSubscription.ts</code></p><p id="c810" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在文件<code class="fe mo mp mq mr b">serverless.yml</code>中添加函数:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="f805" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在文件<code class="fe mo mp mq mr b">src/lambda/stripe/createSubscription.ts</code>中，我们再次实例化Stripe:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="e113" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">指定几何体的接口:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="154b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，定义处理程序:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="541e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这一个，我们不能简单地用POST请求来测试，但是我们稍后集成前端时会回到这个问题。</p><h1 id="03c9" class="ll lm jb bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><strong class="ak">处理订阅</strong></h1><p id="bccf" class="pw-post-body-paragraph jy jz jb ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">通常，您希望为客户提供取消订阅的能力。<br/>订阅将在当前计费周期结束后终止。<br/>与此同时，客户可以继续订购，一切都会恢复原样。</p><p id="687b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用Stripe，我们可以简单地标记订阅是否将在当前计费期后结束。</p><p id="a1fb" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个新文件<code class="fe mo mp mq mr b">src/lambda/stripe/handleSubscription.ts</code></p><p id="1a57" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在文件<code class="fe mo mp mq mr b">serverless.yml</code>中添加函数:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="6123" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在文件<code class="fe mo mp mq mr b">src/lambda/stripe/handleSubscription.ts</code>中，我们再次实例化Stripe:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="ba05" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">指定几何体的接口:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="a9d0" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，定义处理程序:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="74e6" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个我们可以测试。<br/>去你的条纹<em class="nf">仪表盘- &gt;客户</em>。<br/>点击客户，向下滚动至“订阅”部分。<br/>点击订阅，获取ID。</p><p id="0389" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在部署您的新云功能，并向您定义的端点发出POST请求:</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="98c7" class="na lm jb mr b gy nb nc l nd ne">curl --header "Content-Type: application/json" \<br/>  --request POST \<br/>  --data '{"subscriptionID": "THE-ID-YOU-JUST-FOUND", "end": true}' \<br/>  <a class="ae kw" href="https://your-endpoint/stripe/handle-subscription" rel="noopener ugc nofollow" target="_blank">https://your-endpoint/stripe/handle-subscription</a></span></pre><p id="a40e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">回到您的客户，向下滚动到“订阅”部分。<br/>您应该会看到这样的内容:</p><blockquote class="ng nh ni"><p id="4ebc" class="jy jz nf ka b kb kc kd ke kf kg kh ki nj kk kl km nk ko kp kq nl ks kt ku kv ij bi translated">请注意“取消7月9日”徽章</p></blockquote><figure class="ms mt mu mv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi no"><img src="../Images/51f977b56e31c466225f71b340b988e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-jz9ooP_yLLZtZc6.png"/></div></div></figure><h1 id="1d12" class="ll lm jb bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">检索订阅</h1><p id="9f54" class="pw-post-body-paragraph jy jz jb ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">最后，我们希望能够检索与给定订阅相关联的完整订阅对象。</p><p id="e24f" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个新文件<code class="fe mo mp mq mr b">src/lambda/stripe/retrieveSubscription.ts</code></p><p id="7bc1" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe mo mp mq mr b">serverless.yml</code>文件中添加函数:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="f9c8" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在文件<code class="fe mo mp mq mr b">src/lambda/stripe/retrieveSubscription.ts</code>中，我们再次实例化Stripe:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="7d34" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">指定几何体的接口:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="9c32" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，定义处理程序:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="ad57" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们也可以像之前一样，通过使用订阅ID来轻松测试这一点。<br/>部署云功能后，向您定义的端点发送POST请求:</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="837b" class="na lm jb mr b gy nb nc l nd ne">curl --header "Content-Type: application/json" \<br/>  --request POST \<br/>  --data '{"subscriptionID": "THE-ID-YOU-JUST-FOUND"}' \<br/>  <a class="ae kw" href="https://your-endpoint/stripe/retrieve-subscription" rel="noopener ugc nofollow" target="_blank">https://your-endpoint/stripe/retrieve-subscription</a></span></pre><p id="95a0" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您应该从Stripe获得详细的订阅对象。</p><h1 id="61ef" class="ll lm jb bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">检索付款方式</h1><p id="b225" class="pw-post-body-paragraph jy jz jb ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">同样，对于订阅，我们也希望能够从Stripe中检索支付方法对象。特别是，这对于向顾客显示当前使用的信用卡非常有用。例如显示卡的类型和最后4位数字。</p><p id="4a9e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个新文件<code class="fe mo mp mq mr b">src/lambda/stripe/retrievePaymentMethod.ts</code></p><p id="7b41" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在文件<code class="fe mo mp mq mr b">serverless.yml</code>中添加函数:</p><p id="ad9f" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://gist.github.com/Silind/484d9f466607b83ea9a0c9cecb3c662e" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/Silind/484d 9 f 466607 b 83 ea 9 a 0 c 9 cecb 3c 662 e</a></p><p id="d68b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在文件<code class="fe mo mp mq mr b">src/lambda/stripe/retrievePaymentMethod.ts</code>中，实例化Stripe:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="85b1" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">指定几何体的接口:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="6c2c" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，定义处理程序:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="9405" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">同样，使用订阅ID，在Stripe仪表盘中找到您的客户，并从付款方式中获取付款方式ID。</p><p id="d01c" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署云功能，并向定义的端点发出POST请求:</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="0670" class="na lm jb mr b gy nb nc l nd ne">curl --header "Content-Type: application/json" \<br/>  --request POST \<br/>  --data '{"paymentMethodID": "THE-ID-YOU-JUST-FOUND"}' \<br/>  <a class="ae kw" href="https://your-endpoint/stripe/retrieve-payment-method" rel="noopener ugc nofollow" target="_blank">https://your-endpoint/stripe/retrieve-payment-method</a></span></pre><p id="2c87" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您应该从Stripe获得详细的支付方式对象。</p><h1 id="f3ad" class="ll lm jb bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">更新付款方式</h1><p id="f28d" class="pw-post-body-paragraph jy jz jb ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">你的产品的客户应该能够更新他们的付款方式。</p><p id="ca0c" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个新文件<code class="fe mo mp mq mr b">src/lambda/stripe/updatePaymentMethod.ts</code></p><p id="3bb8" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在文件<code class="fe mo mp mq mr b">serverless.yml</code>中添加函数:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="3ad7" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe mo mp mq mr b">src/lambda/stripe/updatePaymentMethod.ts</code>文件中，实例化Stripe:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="87cf" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">指定几何体的接口:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="8568" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，定义处理程序:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="4685" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用一个简单的POST请求来测试这个问题有点困难，所以我们稍后再来讨论这个问题。</p><h1 id="42d9" class="ll lm jb bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">重试发票付款</h1><p id="a8fb" class="pw-post-body-paragraph jy jz jb ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">这个案例比较特殊。<br/>有时会发生这样的情况，最初接受了一种支付方式(即信用卡有效)，但当该支付方式附加到客户时，就出现了问题。<br/>这可能是因为银行拒绝该流程，或者是因为资金不足。</p><p id="5045" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">结果将是一张失败的发票。<br/>具体来说，订阅对象上有一个字段:<code class="fe mo mp mq mr b">latest_invoice.payment_intent.status</code>，其值为<code class="fe mo mp mq mr b">requires_payment_method</code>。</p><p id="ab03" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当这种情况发生时，在Stripe中成功创建了一个客户和一个订阅，因此我们只是希望让客户用另一张卡重试支付。</p><p id="14b2" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个新文件<code class="fe mo mp mq mr b">src/lambda/stripe/retryInvoice.ts</code></p><p id="443a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在文件<code class="fe mo mp mq mr b">serverless.yml</code>中添加函数:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="1f42" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在文件<code class="fe mo mp mq mr b">src/lambda/stripe/retryInvoice.ts</code>中，实例化Stripe:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="da61" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">指定几何体的接口:</p><p id="fc63" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://gist.github.com/Silind/b5b5230ac08c06c04b36e183a14a59f8" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/si Lind/b5 b 5230 AC 08 c 06 c 04 b 36 e 183 a 14 a 59 f 8</a></p><p id="6456" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，定义处理程序:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><h1 id="486e" class="ll lm jb bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">条纹网钩</h1><p id="8121" class="pw-post-body-paragraph jy jz jb ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">我们最后需要集成的是Stripe的webhooks。<br/> Stripe的支付生命周期非常全面，Stripe允许您参与各种活动。</p><p id="aecf" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于<a class="ae kw" href="https://sigmetic.io" rel="noopener ugc nofollow" target="_blank"> Sigmetic </a>，我们只使用三个:</p><ul class=""><li id="7eec" class="kx ky jb ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated"><code class="fe mo mp mq mr b">invoice.payment_succeeded</code></li><li id="bcc2" class="kx ky jb ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><code class="fe mo mp mq mr b">invoice.payment_failed</code></li><li id="884e" class="kx ky jb ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><code class="fe mo mp mq mr b">customer.subscription.deleted</code></li></ul><p id="9798" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们去为Stripe设置这些webhooks。<br/>Go your Stripe<em class="nf">dashboard-&gt;Developers-&gt;web hooks-&gt;添加端点。</em> <br/>添加您的端点:<code class="fe mo mp mq mr b">https://your-endpoint/stripe/webhooks</code>。添加上面列表中的三个事件。</p><p id="3451" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建时，您可以创建签名密码。我们将在下面使用它。</p><p id="524c" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个新文件<code class="fe mo mp mq mr b">src/lambda/stripe/webhooks.ts</code></p><p id="42bd" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在文件<code class="fe mo mp mq mr b">serverless.yml</code>中添加函数:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="ac8e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe mo mp mq mr b">src/lambda/stripe/webhooks.ts</code>文件中，实例化Stripe:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="45af" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在让我们创建三个函数，每个webhook事件一个。<br/>我们从<code class="fe mo mp mq mr b">invoice.payment_succeeded</code>开始。</p><p id="6832" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">成功处理付款后，将触发此事件。<br/>在<a class="ae kw" href="https://sigmetic.io" rel="noopener ugc nofollow" target="_blank"> Sigmetic </a>，我们要向客户发送一份带有发票链接的确认。</p><p id="794a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还想启用他们的付费功能。</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="7b5a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当一个支付失败时，触发<code class="fe mo mp mq mr b">invoice.payment_failed</code>。<br/>在这种情况下，我们希望向客户发送电子邮件通知他们。</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="4955" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，当订阅结束时，触发<code class="fe mo mp mq mr b">customer.subscription.deleted</code>事件。</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="7d18" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，我们定义一个小的<code class="fe mo mp mq mr b">handlerMapping</code>对象，这样我们就可以快速查找使用上面的哪个函数:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="321a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，我们创建处理程序:</p><figure class="ms mt mu mv gt is"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="86dd" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Webhooks下的Stripe仪表板中，您可以发送测试事件来验证它是否正常工作。<br/>尝试一下😎</p><h1 id="96f5" class="ll lm jb bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">舍入</h1><p id="f8e2" class="pw-post-body-paragraph jy jz jb ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">这基本上是我们后端所需要的。</p><p id="a71b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">确保将所有这些云功能部署到云中，并测试每个端点以验证它们都正常工作。</p><p id="d68c" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可能还注意到了一点冗余:我们在本文中给出了函数的完整示例，但是您可能会从编写一些包装器功能中受益匪浅。</p><p id="184b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下一步是将它与前端集成。</p><p id="f0ff" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<a class="ae kw" href="https://sigmetic.io/blog/stripe-react-serverless-part2" rel="noopener ugc nofollow" target="_blank">第2部分</a>中了解更多信息。</p></div></div>    
</body>
</html>