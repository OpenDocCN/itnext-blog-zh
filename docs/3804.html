<html>
<head>
<title>AWS: CloudFormation — Nested Stacks and stacks parameters Import/Export</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS:cloud formation-嵌套堆栈和堆栈参数导入/导出</h1>
<blockquote>原文：<a href="https://itnext.io/aws-cloudformation-nested-stacks-and-stacks-parameters-import-export-55d517c5008b?source=collection_archive---------0-----------------------#2020-02-29">https://itnext.io/aws-cloudformation-nested-stacks-and-stacks-parameters-import-export-55d517c5008b?source=collection_archive---------0-----------------------#2020-02-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/b4b30a77a45a71ac09b162d997438038.png" data-original-src="https://miro.medium.com/v2/resize:fit:260/format:webp/0*REEcotffXgFuUyvD.png"/></div></figure><p id="90b6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><a class="ae ks" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-nested-stacks.html" rel="noopener ugc nofollow" target="_blank">AWS cloud formation中的嵌套堆栈</a>是使用<code class="fe kt ku kv kw b"><a class="ae ks" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-stack.html" rel="noopener ugc nofollow" target="_blank">AWS::CloudFormation::Stack</a></code>从另一个“父”堆栈创建的堆栈。</p><p id="d01b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">嵌套堆栈背后的主要思想是避免编写多余的代码，并使模板可重用。</p><p id="94ad" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">相反，模板只创建一次，存储在S3桶中，在堆栈创建期间，您只需引用它。</p><p id="cac3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，使用<a class="ae ks" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/conditions-section-structure.html" rel="noopener ugc nofollow" target="_blank">条件</a>，您可以使用同一个模板文件创建两个具有不同参数和/或监听器的负载平衡器。</p><p id="54fc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">文档可用<a class="ae ks" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-nested-stacks.html" rel="noopener ugc nofollow" target="_blank">这里&gt; &gt; &gt; </a>，好的帖子是<a class="ae ks" href="https://aws.amazon.com/ru/blogs/devops/use-nested-stacks-to-create-reusable-templates-and-support-role-specialization/" rel="noopener ugc nofollow" target="_blank">这里&gt; &gt; &gt; </a>。</p><p id="8c52" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在本帖中，我们将:</p><ol class=""><li id="69f5" class="kx ky iq jw b jx jy kb kc kf kz kj la kn lb kr lc ld le lf bi translated">创建一个根栈——它将描述我们的其他栈，就像一个框架</li><li id="46d1" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated">会将另一个带有VPC的堆栈作为子堆栈添加到根堆栈</li><li id="8f79" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated">和一个带有AWS SecurityGroups的子堆栈</li></ol><p id="e42e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，我们的嵌套堆栈必须能够在它们之间共享它们的参数，以便能够为各种环境使用相同的模板——Dev/Stage/Prod。</p><p id="4a61" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">最后，我们将简要概述AWS CloudFormation参数在独立堆栈之间的导入/导出功能。</p><p id="c7f4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">生成的模板可在<a class="ae ks" href="https://github.com/setevoy2/setevoy-aws-templates/tree/master/nested-stacks-example" rel="noopener ugc nofollow" target="_blank"> Github </a>上获得。</p><h2 id="fddf" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kf lu lv lw kj lx ly lz kn ma mb mc md bi translated">陷阱</h2><ol class=""><li id="06be" class="kx ky iq jw b jx me kb mf kf mg kj mh kn mi kr lc ld le lf bi translated">不要手动删除嵌套堆栈—只能通过“根”堆栈</li><li id="a51e" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated">对模板使用AWS S3版本控制</li></ol><h2 id="a5e3" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kf lu lv lw kj lx ly lz kn ma mb mc md bi translated">根堆栈</h2><p id="8483" class="pw-post-body-paragraph ju jv iq jw b jx me jz ka kb mf kd ke kf mj kh ki kj mk kl km kn ml kp kq kr ij bi translated">让我们从编写一个根栈的模板开始— <code class="fe kt ku kv kw b">root-stack.json</code>:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="886e" class="ll lm iq kw b gy mu mv l mw mx">{<br/>  "AWSTemplateFormatVersion" : "2010-09-09",<br/>  "Description" : "AWS CloudFormation Root stack",<br/><br/>  "Resources" : {<br/>    "VPCStack": {<br/>      "Type": "AWS::CloudFormation::Stack",<br/>      "Properties": {<br/>        "TemplateURL": "network-stack.yml"<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="0047" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里我们创建了唯一的资源— <code class="fe kt ku kv kw b"><a class="ae ks" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-stack.html" rel="noopener ugc nofollow" target="_blank">AWS::CloudFormation::Stack</a></code>，通过根的<code class="fe kt ku kv kw b">Properties</code>传递子栈模板文件<code class="fe kt ku kv kw b">network-stack.yml</code>。</p><p id="14f8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<code class="fe kt ku kv kw b">TemplateURL</code>将不得不设置一个S3桶网址-将很快更新它。</p><p id="285c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，创建<code class="fe kt ku kv kw b">network-stack.yml</code>文件:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="d212" class="ll lm iq kw b gy mu mv l mw mx">{<br/>  "AWSTemplateFormatVersion" : "2010-09-09",<br/>  "Description" : "AWS CloudFormation Nested Network Stack",<br/><br/>  "Resources" : {<br/>    "VPC" : {<br/>      "Type" : "AWS::EC2::VPC",<br/>      "Properties" : {<br/>        "CidrBlock" : "11.0.0.0/16"<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="b487" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建一个S3桶来存储我们的模板:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="c634" class="ll lm iq kw b gy mu mv l mw mx">$ aws s3api create-bucket --bucket-name eks-cloudformation --region eu-west-3 --create-bucket-configuration LocationConstraint=eu-west-3 --profile arseniy --region eu-west-3<br/>{<br/>  “Location”: “http://eks-cloudformation.s3.amazonaws.com/"<br/>}</span></pre><p id="627c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">记住地点:http://eks-cloudformation.s3.amazonaws.com/现在需要它。</p><p id="2e16" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于这样一个桶来说，启用版本控制是一个非常好的主意。</p><p id="0e89" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">启用它:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="f4ad" class="ll lm iq kw b gy mu mv l mw mx">$ aws--region eu-west-3--profile arseniy s3api put-bucket-versioning --bucket bttrm-eks-cloudformation --versioning-configuration Status=Enabled</span></pre><p id="13df" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将您的<code class="fe kt ku kv kw b">network-stack.yml</code>上传到桶中:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="d3a3" class="ll lm iq kw b gy mu mv l mw mx">$ aws --profile arseniy --region eu-west-3 s3 cp network-stack.yml s3://bttrm-eks-cloudformationnn<br/>upload: ./network-stack.yml to s3://bttrm-eks-cloudformation/network-stack.yml</span></pre><p id="14cc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">回到<code class="fe kt ku kv kw b">root-stack.json</code>，更新它的<code class="fe kt ku kv kw b">TemplateURL</code>——现在将它设置为一个指向桶的URL:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="ce1e" class="ll lm iq kw b gy mu mv l mw mx">{<br/>  "AWSTemplateFormatVersion" : "2010-09-09",<br/>  "Description" : "AWS CloudFormation Root stack",<br/><br/>  "Resources" : {<br/>    "VPCStack": {<br/>      "Type": "AWS::CloudFormation::Stack",<br/>      "Properties": {<br/>        "TemplateURL": "https://bttrm-eks-cloudformation.s3.amazonaws.com/network-stack.yml"<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="2049" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建根堆栈:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="1714" class="ll lm iq kw b gy mu mv l mw mx">$ aws cloudformation create-stack --stack-name nested-stacks-root --template-body file://root-stack.json --profile arseniy --region eu-west-3<br/>{<br/>  “StackId”: “arn:aws:cloudformation:eu-west-3:534****385:stack/nested-stacks-root/6450c320–57ab-11ea-be30–0a9cc8c39c1c”<br/>}</span></pre><p id="8202" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/b83a8271aba97e1c212f0b0e12cf0fcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4KUNBCdPJShyI9OT.png"/></div></div></figure><p id="7217" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">CloudFormation用VPC创建了一个<em class="my"> nested-stacks-root </em>栈及其子栈，命名为<em class="my">nested-stacks-root-VPC stack-1 fty 8 ti 2 pr 2d 2</em>，如<code class="fe kt ku kv kw b">network-stack.yml</code>模板所述:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi ne"><img src="../Images/31f52a117c51f90b3bcce95b536f4df4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*oc-qnG2BYRzhVDr1.png"/></div></div></figure><h2 id="9c56" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kf lu lv lw kj lx ly lz kn ma mb mc md bi translated">AWS云信息包和部署</h2><p id="db78" class="pw-post-body-paragraph ju jv iq jw b jx me jz ka kb mf kd ke kf mj kh ki kj mk kl km kn ml kp kq kr ij bi translated">为了避免手动上传模板，我们可以使用AWS CLI CloudFormation <code class="fe kt ku kv kw b"><a class="ae ks" href="https://docs.aws.amazon.com/cli/latest/reference/cloudformation/package.html" rel="noopener ugc nofollow" target="_blank">package</a></code>和<code class="fe kt ku kv kw b"><a class="ae ks" href="https://docs.aws.amazon.com/cli/latest/reference/cloudformation/deploy/index.html" rel="noopener ugc nofollow" target="_blank">deploy</a></code>选项。</p><h2 id="8bf9" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kf lu lv lw kj lx ly lz kn ma mb mc md bi translated"><code class="fe kt ku kv kw b">package</code></h2><p id="23da" class="pw-post-body-paragraph ju jv iq jw b jx me jz ka kb mf kd ke kf mj kh ki kj mk kl km kn ml kp kq kr ij bi translated"><code class="fe kt ku kv kw b">package</code>将指定文件或整个目录复制到一个S3桶中。</p><p id="dea7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更新您的<code class="fe kt ku kv kw b">root-stack.json</code> —将<code class="fe kt ku kv kw b">VPCStack</code>资源的<code class="fe kt ku kv kw b">TemplateURL</code>替换为本地路径——完整路径或相对于根堆栈文件的路径:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="c3f1" class="ll lm iq kw b gy mu mv l mw mx">{<br/>  "AWSTemplateFormatVersion" : "2010-09-09",<br/>  "Description" : "AWS CloudFormation Root stack",<br/><br/>  "Resources" : {<br/>    "VPCStack": {<br/>      "Type": "AWS::CloudFormation::Stack",<br/>      "Properties": {<br/>        "TemplateURL": "network-stack.yml"<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="15e8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">打包模板并将其上传到S3:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="0167" class="ll lm iq kw b gy mu mv l mw mx">$ aws cloudformation package --template-file root-stack.json — output-template packed-nested-stacks.json --s3-bucket bttrm-eks-cloudformation --profile arseniy --region eu-west-3 --use-json<br/>Uploading to ce12898553365980827b9aa59a99426d.template 187 / 187.0 (100.00%)</span><span id="69f0" class="ll lm iq kw b gy nf mv l mw mx">Successfully packaged artifacts and wrote output template to file packed-nested-stacks.json.</span><span id="ee15" class="ll lm iq kw b gy nf mv l mw mx">Execute the following command to deploy the packaged template</span><span id="1371" class="ll lm iq kw b gy nf mv l mw mx">aws cloudformation deploy — template-file /home/setevoy/Work/devops/projects/EKS/roles/cloudformation/files/packed-nested-stacks.json — stack-name &lt;YOUR STACK NAME&gt;</span></pre><p id="a614" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里:</p><ol class=""><li id="6e8f" class="kx ky iq jw b jx jy kb kc kf kz kj la kn lb kr lc ld le lf bi translated">CLI将在<code class="fe kt ku kv kw b">root-stack.json</code>中找到的所有文件(工件)上传到AWS S3</li><li id="f7f0" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated">将更新<code class="fe kt ku kv kw b">TemplateURL</code>以设置S3 URL而不是本地路径</li><li id="eee4" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated">将返回一个新生成的模板，可与<code class="fe kt ku kv kw b">deploy</code>选项一起使用</li></ol><p id="f64b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe kt ku kv kw b">package</code>返回的模板将保存在<code class="fe kt ku kv kw b">packed-nested-stacks.json</code>中(我使用的是<code class="fe kt ku kv kw b">--use-json</code>，因为默认情况下将使用YAML，检查<a class="ae ks" href="https://rtfm.co.ua/en/what-is-yaml-its-overview-basic-data-types-yaml-vs-json-and-pyyaml/" rel="noopener ugc nofollow" target="_blank">是什么:YAML-其概述、基本数据类型、YAML vs JSON和PyYAML </a> post)。</p><p id="ab57" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查其内容:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="9c79" class="ll lm iq kw b gy mu mv l mw mx">{<br/>    "AWSTemplateFormatVersion": "2010-09-09",<br/>    "Description": "AWS CloudFormation Root stack",<br/>    "Resources": {<br/>        "VPCStack": {<br/>            "Type": "AWS::CloudFormation::Stack",<br/>            "Properties": {<br/>                "TemplateURL": "https://s3.eu-west-3.amazonaws.com/eks-cloudformation/ce12898553365980827b9aa59a99426d.template"<br/>            }<br/>        }<br/>    }<br/>}</span></pre><p id="feb1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">再来看看<a class="ae ks" href="https://s3.eu-west-3.amazonaws.com/eks-cloudformation/ce12898553365980827b9aa59a99426d.template" rel="noopener ugc nofollow" target="_blank"><em class="my">https://S3 . eu-west-3 . amazonaws . com/eks-cloud formation/ce 12898553365980827 b 9 aa 59 a 99426d . template</em></a><em class="my"/>文件内容:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="661a" class="ll lm iq kw b gy mu mv l mw mx">$ aws --profile arseniy --region eu-west-3 s3 cp --quiet s3://eks-cloudformation/ce12898553365980827b9aa59a99426d.template /dev/stdout</span><span id="a265" class="ll lm iq kw b gy nf mv l mw mx">AWSTemplateFormatVersion: ‘2010–09–09’<br/>Description: AWS CloudFormation Nested Network Stack<br/>Resources:<br/>  VPC:<br/>    Type: AWS::EC2::VPC<br/>    Properties:<br/>      CidrBlock: 11.0.0.0/16</span></pre><h2 id="56a9" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kf lu lv lw kj lx ly lz kn ma mb mc md bi translated"><code class="fe kt ku kv kw b">deploy</code></h2><p id="b1fa" class="pw-post-body-paragraph ju jv iq jw b jx me jz ka kb mf kd ke kf mj kh ki kj mk kl km kn ml kp kq kr ij bi translated">在我们执行了<code class="fe kt ku kv kw b">package</code>命令之后，CLI显示了关于以下步骤的提示:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="c7d9" class="ll lm iq kw b gy mu mv l mw mx">…<br/>Execute the following command to deploy the packaged template</span><span id="7a54" class="ll lm iq kw b gy nf mv l mw mx">aws cloudformation deploy — template-file /home/setevoy/Work/devops/projects/EKS/roles/cloudformation/files/packed-nested-stacks.json — stack-name &lt;YOUR STACK NAME&gt;</span></pre><p id="9f01" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将其应用于几个步骤前创建的堆栈:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="f5f8" class="ll lm iq kw b gy mu mv l mw mx">$ aws --profile arseniy --region eu-west-3 cloudformation deploy --template-file packed-nested-stacks.json --stack-name nested-stacks-root<br/>Waiting for changeset to be created..<br/>Waiting for stack create/update to complete<br/>Successfully created/updated stack — nested-stacks-root</span></pre><p id="5d92" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe kt ku kv kw b">deploy</code>创建了一个<a class="ae ks" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-changesets.html" rel="noopener ugc nofollow" target="_blank">变更集</a>并将其应用于根堆栈:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi ng"><img src="../Images/61e8ccdfe7df6e5f6bab510742a151b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QLme0fMvg4nbqu_H.png"/></div></div></figure><h2 id="d513" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kf lu lv lw kj lx ly lz kn ma mb mc md bi translated">嵌套堆栈—传递参数</h2><p id="c34c" class="pw-post-body-paragraph ju jv iq jw b jx me jz ka kb mf kd ke kf mj kh ki kj mk kl km kn ml kp kq kr ij bi translated">此时，我们在模板中没有任何参数。</p><p id="2ff3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，在根栈中，我们可以设置一些全局值。</p><p id="2c18" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们添加一个VPC的CIDR，它将被网络堆栈使用。</p><p id="a6f3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe kt ku kv kw b">Update theroot-stack.json</code>并添加带有一个参数<code class="fe kt ku kv kw b">VPCCIDRBlock</code>及其默认值的<code class="fe kt ku kv kw b">Parameters</code>块:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="8069" class="ll lm iq kw b gy mu mv l mw mx">{<br/>  "AWSTemplateFormatVersion" : "2010-09-09",<br/>  "Description" : "AWS CloudFormation Root stack",<br/><br/>  "Parameters": {<br/>    "VPCCIDRBlock": {<br/>      "Description": "VPC CidrBlock",<br/>      "Type": "String",<br/>      "Default": "11.0.0.0/16"<br/>    }<br/>  },  <br/>...</span></pre><p id="45a1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<code class="fe kt ku kv kw b">VPCStack</code>资源的<code class="fe kt ku kv kw b">Resources</code>块中，添加带有<code class="fe kt ku kv kw b">VPCCIDRBlock</code>参数的<code class="fe kt ku kv kw b">Parameters</code>部分，我们将从“全局”参数传递我们的<code class="fe kt ku kv kw b">VPCCIDRBlock</code>值:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="f5b7" class="ll lm iq kw b gy mu mv l mw mx">{<br/>  "AWSTemplateFormatVersion" : "2010-09-09",<br/>  "Description" : "AWS CloudFormation Root stack",<br/><br/>  "Parameters": {<br/>    "VPCCIDRBlock": {<br/>      "Description": "VPC CidrBlock",<br/>      "Type": "String",<br/>      "Default": "11.0.0.0/16"<br/>    }<br/>  },<br/><br/>  "Resources" : {<br/>    "VPCStack": {<br/>      "Type": "AWS::CloudFormation::Stack",<br/>      "Properties": {<br/>        "TemplateURL": "network-stack.yml",<br/>        "Parameters": {<br/>          "VPCCIDRBlock" : { "Ref": "VPCCIDRBlock" }<br/>        }<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="cd35" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<code class="fe kt ku kv kw b">network-stack.yml</code>模板中将其添加到VPC资源:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="cbfe" class="ll lm iq kw b gy mu mv l mw mx">{<br/>  "AWSTemplateFormatVersion" : "2010-09-09",<br/>  "Description" : "AWS CloudFormation Nested Network Stack",<br/><br/>  "Parameters": {<br/>    "VPCCIDRBlock": {<br/>      "Description": "VPC CidrBlock",<br/>      "Type": "String"<br/>    }<br/>  },<br/><br/>  "Resources" : {<br/>    "VPC" : {<br/>      "Type" : "AWS::EC2::VPC",<br/>      "Properties" : {<br/>        "CidrBlock" : { "Ref": "VPCCIDRBlock" }<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="8ceb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">打包到S3:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="a010" class="ll lm iq kw b gy mu mv l mw mx">$ !518<br/>aws cloudformation package --template-file root-stack.json --output-template packed-nested-stacks.json --s3-bucket bttrm-eks-cloudformation --profile arseniy --region eu-west-3 --use-json</span></pre><p id="723a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">部署:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="46b6" class="ll lm iq kw b gy mu mv l mw mx">$ aws --profile arseniy --region eu-west-3 cloudformation deploy --template-file packed-nested-stacks.json --stack-name nested-stacks-root --profile arseniy --region eu-west-3 --use-json</span></pre><p id="bc78" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查嵌套堆栈的<code class="fe kt ku kv kw b">Parameters</code>:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nh"><img src="../Images/f5fa2aed66b5b5effaaf865789dc14a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*s0jWxcPMfqYI5H6W.png"/></div></div></figure><p id="0782" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加了<code class="fe kt ku kv kw b">VPCCIDRBlock</code>。</p><h2 id="9f92" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kf lu lv lw kj lx ly lz kn ma mb mc md bi translated">嵌套堆栈输出</h2><p id="aeff" class="pw-post-body-paragraph ju jv iq jw b jx me jz ka kb mf kd ke kf mj kh ki kj mk kl km kn ml kp kq kr ij bi translated">此外，嵌套堆栈允许通过<code class="fe kt ku kv kw b"><a class="ae ks" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-getatt.html" rel="noopener ugc nofollow" target="_blank">Fn::GetAtt</a></code>函数使用其他堆栈<code class="fe kt ku kv kw b">Outputs</code>。</p><p id="f37d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们添加第三个名为<em class="my"> SecurityGroupStack </em>的堆栈，在这里将描述我们的SecurityGroup。</p><p id="fb60" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们将使用堆栈<code class="fe kt ku kv kw b">network-stack.yml</code>的<code class="fe kt ku kv kw b">Outputs</code>将VPC ID传递给这个SecurotyGroup。</p><p id="ca74" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">请记住，这样的参数只能从“底部”传递到“顶部”并返回。</p><p id="d59c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">也就是说，您不能将参数从<em class="my"> VPCStack </em>直接传递给<em class="my"> SecurityGroupStack </em>，但是您可以将一个值返回给根堆栈，然后将其用作子堆栈的参数。</p><p id="15cd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为此:</p><ol class=""><li id="5218" class="kx ky iq jw b jx jy kb kc kf kz kj la kn lb kr lc ld le lf bi translated">在<em class="my"> VPCStack </em> ( <code class="fe kt ku kv kw b">network-stack.yml</code>)堆栈中，我们将添加<code class="fe kt ku kv kw b">Outputs</code>来返回装箱的VPC的ID</li><li id="9236" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated">在根堆栈<code class="fe kt ku kv kw b">root-stack.json</code>中，我们将描述一个名为<em class="my"> SecurityGroupStack </em>的新堆栈，它<code class="fe kt ku kv kw b">Parameters</code>将接受来自<em class="my"> VPCStack </em> <code class="fe kt ku kv kw b">Outputs</code> ( <code class="fe kt ku kv kw b">network-stack.yml</code>)的值</li><li id="2a91" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated">将创建一个新的栈<em class="my"> SecurityGroupStack </em>，该模板将使用<code class="fe kt ku kv kw b">Parameters</code> &gt; <code class="fe kt ku kv kw b">VPCID</code></li></ol><h2 id="68d9" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kf lu lv lw kj lx ly lz kn ma mb mc md bi translated"><code class="fe kt ku kv kw b">network-stack.yml</code>堆栈输出</h2><p id="19c7" class="pw-post-body-paragraph ju jv iq jw b jx me jz ka kb mf kd ke kf mj kh ki kj mk kl km kn ml kp kq kr ij bi translated">为VPC添加输出:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="76b4" class="ll lm iq kw b gy mu mv l mw mx">...<br/>  "Resources" : {<br/>    "VPC" : {<br/>      "Type" : "AWS::EC2::VPC",<br/>      "Properties" : {<br/>        "CidrBlock" : { "Ref": "VPCCIDRBlock" }<br/>      }<br/>    }<br/>  },<br/><br/>  "Outputs" : {<br/>    "VPCID" : {<br/>      "Description" : "EKS VPC ID",<br/>      "Value" : { "Ref" : "VPC" }<br/>    }<br/>  }<br/>}</span></pre><h2 id="b27f" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kf lu lv lw kj lx ly lz kn ma mb mc md bi translated"><code class="fe kt ku kv kw b">root-stack.json</code>堆栈</h2><p id="c541" class="pw-post-body-paragraph ju jv iq jw b jx me jz ka kb mf kd ke kf mj kh ki kj mk kl km kn ml kp kq kr ij bi translated">在根栈中添加一个新的栈<em class="my"> SecurityGroupStack </em>并将<code class="fe kt ku kv kw b">VPCID</code>从<em class="my"> VPCStack </em>栈的<code class="fe kt ku kv kw b">Outputs</code>添加到<em class="my"> SecurityGroupStack </em>的<code class="fe kt ku kv kw b">Parameters</code>:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="e339" class="ll lm iq kw b gy mu mv l mw mx">...<br/>  "Resources" : {<br/>    "VPCStack": {<br/>      "Type": "AWS::CloudFormation::Stack",<br/>      "Properties": {<br/>        "TemplateURL": "network-stack.yml",<br/>        "Parameters": {<br/>          "VPCCIDRBlock" : { "Ref": "VPCCIDRBlock" }<br/>        }<br/>      }<br/>    },<br/>    "SecurityGroupStack": {<br/>      "Type": "AWS::CloudFormation::Stack",<br/>      "Properties": {<br/>        "TemplateURL": "sg-stack.yml",<br/>        "Parameters": {<br/>          "VPCID" : { "Fn::GetAtt": ["VPCStack", "Outputs.VPCID"] }<br/>        }<br/>      }<br/>    }<br/>  }<br/>...</span></pre><p id="db0d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为安全组创建新的模板文件— <code class="fe kt ku kv kw b">sg-stack.yml</code>:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="2f3a" class="ll lm iq kw b gy mu mv l mw mx">{<br/>  "AWSTemplateFormatVersion" : "2010-09-09",<br/><br/>  "Description" : "AWS CloudFormation SecurityGroups stack",<br/><br/>  "Parameters" : {<br/>    "VPCID": {<br/>      "Description": "Network Stack VPC ID",<br/>      "Type": "String",<br/>    }<br/>  },<br/><br/>  "Resources" : {<br/>    "SecurityGroup": {<br/>      "Type": "AWS::EC2::SecurityGroup",<br/>      "Properties" : {<br/>        "GroupDescription" : "Example SecurityGroup",<br/>        "VpcId"            : { "Ref": "VPCID" },<br/>        "SecurityGroupIngress" : [<br/>          {<br/>            "Description": "Allow HTTP",<br/>            "IpProtocol" : "tcp",<br/>            "FromPort"   : 80,<br/>            "ToPort"     : 80,<br/>            "CidrIp"     : "0.0.0.0/0"<br/>          },<br/>          {<br/>            "Description": "Allow HTTPS",<br/>            "IpProtocol" : "tcp",<br/>            "FromPort"   : 443,<br/>            "ToPort"     : 443,<br/>            "CidrIp"     : "0.0.0.0/0"<br/>          }<br/>        ]<br/>      }<br/>    },<br/>  }<br/>}</span></pre><p id="75d9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这里，在<code class="fe kt ku kv kw b">"VpcId" : { "Ref": "VPCID" }</code>中，我们使用一个VPC ID值将这个SecirtyGroup添加到同一个VPC中。</p><p id="3d12" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">打包、部署、检查堆栈:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi ni"><img src="../Images/7872226420505555f0ee548fa7077393.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*G0GWv5gMg4036Hud.png"/></div></div></figure><p id="d8d9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建了一个新堆栈。</p><p id="fbd5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查其参数:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi ni"><img src="../Images/d6761c3d7ac66eae7d685930ed858860.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VXHdtdlA-ZTvLIL0.png"/></div></div></figure><p id="19b0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一切都好。</p><h2 id="b985" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kf lu lv lw kj lx ly lz kn ma mb mc md bi translated">模板重用</h2><p id="f36c" class="pw-post-body-paragraph ju jv iq jw b jx me jz ka kb mf kd ke kf mj kh ki kj mk kl km kn ml kp kq kr ij bi translated">正如在开始时已经提到的，主要思想是模块化，当我们可以使用相同的模板文件来创建相似的资源。</p><p id="c444" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">比方说，我们想要两个具有不同CIDRs的VPC。</p><p id="d296" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们可以使用CloudFormation <code class="fe kt ku kv kw b">Mappins</code>并在那里设置两个不同的网络块。</p><p id="9633" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在根模板<code class="fe kt ku kv kw b">root-stack.json</code>中，移除<code class="fe kt ku kv kw b">"Parameters": "VPCCIDRBlock"</code>并添加<code class="fe kt ku kv kw b">Mappings</code>:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="fa60" class="ll lm iq kw b gy mu mv l mw mx">{<br/>  "AWSTemplateFormatVersion" : "2010-09-09",<br/>  "Description" : "AWS CloudFormation Root stack",<br/><br/>  "Mappings": {<br/>    "VPCCIDRBlock": {<br/>      "vpc1": {<br/>        "cidr": "11.0.0.0/16"<br/>      },<br/>      "vpc2": {<br/>        "cidr": "12.0.0.0/16"<br/>      }<br/>    }<br/>  },<br/>...</span></pre><p id="e7f0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<code class="fe kt ku kv kw b">Resources</code>中使用相同的模板文件添加另一个带有VPC的堆栈，但是现在在它的<code class="fe kt ku kv kw b">Parameters</code>中使用<code class="fe kt ku kv kw b">Fn::FindInMap</code>函数为<code class="fe kt ku kv kw b">Property VPCCIDRBlock</code>获取一个值:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="22a9" class="ll lm iq kw b gy mu mv l mw mx">...<br/>  "Resources" : {<br/>    "VPCStack1": {<br/>      "Type": "AWS::CloudFormation::Stack",<br/>      "Properties": {<br/>        "TemplateURL": "network-stack.yml",<br/>        "Parameters": {<br/>          "VPCCIDRBlock" : { "Fn::FindInMap" : [ "VPCCIDRBlock", "vpc1", "cidr" ] }<br/>        }<br/>      }<br/>    },<br/>    "VPCStack2": {<br/>      "Type": "AWS::CloudFormation::Stack",<br/>      "Properties": {<br/>        "TemplateURL": "network-stack.yml",<br/>        "Parameters": {<br/>          "VPCCIDRBlock" : { "Fn::FindInMap" : [ "VPCCIDRBlock", "vpc2", "cidr" ] }<br/>        }<br/>      }<br/>    },<br/>...</span></pre><p id="9af5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">不要忘记SecurityGroup —再次添加另一个—使用同一个SG的模板<code class="fe kt ku kv kw b">sg-stack.yml</code>，并将第二个SecurityGroup附加到第二个VPC:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="ead0" class="ll lm iq kw b gy mu mv l mw mx">...<br/>    "SecurityGroupStack1": {<br/>      "Type": "AWS::CloudFormation::Stack",<br/>      "Properties": {<br/>        "TemplateURL": "sg-stack.yml",<br/>        "Parameters": {<br/>          "VPCID" : { "Fn::GetAtt": ["VPCStack1", "Outputs.VPCID"] }<br/>        }<br/>      }<br/>    },<br/>    "SecurityGroupStack2": {<br/>      "Type": "AWS::CloudFormation::Stack",<br/>      "Properties": {<br/>        "TemplateURL": "sg-stack.yml",<br/>        "Parameters": {<br/>          "VPCID" : { "Fn::GetAtt": ["VPCStack2", "Outputs.VPCID"] }<br/>        }<br/>      }<br/>    }<br/>...</span></pre><p id="f1ac" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">部署，检查:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nj"><img src="../Images/114654035ecb53f3a2bc4c422930b68d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WTBGW3eQXhA9GtI5.png"/></div></div></figure><p id="4042" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">CloudFormation移除了<em class="my"> VPCStack </em>，转而创建了两个新堆栈——<em class="my">VPC stack 1</em>и<em class="my">VPC stack 2</em>，同样的方式——用于<em class="my">安全组</em>。</p><h2 id="a148" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kf lu lv lw kj lx ly lz kn ma mb mc md bi translated">导入/导出值与嵌套堆栈</h2><p id="5299" class="pw-post-body-paragraph ju jv iq jw b jx me jz ka kb mf kd ke kf mj kh ki kj mk kl km kn ml kp kq kr ij bi translated">嵌套堆栈中的<code class="fe kt ku kv kw b">Outputs</code>有利于在关联的堆栈之间共享参数，但它仅适用于当前的堆栈“树”,不能与该AWS帐户中不相关的堆栈共享。</p><p id="59de" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这里，我们可以使用另一个AWS CLoudFormatiuon特性，称为<a class="ae ks" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-crossstackref.html" rel="noopener ugc nofollow" target="_blank">跨栈引用</a>——在第一个栈中，您将创建一个<code class="fe kt ku kv kw b"><a class="ae ks" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-stack-exports.html" rel="noopener ugc nofollow" target="_blank">Export</a></code>，在另一个栈中，您将创建它们的<code class="fe kt ku kv kw b"><a class="ae ks" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-importvalue.html" rel="noopener ugc nofollow" target="_blank">Import</a></code>。</p><h2 id="8575" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kf lu lv lw kj lx ly lz kn ma mb mc md bi translated">陷阱</h2><ul class=""><li id="d8df" class="kx ky iq jw b jx me kb mf kf mg kj mh kn mi kr nk ld le lf bi translated">导出的值只能在同一个AWS区域内访问</li><li id="a0a5" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr nk ld le lf bi translated">如果一个堆栈导入了任何其他堆栈使用的值，则不能删除该堆栈</li></ul><p id="dafe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为创建的SecurityGroups的ID添加一个导出，以便以后在其他独立的堆栈中使用。</p><p id="d448" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为此，更新SecurityGroup <code class="fe kt ku kv kw b">sg-stack.yml</code>模板并将其ID添加到<code class="fe kt ku kv kw b">Outputs</code>:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="3694" class="ll lm iq kw b gy mu mv l mw mx">...<br/>            "ToPort"     : 443,<br/>            "CidrIp"     : "0.0.0.0/0"<br/>          }<br/>        ]<br/>      }<br/>    },<br/>  },<br/><br/>  "Outputs" : {<br/>    "SecurityGroupID" : {<br/>      "Description" : "The SecurityGroup ID",<br/>      "Value" :  { "Ref" : "SecurityGroup" }<br/>    }<br/>  }<br/>}</span></pre><p id="6d9a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在根模板中—更新其<code class="fe kt ku kv kw b">Outputs</code>并为两个<em class="my"> SecurityGroupStack </em>堆栈添加<code class="fe kt ku kv kw b">Export</code>:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="cc9e" class="ll lm iq kw b gy mu mv l mw mx">...<br/>  "Outputs" : {<br/>    "SecurityGroup1" : {<br/>      "Description" : "The SecurityGroup-1 ID",<br/>      "Value" :  { "Fn::GetAtt": [ "SecurityGroupStack1", "Outputs.SecurityGroupID" ] },<br/>      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}-SecurityGroupStack1" } }<br/>    },<br/>    "SecurityGroup2" : {<br/>      "Description" : "The SecurityGroup-2 ID",<br/>      "Value" :  { "Fn::GetAtt": [ "SecurityGroupStack2", "Outputs.SecurityGroupID" ] },<br/>      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}-SecurityGroupStack2" } }<br/>    }<br/>  }<br/>}</span></pre><p id="40de" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里:</p><ul class=""><li id="823c" class="kx ky iq jw b jx jy kb kc kf kz kj la kn lb kr nk ld le lf bi translated">在<code class="fe kt ku kv kw b">Value</code>中，我们从它的<code class="fe kt ku kv kw b">Outputs</code>中获得一个安全组ID</li><li id="d76b" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr nk ld le lf bi translated">在带有<code class="fe kt ku kv kw b"><a class="ae ks" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-sub.html" rel="noopener ugc nofollow" target="_blank">Fn::Sub</a></code>的<code class="fe kt ku kv kw b">Export: Name</code>中，我们正在生成一个唯一的名称。</li></ul><p id="2125" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">部署，检查<em class="my">安全组</em>的堆栈<code class="fe kt ku kv kw b">Outputs</code>:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nl"><img src="../Images/029da487959f519f96ed1dbddd11120b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MGQ-IP4VaOU5LL7s.png"/></div></div></figure><p id="5b53" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">和根堆栈的<code class="fe kt ku kv kw b">Outputs</code>-找到导出的值:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nm"><img src="../Images/d59e2a1d3c391821c98c514a2de212b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HkW4uPNaC6gHQThe.png"/></div></div></figure><p id="6eb2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，它们现在可用于此帐户的整个CloudFormation的导出:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nn"><img src="../Images/789228558dbc475e90d187e33f51faa9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tIiN0NlDgkgiSbVC.png"/></div></div></figure><p id="a63f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，我们可以将它用于其他堆栈。</p><p id="b89d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了检查它，让我们添加一个只有VPC资源的堆栈(因为CloudFormation堆栈必须至少有一个资源类型)，并且在它的<code class="fe kt ku kv kw b">Outputs</code>中使用<code class="fe kt ku kv kw b"><a class="ae ks" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-importvalue.html" rel="noopener ugc nofollow" target="_blank">Fn::ImportValue</a></code>我们将显示来自<em class="my">嵌套堆栈根</em>堆栈的SecurityGroups IDs:</p><pre class="mm mn mo mp gt mq kw mr ms aw mt bi"><span id="9a3c" class="ll lm iq kw b gy mu mv l mw mx">{<br/>  "AWSTemplateFormatVersion" : "2010-09-09",<br/>  "Description" : "AWS CloudFormation Nested Network stack",<br/><br/>  "Parameters": {<br/>    "VPCCIDRBlock": {<br/>      "Description": "VPC CidrBlock",<br/>      "Type": "String",<br/>      "Default": "13.0.0.0/16"<br/>    }<br/>  },<br/><br/>  "Resources" : {<br/>    "VPC" : {<br/>      "Type" : "AWS::EC2::VPC",<br/>      "Properties" : {<br/>        "CidrBlock" : { "Ref": "VPCCIDRBlock" }<br/>      }<br/>    }<br/>  },<br/><br/>  "Outputs" : {<br/>    "SecurityGroup1ID" : {<br/>      "Description" : "The SecurityGroup ID",<br/>      "Value" :  { "Fn::ImportValue" : "nested-stacks-root-SecurityGroupStack1" }<br/>    },<br/>    "SecurityGroup2ID" : {<br/>      "Description" : "The SecurityGroup ID",<br/>      "Value" :  { "Fn::ImportValue" : "nested-stacks-root-SecurityGroupStack2" }<br/>    }<br/>  }<br/>}</span></pre><p id="3924" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">部署它(更好的方法是像调用"<em class="my">独立- </em>或"<em class="my">外部- </em>而不是<em class="my">嵌套- </em>"那样调用新堆栈)，并检查它的<code class="fe kt ku kv kw b">Outputs</code>:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi no"><img src="../Images/186f2582a5ab1e267eeb874a4f97722d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WKecCNqBQDaqw2SA.png"/></div></div></figure><p id="96b1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">完成了。</p><h2 id="716b" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kf lu lv lw kj lx ly lz kn ma mb mc md bi translated">有用的链接</h2><ul class=""><li id="8208" class="kx ky iq jw b jx me kb mf kf mg kj mh kn mi kr nk ld le lf bi translated"><a class="ae ks" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-nested-stacks.html" rel="noopener ugc nofollow" target="_blank">使用嵌套堆栈</a></li><li id="f22e" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr nk ld le lf bi translated"><a class="ae ks" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/best-practices.html#nested" rel="noopener ugc nofollow" target="_blank"> AWS云信息最佳实践</a></li><li id="af0a" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr nk ld le lf bi translated"><a class="ae ks" href="https://www.trek10.com/blog/cloudformation-nested-stacks-primer/" rel="noopener ugc nofollow" target="_blank"> CloudFormation嵌套堆叠引物</a></li><li id="ed4b" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr nk ld le lf bi translated"><a class="ae ks" href="https://medium.com/@janethavishka/walkthrough-with-nested-cloudformation-stacks-d7709b568162" rel="noopener">嵌套云形成堆栈的演练</a></li><li id="9f0c" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr nk ld le lf bi translated"><a class="ae ks" href="https://cloudacademy.com/blog/understanding-nested-cloudformation-stacks/" rel="noopener ugc nofollow" target="_blank">了解嵌套云生成堆栈</a></li><li id="f837" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr nk ld le lf bi translated"><a class="ae ks" href="https://aws.amazon.com/ru/blogs/devops/use-nested-stacks-to-create-reusable-templates-and-support-role-specialization/" rel="noopener ugc nofollow" target="_blank">使用嵌套堆栈创建可重用模板并支持角色专门化</a></li><li id="3a3f" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr nk ld le lf bi translated"><a class="ae ks" href="https://sbstjn.com/cloudformation.html#nested-stacks" rel="noopener ugc nofollow" target="_blank">云形成最佳实践</a></li><li id="e047" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr nk ld le lf bi translated"><a class="ae ks" href="https://aws.nz/best-practice/cloudformation-package-deploy/" rel="noopener ugc nofollow" target="_blank">造云包&amp;展开</a></li><li id="4f87" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr nk ld le lf bi translated"><a class="ae ks" href="https://garbe.io/blog/2017/07/17/cloudformation-hacks/" rel="noopener ugc nofollow" target="_blank"> 7个可怕的云形成黑客</a></li><li id="1303" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr nk ld le lf bi translated"><a class="ae ks" href="https://www.1strategy.com/blog/2017/03/14/using-cloudformation-cross-stack-references/" rel="noopener ugc nofollow" target="_blank">使用CloudFormation交叉堆栈引用</a></li><li id="1c22" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr nk ld le lf bi translated">如何从AWS CloudFormation模板中引用另一个堆栈中的资源？</li><li id="298b" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr nk ld le lf bi translated"><a class="ae ks" href="https://aws.amazon.com/ru/premiumsupport/knowledge-center/multiple-values-list-parameter-cli/" rel="noopener ugc nofollow" target="_blank">如何在AWS CloudFormation模板中为单个参数使用多个值？</a></li><li id="7025" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr nk ld le lf bi translated"><a class="ae ks" href="https://aws.amazon.com/ru/premiumsupport/knowledge-center/cloudformation-parameters-nested-stacks/" rel="noopener ugc nofollow" target="_blank">如何将CommaDelimitedList参数传递给AWS CloudFormation中的嵌套堆栈？</a></li><li id="8244" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr nk ld le lf bi translated"><a class="ae ks" href="https://sanderknape.com/2018/08/two-years-with-cloudformation-lessons-learned/" rel="noopener ugc nofollow" target="_blank">云形成两年:经验教训</a></li></ul></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><p id="1a32" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="my">最初发布于</em> <a class="ae ks" href="https://rtfm.co.ua/en/aws-cloudformation-nested-stacks-and-stacks-parameters-import-export/" rel="noopener ugc nofollow" target="_blank"> <em class="my"> RTFM: Linux、DevOps和系统管理</em> </a> <em class="my">。</em></p></div></div>    
</body>
</html>