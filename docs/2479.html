<html>
<head>
<title>AWS: IAM users keys rotation, EC2 IAM Roles and Jenkins</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS: IAM用户密钥轮换、EC2 IAM角色和Jenkins</h1>
<blockquote>原文：<a href="https://itnext.io/aws-iam-users-keys-rotation-ec2-iam-roles-and-jenkins-bfca5e012d18?source=collection_archive---------6-----------------------#2019-05-30">https://itnext.io/aws-iam-users-keys-rotation-ec2-iam-roles-and-jenkins-bfca5e012d18?source=collection_archive---------6-----------------------#2019-05-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/c8ea3ea01170b046e5dfef67fc5ff239.png" data-original-src="https://miro.medium.com/v2/resize:fit:260/format:webp/0*fanSwXKCniMUqge5.png"/></div></figure><p id="9367" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">今天，我查看了我们的IAM用户,“突然”想起有时更新他们的凭证是有好处的:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div class="gh gi ks"><img src="../Images/d1a01f19e4193f2b2844545eb53edecd.png" data-original-src="https://miro.medium.com/v2/resize:fit:402/format:webp/0*WBmezEiRgkgmZqtU.png"/></div></figure><p id="c0df" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">嗯，这样做很好，但这里有一个问题:在IAM中设置密钥过期很简单，但如何处理我们的Jenkins中使用的所有脚本以及使用这些IAM访问/秘密密钥的脚本呢？</p><p id="1a1b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，我们的后端配置是在Jenkins上使用Ansible <code class="fe kx ky kz la b"><a class="ae lb" href="https://rtfm.co.ua/ansible-modul-cloudformation/" rel="noopener ugc nofollow" target="_blank">cloudformation</a></code>模块完成的，该模块使用IAM用户和IAM策略以及EC2/RDS/CloudFormation等允许规则。</p><p id="a77f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们的数据分析有自己的作业，这些作业执行一些ETL作业，并使用IAM用户将结果存储在AWS S3存储桶中，IAM用户的策略允许访问特定的S3存储桶。</p><p id="53c3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，每次在IAM中轮换作业时，需要更新所有这些作业中的所有访问/密钥吗？</p><p id="9fb3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">作为一个解决方案，可以使用Hashicorp Vault ，它可以向这些脚本/作业授予访问令牌。但是首先，设置Vault本身、它的备份等是一些事情(和时间),其次，使用脚本/Jenkins作业来更新它们以使用Vault而不是具有访问/秘密密钥的变量是一项工作。</p><p id="b35f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一个更好的解决方案是为EC2使用IAM角色，因为任何AWS SDK都会在认证期间寻找它，例如，<a class="ae lb" href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/configuration.html" rel="noopener ugc nofollow" target="_blank"> boto3文档说</a>:</p><ol class=""><li id="8c67" class="lc ld iq jw b jx jy kb kc kf le kj lf kn lg kr lh li lj lk bi translated">在boto.client()方法中将凭据作为参数传递</li><li id="2eeb" class="lc ld iq jw b jx ll kb lm kf ln kj lo kn lp kr lh li lj lk bi translated">创建会话对象时将凭据作为参数传递</li><li id="7685" class="lc ld iq jw b jx ll kb lm kf ln kj lo kn lp kr lh li lj lk bi translated">环境变量</li><li id="8329" class="lc ld iq jw b jx ll kb lm kf ln kj lo kn lp kr lh li lj lk bi translated">共享凭据文件(`~/。AWS/凭据`)</li><li id="3651" class="lc ld iq jw b jx ll kb lm kf ln kj lo kn lp kr lh li lj lk bi translated">AWS配置文件(`~/。aws/config `)</li><li id="bb53" class="lc ld iq jw b jx ll kb lm kf ln kj lo kn lp kr lh li lj lk bi translated">承担角色提供者</li><li id="cb12" class="lc ld iq jw b jx ll kb lm kf ln kj lo kn lp kr lh li lj lk bi translated">Boto2配置文件(`/etc/boto.cfg和~/.boto `)</li><li id="0b72" class="lc ld iq jw b jx ll kb lm kf ln kj lo kn lp kr lh li lj lk bi translated">配置了IAM角色的Amazon EC2实例上的实例元数据服务。</li></ol><p id="56f9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以，让我们试着:</p><ol class=""><li id="ea2e" class="lc ld iq jw b jx jy kb kc kf le kj lf kn lg kr lh li lj lk bi translated">使用必要的策略创建IAM角色</li><li id="0474" class="lc ld iq jw b jx ll kb lm kf ln kj lo kn lp kr lh li lj lk bi translated">将其连接到EC2</li><li id="b544" class="lc ld iq jw b jx ll kb lm kf ln kj lo kn lp kr lh li lj lk bi translated">使用未配置的AWS CLI测试访问</li></ol><h2 id="f168" class="lq lr iq bd ls lt lu dn lv lw lx dp ly kf lz ma mb kj mc md me kn mf mg mh mi bi translated">创建IAM角色</h2><p id="b777" class="pw-post-body-paragraph ju jv iq jw b jx mj jz ka kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr ij bi translated">创建一个角色，选择了EC2类型:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mo"><img src="../Images/f30b437825ecdd021abdb6816407cf1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Gqp8z262vBsWI2m0.png"/></div></div></figure><p id="d68d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">附加任何策略，这里以<em class="mt">Amazon route 53 readonlyaccess</em>为例:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mo"><img src="../Images/6efdaebc1df5b6837230b823f2dbc028.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*07c1yfQj8x5kUssn.png"/></div></div></figure><p id="dd5f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">保存您的新角色:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mu"><img src="../Images/f5bf502d1cf5e79e3203425b67598778.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dGncHJG1LMANQ91r.png"/></div></div></figure><h2 id="bb96" class="lq lr iq bd ls lt lu dn lv lw lx dp ly kf lz ma mb kj mc md me kn mf mg mh mi bi translated">运行EC2</h2><p id="e873" class="pw-post-body-paragraph ju jv iq jw b jx mj jz ka kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr ij bi translated">创建EC2实例并设置上面创建的IAM角色:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mv"><img src="../Images/cb7742c41b7af9fd09ec440740e6828b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*k1VNZyh5UohomUs_.png"/></div></div></figure><h2 id="6d94" class="lq lr iq bd ls lt lu dn lv lw lx dp ly kf lz ma mb kj mc md me kn mf mg mh mi bi translated">测试</h2><p id="86f0" class="pw-post-body-paragraph ju jv iq jw b jx mj jz ka kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr ij bi translated">登录到实例:</p><pre class="kt ku kv kw gt mw la mx my aw mz bi"><span id="c20b" class="lq lr iq la b gy na nb l nc nd">ssh admin@34.244.125.163 -i setevoy-testing-eu-west-1.pem</span></pre><p id="4094" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<a class="ae lb" href="https://docs.aws.amazon.com/en_us/AWSEC2/latest/UserGuide/ec2-instance-metadata.html" rel="noopener ugc nofollow" target="_blank">实例元数据</a>中检查IAM:</p><pre class="kt ku kv kw gt mw la mx my aw mz bi"><span id="c8ef" class="lq lr iq la b gy na nb l nc nd">root@ip-172–31–42–77:/home/admin# curl <a class="ae lb" href="http://169.254.169.254/latest/meta-data/iam/info" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/latest/meta-data/iam/info</a><br/>{<br/>“Code” : “Success”,<br/>“LastUpdated” : “2019–05–30T10:54:26Z”,<br/>“InstanceProfileArn” : “arn:aws:iam::534***385:instance-profile/ec2-example-role”<br/>…</span></pre><p id="8852" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">安装AWS CLI:</p><pre class="kt ku kv kw gt mw la mx my aw mz bi"><span id="bec0" class="lq lr iq la b gy na nb l nc nd">root@ip-172–31–42–77:/home/admin# apt update &amp;&amp; apt -y install awscli</span></pre><p id="6044" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并在没有任何访问/密钥配置的情况下获取Route53托管区域:</p><pre class="kt ku kv kw gt mw la mx my aw mz bi"><span id="f218" class="lq lr iq la b gy na nb l nc nd">root@ip-172–31–42–77:/home/admin# aws route53 list-hosted-zones — output text<br/>HOSTEDZONES 33C2D264-***-***-3052BEA607A9 /hostedzone/Z30***LB6 example.com. 104<br/>CONFIG DME sites False<br/>…</span></pre><p id="07be" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="mt">“管用！”</em>。</p><h2 id="e4fe" class="lq lr iq bd ls lt lu dn lv lw lx dp ly kf lz ma mb kj mc md me kn mf mg mh mi bi translated">詹金斯</h2><p id="1b90" class="pw-post-body-paragraph ju jv iq jw b jx mj jz ka kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr ij bi translated">让我们更进一步，看看这是否能在Jenkins上工作，首先——Jenkins本身运行在Docker容器中，其次——它的任务(如Ansible任务)也是在Jenkins“内部”使用Docker容器启动的。</p><p id="63a8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更新现有EC2实例:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi ne"><img src="../Images/a32fea5f91ea15495c05fcd40e150b0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hYLROoDALULmeMP9.png"/></div></div></figure><p id="11b5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">附加先前创建的角色:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi ne"><img src="../Images/7962fb5408622b2e654dd4d2fbd6ea66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AwizysEowxEsofUx.png"/></div></div></figure><p id="a0c8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用AWS CLI创建自己的Docker映像—创建简单的<code class="fe kx ky kz la b">Dockerfile</code>:</p><pre class="kt ku kv kw gt mw la mx my aw mz bi"><span id="102e" class="lq lr iq la b gy na nb l nc nd">FROM python:3.7-stretch<br/>RUN apt-get update -y<br/>RUN pip install awscli</span></pre><p id="2def" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">构建图像:</p><pre class="kt ku kv kw gt mw la mx my aw mz bi"><span id="bdab" class="lq lr iq la b gy na nb l nc nd">root@jenkins-dev:/opt/jenkins# docker build -t setevoy/awscli .</span></pre><p id="b7f6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><pre class="kt ku kv kw gt mw la mx my aw mz bi"><span id="1b4f" class="lq lr iq la b gy na nb l nc nd">root@jenkins-dev:/opt/jenkins# docker run -ti setevoy/awscli aws — version<br/>aws-cli/1.16.168 Python/3.7.3 Linux/4.9.0–8-amd64 botocore/1.12.158</span></pre><p id="8fb8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">转到Jenkins并创建一个测试作业。</p><p id="11a8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里是<a class="ae lb" href="https://jenkins.io/doc/book/pipeline/docker/" rel="noopener ugc nofollow" target="_blank">詹金斯管道</a>用过的:</p><pre class="kt ku kv kw gt mw la mx my aw mz bi"><span id="5f34" class="lq lr iq la b gy na nb l nc nd">node {<br/>    docker.image('setevoy/awscli:latest').inside('-v /var/run/docker.sock:/var/run/docker.sock') {<br/>        stage('List zones') {<br/>            sh "aws route53 list-hosted-zones --output text"<br/>        }<br/>    }<br/>}</span></pre><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nf"><img src="../Images/3f61fd7463b9cae0a2bde7c710805c77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*A1nCKVxKAhPjtmNs.png"/></div></div></figure><p id="7931" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行此作业:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi ng"><img src="../Images/0acc40a0d5f8f6077e53aa023df31f2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-XNe8_vpgJJKDEW-.png"/></div></div></figure><p id="d32b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">太好了！</p><p id="458c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们检查一下未授权的API调用是否有效。</p><p id="63ca" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在我们的策略中，只允许<em class="mt">Amazon route 53 readonlyaccess</em>——让我们尝试执行S3列表桶:</p><pre class="kt ku kv kw gt mw la mx my aw mz bi"><span id="8b1d" class="lq lr iq la b gy na nb l nc nd">node {<br/>    docker.image('setevoy/awscli:latest').inside('-v /var/run/docker.sock:/var/run/docker.sock') {<br/>        stage('List zones') {<br/>            sh "aws s3api list-buckets"<br/>        }<br/>    }<br/>}</span></pre><p id="35a0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nh"><img src="../Images/4135044a1cfd61a73af6ef19381127ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NqSLaLJqfvyFNZ0m.png"/></div></div></figure><blockquote class="ni nj nk"><p id="d3ee" class="ju jv mt jw b jx jy jz ka kb kc kd ke nl kg kh ki nm kk kl km nn ko kp kq kr ij bi translated">+ aws s3api list-buckets <br/>调用ListBuckets操作时出错(访问被拒绝):访问被拒绝</p></blockquote><p id="8c89" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">拒绝访问 —太好了！</p><p id="6946" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是使用EC2 IAM角色作为jenkins jobs授权机制有一个问题:实际上，它的EC2实例将访问AWS帐户下的所有资源。</p><p id="daed" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">也就是说，如果某人将获得对该主机的SSH访问权限，他将能够访问我们AWS中的任何其他资源。</p><p id="1fd0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一方面，这可以通过使用EC2 spot-instance作为Jenkins workers并附加专用的受限策略来消除。</p><p id="fca7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">另一方面，如果有人要访问你的Jenkins，无论如何你都会有大问题，所以不要忘记升级它，并通过授权和AWS安全组限制对它的访问。</p></div><div class="ab cl no np hu nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="ij ik il im in"><blockquote class="ni nj nk"><p id="d856" class="ju jv mt jw b jx jy jz ka kb kc kd ke nl kg kh ki nm kk kl km nn ko kp kq kr ij bi translated">2019年4月9日，安全研究员Jaikey Sarraf向Matrix警告了Jenkins中存在的漏洞，Matrix称其用于持续集成。“我们使用的Jenkins版本存在漏洞(CVE-2019–1003000，CVE-2019–1003001，CVE-2019–1003002)，使得攻击者能够劫持凭据(转发的ssh密钥)，从而访问我们的生产基础架构。”</p></blockquote><p id="5650" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><a class="ae lb" href="https://www.infosecurity-magazine.com/news/matrix-compromised-through-known-1/" rel="noopener ugc nofollow" target="_blank">https://www . info security-magazine . com/news/matrix-compromised-through-known-1/</a></p></div><div class="ab cl no np hu nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="ij ik il im in"><p id="96be" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="mt">最初发布于</em> <a class="ae lb" href="https://rtfm.co.ua/en/aws-iam-users-keys-rotation-ec2-iam-roles-and-jenkins/" rel="noopener ugc nofollow" target="_blank"> <em class="mt"> RTFM: Linux，devo PSисистемноеадммиитиииииованниое</em></a><em class="mt">。</em></p></div></div>    
</body>
</html>