<html>
<head>
<title>Jenkins Shared Library</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">詹金斯共享图书馆</h1>
<blockquote>原文：<a href="https://itnext.io/jenkins-shared-library-f3408ddb3603?source=collection_archive---------5-----------------------#2020-04-26">https://itnext.io/jenkins-shared-library-f3408ddb3603?source=collection_archive---------5-----------------------#2020-04-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/e7aa0b238feb69a72f5798bdf3c6665b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ha3ghp1nPtSwjXpn"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@itfeelslikefilm?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">🇸🇮·扬科·菲利</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="6ef3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">IT界的每个人都知道什么是CI及其著名的实现，那就是<strong class="kf ir">詹金斯</strong>。在过去的几年中，DevOps工程师可以将持续集成链<em class="lb">组织为一个管道，引入一个<strong class="kf ir"> DSL </strong>(领域特定语言)来通过<em class="lb"> Jenkinsfile </em>管理它:</em></p><pre class="lc ld le lf gt lg lh li lj aw lk bi"><span id="39d4" class="ll lm iq lh b gy ln lo l lp lq">pipeline {<br/>    agent any</span><span id="55c2" class="ll lm iq lh b gy lr lo l lp lq">    stages {<br/>        stage('Build') {<br/>            steps {<br/>                echo 'Building..'<br/>            }<br/>        }<br/>        stage('Test') {<br/>            steps {<br/>                echo 'Testing..'<br/>            }<br/>        }<br/>        stage('Deploy') {<br/>            steps {<br/>                echo 'Deploying....'<br/>            }<br/>        }<br/>    }<br/>}</span></pre><p id="8a6d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面的链接<a class="ae kc" href="https://jenkins.io/doc/book/pipeline/jenkinsfile/" rel="noopener ugc nofollow" target="_blank">https://jenkins.io/doc/book/pipeline/jenkinsfile/</a>解释了它的语法和特性，但是在这篇文章中，我想用一个实际的例子向你介绍<a class="ae kc" href="https://jenkins.io/doc/book/pipeline/shared-libraries/" rel="noopener ugc nofollow" target="_blank"> Jenkins共享库</a>。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/03977859142c07433f861bece402d7bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/format:webp/1*8UiQIv0OWGSB7cn9eFWa4g.png"/></div></figure><p id="433d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如前面的脚本所示，Jenkinsfile可能变得非常不可读，为了避免这种情况，您可以编写一个库来包装您的作业。让我们从下面的管道开始:</p><pre class="lc ld le lf gt lg lh li lj aw lk bi"><span id="bcea" class="ll lm iq lh b gy ln lo l lp lq">pipeline {<br/>    agent any <br/>    tools {<br/>        jdk 'jdk11'<br/>    }<br/>    <br/>    stages {<br/>        stage('Checkout') { <br/>            steps {<br/>                ansiColor('xterm') {<br/>                    checkout scm<br/>                }<br/>            }<br/>        }<br/>        stage('Build') { <br/>            steps {<br/>                ansiColor('xterm') {<br/>                    withMaven(maven:'maven3.6.3'){<br/>                        sh 'mvn clean package'<br/>                    }<br/>                }<br/>            }<br/>        }<br/>        <br/>    }<br/>}</span></pre><p id="e607" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一个简单的检查和构建已经变得不可读，让我们想想如果你开始添加其他阶段，比如质量或部署步骤，会发生什么。为了简化管道，你可以使用Jenkins碎片库，但是让我们从头开始。为了执行前面的管道，您需要在Jenkins上安装:</p><ul class=""><li id="1dcf" class="lt lu iq kf b kg kh kk kl ko lv ks lw kw lx la ly lz ma mb bi translated">JDK11</li><li id="5228" class="lt lu iq kf b kg mc kk md ko me ks mf kw mg la ly lz ma mb bi translated">专家</li><li id="c066" class="lt lu iq kf b kg mc kk md ko me ks mf kw mg la ly lz ma mb bi translated"><a class="ae kc" href="https://plugins.jenkins.io/pipeline-maven/" rel="noopener ugc nofollow" target="_blank">管道Maven集成</a></li></ul><p id="b374" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了安装JDK11，我还安装了<a class="ae kc" href="https://plugins.jenkins.io/adoptopenjdk/" rel="noopener ugc nofollow" target="_blank"> AdoptOpenJDK安装程序</a>，如图所示，现在Jenkins可以从<em class="lb"> Global instrument </em>部分下载JDK11(我将标签设置为<em class="lb">‘JDK 11’</em>)</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mh"><img src="../Images/9c2876e241076a7c9d6efca6615b69a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*RyP3XrpdqwFA3-dA.png"/></div></div></figure><p id="c641" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我装了Maven 3.6.3，贴上了<em class="lb">‘Maven 3 . 6 . 3’</em>的标签</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mi"><img src="../Images/151dcf6a3b0fedbb5673605527d13e74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eWZE1HSNZ_25y9ie.png"/></div></div></figure><p id="976c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在你可以执行前面的管道了…但是我们能不能像下面的代码片段那样用更好的方式写前面的管道呢？</p><pre class="lc ld le lf gt lg lh li lj aw lk bi"><span id="d211" class="ll lm iq lh b gy ln lo l lp lq">@Library('jenkins-lib@1.0.0') _</span><span id="3c38" class="ll lm iq lh b gy lr lo l lp lq">jenkinslib(this, "test")<br/>    .withMavenVersion("maven3.6.3")<br/>    .withJdkVersion("jdk11")<br/>    .execute()</span></pre><p id="dfea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">是的，我们可以通过詹金斯共享库功能！第一行表示库引用:要引用一个库，您需要通过Jenkins全局配置来安装它。通常这个库必须位于SCM库，我把我的库放在<a class="ae kc" href="https://github.com/paspao/jenkins-lib/" rel="noopener ugc nofollow" target="_blank">这个github repo </a>上，然后我在Jenkins上配置它，命名为<em class="lb">‘Jenkins-lib’</em>，我还启用了<em class="lb">‘发现标签’</em>。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mj"><img src="../Images/dc4fada272ba13d6e4f37421315c494a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yamiSDqiCTexfWVC.png"/></div></div></figure><p id="1bf7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我可以在Jenkinsfile中引用我的库，如<strong class="kf ir">@ Library(' Jenkins-lib @ 1 . 0 . 0 ')</strong>或<em class="lb">@ Library(' Jenkins-lib @ master ')</em>或简单地通过标签或分支使用特定版本的<em class="lb"> @Library('jenkins-lib') </em>。在库符号后面有一个下划线<strong class="kf ir"> _ </strong>，这意味着我们想把所有东西都包含到当前的管道中(否则我们必须放一个特定的<em class="lb">导入</em>，但这不是我们的情况)。</p><p id="8e11" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们看看库结构:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/60eb07f5d6881e023e66adbdabd85315.png" data-original-src="https://miro.medium.com/v2/resize:fit:864/format:webp/0*9g_6HUg84KHkfs2R.png"/></div></figure><p id="badd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我定义了一个Jenkins库结构所需要的目录<strong class="kf ir"> vars </strong>，其中包含一个groovy脚本<em class="lb"> jenkinslib.groovy </em>，在这个目录中每个。groovy文件可以被<em class="lb"> Jekinsfile </em>引用。在我的例子中，行<em class="lb"> jenkinslib(…) </em>是对包含特殊函数<em class="lb">调用(…) </em>的<em class="lb"> jenkinslib.groovy </em>文件的引用</p><pre class="lc ld le lf gt lg lh li lj aw lk bi"><span id="3007" class="ll lm iq lh b gy ln lo l lp lq">import org.paspao.sharedlib.JenkinsBuilder</span><span id="f312" class="ll lm iq lh b gy lr lo l lp lq">JenkinsBuilder call(def scriptReference, String projectName) {<br/>    return new JenkinsBuilder(scriptReference,projectName,env['BRANCH_NAME'])<br/>}</span><span id="96a9" class="ll lm iq lh b gy lr lo l lp lq">return this</span></pre><p id="5480" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这个函数中，我简单地用一些初始化参数创建了一个对象<em class="lb"> JenkinsBuilder </em>，但是真正的消息是，我正在把我的管道从函数式编程转移到面向对象的编程，这给了管道代码更多的可读性。神奇的是使用Closure对象实现的，这个对象(获得Groovy定义)<em class="lb">是一个开放的、匿名的代码块，它可以接受参数、返回值并被赋给变量</em>。</p></div></div>    
</body>
</html>