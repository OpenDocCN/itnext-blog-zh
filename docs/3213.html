<html>
<head>
<title>How to: run BpfTrace from a small alpine image, with least privileges.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何:使用最少权限从小型alpine映像运行BpfTrace。</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-run-bpftrace-from-a-small-alpine-image-and-with-least-privileges-379146fcfcf1?source=collection_archive---------3-----------------------#2019-10-26">https://itnext.io/how-to-run-bpftrace-from-a-small-alpine-image-and-with-least-privileges-379146fcfcf1?source=collection_archive---------3-----------------------#2019-10-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/9b2f703d1a53ca1e75b61e266e347940.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UZ10YK806H5xg1F4z4YlUg.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">在<a class="ae kc" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae kc" href="https://unsplash.com/@_imkiran?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Sai Kiran Anagani </a>拍摄的照片</figcaption></figure><p id="fe82" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://github.com/iovisor/bpftrace" rel="noopener ugc nofollow" target="_blank"> BpfTrace </a>是一种用于Linux eBPF的高级跟踪语言，它允许您提取在性能和安全性调查中非常方便的信息。有关bpftrace的更多信息，请查看官方的<a class="ae kc" href="https://github.com/iovisor/bpftrace/blob/master/docs/reference_guide.md" rel="noopener ugc nofollow" target="_blank">参考指南</a>。</p><h1 id="fa1b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">TL；博士:</h1><p id="684a" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">下面是如何直接从alpine容器映像中运行bpftrace。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="1b90" class="mn lc iq mj b gy mo mp l mq mr">docker run --rm -t -v /sys/kernel/debug:/sys/kernel/debug<strong class="mj ir">:ro </strong>--cap-add=SYS_ADMIN --security-opt no-new-privileges paulinhu/bpftrace:alpine sh -c "/init.sh &amp;&amp; bpftrace -e 'kprobe:do_sys_open { printf(\"%s: %s\n\", comm, str(arg1)) } interval:s:2 { exit(); }'"</span></pre><p id="c0c6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="ms">如果以上对您不起作用，要么您的内核已经启用了锁定，要么您的内核主要版本与我构建docker映像的版本(5.x)不兼容。本页底部提供了故障排除。</em></p><p id="90bb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">运行该容器，应该会产生主机中所有当前正在执行的命令以及每个命令打开的文件的列表:</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mt"><img src="../Images/50750487433140ef090ea23917132788.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZQskhElgKAIUtMzhMSQlKQ.png"/></div></div></figure><p id="83a8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请注意，容器中唯一装载的文件夹处于只读模式。另外，在上面的例子中，我没有使用seccomp配置文件运行。在这篇文章的后面，我将展示一个自定义的seccomp配置文件以及如何使用它——假设你有这样的倾向。:)</p><h1 id="ea6d" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">说来话长…</h1><p id="89cd" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我找不到任何可以简单下载并使用bpftrace的alpine图像。我发现这有点奇怪，但后来试图建立自己的我意识到为什么。这一努力面临的基本挑战如下:</p><h2 id="3b72" class="mn lc iq bd ld mu mv dn lh mw mx dp ll ko my mz lp ks na nb lt kw nc nd lx ne bi translated">1.没有用于alpine的稳定bpftrace包</h2><p id="5af0" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">目前，alpine唯一可用的bpftrace 包正在测试中。我不喜欢依赖测试包，因为它们可能会改变，会破坏你的docker构建命令。</p><h2 id="dc20" class="mn lc iq bd ld mu mv dn lh mw mx dp ll ko my mz lp ks na nb lt kw nc nd lx ne bi translated">2.阿尔卑斯山不容易获得的依赖</h2><p id="549b" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">如果重点是使用ubuntu，您可以用bpftrace用一个命令简单地生成一个图像:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="4d4d" class="mn lc iq mj b gy mo mp l mq mr">FROM ubuntu:disco as build</span><span id="a8a2" class="mn lc iq mj b gy nf mp l mq mr">RUN apt update &amp;&amp; apt install -y bpftrace linux-headers-$(uname -r)</span></pre><p id="21ff" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于“登山客”来说，故事并不那么简单。</p><h2 id="821c" class="mn lc iq bd ld mu mv dn lh mw mx dp ll ko my mz lp ks na nb lt kw nc nd lx ne bi translated">3.Bpftrace依赖于主机内核</h2><p id="261f" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">在运行时，bpftrace将使用<strong class="kf ir">目标主机</strong>的内核发布名称来引用内核头。这意味着，如果您在您的机器上构建一个5 . 0 . 0–32-generic的映像，并尝试在5 . 0 . 0–1020-GCP的服务器上运行该映像，它将无法运行。</p><h1 id="98ff" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">建立一个轻松的bpftrace形象</h1><p id="531d" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">上述大多数问题都可以通过从源代码构建所有依赖项来解决。使用一个<a class="ae kc" href="https://docs.docker.com/develop/develop-images/multistage-build/" rel="noopener ugc nofollow" target="_blank">多级构建</a>，所有的源代码都可以下载，连同它们的依赖项和它们的构建依赖项。最后，只需要将静态文件复制到alpine:latest映像中。生成的docker文件如下所示:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="e117" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意，为了解决内核版本名称的运行时依赖性，我创建了一个init.sh脚本，它将主机内核模块名称符号链接到在映像构建时创建的名称。除非它们大相径庭，否则bpftrace不应抱怨。显然，类型会随着新的内核版本而改变，所以您应该努力为目标机器构建，但是，使用这种方法，您应该会有一些偏差。</p><p id="7fe2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用上面的docker映像，假设您的目标类似于您的本地机器，您可以使用:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="3103" class="mn lc iq mj b gy mo mp l mq mr">build -t my-bpftrace:alpine \<br/>--build-arg KERNEL_VERSION=$(uname -r | awk -F- '{ print $1 }'<!-- -->)<!-- --> \<br/>--build-arg KERNEL_RELEASE=$(<!-- -->uname -r)<!-- --> \<br/>.</span></pre><p id="4893" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">构建完成后，您可以使用下面的代码在同一台机器上执行:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="4448" class="mn lc iq mj b gy mo mp l mq mr">docker run --rm -t -v /sys/kernel/debug:/sys/kernel/debug:ro<strong class="mj ir"> </strong>--cap-add=SYS_ADMIN --security-opt no-new-privileges my-bpftrace:alpine bpftrace -e 'kprobe:do_sys_open { printf("%s: %s\n", comm, str(arg1)) } interval:s:2 { exit(); }'</span></pre><p id="926b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您需要在使用不同内核版本名的不同机器上运行，确保您首先执行<code class="fe ni nj nk mj b">/init.sh</code>。在这种情况下，还要确保避免任何双引号:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="5203" class="mn lc iq mj b gy mo mp l mq mr">docker run --rm -t -v /sys/kernel/debug:/sys/kernel/debug<strong class="mj ir">:ro </strong>--cap-add=SYS_ADMIN --security-opt no-new-privileges my-bpftrace:alpine <strong class="mj ir">sh -c "/init.sh &amp;&amp;</strong> bpftrace -e 'kprobe:do_sys_open { printf(<strong class="mj ir">\"</strong>%s: %s\n<strong class="mj ir">\"</strong>, comm, str(arg1)) } interval:s:2 { exit(); }'<strong class="mj ir">"</strong></span></pre><p id="a9c4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果是一个80mb的容器映像:</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/f407789641fd23ff88174dc9962f7e9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yYE22wQIq1H5ASd9Q1v04A.png"/></div></div></figure><p id="6b5f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">压缩后变成27mb:</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/f89f15b99896891c4d953cad40478a4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1148/format:webp/1*nBqQB6qV7g2ozYwJNgIikA.png"/></div></div></figure><p id="8e19" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就是这样！至此，您已经有了一个运行bpftrace命令的简单图像。下面的位是可选的，假设你不关心seccomp，并且在这个过程中没有任何问题。:)</p><p id="6aa9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">关于构建图像的完整代码，请查看<a class="ae kc" href="https://github.com/pjbgf/container-images/blob/master/bpftrace" rel="noopener ugc nofollow" target="_blank">这个报告</a>。</p><h1 id="6c1d" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">用seccomp限制容器图像</h1><p id="d658" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">BpfTrace必须使用<code class="fe ni nj nk mj b">CAP_SYS_ADMIN</code>功能来执行，并且还具有对<code class="fe ni nj nk mj b">/sys/kernel/debug</code>文件夹的(只读)访问权。使用自定义的seccomp配置文件有助于减少攻击面，在运行这种功能时，攻击面并不小。</p><p id="a5d7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">以下是我一直使用的配置文件:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="7886" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">可以通过添加<code class="fe ni nj nk mj b">--security-opt seccomp=profile-name.json</code>来引用seccomp配置文件。最终的命令应该类似于:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="83e2" class="mn lc iq mj b gy mo mp l mq mr">docker run --rm -t -v /sys/kernel/debug:/sys/kernel/debug:ro<strong class="mj ir"> </strong>--cap-add=SYS_ADMIN <strong class="mj ir">--security-opt seccomp=bpftrace.json</strong> <!-- -->--security-opt no-new-privileges paulinhu/bpftrace:alpine sh -c "/init.sh &amp;&amp; bpftrace -e 'kprobe:do_sys_open { printf(\"%s: %s\n\", comm, str(arg1)) } interval:s:2 { exit(); }'"</span></pre><p id="6475" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过应用seccomp配置文件，容器将受到限制，并且不能使用运行bpftrace命令所需的系统调用之外的系统调用。</p><h2 id="971c" class="mn lc iq bd ld mu mv dn lh mw mx dp ll ko my mz lp ks na nb lt kw nc nd lx ne bi translated">玩弄bpftrace</h2><p id="7cac" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">有许多在线工具可以让您更深入地了解服务器上正在发生的事情，这超出了本文的范围。但是这里有一个bpftrace的<a class="ae kc" href="https://github.com/iovisor/bpftrace" rel="noopener ugc nofollow" target="_blank">报告</a>中的例子摘录:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="1f8b" class="mn lc iq mj b gy mo mp l mq mr"># Syscall count by program<br/>bpftrace -e 'tracepoint:raw_syscalls:sys_enter { @[comm] = count(); }'<br/><br/># Read bytes by process:<br/>bpftrace -e 'tracepoint:syscalls:sys_exit_read /args-&gt;ret/ { @[comm] = sum(args-&gt;ret); }'<br/><br/># Show per-second syscall rates:<br/>bpftrace -e 'tracepoint:raw_syscalls:sys_enter { @ = count(); } interval:s:1 { print(@); clear(@); }'<br/><br/># Trace disk size by process<br/>bpftrace -e 'tracepoint:block:block_rq_issue { printf("%d %s %d\n", pid, comm, args-&gt;bytes); }'<br/><br/># Count page faults by process<br/>bpftrace -e 'software:faults:1 { @[comm] = count(); }'<br/><br/># Files opened by process<br/>bpftrace -e 'tracepoint:syscalls:sys_enter_open { printf("%s %s\n", comm, str(args-&gt;filename)); }'</span></pre><p id="a2c1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">运行它们时，您可以通过在末尾添加<code class="fe ni nj nk mj b">interval:s:1 { exit(); }</code>来定义超时。还要确保你阅读了官方的<a class="ae kc" href="https://github.com/iovisor/bpftrace/blob/master/docs/tutorial_one_liners.md" rel="noopener ugc nofollow" target="_blank">一行程序教程</a>。</p></div><div class="ab cl nn no hu np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="ij ik il im in"><h1 id="3654" class="lb lc iq bd ld le nu lg lh li nv lk ll lm nw lo lp lq nx ls lt lu ny lw lx ly bi translated">解决纷争</h1><h2 id="a0f6" class="mn lc iq bd ld mu mv dn lh mw mx dp ll ko my mz lp ks na nb lt kw nc nd lx ne bi translated">内核锁定已启用</h2><p id="1176" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">这将是一些桌面发行版的默认设置，比如Ubuntu。在尝试禁用它之前，确保您正在使用<code class="fe ni nj nk mj b">CAP_SYS_ADMIN</code>运行容器。</p><p id="0bfd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">症状<br/> </strong>当执行容器时你得到下面的错误:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="3d58" class="mn lc iq mj b gy mo mp l mq mr">No error information: couldn't set RLIMIT_MEMLOCK for bpftrace. If your program is not loading, you can try "ulimit -l 8192" to fix the problem</span><span id="3b18" class="mn lc iq mj b gy nf mp l mq mr"><strong class="mj ir">Error creating printf map: Operation not permitted<br/>Creation of the required BPF maps has failed.<br/></strong>Make sure you have all the required permissions and are not confined (e.g. like snapcraft does). `dmesg` will likely have useful output for further troubleshooting</span></pre><p id="543f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">解决方法<br/> </strong>禁用内核锁定:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="5a7b" class="mn lc iq mj b gy mo mp l mq mr">sudo bash -c 'echo 1 &gt; /proc/sys/kernel/sysrq'<br/>sudo bash -c 'echo x &gt; /proc/sysrq-trigger'</span><span id="d253" class="mn lc iq mj b gy nf mp l mq mr"># https://bugzilla.redhat.com/show_bug.cgi?id=1599197</span></pre><h2 id="c3b4" class="mn lc iq bd ld mu mv dn lh mw mx dp ll ko my mz lp ks na nb lt kw nc nd lx ne bi translated">我不能在容器内执行命令</h2><p id="fcb0" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">使用上面的seccomp配置文件运行映像将会限制在该容器中可以执行的内容。</p><p id="0543" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">症状<br/> </strong>运行ls命令导致几个错误:</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/1ec2522e713554a38a7c0da404e8c81e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/format:webp/1*dgGDumDFhE851sgZKqpcfw.png"/></div></figure><p id="e707" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">解决方法<br/> </strong>这里有两个选项:1)根据您的实际需要定制seccomp配置文件。2)不要使用seccomp配置文件。</p><h2 id="8c14" class="mn lc iq bd ld mu mv dn lh mw mx dp ll ko my mz lp ks na nb lt kw nc nd lx ne bi translated">致命错误:找不到“linux/types.h”文件</h2><p id="1317" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">BpfTrace找不到内核头。</p><p id="a438" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">症状</strong></p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="74c5" class="mn lc iq mj b gy mo mp l mq mr">No error information: couldn’t set RLIMIT_MEMLOCK for bpftrace. If your program is not loading, you can try “ulimit -l 8192” to fix the problem</span><span id="3313" class="mn lc iq mj b gy nf mp l mq mr"><strong class="mj ir">/bpftrace/include/asm_goto_workaround.h:14:10: fatal error: ‘linux/types.h’ file not found</strong></span></pre><p id="c57c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">解决方法</strong> <br/>很可能是/init.sh命令没有执行。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="fe28" class="mn lc iq mj b gy mo mp l mq mr">/init.sh</span></pre><p id="dbab" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果上述问题仍然存在，请检查构建映像的内核与执行映像的内核是否兼容。</p><p id="29d0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于一般错误，请查看<a class="ae kc" href="https://github.com/iovisor/bcc/blob/master/FAQ.txt" rel="noopener ugc nofollow" target="_blank">密件抄送常见问题</a>。</p></div></div>    
</body>
</html>