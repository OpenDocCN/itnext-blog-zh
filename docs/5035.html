<html>
<head>
<title>ArgoCD: a Helm chart deployment, and working with Helm Secrets via AWS KMS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ArgoCD:一个舵图表部署，并通过自动气象站KMS与舵的秘密</h1>
<blockquote>原文：<a href="https://itnext.io/argocd-a-helm-chart-deployment-and-working-with-helm-secrets-via-aws-kms-96509bfc5eb3?source=collection_archive---------0-----------------------#2020-11-22">https://itnext.io/argocd-a-helm-chart-deployment-and-working-with-helm-secrets-via-aws-kms-96509bfc5eb3?source=collection_archive---------0-----------------------#2020-11-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/6fa9fa8d92e262b4258055084897046e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8MDBjrYv5W2ANPok4EO3Tg.png"/></div></div></figure><p id="a6f4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在之前的文章<a class="ae kw" href="https://rtfm.co.ua/en/argocd-an-overview-ssl-configuration-and-an-application-deploy/" rel="noopener ugc nofollow" target="_blank"> ArgoCD:概述、SSL配置和应用程序部署</a>中，我们简要概述了如何使用ArgoCD，现在让我们尝试部署一个导航图。</p><p id="4b7b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这其中最有趣的部分是如何启用<a class="ae kw" href="https://rtfm.co.ua/en/helm-helm-secrets-sensitive-data-encryption-with-aws-kms-and-use-it-from-jenkins/" rel="noopener ugc nofollow" target="_blank">掌舵秘笈</a>。使用它有些困难，但最终，它像预期的那样工作了。</p><h1 id="886b" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">内容</h1><ul class=""><li id="6fa0" class="lv lw iq ka b kb lx kf ly kj lz kn ma kr mb kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-a-helm-chart-deployment-and-working-with-helm-secrets-via-aws-kms/#ArgCD_a_Helm_chart_deployment" rel="noopener ugc nofollow" target="_blank"> ArgCD:舵图展开</a></li><li id="66f3" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-a-helm-chart-deployment-and-working-with-helm-secrets-via-aws-kms/#ArgoCD_adding_a_private_Github_repository" rel="noopener ugc nofollow" target="_blank"> ArgoCD:添加私有Github库</a></li><li id="eb20" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-a-helm-chart-deployment-and-working-with-helm-secrets-via-aws-kms/#Github_SSH_key" rel="noopener ugc nofollow" target="_blank"> Github SSH密钥</a></li><li id="4e59" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-a-helm-chart-deployment-and-working-with-helm-secrets-via-aws-kms/#ArgoCD_repositories" rel="noopener ugc nofollow" target="_blank"> ArgoCD储存库</a></li><li id="142f" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-a-helm-chart-deployment-and-working-with-helm-secrets-via-aws-kms/#Adding_an_ArgoCD_application" rel="noopener ugc nofollow" target="_blank">添加ArgoCD应用程序</a></li><li id="0897" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-a-helm-chart-deployment-and-working-with-helm-secrets-via-aws-kms/#ArgoCD_and_Helm_Secrets" rel="noopener ugc nofollow" target="_blank"> ArgoCD和舵的秘密</a></li><li id="e27c" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-a-helm-chart-deployment-and-working-with-helm-secrets-via-aws-kms/#InitContainer_with_a_sharedvolume" rel="noopener ugc nofollow" target="_blank">使用共享卷初始化容器</a></li><li id="a3bf" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-a-helm-chart-deployment-and-working-with-helm-secrets-via-aws-kms/#Building_ArgoCD_Docker_image_with_the_helmsecrets_plugin_installed" rel="noopener ugc nofollow" target="_blank">在安装了头盔秘密插件的情况下构建ArgoCD Docker镜像</a></li><li id="4e2c" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-a-helm-chart-deployment-and-working-with-helm-secrets-via-aws-kms/#SOPS_and_AWS_KMS_%E2%80%93_authentification" rel="noopener ugc nofollow" target="_blank">KMS SOPS和AWS认证</a></li><li id="de1c" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-a-helm-chart-deployment-and-working-with-helm-secrets-via-aws-kms/#AWS_IAM_User" rel="noopener ugc nofollow" target="_blank"> AWS IAM用户</a></li><li id="b93c" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-a-helm-chart-deployment-and-working-with-helm-secrets-via-aws-kms/#AWS_credentials_and_config" rel="noopener ugc nofollow" target="_blank"> AWS凭证和配置</a></li><li id="c418" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-a-helm-chart-deployment-and-working-with-helm-secrets-via-aws-kms/#Adding_secrets_yaml" rel="noopener ugc nofollow" target="_blank">添加secrets.yaml </a></li></ul><h1 id="905f" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">ArgCD:舵图部署</h1><p id="0daa" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">创建测试图表:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="7869" class="mx ky iq mt b gy my mz l na nb">$ helm create test-helm-chart<br/>Creating test-helm-chart</span></pre><p id="6b88" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本地检查:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="338c" class="mx ky iq mt b gy my mz l na nb">$ helm upgrade — install — namespace dev-1-test-helm-chart-ns — create-namespace test-helm-chart-release test-helm-chart/ — debug — dry-run<br/>…<br/>{}<br/>NOTES:<br/>1. Get the application URL by running these commands:<br/>export POD_NAME=$(kubectl get pods — namespace dev-1-test-helm-chart-ns -l “app.kubernetes.io/name=test-helm-chart,app.kubernetes.io/instance=test-helm-chart-release” -o jsonpath=”{.items[0].metadata.name}”)<br/>export CONTAINER_PORT=$(kubectl get pod — namespace dev-1-test-helm-chart-ns $POD_NAME -o jsonpath=”{.spec.containers[0].ports[0].containerPort}”)<br/>echo “Visit <a class="ae kw" href="http://127.0.0.1:8080" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8080</a> to use your application”<br/>kubectl — namespace dev-1-test-helm-chart-ns port-forward $POD_NAME 8080:$CONTAINER_PORT</span></pre><p id="c0ca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好的——它工作了，把它推到Github库。</p><h2 id="d30e" class="mx ky iq bd kz nc nd dn ld ne nf dp lh kj ng nh ll kn ni nj lp kr nk nl lt nm bi translated">ArgoCD:添加私有Github存储库</h2><h2 id="4068" class="mx ky iq bd kz nc nd dn ld ne nf dp lh kj ng nh ll kn ni nj lp kr nk nl lt nm bi translated">Github SSH密钥</h2><p id="a44b" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">我们有一个Github组织。稍后将为ArgoCD创建一个专门的Github用户，但现在，我们可以为我们的帐户添加一个新的RSA-key。</p><p id="2b1e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">实际上，我们可以通过使用login:token来配置访问，但是key似乎是更好的选择。</p><p id="5937" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">生成密钥:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="691c" class="mx ky iq mt b gy my mz l na nb">$ ssh-keygen -f ~/.ssh/argocd-github-key<br/>Generating public/private rsa key pair.<br/>…</span></pre><p id="b489" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加到Github — <em class="nn">设置&gt; SSH按键</em>:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi no"><img src="../Images/9e44d927d36da2fb2ac56a55b2c0a328.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/0*QIKLLnoILBCSdGNE.png"/></div></figure><h2 id="ef50" class="mx ky iq bd kz nc nd dn ld ne nf dp lh kj ng nh ll kn ni nj lp kr nk nl lt nm bi translated">ArgoCD存储库</h2><p id="9343" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">转到<em class="nn">设置—存储库</em>:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi np"><img src="../Images/beb129d3b8e3676dc60f2af4c5ae9716.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rTER-ZUJBgVh-BdJ.png"/></div></div></figure><p id="6d31" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择<em class="nn">使用SSH连接回购</em>:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/0f7d1bee9d1d638cb283d8c9a106e09e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NL2dlRLYLixpHc9m.png"/></div></div></figure><p id="243c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">设置名称、URL，添加私钥:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/d3d6890068d5ba12ba0ec4f85afe4daa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QIle1tP8U7biweEz.png"/></div></div></figure><p id="7720" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">密钥将存储在一个Kubernetes的秘密中:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="f6d0" class="mx ky iq mt b gy my mz l na nb">$ kk -n dev-1-devops-argocd-ns get secrets<br/>NAME TYPE DATA AGE<br/>argocd-application-controller-token-mc457 kubernetes.io/service-account-token 3 45h<br/>argocd-dex-server-token-74r75 kubernetes.io/service-account-token 3 45h<br/>argocd-secret Opaque 5 45h<br/>argocd-server-token-54mfx kubernetes.io/service-account-token 3 45h<br/>default-token-6mmr5 kubernetes.io/service-account-token 3 45h<br/>repo-332507798 Opaque 1 13m</span></pre><p id="3416" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nn">回购-332507798 </em> —在这里。</p><p id="d2c7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">点击<em class="nn">连接</em>。</p><h2 id="697b" class="mx ky iq bd kz nc nd dn ld ne nf dp lh kj ng nh ll kn ni nj lp kr nk nl lt nm bi translated">添加ArgoCD应用程序</h2><p id="3cc3" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">创建新应用程序:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/5f6d1d6db42853f6803aacf1796d14a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Pd5fHaNkHNfeJWUD.png"/></div></div></figure><p id="6a3b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">设置其名称，项目保留<em class="nn">默认</em>，在<em class="nn">同步策略</em>中<em class="nn">自动创建命名空间</em>可以启用:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/a781d9a7467922f70ab4b9fcabd77cdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*g-bEjTywKsXr4uOw.png"/></div></div></figure><p id="01e5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<em class="nn">Source</em>leave<em class="nn">Git</em>中，设置一个资源库的URL，在<em class="nn"> Revision </em>中指定一个分支，在<em class="nn"> Path </em> — path中加入我们的图表目录。</p><p id="b5a6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在当前情况下，存储库是<em class="nn"> devops-kubernetes </em>，图表的目录—<em class="nn">tests/test-helm-chart/</em>，ArgoCD将扫描存储库并建议您选择其中的可用目录:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/b748b7018bafb222fa76619e97c44395.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JKQzhl1xlrPy8tX3.png"/></div></div></figure><p id="baf9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<em class="nn">目的地</em>选择本地Kubernetes集群中，为将要部署图表的位置设置一个名称空间:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/beccca05db023ca4145d69649926b3a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1384/format:webp/0*YBhXtBT-CyL9tlak.png"/></div></figure><p id="f380" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<em class="nn">目的地</em>而不是<em class="nn">目录</em>中设置<em class="nn">舵</em>，尽管Argo发现这是存储库中的舵图目录，并且已经设置了舵本身，并且已经扫描了来自<code class="fe nw nx ny mt b">values.yaml</code>的值。</p><p id="7b91" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">可以保留默认值，稍后我们将在这里添加我们的<code class="fe nw nx ny mt b">secrets.yaml</code>:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/fc6f61f411cd8acb6768fdd4821be798.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LiaNFrPe6ndTEEnJ.png"/></div></div></figure><p id="1733" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/852d3b7772ae408d5075d48b7b436841.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MTAR7wD_a9ArcxTy.png"/></div></div></figure><p id="1705" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您现在单击该应用程序，您将看到ArgoCD已经扫描了模板并创建了一个清单来显示将从该Helm图表中部署哪些资源:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/5d8419edc55e4579ddb300fb1d0f15ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LTk4bh0cyUTXLtew.png"/></div></div></figure><p id="6a95" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">点击<em class="nn">同步</em>，这里可以看到可用的选项，如<em class="nn">修剪</em>和<em class="nn">试运行</em>:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/accc15e3fd68896e404484f31d11253c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MT_Dg909A-MywU-w.png"/></div></div></figure><p id="8b47" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">点击<em class="nn">同步</em>——部署开始:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/1988b82bea622539f0cb44cb5c8725e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lMLXqpNznsinm1xU.png"/></div></div></figure><p id="37fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成—一切正常运行:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/bf3f0022422910f2eeca7ff23a045825.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1QF2qNLrZKYqfxqc.png"/></div></div></figure><p id="4b10" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">立即查看应用程序列表:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="b3cb" class="mx ky iq mt b gy my mz l na nb">$ argocd app list<br/>NAME CLUSTER NAMESPACE PROJECT STATUS HEALTH SYNCPOLICY CONDITIONS REPO PATH TARGET<br/>guestbook <a class="ae kw" href="https://kubernetes.default.svc" rel="noopener ugc nofollow" target="_blank">https://kubernetes.default.svc</a> default default Synced Healthy &lt;none&gt; &lt;none&gt; <a class="ae kw" href="https://github.com/argoproj/argocd-example-apps.git" rel="noopener ugc nofollow" target="_blank">https://github.com/argoproj/argocd-example-apps.git</a> guestbook HEAD<br/>test-helm-chart <a class="ae kw" href="https://kubernetes.default.svc" rel="noopener ugc nofollow" target="_blank">https://kubernetes.default.svc</a> dev-1-devops-test-helm-chart-ns default Synced Healthy &lt;none&gt; &lt;none&gt; git@github.com:***/devops-kubernetes.git tests/test-helm-chart DVPS-458-ArgoCD</span></pre><p id="a42b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">命名空间中的窗格:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="c5f8" class="mx ky iq mt b gy my mz l na nb">$ kubectl -n dev-1-devops-test-helm-chart-ns get pod<br/>NAME READY STATUS RESTARTS AGE<br/>test-helm-chart-67dccc9fb4–2m5rf 1/1 Running 0 2m27s</span></pre><p id="2662" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">而现在我们可以去<a class="ae kw" href="https://rtfm.co.ua/helm-helm-secrets-shifrovanie-sensitive-dannyx-s-aws-kms-i-deploj-iz-jenkins/" rel="noopener ugc nofollow" target="_blank">掌舵秘笈</a>配置了。</p><h1 id="5b5d" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">ArgoCD和舵的秘密</h1><p id="19a5" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">所以，一切都很容易，直到我们不想使用我们的秘密，因为在ArgoCD头盔没有安装必要的插件。</p><p id="a7cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">可用选项是根据文档<a class="ae kw" href="https://argoproj.github.io/argo-cd/user-guide/helm/#helm-plugins" rel="noopener ugc nofollow" target="_blank">此处&gt; &gt; &gt; </a>用ArgoCD构建自定义Docker镜像，或者如<a class="ae kw" href="https://argoproj.github.io/argo-cd/operator-manual/custom_tools/#adding-tools-via-volume-mounts" rel="noopener ugc nofollow" target="_blank">此处&gt;&gt;</a>所述通过共享卷用Kubernetes InitContainer安装插件。</p><h2 id="f909" class="mx ky iq bd kz nc nd dn ld ne nf dp lh kj ng nh ll kn ni nj lp kr nk nl lt nm bi translated">具有共享卷的InitContainer</h2><p id="74ac" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">我尝试的第一个解决方案是具有共享卷的InitContainer，一般来说，它工作得很好——插件被安装了。</p><p id="af4b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下一步是部署argocd-repo-server :</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="8f38" class="mx ky iq mt b gy my mz l na nb">---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  labels:<br/>    app.kubernetes.io/component: repo-server<br/>    app.kubernetes.io/name: argocd-repo-server<br/>    app.kubernetes.io/part-of: argocd<br/>  name: argocd-repo-server<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app.kubernetes.io/name: argocd-repo-server<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app.kubernetes.io/name: argocd-repo-server<br/>    spec:<br/>      automountServiceAccountToken: false<br/>      initContainers:<br/>      - name: argo-tools<br/>        image: alpine/helm<br/>        command: [sh, -c]<br/>        args:<br/>        - apk add git &amp;&amp;<br/>          apk add curl &amp;&amp;<br/>          apk add bash &amp;&amp;<br/>          helm plugin install <a class="ae kw" href="https://github.com/futuresimple/helm-secrets" rel="noopener ugc nofollow" target="_blank">https://github.com/futuresimple/helm-secrets</a><br/>        volumeMounts:<br/>        - mountPath: /root/.local/share/helm/plugins/<br/>          name: argo-tools<br/>      containers:<br/>      - command:<br/>        - uid_entrypoint.sh<br/>        - argocd-repo-server<br/>        - --redis<br/>        - argocd-redis:6379<br/>        image: argoproj/argocd:v1.7.9<br/>        imagePullPolicy: Always<br/>        name: argocd-repo-server<br/>        ports:<br/>        - containerPort: 8081<br/>        - containerPort: 8084<br/>        readinessProbe:<br/>          initialDelaySeconds: 5<br/>          periodSeconds: 10<br/>          tcpSocket:<br/>            port: 8081<br/>        volumeMounts:<br/>        - mountPath: /app/config/ssh<br/>          name: ssh-known-hosts<br/>        - mountPath: /app/config/tls<br/>          name: tls-certs<br/>        - mountPath: /app/config/gpg/source<br/>          name: gpg-keys<br/>        - mountPath: /app/config/gpg/keys<br/>          name: gpg-keyring<br/>        - mountPath: /home/argocd/.local/share/helm/plugins/<br/>          name: argo-tools<br/>      volumes:<br/>      - configMap:<br/>          name: argocd-ssh-known-hosts-cm<br/>        name: ssh-known-hosts<br/>      - configMap:<br/>          name: argocd-tls-certs-cm<br/>        name: tls-certs<br/>      - configMap:<br/>          name: argocd-gpg-keys-cm<br/>        name: gpg-keys<br/>      - emptyDir: {}<br/>        name: gpg-keyring<br/>      - emptyDir: {}<br/>        name: argo-tools</span></pre><p id="50f0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里有一个用<em class="nn"> argo-tools </em>名称创建的<code class="fe nw nx ny mt b">emptyDir</code>卷，然后一个名为<em class="nn"> argo-tools </em>的<code class="fe nw nx ny mt b">initContainer</code>从这个卷开始附加到<code class="fe nw nx ny mt b">/root/.local/share/helm/plugins/</code>目录，然后安装<code class="fe nw nx ny mt b">git</code>、<code class="fe nw nx ny mt b">curl</code>和<code class="fe nw nx ny mt b">bash</code>，最后执行<code class="fe nw nx ny mt b">helm plugin install https://github.com/futuresimple/helm-secrets</code>。</p><p id="0d9a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">与<code class="fe nw nx ny mt b">/home/argocd/.local/share/helm/plugins/</code>目录相同的卷<em class="nn"> argo-tools </em>被安装到<em class="nn"> argocd-repo-server </em> pod，并且<em class="nn"> argocd-repo-server </em>容器中的<code class="fe nw nx ny mt b">helm</code>可以看到插件并能够使用它。</p><p id="a6e2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是问题来了:我们如何执行<code class="fe nw nx ny mt b">helm secrets install</code>命令？默认情况下，ArgoCD调用<code class="fe nw nx ny mt b">/usr/local/bin/helm</code>二进制文件，没有办法给它指定额外的参数。</p><p id="b4ec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，必须使用第二个选项——构建一个安装了<code class="fe nw nx ny mt b">helm-secrets</code>和<code class="fe nw nx ny mt b">sops</code>的定制映像，并编写一个包装器脚本来执行<code class="fe nw nx ny mt b">helm</code>二进制文件。</p><h2 id="1d09" class="mx ky iq bd kz nc nd dn ld ne nf dp lh kj ng nh ll kn ni nj lp kr nk nl lt nm bi translated">使用安装的<code class="fe nw nx ny mt b">helm-secrets</code>插件构建ArgoCD Docker映像</h2><p id="497c" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">解决方案是在这里搜索到的— <a class="ae kw" href="https://hackernoon.com/how-to-handle-kubernetes-secrets-with-argocd-and-sops-r92d3wt1" rel="noopener ugc nofollow" target="_blank">如何用ArgoCD和Sops处理Kubernetes的秘密</a>。</p><p id="66ee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先—需要编写我们的包装器脚本。</p><p id="870d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">必须调用脚本，而不是带有已知参数<code class="fe nw nx ny mt b">template</code>、<code class="fe nw nx ny mt b">install</code>、<code class="fe nw nx ny mt b">upgrade</code>、<code class="fe nw nx ny mt b">lint</code>和<code class="fe nw nx ny mt b">diff</code>的<code class="fe nw nx ny mt b">/usr/local/bin/helm</code>二进制文件，которыепонимаетплаггн<code class="fe nw nx ny mt b">helm-secrets</code>，并将带有所有参数的命令传递给<code class="fe nw nx ny mt b">helm secrets</code>。</p><p id="f476" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">执行<code class="fe nw nx ny mt b">helm secrets @arguments</code>后，输出被打印，删除了“<em class="nn">删除的‘secrets . YAML . dec</em>’”字符串:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="3867" class="mx ky iq mt b gy my mz l na nb">#! /bin/sh<br/>    <br/># helm secrets only supports a few helm commands<br/>if [ $1 = "template" ] || [ $1 = "install" ] || [ $1 = "upgrade" ] || [ $1 = "lint" ] || [ $1 = "diff" ]<br/>then <br/>    # Helm secrets add some useless outputs to every commands including template, namely<br/>    # 'remove: &lt;secret-path&gt;.dec' for every decoded secrets.<br/>    # As argocd use helm template output to compute the resources to apply, these outputs<br/>    # will cause a parsing error from argocd, so we need to remove them.<br/>    # We cannot use exec here as we need to pipe the output so we call helm in a subprocess and<br/>    # handle the return code ourselves.<br/>    out=$(helm.bin secrets $@) <br/>    code=$? <br/>    if [ $code -eq 0 ]; then<br/>        # printf insted of echo here because we really don't want any backslash character processing<br/>        printf '%s\n' "$out" | sed -E "/^removed '.+\.dec'$/d"      <br/>        exit 0<br/>    else<br/>        exit $code<br/>    fi<br/>else<br/>    # helm.bin is the original helm binary<br/>    exec helm.bin $@<br/>fi</span></pre><p id="2f58" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下一件事是用<code class="fe nw nx ny mt b">helm-scerets</code>和<code class="fe nw nx ny mt b">sops</code>构建自己的Docker映像，并用我们的包装器替换<code class="fe nw nx ny mt b">/usr/local/bin/helm</code>。</p><p id="0623" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">找到最新版SOPS——<a class="ae kw" href="https://github.com/mozilla/sops/releases/" rel="noopener ugc nofollow" target="_blank">https://github.com/mozilla/sops/releases/</a>，以及最新版掌舵人秘笈——<a class="ae kw" href="https://github.com/zendesk/helm-secrets/releases" rel="noopener ugc nofollow" target="_blank">https://github.com/zendesk/helm-secrets/releases</a>。</p><p id="02ce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">写一个Dockerfile文件:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="9a13" class="mx ky iq mt b gy my mz l na nb">FROM argoproj/argocd:v1.7.9<br/>    <br/>ARG SOPS_VERSION="v3.6.1"<br/>ARG HELM_SECRETS_VERSION="2.0.2" <br/><br/>USER root  <br/>COPY helm-wrapper.sh /usr/local/bin/<br/>RUN apt-get update  --allow-insecure-repositories --allow-unauthenticated &amp;&amp; \<br/>    apt-get install -y \<br/>    curl \<br/>    gpg &amp;&amp; \<br/>    apt-get clean &amp;&amp; \<br/>    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* &amp;&amp; \<br/>    curl -o /usr/local/bin/sops -L <a class="ae kw" href="https://github.com/mozilla/sops/releases/download/${SOPS_VERSION}/sops-${SOPS_VERSION}.linux" rel="noopener ugc nofollow" target="_blank">https://github.com/mozilla/sops/releases/download/${SOPS_VERSION}/sops-${SOPS_VERSION}.linux</a> &amp;&amp; \<br/>    chmod +x /usr/local/bin/sops &amp;&amp; \<br/>    cd /usr/local/bin &amp;&amp; \<br/>    mv helm helm.bin &amp;&amp; \<br/>    mv helm2 helm2.bin &amp;&amp; \<br/>    mv helm-wrapper.sh helm &amp;&amp; \<br/>    ln helm helm2 &amp;&amp; \<br/>    chmod +x helm helm2<br/>    <br/># helm secrets plugin should be installed as user argocd or it won't be found<br/>USER argocd<br/>RUN /usr/local/bin/helm.bin plugin install <a class="ae kw" href="https://github.com/zendesk/helm-secrets" rel="noopener ugc nofollow" target="_blank">https://github.com/zendesk/helm-secrets</a> --version ${HELM_SECRETS_VERSION}<br/>ENV HELM_PLUGINS="/home/argocd/.local/share/helm/plugins/"</span></pre><p id="1940" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">构建图像——下面的存储库是公开的，因此您可以在这里使用图像。</p><p id="2055" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用构建图像所用的ArgoCD加上您自己的内部版本号来标记图像，这里是1:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="3f74" class="mx ky iq mt b gy my mz l na nb">$ docker build -t setevoy/argocd-helm-secrets:v1.7.9–1 .<br/>$ docker push setevoy/argocd-helm-secrets:v1.7.9–1</span></pre><p id="b231" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，需要更新<a class="ae kw" href="https://rtfm.co.ua/en/argocd-an-overview-ssl-configuration-and-an-application-deploy/" rel="noopener ugc nofollow" target="_blank">上一篇文章</a>中用于部署ArgoCD的<code class="fe nw nx ny mt b">install.yaml</code>。</p><h2 id="3eca" class="mx ky iq bd kz nc nd dn ld ne nf dp lh kj ng nh ll kn ni nj lp kr nk nl lt nm bi translated">sop和AWS KMS —认证</h2><p id="7875" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">在我们的例子中，我们使用来自AWS密钥管理服务的密钥，因此来自<code class="fe nw nx ny mt b">setevoy/argocd-helm-secrets:v1.7.9-1</code>映像的容器中的sop必须能够访问AWS帐户和这个密钥。</p><p id="8f98" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">SOPS <a class="ae kw" href="https://github.com/mozilla/sops#2usage" rel="noopener ugc nofollow" target="_blank">需要</a>我们将从Kubernetes Secrets安装到pod的<code class="fe nw nx ny mt b">~/.aws/credentials</code>和<code class="fe nw nx ny mt b">~/.aws/config</code>文件。</p><p id="5c34" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">实际上，这可以通过一个<a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-serviceaccounts-jwt-tokens-authentication-and-rbac-authorization/" rel="noopener ugc nofollow" target="_blank"> ServiceAccount </a>和一个IAM角色来完成——但是现在，让我们先处理文件。</p><h2 id="4c6a" class="mx ky iq bd kz nc nd dn ld ne nf dp lh kj ng nh ll kn ni nj lp kr nk nl lt nm bi translated">AWS IAM用户</h2><p id="261d" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">创建一个专用的AWS用户来访问密钥—转到AWS IAM，将其设置为<em class="nn">编程访问</em>:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oe"><img src="../Images/e00634acebac4fd64f5be77169113dc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*peq2b5wezxqcJeB7.png"/></div></div></figure><p id="f314" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，创建一个只读IAM策略，只允许sop使用这个键:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi of"><img src="../Images/a3bd8fefc03e9bd1c5051c836dd95330.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mnvsmPPAG11KKvdK.png"/></div></div></figure><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi og"><img src="../Images/02eac0ff660e9d1c1849b73b387b119b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TCSZY3WFwD46vcHn.png"/></div></div></figure><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="1dcf" class="mx ky iq mt b gy my mz l na nb">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Action": [<br/>                "kms:ListKeys",<br/>                "kms:ListAliases",<br/>                "kms:DescribeKey",<br/>                "kms:ListKeyPolicies",<br/>                "kms:GetKeyPolicy",<br/>                "kms:GetKeyRotationStatus",<br/>                "iam:ListUsers",<br/>                "iam:ListRoles"<br/>            ],<br/>            "Resource": "arn:aws:kms:us-east-2:534***385:key/f73daf0d-***-440ca3b6547b",<br/>            "Effect": "Allow"<br/>        }<br/>    ]<br/>}</span></pre><p id="12f2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">保存它并附加到用户:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oh"><img src="../Images/3d2fb50ba01490719df57a8c08c7a843.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*V2C7P0-RCOI1Tcl0.png"/></div></div></figure><p id="1373" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">保存用户，转到AWS KMS，添加一个关键用户:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oi"><img src="../Images/0c67e6eecf37b45fe01e08109ef80ecd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GvnRLV1Ee77vzrsF.png"/></div></div></figure><p id="d1a0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">配置本地AWS配置文件:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="7552" class="mx ky iq mt b gy my mz l na nb">$ aws configure — profile argocd-kms<br/>AWS Access Key ID [None]: AKI***Q4F<br/>AWS Secret Access Key [None]: S7c***6ya<br/>Default region name [None]: us-east-2<br/>Default output format [None]:</span></pre><p id="1e29" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查访问权限:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="cb9f" class="mx ky iq mt b gy my mz l na nb">$ aws — profile argocd-kms kms describe-key — key-id f73daf0d-***-440ca3b6547b<br/>{<br/>“KeyMetadata”: {<br/>“AWSAccountId”: “534***385”,<br/>“KeyId”: “f73daf0d-***-440ca3b6547b”,<br/>“Arn”: “arn:aws:kms:us-east-2:534***385:key/f73daf0d-***-440ca3b6547b”,<br/>…</span></pre><p id="6936" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该配置文件将用于加密我们的秘密，并且该配置文件需要添加到<em class="nn"> argocd-repo-server </em> pod中。</p><h2 id="09e6" class="mx ky iq bd kz nc nd dn ld ne nf dp lh kj ng nh ll kn ni nj lp kr nk nl lt nm bi translated">AWS <code class="fe nw nx ny mt b">credentials</code>和<code class="fe nw nx ny mt b">config</code></h2><p id="0351" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">用<code class="fe nw nx ny mt b">~/.aws/credentials</code>和<code class="fe nw nx ny mt b">~/.aws/config</code>内容创建一个新的Kubernetes Secret，然后它们将被映射到<em class="nn"> argocd-repo-server </em> pod:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="6dbd" class="mx ky iq mt b gy my mz l na nb">---     <br/>apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  name: argocd-aws-credentials<br/>  namespace: dev-1-devops-argocd-ns<br/>type: Opaque<br/>stringData: <br/>  credentials: |<br/>    [argocd-kms]<br/>    aws_access_key_id = AKI***Q4F<br/>    aws_secret_access_key = S7c***6ya<br/>  config: | <br/>    [profile argocd-kms]<br/>    region = us-east-2</span></pre><p id="f8d8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将文件添加到<code class="fe nw nx ny mt b">.gitignore</code>:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="3a18" class="mx ky iq mt b gy my mz l na nb">$ cat .gitignore<br/>argocd-aws-credentials.yaml</span></pre><p id="e491" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">稍后，当将为ArgoCD的推出做一个自动化时，这个文件可以从Jenkins Secrets创建。</p><p id="9dd0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创造秘密:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="cffa" class="mx ky iq mt b gy my mz l na nb">$ kubectl apply -f argocd-aws-credentials.yaml<br/>secret/argocd-aws-credentials created</span></pre><p id="7f89" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更新<code class="fe nw nx ny mt b">Deployment</code><em class="nn">argocd-repo-server</em>-更改要使用的映像，从我们的Secret中添加一个新卷，并将其作为<code class="fe nw nx ny mt b">/home/argocd/.aws</code>挂载到带有Argo的pod:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="b92b" class="mx ky iq mt b gy my mz l na nb">---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  labels:<br/>    app.kubernetes.io/component: repo-server<br/>    app.kubernetes.io/name: argocd-repo-server<br/>    app.kubernetes.io/part-of: argocd<br/>  name: argocd-repo-server<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app.kubernetes.io/name: argocd-repo-server<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app.kubernetes.io/name: argocd-repo-server<br/>    spec:<br/>      automountServiceAccountToken: false<br/>      containers:<br/>      - command:<br/>        - uid_entrypoint.sh<br/>        - argocd-repo-server<br/>        - --redis<br/>        - argocd-redis:6379<br/>#        image: argoproj/argocd:v1.7.9<br/>        image: setevoy/argocd-helm-secrets:v1.7.9-1<br/>        imagePullPolicy: Always<br/>        name: argocd-repo-server<br/>        ports:<br/>        - containerPort: 8081<br/>        - containerPort: 8084<br/>        readinessProbe:<br/>          initialDelaySeconds: 5<br/>          periodSeconds: 10<br/>          tcpSocket:<br/>            port: 8081<br/>        volumeMounts:<br/>        - mountPath: /app/config/ssh<br/>          name: ssh-known-hosts<br/>        - mountPath: /app/config/tls<br/>          name: tls-certs<br/>        - mountPath: /app/config/gpg/source<br/>          name: gpg-keys<br/>        - mountPath: /app/config/gpg/keys<br/>          name: gpg-keyring<br/>        - mountPath: /home/argocd/.aws<br/>          name: argocd-aws-credentials<br/>      volumes:<br/>      - configMap:<br/>          name: argocd-ssh-known-hosts-cm<br/>        name: ssh-known-hosts<br/>      - configMap:<br/>          name: argocd-tls-certs-cm<br/>        name: tls-certs<br/>      - configMap:<br/>          name: argocd-gpg-keys-cm<br/>        name: gpg-keys<br/>      - emptyDir: {}<br/>        name: gpg-keyring<br/>      - name: argocd-aws-credentials<br/>        secret:<br/>          secretName: argocd-aws-credentials</span></pre><p id="c495" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更新ArgoCD实例:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="1461" class="mx ky iq mt b gy my mz l na nb">$ kubectl -n dev-1-devops-argocd-ns apply -f install.yaml</span></pre><p id="af46" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查舱:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="c8e2" class="mx ky iq mt b gy my mz l na nb">$ kubectl -n dev-1-devops-argocd-ns get pod<br/>NAME READY STATUS RESTARTS AGE<br/>…<br/>argocd-repo-server-64f4bbf4b7-jcs6x 1/1 Terminating 0 19h<br/>argocd-repo-server-7c64775679–9jjq2 1/1 Running 0 12s</span></pre><p id="7582" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查文件:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="8418" class="mx ky iq mt b gy my mz l na nb">$ kubectl -n dev-1-devops-argocd-ns exec -ti argocd-repo-server-7c64775679–9jjq2 -- cat /home/argocd/.aws/credentials<br/>[argocd-kms]<br/>aws_access_key_id = AKI***Q4F<br/>aws_secret_access_key = S7c***6ya</span></pre><p id="1bf9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们试着使用<code class="fe nw nx ny mt b">helm-secrets</code>。</p><h2 id="dde7" class="mx ky iq bd kz nc nd dn ld ne nf dp lh kj ng nh ll kn ni nj lp kr nk nl lt nm bi translated">添加<code class="fe nw nx ny mt b">secrets.yaml</code></h2><p id="4ca8" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">在带有图表的存储库中创建一个新的<code class="fe nw nx ny mt b">secrets.yaml</code>文件:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="42c4" class="mx ky iq mt b gy my mz l na nb">somePassword: secretValue</span></pre><p id="5908" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用KMS键和AWS概要文件创建一个<code class="fe nw nx ny mt b">.sops.yaml</code>文件:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="3b67" class="mx ky iq mt b gy my mz l na nb">---<br/>creation_rules:<br/>  - kms: 'arn:aws:kms:us-east-2:534****385:key/f73daf0d-***-440ca3b6547b'<br/>    aws_profile: argocd-kms</span></pre><p id="7a37" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">加密文件:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="c18f" class="mx ky iq mt b gy my mz l na nb">$ helm secrets enc secrets.yaml<br/>Encrypting secrets.yaml<br/>Encrypted secrets.yaml</span></pre><p id="d60d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将我们的秘密的用法添加到测试图表中，例如—让我们创建一个名为<code class="fe nw nx ny mt b">TEST_SECRET_PASSWORD</code>的环境变量—更新<code class="fe nw nx ny mt b">templates/deployment.yaml</code>:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="eb0d" class="mx ky iq mt b gy my mz l na nb">...<br/>      containers:<br/>        - name: {{ .Chart.Name }}<br/>          securityContext:<br/>            {{- toYaml .Values.securityContext | nindent 12 }}<br/>          image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"<br/>          imagePullPolicy: {{ .Values.image.pullPolicy }}<br/>          env:<br/>          - name: TEST_SECRET_PASSWORD<br/>            value: {{ .Values.somePassword }}<br/>...</span></pre><p id="8c82" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将更改推送到存储库:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="b900" class="mx ky iq mt b gy my mz l na nb">$ git add secrets.yaml templates/deployment.yaml<br/>$ git commit -m “test secret added” &amp;&amp; git push</span></pre><p id="018a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">进入应用程序设置— <em class="nn">应用程序详情&gt;参数</em>，点击<em class="nn">编辑</em>，将<code class="fe nw nx ny mt b">values.yaml</code>和<code class="fe nw nx ny mt b">secrets.yaml</code>指定为<em class="nn">值文件</em>:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oj"><img src="../Images/c3bd430676cb78fccd62f3ade99fd252.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xfeOdy1EGrulhUTb.png"/></div></div></figure><p id="84f0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ArgoCD现在发现应用程序与存储库中的数据不同步:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ok"><img src="../Images/8a50300f0e00b8c5e8af4ade713417a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*99QiRPODRiVF7lx1.png"/></div></div></figure><p id="33c6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">同步它:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ol"><img src="../Images/b4638e57168afc8b5778713f8d49bc12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dIPwMHAFGX9YeIcD.png"/></div></div></figure><p id="cec7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查新pod:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi om"><img src="../Images/bbb0e6d793d5d3515ccad9ab6efadf23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*O7xiAe21OVL0UyTs.png"/></div></div></figure><p id="0849" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">和数据直接存储在pod中:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="41a6" class="mx ky iq mt b gy my mz l na nb">$ kubectl -n dev-1-devops-test-helm-chart-ns exec -ti test-helm-chart-5c777f9c9d-wkx6s -- printenv | grep SECRET<br/>TEST_SECRET_PASSWORD=secretValue</span></pre><p id="1af5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">全部完成——秘密就在这里。</p></div><div class="ab cl on oo hu op" role="separator"><span class="oq bw bk or os ot"/><span class="oq bw bk or os ot"/><span class="oq bw bk or os"/></div><div class="ij ik il im in"><p id="faab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nn">最初发布于</em> <a class="ae kw" href="https://rtfm.co.ua/en/argocd-a-helm-chart-deployment-and-working-with-helm-secrets-via-aws-kms/" rel="noopener ugc nofollow" target="_blank"> <em class="nn"> RTFM: Linux，devo PSисистемноеадммитиииииованние</em></a><em class="nn">。</em></p></div></div>    
</body>
</html>