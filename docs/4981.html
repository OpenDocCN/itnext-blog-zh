<html>
<head>
<title>Kubernetes on Devstack part 3: Running applications on the cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes on Devstack第3部分:在集群上运行应用程序</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-on-devstack-part-3-running-applications-on-the-cluster-f15cf4762822?source=collection_archive---------1-----------------------#2020-11-08">https://itnext.io/kubernetes-on-devstack-part-3-running-applications-on-the-cluster-f15cf4762822?source=collection_archive---------1-----------------------#2020-11-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e389" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是涵盖OpenStack云上的Kubernetes集群的<a class="ae kl" href="https://berndbausch.medium.com/running-a-kubernetes-cluster-on-devstack-533d579bb2f9" rel="noopener">系列</a>的第3部分。</p><p id="1d84" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">到目前为止发生了什么:您已经建立了一个Devstack云，并在两个云实例上部署了一个Kubernetes集群。您向云中添加了OpenStack云提供商和Cinder CSI插件。</p><p id="6c46" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">是时候使用集群了。您将创建使用以下内容的应用程序:</p><ol class=""><li id="f827" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">煤渣体积</li><li id="f038" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">多附加Cinder卷</li><li id="8318" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">负载平衡器</li></ol><h1 id="eed6" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">一个使用煤渣卷的简单应用程序</h1><p id="a194" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">您首先需要定义一个映射到Cinder的存储类。这是通过在存储类定义中将Cinder CSI驱动程序引用为<em class="md">提供者</em>来实现的。</p><h2 id="fbc9" class="me lb iq bd lc mf mg dn lg mh mi dp lk jy mj mk lo kc ml mm ls kg mn mo lw mp bi translated">获取煤渣CSI驱动程序的名称</h2><p id="51e7" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">煤渣CSI司机叫什么名字？它在<em class="md">主机1 </em>上的<code class="fe mq mr ms mt b">csi-cinder-driver.yaml</code>清单中定义:</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="5d0b" class="me lb iq mt b gy nc nd l ne nf">$ cd manifests<br/>$ cat csi-cinder-driver.yaml<br/>apiVersion: storage.k8s.io/v1<br/>kind: CSIDriver<br/>metadata:<br/>  name: cinder.csi.openstack.org<br/>spec:<br/>  attachRequired: true<br/>  podInfoOnMount: true<br/>  volumeLifecycleModes:<br/>  - Persistent<br/>  - Ephemeral</span></pre><p id="913d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者，列出当前安装的CSI驱动程序:</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="e193" class="me lb iq mt b gy nc nd l ne nf">$ kubectl get csidrivers.storage.k8s.io<br/>NAME                       ATTACHREQUIRED   PODINFOONMOUNT   MODES                  AGE<br/>cinder.csi.openstack.org   true             true             Persistent,Ephemeral   2d20h</span></pre><p id="5637" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">司机名叫<em class="md">cinder.csi.openstack.org</em>。</p><h2 id="6821" class="me lb iq bd lc mf mg dn lg mh mi dp lk jy mj mk lo kc ml mm ls kg mn mo lw mp bi translated">定义存储</h2><p id="6292" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">三个清单定义了测试应用程序:一个storageclass定义、一个PVC和一个带有NGINX pods的复制控制器。将三份清单从Github <strong class="jp ir">复制到master1 </strong>。</p><p id="1cbf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">存储类通过其<em class="md">置备程序</em>键链接到CSI驱动程序:</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="429f" class="me lb iq mt b gy nc nd l ne nf">$ cat cinder-storageclass.yaml<br/>apiVersion: storage.k8s.io/v1<br/>kind: StorageClass<br/>metadata:<br/>  name: csi-sc-cinderplugin<br/>provisioner: cinder.csi.openstack.org</span></pre><p id="3721" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，应用两个存储清单。</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="0d49" class="me lb iq mt b gy nc nd l ne nf">$ kubectl apply -f cinder-storageclass.yaml<br/>$ kubectl apply -f cinder-pvc-claim1.yaml</span></pre><h2 id="ccfa" class="me lb iq bd lc mf mg dn lg mh mi dp lk jy mj mk lo kc ml mm ls kg mn mo lw mp bi translated">检查成功</h2><p id="985d" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">如果一切配置正确，PVC应该有一个煤渣卷作为后盾。<strong class="jp ir">在Devstack服务器</strong>上，检查卷。</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="c415" class="me lb iq mt b gy nc nd l ne nf">$ source ~/devstack/openrc kube kube<br/>$ openstack volume list -f yaml<br/>- Attached to: []<br/>  ID: 1edb1b91-6fdc-4f20-8ead-283aaf878390<br/>  Name: pvc-a0c8e55f-f766-44bd-80a5-ff2832e4365f<br/>  Size: 1<br/>  Status: available</span></pre><p id="044f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">PVC对应于当前<em class="md">可用</em>的Cinder卷，即未连接到任何服务器。</p><h2 id="1116" class="me lb iq bd lc mf mg dn lg mh mi dp lk jy mj mk lo kc ml mm ls kg mn mo lw mp bi translated">启动应用程序</h2><p id="641c" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated"><strong class="jp ir">在主节点</strong>上，启动应用程序。</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="5683" class="me lb iq mt b gy nc nd l ne nf">$ kubectl apply -f example-pod.yaml<br/>$ kubectl get rc,pod,pvc<br/>NAME                           DESIRED   CURRENT   READY   AGE<br/>replicationcontroller/server   4         4         4       106s</span><span id="e0fd" class="me lb iq mt b gy ng nd l ne nf">NAME               READY   STATUS    RESTARTS   AGE<br/>pod/server-bnwd7   1/1     Running   0          105s<br/>pod/server-jklpp   1/1     Running   0          105s<br/>pod/server-kj26p   1/1     Running   0          106s<br/>pod/server-r4mqd   1/1     Running   0          105s</span><span id="2964" class="me lb iq mt b gy ng nd l ne nf">NAME                           STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE<br/>persistentvolumeclaim/claim1   Bound    pvc-a0c8e55f-f766-44bd-80a5-ff2832e4365f   1Gi        RWO            csi-sc-cinderplugin   7m48s</span></pre><h2 id="4b16" class="me lb iq bd lc mf mg dn lg mh mi dp lk jy mj mk lo kc ml mm ls kg mn mo lw mp bi translated">检查启动成功</h2><p id="be30" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated"><strong class="jp ir">在Devstack服务器</strong>上，再次列出卷。您会发现卷状态已经从<em class="md">可用</em>变为<em class="md">使用中</em>，并且它被附加到<em class="md"> worker1 </em>实例。</p><p id="415a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">在worker1节点</strong>上，验证该卷是否已连接和挂载。</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="507d" class="me lb iq mt b gy nc nd l ne nf">[centos@worker1 ~]$ lsblk<br/>NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT<br/>vda    252:0    0  20G  0 disk<br/>`-vda1 252:1    0  20G  0 part /<br/>vdb    252:16   0   1G  0 disk /var/lib/kubelet/pods/de103e52-227b-4117-b1b6-647c68507127/volumes/kubernetes.io~cs<br/>[centos@worker1 ~]$ sudo blkid<br/>/dev/vda1: UUID="6cd50e51-cfc6-40b9-9ec5-f32fa2e4ff02" TYPE="xfs"<br/>/dev/vdb: UUID="028085bf-2dd1-47c0-ab2a-e925a4150c36" TYPE="ext4"</span></pre><p id="76a3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个卷被称为<em class="md"> vdb </em>，并被挂载到一个kubelet目录中。</p><h1 id="3461" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">多附加卷</h1><p id="97d6" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">默认情况下，Cinder卷只能连接到一个OpenStack实例。现在，实现PVC的卷只连接到<em class="md"> worker1 </em>。</p><p id="6a6d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本节将探讨共享一个卷的多个节点上的<strong class="jp ir">pod，以及为此需要做哪些更改。我们将:</strong></p><ol class=""><li id="2538" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">允许在控制器上安排pod。</li><li id="de04" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">尝试在两个节点上部署pod，但是失败。</li><li id="b657" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">添加煤渣体积类型。</li><li id="409d" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">更改存储类清单。</li><li id="e4ee" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">使PVC <em class="md">读写多个</em>。</li><li id="0fc7" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">尝试在两个节点上部署pod，并获得成功。</li></ol><h2 id="262f" class="me lb iq bd lc mf mg dn lg mh mi dp lk jy mj mk lo kc ml mm ls kg mn mo lw mp bi translated">1.从master1中删除NoSchedule污点</h2><p id="e39f" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">我们想在<em class="md"> master1 </em>节点上运行pods，但是现在它的<em class="md"> NoSchedule </em>污点使得这不可能:</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="433e" class="me lb iq mt b gy nc nd l ne nf">$ kubectl describe no master1 <br/>...<br/>Taints:             node-role.kubernetes.io/master:NoSchedule<br/>...</span></pre><p id="2251" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">去掉这个污点，这样就可以在那里安排吊舱了。</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="fdbf" class="me lb iq mt b gy nc nd l ne nf">$ kubectl taint nodes master1 \<br/>                          node-role.kubernetes.io/master:NoSchedule-</span></pre><p id="ef2c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">命令末尾的破折号是重要的</strong>。再次使用<code class="fe mq mr ms mt b">kubectl describe</code>再次检查污点是否已被清除。</p><h2 id="320e" class="me lb iq bd lc mf mg dn lg mh mi dp lk jy mj mk lo kc ml mm ls kg mn mo lw mp bi translated">2.将pod添加到控制器并检查它们的运行状况</h2><p id="a8c0" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">在<code class="fe mq mr ms mt b">example-pod.yaml</code>中，将副本号从4设置为8，然后应用更新的清单。列出豆荚。</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="3fda" class="me lb iq mt b gy nc nd l ne nf">$ kubectl get pods -o wide<br/>NAME           READY   STATUS              RESTARTS   AGE     IP            NODE      NOMINATED NODE   READINESS GATES<br/>server-8swjk   0/1     ContainerCreating   0          7s      &lt;none&gt;        master1   &lt;none&gt;           &lt;none&gt;<br/>server-bnwd7   1/1     Running             0          3h21m   10.244.1.30   worker1   &lt;none&gt;           &lt;none&gt;<br/>server-j8mnp   0/1     ContainerCreating   0          7s      &lt;none&gt;        master1   &lt;none&gt;           &lt;none&gt;</span></pre><p id="a1ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">过了一分钟左右，再检查一遍。您将会发现新pod的状态仍然是<em class="md"> ContainerCreating </em>。当您描述其中一个pod时，您会发现它们的创建可以完成，因为该卷无法连接，因此无法挂载:</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="5a2e" class="me lb iq mt b gy nc nd l ne nf">$ kubectl describe pod server-vl8cl<br/>...<br/>Events:<br/>  Type     Reason              Age                  From                     Message<br/>  ----     ------              ----                 ----                     -------<br/>  Normal   Scheduled           15m                  default-scheduler        Successfully assigned default/server-vl8cl to master1<br/>  Warning  FailedAttachVolume  15m                  attachdetach-controller  Multi-Attach error for volume "pvc-a0c8e55f-f766-44bd-80a5-ff2832e4365f" Volume is already used by pod(s) server-bnwd7, server-jklpp, server-kj26p, server-r4mqd<br/>  Warning  FailedMount         2m16s (x6 over 13m)  kubelet                  Unable to attach or mount volumes: unmounted volumes=[cinderpvc], unattached volumes=[cinderpvc default-token-9tnjm]: timed out waiting for the condition</span></pre><p id="5f61" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是因为<em class="md"> master1 </em>无法附加已经附加到<em class="md"> worker1 </em>的卷。要将一个Cinder volume附加到多个实例，必须设置其<em class="md"> multiattach </em>标志。</p><p id="60f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您现在将设置一个允许多连接的存储类，但首先要删除副本控制器、PVC和存储类。</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="11c1" class="me lb iq mt b gy nc nd l ne nf">$ kubectl delete rc server<br/>$ kubectl delete pvc claim1<br/>$ kubectl delete sc csi-sc-cinderplugin</span></pre><h2 id="4a7f" class="me lb iq bd lc mf mg dn lg mh mi dp lk jy mj mk lo kc ml mm ls kg mn mo lw mp bi translated">3.创建允许多附件的Cinder卷类型</h2><p id="4567" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">要将一个Cinder卷附加到多个实例，它必须有一个<em class="md">多附加卷类型</em>。目前不存在这样的卷类型，因此您必须先创建一个。更多信息请参见<a class="ae kl" href="https://docs.openstack.org/cinder/latest/admin/blockstorage-volume-multiattach.html" rel="noopener ugc nofollow" target="_blank"> Cinder管理指南</a>。</p><p id="3600" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">在Devstack服务器上</strong>:</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="4499" class="me lb iq mt b gy nc nd l ne nf">$ source ~/devstack/openrc admin admin<br/>$ openstack volume type create multiattach-type \<br/>                                 --property multiattach="&lt;is&gt; True"</span></pre><p id="d8c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请确保multiattach属性具有正确的值。<em class="md"> True </em>中的T必须是大写字母。</p><h2 id="f0f1" class="me lb iq bd lc mf mg dn lg mh mi dp lk jy mj mk lo kc ml mm ls kg mn mo lw mp bi translated">4.将新的卷类型添加到Kubernetes存储类</h2><p id="c493" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated"><strong class="jp ir">在master1节点</strong>上，通过添加新的卷类型作为参数来修改<strong class="jp ir">存储类</strong>清单:</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="fc84" class="me lb iq mt b gy nc nd l ne nf">apiVersion: storage.k8s.io/v1<br/>kind: StorageClass<br/>metadata:<br/>  name: csi-sc-cinderplugin<br/>provisioner: cinder.csi.openstack.org<br/>parameters:<br/>  type: multiattach-type</span></pre><h2 id="d5e5" class="me lb iq bd lc mf mg dn lg mh mi dp lk jy mj mk lo kc ml mm ls kg mn mo lw mp bi translated">5.更改PVC的访问模式并重新创建PVC</h2><p id="a3e6" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">还要修改<strong class="jp ir"> PVC清单</strong>并将其accessMode设置为<em class="md"> ReadWriteMany </em>。</p><p id="bfc2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建存储类和PVC。</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="faf3" class="me lb iq mt b gy nc nd l ne nf">$ kubectl apply -f cinder-storageclass.yaml<br/>$ kubectl apply -f cinder-pvc-claim1.yaml</span></pre><p id="ff14" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">在Devstack服务器</strong>上，验证是否已创建Cinder卷，以及它是否具有multiattach标志。</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="66b1" class="me lb iq mt b gy nc nd l ne nf">$ openstack volume list --all-projects<br/>+--------------------------------------+------------------------------------------+-----------+------+-------------+<br/>| ID                                   | Name                                     | Status    | Size | Attached to |<br/>+--------------------------------------+------------------------------------------+-----------+------+-------------+<br/>| 73c3e003-c535-42e1-8c4a-a1f9379ffba6 | pvc-6d770b8d-fc35-4f8d-800d-0ec8925f58d6 | available |    1 |             |<br/>+--------------------------------------+------------------------------------------+-----------+------+-------------+<br/>$ openstack volume show 73c3e003-c535-42e1-8c4a-a1f9379ffba6 | grep multi<br/>| multiattach                  | True                                          |<br/>| type                         | multiattach-type                              |</span></pre><h2 id="5d34" class="me lb iq bd lc mf mg dn lg mh mi dp lk jy mj mk lo kc ml mm ls kg mn mo lw mp bi translated">6.运行吊舱并检查它们的健康状况</h2><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="ab9e" class="me lb iq mt b gy nc nd l ne nf">$ kubectl apply -f example-pod.yaml<br/>replicationcontroller/server created<br/>$ kubectl get pod -o wide<br/>NAME           READY   STATUS              RESTARTS   AGE   IP       NODE      NOMINATED NODE   READINESS GATES<br/>server-5m8bg   0/1     ContainerCreating   0          13s   &lt;none&gt;   master1   &lt;none&gt;           &lt;none&gt;<br/>server-9djx2   0/1     ContainerCreating   0          13s   &lt;none&gt;   master1   &lt;none&gt;           &lt;none&gt;<br/>...</span></pre><p id="2bed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">过一会儿重复<em class="md"> get </em>命令时，所有的pod都应该处于<em class="md">运行</em>的状态。</p><p id="efcd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">在Devstack服务器</strong>上，列出卷。</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="4e1d" class="me lb iq mt b gy nc nd l ne nf">$ openstack volume list --fit-width<br/>+----------------------+----------------------+--------+------+-----------------------+<br/>| ID                   | Name                 | Status | Size | Attached to           |<br/>+----------------------+----------------------+--------+------+-----------------------+<br/>| 66ea38fd-4d08-4afa-  | pvc-37ab30fb-c27c-4e | in-use |    1 | Attached to worker1   |<br/>| ae3b-fa477cf4b26a    | 86-a067-81b0e0353fe1 |        |      | on /dev/vdb Attached  |<br/>|                      |                      |        |      | to master1 on         |<br/>|                      |                      |        |      | /dev/vdb              |<br/>+----------------------+----------------------+--------+------+-----------------------+</span></pre><p id="4015" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="md">附加到</em>列显示煤渣卷附加到两个节点。</p><h1 id="1498" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">一个使用负载平衡的简单应用程序</h1><p id="2348" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">为了演示负载平衡，pod需要在两个或更多节点上运行。有关在控制器上启用pod调度，请参见上一节中的说明。</p><h2 id="a30a" class="me lb iq bd lc mf mg dn lg mh mi dp lk jy mj mk lo kc ml mm ls kg mn mo lw mp bi translated">新清单</h2><p id="6949" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">创建一个<strong class="jp ir">新的复制控制器清单</strong>，它使用容器本地存储而不是卷:</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="089f" class="me lb iq mt b gy nc nd l ne nf">$ cat example-pod-lb.yaml<br/>apiVersion: v1<br/>kind: ReplicationController<br/>metadata:<br/>  name: lbserver<br/>spec:<br/>  replicas: 8<br/>  selector:<br/>	role: server<br/>  template:<br/>	metadata:<br/>	  labels:<br/>		role: server<br/>		app: lbserver<br/>	spec:<br/>	  containers:<br/>	  - name: server<br/>		image: nginx</span></pre><p id="b874" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该清单基于官方云提供商OpenStack repo的<a class="ae kl" href="https://github.com/kubernetes/cloud-provider-openstack/blob/master/examples/persistent-volume-provisioning/cinder/example-pod.yaml" rel="noopener ugc nofollow" target="_blank">示例</a>。和原版有两点不同:pod多了一个标签<code class="fe mq mr ms mt b">app: lbserver</code>，没有体积。</p><p id="7d89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建名为<em class="md"> service.yaml </em>的<strong class="jp ir">服务清单</strong>。确保其选择器通过上面的标签指向复制控制器:</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="3f93" class="me lb iq mt b gy nc nd l ne nf">kind: Service<br/>apiVersion: v1<br/>metadata:<br/>  name: lb-webserver<br/>spec:<br/>  selector:<br/>	app: lbserver<br/>  type: LoadBalancer<br/>  ports:<br/>  - name: http<br/>	port: 80<br/>	targetPort: 80</span></pre><p id="1e85" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用这两个清单。</p><h2 id="223c" class="me lb iq bd lc mf mg dn lg mh mi dp lk jy mj mk lo kc ml mm ls kg mn mo lw mp bi translated">OpenStack资源</h2><p id="408e" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">OpenStack云提供商将创建一个负载平衡器，这可能需要几分钟时间。大部分时间将用于启动一个新的、所谓的“amphora”实例，该实例运行负载平衡代码。</p><p id="6d26" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">在Devstack服务器</strong>上，探索OpenStack负载平衡器。以下命令使用YAML作为输出格式，以获得更漂亮的输出。</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="c853" class="me lb iq mt b gy nc nd l ne nf">$ openstack loadbalancer list -f yaml<br/>- id: 474f2c35-1d45-4b49-99ba-d745082e9d33<br/>  name: kube_service_kubernetes_default_lb-webserver<br/>  operating_status: OFFLINE<br/>  project_id: 7a099eff1fb1479b89fa721da3e1a018<br/>  provider: amphora<br/>  provisioning_status: PENDING_CREATE<br/>  vip_address: 172.16.0.134</span></pre><p id="8ae2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">预配状态当前为PENDING_CREATE，但将在负载平衡器实例启动并运行时变为活动状态。将您的身份更改为admin后，您可以查看负载平衡器实例:</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="ba4c" class="me lb iq mt b gy nc nd l ne nf">$ source ~/devstack/openrc admin admin<br/>$ openstack server list</span></pre><p id="6a7d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查看负载平衡器详细信息的一个有用命令是<code class="fe mq mr ms mt b">openstack loadbalancer status show &lt;LOADBALANCER-ID&gt;</code>。</p><p id="2287" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">云提供商将浮动IP与负载平衡器的VIP地址相关联。可以用<code class="fe mq mr ms mt b">openstack floating ip list | grep 172.16.0.134</code>查看，其中172.16.0.134是VIP地址。</p><h2 id="bcad" class="me lb iq bd lc mf mg dn lg mh mi dp lk jy mj mk lo kc ml mm ls kg mn mo lw mp bi translated">负载平衡器测试</h2><p id="ecc9" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated"><strong class="jp ir">在master1 </strong>上，浮动IP被用作服务的外部IP:</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="7e8a" class="me lb iq mt b gy nc nd l ne nf">$ kubectl get service<br/>NAME           TYPE           CLUSTER-IP    EXTERNAL-IP     PORT(S)        AGE<br/>kubernetes     ClusterIP      10.96.0.1     &lt;none&gt;          443/TCP        4d2h<br/>lb-webserver   LoadBalancer   10.97.192.7   192.168.1.225   80:30007/TCP   34m</span></pre><p id="199b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您刚刚启动的pod包含一个NGINX web服务器，带有一个默认的<em class="md">index.htm</em>l页面。您可以使用<code class="fe mq mr ms mt b">curl &lt;EXTERNAL-IP&gt;</code>访问web服务器，但这并不能向您证明使用了多个pod。</p><p id="7331" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为每个吊舱创建不同的<em class="md">index.html</em>。例如:</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="847b" class="me lb iq mt b gy nc nd l ne nf">server=1<br/>$ for pod in $LIST_OF_PODS<br/>do <br/>	kubectl exec $i -- /bin/bash -c "echo Server $server &gt; /usr/share/nginx/html/index.html"<br/>	((server++))<br/>done</span></pre><p id="d105" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">LIST_OF_PODS是您刚刚启动的lbserver pods的列表。这个脚本用一个定制的字符串替换了每个pod中的<em class="md">index.html</em>。</p><p id="4374" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过重复运行上面的curl命令来测试这一点。您应该看到不同的pod如何响应，证明发生了负载平衡。</p><pre class="mu mv mw mx gt my mt mz na aw nb bi"><span id="bf0f" class="me lb iq mt b gy nc nd l ne nf">$ curl 192.168.1.225<br/>Server 7<br/>$ curl 192.168.1.225<br/>Server 5<br/>$ curl 192.168.1.225<br/>Server 4<br/>$ curl 192.168.1.225<br/>Server 4<br/>$ curl 192.168.1.225<br/>Server 2</span></pre><p id="76cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来:<a class="ae kl" href="https://berndbausch.medium.com/using-openstack-magnum-to-create-a-kubernetes-cluster-af8ec3cfbda5" rel="noopener">使用OpenStack Magnum建立Kubernetes集群</a>。</p></div></div>    
</body>
</html>