<html>
<head>
<title>Docker Swarm stack at Oracle Cloud OCI using ARM processors</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Oracle云OCI采用arm处理器的Docker Swarm堆栈</h1>
<blockquote>原文：<a href="https://itnext.io/docker-swarm-stack-at-oracle-cloud-oci-using-arm-processors-c26dc8900986?source=collection_archive---------1-----------------------#2021-06-24">https://itnext.io/docker-swarm-stack-at-oracle-cloud-oci-using-arm-processors-c26dc8900986?source=collection_archive---------1-----------------------#2021-06-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/31603ab92598b952a7fa2cd711107814.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GTI1zUFgxH8NB5UWaNDnpw.jpeg"/></div></div></figure><p id="0a0a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Oracle云基础设施(OCI)提供Ampere Altra处理器和业内首款80核Arm服务器，每核小时仅售0.01美元，每核可灵活配置1至80个OCPUs和1至64 GB内存。OCI Ampere Altra A1计算平台提供确定性性能、线性可扩展性和安全架构，具有市场上最佳的性价比。</p><p id="1dae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本文是以下相关文章系列的续篇:</p><ul class=""><li id="f394" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><a class="ae lf" rel="noopener ugc nofollow" target="_blank" href="/oracle-always-free-cloud-instances-in-ha-configuration-e1d3dd59d3b1"> Oracle始终释放HA配置中的云实例</a></li><li id="f829" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" rel="noopener ugc nofollow" target="_blank" href="/my-own-dev-test-cloud-environment-using-oracle-always-free-instances-598695cc3a10">我自己的开发/测试云环境使用Oracle Always免费实例</a></li><li id="d723" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://marcelo-ochoa.medium.com/my-own-iot-deployment-at-oracle-cloud-free-using-autonomous-db-and-ml-f0632e240a29" rel="noopener">我自己在Oracle Cloud使用自主数据库和ML免费部署物联网</a></li><li id="5cef" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" rel="noopener ugc nofollow" target="_blank" href="/using-lets-encrypt-certs-with-oracle-cloud-load-balancer-including-auto-renew-feature-7ae87e6d207b">使用Oracle云负载平衡器加密证书——包括自动更新功能</a></li><li id="247f" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://marcelo-ochoa.medium.com/using-oracle-cloud-object-storage-as-docker-volume-3ec7882f51b7" rel="noopener">使用Oracle云对象存储作为Docker卷</a></li><li id="6639" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://marcelo-ochoa.medium.com/estimating-micro-services-max-db-throughput-8ad1da22a41b" rel="noopener">估计微服务最大数据库吞吐量</a></li></ul><p id="ab63" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是，这篇文章不是描述如何按照逐步说明进行部署，而是讲述如何使用基础架构作为使用<a class="ae lf" href="https://es.wikipedia.org/wiki/Terraform_(software)" rel="noopener ugc nofollow" target="_blank"> Terraform </a>和<a class="ae lf" href="https://docs.cloud.oracle.com/en-us/iaas/Content/ResourceManager/Concepts/resourcemanager.htm" rel="noopener ugc nofollow" target="_blank"> Oracle Resource Manager </a>的代码，在文章的最后，您只需点击几下鼠标，就可以在Oracle Always Free instance上获得一个四节点Swarm集群。</p><p id="95e7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们首先介绍我们的测试环境，参见部署图:</p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ll"><img src="../Images/8e033a8a1e2096b05a3b073f76353ffb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YKKdcsi44F5jyx-klQQmEw.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">部署图表</figcaption></figure><p id="dfa4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们在上面看到了共享存储，该共享存储是使用虚拟机块存储实现的，并使用GlusterFS进行复制，该存储是为PostgreSQL或MySQL等块级IO而设计的，我们的Docker容器有一个新的共享存储，它是使用为存储HTML页面、图像、配置文件或Docker注册表blob对象而设计的对象存储实现的。</p><blockquote class="lu lv lw"><p id="87cb" class="jy jz lx ka b kb kc kd ke kf kg kh ki ly kk kl km lz ko kp kq ma ks kt ku kv ij bi translated">注意:通过为Oracle对象存储添加Docker插件，我们可以从Oracle <a class="ae lf" href="https://docs.cloud.oracle.com/en-us/iaas/Content/API/Concepts/devcloudshellgettingstarted.htm" rel="noopener ugc nofollow" target="_blank">云外壳</a>访问常规文件系统。Docker S3卷插件和面向Docker的GlusterFS卷插件可在ARM(<a class="ae lf" href="https://hub.docker.com/r/mochoa/s3fs-volume-plugin-aarch64" rel="noopener ugc nofollow" target="_blank">S3Fs</a>/<a class="ae lf" href="https://hub.docker.com/r/mochoa/glusterfs-volume-plugin-aarch64" rel="noopener ugc nofollow" target="_blank">GlusterFS</a>)和X86 _ 64(<a class="ae lf" href="https://hub.docker.com/r/mochoa/s3fs-volume-plugin-x86_64" rel="noopener ugc nofollow" target="_blank">S3Fs</a>/<a class="ae lf" href="https://hub.docker.com/r/mochoa/glusterfs-volume-plugin-x86_64" rel="noopener ugc nofollow" target="_blank">GlusterFS</a>)平台的<a class="ae lf" href="https://github.com/marcelo-ochoa/docker-volume-plugins" rel="noopener ugc nofollow" target="_blank"> GitHub </a> / <a class="ae lf" href="https://hub.docker.com/p/mochoa/s3fs-volume-plugin" rel="noopener ugc nofollow" target="_blank"> DockerHub </a>获得。</p></blockquote></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="febd" class="mi mj iq bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">部署文件</h1><p id="efa8" class="pw-post-body-paragraph jy jz iq ka b kb ng kd ke kf nh kh ki kj ni kl km kn nj kp kq kr nk kt ku kv ij bi translated">示例脚本和配置文件可以在我的GitHub repo<a class="ae lf" href="https://github.com/marcelo-ochoa/oci-swarm-cluster" rel="noopener ugc nofollow" target="_blank">OCI-swarm-cluster</a>arm brach获得，只需克隆并执行:</p><pre class="lm ln lo lp gt nl nm nn no aw np bi"><span id="e241" class="nq mj iq nm b gy nr ns l nt nu">$ git clone <a class="ae lf" href="https://github.com/marcelo-ochoa/oci-swarm-cluster" rel="noopener ugc nofollow" target="_blank">https://github.com/marcelo-ochoa/oci-swarm-cluster</a> <strong class="nm ir"><em class="lx">-b arm</em></strong><br/>$ cd oci-swarm-cluster<br/>$ zip -r ../oci-swarm-stack.zip .</span></pre><p id="85be" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">仅此而已，<strong class="ka ir"><em class="lx">OCI-swarm-Stack . zip</em></strong>是用来创建Swarm栈的文件。</p><h1 id="8da6" class="mi mj iq bd mk ml nv mn mo mp nw mr ms mt nx mv mw mx ny mz na nb nz nd ne nf bi translated">部署Docker群堆栈</h1><p id="d4b4" class="pw-post-body-paragraph jy jz iq ka b kb ng kd ke kf nh kh ki kj ni kl km kn nj kp kq kr nk kt ku kv ij bi translated">遵循使用Oracle云控制台的四次点击指南，<a class="ae lf" href="https://cloud.oracle.com/resourcemanager/stacks" rel="noopener ugc nofollow" target="_blank">资源管理器- &gt;堆栈</a>菜单</p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/be23adcf10ba723833492abd89b92766.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NMPt7UvjPGyQjOE1"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">资源管理器窗格</figcaption></figure><p id="93a8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择创建堆栈、ZIP文件配置并浏览生成的oci-swarm-stack.zip文件</p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/1a16487c0a2c9be89953d86c8ea95eb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uT_JtsAz26mO_QON"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">创建堆栈—堆栈信息</figcaption></figure><p id="2f6d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">单击“Next ”,取消选择“auto generated public SSH keys ”,从您的计算机中选择一个公钥，该公钥将允许您访问为群集创建的计算实例。</p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/418a9f3c50326919af3c2d07a2ca5f3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XH5mnuhcPjuJwCKo"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">创建堆栈—配置变量</figcaption></figure><p id="2bbf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">单击下一步，查看公钥和堆栈信息</p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/8614c7377b41767b3fe399daca2663e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ITBvxc0wfeVLN6YW"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">创建堆栈—查看</figcaption></figure><p id="b9f7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">单击创建，您的Terraform堆栈将被创建，如果选择运行应用，堆栈将自动创建，几分钟后您将看到如下输出:</p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oe"><img src="../Images/c1e696db8736717d4ba1c8fc55f24618.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lzUoh7VdFW9sUePQ"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">资源经理-工作详细信息</figcaption></figure><p id="2f68" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在日志的末尾，您会看到类似这样的内容:</p><pre class="lm ln lo lp gt nl nm nn no aw np bi"><span id="fe5a" class="nq mj iq nm b gy nr ns l nt nu">Apply complete! Resources: 44 added, 0 changed, 0 destroyed.<br/>Outputs:<br/>  autonomous_database_password = db_auto_generated_password<br/>  comments = The application URL will be unavailable for a few minutes after provisioning, while the application is configured<br/>  deploy_id = Xi8r<br/>  deployed_to_region = us-ashburn-1<br/>  dev = Made with ❤ by Marcelo Ochoa<br/>  generated_private_key_pem = No Keys Auto Generated<br/>  lb_public_url = <a class="ae lf" href="http://150.136.128.59" rel="noopener ugc nofollow" target="_blank">http://<strong class="nm ir"><em class="lx">150.136.128.59</em></strong></a><strong class="nm ir"><em class="lx"><br/>  </em></strong>oci_swarm_basic_source_code = https://github.com/marcelo-ochoa/oci-swarm-cluster</span></pre></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="cc76" class="mi mj iq bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">一些调整</h1><p id="c631" class="pw-post-body-paragraph jy jz iq ka b kb ng kd ke kf nh kh ki kj ni kl km kn nj kp kq kr nk kt ku kv ij bi translated">此部署中作为示例包括的堆栈包括:</p><ul class=""><li id="dd19" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">使用OCI对象存储的Docker v2注册表回购</li><li id="1725" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">用于管理Docker群堆栈的Portainer可视化工具</li><li id="35d6" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">LetsEncrypt SSL证书生成</li></ul><p id="a53f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后一点要求您为每个在<a class="ae lf" href="https://github.com/marcelo-ochoa/oci-swarm-cluster/blob/arm/scripts/docker-compose.yml" rel="noopener ugc nofollow" target="_blank"> docker-compose.yml </a>中声明的主机名拥有一个有效的DNS条目，指向负载平衡器公共IP，例如使用NoIP.com</p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/b91b29414528883edc2c09a66de976df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MlNSnlaqv6a9gIcu"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">NoIP示例输出A资源</figcaption></figure><p id="8670" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你有像上面这样的公共DNS条目，编辑你的<a class="ae lf" href="https://github.com/marcelo-ochoa/oci-swarm-cluster/blob/arm/scripts/docker-compose.yml" rel="noopener ugc nofollow" target="_blank"> docker-compose.yml </a>文件并重新部署swarm栈，<a class="ae lf" href="https://github.com/marcelo-ochoa/oci-swarm-cluster/blob/arm/scripts/docker-compose.yml" rel="noopener ugc nofollow" target="_blank"> docker-compose.yml </a>文件将看起来像这样:</p><ul class=""><li id="c6c7" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">-trae fik . http . routers . portainer . rule =(Host(` portainer-OCI . hopto . org `) &amp; &amp; path prefix(`/`))</li><li id="1b3e" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">-traefik . http . routers . registry . rule =(Host(` registry-OCI . hopto . org `) &amp; &amp; path prefix(`/v2/`))</li></ul><p id="5232" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这些值将确保Traefik从LetsEncrypt Acme Bot生成有效的SSL证书。</p><pre class="lm ln lo lp gt nl nm nn no aw np bi"><span id="6470" class="nq mj iq nm b gy nr ns l nt nu">[root@oci-swarm-xi8r-0 ~]# vi docker-compose.yml<br/>[root@oci-swarm-xi8r-0 ~]# source /root/swarm.env<br/>[root@oci-swarm-xi8r-0 ~]# export $(cut -d= -f1 /root/swarm.env)[root@oci-swarm-xi8r-0 ~]# docker stack deploy -c docker-compose.yml swarm<br/>Updating service swarm_traefik (id: h5yoa5iary7su5yg5snc4xl0i)<br/>Updating service swarm_whoami (id: jxc83xcimu8292coaof7348wg)<br/>Updating service swarm_registry (id: j7l3n7qdfwaduhrejpglg6bwj)<br/>Updating service swarm_agent (id: v5iqree794b47zm6o8cxiineo)<br/>Updating service swarm_portainer (id: 9r8g06wh3en9bzllr63510dcz)</span></pre><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/7b7170a08946bc89d53f3baa3c5ad796.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lhsYRGhRovXskE3G"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">门户用户界面</figcaption></figure></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="0465" class="mi mj iq bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">表演</h1><p id="bffa" class="pw-post-body-paragraph jy jz iq ka b kb ng kd ke kf nh kh ki kj ni kl km kn nj kp kq kr nk kt ku kv ij bi translated">对于新的ARM处理器和形状，我们重新进行了一些性能测试，如文章<a class="ae lf" href="https://marcelo-ochoa.medium.com/estimating-micro-services-max-db-throughput-8ad1da22a41b" rel="noopener">估计微服务最大数据库吞吐量</a>中所示，结果如下:</p><p id="a2b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">两个微服务，8个并发连接(docker服务规模sb_soecs=2):</p><pre class="lm ln lo lp gt nl nm nn no aw np bi"><span id="21e7" class="nq mj iq nm b gy nr ns l nt nu">soecs:<br/>image: swingbench:2.6.0<br/>command: /opt/swingbench/bin/charbench -cf /opt/Wallet_test1.zip -cs test1_tpurgent -c /opt/swingbench/configs/SOE_Client_Side.xml -u soe -p ${SOE_PWD} -uc 8 -a -v users,tpm,tps,cpu,disk -mt 20000 -mr<br/>Author  :     Dominic Giles<br/>Version :     2.6.0.1135<br/>Results will be written to results.xml.<br/>..... lots of output here ....<br/>|Maximum Transactions/min      |                         13255|<br/>|Average Transactions/sec      |                        206.27|<br/>|Maximum Transactions/min      |                         14266|<br/>|Average Transactions/sec      |                        227.28|<br/>.....<br/>Completed Run.</span></pre><p id="22db" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">4个微服务，4个并发连接(docker服务规模sb_soecs=4):</p><pre class="lm ln lo lp gt nl nm nn no aw np bi"><span id="bea4" class="nq mj iq nm b gy nr ns l nt nu">soecs:<br/>image: swingbench:2.6.0<br/>command: /opt/swingbench/bin/charbench -cf /opt/Wallet_test1.zip -cs test1_tpurgent -c /opt/swingbench/configs/SOE_Client_Side.xml -u soe -p ${SOE_PWD} -uc 4 -a -v users,tpm,tps,cpu,disk -mt 10000 -mr<br/>Author  :     Dominic Giles<br/>Version :     2.6.0.1135<br/>Results will be written to results.xml.<br/>..... lots of output here ....<br/>|Maximum Transactions/min      |                          5655|<br/>|Average Transactions/sec      |                         89.30|<br/>|Maximum Transactions/min      |                          5692|<br/>|Average Transactions/sec      |                         91.77|<br/>|Maximum Transactions/min      |                          5649|<br/>|Average Transactions/sec      |                         89.29|<br/>|Maximum Transactions/min      |                          6514|<br/>|Average Transactions/sec      |                        104.21|<br/>.....<br/>Completed Run.</span></pre><p id="c3c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这两种情况下，两个节点/两个微服务或四个节点/四个微服务ARM处理器将以更低的价格获得两倍于AMD OCI处理器的吞吐量<strong class="ka ir"><em class="lx"/></strong>！！！</p></div></div>    
</body>
</html>