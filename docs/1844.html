<html>
<head>
<title>Under-the-hood of Apollo</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在阿波罗的引擎盖下</h1>
<blockquote>原文：<a href="https://itnext.io/under-the-hood-of-apollo-6d8642066b28?source=collection_archive---------2-----------------------#2019-02-10">https://itnext.io/under-the-hood-of-apollo-6d8642066b28?source=collection_archive---------2-----------------------#2019-02-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="24be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章来自我最近做的一个关于Apollo客户端内部的演讲。看<a class="ae kl" href="https://www.youtube.com/watch?v=zO_ZuWERUy8" rel="noopener ugc nofollow" target="_blank">视频这里</a>。我很沮丧，因为我不明白在我使用它的时候到底发生了什么，所以我花了一些时间来钻研代码。</p><p id="294d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章主要关注一个相对简单的用例，也就是说</p><ul class=""><li id="4313" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">100%反应JS和客户端</li><li id="5245" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">简单查询组件(无变异)</li><li id="8924" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">无订阅/批处理</li><li id="720c" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">没有复杂的缓存或内存策略</li></ul><p id="8c4b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我计划做一个后续工作，看看更先进的功能。</p><p id="3d09" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我的“引擎盖下”系列的一部分:</p><ul class=""><li id="a73d" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated"><a class="ae kl" href="https://craigtaub.dev/under-the-hood-of-type-systems" rel="noopener ugc nofollow" target="_blank">类型系统(如TypeScript) </a></li><li id="9336" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated"><a class="ae kl" href="https://craigtaub.dev/source-maps-from-top-to-bottom" rel="noopener ugc nofollow" target="_blank">来源图</a></li><li id="f5aa" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated"><a class="ae kl" href="https://craigtaub.dev/under-the-hood-of-react-hooks" rel="noopener ugc nofollow" target="_blank">反应钩</a></li><li id="220a" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated"><a class="ae kl" href="https://craigtaub.dev/under-the-hood-of-web-bundlers" rel="noopener ugc nofollow" target="_blank">网络捆扎机(如网络包)</a></li></ul></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h1 id="30d0" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">阿波罗组织架构</h1><p id="4fe9" class="pw-post-body-paragraph jn jo iq jp b jq mf js jt ju mg jw jx jy mh ka kb kc mi ke kf kg mj ki kj kk ij bi translated">我认为在Github上概述Apollo组织很有趣。我们感兴趣的组件的设置如下图所示。</p><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mk"><img src="../Images/916d5c6ad087ac382d3168284aeb397e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Eu5FbM7LCHq6vzgM4rHfkA.png"/></div></div></figure><p id="7382" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">要点</strong></p><ul class=""><li id="716c" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">分为存储库和单一存储库</li><li id="457c" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">总共130个储存库</li><li id="61d6" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">大量的打字稿(所有我们感兴趣的)</li><li id="f07a" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">包括设计原则和路线图(为社区和用户提供指导)</li></ul></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h1 id="4502" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">看得见的</h1><p id="bf68" class="pw-post-body-paragraph jn jo iq jp b jq mf js jt ju mg jw jx jy mh ka kb kc mi ke kf kg mj ki kj kk ij bi translated">可观测量是阿波罗工作的一个重要机制，所以我认为最好对它们做一个简单的提醒。</p><p id="f211" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">简而言之:</p><ul class=""><li id="fe6b" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">新的<strong class="jp ir"> <em class="mw">异步原语</em> </strong>(如承诺和流)</li><li id="8395" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">具有一些<strong class="jp ir">强大的属性</strong>(懒惰、多次运行序列、可取消、内置易于数据操作的操作符)。</li></ul><p id="4d8e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">示例用法:</p><ol class=""><li id="945a" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk mx ks kt ku bi translated">创建可观察对象</li></ol><pre class="ml mm mn mo gt my mz na nb aw nc bi"><span id="19c8" class="nd li iq mz b gy ne nf l ng nh"><strong class="mz ir">subscriptionFunction</strong> = (observer) =&gt; {</span><span id="8547" class="nd li iq mz b gy ni nf l ng nh">  // run some code...</span><span id="658f" class="nd li iq mz b gy ni nf l ng nh">  observer.next("call next in sequence");</span><span id="d2ad" class="nd li iq mz b gy ni nf l ng nh">  observer.complete();</span><span id="b561" class="nd li iq mz b gy ni nf l ng nh">  return () =&gt;  console.log("unsubscribe has been called")</span><span id="d776" class="nd li iq mz b gy ni nf l ng nh">}</span><span id="842c" class="nd li iq mz b gy ni nf l ng nh"><strong class="mz ir">observableObject</strong> = new <strong class="mz ir">Observable</strong>(<strong class="mz ir">subscriptionFunction</strong>);</span></pre><blockquote class="nj nk nl"><p id="894c" class="jn jo mw jp b jq jr js jt ju jv jw jx nm jz ka kb nn kd ke kf no kh ki kj kk ij bi translated">一个可观察对象只是一个函数，它接受一个观察者并返回一个函数</p></blockquote><p id="f3bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.订阅observable:</p><pre class="ml mm mn mo gt my mz na nb aw nc bi"><span id="505c" class="nd li iq mz b gy ne nf l ng nh"><strong class="mz ir">subscription</strong> = <strong class="mz ir">observableObject</strong>.<strong class="mz ir">subscribe</strong>({</span><span id="b367" class="nd li iq mz b gy ni nf l ng nh">  next(x) { console.log(x) }, // "call next in sequence"</span><span id="b63d" class="nd li iq mz b gy ni nf l ng nh">  error(err) { console.log("receives terminating error of the sequence.") },</span><span id="e31a" class="nd li iq mz b gy ni nf l ng nh">  complete() { console.log("Stream has completed successfully.") }</span><span id="0bf1" class="nd li iq mz b gy ni nf l ng nh">});</span><span id="c10e" class="nd li iq mz b gy ni nf l ng nh"><strong class="mz ir">subscription.unsubscribe();</strong></span></pre><p id="f415" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">订阅观察者将触发订阅功能。它可用于同步或异步操作。</p><p id="43dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">他们采用发布/订阅模式。</p><blockquote class="nj nk nl"><p id="14e0" class="jn jo mw jp b jq jr js jt ju jv jw jx nm jz ka kb nn kd ke kf no kh ki kj kk ij bi translated">定义对象之间的一对多关系。当一个对象的状态发生变化时，会通知并更新从属对象。</p></blockquote><p id="793b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们将重点放在Apollo客户端代码本身。</p></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h1 id="2ccc" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">给我看看代码！！</h1><p id="fd38" class="pw-post-body-paragraph jn jo iq jp b jq mf js jt ju mg jw jx jy mh ka kb kc mi ke kf kg mj ki kj kk ij bi translated">我们将关注阿波罗的基本“你好世界”是什么样子的。一些你可以在网上找到的东西。这包括两个部分。</p><p id="c124" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> index.js(左下)</strong></p><p id="d9f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这包括我们的设置和配置。</p><p id="5841" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> app.js(右下方)</strong></p><p id="d3a3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这包括查询组件、查询细节和另一个组件中的响应呈现。</p><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi np"><img src="../Images/8cc072973e22c5ee0eb8a2dda6f4b3ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mn1y9tf66XIoRg7Pb_4X2g.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">我们的示例应用程序</figcaption></figure><p id="5bc2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们现在将分解使用的每个组件，包括一个关于它们如何工作的简短声明和一个帮助截图。</p></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi nu"><img src="../Images/e09dbf1b71b234f548299b3a93d8bb85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SRFwv5I0KMTJfZ6AFU8DMw.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">简单JS数据存储</figcaption></figure></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi nv"><img src="../Images/1458eab23164a057fadb83a3d929ebaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mMo3B1JqylrS993hwJydSg.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">返回一个可观察值。触发时运行fetch，然后fetch按照观察到的响应顺序运行下一个。注意:获取必须已经可用。</figcaption></figure></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi nw"><img src="../Images/9140310a87ac7731e5ba1b65bb8d561e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rmfkPCQ4zI9wgQAjFHZ05g.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">HTTPLink中的可观察对象、缓存和我们的查询组件之间的桥梁。对中间的数据进行处理(在以后的文章中会详细介绍)。</figcaption></figure></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi nx"><img src="../Images/0db1232ecda7d6da6ea6baf549bc8709.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ay3h1LTWdNWYa0sgcoHpWA.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">瘦包装器使this.context.client对所有呈现的子级可用</figcaption></figure></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi ny"><img src="../Images/78887a658d16ab40dc74636ce7d08b15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zpTPjXNWrlXRPsEXH5KQGg.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">获取准备在GraphQL服务器上处理的查询</figcaption></figure></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi nz"><img src="../Images/9de16e0e2c953c29b1293f0198f2ad9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XmpitHF1ANeLuE2AKfTl4w.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">多肉的部分！</figcaption></figure></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi oa"><img src="../Images/d80755f380a362c6c0d3acfefe2a7089.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PpmDIWVYKOywsbkenc3itw.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">事件发生顺序的高级视图。</figcaption></figure></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi ob"><img src="../Images/f0814253350261e408fee294151c7fcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8TUj9Cd264ql0nyzdomatA.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">崩溃…</figcaption></figure></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><p id="0099" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就这样，如果你发现任何错误或有任何问题，请让我知道。</p><p id="2f56" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就个人而言，我发现理解一些我在开发过程中会注意到的边缘情况是有帮助的。例如<em class="mw"> SSR不能开箱即用，因为订阅/获取事件序列都在DOM挂载</em>中。</p><p id="0f42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望你在这篇文章中发现了一些有趣或有用的东西。</p><p id="2129" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步是查看更高级的特性，如突变、缓存、批处理等。我非常期待看到这一成果。</p><p id="e257" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">谢谢，克雷格:)</p></div></div>    
</body>
</html>