<html>
<head>
<title>Modern C++ in Advent of Code: Day5</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">现代C++代码的出现:第5天</h1>
<blockquote>原文：<a href="https://itnext.io/modern-c-in-advent-of-code-day5-4777e4037869?source=collection_archive---------7-----------------------#2021-12-05">https://itnext.io/modern-c-in-advent-of-code-day5-4777e4037869?source=collection_archive---------7-----------------------#2021-12-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="a7bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是代码问世的第五天。今天，我们将解一些方程来找出线的交点。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/af8a7047073d5f237e5312f15ca8d457.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wtEIT9C2UVBYsf2AYETIVg.png"/></div></div></figure><p id="b685" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一如既往，请先尝试解决问题，然后再看解决方案。对于本系列中的所有文章，<a class="ae kl" href="https://medium.com/@happy.cerberus/list/advent-of-code-2021-using-modern-c-c5814cb6666e" rel="noopener">查看这个列表</a>。</p><h1 id="b19a" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">第五天:第一部分</h1><p id="41fc" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">我们得到一个格式为<code class="fe mb mc md me b">x1,y1 -&gt; x2,y2</code>的线条列表，任务是确定多条线条相交的所有点。对于第1部分，我们将忽略所有非轴向的线(水平或垂直)。</p><p id="d3aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">两条线什么时候相交？考虑作为交集一部分的点<code class="fe mb mc md me b">[x,y]</code>。自然，肯定是:<code class="fe mb mc md me b">line1.x1 &lt;= x &lt;= line1.x2</code>、<code class="fe mb mc md me b">line2.x1 &lt;= x &lt;= line2.x2</code>、<code class="fe mb mc md me b">line1.y1 &lt;= y &lt;= line1.y2</code>、<code class="fe mb mc md me b">line2.y1 &lt;= y &lt;= line2.y2</code>。如果我们把这些公式放在一起，我们得到:</p><ul class=""><li id="8c86" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mk ml mm mn bi translated"><code class="fe mb mc md me b">max(line1.x1,line2.x1) &lt;= x &lt;= min(line1.x2,line2.x2)</code></li><li id="44bd" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated"><code class="fe mb mc md me b">max(line1.y1,line2.y1) &lt;= y &lt;= min(line1.y2,line2.y2)</code></li></ul><p id="01cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">鉴于此，交点要么不存在，要么是直线<code class="fe mb mc md me b">max(line1.x1,line2.x1),max(line1.y1,line2.y1) -&gt; min(line1.x2,line2.x2),min(line1.y2,line2.y2)</code>。</p><p id="e38d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，这仅在<code class="fe mb mc md me b">x1&lt;x2</code>和<code class="fe mb mc md me b">y1&lt;y2</code>时有效，这是我们在读取输入时可以轻松实现的。</p><p id="5b60" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了简单起见(我也找不到动机对这样一个小输入做更复杂的事情)，我们将对照所有先前读取的行测试我们读取的每一行，并将结果交叉点保存在一个<code class="fe mb mc md me b">unordered_set</code>中。</p><p id="c3ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将需要一个点的表示，并使该点可散列，因为我们想在<code class="fe mb mc md me b">unordered_set</code>中存储点。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="d776" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要一条线的表示:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="0fb1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于交叉点可以是空的，我们使用<code class="fe mb mc md me b">std::optional</code>来避免使我们的线结构复杂化(来表示空的线段)。</p><p id="fe72" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">声明完成后，我们可以编写测试了:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="7de1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们需要I/O实现:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="9b6d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们按照预期的格式阅读，如果遇到问题就提前返回。当我们遇到意外的分隔符时，我们还需要在输入流上设置<code class="fe mb mc md me b">std::ios_base::badbit</code>(第11行和第35行)。正如已经提到的，我们修改输入，使<code class="fe mb mc md me b">start.x &lt;= end.x</code>和<code class="fe mb mc md me b">start.y &lt;= end.y</code>。请注意，这仅适用于零件1，且仅适用于轴线。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="d343" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我们实现我们已经讨论过的公式。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="26ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们的main中，我们读取所有的线，跳过不在轴上的线，并存储相交部分的所有点。</p><h1 id="c775" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">第五天:第二部分</h1><p id="17d5" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">在第二部分中，对角线问题变得更加复杂。因此，我们需要一个更通用的解决方案来找出交叉点。</p><p id="fbb1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有两种类型的交点需要考虑:单点交点，即具有不同方向的两条线段在一点相交；或者叠加交点，即具有相同方向的线段在一个或多个点重叠。</p><p id="eda2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以像第1部分一样解决叠加交点，但我们需要一个单点交点的通用解决方案。</p><p id="63cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">考虑这个交点<code class="fe mb mc md me b">[x,y]</code>。它必须在两条线路上都可以到达。因此<code class="fe mb mc md me b">x = line1.start.x + m*line1.xdir</code>和<code class="fe mb mc md me b">x = line2.start.x + n*line2.xdir</code>，其中<code class="fe mb mc md me b">m</code>和<code class="fe mb mc md me b">n</code>分别是该点到<code class="fe mb mc md me b">line1</code>和<code class="fe mb mc md me b">line2</code>中直线起点的距离。y也一样:<code class="fe mb mc md me b">y = line1.start.y + m*line1.ydir</code>和<code class="fe mb mc md me b">y = line2.start.y + n*line2.ydir</code>。</p><p id="f855" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以把这些等式放在一起:</p><ul class=""><li id="6ff9" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mk ml mm mn bi translated"><code class="fe mb mc md me b">line1.start.x + m*line1.xdir = line2.start.x + n*line2.xdir</code></li><li id="340a" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated"><code class="fe mb mc md me b">line1.start.y + m*line1.ydir = line2.start.y + n*line2.ydir</code></li></ul><p id="f0ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有了两个方程，我们现在可以求解m和n。我们最终得到一个有两个角点的分数。我们可以除以2，但分子不是偶数。当对角线在视觉上交叉，但交叉点在我们的“像素”的角上时，就会发生这种情况(例如线<code class="fe mb mc md me b">0,0 -&gt; 5,5</code>和<code class="fe mb mc md me b">0,5 -&gt; 5,0</code>)。我们也可以除以零，这发生在平行线上。最后，位于线段外的点可以满足该方程(这些方程适用于直线)。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="7b15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然我们的点结构保持不变，但我们需要扩展线结构。覆盖式相交由<code class="fe mb mc md me b">does_overlay</code>、<code class="fe mb mc md me b">does_intersect</code>和<code class="fe mb mc md me b">intersect</code>处理，基于点的相交由<code class="fe mb mc md me b">single_point_intersect</code>和<code class="fe mb mc md me b">is_within</code>处理。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="251d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这部分的测试范围更广。我必须创建特殊的测试用例来追踪我的代码中的特定bug(第16–22行)。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="0f45" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从<code class="fe mb mc md me b">is_within</code>开始，检查一个点是否在线段内。我们需要确保在被<code class="fe mb mc md me b">xdir()</code>和<code class="fe mb mc md me b">ydir()</code>除的时候不会被零除。我们检查该点是否不在线段之外，并再次检查两个轴是否匹配。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="2ada" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一个新功能是检查覆盖交叉点。只有具有相同方向性的线段和同一条对角线上的对角线(10号线)才能重叠。</p><p id="010d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我们的两个交集计算:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="eb95" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们正在引入额外的<code class="fe mb mc md me b">does_overlay</code>检查(第2行)并调整y轴上倾斜到零的对角线的结果(第6–8行)。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="262d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们检查已经提到的拐角情况:平行线、网格拐角处的交点和外部线段。除此之外，我们只是1:1地实现数学公式。</p><p id="4589" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将所有这些都集中在我们的主要:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="0b86" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们再次一行一行地阅读这些行，并对照所有已经阅读过的行进行检查。如果这些线没有相互重叠(线6)，它们仍然可能有一个单点相交(线21)。</p><h1 id="ccd8" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">链接和技术说明</h1><p id="e3cd" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">每日解决方案存储库位于:<a class="ae kl" href="https://github.com/HappyCerberus/moderncpp-aoc-2021" rel="noopener ugc nofollow" target="_blank">https://github.com/HappyCerberus/moderncpp-aoc-2021</a>。</p><p id="dcae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://medium.com/@happy.cerberus/list/advent-of-code-2021-using-modern-c-c5814cb6666e" rel="noopener">查看此列表，了解《代号</a>问世前几天的文章。</p><p id="6cfc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请不要忘记亲自尝试<a class="ae kl" href="https://adventofcode.com/2021" rel="noopener ugc nofollow" target="_blank">降临码</a>。</p><h1 id="c875" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">感谢您的阅读</h1><p id="1677" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">感谢您阅读这篇文章。你喜欢吗？</p><p id="f13c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我也在YouTube上发布视频。你有问题吗？在Twitter或LinkedIn上联系我。</p></div></div>    
</body>
</html>