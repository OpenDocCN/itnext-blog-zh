<html>
<head>
<title>Monitoring Certificates Expiration in Kubernetes with X.509 Exporter</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用X.509 Exporter监控Kubernetes中的证书过期</h1>
<blockquote>原文：<a href="https://itnext.io/monitoring-certificates-expiration-in-kubernetes-with-x-509-exporter-8030b69f611d?source=collection_archive---------3-----------------------#2021-11-30">https://itnext.io/monitoring-certificates-expiration-in-kubernetes-with-x-509-exporter-8030b69f611d?source=collection_archive---------3-----------------------#2021-11-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/75acb3019f1a36338c1ba3c809ac41dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5em3lTugvK0DoYNn.png"/></div></div></figure><p id="c965" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">KubeSphere提供了一个开发人员友好的向导，简化了Kubernetes的操作和维护，但它本质上是建立在Kubernetes之上的。Kubernetes的TLS证书只有一年的有效期，所以我们需要每年更新证书，这是不可避免的，即使集群是通过强大的轻量级安装工具<a class="ae kw" href="https://github.com/kubesphere/kubekey" rel="noopener ugc nofollow" target="_blank"> KubeKey </a>安装的。为了防止证书过期可能带来的风险，我们需要找到一种方法来监控Kubernetes组件的证书有效性。</p><p id="00aa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有些人可能听说过<a class="ae kw" href="https://github.com/ribbybibby/ssl_exporter" rel="noopener ugc nofollow" target="_blank"> ssl-exporter </a>，它导出从各种来源收集的ssl证书的指标，比如HTTPS证书、文件证书、Kubernetes Secret和kubeconfig文件。基本上，ssl-exporter可以满足我们的需求，但是它没有丰富的指标。在这里，我给大家分享一个更强大的普罗米修斯导出器:<a class="ae kw" href="https://github.com/enix/x509-certificate-exporter" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir">x509-certificate-Exporter</strong></a>。</p><p id="9267" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">与ssl-exporter不同，x509-certificate-exporter只关注Kubernetes集群的证书的过期监控，比如每个组件的文件证书、Kubernetes TLS Secret和kubeconfig文件。此外，它提供了更多的度量标准。接下来，我将展示如何在KubeSphere上部署x509-certificate-exporter来监控集群的所有证书。</p><h1 id="2029" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">准备KubeSphere应用程序模板</h1><p id="f66c" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">借助<a class="ae kw" href="https://github.com/openpitrix/openpitrix" rel="noopener ugc nofollow" target="_blank"> OpenPitrix </a>这一多云应用管理平台，<a class="ae kw" href="https://kubesphere.io/" rel="noopener ugc nofollow" target="_blank"> KubeSphere </a>能够管理应用的整个生命周期，并允许您使用App Store和应用模板直观地部署和管理应用。对于没有在app Store发布的app，可以将其Helm chart导入到KubeSphere的公共库，或者导入到私有的App库，提供App模板。</p><p id="403e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里，我们使用一个KubeSphere应用程序模板来部署x509-certificate-exporter。</p><p id="097c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用app模板部署一个app，需要创建一个工作区，一个项目，两个用户(<code class="fe ma mb mc md b">ws-admin</code>和<code class="fe ma mb mc md b">project-regular</code>)，将工作区中的平台角色<code class="fe ma mb mc md b">workspace-admin</code>分配给<code class="fe ma mb mc md b">ws-admin</code>，将项目中的角色<code class="fe ma mb mc md b">operator</code>分配给<code class="fe ma mb mc md b">project-regular</code>。首先，让我们回顾一下KubeSphere的多租户架构。</p><h1 id="45aa" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">多租户Kubernetes架构</h1><p id="7ba1" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">KubeSphere的多租户系统分为三个层次:集群、工作区、项目(相当于Kubernetes的<a class="ae kw" href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/" rel="noopener ugc nofollow" target="_blank">命名空间</a>)。</p><p id="0b06" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">由于系统工作区运行系统资源，其中大部分只能查看，建议您创建一个新的<a class="ae kw" href="https://kubesphere.com.cn/en/docs/workspace-administration/what-is-workspace/" rel="noopener ugc nofollow" target="_blank">工作区</a>。出于安全原因，我们强烈建议您在不同的租户在一个工作空间中协作时向他们授予不同的权限。</p><p id="ecbd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以在KubeSphere集群中创建多个工作区。在每个工作区中，您可以创建多个项目。默认情况下，KubeSphere为每个级别提供了几个内置角色。此外，KubeSphere允许您创建具有定制权限的角色。总体来说，KubeSphere的多租户架构非常适合向往基于角色管理的企业和组织。</p><h1 id="77e1" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">创建用户</h1><p id="dd9e" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">安装KubeSphere后，您需要创建具有不同角色的用户，以便他们可以在授权范围内工作。最初，系统有一个默认用户<code class="fe ma mb mc md b">admin</code>，它被分配了角色<code class="fe ma mb mc md b">platform-admin</code>。在下面，我们将创建一个名为<code class="fe ma mb mc md b">user-manager</code>的用户，它将用于创建新用户。</p><p id="cc2d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">1.以用户<code class="fe ma mb mc md b">admin</code>的身份登录KubeSphere web控制台，默认密码为<code class="fe ma mb mc md b">P@88w0rd</code>。</p><blockquote class="me mf mg"><p id="d010" class="jy jz mh ka b kb kc kd ke kf kg kh ki mi kk kl km mj ko kp kq mk ks kt ku kv ij bi translated"><em class="iq">为了帐户安全，强烈建议您在首次登录控制台时更改密码。要更改密码，点击右上角下拉列表中的</em> <strong class="ka ir"> <em class="iq">用户设置</em> </strong> <em class="iq">。在</em> <strong class="ka ir"> <em class="iq">密码设置</em> </strong> <em class="iq">中，设置新密码。您也可以在</em> <strong class="ka ir"> <em class="iq">用户设置</em> </strong> <em class="iq">中更改控制台的语言。</em></p></blockquote><p id="db53" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.点击左上角的<strong class="ka ir">平台</strong>，然后点击<strong class="ka ir">门禁</strong>。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ml"><img src="../Images/eb64a6e298f8658a18c60c9c662fc4e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NgjEfOfUYJ8g8a3n.png"/></div></div></figure><p id="de5e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在左侧导航窗格中，点击<strong class="ka ir">平台角色</strong>，您会发现四个可用的内置角色。将角色<code class="fe ma mb mc md b">users-manager</code>分配给您创建的第一个用户。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mq"><img src="../Images/fbded40cffb4b249193ff53e37349ab7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jk2xEsoxByVE9CiH81lVzQ.png"/></div></div></figure><p id="5774" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.在<strong class="ka ir">用户</strong>中，点击<strong class="ka ir">创建</strong>。在显示的对话框中，提供所有必要的信息(标有*)并为<strong class="ka ir">平台角色</strong>选择<code class="fe ma mb mc md b">users-manager</code>。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mr"><img src="../Images/a3b0f292b65ed2721f095ce63aacf0f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8rYPDze6IatTCdoS.png"/></div></div></figure><p id="3ad6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">点击<strong class="ka ir">确定</strong>。在<strong class="ka ir">用户</strong>中，您可以在用户列表中找到新创建的用户。</p><p id="d44f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">4.从控制台注销，以用户<code class="fe ma mb mc md b">user-manager</code>的身份重新登录，创建下表中列出的另外三个用户。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/ec7eeaaf3192521114d16c20b7cd91fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TWAbv6kit1BZb7LvSMYC6A.png"/></div></div></figure><p id="8514" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">5.在<strong class="ka ir">用户</strong>中，您可以查看刚刚创建的三个用户。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mt"><img src="../Images/1f5e0bc8b3005fca38d9d1f465f11cc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kKHmtwcsHAx9CVXc.png"/></div></div></figure><h1 id="c89d" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">创建工作区</h1><p id="960b" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">在这个部分中，您需要使用在上一步中创建的用户<code class="fe ma mb mc md b">ws-manager</code>来创建一个工作区。作为管理项目、工作负载创建和组织成员的基本逻辑单元，工作区支撑着KubeSphere的多租户系统。</p><p id="4357" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">1.以<code class="fe ma mb mc md b">ws-manager</code>的身份登录KubeSphere，他拥有管理平台上所有工作区的权限。点击左上角的<strong class="ka ir">平台</strong>，选择<strong class="ka ir">门禁</strong>。在<strong class="ka ir">工作区</strong>中，您可以看到只有一个默认工作区<code class="fe ma mb mc md b">system-workspace</code>，系统相关的组件和服务在这里运行。不允许您删除此工作区。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/01d61c33761c31146a6799df6df888c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SRAAHbfcyqSiqa-r.png"/></div></div></figure><p id="3739" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.点击右侧的<strong class="ka ir">创建</strong>，为新的工作空间设置一个名称(例如<code class="fe ma mb mc md b">demo-workspace</code>，并将用户<code class="fe ma mb mc md b">ws-admin</code>设置为工作空间管理员。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/21732e557ca492b2ef0caae19e8690e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_CRxYeR7EFtmrPzI.png"/></div></div></figure><p id="5590" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成后点击<strong class="ka ir">创建</strong>。</p><p id="761a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.注销控制台，然后以<code class="fe ma mb mc md b">ws-admin</code>的身份重新登录。在<strong class="ka ir">工作区设置</strong>中，选择<strong class="ka ir">工作区成员</strong>，然后点击<strong class="ka ir">邀请</strong>。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/141b02e5ca078a23b3eac3f297c83457.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*FKentHsFQgBlcehh.png"/></div></div></figure><p id="6788" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">4.邀请<code class="fe ma mb mc md b">project-regular</code>进入工作区，为其分配角色<code class="fe ma mb mc md b">workspace-viewer</code>，然后点击<strong class="ka ir">确定</strong>。</p><blockquote class="me mf mg"><p id="7aae" class="jy jz mh ka b kb kc kd ke kf kg kh ki mi kk kl km mj ko kp kq mk ks kt ku kv ij bi translated">实际的角色名称遵循一个命名约定:<workspace name=""> - <role name="">。例如，在工作空间<code class="fe ma mb mc md b">demo-workspace</code>中，角色<code class="fe ma mb mc md b">viewer</code>的实际角色名称是<code class="fe ma mb mc md b">demo-workspace-viewer</code>。</role></workspace></p></blockquote><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/281212d1b5aa56f8cc0abd0b9ce590ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*K4ioE9ltiGEBh7-Q.png"/></div></div></figure><p id="3a36" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">5.将<code class="fe ma mb mc md b">project-regular</code>添加到工作空间后，点击<strong class="ka ir">确定</strong>。在<strong class="ka ir">工作区成员</strong>中，你可以看到列出了两个成员。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/caa2d75820eb4c69421d05824848f982.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o4PddKdkWMMibsKK_KVvxg.jpeg"/></div></div></figure><h1 id="13d6" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">创建项目</h1><p id="0a71" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">在本节中，您需要使用之前创建的用户<code class="fe ma mb mc md b">ws-admin</code>来创建一个项目。KubeSphere中的项目与Kubernetes中的名称空间相同，为资源提供虚拟隔离。更多信息，请参见<a class="ae kw" href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/" rel="noopener ugc nofollow" target="_blank">名称空间</a>。</p><p id="163e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">1.以<code class="fe ma mb mc md b">ws-admin</code>的身份登录KubeSphere web控制台。在<strong class="ka ir">项目</strong>中，点击<strong class="ka ir">创建</strong>。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi my"><img src="../Images/9c3e06ec7f289ae210c9c8d25eeaa299.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bvNbcX5TMYjeLULP.png"/></div></div></figure><p id="0b5b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.输入项目名称(如<code class="fe ma mb mc md b">exporter</code>)并点击<strong class="ka ir">确定</strong>。您还可以为项目添加别名和描述。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mz"><img src="../Images/880c5e71398769746869d8fc3e244d0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Z8fwt5xnUzMtmwIm.png"/></div></div></figure><p id="f93a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.在<strong class="ka ir">项目</strong>中，点击项目名称查看其详细信息。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/3ccf40ab6ad2590b38f77c8b76bec91d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QpjubBTBH8nyAfy5.png"/></div></div></figure><p id="809e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">4.在<strong class="ka ir">项目设置</strong>中，选择<strong class="ka ir">项目成员</strong>，点击<strong class="ka ir">邀请</strong>邀请<code class="fe ma mb mc md b">project-regular</code>加入项目，将角色<code class="fe ma mb mc md b">operator</code>分配给<code class="fe ma mb mc md b">project regular</code>。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/c465266b283cb1bb7b67c19af86278e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rZASWGBNc_z39p_V.png"/></div></div></figure><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/962144e44d1f5ba533700900588da3f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3CyVj8pjn-o5qL2Y.png"/></div></div></figure><blockquote class="me mf mg"><p id="022e" class="jy jz mh ka b kb kc kd ke kf kg kh ki mi kk kl km mj ko kp kq mk ks kt ku kv ij bi translated">角色为<code class="fe ma mb mc md b">operator</code>的用户是项目维护人员，他们可以管理项目中除用户和角色之外的资源。</p></blockquote><h1 id="84b9" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">添加应用程序存储库</h1><p id="ef35" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">1.以用户<code class="fe ma mb mc md b">ws-admin</code>身份登录KubeSphere的web控制台。在你的工作区，进入<strong class="ka ir">应用管理</strong>下的<strong class="ka ir">应用库</strong>，然后点击<strong class="ka ir">添加</strong>。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nb"><img src="../Images/d1ae11107c0486c8114368318088ab54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bU8QmHcO9df-xJp_.png"/></div></div></figure><p id="4c87" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.在显示的对话框中，指定应用程序存储库名称(例如，<code class="fe ma mb mc md b">enix</code>)并添加您的存储库URL(例如，<code class="fe ma mb mc md b">https://charts.enix.io</code>)。点击<strong class="ka ir">验证</strong>验证URL，然后点击<strong class="ka ir">确定</strong>。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/5977d6f024a3af45ee3327c8232c89fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*npDvu5wQkU9RfIQC.png"/></div></div></figure><p id="ea86" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.在<strong class="ka ir">应用程序库</strong>中，您可以查看创建的应用程序库。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nd"><img src="../Images/adc550d27ac8e4afb42fb45ad0f8bdf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EUi5FwJfFomFXEND.png"/></div></div></figure><h1 id="03ea" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">部署x509-证书导出程序</h1><p id="ef23" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">导入x509-certificate-exporter的应用程序存储库后，可以使用应用程序模板部署x509-certificate-exporter。</p><p id="43e1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">1.注销KubeSpere web控制台，并以用户<code class="fe ma mb mc md b">project-regular</code>的身份登录控制台。单击您创建的项目以转到项目页面。进入<strong class="ka ir">应用工作负载</strong>下的<strong class="ka ir">应用</strong>，点击<strong class="ka ir">创建</strong>。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/adf3f888ad203a87fd707f9cc77a81b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eQ0Wi6kLmiKZETaf.png"/></div></div></figure><p id="9b13" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.在显示的对话框中，从App模板中选择<strong class="ka ir">。</strong></p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ne"><img src="../Images/9808b6354bc8f5897f4f00914a9b2e9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*J7YPxJMvaPqE4zZZ.png"/></div></div></figure><p id="05f8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">来自App Store </strong>:选择内置应用或上传为舵图的应用。</p><p id="c472" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">来自应用模板</strong>:从私有应用库或当前工作区选择一个应用。</p><p id="d9bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.在下拉列表中，选择您刚刚上传的私有应用库<code class="fe ma mb mc md b">enix</code>。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nf"><img src="../Images/3d576f56071ed13f09cffb1ca66d2cea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*v_Wz5JLTgyL5oLXA.png"/></div></div></figure><p id="6bce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">4.选择x509-证书-导出器进行部署。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/1d86dbdd4aa710167dcb63e7135f1bde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*X_zIpoWGoeRW2fPa.png"/></div></div></figure><p id="6431" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">5.在<strong class="ka ir">版本</strong>下拉列表中，选择一个app版本，然后点击<strong class="ka ir">部署</strong>。同时，您可以查看应用程序信息和清单。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/b3d477722b4892571615aba78f419636.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qR8zWM2EGSrgxZ_D.png"/></div></div></figure><p id="6600" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">6.设置app名称，确认app版本和部署位置，点击<strong class="ka ir">下一步</strong>。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/a23e727cda54410e47c0445ca33a99fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*UIifSk_vM4uAMyEJ.png"/></div></div></figure><p id="856a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">7.在<strong class="ka ir"> App设置</strong>中，需要手动编辑清单，指定证书文件的路径。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/dc9df6d361c0a86c07559f2672db5bda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zK3KcHg_hg9jj8Bh.png"/></div></div></figure><pre class="mm mn mo mp gt nk md nl nm aw nn bi"><span id="9445" class="no ky iq md b gy np nq l nr ns">daemonSets:<br/>    master:<br/>      nodeSelector:<br/>        node-role.kubernetes.io/master: ''<br/>      tolerations:<br/>        - effect: NoSchedule<br/>          key: node-role.kubernetes.io/master<br/>          operator: Exists<br/>      watchFiles:<br/>        - /var/lib/kubelet/pki/kubelet-client-current.pem<br/>        - /etc/kubernetes/pki/apiserver.crt<br/>        - /etc/kubernetes/pki/apiserver-kubelet-client.crt<br/>        - /etc/kubernetes/pki/ca.crt<br/>        - /etc/kubernetes/pki/front-proxy-ca.crt<br/>        - /etc/kubernetes/pki/front-proxy-client.crt<br/>      watchKubeconfFiles:<br/>        - /etc/kubernetes/admin.conf<br/>        - /etc/kubernetes/controller-manager.conf<br/>        - /etc/kubernetes/scheduler.conf<br/>    nodes:<br/>      tolerations:<br/>        - effect: NoSchedule<br/>          key: node-role.kubernetes.io/ingress<br/>          operator: Exists<br/>      watchFiles:<br/>        - /var/lib/kubelet/pki/kubelet-client-current.pem<br/>        - /etc/kubernetes/pki/ca.crt</span></pre><p id="73e1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建了两个<code class="fe ma mb mc md b">DaemonSets</code>，其中主节点在控制器节点上运行，节点在计算节点上运行。</p><pre class="mm mn mo mp gt nk md nl nm aw nn bi"><span id="4257" class="no ky iq md b gy np nq l nr ns">$ kubectl -n exporter get ds<br/>   <br/>NAME                   DESIRED   CURRENT   READY   UP-TO-DATE   </span><span id="2734" class="no ky iq md b gy nt nq l nr ns">x509-x509-certificate<br/>-exporter-master        1         1         1        1</span><span id="eea0" class="no ky iq md b gy nt nq l nr ns">x509-x509-certificate<br/>-exporter-nodes         3         3         3        3</span><span id="2ae4" class="no ky iq md b gy nt nq l nr ns"><br/>AVAILABLE      NODE SELECTOR                       AGE<br/>    <br/>    1          node-role.kubernetes.io/master=     3d14h<br/>    3           &lt;none&gt;                             3d14h</span></pre><p id="eb77" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下是参数的定义方式:</p><ul class=""><li id="1fad" class="nu nv iq ka b kb kc kf kg kj nw kn nx kr ny kv nz oa ob oc bi translated"><strong class="ka ir"> watchFiles: </strong>指定证书文件的路径。</li><li id="8ff2" class="nu nv iq ka b kb od kf oe kj of kn og kr oh kv nz oa ob oc bi translated"><strong class="ka ir"> watchKubeconfFiles: </strong>指定kubeconfig文件的路径。</li></ul><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oi"><img src="../Images/c53d8c41bb230ebe330a21d110d3ece9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_vhANo_qffWcuuzB.png"/></div></div></figure><p id="9691" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">8.点击<strong class="ka ir">安装</strong>，等待应用程序成功创建并运行。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/9d8021060515ad5264289f1c7da521f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1JwXVPl_L87YsQA5.png"/></div></div></figure><h1 id="c836" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">集成监控系统</h1><p id="a819" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">使用应用程序模板部署应用程序后，还将创建一个<code class="fe ma mb mc md b">ServiceMonitor</code>和两个DaemonSets。</p><pre class="mm mn mo mp gt nk md nl nm aw nn bi"><span id="2894" class="no ky iq md b gy np nq l nr ns">$ kubectl -n exporter get servicemonitor<br/>NAME                             AGE<br/>x509-x509-certificate-exporter   3d15h</span></pre><p id="2df9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">打开普罗米修斯的web UI，可以看到对应的<code class="fe ma mb mc md b">Targets</code>已经准备好了。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/a272407e37c46b0f20522230aa061e56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*FQTQ8eZtZ3_wqWCR.png"/></div></div></figure><p id="d448" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">x509-certificate-exporter官方提供了一个<a class="ae kw" href="https://grafana.com/grafana/dashboards/13922" rel="noopener ugc nofollow" target="_blank"> Grafana仪表盘</a>，如下图所示。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/c3db7cb893d46c7c4c44caa658092242.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*J4WmLBw_8DiLqT8S.jpg"/></div></div></figure><p id="a199" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">可以看到，所有的指标都非常清晰。一般情况下，我们只需要关注已经过期和即将过期的证书。假设您想知道证书的有效性，使用<code class="fe ma mb mc md b">(x509_cert_not_after{filepath!=""} - time()) / 3600 / 24</code>表达式。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/83709811e18d84d139ae6e65e61dd665.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1drw1ZB9UB0H2qfW.png"/></div></div></figure><p id="8ed1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，您可以创建警报策略，以便O&amp;M人员可以在证书即将过期时收到通知，并及时更新证书。要创建警报策略，请执行以下步骤:</p><ol class=""><li id="c294" class="nu nv iq ka b kb kc kf kg kj nw kn nx kr ny kv oj oa ob oc bi translated">进入<strong class="ka ir">监控&amp;告警</strong>下的<strong class="ka ir">告警策略</strong>，点击<strong class="ka ir">创建</strong>。</li></ol><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/0b2af8836f18808e7241ead3fcc7a366.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qcavn8vd4FYPOvdU.png"/></div></div></figure><p id="c37e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.输入警报策略的名称，设置严重性，然后单击下一步的<strong class="ka ir">。</strong></p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ok"><img src="../Images/24c181054b42f0aa146371c46062ce17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*a0a0oZBQpCf5lqOJ.png"/></div></div></figure><p id="02a3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.点击<strong class="ka ir">自定义规则</strong>页签，输入<strong class="ka ir">规则表达式</strong>的<code class="fe ma mb mc md b">(x509_cert_not_after{filepath!=""} - time()) / 3600 / 24 &lt; 30</code>。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ol"><img src="../Images/8829d588fd65501ecfd9522b6c3efc55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*nS3EidgVjTqCdkdD.png"/></div></div></figure><p id="c614" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">4.点击下一个的<strong class="ka ir">。在<strong class="ka ir">消息设置</strong>页面，填写警报的摘要和详细信息。</strong></p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ok"><img src="../Images/4036a96383116b6c3c5ca9e5cb42b32c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wDtHReoPcCm1eS-Y.png"/></div></div></figure><p id="5de0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">5.点击<strong class="ka ir">创建</strong>，告警策略创建完成。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/69507e20b82274c5447b8f020253e3c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SGctD9rng3kMa3Cm.png"/></div></div></figure><h1 id="15b0" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">摘要</h1><p id="fc6c" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">KubeSphere 3.1支持内置的证书过期警告策略。要查看策略，进入<strong class="ka ir">报警策略</strong>，点击<strong class="ka ir">内置策略</strong>，在搜索框中输入<code class="fe ma mb mc md b">expir</code>。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/3045893735cef7a6f94e50eb71e04123.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kH1Gsg8vzOGFCe-Q.png"/></div></div></figure><p id="92d2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">单击警报策略名称以查看其规则表达式。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/a764710b47ab4ab1648d98e8492a96ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LvMNoeiqZicTfanO.png"/></div></div></figure><p id="0403" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">规则表达式中的度量由API服务器组件公开，并且不包含集群的所有组件的证书。要监控所有组件的证书，建议您在部署x509-certificate-exporter时在KubeSphere上创建一个定制的警报策略。相信我，你将从证书过期中解脱出来。</p><h1 id="a890" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">关于KubeSphere</h1><p id="6602" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">KubeSphere是一个基于Kubernetes的开源容器平台，其核心是应用程序。它提供全栈It自动化操作和简化的开发运维工作流。</p><p id="38e3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://kubesphere.io/" rel="noopener ugc nofollow" target="_blank"> KubeSphere </a>已被全球数千家企业采用，如<strong class="ka ir"> Aqara、新浪、奔来、中国太平、华夏银行、国药控股、微众银行、Geko Cloud、VNG公司、Radore </strong>。KubeSphere为运维提供向导界面和各种企业级功能，包括Kubernetes资源管理、<a class="ae kw" href="https://kubesphere.io/devops/" rel="noopener ugc nofollow" target="_blank">、DevOps (CI/CD) </a>、应用生命周期管理、服务网格、多租户管理、<a class="ae kw" href="https://kubesphere.io/observability/" rel="noopener ugc nofollow" target="_blank">监控</a>、日志记录、警报、通知、存储和网络管理以及GPU支持。有了KubeSphere，企业能够快速建立一个强大且功能丰富的容器平台。</p><p id="1f23" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">欲了解更多信息，请访问<a class="ae kw" href="https://kubesphere.io/" rel="noopener ugc nofollow" target="_blank"> https://kubesphere.io </a></p></div></div>    
</body>
</html>