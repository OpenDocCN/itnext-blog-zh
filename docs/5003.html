<html>
<head>
<title>How to run a headless Chrome browser in Selenium WebDriver.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Selenium WebDriver中运行无头Chrome浏览器？</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-run-a-headless-chrome-browser-in-selenium-webdriver-c5521bc12bf0?source=collection_archive---------0-----------------------#2020-11-15">https://itnext.io/how-to-run-a-headless-chrome-browser-in-selenium-webdriver-c5521bc12bf0?source=collection_archive---------0-----------------------#2020-11-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/929a550e3a78f0ff487cc6d3ccf7f8fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EQ1qBhMKEvecmp8XrS5p7g.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/photos/yvEkwjSBZIY" rel="noopener ugc nofollow" target="_blank">沃特·贝杰特</a>拍摄</figcaption></figure><p id="4b56" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi lb translated">从版本60开始，Chrome浏览器引入了在T4无头模式下运行的能力。我们现在能够在不创建可视浏览器窗口的情况下启动浏览器。这将允许您用更少的资源更快地运行测试，最重要的是，它将允许您在没有图形组件的系统上运行测试。不要担心，截屏功能不会受到任何影响。</p><p id="d04e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我想演示如何使用这个功能。</p><p id="5165" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">任何自动测试的开始都是标准的，我们指定chrome驱动程序的路径:</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="ad45" class="lt lu iq lp b gy lv lw l lx ly">System.setProperty(<strong class="lp ir">"webdriver.chrome.driver"</strong>, <strong class="lp ir">"/path/to/driver"</strong>);</span></pre><p id="8197" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这件事情之后，我们要做的就是创建一个WebDriver对象，并设置ChromeDriver路径和一些参数:</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="0c4d" class="lt lu iq lp b gy lv lw l lx ly">ChromeOptions options = new ChromeOptions();</span><span id="f03b" class="lt lu iq lp b gy lz lw l lx ly">options.addArguments("--headless");</span><span id="b745" class="lt lu iq lp b gy lz lw l lx ly">WebDriver driver = new ChromeDriver(options);</span></pre><p id="e799" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">仅此而已。你可以运行它。</p><p id="eb03" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是，有一个问题。不可见的浏览器窗口只有800x600大小。因此，您需要使用一个附加参数来设置所需的屏幕大小:</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="68d8" class="lt lu iq lp b gy lv lw l lx ly">ChromeOptions options = new ChromeOptions();</span><span id="581f" class="lt lu iq lp b gy lz lw l lx ly">options.addArguments("--headless", <!-- -->"--window-size=1920,1200"<!-- -->);</span><span id="a72a" class="lt lu iq lp b gy lz lw l lx ly">WebDriver driver = new ChromeDriver(options);</span></pre><p id="88b7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通常，您还应该指定在开发人员模式下禁用GPU渲染、扩展和弹出窗口扩展。这通常会导致非常难看和不可读的代码。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="c4bc" class="lt lu iq lp b gy lv lw l lx ly">ChromeOptions options = new ChromeOptions();</span><span id="31f8" class="lt lu iq lp b gy lz lw l lx ly">options.addArguments("--headless", "--disable-gpu", "--window-size=1920,1200","--ignore-certificate-errors","<!-- -->--disable-extensions<!-- -->","<!-- -->--no-sandbox<!-- -->","<!-- -->--disable-dev-shm-usage<!-- -->");</span><span id="9bc0" class="lt lu iq lp b gy lz lw l lx ly">WebDriver driver = new ChromeDriver(options);</span></pre><p id="8316" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了获得更具可读性的视图，我们将重构代码:</p><ul class=""><li id="7af6" class="ma mb iq kf b kg kh kk kl ko mc ks md kw me la mf mg mh mi bi translated">让我们从指定驱动程序的路径开始。我们可以使用第三方的<a class="ae kc" href="https://github.com/bonigarcia/webdrivermanager" rel="noopener ugc nofollow" target="_blank"> WebDriverManager </a>库。</li></ul><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="58f2" class="lt lu iq lp b gy lv lw l lx ly">System.setProperty(<strong class="lp ir">"webdriver.chrome.driver"</strong>, <strong class="lp ir">"/path/to/driver"</strong>);</span></pre><figure class="lk ll lm ln gt jr gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/8fbcf60db3f883b1f89736dcac22f012.png" data-original-src="https://miro.medium.com/v2/resize:fit:984/format:webp/1*GyI1VvGjTRMfV8m_f1sjZA.png"/></div></figure><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="8153" class="lt lu iq lp b gy lv lw l lx ly">@BeforeClass<br/>    <strong class="lp ir">public static void </strong>setupClass() {<br/>        WebDriverManager.<em class="mk">chromedriver</em>().setup();<br/>    }</span></pre><ul class=""><li id="2bb0" class="ma mb iq kf b kg kh kk kl ko mc ks md kw me la mf mg mh mi bi translated">你需要创建一个实例Chrome浏览器。</li></ul><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="d325" class="lt lu iq lp b gy lv lw l lx ly">ChromeOptions options = new ChromeOptions();</span><span id="1fa4" class="lt lu iq lp b gy lz lw l lx ly">options.addArguments("--headless", "--disable-gpu", "--window-size=1920,1200","--ignore-certificate-errors","<!-- -->--disable-extensions<!-- -->","<!-- -->--no-sandbox<!-- -->","<!-- -->--disable-dev-shm-usage<!-- -->");</span><span id="4147" class="lt lu iq lp b gy lz lw l lx ly">WebDriver driver = new ChromeDriver(options);</span></pre><figure class="lk ll lm ln gt jr gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/8fbcf60db3f883b1f89736dcac22f012.png" data-original-src="https://miro.medium.com/v2/resize:fit:984/format:webp/1*GyI1VvGjTRMfV8m_f1sjZA.png"/></div></figure><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="8814" class="lt lu iq lp b gy lv lw l lx ly"><em class="mk">/**<br/> * The class Chrome. This class describes Chrome browser instance.<br/> */<br/></em><strong class="lp ir">public class </strong>Chrome <strong class="lp ir">implements </strong>WebDriverProvider {<br/>    <em class="mk">/**<br/>     * The constant LOG.<br/>     */<br/>    </em><strong class="lp ir">private static final </strong>Logger <strong class="lp ir"><em class="mk">LOG </em></strong>= Logger.<em class="mk">getLogger</em>(Chrome.<strong class="lp ir">class</strong>.getName());<br/><br/>    <em class="mk">/**<br/>     * The method createDriver.<br/>     */<br/>    </em>@Override<br/>    <strong class="lp ir">public </strong>WebDriver createDriver(<strong class="lp ir">final </strong>DesiredCapabilities capabilities) {<br/>        WebDriverManager.<em class="mk">chromedriver</em>().setup();<br/>        capabilities.setCapability(ChromeOptions.<strong class="lp ir"><em class="mk">CAPABILITY</em></strong>, <em class="mk">getChromeOptions</em>());<br/>        <strong class="lp ir">try </strong>{<br/>            <strong class="lp ir">return new </strong>ChromeDriver(<em class="mk">getChromeOptions</em>());<br/>        } <strong class="lp ir">catch </strong>(Exception ex) {<br/>            <strong class="lp ir">if </strong>(<strong class="lp ir"><em class="mk">LOG</em></strong>.isLoggable(Level.<strong class="lp ir"><em class="mk">INFO</em></strong>)) {<br/>                <strong class="lp ir"><em class="mk">LOG</em></strong>.info(String.<em class="mk">valueOf</em>(ex));<br/>            }<br/>        }<br/>        <strong class="lp ir">return null</strong>;<br/>    }<br/><br/>    <em class="mk">/**<br/>     * Method getChromeOptions.<br/>     *<br/>     * </em><strong class="lp ir"><em class="mk">@return </em></strong><em class="mk">the chrome options.<br/>     */<br/>    </em><strong class="lp ir">public static </strong>ChromeOptions getChromeOptions() {<br/>        <strong class="lp ir">final </strong>ChromeOptions chromeOptions = <strong class="lp ir">new </strong>ChromeOptions();<br/>        chromeOptions.addArguments(<strong class="lp ir">"disable-infobars"</strong>);<br/>        chromeOptions.setExperimentalOption(<strong class="lp ir">"excludeSwitches"</strong>, Collections.<em class="mk">singletonList</em>(<strong class="lp ir">"enable-automation"</strong>));<br/>        chromeOptions.setExperimentalOption(<strong class="lp ir">"useAutomationExtension"</strong>, <strong class="lp ir">false</strong>);<br/><br/>        chromeOptions.addArguments(<strong class="lp ir">"--disable-gpu"</strong>);<br/>        chromeOptions.addArguments(<strong class="lp ir">"--disable-extensions"</strong>);<br/>        chromeOptions.addArguments(<strong class="lp ir">"--no-sandbox"</strong>);<br/>        chromeOptions.addArguments(<strong class="lp ir">"--disable-dev-shm-usage"</strong>);<br/>        chromeOptions.addArguments(<strong class="lp ir">"--headless"</strong>);<br/>        chromeOptions.addArguments(<strong class="lp ir">"--window-size=1580,1280"</strong>);<br/><br/>        <strong class="lp ir">final </strong>HashMap&lt;String, Object&gt; prefs = <strong class="lp ir">new </strong>HashMap();<br/>        prefs.put(<strong class="lp ir">"credentials_enable_service"</strong>, <strong class="lp ir">false</strong>);<br/>        prefs.put(<strong class="lp ir">"profile.password_manager_enabled"</strong>, <strong class="lp ir">false</strong>);<br/>        chromeOptions.setExperimentalOption(<strong class="lp ir">"prefs"</strong>, prefs);<br/><br/>        <strong class="lp ir">return </strong>chromeOptions;<br/>    }<br/>}</span></pre><p id="a6bd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们需要创建一个接口WebDriverProvider:</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="79e1" class="lt lu iq lp b gy lv lw l lx ly"><em class="mk">/**<br/> * The interface Web driver provider.<br/> */<br/></em><strong class="lp ir">public interface </strong>WebDriverProvider {<br/><br/>    <em class="mk">/**<br/>     * Create new {</em><strong class="lp ir"><em class="mk">@link </em></strong><em class="mk">WebDriver} instance.<br/>     *<br/>     * </em><strong class="lp ir"><em class="mk">@param capabilities </em></strong><em class="mk">set of desired capabilities<br/>     *                     as suggested by Selenium framework;<br/>     * </em><strong class="lp ir"><em class="mk">@return </em></strong><em class="mk">new {</em><strong class="lp ir"><em class="mk">@link </em></strong><em class="mk">WebDriver} instance.<br/>     */<br/><br/>    </em>WebDriver createDriver(DesiredCapabilities capabilities);<br/><br/>}</span></pre><p id="aba2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">经过这次重构，代码变得更具可读性和可重用性。例如，您可以用同样的方式为Firefox浏览器创建一个实例:</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="74fc" class="lt lu iq lp b gy lv lw l lx ly"><em class="mk">/**<br/> * The class Firefox.<br/> */<br/></em><strong class="lp ir">public class </strong>Firefox <strong class="lp ir">implements </strong>WebDriverProvider {<br/><br/>    <em class="mk">/**<br/>     * The method for createDriver for Firefox.<br/>     */<br/>    </em>@Override<br/>    <strong class="lp ir">public </strong>WebDriver createDriver(<strong class="lp ir">final </strong>DesiredCapabilities capabilities) {<br/>        WebDriverManager.firefoxdriver().setup();<br/><br/>        <strong class="lp ir">return new </strong>FirefoxDriver(<em class="mk">getFirefoxOptions</em>().merge(capabilities));<br/>    }<br/><br/>    <em class="mk">/**<br/>     * Method getFirefoxOptions.<br/>     *<br/>     * </em><strong class="lp ir"><em class="mk">@return </em></strong><em class="mk">the firefox options<br/>     */<br/>    </em><strong class="lp ir">public static </strong>FirefoxOptions getFirefoxOptions() {<br/>        <strong class="lp ir">final </strong>FirefoxOptions firefoxOptions = <strong class="lp ir">new </strong>FirefoxOptions();<br/>        firefoxOptions.addArguments(<strong class="lp ir">"--disable-web-security"</strong>);<br/>        firefoxOptions.addArguments(<strong class="lp ir">"--allow-running-insecure-content"</strong>);<br/><br/>        <strong class="lp ir">final </strong>FirefoxProfile profile = <strong class="lp ir">new </strong>FirefoxProfile();<br/>        profile.setAcceptUntrustedCertificates(<strong class="lp ir">true</strong>);<br/>        profile.setAssumeUntrustedCertificateIssuer(<strong class="lp ir">false</strong>);<br/>        profile.setPreference(<strong class="lp ir">"pageLoadStrategy"</strong>, <strong class="lp ir">"normal"</strong>);<br/><br/>        firefoxOptions.setCapability(FirefoxDriver.PROFILE, profile);<br/><br/>        <strong class="lp ir">return </strong>firefoxOptions;<br/>    }<br/>}</span></pre><p id="a0c5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在基类中，调用:</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="3363" class="lt lu iq lp b gy lv lw l lx ly"><strong class="lp ir">final </strong>DesiredCapabilities capabilities = <strong class="lp ir">new </strong>DesiredCapabilities().<em class="mk">chrome</em>();<br/><strong class="lp ir">final </strong>Chrome chrome = <strong class="lp ir">new </strong>Chrome();</span><span id="54a2" class="lt lu iq lp b gy lz lw l lx ly">DriverHolder.<em class="mk">setDriverThread</em>(chrome.createDriver(capabilities));</span></pre><p id="48cc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并在DriverHolder中创建一个对驱动线程的调用:</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="5600" class="lt lu iq lp b gy lv lw l lx ly"><em class="mk">/**<br/> * The class Driver holder.<br/> */<br/></em><strong class="lp ir">public final class </strong>DriverHolder {<br/><br/>    <em class="mk">/**<br/>     * The value DRIVER_THREAD.<br/>     */<br/>    </em><strong class="lp ir">private static final </strong>ThreadLocal&lt;WebDriver&gt; <strong class="lp ir"><em class="mk">DRIVER_THREAD </em></strong>= <strong class="lp ir">new </strong>ThreadLocal&lt;&gt;();<br/><br/>    <em class="mk">/**<br/>     * The constructor.<br/>     */<br/>    </em><strong class="lp ir">private </strong>DriverHolder() {<br/>    }<br/><br/>    <em class="mk">/**<br/>     * Gets thread driver.<br/>     *<br/>     * </em><strong class="lp ir"><em class="mk">@return </em></strong><em class="mk">the thread driver<br/>     */<br/>    </em><strong class="lp ir">public static </strong>WebDriver getDriverThread() {<br/>        <strong class="lp ir">return <em class="mk">DRIVER_THREAD</em></strong>.get();<br/>    }<br/><br/>    <em class="mk">/**<br/>     * Sets thread driver.<br/>     *<br/>     * </em><strong class="lp ir"><em class="mk">@param webDriverValue </em></strong><em class="mk">the web driver value<br/>     */<br/>    </em><strong class="lp ir">public static void </strong>setDriverThread(<strong class="lp ir">final </strong>WebDriver webDriverValue) {<br/>        <strong class="lp ir"><em class="mk">DRIVER_THREAD</em></strong>.set(webDriverValue);<br/>    }<br/>}</span></pre><p id="f78b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正如你所看到的，Chrome headless真的很容易使用，它与PhantomJS没有太大的不同，因为我们使用Selenium来运行它。</p></div></div>    
</body>
</html>