<html>
<head>
<title>Combine Complex Pages with Various Logic and UI like LEGO</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">像乐高一样将复杂的页面与各种逻辑和UI结合起来</h1>
<blockquote>原文：<a href="https://itnext.io/combine-complex-pages-with-various-logic-and-ui-like-lego-1552bebc9e0f?source=collection_archive---------9-----------------------#2019-07-29">https://itnext.io/combine-complex-pages-with-various-logic-and-ui-like-lego-1552bebc9e0f?source=collection_archive---------9-----------------------#2019-07-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="bd58" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">移动应用中多种逻辑和身份用户界面的架构</h2></div><blockquote class="ki kj kk"><p id="8fd3" class="kl km kn ko b kp kq ju kr ks kt jx ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">感谢我的同事们，<a class="ae li" href="https://www.linkedin.com/in/wan-ching-shao-b8142667/" rel="noopener ugc nofollow" target="_blank">万青</a>、<a class="ae li" href="https://www.linkedin.com/in/shengsianghuang/" rel="noopener ugc nofollow" target="_blank">黄圣文</a>、<a class="ae li" href="https://www.linkedin.com/in/ansgarlin/" rel="noopener ugc nofollow" target="_blank">安斯加</a>帮助我们重构项目，准备分享文章。他们是优秀架构编程和算法的高级android工程师，因此我们将遗留代码迁移到更好的架构，正如我们在这里分享的那样。</p></blockquote><h1 id="d008" class="lj lk it bd ll lm ln lo lp lq lr ls lt jz lu ka lv kc lw kd lx kf ly kg lz ma bi translated"><strong class="ak">介绍</strong></h1><p id="2511" class="pw-post-body-paragraph kl km it ko b kp mb ju kr ks mc jx ku md me kx ky mf mg lb lc mh mi lf lg lh im bi translated">在电子商务应用程序中，产品项目风格的页面不仅呈现单一产品，还呈现几种不同的特定类型的产品，例如，组合交易、限时特卖产品等。每种类型的产品都有不同的API、数据结构和业务逻辑。但是，它们都是通过相似的UI来显示，以减少用户的学习曲线。本文介绍了如何重构我们的原始架构，将基本的MVVM转换为现代的，以获得开发速度，并进一步显著提高代码质量。</p><p id="ba6f" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku md kw kx ky mf la lb lc mh le lf lg lh im bi translated">之前在购物app中，商品项目页面有三种风格:单品、限时特卖商品、超级限时特卖商品。这三种产品具有相似的UI，但是限时销售产品和超级限时销售产品具有相同的倒计时UI模型。而且，单品和限时特卖品共用同一个API服务器，超限时特卖品使用另一个。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/690293416aabda73acf2c6787b268733.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QsGYarjelpIaHUo-"/></div></div></figure><p id="9af9" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku md kw kx ky mf la lb lc mh le lf lg lh im bi translated">过去，我们使用继承来实现三种类型的页面。深厚的继承关系使得项目很难跟踪和修改代码。而且，业务逻辑写在UI层；这也使得测试编写困难，app不稳定。</p><p id="354b" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku md kw kx ky mf la lb lc mh le lf lg lh im bi translated">去年，产品页面需要支持不同的类型，商店产品，然后我们重新设计了产品页面的架构，以分离UI层、业务逻辑和数据层。它允许我们根据不同的需求组合产品页面，就像乐高一样。</p><h1 id="4b02" class="lj lk it bd ll lm ln lo lp lq lr ls lt jz lu ka lv kc lw kd lx kf ly kg lz ma bi translated"><strong class="ak">建筑</strong></h1><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mv"><img src="../Images/39783629066d9c0383be8c71641733ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YonRj_DHXlSna_6S"/></div></div></figure><h2 id="fbda" class="mw lk it bd ll mx my dn lp mz na dp lt md nb nc lv mf nd ne lx mh nf ng lz nh bi translated"><strong class="ak">视图</strong></h2><p id="e07e" class="pw-post-body-paragraph kl km it ko b kp mb ju kr ks mc jx ku md me kx ky mf mg lb lc mh mi lf lg lh im bi translated">产品项目页面包含几个UI组件，例如图像滑块、规格选择器、促销列表、赠品、附加组件等。这些组件还来自不同的API，这意味着同一UI组件的数据模型会有所不同。每个组件可能显示不同类型产品的不同业务逻辑。</p><p id="9569" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku md kw kx ky mf la lb lc mh le lf lg lh im bi translated">为了处理这个问题，我们给每个UI组件一个UI模型，作为数据模型和UI组件之间的适配器。因此，业务逻辑和数据到UI组件中显示的信息之间的映射可以成功地对UI组件隐藏。至于产品项目页面，只要它观察到UI模型的变化，它只需要将UI模型分派给专用的UI组件。页面不关心任何业务逻辑相关的东西。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi ni"><img src="../Images/8f89ee6ce36201fdbdf8c34704c8634b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pH9o_mm5UyZPPQ1s"/></div></div></figure><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nj"><img src="../Images/880d191355e150add5a4f8e38c185e6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*f7Y1R_ncS3rBZ71a"/></div></div></figure><p id="d38b" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku md kw kx ky mf la lb lc mh le lf lg lh im bi translated">此外，对于这些复杂的UI组件，我们将MVVM进一步缩小。例如，项目页面的图像滑块接受图像和视频的URL数组，它生成每种类型的不同单元格，处理部分diff更新和其他隐式呈现逻辑。在这种情况下，我们用MVP封装这个图像滑块:URL数组是它的logModel，presenter计算diff更新场景，并更新滑块。</p><h2 id="f13b" class="mw lk it bd ll mx my dn lp mz na dp lt md nb nc lv mf nd ne lx mh nf ng lz nh bi translated"><strong class="ak"> UI模型</strong></h2><p id="f0e5" class="pw-post-body-paragraph kl km it ko b kp mb ju kr ks mc jx ku md me kx ky mf mg lb lc mh mi lf lg lh im bi translated">UI模型是根据UI组件的需求设计的，所以它不应该也不需要使用来自远程API的数据结构。UI模型是来自API的数据模型和UI组件之间的适配器。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nk"><img src="../Images/21573c42c2a6e9b568a1b9e069509bc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*t0CzuMQi4OT8wobp"/></div></div></figure><h2 id="4eae" class="mw lk it bd ll mx my dn lp mz na dp lt md nb nc lv mf nd ne lx mh nf ng lz nh bi translated"><strong class="ak"> ViewModel </strong></h2><p id="91f9" class="pw-post-body-paragraph kl km it ko b kp mb ju kr ks mc jx ku md me kx ky mf mg lb lc mh mi lf lg lh im bi translated">ViewModel处理整个业务逻辑，决定使用哪个存储库，处理用户交互事件，并发出不可变的UI模型。ViewModel提供了UI模型的单向通信，因此它没有任何直接更改数据的公共方法，这些公共方法只有委托方法(供视图观察然后呈现)和动作事件接收器(例如，用户单击某个按钮需要调用远程API来执行。)</p><p id="967a" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku md kw kx ky mf la lb lc mh le lf lg lh im bi translated">例如，如果item page将自己分成10个组件，那么ViewModel也有10个observabless，每个observable为单个组件发出一种UI模型。项目页面是一个观察者，当一些状态发生变化时会被通知，并被分派到相应的UI组件。项目页面还定义了用户执行的操作，比如添加到愿望列表、添加到购物车等。，到ViewModel实现的接口中。</p><h2 id="71a7" class="mw lk it bd ll mx my dn lp mz na dp lt md nb nc lv mf nd ne lx mh nf ng lz nh bi translated"><strong class="ak">用例</strong></h2><p id="2e50" class="pw-post-body-paragraph kl km it ko b kp mb ju kr ks mc jx ku md me kx ky mf mg lb lc mh mi lf lg lh im bi translated">ViewModel不应该从别人那里继承；他们是独立的。如果它们之间有相似或相同的逻辑，该逻辑必须从视图模型中提取出来成为这些隔离的类，用例，它们在不同的视图模型中重用。</p><h1 id="64dc" class="lj lk it bd ll lm ln lo lp lq lr ls lt jz lu ka lv kc lw kd lx kf ly kg lz ma bi translated"><strong class="ak">优势</strong></h1><ul class=""><li id="f907" class="nl nm it ko b kp mb ks mc md nn mf no mh np lh nq nr ns nt bi translated">要添加新类型的项目页面，我们只需实现新的ViewModel，它可能会从新的API进行查询，然后将这些新的数据结构转换为相应的UI模型，然后原始项目页面会正确地呈现UI组件。</li><li id="8cf7" class="nl nm it ko b kp nu ks nv md nw mf nx mh ny lh nq nr ns nt bi translated">要添加新的UI组件，我们实现这个UI组件及其配对的UI模型，我们不需要改变任何原始代码或结构，也不会影响以前的项目页面类型。这样就很容易通过这个架构在UI上做A/B测试；我们让ViewModel发送不同的UI模型，然后页面呈现不同的UI。</li><li id="4c2d" class="nl nm it ko b kp nu ks nv md nw mf nx mh ny lh nq nr ns nt bi translated">能够对所有的视图模型，甚至用例进行单元测试。这意味着我们可以实现业务逻辑的转换以及从数据模型到UI模型的转换。</li><li id="4bdf" class="nl nm it ko b kp nu ks nv md nw mf nx mh ny lh nq nr ns nt bi translated">对于这些复杂的UI组件，我们将它们打包到较小的MVVM架构中。这样，因为小MVVM独立于页面生命周期和Android/iOS框架，我们可以通过进一步的单元测试快速测试那些UI组件。</li></ul><h1 id="3c24" class="lj lk it bd ll lm ln lo lp lq lr ls lt jz lu ka lv kc lw kd lx kf ly kg lz ma bi translated">结论</h1><p id="acd7" class="pw-post-body-paragraph kl km it ko b kp mb ju kr ks mc jx ku md me kx ky mf mg lb lc mh mi lf lg lh im bi translated">在这个Q2中，为了响应新的营销活动，购物需要支持新的产品项目类型:组合交易。组合交易是多种产品的组合。UI类似于单个产品，但是后端API是全新的，UI上有一些小的区别。</p><p id="f5f1" class="pw-post-body-paragraph kl km it ko b kp kq ju kr ks kt jx ku md kw kx ky mf la lb lc mh le lf lg lh im bi translated">通过我们设计的架构，我们只需要实现一个新的后端API，并将API响应转换成相应的UI模型，这样UI层就完成了。然后创建一个组合交易的视图模型，并使业务逻辑工作。最后，编写单元测试。一个全新的、可测试的项目页面就完成了，不会影响其他类型的项目页面。</p></div></div>    
</body>
</html>