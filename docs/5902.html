<html>
<head>
<title>How to Serve Optimised Images on Umbraco 9</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Umbraco 9上提供优化的图像</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-serve-optimised-images-on-umbraco-9-f86ec06b6344?source=collection_archive---------2-----------------------#2021-06-25">https://itnext.io/how-to-serve-optimised-images-on-umbraco-9-f86ec06b6344?source=collection_archive---------2-----------------------#2021-06-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/7cd04ebd6623e372a811f3e9be0477bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kThqvW70hw0VtSgyqgUGig.jpeg"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">关于在Umbraco 9上提供优化图像的教程</figcaption></figure><div class=""/><p id="1e4f" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">一个关于在最新版本的Umbraco上提供裁剪好的、搜索引擎友好的̶W̶e̶b̶P̶图片的快速教程</p><p id="8753" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><em class="la">注意:本教程最后一次更新是针对RC版本:<br/>T3 9 . 0 . 0-RC(08/07/21)</em></p><p id="18ec" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在Umbraco的引擎盖下有一套强大的媒体管理工具，允许你提供高性能的图片，这些图片是SEO友好的，裁剪得很好。</p><blockquote class="lb lc ld"><p id="cb12" class="kc kd la ke b kf kg kh ki kj kk kl km le ko kp kq lf ks kt ku lg kw kx ky kz ij bi translated">WEBP支持<a class="ae lh" href="https://github.com/SixLabors/ImageSharp/pull/1552" rel="noopener ugc nofollow" target="_blank">还没有完全准备好</a>六个劳动力。ImageSharp.Web，这是一个遗憾，因为它可以作为插件在8上的imageprocessor.web上获得。</p></blockquote><p id="b3dc" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然而，要达到那个阶段，你确实需要一点未记录的知识来让它工作。</p><h2 id="59a4" class="li lj jf bd lk ll lm dn ln lo lp dp lq kn lr ls lt kr lu lv lw kv lx ly lz ma bi translated">GetCropUrl()简介</h2><p id="d433" class="pw-post-body-paragraph kc kd jf ke b kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz ij bi translated">输入这个方法，它会根据你的需要进行动态调整，目前有5种方法可以用来裁剪你的图片，分为两种主要方法，或者通过传递一个<strong class="ke jg"> IPublishContent </strong>媒体项，或者一个url字符串。我们最感兴趣的是这个:</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="36c4" class="li lj jf ml b gy mp mq l mr ms">GetCropUrl(</span><span id="aef1" class="li lj jf ml b gy mt mq l mr ms">this IPublishedContent mediaItem, // Implied by the referring object</span><span id="a13d" class="li lj jf ml b gy mt mq l mr ms">IImageUrlGenerator imageUrlGenerator,  // Implied</span><span id="9282" class="li lj jf ml b gy mt mq l mr ms">IPublishedValueFallback publishedValueFallback,  // Implied</span><span id="3154" class="li lj jf ml b gy mt mq l mr ms">IPublishedUrlProvider publishedUrlProvider,  // Implied</span><span id="557f" class="li lj jf ml b gy mt mq l mr ms">int? width = null,  // The width to crop to in pixels</span><span id="82cc" class="li lj jf ml b gy mt mq l mr ms">int? height = null,  // The height to crop to in pixels</span><span id="8ed1" class="li lj jf ml b gy mt mq l mr ms">string propertyAlias = "umbracoFile",  // Property alias of the property containing the Json data. The default is fine</span><span id="6ccb" class="li lj jf ml b gy mt mq l mr ms">string cropAlias = null,  // The crop alias specified in umbraco, we take this implicitly from the IPublished Content</span><span id="2b01" class="li lj jf ml b gy mt mq l mr ms">int? quality = null,  // Image compresion quality out of 100</span><span id="297b" class="li lj jf ml b gy mt mq l mr ms">ImageCropMode? imageCropMode = null,  // can be left, or specified explicitly based on the modes in Sharps docs</span><span id="1db3" class="li lj jf ml b gy mt mq l mr ms">ImageCropAnchor? imageCropAnchor = null,  // can be left, or specified explicitly based on the modes in Sharps docs</span><span id="49f8" class="li lj jf ml b gy mt mq l mr ms">bool preferFocalPoint = false,  // Use focal point, to generate an output image using the focal point instead of the predefined crop</span><span id="3ebe" class="li lj jf ml b gy mt mq l mr ms">bool useCropDimensions = false,  // Use crop dimensions to have the output image sized according to the predefined crop sizes, this will override the width and height parameters. So we do not want this</span><span id="2c3d" class="li lj jf ml b gy mt mq l mr ms">bool cacheBuster = true,  // Add a serialized date of the last edit of the item to ensure client cache refresh when updated. We want this</span><span id="7649" class="li lj jf ml b gy mt mq l mr ms">string furtherOptions = null,  // Specify extra features to amend the image with. This is where we specify our preferred image format, e.g.  ̶W̶e̶b̶P̶</span><span id="bcec" class="li lj jf ml b gy mt mq l mr ms">ImageCropRatioMode? ratioMode = null,  //  Use a dimension as a ratio. We'll ignore this as we are specifying the width and height, which will explicitly set the ratio.</span><span id="33c1" class="li lj jf ml b gy mt mq l mr ms">bool upScale = true // If the image is smaller than the dimensions, attempt to upscale it to fill the space. Ideally this wont be needed, but best to keep it so we dont get black borders or too small images</span><span id="75ec" class="li lj jf ml b gy mt mq l mr ms">);</span></pre><p id="af09" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">它给了我们最大的灵活性来改变图像，并允许我们提供图像格式，这是其他变体所缺乏的。</p><p id="2460" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">虽然这看起来令人望而生畏，但它实际上对许多不需要的重载来说是多余的。对于我们正在使用的例子，我们可以只关注我们需要的元素。这为我们提供了以下信息:</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="b263" class="li lj jf ml b gy mp mq l mr ms">@* /Views/Partials/ResponsiveImage.cshtml *@</span><span id="8bb5" class="li lj jf ml b gy mt mq l mr ms">@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage</span><span id="6ce9" class="li lj jf ml b gy mt mq l mr ms">@using Umbraco.Cms.Core.Media</span><span id="31b4" class="li lj jf ml b gy mt mq l mr ms">@using Umbraco.Cms.Core.Models.PublishedContent</span><span id="8619" class="li lj jf ml b gy mt mq l mr ms">@using Umbraco.Cms.Core.Routing</span><span id="fe5b" class="li lj jf ml b gy mt mq l mr ms">@{</span><span id="e18b" class="li lj jf ml b gy mt mq l mr ms">var publishedContent =  @ViewData["publishedContent"] as IPublishedContent ?? null;</span><span id="2ffa" class="li lj jf ml b gy mt mq l mr ms">var lazyLoading =  @ViewData["lazyLoading"] ?? false;</span><span id="b148" class="li lj jf ml b gy mt mq l mr ms">var imageWebP = publishedContent?.GetCropUrl(width: 600, height: 20, quality:80, furtherOptions: "&amp;format=jpg") ?? "";</span><span id="ab38" class="li lj jf ml b gy mt mq l mr ms">}</span></pre><p id="1e87" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后，我们指定宽度、高度和质量，在进一步的选项中，我们设置了“̶W̶e̶b̶P̶'”格式，这是新网站的最佳格式。</p><h2 id="c61c" class="li lj jf bd lk ll lm dn ln lo lp dp lq kn lr ls lt kr lu lv lw kv lx ly lz ma bi translated">用图片包起来</h2><p id="1b96" class="pw-post-body-paragraph kc kd jf ke b kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz ij bi translated">为了使我们的图像更具性能，我们可以指定一个源集，从高性能的webp开始，逐渐退化到其他格式。这对于使用老版本浏览器的网站来说很重要，因为它可以让我们退回到jpeg或png等公认的格式。</p><p id="7101" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为了SEO的缘故，我们包括了<code class="fe mu mv mw ml b">loading=”lazy”</code>标签，用于任何出现在“文件夹下”的东西。即使是空的，也需要指定一个alt。</p><p id="bb86" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们还指定了宽度和高度，这有助于浏览器提前计算布局。</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="4d6d" class="li lj jf ml b gy mp mq l mr ms">&lt;picture&gt;<br/> ̶&lt;̶s̶o̶u̶r̶c̶e̶ ̶s̶r̶c̶s̶e̶t̶=̶"̶@̶i̶m̶a̶g̶e̶W̶e̶b̶P̶"̶ ̶t̶y̶p̶e̶=̶"̶i̶m̶a̶g̶e̶/̶w̶e̶b̶p̶"̶&gt;̶<br/>&lt;source srcset="@imageJpeg" type='image/jpeg'&gt;<br/>&lt;img src="@imageOriginal" width="600" loading="@lazyLoading" alt="" /&gt;<br/>&lt;/picture&gt;</span></pre><h2 id="3948" class="li lj jf bd lk ll lm dn ln lo lp dp lq kn lr ls lt kr lu lv lw kv lx ly lz ma bi translated">把所有的放在一起</h2><figure class="mg mh mi mj gt is"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="ddc8" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们现在可以在任何视图中引用我们的图像生成器部分</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="b319" class="li lj jf ml b gy mp mq l mr ms">@Html.Partial("ResponsiveImage",new ViewDataDictionary(ViewData) { { "publishedContent", Model.TestImage.MediaItem }, { "lazyLoading", true } })</span></pre><p id="e39a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们完了。一个超级简单和表演的形象。接下来，我们需要将宽度和高度输入到视图数据中，不过还需要一天的修正。</p><p id="c685" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke jg">问题:使用带有Crops的媒体进行裁剪</strong></p><p id="302b" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">根据您使用的测试版，您可能需要采取额外的步骤来获得IPublishedContent。如果你的媒体以MediaWithCrops的形式出现，获取它的MediaItem值，这将是IPublishedContent类型，所以你可以把它传入。快乐的日子！</p><pre class="mg mh mi mj gt mk ml mm mn aw mo bi"><span id="1609" class="li lj jf ml b gy mp mq l mr ms">MediaWithCrops cmsImage = Model.Value("cmsImage");</span><span id="fda3" class="li lj jf ml b gy mt mq l mr ms">IPublishedContent image = cmsImage.MediaItem;</span></pre><p id="1a09" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">喜欢你读的吗？给我们鼓掌👏👏👏</p></div></div>    
</body>
</html>