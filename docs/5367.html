<html>
<head>
<title>Create a Highly Available Kubernetes Cluster Using Keepalived and HAproxy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Keepalived和HAproxy创建高度可用的Kubernetes集群</h1>
<blockquote>原文：<a href="https://itnext.io/create-a-highly-available-kubernetes-cluster-using-keepalived-and-haproxy-37769d0a65ba?source=collection_archive---------1-----------------------#2021-02-18">https://itnext.io/create-a-highly-available-kubernetes-cluster-using-keepalived-and-haproxy-37769d0a65ba?source=collection_archive---------1-----------------------#2021-02-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="586f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个高度可用的Kubernetes集群确保您的应用运行时不会出现生产所需的中断。在这方面，有很多方法可供您选择，以实现高可用性。例如，如果您的集群部署在云上(例如Google Cloud和AWS)，您可以直接在这些平台上创建负载平衡器。同时，Keepalived、HAproxy、NGINX也是你实现负载均衡的可能替代方案。</p><p id="7114" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，我将使用Keepalived和HAproxy进行负载平衡，并实现高可用性。这些步骤如下所示:</p><ol class=""><li id="a92d" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">准备主机。</li><li id="4836" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">配置Keepalived和HAproxy。</li><li id="1a7f" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">使用KubeKey建立一个Kubernetes集群。</li></ol><h1 id="cb79" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">集群架构</h1><p id="fbe2" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">在我的集群中，我将设置三个主节点、三个工作节点、两个用于负载平衡的节点和一个虚拟IP地址。本例中的虚拟IP地址也可以称为“浮动IP地址”。这意味着在发生节点故障时，IP地址可以在节点之间传递，从而实现故障转移，从而实现高可用性。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mc"><img src="../Images/ea58b2f32aeefe0b82f8482cae44d8e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PZD9OPYONOXb0yW8.png"/></div></div></figure><p id="5ba2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意，在我的集群中，我不会在任何主节点上安装Keepalived和HAproxy。诚然，您可以这样做，也可以实现高可用性。也就是说，我想尝试一种不同的方式，通过配置两个特定的节点来实现负载平衡(您可以根据需要添加更多这种节点)。只有Keepalived和HAproxy将被安装在这两个节点上，以避免与任何Kubernetes组件和服务的任何潜在冲突。</p><h1 id="cab2" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">主机信息</h1><p id="8aab" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">以下是我的集群中每个节点的详细信息，供您参考:</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mo"><img src="../Images/7b69928e5f849cd3b57c2f498635cc2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fAFW2jo_Lz2IV89oOUmxtg.png"/></div></div></figure><p id="0bd0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于节点、网络和依赖性需求的更多信息，<a class="ae mp" href="https://kubesphere.io/blogs/install-kubernetes-using-kubekey/#node-requirements" rel="noopener ugc nofollow" target="_blank">参见我以前的一篇文章</a>。</p><h1 id="fe79" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">配置负载平衡</h1><p id="a1d9" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated"><a class="ae mp" href="https://www.keepalived.org/" rel="noopener ugc nofollow" target="_blank"> Keepalived </a>提供了VRPP实现，并允许您配置Linux机器进行负载平衡，防止单点故障。<a class="ae mp" href="https://www.haproxy.org/" rel="noopener ugc nofollow" target="_blank"> HAProxy </a>，提供可靠、高性能的负载平衡，与Keepalived完美配合。</p><p id="d568" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我上面说过，我会在<code class="fe mq mr ms mt b">lb1</code>和<code class="fe mq mr ms mt b">lb2</code>上同时安装Keepalived和HAproxy。逻辑非常简单:如果其中一个节点出现故障，虚拟IP地址(即浮动IP地址)将自动与另一个节点相关联，以便集群仍然正常工作，从而实现高可用性。如果您愿意，您可以添加更多的节点，并为此安装Keepalived和HAproxy。</p><p id="74d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行以下命令，首先安装Keepalived和HAproxy。</p><pre class="md me mf mg gt mu mt mv mw aw mx bi"><span id="8b17" class="my la iq mt b gy mz na l nb nc">yum install keepalived haproxy psmisc -y</span></pre><h1 id="4e67" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">HAproxy</h1><ol class=""><li id="a871" class="kl km iq jp b jq lx ju ly jy nd kc ne kg nf kk kq kr ks kt bi translated">HAproxy的配置在两台机器上完全相同，用于负载均衡。运行以下命令来配置HAproxy。</li></ol><p id="26c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mq mr ms mt b">vi /etc/haproxy/haproxy.cfg</code></p><p id="96ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.下面是我的配置供你参考(注意<code class="fe mq mr ms mt b">server</code>字段。注意<code class="fe mq mr ms mt b">6443</code>是<code class="fe mq mr ms mt b">apiserver</code>港):</p><pre class="md me mf mg gt mu mt mv mw aw mx bi"><span id="19f9" class="my la iq mt b gy mz na l nb nc">global<br/>    log /dev/log  local0 warning<br/>    chroot      /var/lib/haproxy<br/>    pidfile     /var/run/haproxy.pid<br/>    maxconn     4000<br/>    user        haproxy<br/>    group       haproxy<br/>    daemon<br/>   <br/>   stats socket /var/lib/haproxy/stats<br/>   <br/>defaults<br/>  log global<br/>  option  httplog<br/>  option  dontlognull<br/>        timeout connect 5000<br/>        timeout client 50000<br/>        timeout server 50000<br/>   <br/>frontend kube-apiserver<br/>  bind *:6443<br/>  mode tcp<br/>  option tcplog<br/>  default_backend kube-apiserver<br/>   <br/>backend kube-apiserver<br/>    mode tcp<br/>    option tcplog<br/>    option tcp-check<br/>    balance roundrobin<br/>    default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100<br/>    server kube-apiserver-1 172.16.0.4:6443 check # Replace the IP address with your own.<br/>    server kube-apiserver-2 172.16.0.5:6443 check # Replace the IP address with your own.<br/>    server kube-apiserver-3 172.16.0.6:6443 check # Replace the IP address with your own.</span></pre><p id="1c49" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.保存文件并运行以下命令来重启HAproxy。</p><p id="d059" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mq mr ms mt b">systemctl restart haproxy</code></p><p id="76b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.使其在重新启动后保持不变:</p><p id="0af3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mq mr ms mt b">systemctl enable haproxy</code></p><p id="bc60" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.确保在另一台机器上也配置了ha proxy(<code class="fe mq mr ms mt b">lb2</code>)。</p><h1 id="771f" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">保持存活</h1><p id="2ba5" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">Keepalived必须安装在两台计算机上，尽管它们的配置略有不同。</p><ol class=""><li id="79ab" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">运行以下命令来配置Keepalived。</li></ol><p id="d406" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mq mr ms mt b">vi /etc/keepalived/keepalived.conf</code></p><p id="eb21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.下面是我的配置(<code class="fe mq mr ms mt b">lb1</code>)供你参考:</p><pre class="md me mf mg gt mu mt mv mw aw mx bi"><span id="fa75" class="my la iq mt b gy mz na l nb nc">global_defs {<br/>  notification_email {<br/>  }<br/>  router_id LVS_DEVEL<br/>  vrrp_skip_check_adv_addr<br/>  vrrp_garp_interval 0<br/>  vrrp_gna_interval 0<br/>}<br/>   <br/>vrrp_script chk_haproxy {<br/>  script "killall -0 haproxy"<br/>  interval 2<br/>  weight 2<br/>}<br/>   <br/>vrrp_instance haproxy-vip {<br/>  state BACKUP<br/>  priority 100<br/>  interface eth0                       # Network card<br/>  virtual_router_id 60<br/>  advert_int 1<br/>  authentication {<br/>    auth_type PASS<br/>    auth_pass 1111<br/>  }<br/>  unicast_src_ip 172.16.0.2      # The IP address of this machine<br/>  unicast_peer {<br/>    172.16.0.3                         # The IP address of peer machines<br/>  }<br/>   <br/>  virtual_ipaddress {<br/>    172.16.0.10/24                  # The VIP address<br/>  }<br/>   <br/>  track_script {<br/>    chk_haproxy<br/>  }<br/>}</span></pre><p id="72e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ng">注</em></p><ul class=""><li id="4d68" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk nh kr ks kt bi translated"><em class="ng">对于</em> <code class="fe mq mr ms mt b"><em class="ng">interface</em></code> <em class="ng">字段，您必须提供自己的网卡信息。你可以在你的机器上运行</em> <code class="fe mq mr ms mt b"><em class="ng">ifconfig</em></code> <em class="ng">来得到这个值。</em></li><li id="b35f" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk nh kr ks kt bi translated"><em class="ng">为</em> <code class="fe mq mr ms mt b"><em class="ng">unicast_src_ip</em></code> <em class="ng">提供的IP地址是您当前机器的IP地址。对于安装了HAproxy和Keepalived进行负载平衡的其他机器，必须在字段</em> <code class="fe mq mr ms mt b"><em class="ng">unicast_peer</em></code> <em class="ng">中输入它们的IP地址。</em></li></ul><p id="6114" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.保存文件并运行以下命令来重新启动Keepalived。</p><p id="3262" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mq mr ms mt b">systemctl restart keepalived</code></p><p id="a151" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.使其在重新启动后保持不变:</p><p id="11c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mq mr ms mt b">systemctl enable haproxy</code></p><p id="5fd0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.确保您也在另一台机器(<code class="fe mq mr ms mt b">lb2</code>)上配置了Keepalived。</p><h1 id="ae9f" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">验证高可用性</h1><p id="94ba" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">在开始创建Kubernetes集群之前，确保您已经测试了高可用性。</p><ol class=""><li id="4fc7" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">在机器<code class="fe mq mr ms mt b">lb1</code>上，运行以下命令:</li></ol><pre class="md me mf mg gt mu mt mv mw aw mx bi"><span id="810d" class="my la iq mt b gy mz na l nb nc">[root@lb1 ~]# ip a s<br/>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br/>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br/>    inet 127.0.0.1/8 scope host lo<br/>       valid_lft forever preferred_lft forever<br/>    inet6 ::1/128 scope host<br/>       valid_lft forever preferred_lft forever<br/>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000<br/>    link/ether 52:54:9e:27:38:c8 brd ff:ff:ff:ff:ff:ff<br/>    inet 172.16.0.2/24 brd 172.16.0.255 scope global noprefixroute dynamic eth0<br/>       valid_lft 73334sec preferred_lft 73334sec<br/>    inet 172.16.0.10/24 scope global secondary eth0 # The VIP address<br/>       valid_lft forever preferred_lft forever<br/>    inet6 fe80::510e:f96:98b2:af40/64 scope link noprefixroute<br/>       valid_lft forever preferred_lft forever</span></pre><p id="6571" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.正如您在上面看到的，虚拟IP地址已成功添加。模拟此节点上的故障:</p><p id="8f0b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mq mr ms mt b">systemctl stop haproxy</code></p><p id="a2e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.再次检查浮动IP地址，您可以看到它在<code class="fe mq mr ms mt b">lb1</code>消失。</p><pre class="md me mf mg gt mu mt mv mw aw mx bi"><span id="8ffc" class="my la iq mt b gy mz na l nb nc">[root@lb1 ~]# ip a s<br/>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br/>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br/>    inet 127.0.0.1/8 scope host lo<br/>       valid_lft forever preferred_lft forever<br/>    inet6 ::1/128 scope host<br/>       valid_lft forever preferred_lft forever<br/>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000<br/>    link/ether 52:54:9e:27:38:c8 brd ff:ff:ff:ff:ff:ff<br/>    inet 172.16.0.2/24 brd 172.16.0.255 scope global noprefixroute dynamic eth0<br/>       valid_lft 72802sec preferred_lft 72802sec<br/>    inet6 fe80::510e:f96:98b2:af40/64 scope link noprefixroute<br/>       valid_lft forever preferred_lft forever</span></pre><p id="d879" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.理论上，如果配置成功，虚拟IP将故障转移到另一台机器(<code class="fe mq mr ms mt b">lb2</code>)。在<code class="fe mq mr ms mt b">lb2</code>上，运行以下命令，这是预期的输出:</p><pre class="md me mf mg gt mu mt mv mw aw mx bi"><span id="0e3e" class="my la iq mt b gy mz na l nb nc">[root@lb2 ~]# ip a s<br/>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br/>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br/>    inet 127.0.0.1/8 scope host lo<br/>       valid_lft forever preferred_lft forever<br/>    inet6 ::1/128 scope host<br/>       valid_lft forever preferred_lft forever<br/>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000<br/>    link/ether 52:54:9e:3f:51:ba brd ff:ff:ff:ff:ff:ff<br/>    inet 172.16.0.3/24 brd 172.16.0.255 scope global noprefixroute dynamic eth0<br/>       valid_lft 72690sec preferred_lft 72690sec<br/>    inet 172.16.0.10/24 scope global secondary eth0   # The VIP address<br/>       valid_lft forever preferred_lft forever<br/>    inet6 fe80::f67c:bd4f:d6d5:1d9b/64 scope link noprefixroute<br/>       valid_lft forever preferred_lft forever</span></pre><p id="6d87" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.正如您在上面看到的，高可用性已成功配置。</p><h1 id="5f93" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">使用KubeKey创建一个Kubernetes集群</h1><p id="03fe" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated"><a class="ae mp" href="https://github.com/kubesphere/kubekey" rel="noopener ugc nofollow" target="_blank"> KubeKey </a>是一个创建Kubernetes集群的高效便捷的工具。如果您不熟悉KubeKey，可以看看我以前的文章，关于使用KubeKey来<a class="ae mp" href="https://kubesphere.io/blogs/install-kubernetes-using-kubekey/" rel="noopener ugc nofollow" target="_blank">创建一个三节点集群</a>并扩展您的集群。</p><ol class=""><li id="9518" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">从其<a class="ae mp" href="https://github.com/kubesphere/kubekey/releases" rel="noopener ugc nofollow" target="_blank"> GitHub发布页面</a>下载KubeKey，或者使用以下命令下载KubeKey版本1.0.1。您只需将KubeKey下载到您的一台机器(如<code class="fe mq mr ms mt b">master1</code>)上，作为<strong class="jp ir">任务栏</strong>进行安装。</li></ol><p id="4e6b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mq mr ms mt b">curl -sfL https://get-kk.kubesphere.io | VERSION=v1.0.1 sh -</code></p><p id="8eef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.上面的命令下载KubeKey并解压文件。你的文件夹现在包含一个名为<code class="fe mq mr ms mt b">kk</code>的文件。使其可执行:</p><p id="5d30" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mq mr ms mt b">chmod +x kk</code></p><p id="9f5a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.创建一个配置文件来指定集群信息。我要安装的Kubernetes版本是<code class="fe mq mr ms mt b">v1.17.9</code>。</p><p id="5d4d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mq mr ms mt b">./kk create config --with-kubernetes v1.17.9</code></p><p id="0488" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.将创建一个默认文件<code class="fe mq mr ms mt b">config-sample.yaml</code>。编辑文件，以下是我的配置供您参考:</p><pre class="md me mf mg gt mu mt mv mw aw mx bi"><span id="fe14" class="my la iq mt b gy mz na l nb nc">apiVersion: kubekey.kubesphere.io/v1alpha1<br/>kind: Cluster<br/>metadata:<br/>  name: sample<br/>spec:<br/>  hosts:<br/>  - {name: master1, address: 172.16.0.4, internalAddress: 172.16.0.4, user: root, password: Testing123}<br/>  - {name: master2, address: 172.16.0.5, internalAddress: 172.16.0.5, user: root, password: Testing123}<br/>  - {name: master3, address: 172.16.0.6, internalAddress: 172.16.0.6, user: root, password: Testing123}<br/>  - {name: worker1, address: 172.16.0.7, internalAddress: 172.16.0.7, user: root, password: Testing123}<br/>  - {name: worker2, address: 172.16.0.8, internalAddress: 172.16.0.8, user: root, password: Testing123}<br/>  - {name: worker3, address: 172.16.0.9, internalAddress: 172.16.0.9, user: root, password: Testing123}<br/>  roleGroups:<br/>    etcd:<br/>    - master1<br/>    - master2<br/>    - master3<br/>    master:<br/>    - master1<br/>    - master2<br/>    - master3<br/>    worker:<br/>    - worker1<br/>    - worker2<br/>    - worker3<br/>  controlPlaneEndpoint:<br/>    domain: lb.kubesphere.local<br/>    address: 172.16.0.10   # The VIP address<br/>    port: 6443<br/>  kubernetes:<br/>    version: v1.17.9<br/>    imageRepo: kubesphere<br/>    clusterName: cluster.local<br/>  network:<br/>    plugin: calico<br/>    kubePodsCIDR: 10.233.64.0/18<br/>    kubeServiceCIDR: 10.233.0.0/18<br/>  registry:<br/>    registryMirrors: []<br/>    insecureRegistries: []<br/>  addons: []</span></pre><p id="3f5a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ng">注</em></p><ul class=""><li id="aa67" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk nh kr ks kt bi translated"><em class="ng">用自己的VIP地址替换</em> <code class="fe mq mr ms mt b"><em class="ng">controlPlaneEndpoint.address</em></code> <em class="ng">的值。</em></li><li id="a11e" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk nh kr ks kt bi translated"><em class="ng">关于这个配置文件中不同参数的更多信息，见</em> <a class="ae mp" href="https://kubesphere.io/blogs/install-kubernetes-using-kubekey/#install-kubernetes" rel="noopener ugc nofollow" target="_blank"> <em class="ng">我之前的一篇博客</em> </a> <em class="ng">。</em></li></ul><p id="0cf4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.保存文件并执行以下命令来创建集群:</p><p id="6ca0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mq mr ms mt b">./kk create cluster -f config-sample.yaml</code></p><p id="8d62" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">6.安装完成后，您可以看到如下输出。</p><p id="7095" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mq mr ms mt b">Congratulations! Installation is successful.</code></p><p id="20f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">7.执行以下命令来检查名称空间的状态。</p><p id="867c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mq mr ms mt b">kubectl get pod --all-namespaces</code></p><pre class="md me mf mg gt mu mt mv mw aw mx bi"><span id="38b9" class="my la iq mt b gy mz na l nb nc">NAMESPACE     NAME                  READY   STATUS    RESTARTS   AGE<br/>kube-system   calico-kube<br/>             -controllers<br/>             -59d85c5c84-l7zp5      1/1     Running   0          42s<br/>kube-system   calico-node-5d6gb     1/1     Running   0          21s<br/>kube-system   calico-node-77bcj     1/1     Running   0          42s<br/>kube-system   calico-node-bdzfp     1/1     Running   0          21s<br/>kube-system   calico-node-ph756     1/1     Running   0          22s<br/>kube-system   calico-node-phz7d     1/1     Running   0          22s<br/>kube-system   calico-node-v7wnf     1/1     Running   0          22s<br/>kube-system   coredns-74d59cc5c6<br/>             -gdkmz                 1/1     Running   0          53s<br/>kube-system   coredns-74d59cc5c6<br/>             -j2lhc                 1/1     Running   0          53s<br/>kube-system   kube-apiserver<br/>             -master1               1/1     Running   0          48s<br/>kube-system   kube-apiserver<br/>             -master2               1/1     Running   0          19s<br/>kube-system   kube-apiserver<br/>             -master3               1/1     Running   0          19s<br/>kube-system   kube-controller<br/>             -manager-master1       1/1     Running   0          48s<br/>kube-system   kube-controller<br/>             -manager-master2       1/1     Running   0          19s<br/>kube-system   kube-controller<br/>             -manager-master3       1/1     Running   0          19s<br/>kube-system   kube-proxy-29sfc      1/1     Running   0          21s<br/>kube-system   kube-proxy-drzsc      1/1     Running   0          22s<br/>kube-system   kube-proxy-lgwhd      1/1     Running   0          22s<br/>kube-system   kube-proxy-npq6t      1/1     Running   0          21s<br/>kube-system   kube-proxy-srlwx      1/1     Running   0          22s<br/>kube-system   kube-proxy-vdtbk      1/1     Running   0          53s<br/>kube-system   kube-scheduler<br/>             -master1               1/1     Running   0          48s<br/>kube-system   kube-scheduler<br/>             -master2               1/1     Running   0          19s<br/>kube-system   kube-scheduler<br/>             -master3               1/1     Running   0          20s<br/>kube-system   nodelocaldns<br/>             -2chnt                 1/1     Running   0          22s<br/>kube-system   nodelocaldns<br/>             -2wszl                 1/1     Running   0          22s<br/>kube-system   nodelocaldns-2xqlc    1/1     Running   0          21s<br/>kube-system   nodelocaldns-92ksq    1/1     Running   0          53s<br/>kube-system   nodelocaldns-cktmd    1/1     Running   0          22s<br/>kube-system   nodelocaldns-skmlq    1/1     Running   0          21s</span></pre><h1 id="f836" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">摘要</h1><p id="6faf" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">创建高度可用的Kubernetes集群不仅仅是业务应用程序无停机运行。它还涉及选择正确的工具，并使用它们以最优雅和高效的方式建立高可用性的集群。为什么不试试Keepalived，HAproxy，KubeKey？也许他们会给你寻找已久的答案。</p><h1 id="0a24" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">参考</h1><p id="e42f" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">KubeKey:一个用于Kubernetes和云本地插件的轻量级安装程序</p><p id="7f92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae mp" href="https://github.com/kubesphere/kubekey" rel="noopener ugc nofollow" target="_blank"> KubeKey GitHub知识库</a></p></div></div>    
</body>
</html>