<html>
<head>
<title>Using Terraform to build a serverless Airflow via Amazon Managed Workflows and automatic DAG sync using GitHub Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform通过Amazon管理的工作流和使用GitHub操作的自动DAG同步构建无服务器气流</h1>
<blockquote>原文：<a href="https://itnext.io/using-terraform-to-build-a-serverless-airflow-via-amazon-managed-workflows-and-automatic-dag-sync-261bf1803874?source=collection_archive---------1-----------------------#2021-07-20">https://itnext.io/using-terraform-to-build-a-serverless-airflow-via-amazon-managed-workflows-and-automatic-dag-sync-261bf1803874?source=collection_archive---------1-----------------------#2021-07-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="0ca7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇文章中，我们将再次通过Terraform建立无服务器基础设施:使用<a class="ae kl" href="https://aws.amazon.com/managed-workflows-for-apache-airflow/" rel="noopener ugc nofollow" target="_blank">亚马逊管理的工作流</a>的<a class="ae kl" href="http://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank">气流</a>部署，加上<a class="ae kl" href="https://docs.github.com/en/actions" rel="noopener ugc nofollow" target="_blank"> GitHub动作</a>自动将DAG代码同步到S3。</p><p id="1e6e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为基线，我们将派生<a class="ae kl" href="https://github.com/claudiobizzotto/" rel="noopener ugc nofollow" target="_blank"> Claudio Bizzotto </a>的伟大知识库<a class="ae kl" href="https://github.com/claudiobizzotto/aws-mwaa-terraform" rel="noopener ugc nofollow" target="_blank">claudiobizzotto/AWS-mwaa-terraform</a>，它已经包含了所有亚马逊管理的工作流terra form代码。我们将在顶部添加S3同步。这将允许我们将GitHub代码部署到Airflow服务中。你可以在这里找到分叉的资源库:<a class="ae kl" href="https://github.com/stelsemeyer/aws-mwaa-terraform" rel="noopener ugc nofollow" target="_blank">stelsemeyer/AWS-mwaa-terraform</a>。</p><h1 id="022b" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">地形设置</h1><p id="6a7b" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">使用Terraform大约需要30分钟来产生可控气流。该设置不在免费层内，每小时将产生大约1美元的成本！</p><p id="577d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将在<code class="fe lp lq lr ls b">terraform.tfvars</code>中使用以下变量:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="364e" class="mb kn iq ls b gy mc md l me mf">region   = "eu-central-1"<br/>profile  = "airflow"  # we use an AWS profile in ~/.aws/credentials<br/>prefix   = "airflow"<br/>vpc_cidr = "10.192.0.0/16"<br/>public_subnet_cidrs = [<br/>  "10.192.10.0/24",<br/>  "10.192.11.0/24"<br/>]<br/>private_subnet_cidrs = [<br/>  "10.192.20.0/24",<br/>  "10.192.21.0/24"<br/>]<br/>mwaa_max_workers = 2</span></pre><p id="0408" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以使用<code class="fe lp lq lr ls b">terraform plan</code>来规划我们的基础设施，如果我们对结果满意，我们可以<code class="fe lp lq lr ls b">terraform apply</code>它:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="2b2a" class="mb kn iq ls b gy mc md l me mf">Plan: 31 to add, 0 to change, 0 to destroy.<br/><br/>Changes to Outputs:<br/>  + access_key_id        = (known after apply)<br/>  + mwaa_environment_arn = (known after apply)<br/>  + mwaa_webserver_url   = (known after apply)<br/>  + private_subnets_ids  = [<br/>      + (known after apply),<br/>      + (known after apply),<br/>    ]<br/>  + public_subnets_ids   = [<br/>      + (known after apply),<br/>      + (known after apply),<br/>    ]<br/>  + region               = "eu-central-1"<br/>  + s3_bucket_id         = (known after apply)<br/>  + s3_bucket_name       = (known after apply)<br/>  + secret_access_key    = (known after apply)<br/>  + vpc_id               = (known after apply)</span></pre><h1 id="74bf" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">Airflow服务器</h1><p id="d2be" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">一旦所有东西都创建好了，我们就可以访问我们的Airflow服务器实例了。为此，我们需要登录AWS控制台。然后，我们可以通过<code class="fe lp lq lr ls b">Amazon Managed Workflows</code>访问它，或者使用来自<code class="fe lp lq lr ls b">terraform output</code>的链接。</p><figure class="lt lu lv lw gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mg"><img src="../Images/9ed2a894a948aa2eb710fe02a16e94a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JEL6OEoo56e5qnbg.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">亚马逊在AWS控制台中管理工作流，包括Airflow UI的URL图片由作者完成。</figcaption></figure><p id="5e0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们应该看到气流UI，包括<code class="fe lp lq lr ls b">dags</code>文件夹中的两个Dag，它们最初是由Terraform上传到S3的。</p><figure class="lt lu lv lw gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi ms"><img src="../Images/e44bd90a68ef3245a9854d2ec5b846d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*opOdwDM7ZR6w0QDI.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">带有激活教程DAG的气流用户界面—图像由作者完成。</figcaption></figure><p id="9326" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们单击DAG，我们可以看到图形视图。一旦我们通过轻触开关将DAG设置为active，任务将开始运行以跟上。</p><figure class="lt lu lv lw gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mt"><img src="../Images/5cc957d95e3d0e08247baa1b6949c6a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qJ7yRuYvT8WCnTE8.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">单个DAG视图—由作者制作的图像。</figcaption></figure><h1 id="69b0" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">使用GitHub操作进行DAG同步</h1><p id="8851" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">要设置GitHub动作来自动将包含实际DAG代码的<code class="fe lp lq lr ls b">dags</code>文件夹同步到S3，我们可以使用<code class="fe lp lq lr ls b">terraform output</code>中的<code class="fe lp lq lr ls b">access_key_id</code>、<code class="fe lp lq lr ls b">secret_access_key</code>、<code class="fe lp lq lr ls b">region</code>和<code class="fe lp lq lr ls b">s3_bucket_name</code>。我们将这些值作为<code class="fe lp lq lr ls b">Secrets</code>添加到存储库中:</p><p id="a246" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">工作流yaml文件<code class="fe lp lq lr ls b">.github/workflows/sync.yml</code>定义了我们想要执行的动作:一旦我们合并到<code class="fe lp lq lr ls b">main</code>分支，我们就使用<a class="ae kl" href="https://github.com/jakejarvis/s3-sync-action" rel="noopener ugc nofollow" target="_blank">Jake Jarvis/S3-sync-action</a>将文件夹<code class="fe lp lq lr ls b">dags</code>同步到S3。我们可以定制触发器，只对标签或类似的东西执行操作。</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="8908" class="mb kn iq ls b gy mc md l me mf">name: Sync dags</span><span id="cb20" class="mb kn iq ls b gy mu md l me mf">on:<br/>  push:<br/>    branches:<br/>    - main</span><span id="71ee" class="mb kn iq ls b gy mu md l me mf">jobs:<br/>  deploy:<br/>    runs-on: ubuntu-latest<br/>    steps:<br/>    - uses: actions/checkout@master<br/>    - uses: jakejarvis/s3-sync-action@master<br/>      with:<br/>        args: --follow-symlinks --delete<br/>      env:<br/>        AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}<br/>        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}<br/>        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}<br/>        AWS_REGION: ${{ secrets.AWS_REGION }}<br/>        SOURCE_DIR: 'dags'<br/>        DEST_DIR: 'dags'</span></pre><p id="cb84" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过GitHub上的<code class="fe lp lq lr ls b">Workflow</code>选项卡，我们可以查看工作流程状态。每当我们合并到<code class="fe lp lq lr ls b">main</code>时，文件将被同步到S3，我们应该能够在几秒钟内在我们的Airflow UI中看到更新的Dag(您可能需要点击刷新按钮)。</p><figure class="lt lu lv lw gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mv"><img src="../Images/44362a050e533168cf66b2554d51882d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cNel5R3CVgHnYuS4.png"/></div></div></figure><h1 id="0e42" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">破坏</h1><p id="076d" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">要销毁基础架构，您需要首先删除存储桶中的所有文件:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="125b" class="mb kn iq ls b gy mc md l me mf"># BUCKET_NAME = $(terraform output -json | jq -r .s3_bucket_name.value)<br/># aws s3 rm s3://${BUCKET_NAME} --recursive</span></pre><p id="ced9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我们可以通过<code class="fe lp lq lr ls b">terraform destroy</code>摧毁所有的基础设施，这也需要大约20-30分钟。</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="9ae4" class="mb kn iq ls b gy mc md l me mf"># terraform destroy</span></pre><h1 id="eba2" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">结论</h1><p id="220e" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">通常，当使用无服务器基础设施时，我们需要在维护、控制和成本之间进行折衷。<a class="ae kl" href="https://towardsdatascience.com/managed-apache-airflow-on-aws-new-aws-service-for-data-pipelines-91908ee9e5fc" rel="noopener" target="_blank">这篇文章</a>很好地讨论了亚马逊管理的工作流的优点和缺点，我们可以总结如下:</p><h2 id="5abf" class="mb kn iq bd ko mw mx dn ks my mz dp kw jy na nb la kc nc nd le kg ne nf li ng bi translated">优势</h2><ul class=""><li id="2da4" class="nh ni iq jp b jq lk ju ll jy nj kc nk kg nl kk nm nn no np bi translated">易于与其他AWS服务集成(如Redshift、EMR、SageMaker)</li><li id="dbd1" class="nh ni iq jp b jq nq ju nr jy ns kc nt kg nu kk nm nn no np bi translated">自动扩展，节省时间和成本</li><li id="5067" class="nh ni iq jp b jq nq ju nr jy ns kc nt kg nu kk nm nn no np bi translated">使用CloudWatch进行监控和记录</li><li id="506e" class="nh ni iq jp b jq nq ju nr jy ns kc nt kg nu kk nm nn no np bi translated">AWS管理安全性，包括VPC</li><li id="0279" class="nh ni iq jp b jq nq ju nr jy ns kc nt kg nu kk nm nn no np bi translated">通过Fargate的容器化工作流</li></ul><h2 id="d465" class="mb kn iq bd ko mw mx dn ks my mz dp kw jy na nb la kc nc nd le kg ne nf li ng bi translated">不足之处</h2><ul class=""><li id="74ec" class="nh ni iq jp b jq lk ju ll jy nj kc nk kg nl kk nm nn no np bi translated">我们不能ssh到我们的气流实例或访问气流数据库本身</li><li id="450b" class="nh ni iq jp b jq nq ju nr jy ns kc nt kg nu kk nm nn no np bi translated">依靠AWS提供的气流版本</li><li id="472b" class="nh ni iq jp b jq nq ju nr jy ns kc nt kg nu kk nm nn no np bi translated">仅限于云提供商</li></ul><p id="3884" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">总而言之，在我们自己的硬件或云实例上部署Airflow比MWAA设置更复杂，但它允许我们更容易地定制，使用<code class="fe lp lq lr ls b">KubernetesPodOperator</code>在Kubernetes上运行任务等等。对于单个用例，我们必须权衡利弊。如果您想先测试Airflow，使用受管版本可能是个好主意，因为一旦您想从部署中迁移，您可以轻松地将Dag移动到您自己的部署中。</p></div><div class="ab cl nv nw hu nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="ij ik il im in"><p id="a10e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="oc">最初发表于</em><a class="ae kl" href="https://blog.telsemeyer.com/2021/07/20/using-terraform-to-build-a-serverless-airflow-via-amazon-managed-workflows-and-automatic-dag-sync-using-github-actions/" rel="noopener ugc nofollow" target="_blank"><em class="oc">【https://blog.telsemeyer.com】</em></a><em class="oc">。</em></p></div></div>    
</body>
</html>