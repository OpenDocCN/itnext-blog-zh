<html>
<head>
<title>Sub-queries in Sequelize with Squel</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Squel序列中子查询</h1>
<blockquote>原文：<a href="https://itnext.io/sub-queries-in-sequelize-with-squel-edad3bdb64f9?source=collection_archive---------2-----------------------#2018-05-27">https://itnext.io/sub-queries-in-sequelize-with-squel-edad3bdb64f9?source=collection_archive---------2-----------------------#2018-05-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c02bb05b2339aee83370807f70732c10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ifmfMlQrgmgq1gU-gog_Xg.png"/></div></div></figure><p id="9c9e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你想在<a class="ae kw" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank">节点</a>中处理一个SQL数据库，你可能想使用<a class="ae kw" href="http://docs.sequelizejs.com/" rel="noopener ugc nofollow" target="_blank">序列</a>。</p><p id="06de" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是一个很好的ORM，它有一个基于promise的API，可以很容易地:</p><ul class=""><li id="cd67" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">定义模型</li><li id="df0c" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">定义这些模型之间的关系</li><li id="eb51" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">在访问实例时检索这些关系。</li></ul><p id="dfd8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是我发现很难处理实例内部的<code class="fe ll lm ln lo b">COUNT</code>和<code class="fe ll lm ln lo b">SUM</code>函数，甚至在<a class="ae kw" href="https://github.com/sequelize/sequelize/issues/222" rel="noopener ugc nofollow" target="_blank">读取问题之后的<br/>，试图找到顺序化方法</a>却没有成功。没有一样东西对我有用😭</p><p id="9c90" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这就是我如何用SQL查询生成器<a class="ae kw" href="https://hiddentao.com/squel/" rel="noopener ugc nofollow" target="_blank"> squel </a>解决这个问题的故事</p><ul class=""><li id="8c5d" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">sequelize API的一些知识将真正有助于理解本文🤓</li><li id="afd0" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">服务器使用的框架是<a class="ae kw" href="https://koajs.com/" rel="noopener ugc nofollow" target="_blank"> Koa </a></li><li id="de0b" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">我已经整理了一个包含工作示例的小知识库</li></ul><h1 id="d067" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">数据库</h1><h2 id="ba58" class="mn lq iq bd lr mo mp dn lv mq mr dp lz kj ms mt md kn mu mv mh kr mw mx ml my bi translated">模型</h2><p id="6de7" class="pw-post-body-paragraph jy jz iq ka b kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr nd kt ku kv ij bi translated">我们将有两种型号:</p><ul class=""><li id="e4ce" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">篮子</li><li id="6b00" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">项目</li></ul><p id="c30c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">一个篮子会有很多物品</strong></p><p id="c828" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以让我们用序列定义我们的模型:</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><h2 id="229f" class="mn lq iq bd lr mo mp dn lv mq mr dp lz kj ms mt md kn mu mv mh kr mw mx ml my bi translated">例子</h2><p id="785c" class="pw-post-body-paragraph jy jz iq ka b kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr nd kt ku kv ij bi translated">我们将需要<a class="ae kw" href="https://github.com/Hiswe/sequelize-example/blob/master/index.js#L125-L165" rel="noopener ugc nofollow" target="_blank">来定义我们的实例</a>:</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><h1 id="ce9d" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">预期结果</h1><ul class=""><li id="7c90" class="kx ky iq ka b kb mz kf na kj nk kn nl kr nm kv lc ld le lf bi translated">篮子里的物品数量</li><li id="ab34" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">篮子的总价格</li></ul><p id="ead4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">大概是这样的:</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><h1 id="4e26" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">做这个服务器端</h1><p id="8c87" class="pw-post-body-paragraph jy jz iq ka b kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr nd kt ku kv ij bi translated">这应该很简单:</p><ul class=""><li id="8279" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">用他的物品询问篮子</li><li id="3bc8" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">处理一切以获得正确的信息</li></ul><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="755b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以在演示中找到<a class="ae kw" href="https://github.com/Hiswe/sequelize-example/blob/master/router.js#L20-L36" rel="noopener ugc nofollow" target="_blank">的等价代码。</a></p><p id="3ce2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但这是一项可以在数据库上完成的工作，对吗？所以最好在那里做。</p><h1 id="a416" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">SQL子查询</h1><p id="18ac" class="pw-post-body-paragraph jy jz iq ka b kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr nd kt ku kv ij bi translated">为了在我们的数据库中做到这一点，我们需要Sequelize在查询中生成如下内容:</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="3a88" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以手动编写，但是我们身边没有NodeJS，也没有完整的生态系统。</p><p id="cfd0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以让我们使用squel来做这件事:用一种更JS的方式写SQL。</p><h1 id="f122" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">Squel与Sequelize的接口</h1><p id="ef08" class="pw-post-body-paragraph jy jz iq ka b kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr nd kt ku kv ij bi translated">根据<a class="ae kw" href="http://docs.sequelizejs.com/manual/tutorial/querying.html#attributes" rel="noopener ugc nofollow" target="_blank"> Sequelize文档</a>这是我们定义自定义属性的方式:</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="f4b6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里的主要目标是为计算的属性生成正确的查询</p><h1 id="5e4e" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">Squel配置和注意事项</h1><ul class=""><li id="4506" class="kx ky iq ka b kb mz kf na kj nk kn nl kr nm kv lc ld le lf bi translated">我们必须配置squel来支持postgres数据库</li><li id="d750" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">即使有很多的<a class="ae kw" href="https://hiddentao.com/squel/api.html#cls_defaultquerybuilderoptions" rel="noopener ugc nofollow" target="_blank">转义选项</a> <strong class="ka ir">我也没有找到一个涵盖所有用例的</strong> <br/> Postgres会因<code class="fe ll lm ln lo b">WHERE (item.basketId = basket.id)</code> <br/>而失败→我们应该这样格式化<code class="fe ll lm ln lo b">WHERE ("item"."basketId" = "basket"."id")</code></li><li id="90d6" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">用括号将我们的结果括起来，因为Sequelize不会为我们这样做<br/> → <code class="fe ll lm ln lo b">(…our query) AS "itemsCount"</code></li></ul><p id="32f3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">只要有几个帮手，所有这些都可以很容易地完成:</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="8f5d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">稍微有些不同的是，这是演示中的<a class="ae kw" href="https://github.com/Hiswe/sequelize-example/blob/master/router.js#L42-L52" rel="noopener ugc nofollow" target="_blank">等价代码。</a></p><p id="6ced" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我用的是<a class="ae kw" href="http://docs.sequelizejs.com/class/lib/sequelize.js~Sequelize.html#static-method-literal" rel="noopener ugc nofollow" target="_blank"> Sequelize.static() </a>但是我不确定有没有必要。它只是防止Sequelize对查询字符串进行转义。</p><h1 id="c03c" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">把东西放在一起</h1><p id="6d09" class="pw-post-body-paragraph jy jz iq ka b kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr nd kt ku kv ij bi translated">这将是我们的最终代码:</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="17ed" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以及演示中的<a class="ae kw" href="https://github.com/Hiswe/sequelize-example/blob/master/router.js#L54-L85" rel="noopener ugc nofollow" target="_blank">相关部分</a></p><h1 id="9c10" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">进一步说明</h1><h2 id="bcd4" class="mn lq iq bd lr mo mp dn lv mq mr dp lz kj ms mt md kn mu mv mh kr mw mx ml my bi translated">查找我们的WHERE查询</h2><p id="f2f7" class="pw-post-body-paragraph jy jz iq ka b kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr nd kt ku kv ij bi translated">我不是SQL专家，那么如何编写我们的<code class="fe ll lm ln lo b">WHERE</code>查询？</p><ul class=""><li id="45d9" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">配置Sequelize以在控制台中输出SQL查询</li><li id="1034" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">让Sequelize和他的关系取一个模型</li><li id="339b" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">看看你的日志</li><li id="c3f1" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">复制/粘贴有趣的部分</li></ul><h2 id="b591" class="mn lq iq bd lr mo mp dn lv mq mr dp lz kj ms mt md kn mu mv mh kr mw mx ml my bi translated">构建子查询生成器</h2><p id="fa23" class="pw-post-body-paragraph jy jz iq ka b kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr nd kt ku kv ij bi translated">编写所有Squel代码可能很麻烦。但是我们可以创建一个函数来完成这个任务:</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="f107" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">演示中的<a class="ae kw" href="https://github.com/Hiswe/sequelize-example/blob/master/router.js#L87-L119" rel="noopener ugc nofollow" target="_blank">相关代码</a></p><h1 id="b0c1" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">结论</h1><p id="59f8" class="pw-post-body-paragraph jy jz iq ka b kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr nd kt ku kv ij bi translated">Sequelize是一段非常好的代码。在95%的时间里，它都会像预期的那样工作。对于另外的5 %,你可以编写原始的SQL查询🤓或者用squel来帮你做🤪</p><p id="65c9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过这样做，我们消除了服务器中处理Sequelize结果的负担，这是一个胜利😎</p></div><div class="ab cl nn no hu np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="ij ik il im in"><p id="be8b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nu">原载于</em><a class="ae kw" href="https://hiswe.github.io/2018/09-sequelize-subqueries-with-squel/" rel="noopener ugc nofollow" target="_blank"><em class="nu">hiswe . github . io</em></a><em class="nu">。</em></p></div></div>    
</body>
</html>