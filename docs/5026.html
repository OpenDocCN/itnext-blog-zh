<html>
<head>
<title>Lessons learned from managing a Kubernetes cluster for side projects</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从为附带项目管理Kubernetes集群中获得的经验教训</h1>
<blockquote>原文：<a href="https://itnext.io/lessons-learned-from-managing-a-kubernetes-cluster-for-side-projects-780fbbacf36c?source=collection_archive---------0-----------------------#2020-11-20">https://itnext.io/lessons-learned-from-managing-a-kubernetes-cluster-for-side-projects-780fbbacf36c?source=collection_archive---------0-----------------------#2020-11-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="5ebb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">截至2020年11月，我已经花了将近一年的时间管理一个非常小的Kubernetes集群来部署一些东西:</p><ul class=""><li id="595b" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn kt ku kv kw bi translated">我的网址在<a class="ae kx" href="https://armand1m.dev" rel="noopener ugc nofollow" target="_blank"> https://armand1m.dev </a></li><li id="aa41" class="ko kp it js b jt ky jx kz kb la kf lb kj lc kn kt ku kv kw bi translated"><a class="ae kx" href="https://go.d1m.dev/source" rel="noopener ugc nofollow" target="_blank">我自己的网址缩写</a>在<a class="ae kx" href="https://go.d1m.dev" rel="noopener ugc nofollow" target="_blank"> https://go.d1m.dev </a></li><li id="1245" class="ko kp it js b jt ky jx kz kb la kf lb kj lc kn kt ku kv kw bi translated">电报和懒人机器人。</li><li id="6280" class="ko kp it js b jt ky jx kz kb la kf lb kj lc kn kt ku kv kw bi translated"><a class="ae kx" href="https://hub.docker.com/r/vimagick/murmur" rel="noopener ugc nofollow" target="_blank">咕哝服务器</a></li><li id="a8d1" class="ko kp it js b jt ky jx kz kb la kf lb kj lc kn kt ku kv kw bi translated"><a class="ae kx" href="http://spinnaker.io/" rel="noopener ugc nofollow" target="_blank">三角帆</a></li><li id="457b" class="ko kp it js b jt ky jx kz kb la kf lb kj lc kn kt ku kv kw bi translated"><a class="ae kx" href="http://drone.io/" rel="noopener ugc nofollow" target="_blank">无人机CI </a></li><li id="cc15" class="ko kp it js b jt ky jx kz kb la kf lb kj lc kn kt ku kv kw bi translated">我不时做的其他实验</li></ul><p id="e355" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">简而言之:我使用Kubernetes来部署我可能想要部署的任何东西。它就像是我的个人游乐场，让互联网上的事物变得鲜活起来。</p><p id="46fa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在做这些事情的时候，我最终学到了很多关于Kubernetes、生态系统以及它如何与云提供商集成的知识。</p><p id="ce9c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我不是SRE、系统管理员或DevOps工程师。我只是一个喜欢构建和管理分布式应用程序的软件工程师。</p><p id="6e7d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这篇文章中，我的目的是介绍我在这一年中与GKE一起管理我自己的Kubernetes集群时学到的一些经验。</p><p id="04b9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">免责声明:</strong>如果你还不习惯Kubernetes，你可能会觉得有点可怕。</p><h2 id="1c83" class="ld le it bd lf lg lh dn li lj lk dp ll kb lm ln lo kf lp lq lr kj ls lt lu lv bi translated">习惯是需要时间的。</h2><p id="1e48" class="pw-post-body-paragraph jq jr it js b jt lw jv jw jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn im bi translated">Kubernetes是相当快节奏和复杂的。当我开始做这个的时候，Kubernetes是1.15版，当前的最新版本是1.19版。像<code class="fe mb mc md me b">CrashLoopBackOff</code>这样的错误在开始时会让你头晕目眩。</p><p id="2553" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您与可用的API交互得越多，使用Kubernetes对象来部署和管理不同类型的应用程序的次数越多，这种差距就越小，并且越熟悉。</p><h2 id="373d" class="ld le it bd lf lg lh dn li lj lk dp ll kb lm ln lo kf lp lq lr kj ls lt lu lv bi translated">Terraform是一个好朋友</h2><p id="4823" class="pw-post-body-paragraph jq jr it js b jt lw jv jw jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn im bi translated">Terraform让我能够在集群中规划和应用变化。添加新的节点池，在某个时间段内打开/关闭节点池中的可抢占类型，将节点更新到更新版本的<code class="fe mb mc md me b">kube-proxy</code>等等。</p><p id="f22b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是，我不通过Terraform与集群对象进行交互。我将它的使用限制为管理集群及其节点，仅此而已。</p><h2 id="3f93" class="ld le it bd lf lg lh dn li lj lk dp ll kb lm ln lo kf lp lq lr kj ls lt lu lv bi translated">GKE帮助你，但是你必须习惯它。</h2><p id="5f88" class="pw-post-body-paragraph jq jr it js b jt lw jv jw jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn im bi translated">GKE管理着部署和管理集群的大部分艰难工作。自动扩展节点，确保<code class="fe mb mc md me b">kube-proxy</code>被适当配置，节点的健康检查是它的一些好的部分。</p><p id="3b1c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你习惯于管理你的节点，<code class="fe mb mc md me b">ssh</code>进入它们或者使用类似<code class="fe mb mc md me b">salt</code>的东西，你可能也会喜欢这个。</p><p id="3a48" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您习惯于只管理一个节点，以前从未管理过集群，您可能需要一段时间来适应这种情况。</p><h2 id="1236" class="ld le it bd lf lg lh dn li lj lk dp ll kb lm ln lo kf lp lq lr kj ls lt lu lv bi translated">使用云提供商的负载平衡器可能会很昂贵。</h2><p id="9d94" class="pw-post-body-paragraph jq jr it js b jt lw jv jw jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn im bi translated">在GCP，负载平衡器的成本可能相当高。部署一项<code class="fe mb mc md me b">LoadBalancer</code>服务可能会花费你每天0.55欧元。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/8050ba630c1ea9bb207955160c0a2407.png" data-original-src="https://miro.medium.com/v2/resize:fit:1106/format:webp/1*i6kZAsEkwIlJa-a4Uv7RZQ.png"/></div></figure><p id="12dc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">所以我做的是:</p><ul class=""><li id="a3be" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn kt ku kv kw bi translated">创建一个节点池，其中包含一个e2-small类型的节点和一个taint，以便只执行入口工作负载</li><li id="3427" class="ko kp it js b jt ky jx kz kb la kf lb kj lc kn kt ku kv kw bi translated">设置<code class="fe mb mc md me b">kubeip</code>总是为入口节点分配一个静态IP地址，以防我需要重新创建它(或者使用一个可抢占的地址)</li><li id="64c3" class="ko kp it js b jt ky jx kz kb la kf lb kj lc kn kt ku kv kw bi translated">使用适当的节点关联和配置设置我的入口网关部署，以使用主机网络充当我的负载平衡器。</li></ul><p id="d958" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">完成此操作后，您会在账单图表中看到相当大的变化:</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi mn"><img src="../Images/87655395b55e505a77493ec7adb6744c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PQiifVjVGaAs619Lj9Q9gA.png"/></div></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">这让我成为一个快乐的人</figcaption></figure><h2 id="35dd" class="ld le it bd lf lg lh dn li lj lk dp ll kb lm ln lo kf lp lq lr kj ls lt lu lv bi translated">Kubernetes不仅仅是管理容器。</h2><p id="25f7" class="pw-post-body-paragraph jq jr it js b jt lw jv jw jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn im bi translated">我曾经把Kubernetes看作是Docker Compose之类的东西的演化:一个分布式容器编排器。但是有了Kubernetes对象和Operator模式，Kubernetes可以管理的远不止这些。</p><p id="7488" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">列举一些我在我的集群中完成的事情:</p><ul class=""><li id="baf0" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn kt ku kv kw bi translated">部署<code class="fe mb mc md me b">kubeip</code>为特定节点自动分配静态IP地址。</li><li id="855d" class="ko kp it js b jt ky jx kz kb la kf lb kj lc kn kt ku kv kw bi translated">供应和更新让我们通过<code class="fe mb mc md me b">Certificate</code>和<code class="fe mb mc md me b">ClusterIssuer</code>对象用<code class="fe mb mc md me b">cert-manager</code>自动加密发布的SSL证书</li><li id="9a3a" class="ko kp it js b jt ky jx kz kb la kf lb kj lc kn kt ku kv kw bi translated">通过<code class="fe mb mc md me b">PersistentVolumeClaim</code>对象在GCP创建和删除持久磁盘</li><li id="3b39" class="ko kp it js b jt ky jx kz kb la kf lb kj lc kn kt ku kv kw bi translated">使用<code class="fe mb mc md me b">VolumeSnapshot</code>对象从<code class="fe mb mc md me b">PersistentVolumeClaim</code>对象在GCP创建磁盘快照</li><li id="6b7f" class="ko kp it js b jt ky jx kz kb la kf lb kj lc kn kt ku kv kw bi translated">使用<code class="fe mb mc md me b">snapscheduler</code>自动创建和终止<code class="fe mb mc md me b">VolumeSnapshot</code>对象</li><li id="84f4" class="ko kp it js b jt ky jx kz kb la kf lb kj lc kn kt ku kv kw bi translated">使用<code class="fe mb mc md me b">external-dns</code>实现云中DNS管理的自动化</li></ul><p id="cd87" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我总是发现上面的很多东西非常手动且容易出错，Kubernetes帮助我找到了将它们描述为我的应用程序的合理默认值的方法。</p><p id="d9c0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如今，我把Kubernetes视为一个国家调解人。我可以告诉集群我的工作负载、机密、外部服务的理想状态是什么，Kubernetes将尽力使当前状态与之匹配。它会告诉你是否出了问题，这样你就可以采取行动。</p><h2 id="6568" class="ld le it bd lf lg lh dn li lj lk dp ll kb lm ln lo kf lp lq lr kj ls lt lu lv bi translated">当事情看起来不可思议时，检查集群事件</h2><p id="c9f3" class="pw-post-body-paragraph jq jr it js b jt lw jv jw jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn im bi translated"><code class="fe mb mc md me b">kubectl get events</code>将向您显示群中的最新活动。这个命令对我进行故障排除和理解在我的集群中发生的事情非常重要。</p><p id="74e2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这些对象的大多数协调器会将事件记录到集群中，您可以在这里看到其中的大多数。</p><h2 id="63c7" class="ld le it bd lf lg lh dn li lj lk dp ll kb lm ln lo kf lp lq lr kj ls lt lu lv bi translated">可抢占的实例更便宜，但是有龙</h2><p id="5d85" class="pw-post-body-paragraph jq jr it js b jt lw jv jw jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn im bi translated">可抢占实例可以比标准实例便宜3.25倍。你肯定想利用这些，因为你不仅想让自己快乐，还想让你的口袋快乐。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi mw"><img src="../Images/552c8fc8221c4983c756ff50b1ad00f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vRHJ03S9aNMYTdJr1ezKrQ.png"/></div></div></figure><p id="e6dd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是，默认情况下，在重新创建节点的过程中会有一些停机时间。在部署一些应用程序时，如果他们没有准备好处理这种行为，你可能会遇到麻烦。如果您的应用程序必须挂载一个磁盘，那么您需要考虑这一点以及重新创建节点和初始化工作负载的部分开始时间。</p><p id="d3db" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">出于稳定性的考虑，有时你会倾向于使用标准的机器。</p><h2 id="c26b" class="ld le it bd lf lg lh dn li lj lk dp ll kb lm ln lo kf lp lq lr kj ls lt lu lv bi translated">镜头太神奇了</h2><p id="5698" class="pw-post-body-paragraph jq jr it js b jt lw jv jw jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn im bi translated">我已经用了<a class="ae kx" href="https://k8slens.dev/" rel="noopener ugc nofollow" target="_blank">镜头</a>有一段时间了，非常棒。它与<code class="fe mb mc md me b">kubectl</code>、<code class="fe mb mc md me b">helm</code>和您所有的本地配置完美集成。</p><p id="01e7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您在集群中正确配置了Prometheus和metrics server，并且对集群中部署和发生的一切都有一个令人惊叹的可视化，那么您就可以很好地监控您的工作负载。</p><p id="5f4c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我喜欢CLI，我相信<code class="fe mb mc md me b">kubectl</code>是令人惊奇的，但是Lens提供的UI的便利性在诸如Kubernetes集群这样的复杂环境中是惊人的。</p><h2 id="3958" class="ld le it bd lf lg lh dn li lj lk dp ll kb lm ln lo kf lp lq lr kj ls lt lu lv bi translated">Kubernetes使本地与服务的交互更加容易</h2><p id="d4ab" class="pw-post-body-paragraph jq jr it js b jt lw jv jw jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn im bi translated"><code class="fe mb mc md me b">kubectl</code>提供对运行服务时的常见任务非常有用的实用程序。</p><p id="db43" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当您想在本地访问集群中的服务而不必公开它们时,<code class="fe mb mc md me b">kubectl port-forward</code>非常有用。我经常用它来:</p><ul class=""><li id="0f6d" class="ko kp it js b jt ju jx jy kb kq kf kr kj ks kn kt ku kv kw bi translated">访问我用来管理集群的内部服务，而不必通过我的入口暴露它们(如Grafana、Jaeger、Kiali等)</li><li id="2504" class="ko kp it js b jt ky jx kz kb la kf lb kj lc kn kt ku kv kw bi translated">从我的本地机器上舒适地运行PostgreSQL实例或者将转储恢复到PostgreSQL实例。</li></ul><p id="69fe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe mb mc md me b">kubectl cp</code>非常有助于在本地文件系统和已部署工作负载的文件系统之间复制文件。我经常使用它来访问工作负载的文件系统，以检查一些文件，甚至对挂载的持久磁盘进行一些更改。</p><p id="2acd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe mb mc md me b">kubectl exec</code>是我最喜欢的一个，因为它可以让我创建一个几乎像ssh连接一样的交互式shell，下面是一个例子:</p><p id="8d62" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe mb mc md me b">kubectl exec -it [pod-name] [container-name] -- /bin/sh</code></p><p id="8c43" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您还可以使用它在容器本身中运行命令。以下是如何在运行PostgreSQL的pod中直接执行SQL文件的示例:</p><p id="7c6e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe mb mc md me b">kubectl exec -i [postgres-pod-name] postgres -- psql --username [postgres-user] --password [postgres-password] --dbname [database-name] &lt; ./dump-backup.sql</code></p><p id="3044" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这些只是你可以用<code class="fe mb mc md me b">kubectl</code>做的几件事，会给你的心带来一些快乐。</p><p id="afbc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi">—</p><p id="c135" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">简而言之:</strong>到目前为止，这是一个有趣的探索。我不建议大多数人这样做，因为这是一个很大的工程，但是如果你想在工作之外了解更多关于Kubernetes的知识，这绝对是值得的。</p><p id="5876" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">还有更多的东西，我希望随着我了解的更多，继续更新这篇文章，但是现在，就这样了。到目前为止非常有趣，我已经打破了我的头很多，但我相信我现在做得很好。</p><p id="6377" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我的下一步是尝试编写自己的Kubernetes操作符。希望我能够在新的文章中继续这些内容。</p><p id="d4fa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">非常感谢你阅读这篇文章，我希望你在这些疯狂的时刻安然无恙。下次见！</p></div></div>    
</body>
</html>