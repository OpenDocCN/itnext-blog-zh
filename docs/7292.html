<html>
<head>
<title>Managing Terraform state</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">管理地形状态</h1>
<blockquote>原文：<a href="https://itnext.io/managing-terraform-state-27cf4fc135b?source=collection_archive---------3-----------------------#2022-08-11">https://itnext.io/managing-terraform-state-27cf4fc135b?source=collection_archive---------3-----------------------#2022-08-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1495" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">最佳实践和示例</h2></div><p id="075a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本文中，我们将研究如何管理Terraform状态。首先，我们将介绍什么是Terraform状态以及为什么需要它，然后看一些存储、组织和隔离状态文件的最佳实践。然后，我们将继续研究如何利用数据源引用远程状态，最后，如何使用<code class="fe le lf lg lh b">terraform state</code>命令来操作状态文件的内容。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi li"><img src="../Images/068d9dae81b35ccf4406516a823593cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QllBmGqAYqiKrdqa0aEvIg.jpeg"/></div></div><figcaption class="lu lv gj gh gi lw lx bd b be z dk translated">照片由<a class="ae ly" href="https://unsplash.com/@avirichards?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">阿维·理查兹</a>在<a class="ae ly" href="https://unsplash.com/s/photos/remote?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h2 id="4829" class="lz ma it bd mb mc md dn me mf mg dp mh kr mi mj mk kv ml mm mn kz mo mp mq mr bi translated">什么是地形状态？</h2><p id="70d8" class="pw-post-body-paragraph ki kj it kk b kl ms ju kn ko mt jx kq kr mu kt ku kv mv kx ky kz mw lb lc ld im bi translated">Terraform在一个状态文件中记录它所创建的资源的信息。这使得Terraform能够知道哪些资源在其控制之下，以及何时更新和销毁它们。默认情况下，terraform状态文件名为<code class="fe le lf lg lh b">terraform.tfstate</code>，保存在运行Terraform的同一目录中。它是在运行<code class="fe le lf lg lh b">terraform apply.</code>之后创建的。这个文件的实际内容是配置中定义的资源的JSON格式映射，以及那些存在于您的基础设施中的资源。当Terraform运行时，它可以使用这种映射来比较基础设施和代码，并根据需要进行调整。</p><h2 id="bdf2" class="lz ma it bd mb mc md dn me mf mg dp mh kr mi mj mk kv ml mm mn kz mo mp mq mr bi translated">存储状态文件</h2><p id="cb32" class="pw-post-body-paragraph ki kj it kk b kl ms ju kn ko mt jx kq kr mu kt ku kv mv kx ky kz mw lb lc ld im bi translated">默认情况下，状态文件存储在运行Terraform的本地目录中。如果您使用Terraform进行测试或用于个人项目，这是很好的(只要您的状态文件是安全的和备份的！)，但是，当在一个团队中处理Terraform项目时，这就成了一个问题，因为多个人需要访问状态文件。此外，当使用自动化和CI/CD管道来运行Terraform时，状态文件需要是可访问的，并且将许可给予运行管道的服务主体，以便能够访问保存状态文件的存储帐户容器。这使得共享存储成为保存状态文件的理想选择，可以根据需要授予权限。Azure存储帐户或亚马逊S3桶是一个完美的选择。你也可以使用<a class="ae ly" href="https://docs.spacelift.io/vendors/terraform/state-management" rel="noopener ugc nofollow" target="_blank"> Spacelift之类的工具为你管理你的状态</a>。</p><p id="a549" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你应该远程存储你的状态文件，而不是在你的本地机器上！然后可以使用<code class="fe le lf lg lh b">terraform</code>块中的<code class="fe le lf lg lh b">backend</code>块引用远程状态文件的位置(通常在<code class="fe le lf lg lh b">main.tf</code>文件中)。</p><p id="bd63" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">以下示例显示了在Azure中使用存储帐户的配置:</p><pre class="lj lk ll lm gt mx lh my mz aw na bi"><span id="8240" class="lz ma it lh b gy nb nc l nd ne">terraform {</span><span id="3264" class="lz ma it lh b gy nf nc l nd ne">  backend "azurerm" {<br/>    resource_group_name  = "terraform-rg"<br/>    storage_account_name = "terraformsa"<br/>    container_name       = "terraformstate"<br/>    key                  = "terraform.tfstate"<br/>  }</span><span id="b4da" class="lz ma it lh b gy nf nc l nd ne">}</span></pre><p id="160a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将状态文件存储在源代码控制中并不是一个好主意。这是因为Terraform状态文件包含所有纯文本数据，其中可能包含机密。将秘密存储在除安全位置之外的任何地方都不是一个好主意，并且绝对不应该放在源代码控制中。为了避免这种情况，例如在Azure中，可以引用Azure Key Vault。其次，大多数版本控制系统不允许锁定文件，当多人试图同时访问文件时，这可能会导致问题。最后，在版本控制中存储状态文件可能会引入人为错误，因为每次运行Terraform时都需要提取最新的状态文件。这可能导致使用旧的状态文件，并对基础结构进行意外更改。</p><p id="9b3a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">相反，使用远程后端解决了这些挑战，本机支持锁定，将自动加载状态文件，并且可以使用加密来保护磁盘上和传输中的状态文件。Azure Storage或亚马逊S3等远程后端存储旨在实现高可用性。它们还支持版本控制，因此如果文件损坏，您可以回滚到以前的状态文件。最后，它使用起来很便宜，通常状态文件非常小，通常可以放入空闲层。</p><h2 id="1408" class="lz ma it bd mb mc md dn me mf mg dp mh kr mi mj mk kv ml mm mn kz mo mp mq mr bi translated">隔离和组织状态文件</h2><p id="4918" class="pw-post-body-paragraph ki kj it kk b kl ms ju kn ko mt jx kq kr mu kt ku kv mv kx ky kz mw lb lc ld im bi translated"><strong class="kk iu">国家文件应该隔离，以减少“爆炸半径”。</strong>通常，项目被构建在单个文件夹中，并且对所有资源使用单个状态文件。这会立即带来风险，因为配置中的错误可能会更改状态文件，并对所有资源造成不必要的后果。一个更好的方法是为基础设施的各个部分使用多个状态文件。在逻辑上将资源彼此分开，并在后端给它们自己的状态文件，这意味着对一个资源的更改不会影响另一个。不同环境的不同状态文件也是一个好主意。</p><p id="b646" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，假设我们的项目中有一个Azure SQL数据库、Azure VNET和Azure Web App。基础设施在3个环境中是相同的:开发、UAT(用户验收测试)和生产。对于每个环境，这3种资源中的每一种都有自己的状态文件。这为每个环境提供了强有力的隔离。更进一步，您可能希望在不同的订阅中为每个环境使用完全独立的存储帐户。假设我们将所有状态文件保存在一个存储帐户中，远程后端的容器文件夹结构最终可能看起来像下面的示例:</p><pre class="lj lk ll lm gt mx lh my mz aw na bi"><span id="a7ab" class="lz ma it lh b gy nb nc l nd ne">terraformstate</span><span id="28a5" class="lz ma it lh b gy nf nc l nd ne">--development<br/>  --webapp.tfstate<br/>  --sqldb.tfstate<br/>  --vnet.tfstate</span><span id="abb2" class="lz ma it lh b gy nf nc l nd ne">--UAT<br/>  --webapp.tfstate<br/>  --sqldb.tfstate<br/>  --vnet.tfstate</span><span id="d299" class="lz ma it lh b gy nf nc l nd ne">--production<br/>  --webapp.tfstate<br/>  --sqldb.tfstate<br/>  --vnet.tfstate</span></pre><p id="f193" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">开发环境中Azure Web App的后端配置:</p><pre class="lj lk ll lm gt mx lh my mz aw na bi"><span id="b53f" class="lz ma it lh b gy nb nc l nd ne">terraform {</span><span id="75c8" class="lz ma it lh b gy nf nc l nd ne">  backend "azurerm" {<br/>    resource_group_name  = "terraform-rg"<br/>    storage_account_name = "terraformsa"<br/>    container_name       = "terraformstate"<br/>    key                  = "development\webapp.tfstate"<br/>  }</span><span id="9adf" class="lz ma it lh b gy nf nc l nd ne">}</span></pre><p id="f625" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对开发中的Azure Web应用程序进行更改不会影响生产中的Azure Web应用程序。</p><p id="038d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用Terraform工作空间也可以实现隔离。这些在生产环境中不太有用，但有利于快速测试隔离环境。<a class="ae ly" href="https://www.terraform.io/language/state/workspaces#when-to-use-multiple-workspaces." rel="noopener ugc nofollow" target="_blank">不鼓励使用工作空间来管理实际环境</a>。Terraform默认有一个工作空间(称为default！).状态文件被隔离到每个工作区。</p><p id="bc88" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以使用<code class="fe le lf lg lh b">terraform workspace new</code>命令创建一个新的工作空间。</p><pre class="lj lk ll lm gt mx lh my mz aw na bi"><span id="18cc" class="lz ma it lh b gy nb nc l nd ne">$ terraform workspace new development</span><span id="8d2a" class="lz ma it lh b gy nf nc l nd ne">Created and switched to workspace "development"! You're now on a new, empty workspace. Workspaces isolate their state, so if you run "terraform plan" Terraform will not see any existing state for this configuration.</span></pre><p id="1184" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用工作空间时有用的命令快速参考:</p><p id="8e5c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe le lf lg lh b">terraform workspace list</code> —列出您的工作区。</p><p id="4a95" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe le lf lg lh b">terraform workspace new [workspace name]</code> —创建新的工作区。</p><p id="391b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe le lf lg lh b">terraform workspace select [workspace name]</code>-切换到指定的工作区。</p><h2 id="0500" class="lz ma it bd mb mc md dn me mf mg dp mh kr mi mj mk kv ml mm mn kz mo mp mq mr bi translated">地形远程状态</h2><p id="0e70" class="pw-post-body-paragraph ki kj it kk b kl ms ju kn ko mt jx kq kr mu kt ku kv mv kx ky kz mw lb lc ld im bi translated"><code class="fe le lf lg lh b">terraform_remote_state</code>是一个数据源，可用于直接从远程状态文件中获取详细信息。当您需要引用存储在不同状态文件中的配置输出时，这很有用。当在您的配置中定义了一个<code class="fe le lf lg lh b">output</code>块时，其内容包含在状态文件中。这些细节可以在项目的其他地方引用。</p><p id="3878" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，再次考虑我们有一个Azure SQL数据库和Azure Web应用程序。这些的配置文件应该设置为使用不同的状态文件。当创建web应用程序需要连接的数据库时，我们添加了一个<code class="fe le lf lg lh b">output</code>块来公开数据库创建后的结果ID:</p><pre class="lj lk ll lm gt mx lh my mz aw na bi"><span id="33e6" class="lz ma it lh b gy nb nc l nd ne">output "sqldb_id" {<br/>  value       = azurerm_sql_database.example.id<br/>  description = "Database ID"<br/>}</span></pre><p id="fbcc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，我们可以通过使用<code class="fe le lf lg lh b">terraform_remote_state</code>配置数据块，在Web应用程序配置代码中引用结果SQL数据库ID:</p><pre class="lj lk ll lm gt mx lh my mz aw na bi"><span id="699e" class="lz ma it lh b gy nb nc l nd ne">data "terraform_remote_state" "dev_sqldb" {   <br/>  backend = "azurerm"<br/>   <br/>  config = {     <br/>    storage_account_name = "terraformsa"     <br/>    container_name       = "terraformstate"     <br/>    key                  = "development/sqldb.tfstate"   <br/>  }<br/>}</span></pre><p id="f4e3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后在配置中需要的地方引用输出的名称:</p><pre class="lj lk ll lm gt mx lh my mz aw na bi"><span id="3a39" class="lz ma it lh b gy nb nc l nd ne">data.terraform_remote_state.dev_sqldb.outputs.sqldb_id</span></pre><h2 id="4360" class="lz ma it bd mb mc md dn me mf mg dp mh kr mi mj mk kv ml mm mn kz mo mp mq mr bi translated">操作状态文件</h2><p id="0529" class="pw-post-body-paragraph ki kj it kk b kl ms ju kn ko mt jx kq kr mu kt ku kv mv kx ky kz mw lb lc ld im bi translated">有时有必要直接与状态文件交互，或者检查其内容，当项目被错误导入或不再存在于真实基础结构中时删除项目，或者导入已经存在的项目以将其置于Terraform管理之下。</p><p id="08aa" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe le lf lg lh b">terraform state</code>命令可用于执行高级状态管理。所有修改状态的状态管理命令在进行修改之前创建状态的时间戳备份。</p><p id="2641" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有用的<code class="fe le lf lg lh b">terraform state</code>命令:</p><p id="8824" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe le lf lg lh b">terraform state list</code> —列出状态文件的内容。</p><p id="e203" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe le lf lg lh b">terraform state rm</code> —从状态文件中删除一个项目。</p><p id="9ebc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe le lf lg lh b">terraform state show</code> —显示状态文件中的资源。</p><p id="f7a3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要将基础设施中由其他方法创建的现有项目导入状态文件，使其处于地形控制之下，可使用<code class="fe le lf lg lh b">terraform import</code>命令。Terraform文档页面上的每个资源都有一个导入部分，详细说明了如何对特定资源使用该命令。比如在<a class="ae ly" href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/sql_database" rel="noopener ugc nofollow" target="_blank">azure RM _ sql _ database</a>docs页面上，声明可以使用<code class="fe le lf lg lh b">resource id</code>导入SQL数据库，并给出了一个例子。</p><pre class="lj lk ll lm gt mx lh my mz aw na bi"><span id="bb89" class="lz ma it lh b gy nb nc l nd ne">terraform import azurerm_sql_database.database1 /subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/myresourcegroup/providers/Microsoft.Sql/servers/myserver/databases/database1</span></pre><p id="e1ae" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在使用该命令之前，需要将相应的<code class="fe le lf lg lh b">resource</code>块<code class="fe le lf lg lh b">azurerm_sql_database.database1</code>写入配置文件，设置与实际基础设施相匹配。导入资源可能非常耗时，因此从一开始就避免手动创建资源通常是一个明智的想法！</p><h2 id="f646" class="lz ma it bd mb mc md dn me mf mg dp mh kr mi mj mk kv ml mm mn kz mo mp mq mr bi translated">摘要</h2><p id="394b" class="pw-post-body-paragraph ki kj it kk b kl ms ju kn ko mt jx kq kr mu kt ku kv mv kx ky kz mw lb lc ld im bi translated">理解Terraform状态管理和最佳实践是精通Terraform的关键。作为一般规则，状态文件应远程存储，并以这样的方式隔离和组织，即对于资源和环境的逻辑组存在单独的状态文件，以便在发生任何错误时减少“爆炸半径”。<code class="fe le lf lg lh b">terraform_remote_state</code>数据源可用于从状态文件中引用<code class="fe le lf lg lh b">outputs</code>。最后，<code class="fe le lf lg lh b">terraform state</code>和<code class="fe le lf lg lh b">terraform import</code>命令可以用来操作状态文件的内容。</p><p id="96ef" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有关Terraform状态的更多信息，请查看Terraform文档:</p><div class="ng nh gp gr ni nj"><a href="https://www.terraform.io/language/state" rel="noopener  ugc nofollow" target="_blank"><div class="nk ab fo"><div class="nl ab nm cl cj nn"><h2 class="bd iu gy z fp no fr fs np fu fw is bi translated">HashiCorp的State | Terraform</h2><div class="nq l"><h3 class="bd b gy z fp no fr fs np fu fw dk translated">搜索Terraform文档Terraform必须存储有关托管基础架构和配置的状态。这个…</h3></div><div class="nr l"><p class="bd b dl z fp no fr fs np fu fw dk translated">www.terraform.io</p></div></div><div class="ns l"><div class="nt l nu nv nw ns nx ls nj"/></div></div></a></div><p id="adf3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">想要更多的Terraform内容？<a class="ae ly" href="https://medium.com/@jackwesleyroper/terraform-related-articles-index-52fab8f11a0b" rel="noopener">点击这里查看我在Terraform上的其他文章</a>！</p><p id="a6f6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">干杯！🍻</p><div class="ng nh gp gr ni nj"><a href="https://www.buymeacoffee.com/jackwesleyroper" rel="noopener  ugc nofollow" target="_blank"><div class="nk ab fo"><div class="nl ab nm cl cj nn"><h2 class="bd iu gy z fp no fr fs np fu fw is bi translated">Jack Roper正在Azure、Azure DevOps、Terraform、Kubernetes和Cloud tech上写博客！</h2><div class="nq l"><h3 class="bd b gy z fp no fr fs np fu fw dk translated">希望我的博客能帮到你，你会喜欢它的内容！我真的很喜欢写技术内容和分享…</h3></div><div class="nr l"><p class="bd b dl z fp no fr fs np fu fw dk translated">www.buymeacoffee.com</p></div></div><div class="ns l"><div class="ny l nu nv nw ns nx ls nj"/></div></div></a></div><p id="edfb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="nz">最初发表于</em><a class="ae ly" href="https://spacelift.io/" rel="noopener ugc nofollow" target="_blank"><em class="nz">space lift . io</em></a><em class="nz">。</em></p></div></div>    
</body>
</html>