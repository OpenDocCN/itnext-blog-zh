<html>
<head>
<title>BIG change in K8s 1.24 about ServiceAccounts and their Secrets</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">K8s 1.24中关于服务帐户及其秘密的重大变化</h1>
<blockquote>原文：<a href="https://itnext.io/big-change-in-k8s-1-24-about-serviceaccounts-and-their-secrets-4b909a4af4e0?source=collection_archive---------0-----------------------#2022-05-18">https://itnext.io/big-change-in-k8s-1-24-about-serviceaccounts-and-their-secrets-4b909a4af4e0?source=collection_archive---------0-----------------------#2022-05-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="55e3" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">K8s不会再自动为服务帐户生成秘密</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/626a60d2b73342ba55eb935d94cec922.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fdCQyFhBul1Lw8_NhVoh4A.png"/></div></div></figure><h1 id="d9f2" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">TL；速度三角形定位法(dead reckoning)</h1><ul class=""><li id="68f5" class="lj lk iq ll b lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">创建ServiceAccount时，不会自动创建更多机密</li><li id="2c51" class="lj lk iq ll b lm mb lo mc lq md ls me lu mf lw lx ly lz ma bi translated">默认情况下，Pods内部仍有一个属于其服务帐户的令牌</li><li id="c02c" class="lj lk iq ll b lm mb lo mc lq md ls me lu mf lw lx ly lz ma bi translated">我们可以为服务帐户创建令牌:<code class="fe mg mh mi mj b">kubectl create token</code></li><li id="049e" class="lj lk iq ll b lm mb lo mc lq md ls me lu mf lw lx ly lz ma bi translated">我们可以为服务帐户手动创建密码</li></ul><h1 id="e40b" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">亲眼看看变化</h1><p id="94bc" class="pw-post-body-paragraph mk ml iq ll b lm ln jr mm lo lp ju mn lq mo mp mq ls mr ms mt lu mu mv mw lw ij bi translated">我创建了一个<a class="ae mx" href="https://killercoda.com/kimwuestkamp/scenario/k8s1.24-serviceaccount-secret-changes" rel="noopener ugc nofollow" target="_blank">场景</a>，你可以按照简单的步骤在浏览器中交互地查看变化。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="my mz l"/></div></figure><h1 id="f8cc" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">行动的改变</h1><p id="090c" class="pw-post-body-paragraph mk ml iq ll b lm ln jr mm lo lp ju mn lq mo mp mq ls mr ms mt lu mu mv mw lw ij bi translated">首先你需要一个<a class="ae mx" href="https://killercoda.com/kimwuestkamp/scenario/k8s1.24-serviceaccount-secret-changes" rel="noopener ugc nofollow" target="_blank"> K8s 1.24集群</a>！</p><h2 id="dfc2" class="na ks iq bd kt nb nc dn kx nd ne dp lb lq nf ng ld ls nh ni lf lu nj nk lh nl bi translated">创建服务帐户</h2><p id="7622" class="pw-post-body-paragraph mk ml iq ll b lm ln jr mm lo lp ju mn lq mo mp mq ls mr ms mt lu mu mv mw lw ij bi translated">你会看到没有更多的秘密自动创建！</p><pre class="kg kh ki kj gt nm mj nn no aw np bi"><span id="34bc" class="na ks iq mj b gy nq nr l ns nt">kubectl create sa cicd</span><span id="68af" class="na ks iq mj b gy nu nr l ns nt">kubectl get sa</span><span id="7c11" class="na ks iq mj b gy nu nr l ns nt">kubectl get secret</span></pre><h2 id="5bdd" class="na ks iq bd kt nb nc dn kx nd ne dp lb lq nf ng ld ls nh ni lf lu nj nk lh nl bi translated">创建使用此ServiceAccount的Pod</h2><p id="c1be" class="pw-post-body-paragraph mk ml iq ll b lm ln jr mm lo lp ju mn lq mo mp mq ls mr ms mt lu mu mv mw lw ij bi translated">这里的一切都和以前一样:</p><pre class="kg kh ki kj gt nm mj nn no aw np bi"><span id="e06b" class="na ks iq mj b gy nq nr l ns nt">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  name: cicd<br/>spec:<br/><strong class="mj ir">  serviceAccount: cicd</strong><br/>  containers:<br/>  - image: nginx<br/>    name: cicd</span></pre><p id="eb86" class="pw-post-body-paragraph mk ml iq ll b lm nv jr mm lo nw ju mn lq nx mp mq ls ny ms mt lu nz mv mw lw ij bi translated">一旦Pod运行，你可以看到里面仍然有一个令牌，所以如果你的应用程序使用这个你应该没问题！</p><pre class="kg kh ki kj gt nm mj nn no aw np bi"><span id="940c" class="na ks iq mj b gy nq nr l ns nt">kubectl exec cicd -- cat /run/secrets/kubernetes.io/serviceaccount/token</span></pre><h2 id="4415" class="na ks iq bd kt nb nc dn kx nd ne dp lb lq nf ng ld ls nh ni lf lu nj nk lh nl bi translated">手动生成ServiceAccount令牌</h2><p id="48b6" class="pw-post-body-paragraph mk ml iq ll b lm ln jr mm lo lp ju mn lq mo mp mq ls mr ms mt lu mu mv mw lw ij bi translated">我们可以简单地手动生成令牌，以便在管道中使用，或者在需要联系K8s Apiserver时使用:</p><pre class="kg kh ki kj gt nm mj nn no aw np bi"><span id="f998" class="na ks iq mj b gy nq nr l ns nt">kubectl create token cicd</span><span id="5a6a" class="na ks iq mj b gy nu nr l ns nt">kubectl create token cicd --duration=999999h</span></pre><blockquote class="oa ob oc"><p id="f141" class="mk ml od ll b lm nv jr mm lo nw ju mn oe nx mp mq of ny ms mt og nz mv mw lw ij bi translated">提示:您可以使用例如<a class="ae mx" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank"> https://jwt.io </a>来检查令牌，只是不要对生产令牌这样做！</p></blockquote><h2 id="7e1d" class="na ks iq bd kt nb nc dn kx nd ne dp lb lq nf ng ld ls nh ni lf lu nj nk lh nl bi translated">为服务帐户创建一个密码</h2><p id="a043" class="pw-post-body-paragraph mk ml iq ll b lm ln jr mm lo lp ju mn lq mo mp mq ls mr ms mt lu mu mv mw lw ij bi translated">我们可以手动创建密码，并将其分配给服务帐户:</p><pre class="kg kh ki kj gt nm mj nn no aw np bi"><span id="436c" class="na ks iq mj b gy nq nr l ns nt">apiVersion: v1<br/>kind: Secret<br/><strong class="mj ir">type: kubernetes.io/service-account-token</strong><br/>metadata:<br/>  name: cicd<br/><strong class="mj ir">  annotations:</strong><br/><strong class="mj ir">    kubernetes.io/service-account.name: "cicd"</strong></span></pre><p id="23d8" class="pw-post-body-paragraph mk ml iq ll b lm nv jr mm lo nw ju mn lq nx mp mq ls ny ms mt lu nz mv mw lw ij bi translated">现在，如果我们描述这个秘密，我们还会看到为它生成了一个令牌:</p><pre class="kg kh ki kj gt nm mj nn no aw np bi"><span id="456d" class="na ks iq mj b gy nq nr l ns nt">kubectl describe secret cicd</span></pre><p id="e0d8" class="pw-post-body-paragraph mk ml iq ll b lm nv jr mm lo nw ju mn lq nx mp mq ls ny ms mt lu nz mv mw lw ij bi translated">不过，一个很大的不同是，服务账户不再像以前那样有一个秘密部分:</p><pre class="kg kh ki kj gt nm mj nn no aw np bi"><span id="d635" class="na ks iq mj b gy nq nr l ns nt">kubectl get sa cicd -oyaml</span></pre><p id="5df0" class="pw-post-body-paragraph mk ml iq ll b lm nv jr mm lo nw ju mn lq nx mp mq ls ny ms mt lu nz mv mw lw ij bi translated">为了找到属于ServiceAccount的秘密，我们需要搜索所有具有适当注释的秘密。</p><h2 id="acc4" class="na ks iq bd kt nb nc dn kx nd ne dp lb lq nf ng ld ls nh ni lf lu nj nk lh nl bi translated">删除服务帐户</h2><p id="ac3b" class="pw-post-body-paragraph mk ml iq ll b lm ln jr mm lo lp ju mn lq mo mp mq ls mr ms mt lu mu mv mw lw ij bi translated">如果我们删除ServiceAccount，那么密码也会自动删除，就像以前的版本一样:</p><pre class="kg kh ki kj gt nm mj nn no aw np bi"><span id="7b04" class="na ks iq mj b gy nq nr l ns nt">kubectl delete sa cicd</span><span id="683b" class="na ks iq mj b gy nu nr l ns nt">kubectl get sa,secret # all gone</span></pre><h1 id="9ace" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">保持最新和通知！</h1><p id="1a91" class="pw-post-body-paragraph mk ml iq ll b lm ln jr mm lo lp ju mn lq mo mp mq ls mr ms mt lu mu mv mw lw ij bi translated"><a class="ae mx" href="https://twitter.com/killercoda" rel="noopener ugc nofollow" target="_blank">推特</a></p><p id="99f6" class="pw-post-body-paragraph mk ml iq ll b lm nv jr mm lo nw ju mn lq nx mp mq ls ny ms mt lu nz mv mw lw ij bi translated"><a class="ae mx" href="https://www.linkedin.com/company/killercoda" rel="noopener ugc nofollow" target="_blank">领英</a></p></div></div>    
</body>
</html>