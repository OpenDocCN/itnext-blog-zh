<html>
<head>
<title>PostgreSQL: PostgreSQL Operator for Kubernetes, and its Prometheus monitoring</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PostgreSQL:Kubernetes的PostgreSQL操作符，及其Prometheus监控</h1>
<blockquote>原文：<a href="https://itnext.io/postgresql-postgresql-operator-for-kubernetes-and-its-prometheus-monitoring-6f73525a1b77?source=collection_archive---------1-----------------------#2022-09-23">https://itnext.io/postgresql-postgresql-operator-for-kubernetes-and-its-prometheus-monitoring-6f73525a1b77?source=collection_archive---------1-----------------------#2022-09-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/1016dc2c261f3bb1add496de5fd73577.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/format:webp/1*fjkMMOup1U8ZnbhzH1wrSA.png"/></div></figure><p id="c51b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以，我们已经启动了德鲁伊，见<a class="ae ks" href="https://rtfm-co-ua.translate.goog/uk/apache-druid-oglyad-zapusk-v-kubernetes-ta-monitoring-z-prometheus/?_x_tr_sl=uk&amp;_x_tr_tl=en&amp;_x_tr_hl=en&amp;_x_tr_pto=wapp" rel="noopener ugc nofollow" target="_blank">阿帕奇德鲁伊:概述，在Kubernetes运行，用普罗米修斯</a>监控。到目前为止，本地<a class="ae ks" href="https://translate.google.com/website?sl=uk&amp;tl=en&amp;hl=en&amp;client=webapp&amp;u=https://db.apache.org/derby/" rel="noopener ugc nofollow" target="_blank"> Apache Derby </a>数据库被用作元数据的默认<a class="ae ks" href="https://translate.google.com/website?sl=uk&amp;tl=en&amp;hl=en&amp;client=webapp&amp;u=https://druid.apache.org/docs/latest/design/architecture.html%23metadata-storage" rel="noopener ugc nofollow" target="_blank">存储。</a></p><p id="e019" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来，我们将把Druid切换到PostgreSQL，稍后我们将从集群设置中删除ZooKeeper。</p><p id="9302" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">首先，让我们在Kubernetes中启动一个PostgreSQL集群，为Prometheus添加<a class="ae ks" href="https://translate.google.com/website?sl=uk&amp;tl=en&amp;hl=en&amp;client=webapp&amp;u=https://github.com/prometheus-community/postgres_exporter" rel="noopener ugc nofollow" target="_blank"> PostgreSQL导出器</a>，并配置指标收集。</p><p id="cb87" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们将在<a class="ae ks" href="https://rtfm-co-ua.translate.goog/kubernetes-zapusk-minikube-na-arch-linux/?_x_tr_sl=uk&amp;_x_tr_tl=en&amp;_x_tr_hl=en&amp;_x_tr_pto=wapp" rel="noopener ugc nofollow" target="_blank"> Minikube </a>中再次启动，对于PostgreSQL，我们将使用<a class="ae ks" href="https://translate.google.com/website?sl=uk&amp;tl=en&amp;hl=en&amp;client=webapp&amp;u=https://github.com/zalando/postgres-operator/" rel="noopener ugc nofollow" target="_blank"> Zalando操作符</a>，并将添加<a class="ae ks" href="https://github.com/prometheus-community/postgres_exporter" rel="noopener ugc nofollow" target="_blank"> PostgreSQL导出器</a>作为<a class="ae ks" href="https://translate.google.com/website?sl=uk&amp;tl=en&amp;hl=en&amp;client=webapp&amp;u=https://www.containiq.com/post/kubernetes-sidecar-container" rel="noopener ugc nofollow" target="_blank"> sidecar容器</a>。</p><p id="bdf9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们还不会深入研究这个操作符，尽管它非常有趣，所以我们会以某种方式玩它。现在，我们只需要监视它。</p><p id="af80" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">文档— <a class="ae ks" href="https://translate.google.com/website?sl=uk&amp;tl=en&amp;hl=en&amp;client=webapp&amp;u=https://github.com/zalando/postgres-operator/blob/master/docs/administrator.md" rel="noopener ugc nofollow" target="_blank">管理员指南</a>。</p><h1 id="06f6" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">启动PostgreSQL运算符</h1><p id="6f9f" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">创建名称空间:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="52f1" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl create ns postgres-operator<br/>namespace/postgres-operator created</span></pre><p id="334e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加舵库:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="bc79" class="mf ku iq mb b gy mg mh l mi mj">$ helm repo add postgres-operator-charts <a class="ae ks" href="https://opensource.zalando.com/postgres-operator/charts/postgres-operator" rel="noopener ugc nofollow" target="_blank">https://opensource.zalando.com/postgres-operator/charts/postgres-operator</a></span></pre><p id="1bd3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">安装操作器本身:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="a6cc" class="mf ku iq mb b gy mg mh l mi mj">$ helm -n postgres-operator install postgres-operator postgres-operator-charts/postgres-operator</span></pre><p id="8264" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果需要，为操作员添加一个WebUI:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="43dd" class="mf ku iq mb b gy mg mh l mi mj">$ helm repo add postgres-operator-ui-charts <a class="ae ks" href="https://opensource.zalando.com/postgres-operator/charts/postgres-operator-ui" rel="noopener ugc nofollow" target="_blank">https://opensource.zalando.com/postgres-operator/charts/postgres-operator-ui</a></span><span id="a054" class="mf ku iq mb b gy mk mh l mi mj">$ helm -n postgres-operator install postgres-operator-ui postgres-operator-ui-charts/postgres-operator-ui</span></pre><p id="6378" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查舱:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="68a8" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl -n postgres-operator get pods<br/>NAME READY STATUS RESTARTS AGE<br/>postgres-operator-649799f4bd-dz5bl 1/1 Running 0 82s<br/>postgres-operator-ui-5cfff55c65-v4bjj 1/1 Running 0 22s</span></pre><p id="7f3d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为您自己提供对运营商网络接口服务的访问:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="c095" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl port-forward svc/postgres-operator-ui 8081:80<br/>Forwarding from 127.0.0.1:8081 -&gt; 8081<br/>Forwarding from [::1]:8081 -&gt; 8081</span></pre><p id="f0f6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi ml"><img src="../Images/f8c71fd364488ac3e963f09bff88c9af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*aM2XvseAAJhAUUzP.png"/></div></div></figure><p id="20da" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里我们不做任何事情，我们将采用现成的集群配置示例。</p><h1 id="0216" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">启动PostgreSQL集群</h1><p id="3c39" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">克隆操作员的存储库:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="92d0" class="mf ku iq mb b gy mg mh l mi mj">$ git clone <a class="ae ks" href="https://github.com/zalando/postgres-operator.git" rel="noopener ugc nofollow" target="_blank">https://github.com/zalando/postgres-operator.git</a><br/>cd postgres-operator/</span></pre><p id="baf7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<code class="fe mq mr ms mb b">manifests</code>目录中有几个例子，让我们看一下<code class="fe mq mr ms mb b"><a class="ae ks" href="https://github.com/zalando/postgres-operator/blob/master/manifests/minimal-master-replica-svcmonitor.yaml" rel="noopener ugc nofollow" target="_blank">manifests/minimal-master-replica-svcmonitor.yaml</a></code>文件——它描述了一个名称空间、一个集群、用户、数据库、两个服务和两个带有Prometheus Exporter的ServiceMonitors + Sidecars。</p><p id="90f8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">应用它:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="bc9a" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl apply -f manifests/minimal-master-replica-svcmonitor.yaml<br/>namespace/test-pg created<br/>postgresql.acid.zalan.do/acid-minimal-cluster created<br/>service/acid-minimal-cluster-svc-metrics-master created<br/>service/acid-minimal-cluster-svc-metrics-replica created<br/>servicemonitor.monitoring.coreos.com/acid-minimal-cluster-svcm-master created<br/>servicemonitor.monitoring.coreos.com/acid-minimal-cluster-svcm-replica created</span></pre><p id="51e1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查集群:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="8b83" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl -n test-pg get postgresql<br/>NAME TEAM VERSION PODS VOLUME CPU-REQUEST MEMORY-REQUEST AGE STATUS<br/>acid-minimal-cluster acid 13 2 1Gi 2m21s Running</span></pre><p id="6b42" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">它的豆荚:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="ad60" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl -n test-pg get po<br/>NAME READY STATUS RESTARTS AGE<br/>acid-minimal-cluster-0 2/2 Running 0 37s<br/>acid-minimal-cluster-1 1/2 Running 0 24s</span></pre><p id="670f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">每个人都有自己的角色，这些角色被设置在标签中— <code class="fe mq mr ms mb b">spilo-role=master</code>或<code class="fe mq mr ms mb b">spilo-role=replica</code>。</p><h2 id="caff" class="mf ku iq bd kv mt mu dn kz mv mw dp ld kf mx my lh kj mz na ll kn nb nc lp nd bi translated">PostgreSQL用户</h2><p id="8766" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">参见文档<a class="ae ks" href="https://translate.google.com/website?sl=uk&amp;tl=en&amp;hl=en&amp;client=webapp&amp;u=https://github.com/zalando/postgres-operator/blob/master/docs/user.md%23connect-to-postgresql" rel="noopener ugc nofollow" target="_blank">这里&gt; &gt; &gt; </a>和<a class="ae ks" href="https://translate.google.com/website?sl=uk&amp;tl=en&amp;hl=en&amp;client=webapp&amp;u=https://aws.amazon.com/blogs/database/managing-postgresql-users-and-roles/" rel="noopener ugc nofollow" target="_blank">这里&gt; &gt; &gt; </a>。</p><p id="9b8f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">用户在—惊喜— <code class="fe mq mr ms mb b"><a class="ae ks" href="https://translate.google.com/website?sl=uk&amp;tl=en&amp;hl=en&amp;client=webapp&amp;u=https://github.com/zalando/postgres-operator/blob/master/manifests/minimal-master-replica-svcmonitor.yaml%23L21" rel="noopener ugc nofollow" target="_blank">users</a></code>块中描述:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="39b5" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl -n test-pg get postgresql -o yaml<br/>…<br/>users:<br/>foo_user: []<br/>zalando:<br/>- superuser<br/>- createdb<br/>…</span></pre><p id="c93d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运营商将为他们每个人创建一个专用的Kubernetes秘密:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="c3f1" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl -n test-pg get secret<br/>NAME TYPE DATA AGE<br/>foo-user.acid-minimal-cluster.credentials.postgresql.acid.zalan.do Opaque 2 38m<br/>postgres.acid-minimal-cluster.credentials.postgresql.acid.zalan.do Opaque 2 38m<br/>standby.acid-minimal-cluster.credentials.postgresql.acid.zalan.do Opaque 2 38m<br/>zalando.acid-minimal-cluster.credentials.postgresql.acid.zalan.do Opaque 2 38m</span></pre><p id="dae8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后通过变量映射到pod:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="539a" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl -n test-pg get statefulsets acid-minimal-cluster -o yaml<br/>…<br/>- env:<br/>- name: POD_NAME<br/>valueFrom:<br/>fieldRef:<br/>apiVersion: v1<br/>fieldPath: metadata.name<br/>- name: POD_NAMESPACE<br/>valueFrom:<br/>fieldRef:<br/>apiVersion: v1<br/>fieldPath: metadata.namespace<br/>- name: POSTGRES_USER<br/>value: postgres<br/>- name: POSTGRES_PASSWORD<br/>valueFrom:<br/>secretKeyRef:<br/>key: password<br/>name: postgres.acid-minimal-cluster.credentials.postgresql.acid.zalan.do<br/>…</span></pre><p id="6437" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好吧，让我们检查一下。</p><p id="8531" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们得到密码:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="fbb1" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl -n test-pg get secret postgres.acid-minimal-cluster.credentials.postgresql.acid.zalan.do -o ‘jsonpath={.data.password}’ | base64 -d<br/>CcWdAaqvPA8acxwIpVyM8UHkds2QG3opC3KD7rO1TxITQ1q31cwYLTswzfBeTVsN</span></pre><p id="d257" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">打开其端口以进行本地访问:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="dd98" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl -n test-pg port-forward acid-minimal-cluster-0 6432:5432</span></pre><p id="080b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">登录并检查数据库:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="8067" class="mf ku iq mb b gy mg mh l mi mj">$ psql -U postgres -h localhost -p 6432<br/>Password for user postgres:<br/>psql (14.5, server 13.7 (Ubuntu 13.7–1.pgdg18.04+1))<br/>SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, bits: 256, compression: off)<br/>Type “help” for help.<br/>postgres=# \l<br/>List of databases<br/>Name | Owner | Encoding | Collate | Ctype | Access privileges<br/> — — — — — -+ — — — — — -+ — — — — — + — — — — — — -+ — — — — — — -+ — — — — — — — — — — — -<br/>bar | bar_owner | UTF8 | en_US.utf-8 | en_US.utf-8 |<br/>foo | zalando | UTF8 | en_US.utf-8 | en_US.utf-8 |<br/>postgres | postgres | UTF8 | en_US.utf-8 | en_US.utf-8 |<br/>template0 | postgres | UTF8 | en_US.utf-8 | en_US.utf-8 | =c/postgres +<br/>| | | | | postgres=CTc/postgres<br/>template1 | postgres | UTF8 | en_US.utf-8 | en_US.utf-8 | =c/postgres +<br/>| | | | | postgres=CTc/postgres<br/>(5 rows)<br/>postgres=#</span></pre><h1 id="2cae" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">PostgreSQL Prometheus导出程序</h1><p id="ee97" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">参见<a class="ae ks" href="https://translate.google.com/website?sl=uk&amp;tl=en&amp;hl=en&amp;client=webapp&amp;u=https://github.com/zalando/postgres-operator/blob/master/docs/reference/cluster_manifest.md%23sidecar-definitions" rel="noopener ugc nofollow" target="_blank">边车定义</a>。</p><p id="bb49" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们已经有了一个sidecar——它是从manifest中添加的，在每个Pod中，我们当前有两个容器——PostgreSQL本身和它的导出器:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="89d2" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl -n test-pg get po acid-minimal-cluster-0 -o jsonpath=’{.spec.containers[*].name}’<br/>postgres exporter</span></pre><p id="b873" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们看看是否有指标—打开端口:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="d42e" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl -n test-pg port-forward svc/acid-minimal-cluster-svc-metrics-master 9187:9187<br/>Forwarding from 127.0.0.1:9187 -&gt; 9187<br/>Forwarding from [::1]:9187 -&gt; 9187</span></pre><p id="790d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们看到，我们什么也没看到，星团有点“死了”——<code class="fe mq mr ms mb b">pg_up == 0</code>:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="c786" class="mf ku iq mb b gy mg mh l mi mj">$ curl -s localhost:9187/metrics | grep pg_ | grep -v ‘#’<br/>pg_exporter_last_scrape_duration_seconds 1.00031302<br/>pg_exporter_last_scrape_error 1<br/>pg_exporter_scrapes_total 9<br/>pg_up 0</span></pre><p id="cfa1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为什么？因为出口商必须有访问数据，即登录密码。</p><p id="a0aa" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在边车的配置中，添加新的变量，参见<a class="ae ks" href="https://translate.google.com/website?sl=uk&amp;tl=en&amp;hl=en&amp;client=webapp&amp;u=https://github.com/prometheus-community/postgres_exporter%23environment-variables" rel="noopener ugc nofollow" target="_blank">环境变量</a>:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="484b" class="mf ku iq mb b gy mg mh l mi mj">...<br/>      env:<br/>      - name: "DATA_SOURCE_URI"<br/>        value: "$(POD_NAME)/postgres?sslmode=require"<br/>      - name: "DATA_SOURCE_USER"<br/>        value: "$(POSTGRES_USER)"<br/>      - name: "DATA_SOURCE_PASS"<br/>        value: "$(POSTGRES_PASSWORD)"<br/>      - name: "PG_EXPORTER_AUTO_DISCOVER_DATABASES"<br/>        value: "true"<br/>...</span></pre><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/253253e726f3cb29a27424ba752bf94e.png" data-original-src="https://miro.medium.com/v2/resize:fit:978/format:webp/0*Gaz7Azi30Y_wOU-A.png"/></div></figure><p id="7514" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">也就是说，操作符创建了一个StatefulSet，其中设置了变量<code class="fe mq mr ms mb b">POSTGRES_USER</code>和<code class="fe mq mr ms mb b">POSTGRES_PASSWORD</code>，我们用它来为sidecar设置自己的变量。</p><p id="5c94" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">保存更新并应用它们:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="d598" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl apply -f manifests/minimal-master-replica-svcmonitor.yaml</span></pre><p id="05cf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查pod本身的变量:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="42d2" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl -n test-pg get po acid-minimal-cluster-0 -o yaml<br/>…<br/>- env:<br/>- name: POD_NAME<br/>valueFrom:<br/>fieldRef:<br/>apiVersion: v1<br/>fieldPath: metadata.name<br/>- name: POD_NAMESPACE<br/>valueFrom:<br/>fieldRef:<br/>apiVersion: v1<br/>fieldPath: metadata.namespace<br/>- name: POSTGRES_USER<br/>value: postgres<br/>- name: POSTGRES_PASSWORD<br/>valueFrom:<br/>secretKeyRef:<br/>key: password<br/>name: postgres.acid-minimal-cluster.credentials.postgresql.acid.zalan.do<br/>- name: DATA_SOURCE_URI<br/>value: $(POD_NAME)/postgres?sslmode=require<br/>- name: DATA_SOURCE_USER<br/>value: $(POSTGRES_USER)<br/>- name: DATA_SOURCE_PASS<br/>value: $(POSTGRES_PASSWORD)<br/>- name: PG_EXPORTER_AUTO_DISCOVER_DATABASES<br/>value: “true”<br/>…</span></pre><p id="2155" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并在导出器中再次检查指标:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="c337" class="mf ku iq mb b gy mg mh l mi mj">$ curl -s localhost:9187/metrics | grep pg_ | grep -v ‘#’ | tail -5<br/>pg_stat_replication_pg_current_wal_lsn_bytes{application_name=”acid-minimal-cluster-0",client_addr=”172.17.0.17",server=”acid-minimal-cluster-1:5432",slot_name=”182",state=”streaming”} 1.52655344e+08<br/>pg_stat_replication_pg_wal_lsn_diff{application_name=”acid-minimal-cluster-0",client_addr=”172.17.0.17",server=”acid-minimal-cluster-1:5432",slot_name=”182",state=”streaming”} 0<br/>pg_stat_replication_reply_time{application_name=”acid-minimal-cluster-0",client_addr=”172.17.0.17",server=”acid-minimal-cluster-1:5432",slot_name=”182",state=”streaming”} 1.663625745e+09<br/>pg_static{server=”acid-minimal-cluster-1:5432",short_version=”13.7.0",version=”PostgreSQL 13.7 (Ubuntu 13.7–1.pgdg18.04+1) on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 7.5.0–3ubuntu1~18.04) 7.5.0, 64-bit”} 1<br/>pg_up 1</span></pre><p id="7edb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe mq mr ms mb b">pg_up == 1</code> -耶！有用！</p><h2 id="ab9d" class="mf ku iq bd kv mt mu dn kz mv mw dp ld kf mx my lh kj mz na ll kn nb nc lp nd bi translated">Prometehus服务监视器</h2><p id="c653" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">打开端口访问普罗米修斯本身:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="dc41" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl -n monitoring port-forward svc/kube-prometheus-stack-prometheus 9090:9090<br/>Forwarding from 127.0.0.1:9090 -&gt; 9090<br/>Forwarding from [::1]:9090 -&gt; 9090</span></pre><p id="c3b0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查状态&gt;服务发现—我们在这里没有看到PostgreSQL:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi nf"><img src="../Images/38e4eef704338763507737d55c4e66c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yxn0ys1ehlAOH-bc.png"/></div></div></figure><p id="5487" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">已经根据清单创建了ServiceMonitors:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="7020" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl -n test-pg get servicemonitor<br/>NAME AGE<br/>acid-minimal-cluster-svcm-master 65m<br/>acid-minimal-cluster-svcm-replica 65m</span></pre><p id="1c1d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们像<a class="ae ks" href="https://rtfm-co-ua.translate.goog/uk/apache-druid-oglyad-zapusk-v-kubernetes-ta-monitoring-z-prometheus/?_x_tr_sl=uk&amp;_x_tr_tl=en&amp;_x_tr_hl=en&amp;_x_tr_pto=wapp#Prometheus_ServiceMonitor" rel="noopener ugc nofollow" target="_blank">对德鲁伊</a>做的那样重复“肮脏的攻击”——给他们添加一个标签<code class="fe mq mr ms mb b">"release": "kube-prometheus-stack"</code>，等一两分钟，然后再次检查:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi ng"><img src="../Images/38528b4f3cde141572cebb8ee6b1d7a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Deu3mJoYRZVzpFaJ.png"/></div></div></figure><p id="5cf3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们在普罗米修斯图中得到了PostgreSQL的集群指标:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi nh"><img src="../Images/56656eeda80850e9233a337234cc5f1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XmJivEswSYZVQK-Q.png"/></div></div></figure><p id="cf06" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">完成了。</p></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><p id="fc7e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="np">最初发布于</em> <a class="ae ks" href="https://rtfm.co.ua/en/postgresql-postgresql-operator-for-kubernetes-and-its-prometheus-monitoring/" rel="noopener ugc nofollow" target="_blank"> <em class="np"> RTFM: Linux、DevOps、系统管理</em> </a> <em class="np">。</em></p></div></div>    
</body>
</html>