<html>
<head>
<title>Long-term caching a dynamic index.html with Azure static sites and Webpack</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure静态站点和Webpack长期缓存动态index.html</h1>
<blockquote>原文：<a href="https://itnext.io/long-term-caching-a-dynamic-index-html-with-azure-static-sites-and-webpack-b39f0b68ec3?source=collection_archive---------7-----------------------#2018-05-21">https://itnext.io/long-term-caching-a-dynamic-index-html-with-azure-static-sites-and-webpack-b39f0b68ec3?source=collection_archive---------7-----------------------#2018-05-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/14cb6e72d84233c0fb9b71a3fc4575f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0Mudtm1NhaitRoBF-gj5aA.png"/></div></div></figure><p id="b020" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用Webpack开发和构建web应用程序是一个相对简单的过程。有许多伟大的工具，如<a class="ae kw" href="https://github.com/facebook/create-react-app" rel="noopener ugc nofollow" target="_blank"> create-react-app </a>和许多伟大的长期缓存资源，如<a class="ae kw" href="https://developers.google.com/web/fundamentals/performance/webpack/use-long-term-caching" rel="noopener ugc nofollow" target="_blank">https://developers . Google . com/web/fundamentals/performance/web pack/use-long-term-caching</a>。不太清楚的是，如何长期缓存index.html，同时仍然让新的构建无缝地呈现给用户。当不在静态上下文中时，这很容易处理，比如。Net或Node.js，在那里您可以很容易地拦截对index.html的调用，并在某些内容发生变化时使缓存失效；然而，当作为静态站点托管webapp时，这就不那么容易处理了。创建作为静态站点托管的单页面应用程序时，大多数web服务器会积极缓存index.html。这是不可取的，因为在index.html内，任何时候捆绑的资产发生变化，用户都需要硬刷新浏览器才能将它们拉入。我们真正想要的是新的index.html出现在任何正常的页面负载上。用户应该永远不需要用ctrl+r硬刷新浏览器标签。这是一种糟糕的用户体验，会导致用户在看到旧内容时产生混淆。</p><p id="0fa3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">解决方案是对index.html进行哈希处理，并将该哈希包含在文件名本身中，这样就可以将其构建为索引。[哈希]。html，然后将web服务器指向这个特定的散列命名索引文件。</p><p id="8d1b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">散列index.html需要HtmlWebpackPlugin中的一个附加选项:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="d29f" class="lg lh iq lc b gy li lj l lk ll">new HtmlWebpackPlugin({<br/> <strong class="lc ir">filename: ‘index.[hash].html’,</strong><br/> template: paths.appHtml,<br/>})</span></pre><p id="7530" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您的HtmlWebpackPlugin可能包含比这更多的选项，但是请注意粗体文本中的[hash]——这是控制输出的内容。生成的构建文件可能类似于:【index.340e916f34c4b56b9d73.html<strong class="ka ir"/></p><p id="753d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有了索引。[哈希]。html意味着任何时候包发生变化，默认情况下都包含在index.html中，然后是索引的散列部分。[哈希]。html会变。这意味着在生产推送之间，对该索引的所有调用都将使用304进行缓存。现在的挑战是将IIS指向动态生成的defaultDocument文件。由于<a class="ae kw" href="https://docs.microsoft.com/en-us/iis/configuration/system.webserver/defaultdocument/" rel="noopener ugc nofollow" target="_blank"> IIS DefaultDocument </a>不允许通配符，我们必须使用另一种方法。</p><p id="e35c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当创建一个新的Azure静态站点时，你需要选择为你生成一个<strong class="ka ir"> web.config </strong>文件，或者你可以单独创建一个。这里有两个主要观点。首先是IIS需要一个默认文档；其次，Webpack需要用生成的索引更新本地web.config。[哈希]。html名称。</p><p id="fcd2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在web.config中定义一个具有标准index.html的defaultDocument。</p><figure class="kx ky kz la gt jr"><div class="bz fp l di"><div class="lm ln l"/></div></figure><p id="2cc4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在告诉Webpack用散列将index.html重写为生成的index.html。这有点棘手，因为index.html是由webpack在执行插件的末尾编写的，很难确定插件执行的顺序。谢天谢地，“有一个插件可以解决这个问题。”遇见<a class="ae kw" href="https://github.com/cascornelissen/event-hooks-webpack-plugin" rel="noopener ugc nofollow" target="_blank">事件</a>。这个插件允许你挂钩到Webpack中发生的各种事件。这样，我们可以轻松地挂钩到afterEmit 事件的<strong class="ka ir">，并将index.html重写为生成的索引。afterEmit事件在所有资产都被发送到构建目录后执行。这看起来像下面这样:</strong></p><figure class="kx ky kz la gt jr"><div class="bz fp l di"><div class="lm ln l"/></div></figure><p id="62d1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">分解这里的逻辑，在索引之后。[哈希]。html已经发出，EventHooksPlugin开始工作，自定义代码读取html文件，提取散列，并用索引重写web.config中的index.html文本。[哈希]。html文本。在Azure中，有一个静态站点的默认文档列表。假设您不能添加通配符，并且您不希望必须手动添加生成的索引。[哈希]。每次你进行产品推送时，这个插件都会修改web.config，所以它会自动添加到每个新版本中。</p><p id="392c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">假设在构建目录中没有严格的index.html文件，那么唯一剩下的defaultDocument将是web.config现在指向的动态文件。现在，当您加载webapp时，连续的重新加载将被缓存，直到您推送新版本。新的构建将产生新的哈希索引，在下一次页面加载时使缓存失效，从而导致200响应。现在，后续请求将被缓存，直到下一次索引哈希发生变化。这对于用户应该是透明的，不需要额外的用户干预或硬刷新。</p><p id="dc7a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">同样值得注意的是web.config中的重写，这将所有请求强制到根上下文。对于作为静态站点托管的单页面应用程序，这很可能是您想要做的，以允许您的路由库拦截这些调用，并允许defaultDocument对/的默认上下文生效。</p><p id="78cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">编辑于2018年7月5日:</p><p id="454e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您通过VSTS部署到Azure，您可能会注意到浏览器可能仍然在缓存旧的工件。这是因为，默认情况下，构建工件被附加到Kudu site/wwwroot，而不是被替换。请参见以下论坛链接，了解VSTS选项，以确保只有最新的构建工件位于Kudu的wwwroot中:<a class="ae kw" href="https://social.msdn.microsoft.com/Forums/azure/en-US/0c5e85b6-806f-43a9-af6b-3a2a6f6634e6/how-to-delete-all-the-files-on-the-site?forum=windowsazurewebsitespreview" rel="noopener ugc nofollow" target="_blank">https://social . msdn . Microsoft . com/Forums/azure/en-US/0c5e 85 b 6-806 f-43 a9-af6b-3a 2 a6f 6634 e 6/how-to-delete-all-the-files-on-the-site？forum = windowsazurewebsitespreview</a></p></div></div>    
</body>
</html>