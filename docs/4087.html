<html>
<head>
<title>AWS Elastic Kubernetes Service: a cluster creation automation, part 1 — CloudFormation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS弹性Kubernetes服务:集群创建自动化，第1部分—云形成</h1>
<blockquote>原文：<a href="https://itnext.io/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation-55ea2d9e283f?source=collection_archive---------4-----------------------#2020-04-24">https://itnext.io/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation-55ea2d9e283f?source=collection_archive---------4-----------------------#2020-04-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/4048159ab741910e2ce89dd66ce356e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:260/format:webp/0*pA1Txr-pS7Fs5UkJ.png"/></div></figure><p id="7b56" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">任务是:创建自动化来从头开始部署AWS弹性Kubernetes服务集群。</p><p id="bd61" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将使用:</p><ul class=""><li id="8933" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated">Ansible:自动创建CloudFormation堆栈，并使用必要的参数执行<code class="fe lb lc ld le b">eksctl</code></li><li id="d729" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/en/aws-cloudformation-nested-stacks-and-stacks-parameters-import-export/" rel="noopener ugc nofollow" target="_blank">使用嵌套堆栈形成云</a>:创建基础设施— VPC、子网、安全组、IAM角色等</li><li id="f814" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><code class="fe lb lc ld le b">eksctl</code>:使用CloudFormation创建的资源创建集群本身</li></ul><p id="d628" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">思路是:</p><ol class=""><li id="61c8" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr ll ky kz la bi translated">Ansible将使用<a class="ae lk" href="https://rtfm.co.ua/ansible-modul-cloudformation/" rel="noopener ugc nofollow" target="_blank"> cloudformation模块</a>创建一个基础设施</li><li id="4252" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">通过使用CloudFormation创建的堆栈中的<code class="fe lb lc ld le b">Outputs</code>, ansi ble将为<code class="fe lb lc ld le b">eksctl</code>生成一个配置文件</li><li id="6423" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">Ansible调用<code class="fe lb lc ld le b">eksctl</code>传递配置文件，并将创建一个集群</li></ol><p id="28c9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">选择<code class="fe lb lc ld le b">eksctl</code>首先是因为时间不够，其次是因为它使用了CloudFormation，这在我的项目中使用了很长时间，所以我们所有的基础设施都将保持同构状态。</p><p id="1024" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Ansible将使用带有AWS CLI、Ansible和<code class="fe lb lc ld le b">eksctl</code>的Docker映像运行ma Jenkins作业。</p><p id="4a6e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">实际上，不要认为这篇文章是这种自动化的某种“最佳实践”,相反，它更像是一个概念的证明，更多的是一个例子，说明头脑中的一些模糊想法是如何变成实际工作代码和服务的。到底用什么工具——terra formилиcloud formation，<code class="fe lb lc ld le b"><a class="ae lk" href="https://github.com/kubernetes/kops" rel="noopener ugc nofollow" target="_blank">kops</a></code>还是<code class="fe lb lc ld le b"><a class="ae lk" href="https://github.com/weaveworks/eksctl" rel="noopener ugc nofollow" target="_blank">eksctl</a></code>是次要问题。</p><p id="14f3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，Ansible有两个模块可以使与Kubernetes的工作更容易——<code class="fe lb lc ld le b"><a class="ae lk" href="https://docs.ansible.com/ansible/latest/modules/k8s_module.html" rel="noopener ugc nofollow" target="_blank">k8s</a></code>和<code class="fe lb lc ld le b"><a class="ae lk" href="https://docs.ansible.com/ansible/latest/plugins/connection/kubectl.html" rel="noopener ugc nofollow" target="_blank">kubectl</a></code>,但是它们都有状态<em class="lm">预览</em>和<em class="lm">社区</em>,所以我在这里不使用它们。</p><p id="3505" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">帖子真的很长，所以分为两部分:</p><ul class=""><li id="f9c6" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated">在这一个，第一个，我们将开始写一个CloudFromation模板</li><li id="00a5" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated">在第二部中——将开始编写可行的剧本和角色来运行云编队和<code class="fe lb lc ld le b">eksctl</code></li></ul><p id="6b19" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我希望不会有太多的不准确之处，但仍然有可能，因为这是在几天内写的，经过了反复的更正和修改，但它是一步一步描述的，所以总的想法必须足够明显。</p><p id="e753" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">写完这篇文章后得到的所有文件都可以在<a class="ae lk" href="https://github.com/setevoy2/eksctl-cf-ansible/tree/rdy" rel="noopener ugc nofollow" target="_blank"> eksctl-cf-ansible </a> Github资源库中找到。此处的链接指向一个分支，它与下面的代码完全相同。</p><p id="2275" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">第二部分AWS弹性Kubernetes服务:集群创建自动化，第二部分— Ansible，eksctl 。</p><p id="8f05" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">内容</strong></p><ul class=""><li id="c470" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation/#CloudFormation_stacks" rel="noopener ugc nofollow" target="_blank">云形成堆栈</a></li><li id="7879" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation/#The_Root_stack" rel="noopener ugc nofollow" target="_blank">根栈</a></li><li id="202b" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation/#Parameters" rel="noopener ugc nofollow" target="_blank">参数</a></li><li id="9614" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation/#The_Network_Region_stack" rel="noopener ugc nofollow" target="_blank">网络区域堆栈</a></li><li id="ed37" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation/#VPC" rel="noopener ugc nofollow" target="_blank"> VPC </a></li><li id="dae2" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation/#Internet_Gateway" rel="noopener ugc nofollow" target="_blank">互联网网关</a></li><li id="f20f" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation/#Network_AvailabilityZones_stack" rel="noopener ugc nofollow" target="_blank">网络可用性区域堆栈</a></li><li id="8c8e" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation/#Parameters-2" rel="noopener ugc nofollow" target="_blank">参数</a></li><li id="24e9" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation/#Subnets" rel="noopener ugc nofollow" target="_blank">子网</a></li><li id="50bd" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation/#NAT_Gateway" rel="noopener ugc nofollow" target="_blank"> NAT网关</a></li><li id="118a" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation/#Public_RouteTable" rel="noopener ugc nofollow" target="_blank">公共路由表</a></li><li id="14e5" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation/#Private_RouteTable" rel="noopener ugc nofollow" target="_blank">私有路由表</a></li><li id="1bb5" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation/#Mappings_and_CIDRs_for_subnets" rel="noopener ugc nofollow" target="_blank">子网的映射和CIDRs】</a></li><li id="9a6c" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation/#eksctl_%E2%80%93_a_stack_creation" rel="noopener ugc nofollow" target="_blank"> eksctl —堆栈创建</a></li></ul></div><div class="ab cl ln lo hu lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ij ik il im in"><h2 id="19bf" class="lu lv iq bd lw lx ly dn lz ma mb dp mc kf md me mf kj mg mh mi kn mj mk ml mm bi translated">云形成堆栈</h2><p id="6c29" class="pw-post-body-paragraph ju jv iq jw b jx mn jz ka kb mo kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">所以，让我们从云形成堆栈开始。</p><p id="3b1a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们需要创造:</p><ul class=""><li id="2eec" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated">1 VPC</li><li id="33ea" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated">应用程序负载平衡器、堡垒主机、互联网网关的两个公共子网</li><li id="6088" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated">Kubernetes工作节点EC2、NAT网关的两个专用子网</li></ul><p id="1e8b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">EKS AMI对于Kubernetes的工人节点<code class="fe lb lc ld le b">eksctl</code>会自动选择，但是你可以在这里找到整个列表<a class="ae lk" href="https://docs.aws.amazon.com/eks/latest/userguide/eks-optimized-ami.html" rel="noopener ugc nofollow" target="_blank">&gt;&gt;&gt;</a>。</p><p id="3b73" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此处将使用CloudFormation嵌套堆栈(更多详情参见<a class="ae lk" href="https://rtfm.co.ua/en/aws-cloudformation-nested-stacks-and-stacks-parameters-import-export/" rel="noopener ugc nofollow" target="_blank">AWS:cloud formation-嵌套堆栈和堆栈参数导入/导出</a>):</p><ol class=""><li id="9cbb" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr ll ky kz la bi translated">“<strong class="jw ir">根栈</strong>”，一个模板文件<code class="fe lb lc ld le b">eks-root.json</code>——将描述要创建的栈，确定参数等</li><li id="3f9d" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated"><strong class="jw ir">区域-堆栈</strong>，模板文件<code class="fe lb lc ld le b">eks-region-networking.json</code>:</li><li id="6d08" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">一个VPC</li><li id="d6a0" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">互联网网关</li><li id="a62d" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">互联网网关协会</li><li id="d419" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">“<strong class="jw ir">AvailabilityZones-stack</strong>”，一个模板文件<code class="fe lb lc ld le b">eks-azs-networking.json</code> -所有资源将在一个区域的两个不同availability zones上复制:</li><li id="18e7" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">一个公共子网</li><li id="1e80" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">一个专用子网</li><li id="3235" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">公共子网的路由表</li><li id="00c6" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">通过互联网网关进入0.0.0.0/0网络的路由</li><li id="3a0f" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">和SubnetRouteTableAssociation将该路由表附加到该可用性区域中的公共子网</li><li id="a625" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">专用子网的路由表</li><li id="e187" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">通过NAT网关进入0.0.0.0/0网络的路由</li><li id="279a" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">SubnetRouteTableAssociation将此路由表附加到此可用性区域中的专用子网</li><li id="2431" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">NAT网关</li><li id="6576" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">NAT网关的弹性IP</li></ol><p id="c625" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">继续使用根栈模板。</p></div><div class="ab cl ln lo hu lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ij ik il im in"><h2 id="9e9b" class="lu lv iq bd lw lx ly dn lz ma mb dp mc kf md me mf kj mg mh mi kn mj mk ml mm bi translated">根堆栈</h2><p id="6566" class="pw-post-body-paragraph ju jv iq jw b jx mn jz ka kb mo kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">根栈将使用第一个模板来创建所有其他栈。</p><p id="d663" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为未来的角色创建目录:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="88c6" class="lu lv iq le b gy na nb l nc nd">$ mkdir -p roles/cloudformation/{tasks,files,templates}</span></pre><p id="e887" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<code class="fe lb lc ld le b">roles/cloudformation/files/</code>目录中创建一个新文件<code class="fe lb lc ld le b">eks-root.json</code> -这将是我们的根模板:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="0f05" class="lu lv iq le b gy na nb l nc nd">$ cd roles/cloudformation/files/<br/>$ touch eks-root.json</span></pre><p id="5ed8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">参数</strong></p><p id="9e87" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这是一个好主意，想想你的未来的IP地址块，将在您的项目中使用。至少你需要避免使用重叠的网络块来防止<a class="ae lk" href="https://rtfm.co.ua/aws-nastrojka-vpc-peering/" rel="noopener ugc nofollow" target="_blank"> VPN对等</a>问题。</p><p id="b73c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">第二件要考虑的事情是为您的集群和网络插件使用一个完整的网络模型。</p><p id="749e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">默认情况下，AWS弹性Kubernetes服务使用CNI ( <em class="lm">容器网络接口</em>)插件，该插件允许使用工人节点ес2网络接口(ENI — <em class="lm">弹性网络接口</em>)。通过使用这个插件，Kubernetes将从VPC池中分配IP地址给创建的Pod，参见<code class="fe lb lc ld le b"><a class="ae lk" href="https://rtfm.co.ua/goto/https://github.com/aws/amazon-vpc-cni-k8s" rel="noopener ugc nofollow" target="_blank">amazon-vpc-cni-k8s</a></code>和<a class="ae lk" href="https://rtfm.co.ua/goto/https://docs.aws.amazon.com/eks/latest/userguide/pod-networking.html" rel="noopener ugc nofollow" target="_blank"> Pod网络(CNI) </a>。</p><p id="1e06" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这个解决方案有一些优点和缺点，请查看Weave Net的概述— <a class="ae lk" href="https://rtfm.co.ua/goto/https://www.weave.works/blog/aws-and-kubernetes-networking-options-and-trade-offs-part-3" rel="noopener ugc nofollow" target="_blank"> AWS和Kubernetes网络选项和权衡</a>，并阅读Kubernetes文档中的其他插件— <a class="ae lk" href="https://rtfm.co.ua/goto/https://kubernetes.io/docs/concepts/cluster-administration/networking/" rel="noopener ugc nofollow" target="_blank">集群网络</a>。</p><p id="29d0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，值得查看<a class="ae lk" href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html#VPC_Sizing" rel="noopener ugc nofollow" target="_blank"> VPC和子网规模</a>文档。</p><p id="165b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，我们只为VPC添加<em class="lm"> 10.0.0.0/16 </em>地址块，稍后它将被划分为4个子网:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="3c66" class="lu lv iq le b gy na nb l nc nd">{<br/>  "AWSTemplateFormatVersion": "2010-09-09",<br/>  "Description": "AWS CloudFormation stack for Kubernetes cluster",<br/>  <br/>  "Parameters": {<br/>    <br/>    "VPCCIDRBlock": {<br/>      "Description": "VPC CidrBlock",<br/>      "Type": "String",<br/>      "Default": "10.0.0.0/16"<br/>    }<br/>    <br/>  },</span></pre><p id="b331" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">子网将是下一个:</p><ul class=""><li id="a1c3" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated">可用区域1-а/20，4094地址中的一个公共地址</li><li id="7fd5" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated">可用区域1-а/20，4094地址中的一个私有地址</li><li id="da64" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated">可用区域1-в/20，4094个地址中的一个公共地址</li><li id="30e8" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated">可用区域1-в/20，4094地址中的一个私有地址</li></ul><p id="a3f3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里可以使用<code class="fe lb lc ld le b"><a class="ae lk" href="https://linux.die.net/man/1/ipcalc" rel="noopener ugc nofollow" target="_blank">ipcalc</a></code>:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="62ea" class="lu lv iq le b gy na nb l nc nd">$ ipcalc 10.0.0.0/16 -s 4094 4094 4094 4094 | grep Network | cut -d" " -f 1,4 | tail -4<br/>Network: 10.0.0.0/20<br/>Network: 10.0.16.0/20<br/>Network: 10.0.32.0/20<br/>Network: 10.0.48.0/20</span></pre><p id="a610" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">4094地址必须足够所有eс2实例和pod使用。</p><p id="4553" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这篇文章中，我在这里找到了最好的子网计算器<a class="ae lk" href="http://www.subnetmask.info" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="e13f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">另外，添加一个<em class="lm"> EKSClusterName </em>参数—我们将从Ansible这里传递一个集群名称，以创建必要的CloudFormation标签:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="977a" class="lu lv iq le b gy na nb l nc nd">...<br/>    "EKSClusterName": {<br/>      "Description": "EKS cluster name",<br/>      "Type": "String"<br/>    } <br/>...</span></pre></div><div class="ab cl ln lo hu lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ij ik il im in"><h2 id="bd63" class="lu lv iq bd lw lx ly dn lz ma mb dp mc kf md me mf kj mg mh mi kn mj mk ml mm bi translated">网络区域堆栈</h2><p id="1547" class="pw-post-body-paragraph ju jv iq jw b jx mn jz ka kb mo kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">现在我们可以为第二个堆栈创建一个模板。姑且称之为<code class="fe lb lc ld le b">eks-region-networking.json</code>。</p><p id="bc02" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> VPC </strong></p><p id="263e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这个模板中，我们将描述我们的VPC，并且从根模板将传递一个带有VPC CIDR的参数，并返回到根模板—通过<code class="fe lb lc ld le b">Outputs</code>将传递回所创建的VPC的ID:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="fb01" class="lu lv iq le b gy na nb l nc nd">{<br/>  "AWSTemplateFormatVersion" : "2010-09-09",<br/>  "Description" : "AWS CloudFormation Region Networking stack for Kubernetes cluster",<br/>  <br/>  "Parameters" : {<br/>    <br/>    "VPCCIDRBlock": {<br/>      "Description": "VPC CidrBlock",<br/>      "Type": "String"<br/>    },<br/><br/>    "EKSClusterName": {<br/>      "Description": "EKS cluster name",<br/>      "Type": "String"<br/>   }<br/>    <br/>  },<br/>  <br/>  "Resources" : {<br/>    <br/>    "VPC" : {<br/>      "Type" : "AWS::EC2::VPC",<br/>      "Properties" : {<br/>        "CidrBlock" : { "Ref": "VPCCIDRBlock" },<br/>        "EnableDnsHostnames": true,<br/>        "EnableDnsSupport": true,<br/>        "Tags" : [<br/>          {<br/>            "Key" : "Name",<br/>            "Value" : { "Fn::Join" : [ "-", [ {"Ref" : "AWS::StackName"}, "vpc"] ] } },<br/>          {<br/>            "Key" : { "Fn::Join" : [ "", [ "kubernetes.io/cluster/", {"Ref" : "EKSClusterName"}] ] },<br/>            "Value" : "owned"<br/>          }<br/>        ]<br/>      }<br/>    }<br/>    <br/>  },<br/>  <br/>  "Outputs" : {<br/>    <br/>    "VPCID" : {<br/>      "Description" : "EKS VPC ID",<br/>      "Value" : { "Ref" : "VPC" }<br/>    }<br/>    <br/>  }<br/>}</span></pre><p id="75a7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">返回到根模板，添加第一个嵌套堆栈创建。</p><p id="6d9d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">VPC ID将从网络区域堆栈的<code class="fe lb lc ld le b">Outputs</code>中获取，并将通过root的<code class="fe lb lc ld le b">Outputs</code>公开，以便Ansible获取它来创建一个变量，该变量稍后将用于<code class="fe lb lc ld le b">eksctl</code>配置文件。</p><p id="9ffa" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此时，整个根模板必须如下所示:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="3096" class="lu lv iq le b gy na nb l nc nd">{<br/>  "AWSTemplateFormatVersion": "2010-09-09",<br/>  "Description": "AWS CloudFormation stack for Kubernetes cluster",<br/><br/>  "Parameters": {<br/><br/>    "VPCCIDRBlock": {<br/>      "Description": "VPC CidrBlock",<br/>      "Type": "String",<br/>      "Default": "10.0.0.0/16"<br/>    },<br/>    "EKSClusterName": {<br/>      "Description": "EKS cluster name",<br/>      "Type": "String"<br/>   }<br/><br/>  },<br/><br/>  "Resources": {<br/><br/>    "RegionNetworkStack": {<br/>      "Type": "AWS::CloudFormation::Stack",<br/>      "Properties": {<br/>        "TemplateURL": "eks-region-networking.json",<br/>        "Parameters": {<br/>          "VPCCIDRBlock": { "Ref": "VPCCIDRBlock" },<br/>          "EKSClusterName": { "Ref": "EKSClusterName"},<br/>        }<br/>      }<br/>    }<br/><br/>  },<br/><br/>  "Outputs": {<br/><br/>    "VPCID" : {<br/>      "Description" : "EKS VPC ID",<br/>      "Value" : { "Fn::GetAtt": ["RegionNetworkStack", "Outputs.VPCID"] }<br/>    }<br/><br/>  }<br/>}</span></pre><p id="30fd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在计划使用的区域中创建一个S3存储区:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="ad00" class="lu lv iq le b gy na nb l nc nd">$ aws --profile arseniy --region eu-west-2 s3api create-bucket --bucket eks-cloudformation-eu-west-2 --region eu-west-2 --create-bucket-configuration LocationConstraint=eu-west-2</span></pre><p id="d732" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在生产设置中，启用<a class="ae lk" href="https://rtfm.co.ua/goto/https://docs.aws.amazon.com/AmazonS3/latest/dev/Versioning.html" rel="noopener ugc nofollow" target="_blank"> S3版本</a>来备份和记录将会很棒(尽管所有的模板都将存储在Gitbuh存储库中)。</p><p id="e87e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">启用它:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="746d" class="lu lv iq le b gy na nb l nc nd">$ aws --region eu-west-2 --profile arseniy s3api put-bucket-versioning — bucket eks-cloudformation-eu-west-2 --versioning-configuration Status=Enabled</span></pre><p id="ad32" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将<code class="fe lb lc ld le b">eks-root.json</code>和<code class="fe lb lc ld le b">eks-region-networking.json</code>打包到AWS S3，并将结果文件保存到<code class="fe lb lc ld le b">/tmp</code>作为<code class="fe lb lc ld le b">packed-eks-stacks.json</code>:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="c6f7" class="lu lv iq le b gy na nb l nc nd">$ cd roles/cloudformation/files/<br/>$ aws --profile arseniy --region eu-west-2 cloudformation package --template-file eks-root.json --output-template /tmp/packed-eks-stacks.json --s3-bucket eks-cloudformation-eu-west-2 --use-json</span></pre><p id="a443" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">部署堆栈:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="4f80" class="lu lv iq le b gy na nb l nc nd">$ aws --profile arseniy --region eu-west-2 cloudformation deploy --template-file /tmp/packed-eks-stacks.json --stack-name eks-dev<br/>Waiting for changeset to be created..<br/>Waiting for stack create/update to complete<br/>Successfully created/updated stack — eks-dev</span></pre><p id="475a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><p id="db90" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">第一个子堆栈创建完毕，VPC也创建完毕——目前为止一切顺利。</p><p id="239a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">互联网网关</p><p id="756c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加一个互联网网关和<code class="fe lb lc ld le b"><a class="ae lk" href="https://rtfm.co.ua/goto/https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-internetgateway.html" rel="noopener ugc nofollow" target="_blank">VPCGatewayAttachment</a></code>，因此区域堆栈的<code class="fe lb lc ld le b">Resources</code>块将是:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="884e" class="lu lv iq le b gy na nb l nc nd">...<br/>  "Resources" : {<br/><br/>    "VPC" : {<br/>      "Type" : "AWS::EC2::VPC",<br/>      "Properties" : {<br/>        "CidrBlock" : { "Ref": "VPCCIDRBlock" },<br/>        "EnableDnsHostnames": true,<br/>        "EnableDnsSupport": true,<br/>        "Tags" : [<br/>          {<br/>            "Key" : "Name",<br/>            "Value" : { "Fn::Join" : [ "-", [ {"Ref" : "AWS::StackName"}, "vpc"] ] } },<br/>          {<br/>            "Key" : { "Fn::Join" : [ "", [ "kubernetes.io/cluster/", {"Ref" : "EKSClusterName"}] ] },<br/>            "Value" : "owned"<br/>          }<br/>        ]<br/>      }<br/>    },<br/><br/>    "InternetGateway" : {<br/>      "Type" : "AWS::EC2::InternetGateway",<br/>      "Properties" : {<br/>        "Tags" : [<br/>          {"Key" : "Name", "Value" : { "Fn::Join" : [ "-", [ {"Ref" : "AWS::StackName"}, "igw"] ] } }<br/>        ]<br/>      }<br/>    },<br/>    <br/>    "AttachGateway" : {<br/>       "Type" : "AWS::EC2::VPCGatewayAttachment",<br/>       "Properties" : {<br/>         "VpcId" : { "Ref" : "VPC" },<br/>         "InternetGatewayId" : { "Ref" : "InternetGateway" }<br/>       }<br/>    }<br/><br/>  },<br/>...</span></pre><p id="8bc2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在其<code class="fe lb lc ld le b">Outputs</code>中添加将InternetGateway ID传递回根堆栈，从根堆栈将它传递到Network AvailabilityZones堆栈，以便为公共子网创建未来的路由表:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="7c5c" class="lu lv iq le b gy na nb l nc nd">...<br/>  "Outputs" : {<br/><br/>    "VPCID" : {<br/>      "Description" : "EKS VPC ID",<br/>      "Value" : { "Ref" : "VPC" }<br/>    },<br/>    "IGWID" : {<br/>      "Description" : "InternetGateway ID",<br/>      "Value" : { "Ref" : "InternetGateway" }<br/>    }<br/><br/>  }<br/>}</span></pre><p id="9e02" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">是时候开始编写网络可用性区域堆栈模板了。</p></div><div class="ab cl ln lo hu lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ij ik il im in"><h2 id="44af" class="lu lv iq bd lw lx ly dn lz ma mb dp mc kf md me mf kj mg mh mi kn mj mk ml mm bi translated">网络可用性区域堆栈</h2><p id="bb98" class="pw-post-body-paragraph ju jv iq jw b jx mn jz ka kb mo kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">现在，我们需要指定要在两个AvailabilityZones上复制的资源。</p><p id="3f04" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">其中包括:</p><ol class=""><li id="7d0b" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr ll ky kz la bi translated">通过一个公共子网</li><li id="996c" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">通过一个私有子网</li><li id="f816" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">公共子网的路由表</li><li id="aee5" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">通过互联网网关路由到0.0.0.0/0网络</li><li id="3380" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">以及一个subnetroutetable关联，用于将RouteTable附加到该AvailabilityZone中的公共子网</li><li id="89aa" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">专用子网的路由表</li><li id="3d16" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">有一条通过NAT网关到0.0.0.0/0网络的路由</li><li id="8607" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">以及一个subnetroutetable关联，用于将RouteTable附加到该AvailabilityZone中的私有子网</li><li id="b0bc" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">NAT网关</li><li id="108e" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">NAT网关的弹性IP</li></ol><p id="2482" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里的主要问题是如何为这些堆栈选择AvailabilityZone，因为有些资源，如<code class="fe lb lc ld le b">AWS::EC2::Subnet</code>需要指定availability zone。</p><p id="1d41" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">可能的解决方案是使用<code class="fe lb lc ld le b"><a class="ae lk" href="https://rtfm.co.ua/goto/https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-getavailabilityzones.html" rel="noopener ugc nofollow" target="_blank">Fn::GetAZs</a></code>colu formation函数，该函数将从根堆栈中调用，以获取用于集群的区域的所有AvailabilityZones，然后将它们传递给我们的NetworkAvailabilityZones-stacks。</p><p id="73e7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">大多数地区有三个AvailabilityZones，但在这种情况下，将只使用两个(对于容错来说足够公平)。</p><p id="7f7c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们从子网开始—在两个可用性区域中，一个是公共的，一个是私有的。</p><p id="d422" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这个堆栈中，我们需要传递几个新参数:</p><ul class=""><li id="d8c8" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated">区域堆栈中的VPC ID</li><li id="7dc2" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated">公共子网CIDR块</li><li id="6a0c" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated">专用子网CIDR块</li><li id="6114" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated">要在其中创建资源的可用性区域</li><li id="1e27" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated">用于路由表的区域堆栈中的Internet网关ID</li></ul><p id="1983" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建一个新的模板文件，命名为<code class="fe lb lc ld le b">eks-azs-networking.json</code>。</p><p id="8cd8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因素</p><p id="0dd4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在此添加参数:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="f1f4" class="lu lv iq le b gy na nb l nc nd">{<br/>  "AWSTemplateFormatVersion" : "2010-09-09",<br/>  "Description" : "AWS CloudFormation AvailabilityZones Networking stack for Kubernetes cluster",<br/><br/>  "Parameters" : {<br/>    "VPCID": {<br/>      "Description": "VPC for resources",<br/>      "Type": "String"<br/>    },<br/>    "EKSClusterName": {<br/>      "Description": "EKS cluster name",<br/>      "Type": "String"<br/>    },<br/>    "PublicSubnetCIDR": {<br/>      "Description": "PublicSubnetCIDR",<br/>      "Type": "String"<br/>    },<br/>    "PrivateSubnetCIDR": {<br/>      "Description": "PrivateSubnetCIDR",<br/>      "Type": "String"<br/>    },<br/>    "AZ": {<br/>      "Description": "AvailabilityZone for resources",<br/>      "Type": "String"<br/>    },<br/>    "IGWID": {<br/>      "Description": "InternetGateway for PublicRoutes",<br/>      "Type": "String"<br/>    }<br/>  },</span></pre><p id="63fb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">子网</p><p id="8c2f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加带有两种资源的<code class="fe lb lc ld le b">Resources</code>部分——公共和私有子网:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="eeab" class="lu lv iq le b gy na nb l nc nd">...<br/>"Resources" : {<br/>  <br/>  "PublicSubnet" : {<br/>    "Type" : "AWS::EC2::Subnet",<br/>    "Properties" : {<br/>      "VpcId" : { "Ref" : "VPCID" },<br/>      "CidrBlock" : {"Ref" : "PublicSubnetCIDR"},<br/>      "AvailabilityZone" : { "Ref": "AZ" },<br/>      "Tags" : [<br/>        {<br/>          "Key" : "Name",<br/>          "Value" : { "Fn::Join" : [ "-", [ {"Ref" : "AWS::StackName"}, "public-net", { "Ref": "AZ" } ] ] }<br/>        },<br/>        {<br/>          "Key" : { "Fn::Join" : [ "", [ "kubernetes.io/cluster/", {"Ref" : "EKSClusterName"}] ] },<br/>          "Value" : "shared"<br/>        },<br/>        {<br/>          "Key" : "kubernetes.io/role/elb",<br/>          "Value" : "1"<br/>        }<br/>      ]<br/>    }<br/>  },<br/>  <br/>  "PrivateSubnet" : {<br/>    "Type" : "AWS::EC2::Subnet",<br/>    "Properties" : {<br/>      "VpcId" : { "Ref" : "VPCID" },<br/>      "CidrBlock" : {"Ref" : "PrivateSubnetCIDR"},<br/>      "AvailabilityZone" : { "Ref": "AZ" },<br/>      "Tags" : [<br/>        {<br/>          "Key" : "Name",<br/>          "Value" : { "Fn::Join" : [ "-", [ {"Ref" : "AWS::StackName"}, "private-net", { "Ref": "AZ" } ] ] }<br/>        },<br/>        {<br/>          "Key" : { "Fn::Join" : [ "", [ "kubernetes.io/cluster/", {"Ref" : "EKSClusterName"}] ] },<br/>          "Value" : "shared"<br/>        },<br/>        {<br/>          "Key" : "kubernetes.io/role/internal-elb",<br/>          "Value" : "1"<br/>        }<br/>      ]<br/>    }<br/>  }<br/>  <br/>},</span></pre><p id="b3bb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">注意公共子网的<code class="fe lb lc ld le b">"kubernetes.io/role/elb"</code>标签和私有子网的<code class="fe lb lc ld le b">"kubernetes.io/role/internal-elb"</code>标签——稍后<a class="ae lk" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-running-alb-ingress-controller/" rel="noopener ugc nofollow" target="_blank"> ALB入口控制器</a>会用到它们。</p><p id="baf3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<code class="fe lb lc ld le b">Outputs</code>上，添加subnets-ID以将它们传递给根栈，使它们可用于Ansible为未来的集群创建一个<code class="fe lb lc ld le b">eksctl</code>配置文件，并在此处添加一个AvailabilityZone:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="9566" class="lu lv iq le b gy na nb l nc nd">...<br/>  "Outputs" : {<br/>    <br/>    "StackAZ" : {<br/>      "Description" : "Stack location",<br/>      "Value" : { "Ref" : "AZ" }<br/>    },<br/>    "PublicSubnetID" : {<br/>      "Description" : "PublicSubnet ID",<br/>      "Value" : { "Ref" : "PublicSubnet" }<br/>    },<br/>    "PrivateSubnetID" : {<br/>      "Description" : "PrivateSubnet ID",<br/>      "Value" : { "Ref" : "PrivateSubnet" }<br/>    }<br/>    <br/>  }<br/>}</span></pre><p id="512a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">返回到根模板，再添加两个要创建的资源——每个AvailabilityZone一个堆栈，因此它的<code class="fe lb lc ld le b">Resources</code>必须看起来像下一个:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="2ca9" class="lu lv iq le b gy na nb l nc nd">...<br/>  "Resources": {<br/><br/>    "RegionNetworkStack": {<br/>      "Type": "AWS::CloudFormation::Stack",<br/>      "Properties": {<br/>        "TemplateURL": "eks-region-networking.json",<br/>        "Parameters": {<br/>          "VPCCIDRBlock": { "Ref": "VPCCIDRBlock" },<br/>          "EKSClusterName": { "Ref": "EKSClusterName"}<br/>        }<br/>      }<br/>    },<br/><br/>    "AZNetworkStackA": {<br/>      "Type": "AWS::CloudFormation::Stack",<br/>      "Properties": {<br/>        "TemplateURL": "eks-azs-networking.json",<br/>        "Parameters": {<br/>          "VPCID": { "Fn::GetAtt": ["RegionNetworkStack", "Outputs.VPCID"] },<br/>          "AZ": { "Fn::Select": [ "0", { "Fn::GetAZs": "" } ] },<br/>          "IGWID": { "Fn::GetAtt": ["RegionNetworkStack", "Outputs.IGWID"] },<br/>          "EKSClusterName": { "Ref": "EKSClusterName"},<br/>          "PublicSubnetCIDR": "10.0.0.0/20",<br/>          "PrivateSubnetCIDR": "10.0.32.0/20"<br/>        }<br/>      }<br/>    },<br/>    "AZNetworkStackB": {<br/>      "Type": "AWS::CloudFormation::Stack",<br/>      "Properties": {<br/>        "TemplateURL": "eks-azs-networking.json",<br/>        "Parameters": {<br/>          "VPCID": { "Fn::GetAtt": ["RegionNetworkStack", "Outputs.VPCID"] },<br/>          "AZ": { "Fn::Select": [ "1", { "Fn::GetAZs": "" } ] },<br/>          "IGWID": { "Fn::GetAtt": ["RegionNetworkStack", "Outputs.IGWID"] },<br/>          "EKSClusterName": { "Ref": "EKSClusterName"},<br/>          "PublicSubnetCIDR": "10.0.16.0/20",<br/>          "PrivateSubnetCIDR": "10.0.48.0/20"<br/>        }<br/>      }<br/>    }<br/><br/>  },<br/>...</span></pre><p id="6848" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">互联网网关ID将从区域堆栈的<code class="fe lb lc ld le b">Outputs</code>中获取，并通过<code class="fe lb lc ld le b">Parameters</code>传递给<code class="fe lb lc ld le b">AZNetworkStackА</code> и <code class="fe lb lc ld le b">AZNetworkStackB</code>用于公共子网路由。</p><p id="709c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">CIDR现在可以被硬编码——稍后我们将使用<code class="fe lb lc ld le b">Mappings</code>。</p><p id="7941" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以，在上面的代码中:</p><ul class=""><li id="e0ee" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated"><code class="fe lb lc ld le b">Fn::GetAZs"VPCID": { "Fn::GetAtt": ["RegionNetworkStack", "Outputs.VPCID"] }</code> —将VPD ID从区域堆栈传递到AZ堆栈</li><li id="3f4c" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><code class="fe lb lc ld le b">"AZ": { "Fn::Select": [ "0", { "Fn::GetAZs": "" } ] }</code> —从AvailabilityZones列表中选择第一个元素(index " <em class="lm"> 0 </em>")，并为第二个堆栈选择第二个元素(index " <em class="lm"> 1 </em>")</li><li id="ef39" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><code class="fe lb lc ld le b">PublicSubnetCIDR</code>和<code class="fe lb lc ld le b">PrivateSubnetCIDR</code>是硬编码的</li></ul><p id="157a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，将AvailabilityZones-stack中的subnets-ID添加到根堆栈<code class="fe lb lc ld le b">Outputs</code>中，以使Ansible可用于<code class="fe lb lc ld le b">eksctl</code>参数:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="91b2" class="lu lv iq le b gy na nb l nc nd">...<br/>  "Outputs": {<br/><br/>    "VPCID" : {<br/>      "Description" : "EKS VPC ID",<br/>      "Value" : { "Fn::GetAtt": ["RegionNetworkStack", "Outputs.VPCID"] }<br/>    },<br/>    "AStackAZ" : {<br/>      "Description" : "Stack location",<br/>      "Value" : { "Fn::GetAtt": ["AZNetworkStackA", "Outputs.StackAZ"] }<br/>    },<br/>    "APublicSubnetID" : {<br/>      "Description" : "PublicSubnet ID",<br/>      "Value" : { "Fn::GetAtt": ["AZNetworkStackA", "Outputs.PublicSubnetID"] }<br/>    },<br/>    "APrivateSubnetID" : {<br/>      "Description" : "PrivateSubnet ID",<br/>      "Value" : { "Fn::GetAtt": ["AZNetworkStackA", "Outputs.PrivateSubnetID"] }<br/>    },<br/>    "BStackAZ" : {<br/>      "Description" : "Stack location",<br/>      "Value" : { "Fn::GetAtt": ["AZNetworkStackB", "Outputs.StackAZ"] }<br/>    },<br/>    "BPublicSubnetID" : {<br/>      "Description" : "PublicSubnet ID",<br/>      "Value" : { "Fn::GetAtt": ["AZNetworkStackB", "Outputs.PublicSubnetID"] }<br/>    },<br/>    "BPrivateSubnetID" : {<br/>      "Description" : "PrivateSubnet ID",<br/>      "Value" : { "Fn::GetAtt": ["AZNetworkStackB", "Outputs.PrivateSubnetID"] }<br/>    }<br/><br/>  }<br/>}</span></pre><p id="95f5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">打包它，生成一个新的模板为<code class="fe lb lc ld le b">/tmp/packed-eks-stacks.json</code>:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="2771" class="lu lv iq le b gy na nb l nc nd">$ aws --profile arseniy --region eu-west-2 cloudformation package --template-file eks-root.json --output-template /tmp/packed-eks-stacks.json --s3-bucket eks-cloudformation-eu-west-2 --use-json</span></pre><p id="b488" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">部署它:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="ab04" class="lu lv iq le b gy na nb l nc nd">$ aws --profile arseniy --region eu-west-2 cloudformation deploy --template-file /tmp/packed-eks-stacks.json --stack-name eks-dev</span></pre><p id="d29f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi ne"><img src="../Images/95deb294562f51fae321f6eb74308583.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hSEDzlItnO5yh0xE.png"/></div></div></figure><p id="1f72" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好吧。</p><p id="c672" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们在这里结束—需要添加以下内容:</p><ol class=""><li id="1833" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr ll ky kz la bi translated">公共子网的路由表</li></ol><ul class=""><li id="fb20" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated">通过Internet网关到0.0.0.0/0的路由</li><li id="b197" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated">以及一个subnetroutetable关联，用于将该RouteTable附加到该AvailabilityZone中的公共子网</li></ul><ol class=""><li id="2e73" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr ll ky kz la bi translated">专用子网的路由表</li></ol><ul class=""><li id="95c3" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated">通过NAT网关到0.0.0.0/0的路由</li><li id="596e" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated">以及一个subnetroutetable关联，用于将该路由表附加到该可用性区域中的专用子网</li></ul><ol class=""><li id="ad3b" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr ll ky kz la bi translated">NAT网关</li></ol><ul class=""><li id="613c" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated">NAT网关的弹性IP</li></ul><p id="e068" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">NAT网关</p><p id="496e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">到<code class="fe lb lc ld le b">Resources</code> -添加NAT网关和弹性IP:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="27ad" class="lu lv iq le b gy na nb l nc nd">...<br/>    "NatGwIPAddress" : {<br/>      "Type" : "AWS::EC2::EIP",<br/>      "Properties" : {<br/>        "Domain" : "vpc"<br/>      }<br/>    },<br/><br/>    "NATGW" : {<br/>      "DependsOn" : "NatGwIPAddress",<br/>      "Type" : "AWS::EC2::NatGateway",<br/>      "Properties" : {<br/>        "AllocationId" : { "Fn::GetAtt" : ["NatGwIPAddress", "AllocationId"]},<br/>        "SubnetId" : { "Ref" : "PublicSubnet"},<br/>        "Tags" : [<br/>          {"Key" : "Name", "Value" : { "Fn::Join" : [ "-", [ {"Ref" : "AWS::StackName"}, "nat-gw", { "Ref": "AZ" } ] ] } }<br/>        ]<br/>      }<br/>    }<br/>...</span></pre><p id="b5ea" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">公共路由表</p><p id="86bb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为公共子网添加路由表。</p><p id="e29d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于公共路由，我们需要一个Internet网关ID，它从区域堆栈传递到根堆栈，然后传递到AvailabilityZones-stack。</p><p id="11f5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加一个RouteTable，一个通过互联网网关到<em class="lm"> 0.0.0.0/0 </em>的路由和一个subnetroutetable关联:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="1edb" class="lu lv iq le b gy na nb l nc nd">...<br/>    "PublicRouteTable": {<br/>      "Type": "AWS::EC2::RouteTable",<br/>      "Properties": {<br/>        "VpcId": { "Ref": "VPCID" },<br/>        "Tags" : [<br/>          {"Key" : "Name", "Value" : { "Fn::Join" : [ "-", [ {"Ref" : "AWS::StackName"}, "public-rtb"] ] } }<br/>        ]<br/>      }<br/>    },<br/>    <br/>    "PublicRoute": {<br/>      "Type": "AWS::EC2::Route",<br/>      "Properties": {<br/>        "RouteTableId": {<br/>          "Ref": "PublicRouteTable"<br/>        },<br/>        "DestinationCidrBlock": "0.0.0.0/0",<br/>        "GatewayId": {<br/>          "Ref": "IGWID"<br/>        }<br/>      }<br/>    },<br/>    <br/>    "PublicSubnetRouteTableAssociation": {<br/>      "Type": "AWS::EC2::SubnetRouteTableAssociation",<br/>      "DependsOn": "PublicRouteTable",<br/>      "Properties": {<br/>        "SubnetId": {<br/>          "Ref": "PublicSubnet"<br/>        },<br/>        "RouteTableId": {<br/>          "Ref": "PublicRouteTable"<br/>        }<br/>      }<br/>    }<br/>...</span></pre><p id="69c3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">私有路由表</p><p id="2902" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">类似地，在AvailabilityZones堆栈中添加一个RouteTable及其资源，但是在Route中使用NAT网关而不是Internet网关:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="6ef2" class="lu lv iq le b gy na nb l nc nd">...<br/>    "PrivateRouteTable": {<br/>      "Type": "AWS::EC2::RouteTable",<br/>      "Properties": {<br/>        "VpcId": { "Ref": "VPCID" },<br/>        "Tags" : [<br/>          {"Key" : "Name", "Value" : { "Fn::Join" : [ "-", [ {"Ref" : "AWS::StackName"}, "priv-route", { "Ref": "AZ" } ] ] } }<br/>        ]<br/>      }<br/>    },<br/>    <br/>    "PrivateRoute": {<br/>      "Type": "AWS::EC2::Route",<br/>      "Properties": {<br/>        "RouteTableId": {<br/>          "Ref": "PrivateRouteTable"<br/>        },<br/>        "DestinationCidrBlock": "0.0.0.0/0",<br/>        "NatGatewayId": {<br/>          "Ref": "NATGW"<br/>        }<br/>      }<br/>    },<br/>    <br/>    "PrivateSubnetRouteTableAssociation": {<br/>      "Type": "AWS::EC2::SubnetRouteTableAssociation",<br/>      "Properties": {<br/>        "SubnetId": {<br/>          "Ref": "PrivateSubnet"<br/>        },<br/>        "RouteTableId": {<br/>          "Ref": "PrivateRouteTable"<br/>        }<br/>      }<br/>    }<br/>...</span></pre><p id="563c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">打包、部署、检查:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nj"><img src="../Images/36f6e153a5e4cbccf60c795cb7c16ec7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*irPv0RK83faTZPlF.png"/></div></div></figure><p id="9aa2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">太好了——所有网络和路由都启动了——现在一切都正常了</p><p id="976d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此时，我们可以在公共和私有子网中启动EC2实例，以检查:</p><ol class=""><li id="3119" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr ll ky kz la bi translated">SSH到公共子网中的ес2，检查其网络连接是否正常</li><li id="7472" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated">从公共子网中的ес2到私有子网中的EC2的SSH，用于检查私有子网的路由</li><li id="556c" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr ll ky kz la bi translated"><code class="fe lb lc ld le b">ping</code>从EC2到世界某处的私有子网检查NAT是否工作</li></ol></div><div class="ab cl ln lo hu lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ij ik il im in"><h2 id="a63f" class="lu lv iq bd lw lx ly dn lz ma mb dp mc kf md me mf kj mg mh mi kn mj mk ml mm bi translated">子网的映射和CIDRs</h2><p id="b5c9" class="pw-post-body-paragraph ju jv iq jw b jx mn jz ka kb mo kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">我想在AvailabilityZones堆栈中更改的另一件事是实现一种更好的方法来为子网创建和传递CIDRs。</p><p id="35e5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，目前，我们正在向 <code class="fe lb lc ld le b">VPCCIDRBlock</code>参数传递一个完整的CIDR，如<em class="lm"> 10.0.0.0/16:</em></p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="54cb" class="lu lv iq le b gy na nb l nc nd">...<br/>    "VPCCIDRBlock": {<br/>      "Description": "VPC CidrBlock",<br/>      "Type": "String",<br/>      "Default": "10.0.0.0/16"<br/>    }<br/>...</span></pre><p id="5258" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后，我们需要使用/20掩码创建4个专用网络，两个用于公共子网，两个用于私有子网。</p><p id="1be6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，此时我们只是将这些值硬编码到模板中:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="6388" class="lu lv iq le b gy na nb l nc nd">...<br/>        "Parameters": {<br/>          "VPCID": { "Fn::GetAtt": ["RegionNetworkStack", "Outputs.VPCID"] },<br/>          "AZ": { "Fn::Select": [ "0", { "Fn::GetAZs": "" } ] },<br/>          "IGWID": { "Fn::GetAtt": ["RegionNetworkStack", "Outputs.IGWID"] },<br/>          "PublicSubnetCIDR": "10.0.0.0/20",<br/>          "PrivateSubnetCIDR": "10.0.32.0/20"<br/>        }<br/>...</span></pre><p id="a093" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这显然不是一个太好的主意，因为我们没有任何灵活性，因为我们希望有一个来自Jenkins参数的能力，只需要VPC的一个街区，让CloufFomration做所有剩下的事情。</p><p id="abf9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们看看，对于一个带有<em class="lm"> 10.0.0.0/16 </em>块的VPC，我们必须组成这样的4个网络<em class="lm"> /20 </em>:</p><ul class=""><li id="b222" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated"><em class="lm"> 10.0 </em> —前两个二进制八位数，网络“开始”</li><li id="7f4e" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated">第三个八位字节块— <em class="lm"> 0 </em>、<em class="lm"> 16 </em>、<em class="lm"> 32 </em>、<em class="lm"> 48 </em></li><li id="faa0" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated">以及网络mas — <em class="lm"> /20 </em></li></ul><p id="90eb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，我们还将为开发、阶段、生产等环境提供CIDRs为<em class="lm"> 10.0.0.0/16 </em>、<em class="lm"> 10.1.0.0/16 </em>、<em class="lm"> 10.2.0.0/16 </em>的VPC。</p><p id="192f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">怎么才能把上面的数据都结合起来呢？</p><p id="6cb3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">嗯——我们可以使用<code class="fe lb lc ld le b"><a class="ae lk" href="https://rtfm.co.ua/goto/https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-split.html" rel="noopener ugc nofollow" target="_blank">Fn::Split</a></code>函数从VPC CIDR中得到前两个八位字节——将得到<em class="lm"> 10.0 </em>。或<em class="lm"> 10.1 </em>等。</p><p id="e07b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是如果一辆VPC CIDR会是<em class="lm"> 192.168.0.0/16 </em>呢？…嗯，那么我们必须获取前两个八位字节作为专用对象。</p><p id="3cbd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于剩余的两个八位字节和子网掩码，我们可以创建一个云形<code class="fe lb lc ld le b"><a class="ae lk" href="https://rtfm.co.ua/goto/https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/mappings-section-structure.html" rel="noopener ugc nofollow" target="_blank">Mappings</a></code>，然后使用<code class="fe lb lc ld le b"><a class="ae lk" href="https://rtfm.co.ua/goto/https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-join.html" rel="noopener ugc nofollow" target="_blank">Fn::Join</a></code>函数将它们组合在一起。</p><p id="2d1a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们来试试——向根堆栈模板添加映射:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="e6d1" class="lu lv iq le b gy na nb l nc nd">...<br/>  "Mappings": {<br/><br/>    "AZSubNets": {<br/>      "public": {<br/>        "zoneA": "0.0/20",<br/>        "zoneB": "16.0/20"<br/>      },<br/>      "private": {<br/>        "zoneA": "32.0/20",<br/>        "zoneB": "48.0/20"<br/>      }<br/>    }<br/>  },<br/>...</span></pre><p id="2398" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">而现在这里最有趣的部分:在<code class="fe lb lc ld le b">AZNetworkStackА</code>和<code class="fe lb lc ld le b">AZNetworkStackB</code>资源的根模板中用它们的<code class="fe lb lc ld le b">Parameters</code>代替了:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="06b9" class="lu lv iq le b gy na nb l nc nd">...<br/>"PublicSubnetCIDR": "10.0.0.0/20",<br/>...</span></pre><p id="e2a0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">需要构建类似这样的东西:</p><p id="2725" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="lm">&lt;VPC-CIDR-第一个八位字节&gt;+&lt;VPC-CIDR-第二个八位字节&gt;+&lt;ZONE-FROM-MAPPING&gt;</em></p><p id="852e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">即:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="5cc4" class="lu lv iq le b gy na nb l nc nd">{ «Fn::Join» : [ «.», [ { «VPC-CIDR-FIRST-TWO-OCTETS» ] }, «AONE-FROM-MAPPING»] ] } }</span></pre><p id="1142" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用<code class="fe lb lc ld le b"><a class="ae lk" href="https://rtfm.co.ua/goto/https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-select.html" rel="noopener ugc nofollow" target="_blank">Fn::Select</a></code>和<code class="fe lb lc ld le b"><a class="ae lk" href="https://rtfm.co.ua/goto/https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-split.html" rel="noopener ugc nofollow" target="_blank">Fn::Split</a></code>函数获得<em class="lm"> VPC-CIDR第一八位组</em>:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="a518" class="lu lv iq le b gy na nb l nc nd">{ «Fn::Select» : [ «0», { «Fn::Split»: [«.», { «Ref»: «VPCCIDRBlock»}]}] }</span></pre><p id="a50d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">与第二种方法相同，但在<code class="fe lb lc ld le b"><a class="ae lk" href="https://rtfm.co.ua/goto/https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-select.html" rel="noopener ugc nofollow" target="_blank">Fn::Select</a></code>中使用索引<em class="lm"> 1 </em>:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="a8d7" class="lu lv iq le b gy na nb l nc nd">{ «Fn::Select» : [ «1», { «Fn::Split»: [«.», { «Ref»: «VPCCIDRBlock»}]}] }</span></pre><p id="f3e1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了从映射中选择数据，我们可以使用<code class="fe lb lc ld le b"><a class="ae lk" href="https://rtfm.co.ua/goto/https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-findinmap.html" rel="noopener ugc nofollow" target="_blank">Fn::FindInMap</a></code>，这里我们将使用子网的类型<em class="lm"> public </em>或<em class="lm"> private </em>，并通过AvailabilityZone进行选择:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="5ee0" class="lu lv iq le b gy na nb l nc nd">{ «Fn::FindInMap» : [ «AZSubNets», «public», «zone-a»» ] }</span></pre><p id="bfaa" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以，对于<code class="fe lb lc ld le b">AZNetworkStackА</code>我们会有如下代码:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="a993" class="lu lv iq le b gy na nb l nc nd">...<br/>          "PublicSubnetCIDR": {<br/>            "Fn::Join" : [".", [<br/>              { "Fn::Select": [ "0", { "Fn::Split": [".",  { "Ref": "VPCCIDRBlock"} ] } ] },<br/>              { "Fn::Select": [ "1", { "Fn::Split": [".",  { "Ref": "VPCCIDRBlock"} ] } ] },<br/>              { "Fn::FindInMap" : [ "AZSubNets", "public", "zoneA" ] } <br/>            ]]<br/>          },                  <br/>          "PrivateSubnetCIDR": { <br/>            "Fn::Join" : [".", [<br/>              { "Fn::Select": [ "0", { "Fn::Split": [".",  { "Ref": "VPCCIDRBlock"} ] } ] },<br/>              { "Fn::Select": [ "1", { "Fn::Split": [".",  { "Ref": "VPCCIDRBlock"} ] } ] },<br/>              { "Fn::FindInMap" : [ "AZSubNets", "private", "zoneA" ] } <br/>            ]]<br/>          }<br/>..</span></pre><p id="b7aa" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于<code class="fe lb lc ld le b">{ "Fn::FindInMap" : [ "AZSubNets", "private", "zoneA" ] }</code>中的<code class="fe lb lc ld le b">AZNetworkStackB</code>将使用<em class="lm">区域B </em>选择器。</p><p id="f78c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">总的来说，我们的堆栈资源必须如下所示:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="08d9" class="lu lv iq le b gy na nb l nc nd">...<br/>    "AZNetworkStackA": {<br/>      "Type": "AWS::CloudFormation::Stack",<br/>      "Properties": {<br/>        "TemplateURL": "eks-azs-networking.json",<br/>        "Parameters": {<br/>          "VPCID": { "Fn::GetAtt": ["RegionNetworkStack", "Outputs.VPCID"] },<br/>          "AZ": { "Fn::Select": [ "0", { "Fn::GetAZs": "" } ] },<br/>          "IGWID": { "Fn::GetAtt": ["RegionNetworkStack", "Outputs.IGWID"] },<br/>          "EKSClusterName": { "Ref": "EKSClusterName"},<br/>          "PublicSubnetCIDR": {<br/>            "Fn::Join" : [".", [<br/>              { "Fn::Select": [ "0", { "Fn::Split": [".",  { "Ref": "VPCCIDRBlock"} ] } ] },<br/>              { "Fn::Select": [ "1", { "Fn::Split": [".",  { "Ref": "VPCCIDRBlock"} ] } ] },<br/>              { "Fn::FindInMap" : [ "AZSubNets", "public", "zoneA" ] }<br/>            ]]<br/>          },<br/>          "PrivateSubnetCIDR": {<br/>            "Fn::Join" : [".", [<br/>              { "Fn::Select": [ "0", { "Fn::Split": [".",  { "Ref": "VPCCIDRBlock"} ] } ] },<br/>              { "Fn::Select": [ "1", { "Fn::Split": [".",  { "Ref": "VPCCIDRBlock"} ] } ] },<br/>              { "Fn::FindInMap" : [ "AZSubNets", "private", "zoneA" ] }<br/>            ]]<br/>          }<br/>        }<br/>      }<br/>    },<br/>    "AZNetworkStackB": {<br/>      "Type": "AWS::CloudFormation::Stack",<br/>      "Properties": {<br/>        "TemplateURL": "eks-azs-networking.json",<br/>        "Parameters": {<br/>          "VPCID": { "Fn::GetAtt": ["RegionNetworkStack", "Outputs.VPCID"] },<br/>          "AZ": { "Fn::Select": [ "1", { "Fn::GetAZs": "" } ] },<br/>          "IGWID": { "Fn::GetAtt": ["RegionNetworkStack", "Outputs.IGWID"] },<br/>          "EKSClusterName": { "Ref": "EKSClusterName"},<br/>          "PublicSubnetCIDR": {<br/>            "Fn::Join" : [".", [<br/>              { "Fn::Select": [ "0", { "Fn::Split": [".",  { "Ref": "VPCCIDRBlock"} ] } ] },<br/>              { "Fn::Select": [ "1", { "Fn::Split": [".",  { "Ref": "VPCCIDRBlock"} ] } ] },<br/>              { "Fn::FindInMap" : [ "AZSubNets", "public", "zoneB" ] }<br/>            ]]<br/>          },<br/>          "PrivateSubnetCIDR": {<br/>            "Fn::Join" : [".", [<br/>              { "Fn::Select": [ "0", { "Fn::Split": [".",  { "Ref": "VPCCIDRBlock"} ] } ] },<br/>              { "Fn::Select": [ "1", { "Fn::Split": [".",  { "Ref": "VPCCIDRBlock"} ] } ] },<br/>              { "Fn::FindInMap" : [ "AZSubNets", "private", "zoneB" ] }<br/>            ]]<br/>          }<br/>        }<br/>      }<br/>    }<br/>...</span></pre><p id="2141" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">部署，检查:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nk"><img src="../Images/daba632c756025369160dc3450e0681c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lhthAaDwnZrUyjNN.png"/></div></div></figure><p id="b6d3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">实际上什么都没有改变，因为我们的CIDRs和改变前一样。</p></div><div class="ab cl ln lo hu lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ij ik il im in"><h2 id="b1a6" class="lu lv iq bd lw lx ly dn lz ma mb dp mc kf md me mf kj mg mh mi kn mj mk ml mm bi translated"><code class="fe lb lc ld le b">eksctl</code> -堆栈创建</h2><p id="95ac" class="pw-post-body-paragraph ju jv iq jw b jx mn jz ka kb mo kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">最后——让我们启动一个测试集群来检查一切是否正常，然后我们可以进入Ansible及其角色。</p><p id="01db" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从根堆栈的<code class="fe lb lc ld le b">Outputs</code>中获取必要的参数:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nl"><img src="../Images/7c081e87a35ecd1c556250c6a6741219.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*aoTuiXHfpfpL-Hsd.png"/></div></div></figure><p id="61c5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们现在可以为未来的Ansible <code class="fe lb lc ld le b">eksctl</code> rile创建目录，就像我们在这篇文章开始时为CloudFormation所做的一样:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="2c03" class="lu lv iq le b gy na nb l nc nd">$ cd ../../../<br/>$ mkdir -p roles/eksctl/{templates,tasks}</span></pre><p id="e7d6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，创建一个集群的配置文件<code class="fe lb lc ld le b">eks-cluster-config.yml</code>:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="cf36" class="lu lv iq le b gy na nb l nc nd">$ touch roles/eksctl/templates/eks-cluster-config.yml<br/>$ cd roles/eksctl/templates/</span></pre><p id="5eaf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在此设置集群的参数:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="273e" class="lu lv iq le b gy na nb l nc nd">apiVersion: eksctl.io/v1alpha5<br/>kind: ClusterConfig<br/>metadata:<br/>  name: eks-dev<br/>  region: eu-west-2<br/>  version: "1.15"<br/>nodeGroups:<br/>  - name: worker-nodes<br/>    instanceType: t3.medium<br/>    desiredCapacity: 2<br/>    privateNetworking: true<br/>vpc:<br/>  id: "vpc-00f7f307d5c7ae70d"<br/>  subnets:<br/>    public:<br/>      eu-west-2a:<br/>        id: "subnet-06e8424b48709425a"<br/>      eu-west-2b:<br/>        id: "subnet-07a23a9e23cbb382a"<br/>    private:<br/>      eu-west-2a:<br/>        id: "subnet-0c8a44bdc9aa6726f"<br/>      eu-west-2b:<br/>        id: "subnet-026c14589f4a41900"<br/>  nat:<br/>    gateway: Disable<br/>cloudWatch:<br/>  clusterLogging:<br/>    enableTypes: ["*"]</span></pre><p id="e37e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建集群:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="98bb" class="lu lv iq le b gy na nb l nc nd">$ eksctl --profile arseniy create cluster -f eks-cluster-config.yml</span></pre><p id="59ed" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这里注意一下<code class="fe lb lc ld le b">eksctl</code>使用的名称——它将附加<em class="lm">eks CTL</em>+<em class="lm">+&lt;CLUSTER-NAME&gt;</em>+<em class="lm">CLUSTER</em>作为集群的名称——当我们开始编写可转换的角色时，请考虑这一点。</p><p id="6f44" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">启动AWS Elastic Kubernetes服务集群的过程大约需要15-20分钟，在云形成之后，将为工作节点创建另一个堆栈，因此我们可以在这里喝点茶(或啤酒)。</p><p id="d2d8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">等待工作节点启动:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="ca21" class="lu lv iq le b gy na nb l nc nd">…<br/>[ℹ] nodegroup “worker-nodes” has 2 node(s)<br/>[ℹ] node “ip-10–0–40–30.eu-west-2.compute.internal” is ready<br/>[ℹ] node “ip-10–0–63–187.eu-west-2.compute.internal” is ready<br/>[ℹ] kubectl command should work with “/home/setevoy/.kube/config”, try ‘kubectl get nodes’<br/>[✔] EKS cluster “eks-dev” in “eu-west-2” region is ready</span></pre><p id="ca29" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nl"><img src="../Images/029892d7398c86acebb69a3903457fd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5CrLg279TzfRKzeb.png"/></div></div></figure><p id="ad61" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">堆栈和集群准备就绪。</p><p id="5b71" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们的本地<code class="fe lb lc ld le b">kubectl</code>已经必须由<code class="fe lb lc ld le b">eksctl</code>配置-检查当前上下文:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="4411" class="lu lv iq le b gy na nb l nc nd">$ kubectl config current-context<br/>arseniy@eks-dev.eu-west-2.eksctl.io</span></pre><p id="7063" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查对群集及其节点的访问:</p><pre class="ms mt mu mv gt mw le mx my aw mz bi"><span id="ce26" class="lu lv iq le b gy na nb l nc nd">$ kubectl get nodes<br/>NAME STATUS ROLES AGE VERSION<br/>ip-10–0–40–30.eu-west-2.compute.internal Ready &lt;none&gt; 84s v1.15.10-eks-bac369<br/>ip-10–0–63–187.eu-west-2.compute.internal Ready &lt;none&gt; 81s v1.15.10-eks-bac369</span></pre><p id="8819" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好了，现在就这些——我们已经完成了云的形成。</p><p id="4946" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">第二部分—<a class="ae lk" href="https://rtfm.co.ua/aws-elastic-kubernetes-service-avtomatizaciya-sozdaniya-klastera-chast-2-ansible-eksctl/" rel="noopener ugc nofollow" target="_blank">AWS:elastic kubernetes service—автоматизациясозданиякластера，часть 2 — Ansible，eksctl </a>(暂为俄文，不久将翻译)。</p><h2 id="cdd8" class="lu lv iq bd lw lx ly dn lz ma mb dp mc kf md me mf kj mg mh mi kn mj mk ml mm bi translated">有用的链接</h2><h2 id="70fa" class="lu lv iq bd lw lx ly dn lz ma mb dp mc kf md me mf kj mg mh mi kn mj mk ml mm bi translated">库伯内特斯</h2><ul class=""><li id="fb8e" class="ks kt iq jw b jx mn kb mo kf nm kj nn kn no kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://www.weave.works/blog/introduction-to-kubernetes-pod-networking--part-1" rel="noopener ugc nofollow" target="_blank">Kubernetes Pod网络简介</a></li><li id="8902" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://www.weave.works/technologies/kubernetes-on-aws/" rel="noopener ugc nofollow" target="_blank"> Kubernetes on AWS:部署指南和最佳实践</a></li><li id="bc64" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://rancher.com/learning-paths/how-to-manage-kubernetes-with-kubectl/" rel="noopener ugc nofollow" target="_blank">如何用Kubectl管理Kubernetes】</a></li><li id="42e0" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://kubernetes.io/docs/setup/best-practices/cluster-large/" rel="noopener ugc nofollow" target="_blank">构建大型集群</a></li><li id="a0bc" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://learnk8s.io/production-best-practices" rel="noopener ugc nofollow" target="_blank"> Kubernetes生产最佳实践</a></li></ul><h2 id="1a83" class="lu lv iq bd lw lx ly dn lz ma mb dp mc kf md me mf kj mg mh mi kn mj mk ml mm bi translated">Ansible</h2><ul class=""><li id="2646" class="ks kt iq jw b jx mn kb mo kf nm kj nn kn no kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html" rel="noopener ugc nofollow" target="_blank">最佳实践</a></li><li id="cf5d" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://www.trek10.com/blog/ansible-cloudformation/" rel="noopener ugc nofollow" target="_blank">可行&amp;复杂工作流程的云形成</a></li></ul><h2 id="3d2b" class="lu lv iq bd lw lx ly dn lz ma mb dp mc kf md me mf kj mg mh mi kn mj mk ml mm bi translated">自动警报系统</h2><p id="7102" class="pw-post-body-paragraph ju jv iq jw b jx mn jz ka kb mo kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">EKS</p><ul class=""><li id="5254" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://www.codementor.io/@slavko/kubernetes-cluster-on-aws-eks-lecygk6rl" rel="noopener ugc nofollow" target="_blank">EKS自动气象站上的kubernetes集群</a></li><li id="6691" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://www.stackrox.com/post/2020/02/eks-vs-gke-vs-aks/" rel="noopener ugc nofollow" target="_blank">EKS vs GKE vs AKS——评估云中的Kubernetes</a></li><li id="d62b" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://s3.amazonaws.com/aws-quickstart/quickstart-amazon-eks/doc/amazon-eks-architecture.pdf" rel="noopener ugc nofollow" target="_blank">模块化和可扩展的亚马逊EKS架构</a></li><li id="ee11" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://www.agilepartner.net/en/build-a-kubernetes-cluster-with-eksctl/" rel="noopener ugc nofollow" target="_blank">使用eksctl构建kubernetes集群</a></li><li id="91f5" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://docs.aws.amazon.com/en_us/eks/latest/userguide/sec-group-reqs.html" rel="noopener ugc nofollow" target="_blank">亚马逊EKS安全组注意事项</a></li></ul><p id="c32f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">云的形成</p><ul class=""><li id="ed39" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://programmaticponderings.com/2019/07/30/managing-aws-infrastructure-as-code-using-ansible-cloudformation-and-codebuild/" rel="noopener ugc nofollow" target="_blank">使用Ansible、CloudFormation和CodeBuild将AWS基础设施作为代码进行管理</a></li><li id="5c33" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://cloudacademy.com/blog/understanding-nested-cloudformation-stacks/" rel="noopener ugc nofollow" target="_blank">嵌套CloudFormation堆栈:开发者和系统管理员指南</a></li><li id="fabc" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://medium.com/@janethavishka/walkthrough-with-nested-cloudformation-stacks-d7709b568162" rel="noopener ugc nofollow">嵌套云形成堆栈的演练</a></li><li id="ca03" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://aws.amazon.com/ru/premiumsupport/knowledge-center/cloudformation-parameters-nested-stacks/" rel="noopener ugc nofollow" target="_blank">如何将CommaDelimitedList参数传递给AWS CloudFormation中的嵌套堆栈？</a></li><li id="aa34" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://aws.amazon.com/ru/premiumsupport/knowledge-center/multiple-values-list-parameter-cli/" rel="noopener ugc nofollow" target="_blank">如何在AWS CloudFormation模板中为单个参数使用多个值？</a></li><li id="71c8" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://sanderknape.com/2018/08/two-years-with-cloudformation-lessons-learned/" rel="noopener ugc nofollow" target="_blank">云形成两年:经验教训</a></li><li id="6a56" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://www.jamesqmurphy.com/blog/2019/10/nested-stack" rel="noopener ugc nofollow" target="_blank">用嵌套栈缩小臃肿的云形成模板</a></li><li id="f991" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://sbstjn.com/cloudformation.html#nested-stacks" rel="noopener ugc nofollow" target="_blank">云形成最佳实践</a></li><li id="06ce" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://garbe.io/blog/2017/07/17/cloudformation-hacks/" rel="noopener ugc nofollow" target="_blank"> 7个可怕的云形成黑客</a></li><li id="c733" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://jayendrapatil.com/aws-cloudformation-best-practices-certification/" rel="noopener ugc nofollow" target="_blank"> AWS云信息最佳实践—认证</a></li><li id="da58" class="ks kt iq jw b jx lf kb lg kf lh kj li kn lj kr kx ky kz la bi translated"><a class="ae lk" href="https://rtfm.co.ua/goto/https://blog.shikisoft.com/aws-cloudformation-no-value-pseudo-parameter/" rel="noopener ugc nofollow" target="_blank">使用AWS::NoValue on CloudFormation有条件地定义资源属性</a></li></ul></div><div class="ab cl ln lo hu lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ij ik il im in"><p id="fb9f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="lm">最初发布于</em> <a class="ae lk" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation/" rel="noopener ugc nofollow" target="_blank"> <em class="lm"> RTFM: Linux，devo PSисистемноеадмнииитииовваниование</em></a><em class="lm">。</em></p></div></div>    
</body>
</html>