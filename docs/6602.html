<html>
<head>
<title>Azure Automation Configuring Desired State Configuration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure Automation配置所需的状态配置</h1>
<blockquote>原文：<a href="https://itnext.io/azure-automation-configuring-desired-state-configuration-4091d94e85d9?source=collection_archive---------2-----------------------#2022-01-01">https://itnext.io/azure-automation-configuring-desired-state-configuration-4091d94e85d9?source=collection_archive---------2-----------------------#2022-01-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/489fc9d8aa7b2174d5f66d9c01547692.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lHdd87SdSGD9sf0j5W_ilg.jpeg"/></div></div></figure><p id="f15d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在你深入了解Azure自动化状态配置(AASC)的细节之前，你应该知道什么是期望状态配置(DSC)和AASC。Desired State Configuration是一个PowerShell管理平台，用于管理您的IT基础架构的配置，将配置作为代码。DSC为系统配置提供了一个声明性模型，允许您指定如何配置端点(工作站或服务器),并将实际配置留给PowerShell DSC。通过这种方式，我们只需指定“所需状态”，DSC确定如何以及以何种顺序。AASC类似于DSC，允许您编写、管理和编译配置，以及将配置导入和分配到目标服务器。此外，AASC是一项完全在(Azure)云中运行的服务。</p><p id="7b96" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本指南中，您将设置一个Azure Automation帐户，并配置您的第一个所需状态配置。当你完成后，你将拥有必要的技能来开始在你的Azure租户中配置期望的状态。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="ed72" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">先决条件</h1><p id="1c76" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">开始之前，您需要以下内容:</p><ul class=""><li id="0455" class="mg mh iq ka b kb kc kf kg kj mi kn mj kr mk kv ml mm mn mo bi translated">Azure订阅可以访问对订阅具有足够权限的管理员帐户，例如所有者或包含Microsoft的角色。自动化资源授权。如果您没有类似的权限或套餐，<a class="ae mp" href="https://azure.microsoft.com/free/" rel="noopener ugc nofollow" target="_blank">您可以在这里创建一个免费帐户</a>。</li><li id="dc6f" class="mg mh iq ka b kb mq kf mr kj ms kn mt kr mu kv ml mm mn mo bi translated">Visual Studio代码，或者您个人喜欢的任何其他代码编辑器。<a class="ae mp" href="https://code.visualstudio.com/download/" rel="noopener ugc nofollow" target="_blank">你可以在这里免费下载Visual Studio代码</a>。</li><li id="e17a" class="mg mh iq ka b kb mq kf mr kj ms kn mt kr mu kv ml mm mn mo bi translated"><a class="ae mp" href="https://docs.microsoft.com/cli/azure/install-azure-cli" rel="noopener ugc nofollow" target="_blank">蔚蓝海岸</a>。对于Windows 10用户，我另外强烈推荐微软的<a class="ae mp" href="https://www.microsoft.com/en-us/p/windows-terminal/9n0dx20hk701" rel="noopener ugc nofollow" target="_blank"> Windows终端。</a></li><li id="c70a" class="mg mh iq ka b kb mq kf mr kj ms kn mt kr mu kv ml mm mn mo bi translated"><a class="ae mp" href="https://github.com/PowerShell/PowerShell/releases/" rel="noopener ugc nofollow" target="_blank">安装了<a class="ae mp" href="https://docs.microsoft.com/powershell/azure/get-started-azureps" rel="noopener ugc nofollow" target="_blank"> Azure PowerShell模块</a>的PowerShell 7.x </a>。</li></ul></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="5c7a" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">步骤1 —创建资源</h1><p id="2ccc" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">您将首先创建必要的资源来管理和部署状态配置，创建一个虚拟机，并通过部署所需的状态配置来配置虚拟机。</p><h2 id="afb7" class="mv le iq bd lf mw mx dn lj my mz dp ln kj na nb lr kn nc nd lv kr ne nf lz ng bi translated">登录Azure</h2><p id="5fa7" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">从您的Windows终端、<a class="ae mp" href="https://portal.azure.com/#cloudshell/" rel="noopener ugc nofollow" target="_blank"> Azure Portal </a>或个人偏好的命令行界面，使用Azure云Shell中的<code class="fe nh ni nj nk b">az login</code>命令登录您的Azure环境。</p><h2 id="6f58" class="mv le iq bd lf mw mx dn lj my mz dp ln kj na nb lr kn nc nd lv kr ne nf lz ng bi translated">创建资源组</h2><p id="10d4" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">Azure中的所有资源都由一个容器保存；资源组。最佳实践是为您希望作为一个组来管理的每个解决方案创建一个资源组，并让它保存与此相关的所有资源。这是应有的生命周期管理。出于同样的目的，您将创建一个资源组，该资源组包含您将为本指南创建的所有资源。这使得在您完成本指南后，可以很容易地删除所有资源(如果您愿意的话)。</p><p id="3c06" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过执行以下命令创建资源组。您可以根据个人喜好编辑参数。下面的命令创建一个资源组，名称为“schuttencld-rg ”,位置为西欧地区。</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="d3fc" class="mv le iq nk b gy nt nu l nv nw">az group create \<br/>    --name "schuttencld-rg" \<br/>    --location "westeurope"</span></pre><h2 id="571f" class="mv le iq bd lf mw mx dn lj my mz dp ln kj na nb lr kn nc nd lv kr ne nf lz ng bi translated">创建虚拟机</h2><p id="aa79" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">您将需要一个虚拟机来部署您想要的状态配置。如果您已经有一个运行Windows server作为其操作系统的虚拟机，并且您愿意将它用于测试目的，则可以跳过这一部分。如果你还没有虚拟机，你必须创建一个。下面的命令在先前创建的资源组中，在同一区域(westeurope)创建一个名为“schuttencld-vm”的虚拟机，其操作系统为Windows Server 2019 Datacenter，虚拟机大小为DS1v2。根据您的个人偏好更改任何参数，并执行命令来创建您的虚拟机。</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="f55c" class="mv le iq nk b gy nt nu l nv nw">az vm create \<br/>    --name "schuttencld-vm" \<br/>    --resource-group "schuttencld-rg" \<br/>    --location "westeurope" \<br/>    --image "Win2019Datacenter" \<br/>    --size "Standard_DS1_v2"</span></pre><p id="dbd5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">执行完命令后，你会被要求输入两次管理员密码。</p><h2 id="679f" class="mv le iq bd lf mw mx dn lj my mz dp ln kj na nb lr kn nc nd lv kr ne nf lz ng bi translated">创建自动化帐户</h2><p id="2c52" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">Azure Automation(所需)状态配置是Azure Automation服务中的一项功能。为此，您将使用下面的命令创建一个Azure Automation帐户。同样，您可以根据个人喜好编辑参数。</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="75f9" class="mv le iq nk b gy nt nu l nv nw">az automation account create \<br/>    --automation-account-name "schuttencld-aa" \<br/>    --resource-group "schuttencld-rg"<br/>    --location "westeurope" \<br/>    --sku "Free"</span></pre></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="2de0" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">步骤2 —创建状态配置</h1><p id="2e7d" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">现在您将创建包含所需状态配置的配置文件，并对其进行编译。在这一步中，您将使用PowerShell来执行您的命令。首先在PowerShell中执行<code class="fe nh ni nj nk b">Connect-AzAccount</code>命令来连接到Azure环境。</p><h2 id="6945" class="mv le iq bd lf mw mx dn lj my mz dp ln kj na nb lr kn nc nd lv kr ne nf lz ng bi translated">创建配置文件</h2><p id="e18a" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">现在，您将在配置文件中编写所需的配置。启动Visual Studio代码(或您喜欢的任何其他代码编辑器)并创建一个新的PowerShell文件。在这个例子中，我将这个文件命名为“SchuttenCldConfig.ps1”，并将它保存在我的桌面上。</p><p id="9260" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">出于教育目的，我们编写了一个所需的配置，其中安装了Windows Defender功能并运行Windows Defender服务。我们称这种配置状态为“IsSecure”。如果Windows Defender功能不存在，或者如果Windows Defender服务已停止，则为“NotSecure”。转录的配置文件如下所示:</p><figure class="nl nm nn no gt jr gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/9b93c311c3612ed40cda561ec00c30fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1346/format:webp/0*0mu5sylnksANTnFx.png"/></div></figure><p id="7a54" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ny">图片由Rolf Schutten上传</em><a class="ae mp" href="https://www.schutten.cloud/" rel="noopener ugc nofollow" target="_blank"><em class="ny">Schutten . cloud</em></a></p><h2 id="7f4c" class="mv le iq bd lf mw mx dn lj my mz dp ln kj na nb lr kn nc nd lv kr ne nf lz ng bi translated">导入配置文件</h2><p id="fc46" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">现在，您已经创建了所需状态的配置文件，您需要将其导入到您的Azure Automation帐户中。您可以通过使用"<a class="ae mp" href="https://docs.microsoft.com/en-us/powershell/module/az.automation/import-azautomationdscconfiguration?view=azps-5.8.0" rel="noopener ugc nofollow" target="_blank">Import-AzAutomationDscConfiguration</a>" PowerShell命令来实现这一点。您可以使用下面的示例，但是要确保根据您的个人偏好来更改参数。</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="8ede" class="mv le iq nk b gy nt nu l nv nw">Import-AzAutomationDscConfiguration<br/>    -SourcePath "C:\Users\Rolf\Desktop\SchuttenCldConfig.ps1"<br/>    -ResourceGroupName schuttencld-rg<br/>    -AutomationAccountName schuttencld-aa<br/>    -Published</span></pre><h2 id="8f53" class="mv le iq bd lf mw mx dn lj my mz dp ln kj na nb lr kn nc nd lv kr ne nf lz ng bi translated">编译配置文件</h2><p id="fa64" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">一旦导入了配置文件，就需要编译它。同样，您将使用PowerShell命令来完成此操作，因为这是最简单的方法。使用下面的示例命令，但是请确保根据您的个人偏好更改参数，其中“-configurationName”应该是指您在配置文件中为您的配置指定的名称(该名称显示在文件中第一行代码的单词“Configuration”之后)。</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="3baf" class="mv le iq nk b gy nt nu l nv nw">Start-AzAutomationDscCompilationJob<br/>    -ConfigurationName SchuttenCldConfig<br/>    -ResourceGroupName schuttencld-rg<br/>    -AutomationAccountName schuttencld-aa</span></pre><p id="f337" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">编译配置文件可能需要几分钟才能完成。在根据您的个人偏好进行更改之后，您可以使用下面的命令来验证编译是否成功。</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="c623" class="mv le iq nk b gy nt nu l nv nw">Get-AzAutomationDscNodeConfiguration<br/>    -ResourceGroupName schuttencld-rg<br/>    -AutomationAccountName schuttencld-aa</span></pre><p id="930b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果运行上述命令没有显示任何信息，则没有编译(成功的)配置。如果成功完成，运行该命令后，您应该会看到类似下面的屏幕截图:</p><figure class="nl nm nn no gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/e8551f02a3953f7502be462e8c91d790.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0kJsauCJwqlUT4cm.png"/></div></div></figure><p id="b611" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ny">图片由Rolf Schutten上传</em><a class="ae mp" href="https://www.schutten.cloud/" rel="noopener ugc nofollow" target="_blank"><em class="ny">Schutten . cloud</em></a></p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="4d3d" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">步骤3 —注册虚拟机</h1><p id="66d1" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">在最后一步中，您将使用配置注册虚拟机。在这一步中，您将再次使用PowerShell。</p><h2 id="d851" class="mv le iq bd lf mw mx dn lj my mz dp ln kj na nb lr kn nc nd lv kr ne nf lz ng bi translated">注册虚拟机</h2><p id="9408" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">使用"<a class="ae mp" href="https://docs.microsoft.com/en-us/powershell/module/az.automation/register-azautomationdscnode?view=azps-5.8.0" rel="noopener ugc nofollow" target="_blank">Register-AzAutomationDscNode</a>" PowerShell命令，将您的虚拟机注册到之前配置的状态配置。显然，在您根据个人喜好更改了参数之后，您可以使用下面的示例。</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="03f8" class="mv le iq nk b gy nt nu l nv nw">Register-AzAutomationDscNode<br/>    -AzureVMName schuttencld-vm<br/>    -ResourceGroupName schuttencld-rg<br/>    -AutomationAccountName schuttencld-aa<br/>    -NodeConfigurationName SchuttenCldConfig.IsSecure<br/>    -ConfigurationMode ApplyAndAutocorrect<br/>    -RebootNodeIfNeeded $True</span></pre><p id="e9dd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于“-NodeConfigurationName”，我可以将其参数更改为“SchuttenCldConfig”。NotSecure”，如果我希望系统在没有安装Windows Defender功能和/或运行Windows Defender服务的情况下处于“投诉”状态。此外，对于“ConfigurationMode ”,您还可以选择“ApplyOnly”和“apply and monitor”<em class="ny">apply only</em>将应用配置，但不执行任何操作，除非新配置被推送到目标节点，或者当新配置从服务中拉出时。<em class="ny">apply和Monitor </em>，如果没有为这个特定参数指定值，这是默认的配置模式，将与“ApplyOnly”做相同的事情，如果节点偏离了期望的状态，将报告任何差异。最后，还有“ApplyAndAutocorrect”选项，我们在上面的示例命令中使用了它。<em class="ny"> ApplyAndAutocorrect </em>会做与“ApplyAndMonitor”相同的事情，并在报告差异时重新应用所需的配置。</p><p id="f036" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">成功运行PowerShell命令后，您就将虚拟机注册到了所需的状态配置。为了监控节点的结果和合规状态，微软在Azure门户中开发了一个漂亮的仪表板。你可以在你的Azure Automation帐户中的“状态配置(DSC)”链接下找到该仪表板。</p><figure class="nl nm nn no gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/f9828df4fa76f9255a888bc7f449ffea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8QVCJhJHlaeDj6Sz.png"/></div></div></figure><p id="46e1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ny">图片由Rolf Schutten上传</em><a class="ae mp" href="https://www.schutten.cloud/" rel="noopener ugc nofollow" target="_blank"><em class="ny">Schutten . cloud</em></a></p><p id="bc3b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这里，您可以单击显示的数据，以获得有关配置、合规状态等的详细信息。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="d759" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">结论</h1><p id="25d2" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">本文通过创建、导入、编译和注册一个配置文件到虚拟机，向您介绍了状态配置(在Azure中)的基础知识。本指南中的配置强制提供Windows Defender功能和Windows Defender服务的运行状态。现在，您可以开始编写所需的配置，并使用Azure中的状态配置来实施或监控它们。</p><p id="881b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您想了解更多关于状态配置的信息，<a class="ae mp" href="https://docs.microsoft.com/powershell/scripting/dsc/overview/overview?view=powershell-7.1" rel="noopener ugc nofollow" target="_blank">这个微软文档页面</a>是一个很好的起点。</p></div></div>    
</body>
</html>