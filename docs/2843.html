<html>
<head>
<title>Install and configure Docker swarm</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">安装和配置Docker swarm</h1>
<blockquote>原文：<a href="https://itnext.io/install-and-monitor-docker-swarm-e9db8a8fbbc4?source=collection_archive---------1-----------------------#2019-08-13">https://itnext.io/install-and-monitor-docker-swarm-e9db8a8fbbc4?source=collection_archive---------1-----------------------#2019-08-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="897c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章描述了使用运行在VMware vSphere之上的Ubuntu 18.04服务器虚拟机安装<a class="ae kl" href="https://docs.docker.com/engine/swarm/" rel="noopener ugc nofollow" target="_blank"> Docker swarm </a>。</p><p id="08cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装完成后，为ESXi、Ubuntu Linux和Docker Swarm准备了一些容器。</p><p id="afaf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这一步是为以后的文章做准备，包括Docker Swarm和所有组件的监控。</p><p id="fd7b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在<a class="ae kl" href="https://www.opvizor.com" rel="noopener ugc nofollow" target="_blank"> Opvizor </a>为我们的内部开发和产品测试运行了几十个演示环境。除了Kubernetes，我们目前正在研究Docker Swarm集成。因此，将来会有更多类似于Kubernetes示例的监控选项:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/24de2ed270bde8b920c5f48f90996a9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_WqOKfDvMEjAN8GVeYrPYw.png"/></div></div></figure><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ky"><img src="../Images/94e14d929b2643675a567bf5d75bb51d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GRiapn4shTy6vc8tLr6piw.png"/></div></div></figure><h1 id="e7f1" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">设置</h1><p id="f52a" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">该设置由3台在vSphere 6.7上运行Ubuntu 18.04 LTS的虚拟机组成。</p><p id="c626" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为测试环境，虚拟机配置了4个虚拟CPU、8 GB内存和32 GB磁盘。请确保调整您的环境以满足您的需求。</p><p id="d73a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虚拟机命名为swarm1、swarm2和swarm3。</p><h1 id="f6c3" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">安装Docker CE</h1><p id="b5a3" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">在常见的sudo apt更新&amp; sudo apt升级之后，我们安装Docker CE。</p><pre class="kn ko kp kq gt mc md me mf aw mg bi"><span id="83c2" class="mh la iq md b gy mi mj l mk ml">sudo apt install apt-transport-https ca-certificates curl software-properties-commoncurl -fsSL <a class="ae kl" href="https://download.docker.com/linux/ubuntu/gpg" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/ubuntu/gpg</a> | sudo apt-key add -sudo add-apt-repository "deb [arch=amd64] <a class="ae kl" href="https://download.docker.com/linux/ubuntu" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/ubuntu</a> bionic stable"sudo apt updatesudo apt install docker-cesudo systemctl status dockersudo usermod -aG docker ${USER}apt-cache policy docker-cesudo systemctl start docker sudo systemctl enable docker</span></pre><h1 id="2948" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">安装Docker群</h1><p id="f59f" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">Swarm自动成为Docker CE安装的一部分，但是我们需要做一些准备。</p><p id="45e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1个节点应该是管理器，而其他节点成为工作节点。让我们在hosts文件中反映这一点(当然dns更好，但是在测试环境中并不重要)。</p><pre class="kn ko kp kq gt mc md me mf aw mg bi"><span id="2df6" class="mh la iq md b gy mi mj l mk ml"># sudo vi /etc/hosts 192.168.0.12 swarm1 manager1 192.168.0.14 swarm2 worker1 192.168.0.15 swarm3 worker2</span></pre><h1 id="f3fd" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">初始化Docker群</h1><p id="7409" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">您可能会注意到，我们将192.168.0.12命名为manager1 —请仅在manager节点上运行以下命令</p><pre class="kn ko kp kq gt mc md me mf aw mg bi"><span id="55ee" class="mh la iq md b gy mi mj l mk ml">docker swarm init --advertise-addr 192.168.0.12</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mm"><img src="../Images/135a7eab28e85930ebb53db709f5da6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tFXDBCKx-BeuNsLidgYSNQ.png"/></div></div></figure><p id="4e8a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据docker swarm init命令的输出，在两个worker节点上运行以下命令。</p><pre class="kn ko kp kq gt mc md me mf aw mg bi"><span id="6ccd" class="mh la iq md b gy mi mj l mk ml">docker swarm join --token SWMTKN-1-54hsijoskp3urbgeni9fqzz35yjzg527lvxxkg5qdg4ce7dqyz-bf1sladxf3t5v5wtl9droybdc 192.168.0.12:2377</span></pre><p id="d4bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您应该会收到如下消息:</p><p id="e29f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个节点作为一个工作者加入了一个群体。</p><h1 id="9a85" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">设置Docker swarm UI</h1><pre class="kn ko kp kq gt mc md me mf aw mg bi"><span id="6f2e" class="mh la iq md b gy mi mj l mk ml">sudo apt install unzip wget <a class="ae kl" href="https://github.com/dockersamples/docker-swarm-visualizer/archive/master.zip" rel="noopener ugc nofollow" target="_blank">https://github.com/dockersamples/docker-swarm-visualizer/archive/master.zip</a> unzip master.zip mv docker-swarm-visualizer-master dockersamples docker run -it -d -p 5000:8080 -v /var/run/docker.sock:/var/run/docker.sock dockersamples/visualizer</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mn"><img src="../Images/b2b6c1af035be256472c6008ed3cc136.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uLrYsgECbUByX9_pN-Cwhg.png"/></div></div></figure><h1 id="f77f" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">检查码头工人群状态</h1><p id="c8ed" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">你可以随时使用<strong class="jp ir"> docker node ls </strong>检查你的Docker Swarm集群以及有多少节点可用</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mo"><img src="../Images/bc2c29b329d61e8ac6c631321cdd7940.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m5Yv1qblIXgF-gfbDKTlNQ.png"/></div></div></figure><p id="9326" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用docker服务ls检查正在运行的服务:<strong class="jp ir"> docker服务ls </strong></p><p id="5360" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者具体服务的更多细节:<strong class="jp ir"> docker service ps redis </strong></p><h1 id="a296" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">部署第一个服务</h1><p id="eae8" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">由于Docker现在为容器服务管理一个主机集群，而不是一个单独的主机引擎，所以您需要以不同的方式部署容器(服务)。让我们将一个redis数据库部署为具有两个副本的服务。</p><p id="e5ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">复制品是一种实例。多个副本的好处是，总是有更多的容器运行来接管服务。如果一个容器或容器主机将关闭，Docker Swarm将重新启动该服务的容器，但它不是即时的(可能需要几秒钟)。拥有多个副本意味着无需重启即可即时接管剩余副本。</p><pre class="kn ko kp kq gt mc md me mf aw mg bi"><span id="1d9b" class="mh la iq md b gy mi mj l mk ml">docker service create --name redis --replicas 2 --publish 6379:6379 redis</span></pre><p id="10b8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> —发布</strong></p><p id="48a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当Docker为一个服务发布一个端口时，它通过<strong class="jp ir">在集群集群</strong>内的所有节点上监听该端口来实现。当流量到达该端口时，该流量被路由到为该服务运行的容器。当所有节点都运行一个服务的容器时，这个概念是非常标准的，但是当我们的节点比副本多时，这个概念就变得有趣了。尽管没有在所有群节点上运行副本，发布的服务将在所有节点上可用。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mp"><img src="../Images/7b6ec7b1ea4c15786cfb2149dc16c63f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jIpOt2haFhOBaZqsBc-LTw.png"/></div></div></figure><p id="ee61" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您也可以先创建一个服务，然后再扩展——让我们部署nginx</p><pre class="kn ko kp kq gt mc md me mf aw mg bi"><span id="6e4c" class="mh la iq md b gy mi mj l mk ml"># start with one service docker service create --name nginx-web --publish 8080:80 nginx# scale out to 3 replicas docker service scale nginx-web=3</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mq"><img src="../Images/4925456c51f96b551ac93dcd7e0d68d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QX0xW8SKRJVn7NgU5DlM3g.png"/></div></div></figure><pre class="kn ko kp kq gt mc md me mf aw mg bi"><span id="5148" class="mh la iq md b gy mi mj l mk ml">docker service ls ID NAME MODE REPLICAS IMAGE PORTS 8a0wumpvlm7u nginx-web replicated 3/3 nginx:latest *:8080-&gt;80/tcp hya01a0hl6k0 redis replicated 2/2 redis:latest *:6379-&gt;6379/tcp</span></pre><p id="dee1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您现在可以简单地检查Redis是否在所有节点上都有响应，尽管它只在swarm1和swarm2上运行。</p><pre class="kn ko kp kq gt mc md me mf aw mg bi"><span id="fb1a" class="mh la iq md b gy mi mj l mk ml">redis-cli -h 192.168.0.12 -p 6379 redis-cli -h 192.168.0.14 -p 6379 redis-cli -h 192.168.0.15 -p 6379</span></pre><h1 id="6d1b" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">多容器——WordPress+数据库</h1><p id="2cdb" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">这个设置由多个组件组成:secrets、network、MariaDB数据库服务和WordPress服务。</p><p id="e84b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">秘密</strong></p><p id="3166" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们首先为根数据库和wordpress数据库创建密码，并将它们作为秘密存储在每个Swarm节点上。</p><pre class="kn ko kp kq gt mc md me mf aw mg bi"><span id="734d" class="mh la iq md b gy mi mj l mk ml">openssl rand -base64 20 | docker secret create root_db_password - openssl rand -base64 20 | docker secret create wp_db_password -</span></pre><p id="cc98" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> docker secret ls </strong>显示所有秘密</p><h1 id="c961" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">网络</h1><p id="14a8" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">现在，我们需要一个跨群集的网络连接。</p><pre class="kn ko kp kq gt mc md me mf aw mg bi"><span id="f97e" class="mh la iq md b gy mi mj l mk ml">docker network create -d overlay wordpress-net</span></pre><h1 id="7401" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">创建MariaDB服务</h1><pre class="kn ko kp kq gt mc md me mf aw mg bi"><span id="48e7" class="mh la iq md b gy mi mj l mk ml">docker service create --name mariadb --replicas 1 --constraint=node.role==manager --network wordpress-net --secret source=root_db_password,target=root_db_password --secret source=wp_db_password,target=wp_db_password -e MYSQL_ROOT_PASSWORD_FILE=/run/secrets/root_db_password -e MYSQL_PASSWORD_FILE=/run/secrets/wp_db_password -e MYSQL_USER=wp -e MYSQL_DATABASE=wp mariadb:10.1</span></pre><h1 id="9904" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">创建WordPress服务</h1><pre class="kn ko kp kq gt mc md me mf aw mg bi"><span id="3e70" class="mh la iq md b gy mi mj l mk ml">docker service create --name wp --constraint=node.role==worker --replicas 1 --network wordpress-net --publish 80:80 --secret source=wp_db_password,target=wp_db_password,mode=0400 -e WORDPRESS_DB_USER=wp -e WORDPRESS_DB_PASSWORD_FILE=/run/secrets/wp_db_password -e WORDPRESS_DB_HOST=mariadb -e WORDPRESS_DB_NAME=wp wordpress:4.7</span></pre><p id="e28e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你在端口80上访问任何Docker Swarm节点，你应该会看到WordPress安装程序。</p></div><div class="ab cl mr ms hu mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="ij ik il im in"><p id="b22b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="my">原载于2019年8月13日</em><a class="ae kl" href="https://www.opvizor.com/install-and-use-docker-swarm" rel="noopener ugc nofollow" target="_blank"><em class="my">https://www.opvizor.com</em></a><em class="my">。</em></p></div></div>    
</body>
</html>