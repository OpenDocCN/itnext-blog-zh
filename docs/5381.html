<html>
<head>
<title>Customising istio access logs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">定制istio访问日志</h1>
<blockquote>原文：<a href="https://itnext.io/customising-istio-access-logs-e5805eea31b7?source=collection_archive---------4-----------------------#2021-02-21">https://itnext.io/customising-istio-access-logs-e5805eea31b7?source=collection_archive---------4-----------------------#2021-02-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="6821" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated"><strong class="jt ir">注</strong>:以下文章反映了在使用<code class="fe jn jo jp jq b">istio</code> <code class="fe jn jo jp jq b">1.7.4</code>运行于<code class="fe jn jo jp jq b">k8s</code>版本<code class="fe jn jo jp jq b">1.17</code>的GKE之上的环境中进行的调查</p></div><div class="ab cl kp kq hu kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="ij ik il im in"><figure class="kx ky kz la gt lb gh gi paragraph-image"><div class="gh gi kw"><img src="../Images/ad30f63f81994d4e78cbfdc5aab4b89e.png" data-original-src="https://miro.medium.com/v2/resize:fit:980/format:webp/1*Si5mFEHKbXrYDyHhmBph0A.png"/></div></figure><h1 id="d7bc" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">需要定制istio访问日志</h1><p id="184e" class="pw-post-body-paragraph jr js iq jt b ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk mg km kn ko ij bi translated">在<a class="ae mh" href="http://www.workable.com" rel="noopener ugc nofollow" target="_blank"> Workable </a>中，我们使用GKE作为我们的核心基础设施，并通过以下方式处理传入的请求:</p><p id="3644" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">a) CloudFlare代理我们的大部分服务<br/> b) CloudDNS在<code class="fe jn jo jp jq b">k8s</code>之上为我们的负载平衡器创建DNS条目<br/> c) <code class="fe jn jo jp jq b"><a class="ae mh" href="https://istio.io" rel="noopener ugc nofollow" target="_blank">istio</a></code>作为我们的服务网格，为通过<code class="fe jn jo jp jq b">istio-ingressgateway</code>进入我们的<code class="fe jn jo jp jq b">k8s</code>集群的流量创建入口端点</p><p id="df37" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">在我们最近必须执行的一些调查过程中，我们需要跟踪来自CloudFlare(并由cloud flare代理)的请求/将这些请求关联到我们的<code class="fe jn jo jp jq b">k8s</code>基础架构。</p><p id="a8f0" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">为了支持这个过程，CloudFlare使用了一个名为<code class="fe jn jo jp jq b">cfray</code>的自定义<a class="ae mh" href="https://support.cloudflare.com/hc/en-us/articles/203118044-Gathering-information-for-troubleshooting-sites#h_f7a7396f-ec41-4c52-abf5-a110cadaca7c" rel="noopener ugc nofollow" target="_blank">头</a>，它被注入到一个传入的请求中，并正式建议记录这个头以支持相关的故障排除。所以在这种背景下我们反对解决以下问题:</p><p id="4d7f" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">虽然<code class="fe jn jo jp jq b">cfray</code>在CloudFlare日志中可用，但对于<code class="fe jn jo jp jq b">istio-ingressgateway</code>却不是这样。因此，我们必须找到一种方法让<code class="fe jn jo jp jq b">istio</code>记录特定的头，以便我们能够跟踪从CloudFlare进入我们的<code class="fe jn jo jp jq b">k8s</code>集群的传入请求。</p><h1 id="4012" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">Istio测井</h1><p id="b232" class="pw-post-body-paragraph jr js iq jt b ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk mg km kn ko ij bi translated">彻底掌握<code class="fe jn jo jp jq b">istio</code>的日志行为有点棘手。</p><p id="60de" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">我们首先通过实验验证它在报头传播方面的表现；事实证明，它确实传播了所有的标题(这是通过让我们的一个应用程序在标题从其<code class="fe jn jo jp jq b">istio-proxy</code>边车到达时打印其所有标题来测试的，并且<code class="fe jn jo jp jq b">cfray</code>在那里),默认情况下它不记录它们。</p><p id="ecfc" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">然后我们转向<code class="fe jn jo jp jq b">istio</code>的官方文档，并开始我们的主要调查过程以实现<code class="fe jn jo jp jq b">cfray</code>记录。</p><p id="d9c6" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">与主题相关的官方<code class="fe jn jo jp jq b">istio</code> <a class="ae mh" href="https://istio.io/v1.7/docs/tasks/observability/logs/access-log/" rel="noopener ugc nofollow" target="_blank">文档</a>，只需提及如何打开或关闭访问日志记录以及选择日志记录格式(文本vs <code class="fe jn jo jp jq b">json</code>)即可，用户可以自定义<code class="fe jn jo jp jq b">IstioOperator</code>的<code class="fe jn jo jp jq b">meshConfig.accessLogFormat</code>字段中记录的字段，我们通过自定义配置安装这些字段。</p><p id="fd02" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">文件还指出:</p><blockquote class="mi mj mk"><p id="b5da" class="jr js ml jt b ju jv jw jx jy jz ka kb mm kd ke kf mn kh ki kj mo kl km kn ko ij bi translated">最简单的<code class="fe jn jo jp jq b">istio</code>日志记录是特使访问日志记录。Envoy代理将访问信息打印到标准输出中。然后可以通过<code class="fe jn jo jp jq b">kubectl</code> logs命令打印出Envoy容器的标准输出。</p></blockquote><p id="1805" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">这可能导致假设如果没有应用额外的设置，<code class="fe jn jo jp jq b">istio</code>将使用envoy的默认访问日志格式；根据<code class="fe jn jo jp jq b">envoy’</code> s <a class="ae mh" href="https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#default-format-string" rel="noopener ugc nofollow" target="_blank">文档</a>，如下:</p><pre class="kx ky kz la gt mp jq mq mr aw ms bi"><span id="992e" class="mt lf iq jq b gy mu mv l mw mx"><br/>[%START_TIME%] “%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%” %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% “%REQ(X-FORWARDED-FOR)%” “%REQ(USER-AGENT)%” “%REQ(X-REQUEST-ID)%” “%REQ(:AUTHORITY)%” “%UPSTREAM_HOST%”\n</span></pre><p id="b5a0" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">然而，这与我们在集群中观察到的情况相差甚远，因为我们的<code class="fe jn jo jp jq b">istio-proxy </code>日志如下:</p><pre class="kx ky kz la gt mp jq mq mr aw ms bi"><span id="3a24" class="mt lf iq jq b gy mu mv l mw mx"><br/>istio-ingressgateway-4493400kkdhjrh-b45h1 istio-proxy {<br/> “response_flags”: “NR”,<br/> “requested_server_name”: “service-1.environment-name-1.stg-gke.ourdomain.net”,<br/> “bytes_received”: “0”,<br/> “istio_policy_status”: “-”,<br/> “route_name”: “-”,<br/> “user_agent”: “Mozilla/5.0 (compatible; Cloudflare-Traffic-Manager/1.0; +<a class="ae mh" href="https://www.cloudflare.com/traffic-manager/" rel="noopener ugc nofollow" target="_blank">https://www.cloudflare.com/traffic-manager/</a>; pool-id: 393949487478575)”,<br/> “start_time”: “2021–01–27T15:02:15.128Z”,<br/> “method”: “GET”,<br/> “request_id”: “123456-cff3–9cfd-1234–494048938722”,<br/> “upstream_host”: “-”,<br/> “x_forwarded_for”: “10.16.32.1”,<br/> “bytes_sent”: “0”,<br/> “upstream_cluster”: “-”,<br/> “downstream_remote_address”: “10.16.32.1:1763”,<br/> “path”: “/health”,<br/> “authority”: “service-1.environment-name-1.stg-gke.ourdomain.net”,<br/> “protocol”: “HTTP/1.1”,<br/> “upstream_service_time”: “-”,<br/> “upstream_local_address”: “-”,<br/> “duration”: “0”,<br/> “downstream_local_address”: “10.16.32.27:8443”,<br/> “upstream_transport_failure_reason”: “-”,<br/> “response_code”: “404”<br/>}</span></pre><p id="797e" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">其中<code class="fe jn jo jp jq b">service-1.environment-name-1.stg-gke.ourdomain.net</code>是GCP的CloudDNS公开的url。</p><p id="04fd" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">日志中的<code class="fe jn jo jp jq b">json</code>格式是我们设置的，因为在我们的自定义<code class="fe jn jo jp jq b">IstioOperator</code>配置中我们设置了:</p><pre class="kx ky kz la gt mp jq mq mr aw ms bi"><span id="3160" class="mt lf iq jq b gy mu mv l mw mx">meshConfig:<br/>  accessLogFile: “/dev/stdout”<br/>  accessLogEncoding: “JSON”</span></pre><p id="099e" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated"><strong class="jt ir">更新</strong>:原来在最新的<code class="fe jn jo jp jq b">istio</code>版本中(<code class="fe jn jo jp jq b">1.9</code>)文档被更新以反映实际的测井格式；不幸的是，我们在调查过程中无法获得这一信息。</p><p id="825a" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">鉴于上述情况，我们必须解决以下问题:</p><p id="e20d" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">a)这个默认的日志格式设置<br/>在哪里b)在<code class="fe jn jo jp jq b">meshConfig.accessLogFormat</code>中增加<code class="fe jn jo jp jq b">json</code>字段会有什么影响？这些字段会被追加到默认的访问日志中，还是会完全覆盖它？</p><p id="dc0a" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated"><strong class="jt ir">查找默认访问日志格式的配置</strong></p><p id="f957" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">默认访问格式设置的位置似乎没有记录(或者至少很难找到——你可以顺便在<code class="fe jn jo jp jq b">istio</code>的GH repo <a class="ae mh" href="https://github.com/istio/istio/issues/30242" rel="noopener ugc nofollow" target="_blank">这里</a>跟随相关讨论)。但是，在任何时间点(假设默认的访问日志格式没有被覆盖)，您都可以找到执行到<code class="fe jn jo jp jq b">istio-proxy</code> pod并解析其配置转储所使用的实际默认日志格式，如</p><pre class="kx ky kz la gt mp jq mq mr aw ms bi"><span id="3a3a" class="mt lf iq jq b gy mu mv l mw mx">kubectl exec -it istio-ingressgateway-4493400kkdhjrh-b45h1 -c istio-proxy -n istio-system — curl -s localhost:15000/config_dump | grep format -A 10</span></pre><h1 id="613d" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">修改日志格式并捕获<code class="fe jn jo jp jq b">cfray</code>头</h1><p id="2bb5" class="pw-post-body-paragraph jr js iq jt b ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk mg km kn ko ij bi translated">发现我们的<code class="fe jn jo jp jq b">istio</code>配置使用的实际(默认)日志格式后，下一步是我们提供适当的修改(设置为<code class="fe jn jo jp jq b">IstioOperator</code>的<code class="fe jn jo jp jq b">meshConfig.accessLogForma</code> t字段的值)，以便我们能够记录CloudFlare的<code class="fe jn jo jp jq b">cfray</code>头。</p><p id="fbc7" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">第一步是定义如何在<code class="fe jn jo jp jq b">IstioOperator</code>清单中适当地格式化<code class="fe jn jo jp jq b">meshConfig.accessLogFormat</code>；这也有点棘手，但由于在另一期GH <a class="ae mh" href="https://github.com/istio/istio/issues/24318#issuecomment-688672926" rel="noopener ugc nofollow" target="_blank">中推出的一个讨论中的评论，我们使用了以下配置(实际上有效):</a></p><pre class="kx ky kz la gt mp jq mq mr aw ms bi"><span id="cf98" class="mt lf iq jq b gy mu mv l mw mx">accessLogFormat: |               <br/>   {               <br/>    "accessLogFormat": "{                                         <br/>                        \"cfray\": \"%REQ(CF-RAY)%\",                                                   <br/>                        \"authority\": \"%REQ(:AUTHORITY)%\",                                     <br/>                        \"start_time\": \"%START_TIME%\",                                    <br/>                        \"bytes_received\": \"%BYTES_RECEIVED%\",                                    <br/>                        \"bytes_sent\": \"%BYTES_SENT%\",                                           <br/>                        \"downstream_local_address\": \"%DOWNSTREAM_LOCAL_ADDRESS%\",                                    <br/>                        \"downstream_remote_address\": \"%DOWNSTREAM_REMOTE_ADDRESS%\",                                    <br/>                        \"duration\": \"%DURATION%\",                                    \"istio_policy_status\": \"%DYNAMIC_METADATA(istio.mixer:status)%\",                                    <br/>                        \"method\": \"%REQ(:METHOD)%\",                                    <br/>                        \"path\": \"%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%\",         <br/>                        \"protocol\": \"%PROTOCOL%\",                                       <br/>                        \"request_id\": \"%REQ(X-REQUEST-ID)%\",                                    <br/>                        \"requested_server_name\": \"%REQUESTED_SERVER_NAME%\",                                    <br/>                        \"response_code\": \"%RESPONSE_CODE%\",                                    <br/>                        \"response_flags\": \"%RESPONSE_FLAGS%\",                                    <br/>                        \"route_name\": \"%ROUTE_NAME%\",                                    <br/>                        \"start_time\": \"%START_TIME%\",                                    <br/>                        \"upstream_cluster\": \"%UPSTREAM_CLUSTER%\",                                    <br/>                        \"upstream_host\": \"%UPSTREAM_HOST%\",                                    <br/>                        \"upstream_local_address\": \"%UPSTREAM_LOCAL_ADDRESS%\",                                    <br/>                        \"upstream_service_time\": \"%RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)%\",                                    <br/>                        \"upstream_transport_failure_reason\": \"%UPSTREAM_TRANSPORT_FAILURE_REASON%\",                                    <br/>                        \"user_agent\": \"%REQ(USER-AGENT)%\",                                    <br/>                        \"x_forwarded_for\": \"%REQ(X-FORWARDED-FOR)%\"                                  <br/>                       }"               <br/>}</span></pre><p id="b6b8" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">不幸的是，这确实有点乏味，因为它不是基于追加的，也就是说，无论你在那个部分下放置什么，最终都是完整的访问日志，因此格式的所有字段都必须重写。</p><p id="65a6" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">至于捕获任何自定义标题，这遵循以下模式:</p><pre class="kx ky kz la gt mp jq mq mr aw ms bi"><span id="f611" class="mt lf iq jq b gy mu mv l mw mx">“namethatwillappearinistiolog”:”%REQ(CUSTOM-HEADER-TO-BE-LOGGED)%</span></pre><p id="d69d" class="pw-post-body-paragraph jr js iq jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">这里是一个样本日志，应用了定制的<code class="fe jn jo jp jq b">IstioOperator</code></p><pre class="kx ky kz la gt mp jq mq mr aw ms bi"><span id="4c99" class="mt lf iq jq b gy mu mv l mw mx"><br/>istio-ingressgateway-4493400kkdhjrh-b45h1 stio-proxy {<br/> “cfray”: “38djr9lk3091100309091x”,<br/> “response_flags”: “NR”,<br/> “requested_server_name”: “service-1.environment-name-1.stg-gke.ourdomain.net”,<br/> “bytes_received”: “0”,<br/> “istio_policy_status”: “-”,<br/> “route_name”: “-”,<br/> “user_agent”: “Mozilla/5.0 (compatible; Cloudflare-Traffic-Manager/1.0; +<a class="ae mh" href="https://www.cloudflare.com/traffic-manager/" rel="noopener ugc nofollow" target="_blank">https://www.cloudflare.com/traffic-manager/</a>; pool-id: 2da0260c20e19b2e)”,<br/> “start_time”: “2021–01–27T15:02:15.128Z”,<br/> “method”: “GET”,<br/> “request_id”: “123456-cvt5–9cfd-8289–4961432c5feab”,<br/> “upstream_host”: “-”,<br/> “x_forwarded_for”: “10.16.32.1”,<br/> “bytes_sent”: “0”,<br/> “upstream_cluster”: “-”,<br/> “downstream_remote_address”: “10.16.32.1:1763”,<br/> “path”: “/health”,<br/> “authority”: “service-1.environment-name-1.stg-gke.ourdomain.net”,<br/> “protocol”: “HTTP/1.1”,<br/> “upstream_service_time”: “-”,<br/> “upstream_local_address”: “-”,<br/> “duration”: “0”,<br/> “downstream_local_address”: “10.16.32.27:8443”,<br/> “upstream_transport_failure_reason”: “-”,<br/> “response_code”: “404”<br/>}</span></pre></div></div>    
</body>
</html>