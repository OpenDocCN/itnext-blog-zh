# 我如何逆转一个 NodeJS 恶意软件并找到作者

> 原文：<https://itnext.io/how-i-reversed-a-nodejs-malware-and-found-the-author-7dd9531b389f?source=collection_archive---------0----------------------->

![](img/843b8e3b721e40e95db1f4a7f625c399.png)

给一点背景，我是一个关于开发的小服务器上的不和谐管理员，我们最近从我们的一个用户那里得到一个报告，有人试图让他下载一个 EXE 文件。

我做的第一件事是问记者他是否打开了文件，他回答说他打开了。他告诉我这个程序打开了几秒钟的控制台提示，然后退出了。大多数时候，当你从一个不可信的来源下载了一个文件时，这并不好…

所以我抓起我的电脑，下载了这个文件(我把它下载在一个 Linux 虚拟机上，所以如果它以某种方式被感染，我可以删除这个虚拟机)。**调查时间到了。**

# 确定二进制文件的种类

我的第一个想法是查找这个可执行文件中的内容。为此，我像这样使用了`strings`命令:

```
> strings file.exe
```

`strings`命令在二进制文件中查找可打印的字符串。查看文件中嵌入的任何字符串(如 URL 或地址)会很有帮助。

大多数结果都是乱码，但是在某个时候，我看到了`NodeRuntime`。我们现在可以说它是一个 NodeJS 捆绑的可执行文件！

在这种可执行文件中，源代码总是出现在`strings`输出的末尾。让我们来看看这些来源:

```
function a0_0x47b121(_0x44bb58,_0x4e9d60,_0x355d77,_0x4e9d34,_0x1a193e){return a0_0x1b80(_0x1a193e- -0x1e4,_0x44bb58);
```

在很长的一行上，代码看起来模糊不清，被缩小了…

我应用了下面的方法来理解混淆代码背后的逻辑。

# 第一种方法:不和谐

我知道这个二进制文件是通过 Discord DMs 分发的，所以我用 grep 查看代码中是否包含 Discord 这个词。答对了。

几个函数包含了`discord`这个词:`listDiscords`、`startDiscord`、`killDiscord`、`pwnBetterDiscord`。这最后一个功能看起来很有前途。

我在 Google 和 Github 上查找`pwnBetterDiscord`，找到了工具的来源:[https://github.com/Stanley-GF/PirateStealer](https://github.com/Stanley-GF/PirateStealer)。

## 盗版者

我们已经找到了捆绑应用中使用的源代码。让我们来看看。

它从 discord 客户端窃取所有可以找到的信息，首先杀死 Discord 客户端，并用 Javascript 有效负载修补它，通过 Discord webhook(一个可以向 Discord 服务器发送消息的 URL)泄漏 Discord 凭据和信用卡信息等私人信息。

作者声称该工具仅用于教育目的，但他也出售高级功能和支持？这看起来不像是一个正义的“教育目的”主张…

# 从模糊代码中查找 webhook URL

代码中充满了许多试图混淆对主字符串混淆函数的访问的代理函数。多亏代码没有被完全混淆，我们才能找到`webhook=a0_0x78da73(0x331,0x342,0x32c,0x2f1,0x324)`。让我们来玩一个游戏，提取所有需要破译这个代码的方法。为了简洁起见，我将把所有模糊函数重命名为`fn1`、`fn2` …以及它们的参数`p1`、`p2` …

`a0_0x78da73`(姑且称之为`fn1`)接受 5 个参数，但它只关心第一个和最后一个:

```
**function** fn1(p1,p2,p3,p4,p5){return fn2(p5 - 0x26a,p1);}
```

`fn2`更复杂，有初始化向量和复杂的旋转，但是我们可以通过直接调用这个函数来绕过复杂性。就这么办吧！

我创建了一个名为`find_webhook.js`的新文件，它复制了运行 fn2 和`console.log(fn2(0x324 — 0x26a, 0x331)),`所需的代码……我们有了！输出为`https://ptb.discord.com/api/webhooks/abcdefg/hijklmn`(出于保密原因，输出被审查)。

## 查找脚本的用户

然后我用 webhook 给他们发消息，告诉他们我知道他们在做什么，并告诉他们用我的不和谐 ID 给我发 DM，希望他们会回答我。他们做到了！

从那以后，没有更多的话要说，讨论不是很有成效，但至少我可以告诉我们共有的其他服务器，坏人也在他们的服务器上。

我希望这篇文章能鼓励人们在从不可信的来源下载可执行文件时更加谨慎，并帮助其他人了解我们如何逆转现在越来越多使用的 NodeJS 恶意软件。

如果你有任何建议或意见，不要犹豫，把它们贴在评论区，我会尽力回答。

另外，不要忘记关注，因为我将继续发布更多关于这个黑客和电子的高级主题。

如果你喜欢这篇文章，请考虑留下你的反馈。这种文章需要很长时间准备(除了我的日常工作，几乎有一周)，所以如果你想支持我，你可以在这里订阅[Medium membership](https://medium.com/@devops-guy/membership)。这也给了你无限的媒体访问权。