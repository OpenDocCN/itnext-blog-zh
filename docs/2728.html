<html>
<head>
<title>Kubernetes Journey — Up and running out of the cloud — flannel</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes之旅——在云外奔跑——法兰绒</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-journey-up-and-running-out-of-the-cloud-flannel-c01283308f0e?source=collection_archive---------4-----------------------#2019-07-22">https://itnext.io/kubernetes-journey-up-and-running-out-of-the-cloud-flannel-c01283308f0e?source=collection_archive---------4-----------------------#2019-07-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d0a03f009bf70a079df458c2cd7ecb79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yvTpoKqNTBkURxamI_dzSQ.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">艾莉娜·格鲁布尼亚克在<a class="ae kc" href="https://unsplash.com/search/photos/network?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><p id="222a" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">在本文中，我们将介绍一些关于<strong class="km ir">法兰绒</strong>的细节，以及它在<strong class="km ir"> Kubernetes网络</strong>中扮演的角色。我强烈建议您通过参考链接更好地理解<strong class="km ir">绒布</strong>的工作原理。</p><p id="5cbf" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">在<a class="ae kc" rel="noopener ugc nofollow" target="_blank" href="/kubernetes-journey-up-and-running-out-of-the-cloud-etcd-b332d1be474c">上一篇文章</a>中，我们介绍了<strong class="km ir"> etcd </strong>并对其进行了简要概述。</p><p id="a9c9" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">这些文章是我们<a class="ae kc" href="https://medium.com/@mtvallim/kubernetes-journey-up-and-running-out-of-the-cloud-introduction-f04a811c92a5" rel="noopener"> Kubernetes之旅</a>的一部分。我希望您对深入研究如何从云中安装和配置Kubernetes感到兴奋！</p></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><p id="6c78" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">如果你不想等到所有的文章都发表了，又想马上动手，可以随意克隆项目的Github repo。它完全实用，文档也在不断改进:</p><div class="li lj gp gr lk ll"><a href="https://github.com/mvallim/kubernetes-under-the-hood" rel="noopener  ugc nofollow" target="_blank"><div class="lm ab fo"><div class="ln ab lo cl cj lp"><h2 class="bd ir gy z fp lq fr fs lr fu fw ip bi translated">罩下的姆瓦利姆/库伯内特斯</h2><div class="ls l"><h3 class="bd b gy z fp lq fr fs lr fu fw dk translated">本教程是有人计划安装一个Kubernetes集群，并希望了解一切如何配合在一起…</h3></div><div class="lt l"><p class="bd b dl z fp lq fr fs lr fu fw dk translated">github.com</p></div></div><div class="lu l"><div class="lv l lw lx ly lu lz jw ll"/></div></div></a></div></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><h1 id="1975" class="ma mb iq bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">集群网络</h1><blockquote class="my"><p id="1551" class="mz na iq bd nb nc nd ne nf ng nh lh dk translated"><em class="ni">“网络是Kubernetes的核心部分，但要准确理解它是如何工作的却是一个挑战。”</em></p></blockquote><blockquote class="nj nk nl"><p id="f297" class="kk kl nm km b kn nn kp kq kr no kt ku np nq kx ky nr ns lb lc nt nu lf lg lh ij bi translated">参考:<a class="ae kc" href="https://kubernetes.io/docs/concepts/cluster-administration/networking/" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/docs/concepts/cluster-administration/networking/</a></p></blockquote><p id="41bb" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">在我们谈论法兰绒以及它如何适合这里之前，理解集群的网络特征是很重要的。</p><p id="25d4" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">在本节中，我们将主要关注理解<strong class="km ir"> Pod-to-Pod </strong>通信是如何工作的。</p><p id="11c7" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">Kubernetes网络模型遵循一些基本假设。官方文件称<strong class="km ir"> Kubernetes网络模型</strong>要求:</p><ul class=""><li id="8cbc" class="nv nw iq km b kn ko kr ks kv nx kz ny ld nz lh oa ob oc od bi translated"><em class="nm">无需使用网络地址转换(NAT ),所有pod都能够相互通信。</em></li><li id="ad06" class="nv nw iq km b kn oe kr of kv og kz oh ld oi lh oa ob oc od bi translated"><em class="nm">节点——运行Kubernetes集群的机器。这些可以是虚拟机或物理机，或者实际上是能够运行Kubernetes的任何东西——也能够与所有的pod通信，而不需要NAT。</em></li><li id="181e" class="nv nw iq km b kn oe kr of kv og kz oh ld oi lh oa ob oc od bi translated"><em class="nm">每个Pod会看到自己拥有与其他Pod相同的IP。</em></li></ul></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><h1 id="43e3" class="ma mb iq bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">Kubernetes网络<strong class="ak">型号</strong></h1><figure class="ok ol om on gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oj"><img src="../Images/5fb493adbbca4a3211170a753dfeb71b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CfIjoH4r_6i5X41mJP9NSw.png"/></div></div></figure><p id="4443" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">每个Kubernetes节点(主节点或工作节点)都是一台Linux机器(VM或裸机)，它有一个网络名称空间— <strong class="km ir"> netns </strong> —有一个网络接口作为它的主接口。这在上图中显示为<strong class="km ir"> eth0 </strong>。</p><p id="3e84" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">仔细观察，我们可以看到每个Pod也有自己的<strong class="km ir"> eth </strong>接口，这意味着每个Pod都有自己的网络配置(IP、路由等)。这也意味着每个Pod都有自己的<strong class="km ir"> netns </strong>，因此我们有一个由网络接口分隔的网络名称空间。</p><p id="562e" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">为了说明这一点，想象你和你的同事去拉斯维加斯参加一个会议。您的公司将赞助您参加此次会议，因此您将住在同一家酒店(Kubernetes节点)。这家酒店的每个房间都配备了客房电话(网络接口)。</p><p id="fd6e" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">你使用客房电话与不在酒店的家人联系。没有免费的午餐，所以酒店显然会对你使用客房电话拨打的任何外线电话收费。要做到这一点，所有的外部呼叫都要通过一个中心(即<strong class="km ir"> eth0 </strong>)进行注册，然后将呼叫重定向到外部世界。客房电话和这个中心之间的链接类似于虚拟接口在网络中扮演的角色。</p><blockquote class="my"><p id="a3bd" class="mz na iq bd nb nc nd ne nf ng nh lh dk translated"><em class="ni">“veth设备是虚拟以太网设备。它们可以充当网络命名空间之间的隧道，以创建到另一个命名空间中的物理网络设备的桥，但也可以用作独立的网络设备。</em></p><p id="a986" class="mz na iq bd nb nc nd ne nf ng nh lh dk translated"><em class="ni"> veth设备总是成对互连。”</em></p></blockquote><blockquote class="nj nk nl"><p id="f67d" class="kk kl nm km b kn nn kp kq kr no kt ku np nq kx ky nr ns lb lc nt nu lf lg lh ij bi translated"><em class="iq">参考:</em><a class="ae kc" href="http://man7.org/linux/man-pages/man4/veth.4.html" rel="noopener ugc nofollow" target="_blank"><em class="iq">http://man7.org/linux/man-pages/man4/veth.4.html</em></a></p></blockquote><p id="b891" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">例如，现在你和你的同事想让对方知道你什么时候去参加会议或吃晚饭。你想节省一些钱，所以你决定用客房电话交谈，而不是用手机。当你在酒店登记入住时，礼宾员解释说，你可以在房间之间互相打电话，只需输入<strong class="km ir"> # &lt;房间号&gt; </strong>。有一个内部中枢允许这种交流发生。这类似于<strong class="km ir"> cni0 </strong>(如上图所示)所扮演的角色，作为一个允许Pod到Pod通信的桥梁。</p><p id="70e3" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">碰巧这家酒店有多栋建筑，而你的一些同事被安排在第二栋建筑里。尽管如此，门房解释说没有任何问题。和他们交流，你只需要在房间号前面加上楼号:<strong class="km ir"> # &lt;楼&gt; &lt;房号&gt; </strong>。内部中心(<strong class="km ir"> cni </strong>)将注意到该地址不在它自己的大楼内部，将呼叫重定向到中心(<strong class="km ir"> eth0 </strong>)，中心将再次将呼叫重定向到另一个大楼(另一个Kubernetes节点)中心(类似于<strong class="km ir"> eth0 </strong>)，中心又将呼叫传递到它自己的内部中心，使呼叫最终与目标房间完成。有关此场景的更多技术解释，请查看下面的<strong class="km ir">跨不同主机路由流量</strong>部分。</p><p id="e2e0" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">在Kubernetes上，所有这些配置和管理都是通过一个<strong class="km ir"> CNI </strong>(容器网络接口)插件完成的。</p></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><h1 id="be90" class="ma mb iq bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated"><strong class="ak">什么是CNI？</strong></h1><p id="e2f3" class="pw-post-body-paragraph kk kl iq km b kn oo kp kq kr op kt ku kv oq kx ky kz or lb lc ld os lf lg lh ij bi translated"><strong class="km ir"> CNI </strong>是<strong class="km ir">容器网络接口</strong>的简称，它基本上是一个外部软件(模块)，实现由规范良好定义的<a class="ae kc" href="https://github.com/containernetworking/cni/blob/master/SPEC.md#container-network-interface-specification" rel="noopener ugc nofollow" target="_blank">接口，允许<strong class="km ir"> Kubernetes </strong>执行动作以提供网络功能。</a></p><blockquote class="my"><p id="7ba9" class="mz na iq bd nb nc nd ne nf ng nh lh dk translated"><em class="ni">"每个</em><strong class="ak"><em class="ni">CNI</em></strong><em class="ni">插件必须实现为由容器管理系统调用的可执行文件(例如rkt或Kubernetes)。</em></p><p id="abde" class="mz na iq bd nb nc nd ne nf ng nh lh dk translated"><em class="ni">一个</em><strong class="ak"><em class="ni"/></strong><em class="ni">插件负责将一个网络接口插入到容器网络名称空间(例如</em> <strong class="ak"> <em class="ni"> veth </em> </strong> <em class="ni">对的一端)并在主机上进行任何必要的更改(例如将</em><strong class="ak"><em class="ni">veth</em></strong><em class="ni">的另一端附加到一个</em> <strong class="ak"> <em class="ni">桥</em> </strong> <em class="ni">然后，它应该将IP分配给接口，并通过调用适当的IPAM插件来设置与IP地址管理部分一致的路由。”</em></p></blockquote><blockquote class="nj nk nl"><p id="0505" class="kk kl nm km b kn nn kp kq kr no kt ku np nq kx ky nr ns lb lc nt nu lf lg lh ij bi translated">参考:<a class="ae kc" href="https://github.com/containernetworking/cni/blob/master/SPEC.md#cni-plugin" rel="noopener ugc nofollow" target="_blank">https://github . com/container networking/CNI/blob/master/spec . MD # CNI-plugin</a></p></blockquote></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><h1 id="3db7" class="ma mb iq bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">Kubernetes交通路线</h1><p id="f054" class="pw-post-body-paragraph kk kl iq km b kn oo kp kq kr op kt ku kv oq kx ky kz or lb lc ld os lf lg lh ij bi translated">我们将在两个场景中更详细地解释流量如何在pod之间路由。</p></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><h2 id="3bcd" class="ot mb iq bd mc ou ov dn mg ow ox dp mk kv oy oz mo kz pa pb ms ld pc pd mw pe bi translated">在同一台主机上路由流量</h2><figure class="ok ol om on gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pf"><img src="../Images/b77188f1cf3f8fdba07f3efd9d30fe6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tIhIH5StgSmeISdrMD8hKg.png"/></div></div></figure><p id="6428" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">从<strong class="km ir">盒4 </strong>到<strong class="km ir">盒6 </strong>的逐步通信:</p><ol class=""><li id="5145" class="nv nw iq km b kn ko kr ks kv nx kz ny ld nz lh pg ob oc od bi translated"><em class="nm">包叶子</em><strong class="km ir"><em class="nm">Pod 4 netns</em></strong><em class="nm">通过</em><strong class="km ir"><em class="nm">et H4</em></strong><em class="nm">接口到达</em> <strong class="km ir"> <em class="nm">根netns </em> </strong> <em class="nm">通过虚拟接口</em><em class="nm">vet H4</em><em class="nm">；</em></li><li id="1042" class="nv nw iq km b kn oe kr of kv og kz oh ld oi lh pg ob oc od bi translated"><em class="nm">包叶子</em><strong class="km ir"><em class="nm">vet H4</em></strong><em class="nm">并到达</em><strong class="km ir"><em class="nm">CNI 0</em></strong><em class="nm">，寻找</em><strong class="km ir"><em class="nm">Pod 6</em></strong><em class="nm">的地址；</em></li><li id="5d9a" class="nv nw iq km b kn oe kr of kv og kz oh ld oi lh pg ob oc od bi translated"><em class="nm">包叶子</em><strong class="km ir"><em class="nm">CNI 0</em></strong><em class="nm">并被重定向到</em><strong class="km ir"><em class="nm">veth 6</em></strong><em class="nm">；</em></li><li id="6d88" class="nv nw iq km b kn oe kr of kv og kz oh ld oi lh pg ob oc od bi translated"><em class="nm">包叶子</em> <strong class="km ir"> <em class="nm">根netns </em> </strong> <em class="nm">通过</em><strong class="km ir"><em class="nm">veth 6</em></strong><em class="nm">并到达</em><strong class="km ir"><em class="nm">Pod 6</em><em class="nm"/><strong class="km ir"><em class="nm">根netns </em> </strong> <em class="nm">通过</em> <strong class="km ir"/></strong></li></ol></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><h2 id="9e72" class="ot mb iq bd mc ou ov dn mg ow ox dp mk kv oy oz mo kz pa pb ms ld pc pd mw pe bi translated">跨不同主机路由流量</h2><figure class="ok ol om on gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ph"><img src="../Images/71402be4986dbc8c8d5c2811d765e363.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MgMXvMQtuChrRw-RhsEoQg.png"/></div></div></figure><p id="93d7" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">从<strong class="km ir">盒1 </strong>到<strong class="km ir">盒6 </strong>的逐步通信:</p><ol class=""><li id="db51" class="nv nw iq km b kn ko kr ks kv nx kz ny ld nz lh pg ob oc od bi translated"><em class="nm">包叶子</em><strong class="km ir"><em class="nm">Pod 1 netns</em></strong><em class="nm">通过</em> <strong class="km ir"> <em class="nm"> eth1 </em> </strong> <em class="nm">接口到达</em> <strong class="km ir"> <em class="nm">根netns </em> </strong> <em class="nm">通过虚拟接口</em><strong class="km ir"><em class="nm">vet h1</em></strong><em class="nm">；</em></li><li id="eaca" class="nv nw iq km b kn oe kr of kv og kz oh ld oi lh pg ob oc od bi translated"><em class="nm">包叶子</em><strong class="km ir"><em class="nm">vet h1</em></strong><em class="nm">并到达</em><strong class="km ir"><em class="nm">CNI 0</em></strong><em class="nm">，寻找</em><strong class="km ir"><em class="nm">Pod 6</em></strong><em class="nm">的</em> <strong class="km ir"> <em class="nm"> </em> </strong> <em class="nm">地址；</em></li><li id="fc0a" class="nv nw iq km b kn oe kr of kv og kz oh ld oi lh pg ob oc od bi translated"><em class="nm">包叶子</em><strong class="km ir"><em class="nm">CNI 0</em></strong><em class="nm">并被重定向到</em><strong class="km ir"><em class="nm">eth 0</em></strong><em class="nm">；</em></li><li id="78d9" class="nv nw iq km b kn oe kr of kv og kz oh ld oi lh pg ob oc od bi translated"><em class="nm">包叶子</em><strong class="km ir"><em class="nm">eth 0</em></strong><em class="nm">从</em> <strong class="km ir"> <em class="nm">主1 </em> </strong> <em class="nm">到达</em> <strong class="km ir"> <em class="nm">网关</em></strong><em class="nm">；</em></li><li id="e241" class="nv nw iq km b kn oe kr of kv og kz oh ld oi lh pg ob oc od bi translated"><em class="nm">包叶子</em> <strong class="km ir"> <em class="nm">网关</em> </strong> <em class="nm">和到达</em> <strong class="km ir"> <em class="nm">根网</em> </strong> <em class="nm">通过</em><strong class="km ir"><em class="nm">eth 0</em></strong><em class="nm">接口上的</em> <strong class="km ir"> <em class="nm">工人1</em></strong><em class="nm">；</em></li><li id="6f1f" class="nv nw iq km b kn oe kr of kv og kz oh ld oi lh pg ob oc od bi translated"><em class="nm">包叶子</em><strong class="km ir"><em class="nm">eth 0</em></strong><em class="nm">并到达</em><strong class="km ir"><em class="nm">CNI 0</em></strong><em class="nm">，寻找</em><strong class="km ir"><em class="nm">Pod 6</em></strong><em class="nm">的</em><strong class="km ir"><em class="nm"/></strong><em class="nm">地址；</em></li><li id="ebe0" class="nv nw iq km b kn oe kr of kv og kz oh ld oi lh pg ob oc od bi translated"><em class="nm">包叶子</em><strong class="km ir"><em class="nm">CNI 0</em></strong><em class="nm">并被重定向到</em><strong class="km ir"><em class="nm">veth 6</em></strong><em class="nm">虚拟界面；</em></li><li id="99cd" class="nv nw iq km b kn oe kr of kv og kz oh ld oi lh pg ob oc od bi translated"><em class="nm">包叶子</em> <strong class="km ir"> <em class="nm">根netns </em> </strong> <em class="nm">通过</em><strong class="km ir"><em class="nm">veth 6</em></strong><em class="nm">并到达</em><strong class="km ir"><em class="nm">Pod 6 netns</em></strong><em class="nm">通过</em><strong class="km ir"><em class="nm">eth 6</em></strong></li></ol></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><figure class="ok ol om on gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ph"><img src="../Images/1013fee728a1c1bd3522f9fb5df8c0a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AeASvTqn5bKvtO0xIvdytQ.png"/></div></div></figure><p id="346f" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated"><em class="nm">“法兰绒是配置专为Kubernetes设计的第3层网络结构的一种简单易行的方式。</em></p><p id="ee0f" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated"><em class="nm">绒布在每台主机上运行一个名为</em> <strong class="km ir"> <em class="nm">绒布</em> </strong> <em class="nm">的小型单二进制代理，负责从一个较大的预配置地址空间中为每台主机分配子网租约。法兰绒直接使用Kubernetes API或</em> <strong class="km ir"> <em class="nm"> etcd </em> </strong> <em class="nm">来存储网络配置、分配的子网和任何辅助数据(如主机的公共IP)。数据包使用几种后端机制中的一种进行转发，包括VXLAN和各种云集成。”</em></p><blockquote class="nj nk nl"><p id="b8fa" class="kk kl nm km b kn ko kp kq kr ks kt ku np kw kx ky nr la lb lc nt le lf lg lh ij bi translated">参考:<a class="ae kc" href="https://github.com/coreos/flannel" rel="noopener ugc nofollow" target="_blank">https://github.com/coreos/flannel</a></p></blockquote></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><h1 id="3693" class="ma mb iq bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">后端</h1><blockquote class="my"><p id="db43" class="mz na iq bd nb nc nd ne nf ng nh lh dk translated"><em class="ni"/><strong class="ak"><em class="ni">法兰绒</em> </strong> <em class="ni">可以搭配几种不同的后端。</em> <strong class="ak"> <em class="ni">一旦设置，后台在运行时不应更改</em> </strong> <em class="ni">。</em></p><p id="e4db" class="mz na iq bd nb nc nd ne nf ng nh lh dk translated"><a class="ae kc" href="https://github.com/coreos/flannel/blob/master/Documentation/backends.md#vxlan" rel="noopener ugc nofollow" target="_blank"><strong class="ak"><em class="ni">VX LAN</em></strong></a><em class="ni">是推荐选择。</em><a class="ae kc" href="https://github.com/coreos/flannel/blob/master/Documentation/backends.md#host-gw" rel="noopener ugc nofollow" target="_blank"><strong class="ak"><em class="ni">host-GW</em></strong></a><em class="ni">推荐给更有经验的用户，他们希望性能有所提高，并且他们的基础设施支持它(通常不能在云环境中使用)。</em><a class="ae kc" href="https://github.com/coreos/flannel/blob/master/Documentation/backends.md#udp" rel="noopener ugc nofollow" target="_blank"><strong class="ak"><em class="ni">UDP</em></strong></a><em class="ni">建议仅用于调试或者用于不支持</em><strong class="ak"><em class="ni">VXLAN</em></strong><em class="ni">的非常老的内核。”</em></p></blockquote><blockquote class="nj nk nl"><p id="eb08" class="kk kl nm km b kn nn kp kq kr no kt ku np nq kx ky nr ns lb lc nt nu lf lg lh ij bi translated">参考:<a class="ae kc" href="https://github.com/coreos/flannel/blob/master/Documentation/backends.md#backends" rel="noopener ugc nofollow" target="_blank">https://github . com/coreos/法兰绒/blob/master/Documentation/backends . MD</a></p></blockquote><p id="666d" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">在本文中，我们将讨论一下我们将在解决方案中使用的<strong class="km ir"> VXLAN </strong>模式的内部机制。</p></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><figure class="ok ol om on gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pi"><img src="../Images/3cc8fcbb7fcbb3178c3e5c4005240d03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HvW9aALEP5HgqYA1D_BDfg.png"/></div></div></figure><h1 id="3f16" class="ma mb iq bd mc md pj mf mg mh pk mj mk ml pl mn mo mp pm mr ms mt pn mv mw mx bi translated">法兰绒网络空间</h1><p id="0477" class="pw-post-body-paragraph kk kl iq km b kn oo kp kq kr op kt ku kv oq kx ky kz or lb lc ld os lf lg lh ij bi translated">默认情况下，法兰绒使用CIDR <strong class="km ir"> 10.244.0.0/16 </strong>为每个节点分配带有<strong class="km ir"> 10.244.X.0/24 </strong>掩码的较小子网，而pod将使用分配给给给定节点的这些子网之一的IP地址。</p><p id="d83e" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">简而言之，这意味着每个节点可以有多达254个活动Pod，其中每个Pod都将拥有来自该分配子网的不同IP。</p><p id="4b0d" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">你可以在<strong class="km ir">kube-法兰绒. yml </strong> manifest中看到这个规范，在<strong class="km ir"> net-conf.json </strong>的定义中。(官方法兰绒库在下面的链接)</p><pre class="ok ol om on gt po pp pq pr aw ps bi"><span id="01f8" class="ot mb iq pp b gy pt pu l pv pw">kind: ConfigMap<br/>apiVersion: v1<br/>metadata:<br/>  name: kube-flannel-cfg<br/>  namespace: kube-system<br/>  labels:<br/>    tier: node<br/>    app: flannel<br/>data:<br/>  cni-conf.json: |<br/>    {<br/>      "name": "cbr0",<br/>      "plugins": [<br/>        {<br/>          "type": "flannel",<br/>          "delegate": {<br/>            "hairpinMode": true,<br/>            "isDefaultGateway": true<br/>          }<br/>        },<br/>        {<br/>          "type": "portmap",<br/>          "capabilities": {<br/>            "portMappings": true<br/>          }<br/>        }<br/>      ]<br/>    }<br/>  <strong class="pp ir">net-conf.json</strong>: |<br/>    {<br/>      "Network": "<strong class="pp ir">10.244.0.0/16</strong>",<br/>      "Backend": {<br/>        "Type": "<strong class="pp ir">vxlan</strong>"<br/>      }<br/>    }</span></pre><div class="li lj gp gr lk ll"><a href="https://github.com/coreos/flannel/blob/master/Documentation/kube-flannel.yml" rel="noopener  ugc nofollow" target="_blank"><div class="lm ab fo"><div class="ln ab lo cl cj lp"><h2 class="bd ir gy z fp lq fr fs lr fu fw ip bi translated">coreos/法兰绒</h2><div class="ls l"><h3 class="bd b gy z fp lq fr fs lr fu fw dk translated">法兰绒是一种用于容器的网状织物，专为Kubernetes-coreos/法兰绒设计</h3></div><div class="lt l"><p class="bd b dl z fp lq fr fs lr fu fw dk translated">github.com</p></div></div><div class="lu l"><div class="px l lw lx ly lu lz jw ll"/></div></div></a></div></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><h1 id="632b" class="ma mb iq bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">虚拟以太网设备— veth</h1><blockquote class="my"><p id="874c" class="mz na iq bd nb nc nd ne nf ng nh lh dk translated"><em class="ni">“veth设备是虚拟以太网设备。它们可以充当网络命名空间之间的隧道，以创建到另一个命名空间中的物理网络设备的桥，但也可以用作独立的网络设备。”</em></p></blockquote><blockquote class="nj nk nl"><p id="fd6f" class="kk kl nm km b kn nn kp kq kr no kt ku np nq kx ky nr ns lb lc nt nu lf lg lh ij bi translated"><em class="iq">参考:</em><a class="ae kc" href="http://man7.org/linux/man-pages/man4/veth.4.html" rel="noopener ugc nofollow" target="_blank"><em class="iq">http://man7.org/linux/man-pages/man4/veth.4.html</em></a></p></blockquote></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><h1 id="7910" class="ma mb iq bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">桥梁— cni0</h1><p id="ad65" class="pw-post-body-paragraph kk kl iq km b kn oo kp kq kr op kt ku kv oq kx ky kz or lb lc ld os lf lg lh ij bi translated"><strong class="km ir"> cni0 </strong>是一个Linux网桥设备，所有<strong class="km ir"> veth </strong>设备都将连接到这个网桥，因此同一个节点上的所有pod都可以相互通信，如<strong class="km ir"> Kubernetes网络模型</strong>和上面的酒店类比中所述。</p></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><h1 id="b067" class="ma mb iq bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">VXLAN设备—法兰绒。<vni/></h1><blockquote class="my"><p id="6180" class="mz na iq bd nb nc nd ne nf ng nh lh dk translated"><em class="ni"/><strong class="ak"><em class="ni">虚拟可扩展局域网</em></strong><em class="ni">(</em><strong class="ak"><em class="ni">VXLAN</em></strong><em class="ni">)是一种</em> <a class="ae kc" href="https://en.wikipedia.org/wiki/Network_virtualization" rel="noopener ugc nofollow" target="_blank"> <em class="ni">网络虚拟化</em> </a> <em class="ni">技术，试图解决</em><a class="ae kc" href="https://en.wikipedia.org/wiki/Scalability" rel="noopener ugc nofollow" target="_blank"><em class="ni"/></a><em class="ni">与大型</em> <a class="ae kc" href="https://en.wikipedia.org/wiki/Cloud_computing" rel="noopener ugc nofollow" target="_blank"> <em class="ni">云计算</em> </a> <em class="ni">部署相关的问题。它采用了一种</em><a class="ae kc" href="https://en.wikipedia.org/wiki/VLAN" rel="noopener ugc nofollow" target="_blank"><em class="ni">【VLAN】</em></a><a class="ae kc" href="https://en.wikipedia.org/wiki/OSI_model" rel="noopener ugc nofollow" target="_blank"><em class="ni">OSI</em></a><em class="ni"/><a class="ae kc" href="https://en.wikipedia.org/wiki/Layer_2" rel="noopener ugc nofollow" target="_blank"><em class="ni">第二层</em> </a> <em class="ni"> </em> <a class="ae kc" href="https://en.wikipedia.org/wiki/Ethernet_frame" rel="noopener ugc nofollow" target="_blank"> <em class="ni">以太帧</em></a><a class="ae kc" href="https://en.wikipedia.org/wiki/Layer_4" rel="noopener ugc nofollow" target="_blank"><em class="ni">第四层</em></a><em class="ni"/><a class="ae kc" href="https://en.wikipedia.org/wiki/User_Datagram_Protocol" rel="noopener ugc nofollow" target="_blank"/><a class="ae kc" href="https://en.wikipedia.org/wiki/User_Datagram_Protocol" rel="noopener ugc nofollow" target="_blank">内<em class="ni">的封装技术终止VXLAN隧道的VXLAN端点，可以是虚拟或物理的</em> </a><a class="ae kc" href="https://en.wikipedia.org/wiki/Switch_port" rel="noopener ugc nofollow" target="_blank"> <em class="ni">交换机端口</em> </a> <em class="ni">，称为</em> <strong class="ak"> <em class="ni"> VXLAN隧道端点</em></strong><em class="ni">(</em><strong class="ak"><em class="ni">VTEPs</em></strong><em class="ni">)。”</em></p></blockquote><blockquote class="nj nk nl"><p id="4ca3" class="kk kl nm km b kn nn kp kq kr no kt ku np nq kx ky nr ns lb lc nt nu lf lg lh ij bi translated">参考:<a class="ae kc" href="https://en.wikipedia.org/wiki/Virtual_Extensible_LAN" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/Virtual_Extensible_LAN</a></p></blockquote><p id="959c" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">此接口的主要功能(在我们的图中为法兰绒1)是通过第2层的覆盖来保证Pod与其网络之间通信的前提之一(记住，每个节点都有一个子网，每个Pod都有该子网的IP)。</p><p id="1a4e" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">使用VXLAN，可以连接两个或多个网络，就像它们连接在同一个网络中一样，也就是说，每个网络都是自己网络的一部分，但都在同一个域中。</p><p id="64ca" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">在之前使用的类比中，VXLAN将是连接一个建筑到另一个建筑的(物理)电话线，允许您所在建筑(节点1)的一个房间(Pod 1)与您的一些同事所在的另一个建筑(节点2)的房间(Pod 4)进行通信。</p></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><h1 id="1677" class="ma mb iq bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">法兰绒</h1><p id="419a" class="pw-post-body-paragraph kk kl iq km b kn oo kp kq kr op kt ku kv oq kx ky kz or lb lc ld os lf lg lh ij bi translated">flanneld 是一个守护进程，负责保持节点(及其包含的pod)之间的路由是最新的。</p><p id="89cb" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">在我们上面的类比中，这就像是每次有新房间可用时(例如，如果酒店建造了一个有房间的新建筑)或当房间变得不可用时(例如，如果它们正在维修)，酒店的一名员工负责更新中心。</p></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><p id="debf" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated"><em class="nm">感谢</em> <a class="ae kc" href="https://medium.com/@ivam.santos" rel="noopener"> <em class="nm"> Ivam Luz </em> </a> <em class="nm">，杰出的价值生成器。</em></p></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><p id="61a1" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">我希望您喜欢这篇文章以及本系列中的其他文章。在下一篇文章中，我们将(<strong class="km ir">最终</strong>，我知道:) )动手开始在云中设置我们的Kubernetes集群！。</p></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><p id="02ea" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">不要忘记在下面的评论中留下你的反馈。不断完善这一系列的内容非常重要。</p><p id="20f9" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">我再次强烈推荐您关注我的Medium，这样您就不会错过本系列中发表的任何新文章。如果你错过了本系列的第一篇文章，你可以在这里查看<a class="ae kc" href="https://medium.com/@mtvallim/kubernetes-journey-up-and-running-out-of-the-cloud-introduction-f04a811c92a5" rel="noopener"/>。</p></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><p id="ff5b" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">回头见！！</p><p id="0b4a" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">再见</p></div></div>    
</body>
</html>