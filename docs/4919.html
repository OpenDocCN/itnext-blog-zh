<html>
<head>
<title>Basic Postgres database in Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes中的基本Postgres数据库</h1>
<blockquote>原文：<a href="https://itnext.io/basic-postgres-database-in-kubernetes-23c7834d91ef?source=collection_archive---------1-----------------------#2020-10-24">https://itnext.io/basic-postgres-database-in-kubernetes-23c7834d91ef?source=collection_archive---------1-----------------------#2020-10-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/45b0a47202648b93169e9f4e31bb6dc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*X7klmLnURu_jnoKq.png"/></div></div></figure><p id="6623" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本文中，我们将在Kubernetes中创建一个Postgres数据库实例，然后使用cronjob连接到这个实例。目标是通过这个练习学习Kubernetes的基础知识。对于学习K8s基础，我强烈推荐<a class="ae kw" href="https://kodekloud.com/" rel="noopener ugc nofollow" target="_blank">这门</a>初学者课程。</p><h1 id="2440" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">设置</h1><ul class=""><li id="6b37" class="lv lw iq ka b kb lx kf ly kj lz kn ma kr mb kv mc md me mf bi translated">首先使用<a class="ae kw" href="https://minikube.sigs.k8s.io/docs/start/" rel="noopener ugc nofollow" target="_blank">这里的</a>中的<a class="ae kw" href="https://minikube.sigs.k8s.io/docs/start/" rel="noopener ugc nofollow" target="_blank"> i </a>指令设置一个<strong class="ka ir"> minikube </strong> Kubernetes集群(我们可以使用其他任何东西，比如GKE、EKS、K3等等。).<strong class="ka ir"> minikube </strong>让你在本地运行Kubernetes。<strong class="ka ir"> minikube </strong>在您的个人电脑上运行单节点Kubernetes集群。</li><li id="906f" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">安装<a class="ae kw" href="https://helm.sh/docs/intro/install/" rel="noopener ugc nofollow" target="_blank"> helm </a>来管理Kubernetes应用程序。管理多个Kubernetes YAML文件变得复杂，这就是赫尔姆帮助缓解事情。</li></ul><h1 id="6d76" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated"><strong class="ak">验证设置</strong></h1><ol class=""><li id="c1af" class="lv lw iq ka b kb lx kf ly kj lz kn ma kr mb kv ml md me mf bi translated">使用，<code class="fe mm mn mo mp b">minikube status</code>命令检查minikube是否启动并运行</li></ol><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="8c62" class="my ky iq mp b gy mz na l nb nc">Let's try K8 : minikube status<br/>minikube<br/>type: Control Plane<br/>host: Running<br/>kubelet: Running<br/>apiserver: Running<br/>kubeconfig: Configured</span></pre><p id="93f7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.验证舵是否安装正确</p><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="4774" class="my ky iq mp b gy mz na l nb nc">Let's try K8 : helm version<br/>version.BuildInfo{Version:"v3.3.4", GitCommit:"a61ce5633af99708171414353ed49547cf05013d", GitTreeState:"dirty", GoVersion:"go1.15.2"}</span></pre><h1 id="ed6c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">安装Postgres</h1><ol class=""><li id="6ca0" class="lv lw iq ka b kb lx kf ly kj lz kn ma kr mb kv ml md me mf bi translated"><a class="ae kw" href="https://helm.sh/docs/helm/helm_repo_add/" rel="noopener ugc nofollow" target="_blank">添加要使用的helm </a>的回购。我将在这里使用bitnami回购。你可以在这里找到他们的文件。如果我们搜索bitnami repo，我们会发现他们提供了两个版本的PostgreSQL，让我们使用第一个版本</li></ol><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="434a" class="my ky iq mp b gy mz na l nb nc">Let's try K8 : helm search repo postgres<br/>NAME                                CHART VERSION APP VERSION DESCRIPTION<br/>bitnami/postgresql                  9.8.3         11.9.0      Chart for PostgreSQL, an object-relational data...<br/>bitnami/postgresql-ha               4.0.1         11.9.1      Chart for PostgreSQL with HA architecture (usin...</span></pre><p id="786b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.让我们安装图表</p><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="49a6" class="my ky iq mp b gy mz na l nb nc">helm install postgres bitnami/postgresql</span></pre><p id="5474" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们看看图表现在是否显示出来</p><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="a198" class="my ky iq mp b gy mz na l nb nc">Let's try K8 : helm list<br/>NAME     NAMESPACE REVISION UPDATED                              STATUS   CHART            APP VERSION<br/>postgres default   1        2020-10-24 10:57:00.678762 -0700 PDT deployed postgresql-9.8.3 11.9.0</span></pre><p id="5a52" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.验证PostgreSQL是否按预期运行</p><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="00fa" class="my ky iq mp b gy mz na l nb nc">helm get notes postgres</span></pre><p id="d994" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">验证所有服务和单元是否都已启动并运行。有趣的是，我们安装了一个持久卷、持久卷声明和StatefulSet。这就是helm的美妙之处，它简化了同时安装多个Kubernetes对象，如果我们不使用helm，我们将不得不创建多个Kubernetes YAML文件，这可能是一场管理噩梦。</p><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="f064" class="my ky iq mp b gy mz na l nb nc">Every 2.0s: kubectl get all -o wide                                                                           </span><span id="9d92" class="my ky iq mp b gy nd na l nb nc">NAME                        READY   STATUS    RESTARTS   AGE     IP           NODE       NOMINATED NODE   READINESS GATES<br/>pod/postgres-postgresql-0   1/1     Running   0          3m32s   172.17.0.3   minikube   &lt;none&gt;           &lt;none&gt;</span><span id="2f8f" class="my ky iq mp b gy nd na l nb nc">NAME                                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE    SELECTOR<br/>service/kubernetes                     ClusterIP   10.x.x.x        &lt;none&gt;        443/TCP    43h    &lt;none&gt;<br/>service/postgres-postgresql            ClusterIP   10.x.x.x<br/>&lt;none&gt;        5432/TCP   5m5s   app.kubernetes.io/instance=postgres,app.kubernetes.io/name=pos<br/>tgresql,role=master<br/>service/postgres-postgresql-headless   ClusterIP   None             &lt;none&gt;        5432/TCP   5m5s   app.kubernetes.io/instance=postgres,app.kubernetes.io/name=pos<br/>tgresql</span><span id="fa26" class="my ky iq mp b gy nd na l nb nc">NAME                                   READY   AGE    CONTAINERS            IMAGES<br/>statefulset.apps/postgres-postgresql   1/1     5m5s   postgres-postgresql   docker.io/bitnami/postgresql:11.9.0-debian-10-r48</span></pre><p id="0b76" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们连接到PostgreSQL并验证我们可以创建一个表并插入值</p><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="36b2" class="my ky iq mp b gy mz na l nb nc">Let's try K8 : export POSTGRES_PASSWORD=$(kubectl get secret --namespace default postgres-postgresql -o jsonpath="{.data.postgresql-password}" | base64 --decode)</span><span id="13b2" class="my ky iq mp b gy nd na l nb nc">Let's try K8 : kubectl run postgres-postgresql-client --rm --tty -i --restart='Never' --namespace default --image docker.io/bitnami/postgresql:11.9.0-debian-10-r48 --env="PGPASSWORD=$POSTGRES_PASSWORD" --command -- psql --host postgres-postgresql -U postgres -d postgres -p 5432</span></pre><p id="8dcf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">看起来我们可以从数据库中插入和查询</p><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="6675" class="my ky iq mp b gy mz na l nb nc">postgres=# CREATE TABLE phonebook(phone VARCHAR(32), firstname VARCHAR(32), lastname VARCHAR(32), address VARCHAR(64));<br/>CREATE TABLE</span><span id="3d00" class="my ky iq mp b gy nd na l nb nc">postgres=# INSERT INTO phonebook(phone, firstname, lastname, address) VALUES('+1 123 456 7890', 'John', 'Doe', 'North America');<br/>INSERT 0 1</span><span id="c5ae" class="my ky iq mp b gy nd na l nb nc">postgres=# SELECT * FROM phonebook ORDER BY lastname;<br/>      phone      | firstname | lastname |    address<br/>-----------------+-----------+----------+---------------<br/> +1 123 456 7890 | John      | Doe      | North America<br/>(1 row)</span></pre><h1 id="b1e2" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">添加一个可以每分钟连接到数据库的cronjob</h1><ol class=""><li id="459c" class="lv lw iq ka b kb lx kf ly kj lz kn ma kr mb kv ml md me mf bi translated">编写一个脚本来连接到数据库</li></ol><p id="3e09" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们使用一个简单的python脚本<code class="fe mm mn mo mp b">connect_db.py</code>来连接数据库。我们使用以下参数。</p><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="811c" class="my ky iq mp b gy mz na l nb nc">Username =&gt; postgres<br/>Password =&gt; $POSTGRES_PASSWORD variable as found previosuly<br/>DB name  =&gt; postgres</span></pre><p id="2c55" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">连接到数据库的Python脚本</p><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="09cd" class="my ky iq mp b gy mz na l nb nc">import sqlalchemy as db</span><span id="3b08" class="my ky iq mp b gy nd na l nb nc">engine = db.create_engine('postgresql://postgres:mq4Jq3C8zK@postgres-postgresql:5432/postgres')</span><span id="58f3" class="my ky iq mp b gy nd na l nb nc">connection = engine.connect()</span><span id="80b8" class="my ky iq mp b gy nd na l nb nc">metadata = db.MetaData(bind=connection, reflect=True)</span><span id="0b42" class="my ky iq mp b gy nd na l nb nc">print(metadata)</span></pre><p id="07a8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.作为Kubernetes集群的一部分，我们如何运行这个脚本呢？</p><p id="4f3f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">A.我们可以将它添加为Docker映像的一部分和在POD中运行的容器。让我们首先创建一个映像来运行这个脚本。</p><p id="b22c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> requirements.txt </strong></p><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="c0a6" class="my ky iq mp b gy mz na l nb nc">sqlalchemy==1.3.16<br/>psycopg2-binary</span></pre><p id="91ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> Dockerfile </strong></p><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="da28" class="my ky iq mp b gy mz na l nb nc">FROM python:3.8-slim</span><span id="5026" class="my ky iq mp b gy nd na l nb nc">WORKDIR /app</span><span id="c5cb" class="my ky iq mp b gy nd na l nb nc">COPY requirements.txt /app</span><span id="ff7b" class="my ky iq mp b gy nd na l nb nc">COPY connect_db.py /app</span><span id="b9f3" class="my ky iq mp b gy nd na l nb nc">RUN pip install -r requirements.txt</span><span id="2c60" class="my ky iq mp b gy nd na l nb nc">CMD python connect_db.py</span></pre><p id="4546" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> connect_db.py </strong></p><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="9f96" class="my ky iq mp b gy mz na l nb nc">import sqlalchemy as db</span><span id="93b8" class="my ky iq mp b gy nd na l nb nc">engine = db.create_engine('postgresql://postgres:mq4Jq3C8zK@postgres-postgresql:5432/postgres')</span><span id="b9db" class="my ky iq mp b gy nd na l nb nc">connection = engine.connect()</span><span id="9e99" class="my ky iq mp b gy nd na l nb nc">metadata = db.MetaData(bind=connection, reflect=True)</span><span id="c419" class="my ky iq mp b gy nd na l nb nc">print(metadata)</span></pre><p id="7ccc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">B.现在让我们来构建图像。</p><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="2bcc" class="my ky iq mp b gy mz na l nb nc">docker build -t postgres_image .<br/>Sending build context to Docker daemon  6.144kB<br/>Step 1/6 : FROM python:3.8-slim<br/> ---&gt; 41dcfe21e8fd<br/>Step 2/6 : WORKDIR /app<br/> ---&gt; Using cache<br/> ---&gt; 00a8320e3c52<br/>Step 3/6 : COPY requirements.txt /app<br/> ---&gt; Using cache<br/> ---&gt; e67a21cc9bb8<br/>Step 4/6 : COPY connect_db.py /app<br/> ---&gt; Using cache<br/> ---&gt; 38a6058e0000<br/>Step 5/6 : RUN pip install -r requirements.txt<br/> ---&gt; Using cache<br/> ---&gt; 07495bf00820<br/>Step 6/6 : CMD python connect_db.py<br/> ---&gt; Using cache<br/> ---&gt; 97b09c86daa9<br/>Successfully built 97b09c86daa9<br/>Successfully tagged postgres_image:latest</span></pre><p id="b338" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">C.让我们创建一个cronjob，它尝试使用一个YAML文件在Kubernetes集群中每分钟运行我们刚刚编写的脚本(根据我们的要求)。<a class="ae kw" href="https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/" rel="noopener ugc nofollow" target="_blank"> Kubernetes的文档</a>也有同样的细节。</p><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="8723" class="my ky iq mp b gy mz na l nb nc">apiVersion: batch/v1beta1<br/>kind: CronJob<br/>metadata:<br/>  name: connect<br/>spec:<br/>  schedule: "*/1 * * * *"<br/>  jobTemplate:<br/>    spec:<br/>      template:<br/>        spec:<br/>          containers:<br/>          - name: connect<br/>            image: postgres_image<br/>          restartPolicy: OnFailure</span></pre><p id="5f51" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们使用kubectl应用同样的方法</p><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="2c2f" class="my ky iq mp b gy mz na l nb nc">kubectl apply -f c.yml<br/>cronjob.batch/connect created</span></pre><p id="6a62" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们验证cronjob</p><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="6c20" class="my ky iq mp b gy mz na l nb nc">kubectl get cronjobs<br/>NAME      SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE<br/>connect   */1 * * * *   False     1        13s             72s</span></pre><p id="9fb9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们验证pod，看起来它正在运行</p><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="1d31" class="my ky iq mp b gy mz na l nb nc">kubectl get po<br/>NAME                       READY   STATUS             RESTARTS   AGE<br/>connect-1603564500-6dk2m   0/1     ImagePullBackOff   0          2m18s<br/>connect-1603564560-q6d4t   0/1     ImagePullBackOff   0          78s<br/>connect-1603564620-dtrgf   0/1     ImagePullBackOff   0          18s<br/>postgres-postgresql-0      1/1     Running            0          29m</span></pre><p id="2bed" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是，如果我们查看POD日志，我们会发现找不到该映像</p><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="9d2b" class="my ky iq mp b gy mz na l nb nc">kubectl logs connect-1603564560-q6d4t<br/>Error from server (BadRequest): container "connect" in pod "connect-1603564560-q6d4t" is waiting to start: image can't be pulled</span></pre><p id="e466" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是因为我们需要在本地或公共注册表中托管图像，否则cronJob无法找到图像。为简单起见，我们将把它放在一个公共注册表中(您也可以放在一个本地注册表中)</p><p id="fc3c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们标记我们的图像</p><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="531f" class="my ky iq mp b gy mz na l nb nc">docker tag postgres_image:latest XXXX/postgres_images:latest</span></pre><p id="14b1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们将图像推送到公共注册中心</p><pre class="mq mr ms mt gt mu mp mv mw aw mx bi"><span id="cf11" class="my ky iq mp b gy mz na l nb nc">docker push XXXX/postgres_images:latest<br/>The push refers to repository [docker.io/XXXX/postgres_images]<br/>1ec918490d02: Pushed<br/>c9daa0dc3fcb: Pushed<br/>6a53aff9114d: Pushed<br/>8be2969ec15c: Pushed<br/>4375d6f45f83: Pushed<br/>06b60c6e6ffd: Pushed<br/>322c3996a80b: Pushed<br/>225ef82ca30a: Pushed<br/>d0fe97fa8b8c: Pushed<br/>latest: digest: sha256:c01442f3efe0e31de148926ad6d6e619be998d6e15d20512ac9c7368ef26ac46 size: 2203</span></pre><p id="bb6b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在cronjob可以每分钟运行一次python脚本来连接我们刚刚安装的PostgreSQL DB。</p><h1 id="6e69" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">摘要</h1><p id="7803" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ne kl km kn nf kp kq kr ng kt ku kv ij bi translated">我们刚刚安装了一个PostgreSQL数据库，并添加了一个每分钟运行一次的cronjob来连接数据库，我们在Kubernetes集群中添加了相同的内容。这是一个简单的例子来理解一些基本知识。在生产中运行PostgreSQL数据库是另一回事，我将在即将发布的帖子中分享我对这个主题的看法。</p></div></div>    
</body>
</html>