<html>
<head>
<title>Kubernetes — Prometheus collect NUMA information</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">库伯内特—普罗米修斯收集NUMA信息</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-prometheus-collect-numa-information-c563acb4a564?source=collection_archive---------4-----------------------#2019-04-25">https://itnext.io/kubernetes-prometheus-collect-numa-information-c563acb4a564?source=collection_archive---------4-----------------------#2019-04-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="6aff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们博客的每一个读者都知道我们关心NUMA架构和优化。尽管架构本身很容易理解，但日常运营却很难优化NUMA平衡。</p><p id="7082" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在纯VMware vSphere环境中跟踪当前的NUMA节点平衡已经很难了，但在顶层使用额外的Kubernetes/Container层对其进行监控会更加困难。</p><p id="04a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将在以后讨论更多的NUMA和其他关键的资源监控和优化，但是让我们从最简单的部分开始。如何使用流行的<a class="ae kl" href="https://github.com/helm/charts/tree/master/stable/prometheus-node-exporter" rel="noopener ugc nofollow" target="_blank">普罗米修斯节点导出器</a>获得Kubernetes节点的NUMA细节。</p><p id="c10b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们假设您已经在您的<a class="ae kl" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>环境中运行了<a class="ae kl" href="https://prometheus.io" rel="noopener ugc nofollow" target="_blank"> Prometheus </a>节点导出器。如果没有，已经有很多很棒的博客文章和一些不错的掌舵图了。</p><p id="5e5c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是其中一个帖子:</p><p id="a91c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://medium.com/devopslinks/trying-prometheus-operator-with-helm-minikube-b617a2dccfa3" rel="noopener">https://medium . com/devopslinks/trying-Prometheus-operator-with helm-minikube-b 617 a2 DCC fa 3</a></p><h1 id="bc1f" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">赫尔姆和达蒙塞特</h1><p id="bde2" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">典型的helm charts创建一个daemonset，它在每个Kubernetes节点上部署节点导出器pod。</p><p id="e44c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这样，您就不需要在每次向群集中添加新节点时都考虑部署节点导出器pod。好的方面是，每个出口商pod都有标签集，所以一旦pod启动并运行，Prometheus就会自动收集指标。</p><h1 id="2271" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">检查普罗米修斯</h1><p id="0d6e" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">如果节点已经被擦除，您可以很容易地检查您的Prometheus服务器:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/d4aa820114aeab56255294a4a99491a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GiGyYGRRsC214Es7.png"/></div></div></figure><p id="e4d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">只需访问prometheus服务器并检查Kubernetes-nodes是否被列为目标。</p><h1 id="49c7" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">检查节点导出器指标</h1><p id="61ef" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">要检查收集的指标，只需键入node_并选择一个指标。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/b8c5819146c30faa15b0c8c66848b2a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YK1tXGNW27anlEuj.png"/></div></div></figure><p id="99c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是当你开始搜索NUMA指标时，这个列表将保持空白(除非你已经做了这篇博客文章所要做的改变)。</p><h1 id="4fe1" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">启用NUMA收集器</h1><p id="21f7" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">当您通读官方文档时，您会注意到默认情况下没有收集一些指标。对于所有与NUMA相关的指标也是如此，这些指标通常可以在/proc/meminfo_numa下找到。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/8efa2734c266f5f07189033723a02136.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IdOOF0Taw_2WUMoI.png"/></div></div></figure><p id="e7ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要启用NUMA收集，您需要为daemonset中的节点导出器窗格设置一些参数。为了获得这些信息，让我们首先搜索daemonset。</p><p id="8af5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步是编辑要更改的daemonset。</p><pre class="lq lr ls lt gt mb mc md me aw mf bi"><span id="11af" class="mg kn iq mc b gy mh mi l mj mk">kubectl edit daemonset.apps/prometheus-node-exporter</span></pre><p id="c94e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里，您应该找到包含args-add<strong class="jp ir">—-collector . meminfo _ numa</strong>的容器的spec部分，并保存文件。</p><pre class="lq lr ls lt gt mb mc md me aw mf bi"><span id="a565" class="mg kn iq mc b gy mh mi l mj mk">spec: containers: - args: - --path.procfs=/host/proc - --path.sysfs=/host/sys - --collector.meminfo_numa</span></pre><p id="c38c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">保存daemonset时，所有相关的pod将自动终止、删除并使用新的参数集创建。</p><p id="20f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">等待几分钟，在普罗米修斯数据库中再次搜索NUMA，您应该会看到一些指标。</p><p id="3658" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">node _ memory _ numa _ interleave _ hit _ total就是一个例子。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/152f218e504d37effaa96653c997f73b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*t3aC2L9dZKPutr3q.png"/></div></div></figure><p id="2214" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完美—现在我们可以在仪表板上添加一些有意义的图表了。您既可以使用自己的Grafana实例，也可以使用我们内置的性能分析器产品(Kubernetes集成仍然是测试版，但离最终发布只有几天了)。如果你想尝试一下，请联系我们。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/994fce08f924ad2996197487d040dc0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0q6QL9raCrPQq7hE.png"/></div></div></figure><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/c688ab4d7a7ea67c3b1f88e584e2859e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lTCw7EEGowq6FmU6.png"/></div></div></figure><ol class=""><li id="8020" class="ml mm iq jp b jq jr ju jv jy mn kc mo kg mp kk mq mr ms mt bi translated">NUMA节点</li><li id="f6a4" class="ml mm iq jp b jq mu ju mv jy mw kc mx kg my kk mq mr ms mt bi translated">NUMA交错命中</li><li id="b8eb" class="ml mm iq jp b jq mu ju mv jy mw kc mx kg my kk mq mr ms mt bi translated">NUMA命中(数字/字节)</li><li id="2e9b" class="ml mm iq jp b jq mu ju mv jy mw kc mx kg my kk mq mr ms mt bi translated">NUMA家小姐</li><li id="8c22" class="ml mm iq jp b jq mu ju mv jy mw kc mx kg my kk mq mr ms mt bi translated">NUMA外国</li><li id="7e23" class="ml mm iq jp b jq mu ju mv jy mw kc mx kg my kk mq mr ms mt bi translated">NUMA本地</li><li id="397c" class="ml mm iq jp b jq mu ju mv jy mw kc mx kg my kk mq mr ms mt bi translated">NUMA其他</li></ol><p id="f42a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您想更多地了解Linux上最重要的NUMA指标，这应该是一个不错的起点:</p><ul class=""><li id="49c3" class="ml mm iq jp b jq jr ju jv jy mn kc mo kg mp kk mz mr ms mt bi translated">numa_hit:从进程需要的节点分配的页数。</li><li id="48e5" class="ml mm iq jp b jq mu ju mv jy mw kc mx kg my kk mz mr ms mt bi translated">numa_miss:从该节点分配的页数，但进程首选另一个节点。</li><li id="1c68" class="ml mm iq jp b jq mu ju mv jy mw kc mx kg my kk mz mr ms mt bi translated">numa_foreign:分配给另一个节点的页数，但流程首选此节点。</li><li id="000e" class="ml mm iq jp b jq mu ju mv jy mw kc mx kg my kk mz mr ms mt bi translated">local_node:当进程在本地运行时，从该节点分配的页数。</li><li id="518f" class="ml mm iq jp b jq mu ju mv jy mw kc mx kg my kk mz mr ms mt bi translated">other_node:当进程远程运行(在另一个节点上)时，从该节点分配的页数。</li><li id="9bba" class="ml mm iq jp b jq mu ju mv jy mw kc mx kg my kk mz mr ms mt bi translated">interleave_hit:使用交叉策略成功分配的页数。</li></ul><p id="c6fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://blog.tsunanet.net/2011/06/clarifications-on-linuxs-numa-stats.html" rel="noopener ugc nofollow" target="_blank">https://blog . tsun anet . net/2011/06/declarations-on-linuxs-numa-stats . html</a></p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><p id="c360" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nh">原载于2019年4月25日</em><a class="ae kl" href="https://www.opvizor.com/kubernetes-configure-prometheus-node-exporter-to-collect-numa-information" rel="noopener ugc nofollow" target="_blank"><em class="nh">【https://www.opvizor.com</em></a><em class="nh">。</em></p></div></div>    
</body>
</html>