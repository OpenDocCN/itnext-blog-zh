<html>
<head>
<title>Testing AWS Cloudwatch alarms</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">测试AWS Cloudwatch警报</h1>
<blockquote>原文：<a href="https://itnext.io/testing-aws-cloudwatch-alarms-75caebcf6da8?source=collection_archive---------2-----------------------#2022-10-09">https://itnext.io/testing-aws-cloudwatch-alarms-75caebcf6da8?source=collection_archive---------2-----------------------#2022-10-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="e2be" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">TL；如何测试你的闹钟是否正常工作！</strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/a482feaca4a58c297d5ed57ee72e8cbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GeAmfswbU-tmpxxT6N--Vw.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">没有测试，没有派对！</figcaption></figure><h1 id="eda3" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">动机</h1><p id="2178" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">AWS CloudWatch 是一个云服务，用于存储和索引任何类型的日志。您可以添加维度、属性等</p><p id="6628" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">借助AWS CloudWatch Insight，我们可以在日志上定义指标、发送嵌入式指标…并创建警报！</p><p id="62da" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如今，为你的服务安装闹钟是必须的。</p><p id="0aa8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">定义指标和警报的规范语言可能有点复杂。</p><p id="1c66" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里的要点是，当您有了度量和/或警报的正确语法时，接下来的问题是:我如何测试它？</p><p id="468b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们看看！</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="4341" class="le lf it bd lg lh mp lj lk ll mq ln lo lp mr lr ls lt ms lv lw lx mt lz ma mb bi translated">AWS CLI救援</h1><p id="a282" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">如果你习惯使用AWS，你可能已经安装了<code class="fe mu mv mw mx b">aws</code> CLI工具。</p><p id="312e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在<code class="fe mu mv mw mx b">cloudwatch</code>部分，我们找到了管理指标和警报的整个生命周期的命令和选项。</p><p id="7959" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您还没有安装，可以使用以下shell命令进行安装</p><p id="02dc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="my">麦克OS X </em></p><pre class="kp kq kr ks gt mz mx na nb aw nc bi"><span id="f060" class="nd lf it mx b gy ne nf l ng nh">$ brew install awscli</span></pre><p id="ce06" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="my"> GNU/Linux </em></p><pre class="kp kq kr ks gt mz mx na nb aw nc bi"><span id="461c" class="nd lf it mx b gy ne nf l ng nh">$ curl "<a class="ae mh" href="https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" rel="noopener ugc nofollow" target="_blank">https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip</a>" -o "awscliv2.zip"<br/>$ unzip awscliv2.zip<br/>$ sudo ./aws/install</span></pre><h1 id="88f7" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">这个例子</h1><p id="edbd" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">我们使用一个非常常见的场景:一个lambda函数。</p><p id="1474" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用AWS SAM格式非常简单。</p><p id="79f4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们的函数是pdf2png。它接收一个PDF文件，将其渲染为图像，并在S3保存为PNG图像。</p><p id="6a51" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本例中，我们定义了两个指标:</p><ul class=""><li id="59ab" class="ni nj it js b jt ju jx jy kb nk kf nl kj nm kn nn no np nq bi translated">PDF文件无效时出错。</li><li id="6122" class="ni nj it js b jt nr jx ns kb nt kf nu kj nv kn nn no np nq bi translated">每个文件的处理时间</li></ul><p id="b516" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">根据这些指标，我们定义了以下警报</p><ul class=""><li id="ae3e" class="ni nj it js b jt ju jx jy kb nk kf nl kj nm kn nn no np nq bi translated">大于阈值的错误pdf的数量</li><li id="35f8" class="ni nj it js b jt nr jx ns kb nt kf nu kj nv kn nn no np nq bi translated">平均处理时间大于阈值</li></ul><h1 id="c509" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">在SAM中定义警报</h1><p id="f9df" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">您可能知道，无服务器应用程序模型(又名SAM)是另一个管理AWS无服务器资源的AWS工具。</p><p id="5fcb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你在过去的某一天创建了一个lambda函数，你很可能会用到它。</p><p id="d582" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">lambda代码本身不在讨论范围内。我们关注警报。</p><h2 id="2b8e" class="nd lf it bd lg nw nx dn lk ny nz dp lo kb oa ob ls kf oc od lw kj oe of ma og bi translated">代码</h2><p id="d5ea" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">我们使用SAM构建和部署我们的代码。</p><p id="16cb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是我们为它准备的<code class="fe mu mv mw mx b">template.yaml</code>。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="a7c7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">正如您在上面的代码中看到的，我们定义了两个警报。</p><p id="8df7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第一个是关于有错误的已处理PDF文件的数量。当在过去的一个小时(3600秒)内有5个或更多的PDF文件处理出错时，将触发此警报。</p><p id="56ae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第二个非常相似，但是在这种情况下，我们希望每个文件的平均处理时间低于15s(但是我们的单位是毫秒)。</p><p id="b321" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了应用，我们调用以下命令</p><pre class="kp kq kr ks gt mz mx na nb aw nc bi"><span id="bcf0" class="nd lf it mx b gy ne nf l ng nh">$ sam build<br/>$ sam deploy --guided</span></pre><p id="03d5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe mu mv mw mx b">guided</code>选项仅在第一次部署时需要。它指定了诸如云形成堆栈名称、回滚策略等内容。</p><p id="99de" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果一切顺利，结局一定和下面这个差不多。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oj"><img src="../Images/f6220507ed84f5d37c1162bbb2a83b05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8yk_ZPDPGNHUztPyJw63dA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">警报已创建！</figcaption></figure><h2 id="b7bf" class="nd lf it bd lg nw nx dn lk ny nz dp lo kb oa ob ls kf oc od lw kj oe of ma og bi translated">获取警报状态</h2><p id="cbb1" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">任何CloudWatch警报在创建后都具有“不足数据”状态。使用cloudwatch命令<code class="fe mu mv mw mx b">describe-alarms</code>我们可以看到它的状态和其他细节。</p><pre class="kp kq kr ks gt mz mx na nb aw nc bi"><span id="7bff" class="nd lf it mx b gy ne nf l ng nh">$ aws cloudwatch describe-alarms --region eu-west-1 --alarm-names pdf-converter-files-error</span><span id="d683" class="nd lf it mx b gy ok nf l ng nh">{<br/>    "MetricAlarms": [<br/>        {<br/>            "ComparisonOperator": "GreaterThanOrEqualToThreshold",<br/>            "StateReason": "Unchecked: Initial alarm creation",<br/>            "InsufficientDataActions": [],<br/>            "AlarmName": "pdf-converter-files-error",<br/>            "StateValue": "INSUFFICIENT_DATA",<br/>            "ActionsEnabled": true,<br/>            "AlarmDescription": "Number of errors in processed PDF files pass the threshold in one hour",<br/>            "Dimensions": [],<br/>            "AlarmActions": [],<br/>            "Threshold": 5.0,<br/>            "TreatMissingData": "missing",<br/>            "OKActions": [],<br/>            "EvaluationPeriods": 1,<br/>            "Namespace": "pdf-converter",<br/>            "Statistic": "Sum",<br/>            "Period": 3600,<br/>            "AlarmConfigurationUpdatedTimestamp": "2022-10-06T09:29:58.012Z",<br/>            "MetricName": "error-pdf-file",<br/>            "AlarmArn": "arn:aws:cloudwatch:eu-west-1:520766964441:alarm:pdf-converter-files-error",<br/>            "StateUpdatedTimestamp": "2022-10-06T09:29:58.012Z"<br/>        }<br/>    ]<br/>}</span></pre><h1 id="a3e8" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">如何输入假指标</h1><p id="f510" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">CloudWatch选项中有一个命令允许我们输入指标数据。我们用它来输入“假”数据，看看警报是否改变了状态。</p><p id="382a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个子命令是<code class="fe mu mv mw mx b">put-metric-data</code>。</p><p id="1db5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">必需的参数有:<code class="fe mu mv mw mx b">namespace</code>、<code class="fe mu mv mw mx b">metric-name</code>、<code class="fe mu mv mw mx b">value</code>，在很多情况下还有<code class="fe mu mv mw mx b">unit.</code></p><p id="8a84" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了测试关于PDF文件平均处理时间的警报，我们在不同的调用中输入以下数据:</p><pre class="kp kq kr ks gt mz mx na nb aw nc bi"><span id="6746" class="nd lf it mx b gy ne nf l ng nh">$ aws cloudwatch put-metric-data --namespace pdf-converter --metric-name pdf-processing-time --value 1200  --unit Milliseconds<br/>$ aws cloudwatch put-metric-data --namespace pdf-converter --metric-name pdf-processing-time --value 4300  --unit Milliseconds<br/>$ aws cloudwatch put-metric-data --namespace pdf-converter --metric-name pdf-processing-time --value 2300  --unit Milliseconds<br/>$ aws cloudwatch put-metric-data --namespace pdf-converter --metric-name pdf-processing-time --value 6300  --unit Milliseconds</span></pre><p id="f91e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果我们现在检查警报状态，</p><pre class="kp kq kr ks gt mz mx na nb aw nc bi"><span id="0561" class="nd lf it mx b gy ne nf l ng nh">$ aws cloudwatch describe-alarms</span><span id="d4e1" class="nd lf it mx b gy ok nf l ng nh">{<br/>            "AlarmName": "pdf-converter-TotalPDFProcessingTimeAlarm-FX2TV7R36S0T",<br/>            "AlarmArn": "arn:aws:cloudwatch:eu-west-1:520766964441:alarm:pdf-converter-TotalPDFProcessingTimeAlarm-FX2TV7R36S0T",<br/>            "AlarmDescription": "Average processing time exceeds threshold",<br/>            "AlarmConfigurationUpdatedTimestamp": "2022-10-09T09:36:56.511Z",<br/>            "ActionsEnabled": true,<br/>            "OKActions": [],<br/>            "AlarmActions": [],<br/>            "InsufficientDataActions": [],<br/>            <strong class="mx iu">"StateValue": "OK"</strong>,<br/>            "StateReason": "Threshold Crossed: 1 datapoint [1200.0 (08/10/22 09:39:00)] was not greater than or equal to the threshold (15000.0).",<br/>            "StateReasonData": "{\"version\":\"1.0\",\"queryDate\":\"2022-10-09T09:39:13.827+0000\",\"startDate\":\"2022-10-08T09:39:00.000+0000\",\"unit\":\"Milliseconds\",\"statistic\":\"Average\",\"period\":86400,\"recentDatapoints\":[1200.0],\"threshold\":15000.0,\"evaluatedDatapoints\":[{\"timestamp\":\"2022-10-08T09:39:00.000+0000\",\"sampleCount\":1.0,\"value\":1200.0}]}",<br/>            "StateUpdatedTimestamp": "2022-10-09T09:39:13.829Z",<br/>            "MetricName": "pdf-processing-time",<br/>            "Namespace": "pdf-converter",<br/>            "Statistic": "Average",<br/>            "Dimensions": [],<br/>            "Period": 86400,<br/>            "Unit": "Milliseconds",<br/>            "EvaluationPeriods": 1,<br/>            "Threshold": 15000.0,<br/>            "ComparisonOperator": "GreaterThanOrEqualToThreshold"<br/>}</span></pre><p id="e7e0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一切正常…我们去触发它吧。</p><pre class="kp kq kr ks gt mz mx na nb aw nc bi"><span id="245b" class="nd lf it mx b gy ne nf l ng nh">$ aws cloudwatch put-metric-data --namespace pdf-converter --metric-name pdf-processing-time --value 61300  --unit Milliseconds<br/>$ aws cloudwatch put-metric-data --namespace pdf-converter --metric-name pdf-processing-time --value 161300  --unit Milliseconds<br/>$ aws cloudwatch put-metric-data --namespace pdf-converter --metric-name pdf-processing-time --value 13300  --unit Milliseconds</span></pre><p id="cf42" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通常情况下，警报需要几分钟的时间来重新评估。但是我们可以手动强制评估设置警报状态为“数据不足”。</p><pre class="kp kq kr ks gt mz mx na nb aw nc bi"><span id="e5f5" class="nd lf it mx b gy ne nf l ng nh">$ aws cloudwatch set-alarm-state --alarm-name processing-time-exceeds-alarm --state-value "INSUFFICIENT_DATA" --state-reason "manual testing"</span></pre><p id="518c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">…答对了！</p><pre class="kp kq kr ks gt mz mx na nb aw nc bi"><span id="9627" class="nd lf it mx b gy ne nf l ng nh">$ aws cloudwatch describe-alarms</span><span id="abdf" class="nd lf it mx b gy ok nf l ng nh">{<br/>    "MetricAlarms": [<br/>        {<br/>            "AlarmName": "pdf-converter-TotalPDFProcessingTimeAlarm-FX2TV7R36S0T",<br/>            "AlarmArn": "arn:aws:cloudwatch:eu-west-1:520766964441:alarm:pdf-converter-TotalPDFProcessingTimeAlarm-FX2TV7R36S0T",<br/>            "AlarmDescription": "Average processing time exceeds threshold",<br/>            "AlarmConfigurationUpdatedTimestamp": "2022-10-09T09:36:56.511Z",<br/>            "ActionsEnabled": true,<br/>            "OKActions": [],<br/>            "AlarmActions": [],<br/>            "InsufficientDataActions": [],<br/>            <strong class="mx iu">"StateValue": "ALARM"</strong>,<br/>            "StateReason": "Threshold Crossed: 1 datapoint [<strong class="mx iu">35714.2857142857</strong>2 (08/10/22 09:47:00)] was greater than or equal to the threshold (15000.0).",<br/>            "StateReasonData": "{\"version\":\"1.0\",\"queryDate\":\"2022-10-09T09:47:13.813+0000\",\"startDate\":\"2022-10-08T09:47:00.000+0000\",\"unit\":\"Milliseconds\",\"statistic\":\"Average\",\"period\":86400,\"recentDatapoints\":[35714.28571428572],\"threshold\":15000.0,\"evaluatedDatapoints\":[{\"timestamp\":\"2022-10-08T09:47:00.000+0000\",\"sampleCount\":7.0,\"value\":35714.28571428572}]}",<br/>            "StateUpdatedTimestamp": "2022-10-09T09:47:13.815Z",<br/>            "MetricName": "pdf-processing-time",<br/>            "Namespace": "pdf-converter",<br/>            "Statistic": "Average",<br/>            "Dimensions": [],<br/>            "Period": 86400,<br/>            "Unit": "Milliseconds",<br/>            "EvaluationPeriods": 1,<br/>            "Threshold": 15000.0,<br/>            "ComparisonOperator": "GreaterThanOrEqualToThreshold"<br/>        }<br/>    ],<br/>    "CompositeAlarms": []<br/>}</span></pre><p id="3a2d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果我们进入AWS Cloudwatch控制台，我们也可以看到警报通知。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ol"><img src="../Images/108f6b37c52f3a7ecbeac9ac51b9c41d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RppKNBmZmTqU_KI0BkV6fg.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">向洞里开火！</figcaption></figure><h1 id="f3cf" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="1290" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">如今，为所有事情开发测试是一种最佳实践。据我所知，还没有解决方案来测试这种基础设施的东西。如果你知道什么，请与我分享。</p><p id="beb5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">同时，多亏了CLI，我们可以执行一些基本的测试。</p></div></div>    
</body>
</html>