<html>
<head>
<title>Scripted OKTA / ZScaler Authentication with Curl</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Curl的脚本化OKTA / ZScaler认证</h1>
<blockquote>原文：<a href="https://itnext.io/scripted-okta-zscaler-authentication-with-curl-84c93df74652?source=collection_archive---------5-----------------------#2022-07-04">https://itnext.io/scripted-okta-zscaler-authentication-with-curl-84c93df74652?source=collection_archive---------5-----------------------#2022-07-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/4f1d192c604ed5f7a7cff8b865086d5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tmTWajjdwoPrQ_rC.jpg"/></div></div></figure><p id="2f7e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最近，我不得不编写一个shell脚本，仅使用命令行工具通过<a class="ae kw" href="https://okta.com" rel="noopener ugc nofollow" target="_blank"> OKTA </a>向<a class="ae kw" href="https://www.zscaler.com/" rel="noopener ugc nofollow" target="_blank"> ZScaler </a>认证用户。似乎SSO登录协议主要是为浏览器开发的。关于如何通过脚本实现这一点的相关信息很难找到，坦率地说，这花费了我比我希望的更长的时间。</p><p id="9c6a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">简而言之，很多解决方案都求助于无头浏览器来模拟登录，就像人们交互操作一样。对我来说，这听起来像一个黑客，毕竟，浏览器重定向和认证协议只不过是一些HTTP重定向，同时在cookie中传递重要的令牌。</p><p id="215c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果其他人遇到这个问题，下面是解决方法:</p><h2 id="6188" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">1.向OKTA认证用户</h2><p id="f37f" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">第一步是向OKTA认证用户。您的公司或应用程序将拥有自己专用的OKTA URL，例如<a class="ae kw" href="https://acme_org.okta.com" rel="noopener ugc nofollow" target="_blank">https://acme.okta.com</a>。这里您要做的是使用OKTA authn API，如下所示:</p><figure class="lv lw lx ly gt jr"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="e652" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里需要注意的重要一点是传递给<code class="fe mb mc md me b">curl. </code>的cookie标志。cookie允许在连续调用之间传递重要的SAML令牌信息。</p><p id="c2eb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，从身份验证响应中，我们可以检索这个令牌需要被交换为会话cookie的<code class="fe mb mc md me b">SESSION_TOKEN.</code>。</p><h2 id="c6cb" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">2.获取会话Cookie</h2><p id="bd47" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">下一步是通过调用以下API将会话令牌交换为会话cookie。</p><figure class="lv lw lx ly gt jr"><div class="bz fp l di"><div class="lz ma l"/></div></figure><h2 id="a4f1" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">3.获取SAML请求重定向URL</h2><p id="6858" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">现在我们有了会话cookie，我们需要获得SAML请求有效负载。为此，我们调用您希望连接的ZScaler端点的URL，如下所示:</p><figure class="lv lw lx ly gt jr"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="05a0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从ZScaler的角度来看，这个HTML页面返回一个隐藏的表单，该表单会触发浏览器中的重定向。我们从这个表单中需要的只是重定向位置，因为SAML请求会自动存储在cookie中。</p><h2 id="9e13" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">4.获取SAML响应有效负载</h2><p id="5ecf" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">上面的URL很可能会发出一系列重定向。幸运的是，有了<code class="fe mb mc md me b">-L </code>标志，<code class="fe mb mc md me b">curl</code>将重定向到正确的OKTA URL，在那里我们可以检索SAML响应有效负载，如下所示:</p><figure class="lv lw lx ly gt jr"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="48b3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在第1行，我们检索SAML响应有效负载。在第2行和第3行，我们使用一些命令行实用程序来提取响应本身以及SAML重定向URL到ZScaler。</p><p id="486d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还必须确保对有效载荷进行解码，以获得原始的、非url编码的有效载荷，因此调用了<code class="fe mb mc md me b">recode.</code></p><h2 id="93d1" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">4.登录ZScaler</h2><p id="3cb9" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">最后一步是将经过身份验证的用户重定向回ZScaler。cookie现在包含允许ZScaler将用户登录到应用程序的断言。</p><figure class="lv lw lx ly gt jr"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="a837" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这最后一步之后，可以使用cookie对ZScaler中运行的应用程序执行其他与脚本相关的操作。</p><h2 id="99ba" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">把所有的放在一起</h2><figure class="lv lw lx ly gt jr"><div class="bz fp l di"><div class="lz ma l"/></div></figure><h1 id="e6ae" class="mf ky iq bd kz mg mh mi lc mj mk ml lf mm mn mo li mp mq mr ll ms mt mu lo mv bi translated">结论</h1><p id="6bee" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">在这个例子中，我成功地通过OKTA向ZScaler应用程序验证了一个用户。希望这能在将来帮助其他人。</p></div><div class="ab cl mw mx hu my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="ij ik il im in"><p id="f1b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你从这篇文章中受益，请考虑关注我，这是在媒体上建立追随者基础并确保我的努力到达目标受众的唯一方法。</p></div></div>    
</body>
</html>