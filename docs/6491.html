<html>
<head>
<title>Building Micronaut applications with Micronaut Data Jdbc and Kotlin</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Micronaut数据Jdbc和Kotlin构建Micronaut应用程序</h1>
<blockquote>原文：<a href="https://itnext.io/building-micronaut-applications-with-micronaut-data-jdbc-and-kotlin-81c1b6cf4b10?source=collection_archive---------0-----------------------#2021-12-02">https://itnext.io/building-micronaut-applications-with-micronaut-data-jdbc-and-kotlin-81c1b6cf4b10?source=collection_archive---------0-----------------------#2021-12-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="4756" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Micronaut Data对Jdbc和R2dbc也有很大的支持。在本文中，我们将探索Micronaut数据Jdbc并用Kotlin语言编写示例，最后我们将使用Kotest测试组件。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/e9b4cbab42514bc38fab6c8d5d507ef3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vpMi-XOcWMHQnUiqVqNeOg.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated"><a class="ae lb" href="https://unsplash.com/@dongmingwei?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">董</a>在<a class="ae lb" href="https://unsplash.com/s/photos/china-snow?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><h1 id="8faa" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">入门指南</h1><p id="a79f" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">打开浏览器，导航到<a class="ae lb" href="https://micronaut.io/launch" rel="noopener ugc nofollow" target="_blank"> Micronaut Launch </a>为这篇文章生成一个新的项目框架。在此页面上选择以下项目。</p><ul class=""><li id="6eb0" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mk ml mm mn bi translated">Java版本:<strong class="jp ir"> 17 </strong></li><li id="b37e" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">语言:<strong class="jp ir">科特林</strong></li><li id="6512" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">构建工具:<strong class="jp ir"> Gradle </strong></li><li id="6e06" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">测试框架:<strong class="jp ir"> Kotest </strong></li><li id="4398" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">包含的特性:<strong class="jp ir"> data-jdbc </strong>、<strong class="jp ir"> postgres </strong>等。</li></ul><p id="4829" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击<strong class="jp ir">生成项目</strong>按钮，生成一个项目档案，下载后解压到磁盘，导入到你的IDE，比如IDEA。</p><p id="f6c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建实体类。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="7c1e" class="my ld iq mu b gy mz na l nb nc">@MappedEntity(value = "posts", namingStrategy = NamingStrategies.UnderScoreSeparatedLowerCase::class)<br/>data class Post(<br/>    @field:Id @field:GeneratedValue(GeneratedValue.Type.UUID) var id: UUID? = null,<br/>    var title: String,<br/>    var content: String,<br/>    var status: Status? = Status.DRAFT,<br/>    @field:DateCreated var createdAt: LocalDateTime? = LocalDateTime.now()<br/>)</span></pre><p id="7622" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我们声明一个Kotlin <code class="fe nd ne nf mu b">data class</code>来表示映射表中的数据。类似于JPA注释，您可以在映射到后端表主键的字段上设置<code class="fe nd ne nf mu b">ID</code>和<code class="fe nd ne nf mu b">GeneratedValue</code>。类似于Spring数据项目的审计特性，当实体被持久化时，标注有<code class="fe nd ne nf mu b">@DateCreated</code>的<code class="fe nd ne nf mu b">createdAt</code>字段将被自动填充。</p><p id="bf8e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">状态是一个枚举类。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="d475" class="my ld iq mu b gy mz na l nb nc">enum class Status {<br/>    DRAFT, PENDING_MODERATED, PUBLISHED, REJECTED<br/>}</span></pre><blockquote class="ng nh ni"><p id="bb68" class="jn jo nj jp b jq jr js jt ju jv jw jx nk jz ka kb nl kd ke kf nm kh ki kj kk ij bi translated"><em class="iq">注:</em> <code class="fe nd ne nf mu b"><em class="iq">ID</em></code> <em class="iq">和</em> <code class="fe nd ne nf mu b"><em class="iq">GeneratedValue</em></code> <em class="iq">来自</em> <code class="fe nd ne nf mu b"><em class="iq">io.micronaut.data.annotation</em></code> <em class="iq">包。</em></p></blockquote><p id="c316" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为<code class="fe nd ne nf mu b">Post</code>实体类创建一个<code class="fe nd ne nf mu b">Repository</code>。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="bcd2" class="my ld iq mu b gy mz na l nb nc">@JdbcRepository<br/>interface PostRepository : PageableRepository&lt;Post, UUID&gt;</span></pre><p id="48c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我们使用了一个<code class="fe nd ne nf mu b">JdbcRepository</code>来表示这个存储库是一个<strong class="jp ir">数据——JDBC</strong><code class="fe nd ne nf mu b">Repository</code>。</p><p id="ca5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个bean来初始化一些示例数据。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="04e3" class="my ld iq mu b gy mz na l nb nc">@Singleton<br/>@Requires(notEnv = ["mock"])<br/>class DataInitializer(private val posts: PostRepository) {</span><span id="c733" class="my ld iq mu b gy nn na l nb nc">    @EventListener<br/>    fun onStartUp(e: ServerStartupEvent) {<br/>        log.info("starting data initialization at ServerStartupEvent: $e")</span><span id="e2ea" class="my ld iq mu b gy nn na l nb nc">        posts.deleteAll()</span><span id="6ef8" class="my ld iq mu b gy nn na l nb nc">        val data = listOf(<br/>            Post(title = "Building Restful APIs with Micronaut and Kotlin", content = "test"),<br/>            Post(title = "Building Restful APIs with Micronaut and Kotlin: part 2", content = "test")<br/>        )<br/>        data.forEach { log.debug("saving: $it") }<br/>        posts.saveAll(data).forEach { log.debug("saved post: $it") }<br/>        log.info("data initialization is done...")<br/>    }</span><span id="4cd6" class="my ld iq mu b gy nn na l nb nc">    companion object DataInitializer {<br/>        private val log = LoggerFactory.getLogger(DataInitializer::class.java)<br/>    }</span><span id="1764" class="my ld iq mu b gy nn na l nb nc">}</span></pre><p id="c8cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在创建一个控制器来公开RESTful APIs。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="7508" class="my ld iq mu b gy mz na l nb nc">@Controller("/posts")<br/>class PostController(private val posts: PostRepository) {</span><span id="4abe" class="my ld iq mu b gy nn na l nb nc">    @Get(uri = "/", produces = [MediaType.APPLICATION_JSON])<br/>    fun all(): HttpResponse&lt;List&lt;Post&gt;&gt; = ok(posts.findAll().toList())</span><span id="385a" class="my ld iq mu b gy nn na l nb nc">    @Get(uri = "/{id}", produces = [MediaType.APPLICATION_JSON])<br/>    fun byId(@PathVariable id: UUID): HttpResponse&lt;Any&gt; {<br/>        val post = posts.findById(id) ?: return notFound()<br/>        return ok(post)<br/>    }</span><span id="19f7" class="my ld iq mu b gy nn na l nb nc">    @io.micronaut.http.annotation.Post(consumes = [MediaType.APPLICATION_JSON])<br/>    fun create(@Body body: Post): HttpResponse&lt;Any&gt; {<br/>        val saved = posts.save(body)<br/>        return created(URI.create("/posts/" + saved.id))<br/>    }<br/>}</span></pre><p id="91e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们尝试启动应用程序，确保有一个正在运行的Postgres数据库，数据库设置应该与<em class="nj"> application.yaml </em>中的配置匹配。</p><p id="c52d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">简单地说，你可以通过docker编写文件来准备数据库。在docker中运行下面的命令启动一个Postgres，数据库细节在<em class="nj"> docker-compose.yaml </em>中定义。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="731d" class="my ld iq mu b gy mz na l nb nc"># docker compose up postgres</span></pre><p id="18fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在运行应用程序。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="6712" class="my ld iq mu b gy mz na l nb nc"># gradlew run <br/>// or <br/># gradlew build<br/># java build/xxx.jar</span></pre><p id="a075" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以使用<code class="fe nd ne nf mu b">curl</code>命令来测试<em class="nj"> /posts </em>端点。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="47a8" class="my ld iq mu b gy mz na l nb nc"># curl <a class="ae lb" href="http://localhost:8080/posts" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/posts</a></span></pre><h1 id="3a6c" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">按规格查询</h1><p id="2f82" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">如果你有一些Spring Data JPA的经验，你会对JPA规范印象深刻，但它只适用于Spring Data JPA。在Micronaut数据中，<strong class="jp ir"> data-jdbc </strong>也支持JPA规范的查询。</p><p id="af48" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将<code class="fe nd ne nf mu b">jakarta.persistence:jakarta.persistence-api:3.0.0</code>添加到依赖项中。</p><p id="8068" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">改变<code class="fe nd ne nf mu b">PostRepository</code>，使其延伸<code class="fe nd ne nf mu b">JpaSpecificationExecutor</code>。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="687d" class="my ld iq mu b gy mz na l nb nc">@JdbcRepository<br/>interface PostRepository : PageableRepository&lt;Post, UUID&gt;, JpaSpecificationExecutor&lt;Post&gt;</span></pre><p id="459e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一系列的<code class="fe nd ne nf mu b">Specfication</code>，例如，通过标题查找，通过关键字查找，或者拒绝所有状态为<code class="fe nd ne nf mu b">PENDING_MODERATED</code>的帖子，删除所有<code class="fe nd ne nf mu b">REJECTED</code>的帖子。在Micronaut数据中，有一些<code class="fe nd ne nf mu b">PredicateSpecification</code>的变体，比如<code class="fe nd ne nf mu b">QuerySpecificaiton</code>、<code class="fe nd ne nf mu b">UpdateSpecification</code>和<code class="fe nd ne nf mu b">DeleteSpecification</code>。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="bee7" class="my ld iq mu b gy mz na l nb nc">object Specifications {</span><span id="4bae" class="my ld iq mu b gy nn na l nb nc">    fun titleLike(title: String): PredicateSpecification&lt;Post&gt; {<br/>        return PredicateSpecification&lt;Post&gt; { root, criteriaBuilder -&gt;<br/>            criteriaBuilder.like(<br/>                root.get("title"),<br/>                "%$title%"<br/>            )<br/>        }<br/>    }</span><span id="a9ff" class="my ld iq mu b gy nn na l nb nc">    fun byKeyword(q: String): QuerySpecification&lt;Post&gt; {<br/>        return QuerySpecification&lt;Post&gt; { root, query, criteriaBuilder -&gt;<br/>            criteriaBuilder.or(<br/>                criteriaBuilder.like(root.get("title"), "%$q%"),<br/>                criteriaBuilder.like(root.get("content"), "%$q%")<br/>            )<br/>        }<br/>    }</span><span id="5927" class="my ld iq mu b gy nn na l nb nc">    fun rejectAllPendingModerated(): UpdateSpecification&lt;Post&gt; {<br/>        return UpdateSpecification&lt;Post&gt; {root, query, criteriaBuilder -&gt;<br/>            query.set(root.get("status"), Status.REJECTED)<br/>            criteriaBuilder.equal(root.get&lt;Status&gt;("status"), Status.PENDING_MODERATED)<br/>        }<br/>    }</span><span id="66a7" class="my ld iq mu b gy nn na l nb nc">    fun removeAllRejected(): DeleteSpecification&lt;Post&gt; {<br/>        return DeleteSpecification&lt;Post&gt; {root, query, criteriaBuilder -&gt;<br/>            criteriaBuilder.equal(root.get&lt;Status&gt;("status"), Status.REJECTED)<br/>        }<br/>    }</span><span id="f4af" class="my ld iq mu b gy nn na l nb nc">}</span></pre><p id="ff4f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们创建一些测试来验证这些规范。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="6aa7" class="my ld iq mu b gy mz na l nb nc">@MicronautTest(environments = [Environment.TEST], startApplication = false)<br/>open class PostRepositoryAnnotationSpec() : AnnotationSpec() {<br/>    companion object {<br/>        private val log: Logger = LoggerFactory.getLogger(PostControllerTest::class.java)<br/>    }</span><span id="0480" class="my ld iq mu b gy nn na l nb nc">    @Inject<br/>    private lateinit var posts: PostRepository</span><span id="b0d4" class="my ld iq mu b gy nn na l nb nc">    @Inject<br/>    private lateinit var template: JdbcOperations</span><span id="2d0a" class="my ld iq mu b gy nn na l nb nc">    @Inject<br/>    private lateinit var tx: TransactionOperations&lt;Any&gt;</span><span id="4429" class="my ld iq mu b gy nn na l nb nc">    @BeforeEach<br/>    fun beforeEach() {<br/>        val callback: TransactionCallback&lt;Any, Int&gt; = TransactionCallback { _: TransactionStatus&lt;Any&gt; -&gt;<br/>            val sql = "delete from posts";<br/>            this.template.prepareStatement(sql) {<br/>                it.executeUpdate()<br/>            }<br/>        }</span><span id="0f2e" class="my ld iq mu b gy nn na l nb nc">        val cnt = tx.executeWrite(callback)<br/>        println("deleted $cnt");<br/>    }</span><span id="18d6" class="my ld iq mu b gy nn na l nb nc">    @Test<br/>    fun `test save and find posts`() {<br/>        val sql = "insert into posts(title, content, status) values (?, ?, ?)";<br/>        val insertedCnt = template.prepareStatement(sql) {<br/>            it.setString(1, "test title")<br/>            it.setString(2, "test content")<br/>            it.setString(3, "DRAFT")<br/>            it.executeUpdate()<br/>        }</span><span id="83c7" class="my ld iq mu b gy nn na l nb nc">        insertedCnt shouldBeEqualComparingTo 1<br/>        val all = posts.findAll()<br/>        all shouldHaveSize 1<br/>        log.debug("all posts: $all")<br/>        all.map { it.title }.forAny { it shouldContain "test" }<br/>    }</span><span id="bf81" class="my ld iq mu b gy nn na l nb nc">    @Test<br/>    fun `find by title`() {<br/>        val sql = "insert into posts(title, content, status) values (?, ?, ?)";<br/>        val insertedCnt = template.prepareStatement(sql) {<br/>            it.setString(1, "test title")<br/>            it.setString(2, "test content")<br/>            it.setString(3, "DRAFT")<br/>            it.executeUpdate()<br/>        }</span><span id="c346" class="my ld iq mu b gy nn na l nb nc">        insertedCnt shouldBeEqualComparingTo 1<br/>        val all = posts.findAll(Specifications.titleLike("test"))<br/>        log.debug("all posts size:{}", all.size)<br/>        all shouldHaveSize 1</span><span id="091c" class="my ld iq mu b gy nn na l nb nc">        val all2 = posts.findAll(Specifications.titleLike("test2"))<br/>        log.debug("all2 posts size:{}", all2.size)<br/>        all2 shouldHaveSize 0<br/>    }</span><span id="0b10" class="my ld iq mu b gy nn na l nb nc">    @Test<br/>    fun `find by keyword`() {<br/>        val sql = "insert into posts(title, content, status) values (?, ?, ?)";<br/>        val insertedCnt = template.prepareStatement(sql) {<br/>            it.setString(1, "test title")<br/>            it.setString(2, "test content")<br/>            it.setString(3, "DRAFT")<br/>            it.addBatch()<br/>            it.setString(1, "test2 title")<br/>            it.setString(2, "test2 content")<br/>            it.setString(3, "DRAFT")<br/>            it.addBatch()<br/>            it.executeBatch()<br/>        }</span><span id="4d12" class="my ld iq mu b gy nn na l nb nc">        insertedCnt.any { it == 1 }<br/>        val all = posts.findAll(Specifications.byKeyword("test"))<br/>        log.debug("all posts size:{}", all.size)<br/>        all shouldHaveSize 2</span><span id="ef07" class="my ld iq mu b gy nn na l nb nc">        val all2 = posts.findAll(Specifications.byKeyword("test2"))<br/>        log.debug("all2 posts size:{}", all2.size)<br/>        all2 shouldHaveSize 1<br/>    }</span><span id="4113" class="my ld iq mu b gy nn na l nb nc">    @Test<br/>    fun `update posts`() {<br/>        val sql = "insert into posts(title, content, status) values (?, ?, ?)";<br/>        val insertedCnt = template.prepareStatement(sql) {<br/>            it.setString(1, "test title")<br/>            it.setString(2, "test content")<br/>            it.setString(3, "PENDING_MODERATED")<br/>            it.addBatch()<br/>            it.setString(1, "test2 title")<br/>            it.setString(2, "test2 content")<br/>            it.setString(3, "PENDING_MODERATED")<br/>            it.addBatch()<br/>            it.executeBatch()<br/>        }</span><span id="b338" class="my ld iq mu b gy nn na l nb nc">        insertedCnt.any { it == 1 }<br/>        val updated = posts.updateAll(Specifications.rejectAllPendingModerated())<br/>        log.debug("updated posts size:{}", updated)<br/>        updated shouldBe 2</span><span id="2624" class="my ld iq mu b gy nn na l nb nc">        val all = posts.findAll()<br/>        all shouldHaveSize 2<br/>        all.map { it.status }.forAny { it shouldBe Status.REJECTED }<br/>    }</span><span id="2162" class="my ld iq mu b gy nn na l nb nc">    @Test<br/>    fun `remove posts`() {<br/>        val sql = "insert into posts(title, content, status) values (?, ?, ?)";<br/>        val insertedCnt = template.prepareStatement(sql) {<br/>            it.setString(1, "test title")<br/>            it.setString(2, "test content")<br/>            it.setString(3, "REJECTED")<br/>            it.addBatch()<br/>            it.setString(1, "test2 title")<br/>            it.setString(2, "test2 content")<br/>            it.setString(3, "DRAFT")<br/>            it.addBatch()<br/>            it.executeBatch()<br/>        }</span><span id="37c5" class="my ld iq mu b gy nn na l nb nc">        insertedCnt.any { it == 1 }<br/>        val deleted = posts.deleteAll(Specifications.removeAllRejected())<br/>        log.debug("deleted posts size:{}", deleted)<br/>        deleted shouldBe 1</span><span id="0cff" class="my ld iq mu b gy nn na l nb nc">        val all = posts.findAll()<br/>        all shouldHaveSize 1<br/>        all.map { it.status }.forAny { it shouldBe Status.DRAFT }<br/>    }<br/>}</span></pre><p id="4acb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">类似于Spring Jdbc和Spring Data Jdbc，有一个基于模板的<code class="fe nd ne nf mu b">JdbcOperations</code> bean可用于编程数据库操作。在上述测试代码中，我们使用<code class="fe nd ne nf mu b">JdbcOperations</code>来准备和清理每个测试的样本数据。</p><p id="60c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个应用程序中，我们使用Kotest作为测试框架。</p><p id="4bf4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kotest提供了许多测试代码风格，有些是受NodeJS生态系统或ScalaTest中现有的<code class="fe nd ne nf mu b">describe/it</code>子句的启发。</p><p id="390d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe nd ne nf mu b">AnnotationSpec</code>类似于传统的JUnit编码风格，对于那些来自JUnit的人来说，迁移到Kotest测试框架是零学习曲线。</p><h1 id="f412" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">Kotest</h1><p id="0739" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">最简单的是<code class="fe nd ne nf mu b">SpringSpec</code>，用一个<em class="nj">字符串</em>来描述功能。让我们用<code class="fe nd ne nf mu b">StringSepc</code>重写上面的测试代码。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="2bd5" class="my ld iq mu b gy mz na l nb nc">@MicronautTest(environments = [Environment.TEST], startApplication = false)<br/>class PostRepositoryTest(<br/>    private val posts: PostRepository,<br/>    private val template: JdbcOperations,<br/>    private val tx: TransactionOperations&lt;Any&gt;<br/>) : StringSpec({</span><span id="a06a" class="my ld iq mu b gy nn na l nb nc">    "test save and find posts" {<br/>        val sql = "insert into posts(title, content, status) values (?, ?, ?)";<br/>        val insertedCnt = template.prepareStatement(sql) {<br/>            it.setString(1, "test title")<br/>            it.setString(2, "test content")<br/>            it.setString(3, "DRAFT")<br/>            it.executeUpdate()<br/>        }</span><span id="3e7c" class="my ld iq mu b gy nn na l nb nc">        insertedCnt shouldBeEqualComparingTo 1<br/>        val all = posts.findAll()<br/>        all shouldHaveSize 1<br/>        log.debug("all posts: $all")<br/>        all.map { it.title }.forAny { it shouldContain "test" }<br/>    }</span><span id="2b14" class="my ld iq mu b gy nn na l nb nc">    "find by title" {<br/>        val sql = "insert into posts(title, content, status) values (?, ?, ?)";<br/>        val insertedCnt = template.prepareStatement(sql) {<br/>            it.setString(1, "test title")<br/>            it.setString(2, "test content")<br/>            it.setString(3, "DRAFT")<br/>            it.executeUpdate()<br/>        }</span><span id="dd89" class="my ld iq mu b gy nn na l nb nc">        insertedCnt shouldBeEqualComparingTo 1<br/>        val all = posts.findAll(Specifications.titleLike("test"))<br/>        log.debug("all posts size:{}", all.size)<br/>        all shouldHaveSize 1</span><span id="8fe0" class="my ld iq mu b gy nn na l nb nc">        val all2 = posts.findAll(Specifications.titleLike("test2"))<br/>        log.debug("all2 posts size:{}", all2.size)<br/>        all2 shouldHaveSize 0<br/>    }</span><span id="bfc3" class="my ld iq mu b gy nn na l nb nc">    "find by keyword" {<br/>        val sql = "insert into posts(title, content, status) values (?, ?, ?)";<br/>        val insertedCnt = template.prepareStatement(sql) {<br/>            it.setString(1, "test title")<br/>            it.setString(2, "test content")<br/>            it.setString(3, "DRAFT")<br/>            it.addBatch()<br/>            it.setString(1, "test2 title")<br/>            it.setString(2, "test2 content")<br/>            it.setString(3, "DRAFT")<br/>            it.addBatch()<br/>            it.executeBatch()<br/>        }</span><span id="8121" class="my ld iq mu b gy nn na l nb nc">        insertedCnt.any { it == 1 }<br/>        val all = posts.findAll(Specifications.byKeyword("test"))<br/>        log.debug("all posts size:{}", all.size)<br/>        all shouldHaveSize 2</span><span id="b8d1" class="my ld iq mu b gy nn na l nb nc">        val all2 = posts.findAll(Specifications.byKeyword("test2"))<br/>        log.debug("all2 posts size:{}", all2.size)<br/>        all2 shouldHaveSize 1<br/>    }</span><span id="f09b" class="my ld iq mu b gy nn na l nb nc">    "update posts" {<br/>        val sql = "insert into posts(title, content, status) values (?, ?, ?)";<br/>        val insertedCnt = template.prepareStatement(sql) {<br/>            it.setString(1, "test title")<br/>            it.setString(2, "test content")<br/>            it.setString(3, "PENDING_MODERATED")<br/>            it.addBatch()<br/>            it.setString(1, "test2 title")<br/>            it.setString(2, "test2 content")<br/>            it.setString(3, "PENDING_MODERATED")<br/>            it.addBatch()<br/>            it.executeBatch()<br/>        }</span><span id="99e7" class="my ld iq mu b gy nn na l nb nc">        insertedCnt.any { it == 1 }<br/>        val updated = posts.updateAll(Specifications.rejectAllPendingModerated())<br/>        log.debug("updated posts size:{}", updated)<br/>        updated shouldBe 2</span><span id="a891" class="my ld iq mu b gy nn na l nb nc">        val all = posts.findAll()<br/>        all shouldHaveSize 2<br/>        all.map { it.status }.forAny { it shouldBe Status.REJECTED }<br/>    }</span><span id="e46e" class="my ld iq mu b gy nn na l nb nc">    "remove posts" {<br/>        val sql = "insert into posts(title, content, status) values (?, ?, ?)";<br/>        val insertedCnt = template.prepareStatement(sql) {<br/>            it.setString(1, "test title")<br/>            it.setString(2, "test content")<br/>            it.setString(3, "REJECTED")<br/>            it.addBatch()<br/>            it.setString(1, "test2 title")<br/>            it.setString(2, "test2 content")<br/>            it.setString(3, "DRAFT")<br/>            it.addBatch()<br/>            it.executeBatch()<br/>        }</span><span id="4589" class="my ld iq mu b gy nn na l nb nc">        insertedCnt.any { it == 1 }<br/>        val deleted = posts.deleteAll(Specifications.removeAllRejected())<br/>        log.debug("deleted posts size:{}", deleted)<br/>        deleted shouldBe 1</span><span id="5990" class="my ld iq mu b gy nn na l nb nc">        val all = posts.findAll()<br/>        all shouldHaveSize 1<br/>        all.map { it.status }.forAny { it shouldBe Status.DRAFT }<br/>    }</span><span id="c02c" class="my ld iq mu b gy nn na l nb nc">}) {<br/>    companion object {<br/>        private val log: Logger = LoggerFactory.getLogger(PostControllerTest::class.java)<br/>    }</span><span id="052a" class="my ld iq mu b gy nn na l nb nc">    override fun beforeEach(testCase: TestCase) {<br/>        val callback: TransactionCallback&lt;Any, Int&gt; = TransactionCallback { _: TransactionStatus&lt;Any&gt; -&gt;<br/>            val sql = "delete from posts";<br/>            this.template.prepareStatement(sql) {<br/>                it.executeUpdate()<br/>            }<br/>        }</span><span id="4b57" class="my ld iq mu b gy nn na l nb nc">        val cnt = tx.executeWrite(callback)<br/>        println("deleted $cnt");<br/>    }<br/>}</span></pre><p id="a1b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个测试来测试<code class="fe nd ne nf mu b">PostController</code>，这里我们使用<code class="fe nd ne nf mu b">FunSpec</code>，它将测试封装在一个测试方法块中。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="fce7" class="my ld iq mu b gy mz na l nb nc">@MicronautTest(environments = ["mock"])<br/>class PostControllerTest(<br/>    private val postsBean: PostRepository,<br/>    @Client("/") private var client: HttpClient<br/>) : FunSpec({</span><span id="cbd2" class="my ld iq mu b gy nn na l nb nc">    test("test get posts endpoint") {<br/>        val posts = getMock(postsBean)<br/>        every { posts.findAll() }<br/>            .returns(<br/>                listOf(<br/>                    Post(<br/>                        id = UUID.randomUUID(),<br/>                        title = "test title",<br/>                        content = "test content",<br/>                        status = Status.DRAFT,<br/>                        createdAt = LocalDateTime.now()<br/>                    )<br/>                )<br/>            )<br/>        val response = client.toBlocking().exchange("/posts", Array&lt;Post&gt;::class.java)</span><span id="3965" class="my ld iq mu b gy nn na l nb nc">        response.status shouldBe HttpStatus.OK<br/>        response.body()!![0].title shouldBe "test title"</span><span id="7d42" class="my ld iq mu b gy nn na l nb nc">        verify(exactly = 1) { posts.findAll() }<br/>    }<br/>}) {<br/>    @MockBean(PostRepository::class)<br/>    fun posts() = mockk&lt;PostRepository&gt;()<br/>}</span></pre><p id="3443" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我们使用<strong class="jp ir">模仿</strong>来创建一个被模仿的<code class="fe nd ne nf mu b">PostRepository</code>并且<code class="fe nd ne nf mu b">MockBean</code>位于<code class="fe nd ne nf mu b">SpringSpec</code>的体内。</p><p id="f337" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是使用<code class="fe nd ne nf mu b">SpringSpec</code>的集成示例。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="5956" class="my ld iq mu b gy mz na l nb nc">@MicronautTest<br/>class IntegrationTests(<br/>    private val application: EmbeddedApplication&lt;*&gt;,<br/>    @Client("/") private val client: HttpClient<br/>) : StringSpec({</span><span id="e20a" class="my ld iq mu b gy nn na l nb nc">    "test the server is running" {<br/>        assert(application.isRunning)<br/>    }</span><span id="e0e5" class="my ld iq mu b gy nn na l nb nc">    "test GET /posts endpoint" {<br/>        val response = client.toBlocking().exchange("/posts", Array&lt;Post&gt;::class.java)</span><span id="3e93" class="my ld iq mu b gy nn na l nb nc">        response.status shouldBe HttpStatus.OK<br/>        response.body()!!.map { it.title }.forAny {<br/>            it shouldContain "Micronaut"<br/>        }<br/>    }<br/>})</span></pre><p id="f834" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从我的Github获取完整的<a class="ae lb" href="https://github.com/hantsy/micronaut-sandbox/tree/master/jdbc-kotlin" rel="noopener ugc nofollow" target="_blank">源代码</a>。</p></div></div>    
</body>
</html>