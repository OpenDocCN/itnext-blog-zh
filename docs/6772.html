<html>
<head>
<title>Deploy a Kubernetes cluster for free, using k3s and Oracle Cloud always free resources.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用k3s和Oracle Cloud always免费资源，免费部署Kubernetes集群。</h1>
<blockquote>原文：<a href="https://itnext.io/deploy-a-kubernetes-cluster-for-free-using-k3s-and-oracle-cloud-always-free-resources-ba8d1092b3da?source=collection_archive---------1-----------------------#2022-02-22">https://itnext.io/deploy-a-kubernetes-cluster-for-free-using-k3s-and-oracle-cloud-always-free-resources-ba8d1092b3da?source=collection_archive---------1-----------------------#2022-02-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/e300b6cde20ca96fa451c6a3d81f40f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*zX7yekxXQJvvcyzJZOXC0Q.png"/></div></figure><p id="4619" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用K3s和Oracle <a class="ae ks" href="https://docs.oracle.com/en-us/iaas/Content/FreeTier/freetier_topic-Always_Free_Resources.htm" rel="noopener ugc nofollow" target="_blank"> always free </a>资源，免费部署Kubernetes集群。</p><h1 id="9529" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">重要注意事项</h1><ul class=""><li id="a5df" class="lr ls iq jw b jx lt kb lu kf lv kj lw kn lx kr ly lz ma mb bi translated">本教程仅展示了如何将terraform与Oracle云基础设施结合使用，以及如何仅使用<strong class="jw ir">始终免费的</strong>资源。这些示例是针对生产环境的<strong class="jw ir">而非</strong>。</li><li id="a969" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">试用期(30天)结束时。所有部署的付费资源将被停止/终止</li><li id="abd7" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">在试用期(30天)结束时，如果您有一个正在运行的计算实例，它将被停止/休眠</li></ul><h1 id="0189" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">要求</h1><p id="1889" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">要使用本教程，您需要:</p><ul class=""><li id="526a" class="lr ls iq jw b jx jy kb kc kf mk kj ml kn mm kr ly lz ma mb bi translated">Oracle云帐户。你可以在这里注册<a class="ae ks" href="https://cloud.oracle.com/" rel="noopener ugc nofollow" target="_blank"/></li></ul><p id="9124" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一旦您获得帐户，在开始和<em class="mn"> 1之前，请按照<em class="mn">操作。准备本文件中<a class="ae ks" href="https://docs.oracle.com/en-us/iaas/developer-tutorials/tutorials/tf-provider/01-summary.htm" rel="noopener ugc nofollow" target="_blank">的</a></em>步骤。</em></p><p id="0625" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您还需要:</p><ul class=""><li id="4fe6" class="lr ls iq jw b jx jy kb kc kf mk kj ml kn mm kr ly lz ma mb bi translated"><a class="ae ks" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a> — Terraform是一款开源基础设施代码软件工具，提供一致的CLI工作流来管理数百项云服务。Terraform将云API编码成声明性的配置文件。</li><li id="4eac" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated"><a class="ae ks" href="https://kubernetes.io/docs/tasks/tools/" rel="noopener ugc nofollow" target="_blank">kubectl</a>—Kubernetes命令行工具(可选)</li><li id="e765" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated"><a class="ae ks" href="https://docs.oracle.com/en-us/iaas/Content/API/Concepts/cliconcepts.htm" rel="noopener ugc nofollow" target="_blank"> oci cli </a> — Oracle命令行界面(可选)</li></ul><h2 id="7534" class="mo ku iq bd kv mp mq dn kz mr ms dp ld kf mt mu lh kj mv mw ll kn mx my lp mz bi translated">RSA密钥生成示例</h2><p id="ca9e" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">要将terraform与Oracle云基础架构配合使用，您需要生成一个RSA密钥。使用以下内容生成rsa密钥:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="e01d" class="mo ku iq nf b gy nj nk l nl nm">openssl genrsa -out ~/.oci/&lt;your_name&gt;-oracle-cloud.pem 4096<br/>chmod 600 ~/.oci/&lt;your_name&gt;-oracle-cloud.pem<br/>openssl rsa -pubout -in ~/.oci/&lt;your_name&gt;-oracle-cloud.pem -out ~/.oci/&lt;your_name&gt;-oracle-cloud_public.pem</span></pre><p id="4ccf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将**替换为您的姓名或您喜欢的字符串。</p><p id="dc79" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">注</strong> ~/。oci/-oracle-cloud_public.pem该字符串将用在Oracle provider插件使用的*terraform.tfvars*上，所以请注意该字符串。</p><h1 id="c6bb" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">项目设置</h1><p id="ccad" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">您可以克隆这个存储库并在<em class="mn">示例/ </em>目录中工作。你必须编辑<em class="mn"> main.tf </em>文件，还必须创建<em class="mn"> terraform.tfvars </em>文件。有关更多详细信息，请参见<a class="ae ks" href="https://garutilorenzo.github.io/deploy-kubernetes-for-free-oracle-cloud/#oracle-provider-setup" rel="noopener ugc nofollow" target="_blank"> Oracle提供商设置</a>和<a class="ae ks" href="https://garutilorenzo.github.io/deploy-kubernetes-for-free-oracle-cloud/#pre-flight-checklist" rel="noopener ugc nofollow" target="_blank">飞行前清单</a>。</p><p id="c218" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">或者，如果您愿意，可以在工作区中创建一个新的空目录，并创建以下三个文件:</p><ul class=""><li id="f0e6" class="lr ls iq jw b jx jy kb kc kf mk kj ml kn mm kr ly lz ma mb bi translated">terraform.tfvars —更多详细信息请参见<a class="ae ks" href="https://garutilorenzo.github.io/deploy-kubernetes-for-free-oracle-cloud/#oracle-provider-setup" rel="noopener ugc nofollow" target="_blank"> Oracle provider setup </a></li><li id="73cb" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">main.tf</li><li id="84a2" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">provider.tf</li></ul><p id="40ba" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">main.tf文件将如下所示:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="7ac1" class="mo ku iq nf b gy nj nk l nl nm">variable "compartment_ocid" {</span><span id="568a" class="mo ku iq nf b gy nn nk l nl nm">}</span><span id="e05e" class="mo ku iq nf b gy nn nk l nl nm">variable "tenancy_ocid" {</span><span id="fcc9" class="mo ku iq nf b gy nn nk l nl nm">}</span><span id="3f40" class="mo ku iq nf b gy nn nk l nl nm">variable "user_ocid" {</span><span id="8f4f" class="mo ku iq nf b gy nn nk l nl nm">}</span><span id="1f96" class="mo ku iq nf b gy nn nk l nl nm">variable "fingerprint" {</span><span id="ab69" class="mo ku iq nf b gy nn nk l nl nm">}</span><span id="c6b4" class="mo ku iq nf b gy nn nk l nl nm">variable "private_key_path" {</span><span id="2543" class="mo ku iq nf b gy nn nk l nl nm">}</span><span id="74b8" class="mo ku iq nf b gy nn nk l nl nm">variable "region" {<br/>  default = "&lt;change_me&gt;"<br/>}</span><span id="fe1b" class="mo ku iq nf b gy nn nk l nl nm">module "k3s_cluster" {<br/>  region              = var.region<br/>  availability_domain = "&lt;change_me&gt;"<br/>  compartment_ocid    = var.compartment_ocid<br/>  my_public_ip_cidr   = "&lt;change_me&gt;"<br/>  cluster_name        = "&lt;change_me&gt;"<br/>  environment         = "staging"<br/>  k3s_token           = "&lt;change_me&gt;"<br/>  source              = "github.com/garutilorenzo/k3s-oci-cluster"<br/>}</span><span id="7dc3" class="mo ku iq nf b gy nn nk l nl nm">output "k3s_servers_ips" {<br/>  value = module.k3s_cluster.k3s_servers_ips<br/>}</span><span id="0e28" class="mo ku iq nf b gy nn nk l nl nm">output "k3s_workers_ips" {<br/>  value = module.k3s_cluster.k3s_workers_ips<br/>}</span><span id="c537" class="mo ku iq nf b gy nn nk l nl nm">output "public_lb_ip" {<br/>  value = module.k3s_cluster.public_lb_ip<br/>}</span></pre><p id="b17a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所有可能的变量见<a class="ae ks" href="https://garutilorenzo.github.io/deploy-kubernetes-for-free-oracle-cloud/#pre-flight-checklist" rel="noopener ugc nofollow" target="_blank">飞行前清单</a></p><p id="2348" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">provider.tf将类似于:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="a821" class="mo ku iq nf b gy nj nk l nl nm">provider "oci" {<br/>  tenancy_ocid     = var.tenancy_ocid<br/>  user_ocid        = var.user_ocid<br/>  private_key_path = var.private_key_path<br/>  fingerprint      = var.fingerprint<br/>  region           = var.region<br/>}</span></pre><p id="c718" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，我们可以用以下命令初始化terraform:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="81e9" class="mo ku iq nf b gy nj nk l nl nm">terraform init</span><span id="3854" class="mo ku iq nf b gy nn nk l nl nm">terraform init<br/>Initializing modules...<br/>Downloading git::<a class="ae ks" href="https://github.com/garutilorenzo/k3s-oci-cluster.git" rel="noopener ugc nofollow" target="_blank">https://github.com/garutilorenzo/k3s-oci-cluster.git</a> for k3s_cluster...<br/>- k3s_cluster in .terraform/modules/k3s_cluster</span><span id="ad40" class="mo ku iq nf b gy nn nk l nl nm">Initializing the backend...</span><span id="7af7" class="mo ku iq nf b gy nn nk l nl nm">Initializing provider plugins...<br/>- Reusing previous version of hashicorp/oci from the dependency lock file<br/>- Reusing previous version of hashicorp/template from the dependency lock file<br/>- Using previously-installed hashicorp/template v2.2.0<br/>- Using previously-installed hashicorp/oci v4.64.0</span><span id="daee" class="mo ku iq nf b gy nn nk l nl nm">Terraform has been successfully initialized!</span><span id="6621" class="mo ku iq nf b gy nn nk l nl nm">You may now begin working with Terraform. Try running "terraform plan" to see<br/>any changes that are required for your infrastructure. All Terraform commands<br/>should now work.</span><span id="9ce8" class="mo ku iq nf b gy nn nk l nl nm">If you ever set or change modules or backend configuration for Terraform,<br/>rerun this command to reinitialize your working directory. If you forget, other<br/>commands will detect it and remind you to do so if necessary.</span></pre><p id="d25b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">为公共LB (L7)生成sel签名的SSL证书</strong></p><p id="186c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">注意</strong>如果您已经拥有一个有效的证书，请跳过这一步，为变量PATH_TO_PUBLIC_LB_CERT和PATH_TO_PUBLIC_LB_KEY设置正确的值</p><p id="d7b5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们需要为我们的公共负载平衡器(第7层)生成证书(sel签名)。为此，我们需要<em class="mn"> *openssl* </em>，打开一个终端并遵循以下步骤:</p><p id="a29b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">生成密钥:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="30f5" class="mo ku iq nf b gy nj nk l nl nm">openssl genrsa 2048 &gt; privatekey.pem<br/>Generating RSA private key, 2048 bit long modulus (2 primes)<br/>.......+++++<br/>...............+++++<br/>e is 65537 (0x010001)</span></pre><p id="7a0f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">生成新的证书请求:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="e0f2" class="mo ku iq nf b gy nj nk l nl nm">openssl req -new -key privatekey.pem -out csr.pem<br/>You are about to be asked to enter information that will be incorporated<br/>into your certificate request.<br/>What you are about to enter is what is called a Distinguished Name or a DN.<br/>There are quite a few fields but you can leave some blank<br/>For some fields there will be a default value,<br/>If you enter '.', the field will be left blank.<br/>-----<br/>Country Name (2 letter code) [AU]:IT<br/>State or Province Name (full name) [Some-State]:Italy<br/>Locality Name (eg, city) []:Brescia<br/>Organization Name (eg, company) [Internet Widgits Pty Ltd]:GL Ltd<br/>Organizational Unit Name (eg, section) []:IT<br/>Common Name (e.g. server FQDN or YOUR name) []:testlb.domainexample.com<br/>Email Address []:<a class="ae ks" href="mailto:email@you.com" rel="noopener ugc nofollow" target="_blank">email@you.com</a></span><span id="b10b" class="mo ku iq nf b gy nn nk l nl nm">Please enter the following 'extra' attributes<br/>to be sent with your certificate request<br/>A challenge password []:<br/>An optional company name []:</span></pre><p id="f872" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">生成公共CRT:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="826e" class="mo ku iq nf b gy nj nk l nl nm">openssl x509 -req -days 365 -in csr.pem -signkey privatekey.pem -out public.crt</span><span id="6339" class="mo ku iq nf b gy nn nk l nl nm">Signature ok</span><span id="cf93" class="mo ku iq nf b gy nn nk l nl nm">subject=C = IT, ST = Italy, L = Brescia, O = GL Ltd, OU = IT, CN = testlb.domainexample.com, emailAddress = email@you.com</span><span id="b00e" class="mo ku iq nf b gy nn nk l nl nm">Getting Private key</span></pre><p id="b9c4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这是最后的结果:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="90a7" class="mo ku iq nf b gy nj nk l nl nm">ls</span><span id="cc80" class="mo ku iq nf b gy nn nk l nl nm">csr.pem  privatekey.pem  public.crt</span></pre><p id="db83" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在设置变量:</p><ul class=""><li id="7a99" class="lr ls iq jw b jx jy kb kc kf mk kj ml kn mm kr ly lz ma mb bi translated">PATH _ TO _ PUBLIC _ LB _ CERT:~/full _ PATH/PUBLIC . CRT</li><li id="c185" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">PATH _ TO _ PUBLIC _ LB _ KEY:~/full _ PATH/private KEY . PEM</li></ul><h1 id="5689" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">Oracle provider设置</h1><p id="625a" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">这是一个<em class="mn"> terraform.tfvars </em>文件的例子:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="e32f" class="mo ku iq nf b gy nj nk l nl nm">fingerprint      = "&lt;rsa_key_fingerprint&gt;"<br/>private_key_path = "~/.oci/&lt;your_name&gt;-oracle-cloud_public.pem"<br/>user_ocid        = "&lt;user_ocid&gt;"<br/>tenancy_ocid     = "&lt;tenency_ocid&gt;"<br/>compartment_ocid = "&lt;compartment_ocid&gt;"</span></pre><p id="941e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要在Ocacle云控制台中找到您的tenency_ocid，请转到:治理和管理&gt; tenency详细信息，然后复制ocid。</p><p id="8bcd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要在Ocacle Cloud控制台中找到您的user_ocid，请转到用户设置(单击右上角的图标，然后单击用户设置)，单击您的用户名，然后复制ocid</p><p id="19a8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">compartment_ocid与tenency_ocid相同。</p><p id="7531" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">指纹是你的RSA密钥的指纹，你可以在用户设置&gt; API密钥下找到这个值</p><h1 id="b10a" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">飞行前清单</h1><p id="71c2" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">一旦创建了terraform.tfvars文件，编辑main.tf文件(总是在<em class="mn"> example/ </em>目录中)并设置变量后面的<a class="ae ks" href="https://garutilorenzo.github.io/deploy-kubernetes-for-free-oracle-cloud/#pre-flight-checklist" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="ae75" class="mo ku iq bd kv mp mq dn kz mr ms dp ld kf mt mu lh kj mv mw ll kn mx my lp mz bi translated">生成随机令牌</h2><p id="aa19" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">使用以下内容生成随机k3s令牌:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="1008" class="mo ku iq nf b gy nj nk l nl nm">cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 55 | head -n 1</span></pre><h2 id="1eae" class="mo ku iq bd kv mp mq dn kz mr ms dp ld kf mt mu lh kj mv mw ll kn mx my lp mz bi translated">如何找到可用性域名</h2><p id="4c5e" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">要查找可用性域的列表，请在che Cloud Shell上运行以下命令:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="cfcf" class="mo ku iq nf b gy nj nk l nl nm">oci iam availability-domain list<br/>{<br/>  "data": [<br/>    {<br/>      "compartment-id": "&lt;compartment_ocid&gt;",<br/>      "id": "ocid1.availabilitydomain.oc1..xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",<br/>      "name": "iAdc:EU-ZURICH-1-AD-1"<br/>    }<br/>  ]<br/>}</span></pre><h2 id="6608" class="mo ku iq bd kv mp mq dn kz mr ms dp ld kf mt mu lh kj mv mw ll kn mx my lp mz bi translated">如何列出所有操作系统映像</h2><p id="792a" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">要按形状和操作系统过滤操作系统映像，请在che Cloud Shell上运行以下命令:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="1d47" class="mo ku iq nf b gy nj nk l nl nm">To filter the OS images by shape and OS run this command on che Cloud Shell:</span><span id="5049" class="mo ku iq nf b gy nn nk l nl nm">oci compute image list --compartment-id &lt;compartment_ocid&gt; --operating-system "Canonical Ubuntu" --shape "VM.Standard.A1.Flex"<br/>{<br/>  "data": [<br/>    {<br/>      "agent-features": null,<br/>      "base-image-id": null,<br/>      "billable-size-in-gbs": 2,<br/>      "compartment-id": null,<br/>      "create-image-allowed": true,<br/>      "defined-tags": {},<br/>      "display-name": "Canonical-Ubuntu-20.04-aarch64-2022.01.18-0",<br/>      "freeform-tags": {},<br/>      "id": "ocid1.image.oc1.eu-zurich-1.aaaaaaaag2uyozo7266bmg26j5ixvi42jhaujso2pddpsigtib6vfnqy5f6q",<br/>      "launch-mode": "NATIVE",<br/>      "launch-options": {<br/>        "boot-volume-type": "PARAVIRTUALIZED",<br/>        "firmware": "UEFI_64",<br/>        "is-consistent-volume-naming-enabled": true,<br/>        "is-pv-encryption-in-transit-enabled": true,<br/>        "network-type": "PARAVIRTUALIZED",<br/>        "remote-data-volume-type": "PARAVIRTUALIZED"<br/>      },<br/>      "lifecycle-state": "AVAILABLE",<br/>      "listing-type": null,<br/>      "operating-system": "Canonical Ubuntu",<br/>      "operating-system-version": "20.04",<br/>      "size-in-mbs": 47694,<br/>      "time-created": "2022-01-27T22:53:34.270000+00:00"<br/>    },</span></pre><p id="6b49" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">注意:</strong>这个设置只在Ubuntu 20.04上测试过</p><h1 id="1441" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">关于OCI总是免费资源的笔记</h1><p id="2ec2" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">为了获得oracle始终可用层中的最大可用资源，k3s服务器和k3s工作线程的最大数量必须为2。所以<em class="mn"> k3s_server_pool_size </em>和<em class="mn"> k3s_worker_pool_size </em> <strong class="jw ir">的最大值是</strong> 2。</p><p id="6d29" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在此设置中，我们使用两个LB，一个内部LB和一个公共LB(第7层)。为了使用两个lb使用总是空闲的资源，一个LB必须是<a class="ae ks" href="https://docs.oracle.com/en-us/iaas/Content/NetworkLoadBalancer/introducton.htm#Overview" rel="noopener ugc nofollow" target="_blank">网络负载平衡器</a>，另一个必须是<a class="ae ks" href="https://docs.oracle.com/en-us/iaas/Content/Balance/Concepts/balanceoverview.htm" rel="noopener ugc nofollow" target="_blank">负载平衡器</a>。公共LB <strong class="jw ir">必须</strong>使用<em class="mn">柔性</em>形状(<em class="mn"> public_lb_shape </em>变量)。</p><h1 id="4dda" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">关于K3s的注意事项</h1><p id="7447" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">在此环境中，K3s群集的高可用性是使用嵌入式数据库提供的。更多详情<a class="ae ks" href="https://rancher.com/docs/k3s/latest/en/installation/ha-embedded/" rel="noopener ugc nofollow" target="_blank">此处</a></p><p id="6cad" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">K3s的默认安装安装<a class="ae ks" href="https://traefik.io/" rel="noopener ugc nofollow" target="_blank"> Traefik </a>作为入口控制器。在这种环境下，Traefik由<a class="ae ks" href="https://kubernetes.github.io/ingress-nginx/" rel="noopener ugc nofollow" target="_blank"> Nginx入口控制器</a>代替。要安装Traefik作为入口控制器，将变量<em class="mn"> install_nginx_ingress </em>设置为<em class="mn"> false </em>。有关Nginx入口控制器的更多信息，请参见<a class="ae ks" href="https://garutilorenzo.github.io/deploy-kubernetes-for-free-oracle-cloud/#nginxingress-controller" rel="noopener ugc nofollow" target="_blank"> Nginx入口控制器</a>章节。</p><h1 id="3ad6" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">基础设施概述</h1><p id="1d06" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">最终的基础设施将由以下人员建造:</p><ul class=""><li id="5734" class="lr ls iq jw b jx jy kb kc kf mk kj ml kn mm kr ly lz ma mb bi translated">名为“k3s-servers”的服务器节点的一个实例池</li><li id="0244" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">名为“k3s-workers”的工作节点的一个实例池</li><li id="1019" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">一个内部负载平衡器，将流量路由到K3s服务器</li><li id="2b21" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">一个外部负载平衡器，将流量路由到K3s工作线程</li></ul><p id="544d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">terraform创建的其他资源包括:</p><ul class=""><li id="e12c" class="lr ls iq jw b jx jy kb kc kf mk kj ml kn mm kr ly lz ma mb bi translated">实例池使用的两个实例配置(一个用于服务器，一个用于工作线程)</li><li id="a41b" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">一个vcn</li><li id="4cd8" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">两个公共子网</li><li id="9b7e" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">两个安全列表</li><li id="e776" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">一个充满活力的团体</li><li id="64bc" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">一个身份策略</li></ul><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi no"><img src="../Images/e1ff96e3c47e07ca454ec7809069b223.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tiwUX6IaJepX4WMABpXMpg.png"/></div></div></figure><h1 id="ec4e" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">已部署群集资源</h1><p id="6104" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">该设置将自动安装<a class="ae ks" href="https://longhorn.io/" rel="noopener ugc nofollow" target="_blank">长角牛</a>。Longhorn是Kubernetes 的<em class="mn">云本地分布式块存储。要禁用longhorn部署，请将<em class="mn"> install_longhorn </em>变量设置为<em class="mn"> false </em></em></p><h1 id="b5ad" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">Nginx入口控制器</h1><p id="13be" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">在这种环境下<a class="ae ks" href="https://kubernetes.github.io/ingress-nginx/" rel="noopener ugc nofollow" target="_blank">使用Nginx入口控制器</a>代替标准<a class="ae ks" href="https://traefik.io/" rel="noopener ugc nofollow" target="_blank"> Traefik </a>入口控制器。</p><p id="1bd3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">该安装是<a class="ae ks" href="https://kubernetes.github.io/ingress-nginx/deploy/#bare-metal-clusters" rel="noopener ugc nofollow" target="_blank">裸机</a>安装，然后入口控制器通过负载平衡器服务公开。</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="0782" class="mo ku iq nf b gy nj nk l nl nm">---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: ingress-nginx-controller-loadbalancer<br/>  namespace: ingress-nginx<br/>spec:<br/>  selector:<br/>    app.kubernetes.io/component: controller<br/>    app.kubernetes.io/instance: ingress-nginx<br/>    app.kubernetes.io/name: ingress-nginx<br/>  ports:<br/>    - name: http<br/>      port: 80<br/>      protocol: TCP<br/>      targetPort: 80<br/>    - name: https<br/>      port: 443<br/>      protocol: TCP<br/>      targetPort: 80<br/>  type: LoadBalancer</span></pre><p id="e1c2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了正确配置所有转发的HTTP报头(L7报头),此参数被添加到che ConfigMap:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="7b47" class="mo ku iq nf b gy nj nk l nl nm">---<br/>apiVersion: v1<br/>data:<br/>  allow-snippet-annotations: "true"<br/>  use-forwarded-headers: "true"<br/>  compute-full-forwarded-for: "true"<br/>  enable-real-ip: "true"<br/>  forwarded-for-header: "X-Forwarded-For"<br/>  proxy-real-ip-cidr: "0.0.0.0/0"<br/>kind: ConfigMap<br/>metadata:<br/>  labels:<br/>    app.kubernetes.io/component: controller<br/>    app.kubernetes.io/instance: ingress-nginx<br/>    app.kubernetes.io/managed-by: Helm<br/>    app.kubernetes.io/name: ingress-nginx<br/>    app.kubernetes.io/part-of: ingress-nginx<br/>    app.kubernetes.io/version: 1.1.1<br/>    helm.sh/chart: ingress-nginx-4.0.16<br/>  name: ingress-nginx-controller<br/>  namespace: ingress-nginx</span></pre><h1 id="c6d9" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">部署</h1><p id="5acb" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">我们现在已经准备好部署我们的基础设施。首先，我们要求terraform计划执行:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="306e" class="mo ku iq nf b gy nj nk l nl nm">terraform plan</span><span id="166e" class="mo ku iq nf b gy nn nk l nl nm">...<br/>...<br/>      + id                             = (known after apply)<br/>      + ip_addresses                   = (known after apply)<br/>      + is_preserve_source_destination = false<br/>      + is_private                     = true<br/>      + lifecycle_details              = (known after apply)<br/>      + nlb_ip_version                 = (known after apply)<br/>      + state                          = (known after apply)<br/>      + subnet_id                      = (known after apply)<br/>      + system_tags                    = (known after apply)<br/>      + time_created                   = (known after apply)<br/>      + time_updated                   = (known after apply)</span><span id="646c" class="mo ku iq nf b gy nn nk l nl nm">+ reserved_ips {<br/>          + id = (known after apply)<br/>        }<br/>    }</span><span id="dc84" class="mo ku iq nf b gy nn nk l nl nm">Plan: 27 to add, 0 to change, 0 to destroy.</span><span id="c674" class="mo ku iq nf b gy nn nk l nl nm">Changes to Outputs:<br/>  + k3s_servers_ips = [<br/>      + (known after apply),<br/>      + (known after apply),<br/>    ]<br/>  + k3s_workers_ips = [<br/>      + (known after apply),<br/>      + (known after apply),<br/>    ]<br/>  + public_lb_ip    = (known after apply)</span><span id="45bf" class="mo ku iq nf b gy nn nk l nl nm">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><span id="1f0d" class="mo ku iq nf b gy nn nk l nl nm">Note: You didn't use the -out option to save this plan, so Terraform can't guarantee to take exactly these actions if you run "terraform apply" now</span></pre><p id="3050" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，我们可以通过以下方式部署我们的资源:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="73d5" class="mo ku iq nf b gy nj nk l nl nm">terraform apply</span><span id="842a" class="mo ku iq nf b gy nn nk l nl nm">...<br/>...<br/>      + is_preserve_source_destination = false<br/>      + is_private                     = true<br/>      + lifecycle_details              = (known after apply)<br/>      + nlb_ip_version                 = (known after apply)<br/>      + state                          = (known after apply)<br/>      + subnet_id                      = (known after apply)<br/>      + system_tags                    = (known after apply)<br/>      + time_created                   = (known after apply)<br/>      + time_updated                   = (known after apply)</span><span id="3bb5" class="mo ku iq nf b gy nn nk l nl nm">+ reserved_ips {<br/>          + id = (known after apply)<br/>        }<br/>    }</span><span id="f484" class="mo ku iq nf b gy nn nk l nl nm">Plan: 27 to add, 0 to change, 0 to destroy.</span><span id="d866" class="mo ku iq nf b gy nn nk l nl nm">Changes to Outputs:<br/>  + k3s_servers_ips = [<br/>      + (known after apply),<br/>      + (known after apply),<br/>    ]<br/>  + k3s_workers_ips = [<br/>      + (known after apply),<br/>      + (known after apply),<br/>    ]<br/>  + public_lb_ip    = (known after apply)</span><span id="8f66" class="mo ku iq nf b gy nn nk l nl nm">Do you want to perform these actions?<br/>  Terraform will perform the actions described above.<br/>  Only 'yes' will be accepted to approve.<br/>  Enter a value: yes</span><span id="110a" class="mo ku iq nf b gy nn nk l nl nm">...<br/>...</span><span id="d32a" class="mo ku iq nf b gy nn nk l nl nm">module.k3s_cluster.oci_network_load_balancer_backend.k3s_kube_api_backend[0]: Still creating... [50s elapsed]<br/>module.k3s_cluster.oci_network_load_balancer_backend.k3s_kube_api_backend[0]: Still creating... [1m0s elapsed]<br/>module.k3s_cluster.oci_network_load_balancer_backend.k3s_kube_api_backend[0]: Creation complete after 1m1s [...]</span><span id="e34c" class="mo ku iq nf b gy nn nk l nl nm">Apply complete! Resources: 27 added, 0 changed, 0 destroyed.</span><span id="be4b" class="mo ku iq nf b gy nn nk l nl nm">Outputs:</span><span id="f5be" class="mo ku iq nf b gy nn nk l nl nm">k3s_servers_ips = [<br/>  "X.X.X.X",<br/>  "X.X.X.X",<br/>]<br/>k3s_workers_ips = [<br/>  "X.X.X.X",<br/>  "X.X.X.X",<br/>]<br/>public_lb_ip = tolist([<br/>  "X.X.X.X",<br/>])</span></pre><p id="2e82" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，在一个主节点上，您可以使用以下命令检查集群的状态:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="34ef" class="mo ku iq nf b gy nj nk l nl nm">ssh X.X.X.X -lubuntu</span><span id="a30e" class="mo ku iq nf b gy nn nk l nl nm">ubuntu@inst-iwlqz-k3s-servers:~$ sudo su -<br/>root@inst-iwlqz-k3s-servers:~# kubectl get nodes</span><span id="e40c" class="mo ku iq nf b gy nn nk l nl nm">NAME                     STATUS   ROLES                       AGE     VERSION<br/>inst-axdzf-k3s-workers   Ready    &lt;none&gt;                      4m34s   v1.22.6+k3s1<br/>inst-hmgnl-k3s-servers   Ready    control-plane,etcd,master   4m14s   v1.22.6+k3s1<br/>inst-iwlqz-k3s-servers   Ready    control-plane,etcd,master   6m4s    v1.22.6+k3s1<br/>inst-lkvem-k3s-workers   Ready    &lt;none&gt;                      5m35s   v1.22.6+k3s1</span></pre><h2 id="8123" class="mo ku iq bd kv mp mq dn kz mr ms dp ld kf mt mu lh kj mv mw ll kn mx my lp mz bi translated">公共LB支票</h2><p id="40fc" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">我们现在可以测试公共负载平衡器、nginx入口控制器和安全列表入口规则。在本地PC上运行:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="27a9" class="mo ku iq nf b gy nj nk l nl nm">curl -v http://&lt;PUBLIC_LB_IP&gt;</span><span id="df44" class="mo ku iq nf b gy nn nk l nl nm">*   Trying PUBLIC_LB_IP:80...<br/>* TCP_NODELAY set<br/>* Connected to PUBLIC_LB_IP (PUBLIC_LB_IP) port 80 (#0)<br/>&gt; GET / HTTP/1.1<br/>&gt; Host: PUBLIC_LB_IP<br/>&gt; User-Agent: curl/7.68.0<br/>&gt; Accept: */*<br/>&gt; <br/>* Mark bundle as not supporting multiuse<br/>&lt; HTTP/1.1 404 Not Found<br/>&lt; Date: Fri, 25 Feb 2022 14:03:09 GMT<br/>&lt; Content-Type: text/html<br/>&lt; Content-Length: 146<br/>&lt; Connection: keep-alive<br/>&lt; <br/>&lt;html&gt;<br/>&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;<br/>&lt;body&gt;<br/>&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;<br/>&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;<br/>* Connection #0 to host PUBLIC_LB_IP left intact</span></pre><p id="3f49" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="mn"> 404 </em>是正确的响应，因为集群是空的。我们还可以测试https侦听器/后端:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="dc0c" class="mo ku iq nf b gy nj nk l nl nm">curl -k -v https://&lt;PUBLIC_LB_IP&gt;</span><span id="af52" class="mo ku iq nf b gy nn nk l nl nm">* Trying PUBLIC_LB_IP:443...<br/>* TCP_NODELAY set<br/>* Connected to PUBLIC_LB_IP (PUBLIC_LB_IP) port 443 (#0)<br/>* ALPN, offering h2<br/>* ALPN, offering http/1.1<br/>* successfully set certificate verify locations:<br/>*   CAfile: /etc/ssl/certs/ca-certificates.crt<br/>  CApath: /etc/ssl/certs<br/>* TLSv1.3 (OUT), TLS handshake, Client hello (1):<br/>* TLSv1.3 (IN), TLS handshake, Server hello (2):<br/>* TLSv1.2 (IN), TLS handshake, Certificate (11):<br/>* TLSv1.2 (IN), TLS handshake, Server key exchange (12):<br/>* TLSv1.2 (IN), TLS handshake, Server finished (14):<br/>* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):<br/>* TLSv1.2 (OUT), TLS change cipher, Change cipher spec (1):<br/>* TLSv1.2 (OUT), TLS handshake, Finished (20):<br/>* TLSv1.2 (IN), TLS handshake, Finished (20):<br/>* SSL connection using TLSv1.2 / ECDHE-RSA-AES256-GCM-SHA384<br/>* ALPN, server accepted to use http/1.1<br/>* Server certificate:<br/>*  subject: C=IT; ST=Italy; L=Brescia; O=GL Ltd; OU=IT; CN=testlb.domainexample.com; <a class="ae ks" href="mailto:emailAddress=email@you.com" rel="noopener ugc nofollow" target="_blank">emailAddress=email@you.com</a><br/>*  start date: Feb 25 10:28:29 2022 GMT<br/>*  expire date: Feb 25 10:28:29 2023 GMT<br/>*  issuer: C=IT; ST=Italy; L=Brescia; O=GL Ltd; OU=IT; CN=testlb.domainexample.com; <a class="ae ks" href="mailto:emailAddress=email@you.com" rel="noopener ugc nofollow" target="_blank">emailAddress=email@you.com</a><br/>*  SSL certificate verify result: self signed certificate (18), continuing anyway.<br/>&gt; GET / HTTP/1.1<br/>&gt; Host: PUBLIC_LB_IP<br/>&gt; User-Agent: curl/7.68.0<br/>&gt; Accept: */*<br/>&gt; <br/>* Mark bundle as not supporting multiuse<br/>&lt; HTTP/1.1 404 Not Found<br/>&lt; Date: Fri, 25 Feb 2022 13:48:19 GMT<br/>&lt; Content-Type: text/html<br/>&lt; Content-Length: 146<br/>&lt; Connection: keep-alive<br/>&lt; <br/>&lt;html&gt;<br/>&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;<br/>&lt;body&gt;<br/>&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;<br/>&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;<br/>* Connection #0 to host PUBLIC_LB_IP left intact</span></pre><h2 id="d204" class="mo ku iq bd kv mp mq dn kz mr ms dp ld kf mt mu lh kj mv mw ll kn mx my lp mz bi translated">长角牛格子</h2><p id="5fe2" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">要检查longhorn是否已成功安装，请在一个主节点上运行:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="8a13" class="mo ku iq nf b gy nj nk l nl nm">kubectl get ns<br/>NAME              STATUS   AGE<br/>default           Active   9m40s<br/>kube-node-lease   Active   9m39s<br/>kube-public       Active   9m39s<br/>kube-system       Active   9m40s<br/>longhorn-system   Active   8m52s   &lt;- longhorn namespace</span><span id="c6a3" class="mo ku iq nf b gy nn nk l nl nm">root@inst-hmgnl-k3s-servers:~# kubectl get pods -n longhorn-system<br/>NAME                                        READY   STATUS    RESTARTS        AGE<br/>csi-attacher-5f46994f7-8w9sg                1/1     Running   0               7m52s<br/>csi-attacher-5f46994f7-qz7d4                1/1     Running   0               7m52s<br/>csi-attacher-5f46994f7-rjqlx                1/1     Running   0               7m52s<br/>csi-provisioner-6ccbfbf86f-fw7q4            1/1     Running   0               7m52s<br/>csi-provisioner-6ccbfbf86f-gwmrg            1/1     Running   0               7m52s<br/>csi-provisioner-6ccbfbf86f-nsf84            1/1     Running   0               7m52s<br/>csi-resizer-6dd8bd4c97-7l67f                1/1     Running   0               7m51s<br/>csi-resizer-6dd8bd4c97-g66wj                1/1     Running   0               7m51s<br/>csi-resizer-6dd8bd4c97-nksmd                1/1     Running   0               7m51s<br/>csi-snapshotter-86f65d8bc-2gcwt             1/1     Running   0               7m50s<br/>csi-snapshotter-86f65d8bc-kczrw             1/1     Running   0               7m50s<br/>csi-snapshotter-86f65d8bc-sjmnv             1/1     Running   0               7m50s<br/>engine-image-ei-fa2dfbf0-6rpz2              1/1     Running   0               8m30s<br/>engine-image-ei-fa2dfbf0-7l5k8              1/1     Running   0               8m30s<br/>engine-image-ei-fa2dfbf0-7nph9              1/1     Running   0               8m30s<br/>engine-image-ei-fa2dfbf0-ndkck              1/1     Running   0               8m30s<br/>instance-manager-e-31a0b3f5                 1/1     Running   0               8m26s<br/>instance-manager-e-37aa4663                 1/1     Running   0               8m27s<br/>instance-manager-e-9cc7cc9d                 1/1     Running   0               8m20s<br/>instance-manager-e-f39d9f2c                 1/1     Running   0               8m29s<br/>instance-manager-r-1364d994                 1/1     Running   0               8m26s<br/>instance-manager-r-c1670269                 1/1     Running   0               8m20s<br/>instance-manager-r-c20ebeb3                 1/1     Running   0               8m28s<br/>instance-manager-r-c54bf9a5                 1/1     Running   0               8m27s<br/>longhorn-csi-plugin-2qj94                   2/2     Running   0               7m50s<br/>longhorn-csi-plugin-4t8jm                   2/2     Running   0               7m50s<br/>longhorn-csi-plugin-ws82l                   2/2     Running   0               7m50s<br/>longhorn-csi-plugin-zmc9q                   2/2     Running   0               7m50s<br/>longhorn-driver-deployer-784546d78d-s6cd2   1/1     Running   0               8m58s<br/>longhorn-manager-l8sd8                      1/1     Running   0               9m1s<br/>longhorn-manager-r2q5c                      1/1     Running   1 (8m30s ago)   9m1s<br/>longhorn-manager-s6wql                      1/1     Running   0               9m1s<br/>longhorn-manager-zrrf2                      1/1     Running   0               9m<br/>longhorn-ui-9fdb94f9-6shsr                  1/1     Running   0               8m59s</span></pre><h1 id="31c2" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">部署示例堆栈</h1><p id="b13d" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">最后，为了测试集群的所有组件，我们可以部署一个示例堆栈。堆栈由以下组件组成:</p><ul class=""><li id="da0b" class="lr ls iq jw b jx jy kb kc kf mk kj ml kn mm kr ly lz ma mb bi translated">MariaDB</li><li id="87ea" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">Nginx</li><li id="1c44" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">wordpress软件</li></ul><p id="c862" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">每个组件由以下部分组成:一个部署和一个服务。Wordpress和nginx共享同一个持久卷(具有longhorn存储类的ReadWriteMany)。nginx配置存储在四个配置图中，nginx服务由nginx入口控制器公开。</p><p id="41f2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">通过以下方式部署资源:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="d494" class="mo ku iq nf b gy nj nk l nl nm">kubectl apply -f <a class="ae ks" href="https://raw.githubusercontent.com/garutilorenzo/k3s-oci-cluster/master/deployments/mariadb/all-resources.yml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/garutilorenzo/k3s-oci-cluster/master/deployments/mariadb/all-resources.yml</a><br/>kubectl apply -f <a class="ae ks" href="https://raw.githubusercontent.com/garutilorenzo/k3s-oci-cluster/master/deployments/nginx/all-resources.yml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/garutilorenzo/k3s-oci-cluster/master/deployments/nginx/all-resources.yml</a><br/>kubectl apply -f <a class="ae ks" href="https://raw.githubusercontent.com/garutilorenzo/k3s-oci-cluster/master/deployments/wordpress/all-resources.yml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/garutilorenzo/k3s-oci-cluster/master/deployments/wordpress/all-resources.yml</a></span></pre><p id="d373" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并检查状态:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="06cc" class="mo ku iq nf b gy nj nk l nl nm">kubectl get deployments<br/>NAME        READY   UP-TO-DATE   AVAILABLE   AGE<br/>mariadb       1/1     1            1           92m<br/>nginx         1/1     1            1           79m<br/>wordpress     1/1     1            1           91m</span><span id="e315" class="mo ku iq nf b gy nn nk l nl nm">kubectl get svc<br/>NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE<br/>kubernetes        ClusterIP   10.43.0.1       &lt;none&gt;        443/TCP    5h8m<br/>mariadb-svc       ClusterIP   10.43.184.188   &lt;none&gt;        3306/TCP   92m<br/>nginx-svc         ClusterIP   10.43.9.202     &lt;none&gt;        80/TCP     80m<br/>wordpress-svc     ClusterIP   10.43.242.26    &lt;none&gt;        9000/TCP   91m</span></pre><p id="12c0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在你已经准备好设置WP，打开LB公共ip并按照向导进行操作。<strong class="jw ir">注意</strong> nginx和Kubernetes入口规则是在没有虚拟主机/服务器名称的情况下配置的。</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/7575c6518f58fff20ac374e6c1992677.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/format:webp/1*g2AWnw0KECZ2rJ3WdnxVww.png"/></div></figure><p id="54b5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要清理部署的资源:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="5d14" class="mo ku iq nf b gy nj nk l nl nm">kubectl delete -f https://raw.githubusercontent.com/garutilorenzo/k3s-oci-cluster/master/deployments/mariadb/all-resources.yml<br/>kubectl delete -f https://raw.githubusercontent.com/garutilorenzo/k3s-oci-cluster/master/deployments/nginx/all-resources.yml<br/>kubectl delete -f https://raw.githubusercontent.com/garutilorenzo/k3s-oci-cluster/master/deployments/wordpress/all-resources.yml</span></pre><h1 id="68a1" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">打扫</h1><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="0fbf" class="mo ku iq nf b gy nj nk l nl nm">terraform destroy</span></pre></div></div>    
</body>
</html>