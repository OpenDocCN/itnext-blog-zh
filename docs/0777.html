<html>
<head>
<title>Pass ASP.NET Core Appsettings Values to Angular via an API Call</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过API调用将ASP.NET核心Appsettings值传递给Angular</h1>
<blockquote>原文：<a href="https://itnext.io/pass-asp-net-core-appsettings-values-to-angular-via-an-api-call-59127a1085e8?source=collection_archive---------3-----------------------#2018-05-27">https://itnext.io/pass-asp-net-core-appsettings-values-to-angular-via-an-api-call-59127a1085e8?source=collection_archive---------3-----------------------#2018-05-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/bd02fefdf20815a11216583996cf19d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-HrwPMsgXTBIVOsQMMvNBg.png"/></div></div></figure><p id="3c48" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我展示Angular、Identity Server 4和ASP.NET核心的<a class="ae kw" href="https://github.com/elanderson/Angular-Core-IdentityServer" rel="noopener ugc nofollow" target="_blank"> repo </a>中，出现了一些与Angular新版本不兼容的问题。为了解决这个问题，我们计划使用微软的新Angular模板重新创建客户端应用程序，据我所知，这应该可以解决这个问题。</p><p id="8f57" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">任何修改之前的代码都可以在<a class="ae kw" href="https://github.com/elanderson/Angular-Core-IdentityServer/tree/62c05b775cde7091de06f0728ccf7a705b77cce4" rel="noopener ugc nofollow" target="_blank">这里</a>找到，但是在这种情况下，整个客户端应用程序都被重新创建了，所以起点可能不是很有帮助。</p><h2 id="e53d" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">问题是</h2><p id="808b" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">在很大程度上，这工作得很好，但当我需要在新的Angular应用程序中使用ASP.NET核心的一些配置值时，问题就来了。以前版本的模板使用服务器端呈现，我利用它来传递配置值。默认情况下，新模板不使用服务器端渲染，我想找到一种不需要服务器端渲染的方法来解决这个问题。</p><p id="5903" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">另一个问题是，我希望能够在Azure中运行这个应用程序，并将配置值设置为环境变量。虽然Angular似乎支持环境文件，但是找到一个使用系统环境变量的解决方案并不容易。</p><h2 id="4043" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">配置API端点</h2><p id="4765" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">因为我需要获取客户端应用程序的配置值是保密的，所以我决定通过API调用将它们拉回到托管Angular应用程序的同一个ASP.NET核心应用程序，这是示例解决方案中的客户端应用程序项目。</p><p id="ff4b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我在控制器目录中添加了一个ConfigurationController.cs类，内容如下。</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="349f" class="kx ky iq ma b gy me mf l mg mh">[Produces("application/json")]<br/>[Route("api/Configuration")]<br/>public class ConfigurationController : Controller<br/>{<br/>    private readonly IConfiguration _configuration;<br/><br/>    public ConfigurationController(IConfiguration configuration)<br/>    {<br/>        _configuration = configuration;<br/>    }<br/><br/>    [HttpGet("[action]")]<br/>    public IActionResult ConfigurationData()<br/>    {<br/>        return Ok(new Dictionary&lt;string, string&gt;<br/>        {<br/>            { "IdentityServerAddress", _configuration["IdentityServerAddress"] },<br/>            { "ApiAddress", _configuration["ApiAddress"] }<br/>        });<br/>    }<br/>}</span></pre><p id="07bd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个控制器通过引用应用程序的配置来构造，然后用我的Angular应用程序需要的值来填充字典。为了完整起见，下面是应用程序的appsettings.json文件的内容。</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="193b" class="kx ky iq ma b gy me mf l mg mh">{<br/>  "Logging": {<br/>    "LogLevel": {<br/>      "Default": "Warning"<br/>    }<br/>  },<br/>  "IdentityServerAddress": "http://localhost:5000",<br/>  "ApiAddress": "http://localhost:5001/api/"<br/>}</span></pre><h2 id="5072" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">角度变化</h2><p id="2d3d" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">这是我努力想做好的部分。我需要来自上述API的配置值尽快可用。谢天谢地，我看到了<a class="ae kw" href="https://juristr.com/blog/2018/01/ng-app-runtime-config/#runtime-configuration" rel="noopener ugc nofollow" target="_blank">这篇</a>由<a class="ae kw" href="https://twitter.com/juristr" rel="noopener ugc nofollow" target="_blank">朱里·斯特鲁普弗洛纳</a>撰写的博客文章，其中介绍了Angular的APP_INITIALIZER的使用。</p><p id="6550" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我需要做的第一件事是在Angular中创建一个类，从API中获取配置值，并为它们提供Angular应用程序的其余部分。为此，我将configuration.service.ts添加到新的client app/src/app/configuration目录中。接下来是整个班级。</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="6327" class="kx ky iq ma b gy me mf l mg mh">import { Injectable } from '@angular/core';<br/>import { HttpClient } from '@angular/common/http';<br/><br/>@Injectable()<br/>export class ConfigurationService {<br/><br/>  private configuration: IServerConfiguration;<br/><br/>  constructor(private http: HttpClient) { }<br/><br/>  loadConfig() {<br/>    return this.http.get&lt;IServerConfiguration&gt;('/api/Configuration/ConfigurationData')<br/>      .toPromise()<br/>      .then(result =&gt; {<br/>        this.configuration = &lt;IServerConfiguration&gt;(result);<br/>      }, error =&gt; console.error(error));<br/>  }<br/><br/>  get apiAddress() {<br/>    return this.configuration.ApiAddress;<br/>  }<br/><br/>  get identityServerAddress() {<br/>    return this.configuration.IdentityServerAddress;<br/>  }<br/><br/>}<br/><br/>export interface IServerConfiguration {<br/>  ApiAddress: string;<br/>  IdentityServerAddress: string;<br/>}</span></pre><p id="7d63" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个类调用API来获取loadConfig函数中的配置值，并将其映射到一个类级别的字段。它还提供了获取各个配置值的属性。</p><p id="5801" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">正如我上面提到的，让应用程序及时获得这些配置值是我很难做到的事情。使用Angular的APP_INITIALIZER解决这个问题的第一步是更改从@angular/core的导入，以包含APP_INITIALIZER并导入ConfigurationService。所有这些更改都是在app.module.ts文件中进行的。</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="3550" class="kx ky iq ma b gy me mf l mg mh">import { NgModule, APP_INITIALIZER } from '@angular/core';<br/>import { ConfigurationService } from "./configuration/configuration.service";</span></pre><p id="3536" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们需要定义一个调用configuration service . load config函数的函数。</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="ec3f" class="kx ky iq ma b gy me mf l mg mh">const appInitializerFn = (appConfig: ConfigurationService) =&gt; {<br/>  return () =&gt; {<br/>    return appConfig.loadConfig();<br/>  };<br/>};</span></pre><p id="d89d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，在providers数组中为APP_INITIALIZER和ConfigurationService添加一个元素。</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="b956" class="kx ky iq ma b gy me mf l mg mh">providers: [<br/>  ConfigurationService,<br/>  {<br/>    provide: APP_INITIALIZER,<br/>    useFactory: appInitializerFn,<br/>    multi: true,<br/>    deps: [ConfigurationService]<br/>  }]</span></pre><h2 id="8fad" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">包扎</h2><p id="6b1d" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">这是比我想象的要复杂的事情之一。谢天谢地，有了上面的改变，我能够让它正常工作了。我希望这能为大家节省一些时间。所有修改的代码可以在<a class="ae kw" href="https://github.com/elanderson/Angular-Core-IdentityServer/tree/21477db53da290fae815c6d80aeb27569ffcac6f" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p></div><div class="ab cl mi mj hu mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ij ik il im in"><p id="724c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="mp">原载于</em> <a class="ae kw" href="https://elanderson.net/2018/05/pass-asp-net-core-appsettings-values-to-angular-via-an-api-call/" rel="noopener ugc nofollow" target="_blank"> <em class="mp">安德森</em> </a> <em class="mp">。</em></p></div></div>    
</body>
</html>