<html>
<head>
<title>Code-based Database Migrations with DbUp</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用DbUp进行基于代码的数据库迁移</h1>
<blockquote>原文：<a href="https://itnext.io/code-based-database-migrations-with-dbup-dd04dd2fe2ec?source=collection_archive---------0-----------------------#2020-08-17">https://itnext.io/code-based-database-migrations-with-dbup-dd04dd2fe2ec?source=collection_archive---------0-----------------------#2020-08-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="a159" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在今天的帖子中，我们将了解DbUp基于代码的迁移特性，该特性允许代码作为迁移过程的一部分运行，而不仅仅是基于SQL的脚本。作为迁移的一部分运行代码的能力为迁移过程提供了极大的灵活性。这是基于上周的文章<a class="ae kl" href="https://elanderson.net/2020/08/database-migrations-with-dbup/" rel="noopener ugc nofollow" target="_blank">使用DbUp进行数据库迁移</a>，如果您是DbUp的新手，请务必查看一下。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/d6b2efb9fb5cd3edf98cf9fde205f97b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4kTC5TkgPy9klRJC.jpg"/></div></div></figure><h2 id="5eec" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">脚本提供程序更改</h2><p id="b64e" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">在我们上周在<strong class="jp ir">程序</strong>类中发布的示例应用程序中，当设置我们的<strong class="jp ir">升级程序</strong>时，我们使用了以下设置。</p><pre class="kn ko kp kq gt lw lx ly lz aw ma bi"><span id="91cb" class="ky kz iq lx b gy mb mc l md me">var upgrader =<br/>    DeployChanges.To<br/>                 .SqlDatabase(connectionString)<br/>                 .WithScriptsEmbeddedInAssembly(Assembly.GetExecutingAssembly())<br/>                 .LogToConsole()<br/>                 .Build();</span></pre><p id="636e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面只选取了嵌入的SQL类型文件。为了能够进行基于代码的迁移，我们必须从<strong class="jp ir">withscriptsbembeddedinassembly</strong>脚本提供程序更改为<strong class="jp ir">WithScriptsAndCodeEmbeddedInAssembly</strong>。下面是突出显示了新脚本提供程序的升级程序。</p><pre class="kn ko kp kq gt lw lx ly lz aw ma bi"><span id="10e2" class="ky kz iq lx b gy mb mc l md me">var upgrader =<br/>    DeployChanges.To<br/>                 .SqlDatabase(connectionString)<br/>                 .WithScriptsAndCodeEmbeddedInAssembly(Assembly.GetExecutingAssembly())<br/>                 .LogToConsole()<br/>                 .Build();</span></pre><h2 id="087f" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">基于代码的迁移</h2><p id="e5af" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">要添加基于代码的迁移，请添加一个新类，并将其设置为实现DbUp的<strong class="jp ir"> IScript </strong>接口。我们在上面更改的脚本提供者将获取任何实现了<strong class="jp ir"> IScript </strong>以及SQL脚本文件的非抽象类。结果按照名称进行组合和排序，以确定执行顺序，因此要确保您选择的任何命名约定都能够正确排序SQL脚本和代码。</p><p id="e478" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">IScript接口定义了一个函数ProvideScript，该函数有一个参数，该参数提供了一个创建数据库命令并返回字符串的函数。根据需要，您可以返回一个包含要执行的SQL的字符串，或者您可以创建一个命令并直接在数据库上执行您需要的任何命令，或者根据需要将两者结合使用。</p><p id="a1c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了测试基于代码的迁移，我在Scripts文件夹中添加了以下新类。它实际上不会更改任何数据，而是将一些信息记录到控制台。即使不改变数据，它仍然传达了基于代码的迁移是如何工作的。</p><pre class="kn ko kp kq gt lw lx ly lz aw ma bi"><span id="3d67" class="ky kz iq lx b gy mb mc l md me">using System;<br/>using System.Data;<br/>using DbUp.Engine;<br/><br/>namespace DbupTest.Scripts<br/>{<br/>    public class Code0002Test : IScript<br/>    {<br/>        public string ProvideScript(Func&lt;IDbCommand&gt; dbCommandFactory)<br/>        {<br/>            using (var cmd = dbCommandFactory())<br/>            {<br/>                cmd.CommandText = "SELECT DeliveryMethodName FROM Application.DeliveryMethods";<br/><br/>                using (var dr = cmd.ExecuteReader())<br/>                {<br/>                    Console.WriteLine("  Delivery Methods");<br/><br/>                    while (dr.Read())<br/>                    {<br/>                        Console.WriteLine($"    {dr["DeliveryMethodName"]}");<br/>                    }<br/>                }<br/>            }<br/><br/>            return string.Empty;<br/>        }<br/>    }<br/>}</span></pre><p id="a100" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是运行该应用程序的控制台输出。</p><pre class="kn ko kp kq gt lw lx ly lz aw ma bi"><span id="77e2" class="ky kz iq lx b gy mb mc l md me">Beginning database upgrade<br/>Checking whether journal table exists..<br/>Fetching list of already executed scripts.<br/>  Delivery Methods<br/>    Air Freight<br/>    Chilled Van<br/>    Courier<br/>    Customer Collect<br/>    Customer Courier to Collect<br/>    Delivery Van<br/>    Post<br/>    Refrigerated Air Freight<br/>    Refrigerated Road Freight<br/>    Road Freight<br/>Executing Database Server script 'DbupTest.Scripts.Code0002Test.cs'<br/>Checking whether journal table exists..<br/>Upgrade successful<br/>Success!</span></pre><h2 id="2b32" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">包扎</h2><p id="fe58" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">在数据库迁移过程中运行代码的能力是一组非常棒的功能。我建议将基于SQL的迁移作为默认设置，只有当SQL不能提供完成所需任务的方法或者用代码进行迁移更容易理解时，才使用代码。确保并查看关于此功能的<a class="ae kl" href="https://dbup.readthedocs.io/en/latest/usage/#code-based-scripts" rel="noopener ugc nofollow" target="_blank">官方DbUp文档</a>以了解更多信息。</p></div><div class="ab cl mf mg hu mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ij ik il im in"><p id="26cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mm">原载于</em><a class="ae kl" href="https://elanderson.net/2020/08/code-based-database-migrations-with-dbup/" rel="noopener ugc nofollow" target="_blank"><em class="mm"/></a><em class="mm">。</em></p></div></div>    
</body>
</html>