<html>
<head>
<title>Exposing microservices running in AWS EKS with a microservices/API gateway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过微服务/API网关公开在AWS EKS中运行的微服务</h1>
<blockquote>原文：<a href="https://itnext.io/exposing-microservices-running-in-aws-eks-with-a-microservices-api-gateway-5753f068e26c?source=collection_archive---------5-----------------------#2019-02-08">https://itnext.io/exposing-microservices-running-in-aws-eks-with-a-microservices-api-gateway-5753f068e26c?source=collection_archive---------5-----------------------#2019-02-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="25ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以您决定在AWS中运行Kubernetes工作负载。<a class="ae kl" href="https://medium.com/solo-io/easy-aws-eks-cluster-provisioning-and-user-access-5e3cdc01dfc6" rel="noopener">正如我们之前看到的</a>建立<a class="ae kl" href="https://docs.aws.amazon.com/eks/latest/userguide/getting-started.html" rel="noopener ugc nofollow" target="_blank"> AWS EKS </a>需要很多耐心和麻烦。你也许能让它工作。对于其他人，您应该查看来自Weaveworks 的<code class="fe km kn ko kp b">eksctl</code> <a class="ae kl" href="https://github.com/weaveworks/eksctl" rel="noopener ugc nofollow" target="_blank">工具。</a></p><p id="1af5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在您已经有了一个Kubernetes集群，您希望开始向它部署您的微服务，并开始向您的客户端和组织的其他部分公开和集成API和服务。在<a class="ae kl" href="https://www.solo.io/" rel="noopener ugc nofollow" target="_blank"> Solo.io </a>我们已经<a class="ae kl" href="https://medium.com/solo-io/announcing-gloo-the-function-gateway-3f0860ef6600" rel="noopener">开源了一个微服务网关</a>构建在<a class="ae kl" href="https://www.envoyproxy.io/" rel="noopener ugc nofollow" target="_blank">特使代理</a>之上，名为<a class="ae kl" href="https://github.com/solo-io/gloo" rel="noopener ugc nofollow" target="_blank"> Gloo </a>。<a class="ae kl" href="https://github.com/solo-io/gloo" rel="noopener ugc nofollow" target="_blank"> Gloo </a>是一个平台不可知的控制平面，专为理解“函数”级调用(考虑HTTP路径/方法/头、gRPC调用或Lambda函数的组合)而构建，目的是组合它们并为南北和东西流量构建更丰富的API。Gloo是像Istio这样的服务网格技术的高度补充。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl kv"><img src="../Images/8ce7332b018a97bffbd058db261e7352.png" data-original-src="https://miro.medium.com/v2/format:webp/1*QVvL6hmAreamqc15exn7Og.png"/></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">微服务的功能网关</figcaption></figure><p id="c221" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Gloo的功能包括:</p><ul class=""><li id="e5d0" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">函数路由(HTTP/1、HTTP/2、gRPC函数、Lambda/Cloud函数)</li><li id="cd36" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">细粒度的流量转移(功能金丝雀、功能加权路由等)</li><li id="0a51" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">请求/内容转换(隐式和显式)</li><li id="12a3" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">授权/认证</li><li id="3211" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">限速</li><li id="2c88" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">gRPC</li><li id="3f3e" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">WebSockets</li><li id="9620" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">肥皂/ WSDL</li><li id="def7" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">深度指标收集</li><li id="27d7" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">聚合数据API的GraphQL引擎</li><li id="e20e" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">强大的平台无关的发现机制</li></ul><p id="1ac0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Gloo拥有非常深厚的Kubernetes原生支持，可以作为您的Kubernetes集群的集群入口运行。顺便提一下，对于入口、API网关、API管理(甚至服务网格)的一些急需的澄清，看看博客文章“<a class="ae kl" href="https://medium.com/solo-io/api-gateways-are-going-through-an-identity-crisis-d1d833a313d7" rel="noopener"> API网关正在经历一场身份危机</a></p><p id="a86b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在帮助人们在AWS EKS使用Gloo的过程中，我们不得不在选择和公开运行在Kubernetes中的服务的相当复杂的选择中导航。这些选项对于其他Kuberentes是相同的——本地入口、API或函数网关。由于AWS EKS是Kubernetes，我们可以通过以下方式公开类似Gloo的微服务/API网关:</p><ul class=""><li id="139c" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">一个Kubernetes <a class="ae kl" href="https://kubernetes.io/docs/concepts/services-networking/ingress/" rel="noopener ugc nofollow" target="_blank">入口资源</a></li><li id="a250" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">带有负载平衡器类型的Kubernetes <a class="ae kl" href="https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer" rel="noopener ugc nofollow" target="_blank">服务</a></li><li id="ebaa" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">Kubernetes <a class="ae kl" href="https://kubernetes.io/docs/concepts/services-networking/service/#nodeport" rel="noopener ugc nofollow" target="_blank">服务作为节点端口</a>(不推荐用于生产)</li></ul><p id="43c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Gloo上，我们也在致力于<a class="ae kl" href="https://docs.openshift.com/container-platform/3.9/install_config/router/index.html" rel="noopener ugc nofollow" target="_blank">原生OpenShift支持</a>，应该很快就会有了。</p><p id="db2b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与此同时，如果您在AWS EKS上运行工作负载，您可能会有一些关于如何利用微服务网关的问题，或者您是否应该只使用AWS管理的<a class="ae kl" href="https://aws.amazon.com/api-gateway/" rel="noopener ugc nofollow" target="_blank"> AWS API网关</a>？</p><p id="502e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们在这里探讨一下这些选项。</p><p id="4603" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">AWS EKS实际上是Kubernetes的托管控制平面，您自己运行您的工作节点。典型的设置是让您的工作节点(EC2主机)位于专用VPC中，并使用所有内置的VPC隔离、安全组、IAM策略等。一旦您开始将工作负载/微服务部署到您的Kubernetes集群，您可能希望公开它们和/或向您的客户/顾客/合作伙伴等提供一个良好解耦的API。你的第一个问题可能是“嗯，既然我在使用AWS，在我的Kubernetes集群前面使用<a class="ae kl" href="https://aws.amazon.com/api-gateway/" rel="noopener ugc nofollow" target="_blank"> AWS API网关</a>应该非常容易”。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl kv"><img src="../Images/0eb61370fd1a66636b83f662dd9305e1.png" data-original-src="https://miro.medium.com/v2/format:webp/1*6Et27CC7R4vp6iHqCpxf7w.png"/></div></figure><p id="4537" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">随着您开始深入研究，您会意识到将AWS API网关连接到您的EKS集群并不是那么简单。你会发现AWS API Gateway在它自己的VPC中运行，并且是完全托管的，所以你看不到它的基础设施的任何细节。幸运的是，有了AWS API Gateway，您<em class="lq">可以</em>进行<a class="ae kl" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-private-integration.html" rel="noopener ugc nofollow" target="_blank">“私有集成”来连接到在您自己的VPC </a>中运行的HTTP端点。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl kv"><img src="../Images/dae13de1962a5e5b14a6f3f37f4b6027.png" data-original-src="https://miro.medium.com/v2/format:webp/1*vzBuBnp9cj3SPXcrCvIfCw.png"/></div></figure><p id="fe9d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">私有集成允许您在您的私有VPC中公开一个<a class="ae kl" href="https://docs.aws.amazon.com/elasticloadbalancing/latest/network/introduction.html" rel="noopener ugc nofollow" target="_blank">网络负载平衡器(NLB) </a>，它可以终止您的API网关到VPC集成的流量。所以基本上AWS API网关会创建一个<a class="ae kl" href="https://docs.aws.amazon.com/apigateway/api-reference/resource/vpc-link/" rel="noopener ugc nofollow" target="_blank"> VpcLink </a>到运行在你的VPC 中的<a class="ae kl" href="https://aws.amazon.com/about-aws/whats-new/2017/11/amazon-api-gateway-supports-endpoint-integrations-with-private-vpcs/" rel="noopener ugc nofollow" target="_blank"> NLB。</a></p><p id="a8b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以那太好了！网络负载平衡器是一个<a class="ae kl" href="https://docs.aws.amazon.com/elasticloadbalancing/latest/network/introduction.html" rel="noopener ugc nofollow" target="_blank">非常强大的负载平衡器</a>，但是即使它在您的VPC中运行，它也不知道或理解在您的Kubernetes集群(即Kubernetes Pods)中运行的工作负载。让我们改变这一点。此时，我们需要部署某种类型的<a class="ae kl" href="https://kubernetes.io/docs/concepts/services-networking/ingress/#ingress-controllers" rel="noopener ugc nofollow" target="_blank"> Kubernetes Ingress </a>端点，它知道如何路由到pod。在这一点上，有些人可能倾向于使用原生的Kubernetes入口资源，或者您真的可以只使用一个公开为“负载平衡器”的Kubernetes服务。事实上，我们可以更进一步。当您在EKS的Kubernetes服务中指定<em class="lq">负载平衡器</em>时，创建的默认负载平衡器是一个<a class="ae kl" href="https://docs.aws.amazon.com/elasticloadbalancing/latest/classic/introduction.html" rel="noopener ugc nofollow" target="_blank">经典负载平衡器</a>。这样做的问题是API网关不能路由到传统的负载平衡器。我们需要在EKS内部运行的Kubernetes服务来创建一个网络负载平衡器。例如，此配置将创建一个经典的负载平衡器:</p><pre class="kq kr ks kt gt lr kp ls lt aw lu bi"><span id="fa49" class="lv lw iq kp b gy lx ly l lz ma">apiVersion: v1<br/>kind: Service<br/>metadata:<br/> name: gloo<br/> namespace: default<br/> annotations: {}<br/>spec:<br/> ports:<br/> - name: http<br/> port: 80<br/> protocol: TCP<br/> targetPort: 80<br/> selector:<br/> app: gloo<br/>type: LoadBalancer</span></pre><p id="7e75" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我们在EKS创建这个服务时，添加注释<code class="fe km kn ko kp b"><a class="ae kl" href="http://service.beta.kubernetes.io/aws-load-balancer-type" rel="noopener ugc nofollow" target="_blank">service.beta.kubernetes.io/aws-load-balancer-type</a>: "nlb"</code>将导致AWS创建一个网络负载平衡器:</p><pre class="kq kr ks kt gt lr kp ls lt aw lu bi"><span id="eee5" class="lv lw iq kp b gy lx ly l lz ma">apiVersion: v1<br/>kind: Service<br/>metadata:<br/> name: gloo<br/> namespace: default<br/> labels:<br/> app: gloo<br/> annotations:<br/> <a class="ae kl" href="http://service.beta.kubernetes.io/aws-load-balancer-type" rel="noopener ugc nofollow" target="_blank">service.beta.kubernetes.io/aws-load-balancer-type</a>: "nlb"<br/>spec:<br/> externalTrafficPolicy: Local<br/> ports:<br/> - name: http<br/> port: 80<br/> protocol: TCP<br/> targetPort: 80<br/> selector:<br/> app: gloo<br/>type: LoadBalancer</span></pre><p id="5c3a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">至此，我们已经正确配置了负载平衡器(私有VPC中的NLB)和AWS API网关的正确组合。我们甚至可以在AWS API网关上启用<a class="ae kl" href="https://docs.aws.amazon.com/waf/latest/developerguide/how-aws-waf-works.html" rel="noopener ugc nofollow" target="_blank"> AWS web应用防火墙(WAF) </a>。唯一的问题是，我们在边缘拥有AWS API网关的能力(和成本)，但它仍然不理解我们在Kubernetes集群中运行的工作负载。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl kv"><img src="../Images/2ca32e542b492b311df90ce14a7a7084.png" data-original-src="https://miro.medium.com/v2/format:webp/1*BfNfbSEzjne5xQrAn0X10Q.png"/></div></figure><p id="8c76" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我们想做canary发布、API聚合、函数路由和内容转换之类的事情时，我们需要在Kubernetes集群中完成。Gloo解决了这个问题。那么你真的需要API网关-&gt; NLB -&gt; API网关吗？在这种情况下，您可以将您的网络负载平衡器提升到一个公共子网，让Gloo处理所有的API网关路由、流量整形、速率限制，而不会失去AWS API网关的任何功能(Lambda路由、AuthZ/N、Websockets等)。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl kv"><img src="../Images/2fcac3316f7ce0d9932fa12087bcdcc5.png" data-original-src="https://miro.medium.com/v2/format:webp/1*ZPgsGpLwpO8BMK4QaGrU-w.png"/></div></figure><p id="8291" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在上一节开始时假设，在使用EKS时，AWS API网关比其他解决方案更容易与我们的Kubernetes集群集成。我们发现事实并非如此。然而，我们还有其他选择。如果你使用EKS，你将需要某种API网关或者微服务网关<a class="ae kl" href="https://kubernetes.io/docs/concepts/services-networking/ingress/#ingress-controllers" rel="noopener ugc nofollow" target="_blank">，在Kubernetes </a>中运行。但是我们如何让流量到达我们的EKS集群呢？如果我们想利用AWS Web应用防火墙(WAF)之类的东西呢？</p><p id="d970" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">鉴于各种类型的负载平衡器和在AWS EKS运行微服务/API网关的权衡，我们的选择可归结为以下几点:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl kv"><img src="../Images/368495938194fa38c33fafbac890f2ed.png" data-original-src="https://miro.medium.com/v2/format:webp/1*IMmXmv8Ijzvcte-siuEYHg.png"/></div></figure><p id="3c4f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这与上一节类似，但是您没有使用Gloo这样强大的微服务网关，而是选择在Kubernetes中使用基本的入口控制器。在这种情况下，您可以利用AWS API Gateay，拥有像AWS Web应用程序防火墙这样的好东西，但是您失去了在EKS (pods)中运行的工作负载的保真度</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl kv"><img src="../Images/2fcac3316f7ce0d9932fa12087bcdcc5.png" data-original-src="https://miro.medium.com/v2/format:webp/1*ZPgsGpLwpO8BMK4QaGrU-w.png"/></div></figure><p id="b7a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是上一节的用例。现在，您已经获得了更接近EKS工作负载的微服务网关的强大功能，但您的优势是一个冗余且昂贵的网关。这里的好处是您仍然可以利用AWS web应用程序防火墙(WAF)。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl kv"><img src="../Images/0067b1e2664703165663cadccc6eb87b.png" data-original-src="https://miro.medium.com/v2/format:webp/1*mCUKJdYJ6ilohOm4ftPGmg.png"/></div></figure><p id="7b43" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，我们避开了AWS API网关，只使用位于公共子网中的网络负载平衡器。微服务/API网关的所有功能现在都位于您在EKS的工作负载附近，但您失去了web应用防火墙(不能应用于NLB)。如果您有自己正在使用WAF，这可能是一个不错的权衡。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl kv"><img src="../Images/c0b92c5b26240dcd2cb5a35391e2b790.png" data-original-src="https://miro.medium.com/v2/format:webp/1*No_XEvoydSvwDGx6QS9VgQ.png"/></div></figure><p id="6d23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以使用应用程序负载平衡器(可以应用AWS WAF)更好地控制面向公众的网络请求，同时仍然保持您的EKS流量私有，并通过私有NLB进行控制。使用这种方法，您还可以通过CloudFormation集中管理您的所有TLS证书</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="ab gu cl kv"><img src="../Images/77e32d4aec15a575be4096ada02fc21f.png" data-original-src="https://miro.medium.com/v2/format:webp/1*RFHerU4U4vAdJcbzuQfwYw.png"/></div></figure><p id="ed89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以使用带有应用程序负载平衡器的第三方插件<a class="ae kl" href="https://aws.amazon.com/blogs/opensource/kubernetes-ingress-aws-alb-ingress-controller/" rel="noopener ugc nofollow" target="_blank"> Kubernetes Ingress来管理您在Kubernetes中的ALB。此时，您可以在EKS集群中本地和私有地运行API Gateweay，并且仍然可以利用WAF，因为我们使用的是ALB。缺点是这个功能是由一个第三方插件提供的，而且</a><a class="ae kl" href="https://www.sentialabs.io/2018/10/21/Integrating-EKS-with-other-AWS-services.html#fifth-challenge-deploying-api-gateway-in-front-of-eks" rel="noopener ugc nofollow" target="_blank">你不能通过云形式集中管理你的证书</a>。也就是说，你必须使用<a class="ae kl" href="https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/ingress/annotation/#ssl" rel="noopener ugc nofollow" target="_blank">入口注释来管理那些</a>。</p><p id="469c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在AWS EKS有几个运行微服务/API网关的选项。每种组合都有利弊，应该仔细考虑。我们专门构建了<a class="ae kl" href="https://github.com/solo-io/gloo" rel="noopener ugc nofollow" target="_blank"> Gloo </a>作为一个强大的跨平台、跨云微服务API网关。这意味着在AWS、内部或任何其他云上运行时，您有更多的选择。每个组织都有自己独特的约束、观点和选择。我们相信，有一些很好的选择可以让整体微服务器或内部混合部署到公共云获得成功。如果您对此用例有其他建议，<a class="ae kl" href="http://www.twitter.com/christianposta" rel="noopener ugc nofollow" target="_blank">请在twitter上联系我@ Christian posta</a>或在本博客的评论中。</p></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><p id="f8fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lq">原载于2019年2月8日medium.com</em><a class="ae kl" href="https://medium.com/solo-io/exposing-microservices-running-in-aws-eks-with-a-microservices-api-gateway-like-solo-gloo-263651e309f8" rel="noopener"><em class="lq"/></a><em class="lq">。</em></p></div></div>    
</body>
</html>