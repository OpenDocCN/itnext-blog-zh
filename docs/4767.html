<html>
<head>
<title>I Built a Tool to Monitor San Francisco Air Quality and Alert Any Changes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我开发了一个工具来监控旧金山的空气质量，并对任何变化发出警报</h1>
<blockquote>原文：<a href="https://itnext.io/i-built-a-tool-to-monitor-san-francisco-air-quality-and-alert-any-changes-b2a552c23448?source=collection_archive---------4-----------------------#2020-09-11">https://itnext.io/i-built-a-tool-to-monitor-san-francisco-air-quality-and-alert-any-changes-b2a552c23448?source=collection_archive---------4-----------------------#2020-09-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b1c6aaf878fa7ca267cca4a18908d4ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9HeMqDEBo7JoLNFFED34-Q.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://en.wikipedia.org/wiki/San_Francisco" rel="noopener ugc nofollow" target="_blank"> <strong class="bd kd">旧金山</strong> </a></figcaption></figure><p id="3759" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">如今跟踪天气演变并不困难。你可以通过互联网、收音机包括电视获得天气数据。但是一个个性化的解决方案呢，一个只通知我们想要的城市中我们想要的指标的应用？</p><p id="559d" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">我们甚至可以将此与空气质量结合起来，这是这段时间的一个重要话题，尤其是如果你住在旧金山。这将是有趣的，因为空气质量不是那么容易获得的。没有太多的数据提供者，这种类型的数据比天气数据更难获得。</p><p id="77e7" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">所以让我们为此开发一个应用程序。</p><p id="35df" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">我们的应用程序的最终输出将如下所示。每天早上的某个时间，当天的天气预报将通过电子邮件与当前的空气质量值一起发送。</p><p id="7ec0" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">与此同时，当空气质量下降到某个阈值以下时，将会发出警报，指示高于该限值的一个或多个指标。</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lc"><img src="../Images/7eb84d0de99596a6f9acd9fb76127cc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*DjAffwxhIFRznXk31JIy1Q.gif"/></div></div></figure><h1 id="15b7" class="lh li iq bd kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">让我们编码吧</h1><p id="5eeb" class="pw-post-body-paragraph ke kf iq kg b kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx mi kz la lb ij bi translated">为了能够获取我们感兴趣的数据类型，我们将使用<a class="ae kc" href="https://www.climacell.co/weather-api/" rel="noopener ugc nofollow" target="_blank"> ClimaCell天气API </a>。</p><p id="47fa" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">他们的API将允许我们收集可靠的天气和空气质量数据。</p><p id="dfda" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">在实际开始编码之前，我们需要做的第一步是设置项目，并在ClimaCell上创建一个帐户，这样我们就可以接收一个API密匙。</p><h1 id="6abe" class="lh li iq bd kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">1.设置项目</h1><ol class=""><li id="2ee9" class="mj mk iq kg b kh me kl mf kp ml kt mm kx mn lb mo mp mq mr bi translated">运行以下命令来设置<code class="fe ms mt mu mv b">npm</code>并安装所需的依赖项。</li></ol><p id="eb95" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><code class="fe ms mt mu mv b">npm init -y &amp;&amp; npm i node-fetch nodemailer pug</code></p><ul class=""><li id="4af0" class="mj mk iq kg b kh ki kl km kp mw kt mx kx my lb mz mp mq mr bi translated"><code class="fe ms mt mu mv b">node-fetch</code>将用于向ClimaCell API发送请求；</li><li id="208c" class="mj mk iq kg b kh na kl nb kp nc kt nd kx ne lb mz mp mq mr bi translated"><code class="fe ms mt mu mv b">nodemailer</code>将用于发送邮件；</li><li id="4faa" class="mj mk iq kg b kh na kl nb kp nc kt nd kx ne lb mz mp mq mr bi translated"><code class="fe ms mt mu mv b">pug</code>会用来写邮件模板；</li></ul><p id="b026" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">2.创建一个<code class="fe ms mt mu mv b">config.json</code>文件来存储您的凭证并填充您的数据。</p><pre class="ld le lf lg gt nf mv ng nh aw ni bi"><span id="83ad" class="nj li iq mv b gy nk nl l nm nn">{<br/>  "host": "&lt;email server host&gt;",<br/>  "user": "&lt;email_addr&gt;",<br/>  "pass": "&lt;email_pwd&gt;",<br/>  "cc_key": "&lt;climacell_api_key&gt;"<br/>}</span></pre><ul class=""><li id="5cf2" class="mj mk iq kg b kh ki kl km kp mw kt mx kx my lb mz mp mq mr bi translated"><code class="fe ms mt mu mv b">host</code>、<code class="fe ms mt mu mv b">user</code>和<code class="fe ms mt mu mv b">pass</code>字段用于配置<code class="fe ms mt mu mv b">nodemailer</code>。我从我的电子邮件托管服务发送电子邮件。如果你想从你的Gmail帐户发送电子邮件，你可以用<code class="fe ms mt mu mv b">service</code>替换<code class="fe ms mt mu mv b">host</code>属性，然后按照StackOverflow问题中的<a class="ae kc" href="https://stackoverflow.com/questions/19877246/nodemailer-with-gmail-and-nodejs" rel="noopener ugc nofollow" target="_blank">指令</a>进行操作。</li><li id="1ea5" class="mj mk iq kg b kh na kl nb kp nc kt nd kx ne lb mz mp mq mr bi translated"><code class="fe ms mt mu mv b">cc_key</code>是您的私有ClimaCell API密钥。</li></ul><h1 id="5fe8" class="lh li iq bd kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">2.应用程序设置</h1><p id="c3be" class="pw-post-body-paragraph ke kf iq kg b kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx mi kz la lb ij bi translated">第二步，我们必须编写一些强制脚本，这些脚本不是主要逻辑的一部分，但却是应用程序所需要的。</p><p id="b4a2" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这一步包括定义常数、需要库等等。</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/dd971917dc0ad5db4976abeb107ec447.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6dLKTUq7-vzlRXVeLcGN_g.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://carbon.now.sh/?bg=rgba(171%2C%20184%2C%20195%2C%201)&amp;t=seti&amp;wt=none&amp;l=javascript&amp;ds=true&amp;dsyoff=20px&amp;dsblur=68px&amp;wc=true&amp;wa=true&amp;pv=56px&amp;ph=56px&amp;ln=false&amp;fl=1&amp;fm=Hack&amp;fs=14px&amp;lh=133%25&amp;si=false&amp;es=2x&amp;wm=false&amp;code=%252F%252F%2520*%2520dependencies%250Aconst%2520fs%2520%253D%2520require(%2522fs%2522)%253B%250Aconst%2520nodemailer%2520%253D%2520require(%2522nodemailer%2522)%253B%250Aconst%2520fetch%2520%253D%2520require(%2522node-fetch%2522)%253B%250Aconst%2520pug%2520%253D%2520require(%2522pug%2522)%253B%250A%250A%252F%252F%2520*%2520credentials%2520for%2520email%250Aconst%2520%257B%2520host%252C%2520user%252C%2520pass%252C%2520cc_key%252C%2520recipient%2520%257D%2520%253D%2520JSON.parse(%250A%2520%2520fs.readFileSync(%2522.%252Fconfig.json%2522)%250A)%253B%250A%250A%252F%252F%2520*%2520globals%250Aconst%2520LAT%2520%253D%252037.7749%253B%250Aconst%2520LONG%2520%253D%2520-122.4194%253B%250A%250Aconst%2520AIR_QUALITY_INDICATOR%2520%253D%2520%255B%2522pm10%2522%252C%2520%2522pm25%2522%252C%2520%2522o3%2522%252C%2520%2522no2%2522%252C%2520%2522co%2522%252C%2520%2522so2%2522%255D%253B%250Aconst%2520WEATHER_FIELDS%2520%253D%2520%255B%2522weather_code%2522%252C%2520%2522temp%2522%252C%2520%2522wind_speed%2522%252C%2520%2522humidity%2522%255D%253B%250A%250A%252F%252F%2520*%2520configure%2520email%2520transporter%250Aconst%2520transporter%2520%253D%2520nodemailer.createTransport(%257B%250A%2520%2520host%252C%250A%2520%2520port%253A%2520587%252C%250A%2520%2520secure%253A%2520false%252C%250A%2520%2520auth%253A%2520%257B%250A%2520%2520%2520%2520user%252C%250A%2520%2520%2520%2520pass%252C%250A%2520%2520%257D%252C%250A%257D)%253B%250A%250A%252F%252F%2520*%2520Helper%2520function%2520to%2520build%2520a%2520query%2520params%250Afunction%2520queryBuilder(request%252C%2520options)%2520%257B%250A%2520%2520request%2520%252B%253D%2520%2522%253F%2522%253B%250A%2520%2520Object.keys(options).forEach((key)%2520%253D%253E%2520%257B%250A%2520%2520%2520%2520if%2520(typeof%2520options%255Bkey%255D%2520%253D%253D%253D%2520%2522number%2522%2520%257C%257C%2520typeof%2520options%255Bkey%255D%2520%253D%253D%253D%2520%2522string%2522)%2520%257B%250A%2520%2520%2520%2520%2520%2520if%2520(request%255Brequest.length%2520-%25201%255D%2520!%253D%253D%2520%2522%253F%2522)%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520request%2520%252B%253D%2520%2522%2526%2522%253B%250A%2520%2520%2520%2520%2520%2520%257D%250A%2520%2520%2520%2520%2520%2520request%2520%252B%253D%2520%2560%2524%257Bkey%257D%253D%2524%257Boptions%255Bkey%255D%257D%2560%253B%250A%2520%2520%2520%2520%257D%2520else%2520if%2520(Array.isArray(options%255Bkey%255D))%2520%257B%250A%2520%2520%2520%2520%2520%2520options%255Bkey%255D.forEach((e)%2520%253D%253E%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520if%2520(typeof%2520e%2520%253D%253D%253D%2520%2522number%2522%2520%257C%257C%2520typeof%2520e%2520%253D%253D%253D%2520%2522string%2522)%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520if%2520(request%255Brequest.length%2520-%25201%255D%2520!%253D%253D%2520%2522%253F%2522)%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520request%2520%252B%253D%2520%2522%2526%2522%253B%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%257D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520request%2520%252B%253D%2520%2560%2524%257Bkey%257D%253D%2524%257Be%257D%2560%253B%250A%2520%2520%2520%2520%2520%2520%2520%2520%257D%250A%2520%2520%2520%2520%2520%2520%257D)%253B%250A%2520%2520%2520%2520%257D%250A%2520%2520%257D)%253B%250A%2520%2520return%2520request%253B%250A%257D" rel="noopener ugc nofollow" target="_blank"> RAW </a></figcaption></figure><p id="7eea" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">让我们来分解一下:</p><ul class=""><li id="f99e" class="mj mk iq kg b kh ki kl km kp mw kt mx kx my lb mz mp mq mr bi translated"><code class="fe ms mt mu mv b">LAT</code>、<code class="fe ms mt mu mv b">LONG</code> —旧金山的地理坐标；</li><li id="14a1" class="mj mk iq kg b kh na kl nb kp nc kt nd kx ne lb mz mp mq mr bi translated"><code class="fe ms mt mu mv b">AIR_QUALITY_INDICATOR</code> —排列我们感兴趣的空气质量指标；</li><li id="c432" class="mj mk iq kg b kh na kl nb kp nc kt nd kx ne lb mz mp mq mr bi translated"><code class="fe ms mt mu mv b">WEATHER_FIELDS</code> —排列我们感兴趣的天气指标；</li><li id="eb6f" class="mj mk iq kg b kh na kl nb kp nc kt nd kx ne lb mz mp mq mr bi translated"><code class="fe ms mt mu mv b">nodemailer.createTransport()</code> —根据我们的凭证连接到电子邮件服务器；为了安全连接，您可以使用<code class="fe ms mt mu mv b">port: 465</code>和<code class="fe ms mt mu mv b">secure: true</code>；</li><li id="1a1b" class="mj mk iq kg b kh na kl nb kp nc kt nd kx ne lb mz mp mq mr bi translated"><code class="fe ms mt mu mv b">queryBuilder()</code> —这是一个函数的低级实现，可以将查询附加到请求中。我们将使用这个函数来格式化我们的请求的URLs</li></ul><h1 id="a22d" class="lh li iq bd kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">3.获取天气和空气质量数据</h1><p id="544e" class="pw-post-body-paragraph ke kf iq kg b kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx mi kz la lb ij bi translated">第三步是获取我们感兴趣的天气和空气质量数据。</p><p id="86a3" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">对于天气预报，我们有:</p><ul class=""><li id="2193" class="mj mk iq kg b kh ki kl km kp mw kt mx kx my lb mz mp mq mr bi translated">温度</li><li id="31a7" class="mj mk iq kg b kh na kl nb kp nc kt nd kx ne lb mz mp mq mr bi translated">风速</li><li id="d388" class="mj mk iq kg b kh na kl nb kp nc kt nd kx ne lb mz mp mq mr bi translated">湿度</li><li id="0fc9" class="mj mk iq kg b kh na kl nb kp nc kt nd kx ne lb mz mp mq mr bi translated">天气代码(下雨、多云、晴朗等)</li></ul><p id="3ba4" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">对于空气质量，我们有:</p><ul class=""><li id="1f2d" class="mj mk iq kg b kh ki kl km kp mw kt mx kx my lb mz mp mq mr bi translated">pm10</li><li id="590b" class="mj mk iq kg b kh na kl nb kp nc kt nd kx ne lb mz mp mq mr bi translated">pm25</li><li id="58d2" class="mj mk iq kg b kh na kl nb kp nc kt nd kx ne lb mz mp mq mr bi translated">臭氧</li><li id="c625" class="mj mk iq kg b kh na kl nb kp nc kt nd kx ne lb mz mp mq mr bi translated">no2</li><li id="dc1d" class="mj mk iq kg b kh na kl nb kp nc kt nd kx ne lb mz mp mq mr bi translated">总裁</li><li id="bdb0" class="mj mk iq kg b kh na kl nb kp nc kt nd kx ne lb mz mp mq mr bi translated">二氧化硫</li></ul><p id="aab0" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这两个都是在<code class="fe ms mt mu mv b">WEATHER_FIELDS</code>和<code class="fe ms mt mu mv b">AIR_QUALITY_INDICATOR</code>中声明的。</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi np"><img src="../Images/d097ad02f93397f81e56981d873508b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E9_s4mh90amI7as9R4vKIA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://carbon.now.sh/?bg=rgba(171%2C%20184%2C%20195%2C%201)&amp;t=seti&amp;wt=none&amp;l=javascript&amp;ds=true&amp;dsyoff=20px&amp;dsblur=68px&amp;wc=true&amp;wa=true&amp;pv=56px&amp;ph=56px&amp;ln=false&amp;fl=1&amp;fm=Hack&amp;fs=14px&amp;lh=133%25&amp;si=false&amp;es=2x&amp;wm=false&amp;code=%252F%252F%2520*%2520get%2520air%2520quality%2520data%250Aasync%2520function%2520getAirQualityData()%2520%257B%250A%2520%2520const%2520url%2520%253D%2520queryBuilder(%2522https%253A%252F%252Fapi.climacell.co%252Fv3%252Fweather%252Frealtime%2522%252C%2520%257B%250A%2520%2520%2520%2520lat%253A%2520LAT%252C%250A%2520%2520%2520%2520lon%253A%2520LONG%252C%250A%2520%2520%2520%2520fields%253A%2520AIR_QUALITY_INDICATOR%252C%250A%2520%2520%2520%2520apikey%253A%2520cc_key%252C%250A%2520%2520%257D)%253B%250A%2520%2520const%2520res%2520%253D%2520await%2520fetch(url)%253B%250A%2520%2520const%2520data%2520%253D%2520await%2520res.json()%253B%250A%2520%2520return%2520data%253B%250A%257D%250A%250A%252F%252F%2520*%2520get%2520weather%2520data%250Aasync%2520function%2520getWeatherData()%2520%257B%250A%2520%2520const%2520url%2520%253D%2520queryBuilder(%250A%2520%2520%2520%2520%2522https%253A%252F%252Fapi.climacell.co%252Fv3%252Fweather%252Fforecast%252Fhourly%2522%252C%250A%2520%2520%2520%2520%257B%250A%2520%2520%2520%2520%2520%2520lat%253A%2520LAT%252C%250A%2520%2520%2520%2520%2520%2520lon%253A%2520LONG%252C%250A%2520%2520%2520%2520%2520%2520unit_system%253A%2520%2522si%2522%252C%250A%2520%2520%2520%2520%2520%2520fields%253A%2520WEATHER_FIELDS%252C%250A%2520%2520%2520%2520%2520%2520apikey%253A%2520cc_key%252C%250A%2520%2520%2520%2520%257D%250A%2520%2520)%253B%250A%250A%2520%2520const%2520res%2520%253D%2520await%2520fetch(url)%253B%250A%2520%2520const%2520data%2520%253D%2520await%2520res.json()%253B%250A%2520%2520return%2520data%253B%250A%257D" rel="noopener ugc nofollow" target="_blank">生</a></figcaption></figure><p id="ac4a" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">在这一步还有一件事要提，那就是属性<code class="fe ms mt mu mv b">unit_system:"si" </code>的值。</p><p id="7b88" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">si代表<strong class="kg ir">国际单位制。</strong></p><p id="b926" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">该属性的另一个可能选项是us <strong class="kg ir"> </strong>值，它代表<strong class="kg ir">美国习惯单位。</strong>美国习惯单位<strong class="kg ir">可能会让一些读者感到困惑，所以我决定采用<strong class="kg ir">国际单位制</strong>。</strong></p><p id="7b5c" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">此时，来自ClimaCell API的数据如下所示。</p><p id="864a" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">函数<code class="fe ms mt mu mv b">getWeatherData()</code>的输出是一个数组，其中包含下一个<strong class="kg ir"> 96小时的天气预报。</strong></p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/ba54fc32aa0a387afd8be369c5a43187.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tuowYeaKC7XX-Car6IR-4Q.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://carbon.now.sh/?bg=rgba(171%2C%20184%2C%20195%2C%201)&amp;t=seti&amp;wt=none&amp;l=application%2Fjson&amp;ds=true&amp;dsyoff=20px&amp;dsblur=68px&amp;wc=true&amp;wa=true&amp;pv=56px&amp;ph=56px&amp;ln=false&amp;fl=1&amp;fm=Hack&amp;fs=14px&amp;lh=133%25&amp;si=false&amp;es=2x&amp;wm=false&amp;code=%250A%255B%250A%2520%2520%257B%250A%2520%2520%2520%2520%2522lon%2522%253A%2520-122.4194%252C%250A%2520%2520%2520%2520%2522lat%2522%253A%252037.7749%252C%250A%2520%2520%2520%2520%2522temp%2522%253A%2520%257B%2520%2522value%2522%253A%252018.57%252C%2520%2522units%2522%253A%2520%2522C%2522%2520%257D%252C%250A%2520%2520%2520%2520%2522humidity%2522%253A%2520%257B%2520%2522value%2522%253A%252045.9%252C%2520%2522units%2522%253A%2520%2522%2525%2522%2520%257D%252C%250A%2520%2520%2520%2520%2522wind_speed%2522%253A%2520%257B%2520%2522value%2522%253A%25202.61%252C%2520%2522units%2522%253A%2520%2522m%252Fs%2522%2520%257D%252C%250A%2520%2520%2520%2520%2522weather_code%2522%253A%2520%257B%2520%2522value%2522%253A%2520%2522clear%2522%2520%257D%252C%250A%2520%2520%2520%2520%2522observation_time%2522%253A%2520%257B%2520%2522value%2522%253A%2520%25222020-06-17T15%253A00%253A00.000Z%2522%2520%257D%250A%2520%2520%257D%252C%250A%2520%2520%257B%250A%2520%2520%2520%2520%2522lon%2522%253A%2520-122.4194%252C%250A%2520%2520%2520%2520%2522lat%2522%253A%252037.7749%252C%250A%2520%2520%2520%2520%2522temp%2522%253A%2520%257B%2520%2522value%2522%253A%252020.31%252C%2520%2522units%2522%253A%2520%2522C%2522%2520%257D%252C%250A%2520%2520%2520%2520%2522humidity%2522%253A%2520%257B%2520%2522value%2522%253A%252038.7%252C%2520%2522units%2522%253A%2520%2522%2525%2522%2520%257D%252C%250A%2520%2520%2520%2520%2522wind_speed%2522%253A%2520%257B%2520%2522value%2522%253A%25202.23%252C%2520%2522units%2522%253A%2520%2522m%252Fs%2522%2520%257D%252C%250A%2520%2520%2520%2520%2522weather_code%2522%253A%2520%257B%2520%2522value%2522%253A%2520%2522clear%2522%2520%257D%252C%250A%2520%2520%2520%2520%2522observation_time%2522%253A%2520%257B%2520%2522value%2522%253A%2520%25222020-06-17T16%253A00%253A00.000Z%2522%2520%257D%250A%2520%2520%257D%252C%250A.....%250A%255D" rel="noopener ugc nofollow" target="_blank">生</a></figcaption></figure><p id="3654" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">函数<code class="fe ms mt mu mv b">getAirQualityData()</code>的输出是一个具有以下属性的对象。</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/005c6308db021739d317f7d95d35294a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bXMNGxfOCqOQrG0MK1x3iA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://carbon.now.sh/?bg=rgba(171%2C%20184%2C%20195%2C%201)&amp;t=seti&amp;wt=none&amp;l=application%2Fjson&amp;ds=true&amp;dsyoff=20px&amp;dsblur=68px&amp;wc=true&amp;wa=true&amp;pv=56px&amp;ph=56px&amp;ln=false&amp;fl=1&amp;fm=Hack&amp;fs=14px&amp;lh=133%25&amp;si=false&amp;es=2x&amp;wm=false&amp;code=%250A%257B%250A%2520%2520%2522lat%2522%253A%252037.7749%252C%250A%2520%2520%2522lon%2522%253A%2520-122.4194%252C%250A%2520%2520%2522pm25%2522%253A%2520%257B%2520%2522value%2522%253A%25206.25%252C%2520%2522units%2522%253A%2520%2522%25C2%25B5g%252Fm3%2522%2520%257D%252C%250A%2520%2520%2522pm10%2522%253A%2520%257B%2520%2522value%2522%253A%252011.625%252C%2520%2522units%2522%253A%2520%2522%25C2%25B5g%252Fm3%2522%2520%257D%252C%250A%2520%2520%2522o3%2522%253A%2520%257B%2520%2522value%2522%253A%25202.625%252C%2520%2522units%2522%253A%2520%2522ppb%2522%2520%257D%252C%250A%2520%2520%2522no2%2522%253A%2520%257B%2520%2522value%2522%253A%252011.1875%252C%2520%2522units%2522%253A%2520%2522ppb%2522%2520%257D%252C%250A%2520%2520%2522co%2522%253A%2520%257B%2520%2522value%2522%253A%25200.25%252C%2520%2522units%2522%253A%2520%2522ppm%2522%2520%257D%252C%250A%2520%2520%2522so2%2522%253A%2520%257B%2520%2522value%2522%253A%25201.25%252C%2520%2522units%2522%253A%2520%2522ppb%2522%2520%257D%252C%250A%2520%2520%2522observation_time%2522%253A%2520%257B%2520%2522value%2522%253A%2520%25222020-06-17T15%253A49%253A05.453Z%2522%2520%257D%250A%257D" rel="noopener ugc nofollow" target="_blank"> RAW </a></figcaption></figure><p id="2619" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">我们说过我们将发送两种类型的电子邮件:</p><ul class=""><li id="80ca" class="mj mk iq kg b kh ki kl km kp mw kt mx kx my lb mz mp mq mr bi translated">每天早上一次，显示当前空气质量分数和未来几小时的天气预报(上午8点、10点、12点、下午2点、4点、6点、8点和10点)</li><li id="70ab" class="mj mk iq kg b kh na kl nb kp nc kt nd kx ne lb mz mp mq mr bi translated">一种是空气质量下降到某个阈值以下</li></ul><p id="7f37" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">为了不使这篇文章过长，我已经写了这两封邮件的模板。它们都可以在Github repo 上找到，还有其余的代码。</p><h1 id="62cb" class="lh li iq bd kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">4.格式化天气和空气质量数据以匹配。pug模板</h1><p id="5ea9" class="pw-post-body-paragraph ke kf iq kg b kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx mi kz la lb ij bi translated">因为我们使用了一个模板引擎，像<code class="fe ms mt mu mv b">pug</code>，我们可以利用<code class="fe ms mt mu mv b">for loops</code>，我们可以插入变量。我们现在需要做的就是格式化我们的数据以匹配写在<code class="fe ms mt mu mv b">weather-forecast-template.pug</code>和<code class="fe ms mt mu mv b">air-quality-alert.pug</code>中的<code class="fe ms mt mu mv b">for loops</code>。</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/04ced0732cdbc37f3a5c23385048405f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*luDEcOoTAAbJgHC_2I7XdQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://carbon.now.sh/?bg=rgba(171%2C%20184%2C%20195%2C%201)&amp;t=seti&amp;wt=none&amp;l=javascript&amp;ds=true&amp;dsyoff=20px&amp;dsblur=68px&amp;wc=true&amp;wa=true&amp;pv=56px&amp;ph=56px&amp;ln=false&amp;fl=1&amp;fm=Hack&amp;fs=14px&amp;lh=133%25&amp;si=false&amp;es=2x&amp;wm=false&amp;code=%252F%252F%2520*%2520format%2520the%2520weather%2520data%2520to%2520match%2520the%2520template%2520in%2520weather-forecast-template.pug%250Afunction%2520formatWeatherData(data)%2520%257B%250A%2520%2520const%2520outputArr%2520%253D%2520%255B%255D%253B%250A%250A%2520%2520data.forEach((e%252C%2520i)%2520%253D%253E%2520%257B%250A%2520%2520%2520%2520const%2520output%2520%253D%2520%257B%257D%253B%250A%2520%2520%2520%2520output%255B%2522hour%2522%255D%2520%253D%2520new%2520Date(e.observation_time.value).getHours()%253B%250A%250A%2520%2520%2520%2520output%255B%2522weather_image%2522%255D%2520%253D%2520%2560.%252Fsummary-icons%252F%2524%257Be.weather_code.value%257D.png%2560%253B%250A%2520%2520%2520%2520output%255B%2522cid%2522%255D%2520%253D%2520%2560wid%2524%257Bi%257D%2560%253B%250A%250A%2520%2520%2520%2520output%255B%2522temp%2522%255D%2520%253D%2520e.temp.value%253B%250A%2520%2520%2520%2520output%255B%2522temp_unit%2522%255D%2520%253D%2520e.temp.units%253B%250A%250A%2520%2520%2520%2520output%255B%2522humidity%2522%255D%2520%253D%2520e.humidity.value%253B%250A%2520%2520%2520%2520output%255B%2522humidity_unit%2522%255D%2520%253D%2520e.humidity.units%253B%250A%250A%2520%2520%2520%2520output%255B%2522wind_speed%2522%255D%2520%253D%2520e.wind_speed.value%253B%250A%2520%2520%2520%2520output%255B%2522wind_speed_unit%2522%255D%2520%253D%2520e.wind_speed.units%253B%250A%250A%2520%2520%2520%2520outputArr.push(output)%253B%250A%2520%2520%257D)%253B%250A%250A%2520%2520return%2520outputArr%253B%250A%257D%250A%250A%252F%252F%2520*%2520format%2520the%2520air%2520quality%2520data%2520to%2520match%2520the%2520template%250Afunction%2520formatAirQualityData(airQualityData)%2520%257B%250A%2520%2520const%2520outputArr%2520%253D%2520%255B%255D%253B%250A%250A%2520%2520AIR_QUALITY_INDICATOR.forEach((indicator%252C%2520i)%2520%253D%253E%2520%257B%250A%2520%2520%2520%2520outputArr.push(%257B%250A%2520%2520%2520%2520%2520%2520indicator%253A%2520indicator%252C%250A%2520%2520%2520%2520%2520%2520current_value%253A%2520airQualityData%255Bindicator%255D.value%252C%250A%2520%2520%2520%2520%2520%2520air_image%253A%2520%2560.%252Flegends%252F%2524%257Bindicator%257D-legend.png%2560%252C%250A%2520%2520%2520%2520%2520%2520cid%253A%2520%2560aid%2524%257Bi%257D%2560%252C%250A%2520%2520%2520%2520%257D)%253B%250A%2520%2520%257D)%253B%250A%250A%2520%2520return%2520outputArr%253B%250A%257D" rel="noopener ugc nofollow" target="_blank"> RAW </a></figcaption></figure><p id="7184" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">ClimaCell的另一个很酷的特性是，它可以在一个名为weather_code的属性中返回当前天气的<a class="ae kc" href="https://developer.climacell.co/v3/reference" rel="noopener ugc nofollow" target="_blank"> <em class="nt">状态</em> </a> <em class="nt"> </em>，同时它还为这些天气代码提供一些公共图像。</p><p id="ed3e" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">在同一个Github repo中，有一个名为<code class="fe ms mt mu mv b">summary-icons</code>的文件夹，其中包含所有可能值的相关<code class="fe ms mt mu mv b">.png</code>文件。</p><p id="91ec" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">要在我们的电子邮件中嵌入图像，我们需要将它们作为附件发送，并给它们一个唯一的id，<code class="fe ms mt mu mv b">cid</code>，我们将用它来绑定到一个<code class="fe ms mt mu mv b">img</code>标签。</p><p id="4c40" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">例如:</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/0cda8d2488551ec02cf79ebe9fd77824.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rxofSasc-w89RJpTtQR_ow.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://carbon.now.sh/?bg=rgba(171%2C%20184%2C%20195%2C%201)&amp;t=seti&amp;wt=none&amp;l=javascript&amp;ds=true&amp;dsyoff=20px&amp;dsblur=68px&amp;wc=true&amp;wa=true&amp;pv=56px&amp;ph=56px&amp;ln=false&amp;fl=1&amp;fm=Hack&amp;fs=14px&amp;lh=133%25&amp;si=false&amp;es=2x&amp;wm=false&amp;code=let%2520message%2520%253D%2520%257B%250A%2520%2520%2520%2520...%250A%2520%2520%2520%2520html%253A%2520%27Embedded%2520image%253A%2520%253Cimg%2520src%253D%2522cid%253Amyimage%2522%252F%253E%27%252C%250A%2520%2520%2520%2520attachments%253A%2520%255B%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520path%253A%2520%27%252Fpath%252Fto%252Ffile%27%252C%250A%2520%2520%2520%2520%2520%2520%2520%2520cid%253A%2520%27myimage%27%2520%252F%252Fsame%2520cid%2520value%2520as%2520in%2520the%2520html%2520img%2520src%250A%2520%2520%2520%2520%257D%255D%250A%257D" rel="noopener ugc nofollow" target="_blank">未加工的</a></figcaption></figure><p id="4df9" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这就是为什么我们使用属性<code class="fe ms mt mu mv b">weather_image</code>、<code class="fe ms mt mu mv b">air_image</code>和<code class="fe ms mt mu mv b">cid</code>。</p><p id="2032" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">对于空气质量，我们将使用ClimaCell提供的<code class="fe ms mt mu mv b">legends</code>来显示每个测量指标值的重要性。这些图例可以在同名文件夹中找到。</p><h1 id="0578" class="lh li iq bd kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">5.发送电子邮件</h1><p id="f1af" class="pw-post-body-paragraph ke kf iq kg b kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx mi kz la lb ij bi translated">此时，我们已经可以发送一些电子邮件来查看它们的外观。</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/6c899212e380fd6afe74c0254412ee04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8reWrW8ed4SEJ0qzPbHVhw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://carbon.now.sh/?bg=rgba(171%2C%20184%2C%20195%2C%201)&amp;t=seti&amp;wt=none&amp;l=javascript&amp;ds=true&amp;dsyoff=20px&amp;dsblur=68px&amp;wc=true&amp;wa=true&amp;pv=56px&amp;ph=56px&amp;ln=false&amp;fl=1&amp;fm=Hack&amp;fs=14px&amp;lh=133%25&amp;si=false&amp;es=2x&amp;wm=false&amp;code=%252F%252F%2520*%2520send%2520weather%2520forecast%2520email%250Aasync%2520function%2520sendWeatherForecastEmail(%250A%2520%2520weatherData%252C%250A%2520%2520airQualityData%252C%250A%2520%2520attachments%250A)%2520%257B%250A%2520%2520const%2520templateUtf8%2520%253D%2520fs.readFileSync(%2522.%252Fweather-forecast-template.pug%2522%252C%2520%257B%250A%2520%2520%2520%2520encoding%253A%2520%2522utf-8%2522%252C%250A%2520%2520%257D)%253B%250A%2520%2520const%2520template%2520%253D%2520pug.compile(templateUtf8)%253B%250A%250A%2520%2520const%2520replacements%2520%253D%2520%257B%250A%2520%2520%2520%2520weatherForecast%253A%2520weatherData%252C%250A%2520%2520%2520%2520airQuality%253A%2520airQualityData%252C%250A%2520%2520%2520%2520day%253A%2520new%2520Date().toLocaleDateString(%2522en-US%2522)%252C%250A%2520%2520%257D%253B%250A%2520%2520const%2520htmlToSend%2520%253D%2520template(replacements)%253B%250A%250A%2520%2520const%2520mailOptions%2520%253D%2520%257B%250A%2520%2520%2520%2520from%253A%2520%2560Weather%2520Forecast%2520%2524%257Buser%257D%2560%252C%250A%2520%2520%2520%2520to%253A%2520recipient%252C%250A%2520%2520%2520%2520subject%253A%2520%2522Weather%2520forecast%2520for%2520today%2520and%2520current%2520air%2520quality%2522%252C%250A%2520%2520%2520%2520html%253A%2520htmlToSend%252C%250A%2520%2520%2520%2520attachments%252C%250A%2520%2520%257D%253B%250A%250A%2520%2520await%2520transporter.sendMail(mailOptions)%253B%250A%257D%250A%250A%252F%252F%2520*%2520send%2520alert%2520forecast%2520email%250Aasync%2520function%2520sendAirQualityEmailAlert(airQualityData%252C%2520attachments)%2520%257B%250A%2520%2520const%2520templateUtf8%2520%253D%2520fs.readFileSync(%2522.%252Fair-quality-alert.pug%2522%252C%2520%257B%250A%2520%2520%2520%2520encoding%253A%2520%2522utf-8%2522%252C%250A%2520%2520%257D)%253B%250A%2520%2520const%2520template%2520%253D%2520pug.compile(templateUtf8)%253B%250A%250A%2520%2520const%2520replacements%2520%253D%2520%257B%250A%2520%2520%2520%2520airQuality%253A%2520airQualityData%252C%250A%2520%2520%257D%253B%250A%2520%2520const%2520htmlToSend%2520%253D%2520template(replacements)%253B%250A%250A%2520%2520const%2520mailOptions%2520%253D%2520%257B%250A%2520%2520%2520%2520from%253A%2520%2560Air%2520Quality%2520Alert%2520%2524%257Buser%257D%2560%252C%250A%2520%2520%2520%2520to%253A%2520recipient%252C%250A%2520%2520%2520%2520subject%253A%2520%2522An%2520air%2520quality%2520limit%2520has%2520been%2520exceeded%2522%252C%250A%2520%2520%2520%2520html%253A%2520htmlToSend%252C%250A%2520%2520%2520%2520attachments%252C%250A%2520%2520%257D%253B%250A%250A%2520%2520await%2520transporter.sendMail(mailOptions)%253B%250A%257D" rel="noopener ugc nofollow" target="_blank"> RAW </a></figcaption></figure><p id="93ec" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">我们来分解一下。工作流程很简单:</p><p id="d9dc" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><em class="nt">将模板作为简单的字符串读取→使用相应的模板引擎编译这些模板的内容。pug →在这个模板中插入所需的变量→输出将是一个HTML代码，我们可以使用nodemailer发送它→发送电子邮件</em></p><ul class=""><li id="daa5" class="mj mk iq kg b kh ki kl km kp mw kt mx kx my lb mz mp mq mr bi translated"><code class="fe ms mt mu mv b">recipent</code>和<code class="fe ms mt mu mv b">user</code>变量来自<code class="fe ms mt mu mv b">config.json</code></li></ul><h1 id="5611" class="lh li iq bd kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">6.创造天气预报和空气质量工作</h1><p id="af68" class="pw-post-body-paragraph ke kf iq kg b kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx mi kz la lb ij bi translated">从这一点来说，我们已经有了所有必要的部分，我们所要做的就是把它们放在一起。在这个函数中，我们将为第一封邮件的完整逻辑编写代码，这封邮件带有天气预报和当前时刻的空气质量(发送邮件的那封)。</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/e1da5ff4cc2e7376d31f6db39318910a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-ra5YDK0wiP4bX4THqiMOA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://carbon.now.sh/" rel="noopener ugc nofollow" target="_blank">生</a></figcaption></figure><p id="bb5e" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">在这个函数中，我们只是简单地调用我们之前定义的函数，然后做一些简单的构造，就像这样。</p><p id="c249" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">天气预报是未来<strong class="kg ir"> 96小时，</strong>的天气预报，但我们只想查看今天的天气数据，而且只查看一些预定义小时的天气数据。为了实现这一点，我们可以简单地从我们收到的所有天气数据中删除不是当天的数据，也不是预定义小时的数据。</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nx"><img src="../Images/b255c7c7bdd4c1cb3094cbbea0465c33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HyvwRSaLBgGxBVKsPOwNCg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://carbon.now.sh/?bg=rgba(171%2C%20184%2C%20195%2C%201)&amp;t=seti&amp;wt=none&amp;l=javascript&amp;ds=true&amp;dsyoff=20px&amp;dsblur=68px&amp;wc=true&amp;wa=true&amp;pv=56px&amp;ph=56px&amp;ln=false&amp;fl=1&amp;fm=Hack&amp;fs=14px&amp;lh=133%25&amp;si=false&amp;es=2x&amp;wm=false&amp;code=const%2520desiredHours%2520%253D%2520%255B8%252C%252010%252C%252012%252C%252014%252C%252016%252C%252018%252C%252020%252C%252022%255D%253B%250Aconst%2520desiredWeatherData%2520%253D%2520weatherData.filter(%250A%2520%2520(e)%2520%253D%253E%250A%2520%2520%2520%2520desiredHours.includes(new%2520Date(e.observation_time.value).getHours())%2520%2526%2526%250A%2520%2520%2520%2520new%2520Date(e.observation_time.value).getDay()%2520%253D%253D%2520new%2520Date().getDay()%250A)%253B" rel="noopener ugc nofollow" target="_blank">原始</a></figcaption></figure><p id="4564" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">14、16、18、20、22小时代表下午2点、4点、6点、8点和10点。</p><p id="cf6d" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">如果您还记得，早些时候我们格式化了天气和空气质量数据以匹配模板，但是我们为它们中的每一个写了一个额外的属性，<code class="fe ms mt mu mv b">weather_image</code>和<code class="fe ms mt mu mv b">air_image</code>。</p><p id="3193" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">我们现在将使用这些属性来创建附件数组。在这个数组中，我们将放置图像路径及其id。</p><p id="508a" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">对于空气质量工作，逻辑是相同的。</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/4410fef0d7afc270e50b8cc945bf3e7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dwaRDaXfBSgEH1zQZztULQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://carbon.now.sh/" rel="noopener ugc nofollow" target="_blank">未加工的</a></figcaption></figure><p id="a885" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">此功能<code class="fe ms mt mu mv b">airQualityJob()</code>的目的是检查空气质量是否下降到某个阈值以下，并发送电子邮件警报。</p><p id="d94f" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这封电子邮件看起来与第一封相似，只是我们只在其中包含了高于预定义阈值的指标。</p><h1 id="947d" class="lh li iq bd kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">7.总结和主要逻辑</h1><p id="eee5" class="pw-post-body-paragraph ke kf iq kg b kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx mi kz la lb ij bi translated">最后一步是编写我们脚本的主函数，它将调用函数<code class="fe ms mt mu mv b">weatherForecastJob()</code>和<code class="fe ms mt mu mv b">airQualityJob()</code>。</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/10a72b9029bbf7d5c99a43af1ab17e8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kjSi19vvquz3y-ETiYO00w.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://carbon.now.sh/?bg=rgba(171%2C%20184%2C%20195%2C%201)&amp;t=seti&amp;wt=none&amp;l=javascript&amp;ds=true&amp;dsyoff=20px&amp;dsblur=68px&amp;wc=true&amp;wa=true&amp;pv=56px&amp;ph=56px&amp;ln=false&amp;fl=1&amp;fm=Hack&amp;fs=14px&amp;lh=133%25&amp;si=false&amp;es=2x&amp;wm=false&amp;code=(async%2520function%2520main()%2520%257B%250A%2520%2520try%2520%257B%250A%2520%2520%2520%2520await%2520transporter.verify()%253B%250A%2520%2520%2520%2520console.log(%2522Server%2520is%2520ready%2520to%2520take%2520our%2520messages%2522)%253B%250A%250A%2520%2520%2520%2520%252F%252F%2520*%2520weather%2520forecast%2520job%250A%2520%2520%2520%2520const%2520oneDayInMs%2520%253D%25208.64e7%253B%250A%2520%2520%2520%2520const%2520startHMS%2520%253D%2520%255B8%252C%25200%252C%25200%255D%253B%250A%2520%2520%2520%2520let%2520startDate%2520%253D%2520new%2520Date().setHours(...startHMS)%253B%250A%250A%2520%2520%2520%2520if%2520(Date.now()%2520%253E%2520startDate)%2520%257B%250A%2520%2520%2520%2520%2520%2520const%2520tommorowDate%2520%253D%2520new%2520Date().getDate()%2520%252B%25201%253B%250A%2520%2520%2520%2520%2520%2520startDate%2520%253D%2520new%2520Date(new%2520Date().setDate(tommorowDate)).setHours(%250A%2520%2520%2520%2520%2520%2520%2520%2520...startHMS%250A%2520%2520%2520%2520%2520%2520)%253B%250A%2520%2520%2520%2520%257D%250A%250A%2520%2520%2520%2520const%2520timeLeft%2520%253D%2520startDate%2520-%2520Date.now()%253B%250A%2520%2520%2520%250A%250A%2520%2520%2520%2520setTimeout(async%2520()%2520%253D%253E%2520%257B%250A%2520%2520%2520%2520%2520%2520await%2520weatherForecastJob()%253B%250A%250A%2520%2520%2520%2520%2520%2520setInterval(async%2520()%2520%253D%253E%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520await%2520weatherForecastJob()%253B%250A%2520%2520%2520%2520%2520%2520%250A%2520%2520%2520%2520%2520%2520%257D%252C%2520oneDayInMs)%253B%250A%2520%2520%2520%2520%2520%2520%250A%2520%2520%2520%2520%257D%252C%2520timeLeft)%253B%250A%250A%2520%2520%2520%2520%252F%252F%2520*%2520alert%2520job%250A%2520%2520%2520%2520await%2520airQualityAlertJob()%253B%250A%2520%2520%2520%2520%250A%2520%2520%2520%2520setInterval(async%2520()%2520%253D%253E%2520%257B%250A%2520%2520%2520%2520%2520%2520await%2520airQualityAlertJob()%253B%250A%2520%2520%2520%2520%2520%2520%250A%2520%2520%2520%2520%257D%252C%25202%2520*%252060%2520*%25201000)%253B%250A%2520%2520%257D%2520catch%2520(err)%2520%257B%250A%2520%2520%2520%2520console.log(err)%253B%250A%2520%2520%257D%250A%257D)()%253B" rel="noopener ugc nofollow" target="_blank">生</a></figcaption></figure><p id="a932" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这个函数可能很复杂，所以让我们一步一步来。</p><ol class=""><li id="8313" class="mj mk iq kg b kh ki kl km kp mw kt mx kx my lb mo mp mq mr bi translated">首先，我们检查与电子邮件服务器的连接</li></ol><p id="c6aa" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><code class="fe ms mt mu mv b">await transporter.verify();</code></p><p id="6325" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">2.我们定义了3个变量:</p><pre class="ld le lf lg gt nf mv ng nh aw ni bi"><span id="2610" class="nj li iq mv b gy nk nl l nm nn">const oneDayInMs = 8.64e7;<br/>const startHMS = [8, 0, 0];<br/>let startDate = new Date().setHours(...startHMS);</span></pre><ul class=""><li id="00eb" class="mj mk iq kg b kh ki kl km kp mw kt mx kx my lb mz mp mq mr bi translated"><code class="fe ms mt mu mv b">oneDayInMs</code> —天气预报每天只发送一次，因此该变量用于计算我们必须等待多少毫秒才能发送下一封电子邮件；</li><li id="3cda" class="mj mk iq kg b kh na kl nb kp nc kt nd kx ne lb mz mp mq mr bi translated"><code class="fe ms mt mu mv b">startHMS</code> —我们要发送天气预报的时分秒对</li><li id="eab8" class="mj mk iq kg b kh na kl nb kp nc kt nd kx ne lb mz mp mq mr bi translated"><code class="fe ms mt mu mv b">startDate</code> —以毫秒为单位的值，表示当天上午08:00:00时的值</li></ul><p id="3cb5" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">当我们第一次启动我们的应用程序时，一个棘手的部分发生了。让我解释一下。</p><p id="c7fa" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">例如，我们有两种情况。</p><p id="11b3" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">如果我们在晚上9:00开始应用程序，那么我们错过了早上8:00的第一个目标，一天就要结束了，所以我们不想在这个时候发送天气预报。这就是为什么我们需要计算我们必须等待多长时间，以毫秒为单位，直到第二天早上8:00，这样我们才能发送天气预报。</p><p id="01bc" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">因此，所需的值将是明天上午08:00点的<strong class="kg ir">减去我们开始应用程序的当前时间T10。</strong></p><p id="9338" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">另一种情况是，如果我们在<code class="fe ms mt mu mv b">startDate</code>之前启动应用程序，例如在早上7:50。我们会比目标早10分钟到达。因此，期望值将是<code class="fe ms mt mu mv b">startDate</code>减去<strong class="kg ir">我们启动应用程序</strong>的当前时间。</p><p id="bf0f" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">要在一个简单的if语句中组合这些场景，我们可以编写以下代码:</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/8621d12a57c76ac6279412c25e6698d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zo4EDSWDW7K3QbmujCAXcQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://carbon.now.sh/?bg=rgba(171%2C%20184%2C%20195%2C%201)&amp;t=seti&amp;wt=none&amp;l=javascript&amp;ds=true&amp;dsyoff=20px&amp;dsblur=68px&amp;wc=true&amp;wa=true&amp;pv=56px&amp;ph=56px&amp;ln=false&amp;fl=1&amp;fm=Hack&amp;fs=14px&amp;lh=133%25&amp;si=false&amp;es=2x&amp;wm=false&amp;code=if%2520(Date.now()%2520%253E%2520startDate)%2520%257B%250A%2520%2520const%2520tommorowDate%2520%253D%2520new%2520Date().getDate()%2520%252B%25201%253B%250A%2520%2520startDate%2520%253D%2520new%2520Date(new%2520Date().setDate(tommorowDate)).setHours(%250A%2520%2520%2520%2520...startHMS%250A%2520%2520)%253B%250A%257D%250A%250Aconst%2520timeLeft%2520%253D%2520startDate%2520-%2520Date.now()%253B" rel="noopener ugc nofollow" target="_blank">未加工的</a></figcaption></figure><p id="c91c" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">而<code class="fe ms mt mu mv b">timeLeft</code>代表程序为了发送天气预报而必须等待的绝对值</p><p id="2d69" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">在这段时间过后，我们可以发送我们的第一个天气预报，然后我们可以创建一个每天在同一时间运行的计时器。</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/89f58e56ff2f1608d88497c1fcf543a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H7k9yyIq6pNIQblNiDTbDg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://carbon.now.sh/?bg=rgba(171%2C%20184%2C%20195%2C%201)&amp;t=seti&amp;wt=none&amp;l=javascript&amp;ds=true&amp;dsyoff=20px&amp;dsblur=68px&amp;wc=true&amp;wa=true&amp;pv=56px&amp;ph=56px&amp;ln=false&amp;fl=1&amp;fm=Hack&amp;fs=14px&amp;lh=133%25&amp;si=false&amp;es=2x&amp;wm=false&amp;code=setTimeout(async%2520()%2520%253D%253E%2520%257B%250A%2520%2520await%2520weatherForecastJob()%253B%250A%250A%2520%2520setInterval(async%2520()%2520%253D%253E%2520%257B%250A%2520%2520%2520%2520await%2520weatherForecastJob()%253B%250A%2520%2520%2520%2520%250A%2520%2520%257D%252C%2520oneDayInMs)%253B%250A%257D%252C%2520timeLeft)%253B" rel="noopener ugc nofollow" target="_blank">生</a></figcaption></figure><p id="92e4" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">对于<code class="fe ms mt mu mv b">airQualityAlertJob()</code>，我们可以在应用启动时运行一次，每两分钟检查一次空气质量。</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/05c9f6d34aae74522e9174bb401c7bb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XKStDxzCixEO7RCiHCA5NQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://carbon.now.sh/?bg=rgba(171%2C%20184%2C%20195%2C%201)&amp;t=seti&amp;wt=none&amp;l=javascript&amp;ds=true&amp;dsyoff=20px&amp;dsblur=68px&amp;wc=true&amp;wa=true&amp;pv=56px&amp;ph=56px&amp;ln=false&amp;fl=1&amp;fm=Hack&amp;fs=14px&amp;lh=133%25&amp;si=false&amp;es=2x&amp;wm=false&amp;code=await%2520airQualityAlertJob()%253B%250A%250AsetInterval(async%2520()%2520%253D%253E%2520%257B%250A%2520%2520%2520%2520%2520%2520await%2520airQualityAlertJob()%253B%250A%250A%257D%252C%25202%2520*%252060%2520*%25201000)%253B" rel="noopener ugc nofollow" target="_blank">生</a></figcaption></figure><p id="9fd6" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">ClimaCell的免费计划每小时有100个请求的限制，但我认为每两分钟检查一次空气质量的下降对我们来说是好的。有了这个计划，如果你愿意，你仍然可以把这个时间减少一半到一分钟。</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/8e27b08597d2a6682e3644c16622549c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GgFFeNPbPgWmd8HOOsvW2Q.png"/></div></div></figure><h1 id="8a0c" class="lh li iq bd kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">结论</h1><p id="836c" class="pw-post-body-paragraph ke kf iq kg b kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx mi kz la lb ij bi translated">您可以扩展这个示例并收集更多数据。根据你的需要，你可以检查花粉值。</p><p id="7fdd" class="pw-post-body-paragraph ke kf iq kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">如果您想要托管您的应用程序，那么您可以使用一些外部SasS或PasS，它们附带一个免费计划，并且易于设置。一些例子包括<a class="ae kc" href="https://www.heroku.com/" rel="noopener ugc nofollow" target="_blank"> Heroku </a>、<a class="ae kc" href="https://pages.github.com/" rel="noopener ugc nofollow" target="_blank"> GitHub页面</a>和<a class="ae kc" href="https://www.netlify.com/" rel="noopener ugc nofollow" target="_blank"> Netlify </a>。</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/2fdc2abd8ede14b0f109fa36b9766997.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/1*EnuFXGSDRh99MW_EznDSiQ.gif"/></div></figure></div></div>    
</body>
</html>