<html>
<head>
<title>Overcoming Sequelize Hiccups</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">克服连续打嗝</h1>
<blockquote>原文：<a href="https://itnext.io/overcoming-sequelize-hiccups-24e916ebb4c4?source=collection_archive---------1-----------------------#2018-07-19">https://itnext.io/overcoming-sequelize-hiccups-24e916ebb4c4?source=collection_archive---------1-----------------------#2018-07-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/9b538b2180eafec4db67bb849995ee7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_SmZzhgGpZ5tHeUM8toUWQ.jpeg"/></div></div></figure><p id="74f6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Sequelize可能是可供开发者使用的最好的NodeJS ORM库之一。然而，就像任何工具或框架一样，当我们第一次开始使用Sequelize时，会遇到一些问题。<a class="ae kw" href="http://docs.sequelizejs.com/" rel="noopener ugc nofollow" target="_blank">他们的文档</a>非常详尽，列出了他们提供的所有功能，在这篇文章中，我们将看到一种非常连贯的方式来建立一个带有Sequelize的项目，以及我们如何根据我们不断发展的应用程序对我们的模型进行更改。</p><h1 id="b1f3" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">项目设置</h1><p id="a0b3" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">在大多数应用程序中，您将创建(或使用预先存在的)API应用程序，该应用程序是使用基于NodeJS的框架(如ExpressJS或NextJS)构建的。</p><p id="f85a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我们的例子中，我们将只关注Sequelize，而不依赖于NodeJS框架。为此，让我们首先创建一个空白的NodeJS项目。为此，创建一个您的项目文件夹<code class="fe ma mb mc md b">sequelize-setup</code>，然后在该文件夹的根目录下运行以下命令。回答关于项目描述的提示问题。</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="abd6" class="mm ky iq md b gy mn mo l mp mq">npm init</span></pre><p id="8933" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦您回答了所有的问题，您将会看到在根目录下生成的基本的<code class="fe ma mb mc md b">package.json</code>文件</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mr"><img src="../Images/d3749ff5a2234935bbf8af9fa756fe8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p_-fDzeyRgrg8Qzg34csVg.png"/></div></div></figure><p id="306a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，为了能够在我们的项目中使用Sequelize，我们需要为我们选择的数据库安装Sequelize和相应的数据库客户机。我们需要数据库客户端，因为Sequelize只是一个<em class="ms">库</em>，它实现了ORM技术，以面向对象的方式操作和查询数据，并且不包含与底层数据库交互的附加层。</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="7369" class="mm ky iq md b gy mn mo l mp mq">npm i -S sequelize pg</span></pre><p id="9bf7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本例中，我们将使用Postgres，其安装说明可从<a class="ae kw" href="https://www.postgresql.org/docs/9.3/static/install-procedure.html" rel="noopener ugc nofollow" target="_blank">这里</a>获得，然而，安装服务最简单的方法是使用<a class="ae kw" href="https://brew.sh/" rel="noopener ugc nofollow" target="_blank">自制软件</a>。所以安装Homebrew，然后运行下面的命令来设置你的Postgres。</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="3ee9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们刚刚在Postgres数据库中设置的<code class="fe ma mb mc md b">role</code>是用户名和密码，它可以在将来使用超级用户权限连接到任何数据库。</p><p id="b2ce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还将使用Postico为数据库提供GUI，因此请在这里下载它<a class="ae kw" href="https://eggerapps.at/postico/" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="8aec" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">初始化序列</h1><p id="de51" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">为了能够建立一个基于序列的项目并成功运行它，我们需要以下内容:</p><ol class=""><li id="55be" class="mv mw iq ka b kb kc kf kg kj mx kn my kr mz kv na nb nc nd bi translated">配置—运行序列所需的配置</li><li id="c57d" class="mv mw iq ka b kb ne kf nf kj ng kn nh kr ni kv na nb nc nd bi translated">迁移—包含我们对表所做的任何和所有更改的文件</li><li id="fc60" class="mv mw iq ka b kb ne kf nf kj ng kn nh kr ni kv na nb nc nd bi translated">模型——我们的表的结构及其属性</li><li id="3082" class="mv mw iq ka b kb ne kf nf kj ng kn nh kr ni kv na nb nc nd bi translated">seeders——用默认数据初始化我们的表</li></ol><p id="fbd7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要准备好必要的文件，我们可以手动创建这些文件夹，或者更好的方法是简单地使用Sequelize CLI来完成。</p><p id="ac53" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要安装cli，请运行以下命令:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="2cb6" class="mm ky iq md b gy mn mo l mp mq">npm install --save sequelize-cli</span></pre><p id="ce5d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们现在可以使用位于<code class="fe ma mb mc md b">node_modules/.bin/sequelize</code>的cli。为了简单起见，我将省略<code class="fe ma mb mc md b">node_modules/.bin/</code>前缀，只使用<code class="fe ma mb mc md b">sequelize</code>关键字来处理所有命令。</p><p id="fea2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要使用CLI初始化项目，请在项目根目录下的终端上运行以下命令:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="b6af" class="mm ky iq md b gy mn mo l mp mq">sequelize init</span></pre><p id="9807" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它记录了以下内容:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="2d02" class="mm ky iq md b gy mn mo l mp mq">Sequelize CLI [Node: 8.10.0, CLI: 4.0.0, ORM: 4.38.0]</span><span id="971a" class="mm ky iq md b gy nj mo l mp mq">Created “config/config.json”</span><span id="386e" class="mm ky iq md b gy nj mo l mp mq">Successfully created models folder at “/sequelize-setup/models”.</span><span id="faf0" class="mm ky iq md b gy nj mo l mp mq">Successfully created migrations folder at “/sequelize-setup/migrations”.</span><span id="7bdf" class="mm ky iq md b gy nj mo l mp mq">Successfully created seeders folder at “/sequelize-setup/seeders”.</span></pre><p id="5204" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它实际上是我们的config + empty文件夹，包含模型、迁移和种子。</p><h1 id="9578" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">配置</h1><p id="0643" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">正如所料，config文件夹包含一个名为<code class="fe ma mb mc md b">config.json</code>的文件，该文件具有生成的默认对象，因为我们只担心<code class="fe ma mb mc md b">development</code>流，所以从<code class="fe ma mb mc md b">config.json</code>对象中删除<code class="fe ma mb mc md b">test</code>和<code class="fe ma mb mc md b">production</code>条目，这样我们就有了以下内容:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="137f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从上面可以看到，我们将<code class="fe ma mb mc md b">dialect</code>指定为<code class="fe ma mb mc md b">postgres</code>，用户名和密码与项目设置中配置的相同。因为我们在本地运行数据库，所以<code class="fe ma mb mc md b">host</code> IP是localhost (127.0.0.1)。</p><p id="7442" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个<code class="fe ma mb mc md b">config</code>现在可以用来执行任何和所有后续与postgres的交互。</p><h2 id="3d61" class="mm ky iq bd kz nk nl dn ld nm nn dp lh kj no np ll kn nq nr lp kr ns nt lt nu bi translated">正在创建数据库</h2><p id="e33d" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">拥有配置的用例之一是创建必要的数据库。现在我们已经启动并运行了postgres服务，我们需要首先创建一个数据库，这个数据库可以保存我们的表。在我们的配置中，这个数据库用关键字<code class="fe ma mb mc md b">database</code>表示。要使用Sequelize创建数据库，我们只需运行以下命令:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="f9fa" class="mm ky iq md b gy mn mo l mp mq">sequelize db:create</span></pre><p id="b2c7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这将记录以下内容:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="1cfc" class="mm ky iq md b gy mn mo l mp mq">Sequelize CLI [Node: 8.10.0, CLI: 4.0.0, ORM: 4.38.0]</span><span id="fdf5" class="mm ky iq md b gy nj mo l mp mq">Loaded configuration file “config/config.json”.</span><span id="c445" class="mm ky iq md b gy nj mo l mp mq">Using environment “development”.</span><span id="ef07" class="mm ky iq md b gy nj mo l mp mq">Database database_development created.</span></pre><p id="491f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，为了验证创建，我们将使用之前下载的Postico。打开Postico并点击<code class="fe ma mb mc md b">New Favorite</code>，这将打开面板以配置数据库连接，输入我们刚刚创建的数据库名称以及连接到该数据库所需的用户名和密码。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/84bdcb3dd4e28defc1b2368ca8a03cde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ji5uiRrgvu5S7aMmOhCTCg.png"/></div></div></figure><p id="1516" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">点击<code class="fe ma mb mc md b">connect</code>按钮，您将进入该数据库的表格视图，该视图目前应该是空的。</p><h1 id="36f4" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">模型</h1><p id="d7b4" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们现在准备创建我们的第一个模型，即一个实体，我们将映射到一个表。如果您使用Sequelize CLI，创建模型也是一项非常简单的任务。我们将创建一个非常简单和通用的实体，比如属性为<code class="fe ma mb mc md b">firstName</code>和<code class="fe ma mb mc md b">lastName</code>的<code class="fe ma mb mc md b">User</code>。要生成<code class="fe ma mb mc md b">User</code>，只需运行以下命令:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="df79" class="mm ky iq md b gy mn mo l mp mq">sequelize model:generate --name User --attributes firstName:string,lastName:string</span></pre><p id="c84a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您会看到以下结果:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="4335" class="mm ky iq md b gy mn mo l mp mq">Sequelize CLI [Node: 8.10.0, CLI: 4.0.0, ORM: 4.38.0]</span><span id="634f" class="mm ky iq md b gy nj mo l mp mq">New model was created at /sequelize-setup/models/user.js .</span><span id="072c" class="mm ky iq md b gy nj mo l mp mq">New migration was created at /sequelize-setup/migrations/20180719190326-User.js .</span></pre><p id="f3e7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">既然我们的第一个模型和迁移已经创建，让我们快速地看一下生成的文件包含什么。</p><p id="490b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在models文件夹下生成的用户模型包含我们定义的属性的<code class="fe ma mb mc md b">User</code>的定义，它包含一个名为<code class="fe ma mb mc md b">associate</code>的占位符，我们可以在其中定义任何未来的关联。</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="b8ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以及在迁移文件夹下创建的迁移:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="da82" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以看到，这个文件包含了一些超出我们预期的额外字段，这是因为第一次创建模型时，其相应的迁移是将模型创建为一个表。因此，当我们为<code class="fe ma mb mc md b">User</code>创建模型时，Sequelize会自动建议我们使用所请求的属性(名字和姓氏)和附加属性(如<code class="fe ma mb mc md b">id</code>、<code class="fe ma mb mc md b">createdAt</code>和<code class="fe ma mb mc md b">updatedAt</code>)来创建表<code class="fe ma mb mc md b">Users</code>。</p><p id="8e20" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有趣的是，迁移由两部分组成:<code class="fe ma mb mc md b">up</code>和<code class="fe ma mb mc md b">down</code>。通过更仔细的观察，我们了解到<code class="fe ma mb mc md b">up</code>返回我们希望在应用迁移时执行的承诺，而<code class="fe ma mb mc md b">down</code>包含我们希望在撤消时执行的迁移。所以我们在<code class="fe ma mb mc md b">up</code>和<code class="fe ma mb mc md b">down</code>函数中指定了相反的东西。</p><p id="e0fa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">迁移文件名在开头包含时间戳也是有原因的。使用Sequelize CLI，我们可以生成许多迁移文件，并可以根据需要应用或撤消它们。稍后将详细介绍。</p><h2 id="903d" class="mm ky iq bd kz nk nl dn ld nm nn dp lh kj no np ll kn nq nr lp kr ns nt lt nu bi translated">应用迁移</h2><p id="faaa" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们已经有了<code class="fe ma mb mc md b">User</code>模型和它的初始迁移。要运行此迁移并创建表，只需运行以下命令:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="a7bc" class="mm ky iq md b gy mn mo l mp mq">sequelize db:migrate</span></pre><p id="ed00" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它记录了以下内容:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="b1e0" class="mm ky iq md b gy mn mo l mp mq">Sequelize CLI [Node: 8.10.0, CLI: 4.0.0, ORM: 4.38.0]</span><span id="84cb" class="mm ky iq md b gy nj mo l mp mq">Loaded configuration file “config/config.json”.</span><span id="3cdc" class="mm ky iq md b gy nj mo l mp mq">Using environment “development”.</span><span id="c478" class="mm ky iq md b gy nj mo l mp mq">== 20180719190326-create-user: migrating =======</span><span id="d4e3" class="mm ky iq md b gy nj mo l mp mq">== 20180719190326-create-user: migrated (0.054s)</span></pre><p id="8d5e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">切换到Postico以验证更改:</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/f182d72df152c81708a58a588894acf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LuWOOmAOs_m2seXZjWY7jw.png"/></div></div></figure><p id="61c0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以看到，到目前为止，它包含2个内容，如预期的<code class="fe ma mb mc md b">Users</code>表和包含所有已应用于该数据库的迁移列表的<code class="fe ma mb mc md b">SequelizeMeta</code>表。</p><h1 id="0763" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">播种者</h1><p id="58be" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们的数据库已经设置好了，我们的用户模型和表也已经设置好了，下一个合乎逻辑的步骤是向这个表添加一些数据，让我们开始吧。我们将再次使用Sequelize CLI来生成必要的种子:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="5eaa" class="mm ky iq md b gy mn mo l mp mq">sequelize seed:generate --name create-users</span></pre><p id="2b02" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们只是运行一个命令来生成一个记录以下内容的种子:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="5350" class="mm ky iq md b gy mn mo l mp mq">Sequelize CLI [Node: 8.10.0, CLI: 4.0.0, ORM: 4.38.0]</span><span id="0709" class="mm ky iq md b gy nj mo l mp mq">seeders folder at “.../sequelize-setup/seeders” already exists.</span><span id="0522" class="mm ky iq md b gy nj mo l mp mq">New seed was created at .../sequelize-setup/seeders/20180719192307-create-users.js .</span></pre><p id="cda4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">原始格式的文件除了具有与迁移文件相同的结构(即具有一个<code class="fe ma mb mc md b">up</code>和一个<code class="fe ma mb mc md b">down</code>函数)之外，不包含太多内容:</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nx"><img src="../Images/eb07cedd604cac5181c527da9d3cf201.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P_YzppnWkShILDpgD7IvtA.png"/></div></div></figure><p id="9ba7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是与初始迁移不同，seeder没有填充我们希望它拥有的实际功能，相反，它包含了我们可能能够做什么的模糊示例，在本例中是<code class="fe ma mb mc md b">bulkInsert</code>和<code class="fe ma mb mc md b">bulkDelete</code>。</p><h2 id="5050" class="mm ky iq bd kz nk nl dn ld nm nn dp lh kj no np ll kn nq nr lp kr ns nt lt nu bi translated">运转播种机</h2><p id="153e" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们现在可以在种子文件中创建必要的逻辑，将我们选择的数据添加到<code class="fe ma mb mc md b">Users</code>表中</p><p id="fafd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了运行播种机，我们可以再次使用Sequelize CLI。有了seeder，我们可以获得更精细的控制，如果需要，我们可以运行特定的seeder文件；如果需要，我们也可以运行它们<em class="ms"> all </em>。在我们当前的场景中，我们将运行所有。</p><blockquote class="ny nz oa"><p id="e75a" class="jy jz ms ka b kb kc kd ke kf kg kh ki ob kk kl km oc ko kp kq od ks kt ku kv ij bi translated">我们需要记住的一个小问题是，seeder将针对迁移中指定的结构运行，而不是模型中指定的结构，也就是说，不要排除您想要在数据库表中显示的任何字段。如果你跳过了一个设置为非空约束的字段，将会抛出一个错误。</p></blockquote><p id="235d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">记住上面的内容，我们可以为用户表创建如下种子:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="2354" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以用下面的命令来运行它:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="8e80" class="mm ky iq md b gy mn mo l mp mq">sequelize db:seed:all</span></pre><p id="fb6e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成时输出成功消息:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="e86d" class="mm ky iq md b gy mn mo l mp mq">Sequelize CLI [Node: 8.10.0, CLI: 4.0.0, ORM: 4.38.0]</span><span id="b234" class="mm ky iq md b gy nj mo l mp mq">Loaded configuration file “config/config.json”.</span><span id="b524" class="mm ky iq md b gy nj mo l mp mq">Using environment “development”.</span><span id="3a85" class="mm ky iq md b gy nj mo l mp mq">== 20180719192307-create-users: migrating =======</span><span id="521c" class="mm ky iq md b gy nj mo l mp mq">== 20180719192307-create-users: migrated (0.009s)</span></pre><p id="7042" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以在<code class="fe ma mb mc md b">Users</code>表中使用Postico进行验证:</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oe"><img src="../Images/d471b94e12e8590cfa8b959c486af7bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z92qnuX67SLMfxJXkhmNUA.png"/></div></div></figure><h1 id="3ec1" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">变更和修改</h1><p id="50e2" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">很多时候，尤其是在应用程序开发的早期阶段，实体的结构还没有确定下来，在一些场景中我们需要引入一些变化。例如，在这种情况下，我们在<code class="fe ma mb mc md b">Users</code>表中只有<code class="fe ma mb mc md b">firstName</code>和<code class="fe ma mb mc md b">lastName</code>字段。让我们改变这一点。</p><p id="5983" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将添加一个名为<code class="fe ma mb mc md b">age</code>和<code class="fe ma mb mc md b">email</code>的新列。为此，首先让我们使用Sequelize CLI创建一个新的迁移文件:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="5a45" class="mm ky iq md b gy mn mo l mp mq">sequelize migration:generate --name user-updates</span></pre><p id="7c8e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这将记录新生成的文件路径:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="ff2d" class="mm ky iq md b gy mn mo l mp mq">Sequelize CLI [Node: 8.10.0, CLI: 4.0.0, ORM: 4.38.0]</span><span id="2dd5" class="mm ky iq md b gy nj mo l mp mq">migrations folder at “.../sequelize-setup/migrations” already exists.</span><span id="29fc" class="mm ky iq md b gy nj mo l mp mq">New migration was created at .../sequelize-setup/migrations/20180719202036-user-updates.js .</span></pre><p id="b1b8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这个文件中，我们现在将添加我们需要在<code class="fe ma mb mc md b">up</code>和<code class="fe ma mb mc md b">down</code>阶段做出的更改:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="151b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们只是添加/删除列，并将其作为迁移中的一个承诺返回(注意承诺链)。当我们运行此迁移时:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="9e92" class="mm ky iq md b gy mn mo l mp mq">sequelize db:migrate</span></pre><p id="8078" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们看到了预期的结果:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="8791" class="mm ky iq md b gy mn mo l mp mq">Sequelize CLI [Node: 8.10.0, CLI: 4.0.0, ORM: 4.38.0]</span><span id="7679" class="mm ky iq md b gy nj mo l mp mq">Loaded configuration file “config/config.json”.</span><span id="4ed7" class="mm ky iq md b gy nj mo l mp mq">Using environment “development”.</span><span id="4dce" class="mm ky iq md b gy nj mo l mp mq">== 20180719204635-user-updates: migrating =======</span><span id="24e3" class="mm ky iq md b gy nj mo l mp mq">== 20180719204635-user-updates: migrated (0.018s)</span></pre><p id="01c1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们也可以在Postico中验证这一点:</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi of"><img src="../Images/903ba1e0946ab53b21c57bfc77c4c129.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G0uLEoNpVyJszJEIwMDw4g.png"/></div></div></figure><p id="c6ce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尽管我们已经指定了一些规则(验证)，但是它们并没有真正出现在数据库中(很明显)，因为sequelize在我们试图访问模型进行读取或更新时应用了这些规则。我们将在另一篇文章中对此进行探讨。</p><h1 id="eeb1" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">更新模型</h1><p id="c39c" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">尽管我们已经创建并运行了迁移，但是如果我们更新种子并运行它，我们将会看到预期的数据。让我们使用CLI创建一个新的种子文件:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="5934" class="mm ky iq md b gy mn mo l mp mq">sequelize seed:generate --name add-email-age</span></pre><p id="15c6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如下记录输出，注意这里的文件名:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="31f0" class="mm ky iq md b gy mn mo l mp mq">Sequelize CLI [Node: 8.10.0, CLI: 4.0.0, ORM: 4.38.0]</span><span id="1247" class="mm ky iq md b gy nj mo l mp mq">seeders folder at “.../sequelize-setup/seeders” already exists.</span><span id="2d31" class="mm ky iq md b gy nj mo l mp mq">New seed was created at .../sequelize-setup/seeders/20180719210102-add-email-age.js .</span></pre><p id="3b90" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们将新的字段添加到这个种子中，它看起来与现有的种子文件非常相似，只是稍有更新:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="fd72" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在要运行它，我们将只选择这个文件并运行它，因为我们已经添加了来自上一个种子文件的数据:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="bfd5" class="mm ky iq md b gy mn mo l mp mq">sequelize db:seed --seed 20180719210102-add-email-age</span></pre><p id="2477" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这允许我们只运行一个文件，输出可以在Postico:</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi og"><img src="../Images/1be65989493d2db99bf6e714e9cc1763.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DhQWsymt7Bp8kqFHO6pLxA.png"/></div></div></figure><p id="8de2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">既然我们已经获得了预期的数据，现在让我们添加一个小脚本来尝试查询数据。在项目的根目录下，创建一个名为<code class="fe ma mb mc md b">index.js</code>的文件，并添加以下逻辑来根据用户的年龄查询用户:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="12d2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们现在可以获得用户，当我们记录时，我们看到登录的用户缺少了<code class="fe ma mb mc md b">email</code>和<code class="fe ma mb mc md b">age</code>字段。</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="0f09" class="mm ky iq md b gy mn mo l mp mq">Kashyap-MBP:sequelize-setup kashyap$ node index.js</span><span id="6dff" class="mm ky iq md b gy nj mo l mp mq">Executing (default): SELECT “id”, “firstName”, “lastName”, “createdAt”, “updatedAt” FROM “Users” AS “User” WHERE “User”.”age” &gt;= 20;</span><span id="83af" class="mm ky iq md b gy nj mo l mp mq">{ id: 2,</span><span id="4cb0" class="mm ky iq md b gy nj mo l mp mq">firstName: ‘Jane’,</span><span id="0417" class="mm ky iq md b gy nj mo l mp mq">lastName: ‘Doe’,</span><span id="d5a5" class="mm ky iq md b gy nj mo l mp mq">createdAt: 2018–07–19T21:08:51.998Z,</span><span id="a28a" class="mm ky iq md b gy nj mo l mp mq">updatedAt: 2018–07–19T21:08:51.998Z }</span></pre><p id="a9dc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是因为我们没有将模型更新为与我们的迁移文件同步，该迁移文件用于更新<code class="fe ma mb mc md b">Users</code>表的列。让我们首先用相同的字段更新模型:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="5654" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当我们重新运行之前运行的<code class="fe ma mb mc md b">index.js</code>文件来查询<code class="fe ma mb mc md b">Users</code>表时:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="5b3e" class="mm ky iq md b gy mn mo l mp mq">Kashyap-MBP:sequelize-setup kashyap$ node index.js</span><span id="2fc3" class="mm ky iq md b gy nj mo l mp mq">Executing (default): SELECT “id”, “firstName”, “lastName”, “email”, “age”, “createdAt”, “updatedAt” FROM “Users” AS “User” WHERE “User”.”age” &gt;= 20;</span><span id="7856" class="mm ky iq md b gy nj mo l mp mq">{ id: 2,</span><span id="eba9" class="mm ky iq md b gy nj mo l mp mq">firstName: ‘Jane’,</span><span id="eec2" class="mm ky iq md b gy nj mo l mp mq">lastName: ‘Doe’,</span><span id="fbca" class="mm ky iq md b gy nj mo l mp mq">email: ‘jane.doe@email.com’,</span><span id="547a" class="mm ky iq md b gy nj mo l mp mq">age: 20,</span><span id="8ca9" class="mm ky iq md b gy nj mo l mp mq">createdAt: 2018–07–19T21:08:51.998Z,</span><span id="a08c" class="mm ky iq md b gy nj mo l mp mq">updatedAt: 2018–07–19T21:08:51.998Z }</span></pre><p id="b060" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们可以看到，它按照预期打印了用户对象的整个结构。</p><h1 id="557a" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">结论</h1><p id="a2ff" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">Sequelize有一些非常强大的特性，如果利用得当，可以使开发过程变得容易得多。在这篇文章中，我们已经探索了一些相当简单的选项来解决我们的开发过程。还有更复杂的迁移可以应用于Sequelize，我将在另一篇文章中讨论。</p><p id="e084" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完整的代码库可以在这里找到<a class="ae kw" href="https://github.com/40x/sequelize-setup" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="4ba4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请在下面的评论区留下问题和评论。</p></div><div class="ab cl oh oi hu oj" role="separator"><span class="ok bw bk ol om on"/><span class="ok bw bk ol om on"/><span class="ok bw bk ol om"/></div><div class="ij ik il im in"><p id="54e8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ms">如果你喜欢这个博客，一定要为它鼓掌或者关注我的</em> <a class="ae kw" href="https://www.linkedin.com/in/kashyap-mukkamala/" rel="noopener ugc nofollow" target="_blank"> <em class="ms"> LinkedIn </em> </a></p></div></div>    
</body>
</html>