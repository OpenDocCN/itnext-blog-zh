<html>
<head>
<title>An introduction to Pydbantic — a single model solution to Data Verification &amp; Storage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Pydbantic简介——数据验证和存储的单一模型解决方案</h1>
<blockquote>原文：<a href="https://itnext.io/an-introduction-to-pydbantic-a-single-model-solution-to-data-verification-storage-254cfe9e757f?source=collection_archive---------1-----------------------#2021-11-15">https://itnext.io/an-introduction-to-pydbantic-a-single-model-solution-to-data-verification-storage-254cfe9e757f?source=collection_archive---------1-----------------------#2021-11-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/0aeac1aad5b3955a5d190bda879f5132.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*n609q9z9UY3Tfn9Q.png"/></div></div></figure><p id="2815" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Pydbantic从<a class="ae kw" href="https://pydantic-docs.helpmanual.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> pydantic </strong> </a>继承了它的名字，这是一个“使用Python类型提示进行数据解析和验证”的库。</p><p id="872f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">简而言之，pydantic提供了一个框架来验证接口之间的输入，以确保满足正确的输入数据(类型、结构、必需、可选)，从而消除了添加逻辑来捕捉和验证错误输入的需要。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="5366" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Pydantic负责确保数据类型/格式的正确性，但是这种数据在创建后并不能永久保存。开发人员的一项常见任务是以某种方式将这些模型转换成“数据库原生”格式以便持久化。</p><p id="e0cb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Pydantic为这种序列化提供了许多有用的方法。但是，大多数pydantic模型并不是平等的。这意味着对于每个模型，通常需要单独的逻辑来将给定的字段转换为“数据库本地”列类型。因此，每当数据被序列化时，都必须再次反序列化才能再次使用。</p><p id="cdc3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">数据存储在哪里以及如何存储，通常与编写和管理序列化逻辑一样令人望而生畏。python生态系统提供了许多选择，通常没有“错误的选项”，但是直到最近，每个选项都需要单独的数据验证模型&amp;数据库表。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="428d" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">创建模型</h1><p id="44b6" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">理解和欣赏“单一模型”模型的最好方法，就是看它的实际应用。下面是一个简单的模型，它映射了公司可能存储的关于员工的一些非常基本的信息，我们将继续对其进行扩展:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="e3a5" class="mq lf iq mm b gy mr ms l mt mu"># Application Structure<br/>├── app.py<br/>└── models.py</span></pre><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="13b3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个模型可以马上使用，就像任何pydantic模型一样，开始看到它的潜力。</p><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="550c" class="mq lf iq mm b gy mr ms l mt mu">$ python app.py</span><span id="d941" class="mq lf iq mm b gy mx ms l mt mu">id='0e2eeddd-bfa2-4e81-9d38-87b098039b3d' salary=20000.0 is_employed=True date_employed='2021-11-15T09:21:02.358015'</span></pre><p id="5264" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">到目前为止，应用程序只创建了一个Employee实例，只提供了<code class="fe my mz na mm b">salary</code>和<code class="fe my mz na mm b">is_employed</code>。其他字段在实例化时使用提供的“零参数”函数生成。这个实例可以像任何其他pydantic模型一样使用，带有一些可用于持久性的附加方法(如果插入到数据库中)。</p><h1 id="1111" class="le lf iq bd lg lh nb lj lk ll nc ln lo lp nd lr ls lt ne lv lw lx nf lz ma mb bi translated">保存模型</h1><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="0fdc" class="mq lf iq mm b gy mr ms l mt mu">├── app.py<br/>├── db.py<br/>├── models.py</span></pre><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="a282" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe my mz na mm b">Employee</code>模型通过首先调用<code class="fe my mz na mm b">Database.create(</code>工厂方法连接到数据库，工厂方法将模型连接到新的或现有的数据库。如果是新的，将创建该表，如果是现有的，将检查该表是否有修改&amp;如果需要，将迁移该表。</p><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="a3aa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe my mz na mm b">pydbantic</code>、<code class="fe my mz na mm b">.insert()</code>、<code class="fe my mz na mm b">.save()</code>和<code class="fe my mz na mm b">.create(</code>中有3种保存模型的有效方法，上面演示了后两种方法。</p><h1 id="bd6b" class="le lf iq bd lg lh nb lj lk ll nc ln lo lp nd lr ls lt ne lv lw lx nf lz ma mb bi translated"><strong class="ak">查询模型</strong></h1><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="0c45" class="mq lf iq mm b gy mr ms l mt mu">├── app.py<br/>├── company.db<br/>├── db.py<br/>├── models.py</span></pre><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="a5f1" class="mq lf iq mm b gy mr ms l mt mu">$ python app.py</span><span id="0c85" class="mq lf iq mm b gy mx ms l mt mu">[<br/>    Employee(id='0877c661-0d53-4435-a800-425b64c08c43', salary=100000.0, is_employed=True, date_employed='2021-11-15T09:37:51.105720'), <br/>    Employee(id='67c476d9-3830-434a-9dfe-8ad3cc914129', salary=100000.0, is_employed=True, date_employed='2021-11-15T09:37:51.118808')<br/>]</span></pre><h2 id="7662" class="mq lf iq bd lg ng nh dn lk ni nj dp lo kj nk nl ls kn nm nn lw kr no np ma nq bi translated">主关键字</h2><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="120f" class="mq lf iq mm b gy mr ms l mt mu">$ python app.py<br/>employee is id='0877c661-0d53-4435-a800-425b64c08c43' salary=100000.0 is_employed=True date_employed='2021-11-15T09:37:51.105720'</span></pre><p id="55de" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">过滤</strong></p><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="12be" class="mq lf iq mm b gy mr ms l mt mu">$ python app.py</span><span id="617d" class="mq lf iq mm b gy mx ms l mt mu">[<br/>    Employee(id='0877c661-0d53-4435-a800-425b64c08c43', salary=100000.0, is_employed=True, date_employed='2021-11-15T09:37:51.105720'), <br/>    Employee(id='67c476d9-3830-434a-9dfe-8ad3cc914129', salary=100000.0, is_employed=True, date_employed='2021-11-15T09:37:51.118808')<br/>]</span></pre><h1 id="c25c" class="le lf iq bd lg lh nb lj lk ll nc ln lo lp nd lr ls lt ne lv lw lx nf lz ma mb bi translated">更新模型</h1><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="163d" class="mq lf iq mm b gy mr ms l mt mu">$ python app.py</span><span id="61e9" class="mq lf iq mm b gy mx ms l mt mu">[<br/>    Employee(id='0877c661-0d53-4435-a800-425b64c08c43', salary=102000.0, is_employed=True, date_employed='2021-11-15T09:37:51.105720'), <br/>    Employee(id='67c476d9-3830-434a-9dfe-8ad3cc914129', salary=102000.0, is_employed=True, date_employed='2021-11-15T09:37:51.118808')<br/>]<br/></span></pre><p id="7ce5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过模型实例的<code class="fe my mz na mm b">.save()</code>或<code class="fe my mz na mm b">.update()</code>方法可以更新模型。</p><h1 id="85ea" class="le lf iq bd lg lh nb lj lk ll nc ln lo lp nd lr ls lt ne lv lw lx nf lz ma mb bi translated">从模型中删除数据</h1><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="4550" class="mq lf iq mm b gy mr ms l mt mu">$ python app.py</span><span id="c4e7" class="mq lf iq mm b gy mx ms l mt mu">[]</span></pre><p id="8c0c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就像更新一样，从一个模型中删除数据需要通过一个模型的实例通过<code class="fe my mz na mm b">.delete()</code>来完成。</p><h1 id="6d38" class="le lf iq bd lg lh nb lj lk ll nc ln lo lp nd lr ls lt ne lv lw lx nf lz ma mb bi translated">模型关系</h1><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="e431" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里定义了一个名为<code class="fe my mz na mm b">Positions</code>的新<code class="fe my mz na mm b">DataBaseModel</code>，它通过一个新字段<code class="fe my mz na mm b">position</code>与<code class="fe my mz na mm b">Employees</code>相关联。</p><p id="2767" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请特别注意<code class="fe my mz na mm b">position</code>的默认值，如果在创建员工时未指定，将使用该默认值<strong class="ka ir">，如果字段尚不存在，则使用</strong>进行迁移。</p><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="bae8" class="mq lf iq mm b gy mr ms l mt mu">$ python app.py</span><span id="e20f" class="mq lf iq mm b gy mx ms l mt mu">11-15 10:23 pydb         WARNING  Migrations may be required. Will attempt in order: [&lt;class 'models.Employee'&gt;]</span><span id="6e26" class="mq lf iq mm b gy mx ms l mt mu">11-15 10:23 pydb         WARNING  Migration Required: ['New Column: position']</span><span id="cde9" class="mq lf iq mm b gy mx ms l mt mu">[<br/>    Employee(id='c61e1114-76fd-4356-a167-ffc802c7ad93', salary=100000.0, is_employed=True, date_employed='2021-11-15T11:23:03.047574', position=Positions(name='Manager', department='HR'))<br/>]<br/>[    <br/>    Positions(name='Manager', department='HR')<br/>]</span></pre><p id="ec93" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe my mz na mm b">Employees.create()</code>创建时，<code class="fe my mz na mm b">Positions(name=’Manager’, department=’HR’)</code>被创建，因为还没有名为<code class="fe my mz na mm b">Manager</code>的<code class="fe my mz na mm b">Positions</code>对象存在。</p><p id="fbcb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">还要注意应用程序启动前的额外日志。<code class="fe my mz na mm b">Migrations may be required. Will attempt in order: [&lt;class 'models.Employee'&gt;]</code>该日志和以下日志指示检测到的对模型<code class="fe my mz na mm b">Employee</code>的更改，以及将进行迁移的通知。</p><p id="322d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">聪明的人可能会注意到<code class="fe my mz na mm b">Positions</code>从未直接插入<code class="fe my mz na mm b">db.py</code>。<code class="fe my mz na mm b">DatabaseModel</code>具有相关<code class="fe my mz na mm b">DatabaseModel</code>的对象将确保相关的表也在运行时插入数据库。<code class="fe my mz na mm b">DatabaseModel</code>如果定义被另一个已经输入到<code class="fe my mz na mm b">Database</code>的<code class="fe my mz na mm b">DatabaseModel</code>取消引用，则需要手动输入到<code class="fe my mz na mm b">Database</code>创建中。</p><p id="4d4c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">相关车型变更</strong></p><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="8fd6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在上述模型示例中，新的<code class="fe my mz na mm b">BaseModel</code>被定义为表示新的<code class="fe my mz na mm b">DataBaseModel</code> <code class="fe my mz na mm b">Department</code>位置。现有<code class="fe my mz na mm b">Positions</code>模型的<code class="fe my mz na mm b">department</code>字段被替换为<code class="fe my mz na mm b">positions_department</code>，默认值为<code class="fe my mz na mm b">Department(name=’HR’, company=’FOOBAR’)</code>。</p><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="9e8e" class="mq lf iq mm b gy mr ms l mt mu">$ python app.py</span><span id="08e7" class="mq lf iq mm b gy mx ms l mt mu">11-15 12:38 pydb         WARNING  Migrations may be required. Will attempt in order: [&lt;class 'models.Positions'&gt;]</span><span id="d27c" class="mq lf iq mm b gy mx ms l mt mu">11-15 12:38 pydb         WARNING  Migration Required: ['New Column: position_department', 'Deleted Column: department']</span><span id="940b" class="mq lf iq mm b gy mx ms l mt mu">[<br/>    Employee(id='c61e1114-76fd-4356-a167-ffc802c7ad93', salary=100000.0, is_employed=True, date_employed='2021-11-15T11:23:03.047574', position=Positions(name='Manager', position_department=Department(name='HR', company='FOOBAR', location=Coordinates(latitude=52.299387, longitude=4.976949))))<br/>]</span><span id="f1db" class="mq lf iq mm b gy mx ms l mt mu">[<br/>    Positions(name='Manager', position_department=Department(name='HR', company='FOOBAR', location=Coordinates(latitude=52.299387, longitude=4.976949)))<br/>]<br/>[<br/>    Department(name='HR', company='FOOBAR', location=Coordinates(latitude=52.299387, longitude=4.976949))<br/>]</span></pre><p id="1144" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在运行时，新模型被导入并添加到<code class="fe my mz na mm b">Database</code>，迁移需求被检测并执行。与此同时，<code class="fe my mz na mm b">Employee</code>和<code class="fe my mz na mm b">Positions</code>模型的现有对象继续引入相关的模型变更。</p><h2 id="6b37" class="mq lf iq bd lg ng nh dn lk ni nj dp lo kj nk nl ls kn nm nn lw kr no np ma nq bi translated">删除相关数据</h2><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="7130" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在首次更新/删除相关对象之前，从相关<code class="fe my mz na mm b">DataBaseModels</code>中删除对象时，应特别考虑模型。</p><p id="b4ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在上面的例子中，所有的<code class="fe my mz na mm b">Positions</code>对象都被删除了，而对这些被删除对象的引用存在于<code class="fe my mz na mm b">Employees</code>对象中。查询<code class="fe my mz na mm b">Employees</code>的结果缺少<code class="fe my mz na mm b">Positions</code>数据，即<code class="fe my mz na mm b">None</code>。<code class="fe my mz na mm b">None</code>然而，类型不是模型<code class="fe my mz na mm b">Employee</code>属性<code class="fe my mz na mm b">position</code>的允许类型。</p><p id="9a05" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对此的简单解决方法是允许<code class="fe my mz na mm b">NoneType</code>。</p><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="1bad" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里，<code class="fe my mz na mm b">Employee</code>的属性<code class="fe my mz na mm b">position</code>用<code class="fe my mz na mm b">Union[Positions, None]</code>标注，因此允许属性为None值。使用现有的<code class="fe my mz na mm b">Employee</code>对象实例，如果需要，可以分配和更新新的<code class="fe my mz na mm b">Positions</code>对象。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="5eec" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated"><strong class="ak">使用Pydbantic进行缓存</strong></h1><p id="5200" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">只需将<code class="fe my mz na mm b">cache_enabled=True</code>添加到<code class="fe my mz na mm b">Database.create()</code>以及定义的<code class="fe my mz na mm b">redis_url</code>即可启用缓存。</p><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="e900" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当启用缓存时，db读取响应被缓存&amp;在更改时自动失效。</p><h1 id="700a" class="le lf iq bd lg lh nb lj lk ll nc ln lo lp nd lr ls lt ne lv lw lx nf lz ma mb bi translated"><strong class="ak">使用Pydbantic进行测试</strong></h1><p id="cdc2" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">使用Pydbantic测试很容易，只需将<code class="fe my mz na mm b">testing=True</code>添加到<code class="fe my mz na mm b">database.create()</code>fixture，链接的数据库表&amp;缓存将在启动前自动清空。</p><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="92fb" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">帮助Pydbantic变得更好！</h1><ul class=""><li id="ae48" class="nr ns iq ka b kb mc kf md kj nt kn nu kr nv kv nw nx ny nz bi translated">喜欢图书馆吗？星叉<a class="ae kw" href="https://github.com/codemation/pydbantic" rel="noopener ugc nofollow" target="_blank"> me </a>！</li><li id="3176" class="nr ns iq ka b kb oa kf ob kj oc kn od kr oe kv nw nx ny nz bi translated">有想法，改进，Bug，提交问题<a class="ae kw" href="https://github.com/codemation/pydbantic/issues" rel="noopener ugc nofollow" target="_blank">这里</a>！</li></ul></div></div>    
</body>
</html>