<html>
<head>
<title>Adding SQL Server Pagination to an Outsystems REST API method</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">向Outsystems REST API方法添加SQL Server分页</h1>
<blockquote>原文：<a href="https://itnext.io/adding-sql-server-pagination-to-an-outsystems-rest-api-method-f1a4aa8f2aac?source=collection_archive---------1-----------------------#2019-09-02">https://itnext.io/adding-sql-server-pagination-to-an-outsystems-rest-api-method-f1a4aa8f2aac?source=collection_archive---------1-----------------------#2019-09-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="07f5" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated"><strong class="ak">为什么要分页？</strong></h1><p id="865f" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在构建返回数据的API时，您必须时刻牢记响应的大小。一个从数据库中获取数据的API方法，即使有一些适当的过滤，也可能返回数百万条记录，导致巨大的网络流量并最终超时。</p><p id="40a2" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">如何实施？</strong></p><p id="284c" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">有许多方法可以处理SQL分页，但自SQL Server 2012以来，有了一种新的语法:FETCH { FIRST | NEXT }，它提供了一种超级简单的处理方法。我将向您展示这种方法以及通常用于ROW_NUMBER()函数的变通方法。</p><p id="c235" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">假设您想要公开一个REST API，它从您的应用程序返回大量数据，这些数据将用于与另一个系统的集成。然后，您可以使用以下步骤:</p><h1 id="b6af" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">创建REST API:</h1><p id="8389" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kn ir">首先</strong>，您需要在Outsystems中创建一个REST API(<a class="ae lo" href="https://success.outsystems.com/Documentation/11/Extensibility_and_Integration/REST/Expose_REST_APIs/Expose_a_REST_API#Create_the_REST_API_Service" rel="noopener ugc nofollow" target="_blank">阅读更多内容</a>)，在您的新GET方法中有2个输入。将它们命名为PageSize和PageNumber，并将它们都设置为整数类型。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi lp"><img src="../Images/8c43e221cf42e7182fce3b3444563c4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:720/format:webp/1*A82QnFFHMbM6etKnqbmR9A.png"/></div><figcaption class="lx ly gj gh gi lz ma bd b be z dk translated">REST API方法示例</figcaption></figure><p id="1d18" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">输入:</strong></p><ul class=""><li id="f416" class="mb mc iq kn b ko lj ks lk kw md la me le mf li mg mh mi mj bi translated">页面大小:页面的大小。所以，如果你想返回10条记录，这将是页面大小。</li><li id="9697" class="mb mc iq kn b ko mk ks ml kw mm la mn le mo li mg mh mi mj bi translated">PageNumber:这将是开始搜索的偏移量或页面。这由请求者控制。</li></ul><h1 id="d691" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">向SQL查询添加分页:</h1><p id="b655" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kn ir">第二个</strong>，您将需要使用SQL查询来获取数据。我现在将向您展示两个高级查询示例。</p><p id="570d" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">让我们检查<strong class="kn ir">偏移量并获取</strong>分页:</p><h1 id="3dcb" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">使用OFFSET和FETCH来限制返回的行数</h1><blockquote class="mp mq mr"><p id="d191" class="kl km ms kn b ko lj kq kr ks lk ku kv mt ll ky kz mu lm lc ld mv ln lg lh li ij bi translated">使用OFFSET and FETCH作为分页解决方案需要对返回给客户端应用程序的每一“页”数据运行一次查询。例如，要以10行为增量返回查询结果，必须执行一次查询以返回第1行到第10行，然后再次运行查询以返回第11行到第20行，依此类推。每个查询都是独立的，彼此之间没有任何关系。这意味着，与使用只执行一次查询并在服务器上维护状态的游标不同，客户端应用程序负责跟踪状态。<a class="ae lo" href="https://docs.microsoft.com/en-us/sql/t-sql/queries/select-order-by-clause-transact-sql?view=sql-server-2017" rel="noopener ugc nofollow" target="_blank">阅读更多</a></p></blockquote><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/7340aca28cbe150d0b05c5698a12e1e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:686/format:webp/0*oD9iNyXrj4y2P1qf.png"/></div><figcaption class="lx ly gj gh gi lz ma bd b be z dk translated"><code class="fe mx my mz na b">OFFSET</code>和<code class="fe mx my mz na b">FETCH</code> <a class="ae lo" href="http://www.sqlservertutorial.net/sql-server-basics/sql-server-offset-fetch/" rel="noopener ugc nofollow" target="_blank">阅读更多</a></figcaption></figure><p id="ca35" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">因此，要实现这一点，查询必须按ASC排序，最好是按ID排序(如果添加了新记录，返回的数据将是一致的。如果您按另一个属性或不同的顺序(DESC)排序，如果添加了新记录，您将会错过这些记录。)<br/>然后你只需要加上偏移量，接下来取如下图:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/9884cb7508f4d399eb30064abc94fd11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*WWQiDYUTKb_PWBbB-HhTpA.png"/></div></figure><p id="bbb9" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><code class="fe mx my mz na b">OFFSET</code>子句指定了跳过的<strong class="kn ir">行数。<br/><code class="fe mx my mz na b">FETCH</code>子句指定在</strong> <code class="fe mx my mz na b">OFFSET</code>子句被处理后返回的<strong class="kn ir">行数。<br/><code class="fe mx my mz na b">OFFSET</code>条款为强制条款，而<code class="fe mx my mz na b">FETCH</code>条款为可选条款。<br/><code class="fe mx my mz na b">FIRST</code>和<code class="fe mx my mz na b">NEXT</code>分别是同义词，所以可以互换使用。<br/> <a class="ae lo" href="http://www.sqlservertutorial.net/sql-server-basics/sql-server-offset-fetch/" rel="noopener ugc nofollow" target="_blank">阅读更多</a></strong></p><p id="a79c" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">如何计算偏移量？</strong></p><pre class="lq lr ls lt gt nc na nd ne aw nf bi"><span id="8ae3" class="ng jo iq na b gy nh ni l nj nk">PageSize*(PageNumber-1)</span></pre><p id="1c80" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">有了这个表达式集，就可以将偏移量作为输入参数发送给查询。输入页面大小，您从API方法的输入参数中获得。</p><h1 id="e65d" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">使用ROW_NUMBER()</h1><blockquote class="mp mq mr"><p id="cde0" class="kl km ms kn b ko lj kq kr ks lk ku kv mt ll ky kz mu lm lc ld mv ln lg lh li ij bi translated">对结果集的输出进行编号。更具体地说，返回结果集的分区中某一行的序号，每个分区中第一行从1开始。<a class="ae lo" href="https://docs.microsoft.com/en-us/sql/t-sql/functions/row-number-transact-sql?view=sql-server-2017" rel="noopener ugc nofollow" target="_blank">阅读更多</a></p></blockquote><p id="2e6b" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">以下示例计算按RentalBookingId排序的RentalBooking表中所有行的行号，并只返回偏移量和偏移量限制之间的行。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi nl"><img src="../Images/e5166c9cae220e9bd65663bb6339bd8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fmyQExpCv_qBfeHwpUzc2A.png"/></div></div></figure><p id="388f" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">如何计算上例中的极限？</strong></p><pre class="lq lr ls lt gt nc na nd ne aw nf bi"><span id="7f6e" class="ng jo iq na b gy nh ni l nj nk">(PageSize*PageNumber)</span></pre><p id="2328" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">还有抵消？</strong></p><pre class="lq lr ls lt gt nc na nd ne aw nf bi"><span id="3a84" class="ng jo iq na b gy nh ni l nj nk">PageSize*(PageNumber-1)+1</span></pre><p id="a8ce" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">所以，当你有了输入:<br/>PageSize:10<br/>page number:5</p><p id="8185" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">那么<strong class="kn ir"> WHERE子句</strong>将看起来像:</p><pre class="lq lr ls lt gt nc na nd ne aw nf bi"><span id="1015" class="ng jo iq na b gy nh ni l nj nk">WHERE RowNumber &gt;= 41 AND RowNumber &lt;= 50</span></pre></div><div class="ab cl nq nr hu ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="ij ik il im in"><h1 id="f058" class="jn jo iq bd jp jq nx js jt ju ny jw jx jy nz ka kb kc oa ke kf kg ob ki kj kk bi translated"><strong class="ak">客户请求示例:</strong></h1><p id="f927" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">客户端将不得不控制状态，因此，例如，他将开始请求页面编号1，大小为20。随后将请求下一页的页码。</p><p id="9d11" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">API/rest/get rentals/getall rentals？PageSize = 20 &amp; page number = 1 API/rest/get rentals/get all rentals？PageSize = 20 &amp; page number = 2<br/>API/rest/get rentals/get all rentals？PageSize=20 &amp;页码=3</p><h1 id="56ca" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">API响应示例:</h1><p id="2fc8" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">除了接收所请求的业务数据之外，客户端还应该接收一些关于他正在接收的数据集的信息，例如返回的页码、页面大小和总计数。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/7106f70306f4be5202ff28630d3a2181.png" data-original-src="https://miro.medium.com/v2/resize:fit:1232/format:webp/1*sDuXQGFPN6D4aJXbdklpYg.png"/></div><figcaption class="lx ly gj gh gi lz ma bd b be z dk translated">REST API方法返回的结构示例</figcaption></figure><p id="5ba9" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">JSON响应会是这样的:<br/> <strong class="kn ir">调用</strong>:/rest/get rentals/getall rentals？PageSize=2 &amp;页码=2</p><p id="21a3" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">响应</strong>:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi od"><img src="../Images/8318091b557249dc675fc8dfcb8c3692.png" data-original-src="https://miro.medium.com/v2/resize:fit:956/format:webp/1*jwSH_05H0zcqz-7CmE76WQ.png"/></div></figure><h1 id="20b2" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">结论</h1><p id="2c4a" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在我看来，OFFSET and FETCH NEXT是实现分页最简单的方法。语法清晰，干净，易于理解。<br/> ROW_NUMBER方法使用CTE表，你需要一些T-SQL方面的经验才能完全理解那里发生的事情。</p><p id="2bdc" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">关于性能，即使对于大约3 M记录的大型数据集，我也没有注意到两种方法有很大的不同。</p><p id="5904" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">我发现的每一个文档都指出FETCH NEXT方法的速度是ROW_NUMBER的两倍。但老实说，我无法从测试中得到这些结果。根据我所做的测试，两个查询的性能几乎相同(我确信我需要更深入地分析SQL执行计划——也许我会在另一篇文章中讨论这个问题！)<strong class="kn ir">这让我基于使用的简单性推荐了FETCH NEXT。</strong></p><p id="ef1b" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">确保您的开发和生产环境至少有SQL Server 2012，以便能够使用偏移量并进行下一步提取。</p><p id="1b0d" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">下一个故事再见！</p></div></div>    
</body>
</html>