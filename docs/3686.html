<html>
<head>
<title>How to speed up Ruby and JavaScript tests with CI parallelisation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用CI并行化加速Ruby和JavaScript测试</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-speed-up-ruby-and-javascript-tests-with-ci-parallelisation-a2324a62022a?source=collection_archive---------3-----------------------#2020-02-02">https://itnext.io/how-to-speed-up-ruby-and-javascript-tests-with-ci-parallelisation-a2324a62022a?source=collection_archive---------3-----------------------#2020-02-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="fcd8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当您在处理一个更大的项目时，您可能会被日益增长的测试集的问题所困扰，随着时间的推移，这些测试在您的持续集成(CI)服务器上的执行速度开始变慢。我在Ruby on Rails的一个项目中遇到了这个问题，在CircleCI上的RSpec测试花了大约15分钟。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/c360b81f090be1f2b28b80e55e0b2561.png" data-original-src="https://miro.medium.com/v2/resize:fit:994/format:webp/0*5Ybgfn3BFPabgBHS.jpg"/></div></figure><p id="b624" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于这个问题困扰着我，我决定对此做些什么，这导致了构建一个开源的背包Ruby gem库(名字来源于背包问题)，它处理并行CI服务器之间的分布式测试。在本文中，您将<strong class="jp ir">了解在并行持续集成服务器上分割测试的两种方法——静态和动态</strong>。</p><p id="cfe4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您的项目中有一个测试套件需要在CI服务器上执行十几分钟，或者甚至几个小时，您就会知道这对程序员来说有多不方便。当您在开发一些新特性并将一个新的git提交推入存储库时，您必须等待CI服务器很长时间，直到它执行CI构建。</p><p id="59de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">等待几分钟或一小时会延迟您从CI服务器获得的关于可能尚未完成的测试的反馈(红色测试)。毕竟，我们都希望尽快获得关于我们的CI构建是绿色还是红色的信息，以便程序员的工作不会受阻。</p><h1 id="8c6f" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">在CI服务器上运行并行测试的问题</h1><p id="26a8" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">为了加速CI构建的执行，您可以在CI服务器上使用并行性，即启动几个并行CI机器(CI容器，例如Docker中的CI容器)，其中每个并行服务器将执行测试集的一部分。但是，有一个问题，即哪些测试应该在哪些服务器(CI节点)上运行，以便它们的分布相当均匀，并且您不必等待成为瓶颈的CI节点。</p><p id="8d3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面您可以看到一个在4台CI服务器上测试的非最优分布的例子，其中第二台标有红色的服务器是一个瓶颈，因此等待整个CI构建完成的时间长达20分钟。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi lw"><img src="../Images/e0ff47f312a2fa907c18ac3779ffe537.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZLXq5ohEdGwU-gHB.png"/></div></div></figure><h1 id="ff0e" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">并行CI服务器上测试的最优分布</h1><p id="2b20" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">在理想的情况下，测试应该以这样的方式分布，即所有并行CI服务器在相似的时间结束操作。在接下来的部分中，我将展示如何实现这一点。</p><p id="0d72" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面您可以看到一个测试最佳分布的示例，其中每台并行CI机器执行10分钟的测试，因此整个CI构建只持续了10分钟，而不是上一个示例中的20分钟。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi mb"><img src="../Images/e8e34d65a66d7e6013536d23db44bce9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hmHSJyjVvk5eOi3k.png"/></div></div></figure><h1 id="29e9" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">以确定的方式静态拆分测试</h1><p id="1ff8" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">确定如何在CI服务器上的并行机器之间划分测试以便每个服务器在相似的时间完成测试的一种方法是使用测试套件中文件的测量运行时间。这是我在背包Ruby gem中实现的第一种方法。</p><p id="e0da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在测量测试执行时间之后，我们可以在并行CI服务器之间分配单独的测试文件，以确保CI构建没有瓶颈。</p><p id="3b67" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在背包库的帮助下，您可以在Ruby中运行许多测试运行程序的测试，例如RSpec、Minitest、Cucumber、菠菜和芜菁。使用测试运行时，背包gem可以构建一个要在特定CI节点上执行的测试列表。</p><p id="67a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我通过测量每个git提交和分支的测试文件时间来改进这种划分测试的方式。在下面的视频中，我展示了如何在背包Pro中以确定的方式进行常规模式的静态测试分割。在下一节中，您将了解这种方法的一些边缘情况以及如何解决它。</p><h1 id="9fe2" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">测试的静态分割问题</h1><p id="0123" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">在从用户那里收集信息时，我发现以静态方式分布测试并不总是一个好的解决方案。有时，一些测试有随机的执行时间，这取决于，例如，CI服务器有多忙，或者测试由于软件错误、比平常更快退出工作等原因而没有通过。</p><p id="a849" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，使用浏览器的测试在运行时会有波动(Ruby中的Capybara测试或JavaScript中的E2E测试)。</p><p id="d1b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个问题还会随着您使用的CI服务器而增加。每台并行CI机器是否具有相似的性能，或者是否共享CPU或RAM等资源？CI容器是否在共享环境中运行？如果CI节点过载，那么我们的测试当然会变慢。</p><p id="9ac1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除此之外，还会有所有并行机启动时间是否相近的问题。如果您购买了一个并行CI服务器池，其他人可能也在使用它，例如，当前项目的另一个CI构建或您组织的另一个项目。</p><p id="f0ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果不是所有CI节点都同时启动，或者在CI节点执行过程中某些步骤的引导时间可能是随机的，那么我们希望能够确保所有CI机器在相似的时刻完成它们的工作。慢的CI机器或那些晚开始工作的机器应该做更少的测试，而那些早开始工作的机器可以很容易地做更多的测试。</p><p id="0771" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所有并行CI节点必须在相似的时间停止工作，以避免瓶颈，即测试使机器过载。</p><h1 id="170a" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">动态测试拆分</h1><p id="2995" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">上述问题的解决方案是在一个CI构建中的并行机器之间动态划分测试。这是我近年来一直在解决的问题，创建了<a class="ae mc" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=how-to-speed-up-ruby-and-javascript-tests-with-ci-parallelisation" rel="noopener ugc nofollow" target="_blank">backpack Pro</a>库和Ruby和JavaScript的队列模式，支持Jest或Cypress等几个流行的测试运行程序。</p><p id="2e5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个想法很简单。我们有一组在背包Pro服务器上排队的测试。单个并行CI机器使用背包Pro API消耗队列，直到队列结束。由于这一点，测试在CI服务器之间得到了最佳分布，帮助您避免过载(太慢)CI服务器形式的瓶颈。下面你可以看到一个例子:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi md"><img src="../Images/6158e38a8d19e878eeb0154d4838df85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1358/format:webp/0*jM3yFC8xjtNOt-N-.png"/></div></figure><p id="4e9a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">动态测试套件分割解决了我们在随机测试执行时间、运行缓慢的CI服务器或工作速度较慢的过载服务器方面的问题。无论他们何时开始或结束工作，重要的是他们在完成当前工作之前不要进行太多的测试。</p><p id="7ba3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">了解动态测试套件分割如何在backpack Pro的队列模式下工作。</p><h1 id="1228" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">用Ruby和JavaScript实现背包Pro</h1><p id="e117" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated"><a class="ae mc" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=how-to-speed-up-ruby-and-javascript-tests-with-ci-parallelisation" rel="noopener ugc nofollow" target="_blank">背包Pro </a>对很多流行的CI服务器有原生支持。它还是一个不可知的CI工具，因此您可以使用任何CI服务器。您所要做的就是为在一个CI构建中运行的每个并行CI服务器配置backpackage Pro命令。下面您可以看到一个配置YAML如何使用backpack Pro查找配置项服务器的一般示例:</p><h1 id="ff03" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">结论</h1><p id="2503" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated"><a class="ae mc" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=how-to-speed-up-ruby-and-javascript-tests-with-ci-parallelisation" rel="noopener ugc nofollow" target="_blank">backpack Pro</a>支持Ruby和Jest、Cypress等几个JavaScript测试程序，但也有计划增加对更多测试程序和编程语言的支持。我很想听听<a class="ae mc" href="https://docs.google.com/forms/d/e/1FAIpQLSe7Z6k__VczmRMmXykjA5i2MVEA3nEJ90gbiIeCRjecWhPOig/viewform?hl=en" rel="noopener ugc nofollow" target="_blank">你们用什么来测试应用程序以及哪些CI服务器</a>。你可以在<a class="ae mc" href="https://www.linkedin.com/in/arturtrzop/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上联系我，你可以在<a class="ae mc" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=how-to-speed-up-ruby-and-javascript-tests-with-ci-parallelisation" rel="noopener ugc nofollow" target="_blank">KnapsackPro.com</a>上找到关于所述解决方案的更多信息。我希望这篇文章对你有用。:)</p></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><p id="1f20" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ml">原载于2020年2月2日https://docs.knapsackpro.com</em><a class="ae mc" href="https://docs.knapsackpro.com/2020/how-to-speed-up-ruby-and-javascript-tests-with-ci-parallelisation" rel="noopener ugc nofollow" target="_blank"><em class="ml"/></a><em class="ml">。</em></p></div></div>    
</body>
</html>