<html>
<head>
<title>Synology NAS With Free SSL Certificate on a Private Domain</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Synology NAS带有私有域上的免费SSL证书</h1>
<blockquote>原文：<a href="https://itnext.io/synology-lets-encrypt-dns-01-challenge-acme-sh-and-route53-af491786d262?source=collection_archive---------1-----------------------#2019-07-28">https://itnext.io/synology-lets-encrypt-dns-01-challenge-acme-sh-and-route53-af491786d262?source=collection_archive---------1-----------------------#2019-07-28</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="b65a" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">如何停止在浏览器中看到证书警告</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/af23776bc019f419362679858e85a48f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*11ciQhrdzNA3-pd7"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">帕特里克·林登伯格在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="57ac" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><em class="lw">如果您(仍然)在</em><a class="ae kz" href="https://www.synology.com" rel="noopener ugc nofollow" target="_blank"><em class="lw">Synology</em></a><em class="lw"/><a class="ae kz" href="https://www.synology.com/en-global/dsm" rel="noopener ugc nofollow" target="_blank"><em class="lw">DSM</em></a><em class="lw">5 . x上，并且您想要使用自动更新的</em> <a class="ae kz" href="https://letsencrypt.org" rel="noopener ugc nofollow" target="_blank"> <em class="lw">让我们加密</em> </a> <em class="lw">证书来访问NAS的web管理界面，那么这篇文章就是为您准备的。</em></p><p id="b248" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">考虑到您的NAS的web管理员很可能不接触互联网，简单的HTTP-01挑战对您不起作用，相反，您需要DNS-01挑战和受<a class="ae kz" href="https://github.com/Neilpang/acme.sh" rel="noopener ugc nofollow" target="_blank"> acme.sh </a>脚本支持的DNS服务。在这篇文章中，我将向您展示如何配置您的NAS来自动颁发和更新证书。您需要什么:</p><ul class=""><li id="50c9" class="lx ly iu lc b ld le lg lh lj lz ln ma lr mb lv mc md me mf bi translated">带有DSM 5.x固件的Synology NAS。</li><li id="bcba" class="lx ly iu lc b ld mg lg mh lj mi ln mj lr mk lv mc md me mf bi translated">一个由<code class="fe ml mm mn mo b">acme.sh</code>支持的DNS服务(我用的是<a class="ae kz" href="https://aws.amazon.com" rel="noopener ugc nofollow" target="_blank"> AWS </a> <a class="ae kz" href="https://aws.amazon.com/route53" rel="noopener ugc nofollow" target="_blank"> Route53 </a>)。</li><li id="99d4" class="lx ly iu lc b ld mg lg mh lj mi ln mj lr mk lv mc md me mf bi translated">SSH访问您的NAS。</li></ul></div><div class="ab cl mp mq hy mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="in io ip iq ir"><h2 id="9d0f" class="mw mx iu bd my mz na dn nb nc nd dp ne lj nf ng nh ln ni nj nk lr nl nm nn no bi translated">在NAS中安装acme.sh</h2><ul class=""><li id="9df8" class="lx ly iu lc b ld np lg nq lj nr ln ns lr nt lv mc md me mf bi translated">SSH到您的NAS(使用用户<code class="fe ml mm mn mo b">root</code>，而不是<code class="fe ml mm mn mo b">admin</code>)。</li><li id="d97d" class="lx ly iu lc b ld mg lg mh lj mi ln mj lr mk lv mc md me mf bi translated">切换到临时目录:<code class="fe ml mm mn mo b">cd /tmp</code>。</li><li id="c326" class="lx ly iu lc b ld mg lg mh lj mi ln mj lr mk lv mc md me mf bi translated">下载<code class="fe ml mm mn mo b">acme.sh</code>客户端:<br/> <code class="fe ml mm mn mo b">wget <a class="ae kz" href="https://raw.githubusercontent.com/Neilpang/acme.sh/master/acme.sh" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/Neilpang/acme.sh/master/acme.sh</a></code></li><li id="69e5" class="lx ly iu lc b ld mg lg mh lj mi ln mj lr mk lv mc md me mf bi translated">安装客户端:<br/> <code class="fe ml mm mn mo b">sh ./acme.sh --install --nocron --home /volume1/homes/admin/acme<br/></code>这是您应该得到的输出，您可以忽略这些错误/警告:</li></ul><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nu"><img src="../Images/2bf1f8b0122eb03b7614dc79c6aff435.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ip3P3cV0XMH5Ah2EteLQiQ.png"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">acme.sh安装默认输出</figcaption></figure><ul class=""><li id="ad68" class="lx ly iu lc b ld le lg lh lj lz ln ma lr mb lv mc md me mf bi translated">安装AWS的客户端API:<br/><code class="fe ml mm mn mo b">mkdir /volume1/homes/admin/acme/dnsapi &amp;&amp; \<br/>cd /volume1/homes/admin/acme/dnsapi &amp;&amp; \<br/>wget https://raw.githubusercontent.com/Neilpang/acme.sh/master/dnsapi/dns_aws.sh</code>。</li><li id="da53" class="lx ly iu lc b ld mg lg mh lj mi ln mj lr mk lv mc md me mf bi translated">客户端的安装应该为您提供以下文件结构:</li></ul><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj nv"><img src="../Images/25467058c306a2bd144cab52b06f5f1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*gp32OuVtP-69Dx8GdUsGag.png"/></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">acme.sh文件结构</figcaption></figure><ul class=""><li id="040b" class="lx ly iu lc b ld le lg lh lj lz ln ma lr mb lv mc md me mf bi translated">安装程序会创建一个链接到根用户的<code class="fe ml mm mn mo b">.profile</code>的<code class="fe ml mm mn mo b">acme.sh.env</code>文件，所以一旦你重新登录，你只需输入<code class="fe ml mm mn mo b">acme.sh</code>就可以运行客户端。</li></ul><h2 id="11a4" class="mw mx iu bd my mz na dn nb nc nd dp ne lj nf ng nh ln ni nj nk lr nl nm nn no bi translated">创建AWS IAM用户来管理Route53上的托管区域</h2><p id="82e9" class="pw-post-body-paragraph la lb iu lc b ld np jv lf lg nq jy li lj nw ll lm ln nx lp lq lr ny lt lu lv in bi translated">创建一个<a class="ae kz" href="https://console.aws.amazon.com/iam" rel="noopener ugc nofollow" target="_blank"> AWS IAM </a>用户，并提供必要的权限来处理您计划使用的域的托管区域。因为我使用的AWS帐户是为这篇文章创建的，所以我只是通过一个用户组授予了<code class="fe ml mm mn mo b">AmazonRoute53FullAccess</code>策略；也许您可以选择一些权限:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nz"><img src="../Images/df0da4335689b0c15de035ea75322fa5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EeUSsajEVbwSegbbrGwJ9Q.png"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">拥有处理路线53所需权限的AWS IAM用户组</figcaption></figure><p id="09f8" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">⚠️ <em class="lw">确保你为你的用户下载了凭证。</em></p><h2 id="7b3e" class="mw mx iu bd my mz na dn nb nc nd dp ne lj nf ng nh ln ni nj nk lr nl nm nn no bi translated">使用DNS-01质询颁发您的初始证书</h2><ul class=""><li id="7a92" class="lx ly iu lc b ld np lg nq lj nr ln ns lr nt lv mc md me mf bi translated">注销并SSH回您的NAS(使用<code class="fe ml mm mn mo b">root@</code>，而不是<code class="fe ml mm mn mo b">admin@</code>)。</li><li id="bb4a" class="lx ly iu lc b ld mg lg mh lj mi ln mj lr mk lv mc md me mf bi translated">使用您在AWS IAM中创建的用户的详细信息创建shell变量:<br/> <code class="fe ml mm mn mo b">export AWS_ACCESS_KEY_ID=your_id<br/>export AWS_SECRET_ACCESS_KEY=your_secret</code></li><li id="db31" class="lx ly iu lc b ld mg lg mh lj mi ln mj lr mk lv mc md me mf bi translated">颁发您的初始证书:</li></ul><pre class="kk kl km kn gu oa mo ob oc aw od bi"><span id="ae9b" class="mw mx iu mo b gz oe of l og oh">acme.sh --issue --dns dns_aws -d your_domain \<br/> --certpath /usr/syno/etc/ssl/ssl.crt/server.crt \<br/> --keypath /usr/syno/etc/ssl/ssl.key/server.key \<br/> --accountemail "your_email" \<br/> --reloadcmd '/usr/syno/sbin/synoservicecfg --reload httpd-sys'</span></pre><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj oi"><img src="../Images/b52a6ddea1ec2c34f85e0323d9c77238.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2eHBHY0y4rqVWN87p5zJNg.png"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">用于创建初始证书的acme.sh输出</figcaption></figure><h2 id="07d2" class="mw mx iu bd my mz na dn nb nc nd dp ne lj nf ng nh ln ni nj nk lr nl nm nn no bi translated">测试您新颁发的证书</h2><p id="91be" class="pw-post-body-paragraph la lb iu lc b ld np jv lf lg nq jy li lj nw ll lm ln nx lp lq lr ny lt lu lv in bi translated">只需打开DSM浏览器(如果已经打开，请关闭并重新打开或硬刷新)并检查证书:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj oj"><img src="../Images/810f93414192430ae0edcf9c2cac5482.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f_QLYJvaej580mq8Qw9IrA.png"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">您在DSM上安装的有效证书</figcaption></figure><h2 id="31e4" class="mw mx iu bd my mz na dn nb nc nd dp ne lj nf ng nh ln ni nj nk lr nl nm nn no bi translated">计划证书的自动续订</h2><p id="3207" class="pw-post-body-paragraph la lb iu lc b ld np jv lf lg nq jy li lj nw ll lm ln nx lp lq lr ny lt lu lv in bi translated">转到<code class="fe ml mm mn mo b">Control Panel &gt; Task Scheduler &gt; Create &gt; User-defined script</code>:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ok"><img src="../Images/9aa7d5559393fec6cbb7684af003c33e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j4J3fdjU37hPj534e2GTAw.png"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">创建用户定义的计划作业</figcaption></figure><p id="60ac" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">使用以下脚本创建任务:</p><p id="d2df" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe ml mm mn mo b">/volume1/homes/admin/acme/acme.sh --cron --home /volume1/homes/admin/acme --log /volume1/homes/admin/acme/acme.sh.log</code></p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ol"><img src="../Images/76bb42fe89679dfd1101d27e9bfe910c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dSYbqePyf4ifg0jkjPpXYA.png"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">续订证书的计划任务</figcaption></figure><p id="b3e1" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">设置每天执行的任务。<code class="fe ml mm mn mo b">acme.sh</code>将检查您的证书的到期日期，并且不会尝试重新颁发新证书，除非自颁发日期起已经过了60天:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj om"><img src="../Images/c3c7162854c4868ae1c46c7a7ec67013.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KLuhlBp_NGD4Ppm6glt7yQ.png"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">计划证书续订</figcaption></figure></div></div>    
</body>
</html>