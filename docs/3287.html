<html>
<head>
<title>How do NgRx Action Creators work?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">NgRx动作创作者是如何工作的？</h1>
<blockquote>原文：<a href="https://itnext.io/how-do-ngrx-action-creators-work-bd8b17e02584?source=collection_archive---------1-----------------------#2019-11-14">https://itnext.io/how-do-ngrx-action-creators-work-bd8b17e02584?source=collection_archive---------1-----------------------#2019-11-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/56f597226d18d6890ff11ad943f9960b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rzJKMJY4hQbtJpWZgrPH3w.png"/></div></div></figure><p id="2deb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">StackOverflow是一个了不起的资源，每个开发人员每天都在使用它。此外，它可以激励学习新的东西。最近发现一个问题:<a class="ae kw" href="https://stackoverflow.com/questions/58690209/meaning-of-ngrx-createaction-methods-return-type-signature" rel="noopener ugc nofollow" target="_blank">NgRx create action方法的返回类型签名</a>的含义。这激起了我的兴趣，因为我使用动作创建器已经有一段时间了，但我从来没有渴望了解它们实际上是如何工作的。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="0d03" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在版本8之前使用NgRx的用户可以通过以下方式创建操作:</p><figure class="lf lg lh li gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi le"><img src="../Images/c386f2f2a62ecbee0a6fd8906708473a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TSZjxgUwnvh_v5TtcOQoug.png"/></div></div></figure><p id="c64a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们都记得需要多少样板文件来支持我们的行动和减少。有了NgRx 8，事情变得简单多了:</p><figure class="lf lg lh li gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lj"><img src="../Images/6f5fdd895ca4eef7e3e42086cbd966b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pibww2h1i4crFDRDZhUj4g.png"/></div></div></figure><p id="c619" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们需要调用一个单独的函数<code class="fe lk ll lm ln b">createAction</code>，而不是为每种类型的动作都有一个枚举和一个类。<a class="lo lp ep" href="https://medium.com/u/f7828ad40c7c?source=post_page-----bd8b17e02584--------------------------------" rel="noopener" target="_blank"> Alex Okrushko </a>有一篇很棒的文章，介绍了<a class="ae kw" href="https://blog.angularindepth.com/ngrx-action-creators-redesigned-d396960e46da" rel="noopener ugc nofollow" target="_blank">新动作创作者的好处</a>。</p><p id="af60" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">那么它们是如何工作的呢？</p><p id="d4fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，让我们看看当鼠标悬停在<code class="fe lk ll lm ln b">logout</code>动作上时，TypeScript给出了什么:</p><figure class="lf lg lh li gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lq"><img src="../Images/2d6d1b67cbf547e65a73f752742e14c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XavKt7xM_AG5VRrk7G-oHg.png"/></div></div></figure><p id="b448" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们的登录类型是<code class="fe lk ll lm ln b">ActionCreator&lt;T,() =&gt; TypedAction&lt;T&gt;&gt;.</code> <em class="lr"> </em>第一个参数是泛型参数<code class="fe lk ll lm ln b">T</code>，在我们的例子中是“[Auth] Logout”。第二个是返回<code class="fe lk ll lm ln b">TypedAction&lt;T&gt;</code>的函数。TypedAction通过添加<code class="fe lk ll lm ln b">readonly type</code>字段来扩展动作:</p><figure class="lf lg lh li gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ls"><img src="../Images/980a5b8542e2ea5835d7e30e0dee4485.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mO0vp1S3beinPii0SZYMxg.png"/></div></div></figure><p id="ee99" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们来看看<a class="ae kw" href="https://github.com/ngrx/platform/blob/90d06020d794034d326f01dbecef440be62cf7ce/modules/store/src/action_creator.ts#L100" rel="noopener ugc nofollow" target="_blank"> createAction </a>函数的实现:</p><figure class="lf lg lh li gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lt"><img src="../Images/638346cec84b1948c6524dc3788f4d43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h46exBwSXaIEl70L18hKYg.png"/></div></div></figure><p id="82ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们传入<code class="fe lk ll lm ln b">type</code>(在我们的例子中是‘Auth’Logout)并获取一个Creator函数— <code class="fe lk ll lm ln b">() =&gt; ({type: '[Auth] Logout'})</code>。在第7行，我们用类型和我们的创建者调用<code class="fe lk ll lm ln b">defineType</code>函数。<code class="fe lk ll lm ln b">defineType</code>返回一个传入的Creator函数，并向其添加一个新的属性类型。所以，我们有一个带有类型属性的函数，它返回一个带有类型属性的对象😵😕。</p><p id="37fa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过这个技巧，我们可以调用<code class="fe lk ll lm ln b">logout.type</code>和<code class="fe lk ll lm ln b">logout().type</code>，它们都返回“[Auth] Logout”。</p><p id="f295" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们看看我们的新减速器在做什么:</p><figure class="lf lg lh li gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lu"><img src="../Images/e0b5df1144d866c342abd628b7c941ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x4s766vL0f3OdKm0r_cMYQ.png"/></div></div></figure><p id="efcd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面是<a class="ae kw" href="https://github.com/ngrx/platform/blob/90d06020d794034d326f01dbecef440be62cf7ce/modules/store/src/reducer_creator.ts#L181" rel="noopener ugc nofollow" target="_blank">on功能</a>的实现:</p><figure class="lf lg lh li gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lv"><img src="../Images/d0e2d170c442c39fd729610c2ba1402a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pTWKlmPNm2LJ4RcFajsdQQ.png"/></div></div></figure><p id="dd0f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它首先提取最后一个参数reducer函数(第2行)，获取我们的<code class="fe lk ll lm ln b">ActionCreator</code>的类型(第4行)(这里使用了<code class="fe lk ll lm ln b">defineType</code>的魔力)并返回一个包含reducer和相应动作类型的对象(第7行)。<br/>稍后，在<a class="ae kw" href="https://github.com/ngrx/platform/blob/90d06020d794034d326f01dbecef440be62cf7ce/modules/store/src/reducer_creator.ts#L227" rel="noopener ugc nofollow" target="_blank"> createReducers函数</a>中:</p><figure class="lf lg lh li gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lw"><img src="../Images/f1f461f1a6f368f8925cf7bc55461590.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fSJ-yqoBwyF9neytR67nuA.png"/></div></div></figure><p id="1fb7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们从<code class="fe lk ll lm ln b">on</code>函数(第3行)中得到的减少器和动作被构建到动作类型和减少器(第5行)的映射中。返回一个新的reducer函数(第7行)。如果调度的动作在map中，那么它执行相关的reducer，否则返回原始状态。</p><h1 id="3f61" class="lx ly iq bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">摘要</h1><p id="9915" class="pw-post-body-paragraph jy jz iq ka b kb mv kd ke kf mw kh ki kj mx kl km kn my kp kq kr mz kt ku kv ij bi translated">首先，我们定义动作创建者:</p><pre class="lf lg lh li gt na ln nb nc aw nd bi"><span id="0c5f" class="ne ly iq ln b gy nf ng l nh ni">export const login = createAction(<br/>    '[Login Page] Login',<br/>    props&lt;{payload: {username: string; password: string;}}&gt;(),<br/>)</span></pre><p id="960a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后我们定义一个reducer，它执行<code class="fe lk ll lm ln b">ons</code>函数并在内部构建一个动作类型和reducer函数的映射:</p><pre class="lf lg lh li gt na ln nb nc aw nd bi"><span id="e002" class="ne ly iq ln b gy nf ng l nh ni">export const reducer = createReducer(<br/>  initialState,<br/>  on(AuthActions.login, (state, {username}) =&gt; <br/>     ({...state, user: username}))<br/>);</span></pre><p id="1260" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后我们调用我们的组件或服务:</p><pre class="lf lg lh li gt na ln nb nc aw nd bi"><span id="1046" class="ne ly iq ln b gy nf ng l nh ni">this.store.dispatch(AuthActions.logout())</span></pre><p id="564f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">动作创建器函数<code class="fe lk ll lm ln b">AuthActions.logout()</code>被执行，我们得到一个返回的<code class="fe lk ll lm ln b">TypedAction</code>，其类型属性等于“<em class="lr">[登录页面]登录</em>”。</p><p id="5a17" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Reducer然后遍历它的映射，试图为给定的类型找到一个reducer函数。当reducer被找到时，它被执行，否则返回状态对象。</p></div></div>    
</body>
</html>