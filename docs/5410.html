<html>
<head>
<title>ArgoCD backup cronjob — DRP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ArgoCD备份cronjob — DRP</h1>
<blockquote>原文：<a href="https://itnext.io/argocd-backup-cronjob-drp-ccfccc98be5c?source=collection_archive---------3-----------------------#2021-02-27">https://itnext.io/argocd-backup-cronjob-drp-ccfccc98be5c?source=collection_archive---------3-----------------------#2021-02-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d7306a0663e1fb80a6a52f8290a16008.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*goS5KAZW8bhKUFtj"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">凯利·西克玛在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><p id="dfca" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">当麻烦来临时，你最好做好准备。有一个灾难恢复计划将在未来的某一天拯救你。比如有人会不小心删除你的k8s集群会怎么样？如果您的组织使用GitOps部署风格，这本身就是一种DRP友好的部署方式，(所有k8s/helm yaml文件都安全地存储在git中)。ArgoCD会将这些文件应用到集群中。Argo是另一个可能被搞砸/删除的东西。它将自己的状态存储在k8s配置图、秘密和CRD的argocd-apps中。备份它们将使您能够恢复argo和所有应用程序安装它与一个单一的命令。</p><p id="6686" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">在这篇文章中，我将描述如何设置一个cronjob来备份GCP的argo日志。我们将进入k8s服务帐户，将GCP SA与KSA联系起来，以允许备份pod访问k8s配置地图和谷歌云存储。(对不起EKS用户……)</p><p id="7781" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated"><a class="ae kc" href="https://argoproj.github.io/argo-cd/operator-manual/server-commands/argocd-util/" rel="noopener ugc nofollow" target="_blank"> argocd-utils </a>是argo团队制作的一款便捷工具，可以从yaml文件导出/导入状态。它没有捆绑argocd二进制文件，为了在本地运行它，你需要一个docker镜像。</p><figure class="li lj lk ll gt jr"><div class="bz fp l di"><div class="lm ln l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">本地运行</figcaption></figure><p id="5eb5" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">为了让它在本地工作，你需要安装一个能够访问集群argocd的kubeconfig。</p><p id="7d7d" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">这很容易…现在让我们把它放在一个cronjob中并每天运行！为了实现这一点，我们首先需要一个<strong class="km ir"> Dockerfile </strong>，它将扩展argocd映像并在其上安装gcloud cli。</p><figure class="li lj lk ll gt jr"><div class="bz fp l di"><div class="lm ln l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">在argocd映像上安装gcloud cli</figcaption></figure><p id="2959" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">关于上面的一个小评论，ArgoCD镜像基于Ubuntu，运行apt需要<strong class="km ir">用户root </strong>。</p><figure class="li lj lk ll gt jr"><div class="bz fp l di"><div class="lm ln l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">备份脚本</figcaption></figure><p id="3ecf" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">请注意，备份脚本中没有任何与身份验证相关的内容，我们将使用一种巧妙的方式来允许我们的备份pod被授权访问k8s api和GCS，称为<a class="ae kc" href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity" rel="noopener ugc nofollow" target="_blank"> GCP工作负载身份</a>。总之。我们将创建一个k8s服务帐户，并将其绑定到一个可以访问k8s api的角色，我们还将创建一个GCP服务帐户，该帐户对包含我们的备份的GCS存储桶具有管理员访问权限。并将KSA绑定到GSA，以允许pod将两个服务帐户识别为一个帐户。</p><figure class="li lj lk ll gt jr"><div class="bz fp l di"><div class="lm ln l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">将GSA与KSA绑定</figcaption></figure><p id="5a63" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">让我们分解以上内容:</p><ul class=""><li id="f5ed" class="lo lp iq km b kn ko kr ks kv lq kz lr ld ls lh lt lu lv lw bi translated">创建GCS存储桶</li><li id="dd20" class="lo lp iq km b kn lx kr ly kv lz kz ma ld mb lh lt lu lv lw bi translated">创建GCP服务帐户</li><li id="1a81" class="lo lp iq km b kn lx kr ly kv lz kz ma ld mb lh lt lu lv lw bi translated">在存储桶上分配GCP SA对象管理角色</li><li id="53c2" class="lo lp iq km b kn lx kr ly kv lz kz ma ld mb lh lt lu lv lw bi translated">将GCP服务协议绑定到KSA服务协议(k8s服务帐户)</li><li id="cece" class="lo lp iq km b kn lx kr ly kv lz kz ma ld mb lh lt lu lv lw bi translated">测试任务有效</li></ul><p id="8695" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">在测试这个神奇的作品之前，您首先需要创建一个k8s SA，并用与GCP SA相同的名称对其进行注释。</p><figure class="li lj lk ll gt jr"><div class="bz fp l di"><div class="lm ln l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">sa+角色+tolebinding</figcaption></figure><p id="a2b8" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">上面重要的部分是ClusterRole规则，它使argocd-util能够访问相关的k8s api，以及ServiceAccount注释，GCP工作负载identity将使用该注释将KSA链接到我们前面创建的GSA。</p><p id="7bbb" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">如果到目前为止一切都做得正确，那么您应该能够运行Test命令并从test pod中列出空的GCS bucket。</p><p id="2d8b" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">最后一件事当然是将CronJob.yaml链接到KSA，并告诉它每天运行。</p><pre class="li lj lk ll gt mc md me mf aw mg bi"><span id="16c1" class="mh mi iq md b gy mj mk l ml mm"><em class="mn"># cronjob.yaml<br/>...<br/>schedule</em>: "0 0 * * *"<br/>...<br/>serviceAccount: stg-argocd-backup-eu-west1</span></pre><p id="4c4a" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">我们完了。</p><p id="bdc6" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">要从备份运行中恢复ArgoCD:</p><pre class="li lj lk ll gt mc md me mf aw mg bi"><span id="9342" class="mh mi iq md b gy mj mk l ml mm">argocd-util -n argocd import &lt; /backup/backup.yaml</span></pre><p id="3551" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">如果这篇文章帮助你离开，给我一个评论。</p><p id="7726" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">别忘了给仙人掌浇水。</p><p id="aba0" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">干杯。</p></div></div>    
</body>
</html>