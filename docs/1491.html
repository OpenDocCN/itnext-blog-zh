<html>
<head>
<title>Containerizing Serverless APIs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">容器化无服务器API</h1>
<blockquote>原文：<a href="https://itnext.io/containerizing-serverless-apis-d69fa3e6b9c2?source=collection_archive---------1-----------------------#2018-11-01">https://itnext.io/containerizing-serverless-apis-d69fa3e6b9c2?source=collection_archive---------1-----------------------#2018-11-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0ab7" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用Docker、LocalStack和无服务器框架进行本地开发</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/5b00c52bd0435641dc76ad38814d8da4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7M0snx4P30mYIdcK1Thi1Q.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">品牌积分— <a class="ae kv" href="https://www.docker.com/legal/brand-guidelines" rel="noopener ugc nofollow" target="_blank"> Docker </a>、<a class="ae kv" href="https://aws.amazon.com/trademark-guidelines/" rel="noopener ugc nofollow" target="_blank"> AWS </a>、<a class="ae kv" href="https://serverless.com/framework/" rel="noopener ugc nofollow" target="_blank"> Serverless </a>和<a class="ae kv" href="https://localstack.cloud/" rel="noopener ugc nofollow" target="_blank"> LocalStack </a>。</figcaption></figure><div class="kw kx gp gr ky kz"><a rel="noopener  ugc nofollow" target="_blank" href="/build-a-restful-api-using-aws-lambda-api-gateway-dynamodb-and-the-serverless-framework-30fc68e08a42"><div class="la ab fo"><div class="lb ab lc cl cj ld"><h2 class="bd ir gy z fp le fr fs lf fu fw ip bi translated">使用AWS Lambda、API Gateway、DynamoDB和无服务器框架构建RESTful API</h2><div class="lg l"><h3 class="bd b gy z fp le fr fs lf fu fw dk translated">更新日期:2018年10月17日。</h3></div><div class="lh l"><p class="bd b dl z fp le fr fs lf fu fw dk translated">itnext.io</p></div></div><div class="li l"><div class="lj l lk ll lm li ln kp kz"/></div></div></a></div><p id="7555" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在使用Contacts应用程序来使用我在上面文章中写的Contacts API时，我发现打开多个项目和终端来运行这个应用程序很麻烦。</p><p id="643e" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我将为DynamoDb jar文件运行一个终端，为无服务器离线模式下的API运行另一个终端，为实际的前端应用程序构建和运行再运行一个终端。</p><p id="ef91" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">为了帮助我专注于前端应用程序的开发，我决定在Docker容器中运行DynamoDb和我的无服务器API。这样，我可以让容器在后台运行，让它保存数据，并在我喜欢的时候轻松地拆除或重置它。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h2 id="7f62" class="mr ms iq bd mt mu mv dn mw mx my dp mz lx na nb nc mb nd ne nf mf ng nh ni nj bi translated">TL；速度三角形定位法(dead reckoning)</h2><p id="e255" class="pw-post-body-paragraph lo lp iq lq b lr nk jr lt lu nl ju lw lx nm lz ma mb nn md me mf no mh mi mj ij bi translated">从GitHub克隆<code class="fe np nq nr ns b"><a class="ae kv" href="https://github.com/vanister/contacts_api" rel="noopener ugc nofollow" target="_blank">contacts_api</a></code>项目并检查存储库。</p><p id="cbb7" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">用<code class="fe np nq nr ns b">docker-compose up -d</code>运行<code class="fe np nq nr ns b">docker-compose.yml</code>文件，这会创建两个容器，并在后台启动它们。一个容器应该在只启动DynamoDb服务的情况下使用LocalStack映像，另一个容器是运行带有<code class="fe np nq nr ns b">npm start</code>的<code class="fe np nq nr ns b">contacts_api</code>代码的节点容器。</p><p id="8964" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">一旦两个容器都启动并运行，执行seed命令为API播种一些数据。种子数据是<code class="fe np nq nr ns b">contacts_api</code>项目中的一个JSON文件。</p><pre class="kg kh ki kj gt nt ns nu nv aw nw bi"><span id="1c12" class="mr ms iq ns b gy nx ny l nz oa"># Do this each time <strong class="ns ir">docker-compose down</strong>, <br/># then <strong class="ns ir">docker-compose up</strong> is run.</span><span id="6c43" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">$ docker exec -it contacts_api npm run seed</strong></span><span id="3261" class="mr ms iq ns b gy ob ny l nz oa"># Test the API</span><span id="4987" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">$ curl -i localhost:3000/contacts</strong></span><span id="6d39" class="mr ms iq ns b gy ob ny l nz oa"># Should see an array of contacts</span></pre></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h2 id="ad65" class="mr ms iq bd mt mu mv dn mw mx my dp mz lx na nb nc mb nd ne nf mf ng nh ni nj bi translated">设置</h2><ul class=""><li id="f931" class="oc od iq lq b lr nk lu nl lx oe mb of mf og mj oh oi oj ok bi translated"><a class="ae kv" href="https://github.com/vanister/contacts_api" rel="noopener ugc nofollow" target="_blank">联系人API项目</a> —为其构建容器的项目。</li><li id="769e" class="oc od iq lq b lr ol lu om lx on mb oo mf op mj oh oi oj ok bi translated"><a class="ae kv" href="https://www.docker.com/get-started" rel="noopener ugc nofollow" target="_blank"> Docker </a> —为您的操作系统下载并安装Docker for Developers。</li><li id="5c4a" class="oc od iq lq b lr ol lu om lx on mb oo mf op mj oh oi oj ok bi translated"><a class="ae kv" href="https://hub.docker.com/r/localstack/localstack/" rel="noopener ugc nofollow" target="_blank"> LocalStack Docker映像</a> —使用它作为托管DynamoDb实例的映像。确保使用<code class="fe np nq nr ns b">localstack/localstack</code>图像。</li></ul><p id="d78b" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">从<code class="fe np nq nr ns b">contacts_api</code>项目中，在根目录下创建一个<code class="fe np nq nr ns b">Dockerfile</code>,并添加以下指令:</p><pre class="kg kh ki kj gt nt ns nu nv aw nw bi"><span id="8c94" class="mr ms iq ns b gy nx ny l nz oa"># File: ./Dockerfile</span><span id="7573" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">FROM node:8.12.0</strong></span><span id="c436" class="mr ms iq ns b gy ob ny l nz oa"># Copy the package.json and package.lock.json file to the image<br/><strong class="ns ir">WORKDIR /usr/src/app<br/>COPY package*.json ./</strong></span><span id="22b7" class="mr ms iq ns b gy ob ny l nz oa"># Run `npm install` to install the dependencies in the <br/># package.json file<br/><strong class="ns ir">RUN npm install</strong></span><span id="1560" class="mr ms iq ns b gy ob ny l nz oa"># Copy the contents of the project to the image<br/><strong class="ns ir">COPY . .</strong></span><span id="db66" class="mr ms iq ns b gy ob ny l nz oa"># This is the default port the serverless framework will <br/># listen on when it starts<br/><strong class="ns ir">EXPOSE 3000</strong></span><span id="77b9" class="mr ms iq ns b gy ob ny l nz oa"># These are just to remind me that these are the<br/># environment variables this project uses<br/><strong class="ns ir"># ENV AWS_ENDPOINT='http://localhost:8000'<br/># ENV AWS_REGION='us-west-1'<br/># ENV AWS_ACCESS_KEY_ID='from-dockerfile-fake-access-key'<br/># ENV AWS_SECRET_ACCESS_KEY='from-dockerfile-fake-secret-key'</strong></span><span id="3e53" class="mr ms iq ns b gy ob ny l nz oa"># Run 'npm start' when the container starts.<br/># This will start serverless, in offline mode, just like<br/># running the project from the terminal locally<strong class="ns ir"><br/>CMD [ "npm", "start" ]</strong></span></pre><p id="b6d5" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">接下来添加一个<code class="fe np nq nr ns b">.dockerignore</code>文件来忽略图像不需要的文件和文件夹。</p><pre class="kg kh ki kj gt nt ns nu nv aw nw bi"><span id="2ced" class="mr ms iq ns b gy nx ny l nz oa"># File: ./.dockerignore</span><span id="ea3d" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">.vscode/<br/>.serverless/</strong></span><span id="0d5b" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">coverage/<br/>node_modules/</strong></span><span id="cb9c" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">.env</strong></span></pre><p id="c181" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">创建了<code class="fe np nq nr ns b">Dockerfile</code>和<code class="fe np nq nr ns b">.dockerignore</code>文件后，添加一个<code class="fe np nq nr ns b">docker-compose.yml</code>文件来构建和运行容器。</p><p id="76e5" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">首先在与<code class="fe np nq nr ns b">Dockerfile</code>相同的位置创建一个<code class="fe np nq nr ns b">docker-compose.yml</code>文件，并向其中添加以下YAML代码:</p><pre class="kg kh ki kj gt nt ns nu nv aw nw bi"><span id="1c4d" class="mr ms iq ns b gy nx ny l nz oa"># File: ./docker-compose.yml</span><span id="a7c2" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">version: '3'</strong></span><span id="7200" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">services:<br/>  api:<br/>    </strong># Look for a Dockerfile at the the root<strong class="ns ir"><br/>    build: .</strong></span><span id="e071" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">    </strong># &lt;name&gt; can be the project name, username, anything...<strong class="ns ir"><br/>    image: &lt;name&gt;/contacts_api<br/>    depends_on:<br/>      - localstack<br/>    <br/>    </strong># Mapping port 3000 to the container's port 3000 since<br/>    # running `npm start` will start serverless offline on<br/>    # that port<strong class="ns ir"><br/>    ports:<br/>      - '3000:3000'<br/>    <br/>    container_name: contacts_api</strong></span><span id="1458" class="mr ms iq ns b gy ob ny l nz oa">    # These are the environment variables that are used by the api<br/>    <strong class="ns ir">environment:<br/></strong>      # The name of the localstack container is host for dynamodb<br/><strong class="ns ir">      AWS_ENDPOINT: '</strong><a class="ae kv" href="http://dynamodb_localstack:8000'" rel="noopener ugc nofollow" target="_blank"><strong class="ns ir">http://dynamodb_localstack:8000'</strong></a><strong class="ns ir"> <br/>      AWS_REGION: 'us-west-2'<br/></strong>      # leaving these blank will try and read from the terminal<br/><strong class="ns ir">      AWS_ACCESS_KEY_ID:<br/>      AWS_SECRET_ACCESS_KEY:</strong></span><span id="f491" class="mr ms iq ns b gy ob ny l nz oa">  # Use the LocalStack image to run DynamoDb in a container<strong class="ns ir"><br/>  localstack:<br/>    image: localstack/localstack:latest</strong></span><span id="5510" class="mr ms iq ns b gy ob ny l nz oa">    # Using port 8000 to be consistent with dynamodb local jar<br/>    # port 8080 is the localstack management portal<strong class="ns ir"><br/>    ports:</strong><br/>      <strong class="ns ir">- '8000:8000'<br/>      - '8080:8080'</strong></span><span id="d118" class="mr ms iq ns b gy ob ny l nz oa">    <strong class="ns ir">container_name: dynamodb_localstack<br/>    <br/>    </strong># Only interested in running dynamodb and having it<br/>    # persist data when the container is stopped<strong class="ns ir"><br/>    environment:<br/>      SERVICES: dynamodb:8000<br/>      DATA_DIR: '/tmp/localstack/data'</strong></span></pre><h2 id="cb2f" class="mr ms iq bd mt mu mv dn mw mx my dp mz lx na nb nc mb nd ne nf mf ng nh ni nj bi translated">构建并运行</h2><p id="0dfa" class="pw-post-body-paragraph lo lp iq lq b lr nk jr lt lu nl ju lw lx nm lz ma mb nn md me mf no mh mi mj ij bi translated">打开<code class="fe np nq nr ns b">docker-compose.yml</code>文件所在的终端窗口并运行:</p><pre class="kg kh ki kj gt nt ns nu nv aw nw bi"><span id="afd3" class="mr ms iq ns b gy nx ny l nz oa"># Terminal at ./contacts_api (where docker-compose.yml is located)<br/># the ordering of the print outs might be different</span><span id="1f38" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">$ docker-compose up </strong><br/># or to run in the background in detached mode:<br/><strong class="ns ir"># docker-compose up -d</strong></span><span id="bea1" class="mr ms iq ns b gy ob ny l nz oa"># Successful build and run output should look like this.<br/># Note - I've edited the output for brevity:</span><span id="7b61" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">Step 1/7 : FROM node:8.12.0<br/>Step 2/7 : WORKDIR /usr/src/app<br/>Step 3/7 : COPY package*.json ./<br/>Step 4/7 : RUN npm install</strong></span><span id="8a49" class="mr ms iq ns b gy ob ny l nz oa">...<br/>...</span><span id="e89e" class="mr ms iq ns b gy ob ny l nz oa"># Dependencies from the package.json from the contacts_api<br/># project are installed...</span><span id="42b9" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">added 887 packages from 585 contributors and audited 18846 packages in 21.944s</strong></span><span id="db38" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">Step 5/7 : COPY . .<br/>Step 6/7 : EXPOSE 3000<br/>Step 7/7 : CMD [ "npm", "start" ]</strong></span><span id="c6a1" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">Successfully tagged &lt;name&gt;/contacts_api:latest</strong></span><span id="cab7" class="mr ms iq ns b gy ob ny l nz oa"># The localstack image was already pulled to my machine</span><span id="a2bf" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">Creating dynamodb_localstack ... done<br/>Creating contacts_api        ... done</strong></span><span id="a1a8" class="mr ms iq ns b gy ob ny l nz oa">...<br/>...</span><span id="3038" class="mr ms iq ns b gy ob ny l nz oa"># LocalStack starting the admin portal on port 8080 <br/># like we told it to</span><span id="c553" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">dynamodb_localstack | 2018-10-30T04:46:20:INFO:werkzeug:  <br/>* Running on http://0.0.0.0:8080/ (Press CTRL+C to quit)</strong></span><span id="4fc2" class="mr ms iq ns b gy ob ny l nz oa"># LocalStack starting the DynamoDb service on port 8000</span><span id="4eb1" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">dynamodb_localstack | Starting mock DynamoDB (http port 8000)...<br/>dynamodb_localstack | Ready.</strong></span><span id="d885" class="mr ms iq ns b gy ob ny l nz oa">...</span><span id="43f0" class="mr ms iq ns b gy ob ny l nz oa"># This is the output from running `npm start` in the <br/># contacts_api container.  It is the same output<br/># as running `npm start` from the project directly</span><span id="ee85" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">contacts_api  | &gt; contacts-api@1.0.0 start /usr/src/app<br/>contacts_api  | &gt; sls offline start<br/>contacts_api  |<br/>contacts_api  | Serverless: Starting Offline: dev/us-west-2.<br/>contacts_api  | Serverless: Routes for list:<br/>contacts_api  | Serverless: GET /contacts<br/>contacts_api  |<br/>contacts_api  | Serverless: Routes for get:<br/>contacts_api  | Serverless: GET /contact/{id}<br/>contacts_api  |<br/>contacts_api  | Serverless: Routes for add:<br/>contacts_api  | Serverless: POST /contact<br/>contacts_api  |<br/>contacts_api  | Serverless: Routes for update:<br/>contacts_api  | Serverless: PUT /contact/{id}<br/>contacts_api  |<br/>contacts_api  | Serverless: Routes for delete:<br/>contacts_api  | Serverless: DELETE /contact/{id}<br/>contacts_api  |<br/>contacts_api  | Serverless: Offline listening on http://0.0.0.0:3000</strong></span></pre><p id="23d7" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在API可用之前，需要创建DynamoDb中的contacts表，并为其植入数据。在<code class="fe np nq nr ns b">contacts_api</code>项目中有一个create/seed脚本来做这件事，所以让我们利用它。</p><p id="1fa9" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">使用<code class="fe np nq nr ns b">(ctrl+p, ctrl+q)</code>或<code class="fe np nq nr ns b">ctrl+\</code>打开一个新的终端窗口或从连接到docker进程的终端分离/退出(最后一个可能不起作用)，并运行以下命令:</p><pre class="kg kh ki kj gt nt ns nu nv aw nw bi"><span id="b053" class="mr ms iq ns b gy nx ny l nz oa"># Execute the seed command against the contacts_api container</span><span id="0fc3" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">$ docker exec -it contacts_api npm run seed</strong></span><span id="705a" class="mr ms iq ns b gy ob ny l nz oa"># output from the 'seed' script in the project</span><span id="e3b7" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">&gt; contacts-api@1.0.0 seed /usr/src/app<br/>&gt; node ./seed/runner.js</strong></span><span id="de68" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">&gt;&gt; Checking if 'contacts' table exists<br/>&gt;&gt; Creating 'contacts' table<br/>&gt;&gt; Seeding data<br/>&gt;&gt; Done!</strong></span></pre><p id="7d82" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">作为健全性检查，尝试命中其中一个端点。如果没有错误消息，那么API正在按预期运行。</p><pre class="kg kh ki kj gt nt ns nu nv aw nw bi"><span id="2223" class="mr ms iq ns b gy nx ny l nz oa"><strong class="ns ir">$ curl -i localhost:3000/contacts</strong></span><span id="b1f3" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">HTTP/1.1 200 OK<br/>content-type: application/json; charset=utf-8<br/>cache-control: no-cache<br/>content-length: 411<br/>accept-ranges: bytes<br/>Date: Tue, 30 Oct 2018 05:18:34 GMT<br/>Connection: keep-alive</strong></span><span id="eac3" class="mr ms iq ns b gy ob ny l nz oa"><strong class="ns ir">[...array-of-seeded-contacts]</strong></span></pre><p id="4148" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">请注意，每次拆卸容器并使用<code class="fe np nq nr ns b">docker-compose down</code>和<code class="fe np nq nr ns b">docker-compose up</code>重新提起时，都需要播种DynamoDb。</p><p id="9963" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">要停止和启动容器，只需运行<code class="fe np nq nr ns b">docker-compose stop</code>和<code class="fe np nq nr ns b">docker-compose start</code>。</p><p id="b389" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">就是这样！现在容器在后台运行，我可以专注于开发使用API的应用程序。</p><p id="57f5" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">文章来源:<a class="ae kv" href="https://github.com/vanister/contacts_api" rel="noopener ugc nofollow" target="_blank">https://github.com/vanister/contacts_api</a></p></div></div>    
</body>
</html>