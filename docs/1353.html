<html>
<head>
<title>Istio ingress and the all-host gateway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Istio入口和全主机网关</h1>
<blockquote>原文：<a href="https://itnext.io/istio-ingress-and-the-all-host-gateway-b5c35781a7ba?source=collection_archive---------2-----------------------#2018-09-21">https://itnext.io/istio-ingress-and-the-all-host-gateway-b5c35781a7ba?source=collection_archive---------2-----------------------#2018-09-21</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><p id="003e" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">为了让Istio正确路由您的流量并应用管理员设置的所有规则，有必要让流量通过入口网关。然后，虚拟服务进行URL匹配，并将其分发到目标服务。</p><figure class="kn ko kp kq gu kr gi gj paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gi gj km"><img src="../Images/4048c7ef0ce21a79aecbab01956c472a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A-BuilIQLf3IPvgSAq9hIQ.png"/></div></div><figcaption class="ky kz gk gi gj la lb bd b be z dk translated">从入口网关到Bookinfo演示工作负载的数据流</figcaption></figure><p id="7109" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">以bookinfo为例。有一个bookinfo网关和一个虚拟服务bookinfo。首先是网关:</p><pre class="kn ko kp kq gu lc ld le lf aw lg bi"><span id="c555" class="lh li ir ld b gz lj lk l ll lm"><strong class="ld is">apiVersion: </strong>networking.istio.io/v1alpha3<br/><strong class="ld is">kind: </strong>Gateway<br/><strong class="ld is">metadata:<br/>  name: </strong>bookinfo-gateway<br/><strong class="ld is">spec:<br/>  servers:<br/>  </strong>- <strong class="ld is">hosts:<br/>      </strong>- "*"<br/>  - <strong class="ld is">port:<br/>      number: </strong>80<br/>      <strong class="ld is">name: </strong>http<br/>      <strong class="ld is">protocol: </strong>HTTP</span></pre><p id="33fb" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">您可以看到，为了使用internal / pseudeo-DNS，它与*匹配，以允许所有主机使用。虚拟bookinfo服务看起来像这样:</p><pre class="kn ko kp kq gu lc ld le lf aw lg bi"><span id="d7ca" class="lh li ir ld b gz lj lk l ll lm"><strong class="ld is">apiVersion: </strong>networking.istio.io/v1alpha3<br/><strong class="ld is">kind: </strong>VirtualService<br/><strong class="ld is">metadata:<br/>  name: </strong>bookinfo-vs<br/><strong class="ld is">spec:<br/>  hosts:<br/>  </strong>- "*"<br/>  <strong class="ld is">gateways:<br/>  </strong>- bookinfo-gateway<br/>  <strong class="ld is">http:<br/>  </strong>- <strong class="ld is">match:<br/>    </strong>- <strong class="ld is">uri:<br/>        exact: </strong>/productpage</span></pre><p id="946d" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">可以看到它引用了bookinfo-gateway，然后通过http.match.uri分派到/productpage。</p><h1 id="032c" class="ln li ir bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">现在我的另一个应用</h1><p id="16b3" class="pw-post-body-paragraph jo jp ir jq b jr mk jt ju jv ml jx jy jz mm kb kc kd mn kf kg kh mo kj kk kl ik bi translated">现在，我在一个不同的名称空间中部署了第二个应用程序，它在自己的配置中对Ingress做了同样的事情。这里我只展示虚拟服务:</p><pre class="kn ko kp kq gu lc ld le lf aw lg bi"><span id="f719" class="lh li ir ld b gz lj lk l ll lm"><strong class="ld is">apiVersion: </strong>networking.istio.io/v1alpha3<br/><strong class="ld is">kind: </strong>VirtualService<br/><strong class="ld is">metadata:<br/>  name: </strong>mp-servicemesh-sample<br/><strong class="ld is">spec:<br/>  hosts:<br/>  </strong>- "*"<br/>  <strong class="ld is">gateways:<br/>  </strong>- mp-servicemesh-sample-gateway<br/>  <strong class="ld is">http:<br/>  </strong>- <strong class="ld is">match:<br/>    </strong>- <strong class="ld is">uri:<br/>        prefix: </strong>/mp-servicemesh-sample</span></pre><p id="d0eb" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">当我点击http://istio-Ingres gateway-istio-system . 172 . 31 . 7 . 9 . nip . io/MP-service mesh-sample/service a时，浏览器中出现了一个空白页面。这看起来不太好。</p><p id="553b" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">调查和打探显示，来自上面的bookinfo的第一个网关正在吞噬所有流量。删除bookinfo网关会立即使对…/serviceA的调用成功。</p><h1 id="bacb" class="ln li ir bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">一个可能的解决方案</h1><p id="2bb2" class="pw-post-body-paragraph jo jp ir jq b jr mk jt ju jv ml jx jy jz mm kb kc kd mn kf kg kh mo kj kk kl ik bi translated">当然，正确设置DNS而不使用Host *是正确的解决方案，但在有些情况下(例如开发、内部主机)，这并不容易做到。</p><p id="2a11" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">对我来说，实际上只设置了一个网关(我保留了一个bookinfo ),并且在网关后面也只有一个虚拟服务，它相应地分派请求:</p><pre class="kn ko kp kq gu lc ld le lf aw lg bi"><span id="55d7" class="lh li ir ld b gz lj lk l ll lm"><strong class="ld is">apiVersion: </strong>networking.istio.io/v1alpha3<br/><strong class="ld is">kind: </strong>VirtualService<br/><strong class="ld is">spec:<br/>  gateways:<br/>  </strong>- bookinfo-gateway<br/>  <strong class="ld is">hosts:<br/>  </strong>- '*'<br/>  <strong class="ld is">http:<br/>  </strong>- <strong class="ld is">match:<br/>    </strong>- <strong class="ld is">uri:<br/>        exact: </strong>/productpage<br/>    <strong class="ld is">route:<br/>    </strong>- <strong class="ld is">destination:<br/>        host: </strong>productpage<br/>        <strong class="ld is">port:<br/>          number: </strong>9080<br/>  - <strong class="ld is">match:<br/>    </strong>- <strong class="ld is">uri:<br/>        prefix: </strong>/mp-servicemesh-sample/serviceA<br/>    <strong class="ld is">route:<br/>    </strong>- <strong class="ld is">destination:<br/>        host: </strong>servicea-service.myproject.svc.cluster.local</span></pre><p id="d754" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">您可以看到/productpage转到了productpage目标。</p><p id="9818" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">和/MP-service mesh-sample/serviceA转到servicea-service。实际上与上面不同的是，我用名称空间(“myproject”)和svc.cluster.local完全限定了servicea-service。在这种情况下，Istio没有附加名称空间，虚拟服务在其中，而是直接路由到目的主机。</p><figure class="kn ko kp kq gu kr gi gj paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gi gj mq"><img src="../Images/4e3868ee5be441d181213d5478b87784.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rEtG1Epwi-b9k8_C5p7rrg.png"/></div></div><figcaption class="ky kz gk gi gj la lb bd b be z dk translated"><a class="ae mp" href="https://www.kiali.io/" rel="noopener ugc nofollow" target="_blank"> Kiali </a>显示从入口到产品页面和服务a的流量</figcaption></figure><p id="3a64" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">前面的屏幕截图现在显示了最终结果，其中流量从Istio Ingress网关流向Bookinfo的productpage和myproject中的serviceA。</p><p id="2b6c" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">当然，只有当不同的应用程序没有相同的路由前缀时，这种“技巧”才会起作用。如果两者都有<em class="mr">/登录</em>，那么我们仍然会失败。</p><h1 id="4536" class="ln li ir bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">有没有更好的办法？</h1><p id="a0d9" class="pw-post-body-paragraph jo jp ir jq b jr mk jt ju jv ml jx jy jz mm kb kc kd mn kf kg kh mo kj kk kl ik bi translated">以上可能不是实现目标的最佳方法——这是一种对我有效的方法(所以我把它写下来，以备下次需要时使用:)<br/>请告诉我这里还可以做些什么。</p></div></div>    
</body>
</html>