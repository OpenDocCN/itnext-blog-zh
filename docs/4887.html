<html>
<head>
<title>Eatware — Creation of a flexible, modular bot with Dialogflow and FastAPI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">eatware——使用Dialogflow和FastAPI创建灵活的模块化机器人</h1>
<blockquote>原文：<a href="https://itnext.io/eatware-creation-of-a-flexible-modular-bot-with-dialogflow-and-fastapi-a11b19fa8b25?source=collection_archive---------2-----------------------#2020-10-16">https://itnext.io/eatware-creation-of-a-flexible-modular-bot-with-dialogflow-and-fastapi-a11b19fa8b25?source=collection_archive---------2-----------------------#2020-10-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0755" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">我们如何在两天内制作了一个Slackbot来为我们计划团队午餐。</h2></div><p id="a3cc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">编剧:<a class="ae lb" href="https://twitter.com/jincontroller" rel="noopener ugc nofollow" target="_blank">金正</a>、<a class="ae lb" href="https://github.com/TsyooHUB" rel="noopener ugc nofollow" target="_blank">托马斯·尤</a>、<a class="ae lb" href="https://github.com/biggestcookie" rel="noopener ugc nofollow" target="_blank">保罗·汉萨</a>。</p><h1 id="9181" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">背景</h1><p id="b923" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">当我们真正在办公室的时候，我们的团队效率被一个重复出现的问题所困扰——我们从来不知道我们想去哪里吃饭。团队午餐变成了一个很难计划的任务，但是作为开发人员，我们有很大的权力和责任用新的和流行的技术来自动化琐碎的问题。</p><p id="e647" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">随着我们在NCR的最新内部黑客马拉松，我们有机会用Slack进行黑客攻击，并在Slack团队的帮助和建议下创建Slack应用程序。我们的黑客马拉松团队聚集在一起，在我们的Slack workspace中一劳永逸地创建了这个问题的解决方案。通过使用<a class="ae lb" href="https://cloud.google.com/dialogflow" rel="noopener ugc nofollow" target="_blank"> Dialogflow </a>，一个为将自然语言集成到应用程序中提供接口的平台，以及<a class="ae lb" href="https://fastapi.tiangolo.com/" rel="noopener ugc nofollow" target="_blank"> FastAPI </a>，一个用于Python的简单而高性能的API框架，我们能够轻松地创建一个交互式聊天机器人，名为Eatware，它将执行我们的命令。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/12577ef7c61bcc25ac0d5b644ba35fdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:950/1*veoKhx8pq9dKfXFOf9ly_A.gif"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">如果你不知道去哪里吃饭，试试Eatware！</figcaption></figure><p id="235c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面是我们如何使用这三种技术快速设置我们的应用程序。</p><h1 id="4b00" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">应用程序结构</h1><p id="47a0" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">我们可以将应用程序结构分成三层:</p><ul class=""><li id="e171" class="ml mm iq kh b ki kj kl km ko mn ks mo kw mp la mq mr ms mt bi translated"><strong class="kh ir">我们的表示层Slack</strong>允许用户与机器人交互，并从机器人接收信息。</li><li id="82ab" class="ml mm iq kh b ki mu kl mv ko mw ks mx kw my la mq mr ms mt bi translated"><strong class="kh ir">我们的语言处理层Dialogflow，</strong>直接从Slack接收消息信息并解析。</li><li id="20a0" class="ml mm iq kh b ki mu kl mv ko mw ks mx kw my la mq mr ms mt bi translated"><strong class="kh ir">我们的后端层，Eatware API，</strong>从Dialogflow接收webhook请求，从外部API提取餐馆信息，并将结果发送回Slack。</li></ul><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/21e5d5c536aa5ec904aff13fbafa3466.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YsMElnkdvwOSQdpZN2ZGwA.jpeg"/></div></div></figure><p id="314d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从表示层开始，我们让用户提示机器人开始体验。我们认为用户需要用自然语言与机器人交谈是体验的核心部分，所以它自然地融入了团队频道的对话(这也是使用该技术的一个有趣的借口)。</p><p id="5168" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">用户给机器人贴上标签，用自然语言询问它他们正在寻找食物。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/037516a9a7731cc99feb552fa9570f15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1178/0*M0uxdXZo3hkEvOK4"/></div></figure><p id="c9d0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">语言处理层Dialogflow配置了Slack来读取所有提到注册的@Eatware应用程序的请求。它读取句子，并使用我们训练它的信息来识别用户的意图和他们可能提供的任何参数。Dialogflow将在对话流中做出响应，提示用户任何缺失的参数，当它达到满意的程度时，它将对我们选择的位置进行webhook调用。在我们的例子中，我们设置了一个API来接收这个调用。</p><p id="b586" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们的后端层是用FastAPI构建的，它从用户那里接收现在已经完成的有效负载参数，并用我们的餐馆搜索词调用外部服务。执行这个调用后，我们的API将外部响应映射到Slack有效负载，并将响应发送到Slack，以便作为bot进行响应。</p><p id="3e6c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">既然我们已经介绍了应用程序是如何设置的，那么让我们进入每个部分的更详细的细节。</p><h1 id="9647" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">对话流</h1><p id="ec24" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">Dialogflow是一个端到端的开发工具，用于为网站和应用程序创建对话界面。它还可用于与多种平台接口，包括脸书、线路、电报等。对于我们的特定项目，我们集成了Slack，这允许我们与同事直接测试功能。</p><p id="2589" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Eatware上的Dialogflow是我们应用程序的中间层，它从Slack灵活地接收用户输入，从语句中解析出相关信息，然后作为webhook请求发送给我们的API。当API返回一个响应时，Dialogflow获取信息，将它组合成一种用户友好的格式，然后作为Slack消息输出给用户。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nf"><img src="../Images/3e40cb134f53ae86bb3e101c3a27fb6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*94evYjdS7pKdOc9NRoBvEg.png"/></div></div></figure><p id="db91" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里的主要因素是训练我们的Dialogflow代理识别用户可能说的常见句型，并确定属于某一类别的关键字。</p><p id="ba6a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当出现这样的句子时:</p><blockquote class="ng nh ni"><p id="0acd" class="kf kg nj kh b ki kj jr kk kl km ju kn nk kp kq kr nl kt ku kv nm kx ky kz la ij bi translated">“帮我在附近找一家价格实惠的中国餐馆”</p></blockquote><p id="31b9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Dialogflow最初不会将关键字识别为有意义的数据。然而，通过在它的字典中设置几个词来手动训练它，例如“负担得起=价格”、“中国=食物偏好”和“附近=地址”，句子就成为我们的代理可以解析的参数。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nn"><img src="../Images/0c253238f9f29c04a7200ce311487298.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T8p6CYDi1u4vlRW8zDXPEg.png"/></div></div></figure><p id="4282" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于它的检测功能，我们不必单独将每个单词绑定到一个类别；当Dialogflow找到相似的句子结构时，它会尝试自己这么做。因此，下次当我们要求机器人“帮我在亚特兰大找到一家昂贵的意大利餐馆”时，代理会检测到句子中的相似之处，推断出用户的意图，并已经正确地假设了各自的类别。与所有机器学习一样，Dialogflow通过日常使用和用户反馈来提高其NLP能力。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi no"><img src="../Images/a2e552d193e737da7ac9717bf65bb368.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZUgBetaGp4z4X8nt5NQv6A.png"/></div></div></figure><p id="a740" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦确定了参数，我们可以允许Dialogflow将这些参数传递给后端层的<a class="ae lb" href="https://cloud.google.com/dialogflow/es/docs/fulfillment-overview" rel="noopener ugc nofollow" target="_blank"> fulfillment webhook请求</a>。</p><h1 id="88f9" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">后端</h1><p id="a8a0" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">对于我们的后端，我们很高兴选择FastAPI，这是一个现代的Python web API框架。它利用了Python最近的类型提示特性，并通过<a class="ae lb" href="https://fastapi.tiangolo.com/python-types/#pydantic-models" rel="noopener ugc nofollow" target="_blank"> Pydantic </a>提供了简单的模型创建，这提供了有用的IDE类型错误报告以及自动请求/响应验证。</p><p id="b606" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们首先设置一个POST路由来接收Dialogflow的webhook请求。当Dialogflow将参数传递给Eatware的API时，我们向Dialogflow返回一个初始响应，Dialogflow将这个响应转发给Slack，以便dialog flow和用户都知道他们的请求被成功接收。同时，FastAPI的<a class="ae lb" href="https://fastapi.tiangolo.com/tutorial/background-tasks/" rel="noopener ugc nofollow" target="_blank">后台任务</a>处理我们获取餐馆信息的外部调用。</p><figure class="ma mb mc md gt me"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="6646" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们的案例中，我们选择Yelp作为我们的外部服务，因为它可以免费使用，易于上手，并且是一个成熟的平台。</p><figure class="ma mb mc md gt me"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="886b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">收到Yelp的回复后，我们将其很好地格式化成Slack的<a class="ae lb" href="https://api.slack.com/block-kit" rel="noopener ugc nofollow" target="_blank"> Block Kit </a>，这是一个用于在消息中创建自定义视觉效果和交互性的组件集合。对我们来说，这意味着解析我们的Yelp响应，获取评级、距离和餐馆信息，并将它们一起放入块格式中，以创建一个吸引人的可视化和餐馆基本细节和联系信息的摘要。</p><figure class="ma mb mc md gt me"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="3948" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，创建的块被发送到我们的Slack bot，在那里它将块显示为一条消息。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nr"><img src="../Images/ac44909751bf1f453f73a328c1f95763.png" data-original-src="https://miro.medium.com/v2/resize:fit:1338/format:webp/1*wmCu8FzmmJstMYn62T54cw.png"/></div></div></figure><h1 id="cca2" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">结论</h1><p id="1b76" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">我们在使用Slack、Dialogflow和FastAPI进行开发时度过了美好的时光，并且发现将它们结合在一起相当容易。NCR黑客马拉松为我们的团队提供了一个探索新技术的绝佳机会，我们肯定会在未来重新审视这些新技术。</p><p id="a982" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于GCP的Dialogflow提供的灵活性和我们API的模块化，我们可以很容易地添加对许多其他平台的支持。通过将我们的外部呼叫实现为服务，我们可以将Yelp的使用换成另一种服务，例如NCR自己的内部餐厅API，或者选择通过Slack之外的另一个聊天应用程序进行交互。</p><p id="d2c6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您想亲自查看API，下面提供了我们的源代码！</p><div class="ns nt gp gr nu nv"><a href="https://github.com/biggestcookie/Eatware" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd ir gy z fp oa fr fs ob fu fw ip bi translated">餐具</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">Eatware是一个Slackbot，它可以帮助你和你的团队找到附近的就餐地点并进行投票。专为NCR开发…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">github.com</p></div></div><div class="oe l"><div class="of l og oh oi oe oj mf nv"/></div></div></a></div><h2 id="1fc9" class="ok ld iq bd le ol om dn li on oo dp lm ko op oq lo ks or os lq kw ot ou ls ov bi translated">关于作者</h2><p id="5cf3" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">Paul、Jin和Thomas是的应届毕业生和软件工程师。除了使用NCR酒店与便利和燃油零售解决方案开发应用程序，他们还喜欢玩格斗游戏和创建有趣的新web应用程序。</p></div></div>    
</body>
</html>