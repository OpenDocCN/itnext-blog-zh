<html>
<head>
<title>Integrating Vertx application with Weld/CDI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Vertx应用程序与Weld/CDI集成</h1>
<blockquote>原文：<a href="https://itnext.io/integrating-vertx-application-with-weld-cdi-53a7617bd963?source=collection_archive---------7-----------------------#2021-07-23">https://itnext.io/integrating-vertx-application-with-weld-cdi-53a7617bd963?source=collection_archive---------7-----------------------#2021-07-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d2a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上一篇文章中，我们介绍了一种将Vertx应用程序与Spring框架集成的简单方法。在这篇文章中，我们将尝试将Vertx应用程序与<a class="ae kl" href="https://www.cdi-spec.org" rel="noopener ugc nofollow" target="_blank"> CDI </a>集成，以取代Spring。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/b1d8b503bf19b0363061a113a4601ccd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IVMaWX4HIdNF5Aw45m5nCQ.jpeg"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated"><a class="ae kl" href="https://unsplash.com/@robynnexy?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Robynne Hu </a>在<a class="ae kl" href="https://unsplash.com/s/photos/china-landscape?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><blockquote class="lc ld le"><p id="3728" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated">CDI是Java EE 6中引入的依赖和注入规范，目前Java EE被重命名为Jakarta EE，由Eclipse Foundation维护。Weld是Jakarta CDI规范的兼容提供商。</p></blockquote><p id="05d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">添加下列依赖项。</p><pre class="kn ko kp kq gt lj lk ll lm aw ln bi"><span id="ad2c" class="lo lp iq lk b gy lq lr l ls lt">&lt;dependency&gt;<br/>    &lt;groupId&gt;org.jboss.weld.se&lt;/groupId&gt;<br/>    &lt;artifactId&gt;weld-se-shaded&lt;/artifactId&gt;<br/>    &lt;version&gt;${weld.version}&lt;/version&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;org.jboss&lt;/groupId&gt;<br/>    &lt;artifactId&gt;jandex&lt;/artifactId&gt;<br/>    &lt;version&gt;2.2.3.Final&lt;/version&gt;<br/>&lt;/dependency&gt;</span></pre><p id="f64d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的代码中:</p><ul class=""><li id="6357" class="lu lv iq jp b jq jr ju jv jy lw kc lx kg ly kk lz ma mb mc bi translated"><code class="fe md me mf lk b">weld-se-shaded</code>为Java SE平台提供了CDI运行时环境。</li><li id="f8f8" class="lu lv iq jp b jq mg ju mh jy mi kc mj kg mk kk lz ma mb mc bi translated"><code class="fe md me mf lk b">jandex</code>将索引应用程序中的类并加速bean搜索。</li></ul><p id="a01a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<em class="lf">main/resources/META-INF</em>文件夹中添加一个空的<code class="fe md me mf lk b">beans.xml</code>配置，以便在Java SE应用程序中启用CDI支持。</p><pre class="kn ko kp kq gt lj lk ll lm aw ln bi"><span id="25a5" class="lo lp iq lk b gy lq lr l ls lt">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br/>&lt;beans<br/>        <br/>        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br/>        xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee<br/>                      http://xmlns.jcp.org/xml/ns/javaee/beans_2_0.xsd"<br/>        bean-discovery-mode="annotated"&gt;<br/>&lt;/beans&gt;</span></pre><blockquote class="lc ld le"><p id="b3ce" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq">在Java EE/Jakarta EE世界中，从Java EE 7开始默认启用CDI，beans.xml配置文件是可选的。</em></p></blockquote><p id="83c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">类似于Spring版本，增加一个<code class="fe md me mf lk b">DemoApplication</code>来启动应用。</p><pre class="kn ko kp kq gt lj lk ll lm aw ln bi"><span id="d295" class="lo lp iq lk b gy lq lr l ls lt">public class DemoApplication {</span><span id="cb9d" class="lo lp iq lk b gy ml lr l ls lt">    private final static Logger LOGGER = Logger.getLogger(DemoApplication.class.getName());</span><span id="edee" class="lo lp iq lk b gy ml lr l ls lt">    public static void main(String[] args) {<br/>        var weld = new Weld();<br/>        var container = weld.initialize();<br/>        var vertx = container.select(Vertx.class).get();<br/>        var factory = container.select(VerticleFactory.class).get();</span><span id="20d7" class="lo lp iq lk b gy ml lr l ls lt">        LOGGER.info("vertx clazz:" + vertx.getClass().getName());//Weld does not create proxy classes at runtime on @Singleton beans.<br/>        LOGGER.info("factory clazz:" + factory.getClass().getName());<br/>        // deploy MainVerticle via verticle identifier name<br/>        //var deployOptions = new DeploymentOptions().setInstances(4);<br/>        vertx.deployVerticle(factory.prefix() + ":" + MainVerticle.class.getName());<br/>    }<br/>}</span></pre><p id="7ae8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我们使用<code class="fe md me mf lk b">weld.initialize()</code>来初始化CDI容器。然后取回<code class="fe md me mf lk b">Vertx</code> bean和<code class="fe md me mf lk b">VerticleFactory</code> bean，开始部署<code class="fe md me mf lk b">MainVerticle</code>。</p><p id="a1aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与<code class="fe md me mf lk b">SpringAwareVerticleFactory</code>类似，创建CDI aware <code class="fe md me mf lk b">VerticleFactory</code>。</p><pre class="kn ko kp kq gt lj lk ll lm aw ln bi"><span id="37f2" class="lo lp iq lk b gy lq lr l ls lt">@ApplicationScoped<br/>public class CdiAwareVerticleFactory implements VerticleFactory {<br/>    <br/>    @Inject<br/>    private Instance&lt;Object&gt; instance;</span><span id="9956" class="lo lp iq lk b gy ml lr l ls lt">    @Override<br/>    public String prefix() {<br/>        return "cdi";<br/>    }</span><span id="0fa7" class="lo lp iq lk b gy ml lr l ls lt">    @Override<br/>    public void createVerticle(String verticleName, ClassLoader classLoader, Promise&lt;Callable&lt;Verticle&gt;&gt; promise) {<br/>        String clazz = VerticleFactory.removePrefix(verticleName);<br/>        promise.complete(() -&gt; (Verticle) instance.select(Class.forName(clazz)).get());<br/>    }<br/>}</span></pre><p id="eb0c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个简单的<code class="fe md me mf lk b">Resources</code>类并公开<code class="fe md me mf lk b">Vertx</code>和<code class="fe md me mf lk b">PgPool</code>bean。</p><pre class="kn ko kp kq gt lj lk ll lm aw ln bi"><span id="7103" class="lo lp iq lk b gy lq lr l ls lt">@ApplicationScoped<br/>public class Resources {<br/>    private final static Logger LOGGER = Logger.getLogger(Resources.class.getName());</span><span id="c3fa" class="lo lp iq lk b gy ml lr l ls lt">    @Produces<br/>    @Singleton<br/>    public Vertx vertx(VerticleFactory verticleFactory) {<br/>        Vertx vertx = Vertx.vertx();<br/>        vertx.registerVerticleFactory(verticleFactory);<br/>        return vertx;<br/>    }</span><span id="a473" class="lo lp iq lk b gy ml lr l ls lt">    @Produces<br/>    public PgPool pgPool(Vertx vertx) {<br/>        PgConnectOptions connectOptions = new PgConnectOptions()<br/>            .setPort(5432)<br/>            .setHost("localhost")<br/>            .setDatabase("blogdb")<br/>            .setUser("user")<br/>            .setPassword("password");</span><span id="543b" class="lo lp iq lk b gy ml lr l ls lt">        // Pool Options<br/>        PoolOptions poolOptions = new PoolOptions().setMaxSize(5);</span><span id="8a2b" class="lo lp iq lk b gy ml lr l ls lt">        // Create the pool from the data object<br/>        PgPool pool = PgPool.pool(vertx, connectOptions, poolOptions);</span><span id="fade" class="lo lp iq lk b gy ml lr l ls lt">        return pool;<br/>    }</span><span id="7b32" class="lo lp iq lk b gy ml lr l ls lt">    public void disposesPgPool(@Disposes PgPool pgPool) {<br/>        LOGGER.info("disposing PgPool...");<br/>        pgPool.close().onSuccess(v -&gt; LOGGER.info("PgPool is closed successfully."));<br/>    }<br/>}</span></pre><p id="a019" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其他豆和Spring版本差不多，只是用CDI <code class="fe md me mf lk b">@ApplicaitonScoped</code>代替了Spring <code class="fe md me mf lk b">@Component</code>。</p><pre class="kn ko kp kq gt lj lk ll lm aw ln bi"><span id="aadb" class="lo lp iq lk b gy lq lr l ls lt">@ApplicationScoped<br/>@RequiredArgsConstructor<br/>public class MainVerticle extends AbstractVerticle {<br/>    final PostsHandler postHandlers;<br/>    <br/>    //...<br/>}</span><span id="cad9" class="lo lp iq lk b gy ml lr l ls lt">@ApplicationScoped<br/>@RequiredArgsConstructor<br/>class PostsHandler {<br/>    private final PostRepository posts;<br/>    <br/>    //...<br/>}</span><span id="5fca" class="lo lp iq lk b gy ml lr l ls lt">@ApplicationScoped<br/>@RequiredArgsConstructor<br/>public class PostRepository {</span><span id="4f3e" class="lo lp iq lk b gy ml lr l ls lt">    private final PgPool client;<br/>    <br/>    //...<br/>}</span><span id="d143" class="lo lp iq lk b gy ml lr l ls lt">@ApplicationScoped<br/>@RequiredArgsConstructor<br/>public class DataInitializer {</span><span id="9001" class="lo lp iq lk b gy ml lr l ls lt">    private  final PgPool client;<br/>    <br/>    //...<br/>}</span></pre><p id="700d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，在上面的<code class="fe md me mf lk b">Resources</code>类中，我们给<code class="fe md me mf lk b">Vertx</code>添加了一个<code class="fe md me mf lk b">@Singleton</code>，与<code class="fe md me mf lk b">ApplicationScoped</code>略有不同，Weld并没有为它创建代理对象。</p><blockquote class="lc ld le"><p id="ab92" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq">这里我们必须在Vertx bean上添加</em> <code class="fe md me mf lk b"><em class="iq">@Singleton</em></code> <em class="iq">，否则在应用程序启动阶段会出现向</em> <code class="fe md me mf lk b"><em class="iq">VertxImpl</em></code> <em class="iq">的转换错误，因为CDI不会为</em> <code class="fe md me mf lk b"><em class="iq">VertxImpl</em></code> <em class="iq">创建代理bean。</em></p></blockquote><p id="ffc6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe md me mf lk b">DemoApplication</code>中，我们添加了一些日志来打印<code class="fe md me mf lk b">Vertx</code>和<code class="fe md me mf lk b">VerticleFactory</code>bean的类名。当启动应用程序时，在控制台中，您将看到如下的类名。</p><pre class="kn ko kp kq gt lj lk ll lm aw ln bi"><span id="c6c3" class="lo lp iq lk b gy lq lr l ls lt">//..<br/>INFO: vertx clazz:io.vertx.core.impl.VertxImpl<br/>//...<br/>INFO: factory clazz:com.example.demo.CdiAwareVerticleFactory$Proxy$_$$_WeldClientProxy</span></pre><p id="83b1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">默认情况下，CDI将为所有beans创建代理类，但是如果用<code class="fe md me mf lk b">@Singletone</code>注释，它将直接使用实例。</p><p id="f35c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了测试应用程序，将下面的依赖项添加到<em class="lf">测试</em>范围中。</p><pre class="kn ko kp kq gt lj lk ll lm aw ln bi"><span id="4a79" class="lo lp iq lk b gy lq lr l ls lt">&lt;dependency&gt;<br/>    &lt;groupId&gt;org.jboss.weld&lt;/groupId&gt;<br/>    &lt;artifactId&gt;weld-junit5&lt;/artifactId&gt;<br/>    &lt;version&gt;2.0.2.Final&lt;/version&gt;<br/>    &lt;scope&gt;test&lt;/scope&gt;<br/>    &lt;exclusions&gt;<br/>        &lt;exclusion&gt;<br/>            &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;<br/>            &lt;artifactId&gt;junit-jupiter-api&lt;/artifactId&gt;<br/>        &lt;/exclusion&gt;<br/>        &lt;exclusion&gt;<br/>            &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;<br/>            &lt;artifactId&gt;junit-jupiter-engine&lt;/artifactId&gt;<br/>        &lt;/exclusion&gt;<br/>    &lt;/exclusions&gt;<br/>&lt;/dependency&gt;</span></pre><p id="89bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与Spring版本类似，在运行测试之前，在JUnit <code class="fe md me mf lk b">@BeforeAll</code>钩子中手动部署<code class="fe md me mf lk b">Verticle</code>。</p><pre class="kn ko kp kq gt lj lk ll lm aw ln bi"><span id="3a48" class="lo lp iq lk b gy lq lr l ls lt">@EnableAutoWeld<br/>@AddPackages(DemoApplication.class)<br/>@TestInstance(TestInstance.Lifecycle.PER_CLASS)<br/>@ExtendWith(VertxExtension.class)<br/>public class TestMainVerticle {<br/>    private final static Logger LOGGER = Logger.getLogger(TestMainVerticle.class.getName());</span><span id="8735" class="lo lp iq lk b gy ml lr l ls lt">    @Inject<br/>    Instance&lt;Object&gt; context;</span><span id="2e94" class="lo lp iq lk b gy ml lr l ls lt">    Vertx vertx;</span><span id="fa13" class="lo lp iq lk b gy ml lr l ls lt">    @BeforeAll<br/>    public void setupAll(VertxTestContext testContext) {<br/>        vertx = context.select(Vertx.class).get();<br/>        var factory = context.select(VerticleFactory.class).get();<br/>        vertx.deployVerticle(factory.prefix() + ":" + MainVerticle.class.getName())<br/>            .onSuccess(id -&gt; {<br/>                LOGGER.info("deployed:" + id);<br/>                testContext.completeNow();<br/>            });<br/>    }</span><span id="57f1" class="lo lp iq lk b gy ml lr l ls lt">    @Test<br/>    public void testVertx(VertxTestContext testContext) {<br/>        assertThat(vertx).isNotNull();<br/>        testContext.completeNow();<br/>    }<br/></span><span id="dbb6" class="lo lp iq lk b gy ml lr l ls lt">    @Test<br/>    void testGetAll(VertxTestContext testContext) {<br/>        LOGGER.log(Level.INFO, "running test: {0}", "testGetAll");<br/>        var options = new HttpClientOptions()<br/>            .setDefaultPort(8888);<br/>        var client = vertx.createHttpClient(options);</span><span id="91ea" class="lo lp iq lk b gy ml lr l ls lt">        client.request(HttpMethod.GET, "/posts")<br/>            .flatMap(req -&gt; req.send().flatMap(HttpClientResponse::body))<br/>            .onSuccess(<br/>                buffer -&gt; testContext.verify(<br/>                    () -&gt; {<br/>                        LOGGER.log(Level.INFO, "response buffer: {0}", new Object[]{buffer.toString()});<br/>                        assertThat(buffer.toJsonArray().size()).isGreaterThan(0);<br/>                        testContext.completeNow();<br/>                    }<br/>                )<br/>            )<br/>            .onFailure(e -&gt; LOGGER.log(Level.ALL, "error: {0}", e.getMessage()));<br/>    }</span><span id="4ada" class="lo lp iq lk b gy ml lr l ls lt">}</span></pre><p id="174d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从我的github 中获取<a class="ae kl" href="https://github.com/hantsy/vertx-sandbox/tree/master/post-service-cdi" rel="noopener ugc nofollow" target="_blank">示例代码。</a></p></div></div>    
</body>
</html>