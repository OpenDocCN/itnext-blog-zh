# 如何使用 PyTest，包括真实示例和最佳实践

> 原文：<https://itnext.io/how-to-use-pytest-including-real-examples-and-best-practices-11073e4fd514?source=collection_archive---------0----------------------->

你发现自己定期修复 bug 了吗？就像你不能休息一下，让 QA 或你的经理盯着你。

“嘿，我成功破解了你的密码”。“它不适用于此用例”。

你不是一个人，我也经历过，那很糟糕。你也没有从你的经理、客户或人力资源那里获得多少印象分。

更不用说你的自尊和自信受到的打击了。

好吧，以下是你如何尽你所能减轻这种情况。秘方是单元测试。或者测试驱动开发(TDD)。

现在每个技术面试都会检验你的单元测试知识。

作为一名自学成才的开发人员，如果没有在行业中花费大量时间，或者没有导师，很难获得最佳实践。

这个博客将教你如何使用 PyTest 框架编写 Python 单元测试，最大化覆盖率，模仿外部 API 和服务，并将测试作为 CI/CD 管道的一部分。

都有示例代码。

作为一名首席 Python 开发人员，我从 5 年多的经历中学到了很多。让我们开始吧。

如果你想直接跳到代码，这里有一个 Github 上的[链接。](https://github.com/ericsalesdeandrade/number-logic)

![](img/794d64de904a5737b1f2cce23dacce31.png)

[信用](https://unsplash.com/photos/qAjJk-un3BI)

**为什么要测试？**

*   **预测/模拟预期功能**
*   **不要破坏什么工程**
*   **边缘案例和异常处理**

**测试框架。(Pytest，Unittest &其他)**

**如何测试(示例代码)**

*   **I/O(输入、输出)测试**
*   **功能测试**
*   **异常测试**

**其他类型的测试？**

*   **REST API 调用**
*   **动态生成的查询测试**

**PyTest 最佳实践**

*   **使用夹具作为参数**
*   **将参数&夹具存储在 Conftest** 中
*   **模拟 API 和库响应**

**作为 CI/CD 管道的一部分进行测试& Github 挂钩**

**结论**

# 为什么要测试？

那么测试有什么大不了的呢？

为什么不能让它工作并部署到生产中呢？在本地测试的还不够多吗？

有很多关于单元测试是否重要或者集成测试是否足够的争论。

*注——顾名思义，集成测试是测试一个更复杂系统的整体功能。拼图的各个部分是如何一起工作的。*

这就是我从艰难的道路中学到的东西，以及为什么测试很重要。

## 预测/模拟预期功能

你希望一段代码完全按照你的设计去做，也就是说，对于一个给定的输入，它应该产生相同的输出。每一次

让我们暂时忽略机器学习和神经网络；)

确保这一点的可靠方法是在将代码提交到存储库或部署到生产环境之前运行单元测试。

## 不要破坏有用的东西

有句话很流行“如果有用，就不要碰”。

代码也是如此。如果你(或你的公司)有一个可以工作的软件，你最不想做的事情就是破坏它。

这可能完全是无意的，因为您不知道您的更改会影响代码的其他部分。

单元测试有助于隔离代码的各个模块，并确保您的更改不会破坏应用程序中的其他模块。

## 边缘案例和异常处理

如果有一件事是大多数开发人员擅长的，那就是懒惰。包括我自己。

我们不喜欢花时间思考或考虑可能破坏我们软件的边缘情况。我们宁愿等待它发生，然后修补它。

这是导致灾难的原因。代码中的错误会让你或你的公司向客户付费。

编写单元测试迫使你去思考你的代码可能崩溃的边缘情况，以及你应该如何解决它。

它还让你思考[异常处理](https://www.programiz.com/python-programming/exception-handling#:~:text=In%20Python%2C%20exceptions%20can%20be,we%20have%20caught%20the%20exception.)(代码优雅地处理错误)以及如何用有用的错误消息来处理它。

# 测试框架。(Pytest、Unittest 和其他)

有几个 Python 测试框架，大多数都以相同的方式工作。

你使用一个测试框架调用你的模块，传递一个预期的响应，如果你的代码的响应与预期的响应相匹配，它就通过了。如果没有，它就失败了。

一些流行的框架有

*   [PyTest](https://docs.pytest.org/en/7.1.x/)
*   [单元测试](https://docs.python.org/3/library/unittest.html)
*   [鼻 2](https://docs.nose2.io/en/latest/)
*   [机器人](https://robotframework.org/)
*   [守规矩](https://behave.readthedocs.io/en/stable/)
*   [生菜](https://support.smartbear.com/crossbrowsertesting/docs/automated-testing/frameworks/lettuce.html#:~:text=Lettuce%20is%20a%20Behavior%20Driver,with%20CrossBrowserTesting%27s%20cloud%20testing%20platform.)

虽然大多数框架都很好并且易于使用，但我更喜欢 PyTest 模块。

这是我用得最多的一款，我发现它的功能性和简单性无与伦比。

所以尝试一些对你来说最简单的方法。请记住，使用哪种框架并不重要，重要的是测试覆盖率和健壮性。

# 如何测试(示例代码)

最后，文章的主体。你最期待的部分。实际代码。

整个指南使用 PyTest 模块进行说明，但是这些示例也可以用其他框架编写。

让我们考虑示例源代码— [数字逻辑](http://number-logic/)(链接到 Github)

## 规范摘要

*   该任务的目标是获取一个包含数字列表的文件，并找到总和为指定值的 3 个数字。
*   Python 类“ *NumberLogic* ”包含一系列执行不同任务的函数(读取外部文件，将字符串转换为整数，找到总和等于指定值的数字)。
*   然后，我们将上一节中的 3 个数字相乘，并返回结果。

你可以从根目录沿着路径`src/number_logic.py`看一下源代码。

现在让我们深入单元测试

**关于 Conftest 的注意事项。**

`conftest.py`是一个与单元测试指定在同一个目录中的文件，包含了跨所有测试文件使用所需的装置和参数。

下面是一个在 Conftest 中定义的装置的例子

虽然这是一个非常基本的例子，但是您的`conftest.py`文件可以包含您想要的任意多的夹具和参数。

## 输入输出测试

处理磁盘上的文件时，一个重要的测试是输入/输出。尽管有人可能会认为这更像是一个集成测试，但我还是把它包括进来了。

***测试 1 == >测试 _ 读取 _ 输入 _ 文件***

在这个测试`test_read_input_file`中，我们检查脚本是否能够正确读取文件及其内容。这只是确保我们已经读取了预期的文件。

***测试 2 == >测试 _ 读取 _ 输入 _ 文件 _ 异常***

第二个测试`test_read_input_file_exception`检查如果文件不在磁盘上，我们的代码是否会引发一个`FileNotFoundError`。

请记住，提出例外时，请确保在问题和行动过程中包含有用的信息。

## 功能测试

***测试 3 == >测试 _ 转换 _ 字符串 _ 整数***

在这个测试中，我们检查作为输入传递给函数`convert_str_int`的整数是否被正确地转换成字符串。

***测试 4 == >测试 _ 检查 _ 求和***

在这个测试中，我们检查一个整数列表，其中 3 的和给出一个预定义的值(在这个例子中是 2020)。

***测试 5== >测试 _ 乘 _ 值***

在这个测试中，我们将这些值相乘以获得结果

## 异常测试

***测试 6== >测试 _ 转换 _ 字符串 _ 异常***

在上面的测试中，我们检查了如果我们在输入中遇到一个意外的值(例如一个字符串)，我们的代码会生成一个有用的`ValueError`。

如果我们要进行数值运算，这是很重要的。

***测试 7== >测试 _ 乘值 _ 异常***

与前面的测试类似，我们检查乘数函数的任何输入是否为非整数(并抛出一个`ValueError`)。

# 其他类型的测试？

上面的例子向你展示了如何将理论付诸实践，但是你还需要测试什么呢？

像生活中的大多数事情一样，人们会有不同的看法。有些人的目标是尽可能多的覆盖面，而对另一些人来说，只要基本的就够了。

对于单元测试中的“单元”到底是什么，并没有一致的决定。一组类(模块)，单个类，方法，整个微服务？

我喜欢把一个单元想象成一个类，或者有时是一组类。重要的是你正在测试你所写的代码的功能。

不管它们是否相互排斥。

## REST API 调用

在我的另一篇关于用 AWS Lambda 和 API Gateway 构建 API 的文章中，我引用了 API 的定义

> 应用编程接口(API)是一组协议、例程、函数和/或命令，程序员使用它们来开发软件或促进不同系统之间的交互技术百科

简单地说，这是一个软件系统共享数据的协议。例如从数据库到网络服务器等等。

在 Python 中进行 API 调用最流行的库之一是`[Requests](https://docs.python-requests.org/en/latest/)`库。

但是，如何测试来自其他 API(您不拥有也不控制)的响应呢？

关键是嘲讽。

`[requests-mock](https://medium.com/r?url=https%3A%2F%2Frequests-mock.readthedocs.io%2Fen%2Flatest%2F)`库允许您模拟 API 响应，从而消除了仅仅为了测试目的而对 API 进行外部调用的需要(这可能代价很高)。

更不用说它有助于确保您捕获 API 响应格式的变化。

模仿 ElasticSearch 中索引创建的请求示例，您还可以模仿 HTTP 状态代码。

附注:这里使用了一个`AdminElasticSearch`类，只是为了举例说明。

《T5》蓝皮书中有一些很好的请求嘲讽测试例子。

## 动态生成的查询测试

如果你正在用 Python 构建你的后端，你可能需要使用动态生成的查询与 SQL Server、Postgres 或 ElasticSearch 等数据库进行对话。

这些查询是在运行时基于某些变量生成的，因此模拟生成正确的查询非常重要。

如何应用这一点的一个很好的例子在[这里](https://towardsdatascience.com/a-simple-approach-to-templated-sql-queries-in-python-adc4f0dc511)有很好的描述。

# PyTest 最佳实践

既然我们已经讨论了如何测试，那么让我们快速看一下 PyTest 的一些最佳实践。

## 使用夹具作为参数

您会经常发现自己在测试中使用各种参数。这些可能是您的类的实例，或者可能只是一个输入测试文件。

夹具的使用对此有很大帮助。Pytest fixtures 允许您在测试文件本身(或`conftest.py`)中定义参数，并在您的测试中使用它们。

这里有一个[伟大的指南](https://docs.pytest.org/en/6.2.x/fixture.html)告诉你如何开始使用 PyTest Fixtures。

## 在 Conftest 中存储参数和装置

使用`conftest.py`为运行您的测试提供了一个很好的框架，允许您定义 fixtures 和其他元素，并在所有的测试模块中使用它们。

只要确保`conftest.py`文件和你的测试文件放在同一个目录下。

## 模拟 API 和库响应

模拟 API 调用和其他库响应提供了一种无需实际调用就能测试功能的简便方法，节省了计算资源和成本。

还有几个最佳实践，所以请花些时间来查看并应用它们。

# 作为 CI/CD 管道和 Github 挂钩的一部分进行测试

这是我多年来学到的一个非常重要的实践。

始终将单元和集成测试作为 CI/CD 管道的一部分。

如果您不知道什么是 CI/CD，请点击此处查看文章和视频。

但是，简而言之，CI(或持续改进)是对您的代码分支运行检查的过程，以确保它不会破坏`main`或`master`分支。

这些检查可以配置为执行您选择的任何检查。

连续交付或连续部署(CD)是将代码分支部署到服务器到云帐户的过程。

CI/CD 管道可以使用各种工具来设置，如 AWS CodeBuild/CodePipeline、Jenkins、CircleCI 或我最喜欢的 [Github Actions](https://github.com/features/actions) 。

将单元测试作为 CI/CD 的一部分来运行，可以确保您的最新更改不会破坏现有的功能，并减少 bug 进入生产软件的可能性。

例如，您可以在 [Github 动作](https://medium.com/@dev.soni04/github-action-for-unit-testing-57faefc9633)上设置单元测试，并在本地使用 [Github 挂钩](https://adamtheautomator.com/git-pre-commit-hook/)(通过`.pre-commit-config.yaml`文件)。

下面的示例`.pre-commit-config.yaml`—(存储在您的回购的根目录中)

# 结论和 CTA

这就是了。

这是一个相当全面的 PyTest 使用介绍和指南，包含了我作为开发人员多年来学到的一些最佳实践。

我们看了为什么应该对代码进行单元测试，测试框架(特别是 PyTest)和一些单元测试的例子，包括模仿 REST APIs。

我们还探索了 Pytest 中的一些最佳实践——使用夹具和参数、conftest 等，并将单元测试作为 CI/CD 管道的一部分。

我希望你喜欢这篇文章，如果你有任何建议或问题，不要犹豫，在评论或私人笔记中分享。