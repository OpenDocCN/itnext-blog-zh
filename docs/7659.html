<html>
<head>
<title>Kubernetes: ServiceAccount with AWS IAM Role for Kubernetes Pod</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes:具有Kubernetes Pod的AWS IAM角色的服务帐户</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-serviceaccount-%D0%B7-aws-iam-role-%D0%B4%D0%BB%D1%8F-kubernetes-pod-d44a8e3b576f?source=collection_archive---------4-----------------------#2022-12-11">https://itnext.io/kubernetes-serviceaccount-%D0%B7-aws-iam-role-%D0%B4%D0%BB%D1%8F-kubernetes-pod-d44a8e3b576f?source=collection_archive---------4-----------------------#2022-12-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/aee27dee46c277be3749bdd2c292b00a.png" data-original-src="https://miro.medium.com/v2/resize:fit:636/format:webp/1*X3phdxmrG9gpQFETH74efQ.png"/></div></figure><p id="8831" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们有用于日志的Grafana Loki，并且需要将一个AWS IAM角色与AWS IAM策略连接起来，这允许访问一个AWS S3存储桶，Loki的块和索引将存储在这个存储桶中。</p><p id="aa61" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Kubernetes Pods的IAM角色的工作方式与EC2实例的IAM角色相同:Pod中的流程向AWS API发出请求，发出请求的AWS SDK或AWS CLI也发出使用IAM角色的<code class="fe ks kt ku kv b"><a class="ae kw" href="https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html" rel="noopener ugc nofollow" target="_blank">AssumeRole</a></code>请求(参见<a class="ae kw" href="https://rtfm.co.ua/en/aws-iam-users-keys-rotation-ec2-iam-roles-and-jenkins/" rel="noopener ugc nofollow" target="_blank"> AWS:用户IAM密钥、EC2 IAM角色和Jenkins </a>的轮换)。</p><p id="2803" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了检查它在Kubernetes中是如何工作的，让我们创建一个测试IAM角色，一个带有该角色注释的ServiceAccount，以及一个带有将使用该角色的ServiceAccount的Pod。</p><p id="b8e2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">展望未来——它在Loki中以某种<em class="kx">替代现实</em>工作，也就是说，即使你将一个已经测试过的ServiceAccount连接到Loki Pod——它也会出错崩溃。但最终，我还是让它工作了(关于用AWS S3设置Loki，稍后在另一篇文章中)。</p><p id="9ac6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">文档— <a class="ae kw" href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html" rel="noopener ugc nofollow" target="_blank">服务帐户的IAM角色</a>。</p><h1 id="6698" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">IAM OIDC身份提供者验证</h1><p id="f86e" class="pw-post-body-paragraph ju jv iq jw b jx lw jz ka kb lx kd ke kf ly kh ki kj lz kl km kn ma kp kq kr ij bi translated">在我们的例子中，EKS集群是使用Terraform <code class="fe ks kt ku kv b"><a class="ae kw" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/eks_cluster" rel="noopener ugc nofollow" target="_blank">aws_eks_cluster</a></code>模块部署的，OpenID Connect (OIDC)提供者应该已经配置好了。</p><p id="28fd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">转到集群页面，找到<em class="kx">OpenID连接提供者URL </em>:</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi mb"><img src="../Images/5787bf520493d51da3be1bd7b1e2697d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*E8MeFbPHHxg-E2gP.jpg"/></div></div></figure><p id="420d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">或者从终端:</p><pre class="mc md me mf gt mk kv ml bn mm mn bi"><span id="60e9" class="mo kz iq kv b be mp mq l mr ms">$ aws -rofile development --egion us-west-2 eks describe-cluster --name dev_data_services --query “cluster.identity.oidc.issuer” --output text<br/>https://oidc.eks.us-west-2.amazonaws.com/id/537***A10</span></pre><p id="72c1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">复制没有<code class="fe ks kt ku kv b">https://</code>的网址，在<em class="kx"> IAM &gt;身份提供者</em>中找到:</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi mt"><img src="../Images/20ba90f36af6842c23248dba60c94b51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1yhcKJZo2f-NGAMi.jpg"/></div></div></figure><p id="8a2c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好吧，就这样。</p><h1 id="b27a" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">创建具有AWS IAM角色的Kubernetes ServiceAccount</h1><p id="7a0f" class="pw-post-body-paragraph ju jv iq jw b jx lw jz ka kb lx kd ke kf ly kh ki kj lz kl km kn ma kp kq kr ij bi translated">首先，让我们创建一个IAM策略，向AWS S3存储桶授予权限，然后创建一个带有<code class="fe ks kt ku kv b"><a class="ae kw" href="https://aws.amazon.com/ru/blogs/security/how-to-use-trust-policies-with-iam-roles/" rel="noopener ugc nofollow" target="_blank">TrustedPolicy</a></code>的IAM角色，允许您使用集群的OIDC身份提供者(IDP)执行<code class="fe ks kt ku kv b"><a class="ae kw" href="https://rtfm.co.ua/ru/aws-iam-assumerole-opisanie-primery/" rel="noopener ugc nofollow" target="_blank">AssumeRole</a></code>。</p><h2 id="cd39" class="mu kz iq bd la mv mw dn le mx my dp li kf mz na lm kj nb nc lq kn nd ne lu nf bi translated">AWS IAM策略</h2><p id="1672" class="pw-post-body-paragraph ju jv iq jw b jx lw jz ka kb lx kd ke kf ly kh ki kj lz kl km kn ma kp kq kr ij bi translated">创建测试策略:</p><pre class="mc md me mf gt mk kv ng nh aw ni bi"><span id="fc6e" class="mu kz iq kv b gy nj nk l nl ms">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "s3:ListBucket",<br/>                "s3:PutObject",<br/>                "s3:GetObject",<br/>                "s3:DeleteObject"<br/>            ],<br/>            "Resource": [<br/>                "arn:aws:s3:::development-dev-loki-object-store",<br/>                "arn:aws:s3:::development-dev-loki-object-store/*"<br/>            ]<br/>        }<br/>    ]<br/>}</span></pre><p id="820a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将其添加到AWS IAM:</p><pre class="mc md me mf gt mk kv ml bn mm mn bi"><span id="0f10" class="mo kz iq kv b be mp mq l mr ms">$ aws — profile development iam create-policy --policy-name test-iam-sa-pod-policy --policy-document file://test-iam-sa-pod-policy.json</span></pre><p id="2811" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">进入角色。</p><h2 id="7b1f" class="mu kz iq bd la mv mw dn le mx my dp li kf mz na lm kj nb nc lq kn nd ne lu nf bi translated">AWS IAM角色和可信策略</h2><p id="027b" class="pw-post-body-paragraph ju jv iq jw b jx lw jz ka kb lx kd ke kf ly kh ki kj lz kl km kn ma kp kq kr ij bi translated">找到您的身份提供商的<strong class="jw ir"> ARN </strong>:</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi nm"><img src="../Images/365f41191c31d17ecc5c2e6b797bff59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cxhh0MollGXOicPl.jpg"/></div></div></figure><p id="61d0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">OIDC身份提供者<strong class="jw ir">的URL </strong>已经在前面找到了:</p><pre class="mc md me mf gt mk kv ml bn mm mn bi"><span id="5844" class="mo kz iq kv b be mp mq l mr ms">$ aws --profile development --region us-west-2 eks describe-cluster --name dev_data_services --query “cluster.identity.oidc.issuer” --output text<br/>https://oidc.eks.us-west-2.amazonaws.com/id/537***A10</span></pre><h2 id="5b64" class="mu kz iq bd la mv mw dn le mx my dp li kf mz na lm kj nb nc lq kn nd ne lu nf bi translated">使用AWS CLI创建IAM角色</h2><p id="73df" class="pw-post-body-paragraph ju jv iq jw b jx lw jz ka kb lx kd ke kf ly kh ki kj lz kl km kn ma kp kq kr ij bi translated">用<code class="fe ks kt ku kv b">TustedPolicy</code>创建一个文件，在其<code class="fe ks kt ku kv b">Principal</code>字段中指定IDP的<strong class="jw ir"> ARN </strong>，在集群的<code class="fe ks kt ku kv b">Condition</code>-OIDC<strong class="jw ir">URL</strong>中，将允许执行对<em class="kx">sts.amazonaws.com</em>的请求:</p><pre class="mc md me mf gt mk kv ng nh aw ni bi"><span id="1ff9" class="mu kz iq kv b gy nj nk l nl ms">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Principal": {<br/>                "Federated": "arn:aws:iam::638***021:oidc-provider/oidc.eks.us-west-2.amazonaws.com/id/537***A10"<br/>            },<br/>            "Action": "sts:AssumeRoleWithWebIdentity",<br/>            "Condition": {<br/>                "StringEquals": {<br/>                    "oidc.eks.us-west-2.amazonaws.com/id/537***A10:aud": "sts.amazonaws.com"<br/>                }<br/>            }<br/>        }<br/>    ]<br/>}</span></pre><p id="8c8a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用此可信策略创建角色:</p><pre class="mc md me mf gt mk kv ml bn mm mn bi"><span id="e5c2" class="mo kz iq kv b be mp mq l mr ms">$ aws --profile development iam create-role --role-name test-iam-sa-pod-role --assume-role-policy-document file://test-iam-sa-role-trusted-policy.json</span></pre><p id="712d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将我们在上面创建的具有S3权限的IAM策略连接到此IAM角色:</p><pre class="mc md me mf gt mk kv ml bn mm mn bi"><span id="c6ef" class="mo kz iq kv b be mp mq l mr ms">$ aws --profile development iam attach-role-policy --role-name test-iam-sa-pod-role --policy-arn=arn:aws:iam::638***021:policy/test-iam-sa-pod-policy</span></pre><h2 id="746b" class="mu kz iq bd la mv mw dn le mx my dp li kf mz na lm kj nb nc lq kn nd ne lu nf bi translated">从AWS控制台创建IAM角色</h2><p id="fbdc" class="pw-post-body-paragraph ju jv iq jw b jx lw jz ka kb lx kd ke kf ly kh ki kj lz kl km kn ma kp kq kr ij bi translated">或者我们也可以通过亚马逊控制台页面来完成—选择<em class="kx">网络身份</em>的类型，集群的<em class="kx">身份提供者</em>，以及<em class="kx">受众</em>:</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi nn"><img src="../Images/9ab496ca7fadd8b2829d8cdf5ab655e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*esWQi56m9_cGBO8K.jpg"/></div></div></figure><p id="b404" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加S3的IAM策略:</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi no"><img src="../Images/fe827f704db93c050a6a66b5533fd9d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*c_eyjMbFeVlImixV.png"/></div></div></figure><p id="fb7e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">保存它:</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi np"><img src="../Images/7ecf97dff9872b7360521cb8d8f63a7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*aZuPjzdmoF0Rlb1s.jpg"/></div></div></figure><p id="b501" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">复制角色的ARN:</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi nq"><img src="../Images/026ce2631eb0965694d95d1110080d8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GPcx96nQb7csVyUC.jpg"/></div></div></figure><h2 id="e6e4" class="mu kz iq bd la mv mw dn le mx my dp li kf mz na lm kj nb nc lq kn nd ne lu nf bi translated">创建Kubernetes服务帐户</h2><p id="bf89" class="pw-post-body-paragraph ju jv iq jw b jx lw jz ka kb lx kd ke kf ly kh ki kj lz kl km kn ma kp kq kr ij bi translated">创建一个ServiceAccount清单，在其<code class="fe ks kt ku kv b">annotations</code>中设置所创建角色的ARN:</p><pre class="mc md me mf gt mk kv ng nh aw ni bi"><span id="ed92" class="mu kz iq kv b gy nj nk l nl ms">---<br/>apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: test-iam-sa-pod-service-account<br/>  annotations:<br/>    eks.amazonaws.com/role-arn: arn:aws:iam::638***021:role/test-iam-sa-pod-role</span></pre><p id="50b4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们去库伯内特斯豆荚吧。</p><h1 id="ce14" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">使用服务帐户运行Kubernetes Pod</h1><p id="a426" class="pw-post-body-paragraph ju jv iq jw b jx lw jz ka kb lx kd ke kf ly kh ki kj lz kl km kn ma kp kq kr ij bi translated">使用ServiceAccount的<code class="fe ks kt ku kv b">serviceAccountName</code>创建Pod的清单，因此完整的文件如下所示:</p><pre class="mc md me mf gt mk kv ng nh aw ni bi"><span id="acf2" class="mu kz iq kv b gy nj nk l nl ms">apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: test-iam-sa-pod-service-account<br/>  annotations:<br/>    eks.amazonaws.com/role-arn: arn:aws:iam::638***021:role/test-iam-sa-pod-role<br/>---<br/>apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  name: test-iam-sa-pod<br/>  labels:<br/>    app: test-iam-sa-app<br/>spec:<br/>  containers:<br/>    - name: test-iam-sa<br/>      image: amazon/aws-cli<br/>      command: [ "/bin/bash", "-c", "--" ]<br/>      args: [ "while true; do sleep 30; done;" ]<br/>  serviceAccountName: test-iam-sa-pod-service-account</span></pre><p id="8db1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在Pod中，我们将使用带有AWS CLI和<code class="fe ks kt ku kv b">sleep</code>命令的Docker映像，因此它将在启动后保持<em class="kx">运行</em>。</p><p id="abd8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">部署ServiceAccount和Pod:</p><pre class="mc md me mf gt mk kv ml bn mm mn bi"><span id="aef6" class="mo kz iq kv b be mp mq l mr ms">$ kubectl apply -f test-iam-sa-pod.yaml<br/>serviceaccount/test-iam-sa-pod-service-account created<br/>pod/test-iam-sa-pod created</span></pre><p id="c50d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">深入了解:</p><pre class="mc md me mf gt mk kv ml bn mm mn bi"><span id="cd12" class="mo kz iq kv b be mp mq l mr ms">$ kubectl exec -ti test-iam-sa-pod — bash</span></pre><p id="3215" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并检查篮子的入口:</p><pre class="mc md me mf gt mk kv ml bn mm mn bi"><span id="f5bd" class="mo kz iq kv b be mp mq l mr ms">bash-4.2# aws s3 ls development-dev-loki-object-store<br/>PRE test/</span></pre><p id="9f6c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">完成了。</p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><p id="3c43" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="kx">最初发布于</em> <a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-serviceaccount-z-aws-iam-role-dlya-kubernetes-pod-2/" rel="noopener ugc nofollow" target="_blank"> <em class="kx"> RTFM: Linux、DevOps、系统管理</em> </a> <em class="kx">。</em></p></div></div>    
</body>
</html>