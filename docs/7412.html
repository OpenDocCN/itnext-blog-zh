<html>
<head>
<title>Automating Oracle DB client failover using Azure Function App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure Function App自动化Oracle DB客户端故障转移</h1>
<blockquote>原文：<a href="https://itnext.io/automating-db-client-failover-using-azure-function-app-6ed375ab5666?source=collection_archive---------1-----------------------#2022-09-15">https://itnext.io/automating-db-client-failover-using-azure-function-app-6ed375ab5666?source=collection_archive---------1-----------------------#2022-09-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="3631" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">简介和问题陈述</h1><p id="c267" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">Oracle Data Guard是确保Oracle数据库高可用性的方法之一。Oracle Data Guard将备用数据库作为主数据库的副本进行维护。然后，如果主数据库由于计划内或计划外停机而变得不可用，Oracle Data Guard可以将任何备用数据库切换到主数据库角色，从而最大限度地减少与停机相关的停机时间。</p><p id="ad9c" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">因为这个博客不是关于Oracle Data Guard的，如果你想了解更多，请参考<a class="ae lj" href="https://docs.oracle.com/en/database/oracle/oracle-database/21/sbydb/introduction-to-oracle-data-guard-concepts.html#GUID-AB9DF863-2C7E-4767-81F2-56AD0FA30B49" rel="noopener ugc nofollow" target="_blank">文档</a>了解更多信息。</p><p id="c623" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">为了更好地理解这个概念，您可以参考下面的GIF，它描述了一个使用Oracle Data Guard的简单Oracle数据库高可用性配置。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/560f6adbe92c6c8c65734bbfafcbb15f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*0ujEMF6NnHyhXFTLTu6_hQ.gif"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">图1使用Data Guard的Oracle数据库故障转移</figcaption></figure><p id="158a" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">下面是这张GIF的几个要点，这样更有意义:</p><ul class=""><li id="2554" class="mf mg iq kn b ko lk ks ll kw mh la mi le mj li mk ml mm mn bi translated">可用性区域1有一个连接到Oracle数据库的AKS实例。</li><li id="024f" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">Oracle Data Guard确保了Oracle数据库的高可用性。</li><li id="1fd8" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">这是一个简单的<strong class="kn ir">配置</strong>，其中Oracle数据库有两个实例(在单独的Azure虚拟机上)，一个是主数据库实例(在可用性区域1中)，另一个是备用数据库实例(在可用性区域2中)。</li><li id="0f74" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">第三个虚拟机安装了oracle客户端软件，并承担Oracle Data Guard配置的<a class="ae lj" href="https://www.oracle.com/technical-resources/articles/smiley-fsfo.html" rel="noopener ugc nofollow" target="_blank"> FSFO观察者</a>的角色。仅当配置了快速启动故障切换时，才需要观察器</li><li id="00ec" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">所有数据库客户端(AKS Pods或其他客户端)在其连接字符串中使用<strong class="kn ir">db . my domain . local</strong><a class="ae lj" href="https://docs.microsoft.com/en-us/azure/cloud-services/cloud-services-custom-domain-name-portal#cname-or-alias-record" rel="noopener ugc nofollow" target="_blank">CNAME</a>(在私有DNS区域中)，并使用<strong class="kn ir"> dbservice </strong>作为服务名。</li><li id="0b7b" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated"><strong class="kn ir">db . my domain . local</strong>CNAME必须始终解析到运行主实例的虚拟机FQDN。</li><li id="31b8" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated"><a class="ae lj" href="https://www.oracle.com/technical-resources/articles/smiley-fsfo.html" rel="noopener ugc nofollow" target="_blank">快速启动故障转移</a>在Oracle Data Guard上配置，因此当主数据库由于任何原因变得不可用时(在这种情况下vm1.mydomain.local崩溃)，数据库故障转移到备用数据库实例，Data Guard将备用实例转换为主实例。</li><li id="d06a" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">所有旧的客户端连接都断开了。<strong class="kn ir">现在必须进行客户机故障转移，以便客户机可以再次开始连接到数据库。这是这篇文章的问题陈述。</strong></li></ul><h1 id="ca97" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">Oracle客户端故障转移解决方案</h1><p id="22a9" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">Oracle为客户端故障转移提供了许多解决方案，详情见<a class="ae lj" href="https://docs.oracle.com/database/121/HABPT/config_fcf.htm#HABPT4969" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><ul class=""><li id="6521" class="mf mg iq kn b ko lk ks ll kw mh la mi le mj li mk ml mm mn bi translated">为JDBC客户端配置快速连接故障转移(更新应用程序配置，需要<a class="ae lj" href="https://docs.oracle.com/en-us/iaas/pl-sql-sdk/doc/ons-package.html" rel="noopener ugc nofollow" target="_blank">on</a></li><li id="c8ea" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">配置应用程序连续性(需要Oracle集群件，需要额外的许可)</li><li id="805a" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">为OCI客户机配置快速连接故障转移(Oracle集群件或Oracle重启，需要额外的许可)</li><li id="9569" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">为故障切换配置Oracle RAC数据库(必须安装Oracle RAC，需要额外的许可)</li><li id="fa23" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">配置Oracle Data Guard环境(必须安装Oracle集群件，需要额外的许可)</li></ul><p id="6007" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这些选项需要您安装ons、安装Oracle RAC、Oracle Clusterware或Oracle restart(单个节点上的Oracle Clusterware ),或者在应用程序端配置某些参数。<a class="ae lj" href="https://www.oracle.com/ca-en/database/real-application-clusters/" rel="noopener ugc nofollow" target="_blank"> Oracle RAC </a>解决了大部分与高可用性相关的问题，但它会产生额外的成本，此外，您还需要维护另一个Oracle主目录，对于如上所述的设置，它不是一个理想的解决方案。</p><p id="472d" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">您不想依赖应用程序配置进行客户端故障切换，也不想向堆栈中添加额外的组件。</p><h1 id="5b29" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">使用CNAME切换进行客户端故障切换</h1><p id="82bc" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在图1中，您注意到客户端在数据库连接字符串中使用了<a class="ae lj" href="https://docs.microsoft.com/en-us/azure/cloud-services/cloud-services-custom-domain-name-portal#cname-or-alias-record" rel="noopener ugc nofollow" target="_blank"> CNAME </a>。因此，一旦发生故障转移，CNAME<strong class="kn ir">db . my domain . local</strong>必须指向托管新主实例(旧备用)的虚拟机的FQDN，即vm2.mydomain.local，以便客户端可以再次开始连接到数据库。</p><p id="3f06" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在Azure中，我们可以使用下面的命令来做到这一点。</p><pre class="lq lr ls lt gt mt mu mv mw aw mx bi"><span id="995e" class="my jo iq mu b gy mz na l nb nc">az account set --subscription "Subscription_of_PRIVATE_DNS_ZONE"<br/>az network private-dns record-set cname set-record -g ${v_resourceGroup_pz} -z ${v_DnsZone}  -n ${v_primaryCname} -c "${v_standbyNode}.${v_DnsZone}";</span></pre><p id="f485" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">此外,“dbservice”数据库服务必须在新的主数据库上启动。每当数据库实例以数据库角色“PRIMARY”启动时，我们可以创建一个触发器来启动“dbservice”。</p><pre class="lq lr ls lt gt mt mu mv mw aw mx bi"><span id="69e4" class="my jo iq mu b gy mz na l nb nc">CREATE OR REPLACE TRIGGER startDgServices after startup on database<br/>DECLARE  <br/>db_role VARCHAR(30);  <br/>db_open_mode VARCHAR(30);<br/>BEGIN  <br/>    SELECT DATABASE_ROLE, OPEN_MODE INTO db_role, db_open_mode FROM V$DATABASE;<br/>    IF db_role = 'PRIMARY' THEN <br/>      DBMS_SERVICE.START_SERVICE('DBSERVICE');<br/>    END IF;<br/>END;<br/>/</span></pre><p id="bc9e" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">一旦发生故障转移，当数据库实例作为“主”实例启动时，服务DBSERVICE将自动启动。</p><p id="1e80" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><strong class="kn ir">这种方法是可以的，但是它有一个很大的缺点，它需要你手动更新私有DNS区域中的</strong><a class="ae lj" href="https://docs.microsoft.com/en-us/azure/cloud-services/cloud-services-custom-domain-name-portal#cname-or-alias-record" rel="noopener ugc nofollow" target="_blank"><strong class="kn ir">【CNAME】</strong></a><strong class="kn ir">。</strong></p><p id="4401" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">只要发生数据库切换或故障转移，就可以通过自动执行CNAME更新来解决这个问题。</p><h1 id="8d36" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">使用Azure Function App自动更新CNAME</h1><p id="5d54" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">您将创建一个函数应用程序，它执行PowerShell cmdlets来更新私有DNS区域中的<a class="ae lj" href="https://docs.microsoft.com/en-us/azure/cloud-services/cloud-services-custom-domain-name-portal#cname-or-alias-record" rel="noopener ugc nofollow" target="_blank"> CNAME </a>。<strong class="kn ir">当CNAME指向与托管虚拟机不同的FQDN时，将使用HTTP触发器从运行主实例的虚拟机触发函数应用</strong>。您可以使用一个脚本通过curl来执行HTTP触发器。这将在“创建触发器脚本”一节中详细讨论。</p><h1 id="abfd" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">创建功能应用程序</h1><ul class=""><li id="abc8" class="mf mg iq kn b ko kp ks kt kw nd la ne le nf li mk ml mm mn bi translated">为函数app选择合适的值</li></ul><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ng"><img src="../Images/e0504353f6ce8692f2377d3bf6d8be51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4g7IlJh2F20MEcjeDy-DeQ.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">图2功能应用</figcaption></figure><ul class=""><li id="7105" class="mf mg iq kn b ko lk ks ll kw mh la mi le mj li mk ml mm mn bi translated">选择适当的计划，您可以选择支持私有端点、虚拟网络集成、自定义域和流量管理器的“高级功能”</li></ul><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nh"><img src="../Images/0ef6ad2e0463fb35bf0c644b7600b4a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C2mO0Zmr9Gn6r-dDCmSX-w.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">图3功能应用程序计划</figcaption></figure><ul class=""><li id="8dd3" class="mf mg iq kn b ko lk ks ll kw mh la mi le mj li mk ml mm mn bi translated">导航到身份，对于系统分配的身份，将状态切换到打开，然后单击保存。</li><li id="7db9" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">导航至“功能”并点击创建</li></ul><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ni"><img src="../Images/6e80b667a3b4bbc28b8da7566101588b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M5NHRo0hTLhItsOtJSX49w.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">图4功能创建</figcaption></figure><p id="9ec4" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">选择“HTTP触发器”作为模板。为函数指定一个合适的名称，然后单击create。</p><ul class=""><li id="251b" class="mf mg iq kn b ko lk ks ll kw mh la mi le mj li mk ml mm mn bi translated">点击“code + Test”，用下面这段代码替换run.ps1的现有代码，然后点击“Save”</li></ul><pre class="lq lr ls lt gt mt mu mv mw aw mx bi"><span id="ee04" class="my jo iq mu b gy mz na l nb nc">using namespace System.Net</span><span id="c03b" class="my jo iq mu b gy nj na l nb nc"># Input bindings are passed in via param block.<br/>param($Request, $TriggerMetadata)</span><span id="e4ed" class="my jo iq mu b gy nj na l nb nc"># Write to the Azure Functions log stream.<br/>Write-Host "PowerShell HTTP trigger function processed a request."</span><span id="0da8" class="my jo iq mu b gy nj na l nb nc">#Set the Variables<br/>$subscriptionId =$env:platformSubscriptionId<br/>$tenantId = $env:tenantId<br/>$dbname = $env:dbnamedgbppr<br/>$dnsrgname = $env:dnsrgname<br/>$dnszone = $env:dnszone</span><span id="fe59" class="my jo iq mu b gy nj na l nb nc">#Switch Subscription<br/>Set-AzContext -Subscription $subscriptionId  -Tenant $tenantId<br/># Interact with query parameters or the body of the request.<br/>$name = $Request.Query.Name<br/>$newprimcname = $Request.Body.Newprimcname</span><span id="e742" class="my jo iq mu b gy nj na l nb nc">if (-not $name) {<br/>    $name = $Request.Body.Name<br/>}</span><span id="a8a7" class="my jo iq mu b gy nj na l nb nc">if ($name) {<br/>    Write-Host "Running the DNS switchover for PPR Digitalbank Database"<br/>    $rs = Get-AzPrivateDnsRecordSet -name "$dbname-prim" -RecordType CNAME -ZoneName "$dnszone" -ResourceGroupName "$dnsrgname"<br/>    Remove-AzPrivateDnsRecordConfig -RecordSet $rs -Cname $rs.Records.cname | Set-AzPrivateDnsRecordSet<br/>    Get-AzPrivateDnsRecordSet -name "$dbname-prim" -RecordType CNAME -ZoneName  "$dnszone" -ResourceGroupName "$dnsrgname"| Add-AzPrivateDnsRecordConfig -Cname $newprimcname | Set-AzPrivateDnsRecordSet<br/>    $body1 = "Hello, $name. This HTTP triggered function executed successfully. CNAME $dbname-prim now  switched \n"<br/>}</span><span id="aef3" class="my jo iq mu b gy nj na l nb nc"># Associate values to output bindings by calling 'Push-OutputBinding'.<br/>Push-OutputBinding -Name Response -Value ([HttpResponseContext]@{<br/>    StatusCode = [HttpStatusCode]::OK<br/>    Body = $body1 <br/>})</span></pre><ul class=""><li id="94ef" class="mf mg iq kn b ko lk ks ll kw mh la mi le mj li mk ml mm mn bi translated">导航到“配置”，在“应用程序设置”下添加环境变量“platformSubscriptionId”、“tenantId”、“dbnamedgbppr”、“dnsrgname”、“dnszone”</li><li id="ed18" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">导航至应用服务编辑器，并修改requirements.psd1以匹配以下内容</li></ul><pre class="lq lr ls lt gt mt mu mv mw aw mx bi"><span id="b174" class="my jo iq mu b gy mz na l nb nc">@{<br/>    # For the latest supported version, go to 'https://www.powershellgallery.com/packages/Az'. <br/>    # To use the Az module in your function app, please uncomment the line below.<br/>    # 'Az' = '8.*'<br/>    'Az' = '7.*'<br/>}</span></pre><h1 id="a6ee" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">授权功能应用程序更新私有DNS区域</h1><ul class=""><li id="bc98" class="mf mg iq kn b ko kp ks kt kw nd la ne le nf li mk ml mm mn bi translated">在Azure门户上导航到您的私有DNS区域</li><li id="73fc" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">导航到IAM</li><li id="0f65" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">单击添加并添加角色分配</li><li id="c448" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">选择“专用DNS区域贡献者”</li><li id="c615" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">分配对托管身份的访问权限并选择成员</li></ul><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nk"><img src="../Images/caca040e3a4fa6144a9d4557697e4d39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mNiPh3jg6cdW1qTQjci1eg.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">图5</figcaption></figure><ul class=""><li id="c572" class="mf mg iq kn b ko lk ks ll kw mh la mi le mj li mk ml mm mn bi translated">点击审核和分配</li></ul><h1 id="8d40" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">创建触发脚本</h1><ul class=""><li id="eccd" class="mf mg iq kn b ko kp ks kt kw nd la ne le nf li mk ml mm mn bi translated">你可以用bash或者Python或者你喜欢的语言写一个触发脚本。</li><li id="d2a2" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">脚本将在托管Oracle数据库备用实例的虚拟机上以特定的时间间隔运行。</li><li id="72be" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">该脚本应获取虚拟机上运行的数据库实例的状态，如果发现该实例的OPEN_MODE和database_role分别为“读写”和“主”，则验证CNAME的DNS解析。</li><li id="2eaa" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">如果数据库CNAME(上例中的db.mydomain.local)指向托管虚拟机的FQDN，则不需要进行任何更改，否则更新数据库CNAME以匹配数据库作为主数据库运行的托管虚拟机的FQDN。这将通过为我们之前创建的函数应用程序执行HTTP触发器来完成。</li><li id="2fd9" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">在Azure Portal上导航到您的功能应用程序&gt;功能&gt;您的_function_for_cname_switching。</li><li id="775e" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">从“获取函数URL”中复制URL</li></ul><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nl"><img src="../Images/f81a8c06ea1b9986d3461aa98312e758.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NjJGl09j1wi-uSe8Zs7DpQ.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">图6</figcaption></figure><ul class=""><li id="70a9" class="mf mg iq kn b ko lk ks ll kw mh la mi le mj li mk ml mm mn bi translated">您可以使用curl实用程序来执行如下函数应用程序的HTTP触发器</li></ul><pre class="lq lr ls lt gt mt mu mv mw aw mx bi"><span id="5e58" class="my jo iq mu b gy mz na l nb nc">curl -X POST &lt;replace with the URL you copied above(including "code" part) &gt;  \<br/>        -H 'Content-Type: application/json' \<br/>        -d '{"name":"dnscnameswitcher","newprimcname":"&lt;FQDN of VM Hosting new Primary&gt;"}'</span></pre><ul class=""><li id="ab7c" class="mf mg iq kn b ko lk ks ll kw mh la mi le mj li mk ml mm mn bi translated">确保更新新主虚拟机的FQDN值。</li><li id="8b44" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">在我们目前的项目中，我使用ansible来模板化这个脚本，你可以随时联系我们获取代码。</li><li id="2fed" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">您可以安排脚本在备用节点上定期运行。您可以根据需要决定间隔时间。</li></ul><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/23db01e16ea35c10f0e37903f2124d0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/format:webp/1*boiAJPDLwAyQ08XWnyBJ0Q.png"/></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">图7没有认证的流程</figcaption></figure><ul class=""><li id="6223" class="mf mg iq kn b ko lk ks ll kw mh la mi le mj li mk ml mm mn bi translated">上图显示了没有身份验证的脚本的执行流程</li></ul><p id="0ac2" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><strong class="kn ir">为什么我们只在备用节点上运行脚本？</strong></p><ul class=""><li id="fd82" class="mf mg iq kn b ko lk ks ll kw mh la mi le mj li mk ml mm mn bi translated">如果我们在主节点和备用节点上运行脚本，在裂脑的情况下，主节点与观察节点断开连接，备用节点发生故障转移，两个实例可能同时成为主节点，这可能会导致数据丢失。</li><li id="1b78" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">如果发生故障转移或切换，需要在新的备用节点上重新安排脚本。这可以通过ansible轻松实现。这可能需要人工干预。</li></ul><h1 id="9872" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">初步安全措施</h1><h1 id="6ea1" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">创建私有端点</h1><ul class=""><li id="0dc4" class="mf mg iq kn b ko kp ks kt kw nd la ne le nf li mk ml mm mn bi translated">导航至网络，为您的功能应用添加一个<a class="ae lj" href="https://faun.pub/configure-the-storage-account-access-without-public-ip-7f99c207073c" rel="noopener ugc nofollow" target="_blank">私有端点</a></li></ul><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nn"><img src="../Images/5ee819ce6ed9341dc3e166ac31050f9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LCYeGxwMj0x0t04mEkKwVQ.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">图8私有端点</figcaption></figure><ul class=""><li id="b530" class="mf mg iq kn b ko lk ks ll kw mh la mi le mj li mk ml mm mn bi translated">这将为您在创建私有端点时选择的子网中的功能应用程序分配一个私有IP</li><li id="e135" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">现在，当您对该函数进行HTTP调用时，将使用私有IP，并且请求不会通过互联网路由。</li></ul><h1 id="d870" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">添加访问限制</h1><ul class=""><li id="93d9" class="mf mg iq kn b ko kp ks kt kw nd la ne le nf li mk ml mm mn bi translated">导航到网络，点击访问限制</li><li id="d325" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">点击添加规则</li><li id="1e7c" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">给规则起一个合适的名字，动作为“允许”</li><li id="b138" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">源应该是您的虚拟机所属的虚拟网络和子网。</li><li id="0f6d" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">这将限制所有传入流量，除了来自属于允许子网的虚拟机的呼叫。</li></ul><h1 id="0b11" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">添加身份验证</h1><h2 id="db37" class="my jo iq bd jp no np dn jt nq nr dp jx kw ns nt kb la nu nv kf le nw nx kj ny bi translated">添加身份验证提供程序</h2><ul class=""><li id="fd60" class="mf mg iq kn b ko kp ks kt kw nd la ne le nf li mk ml mm mn bi translated">导航至功能应用程序中的“认证”</li><li id="ee52" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">添加身份提供者并选择“Microsoft”</li><li id="bbdf" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">使用现有应用注册详细信息添加Microsoft (AAD)身份提供者。查看<a class="ae lj" href="https://docs.microsoft.com/en-us/azure/app-service/configure-authentication-provider-aad" rel="noopener ugc nofollow" target="_blank">文档</a>了解详情。</li><li id="0ffa" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">添加app注册的appid和secret，还要在密钥库中添加这个secret。</li><li id="660a" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">还将appid添加到“允许的令牌受众”中。</li><li id="9d76" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">将功能App的访问限制为“需要认证”</li><li id="e49a" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">未经验证的请求将收到“403未经授权的请求”错误。</li></ul><h2 id="df34" class="my jo iq bd jp no np dn jt nq nr dp jx kw ns nt kb la nu nv kf le nw nx kj ny bi translated">调用HTTP触发器方式的变化</h2><ul class=""><li id="5fda" class="mf mg iq kn b ko kp ks kt kw nd la ne le nf li mk ml mm mn bi translated">使用身份验证时，您可以使用curl实用程序为函数App执行HTTP触发器，如下所示</li></ul><pre class="lq lr ls lt gt mt mu mv mw aw mx bi"><span id="b546" class="my jo iq mu b gy mz na l nb nc"># get secret for app registration used for authentication<br/>az login --identity &gt; /dev/null<br/>client_secret_sp=`az keyvault secret show --vault-name &lt;vault_name&gt; -n &lt;appregistration_secret_name_in_KV&gt; --query "value" -o tsv</span><span id="e4e2" class="my jo iq mu b gy nj na l nb nc"># get access token to be used in curl to authenticate the client in function App<br/>ACCESS_TOKEN=$(curl -X POST -H 'Content-Type: application/x-www-form-urlencoded' \<br/>https://login.microsoftonline.com/f1821f56-8d20-4902-bf65-bc7502e367e7/oauth2/token \<br/>-d 'client_id=&lt;AppID_of_appregistration&gt;' \<br/>-d 'grant_type=client_credentials' \<br/>-d 'client_secret='$client_secret_sp \<br/>-d 'resource=&lt;AppID_of_appregistration&gt;' | jq -r .access_token)</span><span id="1996" class="my jo iq mu b gy nj na l nb nc">#making the HTTP trigger request<br/> curl -X POST &lt;replace with the URL you copied above(including "code" part) &gt;  \<br/>   -H 'Content-Type: application/json' \<br/>   -d '{"name":"dnscnameswitcher","newprimcname":"&lt;FQDN of VM Hosting new Primary&gt;"}'\<br/>   -H "Authorization: Bearer ${ACCESS_TOKEN}"</span></pre><ul class=""><li id="e026" class="mf mg iq kn b ko lk ks ll kw mh la mi le mj li mk ml mm mn bi translated">您可以从保存应用程序注册密码的密钥库中获取该密码，确保存在允许托管数据库实例的虚拟机的系统身份从密钥库中“获取”密码的访问策略。</li><li id="bd7d" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">下图显示了带身份验证的脚本的执行流程</li></ul><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nz"><img src="../Images/6a7da2ecc69bf09f06eb9d006efff9b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*knpiiTqC83i_pslhy4GHIw.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">图9认证流程</figcaption></figure><ul class=""><li id="0d7d" class="mf mg iq kn b ko lk ks ll kw mh la mi le mj li mk ml mm mn bi translated">目前，这允许您的Azure AD租户中的任何客户端应用程序请求访问令牌并向功能应用程序进行身份验证。如果您还想实施<em class="oa">授权</em>以仅允许某些客户端应用程序，您必须执行一些<a class="ae lj" href="https://docs.microsoft.com/en-us/azure/app-service/configure-authentication-provider-aad#daemon-client-application-service-to-service-calls" rel="noopener ugc nofollow" target="_blank">附加配置</a>。</li></ul><h2 id="f7d8" class="my jo iq bd jp no np dn jt nq nr dp jx kw ns nt kb la nu nv kf le nw nx kj ny bi translated">使用密钥库</h2><ul class=""><li id="5d09" class="mf mg iq kn b ko kp ks kt kw nd la ne le nf li mk ml mm mn bi translated">将功能键存储在密钥库中</li><li id="7996" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">在密钥库中存储应用程序注册密码</li><li id="e9c4" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">不要在脚本中存储任何秘密信息，并在脚本中检索所有信息。</li></ul><h1 id="900e" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">结论</h1><p id="8d29" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这种解决方案在数据库故障转移或切换的情况下工作良好。欢迎提出任何改进建议。</p><p id="33a4" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">感谢Emmanuel Eyoma帮助我解决了一些功能应用程序的问题。</p></div><div class="ab cl ob oc hu od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="ij ik il im in"><p id="8aab" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">请阅读我的其他文章，并分享您的反馈。如果你喜欢分享的内容，请点赞、评论并订阅新文章。</p></div></div>    
</body>
</html>