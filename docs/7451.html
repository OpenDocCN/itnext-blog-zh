<html>
<head>
<title>How to Handle Tens of Billions of Threat Intelligence Data in a Graph Database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在图形数据库中处理数百亿威胁情报数据</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-handle-tens-of-billions-of-threat-intelligence-data-in-a-graph-database-4dc5cb173541?source=collection_archive---------2-----------------------#2022-09-27">https://itnext.io/how-to-handle-tens-of-billions-of-threat-intelligence-data-in-a-graph-database-4dc5cb173541?source=collection_archive---------2-----------------------#2022-09-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/1b1406e2a0131a2f9862aa79b314c087.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6Z98GXoz9u4mSISD.png"/></div></div></figure><h1 id="c030" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">为什么是图形数据库？</h1><p id="bb67" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">传统的关系数据库在处理复杂数据的关系操作时表现不佳。随着数据量和关系深度的增加，关系数据库不能有效地处理计算。</p><p id="6d42" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">因此，企业需要一个能够将关系信息存储为实体的数据库，以更好地反映数据之间的关系，并灵活地扩展数据模型。图形数据库是他们所需要的。</p><p id="482f" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">与传统的关系数据库相比，图数据库有以下两个优点:</p><p id="8b42" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">一是图形数据库可以表示数据之间的关系。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lz"><img src="../Images/0c1d8630900cc71bb64e2d7af57510f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fJe5wg26Wry_aviO.png"/></div></div></figure><p id="f366" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">从上图所示的图表模型中，您可以看到图表数据库旨在基于图表模型以直观的方式反映关系。它基于实体间关系的模型表达使得图形数据库具有可解释性。</p><p id="c388" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">另一个是图形数据库可以处理数据之间的关系。</p><ul class=""><li id="ccca" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt mj mk ml mm bi translated"><strong class="ky ir">高性能</strong>:JOIN操作主要处理传统关系数据库中的关系数据。随着数据量和关系深度的增加，由于多表连接和外键的限制，会给传统的关系数据库带来很大的额外开销，从而严重降低其性能。图形数据库的底层适应图形模型的数据结构，可以加快数据查询和数据分析。</li><li id="fa3c" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt mj mk ml mm bi translated"><strong class="ky ir">灵活性</strong>:图形数据库支持灵活的数据模型。用户可以调整他们的数据模型以适应他们的业务需求，例如添加或删除顶点和/或边，以及扩展或收缩图形模型。图形数据库使用户能够频繁地改变数据模式。</li><li id="6e0e" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt mj mk ml mm bi translated"><strong class="ky ir">敏捷</strong>:图形数据库支持的图形模型直观。图模型支持测试驱动的开发。每次构建图形数据库时，都可以进行功能测试和性能测试，这符合敏捷开发方法，有助于提高生产和交付效率。</li></ul><p id="ce11" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">由于这些优势，图数据库可以广泛应用于金融反欺诈、公共安全、刑事调查、社交网络、知识图、数据谱系、IT资产的运维以及威胁情报等领域。</p><p id="1866" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">快手威胁情报团队旨在整合由移动客户端、Web客户端、云客户端、广告联盟数据和小程序组成的整个链条中的安全数据，使公司拥有统一的基础安全能力，从而赋能公司的业务。</p><p id="fa0b" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">威胁情报的特点是实体的多样性、关系的复杂性、数据标签的丰富性等。因此，使用图形数据库来存储威胁情报数据是最合适的。</p><h1 id="f016" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">为什么是星云图？</h1><p id="b1c1" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">通过需求收集和研究，快手威胁情报团队最终决定使用NebulaGraph数据库作为其在生产环境中的图形数据库解决方案。</p><h1 id="1e2b" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">收集需求</h1><p id="4344" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">写和查询数据是为快手选择图形数据库解决方案的主要重点。</p><ol class=""><li id="ed40" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt ms mk ml mm bi translated">关于写数据:离线+在线</li></ol><ul class=""><li id="79b4" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt mj mk ml mm bi translated">数据库必须支持每天生成的所有数据的批量离线导入。在该平台上，每天可能会产生数百亿条关系数据，所有数据必须在数小时内写入数据库。</li><li id="051a" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt mj mk ml mm bi translated">数据库需要支持实时数据写入。弗林克消耗卡夫卡的数据。数据经过处理后，将直接从Flink实时导入图形数据库。成千上万的QPS需要支持。</li></ul><p id="fc1b" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">2.关于查询数据:数据库需要支持毫秒级的在线实时查询。五万QPS需要支援。</p><ul class=""><li id="0465" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt mj mk ml mm bi translated">按属性过滤和查询顶点和边</li><li id="e3ce" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt mj mk ml mm bi translated">查询关系的多跳</li></ul><p id="9b4a" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">3.一些基本的图形数据分析功能</p><ul class=""><li id="a352" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt mj mk ml mm bi translated">寻找从一个顶点到另一个顶点的最短路径的算法，等等。</li></ul><p id="7ecf" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">总之，为大数据架构选择的图形数据库解决方案需要具备三个基本能力:实时和离线写入数据、在线查询图形数据和基本OLAP能力，这要求图形数据库支持基本OLAP和在线、并发、低延迟OLTP。</p><h1 id="fb19" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">选择一个解决方案</h1><p id="36bd" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">基于上述需求，在选择图形数据库解决方案时，我们主要考虑以下因素:</p><ul class=""><li id="51fd" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt mj mk ml mm bi translated">图形数据库能够处理的数据量必须足够大，因为企业级应用通常会产生数百亿甚至数千亿的图形数据。</li><li id="8026" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt mj mk ml mm bi translated">群集必须是可扩展的，因为有必要在不停止生产环境中的服务的情况下在线横向扩展群集。</li><li id="1b9f" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt mj mk ml mm bi translated">查询必须以毫秒为单位执行，因为数据库需要满足在线服务的性能要求，图形数据量的增加不应该降低查询性能。</li><li id="91c2" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt mj mk ml mm bi translated">该数据库需要与HDFS和Spark等大数据解决方案轻松连接，稍后可以基于它构建图形计算平台。</li></ul><h1 id="8709" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">星云图的特征</h1><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mt"><img src="../Images/94d21719bc59aa4ea068c26be71bc039.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7R2Z_mlzAhTB-zJd.png"/></div></div></figure><ol class=""><li id="e8d8" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt ms mk ml mm bi translated">高性能:在毫秒内读写数据。</li><li id="d7ed" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt ms mk ml mm bi translated">可伸缩性:支持缩放和存储超大尺寸的图形。</li><li id="cfe3" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt ms mk ml mm bi translated">引擎架构:计算和存储的分离。</li><li id="606d" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt ms mk ml mm bi translated">图形数据模型:顶点和边。支持对顶点或边的属性建模。</li><li id="0e52" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt ms mk ml mm bi translated">图形查询语言:nGQL，一种类似SQL的查询语言，并且易学易用。它可以满足复杂的业务需求。</li><li id="ed08" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt ms mk ml mm bi translated">为导入和导出数据提供多样化的工具。</li><li id="cb17" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt ms mk ml mm bi translated">星云图社区非常活跃。</li><li id="f6d5" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt ms mk ml mm bi translated">NebulaGraph在查询性能上优于JanusGraph和HugeGraph。</li></ol><p id="a40a" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">NebulaGraph的所有这些特性准确地回答了我们的需求，这些场景使我们最终决定在我们的生产环境中使用NebulaGraph。</p><h1 id="9222" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">威胁情报的图形数据建模</h1><p id="9246" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">如下图所示，从情报角度来看，分层防御的自下而上的对策难度增加。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/339d74ae6f6d320f0d7eaa70df181837.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xwny8u91iGEspDS5.png"/></div></div></figure><p id="999f" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">攻击者和防御者先前在每一层上都处于单独的对抗行动中。现在，在应用了图形数据库之后，每一层上的实体id都可以通过特定的关系链接在一起，形成一个三维的层次网络。通过使用这样的网络，公司可以迅速掌握攻击方法、作弊工具、团伙特征等信息。</p><p id="eaaf" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">因此，基于安全数据的图建模可以将原来的二维平面识别变成三维识别，可以帮助我公司更加清晰准确地识别攻击和风险。</p><h1 id="d0e9" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">基本图形模型</h1><p id="8241" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">威胁情报的图建模的主要目的是不仅通过其状态和属性，而且通过从网络角度考虑维度来识别维度的风险，这意味着异构图和同构图中的数据关系应该用于识别维度的风险。</p><p id="64b5" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">以设备风险为例。设备可能涉及网络层、设备层、帐户层和用户层。在每一层上，设备可以由一个实体ID来表示。在图形数据库的帮助下，我们可以完成一个设备的三维风险识别，这对风险识别非常有帮助。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/8c1171d646c974f75e060fe78ce4f68c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tlC_BjDsp6aMV930.png"/></div></div></figure><p id="325d" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">上图显示了威胁情报数据的基本图形建模。它构成了一个基于威胁情报的知识图。</p><h1 id="a79b" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">动态图模型</h1><p id="02ac" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">除了基本图模型中的元素，我们还需要考虑每个关系都是时间敏感的，即在区间A中存在的关系在区间b中可能不再存在。因此，我们希望用于威胁情报的图数据库能够真实地反映跨不同时间区间的现实世界关系。</p><p id="b7b2" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">这意味着数据库必须能够根据查询时间间隔返回不同图模型的数据，我们称之为动态图模型。</p><p id="a1c0" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">为了对动态数据建模，出现了一个问题:根据查询时间间隔，应该返回什么边类型？</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/2c1f91a78427570e712c6470573d229a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*R0LanHz2cNl8oQqr.png"/></div></div></figure><p id="59a2" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">如上图所示，在查询时间间隔B、C或D中，应返回指定的边，但在查询时间间隔A或E中，不应返回此边。</p><h1 id="6f40" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">加权图结构</h1><p id="db52" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">为了检测地下经济犯罪的团伙或作恶者，经常会出现这种情况:一个设备可能会关联许多帐户，其中一些帐户经常被犯罪分子自己使用，其他帐户则被他们购买用于非法直播。为了配合公安或法律事务部门打击非法活动，我们需要准确区分哪些账户是犯罪分子常用的，哪些是他们为非法行为购买的正义账户。</p><p id="29d6" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">这也是为什么账户和设备的关系要加权的原因:如果一个账户通常使用一个设备，说明这个账户和这个设备是强关联的，所以关系的权重更高；如果一个帐户使用该设备进行地下经济犯罪或进行直播，则意味着该帐户与该设备的联系较弱，相应地，这种关系的权重较低。</p><p id="0a00" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">因此，我们的边不仅具有时间属性，还具有权重。</p><p id="f4d8" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">总之，最终为威胁情报数据创建了加权时间演化图模型。</p><h1 id="e2f6" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">基于图数据库的威胁情报服务体系结构及优化</h1><p id="b6c5" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">下图显示了威胁情报服务的整体架构。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/555e601dbd60f0a5bc5bc6af0ba977d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*w-fqZKSv-Lv7amUS.png"/></div></div></figure><p id="4c1c" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">威胁情报服务的整体架构</p><p id="2704" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">该架构具有基于图形数据库的集成智能查询平台。其架构如下图所示。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi my"><img src="../Images/3629866d8c3a81f2a6f91956a6189915.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*i-eBVJ1bZ6bWgWg6.png"/></div></div></figure><p id="2b08" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">综合智能查询平台的总体架构</p><p id="1a34" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">注意:AccessProxy用于从企业专用网络访问IDC，kngx用于在IDC内部直接调用。</p><h1 id="4fb5" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">离线写数据的优化</h1><p id="7927" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我们需要构建的关系数据可能每天都在数十亿次地更新。要保证这么大的数据量能在几个小时内写完，数据异常能被感知，数据不会丢失，这是一个非常具有挑战性的任务。优化集中在失败重试、脏数据发现和导入失败警报策略上。</p><p id="9c50" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">在数据导入过程中，脏数据、服务器弹跳、nebula-graphd进程崩溃、写入数据过快等各种因素都可能导致批量写入数据失败。通过使用同步客户端API、多级重试和失败后退出策略，我们解决了由于服务器端反弹或重启而导致的写入失败或批量写入不完整的问题。</p><h1 id="b662" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">双集群的高可用性和切换</h1><p id="814a" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在快手，部署了两个图形数据库集群，一个用于在线，另一个用于离线。采用同步双写技术向两个集群写入数据。线上集群提供在线RPC服务，线下集群提供案例分析和WEB查询服务。两个集群相互独立。</p><p id="490a" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">此外，状态监控模块和动态配置分发模块是连接在一起的，即当一个集群出现慢速查询或故障时，动态配置分发模块将无缝完成集群切换。</p><h1 id="16d6" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">4.3集群稳定性</h1><p id="381a" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我们的数据架构团队已经完成了对NebulaGraph社区版的研究、维护和改进。</p><p id="be76" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">NebulaGraph采用计算和存储分离的设计。它由三个服务组成:元、图形和存储。他们分别负责元数据管理、计算和存储。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mt"><img src="../Images/7d5af1886f13dbbe84e2d1a026b2aa4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ysVQxtJmFi3UzBWq.png"/></div></div></figure><p id="fbba" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">NebulaGraph的整体架构</p><p id="5c4d" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">NebulaGraph的存储层是图形数据库引擎的基础。它支持多种商店类型。我们采用经典的实现，RocksDB用C++实现，用于KV存储和Raft共识机制，这使得集群能够动态地伸缩。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mz"><img src="../Images/935c8b591419164e6e06a24289f0b3e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5GM0BF2_yVkSe1_B.png"/></div></div></figure><p id="f9db" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">存储层架构</p><p id="c2ef" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">我们对存储层进行了充分的测试，改进了它的代码，优化了它的参数，包括优化Raft心跳机制，改进了leader选举机制和log offset实现，调优了Raft参数，提高了单个集群的故障恢复时间。我们还优化了客户端的失败重试机制。所有这些使我们的图形数据库更加用户友好。例如，在优化之前，中断可能是由故障引起的，但是现在数据库可以在故障后几毫秒内恢复。</p><p id="6456" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">关于监控和报警系统，我们已经对集群的多个级别实施了监控。总体监控架构如下图所示。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/5f9e95c0c3c7846ddf7d4fcc102312e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*s_fe3y1yzrCiGfhH.png"/></div></div></figure><p id="8316" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">集群监控架构</p><p id="4005" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">监控以下指标:</p><ol class=""><li id="66e6" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt ms mk ml mm bi translated">硬件:CPU忙、磁盘工具、内存、网络等等。</li><li id="4641" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt ms mk ml mm bi translated">群集中元服务、存储服务和图形服务的接口，以及分区领导者的在线状态和分布。</li><li id="bb66" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt ms mk ml mm bi translated">从用户的角度评估集群的可用性。</li><li id="4646" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt ms mk ml mm bi translated">收集和监视群集中的元、存储、RocksDB和图形的指标</li><li id="e16b" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt ms mk ml mm bi translated">缓慢的查询。</li></ol><h1 id="5282" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">超级节点查询的优化</h1><p id="5196" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在现实世界的图模型中，顶点的出度一般符合幂律分布的特征，所以图遍历过程中的超级节点(出度数百万甚至数千万的顶点)会造成明显的查询缓慢。如何稳定在线查询的时间消耗，避免极其耗时的情况发生，是我们需要解决的问题。</p><p id="f8bb" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">图遍历中超节点问题的解决方案是在可接受的业务条件下减少规模。下面是它的实现方式:</p><ol class=""><li id="631a" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt ms mk ml mm bi translated">使用适当的限制子句截断结果。</li><li id="3c3a" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt ms mk ml mm bi translated">以指定的比率对边缘进行采样。</li></ol><p id="7e00" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">现在，让我们看看如何优化超级节点查询。</p><h2 id="06a4" class="na jz iq bd ka nb nc dn ke nd ne dp ki lh nf ng km ll nh ni kq lp nj nk ku nl bi translated">使用限制</h2><p id="348f" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated"><strong class="ky ir">先决条件</strong></p><p id="5883" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">从商业角度来看，使用LIMIT来截断每个跃点查询的结果是可以接受的。以下面的查询为例。</p><pre class="ma mb mc md gt nm nn no np aw nq bi"><span id="e572" class="na jz iq nn b gy nr ns l nt nu"># Executing the LIMIT clause until the end. <br/>go from hash('x.x.x.x') over GID_IP REVERSELY where (GID_IP.update_time &gt;= xxx and GID_IP.create_time &lt;= xxx) yield GID_IP.create_time as create_time, GID_IP.update_time as update_time, $^.IP.ip as ip, $$.GID.gid | limit 100 </span><span id="1097" class="na jz iq nn b gy nv ns l nt nu"># Executing the LIMIT clause on the query result first, and then executing the next query.<br/>go from hash('x.x.x.x') over GID_IP REVERSELY where (GID_IP.update_time &gt;= xxx and GID_IP.create_time &lt;= xxx) yield GID_IP._dst as dst | limit 100 | go from $-.dst ..... | limit 100</span></pre><p id="e716" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><strong class="ky ir">优化前</strong></p><p id="0165" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">在存储层，遍历从一个顶点出发的所有外出有向边，在图层，执行LIMIT子句，直到结果返回给客户端，其中大量耗时的操作是不可避免的。另外，虽然NebulaGraph支持在存储层级别(<code class="fe nw nx ny nn b">max_edge_returned_per_vertex</code>)配置一个顶点扫描的最大出度，但是不支持在查询语句级别灵活指定限制，在多跳查询多个顶点的出度时，无法在语句级别进行精确限制。</p><p id="5836" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><strong class="ky ir">如何优化</strong></p><p id="e92f" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">单跳GO遍历分两步执行:</p><ul class=""><li id="c8da" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt mj mk ml mm bi translated">步骤1:扫描一个顶点(srcVertex)的所有向外有向边(destVertex)，获得边的性质。</li><li id="48cc" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt mj mk ml mm bi translated">步骤2:获取所有destVertex的属性值。</li></ul><p id="1c1a" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">对于多跳GO遍历，每个跳查询可以在两种情况下执行:</p><ul class=""><li id="f370" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt mj mk ml mm bi translated">案例1:只执行步骤1。</li><li id="b846" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt mj mk ml mm bi translated">情况2:执行步骤1和步骤2。</li></ul><p id="e28f" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">步骤2花费了整个查询的大部分时间。例如，需要一个RocksDB迭代器操作来查询destVertex的每个属性，如果没有发生缓存命中，这需要500 μs。因此，对于那些具有大量向外有向边的顶点，在步骤2之前执行LIMIT子句是关键。此外，执行步骤1中的LIMIT子句对超级节点有更大的好处。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/7ae438a980a1c62dbb9161e744ac6bb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IS9LSx2_dcc9e2vf.png"/></div></div></figure><p id="4633" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">下表列出了使用LIMIT子句优化查询的情况及其好处。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/8166855c4d83fd75eee269dc9e8b02ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*d8Vww2Bm1JtBmbi9.png"/></div></div></figure><p id="283c" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">注意:N代表一个顶点的出度；n代表极限n；scan表示扫描出度的消耗；get表示获取顶点属性的消耗。</p><p id="f2f9" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><strong class="ky ir">测试结果</strong></p><p id="32e3" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">从上表可以看出，通过优化LIMIT子句，案例1或案例2中的查询可以得到很大的改进。案例2适用于安全业务查询。例如，下表显示了在部署在三台机器上的集群上的情况2中针对限制100的测试结果，每台机器都配备了900 GB数据存储容量的单个磁盘(在没有发生RocksDB缓存命中的情况下)。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/401b055c3d85b98c0a4bd15c536184c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1170/format:webp/0*6Xxbwvw3xs6-Fk-7.png"/></div></figure><p id="0661" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">测试结果表明，优化后超级节点查询的时间消耗大大降低。</p><h2 id="0fd8" class="na jz iq bd ka nb nc dn ke nd ne dp ki lh nf ng km ll nh ni kq lp nj nk ku nl bi translated">采样边缘</h2><p id="c9b0" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我们可以使用储层采样算法来解决无法使用优化限制子句的情况。NebulaGraph支持配置星云存储进程级别上每个顶点的最大出度，并启用油藏采样算法。基于这些特性，我们决定让图形数据库支持以下特性:</p><ol class=""><li id="ca6e" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt ms mk ml mm bi translated">当储层采样算法为星云存储过程启用时，<code class="fe nw nx ny nn b">max_iter_edge_for_sample</code>可配置为指定要扫描的边数。默认情况下，将扫描所有边缘。</li><li id="55be" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt ms mk ml mm bi translated">图表服务支持在GO查询的每一跳对边进行采样。</li><li id="b76c" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt ms mk ml mm bi translated"><code class="fe nw nx ny nn b">enable_reservoir_sampling</code>和<code class="fe nw nx ny nn b">max_edge_returned_per_vertex</code>的配置可以在会话级有效。</li></ol><p id="a6f6" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">有了这些特性，业务端可以更灵活地调整采样比例，以控制遍历规模，实现在线服务的流畅。</p><h1 id="40bb" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">改进和优化查询客户端</h1><p id="2c1d" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">开源的NebulaGraph有自己的客户。我们通过以下两种方式改进和优化了这些客户端，使其适合快手的项目:</p><ul class=""><li id="2b87" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt mj mk ml mm bi translated"><strong class="ky ir">连接池</strong>:nebula graph提供的客户端底层接口需要创建并初始化一个连接，执行查询，并为每个查询关闭连接。在高频查询场景中，频繁地创建和关闭连接对系统的性能和稳定性是有害的。在实践中，我们采用连接池技术对客户端进行重新封装，并监控每个连接的整个生命周期，以重用和共享连接，提高了业务的稳定性。</li><li id="9734" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt mj mk ml mm bi translated"><strong class="ky ir">自动故障转移</strong>:通过定期检测和监控连接创建、初始化、查询和销毁阶段的异常，实现了图形数据库集群中故障节点的实时发现和自动移除。如果整个集群不可用，服务可以在几秒钟内迁移到备份集群，这降低了集群故障对在线服务可用性的潜在影响。</li></ul><h1 id="7f5a" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">可视化和下载查询结果</h1><p id="04f3" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">对于那些固定关系的查询(使用固定的nGQL语句)，前端会在自定义的图形界面中显示返回的结果，如下图所示。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/5e72c920652fd460cd868b5eaa8a3431.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sC_9nVohbOWHs1p9.png"/></div></div></figure><p id="9077" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">如上图所示，前端采用ECharts显示图形数据，在加载和显示数据方面做了一些优化。</p><p id="b7f0" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><strong class="ky ir">问题1 </strong>:关系图需要能够显示每个顶点的细节，但是ECharts提供的图表只能显示数值。解决方案:修改源代码，通过添加一个模态来显示更多细节，从而为每个顶点添加一个单击事件。</p><p id="7a9e" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><strong class="ky ir">问题二</strong>:点击事件触发后，关系图会长时间处于旋转状态，可能无法识别点击的是哪个节点。解决方法:在图形第一次渲染时获取窗口中每个顶点的位置，在click事件触发后固定每个顶点的位置。</p><p id="26e4" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><strong class="ky ir">问题3 </strong>:如果一个图包含很多顶点，那么它们会以拥挤的方式显示。解决方案:使用户能够使用鼠标以图形方式缩放、平移和漫游图形。</p><p id="0f74" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">对于那些灵活关系的查询(使用灵活的nGQL语句)，我们部署了NebulaGraph Studio来可视化结果，如下图所示。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/f631943a3b5cee611f3ea741bd48f8bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kMEjEU-nYeoXZce_.png"/></div></div></figure><h1 id="3905" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">图形数据库在威胁情报中的应用</h1><p id="6f90" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">基于图形数据库的架构和优化，我们提供了Web和RPC两种访问方式，在快手主要支持以下服务:</p><ul class=""><li id="17ad" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt mj mk ml mm bi translated">追踪追查，打击线下违法行为，快手安全地下经济犯罪分析。</li><li id="8e15" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt mj mk ml mm bi translated">商业安全的风险控制与反欺诈</li></ul><p id="fea7" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">例如，群控设备的图形数据所代表的特性不同于普通设备的特性，如下图所示。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oe"><img src="../Images/7fb053dbf104f7d6faee563cfd70d0b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*X8MhfnFN3PsuCX4j.png"/></div></div></figure><p id="bad5" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">正常的IP地址和设备应该是这样的。</p><p id="6b15" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">下图显示了如何在图形中表示成组控制的设备。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi of"><img src="../Images/de509de9b7a846a37701c711bc7ea84d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ST1JfbGwCZXRG5pW.png"/></div></div></figure><p id="30a9" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">中间的顶点代表一个IP地址。与之相连的所有顶点都代表受组控制的设备。</p><h1 id="887e" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">结论和期望</h1><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi og"><img src="../Images/3a6ff804ba5b3c89ebacba0c78bacc7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cbrehZ6l_1kacroF.png"/></div></div></figure><ul class=""><li id="b055" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt mj mk ml mm bi translated"><strong class="ky ir">保证和提高稳定性</strong>:实现HA集群跨可用区的实时同步和自动接入切换，保证99.99%的SLA。</li><li id="7933" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt mj mk ml mm bi translated"><strong class="ky ir">提升性能</strong>:计划更新RPC和AEP的硬件存储解决方案，优化查询执行计划</li><li id="5e37" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt mj mk ml mm bi translated"><strong class="ky ir">使图形计算平台能够与图形查询引擎通信</strong>:构建图形计算、图形学习和图形查询的集成平台。</li><li id="197b" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt mj mk ml mm bi translated"><strong class="ky ir">支持实时检测</strong>:编写实时关系，识别实时风险。</li></ul><p id="eeab" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">加入NebulaGraph <a class="ae oh" href="https://join.slack.com/t/nebulagraph/shared_invite/zt-7ybejuqa-NCZBroh~PCh66d9kOQj45g" rel="noopener ugc nofollow" target="_blank"> Slack </a>频道，了解更多关于图形数据库的信息！</p></div></div>    
</body>
</html>