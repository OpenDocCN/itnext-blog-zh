<html>
<head>
<title>How to deploy a single Kubernetes cluster across multiple clouds using k3s and WireGuard</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用k3s和WireGuard跨多个云部署单个Kubernetes集群</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-deploy-a-single-kubernetes-cluster-across-multiple-clouds-using-k3s-and-wireguard-a5ae176a6e81?source=collection_archive---------1-----------------------#2021-05-11">https://itnext.io/how-to-deploy-a-single-kubernetes-cluster-across-multiple-clouds-using-k3s-and-wireguard-a5ae176a6e81?source=collection_archive---------1-----------------------#2021-05-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/eea63efa51199de56c95e4eae8710edb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AoTH0iO1eX0vfj2y2p2ytw.png"/></div></div></figure><div class=""/><p id="d976" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Kubernetes已经够难的了，现在你的老板让你把你的应用从AWS迁移到Azure，把你的后端和前端拆分在公共和私有数据中心，同时部署到六个不同的环境。</p><p id="73f9" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在你决定辞去你全新的DevOps工作之前，让我们看看我们是否能以一种更简单的方式来设置它。</p><p id="ece4" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">环顾四周，您会发现有许多工具可以跨环境管理多个Kubernetes集群，其中许多甚至可以帮助您部署应用程序。然而，这都提出了一个重要的问题:为什么要运行多个Kubernetes集群？</p><p id="9bbb" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Kubernetes是一个控制平面加上受管理的工作节点。为什么不能将这些工作节点部署到不同的环境中，然后一劳永逸呢？</p><p id="f910" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您通常会听到两种答案:</p><ol class=""><li id="039f" class="kw kx jb ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">你不能这样做，因为有延迟。</li><li id="edf2" class="kw kx jb ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">出于安全考虑，你不能这么做。</li></ol><p id="5aee" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好吧，我在这里告诉你，你可以做到这一点，这比你想象的要容易。</p></div><div class="ab cl lk ll hu lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="ij ik il im in"><h1 id="65a4" class="lr ls jb bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated"><strong class="ak">解决方案</strong></h1><p id="9cfd" class="pw-post-body-paragraph jy jz jb ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated"><strong class="ka jc"> 1。你不能这样做，因为有延迟。</strong>好吧，我们就继续使用<a class="ae mu" href="https://rancher.com/docs/k3s/latest/en/" rel="noopener ugc nofollow" target="_blank"> k3s </a>。Kubernetes的延迟问题是由于E <a class="ae mu" href="https://etcd.io/docs/v3.3/op-guide/hardware/" rel="noopener ugc nofollow" target="_blank"> tcd </a>造成的，它对低性能环境很敏感。K3s允许您使用没有这个问题的SQL。另一种方法可能是让您的主服务器位于同一位置，同时分散工作人员。如果你对Etcd的延迟不耐受有不同的建议/解决方案，请在评论中发表。</p><p id="b9b3" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc"> 2。出于安全考虑，你不能这么做。</strong>我们将在<a class="ae mu" href="https://www.wireguard.com/" rel="noopener ugc nofollow" target="_blank">铁丝网</a>上运行这个。WireGuard棒极了。您可以在这里<a class="ae mu" href="https://www.techradar.com/vpn/what-is-wireguard" rel="noopener ugc nofollow" target="_blank">了解更多信息</a>，但总而言之，我们可以在所有节点之间创建加密隧道，以确保流量安全，同时最大限度地减少对延迟的影响。</p><p id="e7b0" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然而，在#2中有一个小问题。对于极少数保持不变的机器，您可以只手动配置WireGuard。</p><p id="e1cc" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然而，对于较大的或动态的网络，WireGuard很快就变成了PITA，无法自动管理和配置。假设我们想要动态地在集群中添加和删除节点。我们可能需要第三方工具。</p><p id="49ad" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有许多工具可以简化WireGuard管理，但我们将使用<a class="ae mu" href="https://github.com/gravitl/netmaker" rel="noopener ugc nofollow" target="_blank"> Netmaker </a>。为什么？部分原因是因为是我写的！但是对于这个用例，它也工作得很好。然而，如果你不喜欢它，你可以使用<a class="ae mu" href="https://github.com/squat/kilo" rel="noopener ugc nofollow" target="_blank">基洛</a>、<a class="ae mu" href="https://github.com/gravitational/wormhole" rel="noopener ugc nofollow" target="_blank">虫洞</a>、<a class="ae mu" href="https://github.com/mawalu/wireguard-private-networking" rel="noopener ugc nofollow" target="_blank"> Ansible脚本</a>，或者外面几十个wire guard配置管理器工具中的一个<a class="ae mu" href="https://awesomeopensource.com/projects/wireguard" rel="noopener ugc nofollow" target="_blank">。或者，手动设置即可。Arch有好的</a><a class="ae mu" href="https://wiki.archlinux.org/title/WireGuard" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="742d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好了，准备好开始了吗？</p><p id="3712" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">顺便说一句，如果你更喜欢视觉学习，你也可以跟随这个</strong> <a class="ae mu" href="https://youtu.be/z2jvlFVU3dw" rel="noopener ugc nofollow" target="_blank"> <strong class="ka jc"> YouTube教程</strong> </a> <strong class="ka jc">。</strong></p></div><div class="ab cl lk ll hu lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="ij ik il im in"><h1 id="6c34" class="lr ls jb bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated"><strong class="ak">设置</strong></h1><p id="7e4b" class="pw-post-body-paragraph jy jz jb ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">几个小提示:我正试图保持这个简短和甜蜜。因此，我们不会设置DNS、存储或高可用性。所有这些都很容易在我们正在部署的基础上进行设置，但是我们将在以后的文章中进行讨论。这仅用于演示目的，不应在生产中运行。</p><p id="15cd" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">给自己弄几个云虚拟机。在哪里并不重要，他们只需要公共IP。在我的配置中，我有一个Linode、两个AWS EC2和一台家庭网络上的机器。三个将充当集群，一个将运行Netmaker。</p><p id="cf1b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">那么，让我们设置我们的节点。在每台机器上，安装Ubuntu 20.04。如果你喜欢其他的操作系统，一堆其他的操作系统也可以工作，但是我们推荐基于systemd的linux(愤怒地把你的电脑扔出窗外)。</p><p id="8cb1" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">在每个集群节点上，安装wireguard工具。(例如安装电线保护工具)</strong></p><p id="0a79" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">在Netmaker虚拟机上，安装docker和docker-compose: </strong></p><ol class=""><li id="1893" class="kw kx jb ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><a class="ae mu" href="https://docs.docker.com/engine/install/ubuntu/" rel="noopener ugc nofollow" target="_blank">码头工人</a></li><li id="743d" class="kw kx jb ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae mu" href="https://docs.docker.com/compose/install/" rel="noopener ugc nofollow" target="_blank"> docker-compose </a></li></ol><p id="0f4a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，确保在Netmaker虚拟机上打开端口80、8081和50051。</p></div><div class="ab cl lk ll hu lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="ij ik il im in"><h1 id="d107" class="lr ls jb bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated"><strong class="ak">第1部分:Netmaker安装/ WireGuard设置</strong></h1><p id="0edf" class="pw-post-body-paragraph jy jz jb ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">我们首先需要的是一个平面的、安全的网络，供我们的集群节点进行通信。我们将创建一个“虚拟”子网10.11.11.0/24，并将我们的节点添加到其中。</p><p id="e4f5" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">ssh root@netmaker-vm</code></p><p id="9587" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">wget -O docker-compose.yml <a class="ae mu" href="https://raw.githubusercontent.com/gravitl/netmaker/master/docker-compose.nodns.yml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/gravitl/netmaker/master/docker-compose.nodns.yml</a></code></p><p id="2f02" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">sed -i ‘s/your-backend/&lt; Your VM IP Address Here &gt;/g’ docker-compose.yml</code></p><p id="8f15" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">sudo docker-撰写up -d</p><p id="3261" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就是这样！现在转到EC2实例的IP，我们应该得到Netmaker的UI。</p><figure class="na nb nc nd gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/9ed0f8ba62619fdd650a45f3eed3dba9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*trajD67NyGwXCf841VCaYQ.png"/></div></div></figure><p id="6a90" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个用户并使用它登录。</p><p id="1820" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们制作一个名为k3s的网络。只需点击左上角的“创建网络”。我们将其命名为k3s，地址范围为10.11.11.0/24</p><figure class="na nb nc nd gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ne"><img src="../Images/e4f0bcc5099cba30c666d6d99a23b308.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cq3ND-lXmEKYktVfHJlPqA.png"/></div></div></figure><p id="d185" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完美。现在我们准备设置我们的节点。首先，点击“访问密钥”，选择您的网络(k3s)并创建一个密钥。名称并不重要，但我们将称它为k3s-key，并给它1000次使用。嘿，你永远不知道，这可能会成为一个大集群。点击创建并复制信息，<strong class="ka jc">特别是安装脚本。(curl -sfL … | KEY=… sh -) </strong></p><figure class="na nb nc nd gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nf"><img src="../Images/948384efda73d7f1cdebd6ed7bc38890.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*URxBQ8Ynely8j_6smfvQKw.png"/></div></div></figure><p id="3f2e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在是时候在集群虚拟机上部署netclient了。SSH到每个Ubuntu虚拟机，并运行以下命令。</p><p id="be14" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">在运行之前，确保您已经安装了wireguard-tools包。</strong></p><p id="9dfc" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">1.<code class="fe mv mw mx my b">which wg-quick</code></p><p id="9e8f" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.<code class="fe mv mw mx my b">sudo su -</code></p><p id="23c8" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.<code class="fe mv mw mx my b">curl -sfL <a class="ae mu" href="https://raw.githubusercontent.com/gravitl/netmaker/v0.3/scripts/netclient-install.sh" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/gravitl/netmaker/v0.3/scripts/netclient-install.sh</a> | KEY=&lt;YOUR ACCESS KEY FROM NETMAKER&gt; sh -</code></p><p id="91ed" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，快速查看WireGuard应该可以显示情况是否良好:</p><p id="3fc5" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">wg show</code></p><p id="9b23" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果wg show显示了每个节点上的界面，你应该就不错了！UI中的最后一项检查。应该是这样的。您应该看到所有的节点，它们应该是绿色的。</p><figure class="na nb nc nd gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ng"><img src="../Images/5abed511ebc931bdd5ae41d00bf36b14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sDGt_h9MIbgCNLBZ_baVdQ.png"/></div></div></figure><p id="3fda" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">看起来不错。如果你愿意的话，可以随意修改这些名字，使之更合理。我在改变我的来匹配我的布局。</p><figure class="na nb nc nd gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nh"><img src="../Images/a6492ec6670045a91a2d3ed4700407d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yXBK9FXegoJQ3hA_Re9X1Q.png"/></div></div></figure><p id="3cca" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以使用此过程将任意数量的节点添加到您的集群中，但是现在，让我们继续。</p></div><div class="ab cl lk ll hu lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="ij ik il im in"><h1 id="3e7a" class="lr ls jb bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated"><strong class="ak">第二部分:K3S安装</strong></h1><p id="e1a6" class="pw-post-body-paragraph jy jz jb ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">SSH到将成为您的主节点的节点，并运行以下命令:</p><p id="4019" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">sudo su -</code></p><p id="0ad6" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">ip a</code></p><p id="bf8b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你应该会在<code class="fe mv mw mx my b">nm-k3s</code>下面看到一个地址。用那个地址。如果您首先通过Netmaker在主服务器上安装了WireGuard，它应该是10.11.11.1。如果没有，请在下面的脚本中用您的地址替换。</p><p id="2368" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">curl -sfL <a class="ae mu" href="https://get.k3s.io" rel="noopener ugc nofollow" target="_blank">https://get.k3s.io</a> | INSTALL_K3S_EXEC=”server --node-ip 10.11.11.1 --node-external-ip 10.11.11.1 --flannel-iface nm-k3s” sh -</code></p><p id="0a51" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让烘烤大约5分钟。</p><p id="67e2" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">systemctl status k3s.</code></p><p id="2a57" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">kubectl get nodes</code></p><p id="709b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">kubectl get pods --all-namespaces</code></p><p id="ecb1" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">假设一切正常，所有的pod都在运行，您就可以部署工人了。但是首先，从服务器获取节点密钥:</p><p id="4299" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">cat /var/lib/rancher/k3s/server/node-token</code></p><p id="a140" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好了，现在，在您的每个工作节点上运行以下命令:</p><p id="b28c" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">sudo su -</code></p><p id="403c" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">ip a</code></p><p id="39c3" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">获取私有ip地址并运行以下命令，用服务器的输出<code class="fe mv mw mx my b">cat /var/lib/rancher/k3s/server/node-token</code>替换&lt; TOKEN VAL &gt;，用来自<code class="fe mv mw mx my b">ip a</code>的IP地址替换10.11.11.X，用主私有IP地址替换<code class="fe mv mw mx my b"><a class="ae mu" href="https://10.70.0.1:6443" rel="noopener ugc nofollow" target="_blank">10.11.11.MASTER</a></code>(例如10.11.11.1)。</p><p id="5c71" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">curl -sfL <a class="ae mu" href="https://get.k3s.io" rel="noopener ugc nofollow" target="_blank">https://get.k3s.io</a> | INSTALL_K3S_EXEC=”agent --server <a class="ae mu" href="https://10.70.0.1:6443" rel="noopener ugc nofollow" target="_blank">https://10.11.11.MASTER:6443</a> --token &lt; TOKEN VAL &gt; --node-ip 10.11.11.X --node-external-ip 10.11.11.X --flannel-iface nm-k3s” sh -</code></p><p id="3397" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">systemctl status k3s-agent</code></p><p id="a871" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">回到主界面，让我们看看事情是怎样的:</p><p id="b10c" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">sudo kubectl get nodes</code></p><p id="5c77" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">sudo kubectl get pods --all-namespaces -o wide</code></p><p id="afb7" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您的所有节点都显示出来，并且您已经在这些节点上运行了pod，那么您就一切就绪了！</p><figure class="na nb nc nd gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ni"><img src="../Images/c7de627a77e72ff9e911ab8c1a913d08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TDkuspriptNcnGpjQirgfA.png"/></div></div></figure><p id="27b2" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们确保这是真正的工作。我们的节点运行了，但是我们的pod和服务能跨云工作吗？让我们找出答案。</p></div><div class="ab cl lk ll hu lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="ij ik il im in"><h1 id="3f4c" class="lr ls jb bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated"><strong class="ak">第4部分:测试</strong></h1><p id="d2b3" class="pw-post-body-paragraph jy jz jb ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">部署pingtest。这些只是安装了“ping”的简单容器(<a class="ae mu" href="https://docs.projectcalico.org/getting-started/kubernetes/hardway/test-networking" rel="noopener ugc nofollow" target="_blank"> Calico </a>也有这方面的指南)。</p><p id="5ee6" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建pingtest.yaml</p><p id="d27e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">https://pastebin.com/BSqLnP57<a class="ae mu" href="https://pastebin.com/BSqLnP57" rel="noopener ugc nofollow" target="_blank">YAML</a></p><p id="6e11" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">kubectl create namespace pingtest</code></p><p id="623d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">kubectl apply -f pingtest.yaml</code></p><p id="a777" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">kubectl get pods -n pingtest -o wide</p><figure class="na nb nc nd gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nj"><img src="../Images/265e0ef51cf03f7c53ef18e310dc448d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LRsO9AH9yPUdbuKct2cdcA.png"/></div></div></figure><p id="aae9" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">很好，我们在所有3个节点上运行了3个pod。如果您的pingtest pods比nodes多，那么额外的pods将会被挂起(如上)，这对这个测试来说是没问题的。</p><p id="978e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，进入其中一个pod，ping另一个pod IP:</p><figure class="na nb nc nd gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nk"><img src="../Images/9176e0107a652e9fca6b49b5e1754470.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R_KJsM5nZSFKT3f3qrrjGQ.png"/></div></div></figure><p id="61a9" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">太好了！我们可以ping不同云中运行的pod。最后一次测试的时间到了。我们的<strong class="ka jc">服务网络</strong>能跨云工作吗？让我们部署一个nginx服务器，前面有一个负载均衡服务。</p><p id="8c9d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">https://pastebin.com/ttadjjDA:<a class="ae mu" href="https://pastebin.com/ttadjjDA" rel="noopener ugc nofollow" target="_blank">YAML</a></p><p id="9b9e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">kubectl create namespace nginx</code></p><p id="d173" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">kubectl apply -f nginx.yaml -n nginx</code></p><p id="ff27" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，exec返回到pingtest pod，该pod运行在与nginx pods不同的主机上，并尝试使用集群服务名获取index.html</p><p id="dd6a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">kubectl exec -ti pingtest-69ff695cfd-8svc8 -n pingtest -- sh</code></p><p id="192b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">wget nginx.nginx.svc.cluster.local</code></p><p id="8832" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您能够检索到文档，那么恭喜您，您已经为跨云Kubernete集群做好了准备！</p></div><div class="ab cl lk ll hu lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="ij ik il im in"><h1 id="8731" class="lr ls jb bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">结论</h1><p id="6842" class="pw-post-body-paragraph jy jz jb ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">那还不算太糟，是吗？我们使用K3S和WireGuard创建了一个跨越多个云的单一Kubernetes集群。如果我们想向它添加更多的节点，过程非常简单。只需在节点上运行Netmaker安装脚本和K3S安装脚本。</p><p id="df32" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还可以做很多事情，比如设置多个主服务器的高可用性，添加入口，以及创建分布式存储。</p><p id="1241" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，现在我们有了一个运行在多个云中的集群，我们可以使用许多新的部署模式。我们可以运行混合云应用程序，我们可以在云之间移动应用程序，以及许多其他事情。</p><p id="262a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还可以用一种特殊的方式部署Netmaker，这样在集群启动后，它就成为集群的一部分，不再需要额外的虚拟机。</p><p id="8d66" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然而，这些都是未来文章的主题。这只是设置跨云集群的一个简单介绍。现在，祝你好运！让我知道你在评论中遇到的任何问题。</p><p id="adf1" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你有兴趣讨论你的业务模式，你可以通过info@gravitl.com或https://gravitl.com/book.联系</p></div></div>    
</body>
</html>