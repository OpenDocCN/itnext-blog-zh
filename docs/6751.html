<html>
<head>
<title>Loki to the Rescue!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">洛基来救援了。</h1>
<blockquote>原文：<a href="https://itnext.io/loki-to-the-rescue-7c3cc0989a7?source=collection_archive---------2-----------------------#2022-02-17">https://itnext.io/loki-to-the-rescue-7c3cc0989a7?source=collection_archive---------2-----------------------#2022-02-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/25ad67bc8f388d55fd3af94866c6e8f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0T6pgc6dmQQ_-okh"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@janoschphotos?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">雅诺什·迪格尔曼</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="a0da" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在AWS中用Elasticsearch(技术上来说是OpenSearch)玩了一周之后，我们终于有了它！再见橡皮筋！</p><p id="4f37" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">简单介绍一下背景，目前我们将数据存储在Elastic中，用于长期存储和部分检索。有一个微服务将从Elastic提取数据供客户使用。我们可能没有像我们应该的那样使用Elastic，或者没有以“正确”的方式配置它，但是它有点工作。上周我们遇到了一个缩放事件。这一事件促使我们决定如何纵向或横向扩展。我们决定再添加2个数据节点(从2个增加到4个)或增加节点的大小。我们选择了2个额外的数据节点，假设我们可以分散负载，AWS将在4个节点之间重新平衡。我们知道的很少，没有那么多。经过相当长时间的希望，调整，摆弄不同的设置和毫无进展，我们不得不咬紧牙关，垂直增长。所以现在我们已经增加了大约14k/月的账单，我们可以处理负载。这是不可持续的，每一次扩展活动都会成倍增加我们在AWS上的支出，而几乎没有回报。</p><h1 id="6fa7" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">输入Grafana Loki</h1><p id="542f" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">几个月来，我们一直在关注替代品，并测试了一些替代品。好家伙，我们爱上了格拉法纳洛基！</p><p id="cc34" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">作为一个测试，我们决定通过Grafana头盔图把Grafana，Prometheus和Loki放入kubernetes星团，并尝试一下。Loki有两种模式，单二进制或微服模式；我们选择了微服务模式的掌舵图，因为我们知道我们需要在哪里发展，我们绝对需要微服务模式。我们希望最终扩展到每天180多亿次活动。所以最好从正确的方向开始。</p><p id="6752" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">初始安装有每个Loki组件(网关、分配器、ingester、查询前端、查询者、压缩器)、Grafana和prometheus的单个实例。</p><p id="72c0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们有了一个可操作的堆栈，是时候看看当我们向它扔数据时会发生什么了。这当然是令人兴奋的部分！Loki不关心格式化、解析、索引什么的。这太棒了！！我们从每天大约30GB的数据开始，看看每个组件只使用一个会发生什么，让我们完全惊讶的是，什么都没有，Loki只是查看日志，并在Grafana中向我们显示结果！</p><p id="d42f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Loki的一个奇怪之处是，你不索引数据，对于我们所有的数据库极客来说，它完全违背了我们所知道或信任的一切，但它是有效的。洛基在标签上工作，越少越好。最初的数据源之一是我们一个数据中心的Fortinet日志。我们用fluentd填充这些日志，并在此过程中添加了1个标签。在一天的日志(9.96 GB)中查询一个字符串在9.4秒内返回！为了与Elastic进行比较，相同的查询在7.4秒内返回，但是在磁盘上有索引，我们有21GB用于原始数据加上最小的索引。相比之下，我们有9.98GB的磁盘空间。</p><p id="0846" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这一切都是通过开箱即用的配置完成的。关于Loki的一件事是，它确实有很多旋钮可以调节，文档也不完全清楚。然而，Grafana Slack频道非常棒，如果您有任何问题，人们会很快做出回应。</p><h1 id="e650" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">我们现在去哪里？</h1><p id="dbe1" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">现在，我们正在努力将数据双重输入到Elastic和Loki中，同时重构与Elastic对话的代码，以便将其转移到Loki中。一旦完成，我们将数据迁移到Loki，我们将关闭我们的弹性实例，享受AWS的成本节约！</p><h1 id="1e82" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">一个忙</h1><p id="281e" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">如果你愿意的话，请花一分钟跟我来。我正试图通过新的媒体追随者的要求。</p></div></div>    
</body>
</html>