<html>
<head>
<title>Exponential Back-off Implemented in the form of an API Mount Adapter Class</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">以API挂载适配器类的形式实现的指数后退</h1>
<blockquote>原文：<a href="https://itnext.io/exponential-back-off-implemented-in-the-form-of-an-api-mount-adapter-class-9f1e5d735807?source=collection_archive---------5-----------------------#2022-06-12">https://itnext.io/exponential-back-off-implemented-in-the-form-of-an-api-mount-adapter-class-9f1e5d735807?source=collection_archive---------5-----------------------#2022-06-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="49fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个可重用/可扩展的实用程序类，使用控制理论自动将API接收到大规模的数据湖中</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/7f996c02d90011f230b0b923f1a67321.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z81n6QLuEocEjpyOcYqa7Q.png"/></div></div></figure><p id="2c00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">数据工程中最常见的工作流之一是将数据从第三方API接收到数据湖的原始层中。在规模上，随着速率限制的出现，这个问题开始变得更加复杂。因此，当向API发出数百万个请求时，需要一种智能的方法。<br/>在本文中，我将分享我的工具类来自动完成这项任务。您可以随意使用这里的代码，对其进行扩展，并添加特定于您的工作流的新功能，如处理不同形式的身份验证或发送定制的POST请求。事不宜迟，下面是适配器挂载类:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="kx ky l"/></div><figcaption class="kz la gj gh gi lb lc bd b be z dk translated">完整的连接器类</figcaption></figure><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="kx ky l"/></div><figcaption class="kz la gj gh gi lb lc bd b be z dk translated">使用PokeAPI的连接器类的用法示例</figcaption></figure><p id="c068" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> HTTP响应状态列表</strong></p><p id="84ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">理想情况下，我们希望重试以下HTTP错误响应:</p><ul class=""><li id="f73d" class="ld le iq jp b jq jr ju jv jy lf kc lg kg lh kk li lj lk ll bi translated">429:用户在给定的时间内发送了太多的请求(“速率限制”)。</li><li id="a5f3" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">500:服务器遇到了一个它不知道如何处理的情况。</li><li id="b969" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">502:此错误响应意味着服务器在作为网关获取处理请求所需的响应时，得到了无效的响应。</li><li id="60e8" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">503:服务器未准备好处理请求。常见原因是服务器停机维护或过载。请注意，除了这个响应之外，还应该发送一个解释问题的用户友好页面。这个响应应该用于临时情况，如果可能的话,<code class="fe lr ls lt lu b">Retry-After</code> HTTP头应该包含服务恢复之前的估计时间。网站管理员还必须注意与该响应一起发送的与缓存相关的头，因为这些临时条件响应通常不应该被缓存。</li><li id="c456" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">504:当服务器充当网关，不能及时得到响应时，给出此错误响应。</li></ul><p id="3cc8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">带重试算法的指数回退</strong></p><p id="179e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">API mount适配器的逻辑利用来自控制理论的算法，在接收到来自端点的错误响应后，智能地重试发送请求。为了不耗尽API，我们希望增加每次失败后发送请求的时间间隔，而不是以线性间隔无限重试。这个概念被称为“重试指数后退”。数学上它可以表示为:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lv"><img src="../Images/7debdcc99e9ded29e23e5300a94ac5f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:834/format:webp/1*sDqFdWVDcb26-N_2WHD-eA.png"/></div></div><figcaption class="kz la gj gh gi lb lc bd b be z dk translated">“带重试次数的指数后退”公式</figcaption></figure><p id="afb8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个示例配置是:</p><ul class=""><li id="9824" class="ld le iq jp b jq jr ju jv jy lf kc lg kg lh kk li lj lk ll bi translated">最大重试次数= 4</li><li id="678f" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">后退因子= 2</li></ul><p id="827f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么等待时间将是:<br/>第一次重试2秒，第二次重试4秒，第三次重试8秒，最后第四次重试16秒。如果请求仍然不成功，重试机制将停止。</p><p id="9e71" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">该类的其他功能</strong></p><p id="4caf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从write to bronze方法中可以看出，这个类既可以输出增量表，也可以输出parquet、Avro、JSON或CSV等格式的文件。这使得它可以针对不同的工作流进行高度配置，并允许您利用每种格式的不同优势，在这种情况下，您可能更喜欢parquet以获得压缩优势，或者JSON以获得动态模式读取优势。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lw"><img src="../Images/136337d6fc68537af224b994a6fe3210.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IIabzMoy-ZRWEvCMCB4gOQ.png"/></div></div><figcaption class="kz la gj gh gi lb lc bd b be z dk translated">最终增量表的摘录</figcaption></figure><p id="3feb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，该类还使您能够将一个基本URL挂载到HTTP和HTTPS URL，而不是在每次发送请求时都完全重写您的特定资源路径。该适配器还有一个重置方法，可以从一个端点上拔下它并从头开始。</p><p id="66a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">总而言之，我认为有一个可扩展的单个类作为主要参考点，可以让数据工程师在处理不同的工作流时不重复工作，并有效地协作和共享知识。希望你喜欢这篇文章，下次见！</p></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><p id="c9df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">来源:</p><ul class=""><li id="6509" class="ld le iq jp b jq jr ju jv jy lf kc lg kg lh kk li lj lk ll bi translated"><a class="ae me" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status#client_error_responses" rel="noopener ugc nofollow" target="_blank">https://developer . Mozilla . org/en-US/docs/Web/HTTP/Status # client _ error _ responses</a></li><li id="7263" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">【https://en.wikipedia.org/wiki/Exponential_backoff T2】号</li></ul></div></div>    
</body>
</html>