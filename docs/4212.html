<html>
<head>
<title>AWS: CloudFormation — using Conditions, Fn::Equals, and Fn::If — an example</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS: CloudFormation —使用条件、Fn::Equals和Fn::If —示例</h1>
<blockquote>原文：<a href="https://itnext.io/aws-cloudformation-using-conditions-fn-equals-and-fn-if-an-example-bf147336a25f?source=collection_archive---------2-----------------------#2020-05-17">https://itnext.io/aws-cloudformation-using-conditions-fn-equals-and-fn-if-an-example-bf147336a25f?source=collection_archive---------2-----------------------#2020-05-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/864cd9a29362859444f25f89f0b76993.png" data-original-src="https://miro.medium.com/v2/resize:fit:260/format:webp/0*AFhpnxWpmaV5i3Sz.png"/></div></figure><p id="292d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我有一个带有<a class="ae ks" href="https://rtfm.co.ua/aws-nastrojka-vpc-peering/" rel="noopener ugc nofollow" target="_blank">VPC peering</a>的云形成堆栈，在这种情况下，它是一个新的弹性Kubernetes服务集群的VPC和普罗米修斯监控堆栈的VPC之间的对等物。</p><p id="d519" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation/" rel="noopener ugc nofollow" target="_blank">AWS Elastic Kubernetes Service:a cluster creation automation，part 1 — CloudFormation </a>和<a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl/" rel="noopener ugc nofollow" target="_blank">AWS Elastic Kubernetes Service:a cluster creation automation，part 2 — Ansible，eksctl </a>的帖子中描述了EKS集群的堆栈及其整个自动化创建过程。</p><p id="db8f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">任务</strong>:增加一个选择能力，如果CloudFormation必须创建上面提到的对等，或者跳过这一步。</p><p id="4ffc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">解决方案</strong>:使用<a class="ae ks" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/conditions-section-structure.html" rel="noopener ugc nofollow" target="_blank"> AWS CloudFormation条件</a>:将添加一个新参数<code class="fe kt ku kv kw b">VPCPeeringCreate</code>，该参数将接受来自Jenkins作业的<em class="kx">真</em>值<em class="kx">假</em>，然后CloudFormation将根据该值决定是否需要创建这样的对等和相关资源——对等本身和两条路由。</p><p id="dbf2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这个任务变得有点复杂，因为我在这里使用了嵌套的栈，并且资源是由不同的栈创建的，所以要创建一个对等体，它使用:</p><ul class=""><li id="5214" class="ky kz iq jw b jx jy kb kc kf la kj lb kn lc kr ld le lf lg bi translated">根堆栈:</li><li id="206a" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated">将创建区域和可用性区域定位的堆栈</li><li id="d70f" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated">在区域堆栈中:</li><li id="e50c" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated">将创建<code class="fe kt ku kv kw b">AWS::EC2::VPCPeeringConnection</code></li><li id="25cd" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated">将使用普罗米修斯更新远程监控堆栈的路由表—将创建新的<code class="fe kt ku kv kw b">AWS::EC2::Route</code>(从监控VPC到EKS堆栈的VPC的路由)</li><li id="acd7" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated">在其<code class="fe kt ku kv kw b">Outputs</code>中将返回一个<em class="kx">MonitoringProdVPCPeeringConnectionID</em></li><li id="386f" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated">可用性区域-定位堆栈:</li><li id="4e33" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated">将抓取<em class="kx">MonitoringProdVPCPeeringConnectionID</em></li><li id="4d0b" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated">将创建一个<code class="fe kt ku kv kw b">AWS::EC2::Route</code>(从EKS集群的VPC专用子网到监控堆栈VPC的路由)</li></ul><p id="9d1d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以，让我们把它们一个一个地加起来，看看这是如何工作的。</p><h2 id="3872" class="lm ln iq bd lo lp lq dn lr ls lt dp lu kf lv lw lx kj ly lz ma kn mb mc md me bi translated">根堆栈</h2><p id="f7a2" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">在根栈的参数中增加一个新的参数叫做<em class="kx"> VPCPeeringCreate </em>，它可以接受<em class="kx">真</em>或<em class="kx">假</em>:</p><pre class="mk ml mm mn gt mo kw mp mq aw mr bi"><span id="2826" class="lm ln iq kw b gy ms mt l mu mv">{<br/>  "AWSTemplateFormatVersion": "2010-09-09",<br/>  "Description": "AWS CloudFormation stack for Kubernetes cluster",<br/><br/>  "Parameters": {<br/><br/>...<br/><br/>    "VPCPeeringCreate": {<br/>      "Description": "Create or not VPC peering connections",<br/>      "Type": "String",<br/>      "Default": true,<br/>      "AllowedValues": [<br/>          "true",<br/>          "false"<br/>      ]<br/>    }</span></pre><p id="c4d3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更新根堆栈模板中的区域堆栈资源-添加要传递给根堆栈模板的<em class="kx"> VPCPeeringCreate </em>参数:</p><pre class="mk ml mm mn gt mo kw mp mq aw mr bi"><span id="af7a" class="lm ln iq kw b gy ms mt l mu mv">"Resources": {<br/><br/>    "RegionNetworkStack": {<br/>      "Type": "AWS::CloudFormation::Stack",<br/>      "Properties": {<br/>        "TemplateURL": "eks-region-networking.json",<br/>        "Parameters": {<br/>          "VPCCIDRBlock": { "Ref": "VPCCIDRBlock" },<br/>          "VPCPeeringCreate": { "Ref":  "VPCPeeringCreate"}<br/>        }<br/>      }<br/>    },<br/>...</span></pre><h2 id="c9bb" class="lm ln iq bd lo lp lq dn lr ls lt dp lu kf lv lw lx kj ly lz ma kn mb mc md me bi translated">区域堆栈</h2><p id="7ea6" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">将接受<em class="kx"> VPCPeeringCreate </em> —删除此处的默认值，因为它将从根堆栈传递:</p><pre class="mk ml mm mn gt mo kw mp mq aw mr bi"><span id="4d51" class="lm ln iq kw b gy ms mt l mu mv">{<br/>  "AWSTemplateFormatVersion" : "2010-09-09",<br/>  "Description" : "AWS CloudFormation Region Networking stack for Kubernetes cluster",<br/><br/>  "Parameters" : {<br/>...<br/><br/>    "VPCPeeringCreate": {<br/>      "Description": "Create or not VPC peering connections",<br/>      "Type": "String",<br/>      "AllowedValues": [<br/>          "true",<br/>          "false"<br/>      ]<br/>    }<br/>  },<br/>...</span></pre><h2 id="7571" class="lm ln iq bd lo lp lq dn lr ls lt dp lu kf lv lw lx kj ly lz ma kn mb mc md me bi translated">情况</h2><p id="6580" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">现在—这里的主要部分:添加名为<em class="kx"> DoVPCPeeringCreate </em>的<code class="fe kt ku kv kw b">Conditions</code>，我们将使用<code class="fe kt ku kv kw b"><a class="ae ks" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-conditions.html#intrinsic-function-reference-conditions-equals" rel="noopener ugc nofollow" target="_blank">Fn::Equals</a></code>检查<em class="kx"> VPCPeeringCreate </em>的值，如果<em class="kx">为真</em>，则从条件中返回<em class="kx">为真</em>:</p><pre class="mk ml mm mn gt mo kw mp mq aw mr bi"><span id="3070" class="lm ln iq kw b gy ms mt l mu mv">...<br/>    "VPCPeeringCreate": {<br/>      "Description": "Create or not VPC peering connections",<br/>      "Type": "String",<br/>      "AllowedValues": [<br/>          "true",<br/>          "false"<br/>      ]<br/>    }<br/>  },<br/><br/>  "Conditions" : {<br/>    "DoVPCPeeringCreate" : {"Fn::Equals" : [ {"Ref" : "VPCPeeringCreate"}, true] }<br/>  },<br/><br/>...</span></pre><p id="f4f2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来，添加对<em class="kx">MonitoringProdVPCPeeringConnection</em>和<em class="kx">monitoringetoksprodpeerinroute</em>资源— <code class="fe kt ku kv kw b">"Condition" : "DoVPCPeeringCreate"</code>的检查:</p><pre class="mk ml mm mn gt mo kw mp mq aw mr bi"><span id="811f" class="lm ln iq kw b gy ms mt l mu mv">...<br/>    "MonitoringProdVPCPeeringConnection": {<br/>      "Type": "AWS::EC2::VPCPeeringConnection",<br/>      "Condition" : "DoVPCPeeringCreate",<br/>      "Properties": {<br/>        "VpcId": {<br/>          "Ref": "VPC"<br/>        },<br/>        "PeerVpcId": { "Fn::ImportValue" : "monitoring-production-VPC-ID" },<br/>        "PeerRegion": { "Fn::ImportValue" : "monitoring-production-StackRegion" },<br/>        "Tags": [<br/>          {<br/>            "Key": "Name",<br/>            "Value": { "Fn::Join": [ "-", [ {"Ref": "AWS::StackName"}, "vpc-monitoring-prod"] ] }<br/>          }<br/>        ]<br/>      }<br/>    },<br/><br/>    "MonitoringToEksProdPeeringRoute": {<br/>      "Type": "AWS::EC2::Route",<br/>      "Condition" : "DoVPCPeeringCreate",<br/>      "Properties": {<br/>        "RouteTableId": { "Fn::ImportValue" : "monitoring-production-VPC-PublicRouteTable" },<br/>        "DestinationCidrBlock": { "Ref": "VPCCIDRBlock" },<br/>        "VpcPeeringConnectionId": {<br/>          "Ref": "MonitoringProdVPCPeeringConnection"<br/>        }<br/>      }<br/>    },<br/>...</span></pre><p id="f40d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，如果<em class="kx"> DoVPCPeeringCreate </em> <code class="fe kt ku kv kw b">Condition</code>将返回<em class="kx"> True </em>，那么<em class="kx">monitoringprodvpeeringconnection</em>和<em class="kx">monitoringoeksprodpeerinroute</em>资源将被触发创建。</p><p id="af5f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行检查—它们是这样创建的:</p><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi mw"><img src="../Images/b7ff9e195a892d48bd3ee9f7ce2f6ebc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-RovGmoIRvUdzc-E.png"/></div></div></figure><h2 id="eb91" class="lm ln iq bd lo lp lq dn lr ls lt dp lu kf lv lw lx kj ly lz ma kn mb mc md me bi translated"><em class="nb">未解决的资源相关性</em>和<code class="fe kt ku kv kw b">Fn::If</code></h2><p id="a3f9" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">现在—运行相同的操作，但此时指定<em class="kx">VPCPeeringCreate</em>= =<em class="kx">false</em>，您将得到一个错误，因为th区域堆栈上的<code class="fe kt ku kv kw b">Outputs</code>中缺少值:</p><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi nc"><img src="../Images/e0f7a82e6d00512929fb8046d0bc36d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EZ1R3vc8UXZRSueV.png"/></div></div></figure><p id="17c0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为什么这样嗯——因为我们已经禁止创建对等体，但是在区域堆栈的<code class="fe kt ku kv kw b">Outpus</code>中，我们仍然尝试放置一个没有创建的对等体的ID:</p><pre class="mk ml mm mn gt mo kw mp mq aw mr bi"><span id="568c" class="lm ln iq kw b gy ms mt l mu mv">...<br/>    "MonitoringProdVPCPeeringConnectionID": {<br/>      "Description" : "MonitoringProdVPCPeeringConnection ID",<br/>      "Value" : {"Ref" : "MonitoringProdVPCPeeringConnection" }<br/>    }<br/>...</span></pre><p id="036d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要解决这个问题，请更新<code class="fe kt ku kv kw b">Outputs</code>并使用<code class="fe kt ku kv kw b"><a class="ae ks" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-conditions.html#intrinsic-function-reference-conditions-if" rel="noopener ugc nofollow" target="_blank">Fn::If</a></code>来选择要返回的内容:</p><pre class="mk ml mm mn gt mo kw mp mq aw mr bi"><span id="70c8" class="lm ln iq kw b gy ms mt l mu mv">...<br/>  "Outputs" : {<br/><br/>    "VPCID" : {<br/>      "Description" : "EKS VPC ID",<br/>      "Value" : { "Ref" : "VPC" }<br/>    },<br/><br/>    "IGWID" : {<br/>      "Description" : "InternetGateway ID",<br/>      "Value" : { "Ref" : "InternetGateway" }<br/>    },<br/><br/>    "MonitoringProdVPCPeeringConnectionID": {<br/>      "Description" : "MonitoringProdVPCPeeringConnection ID",<br/>      "Value" : { "Fn::If" : [ "DoVPCPeeringCreate", {"Ref" : "MonitoringProdVPCPeeringConnection" }, "Zero" ] }<br/>    }<br/><br/>  }<br/>}<br/>...</span></pre><p id="d5ff" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">也就是说，如果<code class="fe kt ku kv kw b">DoVPCPeeringCreate</code>条件将返回<em class="kx">真</em>，那么我们将获取<em class="kx">MonitoringProdVPCPeeringConnection的</em> ID，如果<code class="fe kt ku kv kw b">DoVPCPeeringCreate</code> == <em class="kx">假</em>，那么我们将在输出中放入一些其他值，例如“零”。</p><h2 id="1b3e" class="lm ln iq bd lo lp lq dn lr ls lt dp lu kf lv lw lx kj ly lz ma kn mb mc md me bi translated">可用性区域堆栈</h2><p id="e325" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">在AZ堆栈中，我们需要做同样的事情——添加参数并添加<code class="fe kt ku kv kw b">Conditions</code>——从区域堆栈中复制粘贴它，并为<code class="fe kt ku kv kw b">AWS::EC2::Route</code>资源—<code class="fe kt ku kv kw b">"Condition" : "DoVPCPeeringCreate"</code>创建一个检查:</p><pre class="mk ml mm mn gt mo kw mp mq aw mr bi"><span id="5d66" class="lm ln iq kw b gy ms mt l mu mv">...<br/>    "EksToMonitoringProdPeeringRoute": {<br/>      "Type": "AWS::EC2::Route",<br/>      "Condition" : "DoVPCPeeringCreate",<br/>      "Properties": {<br/>        "RouteTableId": {<br/>          "Ref": "PrivateRouteTable"<br/>        },<br/>        "DestinationCidrBlock": {<br/>          "Fn::ImportValue" : "monitoring-production-VPC-CIDR"<br/>        },<br/>        "VpcPeeringConnectionId": {<br/>          "Ref": "MonitoringProdVPCPeeringConnectionID"<br/>        }<br/>      }<br/>    },<br/>...</span></pre><p id="9ddb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在Root-стеке中添加要传递给AZ堆栈的<em class="kx"> VPCPeeringCreate </em>:</p><pre class="mk ml mm mn gt mo kw mp mq aw mr bi"><span id="43ff" class="lm ln iq kw b gy ms mt l mu mv">...<br/>    "AZNetworkStackA": {<br/>      "Type": "AWS::CloudFormation::Stack",<br/>      "Properties": {<br/>        "TemplateURL": "eks-azs-networking.json",<br/>        "Parameters": {<br/>          "VPCID": { "Fn::GetAtt": ["RegionNetworkStack", "Outputs.VPCID"] },<br/>          "AZ": { "Fn::Select": [ "0", { "Ref": "AvailabilityZones" } ] },<br/>          "IGWID": { "Fn::GetAtt": ["RegionNetworkStack", "Outputs.IGWID"] },<br/>          "VPCPeeringCreate": { "Ref":  "VPCPeeringCreate"},<br/>...</span></pre><p id="f290" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建堆栈，但不创建对等:</p><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi nd"><img src="../Images/ae0e52c2f1c8744d1632f6c298e23185.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*S-1E8RjX-jEeGDB7.png"/></div></div></figure><p id="8327" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查—再次创建，使用<em class="kx"> VPCPeeringCreate == true: </em></p><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi ne"><img src="../Images/b15cf9206f59555d70c2fd0b4cd6875a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bMPE-wiz5WKf-saQ.png"/></div></div></figure><p id="d21d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">完成了。</p></div><div class="ab cl nf ng hu nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="ij ik il im in"><p id="f768" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="kx">最初发布于</em> <a class="ae ks" href="https://rtfm.co.ua/en/aws-cloudformation-using-conditions-fnequals-and-fnif-an-example/" rel="noopener ugc nofollow" target="_blank"> <em class="kx"> RTFM: Linux、DevOps和系统管理</em> </a> <em class="kx">。</em></p></div></div>    
</body>
</html>