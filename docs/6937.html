<html>
<head>
<title>.NET 6.0: Code First with Entity Framework Core and MySQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">。NET 6.0:用实体框架核心和MySQL代码先行</h1>
<blockquote>原文：<a href="https://itnext.io/net-6-0-code-first-with-entity-framework-core-and-mysql-3c779cec145c?source=collection_archive---------1-----------------------#2022-04-18">https://itnext.io/net-6-0-code-first-with-entity-framework-core-and-mysql-3c779cec145c?source=collection_archive---------1-----------------------#2022-04-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="7454" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">MySQL与EF Core集成初学者指南</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ko"><img src="../Images/fe708700acec1152e272accb9ef0f8a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*11nQmVfgGqdqNll0q4awrQ.jpeg"/></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated">EF核心&amp; MySQL</figcaption></figure><p id="4151" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">实体框架(EF)核心是一个对象关系映射器O/RM，用于将实体与数据库对象进行映射。此外，EF Core提供易于使用的功能，无需编写代码来访问任何数据。。NET EF还提供了命令行工具来实现代码优先而不是数据库优先的方法。</p><h1 id="6388" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">什么是代码优先？</h1><p id="201d" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">使用代码优先方法，您可以在代码中创建实体或模型。各种属性和配置定义了数据库中的关系和键。一旦定义和配置了模型，我们就可以使用实体框架cli工具将它们迁移到数据库中。</p><p id="5939" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了更好地理解代码优先的方法，最好有一个实际的例子。我们将创建两个实体用户和作业。用户将有一个字符串形式的主键Id和名字。作业实体将有一个主键Id，名称为字符串，用户Id为用户实体的外键。</p><h1 id="3f71" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">先决条件</h1><p id="122e" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">在我们开始之前，我们需要一个在本地端口3306上运行的MySQL服务器。提供如何安装MySQL的指导超出了范围，但是有很多教程可以帮助你。此时，不需要创建新的数据库或表。只要有一个正在运行的MySQL服务器就足够了。我们还需要一个MySQL客户端来添加一些数据。可以使用<a class="ae md" href="https://dbeaver.io/" rel="noopener ugc nofollow" target="_blank"> DBeaver </a>。</p><h1 id="2186" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">设置项目</h1><p id="ec8c" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">要开始安装<a class="ae md" href="https://dotnet.microsoft.com/en-us/download/dotnet/6.0" rel="noopener ugc nofollow" target="_blank">。NET 6.0 SDK </a>如果尚未安装。启动下面的命令创建一个新的dotnet应用程序。</p><pre class="kp kq kr ks gt me mf mg mh aw mi bi"><span id="992c" class="mj lb it mf b gy mk ml l mm mn">dotnet new webapi --name dotnet</span></pre><p id="186a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">它将创建一个新的。net项目以及控制器和一些其他文件。为了支持与MySQL的连接，我们需要添加一个nuget包。我们还会加入<em class="mo">微软。EntityFrameworkCore </em>基本上是一个连接数据库的ORM。为此，在新创建的<em class="mo"> dotnet </em>项目中执行以下命令。</p><pre class="kp kq kr ks gt me mf mg mh aw mi bi"><span id="cb6b" class="mj lb it mf b gy mk ml l mm mn">dotnet add package Pomelo.EntityFrameworkCore.MySql --version 6.0.1<br/>dotnet add package Microsoft.EntityFrameworkCore --version 6.0.4<br/>dotnet add package Microsoft.EntityFrameworkCore.Design --version 6.0.4</span></pre><p id="50e9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因为我们不再需要<em class="mo"> WeatherForecast.cs </em>文件，所以删除它。相反，在Job.cs &amp; <em class="mo"> User.cs </em>中创建另外两个实体，如下所示。</p><pre class="kp kq kr ks gt me mf mg mh aw mi bi"><span id="f0f1" class="mj lb it mf b gy mk ml l mm mn">using System.ComponentModel.DataAnnotations;<br/>using System.ComponentModel.DataAnnotations.Schema;</span><span id="0c9a" class="mj lb it mf b gy mp ml l mm mn">namespace dotnet;<br/>public class User<br/>{<br/>    [Key]<br/>    [DatabaseGenerated(DatabaseGeneratedOption.Identity)]<br/>    public int Id { get; set; }</span><span id="52de" class="mj lb it mf b gy mp ml l mm mn">    public string FirstName { get; set; }<br/>}</span></pre></div><div class="ab cl mq mr hx ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="im in io ip iq"><pre class="me mf mg mh aw mi bi"><span id="8e2c" class="mj lb it mf b gy mx my mz na nb ml l mm mn">using System.ComponentModel.DataAnnotations;<br/>using System.ComponentModel.DataAnnotations.Schema;</span><span id="4585" class="mj lb it mf b gy mp ml l mm mn">namespace dotnet;<br/>public class Job<br/>{<br/>    [Key]<br/>    [DatabaseGenerated(DatabaseGeneratedOption.Identity)]<br/>    public int Id { get; set; }</span><span id="499c" class="mj lb it mf b gy mp ml l mm mn">    public string Name { get; set; }</span><span id="2c92" class="mj lb it mf b gy mp ml l mm mn">    public int UserId { get; set; }</span><span id="431d" class="mj lb it mf b gy mp ml l mm mn">    [ForeignKey("UserId")]<br/>    public virtual User User { get; set; }<br/>}</span></pre><p id="b6c7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们还需要一个DbContext子类来访问这些实体。创建一个文件名<em class="mo"> MySQLDBContext.cs </em>并添加以下内容。</p><pre class="kp kq kr ks gt me mf mg mh aw mi bi"><span id="faed" class="mj lb it mf b gy mk ml l mm mn">using Microsoft.EntityFrameworkCore;</span><span id="ee9a" class="mj lb it mf b gy mp ml l mm mn">namespace dotnet;<br/>public class MySQLDBContext : DbContext<br/>{<br/>    public DbSet&lt;User&gt; User { get; set; }<br/>    public DbSet&lt;Job&gt; Job { get; set; }<br/>    public MySQLDBContext(DbContextOptions&lt;MySQLDBContext&gt; options) : base(options) { }<br/>}</span></pre><p id="6aac" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们想要配置。NET使用这个DbContext类进行O/RM映射。导航到您的<em class="mo"> Program.cs </em>文件，并替换为以下内容。<em class="mo">注:自。NET 6.0中，Startup.cs文件被删除，而Program.cs用于所有配置。</em></p><pre class="kp kq kr ks gt me mf mg mh aw mi bi"><span id="b9a9" class="mj lb it mf b gy mk ml l mm mn">using dotnet;<br/>using Microsoft.AspNetCore.Builder;<br/>using Microsoft.Extensions.DependencyInjection;<br/>using Microsoft.EntityFrameworkCore;<br/>using Microsoft.Extensions.Hosting;<br/>using Microsoft.Extensions.Configuration;</span><span id="6d2b" class="mj lb it mf b gy mp ml l mm mn">var builder = WebApplication.CreateBuilder(args);</span><span id="b605" class="mj lb it mf b gy mp ml l mm mn">// Add services to the container.<br/>builder.Services.AddDbContext&lt;MySQLDBContext&gt;(options =&gt;<br/>    {<br/>    var connectionString = builder.Configuration.GetConnectionString("DefaultConnection");<br/>    options.UseMySql(connectionString, ServerVersion.AutoDetect(connectionString));<br/>    });</span><span id="8ecb" class="mj lb it mf b gy mp ml l mm mn">builder.Services.AddControllers();<br/>// Learn more about configuring Swagger/OpenAPI at <a class="ae md" href="https://aka.ms/aspnetcore/swashbuckle" rel="noopener ugc nofollow" target="_blank">https://aka.ms/aspnetcore/swashbuckle</a><br/>builder.Services.AddEndpointsApiExplorer();<br/>builder.Services.AddSwaggerGen();</span><span id="7faf" class="mj lb it mf b gy mp ml l mm mn">var app = builder.Build();</span><span id="6f27" class="mj lb it mf b gy mp ml l mm mn">// Configure the HTTP request pipeline.<br/>if (app.Environment.IsDevelopment())<br/>{<br/>    app.UseSwagger();<br/>    app.UseSwaggerUI();<br/>}</span><span id="a2e1" class="mj lb it mf b gy mp ml l mm mn">app.UseHttpsRedirection();</span><span id="78e0" class="mj lb it mf b gy mp ml l mm mn">app.UseAuthorization();</span><span id="c3e7" class="mj lb it mf b gy mp ml l mm mn">app.MapControllers();</span><span id="3c45" class="mj lb it mf b gy mp ml l mm mn">app.Run();</span></pre><p id="c158" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于我们使用的是从<em class="mo">连接字符串</em>中获取<em class="mo">默认连接</em>的<em class="mo">配置</em>，我们必须将它添加到我们的<em class="mo"> appsettings </em>文件中。要实现这一点，请将<em class="mo">appsettings . development . JSON</em>和<em class="mo"> appsettings.json </em>文件的内容设置如下。</p><pre class="kp kq kr ks gt me mf mg mh aw mi bi"><span id="7d12" class="mj lb it mf b gy mk ml l mm mn">{<br/>  "Logging": {<br/>    "LogLevel": {<br/>      "Default": "Information",<br/>      "Microsoft": "Warning",<br/>      "Microsoft.Hosting.Lifetime": "Information"<br/>    }<br/>  },<br/>  "AllowedHosts": "*",<br/>  "ConnectionStrings": {  <br/>    "DefaultConnection": "server=localhost; port=3306; database=super-app; user=root; password=$SuperApp1; Persist Security Info=False; Connect Timeout=300"  <br/>  } <br/>}</span></pre><p id="046c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，我们将创建一个GET api，它返回数据库中的作业对象列表。为此，删除<em class="mo">weatherforecastcontroller . cs</em>并添加一个包含以下内容的<em class="mo"> UserController.cs </em>文件。</p><pre class="kp kq kr ks gt me mf mg mh aw mi bi"><span id="4b6e" class="mj lb it mf b gy mk ml l mm mn">using System.Collections.Generic;<br/>using System.Linq;<br/>using Microsoft.AspNetCore.Mvc;<br/>using Microsoft.EntityFrameworkCore;</span><span id="2c4f" class="mj lb it mf b gy mp ml l mm mn">namespace dotnet.Controllers<br/>{<br/>    [Route("api/[controller]")]<br/>    [ApiController]<br/>    public class JobController : Controller<br/>    {<br/>        private MySQLDBContext _dbContext;  <br/>  <br/>        public JobController(MySQLDBContext context)  <br/>        {  <br/>            _dbContext = context;  <br/>        }  <br/>  <br/>        [HttpGet]  <br/>        public IList&lt;Job&gt; Get()  <br/>        {  <br/>            return (this._dbContext.Job.Include(x =&gt; x.User).ToList());  <br/>        } <br/>    }<br/>}</span></pre><p id="3800" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们都设置了代码。但是我们仍然需要建立我们的数据库。为此，我们将在我们的<em class="mo">超级应用</em>数据库中创建一个用户和作业表。</p><h1 id="9b32" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">。NET EF工具</h1><p id="65e0" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">。NET的实体框架核心提供了一个非常方便的实现方式。首先通过执行以下命令安装<em class="mo"> dotnet-ef </em> cli工具。</p><pre class="kp kq kr ks gt me mf mg mh aw mi bi"><span id="fefa" class="mj lb it mf b gy mk ml l mm mn">dotnet tool install --global dotnet-ef</span></pre><p id="0759" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦安装，我们将代码优先的方法，并创建一个我们的实体，然后将被推到我们的数据库迁移。</p><pre class="kp kq kr ks gt me mf mg mh aw mi bi"><span id="3812" class="mj lb it mf b gy mk ml l mm mn">dotnet ef migrations add InitialCreate<br/>dotnet ef database update</span></pre><p id="c356" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上面两条语句一旦执行，将创建数据库、其中的表，并设置两个表之间的关系。</p><h1 id="57c3" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">向MySQL添加数据</h1><p id="77cf" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">为了从数据库中获取数据，我们首先需要在表中添加数据。安装任何MySQL客户端来连接数据库。我个人最喜欢的是《T21》。现在，您可以从DBeaver添加数据，首先添加一个连接，详细信息如下:Host=localhost，Port=3306，User = root&amp;password = $ superapp 1。</p><p id="ad05" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">连接后，导航到用户表，添加一行并保存数据。同样，导航到职务表，添加一行并保存数据。我们的数据库现在都设置好了。让我们运行我们的项目并查看结果。</p><h1 id="dd39" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">把所有东西放在一起</h1><p id="fd04" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">回到你的项目，运行下面的命令开始我们的项目。</p><pre class="kp kq kr ks gt me mf mg mh aw mi bi"><span id="1013" class="mj lb it mf b gy mk ml l mm mn">dotnet watch run</span></pre><p id="b328" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上述命令将启动您的项目，并在浏览器中打开一个swagger链接。只需打开作业api，点击<em class="mo">试用</em>，然后点击<em class="mo">执行。将显示一个带有工作列表的漂亮响应。因为我们刚刚添加了一个作业，所以只有一个作业被返回，如下所示。</em></p><pre class="kp kq kr ks gt me mf mg mh aw mi bi"><span id="2be6" class="mj lb it mf b gy mk ml l mm mn">[<br/>  {<br/>    "id": 1,<br/>    "name": "Tutor",<br/>    "userId": 1,<br/>    "user": {<br/>      "id": 1,<br/>      "firstName": "John Doe"<br/>    }<br/>  }<br/>]</span></pre><h1 id="ffc6" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">结论</h1><p id="9fb2" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">总结一下，entity framework core是我遇到的最好的O/RM之一，它可以很好地与许多不同的数据库配合使用。设置它就像发出几个命令一样简单。从实体到数据库的迁移非常顺利。</p></div></div>    
</body>
</html>