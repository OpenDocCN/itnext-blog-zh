<html>
<head>
<title>Redis: main configuration parameters and performance tuning overview</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Redis:主要配置参数和性能调优概述</h1>
<blockquote>原文：<a href="https://itnext.io/redis-main-configuration-parameters-and-performance-tuning-overview-fc598f65137?source=collection_archive---------2-----------------------#2019-09-10">https://itnext.io/redis-main-configuration-parameters-and-performance-tuning-overview-fc598f65137?source=collection_archive---------2-----------------------#2019-09-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/5976e0992cb1e17cc1c9ab0462e963ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:260/format:webp/0*oqBe_3Hje-YgGQdS.png"/></div></figure><p id="4e69" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">目前正在配置Redis服务器作为我们的后端缓存服务，在此期间，我写了这篇文章，在Redis配置文件中有一些需要注意的地方。</p><p id="3c6d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">足够短，但链接到其他职位或文件。</p><p id="5471" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们从<code class="fe ks kt ku kv b"><a class="ae kw" href="https://github.com/maxux/redis-benchmark" rel="noopener ugc nofollow" target="_blank">redis-benchmark</a></code>实用程序开始。</p><p id="1122" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将与Redis服务一起安装，因此可以在服务器安装后立即使用:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="cb32" class="lf lg iq kv b gy lh li l lj lk">root@bttrm-dev-app-1:/home/admin# redis-benchmark -p 6389 -n 1000 -c 10 -k <br/>====== 1 ======<br/>1000 requests completed in 0.03 seconds<br/>10 parallel clients<br/>3 bytes payload<br/>keep alive: 1<br/>98.30% &lt;= 1 milliseconds<br/>99.30% &lt;= 2 milliseconds<br/>100.00% &lt;= 2 milliseconds<br/>30303.03 requests per second</span></pre><p id="ba4e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，您可以使用带有<code class="fe ks kt ku kv b">--latency</code>或<code class="fe ks kt ku kv b">--latency-dist</code>选项的Redis CLI:</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ll"><img src="../Images/e6a7a9213d714aac4d14c3967119d2e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:864/format:webp/0*TPh-ngmQ5Sv2WVhX.png"/></div></div></figure><ul class=""><li id="9360" class="lq lr iq jw b jx jy kb kc kf ls kj lt kn lu kr lv lw lx ly bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/draft-eng-redis-main-configuration-parameters-and-performance-tuning-overview/#Redis_server-level_config" rel="noopener ugc nofollow" target="_blank"> Redis服务器级配置</a></li><li id="caef" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/draft-eng-redis-main-configuration-parameters-and-performance-tuning-overview/#timeout" rel="noopener ugc nofollow" target="_blank">超时</a></li><li id="db4e" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/draft-eng-redis-main-configuration-parameters-and-performance-tuning-overview/#tcp-keepalive" rel="noopener ugc nofollow" target="_blank"> tcp-keepalive </a></li><li id="e2c8" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/draft-eng-redis-main-configuration-parameters-and-performance-tuning-overview/#RDB_Persistence" rel="noopener ugc nofollow" target="_blank"> RDB的坚持</a></li><li id="1bcc" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/draft-eng-redis-main-configuration-parameters-and-performance-tuning-overview/#AOF_persistence" rel="noopener ugc nofollow" target="_blank"> AOF的坚持</a></li><li id="9330" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/draft-eng-redis-main-configuration-parameters-and-performance-tuning-overview/#maxmemory" rel="noopener ugc nofollow" target="_blank"> maxmemory </a></li><li id="4828" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/draft-eng-redis-main-configuration-parameters-and-performance-tuning-overview/#maxmemory-policy" rel="noopener ugc nofollow" target="_blank">最大内存策略</a></li><li id="d1a8" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/draft-eng-redis-main-configuration-parameters-and-performance-tuning-overview/#unixsocket" rel="noopener ugc nofollow" target="_blank"> unixsocket </a></li><li id="bc3e" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/draft-eng-redis-main-configuration-parameters-and-performance-tuning-overview/#loglevel" rel="noopener ugc nofollow" target="_blank">日志级别</a></li><li id="fe5a" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/draft-eng-redis-main-configuration-parameters-and-performance-tuning-overview/#OS-level_config" rel="noopener ugc nofollow" target="_blank">操作系统级配置</a></li><li id="798d" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/draft-eng-redis-main-configuration-parameters-and-performance-tuning-overview/#Transparent_Huge_Page" rel="noopener ugc nofollow" target="_blank">透明巨页</a></li><li id="7b62" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/draft-eng-redis-main-configuration-parameters-and-performance-tuning-overview/#maxclients_and_fsfile-max" rel="noopener ugc nofollow" target="_blank"> maxclients和fs.file-max </a></li><li id="aa70" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/draft-eng-redis-main-configuration-parameters-and-performance-tuning-overview/#tcp-backlog_and_netcoresomaxconn" rel="noopener ugc nofollow" target="_blank"> tcp-backlog和net.core.somaxconn </a></li><li id="4d50" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/draft-eng-redis-main-configuration-parameters-and-performance-tuning-overview/#What_is_the_TCP_backlog_and_netcoresomaxconn" rel="noopener ugc nofollow" target="_blank">什么是TCP backlog和net.core.somaxconn </a></li><li id="e14a" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/draft-eng-redis-main-configuration-parameters-and-performance-tuning-overview/#vmovercommit_memory" rel="noopener ugc nofollow" target="_blank"> vm.overcommit_memory </a></li><li id="048f" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/draft-eng-redis-main-configuration-parameters-and-performance-tuning-overview/#vmswappiness" rel="noopener ugc nofollow" target="_blank"> vm.swappiness </a></li><li id="a746" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/draft-eng-redis-main-configuration-parameters-and-performance-tuning-overview/#Useful_links" rel="noopener ugc nofollow" target="_blank">有用链接</a></li></ul><h2 id="053a" class="lf lg iq bd me mf mg dn mh mi mj dp mk kf ml mm mn kj mo mp mq kn mr ms mt mu bi translated">Redis服务器级配置</h2><h2 id="e9cf" class="lf lg iq bd me mf mg dn mh mi mj dp mk kf ml mm mn kj mo mp mq kn mr ms mt mu bi translated"><code class="fe ks kt ku kv b">timeout</code></h2><p id="7064" class="pw-post-body-paragraph ju jv iq jw b jx mv jz ka kb mw kd ke kf mx kh ki kj my kl km kn mz kp kq kr ij bi translated">如果客户端在<em class="na"> N </em>秒内不活动，则断开连接。</p><p id="99e0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">设置为零以禁用(空闲客户端将保持连接，直到服务器重新启动):</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="089a" class="lf lg iq kv b gy lh li l lj lk">...<br/>timeout 0<br/>...</span></pre><p id="ba2e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">总的来说，我看不出有什么理由要改变默认的300秒。</p><h2 id="6a39" class="lf lg iq bd me mf mg dn mh mi mj dp mk kf ml mm mn kj mo mp mq kn mr ms mt mu bi translated"><code class="fe ks kt ku kv b">tcp-keepalive</code></h2><p id="2f84" class="pw-post-body-paragraph ju jv iq jw b jx mv jz ka kb mw kd ke kf mx kh ki kj my kl km kn mz kp kq kr ij bi translated">更多信息请参见<a class="ae kw" href="https://redis.io/topics/clients#tcp-keepalive" rel="noopener ugc nofollow" target="_blank"> Redis客户端处理</a>。</p><p id="524f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">不适用于发布/订阅期间(实时操作)，请参见<a class="ae kw" href="https://www.redisgreen.net/blog/pubsub-intro/" rel="noopener ugc nofollow" target="_blank"> Redis发布/订阅:介绍指南</a>和<a class="ae kw" href="https://thoughtbot.com/blog/redis-pub-sub-how-does-it-work" rel="noopener ugc nofollow" target="_blank"> Redis发布/订阅…它是如何工作的？</a></p><p id="af2b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在此期间，Redis服务器将在从该参数开始的秒后发送ACK-requests ( <em class="na">确认</em>)以保持会话活动:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="c349" class="lf lg iq kv b gy lh li l lj lk">...<br/>tcp-keepalive 300<br/>...</span></pre><p id="e13f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="940b" class="lf lg iq kv b gy lh li l lj lk">127.0.0.1:6389&gt; CONFIG GET tcp-keepalive<br/>1) “tcp-keepalive”<br/>2) “300”</span></pre><p id="a66c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">默认值为300秒(但在Redis版本上可以更改)。</p><p id="b85f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果客户端不响应来自服务器的确认请求，该连接将被关闭。</p><p id="2c56" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果服务器端的<code class="fe ks kt ku kv b">timeout</code>和<code class="fe ks kt ku kv b">tcp-keepalive</code>都被设置为零(即禁用)，那么“死”连接将保持活动状态，直到服务器重启。</p><p id="81fd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<a class="ae kw" href="https://packetlife.net/blog/2010/jun/7/understanding-tcp-sequence-acknowledgment-numbers/" rel="noopener ugc nofollow" target="_blank">查看更多关于TCP Keepalives </a>的信息。</p><p id="70e1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要了解keep-alive如何影响性能id general —使用<code class="fe ks kt ku kv b">tcp-keepalive</code>选项(<code class="fe ks kt ku kv b">-k</code> == 1)运行基准测试:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="2ee1" class="lf lg iq kv b gy lh li l lj lk">root@bttrm-dev-app-1:/home/admin# redis-benchmark -p 6389 -n 1000 -c 10 -k 1 -q | tail -2<br/>MSET (10 keys): 16129.03 requests per second</span></pre><p id="365b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并且在禁用保持活动的情况下:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="bf3f" class="lf lg iq kv b gy lh li l lj lk">root@bttrm-dev-app-1:/home/admin# redis-benchmark -p 6389 -n 1000 -c 10 -k 0 -q | tail -2<br/>MSET (10 keys): 7042.25 requests per second</span></pre><p id="d1b9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">同样——我找不到任何理由来更改默认值。</p><h2 id="157c" class="lf lg iq bd me mf mg dn mh mi mj dp mk kf ml mm mn kj mo mp mq kn mr ms mt mu bi translated">RDB持久性</h2><p id="69e2" class="pw-post-body-paragraph ju jv iq jw b jx mv jz ka kb mw kd ke kf mx kh ki kj my kl km kn mz kp kq kr ij bi translated">将创建完整的数据库副本。参见此处的文档<a class="ae kw" href="https://redis.io/topics/persistence" rel="noopener ugc nofollow" target="_blank"> Redis持久性</a>。</p><p id="2f4e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">其行为通过<code class="fe ks kt ku kv b">save</code>选项设置(参见<a class="ae kw" href="https://rtfm.co.ua/en/redis-fork-cannot-allocate-memory-linux-virtual-memory-and-vm-overcommit_memory/#Redis_save_SAVE_BGSAVE" rel="noopener ugc nofollow" target="_blank"> Redis save，SAVE и BGSAVE </a>)。</p><p id="e8af" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查当前值:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="580e" class="lf lg iq kv b gy lh li l lj lk">127.0.0.1:6379&gt; CONFIG GET save<br/>1) “save”<br/>2) “3600 1 300 100 60 10000”</span></pre><p id="3ee9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">移除它:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="a391" class="lf lg iq kv b gy lh li l lj lk">127.0.0.1:6379&gt; CONFIG SET save “”<br/>OK<br/>127.0.0.1:6379&gt; CONFIG GET save<br/>1) “save”<br/>2) “”</span></pre><p id="fb32" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">保存新设置:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="8ab9" class="lf lg iq kv b gy lh li l lj lk">127.0.0.1:6389&gt; CONFIG rewrite<br/>OK</span></pre><p id="b29c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在Redis仅用于缓存的情况下——可以禁用持久性，只需从配置文件中删除<code class="fe ks kt ku kv b">save</code>即可。</p><p id="38f1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是，如果使用的话，相同的机制将用于主-从复制(详见<a class="ae kw" href="https://rtfm.co.ua/en/redis-replication-part-1-overview-replication-vs-sharding-sentinel-vs-cluster-redis-topology/" rel="noopener ugc nofollow" target="_blank"> Redis: replication，part 1-a overview)。复制与分片。哨兵vs集群。Redis拓扑。</a>贴)。</p><h2 id="3d69" class="lf lg iq bd me mf mg dn mh mi mj dp mk kf ml mm mn kj mo mp mq kn mr ms mt mu bi translated">AOF持久性</h2><p id="f0b6" class="pw-post-body-paragraph ju jv iq jw b jx mv jz ka kb mw kd ke kf mx kh ki kj my kl km kn mz kp kq kr ij bi translated"><em class="na">仅追加文件</em> —将主控主机执行的每个操作保存到日志文件。</p><p id="ef34" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">当我们仅将Redis用于缓存时，类似于RDB—此选项中不需要。</p><p id="70ee" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">禁用—将<code class="fe ks kt ku kv b">appendonly</code>设置为<em class="na">号</em>:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="3da0" class="lf lg iq kv b gy lh li l lj lk">...<br/>appendonly no<br/>...</span></pre><h2 id="59f7" class="lf lg iq bd me mf mg dn mh mi mj dp mk kf ml mm mn kj mo mp mq kn mr ms mt mu bi translated"><code class="fe ks kt ku kv b">maxmemory</code></h2><p id="74e1" class="pw-post-body-paragraph ju jv iq jw b jx mv jz ka kb mw kd ke kf mx kh ki kj my kl km kn mz kp kq kr ij bi translated"><code class="fe ks kt ku kv b">maxmemory</code>设置分配给Redis的最大主机内存限制。</p><p id="7261" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">参见<a class="ae kw" href="https://redis.io/topics/lru-cache" rel="noopener ugc nofollow" target="_blank">使用Redis作为LRU缓存</a>。</p><p id="8939" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">可以设置为%:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="7b21" class="lf lg iq kv b gy lh li l lj lk">127.0.0.1:6389&gt; CONFIG SET maxmemory 80<br/>OK</span></pre><p id="082a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">或兆字节/千兆字节:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="811c" class="lf lg iq kv b gy lh li l lj lk">127.0.0.1:6389&gt; CONFIG SET maxmemory 1gb<br/>OK<br/>127.0.0.1:6389&gt; CONFIG GET maxmemory<br/>1) “maxmemory”<br/>2) “1073741824”</span></pre><p id="4600" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">或者设置为零以完全禁用限制，这是64位系统的默认值。32位系统默认为3 GB。</p><p id="6d06" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">当达到限制时，Redis将根据<a class="ae kw" href="https://rtfm.co.ua/en/?p=21632#maxmemory-policy" rel="noopener ugc nofollow" target="_blank"> maxmemory-policy </a>选项做出决定。</p><p id="09f9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">请记住，我们也有<code class="fe ks kt ku kv b">memcached</code>和PHP-FPM工作人员在后端主机上运行——让我们将这个限制设置为50% RAM。</p><h2 id="69bd" class="lf lg iq bd me mf mg dn mh mi mj dp mk kf ml mm mn kj mo mp mq kn mr ms mt mu bi translated"><code class="fe ks kt ku kv b">maxmemory-policy</code></h2><p id="1276" class="pw-post-body-paragraph ju jv iq jw b jx mv jz ka kb mw kd ke kf mx kh ki kj my kl km kn mz kp kq kr ij bi translated">设置当Redis达到<code class="fe ks kt ku kv b">maxmemory</code>限制时使用的策略。</p><p id="7ddb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> <em class="na">注</em></strong><em class="na">:LRU——最近少用</em></p><p id="d0c0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">可以是下一个:</p><ul class=""><li id="f7a5" class="lq lr iq jw b jx jy kb kc kf ls kj lt kn lu kr lv lw lx ly bi translated"><code class="fe ks kt ku kv b">volatile-lru</code>:移除设置了<code class="fe ks kt ku kv b">expire</code>的较少使用的按键</li><li id="82d6" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><code class="fe ks kt ku kv b">allkeys-lru</code>:不管<code class="fe ks kt ku kv b">expire</code>设置如何，移除较少使用的按键</li><li id="adf2" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><code class="fe ks kt ku kv b">volatile-random</code>:在<code class="fe ks kt ku kv b">expire</code>设定下移除随机键</li><li id="379b" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><code class="fe ks kt ku kv b">allkeys-random</code>:不管<code class="fe ks kt ku kv b">expire</code>设置如何，移除随机键</li><li id="aef9" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><code class="fe ks kt ku kv b">volatile-ttl</code>:移除剩余TTL最低的按键</li><li id="7cc2" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><code class="fe ks kt ku kv b">noeviction</code>:根本不删除键——只是在写操作时返回一个错误</li></ul><p id="1ac9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要检查<code class="fe ks kt ku kv b">expire</code>字段，您可以使用<code class="fe ks kt ku kv b"><a class="ae kw" href="https://redis.io/commands/ttl" rel="noopener ugc nofollow" target="_blank">TTL</a></code> / <code class="fe ks kt ku kv b"><a class="ae kw" href="https://redis.io/commands/pttl" rel="noopener ugc nofollow" target="_blank">PTTL</a></code>:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="73a2" class="lf lg iq kv b gy lh li l lj lk">127.0.0.1:6379&gt; set test “test”<br/>OK<br/>127.0.0.1:6379&gt; ttl test<br/>(integer) -1<br/>127.0.0.1:6379&gt; pttl test<br/>(integer) -1<br/>127.0.0.1:6379&gt; EXPIRE test 10<br/>(integer) 1<br/>127.0.0.1:6379&gt; ttl test<br/>(integer) 8<br/>127.0.0.1:6379&gt; ttl test<br/>(integer) 7<br/>127.0.0.1:6379&gt; ttl test<br/>(integer) 7</span></pre><p id="16e4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在我们的例子中，后端开发人员不确定我们是否将<code class="fe ks kt ku kv b">expire</code>用于所有键，并且知道Redis将仅用于缓存的事实- <code class="fe ks kt ku kv b">maxmemory-policy allkeys-lru</code>可以被设置。</p><h2 id="051f" class="lf lg iq bd me mf mg dn mh mi mj dp mk kf ml mm mn kj mo mp mq kn mr ms mt mu bi translated"><code class="fe ks kt ku kv b">unixsocket</code></h2><p id="a8c6" class="pw-post-body-paragraph ju jv iq jw b jx mv jz ka kb mw kd ke kf mx kh ki kj my kl km kn mz kp kq kr ij bi translated">如果Redis和应用程序在同一台主机上一起工作，您可以尝试使用UNIX套接字而不是TCP连接。</p><p id="deca" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将Redis服务器设置为使用套接字:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="c47a" class="lf lg iq kv b gy lh li l lj lk">...<br/>unixsocket /tmp/redis.sock<br/>unixsocketperm 755<br/>...</span></pre><p id="4edd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">可以显著提高性能，更多信息请参见<a class="ae kw" href="https://inchoo.net/magento/tuning-redis-for-extra-magento-performance/" rel="noopener ugc nofollow" target="_blank">调优Redis，以获得额外的Magento性能</a>。</p><p id="ed2e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们检查一下<code class="fe ks kt ku kv b">redis-benchmark</code>。</p><p id="d86c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建测试会议:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="85c4" class="lf lg iq kv b gy lh li l lj lk">unixsocket /tmp/redis.sock<br/>unixsocketperm 775<br/>port 0</span></pre><p id="a5e2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用插座运行:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="f65b" class="lf lg iq kv b gy lh li l lj lk">root@bttrm-dev-console:/etc/redis-cluster# redis-server /etc/redis-cluster/test.conf</span></pre><p id="ccf2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查操作:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="c77a" class="lf lg iq kv b gy lh li l lj lk">root@bttrm-dev-console:/home/admin# redis-benchmark -s /tmp/redis.sock -n 1000 -c 100 -k 1<br/>…<br/>90909.09 requests per second</span></pre><p id="5a49" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并通过TCP端口:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="b82e" class="lf lg iq kv b gy lh li l lj lk">root@bttrm-dev-console:/home/admin# redis-benchmark -p 7777 -n 1000 -c 100 -k 1<br/>…<br/>66666.67 requests per second</span></pre><p id="d310" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="na">90909</em>vs<em class="na">66666</em>——相当明显。</p><h2 id="8b21" class="lf lg iq bd me mf mg dn mh mi mj dp mk kf ml mm mn kj mo mp mq kn mr ms mt mu bi translated"><code class="fe ks kt ku kv b">loglevel</code></h2><p id="7850" class="pw-post-body-paragraph ju jv iq jw b jx mv jz ka kb mw kd ke kf mx kh ki kj my kl km kn mz kp kq kr ij bi translated">日志的不稳定级别。使用<em class="na">调试</em> —最详细，因此对主机资源(CPU等)来说更昂贵。</p><p id="4b9d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">可以设置为<em class="na">调试</em>、<em class="na">详细</em>、<em class="na">通知</em>、<em class="na">警告</em>。</p><p id="583b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">默认情况下——<em class="na">注意</em>，当应用程序仍处于配置状态时，可以保留该值。</p><h2 id="684d" class="lf lg iq bd me mf mg dn mh mi mj dp mk kf ml mm mn kj mo mp mq kn mr ms mt mu bi translated">操作系统级配置</h2><h2 id="37cd" class="lf lg iq bd me mf mg dn mh mi mj dp mk kf ml mm mn kj mo mp mq kn mr ms mt mu bi translated">透明巨页</h2><p id="4116" class="pw-post-body-paragraph ju jv iq jw b jx mv jz ka kb mw kd ke kf mx kh ki kj my kl km kn mz kp kq kr ij bi translated">在虚拟内存分配和管理期间利用对象进行操作的Linux内核特性。更多信息请参见<a class="ae kw" href="https://alexandrnikitin.github.io/blog/transparent-hugepages-measuring-the-performance-impact/" rel="noopener ugc nofollow" target="_blank">透明大页面:测量性能影响</a>、<a class="ae kw" href="https://blog.nelhage.com/post/transparent-hugepages/" rel="noopener ugc nofollow" target="_blank">禁用透明大页面</a>和<a class="ae kw" href="https://redis.io/topics/latency#latency-induced-by-transparent-huge-pages" rel="noopener ugc nofollow" target="_blank">透明大页面引起的延迟</a>。</p><p id="b8c0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在Redis中，从<a class="ae kw" href="https://redis.io/topics/latency#latency-induced-by-transparent-huge-pages" rel="noopener ugc nofollow" target="_blank">文件&gt; &gt; &gt; </a>判断，只有当RTB启用时才有意义，但完全可以禁用。</p><p id="90cb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您可以通过调用以下命令来检查当前值:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="8b65" class="lf lg iq kv b gy lh li l lj lk">root@bttrm-dev-app-1:/home/admin# cat /sys/kernel/mm/transparent_hugepage/enabled<br/>always [madvise] never</span></pre><p id="26ea" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">[]中的值是当前使用的值—<em class="na">mad device</em>。</p><p id="81e5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="na"> madvice </em>设置内核只在被<code class="fe ks kt ku kv b"><a class="ae kw" href="http://man7.org/linux/man-pages/man2/madvise.2.html" rel="noopener ugc nofollow" target="_blank">madvice()</a></code>调用直接请求的情况下使用THP。</p><p id="4725" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">可以使用下一个命令检查THP的使用情况:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="c3ee" class="lf lg iq kv b gy lh li l lj lk">root@bttrm-dev-app-1:/home/admin# grep HugePages /proc/meminfo<br/>AnonHugePages: 0 kB<br/>ShmemHugePages: 0 kB<br/>HugePages_Total: 0<br/>HugePages_Free: 0<br/>HugePages_Rsvd: 0<br/>HugePages_Surp: 0</span></pre><h2 id="8c26" class="lf lg iq bd me mf mg dn mh mi mj dp mk kf ml mm mn kj mo mp mq kn mr ms mt mu bi translated"><code class="fe ks kt ku kv b">maxclients</code>和<code class="fe ks kt ku kv b">fs.file-max</code></h2><p id="5090" class="pw-post-body-paragraph ju jv iq jw b jx mv jz ka kb mw kd ke kf mx kh ki kj my kl km kn mz kp kq kr ij bi translated">设置同时连接的最大客户端数量。</p><p id="677f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">默认值为10.000，可通过<code class="fe ks kt ku kv b">maxclients</code>覆盖，参见<a class="ae kw" href="https://redis.io/topics/clients#maximum-number-of-clients" rel="noopener ugc nofollow" target="_blank">最大客户端数量</a>。</p><p id="caff" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">同时— Redis将检查操作系统限制以及内核级限制— <code class="fe ks kt ku kv b">sysctl fs.file-max</code>:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="4154" class="lf lg iq kv b gy lh li l lj lk">root@bttrm-dev-app-1:/home/admin# sysctl fs.file-max<br/>fs.file-max = 202080<br/>root@bttrm-dev-app-1:/home/admin# cat /proc/sys/fs/file-max<br/>202080</span></pre><p id="1ff9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">和<code class="fe ks kt ku kv b">ulimit</code>作为每个进程的每个用户限制:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="bcd0" class="lf lg iq kv b gy lh li l lj lk">root@bttrm-dev-app-1:/home/admin# ulimit -Sn<br/>1024</span></pre><p id="a5ab" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于基于systemd的系统，这个限制可以通过<code class="fe ks kt ku kv b"><a class="ae kw" href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#Process%20Properties" rel="noopener ugc nofollow" target="_blank">LimitNOFILE</a></code>选项在Redis单元文件中设置:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="b08f" class="lf lg iq kv b gy lh li l lj lk">root@bttrm-dev-app-1:/home/admin# cat /etc/systemd/system/redis.service | grep LimitNOFILE<br/>LimitNOFILE=65535</span></pre><h2 id="232b" class="lf lg iq bd me mf mg dn mh mi mj dp mk kf ml mm mn kj mo mp mq kn mr ms mt mu bi translated"><code class="fe ks kt ku kv b">tcp-backlog</code>和<code class="fe ks kt ku kv b">net.core.somaxconn</code></h2><p id="66a3" class="pw-post-body-paragraph ju jv iq jw b jx mv jz ka kb mw kd ke kf mx kh ki kj my kl km kn mz kp kq kr ij bi translated">Redis可以将客户机的连接队列设置为在<code class="fe ks kt ku kv b">tcp-backlog</code>中指定的值(默认为511)。</p><p id="2d84" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">尽管如此，操作系统有自己的限制— <code class="fe ks kt ku kv b">net.core.somaxconn</code>如果它小于Redis的限制—那么将会产生警告:</p><blockquote class="nb nc nd"><p id="4ab1" class="ju jv na jw b jx jy jz ka kb kc kd ke ne kg kh ki nf kk kl km ng ko kp kq kr ij bi translated">由于/proc/sys/net/core/somaxconn被设置为较低值128，因此无法强制执行TCP backlog设置511</p></blockquote><p id="ae8c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">什么是TCP backlog和<code class="fe ks kt ku kv b">net.core.somaxconn</code></p><p id="7185" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了更好地理解在哪里以及如何应用<code class="fe ks kt ku kv b">tcp-backlog</code>以及<code class="fe ks kt ku kv b">net.core.somaxconn</code>的角色——让我们回顾一下TCP会话是如何建立的:</p><ol class=""><li id="0d1b" class="lq lr iq jw b jx jy kb kc kf ls kj lt kn lu kr nh lw lx ly bi translated">服务器:应用程序执行<code class="fe ks kt ku kv b"><a class="ae kw" href="http://man7.org/linux/man-pages/man2/listen.2.html" rel="noopener ugc nofollow" target="_blank">listen()</a></code> syscall，传递给它一个文件描述符到一个套接字，在第二个参数中——接受backlog 大小(从<code class="fe ks kt ku kv b">redis.conf</code>中得到的<code class="fe ks kt ku kv b">tcp-backlog</code>值)</li><li id="8e0a" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr nh lw lx ly bi translated">客户端:客户端的应用程序执行<code class="fe ks kt ku kv b">connect()</code>调用，并向服务器发送<strong class="jw ir"> SYN </strong>数据包</li><li id="9660" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr nh lw lx ly bi translated">在客户端—连接将其状态更改为<em class="na">同步发送</em></li><li id="029b" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr nh lw lx ly bi translated">在服务器端；一个新的连接被设置为<em class="na"> SYN_RCVD </em>状态；并被保存在<em class="na"> syn backlog </em> ( <code class="fe ks kt ku kv b">net.ipv4.tcp_max_syn_backlog</code> ) - <em class="na">未完成连接队列</em></li><li id="5337" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr nh lw lx ly bi translated">服务器:发送<strong class="jw ir"> SYN+ACK </strong></li><li id="62cf" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr nh lw lx ly bi translated">客户端:发送<strong class="jw ir"> ACK </strong>，将连接状态改为<em class="na">已建立</em>状态</li><li id="aaa2" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr nh lw lx ly bi translated">服务器:接受<strong class="jw ir"> ACK </strong>并将连接状态设置为<em class="na">已建立</em>并将其移动到<em class="na">接受积压</em> — <em class="na">完成连接队列</em></li><li id="4af3" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr nh lw lx ly bi translated">服务器:执行<code class="fe ks kt ku kv b"><a class="ae kw" href="http://man7.org/linux/man-pages/man2/accept.2.html" rel="noopener ugc nofollow" target="_blank">accept()</a></code>调用，传递来自<em class="na">接受积压</em>的连接</li><li id="b0cc" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr nh lw lx ly bi translated">客户端:执行<code class="fe ks kt ku kv b">write()</code>调用并开始发送数据</li><li id="3f97" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr nh lw lx ly bi translated">服务器:调用<code class="fe ks kt ku kv b">read()</code>系统调用并开始接收数据</li></ol><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ni"><img src="../Images/f5827a8ff2268b375bb6ab33dabb6b94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*M-AAIbqE3TpCSEbL.jpeg"/></div></div></figure><p id="7150" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，如果Redis将传递给<code class="fe ks kt ku kv b">listen()</code>的<code class="fe ks kt ku kv b">tcp-backlog</code>值大于内核在<code class="fe ks kt ku kv b">net.core.somaxconn</code>设置中的限制，您将得到“<em class="na"> TCP backlog设置不能被执行</em>”消息。</p><p id="ceb5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">默认值为128:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="888d" class="lf lg iq kv b gy lh li l lj lk">root@bttrm-dev-app-1:/home/admin# sysctl net.core.somaxconn<br/>net.core.somaxconn = 128</span></pre><p id="ae05" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并且可以通过<code class="fe ks kt ku kv b">sysctl -w</code>进行更新:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="40c8" class="lf lg iq kv b gy lh li l lj lk">root@bttrm-dev-console:/home/admin# sysctl -w net.core.somaxconn=65535<br/>net.core.somaxconn = 65535<br/>root@bttrm-dev-console:/home/admin# sysctl -p</span></pre><p id="399f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">参见<a class="ae kw" href="https://bunn.cc/2017/syn-backlog/" rel="noopener ugc nofollow" target="_blank"> TCP连接积压——苦苦挣扎的服务器</a> и <a class="ae kw" href="https://hackernoon.com/tcp-three-way-handshake-4161eb8aba32" rel="noopener ugc nofollow" target="_blank"> TCP三方握手</a>。</p><h2 id="9cf9" class="lf lg iq bd me mf mg dn mh mi mj dp mk kf ml mm mn kj mo mp mq kn mr ms mt mu bi translated"><code class="fe ks kt ku kv b">vm.overcommit_memory</code></h2><p id="b48f" class="pw-post-body-paragraph ju jv iq jw b jx mv jz ka kb mw kd ke kf mx kh ki kj my kl km kn mz kp kq kr ij bi translated">对我来说最模糊的参数。</p><p id="82c9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我强烈推荐阅读<a class="ae kw" href="https://rtfm.co.ua/en/redis-fork-cannot-allocate-memory-linux-virtual-memory-and-vm-overcommit_memory/" rel="noopener ugc nofollow" target="_blank"> Redis: fork —不能分配内存、Linux、虚拟内存和vm.overcommit_memory </a>。</p><p id="cf7b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">另见<code class="fe ks kt ku kv b"><a class="ae kw" href="https://www.kernel.org/doc/Documentation/vm/overcommit-accounting" rel="noopener ugc nofollow" target="_blank">overcommit_memory</a></code>和<a class="ae kw" href="https://redis.io/topics/faq#background-saving-fails-with-a-fork-error-under-linux-even-if-i-have-a-lot-of-free-ram" rel="noopener ugc nofollow" target="_blank">在Linux下后台保存失败，出现fork()错误，即使我有很多空闲RAM </a>。</p><p id="802b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">当Redis从磁盘上的内存创建数据快照时，<code class="fe ks kt ku kv b">overcommit_memory</code>介入，特别是在<code class="fe ks kt ku kv b"><a class="ae kw" href="https://rtfm.co.ua/goto/https://redis.io/commands/bgsave" rel="noopener ugc nofollow" target="_blank">BGSAVE</a></code>期间</p><p id="da6c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在我们当前的例子中，当Redis仅用于缓存，并且没有启用RDB或AOF备份时，不需要更改<code class="fe ks kt ku kv b">overcommit_memory</code>，最好保留默认值0。</p><p id="6121" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果您真的想自己设定界限，最好使用<code class="fe ks kt ku kv b">overcommit_memory</code> == 2，并通过设置<code class="fe ks kt ku kv b">overcommit_ratio</code>或<code class="fe ks kt ku kv b">overcommit_kbytes</code>参数来限制过度承诺。</p><h2 id="fa82" class="lf lg iq bd me mf mg dn mh mi mj dp mk kf ml mm mn kj mo mp mq kn mr ms mt mu bi translated"><code class="fe ks kt ku kv b">vm.swappiness</code></h2><p id="638f" class="pw-post-body-paragraph ju jv iq jw b jx mv jz ka kb mw kd ke kf mx kh ki kj my kl km kn mz kp kq kr ij bi translated">如果操作系统配置了交换，它可以将一些Redis的数据转储到磁盘，以后Redis试图访问这些数据时，可能需要很长时间才能将它们读回内存。</p><p id="2c0f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要避免这种情况，请完全禁用交换:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="4bce" class="lf lg iq kv b gy lh li l lj lk">root@bttrm-dev-console:/home/admin# sysctl -w vm.swappiness=0</span></pre><h2 id="dbfb" class="lf lg iq bd me mf mg dn mh mi mj dp mk kf ml mm mn kj mo mp mq kn mr ms mt mu bi translated">有用的链接</h2><ul class=""><li id="ae4f" class="lq lr iq jw b jx mv kb mw kf nj kj nk kn nl kr lv lw lx ly bi translated"><a class="ae kw" href="http://download.redis.io/redis-stable/redis.conf" rel="noopener ugc nofollow" target="_blank"> redis.conf </a></li><li id="a5e6" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="http://download.redis.io/redis-stable/sentinel.conf" rel="noopener ugc nofollow" target="_blank"> sentinel.conf </a></li><li id="44c8" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://redislabs.com/blog/5-tips-for-running-redis-over-aws/" rel="noopener ugc nofollow" target="_blank">在AWS上运行Redis的5个技巧</a></li><li id="ea64" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated">雷迪斯:我喜欢你，但你疯了</li><li id="abb8" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://medium.com/@abhishekbhardwaj510/redis-best-practices-and-performance-tuning-c48611388bbc" rel="noopener"> Redis最佳实践和性能调优</a></li><li id="c424" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://tech.trivago.com/2017/01/25/learn-redis-the-hard-way-in-production/" rel="noopener ugc nofollow" target="_blank">艰难地学习Redis(在生产中)</a></li><li id="fd42" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://sorentwo.com/2015/07/27/optimizing-redis-usage-for-caching.html" rel="noopener ugc nofollow" target="_blank">优化Redis缓存使用</a></li><li id="f8e3" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated">【Redis多线程I/O性能指标评测</li><li id="78b3" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://scaleyourcode.com/blog/article/15" rel="noopener ugc nofollow" target="_blank"> Redis生产配置</a></li><li id="c853" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://blogs.technet.microsoft.com/nettracer/2010/06/03/things-that-you-may-want-to-know-about-tcp-keepalives/" rel="noopener ugc nofollow" target="_blank">关于TCP Keepalives你可能想知道的事情</a></li><li id="11e7" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://www.compose.com/articles/redis-configuration-controls-new-at-compose/" rel="noopener ugc nofollow" target="_blank"> Redis配置控件</a></li><li id="6c2d" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://www.datadoghq.com/pdf/Understanding-the-Top-5-Redis-Performance-Metrics.pdf" rel="noopener ugc nofollow" target="_blank">了解前5名Redis绩效指标</a></li><li id="7bb5" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://easyengine.io/tutorials/redis/" rel="noopener ugc nofollow" target="_blank">с收集我们的笔记以调整redis </a></li><li id="3c86" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://habr.com/ru/company/tinkoff/blog/446342/" rel="noopener ugc nofollow" target="_blank">влияние透明巨页напроизводительностьсистемы</a></li><li id="56ab" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://ibm.github.io/event-streams/troubleshooting/redis-latency-transparent-huge-pages/" rel="noopener ugc nofollow" target="_blank">由于透明的大页面导致Redis延迟</a></li><li id="97cf" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://alexandrnikitin.github.io/blog/transparent-hugepages-measuring-the-performance-impact/" rel="noopener ugc nofollow" target="_blank">透明大页面:测量性能影响</a></li><li id="c614" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://blog.nelhage.com/post/transparent-hugepages/" rel="noopener ugc nofollow" target="_blank">禁用透明超大页面</a></li><li id="48bc" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="http://shokunin.co/blog/2014/11/11/operational_redis.html" rel="noopener ugc nofollow" target="_blank">生产中运行Redis</a>(<em class="na">2014год</em></li><li id="ef7d" class="lq lr iq jw b jx lz kb ma kf mb kj mc kn md kr lv lw lx ly bi translated"><a class="ae kw" href="https://kamaok.org.ua/?p=2461" rel="noopener ugc nofollow" target="_blank">настрокаRedis</a></li></ul></div><div class="ab cl nm nn hu no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="ij ik il im in"><p id="c1ef" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="na">最初发布于</em> <a class="ae kw" href="https://rtfm.co.ua/en/draft-eng-redis-main-configuration-parameters-and-performance-tuning-overview/" rel="noopener ugc nofollow" target="_blank"> <em class="na"> RTFM: Linux、DevOps和系统管理</em> </a> <em class="na">。</em></p></div></div>    
</body>
</html>