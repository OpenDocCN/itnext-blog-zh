<html>
<head>
<title>Infrastructure as Code with Azure Blueprints and is it a Terraform Alternative</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基础设施作为带有Azure蓝图的代码，它是一个平台替代方案吗</h1>
<blockquote>原文：<a href="https://itnext.io/iac-azure-blueprints-and-terraform-7349ecf8d61c?source=collection_archive---------1-----------------------#2020-04-22">https://itnext.io/iac-azure-blueprints-and-terraform-7349ecf8d61c?source=collection_archive---------1-----------------------#2020-04-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/2b4abeff73bbe849d7770e214ac8fbc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kn9q95ogofs1Ws3caMiyKA.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">来自<a class="ae kf" href="https://pixabay.com/de/photos/blaupause-herrscher-architektur-964630/" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae kf" href="https://pixabay.com/de/users/wokandapix-614097/" rel="noopener ugc nofollow" target="_blank"> Wokandapix </a>的照片</figcaption></figure><p id="7f82" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">云基础设施的部署不再是令人困惑的GUI中的点击式冒险。相反，工具用于将基础设施描述为代码。各种提供商为他们的云服务提供专有解决方案，如亚马逊网络服务(AWS)的CloudFormation或OpenStack的Heat。另一方面，还有Terraform等解决方案，支持多个云提供商。微软在这个领域也很活跃，并为他们的Azure云提供蓝图服务，目前仍处于预览状态。</p><p id="f3fa" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">本文描述了如何使用Azure资源管理(ARM)模板通过Blueprint服务在Azure中创建基础设施，并列出了常见的陷阱。</p><h1 id="79a9" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">介绍</h1><p id="e71d" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">在我的微软Azure蓝图之旅的开始，我对蓝图可能如何工作有一些期望。它能与Terraform相媲美吗？它会错过一些地形特征吗？经过几天对服务的熟悉，我对如何使用它和它的可用特性集感到有点惊讶。</p><h1 id="b00d" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">蓝图架构</h1><p id="4a8b" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">蓝图的架构基于两个主要组件:蓝图文件和工件。工件可以是角色、策略和ARM模板。所有这些文件都是以json格式编写的。一般来说，文件的结构如下:“blueprint.json”文件位于根目录中，工件位于工件文件夹中。下面的目录树说明了这一点。文件的内容描述如下。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mh"><img src="../Images/179c8b696c9f3848a59a412280d26808.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lc91P41ftlkjyW-1Zeu-fw.png"/></div></div></figure><h2 id="b81c" class="mm lf it bd lg mn mo dn lk mp mq dp lo kr mr ms ls kv mt mu lw kz mv mw ma mx bi translated">blueprint.json</h2><p id="8243" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">该文件描述了要创建的所有资源组以及蓝图级别的参数。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi my"><img src="../Images/2c4d22b8f542732514fa3d9bb7c5a1e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V9MyWEQnkZM7TQPaLyPh5Q.png"/></div></div></figure><h2 id="c6c1" class="mm lf it bd lg mn mo dn lk mp mq dp lo kr mr ms ls kv mt mu lw kz mv mw ma mx bi translated">政策. json</h2><p id="a5e5" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">在策略工件中，有必要指定类型。在这种情况下，使用“policyAssignment”和属性“policyDefinitionId”。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mz"><img src="../Images/48c3068620f0b690b4b6ff391331bcd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jQpLPeZAUC7DtXAhlhOzbQ.png"/></div></div></figure><h2 id="4ca1" class="mm lf it bd lg mn mo dn lk mp mq dp lo kr mr ms ls kv mt mu lw kz mv mw ma mx bi translated">role.json</h2><p id="fef0" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">首先，这个文件指定了它是哪种工件。对于角色分配，这是具有“角色定义Id”和“原则id”属性的“角色分配”。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mz"><img src="../Images/7c15f5097dfc747f7595307e1187ccbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZiMG6nWnKqbzIa5OvAW_iQ.png"/></div></div></figure><h2 id="4d4b" class="mm lf it bd lg mn mo dn lk mp mq dp lo kr mr ms ls kv mt mu lw kz mv mw ma mx bi translated">arm-模板. json</h2><p id="cea0" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">术语ARM-template代表Azure资源管理器模板。它描述了要在指定的资源组中创建的资源。微软在其<a class="ae kf" href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/template-syntax" rel="noopener ugc nofollow" target="_blank">文档</a>中描述了模板的确切结构和语法。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi na"><img src="../Images/b7053e49762274bbadf72f657527d7ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XnvrLF3uiKh1JGfsUSzoKg.png"/></div></div></figure><h1 id="cb32" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">示例创建虚拟网络子网堡垒</h1><p id="1d93" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">以下示例描述了如何创建一个包含虚拟网络(vnet)、子网和堡垒主机的资源组，以便以更高的安全性管理组中的资源。文件夹结构如下树所示。注意工件json-files开头的数字。其原因将在下一章中描述。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nb"><img src="../Images/10162447e272064efb67804dbb5176e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_MUni_2K4oV8gaeCToF5UA.png"/></div></div></figure><p id="90bd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们从定义蓝图级参数开始。下面的列表对它们进行了概述。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nc"><img src="../Images/0797beb24dd9adc01987c87c80b8a240.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qT5PNzPfDdhtdR3aY3U5EA.png"/></div></div></figure><p id="76af" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">利用参数描述和蓝图的文件结构，我们能够创建“blueprint.json”文件。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nd"><img src="../Images/b63d7ec467760444537d2906c3cef3b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hPgNHWQhG5Ga2lzkbm_ACQ.png"/></div></div></figure><p id="a7e5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有不同的方法来组合工件，将所有的资源放在一个ARM模板文件中。这对于小型部署是有意义的，但是对于大型部署，我推荐另一种方法:在单独的文件中定义每个资源。这提供了一个更好的概览，并更容易地改进您的部署结构。这就是我们在这个故事中要遵循的方式。我们为网络资源创建一个工件文件，并为堡垒主机创建一个单独的文件。第一个文件是“01_network.json”文件，它包括虚拟网络和子网定义。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ne"><img src="../Images/2cbe9978a93fbe8906e64fbbdef4f171.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jKa0VxHiuOGaznxPt4Ij7w.png"/></div></div></figure><p id="b786" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">部署的第二部分包括创建堡垒主机、公共IP地址并将其分配给主机。这将在“02_bastion.json”文件中定义。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nf"><img src="../Images/c77e9ef50b27f6b88a92411ccf8861ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VR4F9oDOvcQdEKX4PJewRQ.png"/></div></div></figure><p id="d0ea" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正如我们所看到的，资源部分包含两个资源。首先是公共IP地址资源，其次是分配了虚拟网络和公共IP地址的堡垒主机。</p><h1 id="81da" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">蓝图处理和工作流程</h1><p id="50cf" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">现在我们已经准备好在微软Azure中通过Rest API或PowerShell创建蓝图。两种方式都使用不同的命令执行相同的过程。以下步骤描述了该过程:</p><ul class=""><li id="c2e4" class="ng nh it ki b kj kk kn ko kr ni kv nj kz nk ld nl nm nn no bi translated">使用blueprint.json文件创建蓝图</li><li id="e96f" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated">将您的工件一个文件一个文件地添加到蓝图中(不可能用一个命令导入多个工件)</li><li id="6c58" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated">发布您的蓝图</li><li id="30e9" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated">分配蓝图</li></ul><p id="3488" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这些步骤在针对<a class="ae kf" href="https://docs.microsoft.com/en-us/azure/governance/blueprints/create-blueprint-rest-api" rel="noopener ugc nofollow" target="_blank"> Rest API </a>和<a class="ae kf" href="https://docs.microsoft.com/en-us/azure/governance/blueprints/create-blueprint-powershell" rel="noopener ugc nofollow" target="_blank"> PowerShell </a>的Azure文档中有更详细的描述。</p><p id="5b01" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正如已经提到的，工件的命名很重要。当蓝图被分配时，工件以字母数字的顺序被执行。因此，在命名工件文件时，您必须考虑对资源的依赖性。我建议在文件名的开头使用数字顺序。</p><p id="3fac" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">重要的是要知道，大多数API和PowerShell特性在Web-UI上不可用，并且在创建过程中云服务不会检查蓝图上的更改。错误只会在分配过程中显示。这是一个巨大的缺点，因为它使得蓝图的开发更加困难和耗时。</p><h1 id="5088" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">使用PowerShell导入和导出蓝图</h1><p id="f15f" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">如果您已经创建了一个蓝图，您可以导入或导出整个蓝图定义。微软的<a class="ae kf" href="https://docs.microsoft.com/bs-latn-ba/azure/governance/blueprints/how-to/import-export-ps" rel="noopener ugc nofollow" target="_blank">文档</a>中也描述了这个过程，在那里你也可以找到这些命令。</p><p id="ca50" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，您需要蓝图对订阅的引用，这可以通过下面的命令来完成。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mz"><img src="../Images/a36b380f2b9cb4a668ef0738c6ccb784.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fvgk-5cjDjef7KRHc8pxDw.png"/></div></div></figure><p id="9a30" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要导出蓝图，您可以使用导出命令。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mz"><img src="../Images/7d8ceb8f4f6184faace44e351445f0e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*guXvdsHtRUrR77VlseXwDA.png"/></div></div></figure><p id="8685" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并且可以使用import命令完成导入。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mz"><img src="../Images/6e606bc2acdd6eb65a7fcfe1ad09b781.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U30zUW8CkPq-97yUJc5EgQ.png"/></div></div></figure><h1 id="9793" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">蓝色蓝图和地形</h1><p id="9e54" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">最后，我将描述这两种技术的关键特征和优势。</p><p id="e995" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">蓝图服务提供以下功能:</p><ul class=""><li id="6afa" class="ng nh it ki b kj kk kn ko kr ni kv nj kz nk ld nl nm nn no bi translated">该服务包括版本控制，这使得处理一个蓝图的多个状态变得更加容易。</li><li id="d7d9" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated">blueprints服务与微软Azure的集成是高层次的，可以通过API、PowerShell和部分Web-UI来管理。</li><li id="d100" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated">蓝图可以在管理组级别使用。</li><li id="a308" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated">微软为这项服务提供了复杂的文档，包括示例和附加信息。它分布在许多页面上，这使得对服务进行概述和熟悉变得不必要的复杂。</li><li id="c35b" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated">Blueprints是一项专有服务，仅适用于Azure cloud。</li></ul><p id="8bd0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">另一方面，Terraform具有以下特征:</p><ul class=""><li id="fb15" class="ng nh it ki b kj kk kn ko kr ni kv nj kz nk ld nl nm nn no bi translated">它可以用于多个云部署。</li><li id="7a72" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated">它有一个很大的社区，为开发提供了很多例子和帮助。</li><li id="c56f" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated">Terraform自动管理依赖关系。</li><li id="7c64" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated">语法和部署检查包括在内，这大大提高了开发速度。</li><li id="1691" class="ng nh it ki b kj np kn nq kr nr kv ns kz nt ld nl nm nn no bi translated">文档结构良好，形状稳定。</li></ul><h1 id="6f41" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="ee02" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我建议将Blueprint服务仅用于管理组级别的特殊Azure功能，例如为订阅(如策略和角色)提供框架。对于复杂的基础设施，我更喜欢使用Terraform，它提供了更多的灵活性。</p><p id="11a7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Azure Blueprints可能会成为一项可靠的服务。微软需要开发更容易描述资源依赖和共享变量的特性。该服务需要更高效的开发流程来检查语法和依赖关系，以提供更快的上传蓝图更改的解决方案，并与Terraform竞争。</p></div></div>    
</body>
</html>