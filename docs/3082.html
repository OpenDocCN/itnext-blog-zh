<html>
<head>
<title>.NET Core Worker Service</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">。网络核心工人服务</h1>
<blockquote>原文：<a href="https://itnext.io/net-core-worker-service-23a0ec422600?source=collection_archive---------3-----------------------#2019-09-30">https://itnext.io/net-core-worker-service-23a0ec422600?source=collection_archive---------3-----------------------#2019-09-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="78dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大约一年前，我写了一篇文章<a class="ae kl" href="https://elanderson.net/2018/09/host-asp-net-core-application-as-a-windows-service/" rel="noopener ugc nofollow" target="_blank">将ASP.NET核心应用作为Windows服务</a>。随着即将发布的。NET Core 3之后，我们现在有了另一个选项，可以使用新的Worker服务模板来创建服务。这篇文章将介绍如何使用新的Worker服务模板创建一个新的应用程序，然后将该服务作为Windows服务运行。</p><h2 id="c309" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">项目创建</h2><p id="aff1" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">这个过程我准备用Visual Studio 2019预览版。如果您愿意，您可以使用。请使用下面的命令来创建项目。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="add1" class="km kn iq lp b gy lt lu l lv lw">dotnet new worker</span></pre><p id="ba3d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于Visual Studio，打开应用程序并选择<strong class="jp ir">创建新项目</strong>选项。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi lx"><img src="../Images/08bfa2a3c775038a16b449ff2b42a529.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*FiK2XOH8IAQ5_YFq.png"/></div></div></figure><p id="570e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在下一个屏幕上搜索<strong class="jp ir">工人服务</strong>，点击<strong class="jp ir">下一步</strong>。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi lx"><img src="../Images/1f6dac9eaa3841900a1105fe9c4be3b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*m6UK_3ItWJqZrVBo.png"/></div></div></figure><p id="6702" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在下一个屏幕上输入一个<strong class="jp ir">项目名</strong>并点击<strong class="jp ir">创建</strong>按钮。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi lx"><img src="../Images/d232e9754c01368aef0d76248ea48591.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4miS_TjGS5Y_4yFs.png"/></div></div></figure><p id="5aaf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，单击create按钮最终创建项目，除非您想使用Docker。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi lx"><img src="../Images/957960071f6439420ac28e5273ed4424.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DFsWdrzMoa5zg-SU.png"/></div></div></figure><h2 id="d795" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">项目结构</h2><p id="c483" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">最终的结构非常简单。我们将要处理的两个文件是<strong class="jp ir"> Program.cs </strong>和<strong class="jp ir"> Worker.cs </strong>。</p><p id="5cd1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> Program.cs </strong>是应用程序的入口点，定义了您想要运行的不同作品。下面的示例设置了两个不同的工人。默认模板只有一个工人，但是我添加了第二个工人，以显示多个工人是一个选项。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="dfeb" class="km kn iq lp b gy lt lu l lv lw">public class Program<br/>{<br/>    public static void Main(string[] args)<br/>    {<br/>        CreateHostBuilder(args).Build().Run();<br/>    }<br/><br/>    public static IHostBuilder CreateHostBuilder(string[] args) =&gt;<br/>        Host.CreateDefaultBuilder(args)<br/>            .ConfigureServices((hostContext, services) =&gt;<br/>            {<br/>                services.AddHostedService&lt;Worker&gt;();<br/>                services.AddHostedService&lt;Worker2&gt;();<br/>            });<br/>}</span></pre><p id="a1ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> Worker.cs </strong>包含被调用来执行工作的代码。下面是从模板创建的默认工作线程。这个工人每秒只写一次日志。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="1053" class="km kn iq lp b gy lt lu l lv lw">public class Worker : BackgroundService<br/>{<br/>    private readonly ILogger&lt;Worker&gt; _logger;<br/><br/>    public Worker(ILogger&lt;Worker&gt; logger)<br/>    {<br/>        _logger = logger;<br/>    }<br/><br/>    protected override async Task ExecuteAsync(CancellationToken stoppingToken)<br/>    {<br/>        while (!stoppingToken.IsCancellationRequested)<br/>        {<br/>            _logger.LogInformation("Worker running at: {time}",<br/>                                   DateTimeOffset.Now);<br/>            await Task.Delay(1000, stoppingToken);<br/>        }<br/>    }<br/>}</span></pre><p id="5e4e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此时，您可以运行应用程序，它将执行您设置的任何工作。</p><h2 id="ed8e" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">作为Windows服务运行</h2><p id="15a3" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">要将项目作为Windows服务运行，我们需要添加一个NuGet包。为此，右击项目文件并选择<strong class="jp ir">管理NuGet包</strong>。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/d82c26eccb5fc9f84db5fe669d253192.png" data-original-src="https://miro.medium.com/v2/resize:fit:684/format:webp/0*38R5dN_Pjzc0Z0cz.png"/></div></figure><p id="f2c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在NuGet对话框中点击<strong class="jp ir">浏览</strong>选项卡，勾选<strong class="jp ir">包含预发布</strong>复选框，搜索<strong class="jp ir">微软。extensions . hosting . windows services</strong>，最后点击<strong class="jp ir">安装</strong>。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi lx"><img src="../Images/4cec82db15bbe36651a81ea0f5616a33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*G98wGz4akSsRM9lQ.png"/></div></div></figure><p id="6aab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">软件包安装完成后，打开<strong class="jp ir"> Program.cs </strong>，在<strong class="jp ir"> CreateHostBuilder </strong>函数中添加对<strong class="jp ir"> UseWindowsService </strong>主机构建器的调用。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="d6a5" class="km kn iq lp b gy lt lu l lv lw">public static IHostBuilder CreateHostBuilder(string[] args) =&gt;<br/>    Host.CreateDefaultBuilder(args)<br/>        .UseWindowsService()<br/>        .ConfigureServices((hostContext, services) =&gt;<br/>        {<br/>            services.AddHostedService&lt;Worker&gt;();<br/>            services.AddHostedService&lt;Worker2&gt;();<br/>        });</span></pre><h2 id="1d05" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">发布应用程序</h2><p id="8f32" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">既然我们已经将应用程序设置为能够作为Windows服务运行，我们需要发布它。从发布。您可以在包含解决方案或项目文件的目录中使用以下命令。如果您希望输出到不同的目录，还有一个输出位置选项。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="0639" class="km kn iq lp b gy lt lu l lv lw">dotnet publish</span></pre><p id="9e63" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者从Visual Studio中单击<strong class="jp ir">构建&gt;发布{解决方案名称} </strong>菜单。选择左侧的<strong class="jp ir">文件夹</strong>选项，然后点击<strong class="jp ir">创建档案</strong>。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi lx"><img src="../Images/d6cade19e0f709dde38e97dc621b6d5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WWLIUxJYl-YsN2x1.png"/></div></div></figure><p id="d883" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在下一个屏幕上，点击<strong class="jp ir">发布</strong>按钮。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi lx"><img src="../Images/692d4037cb2f374c0869507d81846d9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LVSAdwSjdqhwHpUO.png"/></div></div></figure><h2 id="faea" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">服务安装和管理</h2><p id="28ae" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">此时，可以像任何其他Windows服务一样安装和管理该应用程序。要安装该服务，请在管理模式下打开命令提示符，并运行以下命令来创建windows服务。<strong class="jp ir"> binPath </strong>需要是exe的完整路径，否则即使创建成功，服务也无法启动。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="5056" class="km kn iq lp b gy lt lu l lv lw">sc create WindowsServiceHosted binPath= "C:\Users\eanderson\Desktop\Worker\Worker\bin\Debug\netcoreapp3.0\publish\Worker.exe"</span></pre><p id="f467" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另外，注意在<strong class="jp ir"> binPath= </strong>之后和exe名称之前需要空格。</p><p id="e3ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在服务已经安装完毕，运行下面的命令来启动它。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="e762" class="km kn iq lp b gy lt lu l lv lw">sc start Worker</span></pre><p id="87be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要检查服务的状态，请使用以下命令。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="e908" class="km kn iq lp b gy lt lu l lv lw">sc query Worker</span></pre><p id="bd17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要停止服务，请使用以下命令。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="386c" class="km kn iq lp b gy lt lu l lv lw">sc stop Worker</span></pre><p id="4445" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，使用下面的命令卸载您的服务。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="792c" class="km kn iq lp b gy lt lu l lv lw">sc delete Worker</span></pre><h2 id="2db5" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">包扎</h2><p id="c17c" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">这个模板使工人很容易上手。希望这能帮助你开始。确保并检查<a class="ae kl" href="https://devblogs.microsoft.com/aspnet/net-core-workers-as-windows-services/" rel="noopener ugc nofollow" target="_blank">。微软的. NET核心工作者作为Windows服务</a>帖子。</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><p id="5bdf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mn">最初发表于</em> <a class="ae kl" href="https://elanderson.net/2019/09/net-core-worker-service/" rel="noopener ugc nofollow" target="_blank"> <em class="mn">埃里克·安德森</em> </a> <em class="mn">。</em></p></div></div>    
</body>
</html>