<html>
<head>
<title>Kubectl plugin for blue/green deployment strategy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于蓝/绿部署策略的Kubectl插件</h1>
<blockquote>原文：<a href="https://itnext.io/kubectl-plugin-for-blue-green-deployment-strategy-cc5b40a87817?source=collection_archive---------2-----------------------#2021-08-01">https://itnext.io/kubectl-plugin-for-blue-green-deployment-strategy-cc5b40a87817?source=collection_archive---------2-----------------------#2021-08-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="bf2e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">互联网上有许多文档解释了蓝/绿部署的工作原理以及在生产中使用它的优势。如果你不熟悉Kubernetes上的"<strong class="jp ir">蓝/绿"</strong>部署，你可以先在这篇<a class="ae kl" href="https://www.weave.works/blog/kubernetes-deployment-strategies" rel="noopener ugc nofollow" target="_blank">文章</a>中了解一下。本文的目的是解释在Kubernetes上部署web应用程序(尤其是静态Web应用程序)时，如果不使用“蓝/绿”策略，在发布期间可能会出现的问题。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/ba69ac9e20b884c143b250911d74b008.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VA0iBkPsYVyZw_UnTLm8Bg.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">艺术由<a class="ae kl" href="https://twitter.com/deniseyu21" rel="noopener ugc nofollow" target="_blank">丹尼斯</a></figcaption></figure><h2 id="d45c" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated"><strong class="ak">滚动更新策略的问题</strong></h2><p id="f6c6" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">每个静态web应用程序都包含HTML、CSS、JavaScript和图像资产，这些资产在两个连续版本之间可能会有所不同。<br/>在应用发布时，没有人能保证所有版本在分布式环境中相互兼容，包括<strong class="jp ir">用户浏览器缓存</strong>、<strong class="jp ir"> CDN网络</strong>和<strong class="jp ir">为其服务的Kubernetes集群</strong>。<br/>与<strong class="jp ir"> HTML </strong>和<strong class="jp ir"> JS </strong>文件不同，所有其他资产都是独立的。由于HTML文件包含javascript文件的链接，在从版本(N)到版本(N+1)的每个版本中，我们可以用新的文件名和内容替换javascript链接/文件(构建过程的一部分)。</p><p id="4e89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设我们在Kubernetes中使用默认的滚动更新策略来管理我们的部署，在这种情况下，在发布时我们有两个关于<strong class="jp ir"> JS </strong>和<strong class="jp ir"> HTML </strong>文件的不兼容版本，如果第一个HTTP请求命中版本N+1(新版本)，而来自用户的第二个HTTP请求(基于新版本的内容)到达版本N(旧版本)，结果将是<strong class="jp ir"> 404 Not Found </strong>，因为旧版本没有该内容。<br/>默认情况下，Kubernetes盲目地将用户流量路由到pod(因为k8s <strong class="jp ir"> kube-proxy </strong>不知道L7报头请求)。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ma"><img src="../Images/5241a096dbdf3599e7ad9ef1e6cfc7e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H3naqo9s7GeAh1hgRZfP1g.png"/></div></div></figure><h2 id="5db0" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">解决办法</h2><p id="0300" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">使用蓝/绿部署可以解决这个问题。根据经验，同时组合不兼容的应用程序版本会导致不可预知的结果。</p><h2 id="f098" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">权衡取舍</h2><p id="0e71" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">有太多的技术和工具可以在Kubernetes上实现蓝/绿色部署，选择其中之一是一个困难的决定，就像世界上的其他决定一样，每一个都有利弊。我们应该根据我们的需求选择其中之一(或者创建一个新的解决方案)。</p><p id="ba5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或许你已经知道服务网格技术，比如<a class="ae kl" href="https://istio.io/" rel="noopener ugc nofollow" target="_blank"> Istio </a>、<a class="ae kl" href="https://www.consul.io/" rel="noopener ugc nofollow" target="_blank">consult</a>、<a class="ae kl" href="https://linkerd.io/" rel="noopener ugc nofollow" target="_blank"> Linkerd </a>、<a class="ae kl" href="https://kuma.io/" rel="noopener ugc nofollow" target="_blank">库马</a>等等……这些技术可以处理不同的部署策略，具有大量的特性和出色的可见性。但另一方面，他们需要大量资源，还需要重新设计当前的Kubernetes集群，以满足实施要求。</p><p id="f5f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我的案例中，为了在一个小型且如此关键的Kubernetes集群中管理蓝/绿部署，我们需要一个具有<strong class="jp ir">快速实施、低资源使用</strong>和<strong class="jp ir">总体</strong> <strong class="jp ir">低风险的解决方案。<br/> </strong>所以我们想出了创建一个简单的<a class="ae kl" href="https://github.com/afshinpaydar/kubedeploy" rel="noopener ugc nofollow" target="_blank"> Kubectl插件</a>来管理蓝/绿部署，而不需要对我们的k8s集群进行巨大的改变。</p><h2 id="3c6a" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated"><strong class="ak">插件如何工作</strong><strong class="ak">Kube-deploy</strong></h2><p id="d6b5" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated"><strong class="jp ir"> Kube-deploy </strong>插件需要两个以<code class="fe mb mc md me b">-blue</code>和<code class="fe mb mc md me b">-green</code>结尾的部署，每个部署都有“app”和“version”标签，如下例所示:</p><pre class="kn ko kp kq gt mf me mg mh aw mi bi"><span id="a011" class="lc ld iq me b gy mj mk l ml mm">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: test-app-blue<br/>  labels:<br/>    app: test-app<br/>    version: "V1"<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: test-app<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: test-app<br/>        version: "V1"<br/>    spec:<br/>      containers:<br/>        - name: test-app</span><span id="89f5" class="lc ld iq me b gy mn mk l ml mm">---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: test-app-green<br/>  labels:<br/>    app: test-app<br/>    version: "dormant"<br/>spec:<br/>  replicas: 0<br/>  selector:<br/>    matchLabels:<br/>      app: test-app<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: test-app<br/>        version: "dormant"<br/>    spec:<br/>      containers:<br/>        - name: test-app</span></pre><p id="3185" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">他们面前的服务带有“应用”和“版本”标签选择器，如下所示:</p><pre class="kn ko kp kq gt mf me mg mh aw mi bi"><span id="3c8e" class="lc ld iq me b gy mj mk l ml mm">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: test-app<br/>spec:<br/>  selector:<br/>    app: test-app<br/>    version: "V1"<br/>  ports:<br/>    - name: web<br/>      protocol: TCP<br/>      port: 80</span></pre><p id="968b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行<code class="fe mb mc md me b">kubectl deploy bluegreen test-app V2</code>命令，首先将<code class="fe mb mc md me b">dormant</code>部署(在上面的例子中:<code class="fe mb mc md me b">test-app-green</code>)映像标签修补到版本<code class="fe mb mc md me b">V2</code>，并等待直到该部署成功完成(为了安全部署，我们必须使用<code class="fe mb mc md me b">livenessProbe</code>和<code class="fe mb mc md me b">readinessProbe</code>)，然后它扩展新部署并将服务的标签选择器更改为新版本，这一更改将导致用户的流量立即转到新版本，最后旧部署将缩减到零<code class="fe mb mc md me b">-replicas 0</code>，并将修补到下一个版本的<code class="fe mb mc md me b">dormant</code>。</p><p id="22e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在任何情况下，如果部署到新版本失败，我们不再需要担心，因为服务和用户流量不会发生任何变化，部署将回滚，不会影响实时部署和流量。</p><p id="f6b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">结论</strong></p><p id="2455" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">默认的Kubernetes实现并不适合每一个应用程序部署，我们应该根据我们的需求应用配置和附加组件，以帮助为用户提供更稳定的应用程序。<br/> <code class="fe mb mc md me b"><a class="ae kl" href="https://github.com/afshinpaydar/kubedeploy" rel="noopener ugc nofollow" target="_blank">kubectl deploy</a></code>是一个简单的蓝/绿部署kubectl插件，它完成一项工作，而不会消耗更多的资源来为应用程序提供服务。它易于使用，资源消耗非常低。</p><p id="652f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Github回购:【https://github.com/afshinpaydar/kubedeploy T2】</p></div></div>    
</body>
</html>