<html>
<head>
<title>Kubernetes Cluster Autoscaler: More than scaling out</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes集群自动扩展:不仅仅是横向扩展</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-cluster-autoscaler-more-than-scaling-out-7b2d97f10b27?source=collection_archive---------3-----------------------#2019-09-16">https://itnext.io/kubernetes-cluster-autoscaler-more-than-scaling-out-7b2d97f10b27?source=collection_archive---------3-----------------------#2019-09-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/97494f6898b8efa064c2e9adea0aa89a.png" data-original-src="https://miro.medium.com/v2/resize:fit:708/format:webp/1*SM2K6St-CF-VcarnTjXvlg.png"/></div></figure><p id="f76e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，您已经有了全新的Kubernetes (k8s)集群，并且已经部署了第一批应用程序。您已经启用了<a class="ae ks" href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/" rel="noopener ugc nofollow" target="_blank">水平窗格自动缩放</a>，您已经为您的应用程序准备好了黄金时间。您已经为您的集群配置了最小和最大数量的节点，以便在调度的pods不适合现有节点的情况下，<a class="ae ks" href="https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler#cluster-autoscaler" rel="noopener ugc nofollow" target="_blank">集群自动缩放器</a> (CA)可以扩展集群本身。您已经为您的应用程序准备好了黄金时间！🚀</p><p id="a2d8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您会发现一切都很顺利，但是在运行一段时间和多次部署之后，您会注意到下图:</p><figure class="ku kv kw kx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi kt"><img src="../Images/695cdf3f5fc15ce55a548f0124f45d85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IwhEfseN_9reR8I2r_sGYA.png"/></div></div></figure><h1 id="faf6" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">除了向外扩展k8s集群之外，集群自动缩放器是将它向内扩展的组件。</h1><p id="1ca1" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">但是为了做到这一点，您必须给它所需的灵活性，这在许多情况下并不是默认的。但是，我们所说的“灵活性”是什么意思呢？让我们先来看看缩放的一些基础知识。</p><blockquote class="mg mh mi"><p id="2462" class="ju jv mf jw b jx jy jz ka kb kc kd ke mj kg kh ki mk kk kl km ml ko kp kq kr ij bi translated">在简单的情况下，如果一个节点最终没有任何正在运行的pod(DaemonSets除外)，它将被终止。</p></blockquote><p id="af55" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">除了上面的简单情况，在很多情况下，您的集群可能会有很多节点没有得到充分利用。事实上，在某些情况下，您可能会观察到您的集群<em class="mf">未得到充分利用</em>。</p><p id="f4a4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">根据<a class="ae ks" href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#what-types-of-pods-can-prevent-ca-from-removing-a-node" rel="noopener ugc nofollow" target="_blank">文档</a>，在以下情况下，集群自动缩放器不会为了缩小节点而驱逐pod:</p><ol class=""><li id="3f11" class="mm mn iq jw b jx jy kb kc kf mo kj mp kn mq kr mr ms mt mu bi translated"><strong class="jw ir">现有Pod中断预算</strong>:这些Pod有一个<a class="ae ks" href="https://kubernetes.io/docs/tasks/run-application/configure-pdb/" rel="noopener ugc nofollow" target="_blank"> Pod中断预算</a> (PDB)，限制CA驱逐它们。例如，您可能正在运行2个pod，同时您可能已经指定希望任何时候至少有2个pod可用。考虑到CA在驱逐pod时尊重pdb，这使得它无法移动它们。</li><li id="1418" class="mm mn iq jw b jx mv kb mw kf mx kj my kn mz kr mr ms mt mu bi translated"><strong class="jw ir">kube-system pdb</strong>:您尚未为位于<code class="fe na nb nc nd b"><strong class="jw ir">kube-system</strong></code>名称空间中的Pod指定Pod中断预算(从CA <code class="fe na nb nc nd b">0.6</code>开始)。例如，这些pdb没有设置在GKE，因为对<code class="fe na nb nc nd b">kube-system</code> pod中断的容忍度与您在集群中运行的工作负载类型直接相关。</li><li id="54b3" class="mm mn iq jw b jx mv kb mw kf mx kj my kn mz kr mr ms mt mu bi translated"><strong class="jw ir">本地存储</strong>:吊舱带有<strong class="jw ir">本地存储</strong>。<em class="mf">警告</em> <strong class="jw ir"> : </strong>如果您正在使用Istio，<code class="fe na nb nc nd b">istio-proxy</code>边车会在默认设置中装载一个<code class="fe na nb nc nd b">emptyDir</code>卷。您需要为集群自动缩放器添加<code class="fe na nb nc nd b">"cluster-autoscaler.kubernetes.io/safe-to-evict": "true"</code>注释，以便能够驱逐它们。同样，您必须确保关键组件高度可用。</li><li id="dcd3" class="mm mn iq jw b jx mv kb mw kf mx kj my kn mz kr mr ms mt mu bi translated"><strong class="jw ir">其他节点与pod约束不匹配</strong>:可能存在这样的情况，即使某个节点未被充分利用，pod也不适合其他节点。</li></ol><blockquote class="mg mh mi"><p id="1073" class="ju jv mf jw b jx jy jz ka kb kc kd ke mj kg kh ki mk kk kl km ml ko kp kq kr ij bi translated"><strong class="jw ir"> Pod资源请求非常重要。您必须确保，与pod实际需要的CPU和内存相比，您不会将CPU和内存请求放得很高。在这种情况下，您将有一个未充分利用的节点，并且pod资源请求将高到足以阻止pod适合另一个节点，从而导致CA无法驱逐它。</strong></p></blockquote><h1 id="801c" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">CA疑难解答</h1><p id="9886" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">下面是一个有用的提示，可以查看集群自动缩放器是否考虑将任何节点作为终止的候选节点(在将pod逐出之后):</p><p id="a547" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe na nb nc nd b">kubectl get configmap cluster-autoscaler-status -n kube-system -o yaml</code></p><p id="5751" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这将显示每个可用性区域中有多少节点(如果您有多个az ),以及其中有多少被视为终止的候选节点。</p><p id="7543" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">另一个有用的提示是，假设CA使用由<code class="fe na nb nc nd b">metrics-server</code>提供的指标来确定节点利用率，<code class="fe na nb nc nd b">metrics-server</code>必须正确地从节点收集指标(<code class="fe na nb nc nd b">kubectl top nodes</code>应该返回所有节点的指标)。</p><h1 id="d59a" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">结论</h1><p id="e502" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">正确设置Pod中断预算和资源请求，并允许收回具有本地存储的Pod，这将为集群自动缩放器提供开始移动Pod的灵活性。这将导致未充分利用的节点的终止，从而对您的基础设施成本产生非常积极的影响。</p></div></div>    
</body>
</html>