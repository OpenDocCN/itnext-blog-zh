<html>
<head>
<title>Anthos on Bare Metal and Akri — Managing Leaf Devices on Edge Kubernetes Clusters from Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">裸机和Akri上的Anthos从云中管理边缘Kubernetes集群上的叶设备</h1>
<blockquote>原文：<a href="https://itnext.io/anthos-on-bare-metal-and-akri-managing-leaf-devices-on-edge-kubernetes-clusters-from-cloud-222ff17dd7b8?source=collection_archive---------0-----------------------#2021-03-25">https://itnext.io/anthos-on-bare-metal-and-akri-managing-leaf-devices-on-edge-kubernetes-clusters-from-cloud-222ff17dd7b8?source=collection_archive---------0-----------------------#2021-03-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/90be0cece12f8bdf7b4cb7e59d030b28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZBc_Brt_WPqD6fdIjx_GyQ.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Anthos集群在裸机上，Akri作为Kubernetes的资源接口用于Edge</figcaption></figure><div class=""/><p id="2baa" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">目前构成物联网(IoT)的数百万个设备不是驻留在云中，而是驻留在现场:从零售店到工厂车间。这些设备中有许多是微型边缘设备，如照相机(IP照相机、USB照相机等。)、传感器(设备上的智能热传感器等。).对于开发人员来说，编写定制的解决方案来检测和使用每个设备以及核心开发运维/部署团队来管理应用程序和托管这些位于远边缘站点(靠近最终用户)的应用程序的集群变得越来越困难和不切实际。</p><p id="547f" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然而，这些设备中的大多数都太小了，不能自己运行Kubernetes。Kubernetes工作负载如何利用它们，以及如何从云中管理私有集群？</p><p id="0870" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><a class="ae la" href="https://cloud.google.com/anthos/clusters/docs/on-prem/1.6/overview" rel="noopener ugc nofollow" target="_blank">VMware上的Anthos集群</a>也称为GKE本地，是一种支持用户在客户数据中心运行GKE的产品，但这种模式需要vCenter Server和VSphere，但<a class="ae la" href="https://cloud.google.com/anthos/clusters/docs/bare-metal/1.6/concepts/about-bare-metal" rel="noopener ugc nofollow" target="_blank">裸机上的Anthos</a>使用“自带操作系统”模式。它运行在物理或虚拟实例之上，支持Red Hat Enterprise Linux 8.1/8.2、CentOS 8.1/8.2或Ubuntu 18.04/20.04 LTS。</p><p id="7de2" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><a class="ae la" href="https://github.com/deislabs/akri" rel="noopener ugc nofollow" target="_blank">来自Deislabs(微软)的Akri </a>，这是一个开源项目，它定义了一种基于Kubernetes的方法，将边缘上的叶设备表示为本地Kubernetes资源。它提供了一个类似容器网络接口的抽象层，但是它没有抽象底层网络细节，而是删除了查找、利用和监控叶设备可用性的工作。</p><h1 id="dae7" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">示例用例场景</h1><p id="c982" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">一家全国性零售店需要实施基于摄像头的应用程序(一般商店监控、情感分析、性别分析、面具检测、自助结账等)。)并支持商店经理和本地业务开发团队等用户在本地访问应用，支持核心团队通过公共云平台从总部操作和管理应用。在这种情况下，商店可以被视为边缘站点。</p><p id="73c7" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在这种情况下，可行的选择是使用小尺寸设备，如英特尔NUC公司或任何其他具有足够容量来运行Kubernetes的单板机，并使用与其连接的USB摄像头。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div class="gh gi me"><img src="../Images/d52474d4e58f2b8a8678e09e7aa5ffe3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1270/0*jzvyEDxMwycBUNCG"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">连接到NUC的USB摄像头</figcaption></figure><p id="c59c" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Anthos clusters on Bare Metal在这里部署了Kubernetes，并将edge站点中的私有裸机集群连接到Google Cloud。在上面的使用案例示例中，总部可以使用Anthos裸机或使用某种自动化(systemd、rc.local等)对NUC进行映像和预部署/配置。)来引导集群。启动后，群集将使用预配置的SA密钥自动注册到GCP上的用户项目，然后总部团队可以接管在边缘站点上部署、管理和更新应用程序。在这种情况下，本地团队不需要技术能力，他们可以直接使用终端应用程序。</p><p id="420f" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在本文中，<a class="ae la" href="https://cloud.google.com/anthos/config-management" rel="noopener ugc nofollow" target="_blank"> Anthos配置管理</a>用于从GCP的Anthos门户将Akri组件部署到远程/私有集群。部署完成后，本地用户可以使用本地LB IP访问摄像机的镜头。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mj"><img src="../Images/a3a47242366563fb4725ec0349640650.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*l6Cpc_m9hPzfJBKB"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">使用Anthos将Akri部署到远程集群</figcaption></figure><p id="75f4" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这只是一个示例场景，用于访问裸机上的Anthos集群的功能和用法，以及管理edge上的Kubernetes和Leaf设备的Akri。</p><h1 id="2822" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">裸金属上的Anthos簇</h1><p id="c075" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated"><a class="ae la" href="https://cloud.google.com/anthos/clusters/docs/bare-metal/1.6" rel="noopener ugc nofollow" target="_blank">裸机上的Anthos</a>是在物理服务器上运行Anthos的部署选项，部署在用户提供的操作系统上，没有虚拟机管理程序层。裸机上的Anthos具有内置网络、生命周期管理、诊断、健康检查、日志记录和监控功能。用户可以使用受支持的CentOS、Red Hat Enterprise Linux (RHEL)和Ubuntu，所有这些都经过Google验证，可用于集群部署。</p><p id="0290" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">借助裸机上的Anthos，用户可以利用现有投资，使用公司的标准硬件和操作系统映像，这些映像会根据Anthos基础架构要求自动检查和验证。裸机上的Anthos遵循与所有<a class="ae la" href="https://cloud.google.com/anthos/docs/setup/overview#requirements" rel="noopener ugc nofollow" target="_blank">托管的Anthos集群</a>相同的计费模式，基于Anthos集群vCPUs的数量，按小时收费。</p><p id="cced" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">用户可以使用以下部署模式之一在裸机上部署Anthos:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mk"><img src="../Images/9ab775563e062d7d84de450a673e0129.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tiQNWNS0eqiYli7B"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">裸机上的Anthos集群—部署模型</figcaption></figure><p id="308f" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">独立模式允许用户独立管理每个集群。当在边缘位置运行时，或者如果用户希望他们的集群彼此独立管理时，这是一个很好的选择。一种多集群模型，允许用户从一个名为管理集群的集中式集群中管理集群(用户集群)。适合从一个集中位置管理多个集群。</p><p id="9e75" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为了满足不同的需求，裸机上的Anthos集群支持以下部署模型(所有三个模型都包括如上所述的管理集群和用户集群结构)。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ml"><img src="../Images/d42c9287d09ff31d9d8b2e9801e268bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Bvn0_uQkncVpkbN5"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">裸机上的Anthos集群—部署模型</figcaption></figure><p id="0c15" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">帖子中的拓扑结构包括三个英特尔NUC、两个16 GB RAM、4个vCPU和250 GB SSD，用作主节点和节点(Anthos提供了具体的硬件要求)。这里的部署模型是混合的，其中群集是一个管理群集，也允许运行用户工作负载，如果需要，该群集可以作为管理群集重复使用，以创建用户群集。第三个NUC (2个vCPU，8GB RAM)用作执行所有必需部署操作的工作站，它托管临时类型(Docker中的Kubernetes)引导集群。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/3b2ff3db8418f893f9f40ad2853ff603.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xpMshIdbrCROJIao"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">裸机上的Anthos集群—测试集群拓扑</figcaption></figure><p id="9765" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">集群中的所有机器都连接到一个家庭网络(专用),该家庭网络具有到互联网的出站连接。所有NUC从本地网络获取ip(节点ip和主节点IP)。裸机上的Anthos集群使用在L2模式下运行的<a class="ae la" href="https://metallb.universe.tf/" rel="noopener ugc nofollow" target="_blank"> MetalLB </a>来实现数据平面负载平衡。用户可以在专用网络上划出一块连续的IP地址，分配给“负载平衡器”类型的K8s服务。用户可以在上面的块中选择一个“开始”IP地址分配给IngressVIP和另一个不在controlPlaneVIP范围内的IP。</p><p id="7090" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">裸机上的Anthos集群部署L4负载平衡器，这些负载平衡器运行在专用的工作节点池或与控制平面相同的节点上。上述拓扑以“捆绑”模式部署LB，在集群创建期间，负载平衡器将安装在负载平衡器节点上。</p><p id="0145" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Anthos提供现成的覆盖网络和L4/L7负载平衡。客户还可以集成自己的负载平衡器，如F5和Citrix。对于存储，用户可以使用<a class="ae la" href="https://kubernetes-csi.github.io/docs/drivers.html" rel="noopener ugc nofollow" target="_blank"> CSI与现有基础设施的集成</a>来部署持久工作负载。</p><h1 id="bb3e" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用bmctl引导集群</h1><p id="22d2" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">在裸机上安装Anthos集群的命令是<a class="ae la" href="https://cloud.google.com/anthos/clusters/docs/bare-metal/1.6/installing/creating-clusters/create-clusters-overview" rel="noopener ugc nofollow" target="_blank"> bmctl </a>，该实用程序使用户能够以最小的努力创建一个集群。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mn"><img src="../Images/c241fb08f0068a1eea034d156292bd9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZsZGpuhtfbpmrlyi"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">裸机上的Anthos集群— bmctl实用程序</figcaption></figure><p id="26ee" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><em class="mo"> bmctl </em>实用程序从<a class="ae la" href="https://cloud.google.com/anthos/clusters/docs/bare-metal/1.6/quickstart#edit-config" rel="noopener ugc nofollow" target="_blank">配置文件</a>中读取所有配置，可以使用‘bmctl create config’创建模板。用户可以通过'<em class="mo">—enable-API—create-service-accounts</em>'来自动启用Google Cloud中项目认证自动需要的服务账户和API。这个配置文件包括密钥路径和ssh_keys，用于输入部署组件的主节点和节点。配置文件包括节点池、地址池和与存储相关的配置。</p><p id="9937" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在安装过程中，Anthos on Bare Metal创建一个临时引导集群(KIND，一个Kubernetes集群，其中部署了所需的组件来创建第一个管理员/用户集群)，在上述场景中，集群部署在工作站主机上。成功安装后，将删除引导群集，给用户留下一个管理群集和一个用户群集。一般来说，您应该没有理由与该集群进行交互，如果需要的话，可以不删除该集群(<em class="mo">—clean up-external-cluster = false</em>)。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/2af59caa54481bb7e719f144b6024a96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_k4CGrry1_gNE5WB"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">KIND引导集群</figcaption></figure><p id="c9d9" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">集群创建遵循cluster-api模式，该模式使用定制的GKE裸机提供程序，在工作站上运行的引导类集群使用生成的CRD来引导混合集群(或任何其他部署模型)。CRD也是在管理集群上创建的，这样用户就可以创建用户集群。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mq"><img src="../Images/707340dc269dc160bd1cc21ad0c7f84c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3Va3inB2eL-ciZoI"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">裸机上的Anthos集群—用于集群创建的定制CRD</figcaption></figure><p id="c78a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">集群部署步骤:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mr"><img src="../Images/8592fb48b96a4f3076a6270cab3735be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sXCoAtJY8j8wqWM7"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">裸机上的Anthos集群—集群部署阶段</figcaption></figure><p id="29e8" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">访问主集群所需的所有配置文件以及飞行前检查、集群创建日志和kubeconfig都在工作站的特定目录中创建。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/0974850841c7351f35dae5233a15990d.png" data-original-src="https://miro.medium.com/v2/resize:fit:950/0*ZtA4UJ7K6K7YeduZ"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">裸机上的Anthos集群—集群部署</figcaption></figure><p id="aa01" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">一旦群集准备就绪，引导群集将被删除，用户可以开始使用创建的混合群集，用户可以根据需要使用混合群集来创建多个用户群集。如果部署模型是独立的，那么创建一个用户集群时不需要任何机器(管理集群)来创建多个用户集群。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mt"><img src="../Images/5d7179ad11f7f6e00a53e76f10aba386.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HP5TIJzaTVgNwGD6"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">裸机上的Anthos集群—集群部署</figcaption></figure><p id="13b2" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">由于上面的集群是使用混合模式部署的，因此该集群由管理集群机器组成。</p><p id="bfac" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">集群API组件:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mq"><img src="../Images/949a0688c7a18fb5a08d336f47b2d2e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HESRoZr3BN5dsUfB"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">管理集群-CAPI组件</figcaption></figure><p id="d2ef" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">CRD裸机集群:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mq"><img src="../Images/9f0d815d5c03b8ec19968145ba325433.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UledtScjUkhnktvW"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">管理集群—裸机集群CRD</figcaption></figure><p id="42ac" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">BareMetalMachine CRD(由于这是一个混合群集，NUC作为对象添加):</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mq"><img src="../Images/30583d57b6eb2297d45da45f3b4410af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4e2TF_zbuRMCyib9"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">管理集群—裸机集群CRD</figcaption></figure><h1 id="65fa" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">将裸机上的Anthos集群连接到Google Cloud</h1><p id="1c89" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">裸机上的Anthos集群将集群连接到谷歌云。这种连接允许用户通过使用<a class="ae la" href="https://cloud.google.com/anthos/multicluster-management/connect/overview" rel="noopener ugc nofollow" target="_blank"> Connect </a>从云控制台管理和观察孤立的集群。作为集群部署的一部分，在集群中部署连接代理，并且'<em class="mo"> bmctl </em>'实用程序自动创建建立连接所需的服务帐户(如果需要更多控制，用户可以手动创建连接代理、连接注册和日志记录监控服务帐户)，并将集群注册到谷歌云GKE中心。</p><p id="7d10" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Connect是Anthos的一项功能，并不局限于Anthos bare metal，它允许用户将任何Kubernetes集群连接到Google Cloud，而不管它部署在哪里。这使得能够访问集群和工作负载管理功能，包括统一的用户界面<a class="ae la" href="https://cloud.google.com/cloud-console" rel="noopener ugc nofollow" target="_blank">云控制台</a>，以便与集群进行交互。Connect允许Anthos配置管理安装或更新Connect in-cluster代理并观察同步状态。Connect还允许计量代理观察已连接集群中的vCPUs数量。</p><p id="b781" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这对于从中央位置(HQ/区域IT运营中心等)管理隔离网络空间中远端站点上的应用程序的拓扑来说至关重要。)</p><p id="eb2c" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">连接代理可以配置为遍历NAT、出口代理和防火墙，以在隔离裸机集群的Kubernetes API服务器和Google Cloud项目之间建立长期的加密连接。</p><p id="609d" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">裸机集群上部署的连接代理:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mq"><img src="../Images/2d972311892babdcbd94bc557b25095a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Rsr5XsnWim0jpi8F"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">裸机上Anthos集群上的GKE连接代理</figcaption></figure><p id="863f" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">anthos-creds名称空间包含连接GCP服务所需的机密。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mq"><img src="../Images/37d68b2fde3a26f3506f7507b9c1fc2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wg7Xm0Ic7SmZczRg"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">GCP服务连接的秘密</figcaption></figure><p id="4a62" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Anthos门户显示已注册的集群(登录前)，在用户登录之前，右侧面板上的集群信息不会显示:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mq"><img src="../Images/17261aae96ac6540e0af0831c506d5ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NkPvH6_Bz_tfOcNS"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">显示注册集群的Anthos门户</figcaption></figure><p id="7a37" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Kubernetes引擎门户显示已注册的集群(登录前) :</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mq"><img src="../Images/ea4bd348958be740efe23ef8d6332b4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VSZlRDMhz1NfLHwr"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">显示注册集群的Kubernetes引擎</figcaption></figure><p id="f3dc" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">用户可以使用谷歌云控制台登录注册的集群。这可以通过三种方式实现:使用基本身份验证或不记名令牌，或者使用OIDC提供商。在下面的场景中，创建了一个与集群管理角色关联的管理用户，令牌用于登录(用户可以根据所需的操作级别创建一个集群只读角色)。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mq"><img src="../Images/6982f1b1b25bf143111a5f94748e7460.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bssgnibrgZxNITgq"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">使用服务帐户登录到已注册的集群</figcaption></figure><p id="0859" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">使用令牌登录到集群:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mq"><img src="../Images/35129809c3a2cc34fa80430629511bf0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*noPho0P58dEqWMvM"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">使用服务帐户令牌登录到已注册的群集</figcaption></figure><p id="ae47" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如下所示，登录成功后，将启用所有管理选项，并显示集群信息。该信息还显示了GKE中心成员ID，用户可以使用'<em class="mo">g cloud container Hub Membership list</em>'列出所有连接的集群。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mq"><img src="../Images/e988949410c54fc84e31f38b8ff083f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tEoatAD3h92OahO_"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">显示注册集群的Kubernetes引擎</figcaption></figure><p id="8540" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">显示集群信息和集群功能列表的Anthos门户:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mq"><img src="../Images/fd872b38f2ec9d2306d5c2ceabe9134d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jZmn70N373OrtIol"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">显示注册集群的Anthos门户</figcaption></figure><h1 id="3802" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">在裸机上管理Anthos集群上的工作负载</h1><p id="e994" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">一旦连接代理连接到集群，用户就可以使用Kubernetes引擎门户作为仪表板来访问所有Kubernetes组件，并管理裸机集群上的私有Anthos上的工作负载，就像在GKE上一样。</p><p id="bf6c" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Anthos dashboard使用户能够部署与Anthos相关的组件(特性),如ACM、服务网格等。(提供了功能和说明的目录)功能有限，仅用于验证集群的连接性和高级详细信息，如集群大小和门户中的节点。Kubernetes引擎门户是主要的集群管理实体，使用户能够操作Kubernetes的核心功能，如创建、编辑、更新和删除对象，访问配置对象(机密/配置映射)，从市场部署应用程序，浏览对象以及管理/列出PV/PVC等存储元素。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mq"><img src="../Images/8cdc6deb3524445f37bf38eead5f9f39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jdvb-Sv8QzxTGjwf"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">工作负载— Kubernetes引擎</figcaption></figure><p id="a680" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">用户可以编辑任何Kubernetes对象，这同样会反映在裸机集群上。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mq"><img src="../Images/2b75ec411ebf5333d12e2c315c526487.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6uun3sHAkO00nBKX"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">编辑/更新工作负载— Kubernetes引擎</figcaption></figure><p id="78da" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">访问集群服务和入口:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mq"><img src="../Images/44e564dd0933c486d4632683b3a23aee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZWnNcuQcgGBajm-6"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">服务和入口— Kubernetes引擎</figcaption></figure><p id="7c5b" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">裸机上的Anthos集群使用本地卷供应器(LVP)来管理本地持久卷。在裸机上的Anthos集群中为本地PV创建三种类型的存储类:LVP共享(在本地共享文件系统中创建集群期间创建的子目录支持下创建本地PV)、LVP节点挂载(在配置的目录中为每个挂载的磁盘创建本地PV)、Anthos系统(在集群创建期间创建预配置的本地PV，供Anthos系统pod使用)。</p><p id="6cf0" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">访问PVC和可用存储类别:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mq"><img src="../Images/27caa68b3d5789d205fa737c38d066b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vDV-FM4NrXe7KUX2"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">存储— Kubernetes引擎</figcaption></figure><p id="d17c" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Anthos portal方便用户在连接的集群上启用受支持的功能:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mq"><img src="../Images/760e4eaf320ba9cccfd417da4862d345.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*l2tl8jd-nqDiIOG_"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">在已注册的集群上启用功能— Anthos</figcaption></figure><h1 id="94ff" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">监控和记录</h1><p id="149d" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">当用户创建新的管理或用户集群时，会在每个集群中安装并激活日志记录和度量代理。Stackdriver operator管理部署在群集上的所有其他与Stackdriver相关的组件(日志聚合器、日志转发器、元数据代理和prometheus)的生命周期。用户可以使用监控门户在云项目中设置云监控工作区，以访问控制台上远程裸机集群中所有系统和Kubernetes组件的日志。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/d9d424aa4999e91432d9b12e098160d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uQEk42iovEkX-D4r"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">监控和日志记录— Stackdriver</figcaption></figure><p id="74b4" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">普罗米修斯的Stackdriver收集器为著名的普罗米修斯标签中的Kubernetes对象构建了一个云监控资源。一个单独的实体'<em class="mo">stack driver-Prometheus-app</em>'与栈一起部署，可以配置为监控集群中的应用。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/7257adff53d3c9ea8d66cd25e19852d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LUokEKKTI6xYDZu_"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">监控和记录—堆栈驱动普罗米修斯</figcaption></figure><p id="baa3" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">谷歌云的运营套件是谷歌云的内置可观测性解决方案。它提供了全面管理的日志记录解决方案、指标收集、监控、仪表板和警报。云监控使用工作区来组织和管理其信息。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/d4c76bb6aea4eb953ab05352b9b4e1a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8QMiSlIYMwmFfnEM"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">监控和日志记录—工作区</figcaption></figure><p id="0548" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">集成日志记录:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/7de2057daeba56a4b9b3d96bad7cc064.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aqJa13ghDrUKDqpg"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">监控和日志记录—工作区</figcaption></figure><h1 id="a16e" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">akri——面向边缘的Kubernetes资源接口</h1><p id="5adf" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">Akri支持发现和公开异构叶设备作为资源，并为Kubernetes集群中的每个设备创建服务。这使得运行在Kubernetes上的应用程序能够使用来自设备的输入。Akri处理设备的自动包含和移除，以及资源的分配和取消分配，以更好地优化集群。</p><p id="2cb0" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Akri是一个标准的Kubernetes扩展，使用两个定制资源定义(配置和实例)、一个代理和一个控制器来实现。安装后，用户可以为设备编写Akri定义，设备插件充当代理，使用支持的发现协议查找与定义匹配的硬件，然后使用Akri控制器通过Kubernetes pod中运行的代理管理它，该代理向您的应用程序代码公开设备及其API。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mv"><img src="../Images/7fc7f2dea28804389b29030fcf979fdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-yCsIvjT6UvjzTRO"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">阿克里建筑公司</figcaption></figure><p id="38c4" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Akri基于<a class="ae la" href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/resource-management/device-plugin.md" rel="noopener ugc nofollow" target="_blank"> Kubernetes设备插件框架</a>，该框架为供应商提供了一种称为设备插件的机制，可用于广告设备、监控设备(如健康检查)、将设备挂接到运行时以执行设备特定的指令(例如:清理GPU内存、捕捉视频等)。)并使该设备在容器中可用。这使得供应商无需编写额外的代码就可以公布他们的资源并对其进行监控。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mw"><img src="../Images/7e6d37db64c30b9190ef8360ce6bd8cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wW7Dtx4vAnkHDxQi"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">设备插件框架</figcaption></figure><p id="36c2" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Akri目前支持的协议有:udev(发现Linux设备文件系统中的任何东西)、ONVIF(发现IP摄像头)和OPC UA(发现OPC UA服务器)。像蓝牙、简单扫描IP/MAC地址、LoRaWAN、Zeroconf等协议。都在路线图中。</p><p id="4945" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在本文中，udev (userspace /dev)协议用于发现连接到裸机Kubernetes集群上的Anthos的两个节点的USB摄像头。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mx"><img src="../Images/678a8a39cadc87db185de1cf80703a74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xwFGHXocETYNv4GR"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">连接到NUC的USB摄像头</figcaption></figure><p id="4caa" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Udev管理<em class="mo"> /dev </em>目录下的设备节点，比如麦克风、安全芯片、usb摄像头等等。Udev可用于查找连接到或嵌入到节点中的设备。Akri的udev发现处理程序解析配置中列出的udev规则，使用udev搜索它们，并返回发现的设备节点列表(即:/dev/video0)。用户可以通过将<a class="ae la" href="https://wiki.archlinux.org/index.php/Udev" rel="noopener ugc nofollow" target="_blank"> udev规则</a>传入配置规范来配置Akri要查找的设备。</p><p id="0094" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">用户还可以允许多个节点使用一个叶设备，从而在一个节点离线时提供高可用性。此外，Akri将为每种类型的叶设备(或Akri配置)自动创建一个Kubernetes服务，无需应用程序来跟踪pod或节点的状态。</p><p id="be6f" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">例如，以下是在其中一个节点上使用“udevadm”连接的USB摄像头的信息:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/05b34d5d7e942d2d709697215701add6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RUq1VgXMOLZLqa2T"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Udevadm列出附加的摄像机信息</figcaption></figure><p id="d5aa" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">用户可以使用Akri的预定义语法<a class="ae la" href="https://github.com/deislabs/akri/blob/main/discovery-handlers/udev/src/udev_rule_grammar.pest" rel="noopener ugc nofollow" target="_blank">在这里</a>来定义Akri的配置规范的协议部分中的特定udev规则，以定义udev规则应该在特定节点上发现什么设备。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi my"><img src="../Images/d6e5714b282aee4ad5b87efbf4c2e0ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*T3bw2lZjc9elKHz_"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">udev-Akri规则</figcaption></figure><p id="aa20" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">作为daemonset部署的Akri代理处理资源可用性更改并启用资源共享，这些任务使Akri能够找到已配置的资源(叶设备)，将它们暴露给Kubernetes集群以进行工作负载调度，并允许多个节点共享资源。代理通过<a class="ae la" href="https://github.com/deislabs/akri/blob/main/docs/agent-in-depth.md#resource-discovery" rel="noopener ugc nofollow" target="_blank">发现处理程序(DHs) </a>发现资源。</p><p id="bbee" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Akri控制器部署在集群中的主节点上，支持集群访问叶设备和处理节点丢失。代理pods是根据选择的协议和定义的容量(<a class="ae la" href="https://github.com/deislabs/akri/blob/main/docs/resource-sharing-in-depth.md" rel="noopener ugc nofollow" target="_blank">资源共享</a>)自动创建的。</p><h1 id="2621" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用ACM (Anthos配置管理)将Akri部署到裸机集群上的Anthos</h1><p id="3066" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">下面的拓扑展示了如何配置GitOps以及如何从云到边缘执行应用部署的经典示例。Akri部署在隔离网络空间中的Anthos裸机集群上，使用来自云的Anthos配置管理。Akri然后负责所有其他所需的方面，以发现连接的USB摄像头，并使流媒体应用程序能够使用它们。最终用户可以使用LB_IP(本地网络)来观看访问运行在远端站点上的流媒体应用程序的视频(在这种情况下，远端站点是运行Anthos Bare Metal Kubernetes集群的NUC)</p><p id="b28f" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在下面的拓扑中，管理员用户向Anthos配置管理提供“配置管理”规范，该规范包含cluster_selector(在本例中选择了Anthos裸机集群)和git信息，后者包含Akri的所有部署清单。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/767192d11fec528f6492498ffdea3403.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8hSXJmw9n07ad5Zs"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">使用ACM (Anthos配置管理)部署Akri</figcaption></figure><p id="59e0" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">ACM负责将清单部署到指定git_repo中定义的私有裸机集群，并与git分支保持同步。Akri machinery检测连接到节点的USB摄像机(这里两个主机都充当节点—主污点已删除),本地用户可以使用本地网络上的LB_IP访问镜头。</p><p id="74b5" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">ACM可以从GCP控制台上的Anthos dashboard配置，通常项目的所有集群部分都会被考虑更新，用户可以配置特定的集群或将配置应用于所有集群。</p><ol class=""><li id="bd70" class="mz na jf ke b kf kg kj kk kn nb kr nc kv nd kz ne nf ng nh bi translated">Git存储库身份验证:</li></ol><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/f80e5d29205fb8fb5e7453cd71b1d673.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ixyKxBJ4nOu9v6Sm"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">ACM配置</figcaption></figure><p id="1fa9" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">2.Conifg Sync —保存诸如git_url和带有配置清单的目录之类的信息。这里用了一个<a class="ae la" href="https://github.com/gokulchandrap/akri-edge" rel="noopener ugc nofollow" target="_blank">回购</a>的例子。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ni"><img src="../Images/858ec3a8c3d332b249bebc957ba58456.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*l4KcpUPTTgKpXVA6"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">ACM配置</figcaption></figure><p id="ab25" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">上面配置的<a class="ae la" href="https://github.com/gokulchandrap/akri-edge" rel="noopener ugc nofollow" target="_blank"> repo </a>包含了在Kubernetes上部署Akri所需的所有清单。格式遵循<a class="ae la" href="https://cloud.google.com/kubernetes-engine/docs/add-on/config-sync/concepts/repo" rel="noopener ugc nofollow" target="_blank"> ACM指定的布局</a>，其中集群目录包括所有集群级对象(如CRD、集群角色、集群角色绑定等。)，名称空间目录包括一个具有名称空间名称的子目录，该子目录保存名称空间对象和所有其他命名空间对象(如部署、守护程序集、服务等)。)，系统目录包含操作员的配置。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nj"><img src="../Images/7985ec99bc3a38c11f7b518da3660785.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gc2xl1OVf7EuGRBA"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">ACM配置— Git源</figcaption></figure><p id="ea79" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">使用cluster_selector提交ACM规范后(在本例中选择了Anthos裸机集群),裸机集群上的控制器会在配置管理命名空间中创建所需的git-importer和monitor pods，这些pods会在集群上执行所有与GitOps相关的任务。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/d5f66ca55de25d8eeea01a66a083c09c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*h3gzRyHv7vMLGOaE"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">ACM组件—导入器和监视器</figcaption></figure><p id="076a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">安装完成后，用户可以从Anthos仪表板的Anthos配置管理部分或使用“nomos状态”来检查同步状态。如下所示，一旦同步完成，所有与Akri相关的组件都部署在裸机集群上的私有Anthos上，并且可以从Kubernetes引擎的工作负载部分进行验证。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/ea585d28df4e01216245a7c21355a1f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FT-Y4Xu5qsIkuagl"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Akri组件</figcaption></figure><p id="c7f4" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Akri实施在集群中安装两个CRD:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/55520ef66080ec1558dfe72511afb51f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*i9Z4YCGO2eJt_Usc"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">阿克里Akri的</figcaption></figure><p id="aaae" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Akri配置指定Akri控制器要发现的叶设备的类型。在下面的示例(akri-udev-video)中，udev协议用于发现USB摄像头。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nk"><img src="../Images/2553f720b63ca4d594807eb43eebd4b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hlrD2Zx4G03QbKii"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">阿克里Akri的</figcaption></figure><p id="9222" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Akri Agent是一个Kubernetes设备插件框架实现，它搜索叶设备，根据指定的规则检查可用性。一旦设备被发现，Akri控制器将每个Akri实例视为叶设备的代表，部署“代理”pod以促进与叶设备的连接并利用它。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nl"><img src="../Images/71f6cf090969c531a68b65f6b9611f73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qqXSD2Zr7nJ-CysS"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">阿克里Akri的</figcaption></figure><p id="d041" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">除了核心Akri组件之外，还部署了一个'<em class="mo"> akri-vedio-straming-app </em>'来传输从broker pods收集的视频帧。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/bdb844468e1d59bcf63f916dd819617b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*myWUKymG4_-sJMaX"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Akri —视频流应用</figcaption></figure><p id="40d6" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">流媒体应用程序可以使用“<em class="mo"> akri-configuration </em>”对象进行配置:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/3f6948f8ebe535851cec0c9513ea9c4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YTF0xX8n0quq87sh"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Akri —视频流应用—配置</figcaption></figure><p id="63ed" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">可以使用broker pod规范配置格式、分辨率和帧等配置:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/1cadec54faf62804f684f87bbe977278.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9Oy8j3WViLwZZ-9d"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Akri —配置</figcaption></figure><p id="9578" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">管理员可以从Kubernetes引擎的工作负载部分管理所有Akri组件。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/c2a79126b315f1f3b59aa899999efb59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bEK2EYU-PYe-yOON"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">从云中管理Akri组件</figcaption></figure><p id="edcd" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Pod日志可以从Kubernetes引擎门户访问。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/fcdf4732badd4682d6b268d6a3f13ee4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6GFKuPYuNJf3ZYWi"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">从云中监控Akri组件</figcaption></figure><p id="8fc1" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">安装在集群上的stackdriver将所有日志传输到操作和日志记录单元，使用户能够过滤特定的日志。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/077691f91f47902df2abe4f984858610.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nX2K3fLLw1hYWOPQ"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">从云中监控Akri组件</figcaption></figure><p id="d756" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">裸机上的Anthos集群使用在L2模式下运行的<a class="ae la" href="https://metallb.universe.tf/" rel="noopener ugc nofollow" target="_blank"> MetalLB </a>来实现数据平面负载平衡。MetalLB使用在引导群集时配置的IP池，将它们连接到负载平衡器类型的服务。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/66e4b58c2f9a288a60bea7bf8e355c3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EndMOAVsRa7ykTTb"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">裸机上的Anthos集群— Metallb组件</figcaption></figure><p id="793c" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果需要，用户可以从Kubernetes引擎-服务和入口门户编辑服务:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/2172377c3a03289055008743eefc4688.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9TGcd9bA8zGHoHKN"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">将视频流应用程序服务公开为负载平衡器</figcaption></figure><p id="a3e9" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如下图所示，akri-video-streaming-app被公开为一种负载平衡器类型，可用于使用负载平衡器IP访问素材。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/5a18e1c3c228c4c0189e8c77ebeb3b3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BoQkpq5lmb7CFA0S"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">将视频流应用程序服务公开为负载平衡器</figcaption></figure><p id="3a1a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在上面的拓扑中，两个摄像机连接到两个节点，Akri控制器为每个实例(摄像机)部署两个代理单元。如下图所示，摄像机指向两个不同的对象:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mx"><img src="../Images/4bea1961f4bbf1a7dc7af3e9745e6ce5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LSIeBxaLzBekmsCo"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">连接到同一个集群的两个摄像机指向两个不同的对象</figcaption></figure><p id="3329" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">akri-video-streaming-app从两个broker pods收集帧，并在一个统一的视图中显示它们。分辨率和帧数根据akri配置规范进行配置。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nm"><img src="../Images/9a8705f5c90e45ef14eb2b392be1a937.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0Xoghj74UsQ0HtWJt4C89A.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">视频流应用——从连接的摄像机转发帧</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nn"><img src="../Images/4ff7741590ce4874730d006418c21a35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DDaSUkxpaTusTWvSSuCn1w.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">视频流应用——从连接的摄像机转发帧</figcaption></figure></div><div class="ab cl no np hu nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="ij ik il im in"><p id="bf80" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这种结合为用户提供了创建集群所需的自动化，将它们连接到云，并使叶设备能够被表示为Kubernetes对象，从而使Kubernetes成为一种多功能的边缘计算解决方案。</p></div></div>    
</body>
</html>