<html>
<head>
<title>Let’s implement a real-time package tracking app with RabbitMQ and Web socket using Go 🚀</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们用RabbitMQ和使用Go的Web socket实现一个实时包裹跟踪app🚀</h1>
<blockquote>原文：<a href="https://itnext.io/lets-implement-a-real-time-package-tracking-app-with-rabbitmq-and-web-socket-using-go-80f5a5ca5c55?source=collection_archive---------3-----------------------#2022-07-12">https://itnext.io/lets-implement-a-real-time-package-tracking-app-with-rabbitmq-and-web-socket-using-go-80f5a5ca5c55?source=collection_archive---------3-----------------------#2022-07-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><h2 id="aed4" class="ju jv iq bd jw jx jy dn jz ka kb dp kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">这是什么app？</h2><p id="9d8a" class="pw-post-body-paragraph kq kr iq ks b kt ku kv kw kx ky kz la kd lb lc ld kh le lf lg kl lh li lj lk ij bi translated">此应用程序使用车辆信息提供实时包裹位置信息，因为车辆会运送包裹。这样它就能回答我的包裹现在在哪里，它要去哪里？(<em class="ll">目前我还没有在WebSocket上实现广播。你可以想到沟通1-1) </em></p><h2 id="af2d" class="ju jv iq bd jw jx jy dn jz ka kb dp kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">应用架构</h2><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi lm"><img src="../Images/684a0c5a46ce367c498c63bc155ddf7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RDnL4J5louGDoZBw5S_Z2g.png"/></div></div><figcaption class="ly lz gj gh gi ma mb bd b be z dk translated">整体架构</figcaption></figure><ul class=""><li id="1e54" class="mc md iq ks b kt me kx mf kd mg kh mh kl mi lk mj mk ml mm bi translated"><a class="ae mn" href="https://www.rabbitmq.com/documentation.htmlü" rel="noopener ugc nofollow" target="_blank"> RabbitMQ </a>与<a class="ae mn" href="https://docs.docker.com/compose/" rel="noopener ugc nofollow" target="_blank"> docker-compose </a></li><li id="2e61" class="mc md iq ks b kt mo kx mp kd mq kh mr kl ms lk mj mk ml mm bi translated"><a class="ae mn" href="http://github.com/gorilla/websocket" rel="noopener ugc nofollow" target="_blank"> Websocket </a>带<a class="ae mn" href="https://echo.labstack.com/" rel="noopener ugc nofollow" target="_blank">回显框架</a></li><li id="3acd" class="mc md iq ks b kt mo kx mp kd mq kh mr kl ms lk mj mk ml mm bi translated">基于<a class="ae mn" href="https://github.com/bxcodec/go-clean-arch" rel="noopener ugc nofollow" target="_blank">这个干净的架构模板</a></li></ul><h2 id="5ca0" class="ju jv iq bd jw jx jy dn jz ka kb dp kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">源代码</h2><p id="d313" class="pw-post-body-paragraph kq kr iq ks b kt ku kv kw kx ky kz la kd lb lc ld kh le lf lg kl lh li lj lk ij bi translated"><a class="ae mn" href="https://github.com/Abdulsametileri/package-tracking-app" rel="noopener ugc nofollow" target="_blank">https://github.com/Abdulsametileri/package-tracking-app</a></p><h2 id="65c8" class="ju jv iq bd jw jx jy dn jz ka kb dp kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">Websocket</h2><p id="3de7" class="pw-post-body-paragraph kq kr iq ks b kt ku kv kw kx ky kz la kd lb lc ld kh le lf lg kl lh li lj lk ij bi translated">关于WebSocket的资料有很多，但是我强烈推荐你阅读<a class="ae mn" href="https://datatracker.ietf.org/doc/html/rfc6455" rel="noopener ugc nofollow" target="_blank"> WebSocket的RFC文档</a>。</p><p id="9b29" class="pw-post-body-paragraph kq kr iq ks b kt me kv kw kx mf kz la kd mt lc ld kh mu lf lg kl mv li lj lk ij bi translated">该协议有两个部分:握手和数据传输。</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi mw"><img src="../Images/9df9fb4ade9010365f2d97e506b79345.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mJLqOUomS8Ph1A5gBy5QHQ.png"/></div></div><figcaption class="ly lz gj gh gi ma mb bd b be z dk translated">握手流程</figcaption></figure><p id="9e2c" class="pw-post-body-paragraph kq kr iq ks b kt me kv kw kx mf kz la kd mt lc ld kh mu lf lg kl mv li lj lk ij bi translated">一旦客户端和服务器都发送了它们的握手，并且如果握手成功，那么数据传输部分开始。这是一个双向通信通道，每一方都可以独立于另一方随意发送数据。</p><h1 id="1419" class="mx jv iq bd jw my mz na jz nb nc nd kc ne nf ng kg nh ni nj kk nk nl nm ko nn bi translated">兔子q</h1><p id="7b8a" class="pw-post-body-paragraph kq kr iq ks b kt ku kv kw kx ky kz la kd lb lc ld kh le lf lg kl lh li lj lk ij bi translated">我认为RabbitMQ文档非常优秀。我建议你学习一些基本的概念，比如排队、交换等。)通过跟随他们的教程和阅读<a class="ae mn" href="https://www.rabbitmq.com/protocol.html" rel="noopener ugc nofollow" target="_blank"> AMQP协议规范</a>。</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div class="gh gi no"><img src="../Images/af26e595298b1ac2fafc6cb794a38d2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:974/format:webp/1*e4xpHqcaeJz_OgMTNh2GPQ.png"/></div><figcaption class="ly lz gj gh gi ma mb bd b be z dk translated">AMQ主要实体</figcaption></figure><h1 id="e363" class="mx jv iq bd jw my mz na jz nb nc nd kc ne nf ng kg nh ni nj kk nk nl nm ko nn bi translated">Websocket处理程序</h1><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="39a2" class="pw-post-body-paragraph kq kr iq ks b kt me kv kw kx mf kz la kd mt lc ld kh mu lf lg kl mv li lj lk ij bi translated"><code class="fe nr ns nt nu b">upgrader.Upgrade</code>将HTTP服务器连接升级到WebSocket协议。它检查握手过程；例如，它检查请求头是否正确，如<code class="fe nr ns nt nu b">upgrade=Websocket</code>和<code class="fe nr ns nt nu b">connection=Upgrade</code>是否相等。</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi nv"><img src="../Images/78695ff5ccc1aaa4654736e03b88e470.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jCwCNVBALW8vaSW-EW7Etw.png"/></div></div><figcaption class="ly lz gj gh gi ma mb bd b be z dk translated">处理WebSocket关闭状态</figcaption></figure><p id="ee4c" class="pw-post-body-paragraph kq kr iq ks b kt me kv kw kx mf kz la kd mt lc ld kh mu lf lg kl mv li lj lk ij bi translated">为了处理WebSocket关闭握手，当客户端导航到另一个页面时，我使用了<code class="fe nr ns nt nu b">wsConn.ReadMessage()</code>，或者类似于<code class="fe nr ns nt nu b">ReadMessage() </code>返回一个非零错误。当错误不为零时，我调用<a class="ae mn" href="https://www.sohamkamani.com/golang/context-cancellation-and-values/" rel="noopener ugc nofollow" target="_blank">上下文的取消</a>函数。这样做时，上下文的done通道被关闭，因此我们可以关闭底层的TCP连接并从我们的处理程序返回它，如下面第一个select案例所示。</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi nv"><img src="../Images/12d35d48ff75488ec4a57a53083e54d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vW9mlgccgUDTRh3XUamQZg.png"/></div></div><figcaption class="ly lz gj gh gi ma mb bd b be z dk translated">处理WebSocket状态</figcaption></figure><p id="a6f2" class="pw-post-body-paragraph kq kr iq ks b kt me kv kw kx mf kz la kd mt lc ld kh mu lf lg kl mv li lj lk ij bi translated">在select语句默认状态下，我们可以监听我们的<code class="fe nr ns nt nu b">package_status</code>队列；当新的包状态到达时，我们可以将它的信息传递给WebSocket。注:<code class="fe nr ns nt nu b">p.PUseCase.TrackByVehicleID(ctx, vehicleID)</code>该方法基于<code class="fe nr ns nt nu b">&lt;-chan amqp.Delivery</code>。当新消息进入我们的队列时，我们从这个通道获得包信息。</p><h1 id="4bd8" class="mx jv iq bd jw my mz na jz nb nc nd kc ne nf ng kg nh ni nj kk nk nl nm ko nn bi translated">包用例</h1><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="9f19" class="pw-post-body-paragraph kq kr iq ks b kt me kv kw kx mf kz la kd mt lc ld kh mu lf lg kl mv li lj lk ij bi translated">在我们的用例中，没有特定的规则。因此，我们可以从RabbitMQ客户端获取字节消息，并编组我们的包结构格式。</p><h1 id="1018" class="mx jv iq bd jw my mz na jz nb nc nd kc ne nf ng kg nh ni nj kk nk nl nm ko nn bi translated">RabbitMQ客户端</h1><p id="6a71" class="pw-post-body-paragraph kq kr iq ks b kt ku kv kw kx ky kz la kd lb lc ld kh le lf lg kl lh li lj lk ij bi translated">我打开了一个TCP连接和其中的一个通道(虚拟AMQP连接)。<em class="ll">通道是全双工的，这意味着一个通道可以用于发布和消费消息。</em></p><p id="e981" class="pw-post-body-paragraph kq kr iq ks b kt me kv kw kx mf kz la kd mt lc ld kh mu lf lg kl mv li lj lk ij bi translated">我用声明关键字<em class="ll">配置队列——如果不存在就创建，否则继续——</em>并在其上注册消费者变更。</p><p id="c5e6" class="pw-post-body-paragraph kq kr iq ks b kt me kv kw kx mf kz la kd mt lc ld kh mu lf lg kl mv li lj lk ij bi translated">我在<code class="fe nr ns nt nu b">(c *rabbitmqClient) ConsumeByVehicleID</code>方法中持续倾听。我使用<code class="fe nr ns nt nu b">message_id</code>属性来区分消息。</p><p id="44d2" class="pw-post-body-paragraph kq kr iq ks b kt me kv kw kx mf kz la kd mt lc ld kh mu lf lg kl mv li lj lk ij bi translated">注意:我在main方法上使用<code class="fe nr ns nt nu b">(c *rabbitmqClient) Publish</code>方法只是为了测试目的。</p><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="np nq l"/></div></figure><h1 id="588b" class="mx jv iq bd jw my mz na jz nb nc nd kc ne nf ng kg nh ni nj kk nk nl nm ko nn bi translated">把它们放在一起</h1><p id="4e8d" class="pw-post-body-paragraph kq kr iq ks b kt ku kv kw kx ky kz la kd lb lc ld kh le lf lg kl lh li lj lk ij bi translated">当我们运行应用程序时，我们每3秒钟就会看到包的位置。</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/89843b04c99c83043416cbe4148bc6ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:512/format:webp/1*ahhgrWfpPrM7CIVRnE1m6Q.png"/></div><figcaption class="ly lz gj gh gi ma mb bd b be z dk translated">运行应用程序</figcaption></figure><h1 id="bfaa" class="mx jv iq bd jw my mz na jz nb nc nd kc ne nf ng kg nh ni nj kk nk nl nm ko nn bi translated">源代码</h1><p id="7bbc" class="pw-post-body-paragraph kq kr iq ks b kt ku kv kw kx ky kz la kd lb lc ld kh le lf lg kl lh li lj lk ij bi translated"><a class="ae mn" href="https://github.com/Abdulsametileri/package-tracking-app" rel="noopener ugc nofollow" target="_blank">https://github.com/Abdulsametileri/package-tracking-app</a></p><h1 id="a1c1" class="mx jv iq bd jw my mz na jz nb nc nd kc ne nf ng kg nh ni nj kk nk nl nm ko nn bi translated">参考</h1><p id="d1a8" class="pw-post-body-paragraph kq kr iq ks b kt ku kv kw kx ky kz la kd lb lc ld kh le lf lg kl lh li lj lk ij bi translated"><a class="ae mn" href="https://github.com/Abdulsametileri/package-tracking-app/blob/master/assets/1x.png" rel="noopener ugc nofollow" target="_blank">我的RabbitMQ笔记</a></p><p id="37bb" class="pw-post-body-paragraph kq kr iq ks b kt me kv kw kx mf kz la kd mt lc ld kh mu lf lg kl mv li lj lk ij bi translated"><a class="ae mn" href="https://datatracker.ietf.org/doc/html/rfc6455" rel="noopener ugc nofollow" target="_blank">https://datatracker.ietf.org/doc/html/rfc6455</a></p><p id="6e47" class="pw-post-body-paragraph kq kr iq ks b kt me kv kw kx mf kz la kd mt lc ld kh mu lf lg kl mv li lj lk ij bi translated"><a class="ae mn" href="https://www.rabbitmq.com/protocol.html" rel="noopener ugc nofollow" target="_blank">https://www.rabbitmq.com/protocol.html</a></p><p id="ea82" class="pw-post-body-paragraph kq kr iq ks b kt me kv kw kx mf kz la kd mt lc ld kh mu lf lg kl mv li lj lk ij bi translated"><a class="ae mn" href="https://www.sohamkamani.com/golang/context-cancellation-and-values/" rel="noopener ugc nofollow" target="_blank">https://www . sohamkamani . com/golang/context-cancellation-and-values/</a></p><p id="ee33" class="pw-post-body-paragraph kq kr iq ks b kt me kv kw kx mf kz la kd mt lc ld kh mu lf lg kl mv li lj lk ij bi translated"><a class="ae mn" href="https://www.amazon.com/RabbitMQ-Essentials-distributed-scalable-applications/dp/1789131669" rel="noopener ugc nofollow" target="_blank">https://www . Amazon . com/rabbit MQ-Essentials-distributed-scalable-applications/DP/1789131669</a></p></div></div>    
</body>
</html>