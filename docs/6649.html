<html>
<head>
<title>Scaling your micro-frontends off the main thread</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将您的微前端从主线程上剥离</h1>
<blockquote>原文：<a href="https://itnext.io/scaling-your-micro-frontends-off-the-main-thread-36dedf54c5bf?source=collection_archive---------1-----------------------#2022-01-17">https://itnext.io/scaling-your-micro-frontends-off-the-main-thread-36dedf54c5bf?source=collection_archive---------1-----------------------#2022-01-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="5e70" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然我已经看到和读到了相当多的方法来创建微前端，并通过延迟加载策略来增强应用程序，以便在您需要时获取新视图，但大多数方法都觉得难以实现，并且直到最后才真正考虑清楚。本文将向您展示一种实际上很容易实现并且非常强大的方法。</p><p id="cca0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于微前端决策框架，我们将使用:</p><ul class=""><li id="e924" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">水平分裂</li><li id="53ac" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">客户端合成</li><li id="4a86" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">客户端路由</li></ul><p id="c577" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了使这种方法与众不同，我们将在顶部添加以下设计目标:</p><ol class=""><li id="3095" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kz kr ks kt bi translated">我们的mfe和应用程序将存在于一个web worker中，这将带来极快的渲染性能</li><li id="7f44" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kz kr ks kt bi translated">我们代码的开发模式版本必须在浏览器中运行(零构建或转换)</li><li id="7001" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kz kr ks kt bi translated">我们希望在应用程序的不同部分使用不同版本的mfe</li><li id="622f" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kz kr ks kt bi translated">我们希望在需要时延迟加载我们的mfe</li></ol><h1 id="c5fd" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">内容</h1><ol class=""><li id="8991" class="kl km iq jp b jq ly ju lz jy ma kc mb kg mc kk kz kr ks kt bi translated">建立一个类似单回购的结构</li><li id="7958" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kz kr ks kt bi translated">创建我们的主应用</li><li id="1838" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kz kr ks kt bi translated">创建我们的第一个微前端</li><li id="0e97" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kz kr ks kt bi translated">将MFE_1包含到我们的主应用程序中</li><li id="013b" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kz kr ks kt bi translated">创建我们的第二个微前端</li><li id="e0a9" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kz kr ks kt bi translated">将MFE_2包含到我们的主应用中</li><li id="cda5" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kz kr ks kt bi translated">客户端路由</li><li id="4d3c" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kz kr ks kt bi translated">我们MFE组合的生产构建</li><li id="d60b" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kz kr ks kt bi translated">我们的代码真的存在于app worker中吗？</li><li id="5b0b" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kz kr ks kt bi translated">增强创意</li><li id="72a5" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kz kr ks kt bi translated">最后的想法</li></ol><h1 id="c240" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">1.建立一个类似单回购的结构</h1><p id="ff84" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">我为本文创建了一个新的存储库:</p><div class="mg mh gp gr mi mj"><a href="https://github.com/neomjs/micro-frontends-demo" rel="noopener  ugc nofollow" target="_blank"><div class="mk ab fo"><div class="ml ab mm cl cj mn"><h2 class="bd ir gy z fp mo fr fs mp fu fw ip bi translated">GitHub-neom js/micro-frontends-demo:从主线程中扩展您的微前端</h2><div class="mq l"><h3 class="bd b gy z fp mo fr fs mp fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="mr l"><p class="bd b dl z fp mo fr fs mp fu fw dk translated">github.com</p></div></div><div class="ms l"><div class="mt l mu mv mw ms mx my mj"/></div></div></a></div><p id="458b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我使用“monorepo-like”这个词，因为对于一个真正的monorepo，您可能会使用一个构建工具(例如Bazel、Lerna、yarn workspaces)。</p><p id="dab9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您还可以设置多个分支，至少是“main”和“dev”，并根据需要添加特性分支。</p><p id="765d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了使这个演示尽可能简单，我们只使用主分支。</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi mz"><img src="../Images/43525b2a9d98ad47af016f10c2cafcb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RRn4xjGBYvp_KKxNTvS7CQ.png"/></div></div></figure><p id="c97d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根文件夹不包含package.json文件，因此每个顶级文件夹将包含一个独立的npm包。</p><p id="9b70" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你的公司有多个开发团队，他们在一个复杂应用的不同领域工作，或者如果你要迁移到monorepo，这种策略是有意义的。</p><p id="db5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当然，如果每个团队(包)从长远来看使用相同的依赖项，这是很好的，但是这会使迁移变慢，甚至对于相同依赖项的不同版本，也可能有合理的理由。</p><p id="2cad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了创建这个基本设置，我在repo的根文件夹中使用了4次<code class="fe nk nl nm nn b">npx neo-app</code>。</p><p id="657d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此时，所有4个顶级文件夹都包含相同的虚拟应用程序，并且可以自行构建和部署。让我们快速看一下其中的一个:</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi no"><img src="../Images/21c8ae1f7cf43d5eb06463a6a74857a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PdcgxQ75TPFQtSMskrI5eA.png"/></div></div></figure><p id="6345" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于我们来说，<code class="fe nk nl nm nn b">.gitignore</code>已经排除了<code class="fe nk nl nm nn b">dist</code>和<code class="fe nk nl nm nn b">node_modules</code>文件夹。</p><h1 id="0b25" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">2.创建我们的主应用</h1><p id="6949" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">由于我们已经有了一个虚拟应用程序，让我们快速了解一下:</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi np"><img src="../Images/4895ae6c023ef34f9acf6540f13da400.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YUGXO6ksrs7YoPneal4BYA.png"/></div></div></figure><p id="c5d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe nk nl nm nn b">index.html</code>将只包括<code class="fe nk nl nm nn b">MicroLoader</code>。这将为我们创建工人设置:</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nq"><img src="../Images/50d1e02d9d8dbf987cc30b4153487a8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5-veT3mNdcZ0jJ4owiQwcQ.png"/></div></div></figure><p id="c154" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用程序工作人员是我们的主要参与者、指挥者和与应用程序相关的构建入口点，他将为我们获取应用程序外壳:</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nr"><img src="../Images/81dcc199e62c1bbd7cbe63a6ba1ab200.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q2VKzf_Co0jEc8wzgA-IOw.png"/></div></div></figure><p id="d1a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的应用程序外壳是尽可能轻量级的，并且与组件无关。然而，我们可以在这里定义一个<code class="fe nk nl nm nn b">mainView</code>和一个<code class="fe nk nl nm nn b">parentId</code>，以防我们想要将这个应用程序呈现到一个特定的DOM节点中。</p><p id="5cf9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以将<code class="fe nk nl nm nn b">app.mjs</code>文件想象成应用程序工作人员的索引文件(起点)。</p><p id="4eef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以，我们可以马上开始调整我们的主应用程序的内容。</p><p id="515b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将从一个非常简单的结构开始:</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi ns"><img src="../Images/5a61b9035a801da906af1d8b9c1cfc1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KqhdZ2vvuY7_61-1PO0s4A.png"/></div></div></figure><p id="b9cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设“Home”将包含一个复杂的视图，我们将为它创建一个自己的类:</p><figure class="na nb nc nd gt ne"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="ec68" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来让我们看看我们的视窗(主视图):</p><figure class="na nb nc nd gt ne"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="e0e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里的特殊之处在于，一旦第一个选项卡被激活，我们就动态导入我们的<code class="fe nk nl nm nn b">HomeComponent</code>。这还不重要，但是一旦我们设置了客户端路由，它就会变得重要。</p><p id="eb3a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在一个真正的应用程序中，我们会使用主题引擎来设计我们的内容，但是我们的目标是保持它的简单，并专注于核心主题:微前端。</p><h1 id="3fa4" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">3.创建我们的第一个微前端</h1><p id="8ed4" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">虽然我们可以直接在顶层repo文件夹中的apps文件夹内创建这个组件，但是让我们使用那里的<code class="fe nk nl nm nn b">src</code>文件夹来保持它的整洁:</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nv"><img src="../Images/f48bd1ee3ac6a41af27f2ce72cd0e6e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EIauKoay4Hxw6byr04ur-w.png"/></div></div></figure><p id="909f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于我们在此范围内工作的团队希望独立于我们的主应用程序来查看和测试它，所以让我们先将它包含到此范围的应用程序文件夹中(这不会影响我们的主应用程序或它的构建)。</p><figure class="na nb nc nd gt ne"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="079e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你仔细观察:我们使用neo.mjs从我们的主目录相关的导入，以避免多次获取框架相关的文件。</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nw"><img src="../Images/3f34c424e17eaefc224cc461d51aec19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VMRJGulydhIqkdntxvxxZQ.png"/></div></div></figure><p id="dcfb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以立即在浏览器中打开它，无需任何构建或转换，相关团队可以从这里开始工作并测试微前端。</p><h1 id="61f8" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">4.将MFE_1包含到我们的主应用程序中</h1><p id="c4a6" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">我有点害怕向您展示这种方法，但是如果您愿意，您可以非常容易地直接包含总是最新的版本:</p><figure class="na nb nc nd gt ne"><div class="bz fp l di"><div class="nt nu l"/></div></figure><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nx"><img src="../Images/523500c008545c813b50195cedbbf538.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AkGKc2O7Yw5R1lAJySPcdw.png"/></div></div></figure><p id="f73e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还将MFE_1添加为动态导入。如果你打开开发者工具中的网络标签，并切换到我们的主应用程序中的新标签，你会注意到我们的新组件将在这一点上得到懒惰加载。</p><p id="d36c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您还会注意到，我们正在显示一个不同的文本。遵循<strong class="jp ir">单向数据流</strong>范例，父组件可以直接改变类配置(类似于React中的props)。</p><p id="d62d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">警告</strong>:除非你的团队在使用不同的功能分支时非常小心，并且只有在发布新的包版本时才会将代码推送到主分支，否则你就冒着微前端代码库内的代码变化破坏主应用程序的风险。甚至“仅仅”打破开发分支会显著地减慢其他团队的速度。</p><p id="f20e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">干净的方法是调整我们的<code class="fe nk nl nm nn b">package.json</code>文件，并在此时将MFE_1发布到npm:</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi ny"><img src="../Images/f60f49a565624878d34b6454e4cba640.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dUGljXPjyLxc3nzGooKH1A.png"/></div></div></figure><p id="563e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们的顶层回购文件夹可以根据需要将这个包添加到它们的<code class="fe nk nl nm nn b">package.json</code>文件中，并安装依赖项。这样你也可以控制使用不同的版本。</p><h1 id="787e" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">5.创建我们的第二个微前端</h1><p id="f018" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">这一次，我们将创建一个小组件树，并触发一个事件。</p><figure class="na nb nc nd gt ne"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="955f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还将调整我们的独立测试应用程序:</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nz"><img src="../Images/121e75a340a818845d42cf0073d8c66d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*efrbW4-6NpRuiFkvsN3SuQ.png"/></div></div></figure><p id="abfa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们得到以下结果:</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi oa"><img src="../Images/fe9a97af08353e2bbe61e2a23b5dddb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aAeqm5GVkNh9dpdrSa3t9g.png"/></div></div></figure><h1 id="74f8" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">6.将MFE_2包含到我们的主应用中</h1><p id="cad3" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">与MFE_1一样，我们将在需要时延迟加载新面板。我们还将为自定义事件添加一个侦听器，我们将把它映射到新的视图控制器中。</p><figure class="na nb nc nd gt ne"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="8d2b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是新视图控制器的代码:</p><figure class="na nb nc nd gt ne"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="f453" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结果:</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi oa"><img src="../Images/837301788f6968038ba331c32334e1de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fGDXd7W9brD2C0CgxKv3Zw.png"/></div></div></figure><p id="7b2d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">再次遵循单向数据流范例:修改父组件的状态或配置不是一个好主意。相反，我们将触发父组件可以订阅的事件。</p><p id="1115" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">提示</strong>:使用PubSub实现不是一个好主意，因为消息总线不可伸缩。他们很容易被大量的输入淹没。这里的可观察驱动实现感觉更优雅。</p><h1 id="0b90" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">7.客户端路由</h1><p id="dbc0" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">这一部分相当容易。我们需要给我们的<code class="fe nk nl nm nn b">tabButtonConfig</code>对象添加路线:</p><figure class="na nb nc nd gt ne"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="30d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步是将<code class="fe nk nl nm nn b">onHashChange()</code>逻辑添加到我们的视图控制器中:</p><figure class="na nb nc nd gt ne"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="5b89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们不仅在切换主选项卡时生成路线，而且我们现在还可以使用路线加载我们的应用程序，这将只加载我们需要的视图。</p><figure class="na nb nc nd gt ne"><div class="bz fp l di"><div class="ob nu l"/></div></figure><p id="d03e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您仔细观察，您会注意到，如果我们从加载MFE_2路由开始，然后切换到MFE_1选项卡，将不会有任何延迟加载。发生这种情况，是因为MFE_2已经包含了MFE_1。</p><p id="7889" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在检查DOM时，您会注意到只安装了活动的选项卡。除此之外，我们还可以选择将选项卡的JS实例保存在内存中(这是默认行为)，并且只在需要时添加和删除现有的虚拟dom。</p><p id="75f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">含义:每个选项卡的<code class="fe nk nl nm nn b">constructor()</code>只会触发一次，每个选项卡的<code class="fe nk nl nm nn b">render()</code>方法也只会触发一次。</p><p id="5f95" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">客户端路由不仅限于选项卡。我们可以使用卡片布局或其他结构来处理视图控制器内部的逻辑。</p><h1 id="a5c3" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">8.我们MFE组合的生产构建</h1><p id="2632" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">到目前为止，整个代码都在浏览器中运行，没有任何直接的构建或编译。这大大加快了开发速度。</p><p id="0811" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，我们确实想把每个州需要的文件打包。Webpack 是一个很棒的工具，可以在app worker范围内为我们的动态导入创建分割块。</p><p id="ec97" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要做的就是在我们的<code class="fe nk nl nm nn b">main</code>顶层文件夹的<code class="fe nk nl nm nn b">package.json</code>中运行<code class="fe nk nl nm nn b">build-all</code>脚本。</p><p id="1242" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">提示</strong>:如果我们只改变与应用相关的代码，我们可以使用<code class="fe nk nl nm nn b">build-my-apps</code>脚本，这样会更快。</p><p id="f5e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们也可以在我们的<code class="fe nk nl nm nn b">main/apps</code>文件夹中生成多个应用程序，我们将获得开箱即用的跨应用程序分割块。意思是:将多个应用放入同一个页面将会有接近零的开销。</p><p id="0986" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们来看看<code class="fe nk nl nm nn b">dist/production</code>版本:</p><figure class="na nb nc nd gt ne"><div class="bz fp l di"><div class="ob nu l"/></div></figure><p id="a102" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你会看到我们将加载更少的文件。对于基于Webpack的版本，我们需要切换到dev tools network选项卡中的<code class="fe nk nl nm nn b">Other</code>选项卡。这与Harmony有关，一旦Mozilla (Firefox)支持worker范围内的JS模块，Harmony就会被删除。</p><p id="3995" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">目前，dev模式运行在Chromium和Safari中，而dist/production版本运行在所有主流浏览器中。不用担心，也有一个dist/development版本(支持所有浏览器)。</p><h1 id="fd92" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">9.我们的代码真的存在于app worker中吗？</h1><p id="1ccf" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">在创建应用程序时，除了<code class="fe nk nl nm nn b">window</code>和<code class="fe nk nl nm nn b">window.document</code>未定义之外，你几乎不会注意到它们的区别。</p><p id="6189" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不作弊:)</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi od"><img src="../Images/7ed205790e256c6d6c54766a0a9443dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qVhmgq-CVdMhjk-d5QhqBA.png"/></div></div></figure><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi oa"><img src="../Images/7bc031b01a621e3a7fd450e009e86f7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BMGNMV6dTmMEtTn-lrEj1g.png"/></div></div></figure><p id="30a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你的应用、组件和微前端真正地存在于应用工作者的范围内。</p><h1 id="486b" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">10.增强创意</h1><p id="45ba" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">还有一个难题需要解决。浏览器不支持裸模块说明符，我们不能在导入语句或动态导入中使用变量。</p><p id="a4ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">变量会给我们很大的帮助，例如为我们的URL指定一个基本路径。</p><p id="a98a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">解决这个问题的一个方法是将neo放入CDN，并从那里获取所有与框架相关的文件。</p><p id="478c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我想做的是让我们能够将框架放入monorepo结构的顶级文件夹中。这使我们能够从那里获取所有文件，并以一种方便的方式为特性请求或bug创建PRs。</p><p id="a86f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我很可能需要调整构建脚本来处理这个问题。</p><p id="d8cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了支持在不同版本中导入mfe(作为顶层文件夹中的依赖项添加)，我们还需要一个新的构建脚本来根据需要调整与框架相关的导入路径(除非我们使用CDN)。</p><p id="4eea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请给我提个醒，如果你想看到这种情况发生的话！</p><p id="d003" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我可以创建这篇文章的第二部分，如果你有什么想法，你想看到MFE_3实现内部。我在考虑一个更复杂的视图，显示更多的事件，并在运行时调整另外两个mfe。MFE_3应该包含一个视图模型(类似于存储/状态提供者，比如MobX)和如何使用它的逻辑。为了保持这篇文章的篇幅合理，我暂时跳过了这一部分。</p><h1 id="2c27" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">11.最后的想法</h1><p id="5332" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">虽然我强烈建议如果可能的话坚持使用单一工作空间(npx neo-app ),但是monorepo方法可能会很好，特别是在多个团队想要在不同的范围上工作并且需要不同的依赖项(或者相同依赖项的不同版本)的情况下。</p><p id="4bb9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建这个PoC演示和撰写这篇文章只花了一天时间。相信我，写这篇文章花了大部分时间。</p><p id="302a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可能已经注意到，我们根本没有使用模块联合。我们不需要指定任何遥控器，可以自由使用和惰性加载微前端。</p><p id="4f1b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">而我们不能(也不想！)为我们使用的每个MFE单独创建一个dist/prod版本，我们可以根据需要创建与我们的应用程序相关的构建版本。</p><p id="4532" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">构建时间会稍微慢一点，但是请记住，我们只在需要部署到dist/prod时才需要构建。对于开发，我们根本不需要任何构建或移植。</p><p id="4d8a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不过，我还没有找到时间来全面研究模块联合。如果有适用于neo范围的用例，请→功能请求或PRs。</p><p id="f824" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">欢迎您直接在neo repo中创建新功能请求:</p><div class="mg mh gp gr mi mj"><a href="https://github.com/neomjs/neo" rel="noopener  ugc nofollow" target="_blank"><div class="mk ab fo"><div class="ml ab mm cl cj mn"><h2 class="bd ir gy z fp mo fr fs mp fu fw ip bi translated">GitHub - neomjs/neo:应用工人驱动的前端框架</h2><div class="mq l"><h3 class="bd b gy z fp mo fr fs mp fu fw dk translated">neo.mjs使您能够使用一个以上的CPU创建可扩展的高性能应用程序。不需要照顾一个…</h3></div><div class="mr l"><p class="bd b dl z fp mo fr fs mp fu fw dk translated">github.com</p></div></div><div class="ms l"><div class="oe l mu mv mw ms mx my mj"/></div></div></a></div><p id="c5a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">目前的计划是接下来重点关注新的学习部分(大规模epic):</p><div class="mg mh gp gr mi mj"><a href="https://github.com/neomjs/neo/projects/29" rel="noopener  ugc nofollow" target="_blank"><div class="mk ab fo"><div class="ml ab mm cl cj mn"><h2 class="bd ir gy z fp mo fr fs mp fu fw ip bi translated">学习部分/ Wiki neomjs/neo</h2><div class="mq l"><h3 class="bd b gy z fp mo fr fs mp fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="mr l"><p class="bd b dl z fp mo fr fs mp fu fw dk translated">github.com</p></div></div><div class="ms l"><div class="of l mu mv mw ms mx my mj"/></div></div></a></div><p id="ae8d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以在这里找到本文中提到的所有文件:</p><div class="mg mh gp gr mi mj"><a href="https://github.com/neomjs/micro-frontends-demo" rel="noopener  ugc nofollow" target="_blank"><div class="mk ab fo"><div class="ml ab mm cl cj mn"><h2 class="bd ir gy z fp mo fr fs mp fu fw ip bi translated">GitHub-neom js/micro-frontends-demo:从主线程中扩展您的微前端</h2><div class="mq l"><h3 class="bd b gy z fp mo fr fs mp fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="mr l"><p class="bd b dl z fp mo fr fs mp fu fw dk translated">github.com</p></div></div><div class="ms l"><div class="mt l mu mv mw ms mx my mj"/></div></div></a></div><p id="f2d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请随意进入slack频道，获取想法、反馈和问题:</p><div class="mg mh gp gr mi mj"><a href="https://join.slack.com/t/neomjs/shared_invite/zt-6c50ueeu-3E1~M4T9xkNnb~M_prEEOA" rel="noopener  ugc nofollow" target="_blank"><div class="mk ab fo"><div class="ml ab mm cl cj mn"><h2 class="bd ir gy z fp mo fr fs mp fu fw ip bi translated">松弛的</h2><div class="mq l"><h3 class="bd b gy z fp mo fr fs mp fu fw dk translated">编辑描述</h3></div><div class="mr l"><p class="bd b dl z fp mo fr fs mp fu fw dk translated">join.slack.com</p></div></div><div class="ms l"><div class="og l mu mv mw ms mx my mj"/></div></div></a></div><p id="1467" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">问候&amp;快乐编码，<br/>托拜厄斯</p><p id="b0c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">附:我将很快创建一个在线演示！</p><p id="b2a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">预览图像:</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi oh"><img src="../Images/7a5418dc0259112874a02ad2d7150b8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AqCYy1tBWXhOpTApAxLb1w.png"/></div></div></figure></div></div>    
</body>
</html>