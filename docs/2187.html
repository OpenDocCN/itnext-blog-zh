<html>
<head>
<title>Defensive PowerShell</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">防御性PowerShell</h1>
<blockquote>原文：<a href="https://itnext.io/defensive-powershell-with-validation-attributes-8e7303e179fd?source=collection_archive---------5-----------------------#2019-04-13">https://itnext.io/defensive-powershell-with-validation-attributes-8e7303e179fd?source=collection_archive---------5-----------------------#2019-04-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5afa" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">验证属性快速失败</h2></div><p id="3930" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">属性是开发人员添加到代码中的标签，用于向解释器指示信息。属性最常用于定义cmdlet接口，在线上有很多关于在代码中利用PowerShell参数属性的指南，但是几乎没有关于在PowerShell代码中释放属性的全部潜力的指南。</p><h1 id="fffe" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">防御性编程</h1><p id="eca7" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">程序应该检测错误的输入，并在检测到错误输入时立即失败。您总是希望尽可能早地检测潜在问题，并在前提条件失败后最小化代码运行量。</p><h2 id="d499" class="mb lf it bd lg mc md dn lk me mf dp lo kr mg mh lq kv mi mj ls kz mk ml lu mm bi translated">终止错误</h2><p id="fdc3" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">在大多数主流编程语言中，如果程序抛出一个未被捕获的错误，程序就会停止运行。在bash和PowerShell这样的shell脚本语言中，如果程序遇到错误，默认情况下程序会继续下一行。要强制PowerShell总是在出错时停止，请设置:</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk translated">告诉PowerShell将所有错误设为致命错误</figcaption></figure><h2 id="40d4" class="mb lf it bd lg mc md dn lk me mf dp lo kr mg mh lq kv mi mj ls kz mk ml lu mm bi translated">陈述性或命令性</h2><p id="bdc5" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">声明性代码告诉解释器<em class="my">做什么</em>，而命令性代码告诉解释器<em class="my">如何做</em>。考虑这两个等效的实现:</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk translated">声明式与命令式实现</figcaption></figure><p id="d9f1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">声明式实现显然更简洁，告诉解释器只需验证<code class="fe mz na nb nc b">$n</code>在0和10之间。相比之下，命令式解决方案需要更多的代码，并且包含实现细节——布尔运算和错误实例化——否则可以用声明式解决方案来避免。验证属性是声明性的，因为它们定义了值何时有效。</p><h1 id="3d60" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">使用属性</h1><h2 id="edaa" class="mb lf it bd lg mc md dn lk me mf dp lo kr mg mh lq kv mi mj ls kz mk ml lu mm bi translated">声明属性</h2><p id="2c67" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">属性声明需要:</p><ul class=""><li id="0ffa" class="nd ne it kk b kl km ko kp kr nf kv ng kz nh ld ni nj nk nl bi translated">方括号</li><li id="95b3" class="nd ne it kk b kl nm ko nn kr no kv np kz nq ld ni nj nk nl bi translated">属性名称</li><li id="bad1" class="nd ne it kk b kl nm ko nn kr no kv np kz nq ld ni nj nk nl bi translated">属性参数-有时为空，但总是存在</li><li id="bf77" class="nd ne it kk b kl nm ko nn kr no kv np kz nq ld ni nj nk nl bi translated">属性影响的值</li></ul><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk translated">属性声明的形式</figcaption></figure><h2 id="87d3" class="mb lf it bd lg mc md dn lk me mf dp lo kr mg mh lq kv mi mj ls kz mk ml lu mm bi translated">发现验证属性</h2><p id="4b7d" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">如果你还没有，安装<a class="ae nr" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank">代码</a>并安装<a class="ae nr" href="https://github.com/PowerShell/vscode-powershell" rel="noopener ugc nofollow" target="_blank"> PowerShell扩展</a>以在PowerShell和林挺中启用自动完成功能。找到可用验证属性的最简单方法是开始键入<code class="fe mz na nb nc b">[Validate</code>并查看自动完成菜单中的选项:</p><figure class="mn mo mp mq gt mr gh gi paragraph-image"><div role="button" tabindex="0" class="nt nu di nv bf nw"><div class="gh gi ns"><img src="../Images/1c1b65defdb4aae85139cbc82fc17a37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RFKCcl_k9XidtG15WZJIgA.png"/></div></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk translated">验证属性最容易通过VS代码的自动完成功能发现</figcaption></figure><p id="edc1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这些属性中的大部分都是不言自明的，但是你总是可以在线搜索它们。请注意，我们用来声明属性的名称不包括在autocomplete菜单中所有属性上显示的“attribute”后缀。</p><h1 id="e8b5" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">放置验证属性</h1><h2 id="bf43" class="mb lf it bd lg mc md dn lk me mf dp lo kr mg mh lq kv mi mj ls kz mk ml lu mm bi translated">从简单开始:变量的属性</h2><p id="b4a9" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">每当您将名称绑定到值时，都会应用属性。绑定值和名称的最简单的例子是使用变量声明。使用带有变量声明的验证属性遵循以下形式:</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk translated">将属性应用于局部变量</figcaption></figure><p id="2174" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，如果您输入的字符串不是“ca”、“eu”或“us”，下面的代码将引发错误:</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk translated">将属性应用于局部变量的具体示例</figcaption></figure><p id="add0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦您理解了如何在最简单的情况下使用验证属性，您就可以看到相同的概念如何应用于更高级的用例，比如在函数调用中将值绑定到函数参数，或者在类实例化中将值绑定到类属性。</p><h2 id="6dc1" class="mb lf it bd lg mc md dn lk me mf dp lo kr mg mh lq kv mi mj ls kz mk ml lu mm bi translated">验证用户输入:函数的属性</h2><p id="036f" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">只要有接受参数的函数，就可以在参数定义中添加验证属性。</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk translated">定义函数参数的验证属性</figcaption></figure><p id="9f1b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是迄今为止最常见的用例，因此您可以很容易地找到扩展这一概念的其他资源，以及解释其他类型的属性，例如<code class="fe mz na nb nc b">[Parameter(...)]</code>属性。</p><h2 id="5e0e" class="mb lf it bd lg mc md dn lk me mf dp lo kr mg mh lq kv mi mj ls kz mk ml lu mm bi translated">释放潜能:类的属性</h2><p id="9f30" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">如果你还没有，看看我的另一篇文章，关于为什么你应该使用PowerShell类。您将了解为什么PowerShell类是有益的，特别是对于类型转换和序列化/反序列化。结合了验证属性和强制转换的类完美地集成在一起，这在我见过的任何其他语言中都是无与伦比的。</p><p id="ac29" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以在关联的属性声明上应用验证属性，只要您设置属性值，它们就会运行，例如当您将哈希表强制转换为类或在构造函数中设置值时。</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk translated">定义具有属性验证属性的类</figcaption></figure><p id="fc0c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当您将哈希表转换为类类型时，验证属性将确保属性包含有效值。</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk translated">投射到对象</figcaption></figure><h1 id="a696" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">常见使用案例</h1><p id="396d" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">这些是可以集成到脚本中的验证属性的实际例子。</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><h1 id="a447" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">进一步阅读</h1><ul class=""><li id="f2f3" class="nd ne it kk b kl lw ko lx kr nz kv oa kz ob ld ni nj nk nl bi translated"><a class="ae nr" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_functions_advanced_parameters" rel="noopener ugc nofollow" target="_blank">关于功能高级参数</a></li><li id="6df8" class="nd ne it kk b kl nm ko nn kr no kv np kz nq ld ni nj nk nl bi translated"><a class="ae nr" href="https://medium.com/@cjkuech/you-should-be-using-powershell-classes-9966db76f909" rel="noopener">你应该使用PowerShell类</a></li></ul></div></div>    
</body>
</html>