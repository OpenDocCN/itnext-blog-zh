<html>
<head>
<title>Use Istio traffic mirroring for quicker debugging</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Istio流量镜像加快调试速度</h1>
<blockquote>原文：<a href="https://itnext.io/use-istio-traffic-mirroring-for-quicker-debugging-a341d95d63f8?source=collection_archive---------3-----------------------#2019-02-15">https://itnext.io/use-istio-traffic-mirroring-for-quicker-debugging-a341d95d63f8?source=collection_archive---------3-----------------------#2019-02-15</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><p id="1236" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">通常，当出现错误时，尤其是在生产环境中，需要调试应用程序来进行修复。不幸的是，造成问题的输入已经消失了。并且文件上的测试数据不会触发错误(否则它在交付之前就会被修复)。</p><p id="82c9" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">同样地，如果一个人正在创建新的代码，他经常希望看到一个客户端可以提供什么值(老实说，我不止一次使用WireShark来查看发送了什么)。</p><p id="6d5f" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">Istio的流量镜像功能会有所帮助，因为它允许应用程序接收由主版本处理的真实流量。相同的请求被复制，然后发送到镜像服务。不同之处在于，来自镜像服务的回复只是被丢弃(由sidecar中的特使代理丢弃)，而不是返回给调用者。您不需要修改镜像版本——Istio会为您完成所有工作。</p><figure class="kn ko kp kq gu kr gi gj paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gi gj km"><img src="../Images/9e5c3b5e4d278b9ba75f869833cd1b48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9_3WRLFmo3dcOvVMmdbkVw.png"/></div></div><figcaption class="ky kz gk gi gj la lb bd b be z dk translated">具有流量的镜像设置图</figcaption></figure><h1 id="89a4" class="lc ld ir bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">使用Istio规则设置</h1><p id="7445" class="pw-post-body-paragraph jo jp ir jq b jr ma jt ju jv mb jx jy jz mc kb kc kd md kf kg kh me kj kk kl ik bi translated">让我们从DestinationRule开始，看看这个设置的规则</p><pre class="kn ko kp kq gu mf mg mh mi aw mj bi"><span id="3b0d" class="mk ld ir mg b gz ml mm l mn mo"><strong class="mg is">apiVersion</strong>: networking.istio.io/v1alpha3<br/><strong class="mg is">kind</strong>: DestinationRule<br/><strong class="mg is">metadata</strong>:<br/>  <strong class="mg is">name</strong>: a-server-dr<br/><strong class="mg is">spec</strong>:<br/>  <strong class="mg is">host</strong>: a-service<br/>  <strong class="mg is">subsets</strong>:<br/>    - <strong class="mg is">name</strong>: prod<br/>      <strong class="mg is">labels</strong>:<br/>        <strong class="mg is">version</strong>: "v0.1"<br/>    - <strong class="mg is">name</strong>: development<br/>      <strong class="mg is">labels</strong>:<br/>        <strong class="mg is">version</strong>: "devel"</span></pre><p id="b35b" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">此DestinationRule定义了两个子集。<em class="mp"> Prod </em>为生产流量，另一个<em class="mp"> development </em>为我们的调试目标。现在，我们可以使用以下VirtualService来定义镜像:</p><pre class="kn ko kp kq gu mf mg mh mi aw mj bi"><span id="194a" class="mk ld ir mg b gz ml mm l mn mo"><strong class="mg is">apiVersion</strong>: networking.istio.io/v1alpha3<br/><strong class="mg is">kind</strong>: VirtualService<br/><strong class="mg is">metadata</strong>:<br/>  <strong class="mg is">name</strong>: a-mirror<br/><strong class="mg is">spec</strong>:<br/>  <strong class="mg is">hosts</strong>:<br/>    - a-service<br/>  <strong class="mg is">http</strong>:<br/>    - <strong class="mg is">route</strong>:<br/>        - <strong class="mg is">destination</strong>:<br/>            <strong class="mg is">host</strong>: a-service<br/>            <strong class="mg is">subset</strong>: prod<br/>      <strong class="mg is">mirror</strong>:<br/>        <strong class="mg is">host</strong>: a-service<br/>        <strong class="mg is">subset</strong>: development</span></pre><p id="9771" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">然后在spec.http.route.destination中定义默认目标，在spec.http.mirror中定义镜像目标。</p><figure class="kn ko kp kq gu kr gi gj paragraph-image"><div class="gi gj mq"><img src="../Images/d48493d2931f89199bb8360d40b809d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:776/format:webp/1*mrE6WaWUuPXF-_OkfiX4Wg.png"/></div><figcaption class="ky kz gk gi gj la lb bd b be z dk translated">Kiali中的当前显示，其中评论流量将发送到v1并镜像到v2</figcaption></figure><p id="276c" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">虽然在<a class="ae mr" href="https://www.kiali.io/" rel="noopener ugc nofollow" target="_blank"> Kiali </a>中显示不完全正确，但您可以在上面的截图中看到，review服务的流量将100%传输到v1，同时镜像到v2(有人称这种镜像功能为“黑暗启动”，这里由一个不可见的连接表示；如果你想了解这个问题，可以看看https://issues.jboss.org/browse/KIALI-2218和Istio网站上相关的讨论和问题。很可能Istio 1.2将会看到遥测报告的变化，以迎合这一点——见<a class="ae mr" href="https://github.com/istio/istio/issues/11475" rel="noopener ugc nofollow" target="_blank">https://github.com/istio/istio/issues/11475</a>。</p><h1 id="40ed" class="lc ld ir bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">镜像到外部服务</h1><p id="cd9d" class="pw-post-body-paragraph jo jp ir jq b jr ma jt ju jv mb jx jy jz mc kb kc kd md kf kg kh me kj kk kl ik bi translated">通常，人们无法在同一个Istio集群中运行在线编辑器，而只能坐在笔记本电脑前打开IDE。在这种情况下，我们有两种选择:</p><ol class=""><li id="03aa" class="ms mt ir jq b jr js jv jw jz mu kd mv kh mw kl mx my mz na bi translated">部署一个本地代理，该代理被配置为与Istio底板对话，并将流量转发到本地进程。这与上面的场景非常相似</li><li id="68c0" class="ms mt ir jq b jr nb jv nc jz nd kd ne kh nf kl mx my mz na bi translated">使用一个<em class="mp"> ServiceEntry </em>将来自Istio的流量转发给被调试的服务</li></ol><p id="863e" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">让我们看看第二个选项:</p><figure class="kn ko kp kq gu kr gi gj paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gi gj ng"><img src="../Images/aa6691836393d72f9889fd8243d2cc8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ubmxu2aDs656j3VfyDkAJQ.png"/></div></div><figcaption class="ky kz gk gi gj la lb bd b be z dk translated">带有ServiceEntry(蓝色)的场景。</figcaption></figure><p id="d0d3" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">我们将从定义ServiceEntry开始:</p><pre class="kn ko kp kq gu mf mg mh mi aw mj bi"><span id="4eb0" class="mk ld ir mg b gz ml mm l mn mo"><strong class="mg is">apiVersion</strong>: networking.istio.io/v1alpha3<br/><strong class="mg is">kind</strong>: ServiceEntry<br/><strong class="mg is">metadata</strong>:<br/>  <strong class="mg is">name</strong>: external-a-service<br/><strong class="mg is">spec</strong>:<br/>  <strong class="mg is">hosts</strong>:<br/>  - a-service.ext <em class="mp"># this is an arbitrary string; only used in VS<br/>  </em><strong class="mg is">location</strong>: MESH_EXTERNAL<br/>  <strong class="mg is">ports</strong>:<br/>  - <strong class="mg is">number</strong>: 9080<br/>    <strong class="mg is">name</strong>: http-ext<br/>    <strong class="mg is">protocol</strong>: HTTP<br/>  <strong class="mg is">resolution</strong>: STATIC<br/>  <strong class="mg is">endpoints</strong>:<br/>  - <strong class="mg is">address</strong>: 1.2.3.1 <em class="mp"># Change to IP of service under debug<br/>    </em><strong class="mg is">ports</strong>:<br/>      <strong class="mg is">http-ext</strong>: 9080</span></pre><p id="ee82" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">spec.hosts条目是一个任意的条目，您只是稍后在VirtualService中需要它。spec.location表明服务在网格之外。有两种解析目标IP地址的可能性。我们选择“静态”并将IP放入spec.entpoinds.address。参考ServiceEntry 的<a class="ae mr" href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#ServiceEntry" rel="noopener ugc nofollow" target="_blank"> Istio文档以了解更多细节。现在有了这个条目，我们可以看看虚拟服务:</a></p><pre class="kn ko kp kq gu mf mg mh mi aw mj bi"><span id="14fe" class="mk ld ir mg b gz ml mm l mn mo"><strong class="mg is">apiVersion</strong>: networking.istio.io/v1alpha3<br/><strong class="mg is">kind</strong>: VirtualService<br/><strong class="mg is">metadata</strong>:<br/>  <strong class="mg is">name</strong>: external-service-a<br/><strong class="mg is">spec</strong>:<br/>  <strong class="mg is">hosts</strong>:<br/>    - a-service<br/>  <strong class="mg is">http</strong>:<br/>  - <strong class="mg is">route</strong>:<br/>    - <strong class="mg is">destination</strong>:<br/>        <strong class="mg is">host</strong>: a-service<br/>        <strong class="mg is">subset</strong>: prod<br/>      <strong class="mg is">weight</strong>: 100<br/>    <strong class="mg is">mirror</strong>:<br/>        <strong class="mg is">host</strong>: a-service.ext</span></pre><p id="6a0c" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">这看起来像上面一样，唯一真正的区别是，对于镜像目标，我们只提供主机，这是我们在上面的ServiceEntry中设置的。</p><p id="e96f" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">在写这篇文章的时候，我还发现<a class="ae mr" href="https://blog.christianposta.com/microservices/traffic-shadowing-with-istio-reduce-the-risk-of-code-release/" rel="noopener ugc nofollow" target="_blank">一篇来自克里斯蒂安·波斯塔</a>的博客文章，用Istio版本0.5解释了这一点；这些示例不能1:1使用，因为Istio路由规则已经更改。</p></div></div>    
</body>
</html>