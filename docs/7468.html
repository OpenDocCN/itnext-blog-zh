<html>
<head>
<title>SQLite: QEMU all over again?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQLite: QEMU又来了？</h1>
<blockquote>原文：<a href="https://itnext.io/sqlite-qemu-all-over-again-aedad19c9a1c?source=collection_archive---------0-----------------------#2022-10-04">https://itnext.io/sqlite-qemu-all-over-again-aedad19c9a1c?source=collection_archive---------0-----------------------#2022-10-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/9369f018c90e3f1c09ff7c99cf199ddd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*L5NceQxy6ef3CqcG"/></div></div></figure><div class=""/><div class=""><h2 id="57b6" class="pw-subtitle-paragraph jy ja jb bd b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp dk translated">在一次回忆之旅中，我回忆起我在QEMU的经历，以及这个项目是如何完全改变以适应新的行业趋势的。SQLite历史是不是又押韵了？</h2></div><p id="866b" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">我第一次听说QEMU是在21世纪初。QEMU是法布里斯·贝拉的创意。毫不夸张地说，法布里斯是一个真正的天才。不相信我？这些只是他在维基百科页面上的一些成就:</p><ul class=""><li id="c198" class="ln lo jb ks b kt ku kw kx kz lp ld lq lh lr ll ls lt lu lv bi translated"><a class="ae lm" href="https://en.wikipedia.org/wiki/Bellard%27s_formula" rel="noopener ugc nofollow" target="_blank">想出了以16为基数计算圆周率第n位数的公式</a>。</li><li id="a593" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated">2009年，第一次用台式电脑计算圆周率为2.7万亿位。</li><li id="3045" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated">创造了最广泛使用的视频编码器之一<a class="ae lm" href="https://ffmpeg.org/" rel="noopener ugc nofollow" target="_blank"> FFmpeg </a>。</li><li id="4e06" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated">创建了QEMU，这是一个快速的全系统仿真器，可以在几乎所有的处理器架构之间进行转换。</li></ul><h2 id="ee76" class="mb mc jb bd md me mf dn mg mh mi dp mj kz mk ml mm ld mn mo mp lh mq mr ms mt bi translated">QEMU之前模拟器是如何工作的</h2><p id="b3a2" class="pw-post-body-paragraph kq kr jb ks b kt mu kc kv kw mv kf ky kz mw lb lc ld mx lf lg lh my lj lk ll ij bi translated">我第一次听说QEMU是在2006年左右。我很早就对计算机体系结构感兴趣，当时大多数仿真器只是天真地在运行时将指令从翻译成仿真的体系结构。</p><p id="7c0e" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">另一方面，QEMU使用一个“微型代码生成器”通过JIT编译来翻译指令。它没有本机运行的速度快，但对于各种应用程序来说，它已经足够快了，对于许多用例来说，它感觉像是纯粹的奇迹。QEMU也有自己的常见物理设备仿真，自己的<a class="ae lm" href="https://en.wikipedia.org/wiki/Qcow" rel="noopener ugc nofollow" target="_blank">磁盘镜像格式</a>等等。</p><h2 id="0d8c" class="mb mc jb bd md me mf dn mg mh mi dp mj kz mk ml mm ld mn mo mp lh mq mr ms mt bi translated">虚拟化改变了行业</h2><p id="a0ce" class="pw-post-body-paragraph kq kr jb ks b kt mu kc kv kw mv kf ky kz mw lb lc ld mx lf lg lh my lj lk ll ij bi translated">但是在那个时候，一些别的事情正在酝酿。虚拟化正在成为行业的主流。</p><p id="37eb" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">虚拟化的概念不同于仿真。如果您只是试图运行一个独立的工作负载，而不是针对一个完全不同的架构，那么您可以直接执行指令。这说起来容易做起来难，因为处理器有特权指令，允许你访问其他虚拟机。</p><p id="2ecb" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">但是Xen项目在2004年首创的称为半虚拟化的方法表明，如果你同意改变操作系统——因为用户程序无论如何不能调用特权指令——那么你可以安全地一起运行许多虚拟机来完成工作。后来，英特尔和AMD都发布了自己的进程扩展，可以提供处理器特权状态的阴影视图，并允许像KVM这样的解决方案，后来为AWS的Nitro提供了动力。</p><h2 id="933f" class="mb mc jb bd md me mf dn mg mh mi dp mj kz mk ml mm ld mn mo mp lh mq mr ms mt bi translated">让QEMU做虚拟化</h2><p id="01f6" class="pw-post-body-paragraph kq kr jb ks b kt mu kc kv kw mv kf ky kz mw lb lc ld mx lf lg lh my lj lk ll ij bi translated">这两种解决方案都解决了如何执行VM指令的问题。但是，完整的解决方案还要求虚拟机拥有独立的<em class="mz">设备视图，</em>如声卡、显卡、磁盘等。QEMU拥有所有这些，而且非常棒，每个人都想重用它。但是QEMU是一个仿真解决方案，而不是虚拟化。</p><p id="f7ad" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">QEMU是一个开源项目，但是社区对整个虚拟化并不感兴趣。事实上，这个社区大部分是由志愿者维护的，除了非常有限的个人兴趣之外，它似乎对很多事情都不感兴趣。嘿，这里没有评判:我也是作为一名无偿志愿者来维护事物的，我知道这有多难！</p><p id="2e71" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">尽管如此，我们现在有了这个惊人的解决方案，它几乎为<em class="mz">做了</em>我们需要的一切，许多其他社区围绕它构建东西，出于方便升级的原因，他们尽最大努力保持东西不变。直到不可避免的事情发生了:我们通过<a class="ae lm" href="https://lore.kernel.org/all/49F08BD0.6000706@redhat.com/" rel="noopener ugc nofollow" target="_blank"> qemu-kvm </a>项目叉开了QEMU。</p><h2 id="8c23" class="mb mc jb bd md me mf dn mg mh mi dp mj kz mk ml mm ld mn mo mp lh mq mr ms mt bi translated">没有贡献导致分裂</h2><p id="3ff5" class="pw-post-body-paragraph kq kr jb ks b kt mu kc kv kw mv kf ky kz mw lb lc ld mx lf lg lh my lj lk ll ij bi translated">从某种意义上说，因为每个人都在用QEMU的一点一滴来构建他们的设备模型，QEMU <em class="mz">已经被分叉了。这项工作为QEMU本身(尽管是它的一个分支)的扩展奠定了基础，通过用本地处理器模拟代替处理器模拟来实现虚拟化。这个库成为了所有对推动QEMU所能做的事情感兴趣的各方的公共库，随着时间的推移，它基本上成为了新的QEMU:它仍然可以像以前一样进行仿真，甚至更好，因为许多改进非常普通，但现在也可以进行虚拟化，为项目打开了一个全新的应用程序。</em></p><h1 id="9c56" class="na mc jb bd md nb nc nd mg ne nf ng mj kh nh ki mm kk ni kl mp kn nj ko ms nk bi translated">SQLite是否处于类似的岔路口？</h1><figure class="nl nm nn no gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/ddabe8554348b39fa50f9d913cb8c7fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3l3dIayk7eCWL1RA"/></div></div></figure><p id="8fd5" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">当我环顾四周时，我看到一个非常相似的情况正在围绕SQLite发展。SQLite是D. Richard Hipp的想法，他也参与了Tcl编程语言和他自己的版本控制系统。与Fabrice一样，他无疑是一个聪明而有成就的人。</p><p id="ee42" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">SQLite的代码也是可用的，但是贡献比QEMU时代更难了:SQLite明确无误地“<a class="ae lm" href="https://www.sqlite.org/copyright.html" rel="noopener ugc nofollow" target="_blank">开源，而不是开放贡献</a>”。他们拥有的少数核心开发人员不使用git等现代工具和Github等协作工具，也不接受贡献，尽管他们可能会也可能不会接受您对新功能请求的建议。</p><p id="ae0c" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">就像QEMU一样，行业的新趋势正在将它带入一个全新的方向:由于资源和环境有限，围绕边缘计算的用例越来越多，这意味着SQLite完全符合要求。然而，边缘计算也意味着您的代码将在许多地理位置上运行，尽可能靠近用户以获得更好的延迟。这意味着命中单个SQLite实例的数据现在需要复制到所有其他实例。</p><h2 id="37e4" class="mb mc jb bd md me mf dn mg mh mi dp mj kz mk ml mm ld mn mo mp lh mq mr ms mt bi translated">虚拟化的兴起和边缘的兴起之间的相似之处。</h2><p id="631b" class="pw-post-body-paragraph kq kr jb ks b kt mu kc kv kw mv kf ky kz mw lb lc ld mx lf lg lh my lj lk ll ij bi translated">许多解决如何运行SQLite的问题的方法，但是随着分布式数据的出现。其中一些值得注意的是:</p><ul class=""><li id="f9e7" class="ln lo jb ks b kt ku kw kx kz lp ld lq lh lr ll ls lt lu lv bi translated"><a class="ae lm" href="https://github.com/rqlite/rqlite" rel="noopener ugc nofollow" target="_blank"> rqlite </a>:一个成熟的分布式数据库，类似于CockroachDB，但是使用SQLite作为存储引擎。你通过网络与它交流，它不再是一个可嵌入的数据库。</li><li id="a7d5" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated"><a class="ae lm" href="https://bedrockdb.com/" rel="noopener ugc nofollow" target="_blank"> BedrockdB </a>:类似于rqlite，也是围绕SQLite构建的。</li><li id="c2ac" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated"><a class="ae lm" href="https://dqlite.io/" rel="noopener ugc nofollow" target="_blank">dqlite</a>:SQLite&amp;RAFT的组合，用C编写，保持了SQLite的可嵌入性。但是因为你必须清楚地说明网络事件，所以像sqlx这样的表单是行不通的，并且/或者必须进行调整。</li><li id="31b1" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated"><a class="ae lm" href="https://github.com/chiselstrike/chiselstore" rel="noopener ugc nofollow" target="_blank">凿子店</a>:我自己对问题的尝试。接近dqlite(但在Rust中)，最终，正如我发现的，遭受许多相同的问题。</li><li id="fe46" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated">作为它最大的优势，事实上它位于SQLite之后的T2，所以任何和SQLite一起工作的东西都可以和LiteFS一起工作。必须做出一些让步，在当前不改变SQLite的限制下，他们的方法是提供一个分布式FUSE文件系统，它分散写操作并处理一致性问题。它有自己的一系列问题，其中许多问题在<a class="ae lm" href="https://news.ycombinator.com/item?id=32240230" rel="noopener ugc nofollow" target="_blank">黑客新闻的帖子</a>中提出。我个人认为，如果分布式文件系统很简单，我们现在应该已经有一个很好的了。但是在SQLite不可更改的假设下，这是目前最好的方法。向本和团队致敬！</li></ul><h2 id="6112" class="mb mc jb bd md me mf dn mg mh mi dp mj kz mk ml mm ld mn mo mp lh mq mr ms mt bi translated">如果SQLite接受投稿会怎么样？</h2><p id="8653" class="pw-post-body-paragraph kq kr jb ks b kt mu kc kv kw mv kf ky kz mw lb lc ld mx lf lg lh my lj lk ll ij bi translated">为什么假设SQLite不能改变？当然，没有人想保留打了补丁的软件，也没有人想要求用户安装其他版本的核心软件，比如SQLite。这是一个典型的<a class="ae lm" href="https://en.wikipedia.org/wiki/Prisoner%27s_dilemma" rel="noopener ugc nofollow" target="_blank">囚徒困境</a>情况:如果我们中的一个人拿着SQLite的叉子，从长远来看，这是一个失败的提议。正如QEMU的故事——坦率地说，还有其他许多故事——告诉我们的那样，如果我们能够团结一致，我们就会共赢。</p><figure class="nl nm nn no gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi np"><img src="../Images/5c9af2f07e6252a008cf98b50e36f131.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qsNpR398fry682DQ"/></div></div></figure><p id="8964" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">这就是为什么今天我和我的一些同行一起开始使用libSQL。这是一个让我们所有人聚在一起构建新一代嵌入式数据库SQLite的地方。我们希望构建一个强大而独立的社区，有一个清晰的行为准则，如果你觉得SQLite可以改变以适应未来，我们非常欢迎你来和我们一起构建。</p><p id="99f1" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">在我们的<a class="ae lm" href="https://github.com/libsql/libsql/blob/main/README.md" rel="noopener ugc nofollow" target="_blank">宣言</a>中有更多关于我们想要实现的目标的细节。以下是我们想要解决的一些问题:</p><ul class=""><li id="e0c9" class="ln lo jb ks b kt ku kw kx kz lp ld lq lh lr ll ls lt lu lv bi translated"><a class="ae lm" href="https://github.com/libsql/libsql/issues/7" rel="noopener ugc nofollow" target="_blank">我们希望使用io _ uring和异步接口</a></li><li id="5e36" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated"><a class="ae lm" href="https://github.com/libsql/libsql/issues/6" rel="noopener ugc nofollow" target="_blank">我们希望为分布式系统提供复制挂钩</a></li><li id="febe" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated"><a class="ae lm" href="https://github.com/libsql/libsql/issues/1" rel="noopener ugc nofollow" target="_blank">我们希望允许基于WASM的用户自定义函数</a></li></ul><p id="0015" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">你想贡献什么？我洗耳恭听。您可以通过以下方式联系我们:</p><ul class=""><li id="d710" class="ln lo jb ks b kt ku kw kx kz lp ld lq lh lr ll ls lt lu lv bi translated"><a class="ae lm" href="https://github.com/libsql/libsql/discussions/" rel="noopener ugc nofollow" target="_blank"> Github讨论</a></li><li id="d8c0" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated"><a class="ae lm" href="https://discord.gg/TxwbQTWHSr" rel="noopener ugc nofollow" target="_blank">不和</a></li></ul></div></div>    
</body>
</html>