<html>
<head>
<title>Grafana: Loki — the LogQL’s Prometheus-like counters, aggregation functions, and dnsmasq’s requests graphs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">grafana:Loki——LogQL的类似普罗米修斯的计数器、聚合函数和dnsmasq的请求图</h1>
<blockquote>原文：<a href="https://itnext.io/grafana-loki-the-logqls-prometheus-like-counters-aggregation-functions-and-dnsmasq-s-1e622c25c7e4?source=collection_archive---------2-----------------------#2019-11-17">https://itnext.io/grafana-loki-the-logqls-prometheus-like-counters-aggregation-functions-and-dnsmasq-s-1e622c25c7e4?source=collection_archive---------2-----------------------#2019-11-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/7c4591bf47b15766ddcdaf532dd18f35.png" data-original-src="https://miro.medium.com/v2/resize:fit:260/format:webp/0*HjnIcBL2rjXtrgoj.png"/></div></figure><p id="e18d" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我上一次为日志收集和监控配置Loki是在2019年2月——大约一年前，请参见<a class="ae kv" href="https://rtfm.co.ua/en/grafana-labs-loki-logs-collector-and-monitoring-system/" rel="noopener ugc nofollow" target="_blank">Grafana Labs:Loki——日志收集和监控系统</a>帖子，当时Loki处于测试状态。</p><p id="0a52" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">现在，我们在生产环境中面临传出流量问题，却找不到罪魁祸首。</p><p id="4876" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">尝试捕捉它的方法之一是收集关于DNS请求的统计数据，然后查看AWS EC2主机上的out尖峰和对本地<code class="fe kw kx ky kz b">dnsmasq</code>服务的DNS请求之间是否存在相关性。</p><p id="0e23" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><code class="fe kw kx ky kz b">dnsmasq</code>配置在<a class="ae kv" href="https://rtfm.co.ua/en/dnsmasq-aws-temporary-failure-in-name-resolution-logs-debug-and-dnsmasq-cache-size/" rel="noopener ugc nofollow" target="_blank">dnsmasq:AWS-“名称解析中的临时故障”、日志、调试和dnsmasq缓存大小</a>帖子中有所描述，在这篇文章中，我们将尝试实现下一个:</p><ul class=""><li id="7bcc" class="la lb it jz b ka kb ke kf ki lc km ld kq le ku lf lg lh li bi translated"><code class="fe kw kx ky kz b">dnsmasq</code>将所有请求写入本地日志文件</li><li id="6464" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated">日志由<code class="fe kw kx ky kz b">promtail</code>跟踪，它通过Loki向监控主机发送数据</li><li id="eac1" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated">最后，Grafana将根据Loki的数据绘制图表</li></ul><p id="f9bd" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">下面描述的设置更多的是概念验证，因为Loki本身及其在Grafana中的支持仍在开发中。</p><p id="7e6d" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">但是现在Grafana中的Explore特性支持类似于普罗米修斯的聚集和计数功能— <code class="fe kw kx ky kz b">sum()</code>、<code class="fe kw kx ky kz b">rate()</code>等。</p><p id="9922" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">去年的<code class="fe kw kx ky kz b">promtail</code>也增加了一些有趣的新技能，我们会在这篇文章中用到。</p><p id="f924" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">首先，我们将构建一个普通的Grafana + Loki + <code class="fe kw kx ky kz b">promtail</code>栈，然后将添加从我们的生产环境中收集的日志，最后将使用新的LogQL函数添加一个Grafana的仪表板</p><p id="14c0" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><em class="lo">走吧！</em></p><ul class=""><li id="3880" class="la lb it jz b ka kb ke kf ki lc km ld kq le ku lf lg lh li bi translated"><a class="ae kv" href="https://rtfm.co.ua/en/grafana-loki-the-logqls-prometheus-like-counters-aggregation-functions-and-dnsmasqs-requests-graphs/#Loki_start" rel="noopener ugc nofollow" target="_blank">洛基启动</a></li><li id="5396" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated"><a class="ae kv" href="https://rtfm.co.ua/en/grafana-loki-the-logqls-prometheus-like-counters-aggregation-functions-and-dnsmasqs-requests-graphs/#Grafana_start" rel="noopener ugc nofollow" target="_blank"> Grafana开始</a></li><li id="3936" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated"><a class="ae kv" href="https://rtfm.co.ua/en/grafana-loki-the-logqls-prometheus-like-counters-aggregation-functions-and-dnsmasqs-requests-graphs/#NGINX" rel="noopener ugc nofollow" target="_blank"> NGINX </a></li><li id="6b1b" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated"><a class="ae kv" href="https://rtfm.co.ua/en/grafana-loki-the-logqls-prometheus-like-counters-aggregation-functions-and-dnsmasqs-requests-graphs/#promtail_start" rel="noopener ugc nofollow" target="_blank">提示开始</a></li><li id="15e2" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated"><a class="ae kv" href="https://rtfm.co.ua/en/grafana-loki-the-logqls-prometheus-like-counters-aggregation-functions-and-dnsmasqs-requests-graphs/#promtail_and_dnsmasqs_logs" rel="noopener ugc nofollow" target="_blank"> promtail和dnsmasq的日志</a></li><li id="9518" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated"><a class="ae kv" href="https://rtfm.co.ua/en/grafana-loki-the-logqls-prometheus-like-counters-aggregation-functions-and-dnsmasqs-requests-graphs/#LogQL_Lokis_logs_aggregation_and_counters" rel="noopener ugc nofollow" target="_blank"> LogQL — Loki的日志聚合和计数器</a></li><li id="f7e4" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated"><a class="ae kv" href="https://rtfm.co.ua/en/grafana-loki-the-logqls-prometheus-like-counters-aggregation-functions-and-dnsmasqs-requests-graphs/#Loki_Internal_Server_Error" rel="noopener ugc nofollow" target="_blank"> Loki“内部服务器错误”</a></li><li id="625b" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated"><a class="ae kv" href="https://rtfm.co.ua/en/grafana-loki-the-logqls-prometheus-like-counters-aggregation-functions-and-dnsmasqs-requests-graphs/#Prometheus_as_Loki" rel="noopener ugc nofollow" target="_blank">普罗米修斯as…洛基？о.о</a></li><li id="c167" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated"><a class="ae kv" href="https://rtfm.co.ua/en/grafana-loki-the-logqls-prometheus-like-counters-aggregation-functions-and-dnsmasqs-requests-graphs/#rate" rel="noopener ugc nofollow" target="_blank">利率()</a></li><li id="978a" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated"><a class="ae kv" href="https://rtfm.co.ua/en/grafana-loki-the-logqls-prometheus-like-counters-aggregation-functions-and-dnsmasqs-requests-graphs/#promtail_pipeline_stages" rel="noopener ugc nofollow" target="_blank">提前流水线阶段</a></li><li id="0451" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated"><a class="ae kv" href="https://rtfm.co.ua/en/grafana-loki-the-logqls-prometheus-like-counters-aggregation-functions-and-dnsmasqs-requests-graphs/#Grafana_DNS_dashboard" rel="noopener ugc nofollow" target="_blank"> Grafana DNS仪表板</a></li></ul><h2 id="7f43" class="lp lq it bd lr ls lt dn lu lv lw dp lx ki ly lz ma km mb mc md kq me mf mg mh bi translated">洛基开始</h2><p id="c3e5" class="pw-post-body-paragraph jx jy it jz b ka mi kc kd ke mj kg kh ki mk kk kl km ml ko kp kq mm ks kt ku im bi translated">Loki将由Docker Compose启动，创建一个<code class="fe kw kx ky kz b">loki-stack.yml</code>文件:</p><pre class="mn mo mp mq gt mr kz ms mt aw mu bi"><span id="01f7" class="lp lq it kz b gy mv mw l mx my">version: '2.4'<br/><br/>networks:<br/>  loki:<br/><br/>services:<br/><br/>  loki:<br/>    image: grafana/loki:master-2739551<br/>    ports:<br/>      - "3100:3100"<br/>    networks:<br/>      - loki<br/>    restart: unless-stopped</span></pre><p id="e88b" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">运行它:</p><pre class="mn mo mp mq gt mr kz ms mt aw mu bi"><span id="4808" class="lp lq it kz b gy mv mw l mx my">root@monitoring-dev:/opt/loki# docker-compose -f loki-stack.yml up</span></pre><p id="443e" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">检查:</p><pre class="mn mo mp mq gt mr kz ms mt aw mu bi"><span id="f44c" class="lp lq it kz b gy mv mw l mx my">root@monitoring-dev:/home/admin# curl localhost:3100/ready<br/>Ready</span></pre><p id="08ce" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">Loki API文档<a class="ae kv" href="https://github.com/grafana/loki/blob/master/docs/api.md" rel="noopener ugc nofollow" target="_blank">此处&gt; &gt; &gt; </a>。</p><h2 id="a31d" class="lp lq it bd lr ls lt dn lu lv lw dp lx ki ly lz ma km mb mc md kq me mf mg mh bi translated">格拉夫纳开始</h2><p id="04fc" class="pw-post-body-paragraph jx jy it jz b ka mi kc kd ke mj kg kh ki mk kk kl km ml ko kp kq mm ks kt ku im bi translated">以同样的方式使用6.4.4版本对Grafana进行重复操作(参见其<a class="ae kv" href="https://hub.docker.com/r/grafana/grafana/tags" rel="noopener ugc nofollow" target="_blank"> Docker Hub </a>中的所有可用版本):</p><pre class="mn mo mp mq gt mr kz ms mt aw mu bi"><span id="79ea" class="lp lq it kz b gy mv mw l mx my">version: '2.4'<br/><br/>networks:<br/>  loki:<br/><br/>services:<br/><br/>  loki:<br/>    image: grafana/loki:master-2739551<br/>    ports:<br/>      - "3100:3100"<br/>    networks:<br/>      - loki<br/>    restart: unless-stopped<br/><br/>  grafana:<br/>    image: grafana/grafana:6.4.4<br/>    ports:<br/>      - "3000:3000"<br/>    networks:<br/>      - loki<br/>    restart: unless-stopped</span></pre><p id="9527" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">启动它，检查它:</p><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/71aef180c240e65827ac2f3e6b6d32af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QK1xzYHInHcFE0F6.png"/></div></div></figure><p id="dd96" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">使用<em class="lo"> admin:admin </em>登录，进入<em class="lo">数据源</em>:</p><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi ne"><img src="../Images/9b9a80158d49dd381011e08c435208a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IVbhb0zDU4EiHt3B.png"/></div></div></figure><p id="1771" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">因为我们有运行在Docker网络中的Loki—在这里使用<a class="ae kv" href="http://loki" rel="noopener ugc nofollow" target="_blank"><em class="lo">http://Loki</em></a>URI:</p><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nf"><img src="../Images/faab33b7cd824e667e92e0705951badb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*oplsUrTgVPK18gIv.png"/></div></div></figure><h2 id="889f" class="lp lq it bd lr ls lt dn lu lv lw dp lx ki ly lz ma km mb mc md kq me mf mg mh bi translated">NGINX</h2><p id="9e15" class="pw-post-body-paragraph jx jy it jz b ka mi kc kd ke mj kg kh ki mk kk kl km ml ko kp kq mm ks kt ku im bi translated">设置是在现有的监控开发环境中执行的，所以我已经在那里配置了NGINX。</p><p id="dc59" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">Loki的配置<code class="fe kw kx ky kz b">/etc/nginx/conf.d/dev.loki.example.com.conf</code>如下所示:</p><pre class="mn mo mp mq gt mr kz ms mt aw mu bi"><span id="7653" class="lp lq it kz b gy mv mw l mx my">upstream grafana-loki {<br/>    server 127.0.0.1:3000;<br/>}<br/><br/>server {<br/><br/>    listen 80;<br/>    server_name  dev.loki.example.com;<br/><br/>    # Lets Encrypt Webroot                                           <br/>    location ~ /.well-known {<br/><br/>    root /var/www/html;<br/>        allow all;<br/>    }<br/>    <br/>    location / {<br/>    <br/>        allow 194.***.***.26/29;<br/>        allow 91.***.***.78/32;<br/>        allow 188.***.***.94/32;<br/>        allow 78.***.***.191/32;<br/>        allow 176.***.***.43/32;<br/>        allow 10.0.10.0/24;<br/>        deny  all;<br/><br/>        return 301 <a class="ae kv" href="https://dev.loki.example.com$request_uri;" rel="noopener ugc nofollow" target="_blank">https://dev.loki.example.com$request_uri;</a><br/>    }       <br/>}<br/><br/>server {<br/><br/>    listen       443 ssl;<br/>    server_name  dev.loki.example.com;<br/><br/>#    access_log  /var/log/nginx/dev.loki.example.com-access.log proxy;<br/>    error_log /var/log/nginx/dev.loki.example.com-error.log warn;<br/><br/>#    auth_basic_user_file /var/www/dev.loki.example.com/.htpasswd;<br/>#    auth_basic "Password-protected Area";<br/><br/>    allow 194.***.***.26/29;<br/>    allow 91.***.***.78/32;<br/>    allow 188.***.***.94/32;<br/>    allow 78.***.***.191/32;<br/>    allow 176.***.***.43/32;<br/>    allow 10.0.10.0/24;<br/>    deny  all;<br/><br/>    ssl_certificate /etc/letsencrypt/live/dev.loki.example.com/fullchain.pem;<br/>    ssl_certificate_key /etc/letsencrypt/live/dev.loki.example.com/privkey.pem;<br/><br/>    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;<br/>    ssl_prefer_server_ciphers on;<br/>    ssl_dhparam /etc/nginx/dhparams.pem;<br/>    ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:ECDHE-RSA-AES128-GCM-SHA256:AES256+EECDH:DHE-RSA-AES128-GCM-SHA256:AES256+EDH:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4";<br/>    ssl_session_timeout 1d;<br/>    ssl_stapling on;<br/>    ssl_stapling_verify on;<br/><br/>    location / {<br/><br/>        proxy_redirect          off;<br/>        proxy_set_header        Host            $host;<br/>        proxy_set_header        X-Real-IP       $remote_addr;<br/>        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;<br/>        proxy_pass <a class="ae kv" href="http://grafana-loki$request_uri;" rel="noopener ugc nofollow" target="_blank">http://grafana-loki$request_uri;</a><br/>    }<br/><br/>}</span></pre><h2 id="dd03" class="lp lq it bd lr ls lt dn lu lv lw dp lx ki ly lz ma km mb mc md kq me mf mg mh bi translated"><code class="fe kw kx ky kz b">promtail</code>开始</h2><p id="1eaf" class="pw-post-body-paragraph jx jy it jz b ka mi kc kd ke mj kg kh ki mk kk kl km ml ko kp kq mm ks kt ku im bi translated">目前，Grafana Explore中没有任何内容，因为还没有日志被发送到Loki。</p><p id="eb93" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">创建<code class="fe kw kx ky kz b">promtail</code>的配置- <code class="fe kw kx ky kz b">/opt/loki/promtail.yml</code>:</p><p id="61c4" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在<code class="fe kw kx ky kz b">client</code>块中使用URL作为<a class="ae kv" href="http://loki:" rel="noopener ugc nofollow" target="_blank"> http:// <em class="lo"> loki </em> : </a></p><pre class="mn mo mp mq gt mr kz ms mt aw mu bi"><span id="2618" class="lp lq it kz b gy mv mw l mx my">server:<br/><br/>  http_listen_port: 9080<br/>  grpc_listen_port: 0<br/><br/>positions:<br/>  filename: /tmp/positions.yaml<br/><br/>client:<br/><br/>  url: <a class="ae kv" href="http://loki:3100/loki/api/v1/push" rel="noopener ugc nofollow" target="_blank">http://loki:3100/loki/api/v1/push</a><br/><br/>scrape_configs:<br/><br/>  - job_name: messages<br/>    static_configs:<br/>    - targets:<br/>        - localhost<br/>      labels:<br/>        job: all-logs<br/>        env: dev<br/>        host: monitoring-dev<br/>        __path__: /var/log/*.log</span></pre><p id="ef5b" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">将<code class="fe kw kx ky kz b">promtail</code>添加到合成文件中，在那里挂载配置文件，并为<code class="fe kw kx ky kz b">promtail</code>指定一个<code class="fe kw kx ky kz b">command</code>，让它知道使用哪个配置文件:</p><pre class="mn mo mp mq gt mr kz ms mt aw mu bi"><span id="d61d" class="lp lq it kz b gy mv mw l mx my">...<br/>  promtail:<br/>    image: grafana/promtail:master-2739551<br/>    networks:<br/>      - loki<br/>    volumes:<br/>      - /opt/loki/promtail.yml:/etc/promtail/promtail.yml<br/>    command: <br/>      - '-config.file=/etc/promtail/promtail.yml'<br/>    restart: unless-stopped</span></pre><p id="ec3b" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">检查一下。</p><p id="4c9f" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><code class="fe kw kx ky kz b">promtail</code>的输出:</p><pre class="mn mo mp mq gt mr kz ms mt aw mu bi"><span id="61cc" class="lp lq it kz b gy mv mw l mx my">…<br/>promtail_1 | level=info ts=2019–11–16T09:19:57.935528884Z caller=filetargetmanager.go:257 msg=”Adding target” key=”{env=\”dev\”, host=\”monitoring-dev\”, job=\”all-logs\”}”</span><span id="e1c1" class="lp lq it kz b gy ng mw l mx my">promtail_1 | ts=2019–11–16T09:19:57.936230518Z caller=log.go:124 component=tailer level=info msg=”Seeked /var/log/dpkg.log — &amp;{Offset:0 Whence:0}”</span><span id="0ed4" class="lp lq it kz b gy ng mw l mx my">promtail_1 | level=info ts=2019–11–16T09:19:57.936292402Z caller=tailer.go:77 component=tailer msg=”start tailing file” path=/var/log/dpkg.log<br/>…</span></pre><p id="50e6" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><code class="fe kw kx ky kz b">dpkg.log</code>有尾巴。好吧。</p><p id="ea0e" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">并查看Grafana Explore:</p><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nh"><img src="../Images/011a193ed941644e5eb67b31e7b53a6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*RGVj0vE1GG5BVTmu.png"/></div></div></figure><p id="35bd" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">不错！</p><h2 id="8a3d" class="lp lq it bd lr ls lt dn lu lv lw dp lx ki ly lz ma km mb mc md kq me mf mg mh bi translated"><code class="fe kw kx ky kz b">promtail</code>和<code class="fe kw kx ky kz b">dnsmasq</code>的日志</h2><p id="e5b8" class="pw-post-body-paragraph jx jy it jz b ka mi kc kd ke mj kg kh ki mk kk kl km ml ko kp kq mm ks kt ku im bi translated">现在，让我们去我们的生产хост，检查您是否可以从那里访问Loki:</p><pre class="mn mo mp mq gt mr kz ms mt aw mu bi"><span id="4385" class="lp lq it kz b gy mv mw l mx my">root@bttrm-production-console:/home/admin# curl <a class="ae kv" href="http://dev.logger.example.com:3100/ready" rel="noopener ugc nofollow" target="_blank">http://dev.logger.example.com:3100/ready</a></span></pre><p id="5c98" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">准备好的</p><p id="f3f0" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在那里创建一个<code class="fe kw kx ky kz b">promtail</code>的配置<code class="fe kw kx ky kz b">promtail-dev.yml</code>:</p><pre class="mn mo mp mq gt mr kz ms mt aw mu bi"><span id="0e33" class="lp lq it kz b gy mv mw l mx my">server:<br/><br/>  http_listen_port: 9080<br/>  grpc_listen_port: 0<br/><br/>positions:<br/>  filename: /tmp/positions.yaml<br/><br/>client:<br/><br/>  url: <a class="ae kv" href="http://dev.loki.example.com:3100/loki/api/v1/push" rel="noopener ugc nofollow" target="_blank">http://dev.loki.example.com:3100/loki/api/v1/push</a><br/><br/>scrape_configs:<br/><br/>  - job_name: dnsmasq<br/>    static_configs:<br/>    - targets:<br/>        - localhost<br/>      labels:<br/>        job: dnsmasq<br/>        env: production<br/>        host: bttrm-prod-console<br/>        __path__: /var/log/dnsmasq.log</span></pre><p id="7440" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">请注意，自从我上次设置后，Loki的端点已经更改，现在是<code class="fe kw kx ky kz b">/loki/api/v1/push</code>。</p><p id="43b2" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">参见Loki的API文档<a class="ae kv" href="https://github.com/grafana/loki/blob/master/docs/api.md" rel="noopener ugc nofollow" target="_blank">此处&gt; &gt; &gt; </a>。</p><p id="0521" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">现在，让我们在没有Docker Compose的情况下运行它，我在那里有完整的监控导出器堆栈，稍后将添加Promtail:</p><pre class="mn mo mp mq gt mr kz ms mt aw mu bi"><span id="23bd" class="lp lq it kz b gy mv mw l mx my">root@bttrm-production-console:/opt/prometheus-client# docker run -ti -v /opt/prometheus-client/promtail-dev.yml:/etc/promtail/promtail.yml grafana/promtail:master-2739551 -config.file=/etc/promtail/promtail.yml<br/>Unable to find image ‘grafana/promtail:master-2739551’ locally<br/>master-2739551: Pulling from grafana/promtail<br/>…<br/>Status: Downloaded newer image for grafana/promtail:master-2739551<br/>level=warn ts=2019–11–16T09:29:00.668750217Z caller=filetargetmanager.go:98 msg=”WARNING!!! entry_parser config is deprecated, please change to pipeline_stages”<br/>level=info ts=2019–11–16T09:29:00.669077956Z caller=server.go:121 http=[::]:9080 grpc=[::]:45421 msg=”server listening on addresses”<br/>level=info ts=2019–11–16T09:29:00.66921034Z caller=main.go:65 msg=”Starting Promtail” version=”(version=, branch=, revision=)”<br/>level=info ts=2019–11–16T09:29:05.669176878Z caller=filetargetmanager.go:257 msg=”Adding target” key=”{env=\”production\”, host=\”bttrm-prod-console\”, job=\”dnsmasq\”}”</span></pre><p id="d3fb" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">呃…</p><p id="67f8" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">为什么没有日志被跟踪？必须有"<em class="lo">msg = " start tailing file " path =/var/log/dnsmasq . log</em>"字符串…</p><p id="e72f" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">洛基怎么样了？</p><p id="2d0e" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">什么是连接到数据源的"<strong class="jz iu"> <em class="lo">错误:数据源已连接，但未收到标签。验证Loki和Promtail是否正确配置</em> </strong>“错误？</p><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi ni"><img src="../Images/2dbe09286997cb0c8ea65893a9ad86c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QYW0r8hp_5t95C5-.png"/></div></div></figure><p id="f2f1" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">嗯，可以尝试重新创建容器:</p><pre class="mn mo mp mq gt mr kz ms mt aw mu bi"><span id="d888" class="lp lq it kz b gy mv mw l mx my">root@monitoring-dev:/opt/loki# docker rm loki_grafana_1 loki_promtail_1<br/>loki_grafana_1<br/>loki_promtail_1</span></pre><p id="de5f" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">好——这很有帮助，洛基现在回去了。</p><p id="b780" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">日志没有被收集，因为我忘记将<code class="fe kw kx ky kz b">/var/log</code>安装到<code class="fe kw kx ky kz b">promtail</code>的容器中——将<code class="fe kw kx ky kz b">-v /var/log:/var/log</code>添加到它的<code class="fe kw kx ky kz b">run</code>命令中:</p><pre class="mn mo mp mq gt mr kz ms mt aw mu bi"><span id="1bef" class="lp lq it kz b gy mv mw l mx my">root@bttrm-production-console:/home/admin# docker run -ti -v /opt/prometheus-client/promtail-dev.yml:/etc/promtail/promtail.yml -v /var/log:/var/log grafana/promtail:master-2739551 -config.file=/etc/promtail/promtail.yml<br/>level=warn ts=2019–11–16T09:48:02.248719806Z caller=filetargetmanager.go:98 msg=”WARNING!!! entry_parser config is deprecated, please change to pipeline_stages”<br/>level=info ts=2019–11–16T09:48:02.249227598Z caller=server.go:121 http=[::]:9080 grpc=[::]:39883 msg=”server listening on addresses”<br/>level=info ts=2019–11–16T09:48:02.249381673Z caller=main.go:65 msg=”Starting Promtail” version=”(version=, branch=, revision=)”<br/>level=info ts=2019–11–16T09:48:07.249262647Z caller=filetargetmanager.go:257 msg=”Adding target” key=”{env=\”production\”, host=\”bttrm-prod-console\”}”<br/>level=info ts=2019–11–16T09:48:07.24943453Z caller=tailer.go:77 component=tailer msg=”start tailing file” path=/var/log/dnsmasq.log<br/>ts=2019–11–16T09:48:07.249544341Z caller=log.go:124 component=tailer level=info msg=”Seeked /var/log/dnsmasq.log — &amp;{Offset:0 Whence:0}”</span></pre><p id="e8dc" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">现在有日志:</p><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nj"><img src="../Images/a33a78fdec92b574a82922c5dc26c78b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SpGCPYfhuKYAL1qQ.png"/></div></div></figure><h2 id="128c" class="lp lq it bd lr ls lt dn lu lv lw dp lx ki ly lz ma km mb mc md kq me mf mg mh bi translated">LogQL — Loki的日志聚合和计数器</h2><p id="e0ba" class="pw-post-body-paragraph jx jy it jz b ka mi kc kd ke mj kg kh ki mk kk kl km ml ko kp kq mm ks kt ku im bi translated">下面是最有趣的部分开始— <a class="ae kv" href="https://github.com/grafana/loki/blob/master/docs/logql.md" rel="noopener ugc nofollow" target="_blank"> LogQL </a>和聚合/计数函数。</p><p id="ffef" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">然而，我不得不花一些时间来使它工作，因为格拉夫纳和洛基的文件不清楚所有的细节。</p><h2 id="d00e" class="lp lq it bd lr ls lt dn lu lv lw dp lx ki ly lz ma km mb mc md kq me mf mg mh bi translated">Loki“内部服务器错误”</h2><p id="da30" class="pw-post-body-paragraph jx jy it jz b ka mi kc kd ke mj kg kh ki mk kk kl km ml ko kp kq mm ks kt ku im bi translated">如果尝试执行类似<code class="fe kw kx ky kz b">count_over_time({job="dnsmasq"}[5m])</code>的查询，将会看到内部服务器错误:</p><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nk"><img src="../Images/4d09ae620a463b38dd99da55c8f92034.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PfaNkqmZRbsxUbfG.png"/></div></div></figure><p id="5f21" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这是由…空格引起的！</p><p id="d9fb" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">修复它——在大括号之间添加空格，但现在Grafana什么也找不到:</p><pre class="mn mo mp mq gt mr kz ms mt aw mu bi"><span id="cbb3" class="lp lq it kz b gy mv mw l mx my">count_over_time( {job="dnsmasq"}[5m] )</span></pre><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nl"><img src="../Images/648c85c567564401cf3f27adfecee1fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DMUHYHkVIfM1y_CT.png"/></div></div></figure><h2 id="0ba4" class="lp lq it bd lr ls lt dn lu lv lw dp lx ki ly lz ma km mb mc md kq me mf mg mh bi translated">普罗米修斯作为…洛基？О.О</h2><p id="f95a" class="pw-post-body-paragraph jx jy it jz b ka mi kc kd ke mj kg kh ki mk kk kl km ml ko kp kq mm ks kt ku im bi translated">这有点奇怪，但很管用)</p><p id="599c" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">同样，这在任何地方都没有记录，但是我在<a class="ae kv" href="https://grafana.slack.com" rel="noopener ugc nofollow" target="_blank">grafana.slack.com</a>社区找到了这个“解决方案”。</p><p id="a7f8" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在Grafana 6.5中，Loki必须以正常方式支持函数，但是现在，让我们做一些奇怪的事情。</p><p id="2586" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">转到<em class="lo">数据源</em>，添加<strong class="jz iu">普罗米修斯</strong>——但是作为<strong class="jz iu"> Loki </strong>。</p><p id="e33d" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">或者洛基——作为普罗米修斯？</p><p id="3aef" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">无论如何，选择了Prometheus类型，但是在URL中指定了<a class="ae kv" href="http://loki:310/loki" rel="noopener ugc nofollow" target="_blank"><em class="lo">http://Loki:310/Loki</em></a>——结尾是<strong class="jz iu"> /loki </strong>:</p><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nm"><img src="../Images/90ae3692599dcfacc65095421a896274.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JdbXQsiyTi_O6LFb.png"/></div></div></figure><p id="ecb7" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">并检查:</p><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nn"><img src="../Images/aee24e33bf965f42ac255161161edcf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*g7MCbdEpbJ8C3Z3I.png"/></div></div></figure><p id="3cca" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">太好了！</p><p id="c5e2" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><code class="fe kw kx ky kz b">rate()</code></p><p id="d083" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">让我们试着调用类似于<code class="fe kw kx ky kz b">rate()</code> + regex的东西来从<code class="fe kw kx ky kz b">dnsmasq</code>的日志中选择主机名:</p><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nn"><img src="../Images/5b9a0b2ef63dcda104fa4f2800691a41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pAFO8EWve3wNGubY.png"/></div></div></figure><p id="0cdc" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><em class="lo">“管用！”</em></p><p id="a41c" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">顺便说一下，当你开始输入时，Grafana会显示函数及其描述:</p><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi no"><img src="../Images/272be470c3d7a8500e51fc3d5b7e5147.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wO7_XIW3eydC_SCY.png"/></div></div></figure><h2 id="1016" class="lp lq it bd lr ls lt dn lu lv lw dp lx ki ly lz ma km mb mc md kq me mf mg mh bi translated"><code class="fe kw kx ky kz b">promtail</code>管道阶段</h2><p id="3670" class="pw-post-body-paragraph jx jy it jz b ka mi kc kd ke mj kg kh ki mk kk kl km ml ko kp kq mm ks kt ku im bi translated">还有一个新的(？)有趣的事情发生在<code class="fe kw kx ky kz b">promtail</code>——记不清是一年前了——<em class="lo">管道赛段</em>。</p><p id="7bc7" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这里的文献资料是<a class="ae kv" href="https://github.com/grafana/loki/blob/master/docs/clients/promtail/pipelines.md" rel="noopener ugc nofollow" target="_blank">&gt;&gt;&gt;</a>。</p><p id="5cf7" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在其原始版本中:</p><blockquote class="np nq nr"><p id="9c8c" class="jx jy lo jz b ka kb kc kd ke kf kg kh ns kj kk kl nt kn ko kp nu kr ks kt ku im bi translated">管道用于转换单个日志行、其标签和时间戳。流水线由一组<strong class="jz iu">阶段</strong>组成。有4种类型的阶段:</p></blockquote><ol class=""><li id="90df" class="la lb it jz b ka kb ke kf ki lc km ld kq le ku nv lg lh li bi translated"><strong class="jz iu">解析阶段</strong>解析当前日志行并从中提取数据。然后，提取的数据可供其他阶段使用。</li><li id="fdd1" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku nv lg lh li bi translated"><strong class="jz iu">变换阶段</strong>变换从先前阶段提取的数据。</li><li id="c64a" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku nv lg lh li bi translated"><strong class="jz iu">行动阶段</strong>从之前的阶段提取数据，并对其进行处理。行动可以:</li><li id="dee3" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku nv lg lh li bi translated">向日志行添加或修改现有标签</li><li id="97e1" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku nv lg lh li bi translated">更改日志行的时间戳</li><li id="1b7a" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku nv lg lh li bi translated">更改日志行的内容</li><li id="3752" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku nv lg lh li bi translated">基于提取的数据创建指标</li></ol><blockquote class="np nq nr"><p id="f861" class="jx jy lo jz b ka kb kc kd ke kf kg kh ns kj kk kl nt kn ko kp nu kr ks kt ku im bi translated"><strong class="jz iu">过滤阶段</strong>根据某些条件选择性地应用阶段子集或删除条目。</p></blockquote><p id="3fa8" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">因此，简而言之，你可以建立一个多类型阶段的数据管道。</p><p id="bb3e" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">阶段可以是:</p><ol class=""><li id="d210" class="la lb it jz b ka kb ke kf ki lc km ld kq le ku nv lg lh li bi translated"><em class="lo">解析阶段</em>:将解析日志并提取数据，然后将其传递给下一个阶段</li><li id="3173" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku nv lg lh li bi translated"><em class="lo">转换阶段</em>:将转换前一阶段的数据</li><li id="7be0" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku nv lg lh li bi translated"><em class="lo">动作阶段</em>:从前一阶段接收数据，并能:</li></ol><ul class=""><li id="abd9" class="la lb it jz b ka kb ke kf ki lc km ld kq le ku lf lg lh li bi translated">添加/移除标签</li><li id="5cc0" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated">更改时间戳</li><li id="f6e2" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated">更改日志的行</li><li id="cd37" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated">基于提取的数据创建指标</li></ul><blockquote class="np nq nr"><p id="fc7b" class="jx jy lo jz b ka kb kc kd ke kf kg kh ns kj kk kl nt kn ko kp nu kr ks kt ku im bi translated">典型的管道从一个解析阶段开始(比如一个<a class="ae kv" href="https://github.com/grafana/loki/blob/master/docs/clients/promtail/stages/regex.md" rel="noopener ugc nofollow" target="_blank"> regex </a>或<a class="ae kv" href="https://github.com/grafana/loki/blob/master/docs/clients/promtail/stages/json.md" rel="noopener ugc nofollow" target="_blank"> json </a>阶段),从日志行中提取数据。然后，将出现一系列操作阶段，对提取的数据做一些事情。最常见的操作阶段是<a class="ae kv" href="https://github.com/grafana/loki/blob/master/docs/clients/promtail/stages/labels.md" rel="noopener ugc nofollow" target="_blank">标签</a>阶段，用于将提取的数据转换为标签。</p></blockquote></div><div class="ab cl nw nx hx ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="im in io ip iq"><p id="397d" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">让我们回到整个故事的最开始——我们想要实现什么？</p><p id="fdfc" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我们希望获取对我们的<code class="fe kw kx ky kz b">dnsmasq</code>的所有请求，提取主机名并显示一个图表——对一个特定的域名执行了多少请求。</p><p id="c0d2" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">因此，需要:</p><ul class=""><li id="46e6" class="la lb it jz b ka kb ke kf ki lc km ld kq le ku lf lg lh li bi translated">抓取所有请求</li><li id="8d42" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated">将每个保存到一个标签</li><li id="646a" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated">数一数</li></ul><p id="cb5b" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">转到生产和添加阶段的<code class="fe kw kx ky kz b">promtail</code>-更新<code class="fe kw kx ky kz b">promtail-dev.yml</code>配置文件:</p><pre class="mn mo mp mq gt mr kz ms mt aw mu bi"><span id="3717" class="lp lq it kz b gy mv mw l mx my">server:<br/><br/>  http_listen_port: 9080<br/>  grpc_listen_port: 0<br/><br/>positions:<br/>  filename: /tmp/positions.yaml<br/><br/>client:<br/><br/>  url: <a class="ae kv" href="http://dev.loki.example.com:3100/loki/api/v1/push" rel="noopener ugc nofollow" target="_blank">http://dev.loki.example.com:3100/loki/api/v1/push</a><br/><br/>scrape_configs:<br/><br/>  - job_name: dnsmasq<br/>    static_configs:<br/>    - targets:<br/>        - localhost<br/>      labels:<br/>        job: dnsmasq<br/>        env: production<br/>        host: bttrm-prod-console<br/>        __path__: /var/log/dnsmasq.log<br/><br/>    pipeline_stages:<br/>    - match:<br/>        selector: '{job="dnsmasq"}'<br/>        stages:<br/>        - regex:<br/>            expression: ".*query\\[A\\] (?P&lt;query&gt;.*\\s)"<br/>        - labels:<br/>            query:</span></pre><p id="19b5" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在<code class="fe kw kx ky kz b">pipeline_stages</code>这里我们:</p><ol class=""><li id="0adc" class="la lb it jz b ka kb ke kf ki lc km ld kq le ku nv lg lh li bi translated">选择了<code class="fe kw kx ky kz b">dnsmasq</code>的工作</li><li id="1263" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku nv lg lh li bi translated">创建一个regex阶段，该阶段使用<em class="lo">查询【A】</em>字符串选择所有行</li><li id="9a73" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku nv lg lh li bi translated">创建一个名为<em class="lo"> query </em>的正则表达式组，将结果字符串保存到第一个空格<br/>处，即字符串的来源可能是:<br/><em class="lo">11月16日08:23:33 dnsmasq[17597]:从127.0.0.1 </em> <br/>中查询[A]backend-db3-master.example.com，在<em class="lo">查询</em>中正则表达式组将获得值:<br/><em class="lo">backend-db3-master.example.com</em></li><li id="ae7c" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku nv lg lh li bi translated">创建一个<code class="fe kw kx ky kz b">labels</code>阶段，该阶段将附加一个名为<em class="lo">查询</em>的新标签，其<em class="lo">backend-db3-master.example.com</em>值取自<em class="lo">查询</em>正则表达式组</li></ol><p id="7188" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">运行<code class="fe kw kx ky kz b">promtail</code>:</p><pre class="mn mo mp mq gt mr kz ms mt aw mu bi"><span id="ddb9" class="lp lq it kz b gy mv mw l mx my">root@bttrm-production-console:/home/admin# docker run -ti -v /opt/prometheus-client/promtail-dev.yml:/etc/promtail/promtail.yml -v /var/log:/var/log grafana/promtail:master-2739551 -config.file=/etc/promtail/promtail.yml<br/>level=info ts=2019–11–16T11:56:29.760425279Z caller=server.go:121 http=[::]:9080 grpc=[::]:32945 msg=”server listening on addresses”<br/>level=info ts=2019–11–16T11:56:29.760565845Z caller=main.go:65 msg=”Starting Promtail” version=”(version=, branch=, revision=)”<br/>level=info ts=2019–11–16T11:56:34.760567558Z caller=filetargetmanager.go:257 msg=”Adding target” key=”{env=\”production\”, host=\”bttrm-prod-console\”, job=\”dnsmasq\”}”<br/>level=info ts=2019–11–16T11:56:34.760752715Z caller=tailer.go:77 component=tailer msg=”start tailing file” path=/var/log/dnsmasq.log<br/>ts=2019–11–16T11:56:34.760863031Z caller=log.go:124 component=tailer level=info msg=”Seeked /var/log/dnsmasq.log — &amp;{Offset:0 Whence:0}”</span></pre><p id="6fff" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">查看Grafana的图表:</p><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi od"><img src="../Images/dc947e202e6271c32ba4c6baae6f7c55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JbXEb_eScKAtmwTC.png"/></div></div></figure><p id="9951" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">并创建如下查询:</p><pre class="mn mo mp mq gt mr kz ms mt aw mu bi"><span id="ba58" class="lp lq it kz b gy mv mw l mx my">sum (rate( ( {env="production",query=~".*\\..*"} )[5m] )) by (query)</span></pre><p id="3054" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在<code class="fe kw kx ky kz b">query=~".*\\..*"</code>中，我不得不创建一个“crunch”来删除没有查询标签的数据，但我想这肯定是一个更正确的方法。现在-我可以离开这东西。</p><p id="4d57" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">让我们看看结果:</p><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi od"><img src="../Images/3e4f29210fb56f8429c99b9f91328049.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lcq94eY-tnXTXLJ9.png"/></div></div></figure><p id="9167" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">厉害！</p><p id="2549" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">嗯…</p><p id="54f7" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">主机名是来自字符串的<em class="lo">…</em></p><p id="c8af" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">为什么？</p><p id="acd6" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">使用<a class="ae kv" href="https://regex101.com" rel="noopener ugc nofollow" target="_blank">https://regex101.com</a>，修复正则表达式，结果是:</p><pre class="mn mo mp mq gt mr kz ms mt aw mu bi"><span id="5dc7" class="lp lq it kz b gy mv mw l mx my">.*query\[A\] (?P&lt;query&gt;[^\s]+)</span></pre><p id="2dcb" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">更新<code class="fe kw kx ky kz b">promtail</code>的配置:</p><pre class="mn mo mp mq gt mr kz ms mt aw mu bi"><span id="fb42" class="lp lq it kz b gy mv mw l mx my">...<br/>    pipeline_stages:<br/>    - match:<br/>        selector: '{job="dnsmasq"}'<br/>        stages:<br/>        - regex:<br/>            expression: ".*query\\[A\\] (?P&lt;query&gt;[^\\s]+)"<br/>        - labels:<br/>            query:</span></pre><h2 id="3605" class="lp lq it bd lr ls lt dn lu lv lw dp lx ki ly lz ma km mb mc md kq me mf mg mh bi translated">Grafana DNS仪表板</h2><p id="b1eb" class="pw-post-body-paragraph jx jy it jz b ka mi kc kd ke mj kg kh ki mk kk kl km ml ko kp kq mm ks kt ku im bi translated">好的，总的来说——我们看到它会起作用。现在，让我们尝试创建一个仪表板，将所有DNS请求统计数据放在一个漂亮的图表中。</p><p id="80a8" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">点击<em class="lo">添加查询</em>:</p><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi oe"><img src="../Images/d24f6b21af1ee241e9888056e83ac15e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0n1sIDaC9Dtie_v8.png"/></div></div></figure><p id="e8f0" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">添加我们的查询:</p><pre class="mn mo mp mq gt mr kz ms mt aw mu bi"><span id="223a" class="lp lq it kz b gy mv mw l mx my">sum (rate( ( {env="production", query=~".*\\..*"} )[5m] )) by (query)</span></pre><p id="93f6" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在<em class="lo">图例</em>中，使用替换{{ query }}仅显示值:</p><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi of"><img src="../Images/1ee296f4a421d18164e4fcd1937a82bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BvmPt57-kKFtR1ql.png"/></div></div></figure><p id="23eb" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">好吧，还不错…</p><p id="1e1a" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">让我们添加一些变量，使选择查询成为可能。</p><p id="a93c" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">进入<em class="lo">仪表盘设置&gt;变量&gt;添加变量</em>，然后…</p><p id="9af1" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">Loki仍然不支持模板变量:-(</p><p id="9338" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">或者我只是没有找到为Loki执行<code class="fe kw kx ky kz b">label_values()</code>的正确方法...</p><p id="5938" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">文档在这里是<a class="ae kv" href="https://grafana.com/docs/features/datasources/prometheus/#templating" rel="noopener ugc nofollow" target="_blank">&gt;&gt;&gt;</a>。</p><p id="8c7f" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我想创建一个包含来自<code class="fe kw kx ky kz b">query</code>标签的值的变量，以便能够选择一个特定的域名，但是——唉...</p><p id="82a9" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">好了，现在，我们可以做一个简单的过滤——用<em class="lo">文本框</em>类型创建一个变量:</p><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi og"><img src="../Images/fa9adc495cff17418534bb550802edd7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-yDwvf6VGWg3RuRE.png"/></div></div></figure><p id="a18a" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">并选择一个环境—创建一个<em class="lo">自定义</em>类型变量:</p><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi og"><img src="../Images/325d6632becc758ecba7ad3906d13b36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xoEVaMfbScNMimCt.png"/></div></div></figure><p id="5532" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">回到查询，更新它以使用这些变量:</p><pre class="mn mo mp mq gt mr kz ms mt aw mu bi"><span id="1ea0" class="lp lq it kz b gy mv mw l mx my">sum (rate( ( {env="$env", query=~"$include"} )[5m] )) by (query)</span></pre><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi oh"><img src="../Images/fe30bcef42c22e443e9727def0023c7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MLRjQzDSyTyPEoj_.png"/></div></div></figure><p id="dd21" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">并按域用过滤器测试它:</p><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi oh"><img src="../Images/17e55efda7f9bdc1578fcf7c7625543c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zvgfx0VFABJG2l-9.png"/></div></div></figure><p id="113a" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">结果是Grafana仪表板，其中包含主机名DNS请求的统计信息:</p><figure class="mn mo mp mq gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi oi"><img src="../Images/247338a419ccb6041af0a2b352871358.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9-Rr81NbCMHNNFnX.png"/></div></div></figure><h2 id="6b2a" class="lp lq it bd lr ls lt dn lu lv lw dp lx ki ly lz ma km mb mc md kq me mf mg mh bi translated">有用的链接</h2><ul class=""><li id="9e14" class="la lb it jz b ka mi ke mj ki oj km ok kq ol ku lf lg lh li bi translated"><a class="ae kv" href="https://grafana.com/docs/features/explore/" rel="noopener ugc nofollow" target="_blank">格拉夫纳探索</a></li><li id="cd3b" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated"><a class="ae kv" href="https://www.bookstack.cn/read/grafana-v6.2/f30923b9a8c5198a.md" rel="noopener ugc nofollow" target="_blank">在Grafana中使用Loki</a></li><li id="5798" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated"><a class="ae kv" href="https://github.com/grafana/loki/blob/master/docs/logql.md" rel="noopener ugc nofollow" target="_blank"> LogQL:日志查询语言</a></li><li id="7e75" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated"><a class="ae kv" href="https://github.com/grafana/loki/blob/master/docs/design-documents/labels.md" rel="noopener ugc nofollow" target="_blank">来自日志的标签</a></li><li id="7fb8" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated">洛基的HTTP API </li><li id="b126" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated"><a class="ae kv" href="https://github.com/grafana/loki/blob/master/docs/clients/promtail/configuration.md" rel="noopener ugc nofollow" target="_blank">配置提示信息</a></li><li id="a137" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated"><a class="ae kv" href="https://github.com/grafana/loki/blob/master/docs/clients/promtail/pipelines.md" rel="noopener ugc nofollow" target="_blank">前置管线</a></li><li id="8288" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated"><a class="ae kv" href="https://www.regular-expressions.info/refext.html" rel="noopener ugc nofollow" target="_blank">正则表达式引用:命名组和反向引用</a></li><li id="7444" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated"><a class="ae kv" href="https://rtfm.co.ua/en/grafana-labs-loki-distributed-system-labels-and-filters/" rel="noopener ugc nofollow" target="_blank">Grafana Labs:Loki——分布式系统、标签和过滤器</a></li><li id="574e" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated"><a class="ae kv" href="https://rtfm.co.ua/en/grafana-labs-loki-using-aws-s3-as-a-data-storage-and-aws-dynamodb-for-indexes/" rel="noopener ugc nofollow" target="_blank">Grafana Labs:Loki——使用AWS S3作为数据存储，使用AWS DynamoDB作为索引</a></li><li id="63aa" class="la lb it jz b ka lj ke lk ki ll km lm kq ln ku lf lg lh li bi translated"><a class="ae kv" href="https://rtfm.co.ua/en/prometheus-rtfm-blog-monitoring-set-up-with-ansible-grafana-loki-and-promtail/" rel="noopener ugc nofollow" target="_blank">普罗米修斯:用ansi ble-Grafana、Loki和promtail设置RTFM博客监控</a></li></ul></div><div class="ab cl nw nx hx ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="im in io ip iq"><p id="1933" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><em class="lo">最初发布于</em> <a class="ae kv" href="https://rtfm.co.ua/en/grafana-loki-the-logqls-prometheus-like-counters-aggregation-functions-and-dnsmasqs-requests-graphs/" rel="noopener ugc nofollow" target="_blank"> <em class="lo"> RTFM: Linux、DevOps和系统管理</em> </a> <em class="lo">。</em></p></div></div>    
</body>
</html>