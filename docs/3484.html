<html>
<head>
<title>Install OpenShift 4.2 on KVM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在KVM上安装OpenShift 4.2</h1>
<blockquote>原文：<a href="https://itnext.io/install-openshift-4-2-on-kvm-1117162333d0?source=collection_archive---------2-----------------------#2019-12-24">https://itnext.io/install-openshift-4-2-on-kvm-1117162333d0?source=collection_archive---------2-----------------------#2019-12-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="74ac" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">假设我们有一个足够大的盒子，让我们使用KVM创建和管理的虚拟机来设置OpenShift容器平台(OCP) 4.2。</p><h2 id="63f5" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">架构考虑</h2><p id="5606" class="pw-post-body-paragraph jq jr it js b jt lh jv jw jx li jz ka kb lj kd ke kf lk kh ki kj ll kl km kn im bi translated">OCP 4.2需要DHCP和网络启动，它还需要成熟的DNS功能来提供A、PTR和SRV记录。科索沃核查团能够满足其中一些要求，但不能完全满足。因此，我们将使用外部DNS、DHCP服务来完全满足这些要求。我使用<strong class="js iu"> Dnsmasq </strong>作为DNS、DHCP和netboot服务器。另外，<a class="ae lm" href="https://github.com/poseidon/matchbox" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">火柴盒</strong> </a>用于分别为不同的节点角色提供CoreOS启动时的点火。</p><p id="948a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在KVM内部，我们调配虚拟机以形成OCP集群。OCP 4.2要求负载平衡器为API (6443)、机器配置服务(22623)、应用程序HTTP和HTTPS分配负载。我在集群中使用了一个最小化的Ubuntu VM作为负载均衡器，以避免不必要的内部流量通过外部。我在 之间选择L4 LB软件<strong class="js iu"> g </strong> <a class="ae lm" href="https://github.com/yyyar/gobetween" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">。</strong></a></p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div class="gh gi ln"><img src="../Images/b216428b25c05e3dcfda8e78960bae5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1270/format:webp/1*LCRBrY9C27X6NQhl7eKK9w.png"/></div></figure><p id="0fb6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">设置好OCP集群后，为了从KVM主机服务器访问集群，我们需要一个L7反向代理来根据主机信息将流量重定向到底层的OCP集群。这里我用的是<a class="ae lm" href="https://github.com/containous/traefik" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu"> traefik </strong> </a>。</p><p id="bf38" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在下一节中，我将介绍</p><ul class=""><li id="03f3" class="lv lw it js b jt ju jx jy kb lx kf ly kj lz kn ma mb mc md bi translated">KVM设置</li><li id="003e" class="lv lw it js b jt me jx mf kb mg kf mh kj mi kn ma mb mc md bi translated">Dnsmasq设置和常见配置</li><li id="c403" class="lv lw it js b jt me jx mf kb mg kf mh kj mi kn ma mb mc md bi translated">配置Ubuntu使用本地Dnsmasq</li><li id="07ad" class="lv lw it js b jt me jx mf kb mg kf mh kj mi kn ma mb mc md bi translated">Dnsmasq特定于群集的配置</li><li id="e7e2" class="lv lw it js b jt me jx mf kb mg kf mh kj mi kn ma mb mc md bi translated">火柴盒设置</li><li id="4360" class="lv lw it js b jt me jx mf kb mg kf mh kj mi kn ma mb mc md bi translated">负载平衡器虚拟机和Gobetween配置</li><li id="c8ef" class="lv lw it js b jt me jx mf kb mg kf mh kj mi kn ma mb mc md bi translated">OCP安装配置</li><li id="e9a4" class="lv lw it js b jt me jx mf kb mg kf mh kj mi kn ma mb mc md bi translated">OCP VMs</li><li id="38aa" class="lv lw it js b jt me jx mf kb mg kf mh kj mi kn ma mb mc md bi translated">OCP集群引导并完成安装</li><li id="907d" class="lv lw it js b jt me jx mf kb mg kf mh kj mi kn ma mb mc md bi translated">OCP身份验证配置</li><li id="c88e" class="lv lw it js b jt me jx mf kb mg kf mh kj mi kn ma mb mc md bi translated">Traefik配置</li></ul><h2 id="2f35" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">KVM设置</h2><p id="818c" class="pw-post-body-paragraph jq jr it js b jt lh jv jw jx li jz ka kb lj kd ke kf lk kh ki kj ll kl km kn im bi translated">在主机操作系统Ubuntu 18.04上安装KVM。</p><p id="1d80" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，验证此计算机是否支持KVM。运行以下命令</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="e763" class="ko kp it mk b gy mo mp l mq mr">sudo apt install -y cpu-checker<br/>sudo kvm-ok</span></pre><p id="c0d0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果我们看到下面的输出，那么KVM就可以安装和使用了。</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="e78f" class="ko kp it mk b gy mo mp l mq mr">INFO: /dev/kvm exists<br/>KVM acceleration can be used</span></pre><p id="04d3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">安装KVM，启动它</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="542d" class="ko kp it mk b gy mo mp l mq mr">sudo apt install -y libosinfo-bin<br/>sudo apt -y install qemu qemu-kvm libvirt-bin bridge-utils virt-manager</span><span id="6081" class="ko kp it mk b gy ms mp l mq mr">sudo systemctl enable libvirtd<br/>sudo systemctl start libvirtd</span></pre><p id="4e47" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，安装<a class="ae lm" href="http://manpages.ubuntu.com/manpages/bionic/man1/uvt-kvm.1.html" rel="noopener ugc nofollow" target="_blank"> uvt-kvm </a>工具并在本地同步Ubuntu 18.04，以便我们可以轻松创建基于Ubuntu的虚拟机。</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="bf75" class="ko kp it mk b gy mo mp l mq mr">sudo apt -y install uvtool</span><span id="5846" class="ko kp it mk b gy ms mp l mq mr">sudo uvt-simplestreams-libvirt --verbose sync release=bionic arch=amd64</span><span id="0adc" class="ko kp it mk b gy ms mp l mq mr"># create the key to access the VM<br/>ssh-keygen -b 4096 -t rsa -f ~/.ssh/id_rsa -N ""</span></pre><p id="1e07" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建一个KVM网络，但是禁用DNS和DHCP<em class="mt">(IP元素中没有DHCP设置)</em>，如下面的XML文件<code class="fe mu mv mw mk b">net_ocp.xml</code>所示</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="bf12" class="ko kp it mk b gy mo mp l mq mr">&lt;network&gt;<br/>  &lt;name&gt;ocp&lt;/name&gt;<br/>  &lt;forward mode='nat'/&gt;<br/>  &lt;bridge name='br-ocp' stp='on' delay='0'/&gt;<br/>  &lt;dns enable="no"/&gt; <br/>  &lt;ip address='192.168.10.1' netmask='255.255.255.0'&gt;<br/>  &lt;/ip&gt;<br/>&lt;/network&gt;</span></pre><p id="627d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">定义网络并使其自动启动。</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="4d39" class="ko kp it mk b gy mo mp l mq mr">virsh net-define net_ocp.xml<br/>virsh net-autostart ocp<br/>virsh net-start ocp</span><span id="bada" class="ko kp it mk b gy ms mp l mq mr">systemctl restart libvirt-bin</span></pre><p id="93b5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">虚拟网桥被创建</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="65b4" class="ko kp it mk b gy mo mp l mq mr"># ifconfig  br-ocp<br/>br-ocp: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500<br/>        inet 192.168.10.1  netmask 255.255.255.0  broadcast 192.168.10.255<br/>        ether 52:54:00:d1:12:f6  txqueuelen 1000  (Ethernet)<br/>        RX packets 43449450  bytes 37736240429 (37.7 GB)<br/>        RX errors 0  dropped 0  overruns 0  frame 0<br/>        TX packets 54047625  bytes 179923041069 (179.9 GB)<br/>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span></pre><h2 id="8f16" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated"><strong class="ak"> Dnsmasq设置和通用配置</strong></h2><p id="a9f9" class="pw-post-body-paragraph jq jr it js b jt lh jv jw jx li jz ka kb lj kd ke kf lk kh ki kj ll kl km kn im bi translated">在KVM主机上，安装Dnsmasq和所需的tftp、ipxe。</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="8807" class="ko kp it mk b gy mo mp l mq mr">sudo apt install -y dnsmasq<br/>sudo systemctl enable dnsmasq<br/>sudo systemctl start dnsmasq</span><span id="acfd" class="ko kp it mk b gy ms mp l mq mr">sudo apt -y install ipxe<br/>sudo mkdir -p /var/lib/tftp<br/>sudo cp /usr/lib/ipxe/{undionly.kpxe,ipxe.efi} /var/lib/tftp<br/>sudo chown dnsmasq:nogroup /var/lib/tftp/*</span></pre><p id="4359" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建文件<code class="fe mu mv mw mk b">/etc/dnsmasq.d/common.conf</code>，该文件定义了不同OCP集群的公共部分。</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="9fa2" class="ko kp it mk b gy mo mp l mq mr"># Listen on lo and br-ocp only<br/>bind-interfaces<br/>interface=lo,br-ocp</span><span id="77eb" class="ko kp it mk b gy ms mp l mq mr"># DHCP<br/>dhcp-option=option:router,192.168.10.1<br/>dhcp-option=option:dns-server,192.168.10.1<br/>dhcp-range=192.168.10.10,192.168.10.254,12h</span><span id="4a4b" class="ko kp it mk b gy ms mp l mq mr"># forward, use original DNS server<br/>server=10.0.xxx.xxx<br/>server=10.0.xxx.xxx</span><span id="fb56" class="ko kp it mk b gy ms mp l mq mr">enable-tftp<br/>tftp-root=/var/lib/tftp<br/>tftp-secure</span><span id="b315" class="ko kp it mk b gy ms mp l mq mr"># Legacy PXE<br/>dhcp-match=set:bios,option:client-arch,0<br/>dhcp-boot=tag:bios,undionly.kpxe</span><span id="b35c" class="ko kp it mk b gy ms mp l mq mr"># UEFI<br/>dhcp-match=set:efi32,option:client-arch,6<br/>dhcp-boot=tag:efi32,ipxe.efi<br/>dhcp-match=set:efibc,option:client-arch,7<br/>dhcp-boot=tag:efibc,ipxe.efi<br/>dhcp-match=set:efi64,option:client-arch,9<br/>dhcp-boot=tag:efi64,ipxe.efi</span><span id="b45b" class="ko kp it mk b gy ms mp l mq mr"># iPXE - chainload to matchbox ipxe boot script<br/>dhcp-userclass=set:ipxe,iPXE<br/># matchbox can be shared across different cluster<br/>dhcp-boot=tag:ipxe,<a class="ae lm" href="http://matchbox.ibmcloud.io.cpak:8080/boot.ipxe" rel="noopener ugc nofollow" target="_blank">http://matchbox.ibmcloud.io.cpak:8080/boot.ipxe</a></span><span id="7d23" class="ko kp it mk b gy ms mp l mq mr">address=/matchbox.ibmcloud.io.cpak/192.168.10.1</span></pre><p id="7deb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">只监听<code class="fe mu mv mw mk b">lo</code>和<code class="fe mu mv mw mk b">br-ocp</code>接口。</p><p id="8798" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">定义DHCP默认路由和默认DNS服务器。</p><p id="9fa6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将iPXE链接到火柴盒服务器，<code class="fe mu mv mw mk b">matchbox.ibmcloud.io.cpak</code>，我们将安装它并让它在桥接口上监听。为它定义DNS条目，以便虚拟机能够在netboot期间解析火柴盒服务器。</p><h2 id="f8c0" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated"><strong class="ak">配置Ubuntu使用本地Dnsmasq </strong></h2><p id="b729" class="pw-post-body-paragraph jq jr it js b jt lh jv jw jx li jz ka kb lj kd ke kf lk kh ki kj ll kl km kn im bi translated">此外，将Ubuntu服务器(18.04)配置为使用此DNS服务器。</p><p id="452a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">重命名传统的resolv.conf文件，因为ping等一些传统应用程序仍在使用此配置。</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="ae48" class="ko kp it mk b gy mo mp l mq mr">mv /etc/resolv.conf  /etc/resolv.conf.orig</span></pre><p id="ef35" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">备份和替换文件<code class="fe mu mv mw mk b">/etc/systemd/resolved.conf</code>与内容、</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="5de1" class="ko kp it mk b gy mo mp l mq mr">[Resolve]<br/>DNS=127.0.0.1</span></pre><p id="232d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">重新启动systemd解决的服务</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="ba12" class="ko kp it mk b gy mo mp l mq mr">sudo systemctl restart systemd-resolved <br/>systemd-resolve --status</span></pre><p id="d500" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在KVM主机将使用本地Dnsmasq作为它的DNS服务器。</p><h2 id="9d75" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated"><strong class="ak"> Dnsmasq集群特定配置</strong></h2><p id="5245" class="pw-post-body-paragraph jq jr it js b jt lh jv jw jx li jz ka kb lj kd ke kf lk kh ki kj ll kl km kn im bi translated">对于要在KVM中创建的每个OCP集群，创建一个Dnsmasq配置文件，例如<code class="fe mu mv mw mk b">/etc/dnsmasq.d/exp-ocp4.conf</code>。</p><p id="0d4a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在该文件中，为集群中的每个虚拟机定义以下内容</p><ol class=""><li id="fa39" class="lv lw it js b jt ju jx jy kb lx kf ly kj lz kn mx mb mc md bi translated">按MAC地址划分的DHCP Ip地址</li><li id="a0bf" class="lv lw it js b jt me jx mf kb mg kf mh kj mi kn mx mb mc md bi translated">DNS A记录</li><li id="e3ef" class="lv lw it js b jt me jx mf kb mg kf mh kj mi kn mx mb mc md bi translated">DNS PTR记录。这是RHCOS设置其主机名所必需的。</li></ol><p id="93ab" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面列出了一个示例片段，</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="e2c9" class="ko kp it mk b gy mo mp l mq mr">dhcp-host=52:54:00:25:2e:77,192.168.10.40<br/>address=/exp-bootstrap.exp-ocp4.ibmcloud.io.cpak/192.168.10.40<br/>ptr-record=40.10.168.192.in-addr.arpa,exp-bootstrap.exp-ocp4.ibmcloud.io.cpak</span></pre><p id="dded" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来定义指向LB的集群DNS记录，包括应用程序的通配符记录。</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="9451" class="ko kp it mk b gy mo mp l mq mr">address=/api.exp-ocp4.ibmcloud.io.cpak/192.168.10.49<br/>address=/api-int.exp-ocp4.ibmcloud.io.cpak/192.168.10.49<br/>address=/.apps.exp-ocp4.ibmcloud.io.cpak/192.168.10.49</span></pre><p id="ea1e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，为每个etcd实例定义A和SRV记录。如果3个主机中各有一个etcd成员，则</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="a5f2" class="ko kp it mk b gy mo mp l mq mr">address=/etcd-0.exp-ocp4.ibmcloud.io.cpak/192.168.10.41<br/>srv-host=_etcd-server-ssl._tcp.exp-ocp4.ibmcloud.io.cpak,etcd-0.exp-ocp4.ibmcloud.io.cpak,2380</span><span id="e7fb" class="ko kp it mk b gy ms mp l mq mr">address=/etcd-1.exp-ocp4.ibmcloud.io.cpak/192.168.10.42<br/>srv-host=_etcd-server-ssl._tcp.exp-ocp4.ibmcloud.io.cpak,etcd-1.exp-ocp4.ibmcloud.io.cpak,2380</span><span id="064d" class="ko kp it mk b gy ms mp l mq mr">address=/etcd-2.exp-ocp4.ibmcloud.io.cpak/192.168.10.43<br/>srv-host=_etcd-server-ssl._tcp.exp-ocp4.ibmcloud.io.cpak,etcd-2.exp-ocp4.ibmcloud.io.cpak,2380</span></pre><p id="147b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">重新启动Dnsmasq服务以使更改生效。在重新启动服务之前，我们可能需要清除租用缓存，以确保DHCP Ip分配没有被缓存。</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="be1d" class="ko kp it mk b gy mo mp l mq mr">sudo rm -rf /var/lib/misc/dnsmasq.leases <br/>sudo touch /var/lib/misc/dnsmasq.leases</span><span id="166c" class="ko kp it mk b gy ms mp l mq mr">sudo systemctl restart dnsmasq</span></pre><h2 id="ee79" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated"><strong class="ak">火柴盒设置</strong></h2><p id="0c62" class="pw-post-body-paragraph jq jr it js b jt lh jv jw jx li jz ka kb lj kd ke kf lk kh ki kj ll kl km kn im bi translated">在KVM主机上安装火柴盒并进行设置，</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="f52c" class="ko kp it mk b gy mo mp l mq mr">curl -LO <a class="ae lm" href="https://github.com/poseidon/matchbox/releases/download/v0.8.3/matchbox-v0.8.3-linux-amd64.tar.gz" rel="noopener ugc nofollow" target="_blank">https://github.com/poseidon/matchbox/releases/download/v0.8.3/matchbox-v0.8.3-linux-amd64.tar.gz</a> <br/>tar zxvf matchbox-v0.8.3-linux-amd64.tar.gz<br/>cd matchbox-v0.8.3-linux-amd64<br/>sudo cp matchbox /usr/local/bin</span><span id="90cc" class="ko kp it mk b gy ms mp l mq mr">sudo useradd -U matchbox<br/>sudo mkdir -p /var/lib/matchbox/{assets,groups,ignition,profiles}<br/>sudo chown -R matchbox:matchbox /var/lib/matchbox<br/>sudo cp contrib/systemd/matchbox-local.service /etc/systemd/system/matchbox.service</span><span id="97d3" class="ko kp it mk b gy ms mp l mq mr">sudo systemctl enable matchbox<br/>sudo systemctl start matchbox</span></pre><p id="fc2f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="mt">资产</em> </strong></p><p id="30f6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将RHCOS映像下载到资产目录中，</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="148c" class="ko kp it mk b gy mo mp l mq mr">cd /var/lib/matchbox/assets<br/>  <br/>sudo axel -o rhcos-{{ .ver }}.0-x86_64-installer-initramfs.img <a class="ae lm" href="https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/{{" rel="noopener ugc nofollow" target="_blank">https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/{{</a> .ver }}/latest/rhcos-{{ .ver }}.0-x86_64-installer-initramfs.img</span><span id="8060" class="ko kp it mk b gy ms mp l mq mr">sudo axel -o rhcos-{{ .ver }}.0-x86_64-installer-kernel <a class="ae lm" href="https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/{{" rel="noopener ugc nofollow" target="_blank">https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/{{</a> .ver }}/latest/rhcos-{{ .ver }}.0-x86_64-installer-kernel</span><span id="d1d5" class="ko kp it mk b gy ms mp l mq mr">sudo axel -o rhcos-{{ .ver }}.0-x86_64-metal-bios.raw.gz <a class="ae lm" href="https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/{{" rel="noopener ugc nofollow" target="_blank">https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/{{</a> .ver }}/latest/rhcos-{{ .ver }}.0-x86_64-metal-bios.raw.gz</span><span id="a9d2" class="ko kp it mk b gy ms mp l mq mr">sudo chown -R matchbox:matchbox /var/lib/matchbox</span></pre><p id="c35f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mt">我使用的是Golang模板格式。{{ .ver }}可能是4.2.0 </em></p><p id="5942" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">组<em class="mt">组</em>组</strong></p><p id="0d53" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于每个虚拟机，根据其Mac地址准备组文件。例如，<code class="fe mu mv mw mk b">/var/lib/matchbox/groups/exp-master1.json</code></p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="f698" class="ko kp it mk b gy mo mp l mq mr">{<br/>  "id": "exp-master1",<br/>  "name": "exp-master1",<br/>  "profile": "exp-master1",<br/>  "selector": {<br/>    "mac": "52:54:00:34:c7:90"<br/>  }<br/>}</span></pre><p id="0a4d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="mt">简介</em> </strong></p><p id="3ed5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为每个虚拟机准备其配置文件。例如，对于第一个主虚拟机exp-master1，创建以下内容并将其另存为<code class="fe mu mv mw mk b">/var/lib/matchbox/profiles/exp-master1.json</code></p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="6f21" class="ko kp it mk b gy mo mp l mq mr">{<br/>  "id": "exp-master1",<br/>  "name": "exp-master1",<br/>  "ignition_id": "master.ign",<br/>  "boot": {<br/>    "kernel": "/assets/rhcos-4.2.0-x86_64-installer-kernel",<br/>    "initrd": [<br/>      "/assets/rhcos-4.2.0-x86_64-installer-initramfs.img"<br/>      ],<br/>      "args": [<br/>        "ip=dhcp",<br/>        "rd.neednet=1",<br/>        "console=tty0",<br/>        "console=ttyS0",<br/>        "coreos.inst=yes",<br/>        "coreos.inst.install_dev=<strong class="mk iu">vda</strong>",<br/>        "coreos.inst.image_url=<a class="ae lm" href="http://matchbox.ibmcloud.io.cpak:8080/assets/rhcos-4.2.0-x86_64-metal-bios.raw.gz" rel="noopener ugc nofollow" target="_blank">http://matchbox.ibmcloud.io.cpak:8080/assets/rhcos-4.2.0-x86_64-metal-bios.raw.gz</a>",<br/>        "coreos.inst.ignition_url=<a class="ae lm" href="http://matchbox.ibmcloud.io.cpak:8080/ignition?mac=${mac:hexhyp" rel="noopener ugc nofollow" target="_blank">http://matchbox.ibmcloud.io.cpak:8080/ignition?mac=${mac:hexhyp</a>}"<br/>      ]<br/>  }<br/>}</span></pre><p id="3d8b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将内核、initrd参数更新到assets目录中下载的相应文件。将coreos URL参数更新为火柴盒URL。由于我们使用的是KVM，这个磁盘被命名为<code class="fe mu mv mw mk b">vda</code>。</p><p id="9465" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="mt">点火</em> </strong></p><p id="34cb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">OpenShift安装程序根据<code class="fe mu mv mw mk b">install-config.yaml </code>文件创建点火文件。将那些点火文件上传到<code class="fe mu mv mw mk b">/var/lib/matchbox/iginition</code>目录。记得把所有权改成用户火柴盒。更多细节参见<strong class="js iu"> OCP安装配置</strong>一节。</p><p id="a733" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在网络启动时，CoreOS VM将根据其Mac地址联系matchbox服务，并因此获得相应的安装映像和点火文件。</p><h2 id="1984" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated"><strong class="ak">负载平衡器VM和Gobetween配置</strong></h2><p id="aa76" class="pw-post-body-paragraph jq jr it js b jt lh jv jw jx li jz ka kb lj kd ke kf lk kh ki kj ll kl km kn im bi translated">对于每个OCP集群，创建一个最小的Ubuntu虚拟机，</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="529a" class="ko kp it mk b gy mo mp l mq mr">uvt-kvm create exp-lb release=bionic --memory 4 --cpu 4 --disk 50 --bridge br-ocp --password password</span></pre><p id="75a1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">网桥是定义的KVM网桥。</p><p id="4350" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">找出Mac地址，</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="83dc" class="ko kp it mk b gy mo mp l mq mr">virsh dumpxml exp-lb | grep 'mac address' | cut -d\' -f 2</span></pre><p id="e569" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">更新LB的Dnsmasq DHCP Mac和IP地址对、DNS A和PTR记录。</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="42a4" class="ko kp it mk b gy mo mp l mq mr">dhcp-host=52:54:00:71:a6:e0,192.168.10.49<br/>address=/exp-lb.exp-ocp4.ibmcloud.io.cpak/192.168.10.49<br/>ptr-record=49.10.168.192.in-addr.arpa,exp-lb.exp-ocp4.ibmcloud.io.cpak</span></pre><p id="2a71" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">清除租用缓存，重新启动Dnsmasq。重启虚拟机以确保它获得分配的IP，</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="cc52" class="ko kp it mk b gy mo mp l mq mr">virsh destroy exp-lb<br/>virsh start exp-lb</span></pre><p id="cc16" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在LB软件之间安装Gobetween，</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="5b6a" class="ko kp it mk b gy mo mp l mq mr">curl -LO <a class="ae lm" href="https://github.com/yyyar/gobetween/releases/download/0.7.0/gobetween_0.7.0_linux_amd64.tar.gz" rel="noopener ugc nofollow" target="_blank">https://github.com/yyyar/gobetween/releases/download/0.7.0/gobetween_0.7.0_linux_amd64.tar.gz</a><br/>mkdir -p gobetween<br/>cd gobetween<br/>tar xzvf ../gobetween_0.7.0_linux_amd64.tar.gz<br/>sudo cp gobetween /usr/local/bin</span></pre><p id="b558" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建Systemd服务，</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="3b3a" class="ko kp it mk b gy mo mp l mq mr">[Unit]<br/>Description=Gobetween - modern LB for cloud era<br/>Documentation=<a class="ae lm" href="https://github.com/yyyar/gobetween/wiki" rel="noopener ugc nofollow" target="_blank">https://github.com/yyyar/gobetween/wiki</a><br/>After=network.target</span><span id="c1c6" class="ko kp it mk b gy ms mp l mq mr">[Service]<br/>Type=simple<br/>PIDFile=/run/gobetween.pid<br/>#ExecStartPre=prestart some command<br/>ExecStart=/usr/local/bin/gobetween -c /etc/gobetween/gobetween.toml<br/>ExecReload=/bin/kill -s HUP $MAINPID<br/>ExecStop=/bin/kill -s QUIT $MAINPID<br/>PrivateTmp=true</span><span id="74d9" class="ko kp it mk b gy ms mp l mq mr">[Install]<br/>WantedBy=multi-user.target</span></pre><p id="e9ef" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">准备下面的TOML配置文件<code class="fe mu mv mw mk b">/etc/gobetween/gobetween.toml</code></p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="275a" class="ko kp it mk b gy mo mp l mq mr">[servers]<br/>[servers.api]<br/>protocol = "tcp"<br/>bind = "0.0.0.0:6443"</span><span id="5d93" class="ko kp it mk b gy ms mp l mq mr">[servers.api.discovery]<br/>  kind = "static"<br/>  static_list = [ "192.168.10.40:6443","192.168.10.41:6443","192.168.10.42:6443","192.168.10.43:6443" ]</span><span id="194c" class="ko kp it mk b gy ms mp l mq mr">[servers.api.healthcheck]<br/>  kind = "ping"<br/>  fails = 1<br/>  passes = 1<br/>  interval = "2s"<br/>  timeout="1s"<br/>  ping_timeout_duration = "500ms"</span><span id="a287" class="ko kp it mk b gy ms mp l mq mr">[servers.mcs]<br/>protocol = "tcp"<br/>bind = "0.0.0.0:22623"</span><span id="e129" class="ko kp it mk b gy ms mp l mq mr">[servers.mcs.discovery]<br/>  kind = "static"<br/>  static_list = [ "192.168.10.40:22623","192.168.10.41:22623","192.168.10.42:22623","192.168.10.43:22623" ]</span><span id="aca8" class="ko kp it mk b gy ms mp l mq mr">[servers.mcs.healthcheck]<br/>  kind = "ping"<br/>  fails = 1<br/>  passes = 1<br/>  interval = "2s"<br/>  timeout="1s"<br/>  ping_timeout_duration = "500ms"</span><span id="202f" class="ko kp it mk b gy ms mp l mq mr">[servers.http]<br/>protocol = "tcp"<br/>bind = "0.0.0.0:80"</span><span id="a3eb" class="ko kp it mk b gy ms mp l mq mr">[servers.http.discovery]<br/>  kind = "static"<br/>  static_list = [ "192.168.10.44:80","192.168.10.45:80","192.168.10.46:80" ]</span><span id="dbb3" class="ko kp it mk b gy ms mp l mq mr">[servers.http.healthcheck]<br/>  kind = "ping"<br/>  fails = 1<br/>  passes = 1<br/>  interval = "2s"<br/>  timeout="1s"<br/>  ping_timeout_duration = "500ms"</span><span id="0dab" class="ko kp it mk b gy ms mp l mq mr">[servers.https]<br/>protocol = "tcp"<br/>bind = "0.0.0.0:443"</span><span id="905a" class="ko kp it mk b gy ms mp l mq mr">[servers.https.discovery]<br/>  kind = "static"<br/>  static_list = [ "192.168.10.44:443","192.168.10.45:443","192.168.10.46:443" ]</span><span id="62e0" class="ko kp it mk b gy ms mp l mq mr">[servers.https.healthcheck]<br/>  kind = "ping"<br/>  fails = 1<br/>  passes = 1<br/>  interval = "2s"<br/>  timeout="1s"<br/>  ping_timeout_duration = "500ms"</span></pre><p id="626e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">目前，API和MCS服务器包括引导服务器。集群启动后，需要更新记录以删除启动虚拟机的Ip。</p><p id="7fb9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">重新启动服务以使配置生效。</p><p id="b158" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> OCP安装配置</strong></p><p id="2b5c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">准备以下配置，<code class="fe mu mv mw mk b">install-config.yaml</code></p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="9516" class="ko kp it mk b gy mo mp l mq mr">apiVersion: v1<br/>baseDomain: ibmcloud.io.cpak<br/>compute:<br/>- hyperthreading: Enabled<br/>  name: worker<br/>  # must be 0 for user provisioned infra as cluster will not create these workers<br/>  replicas: 0<br/>controlPlane:<br/>  hyperthreading: Enabled<br/>  name: master<br/>  replicas: 3<br/>metadata:<br/>  name: exp-ocp4<br/>networking:<br/>  clusterNetwork:<br/>  - cidr: 10.128.0.0/14<br/>    hostPrefix: 23<br/>  networkType: OpenShiftSDN<br/>  serviceNetwork:<br/>  - 172.30.0.0/16<br/>platform:<br/>  none: {}</span><span id="9dff" class="ko kp it mk b gy ms mp l mq mr">pullSecret: 'Get From the Redhat Website, copy and paste here'<br/>sshKey: 'SSH Public Key to access the coreos'</span></pre><p id="2cce" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建一个目录，生成点火文件，复制到火柴盒文件夹。</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="9663" class="ko kp it mk b gy mo mp l mq mr">rm -rf ocp-install<br/>mkdir -p ocp-install</span><span id="2996" class="ko kp it mk b gy ms mp l mq mr">cp install-config.yaml ocp-install<br/>cd ocp-install<br/>openshift-install create ignition-configs --dir .</span><span id="8a79" class="ko kp it mk b gy ms mp l mq mr">cp *ign /var/lib/matchbox/ignition<br/>sudo chown -R matchbox:matchbox /var/lib/matchbox</span></pre><p id="584f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mt">注意，这里我们删除了旧目录，以清除上次安装的所有临时文件。</em></p><h2 id="364a" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated"><strong class="ak"> OCP VMs </strong></h2><p id="ec73" class="pw-post-body-paragraph jq jr it js b jt lh jv jw jx li jz ka kb lj kd ke kf lk kh ki kj ll kl km kn im bi translated">根据建议的规模创建所需的OCP虚拟机。假设有3个主虚拟机、3个工作虚拟机和一个引导虚拟机。举个例子，</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="4970" class="ko kp it mk b gy mo mp l mq mr">virsh vol-create-as ocp-pool exp-bootstrap.qcow2 120G</span><span id="5ffa" class="ko kp it mk b gy ms mp l mq mr">virt-install --name=exp-bootstrap --ram=16 --vcpus=8 --disk path=/ocp-pool/kvm-image/exp-bootstrap.qcow2,bus=virtio --pxe --noautoconsole --graphics=vnc --hvm --network network=ocp,model=virtio --boot hd,network</span></pre><p id="375b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请注意，虚拟机已经为网络启动指定了“pxe”。启动顺序设置为硬盘和网络。第一次网络启动后，CoreOS将安装在硬盘上，随后的启动将从硬盘进行。</p><p id="5718" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">获取虚拟机Mac地址，并按照Dnsmasq一节中的描述更新Dnsmasq配置文件。请删除租用缓存文件，重新启动Dnsmasq服务。</p><p id="bd26" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">根据每个虚拟机的mac地址准备火柴盒组和配置文件。重新启动火柴盒服务。</p><p id="0836" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">建议将这些过程自动化，以避免任何打字错误和其他人为错误。我是用<a class="ae lm" href="https://github.com/magefile/mage" rel="noopener ugc nofollow" target="_blank"><em class="mt">magefile</em></a><em class="mt">和</em><a class="ae lm" href="https://github.com/zhiminwen/magetool" rel="noopener ugc nofollow" target="_blank"><em class="mt">ssh kit</em></a><em class="mt">来实现自动化的。</em></p><p id="eebb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用<code class="fe mu mv mw mk b">virsh destroy</code>和<code class="fe mu mv mw mk b">virsh start</code>命令重启虚拟机，让内核操作系统安装完毕。</p><blockquote class="my mz na"><p id="1475" class="jq jr mt js b jt ju jv jw jx jy jz ka nb kc kd ke nc kg kh ki nd kk kl km kn im bi translated">提示:我们可以使用<code class="fe mu mv mw mk b">virsh console vmName</code>来监控开机。</p></blockquote><h2 id="6a71" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated"><strong class="ak"> OCP集群自举并完成安装</strong></h2><p id="ff20" class="pw-post-body-paragraph jq jr it js b jt lh jv jw jx li jz ka kb lj kd ke kf lk kh ki kj ll kl km kn im bi translated">一旦虚拟机启动，甚至更早，我们就可以启动OCP集群引导。</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="39a2" class="ko kp it mk b gy mo mp l mq mr">cd ocp-install</span><span id="25fa" class="ko kp it mk b gy ms mp l mq mr">openshift-install --dir=. wait-for bootstrap-complete --log-level=debug</span></pre><p id="92e1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">等待命令成功完成。您将看到如下所示的日志，</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="e10e" class="ko kp it mk b gy mo mp l mq mr">level=debug msg="OpenShift Installer v4.2.11"<br/>level=debug msg="Built from commit 6b629f0c847887f22c7a95586e49b0e2434161c3"<br/>level=info msg="Waiting up to 30m0s for the Kubernetes API at <a class="ae lm" href="https://api.exp-ocp4.ibmcloud.io.cpak:6443" rel="noopener ugc nofollow" target="_blank">https://api.exp-ocp4.ibmcloud.io.cpak:6443</a>..."<br/>level=debug msg="Still waiting for the Kubernetes API: the server could not find the requested resource"<br/>level=debug msg="Still waiting for the Kubernetes API: the server could not find the requested resource"</span><span id="c136" class="ko kp it mk b gy ms mp l mq mr">...SKIP SOME LINES...</span><span id="2132" class="ko kp it mk b gy ms mp l mq mr">level=info msg="API v1.14.6+32dc4a0 up"<br/>level=info msg="Waiting up to 30m0s for bootstrapping to complete..."<br/>level=debug msg="Bootstrap status: complete"<br/>level=info msg="It is now safe to remove the bootstrap resources"</span></pre><p id="d37f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">更新LB Gobetween配置以删除引导Ip并重新启动Gobetween服务。我们现在还可以停止并删除引导虚拟机。</p><p id="c195" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果我们已经准备好了外部持久存储，比如GlusterFS，那么创建存储类，为图像注册中心创建PVC。更新注册表配置以使存储持久化。</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="1427" class="ko kp it mk b gy mo mp l mq mr">export KUBECONFIG=/root/ocp-install/auth/kubeconfig </span><span id="dcd6" class="ko kp it mk b gy ms mp l mq mr">oc patch configs.imageregistry.operator.openshift.io cluster --type merge --patch '{"spec":{"storage":{"pvc":{"claim": "pvc-image-registry"}}}}'</span></pre><p id="179a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mt">您也可以使用emptyDir为存储完成配置，但不建议在生产设置中使用。</em></p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="3675" class="ko kp it mk b gy mo mp l mq mr"><em class="mt">oc patch configs.imageregistry.operator.openshift.io cluster --type merge --patch '{"spec":{"storage":{"emptyDir":{}}}}'</em></span></pre><p id="ad03" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用下面的命令完成集群创建，</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="7dca" class="ko kp it mk b gy mo mp l mq mr">cd ocp-install<br/>openshift-install --dir=. wait-for install-complete --log-level=debug</span></pre><p id="0bfb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您将看到如下一些日志，</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="ac38" class="ko kp it mk b gy mo mp l mq mr">level=debug msg="OpenShift Installer v4.2.11"<br/>level=debug msg="Built from commit 6b629f0c847887f22c7a95586e49b0e2434161c3"<br/>level=info msg="Waiting up to 30m0s for the cluster at <a class="ae lm" href="https://api.exp-ocp4.ibmcloud.io.cpak:6443" rel="noopener ugc nofollow" target="_blank">https://api.exp-ocp4.ibmcloud.io.cpak:6443</a> to initialize..."<br/>level=debug msg="Still waiting for the cluster to initialize: Working towards 4.2.12: 100% complete, waiting on image-registry"<br/>level=debug msg="Cluster is initialized"<br/>level=info msg="Waiting up to 10m0s for the openshift-console route to be created..."<br/>level=debug msg="Route found in openshift-console namespace: console"<br/>level=debug msg="Route found in openshift-console namespace: downloads"<br/>level=debug msg="OpenShift console route is created"<br/>level=info msg="Install complete!"<br/>level=info msg="To access the cluster as the system:admin user when using 'oc', run 'export KUBECONFIG=/root/ocp-install/auth/kubeconfig'"<br/>level=info msg="Access the OpenShift web-console here: <a class="ae lm" href="https://console-openshift-console.apps.exp-ocp4.ibmcloud.io.cpak" rel="noopener ugc nofollow" target="_blank">https://console-openshift-console.apps.exp-ocp4.ibmcloud.io.cpak</a>"<br/>level=info msg="Login to the console with user: kubeadmin, password: xxxxxxxxx"</span></pre><p id="997e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> OCP认证配置</strong></p><p id="a7e3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以配置http-passwd文件进行身份验证。</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="5a34" class="ko kp it mk b gy mo mp l mq mr">apt install -y apache2-utils<br/>htpasswd -c -B -b htpasswd.txt admin password</span><span id="5d2b" class="ko kp it mk b gy ms mp l mq mr">export KUBECONFIG=/root/ocp-install/auth/kubeconfig<br/>oc create secret generic htpass-secret  --from-file=htpasswd=htpasswd.txt -n openshift-config</span></pre><p id="985f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">准备以下YAML文件<code class="fe mu mv mw mk b">htpasswd.yaml</code></p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="1c86" class="ko kp it mk b gy mo mp l mq mr">apiVersion: config.openshift.io/v1<br/>kind: OAuth<br/>metadata:<br/>  name: cluster<br/>spec:<br/>  identityProviders:<br/>  - name: my_htpasswd_provider <br/>    mappingMethod: claim <br/>    type: HTPasswd<br/>    htpasswd:<br/>      fileData:<br/>        name: htpass-secret</span></pre><p id="585e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">应用它并分配集群管理权限。</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="aeea" class="ko kp it mk b gy mo mp l mq mr">export KUBECONFIG=/root/ocp-install/auth/kubeconfig<br/>oc apply -f htpasswd.yaml</span><span id="2112" class="ko kp it mk b gy ms mp l mq mr">oc adm policy add-cluster-role-to-user cluster-admin admin</span></pre><p id="eb94" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，我们准备使用oc命令登录集群</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="d5c6" class="ko kp it mk b gy mo mp l mq mr">oc login <a class="ae lm" href="https://api.{{" rel="noopener ugc nofollow" target="_blank">https://api</a>.exp-ocp4.ibmcloud.io.cpak:6443 --insecure-skip-tls-verify=true</span></pre><p id="3dbd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">输入用户名和密码登录。</p><p id="9292" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> Traefik配置</strong></p><p id="8072" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了允许远程访问KVM内部的集群，我们需要配置L7反向代理。</p><p id="a4e3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在KVM主机上安装traefik，</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="ca61" class="ko kp it mk b gy mo mp l mq mr">curl -LO <a class="ae lm" href="https://github.com/containous/traefik/releases/download/v2.1.1/traefik_v2.1.1_linux_amd64.tar.gz" rel="noopener ugc nofollow" target="_blank">https://github.com/containous/traefik/releases/download/v2.1.1/traefik_v2.1.1_linux_amd64.tar.gz</a> </span><span id="ea6c" class="ko kp it mk b gy ms mp l mq mr">tar zxvf traefik_v2.1.1_linux_amd64.tar.gz<br/>sudo mv traefik /usr/local/bin</span><span id="e76f" class="ko kp it mk b gy ms mp l mq mr">sudo mkdir -p /etc/traefik<br/>sudo mkdir -p /etc/traefik/conf.d</span></pre><p id="3a8a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建以下Systemd服务文件并启用该服务</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="8226" class="ko kp it mk b gy mo mp l mq mr">[Unit]<br/>Description=Traefik<br/>After=network.target</span><span id="fe3d" class="ko kp it mk b gy ms mp l mq mr">[Service]<br/>Type=simple<br/>PIDFile=/run/traefik.pid<br/>ExecStart=/usr/local/bin/traefik<br/>ExecReload=/bin/kill -s HUP $MAINPID<br/>ExecStop=/bin/kill -s QUIT $MAINPID<br/>PrivateTmp=true</span><span id="defd" class="ko kp it mk b gy ms mp l mq mr">[Install]<br/>WantedBy=multi-user.target</span></pre><p id="7904" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建一个基本的公共配置文件<code class="fe mu mv mw mk b">/etc/traefik/traefik.toml</code></p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="b718" class="ko kp it mk b gy mo mp l mq mr">[log]<br/>level = "DEBUG"<br/>[accessLog]</span><span id="63ba" class="ko kp it mk b gy ms mp l mq mr">[entryPoints]</span><span id="b861" class="ko kp it mk b gy ms mp l mq mr">[entryPoints.api]<br/>  address = ":6443"</span><span id="8979" class="ko kp it mk b gy ms mp l mq mr">[entryPoints.https]<br/>  address = ":443"</span><span id="19e1" class="ko kp it mk b gy ms mp l mq mr">[providers]<br/>[providers.file]<br/>  directory = "/etc/traefik/conf.d"<br/>  watch = true</span></pre><p id="1e33" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">监听KVM主机端口6443进行集群API访问，监听端口443进行https访问。</p><p id="082a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于每个集群，例如名为exp-ocp的集群，创建以下文件<code class="fe mu mv mw mk b">/etc/traefik/conf.d/exp-ocp.toml</code></p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="4c63" class="ko kp it mk b gy mo mp l mq mr">[tcp.routers]<br/>[tcp.routers.exp-ocp4-api]<br/>  entryPoints = ["api"] #entry points are shared among the clusters<br/>  rule = "HostSNI(`api.exp-ocp4.ibmcloud.io.cpak`)"<br/>  service = "service-exp-ocp4-api"<br/>  [tcp.routers.exp-ocp4-api.tls]<br/>  passthrough = true</span><span id="dac3" class="ko kp it mk b gy ms mp l mq mr">[tcp.routers.exp-ocp4-https]<br/>  entryPoints = ["https"]<br/>  rule = "HostSNI(`oauth-openshift.apps.exp-ocp4.ibmcloud.io.cpak`,`console-openshift-console.apps.exp-ocp4.ibmcloud.io.cpak`)"<br/>  service = "service-exp-ocp4-https"<br/>  [tcp.routers.exp-ocp4-https.tls]<br/>  passthrough = true</span><span id="d3d4" class="ko kp it mk b gy ms mp l mq mr">[tcp.services]<br/>[tcp.services.service-exp-ocp4-api.loadBalancer]<br/>[[tcp.services.service-exp-ocp4-api.loadBalancer.servers]]<br/>  address = "192.168.10.49:6443"</span><span id="7cda" class="ko kp it mk b gy ms mp l mq mr">[tcp.services.service-exp-ocp4-https.loadBalancer]<br/>[[tcp.services.service-exp-ocp4-https.loadBalancer.servers]]<br/>  address = "192.168.10.49:443"</span></pre><p id="a187" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们通过https创建了两个路由器，一个用于集群API，一个用于集群app。TLS模式是直通模式。使用HostSNI让Traefik将请求路由到相应的OCP集群。目前，每个主机的全名都需要在HostSNI表达式中定义为一个列表。例如，集群HTTPS路由器必须为控制台登录成功定义两台主机。</p><pre class="lo lp lq lr gt mj mk ml mm aw mn bi"><span id="a83d" class="ko kp it mk b gy mo mp l mq mr">HostSNI(`oauth-openshift.apps.exp-ocp4.ibmcloud.io.cpak`,`console-openshift-console.apps.exp-ocp4.ibmcloud.io.cpak`)</span></pre><p id="9fce" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">定义Traefik服务以指向特定集群的负载平衡器。</p><p id="7747" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">注意Traefik路由器和服务都以OCP集群的名称命名，这样配置就不会相互覆盖。</p><p id="d88b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在远程笔记本电脑上，配置本地DNS服务器，将集群的名称解析为KVM的主机。详见我的论文<a class="ae lm" href="https://medium.com/@zhimin.wen/setup-local-dns-server-on-macbook-82ad22e76f2a" rel="noopener">https://medium . com/@ Zhimin . Wen/setup-local-DNS-server-on-macbook-82ad 22 e 76 f2a</a>。</p><p id="9ece" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，我们可以使用URL https://console-open shift-console . apps . exp-oc P4 . IBM cloud . io . cpak访问OCP4.2 web控制台</p></div></div>    
</body>
</html>