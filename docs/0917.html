<html>
<head>
<title>Kubernetes Base Config for nginx-ingress + cert manager + Helm/Tiller</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">nginx的Kubernetes基本配置-入口+证书管理器+舵/舵杆</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-base-config-for-nginx-ingress-cert-manager-helm-tiller-edf5645e04ef?source=collection_archive---------0-----------------------#2018-06-18">https://itnext.io/kubernetes-base-config-for-nginx-ingress-cert-manager-helm-tiller-edf5645e04ef?source=collection_archive---------0-----------------------#2018-06-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jn jo jp jq gh gi paragraph-image"><div class="ab gu cl jr"><img src="../Images/e2ed62d388ee65d6d1a3171b1d2ede82.png" data-original-src="https://miro.medium.com/v2/format:webp/1*A-kYNXMDiSLXde-ilVNJvg.png"/></div></figure><p id="e58b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们最近更新了我们的kubernetes集群，以便从kube-lego进行迁移(因为它现在已经过时了)，并在我们的服务中引入了基于角色的访问控制(RBAC)。</p><p id="7b42" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以下文章概述了如何使用Helm/Tiller安装cert manager和nginx-ingress。我们使用Git存储库来存储我们所有的配置YAML，所以如果您习惯于通过CLI进行部署，您仍然可以从这些YAML文件中获得您需要的详细信息。</p><h1 id="86a7" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">与RBAC一起设置舵/舵</h1><p id="34cb" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">Helm本质上是kubernetes的一个包管理器，Tiller是其对应的服务器端部件。您在本地安装Helm，并在您当前的kubectl环境中初始化它，它将在您的集群上安装tiller。</p><p id="3b65" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从<a class="ae lv" href="https://docs.helm.sh/using_helm/" rel="noopener ugc nofollow" target="_blank">在你的电脑上安装头盔</a>开始:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="0ac3" class="mf kt iq mb b gy mg mh l mi mj"># Mac<br/>brew install kubernetes-helm</span><span id="602d" class="mf kt iq mb b gy mk mh l mi mj"># From Scripts<br/>$ curl https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get &gt; get_helm.sh<br/>$ chmod 700 get_helm.sh<br/>$ ./get_helm.sh</span></pre><p id="94a3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在初始化Helm之前，请确保为Tiller设置了RBAC角色。下面是您可以使用的服务帐户配置。</p><p id="c590" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们将Tiller服务帐户配置设置为一个ClusterRole，因为我们没有运行一个大规模的集群，也不太关心证书管理的特定于名称空间的权限。如果您需要这种粒度级别，还可以使用角色绑定并指定一个名称空间。</p><p id="1b22" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将此文件应用于:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="2c8b" class="mf kt iq mb b gy mg mh l mi mj">kubectl apply -f ./tiller.serviceaccount.rbac.ymal</span></pre><figure class="lw lx ly lz gt jq"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="f6e2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">有了Tiller在集群上的权限，我们可以在本地初始化Helm。如果您像我们一样管理多个上下文，请确保您位于想要安装Tiller的上下文上:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="2045" class="mf kt iq mb b gy mg mh l mi mj">kubectl config current-context</span></pre><p id="3306" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果你在正确的上下文中，用蒂勒的RBAC初始化赫尔姆:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="1603" class="mf kt iq mb b gy mg mh l mi mj">helm init --service-account tiller</span></pre><p id="a26f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一旦得到确认，就大功告成了。检查您的pod以确认:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="642a" class="mf kt iq mb b gy mg mh l mi mj">kubectl get pods --all-namespaces<br/>&gt;&gt; kube-system tiller-deploy-75f5797b-rfcwr 1/1  Running 0 1m</span></pre><h1 id="fb7a" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">设置证书管理器</h1><p id="2b30" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">证书管理器允许kubernetes为您的各种服务提供TLS证书。你可以在证书管理器GitHub页面上找到一些非常有用的<a class="ae lv" href="https://github.com/jetstack/cert-manager/tree/master/docs/getting-started" rel="noopener ugc nofollow" target="_blank">入门</a>指南。</p><p id="5489" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了节省时间，需要确定的一件事是，您是要使用名称空间颁发者还是集群颁发者。同样，我们没有大规模的集群，因此使用集群发行者意味着只需配置一个发行者来为我们所有的服务发行证书。你可以在<a class="ae lv" href="https://github.com/jetstack/cert-manager/blob/master/docs/reference/issuers.rst" rel="noopener ugc nofollow" target="_blank">证书管理人员参考文件</a>中了解不同之处。</p><p id="0b19" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下面是我们的集群发行者配置:</p><figure class="lw lx ly lz gt jq"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="993f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">相应地设置您的私钥ref你需要在下一个头盔命令中使用这个名字。</p><p id="71e5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">有了这两个部分，您可以使用Helm进行cert manager的一个命令安装:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="a257" class="mf kt iq mb b gy mg mh l mi mj">helm install \<br/>--name cert-manager \<br/>--namespace kube-system \<br/>stable/cert-manager \<br/>--set ingressShim.defaultIssuerName=letsencrypt-prod \<br/>--set ingressShim.defaultIssuerKind=ClusterIssuer</span></pre><p id="c74f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果您已经安装了cert manager，并且只需要添加上述两个配置，您可以运行以下命令:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="b02e" class="mf kt iq mb b gy mg mh l mi mj">helm upgrade cert-manager \<br/>stable/cert-manager \<br/>--namespace kube-system \<br/>--set ingressShim.defaultIssuerName=letsencrypt-prod \<br/>--set ingressShim.defaultIssuerKind=ClusterIssuer</span></pre><p id="8cb2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果你从kube-lego升级，这两行是关键:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="e165" class="mf kt iq mb b gy mg mh l mi mj">--set ingressShim.defaultIssuerName=letsencrypt-prod \<br/>--set ingressShim.defaultIssuerKind=ClusterIssuer</span></pre><p id="d33d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">它们允许您在入口中使用与kube-lego请求TLS相同的注释——这就是这里的这些行(您也可以在入口配置的末尾看到它们):</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="2a1e" class="mf kt iq mb b gy mg mh l mi mj">kubernetes.io/tls-acme: 'true'<br/>nginx.ingress.kubernetes.io/tls-acme: 'true'</span></pre><p id="63b4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用以下命令检查所有正在运行的程序:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="6637" class="mf kt iq mb b gy mg mh l mi mj">kubectl get pods --all-namespace</span></pre><p id="e670" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">希望你能在这里看到这个:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="a0a0" class="mf kt iq mb b gy mg mh l mi mj">kube-system cert-manager-cert-manager-bcb987f-2ggf2 1/1 Running 0 1m</span></pre><h1 id="41cf" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">使用赫尔姆和RBAC设置nginx-ingress</h1><p id="e7c1" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">nginx-ingress控制器的伟大之处在于，您需要配置的所有文件都可以在他们的<a class="ae lv" href="https://github.com/kubernetes/ingress-nginx/tree/master/deploy" rel="noopener ugc nofollow" target="_blank"> Git repo here </a>中找到。但是我们使用的是Helm，所以让我们接受黑盒的黑暗，只运行以下命令:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="b57c" class="mf kt iq mb b gy mg mh l mi mj">helm install stable/nginx-ingress --name nginx-ingress --set rbac.create=true</span></pre><p id="cd59" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">就这样…其实…今天就到此为止吧…到此为止。您可能希望添加的唯一内容是一些自定义nginx设置的configmap.yml:</p><figure class="lw lx ly lz gt jq"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="cadf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在您可以访问您的服务之前，请确保将您的主DNS端点指向您闪亮的新nginx负载平衡器。</p><p id="388b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在route 53中，选择您的名称记录，并为kubernetes刚刚启动的ELB负载平衡器设置一个别名:</p><figure class="lw lx ly lz gt jq gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/eb0584e63a6b780a4e725a9b10791154.png" data-original-src="https://miro.medium.com/v2/resize:fit:792/format:webp/1*avdMW8gt1XaRncjVVJc70g.png"/></div></figure><h1 id="2079" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">设置服务和部署</h1><p id="9fbd" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">你可以阅读我们在<a class="ae lv" href="https://medium.com/@logojoyapp/the-worlds-longest-wordpress-deployment-5eda086bbc62" rel="noopener">这里</a>做的示例WordPress部署来查看这些配置的例子。你需要做的就是建立一个入口，运行SSL。呜！</p><figure class="lw lx ly lz gt jq"><div class="bz fp l di"><div class="ml mm l"/></div></figure></div></div>    
</body>
</html>