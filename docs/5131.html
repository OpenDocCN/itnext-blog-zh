<html>
<head>
<title>Installing Apache Superset on Amazon EMR</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Amazon EMR上安装Apache超集</h1>
<blockquote>原文：<a href="https://itnext.io/installing-apache-superset-on-amazon-emr-5e2444f6d242?source=collection_archive---------7-----------------------#2020-12-17">https://itnext.io/installing-apache-superset-on-amazon-emr-5e2444f6d242?source=collection_archive---------7-----------------------#2020-12-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ea0a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">将数据探索和可视化添加到您的分析集群中</h2></div><h1 id="9564" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">介绍</h1><p id="34fa" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">AWS提供了近25种不同的开源数据分析应用程序，可以在Amazon Elastic MapReduce(Amazon EMR)上自动安装和配置。在所有这些选项中，EMR没有提供通用的数据探索和可视化工具。但是，使用EMR，您可以在集群创建过程或集群创建后自动安装其他软件。这篇简短的帖子将探索如何在Amazon EMR的主节点上安装、配置和访问<a class="ae lw" href="https://superset.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache超集</a>，这是一个现代化的数据探索和可视化平台，作为后集群创建步骤。您也可以使用这些相同的技术在EMR上安装其他软件包，手动或作为自动化数据管道的一部分。</p><h1 id="22d2" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">亚马逊电子病历</h1><p id="b3f5" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">据AWS介绍，<a class="ae lw" href="https://aws.amazon.com/emr" rel="noopener ugc nofollow" target="_blank">亚马逊EMR </a>是一个基于云的大数据平台，使用开源工具处理海量数据，如<a class="ae lw" href="https://aws.amazon.com/emr/features/spark/" rel="noopener ugc nofollow" target="_blank"> Apache Spark </a>、<a class="ae lw" href="https://aws.amazon.com/emr/features/hive/" rel="noopener ugc nofollow" target="_blank"> Hive </a>、<a class="ae lw" href="https://aws.amazon.com/emr/features/hbase/" rel="noopener ugc nofollow" target="_blank"> HBase </a>、<a class="ae lw" href="https://aws.amazon.com/blogs/big-data/use-apache-flink-on-amazon-emr/" rel="noopener ugc nofollow" target="_blank"> Flink </a>、<a class="ae lw" href="https://aws.amazon.com/emr/features/hudi/" rel="noopener ugc nofollow" target="_blank">胡迪</a>和<a class="ae lw" href="https://zeppelin.apache.org/" rel="noopener ugc nofollow" target="_blank"> Zeppelin </a>、<a class="ae lw" href="https://jupyter.org/" rel="noopener ugc nofollow" target="_blank"> Jupyter </a>和<a class="ae lw" href="https://aws.amazon.com/emr/features/presto/" rel="noopener ugc nofollow" target="_blank"> Presto </a>。使用Amazon EMR，数据分析师、工程师和科学家可以自由地探索、处理和可视化数据。EMR负责调配、配置和调整底层计算集群，使您能够专注于运行分析。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi lx"><img src="../Images/f0b5527ef64f9722b226d9533ff40874.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*G9m0Lqa2qwY-Skr3.png"/></div></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">Amazon EMR控制台的集群摘要选项卡</figcaption></figure><p id="721a" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">AWS目前提供5.x和6.x版本的亚马逊EMR。最新的<a class="ae lw" href="https://docs.aws.amazon.com/emr/latest/ReleaseGuide/emr-release-components.html" rel="noopener ugc nofollow" target="_blank">亚马逊EMR版本</a>是亚马逊EMR版本6.2.0和亚马逊EMR版本5.32.0。亚马逊EMR的每个版本都提供了近25个不同的、流行的开源大数据软件包的增量主版本和次版本供选择，亚马逊EMR将在创建集群时安装和配置这些软件包。</p><h1 id="b98d" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">Apache超集</h1><p id="8cfc" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">据其网站介绍，<a class="ae lw" href="https://superset.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Superset </a>是一个现代化的数据探索和可视化平台。Superset快速、轻量、直观，并加载了选项，使所有技能集的用户都可以轻松地浏览和可视化他们的数据，从简单的折线图到非常详细的地理空间图。</p><p id="6f9c" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">超集本身支持超过25个数据源，包括Amazon Athena和Redshift、Apache Drill、Druid、Hive、Impala、Kylin、Pinot和Spark SQL、Elasticsearch、Google BigQuery、Hana、MySQL、Oracle、Postgres、Presto、Snowflake、Microsoft SQL Server和Teradata。</p><p id="31ef" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">如他们的<a class="ae lw" href="https://superset.apache.org/gallery" rel="noopener ugc nofollow" target="_blank">图库</a>所示，超集包括数十种可视化类型，包括数据透视表、折线图、标记图、饼图、过滤框、气泡图、箱线图、直方图、热图、旭日图、日历热图和几种地理空间类型。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi ms"><img src="../Images/839e5f6399bcb84335abffa5f2b085e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k3OtsIEMeV0EauXs0nn15g.png"/></div></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">Apache超集可视化图库</figcaption></figure><h1 id="f444" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">设置</h1><p id="fd67" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">使用这个<code class="fe mt mu mv mw b">git clone</code>命令，将本文的开源<a class="ae lw" href="https://github.com/garystafford/emr-superset-demo" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>下载到您的本地环境中。</p><pre class="ly lz ma mb gt mx mw my mz aw na bi"><span id="a9de" class="nb kj it mw b gy nc nd l ne nf">git clone --branch main --single-branch --depth 1 --no-tags \<br/>    https://github.com/garystafford/emr-superset-demo.git</span></pre><p id="0d08" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">为了演示如何在EMR上安装Apache超集，我准备了一个AWS CloudFormation模板。将模板<code class="fe mt mu mv mw b">cloudformation/superset-emr-demo.yml</code>部署到AWS将导致AWS云形成栈<code class="fe mt mu mv mw b">superset-emr-demo-dev</code>。该堆栈创建了一个最小规模的双节点EMR集群、两个亚马逊S3存储桶和几个<a class="ae lw" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html" rel="noopener ugc nofollow" target="_blank"> AWS系统管理器(SSM)参数存储库</a>参数。</p><p id="aa5e" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">还有一个JSON格式的云形成参数文件，<code class="fe mt mu mv mw b">cloudformation/superset-emr-demo-params-dev.json</code>。参数文件包含CloudFormation模板中十个必需参数中八个的值，所有这些参数都可以调整。对于剩余的两个必需参数，您需要提供现有EC2密钥对的名称来访问EMR主节点。需要将密钥对部署到您正在部署EMR的同一个AWS帐户。您还需要为要安装到的EMR集群提供一个子网ID。子网必须能够访问互联网，以安装Superset所需的系统和Python包，并访问Superset基于web的用户界面。如果你需要帮助创建一个VPC和子网来部署EMR，请参考我之前的博客文章<a class="ae lw" href="https://link.medium.com/q5jJdiO08bb" rel="noopener">在Amazon EMR上运行PySpark应用程序:在Amazon Elastic MapReduce上与PySpark交互的方法</a>。</p><p id="63cc" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">使用Python脚本<code class="fe mt mu mv mw b">create_cfn_stack.py</code>创建CloudFormation堆栈。python脚本使用AWS <code class="fe mt mu mv mw b">boto3</code> Python SDK。</p><figure class="ly lz ma mb gt mc"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="bc7b" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">要执行Python脚本并创建CloudFormation堆栈(这将创建EMR集群),请运行以下命令。记住将参数更新为EC2密钥对的名称和EMR集群的子网ID。</p><pre class="ly lz ma mb gt mx mw my mz aw na bi"><span id="5804" class="nb kj it mw b gy nc nd l ne nf">python3 ./create_cfn_stack.py \<br/>    --ec2-key-name <strong class="mw iu"><em class="ni">&lt;your_key_pair_name&gt;</em></strong> \<br/>    --ec2-subnet-id <strong class="mw iu"><em class="ni">&lt;your_subnet_id&gt;</em></strong> \<br/>    --environment dev</span></pre><p id="7b6a" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">这是完整的云形成工作流程的样子。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/d766f6de0c7ea6f9655486e5902ad662.png" data-original-src="https://miro.medium.com/v2/resize:fit:1266/format:webp/1*ETqq0T_KR_gMLjK7g9l-Bg.png"/></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">AWS CloudFormation堆栈创建</figcaption></figure><h2 id="2ce7" class="nb kj it bd kk nk nl dn ko nm nn dp ks lj no np ku ln nq nr kw lr ns nt ky nu bi translated">安全组进入规则</h2><p id="001b" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">要通过SSH在EMR集群的主节点上安装超集，您需要在与EMR集群的主节点相关联的安全组上打开端口<code class="fe mt mu mv mw b">22</code>，允许从您的IP地址进行访问。您可以使用AWS管理控制台或AWS CLI打开端口<code class="fe mt mu mv mw b">22</code>。我们将从AWS CLI使用<code class="fe mt mu mv mw b">jq</code>和AWS <code class="fe mt mu mv mw b">ec2</code> API来获取与EMR集群的主节点相关联的安全组ID，并创建两个入口规则。</p><pre class="ly lz ma mb gt mx mw my mz aw na bi"><span id="92fb" class="nb kj it mw b gy nc nd l ne nf">export EMR_MASTER_SG_ID=$(aws ec2 describe-security-groups | \<br/>    jq -r ".SecurityGroups[] | \<br/>    select(.GroupName==\"ElasticMapReduce-master\").GroupId" | \<br/>    head -n 1)</span><span id="1579" class="nb kj it mw b gy nv nd l ne nf">aws ec2 authorize-security-group-ingress \<br/>    --group-id ${EMR_MASTER_SG_ID} \<br/>    --protocol tcp \<br/>    --port 22 \<br/>    --cidr $(curl ipinfo.io/ip)/32</span></pre><h1 id="2ebc" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">超集脚本</h1><p id="1922" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">一旦创建了CloudFormation堆栈并且打开了端口，我们就可以在EMR主节点上安装Apache超集。引导脚本<code class="fe mt mu mv mw b">bootstrap_emr/bootstrap_superset.sh</code>将用于作为<code class="fe mt mu mv mw b">hadoop</code>用户将Apache超集安装到EMR集群的主节点上。该脚本大致基于超集的<a class="ae lw" href="https://superset.apache.org/docs/installation/installing-superset-from-scratch" rel="noopener ugc nofollow" target="_blank">从头安装</a>指令。</p><p id="8594" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">作为安装超集的一部分，该脚本还将部署几个常见的<a class="ae lw" href="https://superset.apache.org/docs/databases/installing-database-drivers" rel="noopener ugc nofollow" target="_blank">数据库驱动</a>，包括Amazon Athena、Amazon Redshift、Apache Spark SQL、Presto、PostgreSQL和MySQL。该脚本还将创建一个<a class="ae lw" href="https://apache-superset.readthedocs.io/en/0.28.1/security.html#admin" rel="noopener ugc nofollow" target="_blank">超集管理角色</a>，以及两个超集用户角色——Alpha<a class="ae lw" href="https://apache-superset.readthedocs.io/en/0.28.1/security.html#alpha" rel="noopener ugc nofollow" target="_blank">和Gamma </a>。</p><figure class="ly lz ma mb gt mc"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="a175" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">为了使用引导脚本安装超集，我们将使用另一个Python脚本<code class="fe mt mu mv mw b">install_superset.py</code>。该脚本使用了SSHv2的Python实现<code class="fe mt mu mv mw b">paramiko</code>。该脚本还使用了<code class="fe mt mu mv mw b">scp</code>，这是一个通过scp1协议使用<code class="fe mt mu mv mw b">paramiko</code>传输来发送和接收文件的模块。</p><figure class="ly lz ma mb gt mc"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="f2c6" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">该脚本需要一个输入参数<code class="fe mt mu mv mw b">ec2-key-path</code>，它是EC2密钥对的完整路径(例如<code class="fe mt mu mv mw b">~/.ssh/my-key-pair.pem</code>)。或者，您可以使用<code class="fe mt mu mv mw b">superset-port</code>参数更改默认的<code class="fe mt mu mv mw b">8280</code>超集端口。</p><pre class="ly lz ma mb gt mx mw my mz aw na bi"><span id="26ad" class="nb kj it mw b gy nc nd l ne nf">python3 ./install_superset.py \<br/>    --ec2-key-path <strong class="mw iu"><em class="ni">&lt;/path/to/my-key-pair.pem&gt;</em></strong><em class="ni"> \<br/>    --superset-port 8280</em></span></pre><p id="5d0b" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">该脚本使用SSH和SCP来部署和执行引导脚本<code class="fe mt mu mv mw b">bootstrap_superset.sh</code>。脚本的输出包括运行在EMR集群上的Apache超集的URL。输出还包含超集管理员的用户名和密码。</p><pre class="ly lz ma mb gt mx mw my mz aw na bi"><span id="755a" class="nb kj it mw b gy nc nd l ne nf">********************************************************************</span><span id="84c3" class="nb kj it mw b gy nv nd l ne nf">Superset URL: <a class="ae lw" href="http://ec2-184-72-144-74.compute-1.amazonaws.com:280" rel="noopener ugc nofollow" target="_blank">http://ec2-111-22-333-44.compute-1.amazonaws.com:8280</a></span><span id="c468" class="nb kj it mw b gy nv nd l ne nf">Admin Username: SupersetAdmin</span><span id="74b2" class="nb kj it mw b gy nv nd l ne nf">Admin Password: Admin1234</span><span id="6da1" class="nb kj it mw b gy nv nd l ne nf">********************************************************************</span></pre><h1 id="155a" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">SSH隧道</h1><p id="4d5d" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">根据<a class="ae lw" href="https://docs.aws.amazon.com/emr/latest/ManagementGuide/emr-web-interfaces.html" rel="noopener ugc nofollow" target="_blank"> AWS </a>，EMR应用程序将用户界面发布为主节点上托管的网站。出于安全原因，这些网站仅在主节点的本地web服务器上可用。要访问任何web接口，您必须使用动态或本地端口转发与主节点建立一个<a class="ae lw" href="https://en.wikipedia.org/wiki/Tunneling_protocol" rel="noopener ugc nofollow" target="_blank"> SSH隧道</a>。如果使用动态端口转发，还必须配置代理服务器来查看web界面。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi nw"><img src="../Images/c1b3a9a2dc177afac72e94e929eb1e13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MS3CkHELVu_9wdlxH7Ucag.png"/></div></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">创建SSH隧道以访问EMR上的UI的说明</figcaption></figure><p id="4eaf" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">在您的终端中运行该命令将在端口<code class="fe mt mu mv mw b">8157</code>上启动SSH隧道。一旦启用了隧道，您就可以在web浏览器中访问Apache超集，使用上面的脚本输出中显示的脚本输出的URL<a class="ae lw" href="http://ec2-111-22-333-44.compute-1.amazonaws.com:8280)." rel="noopener ugc nofollow" target="_blank">。</a>使用管理员凭据或两个用户凭据中的任何一个登录到超集。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi nw"><img src="../Images/080092c2cf947005aafca267696fdcba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1OOfstqmryIsB99rz1YAOQ.png"/></div></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">Apache超集登录屏幕</figcaption></figure><p id="46f5" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">登录后，您将能够连接到您的数据源并<a class="ae lw" href="https://superset.apache.org/docs/creating-charts-dashboards/exploring-data" rel="noopener ugc nofollow" target="_blank">探索</a>和可视化数据。下面，我们看到一个针对Amazon RDS for PostgreSQL数据库执行的SQL查询示例，它运行在与EMR不同的VPC中。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi nw"><img src="../Images/9ceabca9504fc630b90d534974378e26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BUmqIC4PKxHOg5Obeey7PA.png"/></div></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">使用超集的SQL编辑器查询Amazon RDS PostgreSQL数据库的示例</figcaption></figure><h1 id="30fa" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">结论</h1><p id="08ac" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在这篇文章中，我们学习了如何在Amazon EMR集群的主节点上安装Apache超集。如果您想在EMR集群的所有节点上安装一个应用程序，您可以将命令添加到引导脚本中，该脚本在CloudFormation创建集群时运行。</p></div><div class="ab cl nx ny hx nz" role="separator"><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc"/></div><div class="im in io ip iq"><p id="38e5" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated"><em class="ni">这篇博客代表我自己的观点，而不是我的雇主亚马逊网络服务公司的观点。所有产品名称、徽标和品牌都是其各自所有者的财产。</em></p></div></div>    
</body>
</html>