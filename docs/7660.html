<html>
<head>
<title>Terraform: modules, Outputs, and Variables</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">地形:模块、输出和变量</h1>
<blockquote>原文：<a href="https://itnext.io/terraform-modules-outputs-and-variables-dc157274fb5d?source=collection_archive---------5-----------------------#2022-12-11">https://itnext.io/terraform-modules-outputs-and-variables-dc157274fb5d?source=collection_archive---------5-----------------------#2022-12-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/5f300cb28cb544277e4d7404b666b2d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oqPYm4BTtIUwGlFEkr9RkQ.png"/></div></div></figure><p id="4225" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最终，我到达了Terraform中的模块。</p><p id="e0c6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">也就是说，我必须弄清楚如何在两个模块之间传递变量值。</p><p id="a1a7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以在这篇文章中，最基本和最简单的例子就是使用模块及其值和输出。</p><p id="90da" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更多信息请参见文档— <a class="ae kw" href="https://developer.hashicorp.com/terraform/language/modules" rel="noopener ugc nofollow" target="_blank">模块</a>。</p><h1 id="636b" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">根模块</h1><p id="8a79" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">首先，让我们创建一个根模块，它只是创建一个本地文件，稍后我们将在其中添加模块。</p><p id="c5f8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建测试目录:</p><pre class="ma mb mc md gt me mf mg bn mh mi bi"><span id="d049" class="mj ky iq mf b be mk ml l mm mn">$ mkdir modules_example<br/>$ cd modules_example/</span></pre><p id="1767" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这个目录中添加一个带有<code class="fe mo mp mq mf b"><a class="ae kw" href="https://registry.terraform.io/providers/hashicorp/local/latest/docs/data-sources/file" rel="noopener ugc nofollow" target="_blank">local_file</a></code>类型的<code class="fe mo mp mq mf b"><a class="ae kw" href="https://developer.hashicorp.com/terraform/language/resources" rel="noopener ugc nofollow" target="_blank">resource</a></code>的文件<code class="fe mo mp mq mf b">main.tf</code>，这将创建一个带有“<em class="mr">文件内容</em>文本的<em class="mr"> file.txt </em>:</p><pre class="ma mb mc md gt me mf ms mt aw mu bi"><span id="0b02" class="mv ky iq mf b gy mw mx l my mn">resource "local_file" "file" {<br/>  content  = "file content"<br/>  filename = "file.txt"<br/>}</span></pre><p id="764f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行<code class="fe mo mp mq mf b"><a class="ae kw" href="https://developer.hashicorp.com/terraform/cli/commands/init" rel="noopener ugc nofollow" target="_blank">terraform init</a></code>调出Terraform本身的必要模块:</p><pre class="ma mb mc md gt me mf mg bn mh mi bi"><span id="c610" class="mj ky iq mf b be mk ml l mm mn">$ terraform init<br/>Initializing the backend…<br/>Initializing provider plugins…<br/>- Finding latest version of hashicorp/local…<br/>- Installing hashicorp/local v2.2.3…<br/>- Installed hashicorp/local v2.2.3 (signed by HashiCorp)<br/>…</span></pre><p id="70ce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Terraform已成功初始化！</p><p id="8473" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，运行<code class="fe mo mp mq mf b"><a class="ae kw" href="https://developer.hashicorp.com/terraform/cli/commands/plan" rel="noopener ugc nofollow" target="_blank">terraform plan</a></code>来检查它是否能工作，以及它到底能做什么:</p><pre class="ma mb mc md gt me mf mg bn mh mi bi"><span id="12bd" class="mj ky iq mf b be mk ml l mm mn">$ terraform plan<br/>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:<br/>+ create<br/>Terraform will perform the following actions:<br/>local_file.file will be created<br/>+ resource “local_file” “file” {<br/>+ content = “file content”<br/>+ directory_permission = “0777”<br/>+ file_permission = “0777”<br/>+ filename = “file.txt”<br/>+ id = (known after apply)<br/>}<br/>Plan: 1 to add, 0 to change, 0 to destroy.</span></pre><p id="b89b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果看起来正常，运行<code class="fe mo mp mq mf b"><a class="ae kw" href="https://developer.hashicorp.com/terraform/cli/commands/apply" rel="noopener ugc nofollow" target="_blank">terraform apply</a></code>:</p><pre class="ma mb mc md gt me mf mg bn mh mi bi"><span id="160e" class="mj ky iq mf b be mk ml l mm mn">$ terraform apply<br/>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:<br/>+ create<br/>Terraform will perform the following actions:<br/>local_file.file will be created<br/>+ resource “local_file” “file” {<br/>+ content = “file content”<br/>+ directory_permission = “0777”<br/>+ file_permission = “0777”<br/>+ filename = “file.txt”<br/>+ id = (known after apply)<br/>}<br/>Plan: 1 to add, 0 to change, 0 to destroy.<br/>Do you want to perform these actions?<br/>Terraform will perform the actions described above.<br/>Only ‘yes’ will be accepted to approve.<br/>Enter a value: yes<br/>local_file.file: Creating…<br/>local_file.file: Creation complete after 0s [id=87758871f598e1a3b4679953589ae2f57a0bb43c]<br/>Apply complete! Resources: 1 added, 0 changed, 0 destroyed.</span></pre><p id="f913" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并检查我们创建<code class="fe mo mp mq mf b">main.tf</code>文件并启动命令的目录的内容:</p><pre class="ma mb mc md gt me mf mg bn mh mi bi"><span id="308c" class="mj ky iq mf b be mk ml l mm mn">$ ls -l<br/>total 12<br/>-rwxr-xr-x 1 setevoy setevoy 12 Nov 28 13:14 file.txt<br/>-rw-r — r — 1 setevoy setevoy 90 Nov 28 13:09 main.tf<br/>-rw-r — r — 1 setevoy setevoy 854 Nov 28 13:14 terraform.tfstate</span></pre><p id="829e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">而<code class="fe mo mp mq mf b">file.txt</code>内容:</p><pre class="ma mb mc md gt me mf mg bn mh mi bi"><span id="7c66" class="mj ky iq mf b be mk ml l mm mn">$ cat file.txt<br/>file content</span></pre><p id="c0ee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有用！让我们更进一步。</p><h1 id="ee21" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">地形模块</h1><p id="3bab" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">接下来，让我们进入模块。</p><p id="177f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为两个模块创建两个目录:</p><pre class="ma mb mc md gt me mf mg bn mh mi bi"><span id="5114" class="mj ky iq mf b be mk ml l mm mn">$ mkdir -p modules/file_1<br/>$ mkdir -p modules/file_2</span></pre><p id="7bdb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在其中的每一个中，创建他们自己的<code class="fe mo mp mq mf b">main.tf</code>文件——即<code class="fe mo mp mq mf b">modules/file_1/main.tf</code>和<code class="fe mo mp mq mf b">modules/file_2/main.tf</code>。</p><p id="fffe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe mo mp mq mf b">modules/file_1/main.tf</code>中使用同一个<code class="fe mo mp mq mf b">local_file</code>资源创建一个<em class="mr"> file_1.txt </em>文件:</p><pre class="ma mb mc md gt me mf ms mt aw mu bi"><span id="5cc5" class="mv ky iq mf b gy mw mx l my mn">resource "local_file" "file_1" {<br/>  content  = "file_1 content"<br/>  filename = "file_1.txt"<br/>}</span></pre><p id="f860" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">同样在<code class="fe mo mp mq mf b">modules/file_2/main.tf</code>中为<em class="mr"> file_2.txt </em>:</p><pre class="ma mb mc md gt me mf ms mt aw mu bi"><span id="0934" class="mv ky iq mf b gy mw mx l my mn">resource "local_file" "file_2" {<br/>  content  = "file_2 content"<br/>  filename = "file_2.txt"<br/>}</span></pre><p id="15e4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更新根模块，即<code class="fe mo mp mq mf b">modules_example/main.tf</code>——删除<code class="fe mo mp mq mf b">resource "local_file"</code>，取而代之的是用两个模块的目录路径来描述这两个模块:</p><pre class="ma mb mc md gt me mf ms mt aw mu bi"><span id="beec" class="mv ky iq mf b gy mw mx l my mn">module "file_1" {<br/>  source = "./modules/file_1"<br/>}<br/><br/>module "file_2" {<br/>  source = "./modules/file_2"<br/>}</span></pre><p id="c965" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">再次运行<code class="fe mo mp mq mf b">init</code>，以便Terraform创建其模块结构:</p><pre class="ma mb mc md gt me mf mg bn mh mi bi"><span id="ab06" class="mj ky iq mf b be mk ml l mm mn">$ terraform init<br/>Initializing modules…<br/>- file_1 in modules/file_1<br/>- file_2 in modules/file_2<br/>Initializing the backend…<br/>Initializing provider plugins…<br/>- Reusing previous version of hashicorp/local from the dependency lock file<br/>- Using previously-installed hashicorp/local v2.2.3<br/>Terraform has been successfully initialized!</span></pre><p id="d657" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查<code class="fe mo mp mq mf b">.terraform/modules/</code>:</p><pre class="ma mb mc md gt me mf mg bn mh mi bi"><span id="ae08" class="mj ky iq mf b be mk ml l mm mn">$ cat .terraform/modules/modules.json | jq<br/>{<br/>“Modules”: [<br/>{<br/>“Key”: “”,<br/>“Source”: “”,<br/>“Dir”: “.”<br/>},<br/>{<br/>“Key”: “file_1”,<br/>“Source”: “./modules/file_1”,<br/>“Dir”: “modules/file_1”<br/>},<br/>{<br/>“Key”: “file_2”,<br/>“Source”: “./modules/file_2”,<br/>“Dir”: “modules/file_2”<br/>}<br/>]<br/>}</span></pre><p id="588b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">跑<code class="fe mo mp mq mf b">plan</code>:</p><pre class="ma mb mc md gt me mf mg bn mh mi bi"><span id="17ef" class="mj ky iq mf b be mk ml l mm mn">$ terraform plan<br/>local_file.file: Refreshing state… [id=87758871f598e1a3b4679953589ae2f57a0bb43c]<br/>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:<br/>+ create<br/>- destroy<br/>Terraform will perform the following actions:<br/>local_file.file will be destroyed<br/>(because local_file.file is not in configuration)<br/>- resource “local_file” “file” {<br/>- content = “file content” -&gt; null<br/>- directory_permission = “0777” -&gt; null<br/>- file_permission = “0777” -&gt; null<br/>- filename = “file.txt” -&gt; null<br/>- id = “87758871f598e1a3b4679953589ae2f57a0bb43c” -&gt; null<br/>}<br/>module.file_1.local_file.file_1 will be created<br/>+ resource “local_file” “file_1” {<br/>+ content = “file_1 content”<br/>+ directory_permission = “0777”<br/>+ file_permission = “0777”<br/>+ filename = “file_1.txt”<br/>+ id = (known after apply)<br/>}<br/>module.file_2.local_file.file_2 will be created<br/>+ resource “local_file” “file_2” {<br/>+ content = “file_2 content”<br/>+ directory_permission = “0777”<br/>+ file_permission = “0777”<br/>+ filename = “file_2.txt”<br/>+ id = (known after apply)<br/>}<br/>Plan: 2 to add, 0 to change, 1 to destroy.</span></pre><p id="6af5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们可以执行<code class="fe mo mp mq mf b">apply</code>。</p><p id="e2d5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了不每次都输入<em class="mr">“是</em>”，我们可以使用<code class="fe mo mp mq mf b">-auto-approve</code>参数:</p><pre class="ma mb mc md gt me mf mg bn mh mi bi"><span id="f1f9" class="mj ky iq mf b be mk ml l mm mn">$ terraform apply -auto-approve<br/>local_file.file: Refreshing state… [id=87758871f598e1a3b4679953589ae2f57a0bb43c]<br/>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:<br/>+ create<br/>- destroy<br/>Terraform will perform the following actions:<br/>local_file.file will be destroyed<br/>(because local_file.file is not in configuration)<br/>- resource “local_file” “file” {<br/>- content = “file content” -&gt; null<br/>- directory_permission = “0777” -&gt; null<br/>- file_permission = “0777” -&gt; null<br/>- filename = “file.txt” -&gt; null<br/>- id = “87758871f598e1a3b4679953589ae2f57a0bb43c” -&gt; null<br/>}<br/>module.file_1.local_file.file_1 will be created<br/>+ resource “local_file” “file_1” {<br/>+ content = “file_1 content”<br/>+ directory_permission = “0777”<br/>+ file_permission = “0777”<br/>+ filename = “file_1.txt”<br/>+ id = (known after apply)<br/>}<br/>module.file_2.local_file.file_2 will be created<br/>+ resource “local_file” “file_2” {<br/>+ content = “file_2 content”<br/>+ directory_permission = “0777”<br/>+ file_permission = “0777”<br/>+ filename = “file_2.txt”<br/>+ id = (known after apply)<br/>}<br/>Plan: 2 to add, 0 to change, 1 to destroy.<br/>local_file.file: Destroying… [id=87758871f598e1a3b4679953589ae2f57a0bb43c]<br/>module.file_2.local_file.file_2: Creating…<br/>module.file_1.local_file.file_1: Creating…<br/>local_file.file: Destruction complete after 0s<br/>module.file_2.local_file.file_2: Creation complete after 0s [id=7225b36c22072cd558c23529d0d992c29cb873be]<br/>module.file_1.local_file.file_1: Creation complete after 0s [id=82888a6ec6b05fc219759bd241ca5f0d6cba0e23]<br/>Apply complete! Resources: 2 added, 0 changed, 1 destroyed.</span></pre><p id="eb97" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查文件是否已经出现:</p><pre class="ma mb mc md gt me mf mg bn mh mi bi"><span id="e5f0" class="mj ky iq mf b be mk ml l mm mn">$ ll<br/>total 24<br/>-rwxr-xr-x 1 setevoy setevoy 14 Nov 28 13:21 file_1.txt<br/>-rwxr-xr-x 1 setevoy setevoy 14 Nov 28 13:21 file_2.txt<br/>-rw-r — r — 1 setevoy setevoy 104 Nov 28 13:18 main.tf<br/>drwxr-xr-x 4 setevoy setevoy 4096 Nov 28 13:15 modules</span></pre><p id="c5dc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以及它们的内容:</p><pre class="ma mb mc md gt me mf mg bn mh mi bi"><span id="6df2" class="mj ky iq mf b be mk ml l mm mn">$ cat file_1.txt<br/>file_1 content<br/>cat file_2.txt<br/>file_2 content</span></pre><p id="10a5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">作品？向前看。</p><h1 id="721a" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Terraform模块中的变量</h1><p id="9b98" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">这里没有什么特别的，一切都和普通的Terraform变量一样。参见文档— <a class="ae kw" href="https://developer.hashicorp.com/terraform/language/values/variables" rel="noopener ugc nofollow" target="_blank">输入变量</a>。</p><p id="dc03" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe mo mp mq mf b">modules_example/modules/file_1/main.tf</code>中声明一个变量<code class="fe mo mp mq mf b">user_name</code>:</p><pre class="ma mb mc md gt me mf ms mt aw mu bi"><span id="0532" class="mv ky iq mf b gy mw mx l my mn">variable "user_name" {<br/>  type = string<br/>}    <br/><br/>resource "local_file" "file_1" {<br/>  content  = "file_1 content from ${var.user_name}"<br/>  filename = "file_1.txt"<br/>}</span></pre><p id="9857" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第二个模块也是如此:</p><pre class="ma mb mc md gt me mf ms mt aw mu bi"><span id="a7ed" class="mv ky iq mf b gy mw mx l my mn">variable "user_name" {<br/>  type = string<br/>}    <br/><br/>resource "local_file" "file_2" {<br/>  content  = "file_2 content from ${var.user_name}"<br/>  filename = "file_2.txt"<br/>}</span></pre><p id="f9c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更新根模块—为两个模块传递<code class="fe mo mp mq mf b">user_name</code>变量的值:</p><pre class="ma mb mc md gt me mf ms mt aw mu bi"><span id="77bd" class="mv ky iq mf b gy mw mx l my mn">module "file_1" {<br/>  user_name = "user1"<br/>  source = "./modules/file_1"<br/>}<br/><br/>module "file_2" {<br/>  user_name = "user2"<br/>  source = "./modules/file_2"<br/>}</span></pre><p id="e031" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">应用更改:</p><pre class="ma mb mc md gt me mf mg bn mh mi bi"><span id="c19d" class="mj ky iq mf b be mk ml l mm mn">$ terraform apply -auto-approve<br/>module.file_1.local_file.file_1: Refreshing state… [id=82888a6ec6b05fc219759bd241ca5f0d6cba0e23]<br/>module.file_2.local_file.file_2: Refreshing state… [id=7225b36c22072cd558c23529d0d992c29cb873be]<br/>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:<br/>-/+ destroy and then create replacement<br/>Terraform will perform the following actions:<br/>module.file_1.local_file.file_1 must be replaced<br/>-/+ resource “local_file” “file_1” {<br/>~ content = “file_1 content” -&gt; “file_1 content from user1” # forces replacement<br/>~ id = “82888a6ec6b05fc219759bd241ca5f0d6cba0e23” -&gt; (known after apply)<br/>(3 unchanged attributes hidden)<br/>}<br/>module.file_2.local_file.file_2 must be replaced<br/>-/+ resource “local_file” “file_2” {<br/>~ content = “file_2 content” -&gt; “file_2 content from user2” # forces replacement<br/>~ id = “7225b36c22072cd558c23529d0d992c29cb873be” -&gt; (known after apply)<br/>(3 unchanged attributes hidden)<br/>}<br/>…<br/>Apply complete! Resources: 2 added, 0 changed, 2 destroyed.</span></pre><p id="6f05" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">而结果检查:</p><pre class="ma mb mc md gt me mf mg bn mh mi bi"><span id="65b5" class="mj ky iq mf b be mk ml l mm mn">$ cat file_1.txt<br/>file_1 content from user1</span></pre><h1 id="0e1b" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">变量的模块和输出值</h1><p id="af18" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">如何将变量的值从子模块传递到根模块？使用<code class="fe mo mp mq mf b">outputs</code>。参见<a class="ae kw" href="https://developer.hashicorp.com/terraform/language/values/outputs" rel="noopener ugc nofollow" target="_blank">输出值</a>文档。</p><p id="597a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更新第一个模块—添加名为<em class="mr"> file_content </em>的<code class="fe mo mp mq mf b">output</code>:</p><pre class="ma mb mc md gt me mf ms mt aw mu bi"><span id="7e3e" class="mv ky iq mf b gy mw mx l my mn">variable "user_name" {<br/>  type = string<br/>}    <br/><br/>resource "local_file" "file_1" {<br/>  content  = "file_1 content from ${var.user_name}"<br/>  filename = "file_1.txt"<br/>} <br/><br/>output "file_content" {<br/>  value = file("file_1.txt")<br/>}</span></pre><p id="7127" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第二个也一样:</p><pre class="ma mb mc md gt me mf ms mt aw mu bi"><span id="9f98" class="mv ky iq mf b gy mw mx l my mn">variable "user_name" {<br/>  type = string<br/>}    <br/><br/>resource "local_file" "file_2" {<br/>  content  = "file_2 content from ${var.user_name}"<br/>  filename = "file_2.txt"<br/>} <br/><br/>output "file_content" {<br/>  value = file("file_2.txt")<br/>}</span></pre><p id="be51" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后在根模块中，使用使用<code class="fe mo mp mq mf b">module.&lt;MODULE_NAME&gt;.&lt;OUTPUD_NAME&gt;</code>获得的值创建一个文件<em class="mr"> concat_file.txt </em>:</p><pre class="ma mb mc md gt me mf ms mt aw mu bi"><span id="cef6" class="mv ky iq mf b gy mw mx l my mn">module "file_1" {<br/>  user_name = "user1"<br/>  source = "./modules/file_1"<br/>}<br/><br/>module "file_2" {<br/>  user_name = "user2"<br/>  source = "./modules/file_2"<br/>}<br/><br/>resource "local_file" "concat_file" {<br/>  content  = "${module.file_1.file_content}\n${module.file_2.file_content}\n"<br/>  filename = "concat_file.txt"<br/>}</span></pre><p id="916d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行<code class="fe mo mp mq mf b">apply</code>:</p><pre class="ma mb mc md gt me mf mg bn mh mi bi"><span id="c9bb" class="mj ky iq mf b be mk ml l mm mn">$ terraform apply -auto-approve<br/>module.file_2.local_file.file_2: Refreshing state… [id=5771aa8b1046de4f4342d492faee20e3c289365d]<br/>module.file_1.local_file.file_1: Refreshing state… [id=8a3552bfa2e46f311e7b718f8eed71b69bb8115f]<br/>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:<br/>+ create<br/>Terraform will perform the following actions:<br/>local_file.concat_file will be created<br/>+ resource “local_file” “concat_file” {<br/>+ content = &lt;&lt;-EOT<br/>file_1 content from user1<br/>file_2 content from user2<br/>EOT<br/>+ directory_permission = “0777”<br/>+ file_permission = “0777”<br/>+ filename = “concat_file.txt”<br/>+ id = (known after apply)<br/>}<br/>Plan: 1 to add, 0 to change, 0 to destroy.<br/>local_file.concat_file: Creating…<br/>local_file.concat_file: Creation complete after 0s [id=a4e1240fb9cdc96fffc1b0984392f6218422d194]<br/>Apply complete! Resources: 1 added, 0 changed, 0 destroyed.</span></pre><p id="de8c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查结果:</p><pre class="ma mb mc md gt me mf mg bn mh mi bi"><span id="e1fc" class="mj ky iq mf b be mk ml l mm mn">$ cat concat_file.txt<br/>file_1 content from user1<br/>file_2 content from user2</span></pre><h1 id="3b01" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">在模块之间传输变量值</h1><p id="2c7b" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">最后，我们从如何将值从一个模块转移到另一个模块开始？</p><p id="309f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在第一个模块的文件<code class="fe mo mp mq mf b">main.tf</code>中，添加一个名为<code class="fe mo mp mq mf b">module_1_value</code>的变量，默认值为“<em class="mr">模块1值</em>”:</p><pre class="ma mb mc md gt me mf ms mt aw mu bi"><span id="1538" class="mv ky iq mf b gy mw mx l my mn">...<br/>variable "module_1_value" {<br/>  type = string<br/>  default = "module 1 value"<br/>}<br/>...</span></pre><p id="214f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在同一个地方，创建第二个变量<code class="fe mo mp mq mf b">module_2_value</code>，然后我们将把来自第二个模块的值传递给它:</p><pre class="ma mb mc md gt me mf ms mt aw mu bi"><span id="4ad5" class="mv ky iq mf b gy mw mx l my mn">...<br/>variable "module_2_value" {<br/>  type = string<br/>}<br/>...</span></pre><p id="d28c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加<code class="fe mo mp mq mf b">output</code>将变量<code class="fe mo mp mq mf b">module_1_value</code>的值返回给根模块，以便在第二个模块中进一步使用:</p><pre class="ma mb mc md gt me mf ms mt aw mu bi"><span id="a3a9" class="mv ky iq mf b gy mw mx l my mn">...<br/>output "module_1_value" {<br/>  value = var.module_1_value<br/>}<br/>...</span></pre><p id="cf0b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完整的文件现在看起来像这样:</p><pre class="ma mb mc md gt me mf ms mt aw mu bi"><span id="b25e" class="mv ky iq mf b gy mw mx l my mn">variable "user_name" {<br/>  type = string<br/>} <br/>  <br/>variable "module_1_value" {<br/>  type = string<br/>  default = "module 1 value"<br/>} <br/>  <br/>variable "module_2_value" {<br/>  type = string<br/>}<br/><br/>resource "local_file" "file_1" {<br/>  content  = "file_1 content from ${var.user_name} with value from file_2: ${var.module_2_value}"<br/>  filename = "file_1.txt"<br/>}<br/><br/>output "file_content" {<br/>  value = file("file_1.txt")<br/>}<br/><br/>output "module_1_value" {<br/>  value = var.module_1_value<br/>}</span></pre><p id="eefd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里，在资源<code class="fe mo mp mq mf b">local_file</code>中，我们将使用从第二个模块传输的值。</p><p id="1b3b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对模块<code class="fe mo mp mq mf b">file_2</code>重复相同的操作:</p><pre class="ma mb mc md gt me mf ms mt aw mu bi"><span id="4ffc" class="mv ky iq mf b gy mw mx l my mn">variable "user_name" {<br/>  type = string<br/>} <br/>  <br/>variable "module_2_value" {<br/>  type = string<br/>  default = "module 2 value"<br/>} <br/>  <br/>variable "module_1_value" {<br/>  type = string<br/>}<br/><br/>resource "local_file" "file_2" {<br/>  content  = "file_2 content from ${var.user_name} with value from file_1: ${var.module_1_value}"<br/>  filename = "file_2.txt"<br/>}<br/><br/>output "file_content" {<br/>  value = file("file_2.txt")<br/>}<br/><br/>output "module_2_value" {<br/>  value = var.module_2_value<br/>}</span></pre><p id="dcf2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">返回到根模块，将变量<code class="fe mo mp mq mf b">module_2_value</code>的转移添加到第一个模块，将变量<code class="fe mo mp mq mf b">module_1_value</code>的转移添加到第二个模块:</p><pre class="ma mb mc md gt me mf ms mt aw mu bi"><span id="3e00" class="mv ky iq mf b gy mw mx l my mn">module "file_1" {<br/>  user_name = "user1"<br/>  module_2_value = module.file_2.module_2_value<br/>  source = "./modules/file_1"<br/>}   <br/>  <br/>module "file_2" {<br/>  user_name = "user2"<br/>  module_1_value = module.file_1.module_1_value<br/>  source = "./modules/file_2"<br/>} <br/><br/>resource "local_file" "concat_file" {<br/>  content  = "${module.file_1.file_content}\n${module.file_2.file_content}\n"<br/>  filename = "concat_file.txt"<br/>}</span></pre><p id="1e33" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在在文件<code class="fe mo mp mq mf b">file_1.txt</code>中，我们必须从<code class="fe mo mp mq mf b">module "file_2"</code>中获取值，反之亦然。</p><p id="d251" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">应用:</p><pre class="ma mb mc md gt me mf mg bn mh mi bi"><span id="4f05" class="mj ky iq mf b be mk ml l mm mn">$ terraform apply -auto-approve<br/>module.file_1.local_file.file_1: Refreshing state… [id=d74b0e0b3296ab02e7b4791942d983b175d071b4]<br/>local_file.concat_file: Refreshing state… [id=e0e88293b53693a484db146b15bd2ab3d8f4d250]<br/>module.file_2.local_file.file_2: Refreshing state… [id=12faf027dc96d886c6022b54c878324a21d3d112]<br/>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:<br/>-/+ destroy and then create replacement<br/>Terraform will perform the following actions:<br/>local_file.concat_file must be replaced<br/>-/+ resource “local_file” “concat_file” {<br/>~ content = &lt;&lt;-EOT # forces replacement<br/>- file_1 content from user1 with value from file_2: variable 2 value<br/>- file_2 content from user2 with value from file_1: variable 1 value<br/>+ file_1 content from user1 with value from file_2: module 2 value<br/>+ file_2 content from user2 with value from file_1: module 1 value<br/>EOT<br/>~ id = “e0e88293b53693a484db146b15bd2ab3d8f4d250” -&gt; (known after apply)<br/>(3 unchanged attributes hidden)<br/>}<br/>Plan: 1 to add, 0 to change, 1 to destroy.<br/>local_file.concat_file: Destroying… [id=e0e88293b53693a484db146b15bd2ab3d8f4d250]<br/>local_file.concat_file: Destruction complete after 0s<br/>local_file.concat_file: Creating…<br/>local_file.concat_file: Creation complete after 0s [id=648854841581b273d26646fff776b33fdf060a19]<br/>Apply complete! Resources: 1 added, 0 changed, 1 destroyed.</span></pre><p id="4f98" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查结果:</p><pre class="ma mb mc md gt me mf mg bn mh mi bi"><span id="0758" class="mj ky iq mf b be mk ml l mm mn">$ cat concat_file.txt<br/>file_1 content from user1 with value from file_2: module 2 value<br/>file_2 content from user2 with value from file_1: module 1 value</span></pre><p id="ffab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成了。</p></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><p id="d322" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="mr">最初发布于</em> <a class="ae kw" href="https://rtfm.co.ua/en/terraform-modules-outputs-and-variables/" rel="noopener ugc nofollow" target="_blank"> <em class="mr"> RTFM: Linux、DevOps、系统管理</em> </a> <em class="mr">。</em></p></div></div>    
</body>
</html>