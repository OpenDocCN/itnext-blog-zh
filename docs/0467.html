<html>
<head>
<title>External proxy for Kubernetes (or docker-compose) Ingress with HAProxy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用HAProxy的Kubernetes(或docker-compose)入口的外部代理</h1>
<blockquote>原文：<a href="https://itnext.io/cluster-recipe-external-proxy-for-kubernetes-ingress-or-docker-compose-ingress-with-haproxy-on-f81e3adee5ef?source=collection_archive---------2-----------------------#2018-03-14">https://itnext.io/cluster-recipe-external-proxy-for-kubernetes-ingress-or-docker-compose-ingress-with-haproxy-on-f81e3adee5ef?source=collection_archive---------2-----------------------#2018-03-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><blockquote class="jn jo jp"><p id="7765" class="jq jr js jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated"><a class="ae kp" href="https://www.linkedin.com/cws/share?url=https%3A%2F%2Fitnext.io%2Fcluster-recipe-external-proxy-for-kubernetes-ingress-or-docker-compose-ingress-with-haproxy-on-f81e3adee5ef" rel="noopener ugc nofollow" target="_blank"> <em class="iq">点击这里在LinkedIn </em>上分享这篇文章</a></p></blockquote><p id="7a9f" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">如果您在Kubernetes集群中部署了多个非相关应用程序，您可能会考虑使用一个单独的外部代理来为每个应用程序获取不同的公共ip。我们可以使用HAProxy，因为它能够在第7层(http)或第4层(tcp)上代理http/https请求。在我们的例子中，在没有tls终止的情况下在HAProxy上代理https请求是很重要的，因为Kubernetes Ingress(基于nginx)和kube-lego接管了这个功能。第二个问题是如何将原始客户端IP传递给应用程序。解决方案是代理协议，HAProxy和Nginx都支持它。看看如何在新的数字海洋CentOS 7节点上设置这样的代理。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi kt"><img src="../Images/91875a61e7588f86742630c1500495e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vhQRR5Lp-ut28z7uay-KoA.png"/></div></div></figure><h1 id="fdd5" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">设置HAProxy</h1><p id="f0f5" class="pw-post-body-paragraph jq jr iq jt b ju md jw jx jy me ka kb kq mf ke kf kr mg ki kj ks mh km kn ko ij bi translated">假设防火墙、iptables、selinux被禁用。更新操作系统</p><pre class="ku kv kw kx gt mi mj mk ml aw mm bi"><span id="00a5" class="mn lg iq mj b gy mo mp l mq mr">yum update<br/>yum install epel-release</span></pre><p id="e55d" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">检查HAProxy的可用版本。</p><pre class="ku kv kw kx gt mi mj mk ml aw mm bi"><span id="0ff3" class="mn lg iq mj b gy mo mp l mq mr">yum info haproxy<br/>.. 1.5.18</span></pre><p id="14c8" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">股票CentOS有相对旧版本的HAProxy，所以让我们安装来自<a class="ae kp" href="https://ius.io/GettingStarted/" rel="noopener ugc nofollow" target="_blank"> IUS社区库</a>的最新HAProxy。</p><pre class="ku kv kw kx gt mi mj mk ml aw mm bi"><span id="f73f" class="mn lg iq mj b gy mo mp l mq mr">yum install <a class="ae kp" href="https://centos7.iuscommunity.org/ius-release.rpm" rel="noopener ugc nofollow" target="_blank">https://centos7.iuscommunity.org/ius-release.rpm</a><br/>yum install haproxy18u<br/>haproxy -v<br/>HA-Proxy version 1.8.4-1deb90d 2018/02/08</span></pre><p id="d053" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">编辑haproxy配置，用您的Kubernetes ingress或docker-compose“ingress”公共IP替换X.X.X.X。</p><pre class="ku kv kw kx gt mi mj mk ml aw mm bi"><span id="3d8b" class="mn lg iq mj b gy mo mp l mq mr">vi /etc/haproxy/haproxy.cfg<br/>global<br/>    chroot      /var/lib/haproxy<br/>    pidfile     /var/run/haproxy.pid<br/>    maxconn     4000<br/>    user        haproxy<br/>    group       haproxy<br/>    daemon<br/>    stats socket /var/lib/haproxy/stats</span><span id="1501" class="mn lg iq mj b gy ms mp l mq mr">defaults<br/>    mode http<br/>    log global<br/>    option                  redispatch<br/>    retries                 3<br/>    timeout http-request    10s<br/>    timeout queue           1m<br/>    timeout connect         10s<br/>    timeout client          1m<br/>    timeout server          1m<br/>    timeout http-keep-alive 10s<br/>    timeout check           10s<br/>    maxconn                 3000</span><span id="c153" class="mn lg iq mj b gy ms mp l mq mr">frontend http_front<br/>    mode tcp<br/>    bind *:80<br/>    default_backend http_back</span><span id="b0e4" class="mn lg iq mj b gy ms mp l mq mr">frontend https_front<br/>    mode tcp<br/>    bind *:443<br/>    default_backend https_back</span><span id="4c49" class="mn lg iq mj b gy ms mp l mq mr">backend http_back<br/>    mode tcp<br/>    server server01 X.X.X.X:80 <strong class="mj ir">send-proxy</strong></span><span id="78e3" class="mn lg iq mj b gy ms mp l mq mr">backend https_back<br/>    mode tcp<br/>    server server01 X.X.X.X:443 <strong class="mj ir">send-proxy</strong></span></pre><p id="26fe" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">启用并启动HAProxy</p><pre class="ku kv kw kx gt mi mj mk ml aw mm bi"><span id="e81e" class="mn lg iq mj b gy mo mp l mq mr">systemctl enable haproxy<br/>systemctl start haproxy<br/>systemctl status haproxy -l</span></pre><h1 id="5724" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">支持代理协议的Kubernetes入口</h1><p id="020a" class="pw-post-body-paragraph jq jr iq jt b ju md jw jx jy me ka kb kq mf ke kf kr mg ki kj ks mh km kn ko ij bi translated"><a class="ae kp" href="https://github.com/kubernetes/ingress-nginx/blob/d27829ce7ebc5f202816c52f69985bc102db9a63/deploy/provider/aws/patch-configmap-l4.yaml#L9" rel="noopener ugc nofollow" target="_blank">基于Nginx的Kubernetes Ingress使用现成的use-proxy-protocol指令支持代理协议</a>。只需替换<a class="ae kp" href="https://github.com/kubernetes/ingress-nginx/blob/master/deploy/README.md#mandatory-commands" rel="noopener ugc nofollow" target="_blank"> ingress-nginx强制命令</a>中的configmap.yaml或应用新的configmap即可。</p><pre class="ku kv kw kx gt mi mj mk ml aw mm bi"><span id="b19f" class="mn lg iq mj b gy mo mp l mq mr"># REPLACE<br/># curl <a class="ae kp" href="https://raw.githubusercontent.com/kubernetes/ingress-#" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kubernetes/ingress</a>-nginx/master/deploy/configmap.yaml \<br/>#    | kubectl apply -f -<br/># WITH</span><span id="9a44" class="mn lg iq mj b gy ms mp l mq mr">curl <a class="ae kp" href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/d27829ce7ebc5f202816c52f69985bc102db9a63/deploy/provider/aws/patch-configmap-l4.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kubernetes/ingress-nginx/d27829ce7ebc5f202816c52f69985bc102db9a63/deploy/provider/aws/patch-configmap-l4.yaml</a> \<br/>    | kubectl apply -f -</span><span id="420d" class="mn lg iq mj b gy ms mp l mq mr"># OR apply a new config<br/>cat &lt;&lt;EOF | kubectl apply -f -<br/>kind: ConfigMap<br/>apiVersion: v1<br/>metadata:<br/>  name: nginx-configuration<br/>  namespace: ingress-nginx<br/>  labels:<br/>    app: ingress-nginx<br/>data:<br/>  use-proxy-protocol: "true"    <br/>EOF</span></pre><h1 id="a3b8" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated"><strong class="ak">Docker-利用代理协议支持构建类似入口的配置</strong></h1><p id="e3ce" class="pw-post-body-paragraph jq jr iq jt b ju md jw jx jy me ka kb kq mf ke kf kr mg ki kj ks mh km kn ko ij bi translated">可以使用nginx、jwilder/docker-gen和jrcs/letsencrypt-nginx-proxy-companion容器为docker-compose构建一个类似Ingress的环境。让我们看看如何给这个配置添加代理协议支持。所有需要的文件可以在<a class="ae kp" href="https://github.com/olegsmetanin/docker-compose-examples" rel="noopener ugc nofollow" target="_blank">https://github.com/olegsmetanin/docker-compose-examples</a>找到。</p><p id="9980" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">文件布局:</p><pre class="ku kv kw kx gt mi mj mk ml aw mm bi"><span id="3b11" class="mn lg iq mj b gy mo mp l mq mr">|- docker-compose.yaml<br/>|- nginx-proxy-protocol.tmpl</span></pre><p id="ee34" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">docker-compose.yaml</p><pre class="ku kv kw kx gt mi mj mk ml aw mm bi"><span id="fb9e" class="mn lg iq mj b gy mo mp l mq mr">version: '3'<br/>services:<br/>  nginx-web:<br/>    image: nginx<br/>    labels:<br/>      com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy: "true"<br/>    container_name: docker-compose-ingress<br/>    restart: always<br/>    ports:<br/>      - "80:80"<br/>      - "443:443"<br/>    volumes:<br/>      - ./data/conf.d:/etc/nginx/conf.d<br/>      - ./data/vhost.d:/etc/nginx/vhost.d<br/>      - ./data/html:/usr/share/nginx/html<br/>      - ./data/certs:/etc/nginx/certs:ro<br/>      - ./data/htpasswd:/etc/nginx/htpasswd:ro</span><span id="0749" class="mn lg iq mj b gy ms mp l mq mr">nginx-gen:<br/>    image: jwilder/docker-gen<br/>    command: -notify-sighup docker-compose-ingress -watch -wait 5s:30s /etc/docker-gen/templates/nginx.tmpl /etc/nginx/conf.d/default.conf<br/>    container_name: docker-compose-ingress-nginx-gen<br/>    restart: always<br/>    volumes:<br/>      - ./data/conf.d:/etc/nginx/conf.d<br/>      - ./data/vhost.d:/etc/nginx/vhost.d<br/>      - ./data/html:/usr/share/nginx/html<br/>      - ./data/certs:/etc/nginx/certs:ro<br/>      - ./data/htpasswd:/etc/nginx/htpasswd:ro<br/>      - /var/run/docker.sock:/tmp/docker.sock:ro<br/>      - ./nginx-proxy-protocol.tmpl:/etc/docker-gen/templates/nginx.tmpl:ro</span><span id="df46" class="mn lg iq mj b gy ms mp l mq mr">nginx-letsencrypt:<br/>    image: jrcs/letsencrypt-nginx-proxy-companion<br/>    container_name: docker-compose-ingress-nginx-letsencrypt<br/>    restart: always<br/>    volumes:<br/>      - ./data/conf.d:/etc/nginx/conf.d<br/>      - ./data/vhost.d:/etc/nginx/vhost.d<br/>      - ./data/html:/usr/share/nginx/html<br/>      - ./data/certs:/etc/nginx/certs:rw<br/>      - /var/run/docker.sock:/var/run/docker.sock:ro<br/>    environment:<br/>      NGINX_DOCKER_GEN_CONTAINER: docker-compose-ingress-nginx-gen<br/>      NGINX_PROXY_CONTAINER: docker-compose-ingress</span><span id="5caa" class="mn lg iq mj b gy ms mp l mq mr">networks:<br/>  default:<br/>    external:<br/>      name: webproxy</span></pre><p id="aaed" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">nginx-proxy-protocol.tmpl</p><pre class="ku kv kw kx gt mi mj mk ml aw mm bi"><span id="d9b3" class="mn lg iq mj b gy mo mp l mq mr">curl -o <!-- -->nginx-proxy-protocol.tmpl<!-- --> https://raw.githubusercontent.com/jwilder/docker-gen/master/templates/nginx.tmpl</span></pre><p id="59c2" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">在模板中，为所有listen指令添加一个代理协议。</p><pre class="ku kv kw kx gt mi mj mk ml aw mm bi"><span id="631f" class="mn lg iq mj b gy mo mp l mq mr">-listen ...;</span><span id="7667" class="mn lg iq mj b gy ms mp l mq mr">+listen ... proxy_protocol;</span></pre><p id="7345" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">还要更改X-Real-IP和X-Forwarded-For标头:</p><pre class="ku kv kw kx gt mi mj mk ml aw mm bi"><span id="c0c7" class="mn lg iq mj b gy mo mp l mq mr">-proxy_set_header X-Real-IP $remote_addr;</span><span id="09f0" class="mn lg iq mj b gy ms mp l mq mr">+proxy_set_header X-Real-IP $proxy_protocol_addr;</span><span id="979d" class="mn lg iq mj b gy ms mp l mq mr">-proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><span id="02bf" class="mn lg iq mj b gy ms mp l mq mr">+proxy_set_header X-Forwarded-For $proxy_protocol_addr;</span></pre><p id="f200" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">运行类似入口的docker-compose配置:</p><pre class="ku kv kw kx gt mi mj mk ml aw mm bi"><span id="b5e0" class="mn lg iq mj b gy mo mp l mq mr">docker-compose -f docker-compose.yaml up -d</span></pre><p id="1689" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">出于测试目的，让我们运行hello-world容器，它显示了环境变量，以确保ClientIP是正确的。不要忘记更改域名和电子邮件。</p><pre class="ku kv kw kx gt mi mj mk ml aw mm bi"><span id="aa9a" class="mn lg iq mj b gy mo mp l mq mr">version: '3'</span><span id="4bda" class="mn lg iq mj b gy ms mp l mq mr">services:<br/>  web:<br/>    image: olegsmetanin/dockercloud-hello-world<br/>    environment:<br/>      - VIRTUAL_HOST=cloud.example.com<br/>      - VIRTUAL_NETWORK=webproxy<br/>      - VIRTUAL_PORT=80<br/>      - LETSENCRYPT_HOST=cloud.example.com<br/>      - <a class="ae kp" href="mailto:LETSENCRYPT_EMAIL=me@example.com" rel="noopener ugc nofollow" target="_blank">LETSENCRYPT_EMAIL=me@example.com</a><br/>    volumes:<br/>      - /var/run/docker.sock:/var/run/docker.sock<br/>    restart: always</span><span id="0bd5" class="mn lg iq mj b gy ms mp l mq mr">networks:<br/>  default:<br/>    external:<br/>      name: webproxy</span></pre><p id="3538" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">运行docker-compose，通过域名打开应用程序网页，并确保ClientIP与您的真实外部地址匹配，这意味着代理协议实际工作。</p><pre class="ku kv kw kx gt mi mj mk ml aw mm bi"><span id="b8a6" class="mn lg iq mj b gy mo mp l mq mr">docker-compose -f docker-compose.yaml up</span></pre></div></div>    
</body>
</html>