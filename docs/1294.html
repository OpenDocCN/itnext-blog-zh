<html>
<head>
<title>Swift Playgrounds — Simulating Bluetooth Low Energy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Swift Playgrounds —模拟蓝牙低能耗</h1>
<blockquote>原文：<a href="https://itnext.io/swift-playgrounds-simulating-bluetooth-low-energy-cf5738c15a8c?source=collection_archive---------1-----------------------#2018-09-02">https://itnext.io/swift-playgrounds-simulating-bluetooth-low-energy-cf5738c15a8c?source=collection_archive---------1-----------------------#2018-09-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="2cdb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可能知道，创建一个使用蓝牙低能耗与一些外部设备通信的移动应用程序，如心率、遥控汽车或任何其他带有BLE的物联网设备，可能非常棘手且耗时。</p><p id="80e4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好奇为什么…？</p><h2 id="e8cc" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated">蓝牙低能耗</h2><p id="cb42" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">蓝牙低能耗是一种通信协议，允许您与任何内置蓝牙芯片的物联网设备通信，并使用CBATT请求和响应从该设备读取和写入信息。</p><p id="4715" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一般来说，蓝牙设备称为外设，手机app是一个可以连接给定外设的中心。外围设备可以广告一些广告数据，如名称和已知服务。服务是特性的集合。一个外围设备可以有几个服务，每个服务可以有一个或多个特征。您可以从任何特性中读取数据，在值发生变化时得到通知，或者向该特性中写入一些数据。外围设备和中央设备之间传输的最大数据量为20字节！是的，字节，不是比特，不是千字节，不是兆字节，只是字节。Int64有8个字节，所以你可以一次发送2个Int64值。简单什么事？</p><h2 id="f994" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated">设备原型制作</h2><p id="44c5" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">任何物联网设备的硬件原型都需要很长很长的时间。你知道PCB原型制作、PCB蚀刻、传感器和芯片焊接、创建第二个、第三个原型……这需要一些时间。</p><p id="c3d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在原型准备好之后，软件专家需要准备一些低级操作系统，所有的芯片和传感器逻辑都已编码。</p><p id="d15c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">每个人都可能犯错误，因此需要一些额外时间来调试和测试设备。所有这一切都发生在你开始使用移动应用程序之前！但也许不是！</p><h2 id="a1b5" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated">救援的快速操场</h2><p id="0a4b" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">模拟自动驾驶汽车BLE界面真的很容易，你唯一需要做的就是蓝牙规范和你的Mac电脑。</p><h2 id="20c9" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated">要求</h2><ul class=""><li id="6062" class="lj lk iq jp b jq le ju lf jy ll kc lm kg ln kk lo lp lq lr bi translated">遥控汽车BLE接口规范:</li></ul><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi ls"><img src="../Images/6812008fee8e23d9f69a5e70fee194f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G1hTPV9_702sU8A_e-RCUQ.png"/></div></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">RCCar蓝牙规范</figcaption></figure><ul class=""><li id="e139" class="lj lk iq jp b jq jr ju jv jy mi kc mj kg mk kk lo lp lq lr bi translated">Mac机器</li></ul><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/754c52e464dcdaa93683a3e571765ccf.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*sv2BY_yKjsKFXTX4x8Fn6w.png"/></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">资料来源:Wikipedia.org</figcaption></figure><ul class=""><li id="46e1" class="lj lk iq jp b jq jr ju jv jy mi kc mj kg mk kk lo lp lq lr bi translated">Xcode + MacOS游乐场</li></ul><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mm"><img src="../Images/80189c58f9f0d2ea6b0d44ff2fd18eb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UEjTGbwidppcXgTQerIFHw.png"/></div></div></figure><h1 id="7aa5" class="mn km iq bd kn mo mp mq kq mr ms mt kt mu mv mw kw mx my mz kz na nb nc lc nd bi translated">我们开始吧</h1><p id="1735" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">一开始，我们需要为CBPeripheralManager创建一些抽象。下面我们来讨论一下实现。</p><figure class="lt lu lv lw gt lx"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="454f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">TurnOn方法分配CBPeripheralManager，它创建给定的对象并将对象委托分配给自己。</p><p id="8f8e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在调用<em class="ng"> turnOn </em>方法之前，我们需要注册我们希望包含在广告数据中的所有海关服务和特征。为此，我准备了“registerservicecontroller(_ service controller:service controller)”方法。</p><p id="c1b8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当peripheralDidUpdateState方法被调用，并且我们确定给定的外围设备是打开的，我们可以开始广告数据。广告数据包括:</p><ul class=""><li id="7aef" class="lj lk iq jp b jq jr ju jv jy mi kc mj kg mk kk lo lp lq lr bi translated">“cbadvertisementdatalocalnamekey ”,这是给定外围设备的广告名称</li><li id="f2c6" class="lj lk iq jp b jq nh ju ni jy nj kc nk kg nl kk lo lp lq lr bi translated">` cbadvertisementdataserviceuuidskey '这是给定外围设备正在共享的公开广告服务</li></ul><p id="cb03" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ng">关闭</em>方法是停止广告并删除给定外设的引用。</p><p id="dfc9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其他委托方法可用于处理BLE读取和写入。</p><ul class=""><li id="f0c5" class="lj lk iq jp b jq jr ju jv jy mi kc mj kg mk kk lo lp lq lr bi translated"><em class="ng">func peripheral manager(_ peripheral manager，didReceiveRead request:CBATTRequest)</em>当某个外部蓝牙中心(我们的应用程序)想要从给定特征读取数据时执行</li><li id="2005" class="lj lk iq jp b jq nh ju ni jy nj kc nk kg nl kk lo lp lq lr bi translated"><em class="ng">func peripheral manager(_ peripheral manager，did receive write requests:[CBATTRequest])</em>是当某个蓝牙中心试图将一些数据写入给定特征时调用的方法</li><li id="0246" class="lj lk iq jp b jq nh ju ni jy nj kc nk kg nl kk lo lp lq lr bi translated"><em class="ng">func peripheral manager(_ peripheral manager，central: CBCentral，did subscribe to character istic:CB character istic)在每次有人希望得到给定特性的每个变化的通知时被调用</em></li></ul><p id="31c4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们检查一下ServiceController协议要求:</p><figure class="lt lu lv lw gt lx"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="4805" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所见，服务控制器是某种代理，它将读/写和订阅请求传输到给定的特征。</p><p id="ee47" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我们的MotionService实现:</p><figure class="lt lu lv lw gt lx"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="4fe5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如您所看到的，read请求被转移到movmentCharacteristic，就像任何订阅请求一样。任何写入的请求都会被忽略，因为来自该特性的数据是只读的。</p><p id="156f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在object init中，您可以看到MotionService有一个名为Service的属性，它是CBMutableService的一种类型。这个对象是在CBPeripheralManager开始公布数据之前添加的。<em class="ng">CBMutableService(type:CBUUID(string:“0x2fa 2”)，primary: true) </em> init方法给我们提供了定义服务UUID和服务主选项的可能性。<br/>此外，在外围设备开始广告之前，需要使用CBMutableCharacteristic向CBMutableService注册该服务中包含的每个特征。</p><p id="7280" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们检查特性控制器要求:</p><figure class="lt lu lv lw gt lx"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="9fb6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所见，它与ServiceController协议定义非常相似，因此让我们检查一下示例实现:</p><figure class="lt lu lv lw gt lx"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="9f7a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们做一个简单的概述:</p><p id="b71a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">MotionCharacteristic具有CBMutableCharacteristic属性，该属性是CBMutableService特征数组要求，该属性描述了可以对给定特征执行的所有操作:<br/><em class="ng">cbmutable character istic(type:CBUUID(string:“0x1a2b”)，属性:[。阅读，。通知]，值:零，权限:[。可读])。</em>这里我们需要定义给定特征、属性: (读、写、通知)和权限的UUID。可读、可写)。</p><p id="6fb5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要处理读取请求，您只需将新数据值放入<em class="ng"> request.data </em>属性。并使用以下签名调用外围设备实例上的方法:<em class="ng">peripheral . response(响应:请求，结果:。成功)</em></p><p id="c306" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要处理给定服务上要通知的任何更改，我们需要使用给定的签名对CBPeripheralManager执行方法:<em class="ng"> updateValue(Data，for: CBMutableCharacteristic，onSubscribedCentrals: nil)。</em></p><p id="96d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是为什么我们需要在<em class="ng">方法被调用后存储外围引用。</em></p><p id="8185" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们把这些放在一起:</p><figure class="lt lu lv lw gt lx"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="f2f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就在那之后，我们可以成为外围设备的主人，强迫它做我们想做的事情！</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/5b7344d800e489f80cc71f4719d65e63.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/1*4ZyfGNajaW-9DV5H5qDfgQ.gif"/></div></figure><p id="a9ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们使用https://itunes.apple.com/pl/app/nrf-connect/id1054362403?的<a href="”&lt;a" class="ae nn" rel="noopener ugc nofollow" target="_blank">来检查结果mt=8 </a> " &gt; nRF Connect —北欧半导体ASA &lt; /a &gt;</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/4f7ff5222a7c8eedcf51eebdfbb5efda.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/1*02KivF5TD35Ze2F2tH7NiA.gif"/></div></figure><p id="8151" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">仅此而已！</p><p id="c62e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">游乐场代码可以在这里找到:<a class="ae nn" href="https://github.com/gregiOS/Playgrounds" rel="noopener ugc nofollow" target="_blank">https://github.com/gregiOS/Playgrounds</a></p><p id="1984" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另外，你可以在这里查看我的另一篇关于蓝牙低能耗的文章:</p><p id="cc32" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae nn" href="https://blog.untitledkingdom.com/swift-playground-bluetooth-low-energy-8fe15eb2e6df" rel="noopener ugc nofollow" target="_blank">https://blog . untitled kingdom . com/swift-playground-bluetooth-low-energy-8 Fe 15 EB 2 e 6 df</a></p></div></div>    
</body>
</html>