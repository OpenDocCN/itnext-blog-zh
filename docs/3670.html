<html>
<head>
<title>Building RESTful Api With Node.js, Express.Js And PostgreSQL the Right way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Node.js构建RESTful Api，Express。正确使用Js和PostgreSQL</h1>
<blockquote>原文：<a href="https://itnext.io/building-restful-api-with-node-js-express-js-and-postgresql-the-right-way-b2e718ad1c66?source=collection_archive---------0-----------------------#2020-01-28">https://itnext.io/building-restful-api-with-node-js-express-js-and-postgresql-the-right-way-b2e718ad1c66?source=collection_archive---------0-----------------------#2020-01-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c5e5271a940439463b6fe51ac070846d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ugESK9A82iOB438c3X_Flg.png"/></div></div></figure><p id="ce8b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我的文章<a class="ae kw" href="https://medium.com/@effectblessing/generating-a-pdf-with-node-js-express-cloudinary-8a9b9160207" rel="noopener">“用NodeJs和Cloudinary生成Pdf”</a>之后，我收到了一些人的反馈，他们要求我写一篇关于用Nodejs构建RESTful Api的文章。所以我决定把这篇文章放在这里，希望它能帮助到一些人。</p><h1 id="4e33" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">我们将建造什么？</h1><p id="4074" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">您将了解如何构建一个公共汽车交通预订API——这样用户就可以预订他们的旅程，可以看到他们所有的预订，并有权取消任何预订。</p><blockquote class="ma mb mc"><p id="36c2" class="jy jz md ka b kb kc kd ke kf kg kh ki me kk kl km mf ko kp kq mg ks kt ku kv ij bi translated"><em class="iq">唯一不可能的旅程是你从未开始的旅程。🙌—托尼·罗宾斯</em></p></blockquote><h1 id="e889" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">目录</h1><ul class=""><li id="fc04" class="mh mi iq ka b kb lv kf lw kj mj kn mk kr ml kv mm mn mo mp bi translated">入门指南</li><li id="fbd4" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">先决条件</li><li id="1e53" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">项目设置</li><li id="e605" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">项目结构</li><li id="06da" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">设置数据库(PostgrelSQL)</li><li id="8fc3" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">服务器助手</li><li id="4447" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">JWT认证和授权</li><li id="0cde" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">设置控制器</li><li id="88e1" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">设置路线</li><li id="4d7e" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">服务器设置</li><li id="3ca6" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">邮递员测试</li><li id="2932" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">结论</li></ul><h1 id="4d92" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">入门指南</h1><p id="4163" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">在这篇文章中，我将解释如何连接和使用<a class="ae kw" href="https://www.postgresql.org/" rel="noopener ugc nofollow" target="_blank"> PostgreSQL </a>数据库来存储数据。我们还将学习如何编写一些基本的[SQL](结构化查询语言)查询。SQL是一种在数据库中存储、操作和检索数据的标准语言。为了简单起见，我们可以更好地理解SQL是如何工作的，在这篇文章中我不打算使用ORM(对象关系映射)。查看<a class="ae kw" href="https://stackoverflow.com/a/1279678" rel="noopener ugc nofollow" target="_blank"> stackoverflow </a>上的<a class="ae kw" href="https://stackoverflow.com/a/1279678" rel="noopener ugc nofollow" target="_blank">这个</a>答案，更好地理解ORM。ORM基本上是一种技术，它允许我们在不了解SQL的情况下查询和操作数据库中的数据。ORM包公开了查询和操作数据库中的数据所需的一些方法。我们有几个ORM包可以用于我们的数据库，例如<a class="ae kw" href="http://docs.sequelizejs.com/" rel="noopener ugc nofollow" target="_blank"> Sequelize </a>。不使用ORM，我们将直接使用<a class="ae kw" href="https://node-postgres.com/" rel="noopener ugc nofollow" target="_blank"> PG </a> NodeJS包——PG是一个NodeJS包，用于与PostgreSQL数据库接口。单独使用<a class="ae kw" href="https://node-postgres.com/" rel="noopener ugc nofollow" target="_blank"> PG </a>也将使我们有机会理解一些基本的SQL查询，因为我们将使用原始SQL查询来查询和操作数据库中的数据。</p><h1 id="4d24" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">先决条件</h1><p id="25db" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">虽然我会尽量把事情简单化。然而，在深入本教程之前，掌握一些关于Nodejs的基本知识是很重要的，如果你不友好地遵循这个<a class="ae kw" href="https://docs.npmjs.com/downloading-and-installing-node-js-and-npm" rel="noopener ugc nofollow" target="_blank">指南</a>，这篇文章假设你已经在你的PC上安装了Nodejs和Npm。</p><h1 id="5e12" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">项目设置</h1><ul class=""><li id="1415" class="mh mi iq ka b kb lv kf lw kj mj kn mk kr ml kv mm mn mo mp bi translated">在你的系统上创建一个新的项目目录，你可以把它叫做<code class="fe mv mw mx my b"><strong class="ka ir">transportApi</strong></code></li><li id="a7b5" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">将工作直接转换到项目上，如果你使用的是窗口系统，在你的终端或命令提示符下运行<code class="fe mv mw mx my b">npm init</code>——运行<code class="fe mv mw mx my b">npm init</code>会提示你一些问题来帮助设置你的项目</li></ul><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mz"><img src="../Images/1df98db5597edef8f539c33dc79ecf8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M2B6dWfsONPxHK7xNu_wrg.png"/></div></div></figure><p id="7c4c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成后，您应该会在项目中看到<code class="fe mv mw mx my b">package.json</code>文件，它包含了项目的基本信息。</p><pre class="na nb nc nd gt ne my nf ng aw nh bi"><span id="7b70" class="ni ky iq my b gy nj nk l nl nm">{</span><span id="468e" class="ni ky iq my b gy nn nk l nl nm">"name": "transportapi",</span><span id="375b" class="ni ky iq my b gy nn nk l nl nm">"version": "1.0.0",</span><span id="7526" class="ni ky iq my b gy nn nk l nl nm">"description": "",</span><span id="c475" class="ni ky iq my b gy nn nk l nl nm">"main": "server.js",</span><span id="7caa" class="ni ky iq my b gy nn nk l nl nm">"scripts": {</span><span id="742d" class="ni ky iq my b gy nn nk l nl nm">"test": "echo \"Error: no test specified\" &amp;&amp; exit 1"</span><span id="3e45" class="ni ky iq my b gy nn nk l nl nm">},</span><span id="ba1d" class="ni ky iq my b gy nn nk l nl nm">"author": "Beveloper",</span><span id="d9b9" class="ni ky iq my b gy nn nk l nl nm">"license": "ISC"</span><span id="af69" class="ni ky iq my b gy nn nk l nl nm">}</span></pre><p id="df57" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">安装项目的所有依赖项:</strong></p><p id="f23e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将安装这个项目所需的依赖没有花哨的外部软件包，如摩根等。</p><ul class=""><li id="3555" class="mh mi iq ka b kb kc kf kg kj no kn np kr nq kv mm mn mo mp bi translated"><a class="ae kw" href="https://expressjs.com/" rel="noopener ugc nofollow" target="_blank"> expressjs </a> — Expressjs是一个nodejs web应用程序框架，它使我们能够创建快速简单的API。</li><li id="83f7" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">PG— PG是一个NodeJs包，用于连接PostgreSQL数据库。</li><li id="e9cd" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated"><a class="ae kw" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank">JSON Web Token</a>(JWT)——是一个<a class="ae kw" href="https://tools.ietf.org/html/rfc7519" rel="noopener ugc nofollow" target="_blank">开放标准</a>，用于作为JSON对象在各方之间安全地传输信息。它的发音是<em class="md"> jot </em>，或者像我们的荷兰朋友说的那样，<a class="ae kw" href="https://news.ycombinator.com/item?id=14293602" rel="noopener ugc nofollow" target="_blank"> <em class="md"> yaywaytay </em> </a>。JWT通常用于授权。jwt可以使用秘密或公钥/私钥对进行签名。用户登录后，每个后续请求都需要JWT，从而允许用户访问该令牌允许的路由、服务和资源。</li><li id="05ab" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">主体解析器——在处理程序之前解析中间件中的传入请求主体，在<code class="fe mv mw mx my b">req.body</code>属性下提供。</li><li id="7bcd" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">moment——是一个轻量级的JavaScript日期库，用于解析、验证、操作和格式化日期。</li><li id="5736" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">dotenv——是一个零依赖模块，将环境变量从<code class="fe mv mw mx my b">.env</code>文件加载到<code class="fe mv mw mx my b"><a class="ae kw" href="https://nodejs.org/docs/latest/api/process.html#process_process_env" rel="noopener ugc nofollow" target="_blank">process.env</a></code></li><li id="25d4" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">CORS(跨源资源共享)—是一个node.js包，允许请求跳过同源策略并从远程主机访问资源。</li><li id="072d" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">Bcryptjs —是一种帮助您散列密码的安全方法。</li><li id="0961" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">@babel/polyfill —是一个工具链，主要是<strong class="ka ir">用来</strong>将ECMAScript 2015+代码转换成当前和旧版本浏览器或环境中的JavaScript向后兼容版本。</li><li id="d280" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated"><a class="ae kw" href="https://www.npmjs.com/package/babel-watch" rel="noopener ugc nofollow" target="_blank">巴别塔手表</a> —这是开发需要的。babel watch package做的一件事是编译我们的代码，并在每次我们对代码进行更改时重新加载服务器。</li></ul><p id="fec8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行以下命令来安装上述所有软件包</p><pre class="na nb nc nd gt ne my nf ng aw nh bi"><span id="24b8" class="ni ky iq my b gy nj nk l nl nm"><strong class="my ir">$ </strong>npm install --save express pg moment body-parser dotenv jsonwebtoken cors make-runnable bcryptjs <a class="ae kw" href="http://twitter.com/babel/polyfill" rel="noopener ugc nofollow" target="_blank">@babel/polyfill</a> npm-run-all </span><span id="1d65" class="ni ky iq my b gy nn nk l nl nm">$ npm <strong class="my ir">install </strong>--save-dev babel-core <strong class="my ir">babel-cli </strong>babel-preset-env<strong class="my ir"> babel-watch babel-preset-es2015 babel-register</strong></span></pre><p id="1b42" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果一切顺利，您应该会看到类似这样的内容</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/70bed9d81a1cb6f4476ea761a6d04693.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6w_KRq--JP7KMZBueZx0CA.png"/></div></div></figure><p id="9139" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您会注意到<code class="fe mv mw mx my b">express and moment</code> etc在<code class="fe mv mw mx my b">dependencies</code>下面，这是因为在我们将代码部署到生产环境中时，这些是必需的。<code class="fe mv mw mx my b">babel-cli, babel-preset-env and babel-watch etc</code>仅在开发期间需要。</p><h1 id="f2f9" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">项目结构</h1><p id="0538" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">在您的系统上安装<a class="ae kw" href="https://www.postgresql.org/" rel="noopener ugc nofollow" target="_blank"> PostgreSQL </a>。如果您的电脑上没有安装，请浏览本<a class="ae kw" href="https://www.guru99.com/download-install-postgresql.html" rel="noopener ugc nofollow" target="_blank">指南</a></p><p id="3405" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用以下格式设置项目结构；</p><pre class="na nb nc nd gt ne my nf ng aw nh bi"><span id="f701" class="ni ky iq my b gy nj nk l nl nm">TransportApi</span><span id="380d" class="ni ky iq my b gy nn nk l nl nm"> |-app<br/>   |-controllers<br/>   |-db<br/>   |-helpers<br/>   |-middlewares<br/>   |-routes<br/> |-node_modules<br/> |-.babelrc<br/> |-.env<br/> |-env.js<br/> |-package-lock.json<br/> |-package.json<br/> |-server.js</span></pre><figure class="na nb nc nd gt jr gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/87c49cefd65694ae7eac16f05748fbb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:514/format:webp/1*o2b_5-jxFYHUqQgJJCZgNQ.png"/></div></figure><h1 id="8ecb" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">设置数据库</h1><p id="5fa5" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">让我们创建我们的数据库并将其命名为<code class="fe mv mw mx my b">transportApi</code>。为了创建DB，我们可以使用任何PostgreSQL客户端，例如针对Mac用户的<a class="ae kw" href="https://eggerapps.at/postico/" rel="noopener ugc nofollow" target="_blank"> POSTICO </a>或针对window用户的<a class="ae kw" href="https://www.pgadmin.org/download/" rel="noopener ugc nofollow" target="_blank"> PgAdmin4 </a>。<br/>如果你需要一个在你的电脑上设置PostgrelSQL的指南，看看这个简单易懂的<a class="ae kw" href="https://www.guru99.com/download-install-postgresql.html" rel="noopener ugc nofollow" target="_blank">指南</a></p><h2 id="4323" class="ni ky iq bd kz nt nu dn ld nv nw dp lh kj nx ny ll kn nz oa lp kr ob oc lt od bi translated">创建TransportApi表</h2><p id="8306" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">首先，让我们在系统环境中保存我们的数据库URL。你的数据库网址应该是以下格式<br/> <code class="fe mv mw mx my b">postgres://{db_username}:{db_password}@{host}:{port}/{db_name}</code> <br/>例如<code class="fe mv mw mx my b">postgres://transportUser:develop@localhost:5235/transport</code></p><p id="5e2d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您无法在本地设置DB，简单的方法是使用任何PostgreSQL云DB，比如<a class="ae kw" href="https://www.elephantsql.com/" rel="noopener ugc nofollow" target="_blank"> ElephantSQL </a>。如果使用cloud PostgreSQL DB，则复制URL并使用它。我的端口可能与你的不同，所以请确保使用正确的p。</p><p id="ee31" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">环境变量设置</strong></p><p id="f23b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">打开根目录下的<code class="fe mv mw mx my b">.env</code>文件，将代码复制粘贴到其中。</p><pre class="na nb nc nd gt ne my nf ng aw nh bi"><span id="ffc2" class="ni ky iq my b gy nj nk l nl nm"><em class="md">#.env</em></span><span id="c52e" class="ni ky iq my b gy nn nk l nl nm">DATABASE_URL=postgres://transportUser:develop@<em class="md">localhost:5235</em>/transport</span><span id="bd6f" class="ni ky iq my b gy nn nk l nl nm">PORT=5253</span></pre><ul class=""><li id="5385" class="mh mi iq ka b kb kc kf kg kj no kn np kr nq kv mm mn mo mp bi translated">我们定义了几个环境变量(<code class="fe mv mw mx my b"><strong class="ka ir"><em class="md">DATABASE_URL</em></strong> AND <strong class="ka ir"><em class="md">PORT</em></strong></code>)，这样我们可以在以后的项目中使用它们。</li></ul><p id="2516" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们需要在数据库中创建<code class="fe mv mw mx my b">transportApi</code>表。在这里，我们将开始使用带有基本SQL查询的<code class="fe mv mw mx my b">pg</code>包来创建表。</p><p id="b232" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我们的<code class="fe mv mw mx my b">db folder</code>中创建一个名为<code class="fe mv mw mx my b"><strong class="ka ir">dev</strong></code> <strong class="ka ir"> </strong>的文件夹，并分别创建三个名为dbConnection.js、dbQuery.js和pool.js的文件。</p><p id="1796" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">文件应该是这样的。</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="4a9e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">代码步骤:</p><ul class=""><li id="317a" class="mh mi iq ka b kb kc kf kg kj no kn np kr nq kv mm mn mo mp bi translated">从<code class="fe mv mw mx my b">pg</code>导入<code class="fe mv mw mx my b">Pool</code>对象。查看第<a class="ae kw" href="https://node-postgres.com/features/pooling" rel="noopener ugc nofollow" target="_blank">页文档</a>以了解更多关于<code class="fe mv mw mx my b">pooling</code>的信息。我们用它来连接我们的PostgreSQL数据库。Pool是使用pg最简单、最常见的方式。您还可以利用他们的客户端API来连接到数据库。</li><li id="8b5d" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">从<code class="fe mv mw mx my b">dotenv</code>导入<code class="fe mv mw mx my b">dotenv</code>并使用<code class="fe mv mw mx my b">dotenv.config()</code>加载它——这是为了在我们的项目中搜索<code class="fe mv mw mx my b">.env</code>文件并将其内容加载到系统环境中，这样我们就可以使用节点<code class="fe mv mw mx my b">process.env</code>来访问这些变量。</li><li id="8f0e" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们创建了一个新的<code class="fe mv mw mx my b">Pool</code>实例，并将<code class="fe mv mw mx my b">connectionString</code>传递给它的构造函数。我们使用<code class="fe mv mw mx my b">process.env.DATABASE_URL</code>从系统环境中获取<code class="fe mv mw mx my b">DATABASE_URL</code>变量。</li><li id="e89e" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们监听了池<code class="fe mv mw mx my b">connect</code>事件和控制台日志<code class="fe mv mw mx my b">connected to the db</code></li></ul><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="da0e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">代码步骤:</p><ul class=""><li id="df41" class="mh mi iq ka b kb kc kf kg kj no kn np kr nq kv mm mn mo mp bi translated">我们创建了一个新方法<code class="fe mv mw mx my b">query</code>，它接受两个参数<code class="fe mv mw mx my b">text</code>——查询文本和<code class="fe mv mw mx my b">params</code>—<code class="fe mv mw mx my b">text</code>所需的值。这两个参数是查询数据库所需要的。该方法返回一个承诺，我们将在控制器中调用它。点击<a class="ae kw" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" rel="noopener ugc nofollow" target="_blank">这里</a>阅读更多关于JavaScript Promise的内容。</li></ul><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="ff6f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">代码步骤:</p><ul class=""><li id="4408" class="mh mi iq ka b kb kc kf kg kj no kn np kr nq kv mm mn mo mp bi translated">从<code class="fe mv mw mx my b">pg</code>导入<code class="fe mv mw mx my b">Pool</code>对象。查看pg <a class="ae kw" href="https://node-postgres.com/features/pooling" rel="noopener ugc nofollow" target="_blank">文档</a>以了解更多关于<code class="fe mv mw mx my b">pooling</code>的信息。我们用它来连接我们的PostgreSQL数据库。Pool是使用pg最简单、最常见的方式。您还可以利用他们的客户端API来连接到数据库。</li><li id="dec2" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们听了池<code class="fe mv mw mx my b">connect</code>事件和控制台日志<code class="fe mv mw mx my b">connected to the db</code></li><li id="4064" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们设置了一个<code class="fe mv mw mx my b">createTables()</code>函数，函数内部是一个查询，该查询使用唯一的字段分别创建<code class="fe mv mw mx my b">userTbale, busTable, tripTable and bookingTable </code>。</li></ul><pre class="na nb nc nd gt ne my nf ng aw nh bi"><span id="a3f7" class="ni ky iq my b gy nj nk l nl nm">const<em class="md"> createUserTable </em>=<em class="md"> </em>()<em class="md"> </em>=&gt;<em class="md"> </em>{</span><span id="ad25" class="ni ky iq my b gy nn nk l nl nm">   const<em class="md"> userCreateQuery </em>=<em class="md"> </em>`<em class="md">CREATE TABLE IF NOT EXISTS users</em></span><span id="2332" class="ni ky iq my b gy nn nk l nl nm"><em class="md">   (id SERIAL PRIMARY KEY,</em></span><span id="78b5" class="ni ky iq my b gy nn nk l nl nm"><em class="md">   email VARCHAR(100) UNIQUE NOT NULL,</em></span><span id="9adc" class="ni ky iq my b gy nn nk l nl nm"><em class="md">   first_name VARCHAR(100),</em></span><span id="e906" class="ni ky iq my b gy nn nk l nl nm"><em class="md">   last_name VARCHAR(100),</em></span><span id="dfdd" class="ni ky iq my b gy nn nk l nl nm"><em class="md">   password VARCHAR(100) NOT NULL,</em></span><span id="145b" class="ni ky iq my b gy nn nk l nl nm"><em class="md">   created_on DATE NOT NULL)</em>`;</span></pre><p id="80c3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上面所做的是告诉PostgreSQL DB创建<code class="fe mv mw mx my b">users</code>表，如果没有列出字段的<code class="fe mv mw mx my b">users</code>表，其余的表也是如此。</p><p id="f472" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用第一个表(用户表)作为案例研究，我们观察到以下情况；</p><ul class=""><li id="1517" class="mh mi iq ka b kb kc kf kg kj no kn np kr nq kv mm mn mo mp bi translated">我们用<code class="fe mv mw mx my b">userCreateQuery</code>作为参数调用<code class="fe mv mw mx my b">pool</code>查询方法，它返回一个<code class="fe mv mw mx my b">promise</code>。<br/>我们调用<code class="fe mv mw mx my b">pool.end()</code>来关闭<code class="fe mv mw mx my b">pool</code>到数据库的连接。</li><li id="407d" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们创建了另一个名为<code class="fe mv mw mx my b">dropTables()</code>的函数——它删除<code class="fe mv mw mx my b">users</code>表。<br/>我们设置了一个新的查询<code class="fe mv mw mx my b">DROP TABLE IF EXISTS users</code>，如果数据库中存在users表，它将删除该表。</li><li id="4a9a" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们使用<code class="fe mv mw mx my b">pool.on('remove')</code>监听<code class="fe mv mw mx my b">pool</code> <code class="fe mv mw mx my b">remove</code>事件，使用<code class="fe mv mw mx my b">process.exit(0)</code>退出节点进程。</li><li id="30d3" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">最后，我们需要<code class="fe mv mw mx my b">make-runnable</code>包——我们需要它能够从终端调用我们的两个功能中的任何一个。<br/>注意:你要在最后要求<code class="fe mv mw mx my b">make-runnable</code>。还记得我们之前安装了<code class="fe mv mw mx my b">make-runnable</code>作为项目开发依赖。<br/>你也会注意到我们使用了<code class="fe mv mw mx my b">require</code>而不是<code class="fe mv mw mx my b">import</code>，这是因为我们只想单独从终端运行<code class="fe mv mw mx my b">db.js</code>文件，它不是我们项目的直接组成部分，所以编译它没有意义。最后，让我们运行<code class="fe mv mw mx my b">createTables</code>函数来创建我们的表。为此，我们需要在我们的<code class="fe mv mw mx my b">Package.json</code>文件中添加一个命令。</li></ul><p id="1a75" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在您的启动脚本中，删除测试命令并添加以下内容</p><pre class="na nb nc nd gt ne my nf ng aw nh bi"><span id="113e" class="ni ky iq my b gy nj nk l nl nm">"scripts": {</span><span id="0646" class="ni ky iq my b gy nn nk l nl nm">"create-dev-tables": "babel-node ./app/db/dev/dbConnection createAllTables",</span><span id="30bd" class="ni ky iq my b gy nn nk l nl nm">"start": "nodemon --watch . --exec babel-node -- server",</span><span id="9337" class="ni ky iq my b gy nn nk l nl nm">"setup": "npm-run-all -p start create-dev-tables"</span><span id="ddd1" class="ni ky iq my b gy nn nk l nl nm">},</span></pre><p id="b186" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您的package.json应该知道如下所示</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi og"><img src="../Images/eb9018b4cd7ad68546e590cf126bf751.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rg05M59Zuea-NzAqFejLiA.png"/></div></div></figure><p id="1d56" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们运行命令<code class="fe mv mw mx my b">$ <strong class="ka ir">npm run setup</strong></code></p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oh"><img src="../Images/814ca75669eaf531d022c97dbba080f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1306/format:webp/1*0npo_2BQFZ6scHtd1sITtw.png"/></div></div></figure><p id="d1b4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行完上面的，应该会看到下面类似的东西；</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oi"><img src="../Images/f11328d04bc761833710e71c6dc3ba1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7KI9__XywpD_Z3tLIDUnuw.png"/></div></div></figure><p id="9bdb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意:除了完成上述过程，您还可以使用任何PostgreSQL客户端直接创建表，例如<a class="ae kw" href="https://www.guru99.com/create-drop-table-postgresql.html" rel="noopener ugc nofollow" target="_blank"> pgAdmin </a>，<a class="ae kw" href="https://eggerapps.at/postico/docs/v1.4.1/table-ddl.html" rel="noopener ugc nofollow" target="_blank"> POSTICO </a>，或者在终端上使用PostgreSQL命令。</p></div><div class="ab cl oj ok hu ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="ij ik il im in"><h2 id="34fa" class="ni ky iq bd kz nt nu dn ld nv nw dp lh kj nx ny ll kn nz oa lp kr ob oc lt od bi translated"><strong class="ak">设置助手</strong></h2><p id="0abc" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">在进入核心项目之前，需要创建一些辅助方法，这将促进整个项目的可重用性。</p><p id="ac7e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">复制以下内容并粘贴到<code class="fe mv mw mx my b"><strong class="ka ir"><em class="md">app/helpers/validations.js</em></strong></code>中</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="1bf9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">代码步骤:</p><ul class=""><li id="7c91" class="mh mi iq ka b kb kc kf kg kj no kn np kr nq kv mm mn mo mp bi translated"><code class="fe mv mw mx my b">isValidEmail()</code>方法使用regex(正则表达式)验证用户提供的电子邮件地址。<br/>查看本指南，了解更多关于<a class="ae kw" href="https://scrimba.com/g/gregularexpressions" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> Regex </strong> </a>的信息</li><li id="941f" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated"><code class="fe mv mw mx my b">validatePassword</code> —该方法检查用户在注册或登录时提供的密码长度是否小于或等于5个字符。</li><li id="8e67" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated"><code class="fe mv mw mx my b">isEmpty</code>方法检查用户提供的任何输入是否未定义或为空。</li><li id="11cb" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们导出这个方法，这样我们就可以在我们的项目中使用它们。</li></ul><p id="f91c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">复制以下内容并粘贴到<code class="fe mv mw mx my b"><strong class="ka ir"><em class="md">app/helpers/status.js</em></strong></code>中</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="ef09" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">代码步骤:</strong></p><ul class=""><li id="a778" class="mh mi iq ka b kb kc kf kg kj no kn np kr nq kv mm mn mo mp bi translated">创建了一个对象<strong class="ka ir">状态</strong>并定义了一些带有值的属性。</li><li id="4532" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">成功—当用户执行post请求时，返回状态代码200</li><li id="0a26" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">错误—当用户遇到故障时，返回状态代码500</li><li id="f9ec" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">not found——顾名思义，当用户试图执行未定义的请求时，会返回状态代码404，这是禁止的另一个名称😜。</li><li id="49ea" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">未授权—当用户未经授权访问路径/页面时会出现这种状态，在这种情况下会返回状态代码401。</li><li id="72d6" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">已创建—创建数据时，返回状态代码201。</li><li id="57b8" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">Bad —一个很好的用例是当提供一个无效的电子邮件时，返回一个状态代码400。</li><li id="09b8" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">Nocontent —当用户提交一个空表单时，将返回状态代码400。</li><li id="a20a" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">冲突——一个很好的用例是当用户输入一个已经存在的电子邮件。应该会返回409状态代码。</li><li id="1633" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们导出这个方法，这样我们就可以在我们的项目中使用它们。</li></ul></div><div class="ab cl oj ok hu ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="ij ik il im in"><p id="b939" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">授权和认证<em class="md"> (JWT) </em> </strong></p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/35eda7bf72d713d6e12dd791eb461e30.png" data-original-src="https://miro.medium.com/v2/resize:fit:740/1*05X4fJaoVIWGcqKkFaNCZg.gif"/></div><figcaption class="or os gj gh gi ot ou bd b be z dk translated">JWT的快乐</figcaption></figure><p id="35ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当我们继续学习本教程时，我们的项目会有一些需要保护的路由和一些需要授权的用户。就像我一样，你可能想知道这是如何实现的。幸运的是，我们有JSON Web令牌(JWT)来解决这个问题。</p><p id="4e02" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">JSON Web Token (JWT)是一个开放标准，它定义了一种紧凑的自包含方式，以JSON对象的形式在各方之间安全地传输信息。该信息可以被验证和信任，因为它是数字签名的。</p><p id="51e6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="md">授权</em> </strong>是使用JWT最常见的场景。用户登录后，每个后续请求都将包含JWT，允许用户访问该令牌允许的路由、服务和资源。单点登录是目前广泛使用JWT的一个特性，因为它的开销很小，并且能够很容易地跨不同的域使用。</p><p id="e9cb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用JWT进行授权有一些优点:</p><ol class=""><li id="7006" class="mh mi iq ka b kb kc kf kg kj no kn np kr nq kv ov mn mo mp bi translated">纯粹的无国籍。不需要额外的服务器或基础设施来存储会话信息。</li><li id="1192" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv ov mn mo mp bi translated">它可以很容易地在服务之间共享。</li></ol><p id="3525" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在其紧凑的形式中，JSON Web令牌由点(<code class="fe mv mw mx my b">.</code>)分隔的三个部分组成，它们是:</p><ul class=""><li id="7d2d" class="mh mi iq ka b kb kc kf kg kj no kn np kr nq kv mm mn mo mp bi translated">页眉</li><li id="f160" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">有效载荷</li><li id="9872" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">签名</li></ul><p id="90f9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，JWT通常如下所示。</p><p id="1ba2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">xxxxx.yyyyy.zzzzz</code></p><h1 id="510c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">现在，是写代码的时候了。</h1><figure class="na nb nc nd gt jr gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/6abf32142c704f7cf6e6b63a46be545b.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/1*6LExAmWi3bvXyf42oWx_cw.gif"/></div></figure><h1 id="e292" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated"><strong class="ak"> <em class="ox">认证<br/></em></strong><strong class="ak"><em class="ox">jwt . sign()</em></strong></h1><p id="ada9" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated"><strong class="ka ir"> <em class="md"> jwt.sign(payload，secretkey，[选项，回调]) </em> </strong></p><p id="f8bb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第一个函数<strong class="ka ir"> <em class="md"> </em> </strong> <code class="fe mv mw mx my b">jwt.sign()</code>将生成一个JWT令牌，把它分配给一个用户对象，然后返回那个JWT令牌，这样我们就可以把它传递到任何我们需要的地方。它可以是异步的，也可以是同步的，这取决于是否提供了回调。<strong class="ka ir"> <em class="md"> payload </em> </strong>参数在我们这里会是用户对象，<strong class="ka ir"> <em class="md"> secretkey </em> </strong>是你自己编的，可以是任何东西。回调参数是我们处理发送令牌的地方，选项参数是可以设置过期时间的地方。</p><p id="8a4c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">复制以下代码并粘贴<code class="fe mv mw mx my b"><em class="md">app/helpers/validations.js</em></code></p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="fb7e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">代码步骤:</p><p id="e58c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在validation.js里面我们有一个函数<strong class="ka ir"><em class="md">generateUserToken</em></strong></p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oy"><img src="../Images/6c6828cfc42f70fea2241e61623bdaf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MwiAdPkAOjvuvpsg3UHRZg.png"/></div></div></figure><ul class=""><li id="8349" class="mh mi iq ka b kb kc kf kg kj no kn np kr nq kv mm mn mo mp bi translated">我们从它们各自的模块中导入了jsonwebtoken(JWT)和dotenv。</li><li id="7870" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们创建了一个函数<code class="fe mv mw mx my b">generateUserToken</code>，我们使用<code class="fe mv mw mx my b">jwt.sign(..)</code>对用户的令牌进行签名，通过发送电子邮件、user_id、is_admin(稍后讨论)、first_name和last_name作为有效载荷，我们还传递了我们的<strong class="ka ir"> secret </strong>并将令牌设置为3天后过期。<em class="md">。</em></li></ul><h1 id="c868" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated"><strong class="ak"> <em class="ox">授权<br/> jwt.verify() </em> </strong></h1><p id="a7af" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated"><strong class="ka ir"> <em class="md"> jwt.verify(token，secretkey，[options，callback]) </em> </strong></p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div class="gh gi oz"><img src="../Images/c9bbbe0ba952fae1739fc52c612dbc32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/1*3S0f_qAlgImzCeSMMC881g.gif"/></div></figure><p id="a712" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mv mw mx my b">jwt.verify()</code>当访问受保护的路由时，将验证用户令牌。它将令牌作为一个参数，即您在<code class="fe mv mw mx my b">jwt.sign()</code>函数中定义的密钥，然后您有选项和回调参数。回调将是我们可以访问和发送受保护数据的地方。</p><p id="f945" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">复制以下内容并粘贴到<code class="fe mv mw mx my b"><em class="md">app/middleware/verifyAuth.js</em></code></p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="0b35" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">代码步骤:</p><p id="60fd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里，我们用<code class="fe mv mw mx my b">verifyToken()</code>方法创建一个新的Auth对象。方法所做的基本上是使用我们在签名令牌时使用的相同密钥来验证和解码用户请求令牌。我们使用<code class="fe mv mw mx my b"><strong class="ka ir">const{token} = req.headers</strong></code>从请求头中获取令牌，并将其与我们在签名令牌时使用的秘密一起发送给<code class="fe mv mw mx my b">jwt.verify(..)</code>。如果令牌有效，我们从令牌有效负载中检索<code class="fe mv mw mx my b"><strong class="ka ir"><em class="md">email, user_id, is_admin,first_name, last_name</em></strong></code>，并查询DB以确保用户存在于DB中。如果用户存在于数据库中，我们在<code class="fe mv mw mx my b">req</code>对象中创建了一个新的对象属性。我们将使用它来处理其他请求处理程序。最后，由于这个方法是一个中间件，我们使用了<code class="fe mv mw mx my b">next()</code>来移动到下一个请求处理器。如果这里发生了任何错误，我们会向用户返回一条错误消息，而不必转到下一个请求处理程序。</p></div><div class="ab cl oj ok hu ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="ij ik il im in"><h1 id="cb5d" class="kx ky iq bd kz la pa lc ld le pb lg lh li pc lk ll lm pd lo lp lq pe ls lt lu bi translated"><strong class="ak">设置控制器</strong></h1><p id="2847" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">接下来，我们需要为我们的项目设置控制器，首先是我们的管理员和用户控制器。</p><h2 id="1b36" class="ni ky iq bd kz nt nu dn ld nv nw dp lh kj nx ny ll kn nz oa lp kr ob oc lt od bi translated"><strong class="ak"> <em class="ox">管理员控制器</em> </strong></h2><p id="9a40" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">复制以下内容并粘贴到<code class="fe mv mw mx my b"><strong class="ka ir"><em class="md">app/controllers/adminController.js</em></strong></code>中</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="66dd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">代码步骤:</p><p id="8a95" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意:有一些路由需要管理员权限才能访问</p><ul class=""><li id="681c" class="mh mi iq ka b kb kc kf kg kj no kn np kr nq kv mm mn mo mp bi translated">这里，我们创建了两个方法— <code class="fe mv mw mx my b">createAdmin</code>和<code class="fe mv mw mx my b">updateUserToAdmin</code>。我们还利用了<code class="fe mv mw mx my b">async/await</code>。</li><li id="d888" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们导入moment，这样做的原因是因为我们将使用它来创建日期。</li><li id="1a3b" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们从<code class="fe mv mw mx my b">app/db/dev/dbQuery.js</code>导入了dbQuery。</li><li id="7f8f" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们还从<code class="fe mv mw mx my b">app/helpers/status.js</code>中导入了我们的<strong class="ka ir"> <em class="md">状态</em> </strong>助手方法<code class="fe mv mw mx my b">empty</code>和<code class="fe mv mw mx my b">errorMessage,successMessage, status</code>。</li><li id="5520" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们还从<code class="fe mv mw mx my b">app/helpers/validations.js</code>中导入了我们的<strong class="ka ir"> <em class="md">验证</em> </strong>助手方法<code class="fe mv mw mx my b">hashPassword</code>和<code class="fe mv mw mx my b">comparePassword, isValidEmail, validPassword, isEmpty, generateUserToken</code>。</li><li id="8851" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们创建了一个函数<code class="fe mv mw mx my b">createAdmin</code>，在这个函数中，我们从请求体中解构了我们的值<code class="fe mv mw mx my b">email, first_name, last_name, is_admin, password</code>。</li><li id="f943" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">接下来，我们创建了一个名为created_on的变量，它保存我们创建的用户表的日期。</li><li id="9fe1" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">接下来，我们使用我们的助手方法<code class="fe mv mw mx my b"><strong class="ka ir"><em class="md">isValidEmail.</em></strong></code>检查我们的电子邮件是否有效</li><li id="930b" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">此外，我们检查我们的密码字符是否超过5个。</li><li id="7d99" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">使用我们的助手方法<code class="fe mv mw mx my b">hashPassword</code>，我们使用bcryptjs模块散列我们的密码。</li></ul><h2 id="6e50" class="ni ky iq bd kz nt nu dn ld nv nw dp lh kj nx ny ll kn nz oa lp kr ob oc lt od bi translated"><strong class="ak"> <em class="ox">用户控制器</em> </strong></h2><p id="c3ce" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">复制以下内容并粘贴到<code class="fe mv mw mx my b"><strong class="ka ir"><em class="md">app/controllers/usersController.js</em></strong></code>中</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="7048" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">代码步骤:</p><ul class=""><li id="f318" class="mh mi iq ka b kb kc kf kg kj no kn np kr nq kv mm mn mo mp bi translated">这里，我们创建了两个方法— <code class="fe mv mw mx my b">createUser</code>和<code class="fe mv mw mx my b">signUser</code>。我们还利用了<code class="fe mv mw mx my b">async/await</code>。</li><li id="306b" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们导入moment，这样做的原因是因为我们将使用它来创建日期。</li><li id="5bef" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们从<code class="fe mv mw mx my b">app/db/dev/dbQuery.js</code>导入了dbQuery。</li><li id="f52f" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们还从<code class="fe mv mw mx my b">app/helpers/status.js</code>中导入了我们的<strong class="ka ir"> <em class="md">状态</em> </strong>助手方法<code class="fe mv mw mx my b">empty</code>和<code class="fe mv mw mx my b">errorMessage,successMessage, status</code>。</li><li id="6215" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们还从<code class="fe mv mw mx my b">app/helpers/validations.js</code>导入了我们的<strong class="ka ir"> <em class="md">验证</em> </strong>助手方法<code class="fe mv mw mx my b">hashPassword</code>和<code class="fe mv mw mx my b">comparePassword, isValidEmail, validPassword, isEmpty, generateUserToken</code>。</li><li id="e8f5" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们创建了一个函数<code class="fe mv mw mx my b">createUser</code>，在这个函数中，我们从请求体中解构了我们的值<code class="fe mv mw mx my b">email, first_name, last_name, password</code>。</li><li id="ea85" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">接下来，我们创建了一个名为created_on的变量，它保存我们创建的用户表的日期。</li><li id="344f" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">接下来，我们使用我们的助手方法<code class="fe mv mw mx my b"><strong class="ka ir"><em class="md">isValidEmail.</em></strong></code>检查我们的电子邮件是否有效</li><li id="6d2d" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">此外，我们检查我们的密码字符是否超过5个。</li><li id="c89f" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">使用我们的助手方法<code class="fe mv mw mx my b">hashPassword</code>，我们使用bcryptjs模块散列我们的密码。</li><li id="cb75" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">接下来，我们创建了一个名为created_on的变量，它保存我们创建的总线表的日期。</li><li id="8b89" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">对于我们的SQL查询，我们使用了<code class="fe mv mw mx my b">INSERT INTO users(list_columns_here..) VALUES($1, $2, $3, $4, $5...)</code>——它的作用是在<code class="fe mv mw mx my b">users</code>表中创建一个新行，并将提供的值插入到它的字段中。<code class="fe mv mw mx my b">values</code>是一个数值数组，包含我们要插入到表格中的内容。<code class="fe mv mw mx my b">values</code>数组中的元素必须与<code class="fe mv mw mx my b">$1, $2, $3, $4, $5</code>的顺序相同。我们使用<code class="fe mv mw mx my b">returning *</code>返回创建的行。记得我们创建了<code class="fe mv mw mx my b">query</code>方法，它在<code class="fe mv mw mx my b">app/db/dev/dbQuery.js</code>中接受两个参数<code class="fe mv mw mx my b">quertText</code>和<code class="fe mv mw mx my b">params</code>，这是我们将使用它的地方。我们调用了该方法，并将<code class="fe mv mw mx my b">createUserQuery</code>和值作为参数发送进来。</li><li id="120b" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们利用尝试和捕捉，我💕它。</li><li id="c04d" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">使用generateUserToken helper方法，我们生成了我们的用户令牌。<br/> <strong class="ka ir"> <em class="md"> JWT </em> </strong>将在本文稍后讨论。</li><li id="fc78" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated"><code class="fe mv mw mx my b"><strong class="ka ir"><em class="md">_bt_check_unique</em></strong></code> —检查重复值并返回错误。</li></ul><p id="c759" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为<code class="fe mv mw mx my b">dbQuery.query</code>返回一个承诺，我们利用<code class="fe mv mw mx my b">async/await</code>让我们的代码看起来性感<code class="fe mv mw mx my b">😘.</code></p></div><div class="ab cl oj ok hu ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="ij ik il im in"><ul class=""><li id="71c9" class="mh mi iq ka b kb kc kf kg kj no kn np kr nq kv mm mn mo mp bi translated"><code class="fe mv mw mx my b"><strong class="ka ir"><em class="md">signUser</em></strong></code> -我们设置<code class="fe mv mw mx my b">SELECT * FROM users WHERE email = $1</code>来获取一个有特定电子邮件<strong class="ka ir"> <em class="md">的用户。</em> </strong></li><li id="9d84" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">类似于<strong class="ka ir"> <em class="md"> createUser </em> </strong>函数，它检查电子邮件和密码是否不正确，它还比较密码，确保用户输入的密码和电子邮件都正确无误，然后对它们进行签名。</li><li id="5ac8" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">此外，用户在登录时会获得一个<strong class="ka ir"> <em class="md">令牌</em> </strong>。这是由我们的一代人创造的。 </li><li id="3b59" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">最后，我们分别导出了我们的方法<code class="fe mv mw mx my b">createUser and signUser</code>，因此我们可以在我们的项目中使用它们。</li></ul></div><div class="ab cl oj ok hu ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="ij ik il im in"><h2 id="a127" class="ni ky iq bd kz nt nu dn ld nv nw dp lh kj nx ny ll kn nz oa lp kr ob oc lt od bi translated"><strong class="ak"> <em class="ox">总线控制器</em> </strong></h2><p id="f469" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">复制以下内容并粘贴到<code class="fe mv mw mx my b"><strong class="ka ir"><em class="md">app/controllers/busController.js</em></strong></code>中</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="4cc2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">代码步骤:</p><ul class=""><li id="4bcb" class="mh mi iq ka b kb kc kf kg kj no kn np kr nq kv mm mn mo mp bi translated">在这里，我们创建了两个方法- <code class="fe mv mw mx my b">addBusDetails()</code>和<code class="fe mv mw mx my b">getAllBuses()</code>。我们还利用了<code class="fe mv mw mx my b">async/await</code>。</li><li id="0f02" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们导入moment，这样做的原因是因为我们要用它来创建我们的约会。</li><li id="7186" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated"><code class="fe mv mw mx my b">addbusDetails()</code>——我们从<code class="fe mv mw mx my b">app/db/dev/dbQuery.js</code>导入了我们的dbQuery。</li><li id="48a9" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们还从<code class="fe mv mw mx my b">app/helpers/validations.js</code>中导入了我们的助手方法<code class="fe mv mw mx my b">empty</code>和<code class="fe mv mw mx my b">errorMessage,successMessage, status</code>。和<code class="fe mv mw mx my b">app/helpers/status.js</code>分别表示。</li><li id="a65e" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们创建了一个函数<code class="fe mv mw mx my b">addBusDetails()</code>，在其中我们从请求体中解构了我们的值<code class="fe mv mw mx my b">number_plate, manufacturer, model, year, capacity</code>。</li><li id="5e4c" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">接下来，我们创建了一个名为created_on的变量，它保存我们创建的用户表的日期。</li><li id="152f" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们还使用我们的<code class="fe mv mw mx my b"><strong class="ka ir"><em class="md">empty</em></strong></code>方法检查输入字段是否为空，如果为空，它将发送一个错误<strong class="ka ir"> <em class="md">“所有字段都是必需的”</em> </strong>，并返回一个状态代码400。</li><li id="c16b" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">对于我们的SQL查询，我们使用了<code class="fe mv mw mx my b">INSERT INTO bus(list_columns_here..) VALUES($1, $2, $3, $4, $5, $6 ...)</code>——这是在<code class="fe mv mw mx my b">bus</code>表中创建一个新行，并将提供的值插入到它的字段中。<code class="fe mv mw mx my b">values</code>是一个数值数组，包含我们要插入到表格中的内容。<code class="fe mv mw mx my b">values</code>数组中的元素必须与<code class="fe mv mw mx my b">$1, $2, $3, $4, $5, $6</code>的顺序相同。我们使用<code class="fe mv mw mx my b">returning *</code>返回创建的行。记得我们创建了接受两个参数<code class="fe mv mw mx my b">quertText</code>和<code class="fe mv mw mx my b">app/db/dev/dbQuery.js</code>中的<code class="fe mv mw mx my b">params</code>的<code class="fe mv mw mx my b">query</code>方法，这是我们将使用它的地方。我们调用该方法，并将<code class="fe mv mw mx my b">createBusQuery</code>和值作为参数发送进来。由于<code class="fe mv mw mx my b">dbQuery.query</code>返回一个承诺，我们利用<code class="fe mv mw mx my b">async/await</code>让我们的代码看起来更性感<code class="fe mv mw mx my b">😘.</code></li></ul></div><div class="ab cl oj ok hu ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="ij ik il im in"><h2 id="ef1d" class="ni ky iq bd kz nt nu dn ld nv nw dp lh kj nx ny ll kn nz oa lp kr ob oc lt od bi translated"><strong class="ak"> <em class="ox">行程控制器</em> </strong></h2><p id="4178" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">接下来，我们将创建我们的tripController，类似于总线控制器。</p><p id="39b7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">复制以下内容并粘贴到<code class="fe mv mw mx my b"><strong class="ka ir"><em class="md">app/controllers/tripController.js</em></strong></code>中</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="c99f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">代码步骤:</p><p id="64fb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">tripController与之前创建的BusController非常相似，但是增加了一些东西</p><ul class=""><li id="a220" class="mh mi iq ka b kb kc kf kg kj no kn np kr nq kv mm mn mo mp bi translated">在这里，我们创建了两个方法— <code class="fe mv mw mx my b">createTrip(), getAllTrips()cancelTrips, filterTripByOrigin, filterTripByDestination</code>。</li><li id="c6af" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated"><strong class="ka ir"> <em class="md">取消行程</em> </strong> —我们设置<code class="fe mv mw mx my b">UPDATE trip SET status=$1 WHERE id=$2 returning*</code>根据行程<strong class="ka ir"> <em class="md"> ID取消行程。</em> </strong></li><li id="6709" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated"><strong class="ka ir"><em class="md">filterTripByOrigin</em></strong>—我们设置<code class="fe mv mw mx my b">SELECT * FROM trip WHERE <strong class="ka ir"><em class="md">origin</em></strong>=$1 ORDER BY id DESC </code>从降序<strong class="ka ir"> <em class="md">中过滤用户旅行的起点。</em>T24】</strong></li><li id="19c2" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated"><strong class="ka ir"><em class="md">filterTripByDestination</em></strong>—我们设置了<code class="fe mv mw mx my b">SELECT * FROM trip WHERE destination=$1 ORDER BY id DESC </code>从降序<strong class="ka ir"> <em class="md">中过滤用户旅行的目的地。</em> </strong></li></ul></div><div class="ab cl oj ok hu ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="ij ik il im in"><h2 id="71d2" class="ni ky iq bd kz nt nu dn ld nv nw dp lh kj nx ny ll kn nz oa lp kr ob oc lt od bi translated"><strong class="ak"> <em class="ox">预订控制器</em> </strong></h2><p id="0c36" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">接下来，我们将考虑bookingController，它似乎是我们的<strong class="ka ir"> <em class="md"> transportApi的重要组成部分。</em> </strong></p><p id="ea00" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">复制以下内容并粘贴到<code class="fe mv mw mx my b"><strong class="ka ir"><em class="md">app/controllers/bookingController.js</em></strong></code>中</p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="2caa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">代码步骤:</p><p id="1f5e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">bookingController与之前创建的BusController非常相似，但是增加了一些东西</p><ul class=""><li id="2d3b" class="mh mi iq ka b kb kc kf kg kj no kn np kr nq kv mm mn mo mp bi translated">在这里，我们创建了四个方法— <code class="fe mv mw mx my b">createBooking(), getAllBooking, deleteBooking, and updateBookingSeat</code>。<br/>前两种方法<strong class="ka ir"><em class="md">create booking</em></strong>和<strong class="ka ir"><em class="md">getAllBooking</em></strong>与我们<strong class="ka ir"> <em class="md"> busController中前面的解释相同。</em>T53】</strong></li><li id="6057" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated"><strong class="ka ir"> <em class="md">删除预订</em> </strong> —我们设置<code class="fe mv mw mx my b">UPDATE trip SET status=$1 WHERE id=$2 returning*</code>根据行程<strong class="ka ir"> <em class="md"> ID取消行程。</em> </strong></li><li id="f35a" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated"><strong class="ka ir"> <em class="md">更新预订座位</em> </strong> —我们设置<code class="fe mv mw mx my b">UPDATE booking SET seat_number=$1 WHERE user_id=$2 returning*</code>在预订过程中根据用户ID和用户座位号更新预订。</li></ul></div><div class="ab cl oj ok hu ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="ij ik il im in"><p id="7e86" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你已经走到这一步，你应该得到一个大拇指！</p><h1 id="9524" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated"><strong class="ak">设置路线</strong></h1><p id="7fb2" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">接下来，我们将考虑为创建的每个控制器设置路径。</p><h2 id="2042" class="ni ky iq bd kz nt nu dn ld nv nw dp lh kj nx ny ll kn nz oa lp kr ob oc lt od bi translated"><strong class="ak"> <em class="ox">公交路线</em> </strong></h2><p id="ccbd" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">复制以下内容并粘贴到<code class="fe mv mw mx my b"><strong class="ka ir"><em class="md">app/routes/busRoute.js.</em></strong></code></p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="b68a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">代码步骤:</p><ul class=""><li id="d2a5" class="mh mi iq ka b kb kc kf kg kj no kn np kr nq kv mm mn mo mp bi translated">我们进口快递。</li><li id="0a4a" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">接下来，我们将在我们的总线控制器中创建的所有<strong class="ka ir"> <em class="md">方法</em> </strong>导入到<code class="fe mv mw mx my b"><strong class="ka ir"><em class="md">app/controllers/busController.js.</em></strong></code>中</li><li id="09a7" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们声明了一个变量(<strong class="ka ir"> <em class="md"> router </em> </strong>)，它保存了我们的快速路由器。</li><li id="9ffb" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">我们使用我们的路由器变量和传递请求方法(<strong class="ka ir"> <em class="md"> POST，PUT，PATCH，GET </em> </strong>)定义了我们的路由和匹配路由，例如<br/> <code class="fe mv mw mx my b"><strong class="ka ir"><em class="md">router.post('/buses', addBusDetails), router.get('/buses', getAllBuses)etc</em></strong></code>。</li></ul><h2 id="7856" class="ni ky iq bd kz nt nu dn ld nv nw dp lh kj nx ny ll kn nz oa lp kr ob oc lt od bi translated"><strong class="ak">注:</strong></h2><ul class=""><li id="958f" class="mh mi iq ka b kb lv kf lw kj mj kn mk kr ml kv mm mn mo mp bi translated">虽然路线相同但请求方法不同，所以处理不同的请求。</li><li id="8098" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">相同的模式适用于本教程中的所有路线</li><li id="8bf6" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated"><strong class="ka ir">对任何端点的每个请求都将通过</strong> <code class="fe mv mw mx my b"><strong class="ka ir">verifyAuth</strong></code> <strong class="ka ir">中间件处理实际请求。使用这种新的设置，没有有效令牌的用户将会得到一个错误。</strong></li></ul></div><div class="ab cl oj ok hu ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="ij ik il im in"><h2 id="7b67" class="ni ky iq bd kz nt nu dn ld nv nw dp lh kj nx ny ll kn nz oa lp kr ob oc lt od bi translated"><strong class="ak"> <em class="ox">预定路线</em> </strong></h2><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="oe of l"/></div></figure><h2 id="1aed" class="ni ky iq bd kz nt nu dn ld nv nw dp lh kj nx ny ll kn nz oa lp kr ob oc lt od bi translated"><strong class="ak"> <em class="ox">行程路线</em> </strong></h2><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="oe of l"/></div></figure></div><div class="ab cl oj ok hu ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="ij ik il im in"><h1 id="91dd" class="kx ky iq bd kz la pa lc ld le pb lg lh li pc lk ll lm pd lo lp lq pe ls lt lu bi translated"><strong class="ak"> <em class="ox">设置我们的服务器</em> </strong></h1><p id="290a" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">现在我们已经有了控制器和路线设置，让我们看看如何把一切放在一起。</p><p id="03f0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">复制以下代码并粘贴到<code class="fe mv mw mx my b"><strong class="ka ir"><em class="md">app/server.js.</em></strong></code></p><figure class="na nb nc nd gt jr"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="398a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">代码步骤:</p><p id="d8d5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">。</strong>我们安装了babel-polyfill npm包并导入了它——我们在这里需要它，以便节点运行时能够识别<code class="fe mv mw mx my b">async/await</code>和<code class="fe mv mw mx my b">Promise</code>。</p><p id="c1dd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="md">。</em> </strong>我们从各自的模块中导入必要的包</p><p id="ae40" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="md">。</em> </strong>接下来，我们从routes文件夹中导入所有路线</p><p id="7c97" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="md">。</em> </strong>添加<strong class="ka ir"> cors </strong>中间件用于<em class="md">解析URL编码体(通常由浏览器发送)</em></p><p id="f8a6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">T58。 </strong>表达<strong class="ka ir"> <em class="md">。</em> </strong> <em class="md">添加urlencoded作为中间件，用于解析JSON和urlencoded数据，并填充</em> <strong class="ka ir"> `req.body`. </strong></p><p id="0847" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="md">。</em> </strong>接下来，我们对我们的<strong class="ka ir"> Api </strong> <code class="fe mv mw mx my b"><strong class="ka ir"><em class="md">'/api/v1', userRoute</em></strong></code>进行了版本化，并追加了各自的路由。</p><p id="7a22" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">T1。 </strong>最后我们监听了我们的端口，这样我们就可以启动服务器了。</p><h1 id="e80d" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">邮递员测试</h1><figure class="na nb nc nd gt jr gh gi paragraph-image"><div class="gh gi pf"><img src="../Images/b5f9d300803d46e854d2c24dfb234720.png" data-original-src="https://miro.medium.com/v2/resize:fit:440/1*hCL9cA6g43iMNTKMW5uIbg.gif"/></div></figure><h2 id="5f9b" class="ni ky iq bd kz nt nu dn ld nv nw dp lh kj nx ny ll kn nz oa lp kr ob oc lt od bi translated">创建用户-发布API/v1/注册</h2><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pg"><img src="../Images/2bcf241a20897731a43159774cfe783c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0OROYNjLf04m4uAPQygE2g.png"/></div></div></figure><h2 id="b00f" class="ni ky iq bd kz nt nu dn ld nv nw dp lh kj nx ny ll kn nz oa lp kr ob oc lt od bi translated">创建管理员-发布API/v1/管理员/注册</h2><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ph"><img src="../Images/9a6e810bce5135988c7fa8e6b4f9f567.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Hw-ARVXf1ziRM1Bs4CoJQ.png"/></div></div></figure><p id="a921" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">复制令牌并将其放入标头中</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pi"><img src="../Images/c1f368426729b64798e972927a09d0a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3MqG4w8SycqBoz7afhDFAw.png"/></div></div></figure><h2 id="923a" class="ni ky iq bd kz nt nu dn ld nv nw dp lh kj nx ny ll kn nz oa lp kr ob oc lt od bi translated">创建总线—发布API/v1/总线</h2><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pj"><img src="../Images/9d8692d37ed32b38c1862c89e037ec45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9WaziBUZaaeY3XndlXZvFA.png"/></div></div></figure><h2 id="880f" class="ni ky iq bd kz nt nu dn ld nv nw dp lh kj nx ny ll kn nz oa lp kr ob oc lt od bi translated">获取总线—获取API/v1/bus/</h2><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pk"><img src="../Images/a33634f0caba65c111855660cb221cdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G2qFt0RrKDgyt3i7vMtTiA.png"/></div></div></figure><h2 id="929b" class="ni ky iq bd kz nt nu dn ld nv nw dp lh kj nx ny ll kn nz oa lp kr ob oc lt od bi translated">创建行程-过帐API/v1/行程</h2><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pl"><img src="../Images/8856aa88faef055ba59650950fccc51f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0ARHUkBL4uDB9lEmLk1Rbw.png"/></div></div></figure><h2 id="349e" class="ni ky iq bd kz nt nu dn ld nv nw dp lh kj nx ny ll kn nz oa lp kr ob oc lt od bi translated">获取行程—获取API/v1/行程</h2><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pm"><img src="../Images/2b702d45bfbb80c9658e3bd7d4d442b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E2G0aPESO_9lVJrK9Nuuqw.png"/></div></div></figure><h2 id="e6b3" class="ni ky iq bd kz nt nu dn ld nv nw dp lh kj nx ny ll kn nz oa lp kr ob oc lt od bi translated">取消行程—修补api/v1/trips/:tripId</h2><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pl"><img src="../Images/3be715913f0db58b118ee663780e6e9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vDK7JRD773W95yt4TP-_ig.png"/></div></div></figure><h2 id="c559" class="ni ky iq bd kz nt nu dn ld nv nw dp lh kj nx ny ll kn nz oa lp kr ob oc lt od bi translated">创建预订—发布API/v1/预订</h2><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pn"><img src="../Images/2534cca34684686b28b633552a510065.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LANHYTjOzc_OgdITL13tfA.png"/></div></div></figure><h2 id="8633" class="ni ky iq bd kz nt nu dn ld nv nw dp lh kj nx ny ll kn nz oa lp kr ob oc lt od bi translated">获取预订—获取API/v1/预订</h2><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi po"><img src="../Images/f96ad10a742d6414324cb9ba6f0b903e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XG1wu5U6DAQntlMIY3dO0A.png"/></div></div></figure><h1 id="02cc" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">结论</h1><p id="af30" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们刚刚成功构建了我们的运输后端应用程序。如果你走了这么远，恭喜你，✌.<br/>当然，在学习本教程的过程中，如果你有任何疑问或问题，请留下你的评论，我们会尽快回复你。<br/>再次感谢阅读、鼓掌和分享！👌</p><p id="c986" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<a class="ae kw" href="https://twitter.com/beveloper" rel="noopener ugc nofollow" target="_blank"> Twitter上关注我</a>我们来讨论一下。</p><p id="4c83" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">点击查看完整代码<a class="ae kw" href="https://github.com/krofax/Transport-Booking-Backend-Api" rel="noopener ugc nofollow" target="_blank"/></p><h1 id="31a1" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">资源</h1><ol class=""><li id="c467" class="mh mi iq ka b kb lv kf lw kj mj kn mk kr ml kv ov mn mo mp bi translated"><a class="ae kw" href="https://agilitycms.com/resources/posts/why-you-as-a-developer-should-be-using-a-cms" rel="noopener ugc nofollow" target="_blank">作为开发人员，你为什么应该使用CMS </a></li><li id="612b" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv ov mn mo mp bi translated"><a class="ae kw" href="https://agilitycms.com/resources/posts/headless-commerce-explained-definitions-use-cases-and-roadblocks" rel="noopener ugc nofollow" target="_blank">无头商务解释:定义、用例、障碍|敏捷CMS </a></li><li id="a300" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv ov mn mo mp bi translated"><a class="ae kw" href="https://agilitycms.com/resources/posts/apis-vs-sdks-what-s-the-difference" rel="noopener ugc nofollow" target="_blank">API vs . SDK:有什么区别？|敏捷CMS </a></li><li id="baa2" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv ov mn mo mp bi translated"><a class="ae kw" href="https://agilitycms.com/resources/posts/static-site-generators" rel="noopener ugc nofollow" target="_blank">2021年最值得关注的静态站点发电机</a></li><li id="a83e" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv ov mn mo mp bi translated"><a class="ae kw" href="https://agilitycms.com/resources/posts/what-s-the-difference-between-headless-cms-and-static-site-generator/" rel="noopener ugc nofollow" target="_blank">https://agility CMS . com/resources/posts/what-s-the-difference-between-headless-CMS-and-static-site-generator/</a></li><li id="e57f" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv ov mn mo mp bi translated"><a class="ae kw" href="https://agilitycms.com/resources/posts/what-is-netlify-and-why-should-you-care-as-an-editor" rel="noopener ugc nofollow" target="_blank">什么是网络生活，作为一名编辑，你为什么要关心它？|敏捷CMS </a></li><li id="9f4f" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv ov mn mo mp bi translated"><a class="ae kw" href="https://agilitycms.com/resources/guide/what-is-a-headless-cms" rel="noopener ugc nofollow" target="_blank">什么是无头CMS？|敏捷CMS </a></li><li id="c80a" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv ov mn mo mp bi translated"><a class="ae kw" href="https://agilitycms.com/resources/guide/top-10-reasons-why-you-should-choose-a-headless-cms-over-a-traditional-cms" rel="noopener ugc nofollow" target="_blank">无头CMS相对于传统CMS的优势|敏捷CMS </a></li><li id="7b7c" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv ov mn mo mp bi translated"><a class="ae kw" href="https://agilitycms.com/resources/posts/content-architecture" rel="noopener ugc nofollow" target="_blank">内容架构:组织和管理内容和团队的关键</a></li><li id="6896" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv ov mn mo mp bi translated"><a class="ae kw" href="https://agilitycms.com/resources/posts/wordpress-vs-agility-cms" rel="noopener ugc nofollow" target="_blank"> WordPress及其替代品:无头CMS |敏捷性CMS </a></li><li id="8dbb" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv ov mn mo mp bi translated"><a class="ae kw" href="https://agilitycms.com/resources/whitepaper/proprietary-vs-open-source-content-management-systems" rel="noopener ugc nofollow" target="_blank">开源CMS与专有CMS:您能两全其美吗？敏捷性| CMS</a></li><li id="3c6e" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv ov mn mo mp bi translated"><a class="ae kw" href="https://agilitycms.com/resources/posts/react-cms" rel="noopener ugc nofollow" target="_blank">选择反应型细胞质雄性不育系:寻找什么？敏捷性| CMS</a></li><li id="0ef6" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv ov mn mo mp bi translated"><a class="ae kw" href="https://agilitycms.com/resources/posts/content-modelling" rel="noopener ugc nofollow" target="_blank">掌控您的内容架构:内容建模</a></li><li id="efff" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv ov mn mo mp bi translated"><a class="ae kw" href="https://agilitycms.com/resources/posts/the-benefits-of-a-hybrid-dxp" rel="noopener ugc nofollow" target="_blank"> DXP vs无头CMS:现代DXP建筑</a></li><li id="0253" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv ov mn mo mp bi translated">Jamstack开发:<a class="ae kw" href="https://agilitycms.com/resources/posts/top-jamstack-pioneers" rel="noopener ugc nofollow" target="_blank">2021年您需要了解的10位JAMstack先驱</a></li></ol></div></div>    
</body>
</html>