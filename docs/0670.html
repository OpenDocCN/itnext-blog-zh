<html>
<head>
<title>How to make an authoritative game server with PubNub</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用PubNub做一个权威的游戏服务器</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-make-an-authoritative-game-server-with-pubnub-723264518adc?source=collection_archive---------10-----------------------#2018-05-02">https://itnext.io/how-to-make-an-authoritative-game-server-with-pubnub-723264518adc?source=collection_archive---------10-----------------------#2018-05-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d685" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我见过的大多数用PubNub制作游戏的教程只是在客户端之间传递消息。这意味着游戏完全信任每个客户。这是一个很好的学习方法，但是在实践中(尤其是HTML5游戏),用户很容易破解你的游戏！他们所要做的只是改变广播他们位置(或任何其他重要数据)的代码，突然之间其他客户都认为他们可以飞了。</p><p id="ea7a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl"> PubNub的功能和数据存储特性</em>允许我们把一个频道变成一个完全权威的服务器。</p><p id="345f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我做了一个简单的皇家战役游戏和iOS客户端来演示功能。代码可以在这篇文章底部的源代码部分找到。我会把注意力放在大众方面。</p><p id="2079" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">玩家可以加入游戏，等到游戏开始，再互相攻击。这是它的样子。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/270d6e2f38bebd163c9cde4b331a5cea.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/1*Um7xpZOhhn0fX_Jnac70vA.gif"/></div></figure><p id="ff9a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在是代码！</p><h1 id="63cc" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated"><strong class="ak">功能1 </strong></h1><p id="9865" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">我们需要做的第一件事是创建一个在发布或触发之前发生的函数。<a class="ae lx" href="https://www.pubnub.com/docs/tutorials/pubnub-functions" rel="noopener ugc nofollow" target="_blank">这里有一个关于创建函数的快速教程</a>。我们需要这发生在消息发布之前，这样我们可以确保游戏状态确实存在。</p><h1 id="5bd4" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated"><strong class="ak">创建游戏状态和添加玩家状态</strong></h1><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ly lz l"/></div></figure><p id="2331" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于导入，默认情况下我们得到的只有<code class="fe ma mb mc md b">kvstore</code>和<code class="fe ma mb mc md b">xhr</code>。<code class="fe ma mb mc md b">kvstore</code>是我们用来存储数据的<a class="ae lx" href="https://www.pubnub.com/docs/blocks/kvstore-module" rel="noopener ugc nofollow" target="_blank"/>和<code class="fe ma mb mc md b">xhr</code> <a class="ae lx" href="https://www.pubnub.com/docs/blocks/xhr-module" rel="noopener ugc nofollow" target="_blank">处理http请求</a>，我们并不真的需要它们。我们需要添加<code class="fe ma mb mc md b">pubnub</code>，这样我们就可以<a class="ae lx" href="https://www.pubnub.com/docs/blocks/pubnub-module" rel="noopener ugc nofollow" target="_blank">向玩家发布消息</a>。</p><p id="cb1d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">这个权威策略的主要概念是在我们从数据库获得游戏状态后处理消息。</strong>在每一个函数中，一旦我们得到了游戏状态，我们会用它来决定做什么，然后在函数结束时更新它。</p><p id="b08d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第6行</strong>从响应中获取消息对象。为了方便起见，我们将在每个函数中这样做。</p><p id="07c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第8行</strong>将从数据库中检索一个带有关键字“gameState”的对象，而<code class="fe ma mb mc md b">.then</code>回调将把检索到的数据作为<code class="fe ma mb mc md b">gameState</code>提供给我们。现在我们有了数据，我们需要确保它存在。</p><p id="246b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第11行</strong>检查游戏状态是否不存在(或者我们是否发送了一个“重置-游戏状态”消息，这对调试真的很有帮助)。</p><p id="65f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第13–18行</strong>将用我们默认的游戏状态更新<code class="fe ma mb mc md b">gameState</code>变量</p><p id="667d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第26–29行将会把我们新的游戏状态推送到数据库中。</p><h1 id="4893" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated"><strong class="ak">向游戏状态添加玩家</strong></h1><p id="8715" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">现在我们已经有了我们的游戏状态，我们需要在玩家加入时添加他们。这将替换TODO注释。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ly lz l"/></div></figure><p id="26ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们确保该消息是一个“加入”消息。如果玩家的uuid在我们的playerStates对象中还不存在，我们为他们创建一个playerState。<strong class="jp ir">玩家状态可以包含关于玩家的任何信息，比如他们的用户名、状态等等。</strong>对于这个例子，我只需要知道他们是否准备好了，他们的健康状况如何。</p><p id="63e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为示例游戏是皇家战役，所以我需要玩家总数。随后，当人们准备好了，我们会将准备好的玩家与此进行比较，以告知游戏应该何时开始。</p><p id="5570" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">然后我们向所有玩家发布这个新的游戏状态</strong>。我们需要将整个游戏状态发送到这里，以确保这个新玩家是最新的。这也将更新这个新玩家的游戏状态！</p><h1 id="4481" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated"><strong class="ak">功能2 </strong></h1><p id="8000" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">我们现在需要创建一个在发布之后发生的函数。这个功能将是游戏的核心。它将处理玩家互动和更新游戏状态。我会把这个分成小块。</p><p id="3754" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">设置</strong></p><p id="d7c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们首先设置函数的核心。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ly lz l"/></div></figure><p id="d8dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这和上一个函数看起来很像。</p><p id="d52e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从游戏状态中获取玩家的状态</p><p id="dd2e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第16–25行处理零散信息。用户可能会在错误的时间发送消息，如果他们的客户端有点落后，或者他们可能会试图攻击别人。</p><p id="79c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ma mb mc md b">return request.okay()</code>将返回一个响应并退出该功能。</p><p id="2834" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第28–32行是我们服务器的核心。他们检查游戏的状态，然后相应地处理消息。我一会儿会解释每一个的内容。</p><p id="8f9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第34–41行</strong>向所有玩家发送更新的游戏状态。这是一种昂贵且低效的方法，可以改进。你应该只发送小的状态变化给玩家，只有当玩家加入时才发送完整的游戏状态。如果你的游戏中有100个玩家，这个游戏状态会变得非常大。我这样做是为了加快客户端的开发。我只需要更新这条消息的状态，而不是一堆消息。</p><p id="425e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> TODO 1(下面)有一个为小的状态变化更新客户端状态的例子。</strong></p><p id="235a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我们更新数据库中的状态，现在每个人都跟上了速度！</p><h1 id="20d8" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated"><strong class="ak"> TODO 1:如果游戏状态是等待</strong></h1><p id="c565" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">如果游戏状态是等待，我们只需要担心玩家发送“就绪”消息。如果所有玩家都准备好了，我们也将开始游戏。其他任何消息都只是玩家想偷偷摸摸的。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ly lz l"/></div></figure><p id="b50e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第2–7行</strong>如果我们得到一个就绪信息，只需更新该玩家的状态并添加到活跃玩家中。</p><p id="29a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第10–19行</strong>将检查是否所有玩家都准备好了。如果是，它将更新游戏状态，并向所有玩家发送游戏已经开始的消息。<strong class="jp ir">我把它放在这里作为更新客户端游戏状态而不发送整个游戏状态的例子。</strong>每一个改变游戏状态的动作，都要发送一条小消息告诉玩家发生了什么。</p><h1 id="9e58" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated"><strong class="ak"> TODO 2:如果游戏正在进行</strong></h1><p id="e79b" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">如果游戏正在进行，我们需要处理玩家的交互。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ly lz l"/></div></figure><p id="a909" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我的示例游戏中，唯一的交互是攻击，所以这是我们需要检查的唯一信息。</p><p id="d5d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第2–3行</strong>会获得目标玩家的状态，并递减其生命值。我设置了一个<code class="fe ma mb mc md b">DEFAULT_DAMAGE</code>常量来简化事情，但是对于一个更复杂的游戏，这个常量可以从发送者的玩家状态中获取！</p><p id="8f0e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第7–10行</strong>查看目标玩家是否死亡。如果他们这样做了，减少活跃的球员。这基本上是说，如果他们死了，游戏中就少了一个玩家。</p><p id="a5cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第13–27行</strong>查看游戏是否应该结束。由于我们没有运行的游戏循环，我们需要在重要的消息中进行这些检查。我们检查是否只剩下一个活跃的玩家，如果是，我们重置游戏状态，并向所有玩家发送“赢”消息。</p><p id="5875" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">注意:</strong>在我的客户端上，当有人获胜时，我让所有用户取消订阅该频道，这意味着他们必须重新加入游戏。如果你想让用户留在游戏中，不要重置游戏状态，只需重置玩家状态。</p><h1 id="e3bb" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated"><strong class="ak">结论</strong></h1><p id="27f4" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">就是这样！只要所有改变游戏的消息更新游戏状态，并且服务器向客户端发送更新，PubNub就可以作为简单游戏的权威游戏服务器。</p><p id="7794" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我没有展示一些代码，比如处理存在和玩家的离开，但是这里有PubNub函数的源代码！</p><p id="9584" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">源代码:</p><p id="3cc3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lx" href="https://github.com/diericx/TapRoyale" rel="noopener ugc nofollow" target="_blank"> Swift客户端</a></p><p id="3b16" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lx" href="https://github.com/diericx/PubNub-AuthoritativeGameServer" rel="noopener ugc nofollow" target="_blank"> PubNub功能</a></p></div></div>    
</body>
</html>