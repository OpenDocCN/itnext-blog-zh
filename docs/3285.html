<html>
<head>
<title>Running a fully trusted GitLab Pipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">运行完全受信任的GitLab管道</h1>
<blockquote>原文：<a href="https://itnext.io/running-a-fully-trusted-gitlab-pipeline-a1f69475e7a7?source=collection_archive---------7-----------------------#2019-11-13">https://itnext.io/running-a-fully-trusted-gitlab-pipeline-a1f69475e7a7?source=collection_archive---------7-----------------------#2019-11-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="5065" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如您已经注意到的，我们的目标是让code公证人集成对您来说尽可能简单。这就是为什么我们的博文系列继续使用<a class="ae kl" href="http://www.gitlab.com/" rel="noopener ugc nofollow" target="_blank"> GitLab </a>的原因。到目前为止，我们已经介绍了<a class="ae kl" href="https://www.codenotary.io/securing-your-azure-devops-ecosystem-jenkins-and-kubernetes-aks-using-codenotary-part-1/" rel="noopener ugc nofollow" target="_blank">詹金斯</a>和<a class="ae kl" href="https://www.codenotary.io/validated-builds-using-circleci-ci-cd/" rel="noopener ugc nofollow" target="_blank"> CircleCI </a>，如果你也想看的话。对于这篇博文，我们使用GitLab CE安装。</p><p id="a932" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这一次，我们比前几篇文章更进一步，还集成了一个Git库检查。</p><p id="73d2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这些检查将如下所示:</p><ul class=""><li id="9767" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">认证Git存储库</li><li id="8292" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">如果可信，基于存储库构建容器映像</li><li id="5612" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">发布前公证容器图像</li><li id="cab0" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">将容器映像发布到您的注册表</li></ul><p id="495a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们开始吧！</p><h1 id="9e19" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">先检查我们的需求</h1><p id="bccf" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">因为我们只想使用经过公证的git提交，所以我们需要一个code公证人帐户和本地安装在Git旁边的vcn。</p><ol class=""><li id="bc6a" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk md ks kt ku bi translated"><a class="ae kl" href="https://dashboard.codenotary.io/auth/signup" rel="noopener ugc nofollow" target="_blank">公证账户(完全免费)</a></li><li id="e21d" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk md ks kt ku bi translated"><a class="ae kl" href="https://github.com/vchain-us/vcn/releases/latest" rel="noopener ugc nofollow" target="_blank">下载vcn </a> &amp;登录vcn</li><li id="cdfe" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk md ks kt ku bi translated">为DockerHub和code公证人设置项目中的变量</li></ol><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi me"><img src="../Images/1c53fbb2d57ee3cd2927d12182458a52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fhYVxXe2QdiNNSwD.png"/></div></div></figure><ul class=""><li id="7840" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">code公证人_用户</li><li id="331c" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">公证员_通行证</li><li id="4cc2" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">dockerhub(类型<em class="mq"> docker信息</em>，在我们的例子中:<a class="ae kl" href="https://index.docker.io/v1/)" rel="noopener ugc nofollow" target="_blank">https://index.docker.io/v1/)</a></li><li id="b84a" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">dockerhub_user</li><li id="569e" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">dockerhub_pass</li></ul><h1 id="02f6" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">设置。gitlab-ci.yml</h1><p id="5186" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">像大多数CI/CD管道一样，我们从基本设置开始。确保创建。存储库中的gitlab-ci.yml文件:</p><pre class="mf mg mh mi gt mr ms mt mu aw mv bi"><span id="8310" class="mw lb iq ms b gy mx my l mz na">image: docker:18<br/><br/>stages:<br/>  - authgit<br/>  - build<br/>  - notarize<br/>  - push<br/><br/>variables:<br/>    CONTAINER_IMAGE: "&lt;dockerhub_repository_name&gt;"<br/><br/><br/>before_script:<br/>  - echo -n $dockerhub_pass | docker login -u $dockerhub_user --password-stdin $dockerhub</span></pre><p id="8a51" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里，我们将Container_image设置为我们想要使用的Dockerhub注册表(即用户/图像),并登录到Dockerhub</p><h1 id="503d" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">鉴定来源</h1><p id="25d1" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">下一步是对源代码进行认证，以确保在构建过程中只使用经过公证的git提交。在那篇文章中，我们使用的是vcn版本0.7.3，但是你也可以使用最新的版本。</p><p id="b8dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，因为我们使用基于Alpine OS的映像来使用vcn的静态链接版本。</p><p id="797e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最重要的是，我们希望确保没有人篡改我们下载的vcn可执行文件，因此我们使用带有curl的code公证人. io API进行独立检查。</p><pre class="mf mg mh mi gt mr ms mt mu aw mv bi"><span id="f17c" class="mw lb iq ms b gy mx my l mz na"># Authenticate Git source<br/>Authenticate Git:<br/>  stage: authgit<br/>  script:<br/>    - apk add --no-cache curl<br/>    - curl -L -o /tmp/vcn https://github.com/vchain-us/vcn/releases/download/v0.7.3/vcn-v0.7.3-linux-amd64-static<br/>    - CHECKSUM=$(sha256sum /tmp/vcn | cut -d " " -f 1)<br/>    - echo $CHECKSUM<br/>    - curl -s https://api.codenotary.io/authenticate/$CHECKSUM?org=vchain.us | grep -q :0<br/>    - chmod +x /tmp/vcn<br/>    - /tmp/vcn a git://$CI_PROJECT_DIR</span></pre><p id="d199" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">vcn git://$ CI _ PROJECT _ DIR用于认证我们在项目管道中使用的存储库。</p><p id="0958" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于稍后运行的管道，您总是需要确保公证最新的git提交。</p><p id="603f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">因此，如果我们批准了最新的变更，我们需要提取并公证它们:</strong></p><ul class=""><li id="1467" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">git拉</li><li id="8102" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">git://repository-folder</li></ul><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nb"><img src="../Images/a4a83aba8a9db6c6c2090635b5e6ce75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5GsaOwPFS1XwZQwA.png"/></div></div></figure><p id="aa13" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">重要提示:在测试或使用私有存储库时，您应该只使用匿名身份验证。强烈建议仅对org或signer标志使用authenticate。</p><p id="af9a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> vcn a帮助</strong>:</p><pre class="mf mg mh mi gt mr ms mt mu aw mv bi"><span id="ffa7" class="mw lb iq ms b gy mx my l mz na">-I, --org string         accept only authentications matching the passed organisation's ID,<br/>                           if set no SignerID can be used<br/>                           (overrides VCN_ORG env var, if any)<br/>  -s, --signerID strings   accept only authentications matching the passed SignerID(s)<br/>                           (overrides VCN_SIGNERID env var, if any)</span></pre><h1 id="a2e4" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">建立形象</h1><p id="5e2a" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">我们将构建容器图像，并仅使用哈希来推送它，但没有额外的标记。这将在后面的步骤中发生。</p><pre class="mf mg mh mi gt mr ms mt mu aw mv bi"><span id="9683" class="mw lb iq ms b gy mx my l mz na">Build:<br/>  stage: build<br/>  script:<br/>    - &gt;<br/>      docker build<br/>      --pull<br/>      --build-arg VCS_REF=$CI_COMMIT_SHA<br/>      --build-arg VCS_URL=$CI_PROJECT_URL<br/>      --tag $CONTAINER_IMAGE:$CI_COMMIT_SHA<br/>      .<br/>    - docker push $CONTAINER_IMAGE:$CI_COMMIT_SHA</span></pre><h1 id="375d" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">公证集装箱图像</h1><p id="b1ed" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">这主要是对之前其他构建步骤中的身份验证步骤的复制。原因是，您无法知道是否只有一个或不同的GitLab运行程序在执行任务，因此我们确保它们总是处于同一阶段:</p><pre class="mf mg mh mi gt mr ms mt mu aw mv bi"><span id="dbb8" class="mw lb iq ms b gy mx my l mz na"># notarize container<br/>Notarize:<br/>  stage: notarize<br/>  script:<br/>    - apk add --no-cache curl<br/>    - curl -L -o /tmp/vcn https://github.com/vchain-us/vcn/releases/download/v0.7.3/vcn-v0.7.3-linux-amd64-static<br/>    - CHECKSUM=$(sha256sum /tmp/vcn | cut -d " " -f 1)<br/>    - echo $CHECKSUM<br/>    - curl -s https://api.codenotary.io/authenticate/$CHECKSUM?org=vchain.us | grep -q :0<br/>    - chmod +x /tmp/vcn<br/>    - VCN_USER=$codenotary_user VCN_PASSWORD=$codenotary_pass /tmp/vcn login<br/>    - VCN_NOTARIZATION_PASSWORD=$codenotary_pass /tmp/vcn n --attr GitLab="$CI_COMMIT_SHA" docker://$CONTAINER_IMAGE:latest</span></pre><h1 id="9715" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">推送图像</h1><p id="5be6" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">最后的步骤是关于使用不同的标签、校验和(对GitLab作业的引用)和latest来推送新构建的容器映像。</p><pre class="mf mg mh mi gt mr ms mt mu aw mv bi"><span id="7ca2" class="mw lb iq ms b gy mx my l mz na"># Here, the goal is to tag the "master" branch as "latest"<br/>Push latest:<br/>  variables:<br/>    GIT_STRATEGY: none<br/>  stage: push<br/>  only:<br/>    # Only "master" should be tagged "latest"<br/>    - master<br/>  script:<br/>    # no guarantee that this job will be picked up by the same runner <br/>    # that built the image in the previous step, pull it again locally<br/>    - docker pull $CONTAINER_IMAGE:$CI_COMMIT_SHA<br/>    # Then we tag it "latest"<br/>    - docker tag $CONTAINER_IMAGE:$CI_COMMIT_SHA $CONTAINER_IMAGE:latest<br/>    # push it.<br/>    - docker push $CONTAINER_IMAGE:latest<br/><br/>Push tag:<br/>  variables:<br/>    GIT_STRATEGY: none<br/>  stage: push<br/>  only:<br/>    # run on tags only.<br/>    - tags<br/>  script:<br/>    - docker pull $CONTAINER_IMAGE:$CI_COMMIT_SHA<br/>    - docker tag $CONTAINER_IMAGE:$CI_COMMIT_SHA $CONTAINER_IMAGE:$CI_COMMIT_REF_NAME<br/>    - docker push $CONTAINER_IMAGE:$CI_COMMIT_REF_NAME</span></pre><h1 id="7e6c" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">结果</h1><p id="f8b6" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">当更改。gitlab-ci.yml文件，因为这一更改也将阻止构建容器映像——安全第一！</p><p id="c7fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果一切顺利，您应该能够获得每一个管道步骤的绿色支票。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi me"><img src="../Images/e20ffb5133cfb0863ba5202afbcb1138.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jfkwNjWVARiWabTC.png"/></div></div></figure><p id="d4e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在另一篇博文中，我们还将介绍如何自动部署到Kubernetes中，并使用<a class="ae kl" href="https://github.com/vchain-us/kube-notary" rel="noopener ugc nofollow" target="_blank">Kube-公证人</a>集成来完成360度安全循环。</p></div><div class="ab cl nc nd hu ne" role="separator"><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh"/></div><div class="ij ik il im in"><p id="031b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mq">原载于2019年11月13日</em><a class="ae kl" href="https://www.codenotary.io/fully-trusted-gitlab-pipeline/" rel="noopener ugc nofollow" target="_blank"><em class="mq">https://www . code公证人. io </em> </a> <em class="mq">。</em></p></div></div>    
</body>
</html>