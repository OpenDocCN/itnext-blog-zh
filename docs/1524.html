<html>
<head>
<title>Securing the Base Infrastructure of a Kubernetes Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">保护Kubernetes集群的基础设施</h1>
<blockquote>原文：<a href="https://itnext.io/securing-the-base-infrastructure-of-a-kubernetes-cluster-64e79646b7bf?source=collection_archive---------3-----------------------#2018-11-13">https://itnext.io/securing-the-base-infrastructure-of-a-kubernetes-cluster-64e79646b7bf?source=collection_archive---------3-----------------------#2018-11-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="30df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本系列<strong class="jp ir"> <em class="km">的<a class="ae kl" href="https://blog.giantswarm.io/why-is-securing-kubernetes-so-difficult/" rel="noopener ugc nofollow" target="_blank">第一篇文章</a>讨论了为什么难以保护Kubernetes，以及在我们着手保护该平台时需要注意的各个层面。</em></strong></p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi kn"><img src="../Images/daa7f897d9c222ed6f80789c26da9478.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2-UD1Rb2Qt01mWfDK83RYw.png"/></div></div></figure><p id="e6e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">堆栈中的第一层是基础架构层。我们可以用许多不同的方式来定义它，但是出于我们讨论的目的，它是部署Kubernetes的基础设施组件的总和。它是用于计算、存储和网络目的的物理或抽象硬件层，以及这些资源所在的环境。它还包括操作系统，很可能是Linux，以及一个容器运行时环境，比如Docker。</p><p id="c2e7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将讨论的大部分内容同样适用于支撑Kubernetes之外的系统的基础设施组件，但我们将特别关注那些将增强Kubernetes安全性的因素。</p><h1 id="dde1" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">机器、数据中心和公共云</h1><p id="5e6a" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">采用云作为工作负载部署的工具，无论是公共、私有还是混合云，都在快速发展。虽然对专业裸机服务器配置的需求尚未完全消失，但支撑当今大部分计算资源的基础架构是虚拟机。然而，如果我们部署的机器是虚拟的(基于云或其他方式)或物理的，这并不重要，实体将驻留在数据中心，由我们自己的组织或选定的第三方(如公共云提供商)托管。</p><p id="a131" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">数据中心很复杂，在考虑安全性时，需要考虑的内容非常多。它是一种通用资源，用于托管整个组织的数据处理需求，甚至是来自不同行业和地理位置的众多独立组织的租赁工作负载。出于这个原因，在这个层次上对基础设施的许多不同方面应用安全性，往往是一个成熟的公司或供应商的责任。它将根据国家或国际法规(<a class="ae kl" href="https://www.hhs.gov/hipaa/for-professionals/privacy/index.html" rel="noopener ugc nofollow" target="_blank"> HIPAA </a>、<a class="ae kl" href="https://ec.europa.eu/commission/priorities/justice-and-fundamental-rights/data-protection/2018-reform-eu-data-protection-rules_en" rel="noopener ugc nofollow" target="_blank"> GDPR </a>)、行业合规性要求(<a class="ae kl" href="https://www.pcisecuritystandards.org/pci_security/how" rel="noopener ugc nofollow" target="_blank"> PCI DSS </a>)等因素进行管理，并且通常会追求认证标准认可(<a class="ae kl" href="https://www.iso.org/isoiec-27001-information-security.html" rel="noopener ugc nofollow" target="_blank"> ISO 27001 </a>、<a class="ae kl" href="https://www.nist.gov/itl/current-fips" rel="noopener ugc nofollow" target="_blank"> FIPS </a>)。</p><p id="1875" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在公共云环境的情况下，供应商可以并将在基础架构层提供对法规和合规性标准的必要遵守，但在某种程度上，它归结为服务消费者(您和我)，以进一步构建这一安全基础。这是一个共同的责任。作为公共云服务的消费者，这就引出了一个问题，“我应该保护什么，我应该如何做？”有很多人对这个话题有很多看法，但一个可信的实体是互联网安全中心(CIS)(T11)，这是一个非营利组织，致力于保护公共和私人实体免受恶意网络活动的威胁。</p><h1 id="a0b2" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">CIS基准</h1><p id="a752" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">CIS提供了一系列工具、技术和信息，用于应对我们所依赖的系统和数据面临的潜在威胁。<a class="ae kl" href="https://www.cisecurity.org/cis-benchmarks/" rel="noopener ugc nofollow" target="_blank">例如，CIS基准</a>是基于平台的安全最佳实践配置指南，由安全专业人员和主题专家共同编制。随着越来越多的组织开始实施转型计划(包括迁移到公共和/或混合云基础架构), CIS已经将为主要公共云提供商提供基准作为自己的工作。<a class="ae kl" href="https://www.cisecurity.org/benchmark/amazon_web_services/" rel="noopener ugc nofollow" target="_blank"> CIS亚马逊网络服务基础基准</a>就是一个例子，其他主要公共云提供商也有类似的基准。</p><p id="1ec9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这些基准提供基本的安全配置建议，涵盖身份和访问管理(IAM)、入口和出口、日志记录和监控最佳实践等。实施这些基准建议是一个很好的开始，但它不应该是旅程的终点。每个公共云提供商都将有自己的一套详细的推荐最佳实践<a class="ae kl" href="https://blog.giantswarm.io/securing-the-base-infrastructure-of-a-kubernetes-cluster/#fn:1" rel="noopener ugc nofollow" target="_blank"> 1 </a>、<a class="ae kl" href="https://blog.giantswarm.io/securing-the-base-infrastructure-of-a-kubernetes-cluster/#fn:2" rel="noopener ugc nofollow" target="_blank"> 2 </a>、<a class="ae kl" href="https://blog.giantswarm.io/securing-the-base-infrastructure-of-a-kubernetes-cluster/#fn:3" rel="noopener ugc nofollow" target="_blank"> 3 </a>，并且可以从该领域的其他专家意见中受益匪浅，例如<a class="ae kl" href="https://cloudsecurityalliance.org/" rel="noopener ugc nofollow" target="_blank">云安全联盟</a>。</p><p id="78d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们花点时间来看看一个典型的基于云的场景，它需要从安全角度进行一些仔细的规划。</p><h1 id="225b" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">云场景:私有网络与公共网络</h1><p id="80ed" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">我们如何通过限制访问来平衡保持Kubernetes集群安全的需求，同时允许外部客户通过互联网以及从我们自己的组织内部进行所需的访问？</p><ul class=""><li id="6382" class="mc md iq jp b jq jr ju jv jy me kc mf kg mg kk mh mi mj mk bi translated"><strong class="jp ir">为托管Kubernetes的机器使用专用网络</strong> —确保代表集群节点的主机没有公共IP地址。取消与任何主机建立直接连接的能力，会大大减少攻击的可能性。这种简单的预防措施提供了显著的好处，例如，可以防止导致利用计算资源进行加密货币挖掘的危害。</li><li id="3a92" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mh mi mj mk bi translated"><strong class="jp ir">使用堡垒主机访问私有网络</strong> —管理集群所需的对主机私有网络的外部访问应该通过适当配置的堡垒主机提供。Kubernetes API通常也会暴露在bastion主机后面的私有网络中。它也可能公开暴露，但建议至少通过将来自组织内部网络和/或其VPN服务器的IP地址列入白名单来限制访问。</li><li id="6171" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mh mi mj mk bi translated"><strong class="jp ir">使用带有内部负载平衡器/DNS的VPC对等</strong> —当在带有私有网络的Kubernetes集群中运行的工作负载需要由其他私有的集群外客户端访问时，可以通过调用内部负载平衡器的服务来公开工作负载。例如，要在AWS环境中创建一个内部负载平衡器，服务需要以下注释:<code class="fe mq mr ms mt b">service.beta.kubernetes.io/aws-load-balancer-internal: 0.0.0.0/0</code>。如果客户端驻留在另一个VPC，则需要对等VPC。</li><li id="a99a" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mh mi mj mk bi translated"><strong class="jp ir">使用带有入口的外部负载平衡器</strong> —工作负载通常被设计为由来自互联网的匿名外部客户端使用；当部署到专用网络时，如何允许流量在集群中找到工作负载？根据手头的需求，我们可以通过几种不同的方式来实现这一点。第一种选择是使用Kubernetes服务对象来公开工作负载，这将导致在公共子网上创建外部云负载平衡器服务(例如AWS ELB)。这种方法成本很高，因为每个公开的服务都会调用一个专用的负载平衡器，但对于非HTTP服务来说，这可能是首选的解决方案。对于基于HTTP的服务，更具成本效益的方法是将入口控制器部署到集群，由Kubernetes服务对象作为前端，这反过来又创建了负载平衡器。寻址到负载平衡器的DNS名称的流量被路由到入口控制器端点，入口控制器端点评估与任何定义的入口对象相关联的规则，然后进一步路由到匹配规则中的服务端点。</li></ul><p id="d0e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此场景表明，需要仔细考虑如何配置安全的基础架构，同时提供向目标受众交付服务所需的功能。这不是唯一的情况，还会有其他情况需要类似的治疗。</p><h1 id="80f4" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">锁定操作系统和容器运行时</h1><p id="8f22" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">假设我们已经研究并应用了必要的安全配置来确保机器级基础设施及其环境的安全，下一个任务是锁定每台机器的主机操作系统(OS ),以及负责管理容器生命周期的容器运行时。</p><h1 id="81cf" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">Linux操作系统</h1><p id="9234" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">虽然可以运行Microsoft Windows Server作为Kubernetes工作节点的操作系统，但通常情况下，控制平面和工作节点会运行Linux操作系统的变体。可能有许多因素决定了Linux发行版的选择(商业、内部技能、操作系统成熟度)，但是如果可能的话，使用专为运行容器而设计的最小发行版。例子包括<a class="ae kl" href="https://coreos.com/os/docs/latest/" rel="noopener ugc nofollow" target="_blank"> CoreOS Container Linux </a>、<a class="ae kl" href="https://www.ubuntu.com/core" rel="noopener ugc nofollow" target="_blank"> Ubuntu Core </a>和<a class="ae kl" href="https://www.projectatomic.io/" rel="noopener ugc nofollow" target="_blank"> Atomic Host </a>变种。这些操作系统已经被精简到最低限度，以方便大规模运行容器，因此，攻击面大大减少。</p><p id="57e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">同样，ci为不同风格的Linux提供了许多不同的基准，为保护操作系统提供了最佳实践建议。这些基准涵盖了可能被认为是主流的Linux发行版，如RHEL、Ubuntu、SLES、Oracle Linux和Debian。如果您的首选发行版没有包括在内，有一个独立于<a class="ae kl" href="https://www.cisecurity.org/benchmark/distribution_independent_linux/" rel="noopener ugc nofollow" target="_blank">发行版的</a> CIS基准，通常还有特定于发行版的指南，例如<a class="ae kl" href="https://coreos.com/os/docs/latest/hardening-guide.html" rel="noopener ugc nofollow" target="_blank">CoreOS Container Linux Hardening Guide</a>。</p><h1 id="487c" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">码头引擎</h1><p id="6b4a" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">基础设施层的最后一个组件是容器运行时。在Kubernetes的早期，没有可用的选择；容器运行时必然是Docker引擎。然而，随着Kubernetes <a class="ae kl" href="https://kubernetes.io/blog/2016/12/container-runtime-interface-cri-in-kubernetes/" rel="noopener ugc nofollow" target="_blank">容器运行时接口</a>的出现，有可能移除对Docker引擎的依赖，支持运行时，如<a class="ae kl" href="http://cri-o.io/" rel="noopener ugc nofollow" target="_blank"> CRI-O </a>、<a class="ae kl" href="https://containerd.io/" rel="noopener ugc nofollow" target="_blank"> containerd </a>或<a class="ae kl" href="https://github.com/kubernetes/frakti" rel="noopener ugc nofollow" target="_blank"> Frakti </a>。<a class="ae kl" href="https://blog.giantswarm.io/securing-the-base-infrastructure-of-a-kubernetes-cluster/#fn:4" rel="noopener ugc nofollow" target="_blank"> 4 </a>事实上，从Kubernetes版本1.12开始，一个alpha特性(<a class="ae kl" href="https://kubernetes.io/docs/concepts/containers/runtime-class/" rel="noopener ugc nofollow" target="_blank">运行时类</a>)允许在一个集群中并行运行多个容器运行时。无论部署哪个容器运行时，它们都需要保护。</p><p id="953f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">尽管有多种选择，Docker引擎仍然是Kubernetes的默认容器运行时(尽管在不久的将来可能会改为containerd)，我们将在这里考虑它的安全含义。它构建了大量可配置的安全设置，其中一些默认情况下是打开的，但可以在每个容器的基础上绕过。一个这样的例子是Linux内核功能的<a class="ae kl" href="https://github.com/moby/moby/blob/master/oci/defaults.go#L14-L30" rel="noopener ugc nofollow" target="_blank">白名单</a>在创建时应用于每个容器，这有助于减少运行中的容器内可用的特权。</p><p id="1c72" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">同样，CIS为Docker平台维护了一个基准，即<a class="ae kl" href="https://www.cisecurity.org/benchmark/docker/" rel="noopener ugc nofollow" target="_blank"> CIS Docker基准</a>。它提供了配置Docker守护程序以获得最佳安全性的最佳实践建议。甚至有一个方便的开源工具(脚本)，称为<a class="ae kl" href="https://github.com/docker/docker-bench-security" rel="noopener ugc nofollow" target="_blank"> Docker Bench for Security </a>，可以针对Docker引擎运行，该引擎评估系统是否符合CIS Docker基准。该工具可以定期运行，以暴露与所需配置的任何偏差。</p><p id="71c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当Docker引擎被用作Kubernetes的容器运行时，在考虑和度量它的安全配置时需要注意一些。Kubernetes忽略了Docker守护进程的许多可用功能，更倾向于自己的安全控制。例如，Docker守护进程被配置为使用<a class="ae kl" href="https://docs.docker.com/engine/security/seccomp/" rel="noopener ugc nofollow" target="_blank"> seccomp概要文件</a>将可用Linux内核系统调用的默认白名单应用到每个创建的容器。除非特别说明，Kubernetes将指示Docker从seccomp的角度创建“无约束”的pod容器，让容器可以访问每一个可用的系统调用。换句话说，可能在较低的“Docker层”配置的内容，可能会在平台堆栈的较高级别撤销。我们将在以后的文章中讨论如何减少安全上下文中的这些差异。</p><h1 id="c3a8" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">摘要</h1><p id="874b" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">将我们所有的注意力集中在一个平台的Kubernetes组件的安全配置上可能很有诱惑力。但是正如我们在本文中所看到的，较低层的基础设施组件同样重要，如果忽略了它们，后果将不堪设想。事实上，提供一个安全的基础设施层甚至可以减轻我们可能在集群层本身引入的问题。例如，保持我们节点的私密性可以防止不安全的kubelet被用于<a class="ae kl" href="https://medium.com/handy-tech/analysis-of-a-kubernetes-hack-backdooring-through-kubelet-823be5c3d67c" rel="noopener">的邪恶目的</a>。基础设施组件应该得到与Kubernetes组件本身同等的关注。</p><p id="5123" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在下一篇文章中，我们将继续讨论保护堆栈中的下一层Kubernetes集群组件的含义。</p><h1 id="7565" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">脚注</h1><ol class=""><li id="9a4f" class="mc md iq jp b jq lx ju ly jy mu kc mv kg mw kk mx mi mj mk bi translated"><a class="ae kl" href="https://aws.amazon.com/whitepapers/aws-security-best-practices/" rel="noopener ugc nofollow" target="_blank"> AWS安全最佳实践</a> <a class="ae kl" href="https://blog.giantswarm.io/securing-the-base-infrastructure-of-a-kubernetes-cluster/#fnref:1" rel="noopener ugc nofollow" target="_blank"> ↩ </a></li><li id="1713" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mx mi mj mk bi translated"><a class="ae kl" href="https://docs.microsoft.com/en-us/azure/security/security-best-practices-and-patterns" rel="noopener ugc nofollow" target="_blank"> Azure安全最佳实践和模式</a> <a class="ae kl" href="https://blog.giantswarm.io/securing-the-base-infrastructure-of-a-kubernetes-cluster/#fnref:2" rel="noopener ugc nofollow" target="_blank"> ↩ </a></li><li id="27eb" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mx mi mj mk bi translated"><a class="ae kl" href="https://cloud.google.com/docs/enterprise/best-practices-for-enterprise-organizations" rel="noopener ugc nofollow" target="_blank">企业组织最佳实践(谷歌云平台)</a> <a class="ae kl" href="https://blog.giantswarm.io/securing-the-base-infrastructure-of-a-kubernetes-cluster/#fnref:3" rel="noopener ugc nofollow" target="_blank"> ↩ </a></li><li id="914d" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mx mi mj mk bi translated">更小、更轻的容器运行时，如containerd，特别是为引导容器而构建的，本质上更安全，因为它们有专门的用途。<a class="ae kl" href="https://blog.giantswarm.io/securing-the-base-infrastructure-of-a-kubernetes-cluster/#fnref:4" rel="noopener ugc nofollow" target="_blank"> ↩ </a></li></ol><p id="1ed9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由<a class="ae kl" href="https://twitter.com/puja108" rel="noopener ugc nofollow" target="_blank">Puja Abbas si</a>——开发者倡议@ <a class="ae kl" href="https://giantswarm.io/" rel="noopener ugc nofollow" target="_blank">巨型虫群</a>撰写</p><div class="my mz gp gr na nb"><a href="https://twitter.com/puja108" rel="noopener  ugc nofollow" target="_blank"><div class="nc ab fo"><div class="nd ab ne cl cj nf"><h2 class="bd ir gy z fp ng fr fs nh fu fw ip bi translated">puja Abbas si @ kube con🇨🇳(@ puja 108)|推特</h2><div class="ni l"><h3 class="bd b gy z fp ng fr fs nh fu fw dk translated">Puja Abbassi @ KubeCon 🇨🇳的最新推文(@puja108)。开发者倡导者@ GiantSwarm &amp; Researcher主题…</h3></div><div class="nj l"><p class="bd b dl z fp ng fr fs nh fu fw dk translated">twitter.com</p></div></div><div class="nk l"><div class="nl l nm nn no nk np kx nb"/></div></div></a></div></div></div>    
</body>
</html>