<html>
<head>
<title>Learn how to use DynamoDB Streams with AWS Lambda and Go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解如何通过AWS Lambda和Go使用DynamoDB流</h1>
<blockquote>原文：<a href="https://itnext.io/learn-how-to-use-dynamodb-streams-with-aws-lambda-and-go-f7abcee4d987?source=collection_archive---------3-----------------------#2022-07-21">https://itnext.io/learn-how-to-use-dynamodb-streams-with-aws-lambda-and-go-f7abcee4d987?source=collection_archive---------3-----------------------#2022-07-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9adf" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">将DynamoDB数据从一个表复制到另一个表</h2></div><p id="51d3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这篇博文将帮助你使用<a class="ae lb" href="https://go.dev/" rel="noopener ugc nofollow" target="_blank"> Go </a>快速开始使用<a class="ae lb" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Streams.html" rel="noopener ugc nofollow" target="_blank"> DynamoDB流</a>和<a class="ae lb" href="https://docs.aws.amazon.com/lambda/latest/dg/welcome.html" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>。它将介绍如何使用AWS CDK部署整个解决方案。</p><p id="6e78" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里展示的用例非常简单。有几个<code class="fe lc ld le lf b">DynamoDB</code>表，目标是捕获其中一个表(也称为<code class="fe lc ld le lf b">source</code>表)中的数据，并将它们复制到另一个表(也称为<code class="fe lc ld le lf b">target</code>表)中，以便它可以服务于不同的查询。为了演示一个端到端的流程，还有一个<a class="ae lb" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/welcome.html" rel="noopener ugc nofollow" target="_blank"> Amazon API网关</a>，它前端有一个Lambda函数，该函数将数据保存在源<code class="fe lc ld le lf b">DynamoDB</code>表中。该表中的变化将触发另一个Lambda函数(多亏了DynamoDB流),该函数最终将数据复制到目标表中。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/e180b6e19573f2fc445b3344f1dc9ae0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bQr5FTiHu6SIzW2M.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">高层建筑</figcaption></figure><blockquote class="lw lx ly"><p id="7bbc" class="kf kg lz kh b ki kj jr kk kl km ju kn ma kp kq kr mb kt ku kv mc kx ky kz la ij bi translated"><a class="ae lb" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/SecondaryIndexes.html" rel="noopener ugc nofollow" target="_blank"> <em class="iq">全局或局部</em> </a> <em class="iq">二级指标提供类似功能。</em></p></blockquote><p id="0635" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，您已经大致了解了我们在这里想要实现的目标…</p><h1 id="b3f2" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">..让我们开始吧！</h1><p id="b9a7" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">在你继续之前，确保你已经安装了<a class="ae lb" href="https://go.dev/dl/" rel="noopener ugc nofollow" target="_blank"> Go编程语言</a> ( <strong class="kh ir"> v1.16 </strong>或更高版本)和<a class="ae lb" href="https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html#getting_started_install" rel="noopener ugc nofollow" target="_blank"> AWS CDK </a>。</p><p id="6a89" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">克隆项目并切换到正确的目录:</p><pre class="lh li lj lk gt na lf nb nc aw nd bi"><span id="891a" class="ne me iq lf b gy nf ng l nh ni">git clone https://github.com/abhirockzz/dynamodb-streams-lambda-golang</span><span id="66f4" class="ne me iq lf b gy nj ng l nh ni">cd cdk</span></pre><p id="1e9a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">开始部署… </strong></p><p id="4d26" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">..你所需要做的就是运行一个命令(<code class="fe lc ld le lf b">cdk deploy</code>，然后等待一会儿。您将看到将要创建的资源列表，需要您确认才能继续。</p><p id="56df" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">不要担心，在下一部分，我将解释发生了什么。</p><pre class="lh li lj lk gt na lf nb nc aw nd bi"><span id="f529" class="ne me iq lf b gy nf ng l nh ni">cdk deploy</span><span id="a21c" class="ne me iq lf b gy nj ng l nh ni"># output</span><span id="647e" class="ne me iq lf b gy nj ng l nh ni">Bundling asset DynamoDBStreamsLambdaGolangStack/ddb-streams-function/Code/Stage...</span><span id="8251" class="ne me iq lf b gy nj ng l nh ni">✨  Synthesis time: 5.94s</span><span id="87db" class="ne me iq lf b gy nj ng l nh ni">This deployment will make potentially sensitive changes according to your current security approval level (--require-approval broadening).<br/>Please confirm you intend to make the following modifications:</span><span id="6563" class="ne me iq lf b gy nj ng l nh ni">//.... omitted</span><span id="4cab" class="ne me iq lf b gy nj ng l nh ni">Do you wish to deploy these changes (y/n)? y</span></pre><p id="48e5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将开始创建我们的应用程序所需的AWS资源。</p><blockquote class="lw lx ly"><p id="89d9" class="kf kg lz kh b ki kj jr kk kl km ju kn ma kp kq kr mb kt ku kv mc kx ky kz la ij bi translated"><em class="iq">如果您想查看将在后台使用的AWS CloudFormation模板，运行</em> <code class="fe lc ld le lf b"><em class="iq">cdk synth</em></code> <em class="iq">并检查</em> <code class="fe lc ld le lf b"><em class="iq">cdk.out</em></code> <em class="iq">文件夹</em></p></blockquote><p id="0732" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以在终端中跟踪进度或导航到AWS控制台:<code class="fe lc ld le lf b">CloudFormation &gt; Stacks &gt; DynamoDBStreamsLambdaGolangStack</code></p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/458dc9c751e8f0cd5f2af7a21fed6728.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*u4IWxdXtRFyfStSn.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">AWS云信息堆栈</figcaption></figure><p id="fa98" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦创建了所有的资源，您就可以试用这个应用程序了。你应该有:</p><ul class=""><li id="5d2c" class="nk nl iq kh b ki kj kl km ko nm ks nn kw no la np nq nr ns bi translated">两个λ函数</li><li id="de4e" class="nk nl iq kh b ki nt kl nu ko nv ks nw kw nx la np nq nr ns bi translated">两个DynamoDB表(源和目标)</li><li id="2f07" class="nk nl iq kh b ki nt kl nu ko nv ks nw kw nx la np nq nr ns bi translated">一个API网关(也是路由、集成)</li><li id="c771" class="nk nl iq kh b ki nt kl nu ko nv ks nw kw nx la np nq nr ns bi translated">以及其他一些人(如我的角色等。)</li></ul><p id="2bbd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在继续之前，获取您将需要使用的API网关端点。它在堆栈输出中可用(在终端或AWS CloudFormation控制台的<strong class="kh ir">输出</strong>选项卡中，用于您的堆栈):</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/72e525f09ebf8ca883d73228019ea868.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Y5H_692YF2Fri-4O.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">cdk部署输出</figcaption></figure></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><h1 id="917c" class="md me iq bd mf mg of mi mj mk og mm mn jw oh jx mp jz oi ka mr kc oj kd mt mu bi translated">端到端解决方案…</h1><p id="c7db" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated"><strong class="kh ir">首先在(源)DynamoDB表中创建几个用户</strong></p><p id="cf3d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为此，使用适当的<code class="fe lc ld le lf b">JSON</code>有效负载调用API网关(HTTP)端点:</p><pre class="lh li lj lk gt na lf nb nc aw nd bi"><span id="aa60" class="ne me iq lf b gy nf ng l nh ni"># export the API Gateway endpoint<br/>export APIGW_ENDPOINT=&lt;replace with API gateway endpoint above&gt;</span><span id="0e72" class="ne me iq lf b gy nj ng l nh ni"># for example:<br/>export APIGW_ENDPOINT=https://gy8gxsx9x7.execute-api.us-east-1.amazonaws.com/</span><span id="c98b" class="ne me iq lf b gy nj ng l nh ni"># invoke the endpoint with JSON data</span><span id="bade" class="ne me iq lf b gy nj ng l nh ni">curl -i -X POST -d '{"email":"user1@foo.com", "state":"New York","city":"Brooklyn","zipcode": "11208"}' -H 'Content-Type: application/json' $APIGW_ENDPOINT</span><span id="31f0" class="ne me iq lf b gy nj ng l nh ni">curl -i -X POST -d '{"email":"user2@foo.com", "state":"New York","city":"Staten Island","zipcode": "10314"}' -H 'Content-Type: application/json' $APIGW_ENDPOINT</span><span id="06d6" class="ne me iq lf b gy nj ng l nh ni">curl -i -X POST -d '{"email":"user3@foo.com", "state":"Ohio","city":"Cincinnati","zipcode": "45201"}' -H 'Content-Type: application/json' $APIGW_ENDPOINT</span><span id="bfaa" class="ne me iq lf b gy nj ng l nh ni">curl -i -X POST -d '{"email":"user4@foo.com", "state":"Ohio","city":"Cleveland","zipcode": "44101"}' -H 'Content-Type: application/json' $APIGW_ENDPOINT</span><span id="ea2c" class="ne me iq lf b gy nj ng l nh ni">curl -i -X POST -d '{"email":"user5@foo.com", "state":"California","city":"Los Angeles","zipcode": "90003"}' -H 'Content-Type: application/json' $APIGW_ENDPOINT</span></pre><p id="e5f1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">导航到AWS控制台中的<code class="fe lc ld le lf b">DynamoDB</code>表，并确保已创建记录:</p><blockquote class="lw lx ly"><p id="c479" class="kf kg lz kh b ki kj jr kk kl km ju kn ma kp kq kr mb kt ku kv mc kx ky kz la ij bi translated"><em class="iq">如果你对AWS CLI得心应手，你也可以试试</em> <code class="fe lc ld le lf b"><em class="iq">aws dynamodb scan --table &lt;name of table&gt;</em></code></p></blockquote><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/ed612b32840f3eb82f55223e16a62e6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ACOwySAdczRn9IMp.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">源DynamoDB表中的数据</figcaption></figure><p id="f4f1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果一切顺利，我们的复制功能应该也能工作。为了确认，您需要检查目标<code class="fe lc ld le lf b">DynamoDB</code>表。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/82dd8951525854858cca2b33fe12cf04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*I-YKs6jxjd4eSN6g.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">目标DynamoDB表中的数据</figcaption></figure><blockquote class="lw lx ly"><p id="c798" class="kf kg lz kh b ki kj jr kk kl km ju kn ma kp kq kr mb kt ku kv mc kx ky kz la ij bi translated"><em class="iq">请注意，</em> <code class="fe lc ld le lf b"><em class="iq">zipcode</em></code> <em class="iq">属性丢失了——这是在本演示中故意这样做的。您可以挑选想要包含在目标表中的属性，并相应地编写函数逻辑。</em></p></blockquote><p id="9119" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">目标<code class="fe lc ld le lf b">DynamoDB</code>表将<code class="fe lc ld le lf b">state</code>作为分区键，将<code class="fe lc ld le lf b">city</code>作为排序键，您可以用不同的方式对其进行查询(相比之下，源表只能基于<code class="fe lc ld le lf b">email</code>进行查询)。</p><h1 id="9e61" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">别忘了打扫卫生！</h1><p id="2f59" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">完成后，要删除所有服务，只需使用:</p><pre class="lh li lj lk gt na lf nb nc aw nd bi"><span id="c686" class="ne me iq lf b gy nf ng l nh ni">cdk destroy</span><span id="ab75" class="ne me iq lf b gy nj ng l nh ni">#output prompt (choose 'y' to continue)</span><span id="2202" class="ne me iq lf b gy nj ng l nh ni">Are you sure you want to delete: DynamoDBStreamsLambdaGolangStack (y/n)?</span></pre><p id="eaa4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">厉害！您能够设置并尝试完整的解决方案。在我们结束之前，让我们快速浏览一下代码的一些重要部分，以便更好地理解幕后发生的事情。</p></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><h1 id="b122" class="md me iq bd mf mg of mi mj mk og mm mn jw oh jx mp jz oi ka mr kc oj kd mt mu bi translated">代码走查</h1><p id="43b1" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">因为我们将只关注重要的部分，大量的代码(打印语句，错误处理等。)为简洁起见省略/注释掉。</p><p id="0e89" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">使用自动气象站CDK和Go进行红外线编码！</strong></p><blockquote class="lw lx ly"><p id="7c60" class="kf kg lz kh b ki kj jr kk kl km ju kn ma kp kq kr mb kt ku kv mc kx ky kz la ij bi translated"><em class="iq">你可以在这里参考</em> <a class="ae lb" href="https://github.com/abhirockzz/dynamodb-streams-lambda-golang/blob/master/cdk/cdk.go" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> CDK代码</em> </a></p></blockquote><p id="92c7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们首先创建一个DynamoDB表，并确保DynamoDB流是<strong class="kh ir">启用的</strong>。</p><pre class="lh li lj lk gt na lf nb nc aw nd bi"><span id="325a" class="ne me iq lf b gy nf ng l nh ni">sourceDynamoDBTable := awsdynamodb.NewTable(stack, jsii.String("source-dynamodb-table"),<br/>        &amp;awsdynamodb.TableProps{<br/>            PartitionKey: &amp;awsdynamodb.Attribute{<br/>                Name: jsii.String("email"),<br/>                Type: awsdynamodb.AttributeType_STRING},<br/>            Stream: awsdynamodb.StreamViewType_NEW_AND_OLD_IMAGES})</span><span id="eb4d" class="ne me iq lf b gy nj ng l nh ni">   sourceDynamoDBTable.ApplyRemovalPolicy(awscdk.RemovalPolicy_DESTROY)</span></pre><p id="d5c4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们处理Lambda函数(<em class="lz">这将负责构建和部署函数</em>)，并确保我们为它提供适当的权限来写入<code class="fe lc ld le lf b">DynamoDB</code>表。</p><pre class="lh li lj lk gt na lf nb nc aw nd bi"><span id="be91" class="ne me iq lf b gy nf ng l nh ni">createUserFunction := awscdklambdagoalpha.NewGoFunction(stack, jsii.String("create-function"),<br/>        &amp;awscdklambdagoalpha.GoFunctionProps{<br/>            Runtime:     awslambda.Runtime_GO_1_X(),<br/>            Environment: &amp;map[string]*string{envVarName: sourceDynamoDBTable.TableName()},<br/>            Entry:       jsii.String(createFunctionDir)})</span><span id="9d5c" class="ne me iq lf b gy nj ng l nh ni">sourceDynamoDBTable.GrantWriteData(createUserFunction)</span></pre><p id="0e30" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建了API网关(HTTP API ),以及HTTP-Lambda函数集成和适当的路由。</p><pre class="lh li lj lk gt na lf nb nc aw nd bi"><span id="439a" class="ne me iq lf b gy nf ng l nh ni">api := awscdkapigatewayv2alpha.NewHttpApi(stack, jsii.String("http-api"), nil)</span><span id="61dd" class="ne me iq lf b gy nj ng l nh ni">    createFunctionIntg := awscdkapigatewayv2integrationsalpha.NewHttpLambdaIntegration(jsii.String("create-function-integration"), createUserFunction, nil)</span><span id="355f" class="ne me iq lf b gy nj ng l nh ni">    api.AddRoutes(&amp;awscdkapigatewayv2alpha.AddRoutesOptions{<br/>        Path:        jsii.String("/"),<br/>        Methods:     &amp;[]awscdkapigatewayv2alpha.HttpMethod{awscdkapigatewayv2alpha.HttpMethod_POST},<br/>        Integration: createFunctionIntg})</span></pre><p id="fff7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还需要<code class="fe lc ld le lf b">target</code> DynamoDB表——注意这个表有一个复合主键(<code class="fe lc ld le lf b">state</code>和<code class="fe lc ld le lf b">city</code>):</p><pre class="lh li lj lk gt na lf nb nc aw nd bi"><span id="fc05" class="ne me iq lf b gy nf ng l nh ni">targetDynamoDBTable := awsdynamodb.NewTable(stack, jsii.String("target-dynamodb-table"),<br/>        &amp;awsdynamodb.TableProps{<br/>            PartitionKey: &amp;awsdynamodb.Attribute{<br/>                Name: jsii.String("state"),<br/>                Type: awsdynamodb.AttributeType_STRING},<br/>            SortKey: &amp;awsdynamodb.Attribute{<br/>                Name: jsii.String("city"),<br/>                Type: awsdynamodb.AttributeType_STRING},<br/>        })</span><span id="1de0" class="ne me iq lf b gy nj ng l nh ni">    targetDynamoDBTable.ApplyRemovalPolicy(awscdk.RemovalPolicy_DESTROY)</span></pre><p id="6e6f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，我们创建负责数据复制的第二个Lambda函数，授予它适当的权限，最重要的是，添加<code class="fe lc ld le lf b">DynamoDB</code>作为事件源。</p><pre class="lh li lj lk gt na lf nb nc aw nd bi"><span id="bacf" class="ne me iq lf b gy nf ng l nh ni">replicateUserFunction := awscdklambdagoalpha.NewGoFunction(stack, jsii.String("replicate-function"),<br/>        &amp;awscdklambdagoalpha.GoFunctionProps{<br/>            Runtime:     awslambda.Runtime_GO_1_X(),<br/>            Environment: &amp;map[string]*string{envVarName: targetDynamoDBTable.TableName()},<br/>            Entry:       jsii.String(replicateFunctionDir)})</span><span id="8815" class="ne me iq lf b gy nj ng l nh ni">    replicateUserFunction.AddEventSource(awslambdaeventsources.NewDynamoEventSource(sourceDynamoDBTable, &amp;awslambdaeventsources.DynamoEventSourceProps{StartingPosition: awslambda.StartingPosition_LATEST, Enabled: jsii.Bool(true)}))</span><span id="f69b" class="ne me iq lf b gy nj ng l nh ni">targetDynamoDBTable.GrantWriteData(replicateUserFunction)</span></pre><p id="640e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> Lambda函数—创建用户</strong></p><blockquote class="lw lx ly"><p id="7875" class="kf kg lz kh b ki kj jr kk kl km ju kn ma kp kq kr mb kt ku kv mc kx ky kz la ij bi translated"><em class="iq">这里可以参考</em><a class="ae lb" href="https://github.com/abhirockzz/dynamodb-streams-lambda-golang/blob/master/create-function/main.go" rel="noopener ugc nofollow" target="_blank"><em class="iq">λ功能码</em> </a></p></blockquote><p id="52da" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">函数逻辑非常简单——它将传入的JSON有效负载转换成Go <code class="fe lc ld le lf b">struct</code>,然后调用<a class="ae lb" href="https://pkg.go.dev/github.com/aws/aws-sdk-go-v2/service/dynamodb#Client.PutItem" rel="noopener ugc nofollow" target="_blank"> DynamoDB PutItem API </a>来持久化数据。</p><pre class="lh li lj lk gt na lf nb nc aw nd bi"><span id="faf5" class="ne me iq lf b gy nf ng l nh ni">func handler(ctx context.Context, req events.APIGatewayV2HTTPRequest) (events.APIGatewayV2HTTPResponse, error) {<br/>    payload := req.Body<br/>    var user User</span><span id="dba3" class="ne me iq lf b gy nj ng l nh ni">    err := json.Unmarshal([]byte(payload), &amp;user)<br/>    if err != nil {//..handle}</span><span id="789e" class="ne me iq lf b gy nj ng l nh ni">    item := make(map[string]types.AttributeValue)</span><span id="baef" class="ne me iq lf b gy nj ng l nh ni">    item["email"] = &amp;types.AttributeValueMemberS{Value: user.Email}<br/>    item["state"] = &amp;types.AttributeValueMemberS{Value: user.State}<br/>    item["city"] = &amp;types.AttributeValueMemberS{Value: user.City}<br/>    item["zipcode"] = &amp;types.AttributeValueMemberN{Value: user.Zipcode}<br/>    item["active"] = &amp;types.AttributeValueMemberBOOL{Value: true}</span><span id="1525" class="ne me iq lf b gy nj ng l nh ni">    _, err = client.PutItem(context.Background(), &amp;dynamodb.PutItemInput{<br/>        TableName: aws.String(table),<br/>        Item:      item,<br/>    })</span><span id="357c" class="ne me iq lf b gy nj ng l nh ni">    if err != nil {//..handle}<br/>    return events.APIGatewayV2HTTPResponse{StatusCode: http.StatusCreated}, nil<br/>}</span></pre><p id="3dff" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">λ函数—复制数据</strong></p><blockquote class="lw lx ly"><p id="8595" class="kf kg lz kh b ki kj jr kk kl km ju kn ma kp kq kr mb kt ku kv mc kx ky kz la ij bi translated"><em class="iq">这里可以参考</em><a class="ae lb" href="https://github.com/abhirockzz/dynamodb-streams-lambda-golang/blob/master/replicate-function/main.go" rel="noopener ugc nofollow" target="_blank"><em class="iq">λ功能码</em> </a></p></blockquote><p id="5a2c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">数据复制函数的处理程序接受<a class="ae lb" href="https://pkg.go.dev/github.com/aws/aws-lambda-go/events#DynamoDBEvent" rel="noopener ugc nofollow" target="_blank"> DynamoDBEvent </a>作为参数。它提取新添加的记录并创建一个新记录，该记录可以保存到<code class="fe lc ld le lf b">target</code> DynamoDB表中。检查每个属性的数据类型，并进行相应的处理。虽然代码只显示了<code class="fe lc ld le lf b">String</code>和<code class="fe lc ld le lf b">Boolean</code>类型，但这也可以用于其他<a class="ae lb" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.NamingRulesDataTypes.html#HowItWorks.DataTypes" rel="noopener ugc nofollow" target="_blank"> DynamoDB数据类型</a>，如<code class="fe lc ld le lf b">Map</code> s、<code class="fe lc ld le lf b">Set</code> s等。</p><pre class="lh li lj lk gt na lf nb nc aw nd bi"><span id="54b6" class="ne me iq lf b gy nf ng l nh ni">func handler(ctx context.Context, e events.DynamoDBEvent) {<br/>    for _, r := range e.Records {<br/>        item := make(map[string]types.AttributeValue)</span><span id="ecdc" class="ne me iq lf b gy nj ng l nh ni">        for k, v := range r.Change.NewImage {<br/>            if v.DataType() == events.DataTypeString {<br/>                item[k] = &amp;types.AttributeValueMemberS{Value: v.String()}<br/>            } else if v.DataType() == events.DataTypeBoolean {<br/>                item[k] = &amp;types.AttributeValueMemberBOOL{Value: v.Boolean()}<br/>            }<br/>        }</span><span id="d794" class="ne me iq lf b gy nj ng l nh ni">        _, err := client.PutItem(context.Background(), &amp;dynamodb.PutItemInput{<br/>            TableName: aws.String(table),<br/>            Item:      item})</span><span id="3436" class="ne me iq lf b gy nj ng l nh ni">        if err != nil {//..handle}<br/>    }<br/>}</span></pre><blockquote class="lw lx ly"><p id="7007" class="kf kg lz kh b ki kj jr kk kl km ju kn ma kp kq kr mb kt ku kv mc kx ky kz la ij bi translated">这里有一些你可以尝试的东西</p><p id="a956" class="kf kg lz kh b ki kj jr kk kl km ju kn ma kp kq kr mb kt ku kv mc kx ky kz la ij bi translated">-在源表中插入更多数据-寻找向DynamoDB表中批量插入数据的方法</p><p id="b378" class="kf kg lz kh b ki kj jr kk kl km ju kn ma kp kq kr mb kt ku kv mc kx ky kz la ij bi translated">-基于<code class="fe lc ld le lf b">state</code>、<code class="fe lc ld le lf b">city</code>或两者在目标表中执行查询。</p></blockquote></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><h1 id="670d" class="md me iq bd mf mg of mi mj mk og mm mn jw oh jx mp jz oi ka mr kc oj kd mt mu bi translated">包裹</h1><p id="94c4" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">在这篇博客中，您看到了一个简单的例子，展示了如何结合使用DynamoDB流和Lambda函数，利用DynamoDB流对表数据的变化做出近乎实时的反应。您还使用AWS CDK部署了整个基础设施，包括API网关、Lambda函数、<code class="fe lc ld le lf b">DynamoDB</code>表、集成以及Lambda事件源映射。</p><p id="9762" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所有这些都是使用Go编程语言完成的，这在<a class="ae lb" href="https://pkg.go.dev/github.com/aws/aws-sdk-go-v2/service/dynamodb" rel="noopener ugc nofollow" target="_blank"> DynamoDB </a>、<a class="ae lb" href="https://pkg.go.dev/github.com/aws/aws-lambda-go" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>和<a class="ae lb" href="https://docs.aws.amazon.com/cdk/v2/guide/work-with-cdk-go.html" rel="noopener ugc nofollow" target="_blank"> AWS CDK </a>中得到了很好的支持。</p><p id="26c9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">快乐大厦！</p></div></div>    
</body>
</html>