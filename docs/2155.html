<html>
<head>
<title>Logrotate Setup To Manage Log Files</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">日志旋转安装程序以管理日志文件</h1>
<blockquote>原文：<a href="https://itnext.io/logrotate-setup-to-manage-log-files-74de038e9a5f?source=collection_archive---------3-----------------------#2019-04-08">https://itnext.io/logrotate-setup-to-manage-log-files-74de038e9a5f?source=collection_archive---------3-----------------------#2019-04-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/54d64a4778002269f904f706a17df72e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2aeJVuLBXgn2R3-u"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">马库斯·斯皮斯克在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="5c37" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一个晴朗的夜晚，您接到警报系统的电话，称其中一台生产服务器没有响应。您立即打开笔记本电脑并开始调试，以找到可能出错的地方。过了一段时间后，你发现它的磁盘是满的，因为日志没有被清除。由于日志对于调试和识别生产中的错误至关重要，所以您保留了它们。</p><p id="0876" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果日志管理不当，这可能就是你的故事。在当今世界，我们的应用程序会生成大量日志数据，并且可以创建GB大小的文件。大型日志文件很难调试，占用大量空间，并且会降低定期备份服务器映像和数据的速度。将日志文件保持在可管理的大小并删除无用的旧日志始终是一个好主意。为了实现这一点，我们需要一个工具来帮助我们所有的需求，这可以使用logrotate来完成。</p><p id="bfee" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">根据Logrotate <a class="ae kc" href="https://github.com/logrotate/logrotate" rel="noopener ugc nofollow" target="_blank"> Github页面</a>:</p><blockquote class="lb lc ld"><p id="5677" class="kd ke le kf b kg kh ki kj kk kl km kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated">logrotate实用程序旨在简化生成大量日志文件的系统上的日志文件管理。Logrotate允许自动循环压缩、删除和邮寄日志文件。Logrotate可以设置为每天、每周、每月或当日志文件达到一定大小时处理日志文件。</p></blockquote><p id="2756" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Logrotate可以用来做以下事情:</p><ol class=""><li id="df01" class="li lj iq kf b kg kh kk kl ko lk ks ll kw lm la ln lo lp lq bi translated">基于大小和时间旋转文件</li><li id="839a" class="li lj iq kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">将日期添加到日志文件中，这有助于调试</li><li id="8b4b" class="li lj iq kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">创建具有所需权限的新日志文件</li><li id="236e" class="li lj iq kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">删除旧的日志文件</li><li id="19be" class="li lj iq kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">在日志轮转前后运行自定义命令</li><li id="26fe" class="li lj iq kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">压缩日志文件以节省空间</li></ol><p id="3022" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们开始使用logrotate之前，让我们来看看一些用于设置的常见配置参数。</p><p id="4768" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">日志文件</strong>:我们通过列出日志文件路径，后跟一组所需的参数来定义旋转参数。在一个配置文件中，我们可以放置多个这样的配置。</p><p id="5321" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">循环计数</strong>:定义在开始删除日志文件之前，保留多少个存档日志。</p><p id="8514" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">循环间隔</strong>:定义循环日志文件的频率。这包括每日、每周、每月和每年。如果未定义，则每当logrotate运行时，它都会旋转。</p><p id="c598" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> Size </strong>:我们可以定义Size参数来指定旋转文件时的文件大小。</p><p id="3ff7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">压缩</strong>:如果我们希望我们的归档日志被压缩，我们添加这个参数。</p><p id="8442" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">命令</strong>:我们可以为日志旋转运行旋转前和旋转后命令。这可以使用参数<em class="le">预旋转</em>和<em class="le">后旋转</em>来完成。</p><p id="02fc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> missingok </strong>:该参数指定如果没有日志文件，则不输出错误。</p><p id="a9b8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们从使用Ansible命令安装logrotate开始。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="2017" class="mf mg iq mb b gy mh mi l mj mk">- name: Install logrotate<br/>  package: <br/>    name: logrotate<br/>    state: present<br/>  when: logrotate_scripts is defined</span></pre><p id="ddb5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦安装了logrotate，它将每天使用cron作业运行，该作业执行位于“/etc/cron.daily/logrotate”的脚本。我们可以在“/etc/logrotate.conf”中找到默认的logrotate配置文件，该文件包含了“/etc/logrotate.d/”中的所有配置。我们将在这个文件夹中创建所有需要的logrotate配置文件，这样当logrotate执行时，它可以为所有定义的日志文件进行旋转。在本例中，我们将使用nginx日志旋转配置。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="4716" class="mf mg iq mb b gy mh mi l mj mk">- name: Setup logrotate scripts<br/>  template:<br/>    src: logrotate.d.j2<br/>    dest: "{{ logrotate_conf_dir }}{{ item.name }}"<br/>  with_items: "{{ logrotate_scripts }}"<br/>  when: logrotate_scripts is defined</span></pre><p id="897c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们定义的文件夹中设置nginx的配置变量:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="9338" class="mf mg iq mb b gy mh mi l mj mk">---<br/>  logrotate_conf_dir: "/etc/logrotate.d/"<br/>  logrotate_scripts:<br/>    - name: nginx<br/>      log_dir: '/var/log/nginx'<br/>      log_extension: 'log'<br/>      options:<br/>        - rotate 7<br/>        - daily<br/>        - size 10M<br/>        - missingok<br/>        - compress<br/>        - create 0644 nginx nginx<br/>      scripts:<br/>          postrotate: "/bin/kill -USR1 `cat /run/nginx.pid 2&gt;/dev/null` 2&gt;/dev/null || true"</span></pre><p id="722b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">关于nginx postscript的细节可以在<a class="ae kc" href="https://www.nginx.com/resources/wiki/start/topics/examples/logrotation/" rel="noopener ugc nofollow" target="_blank">这里</a>找到。创建的最终配置文件添加如下:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="71bb" class="mf mg iq mb b gy mh mi l mj mk">/var/log/nginx/*.log {<br/>  rotate 7<br/>  weekly<br/>  size 10M<br/>  missingok<br/>  compress<br/>  delaycompress<br/>  create 0644 nginx nginx<br/>  postrotate<br/>    /bin/kill -USR1 `cat /run/nginx.pid 2&gt;/dev/null` 2&gt;/dev/null || true<br/>  endscript<br/>}</span></pre><p id="2d53" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">完整的代码可以在这个git资源库中找到:<a class="ae kc" href="https://github.com/MiteshSharma/LogrotateUsingAnsible" rel="noopener ugc nofollow" target="_blank">https://github.com/MiteshSharma/LogrotateUsingAnsible</a></p><p id="af6e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> <em class="le"> PS:如果你喜欢这篇文章，请用掌声支持它</em> </strong>👏<strong class="kf ir"> <em class="le">。欢呼</em> </strong></p></div></div>    
</body>
</html>