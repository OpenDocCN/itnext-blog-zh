<html>
<head>
<title>Mount a Kubernetes Worker's Root Filesystem as a container volume - for fun and fortune!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">挂载一个Kubernetes Worker的根文件系统作为容器卷——为了乐趣和财富！</h1>
<blockquote>原文：<a href="https://itnext.io/mount-a-kubernetes-workers-root-filesystem-as-a-container-volume-for-fun-and-fortune-53ae492698db?source=collection_archive---------2-----------------------#2019-08-16">https://itnext.io/mount-a-kubernetes-workers-root-filesystem-as-a-container-volume-for-fun-and-fortune-53ae492698db?source=collection_archive---------2-----------------------#2019-08-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/></div><div class="ab cl jo jp hu jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="ij ik il im in"><figure class="jw jx jy jz gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="gh gi jv"><img src="../Images/b40cf6b00b3f4c6995ec1591cc936382.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Gv40Qq0UbHfbzqPs.jpg"/></div></div><figcaption class="kh ki gj gh gi kj kk bd b be z dk translated">带一个支持容器来分析你的Kube工人</figcaption></figure><blockquote class="kl km kn"><p id="6d1b" class="ko kp kq kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="iq">本文描述了如何在pod容器中挂载和分析所选kube worker的根文件系统(</em> <code class="fe ln lo lp lq b"><em class="iq">/</em></code> <em class="iq">)。该方法展示了一种在工作主机上获取shell以进行分析和维护的替代方法，例如，当kubelet报告DiskPressure时释放磁盘空间。</em></p><p id="f6e5" class="ko kp kq kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kr ir"> <em class="iq">警告</em> </strong> <em class="iq">该方法要求您是kubernetes集群的集群管理员。这需要</em> <code class="fe ln lo lp lq b"><em class="iq">cluster-admin</em></code> <em class="iq">的特权。这应该只能从运行在</em> <code class="fe ln lo lp lq b"><em class="iq">kube-system</em></code> <em class="iq">命名空间中的特权pod中进行。如果在除了</em> <code class="fe ln lo lp lq b"><em class="iq">kube-system</em></code> <em class="iq">之外的任何其他名称空间中有任何其他creds，您可能需要在您的集群上设置</em><a class="ae lr" href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/" rel="noopener ugc nofollow" target="_blank"><em class="iq">PodSecurityPolicies</em></a><em class="iq">。</em></p><p id="6d16" class="ko kp kq kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kr ir"> <em class="iq">免责声明</em> </strong> <em class="iq">本文不是针对你与Kubernetes的情况的具体建议。有可能对kubernetes工人造成伤害。永远要考虑上下文。</em></p></blockquote></div><div class="ab cl jo jp hu jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="ij ik il im in"><h1 id="3529" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">1.使用标签识别并锁定Kube工人</h1><p id="57ec" class="pw-post-body-paragraph ko kp iq kr b ks mq ku kv kw mr ky kz ms mt lc ld mu mv lg lh mw mx lk ll lm ij bi translated">首先，找到一个标签来称呼特定的kubernetes工作人员:</p><p id="6aa7" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz ms lb lc ld mu lf lg lh mw lj lk ll lm ij bi translated">$ kubectl获取节点—显示标签</p><figure class="jw jx jy jz gt ka"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="bcd1" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz ms lb lc ld mu lf lg lh mw lj lk ll lm ij bi translated">对于每个节点来说,<code class="fe ln lo lp lq b">kubernetes.io/hostname</code>标签是唯一的。让我们试试:</p><figure class="jw jx jy jz gt ka"><div class="bz fp l di"><div class="my mz l"/></div></figure><h1 id="2a55" class="ls lt iq bd lu lv na lx ly lz nb mb mc md nc mf mg mh nd mj mk ml ne mn mo mp bi translated">2.创建支持窗格</h1><p id="501c" class="pw-post-body-paragraph ko kp iq kr b ks mq ku kv kw mr ky kz ms mt lc ld mu mv lg lh mw mx lk ll lm ij bi translated">接下来，创建一个用于worker analysis的pod，它只需休眠一个小时，我们就可以进入并交互浏览主机文件系统。这是完整的Pod清单(<code class="fe ln lo lp lq b">analyse-worker-fs.yml</code>):</p><figure class="jw jx jy jz gt ka"><div class="bz fp l di"><div class="my mz l"/></div></figure><blockquote class="kl km kn"><p id="645b" class="ko kp kq kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="iq">这里我们创建一个</em> <code class="fe ln lo lp lq b"><em class="iq">hostPath</em></code> <em class="iq">卷，它捕获了worker的整个根文件系统(</em> <code class="fe ln lo lp lq b"><em class="iq">/</em></code> <em class="iq">)，并将其挂载到busybox容器的挂载点</em> <code class="fe ln lo lp lq b"><em class="iq">/host</em></code> <em class="iq">。为此，您的kube凭据必须有权在worker FS的根目录下创建hostPath卷。</em></p><p id="db80" class="ko kp kq kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="iq">我们通过在pod规范中使用</em> <code class="fe ln lo lp lq b"><em class="iq">nodeSelector</em></code> <em class="iq">来确保它在我们的目标Kube Worker ( </em> <code class="fe ln lo lp lq b"><em class="iq">kubernetes.io/hostname=ip-10-1-79-78.cryptocracy.org</em></code> <em class="iq">)上得到调度。</em></p></blockquote><p id="26bc" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz ms lb lc ld mu lf lg lh mw lj lk ll lm ij bi translated">创建pod:</p><figure class="jw jx jy jz gt ka"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="a2d1" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz ms lb lc ld mu lf lg lh mw lj lk ll lm ij bi translated">如果pod已经存在，请删除它并创建一个新的。</p><figure class="jw jx jy jz gt ka"><div class="bz fp l di"><div class="my mz l"/></div></figure><h1 id="374f" class="ls lt iq bd lu lv na lx ly lz nb mb mc md nc mf mg mh nd mj mk ml ne mn mo mp bi translated">3.启动交互式外壳</h1><p id="15af" class="pw-post-body-paragraph ko kp iq kr b ks mq ku kv kw mr ky kz ms mt lc ld mu mv lg lh mw mx lk ll lm ij bi translated">启动交互式外壳:</p><figure class="jw jx jy jz gt ka"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="59bf" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz ms lb lc ld mu lf lg lh mw lj lk ll lm ij bi translated">现在您是root用户，可以访问安装在<code class="fe ln lo lp lq b">/host</code>的完整worker root文件系统！</p><figure class="jw jx jy jz gt ka"><div class="bz fp l di"><div class="my mz l"/></div></figure><h1 id="e90f" class="ls lt iq bd lu lv na lx ly lz nb mb mc md nc mf mg mh nd mj mk ml ne mn mo mp bi translated">4.分析工作主机根文件系统</h1><p id="c9fc" class="pw-post-body-paragraph ko kp iq kr b ks mq ku kv kw mr ky kz ms mt lc ld mu mv lg lh mw mx lk ll lm ij bi translated">您可以分析主机根文件系统上的大问题</p><p id="270c" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz ms lb lc ld mu lf lg lh mw lj lk ll lm ij bi translated">一些最大的家政机会可能会在<code class="fe ln lo lp lq b">/host/var/cache</code>和<code class="fe ln lo lp lq b">/host/var/crash</code>找到。</p><h1 id="a0c0" class="ls lt iq bd lu lv na lx ly lz nb mb mc md nc mf mg mh nd mj mk ml ne mn mo mp bi translated">拒绝许可？需要更多功能？</h1><p id="499e" class="pw-post-body-paragraph ko kp iq kr b ks mq ku kv kw mr ky kz ms mt lc ld mu mv lg lh mw mx lk ll lm ij bi translated">例如，您想要更改主机内核参数:</p><figure class="jw jx jy jz gt ka"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="36f0" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz ms lb lc ld mu lf lg lh mw lj lk ll lm ij bi translated">或者，您想要访问主机设备？</p><figure class="jw jx jy jz gt ka"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="c45d" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz ms lb lc ld mu lf lg lh mw lj lk ll lm ij bi translated">要为您的维护任务授予细粒度的内核功能，请使用:</p><figure class="jw jx jy jz gt ka"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="f613" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz ms lb lc ld mu lf lg lh mw lj lk ll lm ij bi translated">对于可能的能力常数，请参考Linux内核源代码中的<a class="ae lr" href="https://github.com/torvalds/linux/blob/master/include/uapi/linux/capability.h" rel="noopener ugc nofollow" target="_blank"> capability.h </a>。</p><blockquote class="kl km kn"><p id="c2cd" class="ko kp kq kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="iq">注意podSpec中省略了</em> <code class="fe ln lo lp lq b"><em class="iq">CAP</em></code> <em class="iq">前缀。详见</em> <a class="ae lr" href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-capabilities-for-a-container" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> kube文档</em> </a> <em class="iq">。</em></p></blockquote><p id="41d8" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz ms lb lc ld mu lf lg lh mw lj lk ll lm ij bi translated">或者，使用特权容器:</p><figure class="jw jx jy jz gt ka"><div class="bz fp l di"><div class="my mz l"/></div></figure></div><div class="ab cl jo jp hu jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="ij ik il im in"><p id="3a39" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz ms lb lc ld mu lf lg lh mw lj lk ll lm ij bi translated"><a class="ae lr" href="https://github.com/doughgle" rel="noopener ugc nofollow" target="_blank"><em class="kq">https://github.com/doughgle</em></a></p><p id="d3eb" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz ms lb lc ld mu lf lg lh mw lj lk ll lm ij bi translated">[1]通过Kubelet攻击Kubernetes—https://labs . mwrinfosecurity . com/blog/attack-Kubernetes-through-kube let/</p></div></div>    
</body>
</html>