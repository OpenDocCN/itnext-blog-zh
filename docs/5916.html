<html>
<head>
<title>8 Use Cases for Kubernetes over VPN: Unlocking Multicloud Flexibility</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes over VPN的8个用例:释放多云灵活性</h1>
<blockquote>原文：<a href="https://itnext.io/8-use-cases-for-kubernetes-over-vpn-unlocking-multicloud-flexibility-3958dab2219f?source=collection_archive---------1-----------------------#2021-06-29">https://itnext.io/8-use-cases-for-kubernetes-over-vpn-unlocking-multicloud-flexibility-3958dab2219f?source=collection_archive---------1-----------------------#2021-06-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="4579" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我写的另一个关于如何在多个云中运行Kubernetes的故事的更高层次的总结。在解释<em class="km">如何</em>之前，我应该先回答<em class="km">为什么？</em>那么，我们就从问题开始吧。</p><h1 id="699b" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated"><strong class="ak">多云有什么问题？</strong></h1><p id="99db" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">Kubernetes在短时间内成为事实上的云原生计算标准。发布于2014年，每个平台都有一个Kubernetes发行版，大多数企业都有一个Kubernetes战略。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi lq"><img src="../Images/e18012e56c7217b1eb4193582c2b9f74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BqjUHhYHASSfJbVcqsOZuQ.png"/></div></div></figure><p id="e67e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这带来了一系列企业仍在学习解决的问题。这些问题中最主要的是<strong class="jp ir">云间可操作性</strong>，或者说，跨各种环境管理集群和基于集群的应用程序的能力。</p><p id="59cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">典型的解决方案架构侧重于将多个集群部署到各种环境中，然后协调这些环境中基础架构和应用程序的管理。</p><p id="05a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在许多环境被严格划分的场景中，这样的解决方案是必要的。然而，这些体系结构引入了它们自己的问题。它们需要必须学习和操作的额外的复杂软件。他们需要一个运营团队同时管理多个集群。它们还需要大量的资源开销，因为每个环境至少需要一个完整的集群。</p><h1 id="677a" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">我们如何解决这个问题？</h1><p id="8f7e" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">企业通常忽略了解决这些问题的另一种方法:网状VPN。这不要与“服务网格”相混淆，后者是一个不相关的Kubernetes概念。网状VPN为集群创建了一个“虚拟”云环境，它可能由许多物理环境组成。</p><p id="03ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">借助网状VPN，企业可以跨<strong class="jp ir">多个环境</strong>管理<strong class="jp ir">单个集群</strong>。这种方法相对简单，有几个主要优点:</p><ul class=""><li id="0d1d" class="mc md iq jp b jq jr ju jv jy me kc mf kg mg kk mh mi mj mk bi translated">云突然进入新环境</li><li id="2286" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mh mi mj mk bi translated">节省资源开销</li><li id="d2e6" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mh mi mj mk bi translated">不需要新的技能或工具</li></ul><p id="d868" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除了节省时间和成本之外，网状VPN还为Kubernetes集群提供了额外的好处:<strong class="jp ir">安全性</strong>。</p><p id="a72a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启用了网状VPN的Kubernetes集群对所有节点之间的流量进行了加密，并启用了新的模式来安全访问集群。</p><h1 id="7a76" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">什么是网状VPN？</h1><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi mq"><img src="../Images/f34af86c6cb09da27bb469ab71c5d9f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*URDLYJlaaebN6Mlu"/></div></div></figure><p id="a982" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">网状VPN是一种虚拟专用网，其中每台计算机都通过专用IP地址与其他计算机直接相连。</p><p id="f485" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Kubernetes的上下文中，它是一个虚拟子网，您可以在其中部署工作节点，这不需要将这些节点部署在同一位置。</p><p id="9f25" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这使得平台团队能够将节点放置在任意环境中部署集群。例如，您可以拥有一个内部数据中心，如果需要更多资源，它可以“云爆发”到公共云环境中。从集群的角度来看，它只是一个普通的Kubernetes集群。它不知道它的节点被放置在不同的位置。通过节点选择器可以实现简单的管理。</p><p id="dd25" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">企业可以使用任何一种可用的网状VPN，包括Nebula、Tailscale、Twingate、Netmaker等。然而，使用基于<strong class="jp ir">内核WireGuard </strong>的网状VPN至关重要。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/0c62198c7eb554235b90fcb0c46c2db3.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/0*fQukEPouNwGQxYtI"/></div></figure><p id="363f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">VPN在历史上造成了显著的延迟，并可能导致带宽减少30%或更多。此外，它们通常既复杂又笨重。突破性的VPN技术WireGuard消除了这些问题。它在速度上与没有WireGuard的相同网络接近，并且相对于OpenVPN和IPSec等旧技术而言，实现非常简单。</p><p id="533a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">只有少数最新的网状VPN(如Netmaker)利用内核WireGuard来最大限度地提高速度。</p><h1 id="c547" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">有哪些局限性？</h1><p id="c05d" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">在进入用例之前，让我们先了解一些限制。这是今天没有广泛使用的模式的原因，尽管它们是由于一些可以解决的误解。</p><p id="d082" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最大的误解是Kubernetes不能以高延迟运行:它<em class="km">可以，</em>但是<em class="km"> etcd </em>不能。这意味着您的主节点要么必须位于同一位置，要么使用etcd以外的数据库。例如，带有K3S的SQL就没有这样的问题。MicroK8s还运行Dqlite，这是SQL的一个分布式版本，可以容忍延迟。</p><p id="6da8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，运营商已经习惯了使用传统VPN(如IPSec和OpenVPN)运行的延迟成本。他们可能不知道WireGuard有多快。</p><p id="f027" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有三个合理的因素可以阻止一些公司采用这种策略:带宽定价、公司防火墙和应用程序级延迟。</p><p id="29ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您正在使用出口数据费用非常高的云提供商，您可能想要运行这些费用的分析，因为您的节点将在云之间来回发送数据。不过，这一价格可能低于在每个环境中运行复制基础架构的价格。数字海洋的带宽价格可能比运行额外的基础设施低得多。</p><p id="fa0a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您所在的企业环境在环境之间有严格的防火墙限制，需要多层权限才能在环境之间运行数据，这也可能会给设置此拓扑带来挑战。尽管如此，如果您已经需要运行这样的集成，这可能是值得考虑的。</p><p id="543a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，在许多情况下，您的应用程序不能容忍高延迟。在这些情况下，您可以使用简单的相似性规则和节点选择器来解决问题:在每个位置，给节点一个标签，然后在您的集群上设置相似性规则，以便应用程序中的pods将默认调度到一个组或另一个组。</p><p id="d9aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在某些情况下，运行重复的基础架构以避免处理潜在的云间问题更有意义，但这种情况比您想象的要少。尽管如此，考虑潜在的成本和涉及的危险总是很重要的。</p><h1 id="7159" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">有哪些用例？</h1><p id="e5e5" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">假设一家公司没有受到上述限制的严重影响，网状VPN可以实现许多有价值的用例，既可以降低成本和复杂性，又可以实现强大的部署模式。我们在下面讨论这些不同的用例。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/6cef6f5602e84fb9ced5633620251d7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:882/0*83CJvB0Hk0c0R_K2"/></div></figure><p id="883a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">情况0:常规集群</strong></p><p id="fa79" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您计划部署一个集群，那么考虑一个基于内核的WireGuard网状VPN总是值得的。您将拥有一个正常运行的集群，性能差异可以忽略不计。但是，您可以使您的集群在未来以增强的拓扑运行，并获得加密节点间流量的额外好处。</p><p id="9e23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">案例一:广节点</strong></p><p id="fc48" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个场景中，假设一个来自案例0的集群，但是现在您想要部署一个与Azure服务集成的应用程序。您只需在Azure中部署一个虚拟机，将该虚拟机添加到您的网格中，然后安装节点。您现在有了下面的拓扑。在两个云之间迁移应用程序就像更改节点选择器一样简单。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi mt"><img src="../Images/cb6420335edf47e2483e89a15cb28493.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gE3w6w2gvxGteEGV"/></div></div></figure><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/c1d45ea043798b5a24cb2836bee7259c.png" data-original-src="https://miro.medium.com/v2/resize:fit:754/0*re8_QyXLE_YRNEzi"/></div></figure><p id="59ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">案例二:云爆</strong></p><p id="135c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个场景中，一个企业有一个用于Kubernetes的本地数据中心。他们在其集群下部署了网状VPN，这使他们能够从云环境(DigitalOcean、AWS等)中任意添加节点。).这对于需要快速扩展应用程序但本地资源有限的情况非常有用。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/2ffb386c6e7d72e68e9776bf6e35ad85.png" data-original-src="https://miro.medium.com/v2/resize:fit:742/0*8Bp-71SJQDTCidHx"/></div></figure><p id="0a93" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">案例3:云控制</strong></p><p id="517d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，企业拥有大量内部资源，但不想在本地管理控制平面。主节点故障可能是灾难性的，他们宁愿使用云资源。因此，该企业利用基于云的控制平面，但使用本地员工。这可以大幅降低云成本。</p><p id="f0d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种情况也适用于使用<strong class="jp ir">基于云的存储节点</strong>，这是另一个不允许出现故障的关键组件。</p><p id="f838" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">情况4:分布式/边缘节点</strong></p><p id="3c65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个场景中，工作节点都被放置在不同的环境中。这个用例也可以应用于边缘环境，其中有一个中央控制平面将应用程序(可能通过daemonset)推送到所有边缘节点。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi mw"><img src="../Images/9f7f6e3cb563a661d2ad26ad3c160fb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:822/0*UTVZCDwpWwaYP4c7"/></div></div></figure><p id="f4ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">案例5:分布式集群</strong></p><p id="3ed0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个场景更复杂，需要更深入的研究，但是使用正确的架构，整个集群可以跨任意云运行，包括主节点。这里的主要限制是etcd，它不能容忍高延迟。这种模式可能需要一个非etcd集群数据库。</p><p id="b7fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">情况6:连接的集群</strong></p><p id="3f13" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，集群通过网状VPN连接，可以直接相互通信，这意味着基于微服务的应用程序可以在两个集群之间拆分。这可以与多集群管理工具结合使用。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/6bb31ab9603e141824f0de57329b79a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/0*krXPHPaHhzMFTWyh"/></div></figure><p id="b9d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">案例7:安全的私人访问(入站)</strong></p><p id="f608" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，企业只希望受信任的用户或应用程序访问集群资源。这里，网状VPN的作用类似于企业VPN，用户必须连接到VPN才能访问。这也可以在较低的级别上执行，以允许外部访问Kubernetes集群中的服务和pod网络，这对于开发和运营团队来说是一个有用的特性。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div class="gh gi my"><img src="../Images/7b380157ec5935c69aac981f5cadef83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1342/0*ptp8f6Gi_3e_8rBF"/></div></figure><p id="6c58" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">案例8:安全的私人访问(出站)</strong></p><p id="ac08" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个场景中，基于Kubernetes的应用程序需要安全地访问非Kubernetes应用程序，比如SQL数据库。数据库虚拟机被添加到VPN，应用程序现在可以安全、即时地访问(见上文)。这种方法可用于将任意非Kubernetes应用程序添加到Kubernetes网络，并允许pods使用该服务。</p><h1 id="6b18" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated"><strong class="ak">网状VPN的选项</strong></h1><p id="79d5" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">目前，网状VPN有几种选择，包括Tailscale、Netmaker、Kilo、Nebula等。基于VPN的选择，上述一些用例变得不太可行。此外，只有Netmaker和Kilo提供内核WireGuard作为选项，这是最小化延迟的关键考虑因素。</p><p id="f3b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">公司也可以直接使用WireGuard“滚动自己的”网格，但这在大规模管理时变得非常困难，并且需要大量的手动干预。</p><p id="4574" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">GRAVITL设计了<a class="ae kl" href="https://gravitl.com/netmaker" rel="noopener ugc nofollow" target="_blank"> Netmaker </a>来处理上述所有用例，同时在很大程度上实现了自动化，并基于内核WireGuard。此外，由于它是一个通用的网状VPN，它可以用于集成外部服务。也就是说，每个公司都应该自己决定哪种网络虚拟化工具最适合他们的环境。</p><h1 id="fb89" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated"><strong class="ak">结论</strong></h1><p id="987b" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">我们已经讨论了多云Kubernetes集群的当前状态、Kubernetes内部对网状VPN的需求以及它支持的不同用例。</p><p id="90b8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">建议平台所有者考虑在其集群下部署网状VPN，即使他们没有当前状态的使用案例，因为它不会显著影响集群性能，并允许在需要时快速启用上述拓扑。</p><p id="3782" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有关mesh VPN或<a class="ae kl" href="https://gravitl.com/netmaker" rel="noopener ugc nofollow" target="_blank">网络制造商</a>的更多信息，请联系位于info@gravitl.com<a class="ae kl" href="mailto:info@gravitl.com" rel="noopener ugc nofollow" target="_blank">的GRAVITL，或访问我们位于https://gravitl.com/book</a><a class="ae kl" href="https://gravitl.com/book" rel="noopener ugc nofollow" target="_blank">的网站</a>。</p></div></div>    
</body>
</html>