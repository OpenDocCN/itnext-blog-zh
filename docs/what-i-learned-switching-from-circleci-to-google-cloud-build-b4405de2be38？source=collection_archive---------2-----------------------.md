# 经验教训:从 CircleCI 转向 Google Cloud Build

> 原文：<https://itnext.io/what-i-learned-switching-from-circleci-to-google-cloud-build-b4405de2be38?source=collection_archive---------2----------------------->

本月早些时候，我们终于达到了 CircleCI 慷慨的每月 1500 分钟的构建时间限制。

作为一家自举创业公司的创始人(见 [Focuster](http://focuster.com/?utm_source=medium&utm_medium=blog&utm_campaign=circle_gcb) )，我非常感谢 CircleCI 这么多年来一直在提供很棒的构建服务，而且他们对自己的限制非常慷慨。

但是每一笔新的开销都像是打在脸上的一拳。

![](img/146c697886f40d1bee0621ec09e823f6.png)

我们最近将 Focuster 的基础设施迁移到了谷歌的 Kubernetes 服务(GKE)，我注意到他们有自己的构建服务，云构建(GCB)。

虽然它在很多方面并不全面，但在这一点上它对我来说有一些明显的优势。

我想分享我在迁移中所学到的东西，这样其他人也可以受益，希望谷歌会听取我的一些反馈并做出一些改进。

# 谷歌云构建的优势

## 更便宜*

正如我前面提到的，CircleCI 在他们的免费层上每月提供 1500 分钟，并发限制为 1。要升级到下一个服务级别，统一费率为每月 50 美元。对于 2 个构建并发，构建数量不限。

另一方面，Google Cloud Build 在其标准大小的容器(n1-standard-1 机器类型，1 个内核，3.75gb RAM)上提供了每天 120 分钟的免费构建时间。

这算出来大约是。每月 3600 次构建/分钟。也就是说，未使用天数的时间不会滚动，因此某个特别繁忙的日子可能会产生一些费用。

在免费层之上，定价仅为每构建/分钟 0.003 美元。我的构建平均需要 10 分钟，所以我一个月要做超过 1667 个构建，或者一天 50 个构建才能达到 CircleCI 收取的 50 美元。

## 并发

CircleCI 基本上是根据你的并发级别来收费的，并且给你无限的分钟数。GCB 有 10 个并发构建的实际限制，但按构建/分钟收费。在这一点上，我喜欢这种方法，因为我可以在空闲层上获得额外并发的好处。

## 本地测试

CircleCI 和 GCB 都提供了使用 docker 测试本地部署的工具。上一次我在 OSX 的 CircleCI 上尝试时，速度慢得可怕，以至于无法使用。我不确定这个问题是否已经解决。

GCB 提供本地测试工具，这些工具通过 *cloud-build-local* 命令与 Google Cloud SDK 一起发布。

使用这个工具，我能够快速迭代我的构建步骤，而不需要在云服务上花费任何时间。

## 更快部署

*   接近谷歌集装箱注册(GCR)更快的码头拉/推。

我实际上没有测试这是真是假，但我假设在谷歌的网络中意味着从 GCR 到 GCB 的 docker 图像将比从 CircleCI 更快。

*   实时图像通知部署通知

为了部署到我的 Kubernetes 集群，我使用了一个名为 [Keel](https://keel.sh) 的工具，在 Docker 存储库中的映像更新时自动更新我的部署。

过去我使用 Docker 的轮询系统，因为 web 挂钩的设置有点麻烦。我发现 GCR 发布订阅通知的设置非常简单，这使得部署快了一分钟。

## Docker 本地步骤

CircleCI 和 Google Cloud Build 都有广泛的 Docker 支持。但是 Google Cloud Build 允许你使用 Docker 映像定义自己的步骤。

共享工作区(挂载在/workspace)在步骤之间是持久的。

我发现这实际上是开发我的构建步骤的一个非常好的方法，因为我可以为每个步骤利用专门构建的小图像。

我还可以在构建过程中的任何时候利用现有的 Docker 映像，并且可以用任何语言编写我的构建步骤。

# 谷歌云构建的缺点

## 内置步骤是有限的

GCB 为许多最常用的工具提供了现有的步骤:docker、git、Google 的服务、curl、npm、kubectl 等。

完整名单在此:【https://github.com/GoogleCloudPlatform/cloud-builders 

但是像初始化 git 子模块这样简单的事情却很难做到。为此，我必须创建自己的构建步骤。如果他们能提供一个简单易用的构建步骤，从谷歌的 KMS 中提取 ssh 密钥，那就太好了。

CircleCI 在这方面有优势，因为他们支持向构建帐户添加 SSH 密钥，并且因为他们的构建都在一个容器中运行，所以配置起来容易得多。

## 糟糕的缓存故事

与 GCB 相比，CircleCI 的另一个亮点是缓存。

它们提供了一些非常灵活的缓存原语，例如，根据文件内容的哈希动态生成缓存键。并允许基于分支名称或许多其他标准回退到较旧的高速缓存。

另一方面，GCB 只提供了在 Google Storage 中存储一些文件夹内容的文档。

好消息是，我能够创建自己的构建步骤，基本上模仿了 CircleCI 在 GCB 中的行为。

(如果有兴趣，我将开放我创建的缓存步骤的源代码)

## 有限调试

CircleCI 使 SSH 进入您的构建来诊断问题变得非常容易，只需在构建上勾选一个框并重新启动它。

对于 GCB，我找不到任何类似的步骤。

也许可以在本地调试中使用 docker run 来打开特定映像中的 shell，但是我不清楚在这种情况下如何保留构建的工作空间。

## 用户界面没有那么好

*   过滤器构建可以使用很多改进。对所有构建属性进行全文搜索会很棒。没有对查询语言的解释。
*   在构建完成之前看不到单个步骤的进度，或者需要查看整个构建的日志。Circle CI 在这里做得更好，因为您可以看到每一步的进度。
*   您必须手动单击“刷新”才能在构建列表中看到新的构建。

## 缺乏整合

设置 Slack 和 Github 集成是基于手动安装一些谷歌云功能，而不是大多数服务使用的 1-click。

也就是说，将 PubSub 用于构建通知允许很多定制。

## 有限的机器类型配置

目前，您只能在 1 核、8 核或 32 核之间进行选择。最好有 2 核和 4 核作为选项。我们能得到一个 *n1-standard-2* 或其他尺寸的建筑机械吗？

# 最后的想法

做出了改变，我对结果总体上很满意。我希望谷歌继续定期更新这项服务。

—

*这是关于 Focuster 工程实践系列文章的一部分。*

[***看看 Focuster***](http://focuster.com/?utm_source=medium&utm_medium=blog&utm_campaign=circle_gcb) *，第一款真正帮助你完成事情而不是做无止境的清单的专注 app。在谷歌日历中根据你的待办事项列表自动建立一个日程表，如果事情没有完成，就把它向前推进。*

[*在 Twitter 上关注@ focusterapp*](https://twitter.com/intent/follow?screen_name=focusterapp)*获取关于生产力和高绩效的更新。*