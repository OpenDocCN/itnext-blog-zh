<html>
<head>
<title>Getting started with OPA/Gatekeeper</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">OPA/网关守护设备入门</h1>
<blockquote>原文：<a href="https://itnext.io/getting-started-with-opa-gatekeeper-c12a2c0640fa?source=collection_archive---------3-----------------------#2022-01-05">https://itnext.io/getting-started-with-opa-gatekeeper-c12a2c0640fa?source=collection_archive---------3-----------------------#2022-01-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="1f7b" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">使用OPA/Gatekeeper管理和实施Kubernetes安全策略</h1><p id="b423" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">PodSecurityPolicy (PSP)在Kubernetes 1.21中已被弃用。有几个外部准入控制器可用，如OPA/Gatekeeper，但开始使用OPA可能具有挑战性。</p><p id="c64e" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><a class="ae lo" href="https://otomi.io/" rel="noopener ugc nofollow" target="_blank"> Otomi </a>是一套完整的集成K8s应用和附加组件，结合了开发人员自助服务，使用OPA/Gatekeeper作为提供策略执行的标准。集成到Otomi中的所有应用程序都是基于合理的默认设置和最佳实践预先配置的。所有应用的配置都使用版本控制系统进行管理，其中所需的状态反映为代码，集群状态会自动更新。</p><p id="0299" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">Otomi的一个关键原则是它易于使用，并从头开始提供安全性。在本文中，我将简要介绍如何使用Otomi开始使用OPA/Gatekeeper。</p><h1 id="2f7b" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">安装Otomi</h1><p id="dcbe" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">首先，在您选择的云中的Kubernetes集群上安装Otomi。您可以使用Otomi Quickstart在AWS、Azure、GCP提供Kubernetes集群，或者使用Helm chart安装Otomi。要使用Helm chart安装Otomi，请确保Kubernetes集群至少运行16个CPU线程，并且在worker节点池中有32GB以上的RAM。</p><p id="0624" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">添加Otomi存储库:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="7a84" class="ly jo iq lu b gy lz ma l mb mc">helm repo add otomi https://otomi.io/otomi-core<br/>helm repo update</span></pre><p id="d8f1" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">使用以下值创建一个值文件:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="6c0c" class="ly jo iq lu b gy lz ma l mb mc">cluster:<br/>  k8sVersion: '1.20' # currently 1.18, 1.19, 1.20 and 1.21 are supported<br/>  name: # the name of your cluster<br/>  provider: # choose between aws, azure, google or onprem</span></pre><p id="26f4" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">安装图表:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="415f" class="ly jo iq lu b gy lz ma l mb mc">helm install -f values.yaml otomi otomi/otomi</span></pre><p id="0342" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">当安装程序作业(在默认名称空间中)完成时，从日志底部复制URL和生成的密码，并完成<a class="ae lo" href="https://otomi.io/docs/installation/post-install/" rel="noopener ugc nofollow" target="_blank">安装后步骤</a>。</p><p id="aa70" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">您现在可以登录到控制台。在左侧窗格(在企业下)中，您将看到<code class="fe md me mf lu b">Policies</code>，当您点击它时，您将看到Otomi中所有可用策略的列表。</p><figure class="lp lq lr ls gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mg"><img src="../Images/1eaeabb3a86edb4115a956114ed64f76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lEK4CC4JcI54Oc8O7KHW_g.png"/></div></div></figure><h1 id="d531" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">使用Otomi控制台管理策略</h1><p id="ffd5" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">Otomi包含了13种可用的OPA策略，并对它们进行了改编，以供Conftest使用，以及用于Otomi生成的清单的静态分析。</p><p id="5434" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">您可以打开或关闭策略，还可以设置要使用的默认参数。选择您想要编辑的策略(启用/禁用或更改默认参数)，点击<code class="fe md me mf lu b">Submit</code>并点击<code class="fe md me mf lu b">Deploy Changes</code>。现在，更改将应用于Otomi配置。</p><figure class="lp lq lr ls gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mo"><img src="../Images/401631129b0deacfdf6418a1f417ecea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A2LeM_uPJ0mthHgwEOMHMA.png"/></div></div></figure><h1 id="5066" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">网守模式</h1><p id="0b93" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">Otomi支持3种看门人模式:</p><ul class=""><li id="f218" class="mp mq iq kn b ko lj ks lk kw mr la ms le mt li mu mv mw mx bi translated">执行</li><li id="b141" class="mp mq iq kn b ko my ks mz kw na la nb le nc li mu mv mw mx bi translated">许可(默认)</li><li id="9859" class="mp mq iq kn b ko my ks mz kw na la nb le nc li mu mv mw mx bi translated">有缺陷的</li></ul><p id="6cdc" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">在强制和许可模式下，可以打开或关闭各个策略。默认情况下，网关守护设备在许可模式下启用(记录和非阻塞)。</p><p id="9eda" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">基于Otomi模式或通过使用Otomi控制台支持策略的定制。在特定需求的情况下，运营商可以添加他们自己的定制策略。</p><p id="48b2" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">要更改模式，请打开Gitea(在应用程序中)并导航至<code class="fe md me mf lu b">values/env/charts/gatekeeper-operator.yaml</code></p><p id="4bd2" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">要切换到强制模式，编辑文件并设置<code class="fe md me mf lu b">disableValidatingWebhook=false</code>:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="c1a6" class="ly jo iq lu b gy lz ma l mb mc">charts:<br/>  gatekeeper-operator:<br/>    disableValidatingWebhook: false</span></pre><p id="c1f4" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">要禁用策略实施，请编辑文件并设置<code class="fe md me mf lu b">enabled: false</code>:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="eade" class="ly jo iq lu b gy lz ma l mb mc">charts:<br/>  gatekeeper-operator:<br/>    enabled: false</span></pre><h1 id="43d2" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">开发者支持</h1><p id="5e39" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在Otomi控制台的team部分，开发人员可以使用Gatekeeper仪表板查看与其部署相关的所有违反策略的情况。首先，在Otomi中创建一个团队，如果你还没有这样做的话。在团队部分，点击<code class="fe md me mf lu b">Apps</code>，然后点击<code class="fe md me mf lu b">Gatekeeper</code>。</p><figure class="lp lq lr ls gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi nd"><img src="../Images/c27e3e5b7587c57ea79dcfa3286b00cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z6TYfho9rmtEyap-I2Q8yQ.png"/></div></div></figure><h1 id="f09c" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">对任何种类的YAML资源运行策略检查</h1><p id="c1f2" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">通过一个简单的命令，您可以测试舵图是否违反了任何策略。</p><p id="8032" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">生成的YAML文件被传输到Conftest中，并逐个测试策略。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="3d26" class="ly jo iq lu b gy lz ma l mb mc">$ helm template stable/keycloak | conftest test --policy ./policies/ --all-namespaces -<br/>FAIL - Policy: container-limits - container &lt;keycloak&gt; has no resource limits<br/>FAIL - Policy: container-limits - container &lt;keycloak-test&gt; has no resource limits<br/>162 tests, 160 passed, 0 warnings, 2 failures, 0 exceptions</span></pre><p id="0bad" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">通过检查日志消息，您可以看到容器限制策略将两个资源标记为失败。现在，您所要做的就是修改模板，为指定的容器提供“敏感”数量的资源限制，我们的策略检查将成功通过！</p><p id="112e" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">如果您想采用新的Helm应用程序，但不想在集群中部署任何东西，除非它经过了充分的违规检查，否则这是非常有用的。Conftest支持使用–data选项向策略传递值，该选项允许策略设计者通过参数配置不同的设置。</p><h1 id="bd5d" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">策略例外功能</h1><p id="06d7" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">为了创造一些灵活性，Otomi提供了通过检查每个资源的粒度注释信息来产生异常的能力。</p><p id="e684" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">例如:使用以下注释将允许整个窗格或窗格中的某些容器排除一个或多个策略:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="864b" class="ly jo iq lu b gy lz ma l mb mc"># Annotation for the entire pod<br/>policy.otomi.io/ignore: psp-allowed-repos<br/># Annotation for Istio sidecar based containers<br/>policy.otomi.io/ignore-sidecar: psp-allowed-users,psp-capabilities<br/># Annotation for a specific container (name=app-container)<br/>policy.otomi.io/ignore/app-container: banned-image-tags</span></pre><h1 id="1198" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">包扎</h1><p id="5ceb" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">实施OPA/Gatekeeper可能是一项具有挑战性的工作。一些云提供商已经将Gatekeeper集成到他们的托管Kubernetes服务中，但这导致了一种锁定，而Otomi则与云无关。在托管Kubernetes服务中使用集成策略也不总是非常灵活。例如，在Azure中，策略强制只能打开或关闭。没有在许可模式下运行的选项。</p><p id="81d7" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">Otomi使用OPA/Gatekeeper和Conftest提供完整的Kubernetes安全策略功能。在(默认)许可模式下，开发人员可以部署他们的应用程序，而不必直接遵从。然后，他们可以看到所有违规，并相应地调整他们的部署。有了Otomi，你可以拥有所有的OPA/Gatekeeper功能，一套合理的实现默认策略，一个简单的用户体验和大量的灵活性，安装Otomi后立即可用。</p><p id="9998" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">今天开始使用大友。点击这里查看GitHub repo<a class="ae lo" href="https://github.com/redkubes/otomi-core" rel="noopener ugc nofollow" target="_blank"/>。</p></div></div>    
</body>
</html>