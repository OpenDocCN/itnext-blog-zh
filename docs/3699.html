<html>
<head>
<title>Deploy staging and production environments to single server using Capistrano — Rails</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Capistrano-Rails将登台和生产环境部署到单个服务器上</h1>
<blockquote>原文：<a href="https://itnext.io/deploy-staging-and-production-applications-to-single-server-using-capistrano-rails-1d5ab558d44f?source=collection_archive---------1-----------------------#2020-02-06">https://itnext.io/deploy-staging-and-production-applications-to-single-server-using-capistrano-rails-1d5ab558d44f?source=collection_archive---------1-----------------------#2020-02-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e15d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">拥有多个环境是我或我的客户最常见的需求之一。默认情况下，Ruby on Rails应用程序有三种环境——开发、测试和生产。开发和测试环境安装在本地或开发人员的计算机上。生产环境是一个服务器环境，最终的应用程序代码在这里被部署到世界各地。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/67ff0517fed7e299a261c6e34f2eec11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J4UWv6_fDqqvxzQ4QgtEUA.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">使用Capistrano/Passenger/Nginx在多个环境中部署Rails</figcaption></figure><p id="4f56" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，我在许多项目中工作过，我们需要不止一个类似生产的环境。至少，过去有两种环境—试运行和生产。该团队可以在试运行或预生产环境中测试功能，然后再将其投入生产环境并由真实客户使用。</p><p id="c965" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在项目开发的早期，当资源不是太大的时候，我一般喜欢使用同一台服务器机器来配置多个环境。这样我们可以节省一些钱，同时保持配置服务器的复杂性为1。一旦应用程序变得很大或者资源需求足够高，那么我们总是可以迁移到更好更大的基础设施。</p><p id="f504" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇文章中，我将解释并提供一些配置选项来在一台服务器上部署不同的环境。对我来说，一开始为多个环境配置一台服务器并不是一件容易的事情。我不得不通过几个谷歌搜索和博客帖子，但它值得我花所有的时间。在这里，我尽量保持所有的配置尽可能简单，所以它应该适用于不同的项目特定的设置。</p><p id="b34b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这不是一篇关于如何设置Capistrano或将Ruby on Rails应用程序部署到生产服务器的博文。您可以找到几篇将应用程序部署到您自己的服务器的文章和教程。</p><p id="8e92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，让我们从假设我们已经可以将一个环境部署到我们的服务器开始。</p><p id="e790" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">先决条件</strong></p><p id="c3e4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">到这一步，我假设您已经为单个环境设置了一个有效的Capistrano部署环境。但是，您没有为同一个服务器设置另一个环境。例如，你可以执行</p><pre class="km kn ko kp gt lb lc ld le aw lf bi"><span id="2087" class="lg lh iq lc b gy li lj l lk ll">cap production deploy</span></pre><p id="909c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">来部署您的生产应用程序，并且部署成功。但是</p><pre class="km kn ko kp gt lb lc ld le aw lf bi"><span id="14cc" class="lg lh iq lc b gy li lj l lk ll">cap staging deploy</span></pre><p id="267d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不在同一个服务器上部署您的应用程序，并且您想要配置它。</p><p id="d727" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你没有任何环境设置或工作，我建议你在这里停下来，看看关于gorails.com的<a class="ae lm" href="https://gorails.com/deploy/ubuntu" rel="noopener ugc nofollow" target="_blank">这个很棒的教程。我使用gorails教程作为基础，并将修改一些配置来设置多个环境。</a></p><p id="9b13" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">策划</strong></p><ol class=""><li id="824b" class="ln lo iq jp b jq jr ju jv jy lp kc lq kg lr kk ls lt lu lv bi translated">我们将创建两个子域— <strong class="jp ir"> staging。[您的域名]。com </strong> &amp; <strong class="jp ir">制作。[您的域名]。com </strong>，在这里我们将指向我们的应用程序。当然，用您的实际域名替换[您的域名]。</li><li id="91d9" class="ln lo iq jp b jq lw ju lx jy ly kc lz kg ma kk ls lt lu lv bi translated">我们将针对不同的环境使用两个不同的GitHub分支:<br/> -生产主分支<br/> -暂存分支</li><li id="3f1a" class="ln lo iq jp b jq lw ju lx jy ly kc lz kg ma kk ls lt lu lv bi translated">我将使用以下技术栈:<br/> - Digital Ocean ubuntu 18.04服务器droplet<br/>-rbenv with ruby 2 . 7 . 0<br/>-rails 6 . 0 . 2应用程序<br/>-nginx web server with passenger for rails应用程序<br/> - PostgreSQL数据库服务器<br/> - Capistrano for deployment</li></ol><p id="2094" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">步骤1 —创建子域</strong></p><p id="9c08" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">进入你的DNS区域编辑器，添加两个A记录，指向你的服务器的同一个公共IP。我是这样做的:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mb"><img src="../Images/4917befd88163e38eaa48c9486ccaa8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6wlaNkjSpLd24Jq8qdb-YQ.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">DNS记录</figcaption></figure><p id="4e9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">步骤2 —为两个应用程序创建nginx站点配置文件</strong></p><p id="5e9b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在ssh登录到您的服务器，并前往nginx网站-启用文件夹。然后为这两个应用程序创建/更新配置文件。我是这样做的:</p><pre class="km kn ko kp gt lb lc ld le aw lf bi"><span id="4d17" class="lg lh iq lc b gy li lj l lk ll">$&gt; ssh deploy@1.2.3.4<br/>$&gt; cd /etc/nginx/sites-enabled<br/>$&gt; sudo nano production.[your-domain].com<br/>$&gt; sudo nano staging.[your-domain].com</span></pre><p id="2465" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这两个文件的实际内容如下:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mc md l"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">staging.your-domain.com</figcaption></figure><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mc md l"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">production.your-domain.com</figcaption></figure><p id="2e7b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">更新两个文件后，检查nginx配置，并使用以下命令成功重启:</p><pre class="km kn ko kp gt lb lc ld le aw lf bi"><span id="11a4" class="lg lh iq lc b gy li lj l lk ll">$&gt; sudo nginx -t<br/>$&gt; sudo service nginx start</span></pre><p id="009c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">步骤3 —更改部署脚本</strong></p><p id="2f39" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，是时候在rails应用程序中修改Capistrano部署脚本了。下面是我的config/deploy.rb文件的样子:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mc md l"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">配置/部署. rb</figcaption></figure><p id="de23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我还有两个与环境相关的文件— config/deploy/staging.rb和config/deploy/production.rb。这两个文件的内容如下:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mc md l"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">配置/部署/暂存. rb</figcaption></figure><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mc md l"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">配置/部署/生产. rb</figcaption></figure><p id="75bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">步骤4 —数据库设置</strong></p><p id="bb8d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要设置数据库，我们需要在database.yml文件中包含暂存和生产块。这是我的config/database.yml文件。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mc md l"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">config/database.yml</figcaption></figure><p id="8e7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，我同时拥有试运行和生产模块。此外，我使用rails凭证文件来保存多环境凭证。您可以使用编辑器编辑凭证文件，并更新这些环境变量，如下所示:</p><pre class="km kn ko kp gt lb lc ld le aw lf bi"><span id="729b" class="lg lh iq lc b gy li lj l lk ll">$&gt; EDITOR="atom --wait" rails credentials:edit</span></pre><p id="049a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是我打开凭据文件时的样子:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mc md l"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">在编辑器中打开config/credentials.yml.enc文件</figcaption></figure><p id="42d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果不使用凭据文件来存储变量，则必须在服务器中存储登台和生产环境变量，并确保正确配置了这两个数据库。</p><p id="5610" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">步骤5 —其他设置</strong></p><p id="6a2a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，大部分工作已经完成。剩下的几件事，让我们快速设置它们。</p><p id="b5a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">一、为Rails定义staging environment</strong>—Rails app默认有3个环境——开发、测试和生产，定义在config/environments文件夹中。我们这里还有一个环境—暂存。因此，我们需要定义暂存环境配置。为此，我们可以简单地将production.rb文件转换成staging.rb，就像这样:</p><pre class="km kn ko kp gt lb lc ld le aw lf bi"><span id="5e01" class="lg lh iq lc b gy li lj l lk ll">$&gt; cp config/environments/production.rb config/environments/staging.rb</span></pre><p id="4819" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">二。为Webpacker </strong>定义登台环境— Rails 6也需要为Webpacker设置环境。您需要在config/webpacker.yml文件中添加staging节。您可以简单地从同一个文件中复制生产数据块，并对其进行编辑以进行转移。您还需要创建config/webpack/staging.js文件。您可以将config/webpack/production.js中的内容复制到staging.js文件中。</p><h2 id="367a" class="lg lh iq bd me mf mg dn mh mi mj dp mk jy ml mm mn kc mo mp mq kg mr ms mt mu bi translated"><strong class="ak">第六步——部署</strong></h2><p id="8f61" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">仅此而已。我们都准备好了。让我们使用以下命令部署这两个环境:</p><pre class="km kn ko kp gt lb lc ld le aw lf bi"><span id="4ac1" class="lg lh iq lc b gy li lj l lk ll">$&gt; cap staging deploy<br/>$&gt; cap production deploy</span></pre><p id="2578" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一次运行时，您可能会得到一个错误，说链接文件丢失。因为我们在shared/config文件夹中共享了database.yml和master.key文件。如果您收到该错误消息，请使用应用程序中的内容创建或更新这些文件。</p><p id="3698" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">再次尝试部署到两个环境中，这次一切都应该工作了。</p><p id="4363" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们打开浏览器，试着浏览两个应用，网址分别是:【http://production.your-domain.com】http://staging . your-domain . com和<a class="ae lm" href="http://production.your-domain.com." rel="noopener ugc nofollow" target="_blank">。</a>两个应用程序都应该正确加载，当您在两个分支中推送时，您应该会看到不同的内容。您也可以在终端中使用curl进行检查，如下所示:</p><pre class="km kn ko kp gt lb lc ld le aw lf bi"><span id="d6ad" class="lg lh iq lc b gy li lj l lk ll">$&gt; curl -i <a class="ae lm" href="http://staging.your-domain.com" rel="noopener ugc nofollow" target="_blank">http://staging.your-domain.com</a><br/>$&gt; curl -i http://production.your-domain.com</span></pre><p id="c59f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">检查日志</strong> —如果出现问题或网站加载不正确，检查日志总是个好主意。您可以检查nginx日志或应用程序日志。Nginx日志一般位于/var/log/nginx，应用日志位于/home/deploy/[environment]/current/log</p><p id="f048" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样。恭喜你！到目前为止，您应该已经有了一个支持多种环境的工作服务器。您可以按照相同的设置将不同的应用程序部署到单个服务器中，只需稍作更改。如果您有任何反馈，请留言。</p></div></div>    
</body>
</html>