<html>
<head>
<title>ASP.NET Core Configuration Issue with In Process Hosting</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">进程内托管的ASP.NET核心配置问题</h1>
<blockquote>原文：<a href="https://itnext.io/asp-net-core-configuration-issue-with-in-process-hosting-bebbf9110a1b?source=collection_archive---------3-----------------------#2019-02-17">https://itnext.io/asp-net-core-configuration-issue-with-in-process-hosting-bebbf9110a1b?source=collection_archive---------3-----------------------#2019-02-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="6d7f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">自从<a class="ae kl" href="https://blogs.msdn.microsoft.com/webdev/2018/12/04/asp-net-core-2-2-available-today/" rel="noopener ugc nofollow" target="_blank">ASP.NET核心2.2发布</a>以来，我一直致力于更新我所有不同的应用程序，并使用<a class="ae kl" href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/index?view=aspnetcore-2.2&amp;tabs=windows#in-process-hosting-model" rel="noopener ugc nofollow" target="_blank">进程内托管</a>。我很快就遇到了一个使用SQLite的应用程序的问题。当应用程序试图访问数据库时，我发现了下面的错误。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/9718015d09ad761761f51a139c03f4e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MkMxjbrk-V6eOfq7Xs5k2g.png"/></div></div></figure><blockquote class="ky kz la"><p id="4dec" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated">SqliteException: SQLite错误14:“无法打开数据库文件”。微软。data . SQLite . sqliteexception . throwexceptionforrc(int RC，sqlite3 db)微软。data . SQLite . SQLite connection . open()微软。EntityFrameworkCore . storage . relational connection . opendb connection(预期出现布尔值错误)</p></blockquote><h2 id="2ff0" class="lf lg iq bd lh li lj dn lk ll lm dp ln jy lo lp lq kc lr ls lt kg lu lv lw lx bi translated">问题</h2><p id="d7c0" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">经过一番谷歌搜索，我在GitHub 上发现了一个<a class="ae kl" href="https://github.com/aspnet/AspNetCore/issues/4206" rel="noopener ugc nofollow" target="_blank">问题，详细描述了这个问题。事实证明，当应用程序获取其当前目录时，它返回的是承载应用程序的IIS进程的路径，而不是应用程序所在的目录。</a></p><h2 id="fd7d" class="lf lg iq bd lh li lj dn lk ll lm dp ln jy lo lp lq kc lr ls lt kg lu lv lw lx bi translated">变通一下</h2><p id="0f7f" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">在另一个<a class="ae kl" href="https://github.com/aspnet/AspNetCore/issues/6117" rel="noopener ugc nofollow" target="_blank"> GitHub问题</a>上，我找到了一个推荐解决方法的链接。在应用程序中的某个地方添加下面的类。这段代码来自<a class="ae kl" href="https://github.com/aspnet/Docs/blob/master/aspnetcore/host-and-deploy/aspnet-core-module/samples_snapshot/2.x/CurrentDirectoryHelpers.cs" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><pre class="kn ko kp kq gt md me mf mg aw mh bi"><span id="4ff6" class="lf lg iq me b gy mi mj l mk ml">internal class CurrentDirectoryHelpers<br/>{<br/>    internal const string AspNetCoreModuleDll = "aspnetcorev2_inprocess.dll";<br/><br/>    [System.Runtime.InteropServices.DllImport("kernel32.dll")]<br/>    private static extern IntPtr GetModuleHandle(string lpModuleName);<br/><br/>    [System.Runtime.InteropServices.DllImport(AspNetCoreModuleDll)]<br/>    private static extern int http_get_application_properties(ref IISConfigurationData iiConfigData);<br/><br/>    [System.Runtime.InteropServices.StructLayout(System.Runtime.InteropServices.LayoutKind.Sequential)]<br/>    private struct IISConfigurationData<br/>    {<br/>        public IntPtr pNativeApplication;<br/>        [System.Runtime.InteropServices.MarshalAs(System.Runtime.InteropServices.UnmanagedType.BStr)]<br/>        public string pwzFullApplicationPath;<br/>        [System.Runtime.InteropServices.MarshalAs(System.Runtime.InteropServices.UnmanagedType.BStr)]<br/>        public string pwzVirtualApplicationPath;<br/>        public bool fWindowsAuthEnabled;<br/>        public bool fBasicAuthEnabled;<br/>        public bool fAnonymousAuthEnable;<br/>    }<br/><br/>    public static void SetCurrentDirectory()<br/>    {<br/>        try<br/>        {<br/>            // Check if physical path was provided by ANCM<br/>            var sitePhysicalPath = Environment.GetEnvironmentVariable("ASPNETCORE_IIS_PHYSICAL_PATH");<br/>            if (string.IsNullOrEmpty(sitePhysicalPath))<br/>            {<br/>                // Skip if not running ANCM InProcess<br/>                if (GetModuleHandle(AspNetCoreModuleDll) == IntPtr.Zero)<br/>                {<br/>                    return;<br/>                }<br/><br/>                IISConfigurationData configurationData = default(IISConfigurationData);<br/>                if (http_get_application_properties(ref configurationData) != 0)<br/>                {<br/>                    return;<br/>                }<br/><br/>                sitePhysicalPath = configurationData.pwzFullApplicationPath;<br/>            }<br/><br/>            Environment.CurrentDirectory = sitePhysicalPath;<br/>        }<br/>        catch<br/>        {<br/>            // ignore<br/>        }<br/>    }<br/>}</span></pre><p id="4998" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，在<strong class="jp ir">程序</strong>类的<strong class="jp ir">主</strong>函数中，添加下面一行作为函数中的第一件事。</p><pre class="kn ko kp kq gt md me mf mg aw mh bi"><span id="bbf2" class="lf lg iq me b gy mi mj l mk ml">CurrentDirectoryHelpers.SetCurrentDirectory();</span></pre><h2 id="46f3" class="lf lg iq bd lh li lj dn lk ll lm dp ln jy lo lp lq kc lr ls lt kg lu lv lw lx bi translated">包扎</h2><p id="bb86" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">有了上述更改，一切都将按预期运行。我的理解是，这个问题将在未来的某个时候作为一个补丁来解决，所以这应该只是一个临时的修复。</p></div><div class="ab cl mm mn hu mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ij ik il im in"><p id="a322" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lb">最初发表于</em> <a class="ae kl" href="https://elanderson.net/2019/02/asp-net-core-configuration-issue-with-in-process-hosting/" rel="noopener ugc nofollow" target="_blank"> <em class="lb">埃里克·安德森</em> </a> <em class="lb">。</em></p></div></div>    
</body>
</html>