<html>
<head>
<title>Multi-Arch docker images in Gitlab Container Registry</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Gitlab容器注册表中的多拱docker图像</h1>
<blockquote>原文：<a href="https://itnext.io/multi-arch-docker-images-in-gitlab-container-registry-ada46cc6d4bb?source=collection_archive---------1-----------------------#2021-08-17">https://itnext.io/multi-arch-docker-images-in-gitlab-container-registry-ada46cc6d4bb?source=collection_archive---------1-----------------------#2021-08-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="050e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">即使用与x86/x64相同的标签将ARM映像推送到Docker注册表</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/276fad08a799dd3dd4f01b7d43bcf615.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UMiYgeSWyHzms-IQKTVXPQ.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">安托万·佩蒂特维尔在<a class="ae lb" href="https://unsplash.com/s/photos/containers-architecture?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="f697" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="3ab8" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">使用标准的<em class="mf"> buildx </em>命令(<a class="ae lb" href="https://www.docker.com/blog/multi-arch-build-and-images-the-simple-way/" rel="noopener ugc nofollow" target="_blank">引用</a>)，可以构建并推送多拱映像(x86、ARM、amd64)到Gitlab容器注册表。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="952b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的例子使用了一个<a class="ae lb" href="https://gitlab.com/nicosingh/demo-flask-application" rel="noopener ugc nofollow" target="_blank">样例repo </a>，在这里您可以检查<em class="mf"> Dockerfile </em>根本没有特定于架构的定义。为多个架构构建映像的技巧是使用一个已经支持所有架构的基础映像(<em class="mf"> python:3.8-alpine </em>)。</p></div><div class="ab cl mi mj hu mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ij ik il im in"><h1 id="29f1" class="lc ld iq bd le lf mp lh li lj mq ll lm ln mr lp lq lr ms lt lu lv mt lx ly lz bi translated">完整版</h1><p id="4e69" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">本帖是<a class="ae lb" href="https://www.docker.com/blog/multi-arch-build-and-images-the-simple-way/" rel="noopener ugc nofollow" target="_blank">本文</a>的延伸，讲解了如何用Gitlab容器注册表替代Docker Hub推送多拱Docker图片。</p><p id="43a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">多拱映像允许我们在各种架构的设备中使用相同的docker映像，为在ARM设备(如Raspberry Pis或基于AWS Graviton的EC2实例)中部署轻量级和高度可扩展的服务带来了一个很好的替代方案(便宜！).</p><p id="9911" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">直奔主题，有两种方法可以构建多拱图像:使用清单或者使用<a class="ae lb" href="https://docs.docker.com/buildx/working-with-buildx/" rel="noopener ugc nofollow" target="_blank"> buildx命令</a>。为了简单起见，我们将使用<em class="mf"> buildx </em>来构建&amp; push我们的多拱图像到Gitlab。</p><p id="f255" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除了使用Gitlab作为我们的Docker注册表而不是Docker Hub之外，参考文章中详细描述的步骤没有太大区别。这意味着第一步是使用我们的个人凭证或访问令牌登录Gitlab容器注册表:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="97f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我们可以使用如下命令构建并推送我们的多拱映像:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="1e18" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如我们可以在这个示例报告中看到的，<a class="ae lb" href="https://gitlab.com/nicosingh/demo-flask-application/-/blob/master/Dockerfile" rel="noopener ugc nofollow" target="_blank">docker file</a>与该架构没有任何特殊关系，因为它基于另一个多拱图像:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="02ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所见，这个Docker图像使用python创建了一个示例应用程序。在本例中，我们使用Flask创建了一个简单的web服务器:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="abfe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Buildx的<em class="mf">平台</em>选项允许我们指定构建我们的映像的架构作为列表，而<em class="mf">推送</em>选项允许我们在构建阶段一结束就推送映像。</p><h1 id="81c9" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">CI作业</h1><p id="5b78" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">事实证明，在使用docker-in-docker (dind)的GitlabCI管道中，使用<em class="mf"> buildx </em>命令可以完美地工作😀</p><p id="0a00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下示例显示了一个简单的CI作业，它使用官方Docker映像下载<em class="mf"> buildx </em>，然后使用它来构建&amp;将Flask应用程序推送到容器注册表:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mg mh l"/></div></figure><h1 id="817d" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">包扎</h1><p id="d392" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">就是这样！从现在开始，可以从使用相同图像标签的多个设备(笔记本电脑、raspberry pi、EC2实例等)使用docker图像。</p><p id="8c65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">✅请记住，所有这些步骤都适用于任何支持多拱图像的Docker注册表(例如DockerHub、AWS ECR、)。</p><p id="d7ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我真的很感激任何类型的反馈，疑问或评论。在这里随意ping我<a class="ae lb" href="https://www.linkedin.com/in/nicosingh" rel="noopener ugc nofollow" target="_blank">，或者在这个帖子里发表任何评论。</a></p><div class="mu mv gp gr mw mx"><a href="https://github.com/sponsors/nicosingh" rel="noopener  ugc nofollow" target="_blank"><div class="my ab fo"><div class="mz ab na cl cj nb"><h2 class="bd ir gy z fp nc fr fs nd fu fw ip bi translated">GitHub赞助商上的赞助商@nicosingh</h2><div class="ne l"><h3 class="bd b gy z fp nc fr fs nd fu fw dk translated">非常感谢你的支持😊我感谢你对做开源软件和分享知识的认可…</h3></div><div class="nf l"><p class="bd b dl z fp nc fr fs nd fu fw dk translated">github.com</p></div></div><div class="ng l"><div class="nh l ni nj nk ng nl kv mx"/></div></div></a></div></div></div>    
</body>
</html>