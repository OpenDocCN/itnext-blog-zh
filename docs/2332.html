<html>
<head>
<title>Build a modern Android chat app with Kotlin</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Kotlin构建一个现代Android聊天应用</h1>
<blockquote>原文：<a href="https://itnext.io/build-a-modern-android-chat-app-with-kotlin-8af05bbeafaa?source=collection_archive---------5-----------------------#2019-05-07">https://itnext.io/build-a-modern-android-chat-app-with-kotlin-8af05bbeafaa?source=collection_archive---------5-----------------------#2019-05-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="130b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">听说过“沟通是关键”这句话吗？</p><p id="9a7d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">交流在解决世界问题中起着重要的作用。每天，我们都在努力寻找更快或更好的交流方式。让我们觉得彼此更亲近。向全世界发送信息。致力于这些解决方案的公司之一是<strong class="jp ir"> CometChat </strong></p><p id="02a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">CometChat是一个平台，可以帮助您快速将语音、视频和短信功能集成到您的网络和移动应用程序中。</p><p id="e16b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本教程中，我们将构建一个由CometChat支持的简单Android聊天应用程序:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/8c76cec6cf5d384165a67afd36de31c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*MR94ZNLN6NQkK17u.gif"/></div></figure><p id="53e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我鼓励你继续学习，但是如果你想直接跳到代码，你可以在GitHub上找到这个应用程序的完整代码。</p><h1 id="952f" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">创建一个Android Studio项目</h1><p id="7fee" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">启动一个新的Android Studio项目并选择<strong class="jp ir">空活动</strong>:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi lx"><img src="../Images/87ae39a38f8f41ba2b2ba7ded07bc181.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ibLQHW0Pvj9FwAzG.png"/></div></div></figure><p id="0114" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为您的应用程序输入一个名称，我将我的应用程序命名为“CometChat ”,并保留<strong class="jp ir">该项目将支持即时应用程序</strong>和<strong class="jp ir">使用AndroidX工件</strong>未选中:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi lx"><img src="../Images/6225cd92625dffc8cb993710029eeb8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eSywgH1GHOxWATNV.png"/></div></div></figure><h1 id="24ab" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">在我们的应用程序中设置CometChat</h1><p id="698a" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">让我们先安装CometChat Pro SDK，以便我们使用它的服务。</p><p id="272f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.打开您的<code class="fe mc md me mf b">build.gradle</code>文件并添加这些URL:</p><pre class="km kn ko kp gt mg mf mh mi aw mj bi"><span id="01ea" class="mk kv iq mf b gy ml mm l mn mo">allprojects {<br/>    repositories {<br/>        google()<br/>        jcenter()<br/>        maven {<br/>            url "https://dl.bintray.com/cometchat/pro"<br/>        }<br/>        maven {<br/>            url "https://github.com/jitsi/jitsi-maven-repository/raw/master/releases"<br/>        }<br/>    }<br/>}</span></pre><p id="b818" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了下载CometChat SDK，我们必须首先添加这些存储库。</p><p id="a88f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.在同一个<code class="fe mc md me mf b">build.gradle</code>文件中，将这些行添加到<code class="fe mc md me mf b">android</code>块中</p><pre class="km kn ko kp gt mg mf mh mi aw mj bi"><span id="ace2" class="mk kv iq mf b gy ml mm l mn mo">android {<br/>    compileSdkVersion 28<br/>    defaultConfig {<br/>        ...<br/>    }<br/>    compileOptions {<br/>        sourceCompatibility JavaVersion.VERSION_1_8<br/>        targetCompatibility JavaVersion.VERSION_1_8<br/>    }<br/>    buildTypes {<br/>        ...<br/>    }<br/>}</span></pre><p id="b25c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">CometChat SDK使用Java 8语言特性，因此我们必须配置我们的项目来启用它。</p><p id="cf39" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.同样在build.gradle文件中，将这些行添加到<code class="fe mc md me mf b">dependencies</code>块中</p><pre class="km kn ko kp gt mg mf mh mi aw mj bi"><span id="90ef" class="mk kv iq mf b gy ml mm l mn mo">dependencies {<br/>    implementation fileTree(dir: 'libs', include: ['*.jar'])<br/>    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version"</span><span id="6fc3" class="mk kv iq mf b gy mp mm l mn mo">    // Support<br/>    implementation 'com.android.support:appcompat-v7:28.0.0'<br/>    implementation 'com.android.support:design:28.0.0'<br/>    implementation 'com.android.support.constraint:constraint-layout:1.1.3'<br/>    implementation 'com.android.support:recyclerview-v7:28.0.0'</span><span id="3c95" class="mk kv iq mf b gy mp mm l mn mo">    // CometChat<br/>    implementation 'com.cometchat:pro-android-chat-sdk:1.0.+'</span><span id="7f21" class="mk kv iq mf b gy mp mm l mn mo">    // Test<br/>    testImplementation 'junit:junit:4.12'<br/>    androidTestImplementation 'com.android.support.test:runner:1.0.2'<br/>    androidTestImplementation 'com.android.support.test.espresso:espresso-core:3.0.2'<br/>}</span></pre><p id="3f32" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.点击右上角的<strong class="jp ir">立即同步</strong></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mq"><img src="../Images/f244e3cec3720ed1628da6f45fc3fe21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EqBnkCNkMDIfDCrR.png"/></div></div></figure><h1 id="82e7" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">把用户界面的东西去掉</h1><p id="dcfe" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">现在我们已经安装了依赖项，让我们提前定义一些与UI相关的值。</p><p id="cc86" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.打开应用程序/资源/值</p><p id="b860" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.更换<code class="fe mc md me mf b">color.xml</code>:</p><pre class="km kn ko kp gt mg mf mh mi aw mj bi"><span id="1b5b" class="mk kv iq mf b gy ml mm l mn mo">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;resources&gt;<br/>    &lt;color name="colorPrimary"&gt;#673AB7&lt;/color&gt;<br/>    &lt;color name="colorPrimaryDark"&gt;#512DA8&lt;/color&gt;<br/>    &lt;color name="colorAccent"&gt;#E040FB&lt;/color&gt;<br/>    &lt;color name="gray"&gt;#DDDDDD&lt;/color&gt;<br/>&lt;/resources&gt;</span></pre><p id="c25a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我们为应用程序设置颜色的地方。如果你愿意，你可以把它定制成你想要的任何颜色。要获得灵感，请查看<a class="ae kt" href="https://www.materialpalette.com/" rel="noopener ugc nofollow" target="_blank">材质调色板。</a></p><p id="decc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.编辑<code class="fe mc md me mf b">styles.xml</code>:</p><pre class="km kn ko kp gt mg mf mh mi aw mj bi"><span id="87a0" class="mk kv iq mf b gy ml mm l mn mo">&lt;resources&gt;<br/>    &lt;!-- Base application theme. --&gt;<br/>    &lt;style name="AppTheme" parent="Theme.MaterialComponents.Light.DarkActionBar"&gt;<br/>        &lt;!-- Customize your theme here. --&gt;<br/>        &lt;item name="colorPrimary"&gt;@color/colorPrimary&lt;/item&gt;<br/>        &lt;item name="colorPrimaryDark"&gt;@color/colorPrimaryDark&lt;/item&gt;<br/>        &lt;item name="colorAccent"&gt;@color/colorAccent&lt;/item&gt;<br/>    &lt;/style&gt;</span><span id="6165" class="mk kv iq mf b gy mp mm l mn mo">&lt;/resources&gt;</span></pre><p id="69a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">替换您的<code class="fe mc md me mf b">parent</code>主题，使用我们在应用程序中设置CometChat时使用<code class="fe mc md me mf b">implementation 'com.android.support:design:28.0.0</code>导入的材料设计主题。</p><p id="d4c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.编辑<strong class="jp ir"> strings.xml </strong></p><p id="5c23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您的<code class="fe mc md me mf b">strings.xml</code>文件将包含您的CometChat应用ID和API密钥，我们将在下一节中创建:</p><pre class="km kn ko kp gt mg mf mh mi aw mj bi"><span id="aeeb" class="mk kv iq mf b gy ml mm l mn mo">&lt;resources&gt;<br/>    &lt;string name="app_name"&gt;CometChatPro&lt;/string&gt;<br/>    &lt;string name="username"&gt;Username&lt;/string&gt;<br/>    &lt;string name="join_chat"&gt;Join Chat&lt;/string&gt;<br/>    &lt;string name="send"&gt;Send&lt;/string&gt;<br/>    &lt;string name="enter_message"&gt;Enter message…&lt;/string&gt;<br/>    &lt;string name="appID"&gt;YOUR_APP_ID_HERE&lt;/string&gt;<br/>    &lt;string name="apiKey"&gt;YOUR_API_KEY_HERE&lt;/string&gt;<br/>&lt;/resources&gt;</span></pre><p id="deae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">同样，现在不要担心你的APP_ID_HERE和你的API_KEY_HER  E。我们将在下一步中改变这一点。</p><h1 id="f0e9" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">创建并设置一个CometChat Pro帐户</h1><p id="627c" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">1.如果您还没有，请<a class="ae kt" href="http://app.cometchat.com/#/login" rel="noopener ugc nofollow" target="_blank">创建一个CometChat帐户</a></p><p id="b61a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.注册并登录后，前往您的<a class="ae kt" href="https://app.cometchat.com/#/login" rel="noopener ugc nofollow" target="_blank">仪表盘</a></p><p id="6ef6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.创建一个名为“CometChatPro”的新应用程序</p><p id="0508" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.创建API密钥:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi kl"><img src="../Images/10fe260a1cbdebe119680b1ecdafc2ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*XKiSCJuoK68EK6ra.gif"/></div></div></figure><p id="3ec1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.返回到您的<code class="fe mc md me mf b">strings.xml</code>，粘贴您的应用ID和API密钥</p><pre class="km kn ko kp gt mg mf mh mi aw mj bi"><span id="501d" class="mk kv iq mf b gy ml mm l mn mo">&lt;resources&gt;<br/>    ...<br/>    &lt;string name="appID"&gt;2179fddc591bf&lt;/string&gt;<br/>    &lt;string name="apiKey"&gt;6cb3aa84e2c066ed8bb34d3a58b3d6904d829b6e&lt;/string&gt;<br/>&lt;/resources&gt;</span></pre><p id="75e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们已经完成了所有这些设置，让我们测试一下是否可以启动到CometChat Pro API的连接。</p><h1 id="6c03" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">在我们的应用程序中初始化CometChat</h1><p id="f761" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">现在我们已经创建了一个API密钥，让我们初始化应用程序中的CometChat SDK，以便与CometChat服务器建立连接。</p><p id="07ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.在<code class="fe mc md me mf b">cometchat/cometchatpro</code>下创建一个名为<code class="fe mc md me mf b">App.kt</code>的新类，并粘贴以下代码:</p><pre class="km kn ko kp gt mg mf mh mi aw mj bi"><span id="1d36" class="mk kv iq mf b gy ml mm l mn mo">import android.support.v7.widget.RecyclerView<br/>import android.view.LayoutInflater<br/>import android.view.View<br/>import android.view.ViewGroup<br/>import android.widget.TextView<br/>import com.cometchat.pro.models.BaseMessage<br/>import com.cometchat.pro.models.TextMessage</span><span id="9417" class="mk kv iq mf b gy mp mm l mn mo">class MessagesAdapter(private val uid: String,<br/>                      private var messages: MutableList&lt;BaseMessage&gt;)  : RecyclerView.Adapter&lt;MessagesAdapter.MessageViewHolder&gt;() {</span><span id="3a65" class="mk kv iq mf b gy mp mm l mn mo">    companion object {<br/>        private const val SENT = 0<br/>        private const val RECEIVED = 1<br/>    }</span><span id="97e9" class="mk kv iq mf b gy mp mm l mn mo">    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): MessageViewHolder {<br/>        val view = when (viewType) {<br/>            SENT -&gt; {<br/>                LayoutInflater.from(parent.context).inflate(R.layout.item_sent, parent, false)<br/>            }<br/>            else -&gt; {<br/>                LayoutInflater.from(parent.context).inflate(R.layout.item_received, parent, false)<br/>            }<br/>        }<br/>        return MessageViewHolder(view)<br/>    }</span><span id="d4db" class="mk kv iq mf b gy mp mm l mn mo">    override fun getItemCount() = messages.size</span><span id="1426" class="mk kv iq mf b gy mp mm l mn mo">    override fun onBindViewHolder(holder: MessageViewHolder, position: Int) {<br/>        holder.bind(messages[position])<br/>    }</span><span id="b6e4" class="mk kv iq mf b gy mp mm l mn mo">    override fun getItemViewType(position: Int): Int {<br/>        return if (messages[position].sender?.uid!!.contentEquals(uid)) {<br/>            SENT<br/>        } else {<br/>            RECEIVED<br/>        }<br/>    }</span><span id="15bf" class="mk kv iq mf b gy mp mm l mn mo">    fun updateMessages(messages: List&lt;BaseMessage&gt;) {<br/>        this.messages = messages.toMutableList()<br/>        notifyDataSetChanged()<br/>    }</span><span id="29cf" class="mk kv iq mf b gy mp mm l mn mo">    fun appendMessage(message: BaseMessage) {<br/>        this.messages.add(message)<br/>        notifyItemInserted(this.messages.size - 1)<br/>    }</span><span id="0698" class="mk kv iq mf b gy mp mm l mn mo">    inner class MessageViewHolder(itemView: View) : RecyclerView.ViewHolder(itemView) {</span><span id="e733" class="mk kv iq mf b gy mp mm l mn mo">        private val messageText: TextView = itemView.findViewById(R.id.message_text)</span><span id="2708" class="mk kv iq mf b gy mp mm l mn mo">        fun bind(message: BaseMessage) {<br/>            if (message is TextMessage) {<br/>                messageText.text = message.text<br/>            }<br/>        }<br/>    }<br/>}</span></pre><p id="24fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.打开<code class="fe mc md me mf b">AndroidManifest.xml</code>并添加我们新创建的应用程序类:</p><pre class="km kn ko kp gt mg mf mh mi aw mj bi"><span id="09bf" class="mk kv iq mf b gy ml mm l mn mo">&lt;manifest xmlns:android="http://schemas.android.com/apk/res/android"<br/>          package="com.cometchat.cometchatpro"&gt;<br/>    &lt;application<br/>            android:name=".App"<br/>            android:allowBackup="true"<br/>            android:icon="@mipmap/ic_launcher"<br/>            android:label="@string/app_name"<br/>            android:roundIcon="@mipmap/ic_launcher_round"<br/>            android:supportsRtl="true"<br/>            android:theme="@style/AppTheme"&gt;<br/>        ...<br/>    &lt;/application&gt;<br/>&lt;/manifest&gt;</span></pre><p id="ce26" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在模拟器或您自己的设备上运行应用程序。检查日志，您应该会看到文本“初始化完成:初始化成功”:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mr"><img src="../Images/de177f56e3c88bd5d5af58a094da0b0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uL6GJkLjLKWj8pQa.png"/></div></div></figure><p id="0f95" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">既然我们已经与CometChat Pro服务建立了联系，是时候让我们与它互动了。</p><p id="fa96" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在每一个聊天应用程序中，都有用户参与其中并相互交流。因此，让我们首先创建一个登录屏幕来验证我们的用户。</p><h1 id="9dcb" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">创建我们的身份验证用户界面</h1><p id="469e" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">对于应用程序的每个用户，您需要创建一个CometChat用户。每个用户都有一个用户名和一个唯一的ID (UID)。或者，您可以将其他元数据(如个人资料图片)与用户相关联，但这不是我们在此讨论的内容。你可以在<a class="ae kt" href="https://prodocs.cometchat.com/docs/concepts#section-users" rel="noopener ugc nofollow" target="_blank">官方文档</a>中阅读更多关于CometChat用户的信息。</p><p id="e15b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<a class="ae kt" href="https://prodocs.cometchat.com/reference#createuser" rel="noopener ugc nofollow" target="_blank"> CreateUser API </a>可以用代码创建CometChat用户。然而，为了简单起见，我们将通过CometChat仪表板来创建用户。</p><p id="79b8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为我们将手动创建用户，所以我们将只使用用户的UID登录。我们将为我们的UID创建一个文本字段，并创建一个用于登录的按钮。</p><p id="be88" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.在res/layout文件夹下，打开<code class="fe mc md me mf b">activity_main.xml</code>，粘贴以下代码:</p><pre class="km kn ko kp gt mg mf mh mi aw mj bi"><span id="2f20" class="mk kv iq mf b gy ml mm l mn mo">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;android.support.constraint.ConstraintLayout <br/>    xmlns:android="http://schemas.android.com/apk/res/android"<br/>    xmlns:app="http://schemas.android.com/apk/res-auto"<br/>    android:layout_width="match_parent"<br/>    android:layout_height="match_parent"&gt;</span><span id="a120" class="mk kv iq mf b gy mp mm l mn mo">    &lt;EditText<br/>        android:id="@+id/username"<br/>        android:layout_width="0dp"<br/>        android:layout_height="wrap_content"<br/>        android:layout_marginStart="24dp"<br/>        android:layout_marginTop="8dp"<br/>        android:layout_marginEnd="24dp"<br/>        android:layout_marginBottom="8dp"<br/>        android:hint="@string/username"<br/>        app:layout_constraintBottom_toBottomOf="parent"<br/>        app:layout_constraintEnd_toEndOf="parent"<br/>        app:layout_constraintStart_toStartOf="parent"<br/>        app:layout_constraintTop_toTopOf="parent" /&gt;</span><span id="8c8e" class="mk kv iq mf b gy mp mm l mn mo">    &lt;Button<br/>        android:id="@+id/join_chat"<br/>        android:layout_width="128dp"<br/>        android:layout_height="wrap_content"<br/>        android:layout_marginTop="8dp"<br/>        android:text="@string/join_chat"<br/>        app:layout_constraintEnd_toEndOf="@+id/username"<br/>        app:layout_constraintStart_toStartOf="@+id/username"<br/>        app:layout_constraintTop_toBottomOf="@+id/username" /&gt;<br/>&lt;/android.support.constraint.ConstraintLayout&gt;</span></pre><p id="029f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.运行应用程序，你应该有类似这样的东西</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/16dc48c13776e25d13909f85b628c6e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/format:webp/0*Pty8jGIGIwQe1V_F.png"/></div></figure><h1 id="6c7d" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">实现我们的验证码</h1><p id="52a0" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">在您创建了用于身份验证的UI之后，让我们通过使用CometChat服务器进行身份验证来添加登录功能。</p><p id="06ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.打开您的<code class="fe mc md me mf b">MainActivity.class</code>，粘贴以下代码:</p><pre class="km kn ko kp gt mg mf mh mi aw mj bi"><span id="57f0" class="mk kv iq mf b gy ml mm l mn mo">class MainActivity : AppCompatActivity() {</span><span id="1564" class="mk kv iq mf b gy mp mm l mn mo">    private lateinit var join: Button<br/>    private lateinit var username: EditText</span><span id="77ed" class="mk kv iq mf b gy mp mm l mn mo">    override fun onCreate(savedInstanceState: Bundle?) {<br/>        super.onCreate(savedInstanceState)<br/>        setContentView(R.layout.activity_main)</span><span id="56c6" class="mk kv iq mf b gy mp mm l mn mo">        username = findViewById(R.id.username)</span><span id="3ea7" class="mk kv iq mf b gy mp mm l mn mo">        join = findViewById(R.id.join_chat)<br/>        join.setOnClickListener {<br/>            disableAuthField()<br/>            login()<br/>        }<br/>    }</span><span id="0960" class="mk kv iq mf b gy mp mm l mn mo">    private fun disableAuthField() {<br/>        join.isEnabled = false<br/>        username.isEnabled = false<br/>    }</span><span id="8ccf" class="mk kv iq mf b gy mp mm l mn mo">    private fun login() {<br/>        CometChat.login(username.text.toString(), getString(R.string.apiKey), object : CometChat.CallbackListener() {<br/>            override fun onSuccess(user: User) {<br/>                username.setText("")<br/>                enableAuthField()<br/>                Toast.makeText(this@MainActivity, "Login successful", Toast.LENGTH_SHORT).show()<br/>            }</span><span id="b92b" class="mk kv iq mf b gy mp mm l mn mo">            override fun onError(e: CometChatException) {<br/>                Toast.makeText(this@MainActivity, "Error or username doesn't exist.", Toast.LENGTH_SHORT).show()<br/>                enableAuthField()<br/>            }<br/>        })<br/>    }</span><span id="fd3d" class="mk kv iq mf b gy mp mm l mn mo">    private fun enableAuthField() {<br/>        join.isEnabled = true<br/>        username.isEnabled = true<br/>    }<br/>}</span></pre><p id="3739" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是等等！您可能会问自己“我如何创建用户？”。为了使本教程简单，我们将使用<a class="ae kt" href="https://app.cometchat.com/#/apps" rel="noopener ugc nofollow" target="_blank">仪表板</a>创建一个用户。对于实际的生产应用程序，您应该使用<a class="ae kt" href="https://prodocs.cometchat.com/reference#createuser" rel="noopener ugc nofollow" target="_blank"> CreateUser API </a>来创建用户。</p><h1 id="e66d" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">创建用户</h1><p id="4d84" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">转到您的<a class="ae kt" href="https://app.cometchat.com/#/apps" rel="noopener ugc nofollow" target="_blank">仪表盘</a>并点击CometChatPro应用程序下方的<strong class="jp ir">探索</strong>按钮</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/2659853871b5f9e431bee4aec1b707f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*cZIpISt9Nu-q5jsY.gif"/></div></figure><p id="93b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所见，CometChat提供了一组现有的示例用户。您也可以使用这个，但是创建用户也非常简单。</p><p id="bd1d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">记下您刚刚创建的用户的UID，因为我们将使用它来登录我们的应用程序。</p><h1 id="3087" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">登录CometChat</h1><p id="9a21" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">使用我们刚刚创建的用户的UID“user 1”。</p><p id="cec8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.运行应用程序</p><p id="aa13" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.在用户名输入中，输入“用户1”</p><p id="0bd4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.点击<strong class="jp ir">登录</strong>，你会看到一个提示“登录成功”的提示</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/dc859fbe4b871661ee983357d2888599.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/format:webp/0*uxqf4QZrZNXiLuSn.png"/></div></figure><p id="b4ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们可以登录了，让我们进入本教程最精彩的部分，开发聊天功能！</p><p id="83fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将学习如何使用CometChat实时发送、获取和监听消息。😎</p><h1 id="83a9" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">使用CometChat群组创建聊天室</h1><p id="f91d" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">它有很多名字——对话、聊天室或群组。重要的是，对于用户来说，要相互交流，他们必须有相互传递信息的方法。</p><p id="559e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是CometChat组的用武之地。把群组想象成一个聊天室，让用户发送他们的信息，也让群组中的其他人接收信息。</p><p id="2649" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">出于本教程的目的，我们将使用CometChat仪表板进行分组。如果您愿意，也可以用代码动态创建一个组。更多信息请点击。</p><p id="20f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.在侧边栏中，点击<strong class="jp ir">群组</strong>:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/dda494681b980ae45a282c54985f0d5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:508/format:webp/0*r9N0hd0z37SemBNG.png"/></div></figure><p id="c653" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.CometChat为您提供了一个名为“超群”的样本群。创建自己的群也很容易。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi lx"><img src="../Images/1fec30d870410d3097343d894ef307f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QkZTHS-3WPRagCFt.png"/></div></div></figure><p id="7b0d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.点击<strong class="jp ir">创建群组</strong></p><p id="bff2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.输入<strong class="jp ir"> GUID、名称和类型</strong></p><p id="851a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.单击<strong class="jp ir">创建组</strong>并记下GUID，因为我们将在后面的步骤中使用它</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mu"><img src="../Images/51ac7004280225d04621fd1f08aa9334.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*t4vuUpAXk6gpKEa1.png"/></div></div></figure><h1 id="efcc" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">创建我们的消息屏幕用户界面</h1><p id="f8d6" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">现在我们已经创建了一个组，我们将创建发送和显示聊天消息的UI。</p><p id="798e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.在<code class="fe mc md me mf b">cometchat/cometchatpro</code>下创建一个名为<code class="fe mc md me mf b">MessagesActivity</code>的新的空活动</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mv"><img src="../Images/b8e6246cc93f2c0a1d6a4c04cea824bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*x-h3sufISDsocg2_.png"/></div></div></figure><p id="9725" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.打开您的<code class="fe mc md me mf b">activity_messages.xml</code>布局并粘贴以下代码:</p><pre class="km kn ko kp gt mg mf mh mi aw mj bi"><span id="d297" class="mk kv iq mf b gy ml mm l mn mo">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;android.support.constraint.ConstraintLayout<br/>    xmlns:android="http://schemas.android.com/apk/res/android"<br/>    xmlns:app="http://schemas.android.com/apk/res-auto"<br/>    android:layout_width="match_parent"<br/>    android:layout_height="match_parent"&gt;</span><span id="661c" class="mk kv iq mf b gy mp mm l mn mo">    &lt;android.support.v7.widget.RecyclerView<br/>        android:id="@+id/messages"<br/>        android:layout_width="0dp"<br/>        android:layout_height="0dp"<br/>        android:layout_marginStart="8dp"<br/>        android:layout_marginTop="8dp"<br/>        android:layout_marginEnd="8dp"<br/>        android:layout_marginBottom="8dp"<br/>        app:layout_constraintBottom_toTopOf="@+id/enter_message"<br/>        app:layout_constraintEnd_toEndOf="parent"<br/>        app:layout_constraintStart_toStartOf="parent"<br/>        app:layout_constraintTop_toTopOf="parent" /&gt;</span><span id="3e0a" class="mk kv iq mf b gy mp mm l mn mo">    &lt;EditText<br/>        android:id="@+id/enter_message"<br/>        android:layout_width="0dp"<br/>        android:layout_height="wrap_content"<br/>        android:layout_marginStart="8dp"<br/>        android:layout_marginEnd="8dp"<br/>        android:layout_marginBottom="8dp"<br/>        android:hint="@string/enter_message"<br/>        app:layout_constraintBottom_toBottomOf="parent"<br/>        app:layout_constraintEnd_toStartOf="@+id/send_message"<br/>        app:layout_constraintHorizontal_bias="0.5"<br/>        app:layout_constraintStart_toStartOf="parent" /&gt;</span><span id="4c02" class="mk kv iq mf b gy mp mm l mn mo">    &lt;Button<br/>        android:id="@+id/send_message"<br/>        android:layout_width="wrap_content"<br/>        android:layout_height="wrap_content"<br/>        android:layout_marginEnd="8dp"<br/>        android:text="@string/send"<br/>        app:layout_constraintBottom_toBottomOf="@+id/enter_message"<br/>        app:layout_constraintEnd_toEndOf="parent"<br/>        app:layout_constraintHorizontal_bias="0.5"<br/>        app:layout_constraintStart_toEndOf="@+id/enter_message"<br/>        app:layout_constraintTop_toTopOf="@+id/enter_message" /&gt;</span><span id="0ed6" class="mk kv iq mf b gy mp mm l mn mo">&lt;/android.support.constraint.ConstraintLayout&gt;</span></pre><p id="eb6f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.如果登录成功，打开您的<code class="fe mc md me mf b">MainActivity.class</code>并启动我们的<code class="fe mc md me mf b">MessagesActivity</code></p><pre class="km kn ko kp gt mg mf mh mi aw mj bi"><span id="b1f0" class="mk kv iq mf b gy ml mm l mn mo">private fun login() {<br/>  CometChat.login(username.text.toString(), getString(R.string.apiKey), object : CometChat.CallbackListener() {<br/>    override fun onSuccess(user: User) {<br/>      username.setText("")<br/>      enableAuthField()<br/>      val intent = Intent(this@MainActivity, MessagesActivity::class.java)<br/>      startActivity(intent)<br/>    }<br/>    ...<br/>  })<br/>}</span></pre><p id="aa2a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行应用程序，当我们以“用户1”的身份登录时，它应该会启动我们的<code class="fe mc md me mf b">MessagesActivity</code></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/a1eead10666bda2462a99a8ebb59294e.png" data-original-src="https://miro.medium.com/v2/resize:fit:540/0*1fLbh5aa5-Pk8UUm.gif"/></div></figure><h1 id="7ea0" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">发送消息</h1><p id="7cb8" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">在CometChat中，有两种消息:<a class="ae kt" href="https://prodocs.cometchat.com/docs/android-appendix#section-textmessage" rel="noopener ugc nofollow" target="_blank"> TextMessage </a>和<a class="ae kt" href="https://prodocs.cometchat.com/docs/android-appendix#section-mediamessage" rel="noopener ugc nofollow" target="_blank"> MediaMessage </a>。在本教程中，我们将只关注文本消息。</p><p id="2340" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.在res/drawable文件夹下，创建两个新的drawable:</p><p id="b1ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mc md me mf b">item_received_background.xml</code>:</p><pre class="km kn ko kp gt mg mf mh mi aw mj bi"><span id="0a41" class="mk kv iq mf b gy ml mm l mn mo">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>    &lt;shape xmlns:android="http://schemas.android.com/apk/res/android"&gt;<br/>        &lt;solid android:color="@color/gray" /&gt;<br/>        &lt;corners android:radius="4dp" /&gt;<br/>    &lt;/shape&gt;</span></pre><p id="221d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mc md me mf b">item_sent_background.xml</code>:</p><pre class="km kn ko kp gt mg mf mh mi aw mj bi"><span id="207b" class="mk kv iq mf b gy ml mm l mn mo">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;shape xmlns:android="http://schemas.android.com/apk/res/android"&gt;<br/>    &lt;solid android:color="@color/colorPrimary" /&gt;<br/>    &lt;corners android:radius="4dp" /&gt;<br/>&lt;/shape&gt;</span></pre><p id="3f5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.在res/layout文件夹下，创建两个新布局:</p><p id="0ec0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mc md me mf b">item_received.xml</code>:</p><pre class="km kn ko kp gt mg mf mh mi aw mj bi"><span id="801a" class="mk kv iq mf b gy ml mm l mn mo">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>    &lt;LinearLayout<br/>        xmlns:android="http://schemas.android.com/apk/res/android"<br/>        android:layout_width="match_parent"<br/>        android:layout_height="wrap_content"<br/>        android:orientation="vertical"&gt;<br/>        &lt;TextView<br/>            android:id="@+id/message_text"<br/>            android:layout_width="wrap_content"<br/>            android:layout_height="wrap_content"<br/>            android:layout_margin="8dp"<br/>            android:background="@drawable/item_received_background"<br/>            android:gravity="center"<br/>            android:padding="8dp" /&gt;<br/>    &lt;/LinearLayout&gt;</span></pre><p id="777a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mc md me mf b">item_sent.xml</code>:</p><pre class="km kn ko kp gt mg mf mh mi aw mj bi"><span id="e6c3" class="mk kv iq mf b gy ml mm l mn mo">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;LinearLayout<br/>    xmlns:android="http://schemas.android.com/apk/res/android"<br/>    android:layout_width="match_parent"<br/>    android:layout_height="wrap_content"<br/>    android:orientation="vertical"&gt;<br/>    &lt;TextView<br/>        android:id="@+id/message_text"<br/>        android:layout_width="wrap_content"<br/>        android:layout_height="wrap_content"<br/>        android:layout_gravity="end"<br/>        android:layout_margin="8dp"<br/>        android:background="@drawable/item_sent_background"<br/>        android:gravity="center"<br/>        android:padding="8dp"<br/>        android:textColor="@android:color/white" /&gt;<br/>&lt;/LinearLayout&gt;</span></pre><p id="9700" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.创建一个新类— <code class="fe mc md me mf b">MessagesAdapter</code>并粘贴以下代码:</p><pre class="km kn ko kp gt mg mf mh mi aw mj bi"><span id="630d" class="mk kv iq mf b gy ml mm l mn mo">import android.support.v7.widget.RecyclerView<br/>import android.view.LayoutInflater<br/>import android.view.View<br/>import android.view.ViewGroup<br/>import android.widget.TextView<br/>import com.cometchat.pro.models.BaseMessage<br/>import com.cometchat.pro.models.TextMessage</span><span id="54c5" class="mk kv iq mf b gy mp mm l mn mo">class MessagesAdapter(private val uid: String,<br/>                      private var messages: MutableList&lt;BaseMessage&gt;)  : RecyclerView.Adapter&lt;MessagesAdapter.MessageViewHolder&gt;() {</span><span id="33ca" class="mk kv iq mf b gy mp mm l mn mo">    companion object {<br/>        private const val SENT = 0<br/>        private const val RECEIVED = 1<br/>    }</span><span id="2faa" class="mk kv iq mf b gy mp mm l mn mo">    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): MessageViewHolder {<br/>        val view = when (viewType) {<br/>            SENT -&gt; {<br/>                LayoutInflater.from(parent.context).inflate(R.layout.item_sent, parent, false)<br/>            }<br/>            else -&gt; {<br/>                LayoutInflater.from(parent.context).inflate(R.layout.item_received, parent, false)<br/>            }<br/>        }<br/>        return MessageViewHolder(view)<br/>    }</span><span id="f47f" class="mk kv iq mf b gy mp mm l mn mo">    override fun getItemCount() = messages.size</span><span id="9135" class="mk kv iq mf b gy mp mm l mn mo">    override fun onBindViewHolder(holder: MessageViewHolder, position: Int) {<br/>        holder.bind(messages[position])<br/>    }</span><span id="aefa" class="mk kv iq mf b gy mp mm l mn mo">    override fun getItemViewType(position: Int): Int {<br/>        return if (messages[position].sender?.uid!!.contentEquals(uid)) {<br/>            SENT<br/>        } else {<br/>            RECEIVED<br/>        }<br/>    }</span><span id="3d93" class="mk kv iq mf b gy mp mm l mn mo">    fun updateMessages(messages: List&lt;BaseMessage&gt;) {<br/>        this.messages = messages.toMutableList()<br/>        notifyDataSetChanged()<br/>    }</span><span id="b2f9" class="mk kv iq mf b gy mp mm l mn mo">    fun appendMessage(message: BaseMessage) {<br/>        this.messages.add(message)<br/>        notifyItemInserted(this.messages.size - 1)<br/>    }</span><span id="7033" class="mk kv iq mf b gy mp mm l mn mo">    inner class MessageViewHolder(itemView: View) : RecyclerView.ViewHolder(itemView) {</span><span id="3cc4" class="mk kv iq mf b gy mp mm l mn mo">        private val messageText: TextView = itemView.findViewById(R.id.message_text)</span><span id="b611" class="mk kv iq mf b gy mp mm l mn mo">        fun bind(message: BaseMessage) {<br/>            if (message is TextMessage) {<br/>                messageText.text = message.text<br/>            }<br/>        }<br/>    }<br/>}</span></pre><p id="f5c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.打开你的<code class="fe mc md me mf b">MessagesActivity.class</code>，粘贴以下代码。确保将<code class="fe mc md me mf b">roomID</code>字段设置为“androidroom ”,这是我们之前创建的:</p><pre class="km kn ko kp gt mg mf mh mi aw mj bi"><span id="984e" class="mk kv iq mf b gy ml mm l mn mo">import android.os.Bundle<br/>import android.support.v7.app.AppCompatActivity<br/>import android.support.v7.widget.LinearLayoutManager<br/>import android.support.v7.widget.RecyclerView<br/>import android.util.Log<br/>import android.widget.Button<br/>import android.widget.EditText<br/>import com.cometchat.pro.constants.CometChatConstants<br/>import com.cometchat.pro.core.CometChat<br/>import com.cometchat.pro.exceptions.CometChatException<br/>import com.cometchat.pro.models.TextMessage</span><span id="c6ff" class="mk kv iq mf b gy mp mm l mn mo">class MessagesActivity : AppCompatActivity() {</span><span id="c21c" class="mk kv iq mf b gy mp mm l mn mo">    private lateinit var enterMessage: EditText<br/>    private lateinit var send: Button<br/>    private lateinit var messagesList: RecyclerView<br/>    private lateinit var messagesAdapter: MessagesAdapter</span><span id="4c23" class="mk kv iq mf b gy mp mm l mn mo">    private val roomID = "androidroom"</span><span id="6d67" class="mk kv iq mf b gy mp mm l mn mo">    override fun onCreate(savedInstanceState: Bundle?) {<br/>        super.onCreate(savedInstanceState)<br/>        setContentView(R.layout.activity_messages)</span><span id="627b" class="mk kv iq mf b gy mp mm l mn mo">        enterMessage = findViewById(R.id.enter_message)<br/>        send = findViewById(R.id.send_message)</span><span id="f0f4" class="mk kv iq mf b gy mp mm l mn mo">        messagesList = findViewById(R.id.messages)<br/>        val layoutMgr = LinearLayoutManager(this)<br/>        layoutMgr.stackFromEnd = true<br/>        messagesList.layoutManager = layoutMgr</span><span id="5bc1" class="mk kv iq mf b gy mp mm l mn mo">        messagesAdapter = MessagesAdapter(CometChat.getLoggedInUser().uid, mutableListOf())<br/>        messagesList.adapter = messagesAdapter</span><span id="9560" class="mk kv iq mf b gy mp mm l mn mo">        send.setOnClickListener {<br/>            sendMessage()<br/>        }<br/>        <br/>        joinGroup()<br/>    }</span><span id="0d52" class="mk kv iq mf b gy mp mm l mn mo">    private fun joinGroup() {<br/>        CometChat.joinGroup(<br/>            roomID,<br/>            CometChatConstants.GROUP_TYPE_PUBLIC,<br/>            "",<br/>            object : CometChat.CallbackListener&lt;String&gt;() {<br/>                override fun onSuccess(successMessage: String) {<br/>                    Log.d("CometChat", "Group join successful")<br/>                }</span><span id="9c8b" class="mk kv iq mf b gy mp mm l mn mo">                override fun onError(e: CometChatException) {<br/>                    e.code?.let {<br/>                        // For now, we'll just keep on attempting to join the group<br/>                        // because persistence is out of the scope for this tutorial<br/>                        if (it.contentEquals("ERR_ALREADY_JOINED")) {<br/>                            Log.d("CometChat", "Already joined the group")<br/>                        }<br/>                    }<br/>                }<br/>            })<br/>    }</span><span id="2db0" class="mk kv iq mf b gy mp mm l mn mo">    private fun sendMessage() {<br/>        val textMessage = TextMessage(<br/>            roomID,<br/>            enterMessage.text.toString(),<br/>            CometChatConstants.MESSAGE_TYPE_TEXT,<br/>            CometChatConstants.RECEIVER_TYPE_GROUP<br/>        )</span><span id="0c6c" class="mk kv iq mf b gy mp mm l mn mo">        CometChat.sendMessage(textMessage, object : CometChat.CallbackListener&lt;TextMessage&gt;() {<br/>            override fun onSuccess(message: TextMessage) {<br/>                enterMessage.setText("")<br/>                messagesAdapter.appendMessage(message)<br/>                scrollToBottom()<br/>            }</span><span id="52c0" class="mk kv iq mf b gy mp mm l mn mo">            override fun onError(e: CometChatException) {<br/>                Log.d("CometChat", "Message send failed: ${e.message}")<br/>            }<br/>        })<br/>    }</span><span id="ddce" class="mk kv iq mf b gy mp mm l mn mo">    private fun scrollToBottom() {<br/>        messagesList.scrollToPosition(messagesAdapter.itemCount - 1)<br/>    }<br/>}</span></pre><p id="b36f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意<code class="fe mc md me mf b">joinGroup()</code>功能。</p><p id="9a94" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们必须先加入群，然后才能向群发送消息。暂时忽略<code class="fe mc md me mf b">onError(…)</code>部分，因为我们将尝试继续加入该组，因为持久性现在超出了我们的范围。</p><p id="b136" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.运行应用程序并尝试发送消息。你应该有这样的东西。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/ee8d59cca8ac36b6b56168aa45173b1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:540/0*AvQTjyFIL6iJeayC.gif"/></div></figure><p id="5115" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">很棒吧？！😉</p><p id="55e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是有一个问题。如果你把app杀了，重新登录，屏幕是空的。我们的信息去了哪里？继续下一步，找出答案</p><h1 id="cd27" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">获取以前的消息</h1><p id="4f9d" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">在上一步中，我们能够发送消息，但当我们再次打开应用程序时，屏幕是空的。</p><p id="fcd9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不要担心，我们的消息真的发送了，它存储在CometChat中。我们只需要一种方法来获取在组中发送的消息。</p><p id="7981" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.打开<code class="fe mc md me mf b">MessagesActivity.class</code>并添加<code class="fe mc md me mf b">fetchMessages()</code>功能</p><pre class="km kn ko kp gt mg mf mh mi aw mj bi"><span id="57cd" class="mk kv iq mf b gy ml mm l mn mo">class MessagesActivity : AppCompatActivity() {<br/>    ...<br/>    override fun onCreate(savedInstanceState: Bundle?) {<br/>        ...<br/>    }</span><span id="b244" class="mk kv iq mf b gy mp mm l mn mo">    private fun joinGroup() {<br/>        CometChat.joinGroup(<br/>            roomID,<br/>            CometChatConstants.GROUP_TYPE_PUBLIC,<br/>            "",<br/>            object : CometChat.CallbackListener&lt;String&gt;() {<br/>                override fun onSuccess(successMessage: String) {<br/>                    fetchMessages()<br/>                }</span><span id="2850" class="mk kv iq mf b gy mp mm l mn mo">                override fun onError(e: CometChatException) {<br/>                    e.code?.let {<br/>                        // For now, we'll just keep on attempting to join the group<br/>                        // because persistence is out of the scope for this tutorial<br/>                        if (it.contentEquals("ERR_ALREADY_JOINED")) {<br/>                            fetchMessages()<br/>                        }<br/>                    }<br/>                }<br/>            })<br/>    }</span><span id="b654" class="mk kv iq mf b gy mp mm l mn mo">    private fun fetchMessages() {<br/>        val messagesRequest = MessagesRequest.MessagesRequestBuilder()<br/>            .setGUID(roomID)<br/>            .setLimit(30)<br/>            .build()</span><span id="d654" class="mk kv iq mf b gy mp mm l mn mo">        messagesRequest.fetchPrevious(object : CometChat.CallbackListener&lt;List&lt;BaseMessage&gt;&gt;() {<br/>            override fun onSuccess(messages: List&lt;BaseMessage&gt;) {<br/>                messagesAdapter.updateMessages(messages.filter { it is TextMessage })<br/>                scrollToBottom()<br/>            }</span><span id="3b9e" class="mk kv iq mf b gy mp mm l mn mo">            override fun onError(e: CometChatException) {<br/>                Log.d("CometChat", "Fetch messages failed: ${e.message}")<br/>            }<br/>        })<br/>    }<br/>    ...<br/>}</span></pre><p id="ccb4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.运行应用程序，您应该会看到您不久前发送的消息🎉</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/20ae0c8fcd6d65de69ab5c31148bfa23.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/0*c67OjwQCl0v_TzCq.gif"/></div></figure><p id="4c0c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我知道你在想什么。</p><p id="b5f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">“老兄，我知道我现在可以发送消息并查看我的消息了。但自言自语会有点奇怪，对吧？”</p><p id="424b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不要担心！下一步，我们将学习如何实时接收来自其他真实人物的信息！</p><h1 id="223b" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">实时接收消息！</h1><p id="5348" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">1.修改我们的<code class="fe mc md me mf b">MessagesActivity.class</code>以收听新消息:</p><pre class="km kn ko kp gt mg mf mh mi aw mj bi"><span id="2c0f" class="mk kv iq mf b gy ml mm l mn mo">class MessagesActivity : AppCompatActivity() {<br/>    ...<br/>    private val listenerID = "MESSAGES_LISTENER"</span><span id="34f8" class="mk kv iq mf b gy mp mm l mn mo">    override fun onCreate(savedInstanceState: Bundle?) {<br/>        ...<br/>    }</span><span id="aae8" class="mk kv iq mf b gy mp mm l mn mo">    override fun onResume() {<br/>        super.onResume()<br/>        CometChat.addMessageListener(listenerID, object : CometChat.MessageListener() {<br/>            override fun onTextMessageReceived(message: TextMessage) {<br/>                messagesAdapter.appendMessage(message)<br/>                scrollToBottom()<br/>            }<br/>        })<br/>    }</span><span id="fb15" class="mk kv iq mf b gy mp mm l mn mo">    override fun onPause() {<br/>        super.onPause()<br/>        CometChat.removeMessageListener(listenerID)<br/>    }<br/>    ...<br/>}</span></pre><p id="9222" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就这样？！是的，在CometChat中实时接收其他用户的消息就是这么简单。</p><p id="15f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.在两个模拟器或设备中运行应用程序。以“用户1”的身份登录第一个，以“超级英雄1”的身份登录另一个CometChat提供的示例用户之一。这是你应该看到的:</p><p id="65bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">恭喜🎉！您刚刚创建了您的第一个Android聊天应用程序！给自己一个鼓励。奖励自己。与你的朋友分享，如果你有时间，也教他们如何做一个。</p><p id="6841" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你已经做到这一步，我们想说非常感谢你花时间真正完成教程。</p><p id="ae2a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们希望你学到了一些东西，至少对你作为Android开发者的旅程有所影响。</p><h1 id="aa68" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">接下来去哪里？</h1><p id="6281" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">本教程只是你可以用CometChat做的事情的冰山一角。为了提高你的成绩，这里有一些资源可以帮助你:</p><p id="2725" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kt" href="https://prodocs.cometchat.com/docs/android-quick-start" rel="noopener ugc nofollow" target="_blank"> CometChat Pro Android文档</a></p><p id="87bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">也可以查看其他平台的CometChat Pro。</p><p id="ada4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kt" href="https://prodocs.cometchat.com/docs/ios-quick-start" rel="noopener ugc nofollow" target="_blank"> CometChat Pro iOS文档</a></p><p id="e5bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kt" href="https://prodocs.cometchat.com/docs/js-quick-start" rel="noopener ugc nofollow" target="_blank"> CometChat Pro Javascript文档</a></p></div></div>    
</body>
</html>