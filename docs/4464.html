<html>
<head>
<title>Top 5 Istio Commands</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">五大Istio命令</h1>
<blockquote>原文：<a href="https://itnext.io/top-5-istio-commands-f54ada0cc4e?source=collection_archive---------0-----------------------#2020-07-06">https://itnext.io/top-5-istio-commands-f54ada0cc4e?source=collection_archive---------0-----------------------#2020-07-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="cf61" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Istio项目(和服务网格)已经成为云原生世界中家喻户晓的名字，这是有充分理由的！Istio可以位于Kubernetes之上，也可以单独作为一个控制平面，只要它管理着通过<a class="ae ko" href="https://www.envoyproxy.io/" rel="noopener ugc nofollow" target="_blank">特使代理</a>路由流量的服务舰队。Istio将三件大事合二为一——路由、可观察性和安全性。在我学习的早期，关于Kubernetes的一个很棒的项目(嗯，我仍然是！)是kubectl备忘单。在这篇文章中，我希望给你五种调试Istio的新方法，以及一个当你不确定集群中发生了什么时可以使用的快速工具箱。我假设您正在Kubernetes上运行Istio，并且已经安装了<code class="fe kp kq kr ks b">istioctl</code>(一些命令使用它)。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div class="gh gi kt"><img src="../Images/eb1c6fdd5f2e28b8e74b491e2458f550.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/format:webp/0*EOiB-uX-9pA1XbN0.png"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">Istio不需要Kubernetes，但这两者可以很好地结合在一起</figcaption></figure><h1 id="26c0" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">1.kubectl get pods -n istio-system</h1><p id="fb6a" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">把它打出来感觉有点傻，但是如果你是新手，知道Istio通常在<code class="fe kp kq kr ks b">istio-system</code>名称空间中安装它的控制平面组件是有好处的。Istio 1.6及以上版本中的关键组件是<code class="fe kp kq kr ks b">istiod</code>。下面是一个输出示例。</p><pre class="ku kv kw kx gt mi ks mj mk aw ml bi"><span id="ef8c" class="mm lg it ks b gy mn mo l mp mq">$ kubectl get pods -n istio-system<br/>NAME                                    READY   STATUS    RESTARTS   AGE<br/>grafana-64986f9974-bmb28                1/1     Running   0          13d<br/>istio-egressgateway-5f9595d5d-gtlwr     1/1     Running   0          13d<br/>istio-ingressgateway-555fd75c88-f6jc8   1/1     Running   0          13d<br/>istio-tracing-7cf5f46848-fzmmh          1/1     Running   0          13d<br/>istiod-76b6d8f677-ml96d                 1/1     Running   0          13d<br/>kiali-7fcc47db9f-fbvrs                  1/1     Running   0          13d<br/>prometheus-698dc96c9-d7ltt              2/2     Running   0          13d</span></pre><p id="cfe9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">注意这里我运行了一些额外的项目，事实上这是和<code class="fe kp kq kr ks b">istioctl</code>一起安装的<code class="fe kp kq kr ks b">demo</code>概要文件</p><h1 id="d8fb" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">2.ku bectl logs-n istio-system-l app = istiod</h1><p id="6448" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">这从Istiod获取日志，并为您提供控制平面中发生的事件的快照。同样，这是一个输出示例。注意，我从标签<code class="fe kp kq kr ks b">app=istiod</code>中抓取了<code class="fe kp kq kr ks b">istiod</code></p><pre class="ku kv kw kx gt mi ks mj mk aw ml bi"><span id="36c4" class="mm lg it ks b gy mn mo l mp mq">$ kubectl logs -n istio-system -l app=istiod<br/>2020-07-06T17:47:13.725314Z info ads LDS: PUSH for node:istio-ingressgateway-555fd75c88-f6jc8.istio-system listeners:0<br/>2020-07-06T17:47:13.726066Z info ads EDS: PUSH for node:istio-ingressgateway-555fd75c88-f6jc8.istio-system clusters:64 endpoints:70 empty:0</span></pre><p id="2728" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在任何给定的时间，我都发现这些日志要么充满了有用的信息，要么充满了与我正在调试的内容无关的状态。这是一般性的，但是当Istio集群中出现问题时，<code class="fe kp kq kr ks b">istiod</code>通常包含部分答案，因为往来于特使代理的许多重试逻辑都记录在<code class="fe kp kq kr ks b">istiod</code>中</p><h1 id="7b68" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">3.组织分析</h1><p id="b7bf" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated"><code class="fe kp kq kr ks b">istioctl</code>工具附带了一个分析工具，它通常是我调试Istio时首先去的地方，尤其是当我需要一个系统基线的时候。它会告诉你关于你丢失的东西和不一致的一般项目的常见警告。这是我的一个例子，注意我遗漏了Istio侧车注射所需的标签。<a class="ae ko" href="https://istio.io/latest/docs/ops/diagnostic-tools/istioctl-analyze/" rel="noopener ugc nofollow" target="_blank">查看文档了解更多信息。</a></p><pre class="ku kv kw kx gt mi ks mj mk aw ml bi"><span id="4864" class="mm lg it ks b gy mn mo l mp mq">$ istioctl analyze<br/>Warn [IST0102] (Namespace default) The namespace is not enabled for Istio injection. Run 'kubectl label namespace default istio-injection=enabled' to enable it, or 'kubectl label namespace default istio-injection=disabled' to explicitly mark it as not needing injection</span></pre><p id="8839" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个输出实际上非常有用，我的边车注射标签不见了！</p><h1 id="9854" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">4.istioctl代理-状态</h1><p id="815c" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">该命令对于获取网格的概览非常有用。您的Istio安装中的sidecars(通过Envoy提供支持)依赖于一组称为<code class="fe kp kq kr ks b">xDS</code> API的API，意思是x发现服务，其中x是被发现的配置类型(有四个)。我知道这可能从一开始就听起来令人困惑，但需要知道的重要一点是，Istio是一个巨大的工具，用于配置多个一起工作的特使代理。这些代理将其配置分成四个部分，每个部分代表一个发现服务。<a class="ae ko" href="https://www.envoyproxy.io/docs/envoy/latest/api-docs/xds_protocol" rel="noopener ugc nofollow" target="_blank">有关更多信息，请参见特使文档。</a></p><p id="317b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">底线是，您在这个输出中寻找的是每个<code class="fe kp kq kr ks b">xDS</code>字段都表示<code class="fe kp kq kr ks b">SYNCED</code>(总共有四个)。</p><pre class="ku kv kw kx gt mi ks mj mk aw ml bi"><span id="1e66" class="mm lg it ks b gy mn mo l mp mq">$ istioctl proxy-status<br/>NAME                 CDS    LDS    EDS     RDS      PILOT  VERSION<br/>istio-egressgateway  SYNCED SYNCED SYNCED  NOT SENT istiod   1.6.2<br/>istio-ingressgateway SYNCED SYNCED SYNCED  NOT SENT istiod   1.6.2<br/>prometheus           SYNCED SYNCED SYNCED  SYNCED   istiod   1.6.2</span></pre><h1 id="1a0a" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">5.kubectl日志POD_NAME -c istio-proxy</h1><p id="d716" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">这一点也很容易理解，但仍然值得一提，以防它不在您的首选项中。您的代理将发出各种各样的事件，尤其是当您更改您的Istio对象或尝试一些新的东西时。监控这些日志对于观察流量进出您的pod(以及当它失败时)非常有用。例如，您可以从pod中观察<code class="fe kp kq kr ks b">curl https://www.google.com</code>事件:</p><pre class="ku kv kw kx gt mi ks mj mk aw ml bi"><span id="3507" class="mm lg it ks b gy mn mo l mp mq">$ kubectl logs productpage-v1-88646568d-v9q6w -c istio-proxy<br/>2020-07-06T18:53:08.946714Z info Obtained private IP [10.32.2.7]<br/>2020-07-06T18:53:08.948383Z info JWT policy is third-party-jwt<br/><strong class="ks iu">[2020-07-06T18:57:05.103Z] "- - -" 0 - "-" "-" 883 15444 138 - "-" "-" "-" "-" "74.125.195.106:443" PassthroughCluster 10.32.2.7:53332 74.125.195.106:443 10.32.2.7:53330 - -</strong></span></pre><p id="fbfc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请注意，最后一个日志条目从内部的<code class="fe kp kq kr ks b">10.x.x.x</code> IP地址命中<code class="fe kp kq kr ks b">74.125.195.106:443</code>，这表示从ProductPage pod内部到Google的cURL(使用端口443，又名HTTPS)。</p><h1 id="7172" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">摘要</h1><p id="7235" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">这就对了。我给了你五个命令，可以帮助你完成Istio冒险和调试过程。当您的Istio集群不可避免地遇到问题或者您试图向您的服务网格添加功能时，这些命令非常简单，但却是必不可少的。如果你喜欢我所做的，<strong class="js iu">请跟随我的媒介，</strong>如果你有任何问题或询问，请发电子邮件给我bryant.hagadorn@gmail.com。谢谢！</p></div></div>    
</body>
</html>