<html>
<head>
<title>The Definitive Guide for setting up a clean and working AWS EKS Kubernetes Infrastructure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">建立一个干净和工作的AWS EKS Kubernetes基础设施的权威指南</h1>
<blockquote>原文：<a href="https://itnext.io/the-definitive-guide-for-setting-up-a-clean-and-working-aws-eks-kubernetes-infrastructure-for-2d4153d47e20?source=collection_archive---------2-----------------------#2021-11-13">https://itnext.io/the-definitive-guide-for-setting-up-a-clean-and-working-aws-eks-kubernetes-infrastructure-for-2d4153d47e20?source=collection_archive---------2-----------------------#2021-11-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2b38" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">完整的模块化Terraform模板，带有深入的解释</h2></div><p id="8ece" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当外面天气变冷时，花时间构建一个干净的端到端Terraform模板来构建AWS云基础设施是多么好的时机啊，该模板带有一个公开可用的演示应用程序，运行在AWS EKS提供的Kubernetes集群上。</p><h1 id="820a" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">首先，我们想要建造什么？</h1><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div class="gh gi lt"><img src="../Images/3e29f116e82b8172dab17c9752e3e0d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*CJCiQ5csK23N4iigRa6PQg.png"/></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">目标基础设施</figcaption></figure><p id="790a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们希望建立一个完整的基础设施，其中一个演示应用程序(在本例中为<a class="ae mf" href="https://github.com/kubernetes/dashboard#kubernetes-dashboard" rel="noopener ugc nofollow" target="_blank"> Kubernetes dashboard </a>)正在EKS集群上运行，并且是公开可用的。</p><p id="5815" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为此，我们需要:</p><ul class=""><li id="7475" class="mg mh iq kh b ki kj kl km ko mi ks mj kw mk la ml mm mn mo bi translated"><strong class="kh ir">VPC</strong>跨越两个可用性区域，每个区域都有可用的公共和私有子网。</li><li id="0c20" class="mg mh iq kh b ki mp kl mq ko mr ks ms kw mt la ml mm mn mo bi translated">一个<strong class="kh ir">公共负载均衡器</strong>，它被提供来自用户的流量，并将该流量转发给EKS工作节点。</li><li id="1e93" class="mg mh iq kh b ki mp kl mq ko mr ks ms kw mt la ml mm mn mo bi translated">一个<strong class="kh ir"> DNS记录</strong>，它将一个子域解析为公共负载平衡器的DNS名称。</li><li id="8a49" class="mg mh iq kh b ki mp kl mq ko mr ks ms kw mt la ml mm mn mo bi translated">一个由EKS 提供的<strong class="kh ir"> Kubernetes集群，一个处理集群入口流量的<strong class="kh ir">入口控制器</strong>，以及一个安装Kubernetes仪表板工作负载的<strong class="kh ir">初始化</strong></strong></li></ul><p id="7bbd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们看看我们的存储库结构:</p><figure class="lu lv lw lx gt ly"><div class="bz fp l di"><div class="mu mv l"/></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">模板存储库结构</figcaption></figure><figure class="lu lv lw lx gt ly"><div class="bz fp l di"><div class="mu mv l"/></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">模板存储库结构描述</figcaption></figure><p id="c94c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">只有一个<code class="fe mw mx my mz b">tf</code> —通过调用设置VPC、DNS、负载平衡和EKS所需的所有子模块，包含整个基础设施的配置的文件。那就是<code class="fe mw mx my mz b">main.tf</code>。</p><h1 id="78bc" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated"><strong class="ak">网络——VPC</strong></h1><p id="b31e" class="pw-post-body-paragraph kf kg iq kh b ki na jr kk kl nb ju kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated">为了设置VPC，该模板基于公共Terraform注册中心的<a class="ae mf" href="https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latest" rel="noopener ugc nofollow" target="_blank">社区模块</a>。我们正在使用<code class="fe mw mx my mz b">main.tf</code>中的模块，比如:</p><figure class="lu lv lw lx gt ly"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="e841" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们希望驻留在私有子网中的Kubernetes工作负载能够与互联网进行通信(<code class="fe mw mx my mz b">enable_nat_gateway=true</code>)，但我们不需要为每个可用性区域提供NAT网关(<code class="fe mw mx my mz b">single_nat_gateway=true</code>)。此外，我们希望在我们的VPC内启用DNS主机名(<code class="fe mw mx my mz b">enable_dns_hostnames=true</code>、<code class="fe mw mx my mz b">enable_dns_support=true</code>)。</p><h1 id="1dce" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">域名服务器(Domain Name Server)</h1><p id="8f25" class="pw-post-body-paragraph kf kg iq kh b ki na jr kk kl nb ju kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated">为了达到在EKS工作节点上运行的工作负载，我们必须提供一个DNS记录，将公共托管区域的子域解析为公共负载平衡器的DNS名称。为了实现这一点，我们可以简单地调用<code class="fe mw mx my mz b">modules/terraform-aws-dns-aliasrecord</code>下的Terraform模块，它将为我们创建一个DNS别名记录:</p><figure class="lu lv lw lx gt ly"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="d8a7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">值得一提的是，在所使用的AWS帐户中必须已经有一个公共托管区域，它是在<code class="fe mw mx my mz b">dns_zone</code>变量中设置的。模块<code class="fe mw mx my mz b">dns_record</code>的输入变量是<code class="fe mw mx my mz b">list(object)</code>类型的，包含应该为哪个子域创建DNS记录(<code class="fe mw mx my mz b">subdomain</code>)以及DNS记录应该解析到哪里的信息，在我们的例子中是公共负载平衡器(<code class="fe mw mx my mz b">dns_name</code>，<code class="fe mw mx my mz b">zone_id</code>)。</p><h1 id="b89e" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">负载平衡</h1><figure class="lu lv lw lx gt ly"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="0868" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">负载平衡器的模块包含设置公共应用程序负载平衡器(ALB)和两个侦听器的所有资源，一个用于HTTP，一个用于HTTPS流量。HTTP侦听器将流量重定向到HTTPS侦听器，该侦听器终止SSL，并使用在子域(<code class="fe mw mx my mz b">certificate_arn</code>)的DNS模块中由AWS ACM生成的TLS证书。此外，我们声明负载均衡器应该连接到哪个VPC(<code class="fe mw mx my mz b">vpc_id</code>)，应该在哪个公共子网中可用(<code class="fe mw mx my mz b">public_subnets</code>)以及属于哪个项目(<code class="fe mw mx my mz b">project</code>)。</p><h1 id="cf7c" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">Kubernetes集群设置和初始化</h1><figure class="lu lv lw lx gt ly"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="1b02" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Kubernetes集群的供应被抽象为驻留在<code class="fe mw mx my mz b">modules/terraform-aws-eks</code>中的模块，该模块本身利用了<a class="ae mf" href="https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/latest" rel="noopener ugc nofollow" target="_blank"> EKS社区模块</a>。<strong class="kh ir">指定Kubernetes版本</strong>由输入变量<code class="fe mw mx my mz b">eks_version</code>完成，输入变量定义了EKS为您提供的控制平面版本，变量<code class="fe mw mx my mz b">ami_id</code>必须与Kubernetes版本匹配。您可以在amazon管理控制台的EC2/Compute下搜索带有匹配的预装Kubernetes版本的Amazon机器映像。AMI是特定于地区的，所以请确保选择适合您所在地区的AMI(模板使用<code class="fe mw mx my mz b">eu-west-1</code>)。</p><p id="aed3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了<strong class="kh ir">允许从公共ALB </strong>进入工作节点的流量，我们在输入变量<code class="fe mw mx my mz b">ingress_from_security_group_id</code>中传递LB模块的<code class="fe mw mx my mz b">security_group_id</code>。我们还必须<strong class="kh ir">向LB模块中创建的ALB </strong>的HTTPS监听器注册一个LB监听器规则。在这个模板中，这是EKS模块的责任，它需要<code class="fe mw mx my mz b">https_listener_arn</code>、<code class="fe mw mx my mz b">lb_listener_host_rule</code>来定义流量应该被转发的主机报头和规则优先级(<code class="fe mw mx my mz b">lb_listener_rule_priority</code>)。规则按优先级顺序进行评估，从最低值到最高值。</p><p id="5ca7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该模块为工作节点创建一个<strong class="kh ir">自动缩放组，该组使用一个<a class="ae mf" href="https://github.com/terraform-aws-modules/terraform-aws-eks/blob/master/docs/spot-instances.md#using-launch-templates-with-both-spot-and-on-demand" rel="noopener ugc nofollow" target="_blank">启动模板</a>，该模板同时具有按需实例和现场实例。自动缩放组的配置由输入变量完成:</strong></p><ul class=""><li id="62f7" class="mg mh iq kh b ki kj kl km ko mi ks mj kw mk la ml mm mn mo bi translated"><code class="fe mw mx my mz b">eks_general_workers_override_instance_types</code>:混合实例策略的覆盖实例类型列表</li><li id="8804" class="mg mh iq kh b ki mp kl mq ko mr ks ms kw mt la ml mm mn mo bi translated"><code class="fe mw mx my mz b">eks_general_workers_asg_min_size</code>:自动缩放组中的最小工人能力</li><li id="0916" class="mg mh iq kh b ki mp kl mq ko mr ks ms kw mt la ml mm mn mo bi translated"><code class="fe mw mx my mz b">eks_general_workers_asg_desired_capacity</code>:自动缩放组中期望的工人能力</li><li id="97fb" class="mg mh iq kh b ki mp kl mq ko mr ks ms kw mt la ml mm mn mo bi translated"><code class="fe mw mx my mz b">eks_general_workers_on_demand_base_capacity</code>:按需实例必须满足的所需能力的绝对最小量</li><li id="2bc6" class="mg mh iq kh b ki mp kl mq ko mr ks ms kw mt la ml mm mn mo bi translated"><code class="fe mw mx my mz b">eks_general_workers_on_demand_percentage_above_base_capacity</code>:按需实例和Spot实例之间超出基本按需容量的百分比分割(当ASG向外扩展时)</li><li id="0b6e" class="mg mh iq kh b ki mp kl mq ko mr ks ms kw mt la ml mm mn mo bi translated"><code class="fe mw mx my mz b">eks_general_workers_asg_max_size</code>:自动缩放组中的最大工作人员容量。</li><li id="3e42" class="mg mh iq kh b ki mp kl mq ko mr ks ms kw mt la ml mm mn mo bi translated"><code class="fe mw mx my mz b">eks_general_workers_spot_instance_pools</code>:每个可用性区域分配容量的点池数量。</li></ul><p id="c86a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过使用混合实例启动模板，很容易为<code class="fe mw mx my mz b">dev</code>或<code class="fe mw mx my mz b">test</code>环境建立仅由现场实例组成的<strong class="kh ir">工作节点。在内部，该模块使用<code class="fe mw mx my mz b">lowest-price</code>作为spot分配策略，因此当请求spot实例时，将提供<code class="fe mw mx my mz b">eks_general_workers_override_instance_types</code>中定义的spot池中最便宜的可用实例。</strong></p><p id="0dbb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，变量<code class="fe mw mx my mz b">install_nginx_ingress</code>和<code class="fe mw mx my mz b">install_kubernetes-dashboard</code>指示模块在EKS控制平面被提供并且工作节点已经加入集群并且启动和运行之后安装nginx-ingress控制器和kubernetes仪表板。</p><h1 id="b159" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">使用模板</h1><p id="25ef" class="pw-post-body-paragraph kf kg iq kh b ki na jr kk kl nb ju kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated">最后，我想指出完整的模板可以在<a class="ae mf" href="https://github.com/yandok/terraform-aws-eks-template" rel="noopener ugc nofollow" target="_blank"> Github </a>上获得。请随意为自己克隆它，并尝试它。</p><p id="7c71" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用<a class="ae mf" href="https://github.com/terraform-docs/terraform-docs" rel="noopener ugc nofollow" target="_blank"> Terraform Docs </a>生成Terraform模块的文档——各个模块目录中的<code class="fe mw mx my mz b">README.md</code>文件显示有关所用提供者、模块的信息以及所有输入变量和输出的描述。</p><p id="5a6d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要开始使用你的AWS帐户，你只需要在Route53服务中手动创建一个公共托管区域，并在<code class="fe mw mx my mz b">envs/dev.tfvars</code>中设置<code class="fe mw mx my mz b">dns_zone</code>-变量。其次，当然还要设置<code class="fe mw mx my mz b">aws_accountnumber</code> —变量。最后创建一个S3桶来存储地形状态，并在文件<code class="fe mw mx my mz b">backend.tf</code>中设置桶名。仅此而已。应用Terraform配置后，这可能需要20-25分钟(EKS创建非常慢)，您应该能够在<code class="fe mw mx my mz b">https://&lt;subdomain&gt;.&lt;dns_zone&gt;</code>到达Kubernetes仪表板</p><p id="20a6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">玩得开心——回头见。</p><div class="nf ng gp gr nh ni"><a href="https://github.com/yandok/terraform-aws-eks-template" rel="noopener  ugc nofollow" target="_blank"><div class="nj ab fo"><div class="nk ab nl cl cj nm"><h2 class="bd ir gy z fp nn fr fs no fu fw ip bi translated">GitHub-yandok/terraform-AWS-eks-模板</h2><div class="np l"><h3 class="bd b gy z fp nn fr fs no fu fw dk translated">这是一个演示库，用于引导一个简单的云基础设施，并提供一个公共的演示应用程序…</h3></div><div class="nq l"><p class="bd b dl z fp nn fr fs no fu fw dk translated">github.com</p></div></div><div class="nr l"><div class="ns l nt nu nv nr nw lz ni"/></div></div></a></div></div></div>    
</body>
</html>