# 使用 Loft v0.3 的 Kubernetes 虚拟集群

> 原文：<https://itnext.io/loft-v0-3-virtual-clusters-for-kubernetes-40b2c56918f?source=collection_archive---------2----------------------->

![](img/f1466b9394827f0a03baafc5d46bfb44.png)

我们自豪地宣布, [loft](https://loft.sh/) 是第一个为虚拟化 Kubernetes 集群提供稳定实施的云原生技术。借助 loft v0.3，用户现在可以在几秒钟内创建虚拟 Kubernetes 集群(vClusters)，只需点击 UI，使用 loft CLI 的一个命令，或者使用 vCluster CRD(参见最后一段中的示例)。

# loft 是什么？

[loft](https://loft.sh) 是 [DevSpace Cloud](https://devspace.cloud) 的重新命名和重新架构版本，它让管理员为他们的 Kubernetes 集群建立了一个名称空间的自助服务系统。在与各种公司合作并帮助他们将自助式 Kubernetes 名称空间引入他们的工程团队的过程中，我们了解了很多关于 IT 团队和工程团队之间的紧张关系。虽然系统管理员最关心的是系统的稳定性和安全性，但工程师们努力追求速度，并要求自由地做他们工作所需的任何事情，包括在安装 1000 多个需要这种集群范围访问的掌舵图中的任何一个时安装 CRD 和自定义 RBAC 规则。

loft 的 v0.3 现在用虚拟集群解决了这个问题。方法如下:

# 什么是虚拟集群？

您可以将虚拟 Kubernetes 集群想象为运行在另一个集群之上的全功能 Kubernetes 集群—包含在底层主机集群的单个名称空间中。一个虚拟 Kubernetes 集群可以像任何其他 Kubernetes 集群一样使用，使用 kubectl、helm 或任何客户端工具都可以访问这个虚拟集群的有效 kube-context。

虚拟集群大致由两部分组成:

*   控制平面(即 API 服务器、数据库，如 etcd 和控制器管理器)
*   实际启动和管理底层主机群集中的容器的同步程序

虽然虚拟集群使用底层主机集群来实际运行其 pod 的容器，但虚拟集群有自己的 API 服务器，用于创建和管理所有 Kubernetes 资源，如 pod、部署、服务、集群角色，甚至名称空间。

这意味着，当您在虚拟 Kubernetes 集群中创建部署时，该部署不会发送到底层主机集群，也不会存储在底层主机集群的 etcd 存储中。相反，资源将使用虚拟集群的独立 API 服务器创建，并存储在该虚拟集群的数据库(可能是 etcd，甚至是简单的 sqlite 或 mysql 数据库)中。为了实际运行此部署的容器，虚拟集群的 syncer 组件会联系底层主机集群，并在那里创建一个 pod，然后正确连接所有设备，以便联网等。会按预期工作。

与虚拟机类似，虚拟集群应致力于以下目标:

*   租户应被限制在其虚拟集群内，并且不能访问底层主机。
*   在同一台主机上运行时，租户不应该知道彼此的存在。
*   虚拟集群应该能够快速启动，并且易于销毁，不会在底层主机集群上留下任何痕迹。

如果您想了解 loft 中虚拟集群实现的更多信息，请查看虚拟集群的 [loft 文档。](https://loft.sh/docs/vclusters/basics)

# 为什么选择虚拟集群？

> ***TL；博士:*** *工程师需要能够安装和管理自己的 CRDs、RBAC 等。将用户限制在名称空间不允许他们这样做，但是虚拟集群可以解决这个问题。*

## 名称空间是不够的

还记得 90 年代吗？网络托管者在共享的 Linux 机器上提供网络空间，用户可以在那里运行他们的 PHP 应用程序，只要它与他们的托管者为同一台机器上的所有用户安装的任何 PHP 版本兼容。我们现在正在对 Kubernetes 做几乎同样的事情。我们正在给工程团队分发命名空间，希望他们不会抱怨 RBAC 或 CRD 缺少的任何东西。

名称空间是 Kubernetes 的网络空间——它们是隔离租户及其工作负载的核心构件，它们不足以满足当今高速工程的需求。如果团队可以访问 Kubernetes 名称空间，他们的访问通常会受到 RBAC 之类的限制。为此，多租户集群中的用户通常被限制在其名称空间内，并且不能修改任何集群范围的对象。这意味着对于名称空间，工程师:

*   无法安装 CRDs
*   无法使用集群范围的 CRD
*   无法修改 RBAC 规则
*   大多数时候甚至不能列出它们自己的名称空间

虽然所有这些事情对工程团队来说都很烦人，但是这个列表中的第一个问题尤其严重，因为 CRD 在 Kubernetes 生态系统中变得越来越重要。无论一个团队想要评估 Kubeflow，开始使用 knative，还是使用任何其他严重依赖 CRD 的项目，工程团队都需要能够安装 CRD。如果没有能力管理自己的 CRD 或建立自己的 RBAC 规则，工程师将无法在 Helm Hub 上安装 90%的舵图表——这是一个问题。如今，如果你想保持竞争力，你需要快速行动。那么，我们该如何解决这个问题呢？

## vClusters 比名称空间更强大

我们可以按照扎克伯格的建议，快速行动，打破常规。然而，我想我们都同意，在各种情况下，这种做法并不奏效。仅仅将管理员权限交给集群，开放我们严格的 RBAC 设置，以便工程师可以自己安装 CRD 和 RBAC 规则，这是一个灾难的处方。

在不损坏任何东西的情况下移动东西怎么样？这就是我们努力通过虚拟 Kubernetes 集群实现的目标。

就像虚拟服务器或现代云虚拟机允许我们在相同的物理服务器硬件上托管多个操作系统，同时忽略网络空间的所有问题一样，虚拟 Kubernetes 集群将允许我们在相同的 Kubernetes 集群上托管不同的工程团队甚至生产工作负载，而不必限制他们的能力。

# 如何入门？

如果您现在想亲自尝试 vClusters，以下是操作方法:

# 1.安装放样

按照 loft 文档中的说明[将 loft 安装到任何 Kubernetes 集群](https://loft.sh/docs/getting-started/setup)。

# 2.创建虚拟集群

**选项 A —通过 CLI**

```
loft create vcluster my-vcluster-1
```

**选项 B —通过用户界面**

使用 loft UI 创建虚拟集群

**选项 C——经由 CRD**

查看放样文档，了解更多关于虚拟集群使用[放样 CRDs 的信息](https://loft.sh/docs/vclusters/basics)。

# 下一步是什么？

现在，任何人都可以在几秒钟内创建虚拟 Kubernetes 集群，我们正在努力支持虚拟集群的一些高级用例，包括:

*   快照和恢复虚拟集群
*   不同 Kubernetes 集群之间的虚拟集群迁移(例如，从 GKE 迁移到 EKS)
*   跨不同主机集群的虚拟集群。

# 取得联系！

如果您对使用虚拟集群感兴趣，请下载 loft 并立即开始。如果您遇到任何问题或对虚拟集群有任何功能需求，请帮助我们制定路线图并联系我们。我们希望虚拟集群成为 Kubernetes 多租户的新标准，并计划支持尽可能多的用例。因此，请联系我们，让我们知道您计划如何使用虚拟集群:

*   在推特上关注[@ loft _ sh](https://twitter.com/loft_sh)
*   [loft GitHub 回购](https://github.com/loft-sh/loft)中的未决问题
*   通过 lg@devspace.cloud (Lukas)给我发邮件

*原载于 2020 年 8 月 11 日*[*https://loft . sh*](https://loft.sh/blog/loft-v0-3-virtual-kubernetes-clusters/)*。*