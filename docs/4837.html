<html>
<head>
<title>Migrating Data From CosmosDB to Azure Storage using Azure Data Factory</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure数据工厂将数据从CosmosDB迁移到Azure存储</h1>
<blockquote>原文：<a href="https://itnext.io/migrating-data-from-cosmosdb-to-azure-storage-using-azure-data-factory-b7158d716281?source=collection_archive---------1-----------------------#2020-10-03">https://itnext.io/migrating-data-from-cosmosdb-to-azure-storage-using-azure-data-factory-b7158d716281?source=collection_archive---------1-----------------------#2020-10-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/67abc57582eb1ab26d6e74596652d88d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*b4cideoOoVfWaw1m"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">迪米特里·阿尼金在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="74a8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最近，我有幸被指派将一个旧的CosmosDB核心(SQL)帐户迁移到Azure Storage。该帐户在项目早期就已经存在，它包含两个集合中的近100GB数据，每个集合都包含出于合规目的而必须保留的PID(个人身份数据)。不用说，我非常害怕接触这个。</p><p id="9ec6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这背后的背景故事是，几个月前我们改变了我们的应用程序，在一个单独的帐户中使用MongoDB API for CosmosDB。我们已经使用MongoDB存储其他数据，所以我们决定将所有这些记录合并到一个帐户中，并通过一个客户端访问它。以前保存在SQL帐户中。当我们知道如何做时，技术领导决定整合MongoDB帐户中的所有内容，并绑定SQL帐户。</p><p id="0f19" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我开始四处寻找数据迁移工具是否符合我们的目的，但我用的是Mac，而该工具只能在Windows上运行🤦‍♂.我考虑过将启动虚拟机作为一种临时措施并将其安装在那里，但我觉得如果虚拟机在迁移过程中的任何时候重启，这可能会给我们带来问题。</p><h1 id="ae01" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated"><strong class="ak">创建数据工厂</strong></h1><p id="db6e" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">坦白地说，我使用GUI进行所有这些操作，主要是因为这是一次性的导出，我不打算再这样做了。我通常会使用Terraform，然而，为一个只会使用一次的东西找出所有的资源和参数似乎有点大材小用。</p><p id="a00d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是建立数据工厂的过程:</p><ol class=""><li id="7b91" class="mh mi it ki b kj kk kn ko kr mj kv mk kz ml ld mm mn mo mp bi translated">在门户中，导航到数据工厂</li></ol><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mq"><img src="../Images/734143991c08a45a0ed4162b08e44e99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iS0nf7sdj7oqQQJa-Doffg.png"/></div></div></figure><p id="f0ae" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">2.单击添加，然后完成创建向导。将版本设置为<em class="mv"> V2 </em>，如果您现在不想执行此步骤，请勾选<em class="mv">稍后配置Git</em>框。完成后，单击Review + Create创建数据工厂。</p><p id="b4c3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">3.等待它完成创建。</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h1 id="7b64" class="le lf it bd lg lh nd lj lk ll ne ln lo lp nf lr ls lt ng lv lw lx nh lz ma mb bi translated">将数据从CosmosDB导出到Azure存储</h1><p id="41a2" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">首先打开您刚刚在Azure门户中创建的数据工厂。将它放在面前后，选择概览刀片上的作者和监视器，然后执行以下步骤:</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ni"><img src="../Images/c5b6576c79a8c773a9b051abde92dc65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MS1INr0mzZGhJ6Wxdj3Z1A.png"/></div></div></figure><p id="37b1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">1.将打开一个新的选项卡，这是数据工厂UI。在这里，选择<em class="mv">复制数据</em>。这将打开一个设置向导，我们将在其中添加CosmosDB帐户和存储帐户的连接详细信息。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nj"><img src="../Images/3a5a1a438be26eb35b2cd13468739830.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vxTW_XCMmxEV1D5fLK9_zA.png"/></div></div></figure><p id="e65c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">2.输入作业的名称，然后单击下一步。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nk"><img src="../Images/10a806b606f2477cff3ec8d6f731777b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZeRlfdsseXrVjvSOr04dOw.png"/></div></div></figure><p id="c3c6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">3.下一个屏幕应该是空白的。选择创建新连接以添加您的CosmosDB帐户。从“新链接服务”屏幕中选择要复制的帐户类型。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nl"><img src="../Images/122442613d1166f6b5a008bc2a9d9be8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1Lr0eFp-9g2SjCI3qxpXLw.png"/></div></div></figure><p id="2ce0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">4.在“新链接服务”窗口中输入您的CosmosDB帐户的字段，然后选择“测试连接”以确保一切正常工作。如果一切正常，选择Create。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nm"><img src="../Images/374fdc8bbc345092992b7c25ce9e8f0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lhA2sXEz56VW6bZOP3TI-A.png"/></div></div></figure><p id="5dcf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">5.在Dataset部分，选择您想要复制的表，<strong class="ki iu">,并确保勾选“按原样导出到JSON文件或Azure CosmosDB集合”框。</strong>然后再点击一次或两次下一步，完成信号源的配置。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nn"><img src="../Images/2d765e674963908f67fa62ca77649b35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NiLtpj9s9jRXJFITZ0nlDA.png"/></div></div></figure><p id="53f5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">6.要配置此作业的目标，请再次选择“创建新连接”，然后从服务列表中选择“Blob存储”。</p><p id="56f4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">7.添加目标存储帐户的详细信息，并再次选择测试连接，以确保这一切都正常工作。然后单击“下一步”完成存储帐户的连接。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi no"><img src="../Images/7cf8b8285af5e5ec69bc0e63ffd80e3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l9r2TwDyEtrCazJX5W-A2A.png"/></div></div></figure><p id="4d02" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">8.通过指定保存导出的JSON文档的文件夹路径，在您的存储帐户中配置数据集。请注意，此处的文件夹表示Azure存储帐户中的容器。我简单地创建了一个名为backup的容器，并在这里输入它作为文件夹路径。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi np"><img src="../Images/adc88b0eaae27b092fe82abd952abf48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3axaUvsIMh5FqJWnfqUJQg.png"/></div></div></figure><p id="fbbe" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">14.启用数据一致性验证，以确保您的所有数据都能安全通过。日志记录不是绝对必须的，但是考虑到这是生产数据，我希望记录所采取的每一个操作，尤其是如果有问题的话。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi np"><img src="../Images/adc88b0eaae27b092fe82abd952abf48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3axaUvsIMh5FqJWnfqUJQg.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">强烈建议进行数据一致性验证。我不确定为什么默认不开。</figcaption></figure><p id="a8c5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">就是这样！查看摘要并单击Next后，它将在运行管道之前对您已配置的所有内容进行快速验证。您将看到的最后一页是对您所做的一切的确认。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nq"><img src="../Images/c26089ded94f5c7a02434e7b7f7ad1d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EJZgFml8gceNi4-hfY9qaQ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">我们开始有进展了！</figcaption></figure><p id="2cfe" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正如我们所说的，您的拷贝作业已经在运行，您可以通过转到左侧的Monitor选项卡，选择该作业，然后选择<em class="mv">活动运行</em>部分下的详细信息(眼镜)图标来查看其进度。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nr"><img src="../Images/0cdc33705c6885ebbaa46e0bf5407f14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p5aaPapSpJVyM3UcYJAFOw.png"/></div></div></figure><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ns"><img src="../Images/2ebd639ab5adbebfbc00f8c8f0714d63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wTvl_-sjgsR5y-cRvqttpQ.png"/></div></div></figure><p id="0661" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，您已经开始将所有收藏从CosmosDB导出到Azure存储帐户！此作业完成后，导出的数据将位于您的存储帐户的容器中。每个集合都将被导出到自己唯一的JSON文件中。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nt"><img src="../Images/33467ec75ea93b9ec3ef4c9b314a479c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lcrcuAeLxnUFy8Vpa5eNuw.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">呼，终于来了！</figcaption></figure></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h1 id="a769" class="le lf it bd lg lh nd lj lk ll ne ln lo lp nf lr ls lt ng lv lw lx nh lz ma mb bi translated">使用Azure数据工厂将数据从Azure存储导入到CosmosDB</h1><p id="c7d4" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">这在很大程度上是相同的过程，但是我们需要创建一个新的管道走向另一个方向。我们将使用相同的复制数据向导进行设置:</p><ol class=""><li id="017d" class="mh mi it ki b kj kk kn ko kr mj kv mk kz ml ld mm mn mo mp bi translated">导航回主页，再次单击复制数据。</li><li id="0391" class="mh mi it ki b kj nu kn nv kr nw kv nx kz ny ld mm mn mo mp bi translated">对于源，选择我们已经为最后一个管道配置的Azure存储帐户。</li><li id="7e5b" class="mh mi it ki b kj nu kn nv kr nw kv nx kz ny ld mm mn mo mp bi translated">对于文件或文件夹路径，选择备份容器中的JSON文件，这是我们之前完成管道的结果。</li></ol><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nz"><img src="../Images/5b5b41bbd86f133356bccf6d0959a5de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3ktAx0S-Qx7da9tGRcgxeA.png"/></div></div></figure><p id="b524" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">4.在文件格式部分，确保<strong class="ki iu">勾选了导出到JSON文件或Azure CosmosDB集合的复选框。</strong></p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oa"><img src="../Images/131c33f5471c6b3e206b71444728c2ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hFxiwNz1Asg9HR2_VbT3zg.png"/></div></div></figure><p id="ffb5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">5.对于目的地，选择我们已经为最后一个管道配置的CosmosDB帐户。选择应该导入数据的正确表格(集合)。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ob"><img src="../Images/d083dd9457701d855751cf9356f3e46a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zOHcurZn4N4KVya_QESZAQ.png"/></div></div></figure><p id="e0c1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">6.查看摘要后，该管道将被部署并立即开始运行。恭喜你。您现在已经将数据从Azure存储中的一个文件恢复到了CosmosDB帐户中的一个集合中。</p><p id="4780" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意:你必须为你希望从Azure存储中恢复的每个集合设置另一个管道。我还没有找到一种能够通过GUI将多个文件自动导入到多个收藏中的方法。目前看来是一对一的映射。</p><p id="c320" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您有几十个收藏，那么这可能是一个缓慢而乏味的过程。好消息是，这个UI内置了原生Git和AzureDevops集成，因此您可以将您在门户中所做的一切导出到您可以访问的任何存储库的分支。然后，您可以编写其余设置的脚本，将其推送到您的分支，这些更改将反映在门户中。</p><p id="52d7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦我们运行了这些管道，我们应该看到数据已经被复制到我们新的CosmosDB帐户中。如果我们检查集合，我们会看到数据在那里！</p><p id="76f1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">仅此而已。现在，我们可以从CosmosDB中取出数据，以更低的价格离线存储在Azure Storage中，并删除不再使用的旧CosmosDB帐户。如果我们需要访问数据，我们只需创建一个新的CosmosDB帐户，并运行数据工厂管道将其导入。一旦我们完成了数据查询，我们可以再次删除帐户。</p></div></div>    
</body>
</html>