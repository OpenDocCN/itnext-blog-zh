<html>
<head>
<title>API Management and Service Mesh</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">API管理和服务网格</h1>
<blockquote>原文：<a href="https://itnext.io/api-management-and-service-mesh-e7f0e686090e?source=collection_archive---------0-----------------------#2018-09-14">https://itnext.io/api-management-and-service-mesh-e7f0e686090e?source=collection_archive---------0-----------------------#2018-09-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e665" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为什么服务网格不能替代API管理</p><p id="358f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为免责声明，我在Red Hat工作，更确切地说，在3scale团队(2年前收购)开发3scale API管理解决方案。最近，在与我们的客户交谈时，一个问题越来越多地出现了:</p><blockquote class="kl"><p id="0526" class="km kn iq bd ko kp kq kr ks kt ku kk dk translated">"如果我使用Istio，为什么我需要API管理？"</p></blockquote><p id="5878" class="pw-post-body-paragraph jn jo iq jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ij bi translated">要回答这个问题，首先我们要明白什么是什么，但如果你想要一个剧透:<em class="la"> 3scale API管理和Istio在一起很惊艳。</em></p><p id="c084" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将尝试描述这两个解决方案旨在解决什么问题，重点是3scale API管理和Istio服务网格(这是我比较了解的两个)。</p><h1 id="63ad" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">什么是API管理解决方案？</h1><p id="f0f1" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">如果我们看一看维基百科:</p><blockquote class="kl"><p id="644f" class="km kn iq bd ko kp kq kr ks kt ku kk dk translated">API管理是创建和发布web APIs、实施其使用策略、控制访问、培育订户社区、收集和分析使用统计数据以及报告性能的过程</p></blockquote><p id="b408" class="pw-post-body-paragraph jn jo iq jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ij bi translated">这是个很好的定义。<em class="la">作为一家已经创建了某种<strong class="jp ir">内部服务</strong>的</em>公司，我现在想<strong class="jp ir">通过<strong class="jp ir">向外部用户</strong>提供API来围绕它建立一项业务</strong>。当然，我希望<strong class="jp ir">通过提供几个<strong class="jp ir">具有不同<strong class="jp ir">使用限制、范围</strong>的订阅计划</strong>来将其货币化</strong>，并且能够<strong class="jp ir">自动向我的客户</strong>开具发票。</p><p id="c80c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，<strong class="jp ir">外部开发者应该很容易找到我的API</strong>,<strong class="jp ir">用他们的信用卡自助注册一个计划</strong>，所有这些对我的API代码应该是<strong class="jp ir">透明的</strong></p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi me"><img src="../Images/e1ba0f92c6000a522e152451c2f09c19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xJNzPtvS-ByBYtvrCGotJg.png"/></div></div></figure><p id="0bd7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们分析这些需求，我们可以将它们分为以下几类:</p><ul class=""><li id="e652" class="mq mr iq jp b jq jr ju jv jy ms kc mt kg mu kk mv mw mx my bi translated"><strong class="jp ir">访问控制和安全</strong>:控制谁可以访问我的API以及如何访问。</li><li id="307f" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><strong class="jp ir"> API合同&amp;费率限制</strong>:一个用户基于订阅可以做多少请求。</li><li id="eb84" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><strong class="jp ir">分析和报告</strong>:你的API做得怎么样？哪些方法用的最多？有错误吗？哪些是热门/趋势API？</li><li id="b0b7" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><strong class="jp ir">开发者门户，文档</strong>:让开发者找到你的API并注册订阅计划</li><li id="92ad" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><strong class="jp ir">开票</strong>:发送发票，向开发商收费。</li></ul><p id="08e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">API管理解决方案如何实施所有这些？多亏了一个叫做<strong class="jp ir"> </strong>的<strong class="jp ir">关键组件</strong><strong class="jp ir">API网关</strong>。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi ne"><img src="../Images/e03a8a49d4bb7b1aec1c7d7b3f086ffd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6XCNXvs9C2-5WIlnmdzEhQ.png"/></div></div></figure><p id="168d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个位于流量中间的组件，因此客户端的请求通过它，保护您的API端点，并与其他API管理组件进行通信，以允许用户访问或不访问您的API。</p><p id="792e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这通常是通过对用户请求进行身份验证和“速率限制”来实现的，想象一下这个场景:</p><ul class=""><li id="74e3" class="mq mr iq jp b jq jr ju jv jy ms kc mt kg mu kk mv mw mx my bi translated"><strong class="jp ir">用户A </strong>订购了<strong class="jp ir">“基本”</strong>计划</li><li id="0d40" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><strong class="jp ir">“基本”计划为几个API操作</strong> (HTTP方法+ HTTP路径)定义了一些限制，例如:“获取/产品”和“过帐/发货”</li><li id="cea4" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated">这些限制可以被定义，每秒，每分钟，每月…</li><li id="d150" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated">“获取/产品”被限制为每分钟最多10个请求。</li></ul><p id="6333" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，当用户A试图在一分钟内发出10个以上的请求时，这些额外的请求将受到429(太多请求)的速率限制，或者如果身份验证无效，用户将得到403(禁止)，身份验证可以作为OAuth的一部分、一些查询参数或标头提供。</p><p id="6ec9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">速率限制是API管理的关键部分。这就是API网关对最终用户实施业务规则的方式，但有必要了解，速率限制可能非常复杂，基于多个规则，也可能非常简单，如每个客户端IP。定义真正复杂的速率限制场景(业务规则)的能力使得API管理如此强大。</p><p id="9565" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以，让我大声说出来:</p><blockquote class="kl"><p id="2069" class="km kn iq bd ko kp kq kr ks kt ku kk dk translated">API管理不(仅仅)限制速率。</p></blockquote><h1 id="afb0" class="lb lc iq bd ld le lf lg lh li lj lk ll lm nf lo lp lq ng ls lt lu nh lw lx ly bi translated">什么是服务网格？</h1><p id="a4a7" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">以前，我们谈论API，我们不谈论服务、应用程序、端口、连接、重试…因为在API管理层，我们并不真正关心这些，但我们现在会关心。</p><p id="17d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你牛逼的API背后到底是什么？多个服务相互对话，相互作用，形成一个单一的大API，每个API都用不同的编程语言编写，由一个大组织内世界各地的不同团队维护和操作。这有印象吗？是啊！微服务！</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi ni"><img src="../Images/af4740862a0a2b2e9d23dced3aad33d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XhkVVkGHUxmfg6CcUSQEXw.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">微服务。或者是相连的点。</figcaption></figure><p id="d56e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，我们有了由多种服务组成的大型API，这听起来很不错，但是越来越多的团队正在为新功能和/或新需求推出新服务，在某个时间点，由于您的架构的运营复杂性不断增加而产生的疑问和问题将会出现:</p><ul class=""><li id="49a9" class="mq mr iq jp b jq jr ju jv jy ms kc mt kg mu kk mv mw mx my bi translated">如果服务间的任何<strong class="jp ir">内部请求失败</strong>会发生什么</li><li id="8735" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated">我的<strong class="jp ir">请求在哪里失败了</strong>？</li><li id="4718" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated">为什么这个<strong class="jp ir"> API端点这么慢</strong>？<strong class="jp ir">哪个服务有问题？</strong></li><li id="2d6d" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated">这项服务很容易出错……如果失败了，我们能重试这些电话吗??</li><li id="bad6" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated">有人每天都在同一时间敲打这个服务，我们应该增加一些<strong class="jp ir">速率限制</strong>来避免这种情况！</li><li id="16b6" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated">那个服务应该不能联系另一个服务</li></ul><p id="611e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这些问题是服务网格可以帮助解决的。并且属于这些类别类型:</p><ul class=""><li id="01c9" class="mq mr iq jp b jq jr ju jv jy ms kc mt kg mu kk mv mw mx my bi translated"><strong class="jp ir">弹性</strong>:超时、重试、断路器、故障处理、负载平衡</li><li id="97c8" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><strong class="jp ir">速率限制</strong>:基于多源的基础设施速率限制。</li><li id="4886" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><strong class="jp ir">流量路由</strong>:路径、主机、头、cookie库、源服务等路由能力</li><li id="cf61" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><strong class="jp ir">可观察性</strong>:度量、日志、分布式跟踪</li><li id="213c" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><strong class="jp ir">安全</strong> : mTLS，RBAC…</li></ul><p id="7775" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所有这些对应用程序来说都是透明的。</p><p id="c9f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们看看<strong class="jp ir"> Istio </strong>是如何工作的<strong class="jp ir"> : </strong></p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/c5370aca27d4417f00b42c9da92de34d.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/format:webp/1*5YjfczcjiAmtK6ENpve0BA.png"/></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">Istio组件图</figcaption></figure><p id="e463" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Istio使用“sidecar container”模式，通过在同一个<a class="ae no" href="https://docs.openshift.com/online/architecture/core_concepts/pods_and_services.html#pods" rel="noopener ugc nofollow" target="_blank"> POD </a>中运行第二个容器来扩展“主”容器的功能。“主”容器是我们的应用程序，sidecar容器是Istio代理，这是基于“特使”的。</p><p id="32a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦注入，所有进出主容器的流量都将被代理“劫持”(使用Iptables魔术),正如您在前面的图表中看到的。</p><p id="a966" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这允许Istio控制流量，并向控制平面报告正在发生的情况。更具体地说是<em class="la">混合器</em>，遥测和策略引擎。</p><h1 id="1b08" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">他们有什么共同点？</h1><p id="8d51" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">我们已经定义了这两种技术，您看到了什么共同点？他们试图解决不同的问题，但使用一些类似的技术…</p><p id="7118" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这两种解决方案有一个共同点:</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi np"><img src="../Images/63ae148f81947989764bff9941d779f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rlO1vjY7I4UuwCKw-o866A.png"/></div></div></figure><p id="fe5c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是重要的是要记住，速率限制是用来执行不同的事情的:商业规则T21或基础设施限制。</p><p id="56ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，它们并不相互排斥，我们应该将它们视为基础架构中的不同层:</p><ol class=""><li id="b629" class="mq mr iq jp b jq jr ju jv jy ms kc mt kg mu kk nq mw mx my bi translated"><strong class="jp ir"> API管理:</strong>根据开发者、订阅计划、应用程序、发票等处理对您的API的访问</li><li id="aa1e" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk nq mw mx my bi translated"><strong class="jp ir">服务网格</strong>:让你的API服务安全、易于监控、灵活。</li></ol><h1 id="f2c2" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">我们如何结合3scale API管理和Istio服务网格？</h1><p id="f42d" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">请继续关注一系列关于<strong class="jp ir"> 3scale如何通过使用我们的<a class="ae no" href="https://github.com/3scale/apicast" rel="noopener ugc nofollow" target="_blank"> API网关APIcast </a>或<strong class="jp ir">使用<a class="ae no" href="https://github.com/3scale/istio-integration/tree/master/3scaleAdapter" rel="noopener ugc nofollow" target="_blank"> 3scale Istio适配器</a>对Istio进行本机</strong>扩展来为Istio服务网格</strong>添加完整的API管理功能的技术文章。</p></div></div>    
</body>
</html>