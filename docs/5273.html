<html>
<head>
<title>How to easily create an HTTP 301 redirection with AWS API Gateway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用AWS API网关轻松创建HTTP 301重定向</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-easily-create-a-http-301-redirection-with-aws-api-gateway-2bf2874ef3f2?source=collection_archive---------1-----------------------#2021-01-30">https://itnext.io/how-to-easily-create-a-http-301-redirection-with-aws-api-gateway-2bf2874ef3f2?source=collection_archive---------1-----------------------#2021-01-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/e186ab02a899315b88d4e473f4acf590.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GWOpmMX71PUnGgd0165fFQ.png"/></div></div></figure><p id="c121" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">几周前，我重新编写了一个lambda函数来服务一个swagger UI。这里有代码<a class="ae kw" href="https://github.com/sylwit/aws-serverless-swagger-ui" rel="noopener ugc nofollow" target="_blank">https://github.com/sylwit/aws-serverless-swagger-ui</a>。</p><h1 id="baac" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">用例</h1><p id="f48e" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">用例非常明确，你需要重定向的每个请求。</p><p id="a56d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我需要这样做是因为网关限制，即{proxy+}资源的根不能包含在{proxy+}本身中</p><p id="365f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我的意思是如果你有下面的结构</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ma"><img src="../Images/27e913d1753efc16c6514804f87885b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:406/format:webp/1*D3ZcGYPA8C5Oq5YdcVD7XA.png"/></div></div></figure><p id="151f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">/docs不会包含在代理所针对的lambda中。我的建议是直接创建一个301 from /docs to /docs/index.html。</p><p id="d307" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">同样，昨天在脸书的AWS小组，有人问如何创建从URL到另一个微服务的重定向。有些人谈论使用DNS没有帮助，有些人说创建另一个lambda来返回301，这是可行的，但我们确实有一个更简单、更有效的方法来实现这一点。</p><h1 id="eaee" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">API网关和模拟集成</h1><p id="94d3" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">解决方案非常简单。Api Gateway支持不同的集成类型:AWS、AWS_PROXY、HTTP、HTTP_PROXY和MOCK。如果你想了解更多细节，这里有官方文档<a class="ae kw" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-api-integration-types.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/API gateway/latest/developer guide/API-gateway-API-integration-types . html</a></p><p id="c046" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">模拟集成是这个用例的完美匹配，因为它避免了我们必须编写一些代码，因为这只是一个配置问题。</p><p id="487d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面是terraform代码，我们来分解一下。我假设您已经有了API(AWS _ API _ gateway _ rest _ API . API . id)和lambda(AWS _ lambda _ function . swagger _ lambda)</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="cf68" class="mk ky iq mg b gy ml mm l mn mo"># create the resource /docs at the root of our api<br/>resource "aws_api_gateway_resource" "api_docs" {<br/>  rest_api_id = aws_api_gateway_rest_api.api.id<br/>  parent_id   = aws_api_gateway_rest_api.api.root_resource_id<br/>  path_part   = "docs"<br/>}</span><span id="7a0c" class="mk ky iq mg b gy mp mm l mn mo"># create the method GET and assign it to the resource /docs<br/>resource "aws_api_gateway_method" "api_docs" {<br/>  rest_api_id   = aws_api_gateway_rest_api.api.id<br/>  resource_id   = aws_api_gateway_resource.api_docs.id<br/>  http_method   = "GET"<br/>  authorization = "NONE"<br/>}</span><span id="1f31" class="mk ky iq mg b gy mp mm l mn mo"># create the mock integration which will returns the statusCode 301 on the previous method GET of the /docs<br/>resource "aws_api_gateway_integration" "api_docs" {<br/>  rest_api_id = aws_api_gateway_rest_api.api.id<br/>  resource_id = aws_api_gateway_resource.api_docs.id<br/>  http_method = aws_api_gateway_method.api_docs.http_method<br/>  type        = "MOCK"<br/>  request_templates = {<br/>    "application/json" : "{ \"statusCode\": 301 }"<br/>  }<br/>}</span><span id="1dd0" class="mk ky iq mg b gy mp mm l mn mo"># create the method response and enable the header Location<br/>resource "aws_api_gateway_method_response" "api_docs_301" {<br/>  rest_api_id = aws_api_gateway_rest_api.api.id<br/>  resource_id = aws_api_gateway_resource.api_docs.id<br/>  http_method = aws_api_gateway_method.api_docs.http_method<br/>  status_code = "301"<br/>  response_parameters = {<br/>    "method.response.header.Location" : true<br/>  }<br/>}</span><span id="735d" class="mk ky iq mg b gy mp mm l mn mo"># Fill the previous header with the destination. Notice the syntax of the location with single quotes wrapped by doubles.<br/>resource "aws_api_gateway_integration_response" "api_docs" {<br/>  rest_api_id = aws_api_gateway_rest_api.api.id<br/>  resource_id = aws_api_gateway_resource.api_docs.id<br/>  http_method = aws_api_gateway_method.api_docs.http_method<br/>  status_code = aws_api_gateway_method_response.api_docs_301.status_code<br/>  response_parameters = {<br/>    "method.response.header.Location" : "'/docs/index.html'"<br/>  }<br/>}</span><span id="2a6f" class="mk ky iq mg b gy mp mm l mn mo"># create the wildecard sub resource of docs. ie /docs/*<br/>resource "aws_api_gateway_resource" "api_docs_proxy" {<br/>  rest_api_id = aws_api_gateway_rest_api.api.id<br/>  parent_id   = aws_api_gateway_resource.api_docs.id<br/>  path_part   = "{proxy+}"<br/>}</span><span id="95f6" class="mk ky iq mg b gy mp mm l mn mo"># configure the method you need<br/>resource "aws_api_gateway_method" "api_docs_proxy" {<br/>  rest_api_id   = aws_api_gateway_rest_api.api.id<br/>  resource_id   = aws_api_gateway_resource.api_docs_proxy.id<br/>  http_method   = "ANY"<br/>  authorization = "NONE"<br/>}</span><span id="2f47" class="mk ky iq mg b gy mp mm l mn mo"># integrate your lambda to this resource<br/>resource "aws_api_gateway_integration" "api_docs_proxy" {<br/>  rest_api_id             = aws_api_gateway_rest_api.api.id<br/>  resource_id             = aws_api_gateway_resource.api_docs_proxy.id<br/>  http_method             = aws_api_gateway_method.api_docs_proxy.http_method<br/>  integration_http_method = "POST"<br/>  type                    = "AWS_PROXY"<br/>  uri                     = aws_lambda_function.swagger_lambda.invoke_arn<br/>}</span></pre><p id="8e56" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">瞧，只需几行配置就可以设置HTTP重定向。</p></div></div>    
</body>
</html>