<html>
<head>
<title>How to use Codefresh CI parallel jobs to run RSpec a few times faster for RoR project</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Codefresh CI并行作业将RoR项目的RSpec运行速度提高几倍</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-use-codefresh-ci-parallel-jobs-to-run-rspec-a-few-times-faster-for-ror-project-de4caeb8a83e?source=collection_archive---------2-----------------------#2019-10-18">https://itnext.io/how-to-use-codefresh-ci-parallel-jobs-to-run-rspec-a-few-times-faster-for-ror-project-de4caeb8a83e?source=collection_archive---------2-----------------------#2019-10-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d9b1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你是一个Ruby开发者，Codefresh.io似乎是一个非常好的CI解决方案。我已经在Codefresh上测试了我的一个项目，看看它如何允许运行快速测试。Codefresh有一个矩阵特性，允许您为CI构建运行并行步骤。在本文中，您将看到如何利用Codefresh matrix配置和backpack Pro客户端库，通过RSpec测试套件并行测试您的Ruby on Rails项目。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/8e8bdcab365bb5e982751c1dd80a71a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wl0r3kDmBPLhiEwe.png"/></div></div></figure><h1 id="cb54" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">在Codefresh.io上配置Rails项目</h1><p id="c454" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">为了在Codefresh上运行针对Rails项目的CI构建，您需要YAML配置文件和Docker映像，它们将用作运行测试的基本Docker容器。</p><p id="adaa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还需要CI服务器上的DB。在我的Ruby on Rails项目中，我使用PostgreSQL，所以我必须配置Codefresh服务来运行Postgres。</p><p id="cead" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们从创建需要添加到存储库中的<code class="fe ma mb mc md b">.codefresh/codefresh.yml</code>文件和<code class="fe ma mb mc md b">Test.Dockerfile</code>开始。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="1342" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如你所见，我使用<a class="ae mg" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=how-to-use-codefresh-ci-parallel-steps-to-run-rspec-a-few-times-faster-for-rails-project" rel="noopener ugc nofollow" target="_blank">backpack _ pro ruby gem</a>作为运行我的RSpec测试的命令。它将知道基于<code class="fe ma mb mc md b">KNAPSACK_PRO_CI_NODE_INDEX</code>值，在一个特定的并行步骤上应该执行哪组测试。基于为矩阵定义的<code class="fe ma mb mc md b">KNAPSACK_PRO_CI_NODE_INDEX</code>变量列表生成节点索引。</p><p id="e29d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">backpack Pro将自动在并行任务(步骤)之间分割测试，以确保每个步骤花费相似的时间。这是可能的，感谢背包专业队列模式，它可以跨并行步骤进行动态测试套件分割。您可以从本文末尾的视频中了解更多关于队列模式如何工作的技术细节，但现在让我们来看看Codefresh是如何工作的。您可以在下面的视频中看到我在Codefresh web dashboard中的CI构建。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mh mf l"/></div></figure><p id="fc11" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你忘记了视频中的步骤，那么我列出了你需要在Codefresh仪表板和YAML配置文件中设置的东西。</p><ul class=""><li id="a3b3" class="mi mj iq jp b jq jr ju jv jy mk kc ml kg mm kk mn mo mp mq bi translated">您需要在Codefresh dashboard中设置一个类似<code class="fe ma mb mc md b">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC</code>的API令牌，请参见左侧菜单管道- &gt;设置(管道旁边的cog图标)- &gt;变量选项卡(参见右侧的垂直菜单)。根据您使用的测试运行程序添加新的API令牌:</li><li id="bbf6" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated"><code class="fe ma mb mc md b">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC</code></li><li id="d315" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated"><code class="fe ma mb mc md b">KNAPSACK_PRO_TEST_SUITE_TOKEN_CUCUMBER</code></li><li id="c0c9" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated"><code class="fe ma mb mc md b">KNAPSACK_PRO_TEST_SUITE_TOKEN_MINITEST</code></li><li id="f642" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated"><code class="fe ma mb mc md b">KNAPSACK_PRO_TEST_SUITE_TEST_UNIT</code></li><li id="b224" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated"><code class="fe ma mb mc md b">KNAPSACK_PRO_TEST_SUITE_TOKEN_SPINACH</code></li><li id="1a27" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated">设置在哪里可以找到Codefresh YAML文件。在Codefresh dashboard中，请参见左侧菜单管道-&gt;设置(管道旁边的cog图标)-&gt;工作流选项卡(顶部的水平菜单)-&gt; YAML路径(在此设置<code class="fe ma mb mc md b">./.codefresh/codefresh.yml</code>)。</li><li id="c5f3" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated">使用<code class="fe ma mb mc md b">.codefresh/codefresh.yml</code>文件中的<code class="fe ma mb mc md b">KNAPSACK_PRO_CI_NODE_TOTAL</code>环境变量设置您想要运行多少个并行作业(并行CI节点)。</li><li id="2428" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated">确保在矩阵部分列出了值从<code class="fe ma mb mc md b">0</code>到<code class="fe ma mb mc md b">KNAPSACK_PRO_CI_NODE_TOTAL-1</code>的所有<code class="fe ma mb mc md b">KNAPSACK_PRO_CI_NODE_INDEX</code>环境变量。Codefresh将生成一个并行作业矩阵，其中每个作业都有不同的<code class="fe ma mb mc md b">KNAPSACK_PRO_CI_NODE_INDEX</code>值。多亏了这一点，backpackage Pro知道应该对每个并行任务运行什么样的测试。</li></ul><h1 id="2f9d" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">队列模式如何工作</h1><p id="d4a3" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">在这个视频中，我解释了动态测试套件分割的技术细节，以及它解决了什么问题来帮助您在最佳时间内运行快速CI构建。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mw mf l"/></div></figure><p id="6108" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Ruby中有更多的测试运行程序，如Cucumber、Minitest等，这些都是由<a class="ae mg" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=how-to-use-codefresh-ci-parallel-steps-to-run-rspec-a-few-times-faster-for-rails-project" rel="noopener ugc nofollow" target="_blank">背包Pro </a>支持的。甚至像Cypress.io或Jest这样的JavaScript工具也可以用backpack Pro wrapper启动(<a class="ae mg" href="https://docs.knapsackpro.com/integration/" rel="noopener ugc nofollow" target="_blank">参见安装指南</a>)。</p><p id="3fd3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望本教程对您有用，并且由于在Codefresh.io上运行并行步骤，您可以从Rails项目的更快CI构建中受益</p></div><div class="ab cl mx my hu mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="ij ik il im in"><p id="5935" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ne">原载于2019年10月18日</em><a class="ae mg" href="https://docs.knapsackpro.com/2019/how-to-use-codefresh-ci-parallel-steps-to-run-rspec-a-few-times-faster-for-rails-project" rel="noopener ugc nofollow" target="_blank"><em class="ne">https://docs.knapsackpro.com</em></a><em class="ne">。</em></p></div></div>    
</body>
</html>