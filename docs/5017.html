<html>
<head>
<title>Using Istio with Nginx ingress</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Istio和Nginx入口</h1>
<blockquote>原文：<a href="https://itnext.io/using-istio-with-nginx-ingress-ccb8e28d9aff?source=collection_archive---------1-----------------------#2020-11-17">https://itnext.io/using-istio-with-nginx-ingress-ccb8e28d9aff?source=collection_archive---------1-----------------------#2020-11-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="eeaf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在giffgaff，我们从一开始就使用<a class="ae ko" href="https://github.com/kubernetes/ingress-nginx" rel="noopener ugc nofollow" target="_blank"> NGINX </a>作为Kubernetes集群的入口控制器。NGINX是最受欢迎的Kubernetes入口提供商，已经证明是一个可靠的解决方案。</p><p id="ee95" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在过去一年左右的时间里，我们一直在向一些工作负载推出<a class="ae ko" href="https://istio.io/" rel="noopener ugc nofollow" target="_blank"> Istio </a>。Istio是一个非常复杂的软件，功能非常强大。如你所知，<strong class="js iu">“权力越大，责任越大”。从第一天开始就可以获得很多开箱即用的好处，包括遥测、跟踪和详细的访问日志。但是，如果您对Istio如何管理进出网格的流量没有深刻的理解，也很容易把事情搞砸。配置也要复杂得多，NGINX中的一个简单注释在Istio中变成了两个或三个(可配置性更强的)<a class="ae ko" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" rel="noopener ugc nofollow" target="_blank"> CRs </a>。</strong></p><p id="2d8b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Istio对大多数公司来说可能太复杂，无法一次推出所有功能。因此，我们决定分阶段推出Istio。我们继续使用当前的入口控制器，而不是基于Istio的入口控制器，Istio入口网关。由于Kubernetes允许同时部署多个入口控制器，我们可以稍后将它们迁移到Istio Gateway中，而不会遇到大问题。</p><p id="46b4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">虽然这是一种保守的方法，但它需要一些更改才能使NGINX和Istio之间的集成行为正确。</p><h1 id="941f" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">部署期间503秒</h1><p id="e546" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">在应用程序和NGINX入口容器中注入Istio后，我们注意到一些问题:</p><ul class=""><li id="9ed2" class="ls lt it js b jt ju jx jy kb lu kf lv kj lw kn lx ly lz ma bi translated">在部署期间，从NGINX到应用程序的请求导致了503个错误。在被正确路由到新的pod之前，流量被路由到被短时间终止的pod。</li><li id="330d" class="ls lt it js b jt mb jx mc kb md kf me kj mf kn lx ly lz ma bi translated">Istio telemetry将来自Nginx的请求报告为<a class="ae ko" href="https://istio.io/latest/blog/2019/monitoring-external-service-traffic/#what-are-blackhole-and-passthrough-clusters" rel="noopener ugc nofollow" target="_blank"> PassThroughCluster </a>，而不是应用服务(下图中的三角形)。</li></ul><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi mg"><img src="../Images/d627014c08e7fac1bad89049d910c7cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bYck6btuvxn6xJujPev9Gw.png"/></div></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">直通集群</figcaption></figure><blockquote class="mw mx my"><p id="83f6" class="jq jr mz js b jt ju jv jw jx jy jz ka na kc kd ke nb kg kh ki nc kk kl km kn im bi translated"><em class="it">如果使用Istio Ingress网关而不是NGINX，这些问题都不存在。</em></p></blockquote><h1 id="bf99" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">到底发生了什么</h1><p id="a627" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">了解NGINX ingress如何工作的一些概念很重要。NGINX入口控制器不使用服务将流量路由到pod。相反，它使用NGINX上游配置中所有端点(Pod IP/端口)的列表，以绕过kube-proxy，从而允许NGINX功能，如会话相似性和自定义负载平衡算法。</p><p id="18ef" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您应该配置NGINX ingress路由到单个上游服务，而不是将出站流量路由到NGINX上游配置中的端点列表，以便出站流量被istio sidecar拦截。</p><p id="2724" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe nd ne nf ng b">nginx.ingress.kubernetes.io/service-upstream</code>注释禁用了这种行为，取而代之的是使用NGINX中的单个上游，即服务的集群IP和端口。</p><blockquote class="mw mx my"><p id="21a1" class="jq jr mz js b jt ju jv jw jx jy jz ka na kc kd ke nb kg kh ki nc kk kl km kn im bi translated"><em class="it">即使您不使用Istio并且您正在寻找零停机部署，您也可能想要添加这个注释，如</em> <a class="ae ko" href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/annotations.md#service-upstream" rel="noopener ugc nofollow" target="_blank"> <em class="it">文档</em> </a> <em class="it">中所述。请记住，像会话相似性和自定义负载平衡这样的功能是不起作用的。</em></p></blockquote><p id="9e24" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe nd ne nf ng b">nginx.ingress.kubernetes.io/upstream-vhost</code>注释允许您在下面的语句中控制host的值:<code class="fe nd ne nf ng b">proxy_set_header Host $host</code>，它构成了位置块的一部分。</p><p id="2831" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了使Istio正常工作，需要将以下注释添加到每个入口资源中，以便:</p><ul class=""><li id="3847" class="ls lt it js b jt ju jx jy kb lu kf lv kj lw kn lx ly lz ma bi translated">出站流量被Istio边车拦截</li><li id="6c1d" class="ls lt it js b jt mb jx mc kb md kf me kj mf kn lx ly lz ma bi translated">流量被发送到正确的服务入口。</li></ul><pre class="mh mi mj mk gt nh ng ni nj aw nk bi"><span id="6c87" class="nl kq it ng b gy nm nn l no np">nginx.ingress.kubernetes.io/service-upstream: "true" nginx.ingress.kubernetes.io/upstream-vhost: &lt;service-name&gt;.&lt;namespace&gt;.svc.cluster.local</span></pre><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi nq"><img src="../Images/3486392fda400991a856cee696ad9208.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dU3ku-NXqqEg5blHBiSBFA.png"/></div></div></figure><h1 id="8d63" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">不包括入站流量</h1><p id="14e5" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">在这一点上，那些503应该消失了。入站流量在到达NGINX pods之前仍然通过Istio路由。如果我们希望阻止入站流量通过边车，(我们希望入口代理来处理它)，用以下内容注释NGINX部署:</p><pre class="mh mi mj mk gt nh ng ni nj aw nk bi"><span id="3b9c" class="nl kq it ng b gy nm nn l no np">traffic.sidecar.istio.io/excludeInboundPorts: 80,443 traffic.sidecar.istio.io/includeInboundPorts: ""</span></pre><p id="4c6c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe nd ne nf ng b">traffic.sidecar.istio.io/excludeInboundPorts:</code>要从重定向到特使中排除的以逗号分隔的入站端口列表。</p><p id="949f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe nd ne nf ng b">traffic.sidecar.istio.io/includeInboundPorts:</code>以逗号分隔的入站端口列表，流量将被重定向到特使。通配符“*”可用于配置所有端口的重定向。空列表将禁用所有入站重定向。</p><p id="2632" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以在<a class="ae ko" href="https://istio.io/latest/docs/reference/config/annotations/" rel="noopener ugc nofollow" target="_blank">官方文档</a>中找到Istio资源注释的完整列表。</p><h1 id="03da" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">结论</h1><p id="1b97" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">如本文开头所述，Istio是复杂的。我们建议逐步采用，这样您可以先熟悉它，然后才能充分利用它的潜力。</p><figure class="mh mi mj mk gt ml gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi nr"><img src="../Images/a4e32d2c6d5f64606ff891ce4ff59a39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XR33yBY6VKFAMPmirINEZA.png"/></div></div></figure></div><div class="ab cl ns nt hx nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="im in io ip iq"><p id="83c8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">本文假设你熟悉作为<a class="ae ko" href="https://github.com/kubernetes/ingress-nginx" rel="noopener ugc nofollow" target="_blank">入口控制器</a>的<a class="ae ko" href="https://istio.io/latest/" rel="noopener ugc nofollow" target="_blank"> Istio </a>和<a class="ae ko" href="https://github.com/kubernetes/ingress-nginx" rel="noopener ugc nofollow" target="_blank"> NGINX入口</a>。</p><p id="0961" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这种配置已经过测试:</p><ul class=""><li id="5b57" class="ls lt it js b jt ju jx jy kb lu kf lv kj lw kn lx ly lz ma bi translated">Istio 1.7.4</li><li id="2216" class="ls lt it js b jt mb jx mc kb md kf me kj mf kn lx ly lz ma bi translated">Kubernetes 1.16</li></ul></div><div class="ab cl ns nt hx nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="im in io ip iq"><p id="3479" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mz">原发布于</em><a class="ae ko" href="https://www.giffgaff.io/tech/using-istio-with-nginx-ingress/" rel="noopener ugc nofollow" target="_blank"><em class="mz">https://www . giffgaff . io</em></a><em class="mz">。</em></p></div></div>    
</body>
</html>