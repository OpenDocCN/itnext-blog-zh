<html>
<head>
<title>How to speed up Node.js modules installation in CI/CD pipeline as of 2020</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">截至2020年，如何加快CI/CD管道中Node.js模块的安装</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-speed-up-node-js-modules-installation-in-ci-cd-pipeline-as-of-2020-4865d77c0eb7?source=collection_archive---------1-----------------------#2020-03-28">https://itnext.io/how-to-speed-up-node-js-modules-installation-in-ci-cd-pipeline-as-of-2020-4865d77c0eb7?source=collection_archive---------1-----------------------#2020-03-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/4655f0568acad2a62f0769974b2fd113.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*8mzJX32oMaHZM2Av-YIyQQ.png"/></div></figure><blockquote class="jx jy jz"><p id="22e3" class="ka kb kc kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">2020/3/28更新:添加<code class="fe kz la lb lc b">pnpm</code></p></blockquote><p id="7366" class="pw-post-body-paragraph ka kb it kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">当您在项目中使用Node.js时，您需要注意CI/CD管道中的node_modules安装。你可以使用<code class="fe kz la lb lc b">npm install</code>、<code class="fe kz la lb lc b">npm ci</code>、<code class="fe kz la lb lc b">yarn install</code>和<code class="fe kz la lb lc b">pnpm install</code>，但是最快的方法是什么仍然是我们正在寻找答案的问题。在这个故事中，我想尝试所有我知道的可能性来找出最终的答案。</p><h1 id="d77e" class="lg lh it bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="3f75" class="pw-post-body-paragraph ka kb it kd b ke me kg kh ki mf kk kl ld mg ko kp le mh ks kt lf mi kw kx ky im bi translated">如果你很着急，你必须做的是:</p><ol class=""><li id="0e63" class="mj mk it kd b ke kf ki kj ld ml le mm lf mn ky mo mp mq mr bi translated">禁用标准输出输出</li><li id="7f03" class="mj mk it kd b ke ms ki mt ld mu le mv lf mw ky mo mp mq mr bi translated">使用缓存的节点模块</li><li id="9749" class="mj mk it kd b ke ms ki mt ld mu le mv lf mw ky mo mp mq mr bi translated">使用<code class="fe kz la lb lc b">--prefer-offline</code></li><li id="c492" class="mj mk it kd b ke ms ki mt ld mu le mv lf mw ky mo mp mq mr bi translated">使用全局缓存(仅适用于<code class="fe kz la lb lc b">yarn</code></li></ol><pre class="mx my mz na gt nb lc nc nd aw ne bi"><span id="4db9" class="nf lh it lc b gy ng nh l ni nj">$ tar zxvf node_modules.tar.gz<br/>$ npm install --prefer-offline &amp;&gt; /dev/null</span></pre><p id="d5eb" class="pw-post-body-paragraph ka kb it kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">如果你喜欢<code class="fe kz la lb lc b">yarn</code></p><pre class="mx my mz na gt nb lc nc nd aw ne bi"><span id="7bd7" class="nf lh it lc b gy ng nh l ni nj">$ tar zxvf node_modules.tar.gz<br/>$ tar zxvf cache.tar.gz<br/>$ yarn install --prefer-offline --cache-folder ./cache &amp;&gt; /dev/null</span></pre><p id="929f" class="pw-post-body-paragraph ka kb it kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">如果你喜欢<code class="fe kz la lb lc b">pnpm</code></p><pre class="mx my mz na gt nb lc nc nd aw ne bi"><span id="2f64" class="nf lh it lc b gy ng nh l ni nj">$ tar zxvf cache.tar.gz<br/>$ pnpm config set store-dir $PWD/cache<br/>$ pnpm install &amp;&gt; /dev/null</span></pre><blockquote class="jx jy jz"><p id="957c" class="ka kb kc kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">与纯粹的<code class="fe kz la lb lc b">npm install</code>相比，总速度提高了约3倍</p></blockquote><h1 id="2fea" class="lg lh it bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">现有工程</h1><p id="7a5d" class="pw-post-body-paragraph ka kb it kd b ke me kg kh ki mf kk kl ld mg ko kp le mh ks kt lf mi kw kx ky im bi translated">这是正常的，有人已经这样做了，这里有一些现有的作品供您参考。</p><ul class=""><li id="d7e0" class="mj mk it kd b ke kf ki kj ld ml le mm lf mn ky nk mp mq mr bi translated"><a class="ae nl" href="https://github.com/appleboy/npm-vs-yarn" rel="noopener ugc nofollow" target="_blank">https://github.com/appleboy/npm-vs-yarn</a></li><li id="b386" class="mj mk it kd b ke ms ki mt ld mu le mv lf mw ky nk mp mq mr bi translated"><a class="ae nl" href="https://winsmarts.com/npm-install-speed-up-by-3-times-almost-25ad416cf77e" rel="noopener ugc nofollow" target="_blank">https://winsmarts . com/NPM-install-speed-up-by-3-times-almost-25ad 416 cf 77 e</a></li><li id="fe99" class="mj mk it kd b ke ms ki mt ld mu le mv lf mw ky nk mp mq mr bi translated"><a class="ae nl" href="http://www.tiernok.com/posts/2019/faster-npm-installs-during-ci/" rel="noopener ugc nofollow" target="_blank">http://www . tier NOK . com/posts/2019/faster-NPM-installs-during-ci/</a></li></ul><h1 id="0fa2" class="lg lh it bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">环境</h1><h2 id="6160" class="nf lh it bd li nm nn dn lm no np dp lq ld nq nr lu le ns nt ly lf nu nv mc nw bi translated">包装</h2><p id="e46d" class="pw-post-body-paragraph ka kb it kd b ke me kg kh ki mf kk kl ld mg ko kp le mh ks kt lf mi kw kx ky im bi translated">为了防止任何缓存或意外行为，我在docker容器中运行实验，每次我们完成一个安装，我们都为下一个安装运行一个新的容器。</p><p id="28c7" class="pw-post-body-paragraph ka kb it kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">我使用的docker镜像是<code class="fe kz la lb lc b">node:12</code>，每个组件的版本是:</p><ul class=""><li id="9108" class="mj mk it kd b ke kf ki kj ld ml le mm lf mn ky nk mp mq mr bi translated">节点:v12.16.1</li><li id="5832" class="mj mk it kd b ke ms ki mt ld mu le mv lf mw ky nk mp mq mr bi translated">国家预防机制</li><li id="25da" class="mj mk it kd b ke ms ki mt ld mu le mv lf mw ky nk mp mq mr bi translated">纱线:1.22.0</li><li id="1a06" class="mj mk it kd b ke ms ki mt ld mu le mv lf mw ky nk mp mq mr bi translated">pnpm: 4.12.1</li></ul><h2 id="84fb" class="nf lh it bd li nm nn dn lm no np dp lq ld nq nr lu le ns nt ly lf nu nv mc nw bi translated">网络</h2><p id="45e6" class="pw-post-body-paragraph ka kb it kd b ke me kg kh ki mf kk kl ld mg ko kp le mh ks kt lf mi kw kx ky im bi translated">我对远程和本地注册中心(<a class="ae nl" href="https://verdaccio.org/" rel="noopener ugc nofollow" target="_blank"> verdaccio </a>)场景进行了实验，以展示网络的影响。在本地注册表中，我假设用户做了如下事情:</p><pre class="mx my mz na gt nb lc nc nd aw ne bi"><span id="e2a0" class="nf lh it lc b gy ng nh l ni nj">$ npm install react@latest --registry <a class="ae nl" href="http://nvy-registry:4873" rel="noopener ugc nofollow" target="_blank">http://nvy-registry:4873</a><br/># or<br/>$ yarn add react@latest --registry http://nvy-registry:4873</span></pre><p id="4e20" class="pw-post-body-paragraph ka kb it kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">这使得锁文件中的注册表url直接指向本地注册表。</p><h2 id="2e87" class="nf lh it bd li nm nn dn lm no np dp lq ld nq nr lu le ns nt ly lf nu nv mc nw bi translated">应用</h2><p id="89b3" class="pw-post-body-paragraph ka kb it kd b ke me kg kh ki mf kk kl ld mg ko kp le mh ks kt lf mi kw kx ky im bi translated">为了模拟真实世界的场景，我在一个使用<code class="fe kz la lb lc b">create-react-app</code>创建的web应用程序中进行了实验。</p><h2 id="0341" class="nf lh it bd li nm nn dn lm no np dp lq ld nq nr lu le ns nt ly lf nu nv mc nw bi translated">命令</h2><p id="75d0" class="pw-post-body-paragraph ka kb it kd b ke me kg kh ki mf kk kl ld mg ko kp le mh ks kt lf mi kw kx ky im bi translated">我使用5个基本命令:</p><ul class=""><li id="f50e" class="mj mk it kd b ke kf ki kj ld ml le mm lf mn ky nk mp mq mr bi translated"><code class="fe kz la lb lc b">npm install</code></li><li id="d3e7" class="mj mk it kd b ke ms ki mt ld mu le mv lf mw ky nk mp mq mr bi translated"><code class="fe kz la lb lc b">npm ci</code></li><li id="b7a6" class="mj mk it kd b ke ms ki mt ld mu le mv lf mw ky nk mp mq mr bi translated"><code class="fe kz la lb lc b">yarn install</code></li><li id="53a5" class="mj mk it kd b ke ms ki mt ld mu le mv lf mw ky nk mp mq mr bi translated"><code class="fe kz la lb lc b">yarn install --frozen-lockfile</code></li><li id="5a9d" class="mj mk it kd b ke ms ki mt ld mu le mv lf mw ky nk mp mq mr bi translated"><code class="fe kz la lb lc b">pnpm install</code></li></ul><blockquote class="jx jy jz"><p id="7bb9" class="ka kb kc kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe kz la lb lc b">yarn install --frozen-lockfile</code>类似于<code class="fe kz la lb lc b">npm ci</code></p></blockquote><p id="ea8e" class="pw-post-body-paragraph ka kb it kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">对于所有这些，我添加了<code class="fe kz la lb lc b">&amp;&gt; /dev/null</code>来删除stdout输出，执行时间是3次执行的平均值。(由于执行时间相当稳定，我相信3次就足够了)</p><p id="ff67" class="pw-post-body-paragraph ka kb it kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">让我们开始实验，看看我们会达到什么目的。😃</p><h1 id="681a" class="lg lh it bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">因素</h1><p id="46f5" class="pw-post-body-paragraph ka kb it kd b ke me kg kh ki mf kk kl ld mg ko kp le mh ks kt lf mi kw kx ky im bi translated">我们将调整4个参数:</p><ol class=""><li id="48d7" class="mj mk it kd b ke kf ki kj ld ml le mm lf mn ky mo mp mq mr bi translated">本地注册表</li></ol><p id="ca4d" class="pw-post-body-paragraph ka kb it kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">有了本地注册表，你可以在网络带宽不够的时候防止过时。这是一个提高速度的好方法，但是当有人克隆了你的注册表却无法访问你使用的本地注册表时，这可能会很痛苦。</p><p id="ff1d" class="pw-post-body-paragraph ka kb it kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">2.缓存的节点模块</p><p id="9eab" class="pw-post-body-paragraph ka kb it kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">一种加速安装的常用技术，通过压缩<code class="fe kz la lb lc b">node_modules</code>文件夹并在安装前解压缩，以消除再次从网络下载模块的需要。</p><p id="7c8f" class="pw-post-body-paragraph ka kb it kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">3.全局缓存</p><p id="1a0d" class="pw-post-body-paragraph ka kb it kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">npm在<code class="fe kz la lb lc b">~/.npm</code>有全局缓存文件夹，yarn在<code class="fe kz la lb lc b">~/.yarn</code>有全局缓存文件夹，通过提前添加全局缓存，想知道有没有可能加速。</p><p id="70db" class="pw-post-body-paragraph ka kb it kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">4.<code class="fe kz la lb lc b">--prefer-offline</code></p><p id="b1a8" class="pw-post-body-paragraph ka kb it kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">详情:<a class="ae nl" href="https://docs.npmjs.com/misc/config#prefer-offline" rel="noopener ugc nofollow" target="_blank">https://docs.npmjs.com/misc/config#prefer-offline</a></p><blockquote class="jx jy jz"><p id="92c4" class="ka kb kc kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果为true，将绕过对缓存数据的过时检查，但将从服务器请求缺失的数据。要强制完全离线模式，使用<code class="fe kz la lb lc b"><strong class="kd iu"><em class="it">--offline</em></strong></code>。</p></blockquote><p id="cac1" class="pw-post-body-paragraph ka kb it kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">通过这个选项，我们可以防止npm或yarn检查远程数据并直接使用本地缓存。</p><h1 id="45ca" class="lg lh it bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">实验</h1><p id="ab3e" class="pw-post-body-paragraph ka kb it kd b ke me kg kh ki mf kk kl ld mg ko kp le mh ks kt lf mi kw kx ky im bi translated">以下是所有配置的结果:</p><figure class="mx my mz na gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ny nz di oa bf ob"><div class="gh gi nx"><img src="../Images/060d7dce2246d37a72a320d9a5d5da6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vpPs5bYksXlvjp-Mrzh2Sg.png"/></div></div></figure><blockquote class="jx jy jz"><p id="f181" class="ka kb kc kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">该数字是完成模块安装的秒数</p></blockquote><h1 id="6b4b" class="lg lh it bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">观察</h1><ul class=""><li id="d699" class="mj mk it kd b ke me ki mf ld oc le od lf oe ky nk mp mq mr bi translated">永远记住用<code class="fe kz la lb lc b">&amp;&gt; /dev/null</code>关闭安装的输出，因为stdout非常耗时</li><li id="1d76" class="mj mk it kd b ke ms ki mt ld mu le mv lf mw ky nk mp mq mr bi translated">虽然本地注册表可以保证下载模块的稳定性，但不建议修改锁文件来获得这一好处，因为副作用是巨大的。</li><li id="a090" class="mj mk it kd b ke ms ki mt ld mu le mv lf mw ky nk mp mq mr bi translated"><code class="fe kz la lb lc b">npm ci</code>的速度在不同配置下都很稳定，但是<code class="fe kz la lb lc b">npm install</code>可以用<code class="fe kz la lb lc b">--prefer-offline</code>更快。</li><li id="3cc1" class="mj mk it kd b ke ms ki mt ld mu le mv lf mw ky nk mp mq mr bi translated"><code class="fe kz la lb lc b">yarn install</code>和<code class="fe kz la lb lc b">yarn install --frozen-lockfile</code>的速度根本没有区别。</li><li id="81bd" class="mj mk it kd b ke ms ki mt ld mu le mv lf mw ky nk mp mq mr bi translated">全局缓存对<code class="fe kz la lb lc b">yarn</code>更有用</li><li id="4794" class="mj mk it kd b ke ms ki mt ld mu le mv lf mw ky nk mp mq mr bi translated"><code class="fe kz la lb lc b">pnpm</code>的效率高度依赖全局缓存，如果没有缓存，由于缓存预处理开销，它的速度比其他的要慢</li></ul></div><div class="ab cl of og hx oh" role="separator"><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok"/></div><div class="im in io ip iq"><p id="5297" class="pw-post-body-paragraph ka kb it kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">对于这个实验的源代码可以在这个资源库中找到:<a class="ae nl" href="https://github.com/jeromewu/npm-vs-yarn-in-cicd" rel="noopener ugc nofollow" target="_blank">https://github.com/jeromewu/npm-vs-yarn-in-cicd</a></p><p id="aab6" class="pw-post-body-paragraph ka kb it kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated">希望它对你有所帮助，如果你有任何想法可以进一步加快速度，请随时在资源库中留下回复或创建问题。😄</p></div></div>    
</body>
</html>