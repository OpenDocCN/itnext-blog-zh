<html>
<head>
<title>An Infrastructure-As-Code Journey</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基础设施即代码之旅</h1>
<blockquote>原文：<a href="https://itnext.io/an-infrastructure-as-code-journey-8127132f5a70?source=collection_archive---------0-----------------------#2022-01-27">https://itnext.io/an-infrastructure-as-code-journey-8127132f5a70?source=collection_archive---------0-----------------------#2022-01-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="c62c" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">前言</h1><p id="ad13" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">2020年6月，我们开始启动DXP云。团队规模不超过2名工程师，我们出去为后来的DXP云打下了第一块砖。</p><p id="b662" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">我们很快意识到，使用Azure的门户作为构建我们平台的主要接口是不可扩展的，在整个旅程中，我们反复讨论如何使用IaC以及如何改进。我们都没有使用IaC的经验，但是作为软件工程师，IaC是我们DevOps思维模式的自然适应和延伸。</p><p id="0b4d" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><a class="ae lo" href="https://blog.segersian.com/2022/01/07/an-iac-journey/" rel="noopener ugc nofollow" target="_blank"> <em class="lp">本文原创于blog.segersian.com</em>T3</a></p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><h1 id="f669" class="jn jo iq bd jp jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk bi translated">高层次设计</h1><p id="25ac" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我写了一篇简短的博文解释<a class="ae lo" href="https://blog.segersian.com/2021-12-05-dxp-cloud" rel="noopener ugc nofollow" target="_blank">什么是DXP云以及它是如何工作的</a>。但是，我将占用图表一点时间来讨论一些事情。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mc"><img src="../Images/931c62e2363dc7963046cee2686ee122.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LGbtUVdnW-_2jAYL.png"/></div></div></figure><p id="f6e7" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">在我们的架构中，我们有静态和动态云资源。我们控制平面中的大多数云资源都是静态的，也就是说，它们不会自行创建、删除或更改。云资源的创建、更改或修改是对我们架构的实际更改。动态云资源不断地被创建、删除、修改，而不改变我们的架构。我们的大部分数据平面云资源都是动态的，这些资源与我们客户的独特实例相关。</p><p id="322a" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">我们可以将静态基础设施定义为“平台本身”，而动态基础设施是运行在我们平台之上的资源。</p><p id="1d8a" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">静态云资源示例</strong></p><blockquote class="mo mp mq"><p id="66a1" class="kl km lp kn b ko lj kq kr ks lk ku kv mr ll ky kz ms lm lc ld mt ln lg lh li ij bi translated"><em class="iq">我们的Azure API管理服务。只有当我们的一名工程师想要公开一个新的REST API端点时，才会对其进行修改。</em></p></blockquote><p id="4691" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">动态云资源示例</strong></p><blockquote class="mo mp mq"><p id="0828" class="kl km lp kn b ko lj kq kr ks lk ku kv mr ll ky kz ms lm lc ld mt ln lg lh li ij bi translated"><em class="iq">Azure SQL数据库，为新的客户实例提供。该数据库是为给定实例单独提供的，可以由客户主动删除或修改。该资源的创建不会改变DXP云的实际架构。</em></p></blockquote><h1 id="c6df" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">为什么要区分静态和动态？</h1><p id="365e" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这很重要，因为我们需要采取不同的方法来调配和管理云资源。这意味着我们的IaC之旅有两条平行的故事线。所以，静态故事和动态故事。</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><h1 id="cd3b" class="jn jo iq bd jp jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk bi translated">静态故事</h1><h1 id="aa5c" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">归零地</h1><p id="846f" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">起初，我们开始摆弄Azure的门户网站。这提供了很好的“探索”体验，但是导致了手动工作。我们作为工程师讨厌手工工作，我们希望一切自动化！由于手动工作不可扩展，您无法对其进行版本化，您必须对其进行文档化(唉),并且我们必须复制所有的文档(开发和生产环境)！</p><p id="3ebe" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">让我们继续前进，迭代这些恶作剧！</p><h1 id="aaca" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">迭代1: ARM模板和Powershell</h1><p id="b55d" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我们的原则之一是“从可用的本地工具开始，一旦现有工具变得有限，并且您理解了需求，再选择另一个”，因为我们只有2名工程师，所以我们无法承担培训数十个第三方工具的费用，也无法提高工作效率！</p><p id="af94" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">我们从一个用于版本控制和协作的GitHub库开始。ARM模板为我们提供了一种定义基础设施的声明式方法。然而，我们最终仍然严重依赖Powershell cmdlets和Azure CLI，因为ARM模板不支持这些操作，或者这些操作与ARM本身无关(例如生成证书)。</p><p id="652c" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">Powershell和Azure CLI的使用引入了命令式方法，并结合了来自ARM模板的声明式方法。这些因素结合在一起，使得我们很难理解运行任何脚本的“预期”结果是什么，以及资源之间的任何依赖关系(例如，应该首先提供哪个资源)。</p><p id="c631" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">Powershell证明了自己不是非常平台独立友好(在Windows、macOS和Linux之间)。Powershell core本应是解决这一问题的方案，但我们在任何机器上运行我们的脚本都面临着许多挑战。这些命令式脚本语言的使用使得以幂等方式运行我们的脚本变得更加困难，如果您想要保持多个环境同步，这是一个首要要求。</p><p id="febe" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">采用git、脚本和ARM模板，作为软件工程师，我们已经感到更加自在了，然而随着每个资源添加到我们的平台，复杂性增长得太快了。是时候改进我们的方法了。</p><h1 id="6039" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">迭代2:初学者的地形</h1><p id="e52e" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">声明式和命令式的混合让我们不太舒服。经过一些研究后，我们决定采用Terraform，因为它将消除我们对组合“命令式”和“声明式”方法的需要，并且只使用声明式方法。</p><p id="1cce" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">主要的问题是，由于Terraform是第三方工具，与Azure自己的工具相比，它无法跟上最新最好的工具。然而，作为回报，我们将得到一个更干净的、声明性的方法来定义我们的基础设施，以一种不太冗长的文件格式(HCL，Hashicorp配置语言)。这需要一些教育，但投资回报似乎是值得的。</p><p id="2ad4" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">我们花了几天时间阅读“Terraform:由Yevgeniy Brikman撰写的启动和运行”,这确实帮助我们启动了Terraform的推出。在这一点上，我们对选择Terraform作为IaC的主要工具感到非常满意。如果我没记错的话，这次迁移花了大约一个月的时间，但是多亏了导入功能，我们不必从头开始。</p><p id="2348" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">然而，没有完美的解决方案。现在确实面临一些其他问题:</p><ul class=""><li id="b8f5" class="mu mv iq kn b ko lj ks lk kw mw la mx le my li mz na nb nc bi translated">设置Terraform附带的“中央状态文件”管理。</li><li id="10bd" class="mu mv iq kn b ko nd ks ne kw nf la ng le nh li mz na nb nc bi translated">为部署建立“规划、批准和应用”渠道。</li><li id="e180" class="mu mv iq kn b ko nd ks ne kw nf la ng le nh li mz na nb nc bi translated">将所有内容导入Terraform后，我们有了一个整体反模式，因为我们将所有资源都放在了一个模块中。这使得Terraform很慢，并且违反了任何可测试性、解耦和可重用性的原则</li></ul><h2 id="4903" class="ni jo iq bd jp nj nk dn jt nl nm dp jx kw nn no kb la np nq kf le nr ns kj nt bi translated">令人痛苦的错误</h2><p id="aa15" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果不提及一些失败，任何学习之旅都是不恰当的。这也不例外，在这个阶段，我们正在适应Terraform并致力于并发分支。在一些沟通失误和人为错误之后(像往常一样)，我们清除了AKS集群，并在其上运行了实例。好的方面是，当时只有内部客户(员工)在使用它，坏的方面是，它痛苦地提醒我们缺乏灾难恢复。恢复是一个痛苦、缓慢的手动过程。谢天谢地，此时只有少数员工使用它。</p><p id="43b1" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">哪里出了问题？如果我没记错的话，我们两个在不同的部门工作。一个在主分支上，另一个在单独的分支上。这个单独的分支由于某种原因(时间太长，无法回忆起确切的原因)没有指定AKS terraform资源，而在主分支中却指定了。众所周知，除了主分支机构，我们不允许在任何其他分支机构进行“Terraform应用”。然而，由于人为错误，没有验证当前的分支，也没有仔细检查计划，我们继续应用，放弃了我们的AKS集群。</p><p id="433b" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">在这个错误发生之前，我们实际上理解了问题风险，风险，以及不要做什么。我们知道不应该做什么，然而，我们仍然犯了那些确切的错误，按照确切的顺序，会导致这样的问题发生。关键的一点是，建立你的工作流程来避免人为错误，不要相信自己总是思维敏捷。但是，尽量避免降低开发人员的生产力。</p><p id="3eee" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">当我试图回忆这个故事并把它写下来时，我痛苦地想起了尸检的重要性。但是，后来确实采用了这种做法</p><h1 id="349c" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">迭代3:青少年的土地改造</h1><p id="3f69" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">大约在这个时候，Terraform Cloud发布了，并为我们提供了最后两个绘画点的答案。用于部署和集中式状态文件管理的“规划、批准和应用”管道。除此之外，我们还了解到它解决了我们当时的一个未知挑战，提供了一个私有的Terraform模块注册表。</p><p id="1755" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">现在，这种方法已经开始满足我们的DevOps需求了！但我们仍然面临着一个新的巨大挑战，我们的整个基础设施只有一个单一的整体式平台模块。在这一点上，我们开始审视我们的基础架构中更大的依赖性和范围。我们按照“什么样的基础设施以相同的速度移动、发展和部署”的思维模式来分割我们的整体模块。</p><p id="c369" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">最终结果是我们的平台“计划”行动变得更短，因为模块更小，可以独立移动。这是一个很好的开始，然而，我们的模块仍然不小，不分离，不可重用，不可测试。单个模块仍然会与其他模块有很强的耦合，因此我们不能独立安装一个模块，因为它需要提供模块本身之外的许多其他资源。一股浓浓的代码味！</p><p id="b55c" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">由于Terraform cloud提供的Terraform module registry，我们可以在将基础架构分解为更小的模块时轻松创建和托管私有Terraform模块。</p><h1 id="aefa" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">迭代4:开发和测试</h1><p id="2985" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在这个时间点上，我们非常高兴，我们有一个很好的部署管道，我们有更小的模块，我们正在逐步分离。我们的整个工作流程真的开始感觉像一个软件开发管道！尽管如此，在分离我们的Terraform模块方面还有一些工作要做，但是架构和模块的变化是持续的，所以我们不能声称已经“完成”。</p><p id="6846" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">那时我们的工作流程中还缺少什么？安全和测试！</p><p id="85a8" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">安全性:我们希望让安全性成为我们管道中更重要的一部分，这在业内通常被称为“左移”。我们在管道中采用了Checkov(https://www . Checkov . io/)。</p><p id="b5b9" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">测试:由于我们已经发现我们的模块与其他模块紧密耦合，单元测试我们的Terraform模块在这一点上不是一个选项，将我们的模块重构为更小的独立模块将需要更长的时间。所以我们关注于<a class="ae lo" href="https://www.browserstack.com/guide/testing-pyramid-for-test-automation" rel="noopener ugc nofollow" target="_blank">测试金字塔的顶端(打开新窗口)</a>并创建了e2e测试，它通过GitHub动作运行。这些测试是对我们的DXP云REST api的API调用，然后验证资源是否被正确操作。</p><h1 id="f5e0" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated"><a class="ae lo" href="https://blog.segersian.com/2022/01/07/an-iac-journey/#iteration-5-best-practices-and-compliance" rel="noopener ugc nofollow" target="_blank"> # </a>迭代5:最佳实践和法规遵从性</h1><p id="fd08" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">随着我们对Terraform和IaC的经验不断积累，我们开始提出“技术愿景”。定义我们“最佳实践”的文档。这可能是关于如何在我们的环境中设置一个带有CI/CD的Azure函数，或者关于如何创建一个新的Terraform模块，带有正确的GitHub动作、分支等等…</p><p id="fd10" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">这些最佳实践为我们的DXP云环境创造了一种更加统一的方法。为了跟踪我们在一些最佳实践中的表现，我们使用Azure策略来检查合规性。这为我们提供了一些衡量标准。然而，100%的合规性并不是我们的目标，因为我们谈论“最佳实践”，如<a class="ae lo" href="https://engineering.atspotify.com/2020/08/17/how-we-use-golden-paths-to-solve-fragmentation-in-our-software-ecosystem/" rel="noopener ugc nofollow" target="_blank">“黄金路径”(打开新窗口)</a>，这不应该是强制性的！</p><p id="cd5d" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">在这里，我们开始体验到流程和方法的更加成熟。</p><h1 id="a46a" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated"><a class="ae lo" href="https://blog.segersian.com/2022/01/07/an-iac-journey/#iteration-x-the-future" rel="noopener ugc nofollow" target="_blank"> # </a>迭代X:未来</h1><p id="4d3a" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">没有完成的最后阶段，我们的旅程将继续，永远不会结束，因为我们会不断改进我们工作、思考和应用IaC的方式。但是，我们可以分享我们关注的一些想法:</p><p id="c53a" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">重构模块:进一步重新设计，重构更易测试、可重用和封装的模块。质量保证:更强的林挺，以及通过采用像tfsec (tfsec.dev)这样的工具对我们的模块进行静态分析以获得更好的安全性。安全性:A必须对如何更好地实施安全性和策略进行更多的研究。(例如，自动扫描Azure上的所有资源等)</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><h1 id="dd21" class="jn jo iq bd jp jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk bi translated">动态故事</h1><h1 id="6d49" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">迭代1:圣盔谷</h1><p id="691d" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在我们最初的方法中，我们使用Helm以声明的方式提供我们的Kubernetes资源。Helm是Kubernetes的一种包管理器和模板工具。对于所有的Azure资源，我们使用REST API，使用Azure的官方NPM包，在可能的地方包装这些API。</p><p id="74d4" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">供应和修改动态基础设施的流程编排是通过用JavaScript编写的Azure函数实现的。然后，这些函数将使用Azure的NPM模块，这些模块方便地包装了REST API，以提供Azure资源。对于Kubernetes资源，我们会使用头盔。Helm是一个模板工具，帮助提供和管理Kubernetes资源。</p><h1 id="0df8" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">迭代2:头盔太深</h1><p id="08e9" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">随着我们在DXP云平台上增加了更多对修改资源的支持，我们觉得使用官方的Kubernetes NPM模块来管理和修改资源会更方便。为了使我们的方法和工作流程更加一致，我们决定在我们的动态基础设施中取消Helm的使用。</p><p id="12e3" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">我们所有的动态基础设施现在都是通过Azure函数以及Azure和Kubernetes的官方NPM包运行的，它们最终只是包装了各自的REST APIs。</p><p id="7606" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">我们也研究了一些工具，比如Pulumi，但是在撰写本文的时候，我们还没有理由或者理由放弃使用Azure和Kubernetes的原生API作为我们的动态基础设施。</p><h1 id="9075" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">迭代X:未来</h1><p id="c7af" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我们所有的逻辑现在都是绝对必要的。这在调试和更改我们的数据平面时仍然非常具有挑战性。比方说，当我们提供Azure SQL数据库时，我们希望在其上设置标签。这是容易的部分，在我们的源代码中找到“供应数据库”逻辑并修改代码。但是所有这些现有的数据库呢？他们没有那些标签？我们现在需要构建一个特定的一次性迁移脚本来更新所有现有的数据库。这通常是一个比实际的特性改变更大的任务！</p><p id="26e9" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">这样的用例一直都在出现。因此，我们需要找到一种更好的方法来管理我们的动态云资源。我们需要的是某种“声明性”的模型(就像Terraform的HCL)。所以我们可以为给定的实例定义一个声明性的模型。这样，我们可以为所有实例重新运行相同的逻辑，从而为每个实例重新生成声明性模型。</p><p id="5463" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">一旦我们为所有实例重新生成了这些声明性模型，我们就可以运行一个作业来协调(打开新窗口)声明性模型和真实世界。与Kubernetes、<a class="ae lo" href="https://www.learnsteps.com/what-is-reconciler-pattern-and-how-terraform-uses-it/" rel="noopener ugc nofollow" target="_blank">、Terraform(打开新窗口)</a>以及其他声明性IaC工具完全一样。然而，我们必须能够以自动化的方式使用它。考虑到它的状态文件的性质，Terraform不是一个好的匹配。Kubernetes工具太有限，我们的实例资源覆盖Azure和Kubernetes资源。</p><p id="56b3" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">除了自制一些解决方案之外，还有一些潜在的候选方案。然而，这是一个项目和帖子本身。</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><h1 id="8adf" class="jn jo iq bd jp jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk bi translated">资源</h1><p id="6aed" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在我们的旅程中，我们使用以下书籍作为定义和改进IaC方法的灵感来源:</p><ul class=""><li id="f1bd" class="mu mv iq kn b ko lj ks lk kw mw la mx le my li mz na nb nc bi translated">基础设施作为代码(由基夫莫里斯，第一和第二版)</li><li id="b0c0" class="mu mv iq kn b ko nd ks ne kw nf la ng le nh li mz na nb nc bi translated">地形:启动和运行(叶夫根尼·布里克曼)</li><li id="f1b8" class="mu mv iq kn b ko nd ks ne kw nf la ng le nh li mz na nb nc bi translated">数据库可靠性工程(Laine Campbell &amp; Charity Majors)</li><li id="d811" class="mu mv iq kn b ko nd ks ne kw nf la ng le nh li mz na nb nc bi translated">现场可靠性工程(贝琪·拜尔、克里斯·琼斯、詹妮弗·佩托夫、尼尔·理查德·墨菲)</li><li id="3ac2" class="mu mv iq kn b ko nd ks ne kw nf la ng le nh li mz na nb nc bi translated">构建进化的建筑(尼尔·福特、丽贝卡·帕森斯、帕特里克·库阿)</li><li id="fd33" class="mu mv iq kn b ko nd ks ne kw nf la ng le nh li mz na nb nc bi translated">软件架构基础(马克·理查兹和尼尔·福特)</li></ul></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><h1 id="4ee6" class="jn jo iq bd jp jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk bi translated">谢谢</h1><p id="011f" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我提到我们是两个工程师，但我的意思是我们在任何给定的时间都和两个工程师在一起。我想对Skyetec的kolbjrn和John Inge以及现在是DXP云团队全职成员的Sebastian Augado表示感谢。</p></div></div>    
</body>
</html>