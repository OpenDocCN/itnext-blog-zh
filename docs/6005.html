<html>
<head>
<title>Building a Vertx application with SmallRye Mutiny Bindings, Spring and Hibernate Reactive</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用SmallRye兵变绑定、Spring和Hibernate反应式构建Vertx应用程序</h1>
<blockquote>原文：<a href="https://itnext.io/building-a-vertx-application-with-smallrye-mutiny-bindings-spring-and-hibernate-reactive-5cf10b57983a?source=collection_archive---------2-----------------------#2021-07-23">https://itnext.io/building-a-vertx-application-with-smallrye-mutiny-bindings-spring-and-hibernate-reactive-5cf10b57983a?source=collection_archive---------2-----------------------#2021-07-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="15fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<a class="ae kl" href="https://github.com/hantsy/vertx-sandbox/blob/master/docs/spring.md" rel="noopener ugc nofollow" target="_blank"> Spring integration post </a>中，我们使用Spring组装资源并启动应用程序。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/27b970583e1ef6af449cc380f62fe99a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lBVdgaRt4mrtNwLaEosQ4Q.jpeg"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk">Photo by <a class="ae kl" href="https://unsplash.com/@maohaolan?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">昊蓝 毛</a> on <a class="ae kl" href="https://unsplash.com/s/photos/china-landscape?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="7be4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇文章中，我们将重用Spring基础代码，但是:</p><ul class=""><li id="ee2b" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">使用Hibernate Reactive替换原始的Postgres客户端</li><li id="64c3" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">并使用SmallRye哗变Vertx绑定来替换原来的Vertx API，如Future等..</li></ul><p id="25c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将Hibernate相关的依赖项添加到项目<em class="lq"> pom.xml </em>文件中。</p><pre class="kn ko kp kq gt lr ls lt lu aw lv bi"><span id="399f" class="lw lx iq ls b gy ly lz l ma mb">&lt;dependency&gt;<br/>    &lt;groupId&gt;org.hibernate.reactive&lt;/groupId&gt;<br/>    &lt;artifactId&gt;hibernate-reactive-core&lt;/artifactId&gt;<br/>    &lt;version&gt;${hibernate-reactive.version}&lt;/version&gt;<br/>&lt;/dependency&gt;<br/>&lt;!-- <a class="ae kl" href="https://mvnrepository.com/artifact/org.hibernate/hibernate-jpamodelgen" rel="noopener ugc nofollow" target="_blank">https://mvnrepository.com/artifact/org.hibernate/hibernate-jpamodelgen</a> --&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;org.hibernate&lt;/groupId&gt;<br/>    &lt;artifactId&gt;hibernate-jpamodelgen&lt;/artifactId&gt;<br/>    &lt;version&gt;${hibernate.version}&lt;/version&gt;<br/>    &lt;scope&gt;provided&lt;/scope&gt;<br/>&lt;/dependency&gt;</span></pre><p id="acc2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上述代码中，</p><ul class=""><li id="69d0" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated"><code class="fe mc md me ls b">hibernate-reactive-core</code>提供Hibernate Reactive，使用Vertx Postgres Client等实现reactive APIs，目前支持Java 8 <code class="fe mc md me ls b">CompletionStage</code>和SmallRye哗变。在本帖中，我们只使用SmallRye兵变API。</li><li id="d8d3" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">在编译项目时，<code class="fe mc md me ls b">hibernate-jpamodelgen</code>将生成JPA <code class="fe mc md me ls b">Entity</code>元数据类。</li></ul><p id="7404" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<em class="lq">main/resources/META-INF</em>文件夹中添加一个<em class="lq"> persistence.xml </em>配置。</p><pre class="kn ko kp kq gt lr ls lt lu aw lv bi"><span id="c1e4" class="lw lx iq ls b gy ly lz l ma mb">&lt;persistence <br/>             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br/>             xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence http://xmlns.jcp.org/xml/ns/persistence/persistence_2_2.xsd"<br/>             version="2.2"&gt;</span><span id="c0fd" class="lw lx iq ls b gy mf lz l ma mb">    &lt;persistence-unit name="blogPU"&gt;<br/>        &lt;provider&gt;org.hibernate.reactive.provider.ReactivePersistenceProvider&lt;/provider&gt;</span><span id="ac29" class="lw lx iq ls b gy mf lz l ma mb">        &lt;class&gt;com.example.demo.Post&lt;/class&gt;</span><span id="71ae" class="lw lx iq ls b gy mf lz l ma mb">        &lt;properties&gt;</span><span id="726c" class="lw lx iq ls b gy mf lz l ma mb">            &lt;!-- PostgreSQL --&gt;<br/>            &lt;property name="javax.persistence.jdbc.url"<br/>                      value="jdbc:postgresql://localhost:5432/blogdb"/&gt;</span><span id="0592" class="lw lx iq ls b gy mf lz l ma mb">            &lt;!-- Credentials --&gt;<br/>            &lt;property name="javax.persistence.jdbc.user"<br/>                      value="user"/&gt;<br/>            &lt;property name="javax.persistence.jdbc.password"<br/>                      value="password"/&gt;</span><span id="51fa" class="lw lx iq ls b gy mf lz l ma mb">            &lt;!-- The Vert.x SQL Client connection pool size --&gt;<br/>            &lt;property name="hibernate.connection.pool_size"<br/>                      value="10"/&gt;</span><span id="8808" class="lw lx iq ls b gy mf lz l ma mb">            &lt;!-- Automatic schema export --&gt;<br/>            &lt;property name="javax.persistence.schema-generation.database.action"<br/>                      value="drop-and-create"/&gt;</span><span id="fc34" class="lw lx iq ls b gy mf lz l ma mb">            &lt;!-- SQL statement logging --&gt;<br/>            &lt;property name="hibernate.show_sql" value="true"/&gt;<br/>            &lt;property name="hibernate.format_sql" value="true"/&gt;<br/>            &lt;property name="hibernate.highlight_sql" value="true"/&gt;</span><span id="4dd7" class="lw lx iq ls b gy mf lz l ma mb">        &lt;/properties&gt;</span><span id="1ba4" class="lw lx iq ls b gy mf lz l ma mb">    &lt;/persistence-unit&gt;</span><span id="60f2" class="lw lx iq ls b gy mf lz l ma mb">&lt;/persistence&gt;</span></pre><p id="bd71" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个标准的JPA配置，但是这里我们使用特定的<code class="fe mc md me ls b">org.hibernate.reactive.provider.ReactivePersistenceProvider</code>作为提供者来提供ReactiveStreams支持。</p><p id="00b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，添加SmallRye相关的依赖项。</p><pre class="kn ko kp kq gt lr ls lt lu aw lv bi"><span id="dee4" class="lw lx iq ls b gy ly lz l ma mb">&lt;dependency&gt;<br/>    &lt;groupId&gt;io.smallrye.reactive&lt;/groupId&gt;<br/>    &lt;artifactId&gt;smallrye-mutiny-vertx-core&lt;/artifactId&gt;<br/>    &lt;version&gt;${mutiny-vertx.version}&lt;/version&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;io.smallrye.reactive&lt;/groupId&gt;<br/>    &lt;artifactId&gt;smallrye-mutiny-vertx-web&lt;/artifactId&gt;<br/>    &lt;version&gt;${mutiny-vertx.version}&lt;/version&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;io.smallrye.reactive&lt;/groupId&gt;<br/>    &lt;artifactId&gt;smallrye-mutiny-vertx-pg-client&lt;/artifactId&gt;<br/>    &lt;version&gt;${mutiny-vertx.version}&lt;/version&gt;<br/>&lt;/dependency&gt;</span></pre><p id="84e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe mc md me ls b">DemoApplication</code>中，曝光一个<code class="fe mc md me ls b">Mutiny.SessionFactory</code> bean。</p><pre class="kn ko kp kq gt lr ls lt lu aw lv bi"><span id="32e1" class="lw lx iq ls b gy ly lz l ma mb">@Bean<br/>public Mutiny.SessionFactory sessionFactory() {<br/>    return Persistence.createEntityManagerFactory("blogPU")<br/>        .unwrap(Mutiny.SessionFactory.class);<br/>}</span></pre><blockquote class="mg mh mi"><p id="aa9c" class="jn jo lq jp b jq jr js jt ju jv jw jx mj jz ka kb mk kd ke kf ml kh ki kj kk ij bi translated"><em class="iq">注意:您必须更新所有导入才能使用</em> <code class="fe mc md me ls b"><em class="iq">io.vertx.mutiny</em></code> <em class="iq">包中的物品，包括</em> <code class="fe mc md me ls b"><em class="iq">Vertx</em></code> <em class="iq">等。</em></p></blockquote><p id="7a72" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用以下零件替换<code class="fe mc md me ls b">PostRepository</code>。</p><pre class="kn ko kp kq gt lr ls lt lu aw lv bi"><span id="2973" class="lw lx iq ls b gy ly lz l ma mb">@Component<br/>@RequiredArgsConstructor<br/>public class PostRepository {<br/>    private static final Logger LOGGER = Logger.getLogger(PostRepository.class.getName());</span><span id="1a99" class="lw lx iq ls b gy mf lz l ma mb">    private final Mutiny.SessionFactory sessionFactory;</span><span id="2c40" class="lw lx iq ls b gy mf lz l ma mb">    public Uni&lt;List&lt;Post&gt;&gt; findAll() {<br/>        CriteriaBuilder cb = this.sessionFactory.getCriteriaBuilder();<br/>        // create query<br/>        CriteriaQuery&lt;Post&gt; query = cb.createQuery(Post.class);<br/>        // set the root class<br/>        Root&lt;Post&gt; root = query.from(Post.class);<br/>        return this.sessionFactory.withSession(session -&gt; session.createQuery(query).getResultList());<br/>    }</span><span id="e41f" class="lw lx iq ls b gy mf lz l ma mb">    public Uni&lt;List&lt;Post&gt;&gt; findByKeyword(String q, int offset, int limit) {</span><span id="eacc" class="lw lx iq ls b gy mf lz l ma mb">        CriteriaBuilder cb = this.sessionFactory.getCriteriaBuilder();<br/>        // create query<br/>        CriteriaQuery&lt;Post&gt; query = cb.createQuery(Post.class);<br/>        // set the root class<br/>        Root&lt;Post&gt; root = query.from(Post.class);</span><span id="0bee" class="lw lx iq ls b gy mf lz l ma mb">        // if keyword is provided<br/>        if (q != null &amp;&amp; !q.trim().isEmpty()) {<br/>            query.where(<br/>                cb.or(<br/>                    cb.like(root.get(Post_.title), "%" + q + "%"),<br/>                    cb.like(root.get(Post_.content), "%" + q + "%")<br/>                )<br/>            );<br/>        }<br/>        //perform query<br/>        return this.sessionFactory.withSession(session -&gt; session.createQuery(query)<br/>            .setFirstResult(offset)<br/>            .setMaxResults(limit)<br/>            .getResultList());<br/>    }<br/></span><span id="6a8d" class="lw lx iq ls b gy mf lz l ma mb">    public Uni&lt;Post&gt; findById(UUID id) {<br/>        Objects.requireNonNull(id, "id can not be null");<br/>        return this.sessionFactory.withSession(session -&gt; session.find(Post.class, id))<br/>            .onItem().ifNull().failWith(() -&gt; new PostNotFoundException(id));<br/>    }</span><span id="1ad6" class="lw lx iq ls b gy mf lz l ma mb">    public Uni&lt;Post&gt; save(Post post) {<br/>        if (post.getId() == null) {<br/>            return this.sessionFactory.withSession(session -&gt;<br/>                session.persist(post)<br/>                    .chain(session::flush)<br/>                    .replaceWith(post)<br/>            );<br/>        } else {<br/>            return this.sessionFactory.withSession(session -&gt; session.merge(post).onItem().call(session::flush));<br/>        }<br/>    }</span><span id="834e" class="lw lx iq ls b gy mf lz l ma mb">    public Uni&lt;Post[]&gt; saveAll(List&lt;Post&gt; data) {<br/>        Post[] array = data.toArray(new Post[0]);<br/>        return this.sessionFactory.withSession(session -&gt; {<br/>            session.persistAll(array);<br/>            session.flush();<br/>            return Uni.createFrom().item(array);<br/>        });<br/>    }</span><span id="f272" class="lw lx iq ls b gy mf lz l ma mb">    public Uni&lt;Integer&gt; deleteById(UUID id) {<br/>        CriteriaBuilder cb = this.sessionFactory.getCriteriaBuilder();<br/>        // create delete<br/>        CriteriaDelete&lt;Post&gt; delete = cb.createCriteriaDelete(Post.class);<br/>        // set the root class<br/>        Root&lt;Post&gt; root = delete.from(Post.class);<br/>        // set where clause<br/>        delete.where(cb.equal(root.get(Post_.id), id));<br/>        // perform update<br/>        return this.sessionFactory.withTransaction((session, tx) -&gt;<br/>            session.createQuery(delete).executeUpdate()<br/>        );<br/>    }</span><span id="fc66" class="lw lx iq ls b gy mf lz l ma mb">    public Uni&lt;Integer&gt; deleteAll() {<br/>        CriteriaBuilder cb = this.sessionFactory.getCriteriaBuilder();<br/>        // create delete<br/>        CriteriaDelete&lt;Post&gt; delete = cb.createCriteriaDelete(Post.class);<br/>        // set the root class<br/>        Root&lt;Post&gt; root = delete.from(Post.class);<br/>        // perform update<br/>        return this.sessionFactory.withTransaction((session, tx) -&gt;<br/>            session.createQuery(delete).executeUpdate()<br/>        );<br/>    }</span><span id="75f7" class="lw lx iq ls b gy mf lz l ma mb">}</span></pre><p id="b01b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它非常类似于标准的JPA代码，但是当使用<code class="fe mc md me ls b">Mutiny.SessionFactory</code>执行查询时，它将返回SmallRye哗变特定的<code class="fe mc md me ls b">Uni</code>类型。</p><p id="5c99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">更新<code class="fe mc md me ls b">PostsHandler</code>的内容。</p><pre class="kn ko kp kq gt lr ls lt lu aw lv bi"><span id="5643" class="lw lx iq ls b gy ly lz l ma mb">@Component<br/>@RequiredArgsConstructor<br/>class PostsHandler {<br/>    private static final Logger LOGGER = Logger.getLogger(PostsHandler.class.getSimpleName());</span><span id="8c56" class="lw lx iq ls b gy mf lz l ma mb">    private final PostRepository posts;<br/></span><span id="974f" class="lw lx iq ls b gy mf lz l ma mb">    public void all(RoutingContext rc) {<br/>//        var params = rc.queryParams();<br/>//        var q = params.get("q");<br/>//        var limit = params.get("limit") == null ? 10 : Integer.parseInt(params.get("q"));<br/>//        var offset = params.get("offset") == null ? 0 : Integer.parseInt(params.get("offset"));<br/>//        LOGGER.log(Level.INFO, " find by keyword: q={0}, limit={1}, offset={2}", new Object[]{q, limit, offset});<br/>        this.posts.findAll()<br/>            .subscribe()<br/>            .with(<br/>                data -&gt; {<br/>                    LOGGER.log(Level.INFO, "posts data: {0}", data);<br/>                    rc.response().endAndAwait(Json.encode(data));<br/>                },<br/>                rc::fail<br/>            );<br/>    }</span><span id="7977" class="lw lx iq ls b gy mf lz l ma mb">    public void get(RoutingContext rc) {<br/>        var params = rc.pathParams();<br/>        var id = params.get("id");<br/>        this.posts.findById(UUID.fromString(id))<br/>            .subscribe()<br/>            .with(<br/>                post -&gt; rc.response().endAndAwait(Json.encode(post)),<br/>                throwable -&gt; rc.fail(404, throwable)<br/>            );<br/>    }</span><span id="4c1c" class="lw lx iq ls b gy mf lz l ma mb">    public void save(RoutingContext rc) {<br/>        //rc.getBodyAsJson().mapTo(PostForm.class)<br/>        var body = rc.getBodyAsJson();<br/>        LOGGER.log(Level.INFO, "request body: {0}", body);<br/>        var form = body.mapTo(CreatePostCommand.class);<br/>        this.posts<br/>            .save(Post.builder()<br/>                .title(form.getTitle())<br/>                .content(form.getContent())<br/>                .build()<br/>            )<br/>            .subscribe()<br/>            .with(<br/>                savedId -&gt; rc.response()<br/>                    .putHeader("Location", "/posts/" + savedId)<br/>                    .setStatusCode(201)<br/>                    .endAndAwait(),<br/>                throwable -&gt; rc.fail(404, throwable)<br/>            );<br/>    }</span><span id="b7ff" class="lw lx iq ls b gy mf lz l ma mb">    public void update(RoutingContext rc) {<br/>        var params = rc.pathParams();<br/>        var id = params.get("id");<br/>        var body = rc.getBodyAsJson();<br/>        LOGGER.log(Level.INFO, "\npath param id: {0}\nrequest body: {1}", new Object[]{id, body});<br/>        var form = body.mapTo(CreatePostCommand.class);<br/>        this.posts.findById(UUID.fromString(id))<br/>            .flatMap(<br/>                post -&gt; {<br/>                    post.setTitle(form.getTitle());<br/>                    post.setContent(form.getContent());</span><span id="3a65" class="lw lx iq ls b gy mf lz l ma mb">                    return this.posts.save(post);<br/>                }<br/>            )<br/>            .subscribe()<br/>            .with(<br/>                data -&gt; rc.response().setStatusCode(204).endAndAwait(),<br/>                throwable -&gt; rc.fail(404, throwable)<br/>            );<br/>    }</span><span id="f82f" class="lw lx iq ls b gy mf lz l ma mb">    public void delete(RoutingContext rc) {<br/>        var params = rc.pathParams();<br/>        var id = params.get("id");</span><span id="27ae" class="lw lx iq ls b gy mf lz l ma mb">        var uuid = UUID.fromString(id);<br/>        this.posts.findById(uuid)<br/>            .flatMap(<br/>                post -&gt; this.posts.deleteById(uuid)<br/>            )<br/>            .subscribe()<br/>            .with(<br/>                data -&gt; rc.response().setStatusCode(204).endAndAwait(),<br/>                throwable -&gt; rc.fail(404, throwable)<br/>            );<br/>    }<br/>}</span></pre><p id="5734" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们来看看<code class="fe mc md me ls b">MainVerticle</code>。</p><pre class="kn ko kp kq gt lr ls lt lu aw lv bi"><span id="0c4f" class="lw lx iq ls b gy ly lz l ma mb">//...other imports.<br/>import io.smallrye.mutiny.Uni;<br/>import io.smallrye.mutiny.vertx.core.AbstractVerticle;<br/>import io.vertx.core.json.jackson.DatabindCodec;<br/>import io.vertx.mutiny.ext.web.Router;<br/>import io.vertx.mutiny.ext.web.handler.BodyHandler;</span><span id="eb8c" class="lw lx iq ls b gy mf lz l ma mb">@Component<br/>@RequiredArgsConstructor<br/>public class MainVerticle extends AbstractVerticle {<br/>    final PostsHandler postHandlers;</span><span id="35c0" class="lw lx iq ls b gy mf lz l ma mb">    private final static Logger LOGGER = Logger.getLogger(MainVerticle.class.getName());</span><span id="048e" class="lw lx iq ls b gy mf lz l ma mb">    static {<br/>        LOGGER.info("Customizing the built-in jackson ObjectMapper...");<br/>        var objectMapper = DatabindCodec.mapper();<br/>        objectMapper.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS);<br/>        objectMapper.disable(SerializationFeature.WRITE_DATE_TIMESTAMPS_AS_NANOSECONDS);<br/>        objectMapper.disable(DeserializationFeature.READ_DATE_TIMESTAMPS_AS_NANOSECONDS);</span><span id="c9e2" class="lw lx iq ls b gy mf lz l ma mb">        JavaTimeModule module = new JavaTimeModule();<br/>        objectMapper.registerModule(module);<br/>    }</span><span id="0cd4" class="lw lx iq ls b gy mf lz l ma mb">    @Override<br/>    public Uni&lt;Void&gt; asyncStart() {<br/>        LOGGER.log(Level.INFO, "Starting HTTP server...");</span><span id="5cfd" class="lw lx iq ls b gy mf lz l ma mb">        // Configure routes<br/>        var router = routes(postHandlers);</span><span id="a9d8" class="lw lx iq ls b gy mf lz l ma mb">        // Create the HTTP server<br/>        return vertx.createHttpServer()<br/>            // Handle every request using the router<br/>            .requestHandler(router)<br/>            // Start listening<br/>            .listen(8888)<br/>            // Print the port<br/>            .onItem().invoke(() -&gt; LOGGER.info("Http server is listening on http://127.0.0.1:8888"))<br/>            .onFailure().invoke(Throwable::printStackTrace)<br/>            .replaceWithVoid();<br/>    }</span><span id="fc5a" class="lw lx iq ls b gy mf lz l ma mb">    //create routes<br/>    private Router routes(PostsHandler handlers) {</span><span id="fd17" class="lw lx iq ls b gy mf lz l ma mb">        // Create a Router<br/>        Router router = Router.router(vertx);<br/>        // register BodyHandler globally.<br/>        //router.route().handler(BodyHandler.create());<br/>        router.get("/posts").produces("application/json")<br/>            .handler(handlers::all);<br/>        router.post("/posts").consumes("application/json")<br/>            .handler(BodyHandler.create())<br/>            .handler(handlers::save);<br/>        router.get("/posts/:id").produces("application/json")<br/>            .handler(handlers::get)<br/>            .failureHandler(frc -&gt; frc.response().setStatusCode(404).endAndAwait());<br/>        router.put("/posts/:id").consumes("application/json")<br/>            .handler(BodyHandler.create())<br/>            .handler(handlers::update);<br/>        router.delete("/posts/:id")<br/>            .handler(handlers::delete);</span><span id="67f6" class="lw lx iq ls b gy mf lz l ma mb">        router.get("/hello").handler(rc -&gt; rc.response().end("Hello from my route"));</span><span id="0966" class="lw lx iq ls b gy mf lz l ma mb">        return router;<br/>    }</span><span id="6ae0" class="lw lx iq ls b gy mf lz l ma mb">}</span></pre><p id="86bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的代码和以前的Spring版本很像。</p><p id="fca5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">SmallRye哗变版本<code class="fe mc md me ls b">Router</code>提供了一些变体方法来接受一个简单的函数，而不是原来的<code class="fe mc md me ls b">RequestHandler</code>，例如，有一个使用<code class="fe mc md me ls b">respond</code>方法的例子。</p><pre class="kn ko kp kq gt lr ls lt lu aw lv bi"><span id="0abe" class="lw lx iq ls b gy ly lz l ma mb">//MainVerticle.java<br/>router.get("/posts").produces("application/json")<br/>    .respond(handlers::all);</span><span id="cec0" class="lw lx iq ls b gy mf lz l ma mb">//PostHandler.java<br/>public Uni&lt;List&lt;Post&gt;&gt; all(RoutingContext rc) {<br/>    return this.posts.findAll();<br/>}</span></pre><p id="f396" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了测试应用程序，将以下依赖项添加到<em class="lq">测试</em>范围中。</p><pre class="kn ko kp kq gt lr ls lt lu aw lv bi"><span id="76d5" class="lw lx iq ls b gy ly lz l ma mb">&lt;dependency&gt;<br/>    &lt;groupId&gt;io.smallrye.reactive&lt;/groupId&gt;<br/>    &lt;artifactId&gt;smallrye-mutiny-vertx-junit5&lt;/artifactId&gt;<br/>    &lt;version&gt;${mutiny-vertx.version}&lt;/version&gt;<br/>    &lt;scope&gt;test&lt;/scope&gt;<br/>&lt;/dependency&gt;</span></pre><p id="82f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它为测试方法中的<code class="fe mc md me ls b">io.vertx.mutiny.core.Vertx</code>和<code class="fe mc md me ls b">TestContext</code>提供参数注入。</p><pre class="kn ko kp kq gt lr ls lt lu aw lv bi"><span id="dda4" class="lw lx iq ls b gy ly lz l ma mb">import io.vertx.mutiny.core.Vertx;<br/>import io.vertx.mutiny.core.http.HttpClientRequest;<br/>import io.vertx.mutiny.core.http.HttpClientResponse;<br/>//other imports</span><span id="ae43" class="lw lx iq ls b gy mf lz l ma mb">@SpringJUnitConfig(classes = DemoApplication.class)<br/>@TestInstance(TestInstance.Lifecycle.PER_CLASS)<br/>@ExtendWith(VertxExtension.class)<br/>public class TestMainVerticle {<br/>    private final static Logger LOGGER = Logger.getLogger(TestMainVerticle.class.getName());</span><span id="4546" class="lw lx iq ls b gy mf lz l ma mb">    @Autowired<br/>    ApplicationContext context;</span><span id="3a27" class="lw lx iq ls b gy mf lz l ma mb">    Vertx vertx;</span><span id="9e0a" class="lw lx iq ls b gy mf lz l ma mb">    @BeforeAll<br/>    public void setupAll(VertxTestContext testContext) {<br/>        vertx = context.getBean(Vertx.class);<br/>        var factory = context.getBean(VerticleFactory.class);<br/>        vertx.deployVerticle(factory.prefix() + ":" + MainVerticle.class.getName())<br/>            .subscribe()<br/>            .with(id -&gt; {<br/>                    LOGGER.info("deployed:" + id);<br/>                    testContext.completeNow();<br/>                },<br/>                testContext::failNow<br/>            );<br/>    }</span><span id="b226" class="lw lx iq ls b gy mf lz l ma mb">    @Test<br/>    public void testVertx(VertxTestContext testContext) {<br/>        assertThat(vertx).isNotNull();<br/>        testContext.completeNow();<br/>    }<br/></span><span id="050e" class="lw lx iq ls b gy mf lz l ma mb">    @Test<br/>    void testGetAll(VertxTestContext testContext) {<br/>        LOGGER.log(Level.INFO, "running test: {0}", "testGetAll");<br/>        var options = new HttpClientOptions()<br/>            .setDefaultPort(8888);<br/>        var client = vertx.createHttpClient(options);</span><span id="1c36" class="lw lx iq ls b gy mf lz l ma mb">        client.request(HttpMethod.GET, "/posts")<br/>            .flatMap(HttpClientRequest::send)<br/>            .flatMap(HttpClientResponse::body)<br/>            .subscribe()<br/>            .with(buffer -&gt;<br/>                    testContext.verify(<br/>                        () -&gt; {<br/>                            LOGGER.log(Level.INFO, "response buffer: {0}", new Object[]{buffer.toString()});<br/>                            assertThat(buffer.toJsonArray().size()).isGreaterThan(0);<br/>                            testContext.completeNow();<br/>                        }<br/>                    ),<br/>                e -&gt; {<br/>                    LOGGER.log(Level.ALL, "error: {0}", e.getMessage());<br/>                    testContext.failNow(e);<br/>                }<br/>            );<br/>    }<br/></span><span id="a7f4" class="lw lx iq ls b gy mf lz l ma mb">}</span></pre><h2 id="6020" class="lw lx iq bd mm mn mo dn mp mq mr dp ms jy mt mu mv kc mw mx my kg mz na nb nc bi translated"><a class="ae kl" href="https://github.com/hantsy/vertx-sandbox/tree/master/mutiny-spring-hibernate" rel="noopener ugc nofollow" target="_blank">从我的github获取示例代码。</a></h2></div></div>    
</body>
</html>