<html>
<head>
<title>Create Stripe Subscription Payments Using React &amp; AWS Lambda Pt 1: Setting Up The Lambda Service</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用React &amp; AWS Lambda Pt 1:设置Lambda服务创建条带订阅支付</h1>
<blockquote>原文：<a href="https://itnext.io/create-stripe-subscription-payments-using-react-aws-lambda-pt-1-setting-up-the-lambda-service-4e26501d30e0?source=collection_archive---------4-----------------------#2019-05-05">https://itnext.io/create-stripe-subscription-payments-using-react-aws-lambda-pt-1-setting-up-the-lambda-service-4e26501d30e0?source=collection_archive---------4-----------------------#2019-05-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/0f12f7a928db2173269faefb59650967.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cZphGnukwz1poasNGMcqFQ.jpeg"/></div></div></figure><p id="3c73" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">随着SaaS产品继续占领世界，使用户能够轻松进行定期结算交易的网络应用程序变得越来越流行。这种在线支付处理是事件驱动架构的完美用例，就像无服务器设置提供的架构一样。</p><p id="d469" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这个由两部分组成的系列中，我将介绍如何使用<a class="ae kz" href="https://serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器</a>框架和<a class="ae kz" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> AWS lambda </a>来设置Lambda函数。然后，我们将能够向我们的lambda服务提交一个请求，以创建与我们在线订阅产品时所期望的相同的功能。我们的lambda函数将执行以下任务:</p><ol class=""><li id="0aff" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">为用户创建条带客户帐户</li><li id="6e41" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">为创建的客户订阅产品计划</li></ol><h1 id="4eeb" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated"><strong class="ak">创建一个条纹账户</strong></h1><p id="c96b" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">正如你可能已经猜到的，你将需要一个可以使用的<a class="ae kz" href="https://stripe.com/" rel="noopener ugc nofollow" target="_blank"> Stripe </a>账户。设置不应该是一个麻烦，只是通常的注册材料。一旦您完成登录，请前往左侧菜单中的<strong class="kd iu">账单</strong>部分。您可以继续操作并单击“Billing ”,之后您会看到一个选项下拉列表，其中有一个指向<strong class="kd iu">产品</strong>页面的链接。导航到产品页面，创建一些产品和产品计划。如果你遇到一些问题，这篇短文<a class="ae kz" href="https://help.clickfunnels.com/hc/en-us/articles/360006017074-Setting-Up-A-Stripe-Subscription-Product" rel="noopener ugc nofollow" target="_blank">应该可以提供指导。</a></p><p id="1eb9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在创建了几个产品和它们各自的产品计划后，点击同一个左侧菜单中的<strong class="kd iu">开发者</strong>部分。您会注意到在出现的下拉选项中有一个到<strong class="kd iu"> API键</strong>的链接。记下你的<em class="mr">可公开</em> <em class="mr">密钥</em>和你的<em class="mr">秘密</em> <em class="mr">密钥</em>，因为你将在这个小应用程序的不同部分需要它们。</p><h1 id="92a0" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated"><strong class="ak">建立我们的Lambda服务</strong></h1><figure class="mt mu mv mw gt ju gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/5d5532351fe02b4f6d4d0f6bd1c1bede.png" data-original-src="https://miro.medium.com/v2/resize:fit:1216/format:webp/1*wUmkP_B66ti4gLSdOEKNRg.png"/></div></figure><p id="89d6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们从全局安装<a class="ae kz" href="https://www.npmjs.com/package/serverless" rel="noopener ugc nofollow" target="_blank">无服务器</a>框架开始:</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="0a67" class="nc lp it my b gy nd ne l nf ng">$ npm install -g serverless</span></pre><p id="9666" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您还没有一个<a class="ae kz" href="https://aws.amazon.com/" rel="noopener ugc nofollow" target="_blank"> AWS帐户</a>，您将需要创建一个。一旦你完成了所有的设置，创建一个<a class="ae kz" href="https://aws.amazon.com/iam/" rel="noopener ugc nofollow" target="_blank"> IAM </a>用户配置文件，并将用户凭证保存在一个安全的地方。然后，您可以使用无服务器配置文件，如下所示:</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="9f86" class="nc lp it my b gy nd ne l nf ng">$ <!-- -->sls config credentials --provider aws --key 1234 --secret 5678</span></pre><p id="1de1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一旦完成，你就可以进入lambda所在的本地目录或文件夹。无服务器框架附带了许多很酷的模板，我们可以用它们来为我们的服务生成一些样板代码。我选择使用<strong class="kd iu"> aws-nodejs-typescript </strong>模板<strong class="kd iu">。</strong>因此，我们的下一步是运行无服务器命令(<em class="mr">无服务器</em>或<em class="mr"> sls </em>)，这将创建一个新服务:</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="3ce8" class="nc lp it my b gy nd ne l nf ng"><em class="mr"># Create a new Serverless Service/Project</em></span><span id="7181" class="nc lp it my b gy nh ne l nf ng">$ sls create --template aws-nodejs-typescript --path react-stripe-subscriptions-backend</span><span id="b746" class="nc lp it my b gy nh ne l nf ng"><em class="mr"># Change into the newly created directory</em></span><span id="db51" class="nc lp it my b gy nh ne l nf ng">$ cd react-stripe-subscriptions-backend</span></pre><p id="b119" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">此时，您应该有一个完整的无服务器应用程序结构，默认的<strong class="kd iu"> handler.ts </strong>文件如下所示:</p><figure class="mt mu mv mw gt ju"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="22fd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您在IDE或代码编辑器中看到一些林挺错误，那可能是因为我们缺少了一些依赖项，所以现在让我们来解决这个问题。我们还将安装条带节点库，这是我们的服务所需的主要模块:</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="5242" class="nc lp it my b gy nd ne l nf ng">$ npm i --save aws-lambda node stripe</span></pre><p id="d5d7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们希望能够在部署之前离线运行我们的服务，这样当您使用它时，您可以安装<strong class="kd iu">无服务器离线</strong>:</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="1f9a" class="nc lp it my b gy nd ne l nf ng">$ npm i --save-dev serverless-offline</span></pre><p id="cfa0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您和我一样，喜欢使用熟悉的CLI命令(本例中为npm ),您可以通过添加另一个脚本来更新您的清单文件(package.json ),这样您就能够使用<strong class="kd iu"> npm start </strong>命令离线启动您的服务:</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="cd68" class="nc lp it my b gy nd ne l nf ng">"scripts": {</span><span id="2b2e" class="nc lp it my b gy nh ne l nf ng">  "start": "sls offline start --port 4000",</span><span id="e6ca" class="nc lp it my b gy nh ne l nf ng">  "test": "echo \"Error: no test specified\" &amp;&amp; exit 1"</span><span id="2ca9" class="nc lp it my b gy nh ne l nf ng">}</span></pre><p id="a723" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">接下来，我们需要通过将serverless-offline列为我们的插件之一来更新我们的<strong class="kd iu"> serverless.yml </strong>文件中的一些配置，包括我们的处理函数的一些细节和指定我们服务的区域。</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="43da" class="nc lp it my b gy nd ne l nf ng">service:</span><span id="b476" class="nc lp it my b gy nh ne l nf ng">  name: react-stripe-subscriptions-backend</span><span id="dab5" class="nc lp it my b gy nh ne l nf ng"># Add the serverless-webpack plugin</span><span id="d62f" class="nc lp it my b gy nh ne l nf ng">plugins:</span><span id="0098" class="nc lp it my b gy nh ne l nf ng">  - serverless-webpack</span><span id="9952" class="nc lp it my b gy nh ne l nf ng">  - serverless-offline<br/></span><span id="2cf9" class="nc lp it my b gy nh ne l nf ng">provider:</span><span id="4c18" class="nc lp it my b gy nh ne l nf ng">  name: aws</span><span id="21f8" class="nc lp it my b gy nh ne l nf ng">  runtime: nodejs8.10</span><span id="ce20" class="nc lp it my b gy nh ne l nf ng">  region: eu-west-1<br/></span><span id="a29c" class="nc lp it my b gy nh ne l nf ng">functions:</span><span id="b9fb" class="nc lp it my b gy nh ne l nf ng">  createCustomer:</span><span id="e873" class="nc lp it my b gy nh ne l nf ng">    handler: handler.createCustomer</span><span id="63d1" class="nc lp it my b gy nh ne l nf ng">    events:</span><span id="1617" class="nc lp it my b gy nh ne l nf ng">      - http:</span><span id="b684" class="nc lp it my b gy nh ne l nf ng">          method: post</span><span id="028b" class="nc lp it my b gy nh ne l nf ng">          path: create-customer</span><span id="eaff" class="nc lp it my b gy nh ne l nf ng">          cors: true</span></pre><figure class="mt mu mv mw gt ju"><div class="bz fp l di"><div class="nk nj l"/></div></figure><p id="f357" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我知道你在想什么“我们什么时候开始有趣的事情？”坚持住，我们快到了。</p><p id="3d56" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们更新当前的handler.ts文件，让这个<strong class="kd iu"> createCustomer </strong>函数在我们的yaml配置文件中指定。该函数将接收三个参数:</p><ol class=""><li id="1576" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated"><em class="mr"> stripeToken </em> —包含客户账单和地址详细信息的令牌</li><li id="1cff" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated"><em class="mr">电子邮件</em> —创建Stripe客户账户的用户的电子邮件地址</li><li id="9a92" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated"><em class="mr">产品计划</em> —客户正在订阅的产品计划的id</li></ol><figure class="mt mu mv mw gt ju"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="3a5a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下一步，让我们用包含函数<strong class="kd iu">createCustomerAndSubscribeToPlan</strong>的文件创建一个文件夹a，该函数将利用条带库并处理客户和产品订阅的创建。</p><figure class="mt mu mv mw gt ju"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="b6b8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一旦你有了这个函数，我们的<strong class="kd iu"> createCustomer </strong> lambda就可以运行了🎉</p><p id="7dd3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了确保一切正常，您可以尝试使用<strong class="kd iu"> npm start </strong>在本地运行它</p><figure class="mt mu mv mw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nl"><img src="../Images/5d1249677e0794d20b786f97f0686276.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ycJUtcvTYxBJQa5EnHAqfg.png"/></div></div></figure><p id="222f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你对你所看到的感到满意(在这一点上不会太多🤔)，您可以使用以下命令部署lambda函数:</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="f08f" class="nc lp it my b gy nd ne l nf ng">$ sls deploy</span></pre><p id="9c16" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">伙计们，现在就到这里吧😃。在这篇文章的后续部分，我将一步一步地指导如何<a class="ae kz" href="https://medium.com/@outlier.developer/create-stripe-subscription-payments-using-react-aws-lambda-pt-2-building-our-react-frontend-28a6a167f7b9" rel="noopener">创建一个使用我们刚刚创建的lambda函数的React前端应用</a>，敬请关注！</p><p id="a995" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">你可以在https://github.com/LukeMwila/stripe-subscriptions-backend<a class="ae kz" href="https://github.com/LukeMwila/stripe-subscriptions-backend" rel="noopener ugc nofollow" target="_blank">的</a>找到这个帖子的代码</p><p id="04ac" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你喜欢这篇文章，请在☕️给我买杯咖啡😃。</p></div></div>    
</body>
</html>