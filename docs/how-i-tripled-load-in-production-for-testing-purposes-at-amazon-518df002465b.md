# 我如何在亚马逊将生产负载增加三倍以进行测试…

> 原文：<https://itnext.io/how-i-tripled-load-in-production-for-testing-purposes-at-amazon-518df002465b?source=collection_archive---------0----------------------->

## …并幸存下来讲述了这个故事！

![](img/7f777829e7624f3e429edaba83d711b9.png)

我深吸了一口气。我正要做些什么，我既兴奋又害怕。我慢慢地在终端上输入命令，盯着闪烁的光标。仔细检查了我的寻呼机的电池(是的，我们当时带着实体寻呼机…)。三次检查我输入的命令行。最终我用尽了强迫性的事情来继续拖延。表演时间到了。

我的工具的详细输出开始打印到控制台。当这些行快速滚动时，我寻找任何问题的征兆。没有错误消息！我出了一身冷汗，点击了浏览器窗口上的刷新，在那里我有我的服务的操作仪表板。这些指标急剧上升。

我轻轻一按 return 键，就命令亚马逊数据中心深处的一万台机器开始向 Amazon.com 的一个关键地区发送万亿字节的数据，以测试它接近崩溃的极限。不是测试阶段。生产阶段。同时处理常规流量。我的服务正在处理三倍的负载。这是我职业生涯中做过的最冒险的事情。任何错误都可能意味着令人尴尬的公共服务中断、数百万美元的收入损失以及一些愤怒的同事。

我不知道这一刻是我职业生涯的转折点。基于我十年来领导亚马逊公司范围内的负载和性能测试工作，我会被提升为高级工程师，然后是首席工程师。今天，我是 Google 性能测试的领域管理员。这一切都是从那个按键开始的。

一年前，我的服务在 Amazon.com 造成了一次痛苦的停机。以下是我在*接下来*所做的，以确保这种事情不会再次发生。

> **负载和性能测试不是盲目地遵循一个公式。你必须运用批判性思维、深度分析和逻辑。我提出了许多问题来指导我的负载测试策略。我认为这些足够通用，它们也可以指导你。**

# 我实际上想做什么？

似乎很明显，不是吗？不——多问几遍这个问题，以弄清你实际上想做什么。例如:

*   “我预计我的负载会因某个计划好的高峰事件而从 X 增加到 Y，我想确保我的系统能够优雅地处理 Y。”
*   “我想知道*我的系统什么时候会崩溃。我想让它接近极限，这样我就知道我有多失控。”*
*   “我想知道*我的系统将如何*崩溃。我想让它突破极限，这样我就知道这是多么的灾难性和可恢复性。”
*   “我想知道我的系统是否能够适应依赖关系变慢或完全失效，以及在这种情况下它如何处理负载。”
*   “我想了解当系统处理更多吞吐量时，它的延迟是如何变化的。我会在哪个点错过 [SLOs](https://www.atlassian.com/incident-management/kpis/sla-vs-slo-vs-sli#:~:text=An%20SLO%20(service%20level%20objective,re%20making%20to%20that%20customer.) ？”
*   “我想知道是否有更好的配置，使我的系统在峰值时性能更好/更快/更便宜(例如，我应该在硬件 A 还是 B 上运行我的服务，我应该使用 16 个还是 32 个线程，等等)。”

您使用的工具，甚至整个方法对于所有这些桶来说可能是完全相同的，但是您计划和执行测试的方式以及您构建将帮助您回答实际问题的仪表板的方式有细微差别。

对我来说，这是第一颗子弹。我有整整两天的时间(黑色星期五和网络星期一),在这两天里，我们预测系统将收到 3 倍于平时的负载。因此，如果我可以证明系统在该负载下成功运行，我就达到了我的目标。

# “应用负载”对您的系统意味着什么？

![](img/e5171217e058f33d9ce1bba74d815676.png)

另一个看似显而易见，实则不然的问题。对于大多数实时同步系统来说，“应用负载”意味着增加事务发生的速率。但是这里有细微差别。有些人用每秒的*事务*来描述吞吐量，但其他人将吞吐量定义为*并发连接*或“用户”。还有:是事务*开始*的速率，还是事务*结束*的速率？一般来说，随着负载的增加，系统开始变慢，因此事务完成的速度开始显示出与事务开始的速度不同的斜率(这是一个信号，表明你已经进入了一个不可持续的状态)。我在这里写了这个。

我的系统是*异步的*，这使得理解增加负载的影响更加困难。有一个摄取服务，它从 Amazon.com 前线舰队接收大量原始数据，加密后保存到 S3 自动气象站做进一步处理。有 [map/reduce](https://en.wikipedia.org/wiki/MapReduce) 作业从 S3 获取数据，并对其进行聚合和处理(运行当时世界上最大的 Hadoop 集群之一)。亚马逊上有几十个服务调用这个服务来获取处理过的数据。他们利用这些数据做出了许多关键的近乎实时的商业决策(在任何给定的时间，Amazon.com 都在根据客户行为和实验做出数十或数百个自动决策，而我的服务正是让这一切成为可能的一部分)。

异步架构的本质意味着调用摄取服务的延迟是没有意义的(因为它只是将实际工作排队并立即返回)。在原始数据被摄取的时间和处理后的数据可用的时间之间存在不确定的延迟。这段时间需要保持在 SLOs 峰值范围内，因为 Amazon 用处理后的数据做出的一些商业决策是时间敏感的。

我对摄取服务很感兴趣，因为这是数据进入我系统的方式。所有为 Amazon.com 流量服务的服务器都会不断地将日志数据写入磁盘，然后分批发送到我的服务，每分钟一次。这意味着来自数千台机器的流量会出现峰值，然后在这一分钟的剩余时间里可能会处于空闲状态。但是网络分区增加了一些噪音:如果一台机器在最后一分钟没有将数据发送到我的系统，它将继续堆积并继续尝试。随机的网络问题意味着会有掉队者带着比平常更大的数据和有效载荷进来。对我来说，Amazon.com 上更多的流量并不意味着每秒更多的交易，*这意味着更大的有效负载*。这将在测试中发挥重要作用。

系统的其他部分呢？思考异步系统如何处理负载的一个好方法是，从端到端处理一个特定的数据需要多长时间*。*在任何给定的时间，你都有 N 个单元的工作要处理，M 个单元的工作要处理。如果 N > M 持续一段时间，那么处理时间将会增长。所以在我的测试中，我需要遥测技术来告诉我我的队列大小和处理时间。有些遥测技术已经存在，但不是全部，所以我必须在我的仪表板上添加指标。如果我没有花时间预先考虑这一点，这不是我能够追溯得到的数据。

# 刺激，还是不刺激

![](img/08b1fdd1dc75c993569146f2a4d4af78.png)

这似乎是问我自己的另一个奇怪的问题，因为在测试阶段测试总是*更安全*，而在 prod 中测试只是为那些懒得创建一个合适的测试阶段的人准备的，对吗？也许不是。在很大程度上，该架构的构建块是水平扩展的，如 AWS S3 或 Hadoop。但是我对推断我的系统将永远线性扩展感到不舒服。一个系统的可伸缩性取决于它最不可伸缩的组件，除非你知道那是什么，否则你不知道你的临界点在哪里。我的测试阶段是我的大规模生产环境的百分之一。尺寸、配置和数据的保真度至关重要。

在一个理想的世界里，我会两样都做。在我的测试环境中开始测试，在那里找到容易得到的结果，只有在首先解决了所有容易的事情之后，才继续测试我的生产环境。我的时间有限，所以我决定冒险在生产中进行测试。

制作保真是主要原因，但我也有另一个原因。当您增加系统负载时，很可能会增加其*依赖项*的负载。我花了相当多的时间了解我们有哪些依赖关系，以及应用于我的系统的负载如何转化为应用于他们系统的负载。例如，加倍我的负载是否会加倍我传递给依赖项的负载？还是我中间有一个缓存？缓存使负载测试变得更加困难，因为现在有了一个层，它可以根据数据的构成以及是热缓存还是冷缓存来显著影响系统处理负载的方式。

即使我可以增加我的测试阶段*的负载，我的依赖*的*测试阶段也有可能不想要(或者不能处理)那个负载。因此，我为我将要影响的所有依赖项提出了一个“双赢”的主张。我需要证明我的系统能够处理峰值，他们也需要证明这一点。我的提议是: ***我在做所有艰苦的工作*** ！他们只需要在我测试期间扩展他们的系统，在测试期间，他们的 oncall 和我会成为最好的朋友。我将他们的度量标准添加到我的仪表板中，以了解测试是否给他们带来了风险。我确保他们有我的呼机，我也有他们的。我们需要密切配合。这感觉像是在养猫，但我最终得到了我所有重要依赖者的支持，我们选择了一个日期，在这个日期之前我们都准备好了。*

# 我应该使用什么数据？

我需要数据。大量数据。我怎样才能达到日常工作量的 3 倍呢？我应该设计合成数据还是重放生产流量？

只要在访问 prod 数据时不侵犯客户隐私，从 prod 重放总是一个不错的选择，因为它保证了保真度。还有一个更重要的考虑:重放事务是否会改变状态。如果您正在对 ATM 进行负载测试，测试 GetAccountBalance()很容易，因为它是幂等的，但是测试 WithdrawMoney()比较困难，因为每次重放它时，它都会从某人的帐户中扣除一些钱。

在很大程度上，我的系统是幂等的，但是有一些地方我需要确保我发送的用于测试的数据不会污染任何真实的业务数据。我用一个测试标志标记了这些数据，并在我的服务中构建了一些管道，以稍微不同的方式处理这些数据。区别对待测试数据*一点点*以确保它不会造成污染，与区别对待测试数据*太多*以至于失去生产保真度，这两者之间有一条细微的界限。对于您添加到生产代码中的用于处理测试数据的 *if* 子句，要慎重且有原则。

我最初天真的方法是在系统处理常规日的基础上重放 2 天以前的内容。这将大致达到预期的吞吐量。该数据将是生产数据。所以很简单，勾选了大部分的框。

但这正是负载测试需要*批判性思维*的地方。消费者在网络星期一的行为会与平常购物日有所不同吗？是的。浏览行为不同。与平常相比，顾客会往购物车里添加更多的东西。他们购买更多。闪电销售立即在我们的一些服务中创造了热点。

为了验证我的理论，即网络星期一是独一无二的，我得到了前一年的数据，并编写了代码来解析它，提取一些感兴趣的模式。然后，我在许多常规的日子里运行我的脚本，以理解可能影响我的测试的客户行为变化。

最后，我使用了前两天的数据，但是我编写了一个数据转换管道来处理数据的某些方面，以便它最接近黑色星期五和网络星期一期间的行为。

# 我做得对吗？

我确实发现了一个会导致 Amazon.com 在黑色星期五停工的错误，并且我能够阻止它。这很容易造成数百万美元的停机。如果有效负载大于 N 兆字节，我们使用的一个库就会泄漏一个文件句柄。这个错误已经潜伏在系统中有一段时间了，但没有被发现，因为在正常运行期间，绝大多数有效载荷都低于这个阈值。偶尔会有泄漏，但是当系统重新启动时，这些泄漏就消失了(每次部署都会发生这种情况)。对于黑色星期五，几乎所有的*有效负载都将超过这个阈值，所以当我看到*空闲磁盘*指标在测试的一个小时内急剧下降到危险水平时，可以想象我有多惊讶。我不得不中止测试，因为生产环境处于危险之中。*

我还发现，虽然该系统是用可水平扩展的构建块构建的，但有几个组件不能以日常负载的 3 倍线性扩展，因此我们最初对需要多少硬件的计算相差很大。我们用我从测试中获得的数据对我们的车队进行了规模调整。这不是一个运行成本低廉的车队，因此不过度配置可以节省相当多的硬件成本。

我确实做错了一件事。在任何时候，亚马逊都会进行几十次实验。这些实验达到了一定的流量百分比。例如，我可以运行一个实验，我想知道改变“添加到购物车”按钮的颜色是否会影响销售，所以我将对 1%的交易运行它。如果数字看起来有希望，我可能会把它提高到 10%，然后 20%，然后 50%，然后 90%，然后 100%。在我的测试中，有一个实验运行在 1%的负载，但是在黑色星期五，这个实验运行了 20%,这意味着我们系统中有一个分区的负载是我测试的 20 倍。结果还不错，但当我看到这种情况时，有些人在流汗和咒骂！

我在 AWS reInvent 2013 上也讲过这个