<html>
<head>
<title>Istio — Impacts of namespace sameness with traffic management in a Multi-Cluster environment</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Istio —多集群环境中命名空间一致性对流量管理的影响</h1>
<blockquote>原文：<a href="https://itnext.io/istio-impacts-of-namespace-sameness-with-traffic-management-in-a-multi-cluster-environment-6556171d8cdd?source=collection_archive---------3-----------------------#2022-07-18">https://itnext.io/istio-impacts-of-namespace-sameness-with-traffic-management-in-a-multi-cluster-environment-6556171d8cdd?source=collection_archive---------3-----------------------#2022-07-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="3908" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在最近的一篇博客中，我介绍了如何在Anthos服务网格中配置全局<em class="kl"> MeshConfig </em>设置。现在是时候说说那个把我引向那里的故事了！</p><p id="4d42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们目前运行一个多集群环境，最近通过向集群添加Istio remote secrets实现了服务发现。一旦完成，我们就开始在ArgoCD和Vault等服务中出现奇怪的行为。我们在热/温设置中运行ArgoCD，并使用相同的名称空间名称(提示提示)。Vault在每个区域群集中具有性能副本，并且使用相同的命名空间名称(提示提示x2)。</p><p id="4a11" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对ArgoCD来说，行为怪异与Dex有关。我们使用Dex进行单点登录。在服务发现之后，Dex页面将加载，接受您的凭证，并在重定向时不识别登录。我们最终陷入了一个登录循环。作为Argo上的主要SME，并且已经完成了服务发现变更，我控制了一些“变更参数”。于是我在网上搜了一下，看看别人有没有类似的问题，挖了又挖，除了这个<a class="ae km" href="https://istio.io/latest/docs/ops/configuration/traffic-management/multicluster/" rel="noopener ugc nofollow" target="_blank">片段</a>没找到多少:</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi kn"><img src="../Images/42c49c04fbef1af93095b067e80986e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H-3EAkqU3YCH-OhZlDxLkw.png"/></div></div><figcaption class="kz la gj gh gi lb lc bd b be z dk translated">名称空间相同</figcaption></figure><p id="fc40" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这让我恍然大悟，并开始探究名称空间的一致性是否是我的问题的根源。首先，我将备用集群上用于Dex部署的副本缩减到零。士气也提高了！当我有所进展时，这是个好消息。用户能够再次登录并监控他们的应用程序部署。</p><p id="6aa7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">随着我继续研究云日志(我们在GKE)，我还注意到ArgoCD使用的Redis部署中的错误增加了(我们在HA配置中运行Redis)。错误表明一个成员拍打，这也触发了我。我在备用集群上对Redis和所有其他组件重复了缩减到零的过程…..士气进一步提高。</p><p id="73fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">重读名称空间相同性片段，很明显行为变化是相关的。戴上我的网络帽子，我回想起Istio用注入的特使代理有效地劫持了你的网络。拓扑不再是关注Kubernetes服务端点的问题；统治世界的是Istio拓扑，它看到了本地集群之外的东西！看着Istio的观点，我看到了以下内容</p><pre class="ko kp kq kr gt ld le lf lg aw lh bi"><span id="140c" class="li lj iq le b gy lk ll l lm ln">istioctl proxy-config endpoints deploy/istio-ingressgateway.istio-ingress |grep dex</span></pre><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi lo"><img src="../Images/1b14822e9345c982ca60786720c84ffa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FOEBT5p21ELS5HGtL6T72g.png"/></div></div><figcaption class="kz la gj gh gi lb lc bd b be z dk translated">指数的Istio拓扑</figcaption></figure><p id="d3c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好吧，这是有道理的，所以现在我必须想出一个办法，使这成为永久性的。我想到了几件事:</p><ul class=""><li id="6ea8" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx bi translated">(第二个最佳选择)打破名称空间的一致性—让主实例和备用实例具有不同的名称空间名称</li><li id="be99" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">保持名称空间的一致性，但是通过重命名服务和其他资源使其在集群中具有不同的名称来使服务“独立”(更多的配置！)</li><li id="d7db" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">将备用群集上的所有副本降至零</li><li id="bd94" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">(选择)从Istio的网格角度解决问题</li></ul><p id="246f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我们选择通过将一些名称空间标记为集群本地来解决Istio级别的问题。这意味着有效地禁用名称空间的服务发现，这样它们就可以被认为是集群的本地服务。受益于此的组件包括ArgoCD、Vault、Dynatrace、External Secrets，我相信更多组件会随之而来。</p><p id="ca34" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于如何配置这种网格范围设置的细节，我建议查看我的另一篇博客文章<em class="kl"> Anthos服务网格——配置全局设置。</em></p><p id="e792" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">既然这个危机已经解决了，那么名称空间的相同性在哪里有意义呢？如果您有一个无状态的应用程序或外部化的状态，并且跨多个集群/区域运行；这个功能还是蛮不错的。对于平台组件来说，就没那么简单了。特别是对于成员/法定人数起作用的服务(Redis HA成员、Vault Raft后端等)。)</p><p id="c0a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是痛苦的几天，假设，验证，寻找如何修复，并与谷歌支持工作。最终，解决方案是一个易于部署到集群的单一配置图。</p></div></div>    
</body>
</html>