<html>
<head>
<title>Kubernetes: update AWS Route53 DNS from an Ingress</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes:从入口更新AWS Route53 DNS</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-update-aws-route53-dns-from-an-ingress-1c3a8068f9fe?source=collection_archive---------1-----------------------#2020-11-22">https://itnext.io/kubernetes-update-aws-route53-dns-from-an-ingress-1c3a8068f9fe?source=collection_archive---------1-----------------------#2020-11-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/748b92ab1e2dca4abc78177b8ed17bae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LwQ5TrmSSdHxgqBn6oahvw.png"/></div></div></figure><p id="6e75" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们希望能够在部署Kubernetes入口资源时在AWS Route53上添加DNS记录，并将该记录指向由<a class="ae kw" href="https://rtfm.co.ua/kubernetes-zapusk-alb-ingress-controller-dlya-aws-elastic-kubernetes-service/" rel="noopener ugc nofollow" target="_blank"> ALB入口控制器</a>创建的AWS负载平衡器的URL。</p><p id="3b5d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了实现这一点，可以使用<a class="ae kw" href="https://github.com/kubernetes-sigs/external-dns" rel="noopener ugc nofollow" target="_blank">外部DNS </a>，它将向AWS Route53发出API请求，以添加适当的记录。</p><p id="3a5b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">AWS安装在其<a class="ae kw" href="https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/aws.md" rel="noopener ugc nofollow" target="_blank">文档&gt; &gt; &gt; </a>中有描述。</p><h1 id="6ea6" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated"><strong class="ak">内容</strong></h1><ul class=""><li id="1be5" class="lv lw iq ka b kb lx kf ly kj lz kn ma kr mb kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-update-aws-route53-dns-from-an-ingress/#AWS_set_up" rel="noopener ugc nofollow" target="_blank"> AWS设置</a></li><li id="5a5b" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-update-aws-route53-dns-from-an-ingress/#IAM_Policy" rel="noopener ugc nofollow" target="_blank"> IAM策略</a></li><li id="e227" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-update-aws-route53-dns-from-an-ingress/#IAM_Role" rel="noopener ugc nofollow" target="_blank">我的角色</a></li><li id="1203" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-update-aws-route53-dns-from-an-ingress/#ExternalDNS" rel="noopener ugc nofollow" target="_blank">外部域名</a></li><li id="863d" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-update-aws-route53-dns-from-an-ingress/#Kubernetes_Ingress_and_AWS_Application_LoadBalancer" rel="noopener ugc nofollow" target="_blank"> Kubernetes Ingress和AWS应用负载平衡器</a></li><li id="3e4e" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-update-aws-route53-dns-from-an-ingress/#Records_updates_and_apex_domains" rel="noopener ugc nofollow" target="_blank">记录更新和apex域</a></li><li id="8d6d" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-update-aws-route53-dns-from-an-ingress/#Update_an_existing_rootleveldomain" rel="noopener ugc nofollow" target="_blank">更新现有的根级域名</a></li></ul><h1 id="ca5f" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">AWS设置</h1><h2 id="6d9b" class="ml ky iq bd kz mm mn dn ld mo mp dp lh kj mq mr ll kn ms mt lp kr mu mv lt mw bi translated">IAM策略</h2><p id="bd68" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj mx kl km kn my kp kq kr mz kt ku kv ij bi translated">首先，需要创建一个IAM策略。出于测试目的，让我们创建一个只能访问一个托管域的站点。</p><p id="9652" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">转到Route53，找到一个区域ID:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div class="gh gi na"><img src="../Images/7861a0ade68a9862d1ac5a840b7d77a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:650/format:webp/0*64NW2ujCPPqeYxyS.png"/></div></figure><p id="6ae3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">转到IAM &gt;策略，添加新策略:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="67fb" class="ml ky iq ng b gy nk nl l nm nn">{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Effect": "Allow",<br/>      "Action": [<br/>        "route53:ChangeResourceRecordSets"<br/>      ],<br/>      "Resource": [<br/>        "arn:aws:route53:::hostedzone/Z07***ZM6"<br/>      ]<br/>    },<br/>    {<br/>      "Effect": "Allow",<br/>      "Action": [<br/>        "route53:ListHostedZones",<br/>        "route53:ListResourceRecordSets"<br/>      ],<br/>      "Resource": [<br/>        "*"<br/>      ]<br/>    }<br/>  ]<br/>}</span></pre><p id="fa0b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">保存它:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/1fa8ba9789adb46b26f05de7cc6f3f43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zWaqZSnk0h4F0EeC.png"/></div></div></figure><p id="ad7e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">找到它，并复制它的ARN:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi np"><img src="../Images/b58d304a11d4ad3bbeb2969171caabdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6O6smnoPRPmhZesc.png"/></div></div></figure><h2 id="e3ef" class="ml ky iq bd kz mm mn dn ld mo mp dp lh kj mq mr ll kn ms mt lp kr mu mv lt mw bi translated">IAM角色</h2><p id="0a5b" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj mx kl km kn my kp kq kr mz kt ku kv ij bi translated">我们的AWS Elastic Kubernetes服务集群是用<code class="fe nq nr ns ng b">ekctl</code>创建的，参见<a class="ae kw" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl/" rel="noopener ugc nofollow" target="_blank"> AWS Elastic Kubernetes服务:集群创建自动化，第2部分Ansible，eksctl </a>帖子。</p><p id="67c0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">附上<a class="ae kw" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html" rel="noopener ugc nofollow" target="_blank"> OIDC </a>:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="3e7a" class="ml ky iq ng b gy nk nl l nm nn">$ eksctl utils associate-iam-oidc-provider --region=us-east-2 --cluster=bttrm-eks-dev-1 --approve</span></pre><p id="9fbe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建服务帐户:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="9744" class="ml ky iq ng b gy nk nl l nm nn">$ eksctl --profile arseniy create iamserviceaccount --name external-dns --cluster bttrm-eks-dev-1 --attach-policy-arn arn:aws:iam::534***385:policy/AllowExternalDNSUpdates --approve --override-existing-serviceaccounts</span></pre><p id="5ad3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">转到AWS CloudFormation，找到由<code class="fe nq nr ns ng b">eksctl</code>创建的堆栈，以及其中的一个新角色:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/de353b40acc4f3d9f0320cc598f3b99f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ztb0bbXE0NbRbOdh.png"/></div></div></figure><p id="0991" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">忸怩这个角色的ARN:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/cc1ba795241ea4998e58843e8ada3568.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ex8NzG8T6qTjTg4Q.png"/></div></div></figure><h1 id="3850" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">外部DNS</h1><p id="df53" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj mx kl km kn my kp kq kr mz kt ku kv ij bi translated">检查您的clutser中是否启用了RBAC:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="9505" class="ml ky iq ng b gy nk nl l nm nn">$ kubectl api-versions | grep rbac.authorization.k8s.io<br/>rbac.authorization.k8s.io/v1<br/>rbac.authorization.k8s.io/v1beta1</span></pre><p id="5fee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个部署，请参见<a class="ae kw" href="https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/aws.md#manifest-for-clusters-with-rbac-enabled" rel="noopener ugc nofollow" target="_blank">清单(对于启用了RBAC的集群)</a>，在其ServiceAccount注释中指定了上面创建的角色，并在<code class="fe nq nr ns ng b">--domain-filter</code>-set your domain<em class="nv">example.com</em>中，因为我们仍然希望只使用一个域来测试ExternalDNS，而不是授予它访问此AWS帐户中所有域的权限:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="b0fc" class="ml ky iq ng b gy nk nl l nm nn">apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: external-dns<br/>  # If you're using Amazon EKS with IAM Roles for Service Accounts, specify the following annotation.<br/>  # Otherwise, you may safely omit it.<br/>  annotations:<br/>    # Substitute your account ID and IAM service role name below.<br/>    eks.amazonaws.com/role-arn: arn:aws:iam::534***385:role/eksctl-bttrm-eks-dev-1-addon-iamserviceaccou-Role1-LOQOWXLJ8SD3<br/>---<br/>apiVersion: rbac.authorization.k8s.io/v1beta1<br/>kind: ClusterRole<br/>metadata:<br/>  name: external-dns<br/>rules:<br/>- apiGroups: [""]<br/>  resources: ["services","endpoints","pods"]<br/>  verbs: ["get","watch","list"]<br/>- apiGroups: ["extensions","networking.k8s.io"]<br/>  resources: ["ingresses"]<br/>  verbs: ["get","watch","list"]<br/>- apiGroups: [""]<br/>  resources: ["nodes"]<br/>  verbs: ["list","watch"]<br/>---<br/>apiVersion: rbac.authorization.k8s.io/v1beta1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  name: external-dns-viewer<br/>roleRef:<br/>  apiGroup: rbac.authorization.k8s.io<br/>  kind: ClusterRole<br/>  name: external-dns<br/>subjects:<br/>- kind: ServiceAccount<br/>  name: external-dns<br/>  namespace: default<br/>---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: external-dns<br/>spec:<br/>  strategy:<br/>    type: Recreate<br/>  selector:<br/>    matchLabels:<br/>      app: external-dns<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: external-dns<br/>    spec:<br/>      serviceAccountName: external-dns<br/>      containers:<br/>      - name: external-dns<br/>        image: k8s.gcr.io/external-dns/external-dns:v0.7.3<br/>        args:<br/>        - --source=service<br/>        - --source=ingress<br/>        - --domain-filter=example.com # will make ExternalDNS see only the hosted zones matching provided domain, omit to process all available hosted zones<br/>        - --provider=aws<br/>        - --policy=upsert-only # would prevent ExternalDNS from deleting any records, omit to enable full synchronization<br/>        - --aws-zone-type=public # only look at public hosted zones (valid values are public, private or no value for both)<br/>        - --registry=txt<br/>        - --txt-owner-id=bttrm-eks-dev-1-external-dns<br/>      securityContext:<br/>        fsGroup: 65534 # For ExternalDNS to be able to read Kubernetes and AWS token files</span></pre><p id="8b53" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">文档没有描述这里的“<code class="fe nq nr ns ng b">txt-owner-id</code>”选项到底是什么，所以它定义了一个TXT-record值，供ExternalDNS在创建新的DNS记录时使用，以将它们标记为“由ExternalDNS拥有”。</p><p id="53a1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，如果我们已经有一个子域记录<em class="nv">subdomain.example.com</em>，并且它没有这样一个由ExternalDNS添加的TXT记录，那么当使用<code class="fe nq nr ns ng b">host: subdomain.example.com</code>创建一个新的入口时，ExternalDNS将不会对这样一个现有的记录做任何事情。</p><p id="d881" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">稍后我们将播放这些TXT记录。</p><p id="5858" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，部署ExternalDNS资源:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="6b16" class="ml ky iq ng b gy nk nl l nm nn">$ kubectl apply -f ~/Work/Temp/EKS/external-dns-deployment.yaml<br/>Warning: kubectl apply should be used on resource created by either kubectl create — save-config or kubectl apply<br/>serviceaccount/external-dns configured<br/>clusterrole.rbac.authorization.k8s.io/external-dns created<br/>clusterrolebinding.rbac.authorization.k8s.io/external-dns-viewer created<br/>deployment.apps/external-dns created</span></pre><p id="bb10" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查吊舱:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="6a11" class="ml ky iq ng b gy nk nl l nm nn">$ kubectl get pod -l app=external-dns<br/>NAME READY STATUS RESTARTS AGE<br/>external-dns-75894b84b-2qnr5 1/1 Running 0 2m2s</span></pre><h2 id="ca0e" class="ml ky iq bd kz mm mn dn ld mo mp dp lh kj mq mr ll kn ms mt lp kr mu mv lt mw bi translated">Kubernetes入口和AWS应用负载平衡器</h2><p id="5ec8" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj mx kl km kn my kp kq kr mz kt ku kv ij bi translated">让我们去检查我们的外部。</p><p id="3d7e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建部署和服务:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="b7bc" class="ml ky iq ng b gy nk nl l nm nn">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: test-deployment<br/>  labels:<br/>    app: test<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: test<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: test<br/>    spec:<br/>      containers:<br/>      - name: nginx<br/>        image: nginx:1.14.2<br/>        ports:<br/>        - containerPort: 80<br/>      dnsPolicy: None<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: test-svc<br/>spec:<br/>  type: NodePort<br/>  selector:<br/>    app: test<br/>  ports:<br/>    - protocol: TCP<br/>      port: 80<br/>      targetPort: 80</span></pre><p id="b847" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个入口，在其注释<code class="fe nq nr ns ng b">external-dns.alpha.kubernetes.io/hostname</code>中指定所需的域(或在<code class="fe nq nr ns ng b">spec.rules.host</code>):</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="50ea" class="ml ky iq ng b gy nk nl l nm nn">---<br/>apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: test-ingress<br/>  annotations:<br/>    kubernetes.io/ingress.class: alb<br/>    alb.ingress.kubernetes.io/scheme: internet-facing<br/>    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}]'<br/>    alb.ingress.kubernetes.io/inbound-cidrs: 0.0.0.0/0<br/>    external-dns.alpha.kubernetes.io/hostname: test-dns.example.com<br/>spec:<br/>  rules:<br/>  - http:<br/>      paths:<br/>      - backend:<br/>          serviceName: test-svc<br/>          servicePort: 80</span></pre><p id="8892" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署它:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="998c" class="ml ky iq ng b gy nk nl l nm nn">$ kubectl apply -f ~/Work/devops-kubernetes/tests/test-deployment.yaml<br/>deployment.apps/test-deployment created<br/>service/test-svc created<br/>ingress.extensions/test-ingress created</span></pre><p id="9466" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查入口:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="8084" class="ml ky iq ng b gy nk nl l nm nn">$ kubectl get ingress test-ingress<br/>NAME HOSTS ADDRESS PORTS AGE<br/>test-ingress * e172ad3e-default-testingre-5bb0–1920769979.us-east-2.elb.amazonaws.com 80 28s</span></pre><p id="4006" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Pod的日志:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="f469" class="ml ky iq ng b gy nk nl l nm nn">$ kubectl logs external-dns-75894b84b-2qnr5<br/>…<br/>time=”2020–11–13T12:31:13Z” level=info msg=”Desired change: CREATE test-dns.example.com A [Id: /hostedzone/Z07***ZM6]”<br/>time=”2020–11–13T12:31:13Z” level=info msg=”Desired change: CREATE test-dns.example.com TXT [Id: /hostedzone/Z07***ZM6]”<br/>time=”2020–11–13T12:31:13Z” level=info msg=”2 record(s) in zone example.com. [Id: /hostedzone/Z07***ZM6] were successfully updated”</span></pre><p id="05e8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">和DNS:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/70fa176041d9d7def7168a99d6640376.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*geXz3WtEbvciwA90.png"/></div></div></figure><p id="6dbb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意带有“<code class="fe nq nr ns ng b">heritage=external-dns,external-dns/owner=bttrm-eks-dev-1-external-dns,external-dns/resource=ingress/default/test-ingress</code>”值的TXT这里使用了<code class="fe nq nr ns ng b">txt-owner-id</code>参数。</p><p id="f564" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查域:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="6ed5" class="ml ky iq ng b gy nk nl l nm nn">$ dig test-dns.example.com +short<br/>3.133.54.4<br/>13.59.209.195</span><span id="dade" class="ml ky iq ng b gy nx nl l nm nn">$ curl -I test-dns.example.com.com<br/>HTTP/1.1 200 OK</span></pre><h2 id="d4a8" class="ml ky iq bd kz mm mn dn ld mo mp dp lh kj mq mr ll kn ms mt lp kr mu mv lt mw bi translated">记录更新和apex域</h2><p id="080f" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj mx kl km kn my kp kq kr mz kt ku kv ij bi translated">要允许外部DNS更新和删除记录，请在其部署中删除<code class="fe nq nr ns ng b">--policy=upsert-only</code>选项。</p><p id="a5a2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，根级别(apex)域必须没有任何TXT记录，否则，ExternalDNS不会更新它。更重要的是，您必须根本没有根级域名的现有记录(但我们将在下面看到必须更新现有记录)。</p><p id="a33e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我们的例子中，我们有一个用于Google验证的TXT记录，我必须删除它。</p><p id="c233" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更新入口指定一个子域和一个根域:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="2eab" class="ml ky iq ng b gy nk nl l nm nn">---<br/>apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: test-ingress<br/>  annotations:<br/>    kubernetes.io/ingress.class: alb<br/>    alb.ingress.kubernetes.io/scheme: internet-facing<br/>    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}]'<br/>    alb.ingress.kubernetes.io/inbound-cidrs: 0.0.0.0/0<br/>    external-dns.alpha.kubernetes.io/hostname: test-dns.example.com, example.com<br/>spec:<br/>  rules:<br/>  - http:<br/>      paths:<br/>      - backend:<br/>          serviceName: test-svc<br/>          servicePort: 80</span></pre><p id="5401" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更新并检查入口:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="bd54" class="ml ky iq ng b gy nk nl l nm nn">$ kubectl get ingress test-ingress<br/>NAME HOSTS ADDRESS PORTS AGE<br/>test-ingress * e172ad3e-default-testingre-5bb0–456442783.us-east-2.elb.amazonaws.com 80 30m</span></pre><p id="760b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查日志:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="cff9" class="ml ky iq ng b gy nk nl l nm nn">time=”2020–11–14T12:47:16Z” level=info msg=”Desired change: CREATE example.com A [Id: /hostedzone/Z07***ZM6]”<br/>time=”2020–11–14T12:47:16Z” level=info msg=”Desired change: CREATE example.comm TXT [Id: /hostedzone/Z07***ZM6]”<br/>time=”2020–11–14T12:47:16Z” level=info msg=”2 record(s) in zone example.com. [Id: /hostedzone/Z07***ZM6] were successfully updated”</span></pre><p id="c1fb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">和域本身:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/cce0c21814107c87cbabe04c8186cad9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lxCjA9tQwLxPi06L.png"/></div></div></figure><h2 id="c0b9" class="ml ky iq bd kz mm mn dn ld mo mp dp lh kj mq mr ll kn ms mt lp kr mu mv lt mw bi translated">更新现有的根级别域</h2><p id="8bac" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj mx kl km kn my kp kq kr mz kt ku kv ij bi translated">我想尝试更新现有域名的第一件事是添加一个TXT-record。</p><p id="cfa4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，假设我们在1.1.1.1记录中有一个<em class="nv">example.com</em>域，我们不想删除它，而是需要在部署新入口时进行更新。</p><p id="41d8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此时，如果只是将<em class="nv">example.com</em>添加到入口，则ExternalDNS不会更新现有记录，因为没有合适的TXT-record向ExternalDNS表明该记录是他“拥有”的。</p><p id="e99e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，我们的想法是添加带有<code class="fe nq nr ns ng b">txt-owner-id</code>的TXT，即<code class="fe nq nr ns ng b">heritage=external-dns,external-dns/owner=bttrm-eks-dev-1-external-dns,external-dns/resource=ingress/default/test-ingress</code>，然后部署带有<code class="fe nq nr ns ng b">host</code>设置的入口。</p><p id="8d4b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是在这种情况下，ExternalDNS在我能够部署入口之前删除了现有的记录。</p><p id="373c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，流程可以是下一步:</p><ol class=""><li id="3360" class="lv lw iq ka b kb kc kf kg kj nz kn oa kr ob kv oc md me mf bi translated">我们有域<em class="nv">example.com</em>与在一个1.1.1.1在路由53</li><li id="2a4e" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv oc md me mf bi translated">将使用指定的域部署新入口</li><li id="a77a" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv oc md me mf bi translated">ExternalDNS不会更新现有的记录1.1.1.1，因为没有“绑定”TXT记录</li><li id="2d76" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv oc md me mf bi translated">然后，我们将手动创建TXT，在下一次检查时，ExternalDNS将看到它，并认为该记录由他管理，他有权限管理它，并将使用入口URL的适当值更新它</li></ol><p id="535c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们检查一下。</p><p id="608f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">删除之前测试中ExternalDNS已经创建的所有记录，在1.1.1.1中手动添加<em class="nv">example.com</em>，部署带有<em class="nv">example.com</em>集合的入口——external DNS会说“<strong class="ka ir"> <em class="nv">所有记录都已经是最新的</em> </strong>”因为没有绑定TXT。</p><p id="cd2d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Route53中的记录现在看起来是这样的:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/89d8a34004feb152738745d8d3c945f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wMJ7rgXzYWA44RhS.png"/></div></div></figure><p id="c511" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，添加TXT:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/34eda8195d97ac46a073a474b88763e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*UxUXh72lRhYgLBxe.png"/></div></figure><p id="c04a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并检查日志:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="17fd" class="ml ky iq ng b gy nk nl l nm nn">time=”2020–11–14T13:39:44Z” level=info msg=”Desired change: UPSERT example.com A [Id: /hostedzone/Z07***ZM6]”<br/>time=”2020–11–14T13:39:44Z” level=info msg=”Desired change: UPSERT example.com TXT [Id: /hostedzone/Z07***ZM6]”<br/>time=”2020–11–14T13:39:45Z” level=info msg=”2 record(s) in zone example.com. [Id: /hostedzone/Z07***ZM6] were successfully updated”</span></pre><p id="9363" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ExternalDNS现在执行了<code class="fe nq nr ns ng b"><a class="ae kw" href="https://docs.aws.amazon.com/Route53/latest/APIReference/API_ChangeResourceRecordSets.html" rel="noopener ugc nofollow" target="_blank">UPSERT</a></code>调用，而不是<code class="fe nq nr ns ng b">DELETE</code>或<code class="fe nq nr ns ng b">CREATE</code>，并且记录按照我们的计划进行了更新:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/80e93292927cbe05fa4bc8c504156610.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QGI886HZy797tBog.png"/></div></div></figure><p id="eda6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成了。</p></div><div class="ab cl of og hu oh" role="separator"><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok"/></div><div class="ij ik il im in"><p id="ccc4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nv">最初发表于</em> <a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-update-aws-route53-dns-from-an-ingress/" rel="noopener ugc nofollow" target="_blank"> <em class="nv"> RTFM: Linux，devo PSисистемноеадмииитиованиииованиде</em>T25<em class="nv">。</em></a></p></div></div>    
</body>
</html>