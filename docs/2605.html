<html>
<head>
<title>Setup a private registry on K3s</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在K3s上设置私有注册表</h1>
<blockquote>原文：<a href="https://itnext.io/setup-a-private-registry-on-k3s-f30404f8e4d3?source=collection_archive---------1-----------------------#2019-06-23">https://itnext.io/setup-a-private-registry-on-k3s-f30404f8e4d3?source=collection_archive---------1-----------------------#2019-06-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/292b2a2c06a94676eb7b5114fc349282.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5n_5yQpDOzW9Zzuq.jpg"/></div></div></figure><p id="c86b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我最近需要建立一个私人注册中心来展示Kubernetes的一些特性。轻量级Kubernetes K3s上的Docker-registry舵图很好地服务于我的目的。</p><h2 id="6f32" class="kz la it bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">1.创建证书</h2><p id="49c3" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">使用<a class="ae lx" href="https://github.com/cloudflare/cfssl" rel="noopener ugc nofollow" target="_blank"> cfssl </a>工具创建一个自签名证书。</p><p id="9983" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">准备以下myca.json文件</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="d3e7" class="kz la it md b gy mh mi l mj mk">{<br/>   "CN": "k3s",<br/>   "hosts": [ "k3s" ],<br/>   "key": {<br/>      "algo": "rsa",<br/>      "size": 2048<br/>   },<br/>   "names": [<br/>      {<br/>          "C": "SG",<br/>          "ST": "SG",<br/>          "L": "Singapore"<br/>      }<br/>  ]<br/>}</span></pre><p id="f23a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">生成自签名根ca证书，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="044d" class="kz la it md b gy mh mi l mj mk">cfssl gencert -initca myca.json | cfssljson -bare myca</span></pre><p id="f0a9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">创建以下serverRuest.json文件，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="54ad" class="kz la it md b gy mh mi l mj mk">{<br/>   "CN": "registry",<br/>   "hosts": [ "ubuntu" ],<br/>   "key": {<br/>      "algo": "rsa",<br/>      "size": 2048<br/>   }<br/>}</span></pre><p id="104f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">使用下面的命令生成服务器证书，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="e967" class="kz la it md b gy mh mi l mj mk">cfssl gencert -ca=myca.pem -ca-key=myca-key.pem -config=ca-config.json -profile=server -hostname=ubuntu serverRequest.json | cfssljson -bare registry</span></pre><p id="2e79" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在我们已经创建了证书registry.pem和密钥文件registry-key.pem。在K3s集群中创建Kubernetes的TLS秘密，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="6bab" class="kz la it md b gy mh mi l mj mk">kubectl -n kube-system create secret tls registry-ingress-tls --cert=registry.pem --key=registry-key.pem</span></pre><h2 id="9ff2" class="kz la it bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">2.展开舵图</h2><p id="ee83" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">创建以下helmchart CRD注册表</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="670f" class="kz la it md b gy mh mi l mj mk">apiVersion: helm.cattle.io/v1<br/>kind: HelmChart<br/>metadata:<br/>  name: docker-registry<br/>  namespace: kube-system<br/>spec:<br/>  chart: stable/docker-registry<br/>  targetNamespace: kube-system<br/>  valuesContent: |-<br/>    service:<br/>      name: registry<br/>      type: LoadBalancer<br/>    persistence:<br/>      enabled: true<br/>    tlsSecretName: registry-ingress-tls</span></pre><p id="d246" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我使用的是最新的K3s(v 0 . 6 . 1)。helm chart的CRD API版本略有变化。<em class="ml">(感谢K3s团队，他们在我为V0.6.0报告后立即修复了舵图问题，并发布了V0.6.1) </em></p><p id="01bc" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">应用它。我们正在运行docker-registry。通过以下命令验证docker注册表是否正常工作，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="8cdc" class="kz la it md b gy mh mi l mj mk">curl -ks https://ubuntu:5000/v2/_catalog</span></pre><p id="4953" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">由于我使用的是K3s负载平衡器，主机上的端口5000是可用的。</p><h2 id="e2eb" class="kz la it bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">3.使用Docker推送图像</h2><p id="9ecb" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">在我们将图像发送到私有注册表之前。我们需要使CA对Docker引擎是可信的。使用CA的证书更新设置，<code class="fe mm mn mo md b">myca.pem</code></p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="129b" class="kz la it md b gy mh mi l mj mk">sudo mkdir -p /etc/docker/certs.d/ubuntu:5000<br/>sudo cp myca.pem /etc/docker/certs.d/ubuntu:5000/ca.crt</span></pre><p id="09ba" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在我们可以构建映像并将映像推送到我们设置的私有注册中心。</p><h2 id="3e0a" class="kz la it bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">4.使用K3s集群中的映像</h2><p id="290a" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">类似地，要使用私有Docker注册表中的K3s映像，首先需要信任CA的证书。似乎目前containerd引擎无法从配置中定义受信任的CA。</p><p id="9b87" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">但是，可以通过将CA放入主机系统的可信CA链中来解决这个问题。运行以下命令。</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="d264" class="kz la it md b gy mh mi l mj mk">sudo mkdir -p /usr/local/share/ca-certificates/myregistry</span><span id="ff9c" class="kz la it md b gy mp mi l mj mk">sudo cp registry/myca.pem /usr/local/share/ca-certificates/myregistry/myca.crt</span><span id="7c73" class="kz la it md b gy mp mi l mj mk">sudo update-ca-certificates</span></pre><p id="b571" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">注意，特定目录下的证书必须以扩展名<code class="fe mm mn mo md b">crt</code>命名。重新启动K3s服务以使更改生效。</p><p id="8a44" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在我们设置注册表，里面的图片可以在K3s集群中引用并运行。</p></div></div>    
</body>
</html>