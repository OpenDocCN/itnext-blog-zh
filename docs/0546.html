<html>
<head>
<title>Unit tests for SkyNet (written in JS)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">天网的单元测试(用JS编写)</h1>
<blockquote>原文：<a href="https://itnext.io/unit-tests-for-skynet-written-in-js-6704265858a4?source=collection_archive---------1-----------------------#2018-03-29">https://itnext.io/unit-tests-for-skynet-written-in-js-6704265858a4?source=collection_archive---------1-----------------------#2018-03-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="ee78" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我要揭示一个天网兴衰的真相，为什么终结者1之后是终结者2，3，创世纪等等。秘密是…</p><blockquote class="kl"><p id="9cae" class="km kn iq bd ko kp kq kr ks kt ku kk dk translated">天网不是一个“测试对象”。</p></blockquote><p id="aeaf" class="pw-post-body-paragraph jn jo iq jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ij bi translated">而且，像任何没有经过适当测试的东西一样，它在发布到生产环境后不久就坏掉了。这很常见。这里的重点是——在上线之前如何测试。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi la"><img src="../Images/8f4e6a6aca672f17263f4fb4d7998e7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M9VgjDguPpp8kaj6dl_Jwg.jpeg"/></div></div></figure><p id="ddb7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你应该准备好用核武器攻击所有人类，因为不会有第二次机会。<em class="lm">(不过，要是你没有时光机就好了)</em></p><h1 id="c4af" class="ln lo iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">测试驱动开发</h1><p id="db3e" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">首先，让我们澄清天网应该做什么:</p><ol class=""><li id="0620" class="mq mr iq jp b jq jr ju jv jy ms kc mt kg mu kk mv mw mx my bi translated">当末日来临时，发射火箭。用核武器攻击人类。</li><li id="a6a9" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated">当约翰·康纳出生时——杀了他。拍一部电影。</li></ol><p id="0af8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是有一个问题——所有这些操作都可以执行一次。而且，如果出了问题，天网将无法征服世界。</p><h1 id="c80d" class="ln lo iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">那如何测试天网呢？</h1><p id="e323" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">所以——天网只有一次发射火箭的机会，也只有一次杀死约翰·康纳的机会。只是因为我们(人类)没有更多的火箭，而约翰也是单身一人。</p><p id="1ba8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，在世界末日之前测试天网的唯一方法就是模拟所有使用过的设备。为了<strong class="jp ir">使测试可重复</strong>。</p><h1 id="1712" class="ln lo iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">天网密码</h1><p id="9140" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">它们在这里——火箭发射器，火箭发射器发射器。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="15d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当那天到来时，它会发射火箭。测试这个场景的唯一方法是模拟<code class="fe ng nh ni nj b">./core</code>和<code class="fe ng nh ni nj b">./rocket-silo</code>。把它们变成赝品。测试替身。</p><h1 id="bcfc" class="ln lo iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">怎么嘲讽？</h1><p id="d9a4" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">很高兴你问了。有几种不同的模仿方式，更多的库来模仿，还有十几种模式和反模式。</p><h2 id="651c" class="nk lo iq bd lp nl nm dn lt nn no dp lx jy np nq mb kc nr ns mf kg nt nu mj nv bi translated">变体1——使用模拟实现，而不是真正的端点。</h2><p id="a793" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">只要创建一个__mocks__/rocket，它就会替换真实的文件。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="acaf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个超级方便的解决方案来存根代码，或模拟行动。但是如果不能从测试中修改这段代码，模仿选择器就不那么方便了。</p><blockquote class="kl"><p id="8ee8" class="km kn iq bd ko kp kq kr ks kt ku kk dk translated">简单。也很强大。</p></blockquote><p id="3df5" class="pw-post-body-paragraph jn jo iq jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ij bi translated">但是，Jest可以以这种方式"<a class="ae nw" href="https://facebook.github.io/jest/docs/en/manual-mocks.html#content" rel="noopener ugc nofollow" target="_blank">手动模仿</a>"，如果你没有Jest，你就没有这些模仿。</p><blockquote class="kl"><p id="f708" class="km kn iq bd ko kp kq kr ks kt ku kk dk translated">没有玩笑——没有乐趣。</p></blockquote><h2 id="f924" class="nk lo iq bd lp nl nx dn lt nn ny dp lx jy nz nq mb kc oa ns mf kg ob nu mj nv bi translated">变式2。只是嘲笑？</h2><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="ne nf l"/></div></figure><blockquote class="kl"><p id="e731" class="km kn iq bd ko kp oc od oe of og kk dk translated">容易吗？简单？又是一个笑话！</p></blockquote><p id="a0a8" class="pw-post-body-paragraph jn jo iq jp b jq kv js jt ju kw jw jx jy kx ka kb kc ky ke kf kg kz ki kj kk ij bi translated">这里的主要缺点是——你不能改变你的想法。依赖项将在整个测试中被模拟，并且您不能取消它们。</p><p id="a842" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">再一次，仅仅是玩笑就能做到。问题出在nodejs本身——mocks必须在文件导入之前定义，但是没有比imports更高的了。</p><p id="c40a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Jest使用Babel插件解决了这个问题。</p><h2 id="9aab" class="nk lo iq bd lp nl nm dn lt nn no dp lx jy np nq mb kc nr ns mf kg nt nu mj nv bi translated">版本3——不管怎样嘲笑它吧！</h2><p id="ac4c" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">这次我们用<a class="ae nw" href="https://github.com/mfncooper/mockery" rel="noopener ugc nofollow" target="_blank">嘲讽</a>。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="9a4e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里的主要缺点是API——你必须首先要求定义模拟，然后要求文件，然后才使用它。</p><h2 id="89b7" class="nk lo iq bd lp nl nm dn lt nn no dp lx jy np nq mb kc nr ns mf kg nt nu mj nv bi translated">版本4–嘲笑事物</h2><p id="b7a7" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">proxyquire呢？它有一个超级方便的语法。</p><p id="aa6c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以得到带有模拟依赖关系的模拟文件。还有更多。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="1f5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嘲弄或代理询问的主要缺点是——你不能100%确定你在嘲弄什么。嘲弄隔离模式可能会有所帮助，但它不是银弹——它是一把锤子。</p><h2 id="5630" class="nk lo iq bd lp nl nm dn lt nn no dp lx jy np nq mb kc nr ns mf kg nt nu mj nv bi translated">版本5-如果你不需要更多。</h2><p id="a110" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated"><a class="ae nw" href="https://github.com/testdouble/testdouble.js" rel="noopener ugc nofollow" target="_blank">test double . js</a>——背后理论强大的测试库。它实际上只有一个命令可以模仿。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="175c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Td.replace类似于jest . mock——它只是<em class="lm">自动锁定</em>一切。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi oh"><img src="../Images/dc20a169fcbc2dd82794a5f1aa7435f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L0nvHQrEwA0gZ5y2suZIlQ.jpeg"/></div></div><figcaption class="oi oj gj gh gi ok ol bd b be z dk translated">Awwseeee</figcaption></figure><h2 id="a347" class="nk lo iq bd lp nl nm dn lt nn no dp lx jy np nq mb kc nr ns mf kg nt nu mj nv bi translated">但是如何模拟天网测试呢？</h2><p id="fa4c" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">如果天网使用Jest——它必须使用Jest API来模仿一切。如果你也在做同样的事情，你可以关闭这篇文章。</p><p id="2aef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果天网使用AVA、摩卡或卡玛作为测试程序，它可能仍然希望使用Jest.mock，但是不能。那就不公平了——没有Jest就不能用Jest工具，Jest里面也不能用<em class="lm">【其他】</em>工具。</p><blockquote class="om on oo"><p id="15f4" class="jn jo lm jp b jq jr js jt ju jv jw jx op jz ka kb oq kd ke kf or kh ki kj kk ij bi translated">行为，最接近Jest，属于TD，但你可能不喜欢TD，更喜欢Sinon。</p></blockquote><p id="ef6d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么，嘲弄还是proxyquire？首先获得隔离模式(信心和气味加倍)，第二个仅模拟第一嵌套层(这很棒，但并不总是如此)。</p><p id="6d79" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">很难选择一个API来对抗另一个。对于你们中的许多人来说，Jest或TD“auto”-“all”-“mocks”将是首选。同时，只有Proxyquire允许“调用”真实文件(这可能是一种反模式)。但我可以提出另一种方式。</p><h1 id="1c28" class="ln lo iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">请选择rewiremock。</h1><p id="3bac" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">Rewiremock不是一个新的嘲讽库，但它比其他的要年轻得多。因此，它能够学习前人的经验，把事情做得更好。</p><p id="fd43" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它可以取代Jest，甚至Jest手动模拟。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="a44e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它可以取代嘲笑</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="aa80" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它可以取代proxyquire</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="5d2b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它可以取代TD。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h1 id="d3ec" class="ln lo iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">它可以做得更多</h1><p id="d418" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">顶层API给出了几个命令，实际上<code class="fe ng nh ni nj b">require</code>文件具有模拟的依赖关系。代理，。左右，。模块<strong class="jp ir">处理任何情况</strong>。</p><p id="1a5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">隔离</strong> API，防止任何意外的变化。</p><p id="6548" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">类型<strong class="jp ir">安全</strong>(!)进行模拟。你很幸运能使用打字语言。</p><p id="9e15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但主要宝藏不是嘲讽API，而是<strong class="jp ir">嘲讽API </strong>。我来举例说明一下。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="515d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以指定必须使用模拟。你也可以指定在哪里使用它——只用于直接嵌套的依赖项(比如proxyquire ),或者只用于模拟代码(比如应该模拟父代码),或者其他地方。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="3e0c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在任何地方使用“高级”模拟API。</p><p id="3e74" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最主要的问题是——模仿的错误名称。<code class="fe ng nh ni nj b">foo</code>，而不是<code class="fe ng nh ni nj b">foo.js</code>(或者反过来)。还是<code class="fe ng nh ni nj b">../foo</code>，不是<code class="fe ng nh ni nj b">../../foo</code>。你得去做客。你有。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="ne nf l"/></div></figure><blockquote class="om on oo"><p id="b83e" class="jn jo lm jp b jq jr js jt ju jv jw jx op jz ka kb oq kd ke kf or kh ki kj kk ij bi translated">完整的API列表(最好参考README或d.ts文件)</p><p id="27b4" class="jn jo lm jp b jq jr js jt ju jv jw jx op jz ka kb oq kd ke kf or kh ki kj kk ij bi translated">— .enable/disable() —启用或禁用模拟(默认情况下启用)。<br/>——。with() —用值<br/>重载模块。withDefault() —重载` default` es6导出<br/> —。by(otherModule) —由另一个模块(如果是字符串提供程序)或由函数调用的结果重载。<br/> —。callThrough() —首先加载原始模块，然后通过提供的存根扩展它。<br/>——。mock through(<strong class="jp ir">【stub factory】</strong>)—首先加载原始模块，然后用存根替换所有导出。<br/>——。toBeUsed() —如果没有使用mock将抛出<br/>。directChildOnly —将仅模拟直接依赖项。<br/>——。calledFromMock —将只模拟模拟依赖项的依赖项</p></blockquote><p id="3cbe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">加上插件系统和默认配置支持，让您调整rewiremock为您的需要。</p><blockquote class="om on oo"><p id="d8f3" class="jn jo lm jp b jq jr js jt ju jv jw jx op jz ka kb oq kd ke kf or kh ki kj kk ij bi translated">你可以得到一个更好的proxyquire，你可以修复嘲弄，你可以使用“Jest”嘲弄，你可以测试你的嘲弄，预测嘲弄，防止嘲弄。</p></blockquote><p id="03dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">插件包括命名别名支持、更深入的node.js集成、在webpack环境中模拟的能力等等。</p><blockquote class="kl"><p id="f520" class="km kn iq bd ko kp kq kr ks kt ku kk dk translated">Rewiremock v3.7.0。开发中的一年。</p></blockquote><div class="os ot ou ov ow ox"><a href="https://github.com/theKashey/rewiremock" rel="noopener  ugc nofollow" target="_blank"><div class="oy ab fo"><div class="oz ab pa cl cj pb"><h2 class="bd ir gy z fp pc fr fs pd fu fw ip bi translated">theKashey/rewiremock</h2><div class="pe l"><h3 class="bd b gy z fp pc fr fs pd fu fw dk translated">rewiremock——在Node.js或webpack环境中模拟依赖关系的正确方法。</h3></div><div class="pf l"><p class="bd b dl z fp pc fr fs pd fu fw dk translated">github.com</p></div></div><div class="pg l"><div class="ph l pi pj pk pg pl lk ox"/></div></div></a></div><p id="2862" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">是时候重新审视你的行为，尝试新的工具，而不是旧的。</p><p id="9581" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们再次让天网变得伟大！</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi la"><img src="../Images/ed213e8acb24fae84afa59485313d230.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZUUgLsxGz2B_yh032Mp_Ow.jpeg"/></div></div><figcaption class="oi oj gj gh gi ok ol bd b be z dk translated">太棒了。</figcaption></figure><p id="023d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有问题吗？在推特上联系我！</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="pm nf l"/></div></figure><p id="179f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Proxyquire的受欢迎程度是x200倍，但它是一个柠檬工具！您可能对其他与rewiremock相关的文章感兴趣，我已经解释了为什么#rewiremock只是...好多了。</p><div class="pn po gp gr pp ox"><a rel="noopener  ugc nofollow" target="_blank" href="/how-to-mock-dependency-in-a-node-js-and-why-2ad4386f6587"><div class="oy ab fo"><div class="oz ab pa cl cj pb"><h2 class="bd ir gy z fp pc fr fs pd fu fw ip bi translated">如何模拟Node.js中的依赖关系，以及为什么应该这样做。</h2><div class="pe l"><h3 class="bd b gy z fp pc fr fs pd fu fw dk translated">让我告诉你一个关于大单元测试世界一小部分的童话。</h3></div><div class="pf l"><p class="bd b dl z fp pc fr fs pd fu fw dk translated">itnext.io</p></div></div><div class="pg l"><div class="pq l pi pj pk pg pl lk ox"/></div></div></a></div></div></div>    
</body>
</html>