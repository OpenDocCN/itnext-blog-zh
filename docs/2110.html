<html>
<head>
<title>Passwordless SMS Authentication: Backend</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无密码短信认证:后端</h1>
<blockquote>原文：<a href="https://itnext.io/passwordless-sms-authentication-backend-9932391c49dc?source=collection_archive---------3-----------------------#2019-04-02">https://itnext.io/passwordless-sms-authentication-backend-9932391c49dc?source=collection_archive---------3-----------------------#2019-04-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/7bc5491dc767a9cd8006d9c3c1f3a6f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H6PKKc-Z0-C5g9milwyxiw.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">格陵兰上空的某处</figcaption></figure><p id="ced5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在我的上一篇文章<a class="ae la" rel="noopener ugc nofollow" target="_blank" href="/passwordless-sms-authentication-the-basics-fdf9dbecab04">无密码短信认证:基础知识</a>中，我谈到了认证的三个因素和使用你拥有的东西，比如一部无需密码就能接收短信进行认证的手机。提供无密码短信认证仍然是最简单的方法之一。在本文中，我们将通过<strong class="ke ir">使用Amazon Cognito </strong>实现自定义无密码短信认证流程的后端解决方案。</p><h1 id="766c" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">解决办法</h1><p id="9fc3" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">这个解决方案包括使用<strong class="ke ir">三个Lambda函数触发器</strong>(加上一个自动确认用户电话号码为用户名的函数)建立一个带有自定义身份验证质询流的Cognito用户池。至少可以说，由于创建这个自定义身份验证流的过程有许多移动部分，所以我构建了一个单击式解决方案，这样您就可以通过<strong class="ke ir"> AWS无服务器应用程序库</strong>部署整个后端。利用部署该解决方案节省的时间，我将向您介绍每个功能以及每个功能在登录流程中扮演的角色。</p><h1 id="4d87" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">解决方案概述</h1><p id="721a" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated"><em class="me">顺便说一句——根据文档，这是通过Amazon Cognito用户池使用</em> <a class="ae la" href="https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-lambda-challenge.html" rel="noopener ugc nofollow" target="_blank"> <em class="me">自定义身份验证质询Lambda触发器</em> </a> <em class="me">实现无密码短信(或电子邮件)的最佳实践。</em></p><p id="7f4b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">该解决方案遵循上述文档中概述的流程。我们将使用Amazon Cognito用户池和一组AWS Lambda函数作为触发器来完成一个<a class="ae la" href="https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-lambda-challenge.html" rel="noopener ugc nofollow" target="_blank">定制认证流程</a>。我们将使用亚马逊社交网络通过短信向用户发送一次性密码。下面是显示每个Lambda函数的自定义身份验证流程图。我们将在下一篇文章中构建“应用程序用户”客户端解决方案。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mf"><img src="../Images/6817a78a1064155eea1a57dbab9351d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B_uF6bcP0MlFrO4tsR4OJw.png"/></div></div></figure><p id="3a9d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">该图描述了移动/web用户完成授权流程所经历的以下步骤。</p><p id="f3b7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">1.用户在自定义注册/登录页面上输入他们的电话号码，然后发送到您的Amazon Cognito用户池。</p><p id="aa85" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">2.用户池调用“<em class="me">定义授权挑战</em>”Lambda函数。这个Lambda函数确定需要创建哪个自定义质询。</p><p id="8c1e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">3.用户池调用“<em class="me">Create Auth Challenge</em>Lambda函数。这个Lambda函数生成一个秘密登录代码，并使用Amazon SNS作为传输服务，通过SMS将这个代码发送到用户的移动设备。</p><p id="8451" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">4.用户在他们的手机上检索秘密登录代码，并将其输入到自定义登录页面，然后该代码被发送回来，您的用户池调用“<em class="me">验证身份验证质询响应</em>”Lambda函数来验证用户的响应。</p><p id="411b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">5.用户池再次调用“<em class="me">定义身份验证质询</em>”Lambda函数来验证质询已被成功回答，并且不需要进一步的质询。该函数在其对用户池的响应中包含“issueTokens: true”。用户池现在认为用户已经过身份验证，并在对用户的最终响应中发送有效的JSON Web令牌(jwt)。</p><p id="fe5b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">注意:对于使用原生AWS SDK的原生iOS和Android开发人员，您不需要担心处理JWT令牌，因为AWSMobileClient会通过将令牌传递给Cognito Identity Pool来交换AWS凭证，从而为您管理所有这一切。在下一篇文章中，我将实现一个iOS原生应用程序，从头到尾都遵循这个流程，并使用mobile SDK for iOS来检索AWS凭据，以交换使用Amazon Cognito身份池接收的JWT令牌。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="fd53" class="lb lc iq bd ld le mr lg lh li ms lk ll lm mt lo lp lq mu ls lt lu mv lw lx ly bi translated">开始—后端</h1><h2 id="cdbb" class="mw lc iq bd ld mx my dn lh mz na dp ll kn nb nc lp kr nd ne lt kv nf ng lx nh bi translated">通过<a class="ae la" href="https://aws.amazon.com/serverless/serverlessrepo/" rel="noopener ugc nofollow" target="_blank"> AWS无服务器应用程序库</a>部署后端</h2><ol class=""><li id="f5f5" class="ni nj iq ke b kf lz kj ma kn nk kr nl kv nm kz nn no np nq bi translated">启动<a class="ae la" href="https://console.aws.amazon.com/lambda/home?region=us-east-1#/create/app?applicationId=arn:aws:serverlessrepo:us-east-1:552623489034:applications/amplify-passwordless-sms-auth" rel="noopener ugc nofollow" target="_blank">无服务器应用程序库</a></li></ol><p id="c794" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">2.提供一个<strong class="ke ir">应用名称</strong>和<strong class="ke ir">用户池名称</strong>并勾选“<em class="me">我确认… </em>”</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/ace3bdd53ce32414834e2f236ccb97f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t4L0PhB6xIL-0ecTXxwcdQ.png"/></div></div></figure><p id="0c59" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">3.<strong class="ke ir">选择部署</strong>。</p><p id="2bd9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">以下是上述三个步骤的截屏:</p><figure class="mg mh mi mj gt jr"><div class="bz fp l di"><div class="ns nt l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae la" href="https://youtu.be/WYaES9vJYuU" rel="noopener ugc nofollow" target="_blank">https://youtu.be/WYaES9vJYuU</a></figcaption></figure><p id="df51" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">通过AWS无服务器应用程序存储库进行部署会在您的帐户上触发Amazon CloudFormation堆栈创建，并开始在当前区域创建资源。这些资源包括一个Cognito用户池、四个Lambda函数和与这些资源交互的权限。您总是可以在CloudFormation控制台中看到已部署的CloudFormation堆栈中的模板代码。</p><h1 id="28ae" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">试验</h1><p id="1836" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">通过无服务器存储库部署您的解决方案后，您可以使用本<a class="ae la" href="https://github.com/mobilequickie/amplify-passwordless-sms-auth/" rel="noopener ugc nofollow" target="_blank">Amplify password SMS Auth repo</a>中提供的自定义注册和登录web客户端进行测试。只需克隆回购，并按照客户的指示。</p><h1 id="a90b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">AWS Lambda函数(触发器)</h1><p id="43ad" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">下面是部署为Node.js v8.10运行时函数的四个触发器，Cognito用户池使用它们来完成自定义的身份验证质询流，从而允许您的用户通过他们的电话号码进行身份验证。一旦这个解决方案已经通过AWS无服务器应用程序存储库部署，您就可以在<strong class="ke ir">认知用户池</strong> &gt; <strong class="ke ir">设置</strong> &gt; <strong class="ke ir">触发器</strong>下查看这些链接的Lambda函数。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/9f861c74832f3a7408caa593ac22f599.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f94VSxIl6fpCGfZ6J6j09A.png"/></div></div></figure><h2 id="4e98" class="mw lc iq bd ld mx my dn lh mz na dp ll kn nb nc lp kr nd ne lt kv nf ng lx nh bi translated">预注册</h2><p id="8b42" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">该功能自动确认新用户，在注册时使用他们提供的电话号码作为他们的Cognito用户池用户名。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/b325d40d931a4394e9d8fb652184c030.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VkZLfwzlfAyrzeQPFQ_SDA.png"/></div></div></figure><h2 id="5094" class="mw lc iq bd ld mx my dn lh mz na dp ll kn nb nc lp kr nd ne lt kv nf ng lx nh bi translated">创建身份验证质询</h2><p id="3d52" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">该功能生成一个秘密的6位数字代码(又名OTP，一次性密码)并通过短信发送给用户。用户有三次机会输入正确的密码，然后密码被重置并发送新的密码。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/a7fb20f4f2c6f8e4684ecdb83f78ad89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wVGOkw4fn4hV26zx-RayiQ.png"/></div></div></figure><h2 id="d657" class="mw lc iq bd ld mx my dn lh mz na dp ll kn nb nc lp kr nd ne lt kv nf ng lx nh bi translated">定义身份验证质询</h2><p id="e510" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">该功能管理认证流。在提供给这个Lambda函数(<em class="me"> event.request.session </em>)的会话数组中，呈现了认证流的整个状态。</p><p id="70cc" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果会话详细信息为空，则自定义身份验证流程刚刚开始。如果它有项目，自定义身份验证流程正在进行中，这意味着向用户提出了一个挑战，用户提供了一个答案，并且它(答案)被验证为正确或错误。在这两种情况下，这个函数决定接下来会发生什么。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nx"><img src="../Images/8b64382df53b1bf67425966b89366692.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mB17f2gFo0DeArtWU_9p7Q.png"/></div></div></figure><h2 id="413b" class="mw lc iq bd ld mx my dn lh mz na dp ll kn nb nc lp kr nd ne lt kv nf ng lx nh bi translated">验证身份验证质询响应</h2><p id="04b9" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">该功能的工作是验证用户的答案是否与发送给用户的秘密登录代码相匹配。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/55abed6fd270e79fa227ca17c3c9ffcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hw4LJikDsXc-_BFFfAKxtw.png"/></div></div></figure><h1 id="6582" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">摘要</h1><p id="e9db" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">无密码短信和电子邮件身份验证是一种简单的方式，让移动用户能够快速轻松地进行身份验证。有了这个解决方案，您可以在几分钟内将它部署到AWS云中，并且生产就绪，您可以立即开始测试。</p><p id="e9a9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">请注意，短信和电子邮件无密码身份验证可能是对您的移动用户进行身份验证的安全选项，但是，总有更多安全选项，如MFA，或使用物理硬件密钥，如Yubikey。此外，您应该为那些没有提供手机号码或不愿意提供手机号码的用户提供发送OTP的替代选择，如传统的电子邮件/密码。请让我知道这是否有帮助，因为这是一段时间以来移动开发者经常要求的功能，所以我很高兴最终提供了一个很好的替代认证解决方案，我也将在我自己的应用程序中实现。</p><h1 id="7f14" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">资源</h1><p id="c126" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">用亚马逊Cognito实现<strong class="ke ir">无密码邮件</strong>认证:<a class="ae la" href="https://aws.amazon.com/blogs/mobile/implementing-passwordless-email-authentication-with-amazon-cognito/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/mobile/implementing-password-email-authentic ation-with-Amazon-cogn ITO/</a></p></div></div>    
</body>
</html>