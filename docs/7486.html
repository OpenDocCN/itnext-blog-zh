<html>
<head>
<title>Let’s Encrypt serverless automation with Oracle Cloud Infrastructure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们利用Oracle云基础架构加密无服务器自动化</h1>
<blockquote>原文：<a href="https://itnext.io/lets-encrypt-automation-with-oracle-cloud-infrastructure-1ea5840a5be6?source=collection_archive---------2-----------------------#2022-10-07">https://itnext.io/lets-encrypt-automation-with-oracle-cloud-infrastructure-1ea5840a5be6?source=collection_archive---------2-----------------------#2022-10-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/dd363c4b0b7e2e4bcd8104c1250b41df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Fkt41RyDtNbBOR1R"/></div></div></figure><p id="2ae6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank">让我们加密</a>在2015年末首次亮相。它是由<a class="ae kw" href="https://www.abetterinternet.org/" rel="noopener ugc nofollow" target="_blank">互联网安全研究小组提供的免费认证机构。</a>目标是支持采用SSL / TLS来确保通过公共互联网发送的信息的隐私性。Let's Encrypt现在每天提供超过250万份证书。</p><p id="b0c7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你正在阅读这篇文章，很可能你以前已经处理过SSL证书。也有可能你们中的一些人已经调查了一次中断，却发现一个SSL证书在没有人知道的地方过期了。证书的发现、管理和续订可能会非常耗时，而且也没什么意思。</p><p id="4d65" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">云提供商通过引入能够发布公共域验证(DV)证书的证书服务，使这项工作变得更加容易。Oracle云基础设施(OCI)目前允许您创建私有证书颁发机构(CA)、私有证书和私有证书颁发机构包。专用证书资源用于保护专用网络上的通信，在专用网络上可以安装和信任证书以实现安全通信。</p><p id="7d56" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是对于通过互联网连接的用户来说，公开签署的证书又如何呢？使用私有OCI证书将导致您的web浏览器出现“证书不可信”错误；这就是让我们加密的用武之地。我将向您展示如何在您的OCI租赁中运行完全自动化的无服务器Let's Encrypt解决方案，以安装并自动续订在您的web浏览器中显示为可信的证书。</p><h1 id="2802" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">它是如何工作的？</h1><p id="63a8" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">正确处理证书与在终端上启用TLS一样重要。证书和私钥应始终安全存储，只有授权用户和服务才能访问。我的解决方案使用OCI本地服务、<a class="ae kw" href="https://www.oracle.com/au/cloud/cloud-native/functions/" rel="noopener ugc nofollow" target="_blank">功能</a>、<a class="ae kw" href="https://www.oracle.com/au/cloud/networking/dns/" rel="noopener ugc nofollow" target="_blank"> DNS </a>、<a class="ae kw" href="https://www.oracle.com/au/security/cloud-security/ssl-tls-certificates/" rel="noopener ugc nofollow" target="_blank">证书服务</a>和<a class="ae kw" href="https://docs.oracle.com/en-us/iaas/Content/KeyManagement/Concepts/keyoverview.htm" rel="noopener ugc nofollow" target="_blank">保险库</a>来执行与Let's加密和安全存储证书工件的交互。所有操作都在内存中执行，确保没有证书或密钥保存到磁盘存储中。</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ma"><img src="../Images/9fe94e347f4df0c8c1c628e2fbc22e4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*h_DedCxmd_3A4UkN"/></div></div></figure><p id="b652" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上图展示了我提出的解决方案的架构。它包括:</p><ul class=""><li id="004b" class="mf mg iq ka b kb kc kf kg kj mh kn mi kr mj kv mk ml mm mn bi translated">虚拟云网络、公共和私有子网、互联网和NAT网关</li><li id="61d6" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">一个应用程序负载平衡器，带有一个或多个后端web服务器。</li><li id="5d72" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">我创建了一个名为let-encrypt的自定义Ruby函数。</li><li id="5b86" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">DNS区域</li><li id="74f6" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">虚拟仓库</li><li id="9071" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">证书服务</li></ul><h1 id="df13" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">项目先决条件</h1><p id="d06b" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">在我们开始之前，您需要:</p><ul class=""><li id="7faa" class="mf mg iq ka b kb kc kf kg kj mh kn mi kr mj kv mk ml mm mn bi translated">OCI的租赁</li><li id="c405" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">具有公共/私有子网的虚拟云网络、互联网网关、NAT网关</li><li id="27da" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">OCI DNS上托管的DNS域。对于我的例子，我使用dflect.me</li><li id="731c" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">具有一个或多个web服务器后端的应用程序负载平衡器。</li><li id="44ef" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">足够的IAM权限，以便在您的租用中或在资源将要驻留的隔离专区中创建资源</li></ul><p id="d820" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你没有在OCI运行的现有web服务器，你可以按照这些说明安装NGINX:<a class="ae kw" href="https://docs.oracle.com/en/learn/oracle-linux-nginx/index.html" rel="noopener ugc nofollow" target="_blank">https://docs . Oracle . com/en/learn/Oracle-Linux-NGINX/index . html</a>。您还需要配置一个负载平衡器来支持NGINX服务。</p><h1 id="e5be" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">设置和配置</h1><p id="6135" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated"><strong class="ka ir"> <em class="mt">注意:</em> </strong>下面的说明有一个更新，允许您提供多个证书。更新的说明可以在这里找到:<a class="ae kw" href="https://medium.com/@scotti.fletcher.1/managing-multiple-lets-encrypt-certificates-with-oracle-cloud-infrastructure-470eef51630" rel="noopener">https://medium . com/@ scotti . Fletcher . 1/managing-multiple-lets-encrypt-certificates-with-Oracle-cloud-infra structure-470 eef 51630</a></p><p id="b35e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你还需要安装<a class="ae kw" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker </a>，以及<a class="ae kw" href="https://fnproject.io/" rel="noopener ugc nofollow" target="_blank"> Fn项目</a>。在OSX，安装Fn项目很容易，因为有自制软件:</p><pre class="mb mc md me gt mu mv mw mx aw my bi"><span id="1c98" class="mz ky iq mv b gy na nb l nc nd">$ brew install fn</span></pre><p id="e1cb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要将该功能推送到OCI容器库，您还需要一个Auth Token，它可以通过选择您的用户并单击“Auth Tokens”在OCI身份中生成。</p><p id="fc16" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从Github<a class="ae kw" href="https://github.com/scotti-fletcher/oci-letsencrypt" rel="noopener ugc nofollow" target="_blank">https://github.com/scotti-fletcher/oci-letsencrypt</a>下载函数源代码。一如既往，我建议在使用之前检查你从网上下载的任何源代码的安全问题。</p><p id="3372" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们将创建一个函数应用程序。应用程序只是函数的逻辑分组，在这个解决方案中，我只有一个名为“acme-certbot”的应用程序和一个名为“lets-encrypt”的函数。</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/3caab21383a5acf8fcbb1d494bb3d111.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/0*Ejj-bNyHoBMwsh1-"/></div></figure><p id="a3dd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建应用程序后，按照“本地设置”的“入门”说明进行操作。显示的说明将因您的OCI环境而异，但是我将解释这些步骤，因为本示例并不需要所有步骤。</p><p id="d93d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在终端中，cd进入包含函数文件的let-encrypt目录:</p><pre class="mb mc md me gt mu mv mw mx aw my bi"><span id="087b" class="mz ky iq mv b gy na nb l nc nd">scott@scott-mac lets-encrypt % cd ~/Projects/oci-certbot/lets-encrypt<br/>scott@scott-mac lets-encrypt % ls<br/>Gemfile func.rb func.yaml models.rb</span></pre><p id="4fb6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为此隔离专区创建一个上下文，并选择使用它。我的函数位于我的沙箱隔离舱中，名称如下所示:</p><pre class="mb mc md me gt mu mv mw mx aw my bi"><span id="da64" class="mz ky iq mv b gy na nb l nc nd">$ fn create context scott_fletcher_sandbox --provider oracle <br/>$ fn use context scott_fletcher_sandbox</span></pre><p id="3f11" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用创建应用产品的隔离专区OCID和Oracle Functions API URL更新上下文。</p><pre class="mb mc md me gt mu mv mw mx aw my bi"><span id="a26e" class="mz ky iq mv b gy na nb l nc nd">$ fn update context oracle.compartment-id [your compartment ocid] <br/>$ fn update context api-url <a class="ae kw" href="https://functions.ap-sydney-1.oraclecloud.com" rel="noopener ugc nofollow" target="_blank">https://functions.ap-sydney-1.oraclecloud.com</a></span></pre><p id="6dac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个存储库，用于存储您的函数容器映像。</p><pre class="mb mc md me gt mu mv mw mx aw my bi"><span id="8d01" class="mz ky iq mv b gy na nb l nc nd">$ fn update context registry syd.ocir.io/[your namespace]/acme-certbot</span></pre><p id="1bdf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">登录OCI集装箱登记处。</p><pre class="mb mc md me gt mu mv mw mx aw my bi"><span id="a5de" class="mz ky iq mv b gy na nb l nc nd">$ docker login -u '[your namespace]/oracleidentitycloudservice/scott.fletcher@oracle.com' syd.ocir.io</span></pre><p id="931d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您应该会看到“登录成功”的消息。现在，您可以构建和部署您的应用程序了。首次执行此操作可能需要几分钟时间:</p><pre class="mb mc md me gt mu mv mw mx aw my bi"><span id="a45a" class="mz ky iq mv b gy na nb l nc nd">scott@scott-mac lets-encrypt % fn deploy --app acme-certbot                                                                                                    <br/>Deploying lets-encrypt to app: acme-certbot<br/>Bumped to version 0.0.19<br/>Using Container engine docker<br/>Building image syd.ocir.io/abcd/acme-certbot/lets-encrypt:0.0.19 ......<br/>Parts:  [syd.ocir.io abcd acme-certbot lets-encrypt:0.0.19]<br/>Using Container engine docker to push<br/>Pushing syd.ocir.io/abcd/acme-certbot/lets-encrypt:0.0.19 to docker registry...The push refers to repository [syd.ocir.io/abcd/acme-certbot/lets-encrypt]<br/>d15aa7ac2cf0: Pushed <br/>f9a15c3fd1e8: Pushed <br/>111ae97432f0: Layer already exists <br/>fb57e582ca84: Layer already exists <br/>d55982f12cfa: Layer already exists <br/>04aab8128d11: Layer already exists <br/>05dc728e5e49: Layer already exists <br/>0.0.19: digest: sha256:d86dcf6889fa8fe3a036da8e17fbb7733c50369a158c1daf2649eaaf7d232c40 size: 1783<br/>Updating function lets-encrypt using image syd.ocir.io/abcd/acme-certbot/lets-encrypt:0.0.19...</span></pre><p id="1b39" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建之后，您应该能够在OCI控制台的应用程序下以及容器注册表中看到该函数。</p><p id="9128" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们需要创建一个日志组来保存我们的函数特定的日志。创建一个日志组，我将我的命名为“cert-bot-logs”:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ma"><img src="../Images/7667822108a9b4b5d5e3dffc062e5f09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ub_xMWqqaW-8OfPv"/></div></div></figure><p id="010e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在日志中，点击“创建自定义日志”并将其命名为“cert-bot-activity”。</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nf"><img src="../Images/ef4d4966c3bb5ccbc5a4f594f8136c18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*blzZma9PBao1hc6p"/></div></div></figure><p id="5410" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">出现提示时，选择“稍后添加配置”，然后单击创建。您应该在“cert-bot-logs”中看到日志“cert-bot-activity”。记下cert-bot活动日志的OCID，因为您稍后会需要它。</p><p id="7903" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您在OCI保管库中还没有主加密密钥，则需要创建一个:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/6cae323ba6ca655484ac646bc85d0543.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WxAwFWqMmMVLgKTV"/></div></div></figure><p id="14fb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">记下主加密密钥的OCID，因为您稍后会需要它。</p><p id="0f66" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们将返回到我们的函数，并更新所需的配置项。配置项只是函数可以访问的环境变量:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/006f50a6823ed2a8c299b558777e11ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zV_kWJ2iQ_6P7Ghi"/></div></div></figure><p id="108a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您需要配置以下项目:</p><ul class=""><li id="5a2c" class="mf mg iq ka b kb kc kf kg kj mh kn mi kr mj kv mk ml mm mn bi translated">CERT_COMPARTMENT_OCID:这是将创建证书的隔离舱。</li><li id="ce9b" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">DNS_REGION:这是配置DNS区域的区域。</li><li id="00ee" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">CN_CERT_NAME:这是您希望由Let's Encrypt颁发的证书的通用名称。如上，我要颁发的证书是给<a class="ae kw" href="https://www.dflect.me" rel="noopener ugc nofollow" target="_blank"> www.dflect.me </a></li><li id="a0de" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">OCI日志OCID:这是你之前创建的证书机器人活动日志的OCID。</li><li id="7808" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">OCI _保险库_OCID:这是您的主加密密钥所在的保险库的OCID。这也是我们将存储您的Let's Encrypt帐户私钥作为一个秘密。</li><li id="31ea" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">VAULT_SECRET_NAME:这是保存您的Let's Encrypt帐户私钥的秘密名称。您可以使用“acme-cert-bot-key ”,或者根据需要更改它。</li><li id="358e" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">CERT_CONTACT:这是与将要颁发的证书相关联的电子邮件地址</li><li id="b7f2" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">CERT_AUTO_DEPLOY:在此输入“是”将使将来续订的证书成为证书服务中的“当前”版本，从而触发任何相关负载平衡器上的证书更新。</li><li id="090a" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">DNS区域名称:这是您的DNS区域的名称。如上，我的名字叫做dflect.me</li><li id="02bb" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">让我们加密URI:这是让我们加密API端点。</li><li id="a04a" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">VAULT_MASTER_KEY_OCID:这是您要使用的或之前创建的主加密密钥的OCID。</li><li id="72d2" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">RENEW_BEFORE_EXPIRY_DAYS:这定义了在证书到期前多少天，您希望续订证书。我已选择在到期前30天更新我的证书。</li></ul><p id="cee6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您还需要为该功能配置超时和内存。内存应为1024mb，超时时间应设置为300秒:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/2398a5c397b3df33b9f8a34bad170ddf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/0*Nmw5L01-PDTHp-qm"/></div></figure><p id="c7e2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">函数也会发出日志，为了调试的目的，查看它们是很有用的。要启用这些日志，请单击“启用日志”:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/c2255400a4c3f5167c285d9213c7fcd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*asrNncfgaSg3FnNm"/></div></div></figure><p id="215d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在测试我们的功能之前，我们需要创建一个动态组，以及允许我们的功能在我们的环境中运行的策略。根据您的使用情形以及您的保管库和DNS区域的位置，您可能需要调整策略。我下面的例子仅限于我的沙盒区间。</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/d072582a742e15a6934c0e7386498f1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3WyIE7B16U3oA8wh"/></div></div></figure><p id="f0d4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用以下策略语句创建一个新策略。如果您选择了不同的动态组和隔离专区名称，则需要相应地更新策略声明:</p><pre class="mb mc md me gt mu mv mw mx aw my bi"><span id="1656" class="mz ky iq mv b gy na nb l nc nd">Allow dynamic-group acme-certbot-dg to use log-content in compartment scott_fletcher_sandbox<br/>Allow dynamic-group acme-certbot-dg to use dns in compartment scott_fletcher_sandbox<br/>Allow dynamic-group acme-certbot-dg to manage leaf-certificate-family in compartment scott_fletcher_sandbox<br/>Allow dynamic-group acme-certbot-dg to manage secrets in compartment scott_fletcher_sandbox<br/>Allow dynamic-group acme-certbot-dg to manage key-family in compartment scott_fletcher_sandbox</span></pre><p id="a8f1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这些语句允许我的函数:</p><ul class=""><li id="0f15" class="mf mg iq ka b kb kc kf kg kj mh kn mi kr mj kv mk ml mm mn bi translated">将日志推送到cert-bot活动日志</li><li id="9a0b" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">更新DNS区域以响应TXT记录“让我们加密挑战”。</li><li id="d021" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">将证书导入证书服务</li><li id="d3d2" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">创建并读取您的Let's Encrypt帐户私钥，该私钥作为秘密存储在保管库中</li><li id="126d" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">加密“让我们加密”帐户私钥时，请使用您的主加密密钥</li></ul><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/c2ab5a83f29b8f3eef8a136ed897da2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jb3v7_1xRTkxz6cE"/></div></div></figure><p id="0e95" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在一切都配置好了，我们可以调用函数来创建证书。这可能需要1-2分钟。您应该会看到返回一条“成功完成”的消息:</p><pre class="mb mc md me gt mu mv mw mx aw my bi"><span id="8799" class="mz ky iq mv b gy na nb l nc nd">scott@scott-mac lets-encrypt % fn invoke acme-certbot lets-encrypt "Completed Successfully"</span></pre><p id="108c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果我们看一下我们的cert-bot活动日志，我们可以看到证书是这样创建的:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/b2683f9d68c0f11aabc30ae474f5d07d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KRn5nDM44_Q3z6qC"/></div></div></figure><p id="7035" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">查看我们的DNS区域记录，我们可以看到为_acme-challenge.www.dflect.me添加了一条TXT记录:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/7cd7d242868e84c2d9f139e0027defb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1356/0*C06u5UQ7psN3CbKW"/></div></figure><p id="370b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">查看我们的存储库，我们可以看到还添加了acme-cert-bot-key秘密:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/a1f96567b1bac04a8bf19f25c9713720.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IR4e-puOrOPau1Xe"/></div></div></figure><p id="20f5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，我们可以看到证书已导入证书服务:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi np"><img src="../Images/5d3daef6d63e0ffd7c48baa7e340c6aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vgzFWFSaIMtV3maj"/></div></div></figure><p id="5074" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果我们再次调用该函数，我们将看到未来的证书被添加到现有证书中，最新的证书被提升到当前版本:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/3bc77f75bcf4a5fa0d9e2dd7f62ffcc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2048REvD204bHLGk"/></div></div></figure><p id="badd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们需要将证书与负载平衡器侦听器相关联。您可以创建HTTPS监听程序，或编辑现有监听程序。选择已创建的证书:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/70381ea968af8e12aed093aac74d1444.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fFrNtkTAo7lLRPIX"/></div></div></figure><p id="8dfc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦负载平衡器工作请求完成，您现在就可以浏览您的网站。对我来说，是https://www.dflect.me/:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/fe28bdb16fbcd3cbb0b647af50b90a87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6wzrbKuP28Jh6KrO"/></div></div></figure><p id="7682" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我还可以查看由“让我们加密”颁发的证书:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/509a6999add47701f0a51d86e3668397.png" data-original-src="https://miro.medium.com/v2/resize:fit:1026/0*cTbDUzfF4tFL9l2c"/></div></figure><p id="19d0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在最棒的事情是，每当调用该函数时，如果需要新证书(在本例中是在到期前30天),就会生成一个新证书，将其升级为当前证书，并自动推送到任何关联的资源。这意味着我的负载平衡器将永远拥有一个有效的SSL证书。</p><p id="2076" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后要做的事情是配置一个机制，通过它来调用OCI中的函数。有几种方法可以实现这一点:</p><ul class=""><li id="e87a" class="mf mg iq ka b kb kc kf kg kj mh kn mi kr mj kv mk ml mm mn bi translated">根据需要通过命令行手动运行它(如前面所示)</li><li id="5c3f" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">通过计算实例中的cron作业或您使用的其他调度程序来运行它</li><li id="5fc8" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">使用从OCI内部触发该函数的方法自动运行它。</li></ul><p id="5ffd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为我不想手动运行它，而且我也没有调度程序，所以我打算每天使用一次OCI警报来触发我的功能。我的同事有一篇关于如何做到这一点的好文章<a class="ae kw" href="https://redthunder.blog/2022/05/03/a-better-mechanism-for-periodic-functions-invocation/" rel="noopener ugc nofollow" target="_blank">https://red thunder . blog/2022/05/03/a-better-mechanism-for-periodic-functions-invocation/</a>。这是一本很好的读物，它深入探讨了这种方法如何工作的细节。</p><p id="e795" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，我们需要创建一个主题:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/06f2e5bfb132804b7172ea420a1dc027.png" data-original-src="https://miro.medium.com/v2/resize:fit:1262/0*GiilE6oCIsj648np"/></div></figure><p id="d10e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建主题后，创建一个将调用let-encrypt函数的订阅:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/37a61f952acb53303522fc13384004e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hjECAXARC39hm2dd"/></div></div></figure><p id="7bcb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们需要创建一个警报:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/2c3eb8bd1f2be8d1ce700b9d5e5af6fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*G5pHdkDOFoEK7Osy"/></div></div></figure><p id="0086" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为我正在运行多个计算实例，所以我选择了一个将始终触发的指标。</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nx"><img src="../Images/02d96568c32c239e4e57050f89624492.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yLCPdZq-Fk1Kr7CE"/></div></div></figure><p id="eede" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当值大于-1时触发规则，这意味着警报将总是触发。您可能需要输入1，然后按下向下箭头键获得值-1。您可以通过查看图表来验证指标是否有效。蓝线表示该指标将触发警报:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/5542abe5f16a4a688ea69d84c88ee27c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7Ni7hmhnrXgaohH0"/></div></div></figure><p id="ad94" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们需要做的就是配置警报，向我们的通知主题发送消息。注意:我已将闹钟配置为每24小时重复通知一次。这将确保我们的let-encrypt函数每天运行一次:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi np"><img src="../Images/f90ceba19c8abb8c4326243aa8bed7dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DFwjS2k7984bNrsE"/></div></div></figure><p id="cbc7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要确认let-encrypt函数每天都在运行，请查看函数指标:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/d24cb2344a20583485f1dfa809a62373.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KQcchszJu7jETR7G"/></div></div></figure><p id="7288" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">太棒了，现在我们有了一个完全自动化的解决方案，允许我们颁发和续订加密证书，并自动更新负载平衡器。</p><h1 id="c053" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">其他考虑/想法</h1><ul class=""><li id="0929" class="mf mg iq ka b kb lv kf lw kj oa kn ob kr oc kv mk ml mm mn bi translated">当请求Let's Encrypt证书时，提供的证书链不包括信任根的所有证书。如果您试图手动将“让我们加密”证书导入OCI的证书服务，您可能会收到“信任链错误”。我在函数中通过遍历CA Issuer树并构建导入的正确证书链来处理这个问题。如果你查看源代码，你会看到它是如何完成的。</li><li id="403b" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">我建议在您的OCI租赁中启用<a class="ae kw" href="https://www.oracle.com/au/security/cloud-security/cloud-guard/" rel="noopener ugc nofollow" target="_blank">云卫士</a>。它是免费的，在一系列令人敬畏的云安全状态管理功能中，它有检测器来识别负载平衡器上的证书何时到期。如果您在证书到期前30天续订证书，那么将您的Cloud Guard检测器设置为识别将在20天后到期的证书将确保您在该功能未能成功运行或执行时收到警报。</li><li id="699f" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">如果你想做端到端的SSL加密，那么你可以在后台使用OCI的私有证书。在调配计算实例时，您也可以使用init脚本来检索、安装和信任这些证书。</li><li id="2773" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">我的IAM策略的范围是我的沙盒隔离专区中的所有内容。如果您想要进一步控制该函数可以访问的内容，您可以将这些内容限定到特定的资源OCID。</li><li id="62dc" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">我选择将CERT_AUTO_DEPLOY配置变量设置为“YES ”,这意味着更新的证书将自动成为当前版本，从而触发相关负载平衡器上的自动更新。如果您只想检索证书，而不想将它自动推送到负载平衡器，请将此项设置为“否”。如果您将其设置为“否”,则您需要监视证书何时更新，并手动将其标记为“当前”。</li><li id="ba20" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">我把账户私钥作为秘密储存在金库里。这是因为如果您需要撤销证书，您将需要帐户私钥和证书。</li><li id="4347" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">此解决方案演示了如何更新单个证书。如果您需要多个加密证书，那么您可以根据需要部署多个功能。在不久的将来，我将更新解决方案，以处理多个证书配置。</li></ul><p id="5e70" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你觉得这有用，请分享！如果你有任何问题，你可以在LinkedIn上联系我<a class="ae kw" href="https://www.linkedin.com/in/scotti-fletcher/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/scotti-fletcher/</a></p><figure class="mb mc md me gt jr gh gi paragraph-image"><div class="gh gi od"><img src="../Images/50b097a9b77e3141e7e945db4babcbd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:84/0*E60P3zXJdTiq-bU-"/></div></figure></div><div class="ab cl oe of hu og" role="separator"><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj"/></div><div class="ij ik il im in"><p id="d2e8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="mt">原载于2022年10月7日</em><a class="ae kw" href="https://redthunder.blog/2022/10/08/lets-encrypt-automation-with-oracle-cloud-infrastructure/" rel="noopener ugc nofollow" target="_blank"><em class="mt">http://red thunder . blog</em></a><em class="mt">。</em></p></div></div>    
</body>
</html>