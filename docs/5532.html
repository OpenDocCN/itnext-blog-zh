<html>
<head>
<title>Setup Ruby on Github Actions to cache Ruby gems for Rails project</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">设置Ruby on Github操作以缓存Ruby gems for Rails项目</h1>
<blockquote>原文：<a href="https://itnext.io/setup-ruby-on-github-actions-to-cache-ruby-gems-for-rails-project-780a3c76f78d?source=collection_archive---------5-----------------------#2021-03-25">https://itnext.io/setup-ruby-on-github-actions-to-cache-ruby-gems-for-rails-project-780a3c76f78d?source=collection_archive---------5-----------------------#2021-03-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c0f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如何在Github Actions上从缓存加载Ruby gems更快的启动CI构建？如果您能够在短时间内设置好所有的依赖项，那么您可以更快地开始运行Ruby on Rails项目的测试。缓存对此很有帮助。您的项目所需的Ruby gems可以通过Github操作进行缓存，因此当您运行一个新的CI构建时，可以更快地加载它们。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/ebf2b5d5c07d6bb7d9265336d0701c66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-7age-zTCKfwJajR.jpeg"/></div></div></figure><p id="3d84" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将学习如何使用以下工具配置Github操作:</p><ul class=""><li id="03d4" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated"><a class="ae lg" href="https://github.com/actions/cache" rel="noopener ugc nofollow" target="_blank">动作/缓存</a> —这是一个流行的缓存Ruby gems的解决方案。</li><li id="e21e" class="kx ky iq jp b jq lh ju li jy lj kc lk kg ll kk lc ld le lf bi translated"><a class="ae lg" href="https://github.com/ruby/setup-ruby" rel="noopener ugc nofollow" target="_blank"> ruby/setup-ruby </a> —这是一个安装特定ruby版本并用bundler缓存Ruby gems的解决方案。一个动作中的两个特征。</li></ul><h1 id="d930" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">操作/缓存—仅缓存依赖关系</h1><p id="9074" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated"><a class="ae lg" href="https://github.com/actions/cache" rel="noopener ugc nofollow" target="_blank"> Actions/cache </a>是一种流行的解决方案，可用于将数据保存到缓存中，并在下一次CI构建期间恢复数据。它通常用于Ruby on Rails项目，这些项目也使用<code class="fe mp mq mr ms b">actions/setup-ruby</code>来管理Github上的Ruby版本动作。</p><p id="1cc2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们看看使用<code class="fe mp mq mr ms b">actions/cache</code>的Github动作缓存配置示例。</p><pre class="km kn ko kp gt mt ms mu mv aw mw bi"><span id="e6d1" class="mx ln iq ms b gy my mz l na nb"><em class="nc"># .github/workflows/main.yml</em><br/>name: Main<br/>on: [push, pull_request]<br/>jobs:<br/>  test:<br/>    runs-on: ubuntu-latest<br/>    steps:<br/>      - uses: actions/checkout@v2<br/><br/>      - uses: actions/cache@v2<br/>        with:<br/>          path: vendor/bundle<br/>          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}<br/>          restore-keys: |<br/>            ${{ runner.os }}-gems-<br/><br/>      - name: Bundle install<br/>        env:<br/>          RAILS_ENV: test<br/>        run: |<br/>          bundle config path vendor/bundle<br/>          bundle install --jobs 4 --retry 3</span></pre><ul class=""><li id="4077" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">您需要指定将被缓存的目录路径。在我们这里是<code class="fe mp mq mr ms b">vendor/bundle</code>。</li><li id="fe7f" class="kx ky iq jp b jq lh ju li jy lj kc lk kg ll kk lc ld le lf bi translated">您还可以根据操作系统版本和<code class="fe mp mq mr ms b">Gemfile.lock</code>文件生成一个唯一的缓存<code class="fe mp mq mr ms b">key</code>。当您更改操作系统版本或安装新的gem并且<code class="fe mp mq mr ms b">Gemfile.lock</code>发生变化时，将会生成新的<code class="fe mp mq mr ms b">key</code>值。</li><li id="b79a" class="kx ky iq jp b jq lh ju li jy lj kc lk kg ll kk lc ld le lf bi translated">您需要配置bundler来将您所有的Ruby gems安装到目录<code class="fe mp mq mr ms b">vendor/bundle</code>中。</li><li id="077c" class="kx ky iq jp b jq lh ju li jy lj kc lk kg ll kk lc ld le lf bi translated">您可以使用捆绑器选项:</li><li id="a68e" class="kx ky iq jp b jq lh ju li jy lj kc lk kg ll kk lc ld le lf bi translated"><code class="fe mp mq mr ms b">--jobs 4</code> -使用平行工人安装宝石。这允许更快的gems安装。</li><li id="7564" class="kx ky iq jp b jq lh ju li jy lj kc lk kg ll kk lc ld le lf bi translated"><code class="fe mp mq mr ms b">--retry 3</code> -如果出现网络问题(例如Rubygems.org暂时停机)，尝试3次连接Rubygems</li></ul><p id="8a54" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想看Github Actions和Rails项目的完整YAML配置，你可以看看我们的一些文章:</p><ul class=""><li id="0ed0" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated"><a class="ae lg" href="https://docs.knapsackpro.com/2019/how-to-run-rspec-on-github-actions-for-ruby-on-rails-app-using-parallel-jobs" rel="noopener ugc nofollow" target="_blank">如何使用并行作业为Ruby on Rails应用程序运行RSpec on GitHub Actions</a></li><li id="cebf" class="kx ky iq jp b jq lh ju li jy lj kc lk kg ll kk lc ld le lf bi translated"><a class="ae lg" href="https://docs.knapsackpro.com/2019/github-actions-ci-config-for-ruby-on-rails-project-with-mysql-redis-elasticsearch-how-to-run-parallel-tests" rel="noopener ugc nofollow" target="_blank">GitHub Actions CI config for Ruby on Rails project with MySQL、Redis、Elasticsearch —如何运行并行测试</a></li><li id="d905" class="kx ky iq jp b jq lh ju li jy lj kc lk kg ll kk lc ld le lf bi translated"><a class="ae lg" href="https://docs.knapsackpro.com/2020/how-to-run-slow-rspec-files-on-github-actions-with-parallel-jobs-by-doing-an-auto-split-of-the-spec-file-by-test-examples" rel="noopener ugc nofollow" target="_blank">如何在Github Actions上运行慢速RSpec文件，通过测试示例自动分割Spec文件来执行并行作业</a></li><li id="0813" class="kx ky iq jp b jq lh ju li jy lj kc lk kg ll kk lc ld le lf bi translated"><a class="ae lg" href="https://docs.knapsackpro.com/2021/cucumber-bdd-testing-using-github-actions-parallel-jobs-to-run-tests-quicker" rel="noopener ugc nofollow" target="_blank"> Cucumber BDD测试使用Github Actions并行作业更快地运行测试</a></li></ul><h1 id="46a7" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">ruby/setup-ruby —安装ruby并缓存gem</h1><p id="cd4a" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">在上一节中，我们提到了<code class="fe mp mq mr ms b">actions/setup-ruby</code>经常与Ruby on Rails项目一起使用。<code class="fe mp mq mr ms b">actions/setup-ruby</code>已经被弃用，所以现在推荐使用<code class="fe mp mq mr ms b">ruby/setup-ruby</code>动作。它已经有缓存功能，你可以使用。让我们看看怎么做。</p><pre class="km kn ko kp gt mt ms mu mv aw mw bi"><span id="aa38" class="mx ln iq ms b gy my mz l na nb"><em class="nc"># .github/workflows/main.yml</em><br/>name: Main<br/>on: [push, pull_request]<br/>jobs:<br/>  test:<br/>    runs-on: ubuntu-latest<br/>    steps:<br/>    - uses: actions/checkout@v2<br/><br/>    - uses: ruby/setup-ruby@v1<br/>      with:<br/>        <em class="nc"># Not needed with a .ruby-version file</em><br/>        ruby-version: 2.7<br/>        <em class="nc"># runs 'bundle install' and caches installed gems automatically</em><br/>        bundler-cache: true<br/><br/>    <em class="nc"># run RSpec tests</em><br/>    - run: bundle exec rspec</span></pre><p id="984e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如你所见，使用<code class="fe mp mq mr ms b">ruby/setup-ruby</code>来管理Ruby版本和gems缓存要简单得多。你只要加上一个选项<code class="fe mp mq mr ms b">bundler-cache: true</code>就可以了。</p><p id="ba3b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在<code class="fe mp mq mr ms b"><a class="ae lg" href="https://github.com/ruby/setup-ruby#caching-bundle-install-automatically" rel="noopener ugc nofollow" target="_blank">ruby/setup-ruby</a></code> <a class="ae lg" href="https://github.com/ruby/setup-ruby#caching-bundle-install-automatically" rel="noopener ugc nofollow" target="_blank">文档中读到</a>:</p><p id="8dad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">“也可以手动缓存gem，但不建议这样做，因为这样做很繁琐，而且很难正确完成。存在许多问题，这意味着使用<code class="fe mp mq mr ms b">actions/cache</code>永远不足以缓存gem(例如，不完整的缓存密钥、从另一个密钥恢复时清理旧的gem、正确散列未签入的锁定文件、操作系统版本、ruby-head的ABI兼容性等)。所以，请用<code class="fe mp mq mr ms b">bundler-cache: true</code>代替……”</p><h1 id="bb94" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">摘要</h1><p id="7018" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">您看到了在Github Actions上缓存Ruby gems的两种方式。还有其他方法可以让您的CI构建得更快，比如并行运行测试。你可以在这里了解更多关于<a class="ae lg" href="https://docs.knapsackpro.com/2020/how-to-speed-up-ruby-and-javascript-tests-with-ci-parallelisation" rel="noopener ugc nofollow" target="_blank">测试并行化的信息，或者直接查看</a><a class="ae lg" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=medium-how-to-load-ruby-gems-from-cache-on-github-actions" rel="noopener ugc nofollow" target="_blank">背包Pro </a>主页。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/c38b401e06c2f69f2dd1cd0f09d3981f.png" data-original-src="https://miro.medium.com/v2/resize:fit:160/format:webp/0*qq9D3I-KrCJqMwrt.png"/></div></figure></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><p id="61a3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nc">原载于2021年3月25日https://docs.knapsackpro.com</em><a class="ae lg" href="https://docs.knapsackpro.com/2021/how-to-load-ruby-gems-from-cache-on-github-actions" rel="noopener ugc nofollow" target="_blank"><em class="nc"/></a><em class="nc">。</em></p></div></div>    
</body>
</html>