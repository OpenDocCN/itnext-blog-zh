<html>
<head>
<title>ERROR: x509: certificate signed by unknown authority error is returned</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">错误:x509:返回由未知颁发机构签名的证书错误</h1>
<blockquote>原文：<a href="https://itnext.io/error-x509-certificate-signed-by-unknown-authority-error-is-returned-f0e5d436f467?source=collection_archive---------0-----------------------#2022-07-04">https://itnext.io/error-x509-certificate-signed-by-unknown-authority-error-is-returned-f0e5d436f467?source=collection_archive---------0-----------------------#2022-07-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3325f6025cabd940681cc841f2cbdf83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8w0akN4hXLScUyGX1dGi-A.png"/></div></div></figure><p id="5e3c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本文中，我们将研究在尝试将图像推送到我们自己的注册中心时，如何使用自签名证书来解决这个问题。</p><p id="de4a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最近，我不得不处理一个构建错误，在我们的管道中将一个图像推入注册表的阶段，这个问题被证明是平庸的，像往常一样——一件小事，只是有人改变了注册表域并且程序集失败了，整个团队收到了关于一个不成功的构建的警报，并且正如通常发生的那样，他们开始理解这个问题，否则会怎样？这需要一点挖掘，但它很好。因此，如果您遇到证书错误，这份材料是解决将图像推送到git存储库的类似问题的手册之一。</p><p id="29e8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">问题描述</strong></p><p id="39bd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，您在构建映像时遇到了问题(例如，它可能在CI/CD中):</p><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/8524e797d51a35438221108f8c346f62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bv7ILA0ExaTBdwuJWANcoQ.png"/></div></div></figure><p id="1362" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您无法登录您的docker注册表。您正在为docker注册表使用自签名证书，而不是由可信证书颁发机构(CA)颁发的证书。docker守护程序不信任自签名证书，这导致了x509错误。</p><p id="07d3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这可能是由于当前证书过期、主机名更改以及其他更改造成的。</p><p id="bed2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我的例子中，注册表是在一个单独的容器中产生的。在具有特定域名和主机名的服务器上。</p><p id="daa4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">这个问题的解决方案</strong></p><p id="129d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为组装是在公司网络中进行的，所以所有的服务，包括CI / CD，都与docker注册中心在同一个私有网络中。解决方案最终分为两部分:<br/>——生成新的证书；<br/> -使用新证书重启docker注册表。</p><p id="3bf9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，我们需要生成一个密钥:</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="853e" class="lf lg iq lb b gy lh li l lj lk">openssl genrsa -des3 -out domainname.com.key 2048</span></pre><p id="e547" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们生成一个CSR(证书签名请求):</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="4748" class="lf lg iq lb b gy lh li l lj lk">openssl req -new -key domainname.com.key -out domainname.com.csr</span></pre><p id="3e66" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">填写所需信息:</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="57ed" class="lf lg iq lb b gy lh li l lj lk">Enter pass phrase for example.com.key:</span><span id="48a7" class="lf lg iq lb b gy ll li l lj lk">You are about to be asked to enter information that will be incorporated</span><span id="bc21" class="lf lg iq lb b gy ll li l lj lk">into your certificate request.</span><span id="6ac9" class="lf lg iq lb b gy ll li l lj lk">What you are about to enter is what is called a Distinguished Name or a DN.</span><span id="60d4" class="lf lg iq lb b gy ll li l lj lk">There are quite a few fields but you can leave some blank</span><span id="29ad" class="lf lg iq lb b gy ll li l lj lk">For some fields there will be a default value,</span><span id="0bac" class="lf lg iq lb b gy ll li l lj lk">If you enter '.', the field will be left blank.</span><span id="7ec7" class="lf lg iq lb b gy ll li l lj lk">Country Name (2 letter code) [XX]:XX</span><span id="f426" class="lf lg iq lb b gy ll li l lj lk">State or Province Name (full name) []:State</span><span id="5e4c" class="lf lg iq lb b gy ll li l lj lk">Locality Name (eg, city) [Default City]:City</span><span id="1c15" class="lf lg iq lb b gy ll li l lj lk">Organization Name (eg, company) [Default Company Ltd]:Company</span><span id="025d" class="lf lg iq lb b gy ll li l lj lk">Organizational Unit Name (eg, section) []:BU</span><span id="f905" class="lf lg iq lb b gy ll li l lj lk">Common Name (eg, your name or your server's hostname) []:*.example.com</span><span id="ce31" class="lf lg iq lb b gy ll li l lj lk">Email Address []:admin@domainname.com</span><span id="1624" class="lf lg iq lb b gy ll li l lj lk">Please enter the following 'extra' attributes</span><span id="cd4a" class="lf lg iq lb b gy ll li l lj lk">to be sent with your certificate request</span><span id="58ea" class="lf lg iq lb b gy ll li l lj lk">A challenge password []:</span><span id="b326" class="lf lg iq lb b gy ll li l lj lk">An optional company name []:</span></pre><p id="eff5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从密钥中删除密码:</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="ac5c" class="lf lg iq lb b gy lh li l lj lk">cp domainname.com.key domainname.com.key.org<br/>openssl rsa -in domainname.com.key.org -out domainname.com.key</span></pre><p id="dcde" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为SAN创建配置文件:</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="5577" class="lf lg iq lb b gy lh li l lj lk">touch v3.ext</span></pre><p id="ff46" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">生成自签名证书:</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="e82d" class="lf lg iq lb b gy lh li l lj lk">openssl x509 -req -in domainname.com.csr -signkey domainname.com.key -out domainname.com.crt -days 3650 -sha256 -extfile v3.ext</span></pre><p id="2d31" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此时，我们已经准备好了一个自签名证书，可以在docker注册表中使用。</p><p id="62f1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="lm">要在注册表中使用新证书，请执行以下操作:</em> </strong> <br/>您必须告诉docker信任自签名证书，方法是将自签名证书复制到运行docker登录命令的机器上的<em class="lm">/etc/docker/certs . d/&lt;your _ registry _ host _ name&gt;</em>:<em class="lm">&lt;your _ registry _ host _ port&gt;/ca . CRT</em>。</p><p id="dbcf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在您使用Docker登录的服务器上创建以下目录:</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="1c99" class="lf lg iq lb b gy lh li l lj lk">mkdir -p /etc/docker/certs.d/&lt;your_registry_host_name&gt;:&lt;your_registry_host_port&gt;</span></pre><p id="01dc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将docker注册表证书文件从docker注册表主机复制到您登录Docker的集群。将Docker注册表<em class="lm">证书文件重命名为/etc/Docker/certs . d/&lt;your _ registry _ host _ name&gt;:&lt;your _ registry _ host _ port&gt;/ca . CRT:</em></p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="3151" class="lf lg iq lb b gy lh li l lj lk">scp &lt;your_registry_host_name&gt;:/opt/registry/certs/domain.crt /etc/docker/certs.d/&lt;your_registry_host_name&gt;:&lt;your_registry_host_port&gt;/ca.crt</span></pre><p id="2e61" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，您可以再次重复构建docker映像，看看会发生什么。</p><p id="b66f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">自动化快乐！</p></div></div>    
</body>
</html>