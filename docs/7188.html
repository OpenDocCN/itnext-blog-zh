<html>
<head>
<title>From Chaos to Optimum with Azure Chaos Studio</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Azure Chaos Studio从混乱到最佳</h1>
<blockquote>原文：<a href="https://itnext.io/from-chaos-to-optimum-with-azure-chaos-studio-8bc0cae20a35?source=collection_archive---------2-----------------------#2022-07-09">https://itnext.io/from-chaos-to-optimum-with-azure-chaos-studio-8bc0cae20a35?source=collection_archive---------2-----------------------#2022-07-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c9aadb53d8111df2b74ae1f384fcaf1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fFuP4i-qWxyg3lggaq5qSg.jpeg"/></div></div></figure><p id="201f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本文中，我将解释什么是Azure Chaos Studio和chaos engineering，如何使用Azure Chaos Studio来测试和提高应用程序的弹性，并分享我对第一次实践经验的想法。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="39cf" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">关于Azure混沌工作室</h1><p id="9f1c" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">在2021年11月2日的<a class="ae mg" href="https://myignite.microsoft.com/" rel="noopener ugc nofollow" target="_blank">微软Ignite </a>上，微软推出了Azure Chaos Studio，自那以后一直在<a class="ae mg" href="https://techcommunity.microsoft.com/t5/azure-governance-and-management/announcing-the-public-preview-of-azure-chaos-studio/ba-p/2893050" rel="noopener ugc nofollow" target="_blank">公开预览</a>。Azure Chaos Studio是一项Azure服务，帮助您测试和提高基于Azure的解决方案的应用程序弹性。</p><h2 id="e7b2" class="mh le iq bd lf mi mj dn lj mk ml dp ln kj mm mn lr kn mo mp lv kr mq mr lz ms bi translated">什么是混沌工程？</h2><p id="c3a2" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">混沌工程是一种方法学，通过强化服务以防止生产中的故障，帮助开发人员获得一致的可靠性。<a class="ae mg" href="https://www.netflix.com/" rel="noopener ugc nofollow" target="_blank">网飞</a>是最早引入混沌工程概念的公司之一，使用了专有的知名工具<a class="ae mg" href="https://netflix.github.io/chaosmonkey/" rel="noopener ugc nofollow" target="_blank">混沌猴子</a>。该工具有意和随机地触发各种故障。这背后的想法是，基础设施有这样一个健壮的级别，它是为这些现实世界的场景准备的。目标是观察、监控、响应和提高系统在不利环境下的可靠性。</p><p id="f017" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">思考混沌工程的另一种方式是，它是关于拥抱复杂系统中固有的混沌，并通过实验，增强对您的解决方案处理混沌的能力的信心。</p><h2 id="bb14" class="mh le iq bd lf mi mj dn lj mk ml dp ln kj mm mn lr kn mo mp lv kr mq mr lz ms bi translated">Azure混沌工作室是什么？</h2><p id="6160" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated"><a class="ae mg" href="https://azure.microsoft.com/services/chaos-studio" rel="noopener ugc nofollow" target="_blank"> Azure Chaos Studio </a>是一个托管服务，它使用chaos engineering来帮助您测量、了解和改进您的云应用程序和服务弹性。它运行可以模拟故障或导致事故的实验，例如某个区域宕机或某个应用程序故障导致虚拟机上的CPU使用率达到100%。</p><p id="006a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">弹性是系统处理和恢复中断的能力。应用程序中断可能会导致错误和故障，从而对您的业务和任务产生负面影响。无论是开发、迁移还是操作Azure应用，验证和提高应用的弹性都是非常重要的。</p><p id="b408" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Azure Chaos Studio中，有三种方式来设置Azure Chaos Studio实验:</p><ul class=""><li id="07d3" class="mt mu iq ka b kb kc kf kg kj mv kn mw kr mx kv my mz na nb bi translated">使用service-direct fault，它直接针对Azure资源运行，不需要任何工具。</li><li id="1e59" class="mt mu iq ka b kb nc kf nd kj ne kn nf kr ng kv my mz na nb bi translated">使用基于代理的故障，这需要设置和安装混沌代理。</li><li id="6c95" class="mt mu iq ka b kb nc kf nd kj ne kn nf kr ng kv my mz na nb bi translated">使用<a class="ae mg" href="https://chaos-mesh.org/" rel="noopener ugc nofollow" target="_blank"> Chaos Mesh </a>，这是一个免费的开源混沌工程平台，Kubernetes可以将故障注入AKS集群。混沌网格故障是服务直接故障，需要在AKS集群上安装混沌网格。</li></ul></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="e241" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">实践中的混乱</h1><p id="ecfd" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">在Azure Chaos Studio 的<a class="ae mg" href="https://docs.microsoft.com/en-us/azure/chaos-studio/" rel="noopener ugc nofollow" target="_blank">文档页面上，微软放置了三个入门指南，分别针对</a><a class="ae mg" href="https://docs.microsoft.com/en-us/azure/chaos-studio/chaos-studio-tutorial-service-direct-portal" rel="noopener ugc nofollow" target="_blank"> service-direct </a>、<a class="ae mg" href="https://docs.microsoft.com/en-us/azure/chaos-studio/chaos-studio-tutorial-agent-based-portal" rel="noopener ugc nofollow" target="_blank"> agent-based </a>和<a class="ae mg" href="https://docs.microsoft.com/en-us/azure/chaos-studio/chaos-studio-tutorial-aks-portal" rel="noopener ugc nofollow" target="_blank"> AKS Chaos Mesh </a>故障。在以下场景中，我使用基于代理的故障和服务导向的故障。</p><p id="5633" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所使用的实验室环境由两台安装了Apache web服务的Linux (Ubuntu 20.04)虚拟机组成，位于负载平衡器之后。它们部署在具有子网和相关网络安全组的虚拟网络上(允许来自互联网的HTTP流量，并允许从我的家庭网络到虚拟机的SSH流量)。</p><figure class="ni nj nk nl gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/5fe916466815afd17546447eeab0fa6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3iPixriosMUuqhjALUxJ0A.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">Rolf Schutten图片</figcaption></figure><p id="cc15" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">虚拟机上发布的页面彼此略有不同，因此我们可以在各自的登录页面上看到哪个虚拟机当前负责发布网页。</p><figure class="ni nj nk nl gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/bd1e129d08c8923852f5a82e92876de3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-wK3owQeKZuvzvk1cmIkAQ.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">Rolf Schutten图片</figcaption></figure><h2 id="8708" class="mh le iq bd lf mi mj dn lj mk ml dp ln kj mm mn lr kn mo mp lv kr mq mr lz ms bi translated">混乱场景#1。意外的CPU峰值</h2><p id="a8d6" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">在这个场景中，我们在其中一个虚拟机上造成一个意外的CPU峰值，以测试负载平衡器设置是否是最佳的，并减少停机时间。用于Linux的Chaos Studio代理需要stress-ng，这是一个开源应用程序，可以在虚拟机上引起各种压力事件。您可以通过<a class="ae mg" href="https://docs.microsoft.com/en-us/azure/virtual-machines/ssh-keys-portal" rel="noopener ugc nofollow" target="_blank">连接到您的Linux虚拟机</a>并为您的包管理器运行适当的安装命令来安装stress-ng，例如:</p><pre class="ni nj nk nl gt nr ns nt nu aw nv bi"><span id="4ac0" class="mh le iq ns b gy nw nx l ny nz">sudo apt-get update &amp;&amp; sudo apt-get -y install unzip &amp;&amp; sudo apt-get -y install stress-ng</span></pre><p id="df8c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Azure Chaos Studio实验看起来是这样的:</p><figure class="ni nj nk nl gt jr gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/2a18a056084264b4e7ef51d8394659c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1368/format:webp/1*2gWznKiSPx4haGbxdh08BQ.png"/></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">Rolf Schutten图片</figcaption></figure><p id="66ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在开始实验后，CPU的利用率立即增加，stress-ng显然完成了它的工作。</p><figure class="ni nj nk nl gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/e0340b25671ad4457610e1b58219f82e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ldfGaXjmuFPNxv6poGRlkw.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">Rolf Schutten图片</figcaption></figure><p id="798f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当访问位于发布网页的虚拟机前面的负载平衡器的公共IP地址时，两个网页(运行在不同的虚拟机上)在运行实验时仍然显示。这是意料之中的，因为目标虚拟机仍在运行并处于活动状态，而且在实验室环境中，网页是通过HTTP访问的。因此，在负载平衡器中设置了HTTP健康探测器。使用HTTP运行状况探测器，不可能根据虚拟机的CPU利用率来平衡负载。使用HTTPS健康探测器，您可以通过向健康探测器添加自定义脚本来实现。在实际场景中，如果需要根据底层虚拟机的CPU利用率来平衡负载，则必须使用自定义脚本来设置HTTPS运行状况探测器。</p><h2 id="83b9" class="mh le iq bd lf mi mj dn lj mk ml dp ln kj mm mn lr kn mo mp lv kr mq mr lz ms bi translated">混乱场景二。意外的数据中心或区域故障</h2><p id="3740" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">在这个场景中，我们造成Azure zone的意外中断，以测试将虚拟机放在不同的可用性区域中是否能够完成工作并减少中断。虚拟机1位于可用性区域1，虚拟机2位于可用性区域2。其他资源是区域服务。</p><p id="9ffb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Azure Chaos Studio实验看起来是这样的:</p><figure class="ni nj nk nl gt jr gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/30b2415abe9c4aaa38d56738f12957e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1368/format:webp/1*NdogJQh0KBh-Ggg4UQ_TFA.png"/></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">Rolf Schutten图片</figcaption></figure><p id="7005" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">启动实验后，目标虚拟机立即进入停止状态。当访问位于发布网页的虚拟机前面的负载平衡器的公共IP地址时，在运行实验时，只显示一个(非目标虚拟机的)网页。这是意料之中的，因为负载平衡器将我们路由到非目标虚拟机，因为配置的运行状况探测器向目标虚拟机的负载平衡器发出了否定信号。</p><p id="97e4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">实验结束后，目标虚拟机将(自动)正确重启，并且可以再次访问其网页。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="4040" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">结束语</h1><p id="5880" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">当我想到混沌工程时，我会想到终止(预)生产中的场景，以确保工程师实现他们的服务对实例故障具有弹性。这正是Azure Chaos Studio所做的。使用Azure Chaos Studio是安全的，而且多少有些可预测性:你的实验是一个工作流，在那里你决定什么是触发器(以及什么时候)，这可能是你的构建和发布管道的一部分。</p><figure class="ni nj nk nl gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/6b55128cf3db990cee4990931a5ba46c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZdIgNeps8IhouqUuhICUJA.jpeg"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">图片由<a class="ae mg" href="https://azure.microsoft.com/en-us/services/chaos-studio/" rel="noopener ugc nofollow" target="_blank">微软</a></figcaption></figure><p id="01ec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">微软已经建立了一个很好的标准错误和行为库，这将有助于大多数专业人士评估他们的基础设施的弹性。这就是Azure Chaos Studio的优势所在:在计划的时间内，针对特定的场景进行评估和证明。这对托管服务提供商(MSP)和独立软件供应商(ISV)来说是非常有价值的。并非不重要，CI/CD管道中的集成可能性是非常有前途的。</p></div></div>    
</body>
</html>