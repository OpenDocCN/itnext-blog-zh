<html>
<head>
<title>Micro-Training: AKS Auditing Resource Deletions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">微型培训:AKS审核资源删除</h1>
<blockquote>原文：<a href="https://itnext.io/micro-training-aks-auditing-resource-deletions-287968e9ca14?source=collection_archive---------8-----------------------#2022-12-21">https://itnext.io/micro-training-aks-auditing-resource-deletions-287968e9ca14?source=collection_archive---------8-----------------------#2022-12-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="527d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这需要在集群上安装<a class="ae kl" href="https://learn.microsoft.com/en-us/azure/azure-monitor/containers/container-insights-enable-aks?tabs=azure-cli" rel="noopener ugc nofollow" target="_blank"> container insights </a>，并正确配置日志分析工作区。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><p id="e0e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从集群诊断设置区域启用KubeAudit诊断设置。</p><pre class="kt ku kv kw gt kx ky kz bn la lb bi"><span id="5272" class="lc ld iq ky b be le lf l lg lh">Monitoring -&gt; Diagnostic settings -&gt; Add diagnostic setting<br/><br/>Enter a name -&gt; Kubernetes Audit -&gt; Send to Log Analytics workspace<br/><br/>Save</span></pre><figure class="kt ku kv kw gt lj gh gi paragraph-image"><div class="gh gi li"><img src="../Images/4a9bcfd92e0f9f381fb96ca66c20f979.png" data-original-src="https://miro.medium.com/v2/resize:fit:872/0*qECEYj7SUN8m90IK"/></div></figure></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><ul class=""><li id="eb15" class="lm ln iq jp b jq jr ju jv jy lo kc lp kg lq kk lr ls lt lu bi translated">监控-&gt;日志</li><li id="cdb5" class="lm ln iq jp b jq lv ju lw jy lx kc ly kg lz kk lr ls lt lu bi translated">退出弹出的查询</li><li id="dad5" class="lm ln iq jp b jq lv ju lw jy lx kc ly kg lz kk lr ls lt lu bi translated">摄入一段时间后，您应该会看到AzureMetrics表。</li></ul><figure class="kt ku kv kw gt lj gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/5bc329060e31693b6aee572c945eaa7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:584/format:webp/1*zUo_UGgKm5ZkWPeVC4kWLQ.png"/></div></figure><p id="3a13" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行下面的查询，该查询将解析日志并提取数据，以突出显示谁删除了什么、从哪里删除、时间等。请记住，在非RBAC集群中，您不会像预期的那样看到用户名。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><pre class="kt ku kv kw gt kx ky kz bn la lb bi"><span id="ff29" class="lc ld iq ky b be le lf l lg lh">//Who deleted stuff?<br/>AzureDiagnostics<br/>| where Category == "kube-audit"<br/>| extend JSON = parse_json(log_s)<br/>| extend stage = JSON.stage<br/>| extend verb = JSON.verb<br/>| where stage == "ResponseComplete"<br/>    and verb == "delete"<br/>| extend userAgent = JSON.userAgent<br/>| extend user = JSON.user.username<br/>| extend sourceIPs = JSON.sourceIPs<br/>| extend resourceType = JSON.objectRef.resource<br/>| extend resourceName = JSON.objectRef.name<br/>| extend requestUri = JSON.requestURI<br/>| project TimeGenerated, verb, user, sourceIPs, resourceType, resourceName, requestUri, JSON</span></pre><figure class="kt ku kv kw gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mb"><img src="../Images/2b708d41f5923abd6182c76514b26d0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o4ZlmJWIHh7ynQ0kB87vZQ.png"/></div></div></figure></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><p id="c0d2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就像这样，您可以解析json日志并打印出有用信息。随心所欲地调整它。</p><p id="8156" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你喜欢这样的东西，请鼓掌，如果有你想看的特别的东西，请告诉我。</p><h1 id="5b3b" class="mg ld iq bd mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc bi translated">其他感兴趣的链接</h1><ul class=""><li id="70fe" class="lm ln iq jp b jq nd ju ne jy nf kc ng kg nh kk lr ls lt lu bi translated"><a class="ae kl" href="https://learn.microsoft.com/en-us/azure/azure-monitor/containers/container-insights-onboard" rel="noopener ugc nofollow" target="_blank">集装箱见解</a></li><li id="9571" class="lm ln iq jp b jq lv ju lw jy lx kc ly kg lz kk lr ls lt lu bi translated"><a class="ae kl" href="https://learn.microsoft.com/en-us/azure/azure-monitor/essentials/data-collection" rel="noopener ugc nofollow" target="_blank">日志分析数据收集</a></li><li id="045f" class="lm ln iq jp b jq lv ju lw jy lx kc ly kg lz kk lr ls lt lu bi translated"><a class="ae kl" href="https://learn.microsoft.com/en-us/azure/azure-monitor/agents/log-analytics-agent" rel="noopener ugc nofollow" target="_blank">日志分析代理</a></li><li id="50ae" class="lm ln iq jp b jq lv ju lw jy lx kc ly kg lz kk lr ls lt lu bi translated"><a class="ae kl" href="https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/" rel="noopener ugc nofollow" target="_blank"> KQL语言</a></li></ul></div></div>    
</body>
</html>