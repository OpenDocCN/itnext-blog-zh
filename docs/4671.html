<html>
<head>
<title>Ansible: Easy and Safe SSH deployments from GitHub</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ansible:来自GitHub的简单安全的SSH部署</h1>
<blockquote>原文：<a href="https://itnext.io/ansible-easy-and-safe-ssh-deployments-from-github-44548e041dd5?source=collection_archive---------4-----------------------#2020-08-19">https://itnext.io/ansible-easy-and-safe-ssh-deployments-from-github-44548e041dd5?source=collection_archive---------4-----------------------#2020-08-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/0a9c642ec9b5dee43516504b435d22da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZfyoN1rF7hCcATL2.jpg"/></div></div></figure><p id="b8b9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Ansible是一个服务器编排工具，您也可以使用它以可预测和可重复的方式在远程机器上执行工作流。在之前的文章<a class="ae kz" href="https://roelofjanelsinga.com/articles/automating-laravel-deployment-using-ansible" rel="noopener ugc nofollow" target="_blank">“使用Ansible自动化Laravel部署”</a>中，我已经列出了如何使用GitHub用户名和用户令牌使用Ansible Vault部署应用程序。但是，您也可以使用SSH来实现这一点，确保您的服务器只对您的应用程序存储库进行拉取访问。这个额外的安全层很容易实现，所以在这篇文章中，我们将看看如何做到这一点。</p><p id="601d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这篇博文中，我们将按照以下步骤使用与之前相同的配置，但是使用SSH而不是用户令牌或密码:</p><ol class=""><li id="0c93" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">在服务器上生成SSH密钥</li><li id="ab93" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">将公共SSH密钥作为部署密钥提交给GitHub</li><li id="ecdd" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">使用SSH部署您的应用程序</li></ol><h1 id="b511" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">先决条件</h1><p id="24c7" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">你可以使用<a class="ae kz" href="https://roelofjanelsinga.com/articles/automating-laravel-deployment-using-ansible" rel="noopener ugc nofollow" target="_blank">以前的博客文章</a>中的配置来部署你的应用程序，这篇文章中唯一的不同是你不需要Ansible Vault，所以你可以从那篇文章中提到的配置中删除“vars_files”键。除此之外，您还需要使用SSH地址作为“github_repo_url”值:<a class="ae kz" href="https://roelofjanelsinga.com/cdn-cgi/l/email-protection" rel="noopener ugc nofollow" target="_blank">【电子邮件保护】</a>:your-username/your-repository . git</p><h1 id="e7aa" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">在服务器上生成SSH密钥</h1><p id="1c48" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">在服务器上生成SSH密钥是一个快速的过程，只需要一个命令:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="57d2" class="na lp it mw b gy nb nc l nd ne">ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa</span></pre><p id="ce92" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们来分解一下:</p><ul class=""><li id="d698" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky nf lg lh li bi translated">“-t”:这是我们定义公钥算法并将其设置为“RSA”的地方</li><li id="703f" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky nf lg lh li bi translated">"-b ":我们将密钥大小设置为4096位(不要再低了)</li><li id="36da" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky nf lg lh li bi translated">"-f ":我们正在指定我们想要使用的文件名。</li></ul><p id="b0c0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">指定文件名时，请确保该文件不存在。这将导致现有的密钥被覆盖，这可能会中断您可能拥有的其他SSH连接。如果文件已经存在，请选择不同的名称:~/。例如，ssh/your_repository_name。</p><p id="4165" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您最终使用了不同于“id_rsa”的文件名，您需要进行额外的更改:</p><ol class=""><li id="9d0b" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">创建和/或打开以下文件:~/。ssh/config</li><li id="cc3c" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">添加下面的代码片段</li><li id="e4bb" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">更新您的存储库的SSH地址以使用定制的SSH密钥</li></ol><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="9321" class="na lp it mw b gy nb nc l nd ne">Host github_server <br/>  Hostname github.com <br/>  IdentityFile ~/.ssh/your_repository_name <br/>  IdentitiesOnly yes</span></pre><p id="ef29" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">并将Ansible中存储库的SSH地址更改为<a class="ae kz" href="https://roelofjanelsinga.com/cdn-cgi/l/email-protection" rel="noopener ugc nofollow" target="_blank">【email protected】</a>_ server:your-username/your-repository . git。注意，我们不再使用github.com，而是使用我们的自定义配置:github_server。</p><h1 id="57c6" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">将公共SSH密钥作为部署密钥提交给GitHub</h1><p id="7d07" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">现在我们已经在服务器上生成了一个私有和公共的SSH密钥，我们可以将其作为“部署密钥”添加到我们的GitHub存储库中。<a class="ae kz" href="https://developer.github.com/v3/guides/managing-deploy-keys/#deploy-keys" rel="noopener ugc nofollow" target="_blank">部署密钥</a>是允许另一台机器访问单个GitHub存储库的SSH密钥。您作为存储库所有者，甚至可以指定远程计算机是否具有推送权限。默认情况下，部署密钥只具有拉访问权限，这正是我们想要的部署。我们不想要推送特权，也不想让远程机器无限制地访问我们的整个GitHub帐户。</p><p id="4187" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要从服务器获取公共SSH密钥，请运行以下命令:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="0d82" class="na lp it mw b gy nb nc l nd ne">cat ~/.ssh/id_rsa.pub</span></pre><p id="1cab" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您使用自定义名称作为SSH密钥，请改用该名称。这可能是:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="d640" class="na lp it mw b gy nb nc l nd ne">cat ~/.ssh/your_repository_name.pub</span></pre><p id="fb07" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">注意。SSH密钥后面的酒吧，这是你的公钥。你可以把这个给别人，只是要确保永远不要把你的私钥给别人(没有。酒吧在尽头)。私人文件的内容必须始终保密。</p><p id="f3fe" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您现在应该在终端中看到您的公钥，从“ssh-rsa”开始。复制整个密钥，包括ssh-rsa和末尾的机器名称。这都是你的公钥的一部分。</p><p id="3c9e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，转到您在GitHub上的存储库，导航到“设置”选项卡-&gt;部署密钥-&gt;添加部署密钥。</p><p id="2e86" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">给你的部署密钥一个可识别的标题，像“生产服务器”，并在“密钥”字段中粘贴公共SSH密钥。不要选中“允许写访问”复选框，除非您确实需要。现在单击“添加密钥”，您应该会在概览中看到新创建的部署密钥。</p><h1 id="fbcc" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">使用SSH部署您的应用程序</h1><p id="c688" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">现在，您已经将服务器连接到了GitHub存储库中，您可以对应用程序进行一些更改，并提交您的更改。当您准备好部署更改时，执行您的Ansible行动手册，并使用新的SSH设置查看应用程序的部署情况。您可以通过刷新GitHub中的“部署密钥”概述来验证您的SSH密钥是否用于提取您的更改。您的部署密钥现在应该是绿色的，而不是灰色的，并且应该有一条消息说“上周内最后一次使用”。</p><p id="e6a2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要执行您的Ansible行动手册，您可以使用以下命令:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="7002" class="na lp it mw b gy nb nc l nd ne">ansible-playbook your-configuration-file.yml</span></pre><h1 id="26db" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">结论</h1><p id="1d46" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">使用SSH从GitHub部署应用程序并不困难，您也不必让您的远程机器访问您的整个GitHub帐户。在本文中，我们将通过GitHub中的部署密钥来使用SSH，只允许您的远程机器拉访问单个存储库，以安全轻松地部署您的应用程序。</p><p id="765c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我写这篇博文是为了分享我最近使用Ansible部署应用程序的发现。我可能会错过一些东西，因为我自己也是新手。新的发现总是会在新的博客文章中被提及，不准确的地方会在这篇文章中被修正，以确保我没有传播错误的信息。因此，如果您发现了错误，请让我知道，并帮助我将质量信息传播给其他软件工程师。</p><p id="c941" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">发布时间:2020年8月19日</p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><p id="e611" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="nn">最初发表于</em><a class="ae kz" href="https://roelofjanelsinga.com/articles/ansible-easy-safe-ssh-deployments-from-github" rel="noopener ugc nofollow" target="_blank"><em class="nn">【https://roelofjanelsinga.com】</em></a><em class="nn">。</em></p></div></div>    
</body>
</html>