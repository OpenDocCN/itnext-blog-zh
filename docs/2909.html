<html>
<head>
<title>Push Notifications in JavaScript? Yes, you can!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">JavaScript中的推送通知？是的，你可以！</h1>
<blockquote>原文：<a href="https://itnext.io/an-introduction-to-web-push-notifications-a701783917ce?source=collection_archive---------0-----------------------#2019-08-27">https://itnext.io/an-introduction-to-web-push-notifications-a701783917ce?source=collection_archive---------0-----------------------#2019-08-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="81d0" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">开始使用Web推送通知。如何用JavaScript实现推送通知</h2><div class=""/><div class=""><h2 id="1173" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">有工作代码样本和简单的解释。</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/4075a5bb0d5a34735683e487ba7ad46a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W1nZrfSnlkDELSU8uFkZ2w.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">最后的结果</figcaption></figure><p id="2e24" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">TLDR:你真差劲，你只是想要代码。</p><p id="e6c7" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">您可以在这里看到我们将要制作的现场演示:</p><div class="ma mb gp gr mc md"><a href="https://push-notifications-demo.netlify.app/" rel="noopener  ugc nofollow" target="_blank"><div class="me ab fo"><div class="mf ab mg cl cj mh"><h2 class="bd ja gy z fp mi fr fs mj fu fw iz bi translated">网络推送通知</h2><div class="mk l"><h3 class="bd b gy z fp mi fr fs mj fu fw dk translated">询问用户许可这将创建一个必须发送到推送服务器创建通知的端点…</h3></div><div class="ml l"><p class="bd b dl z fp mi fr fs mj fu fw dk translated">推送-通知-demo.netlify.app</p></div></div><div class="mm l"><div class="mn l mo mp mq mm mr ky md"/></div></div></a></div><p id="ebf9" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">您可以下载并在本地运行该演示，完整说明的源代码在这里:</p><div class="ma mb gp gr mc md"><a href="https://github.com/Spyna/push-notification-demo" rel="noopener  ugc nofollow" target="_blank"><div class="me ab fo"><div class="mf ab mg cl cj mh"><h2 class="bd ja gy z fp mi fr fs mj fu fw iz bi translated">spyna/推送通知-演示</h2><div class="mk l"><h3 class="bd b gy z fp mi fr fs mj fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="ml l"><p class="bd b dl z fp mi fr fs mj fu fw dk translated">github.com</p></div></div><div class="mm l"><div class="ms l mo mp mq mm mr ky md"/></div></div></a></div></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><p id="739a" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">你将揭开推送通知的秘密，准备好了吗？我们开始吧。</p><p id="4d2f" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">第一个事实:推送通知由两部分组成:</p><ul class=""><li id="a173" class="na nb iq lg b lh li lk ll ln nc lr nd lv ne lz nf ng nh ni bi translated">推送:从服务器向应用程序发送通知的行为。是的，你需要一台服务器😅。</li><li id="84c9" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">通知:显示在智能手机状态栏或浏览器上的实际通知。</li></ul><h2 id="e515" class="no np iq bd nq nr ns dn nt nu nv dp nw ln nx ny nz lr oa ob oc lv od oe of iw bi translated">网络推送通知流程</h2><p id="31e2" class="pw-post-body-paragraph le lf iq lg b lh og ka lj lk oh kd lm ln oi lp lq lr oj lt lu lv ok lx ly lz ij bi translated">网络推送通知是一个包含4个参与者的协议:</p><ul class=""><li id="a42f" class="na nb iq lg b lh li lk ll ln nc lr nd lv ne lz nf ng nh ni bi translated"><strong class="lg ja">用户</strong>:希望接收通知的用户。</li><li id="f78c" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">运行在用户代理(通常是浏览器)上的<strong class="lg ja">应用</strong></li><li id="a6f5" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated"><strong class="lg ja">服务人员</strong>:运行在浏览器上</li><li id="be07" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated"><strong class="lg ja">推送服务器</strong>:向服务人员发送推送消息</li></ul><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ol"><img src="../Images/c4c6c6ad82ff4e39ed0aa1ec6244ebe3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hP_7w2Ig9Iwk_Vef0DafcA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">推送通知实现流程</figcaption></figure><ol class=""><li id="a990" class="na nb iq lg b lh li lk ll ln nc lr nd lv ne lz om ng nh ni bi translated">当应用程序<strong class="lg ja">要求用户同意</strong>显示通知时，流程开始。</li></ol><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi on"><img src="../Images/2a777684751ce4164da95c8fca9f149a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PGSd0hz6OdZd5dn3D8IYEg.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">浏览器要求用户同意显示推送通知</figcaption></figure><p id="a097" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">2.一旦用户同意接收通知，应用程序就注册一个<strong class="lg ja">服务工作者</strong>(稍后我将解释什么是服务工作者)。</p><p id="a684" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">4.当应用接收到服务工作者注册时，它可以使用它来创建<strong class="lg ja">推送通知订阅。</strong>注册创建了一个端点，向其发送推送消息。</p><p id="f79c" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">7.此时，应用向<strong class="lg ja">推送服务器发送推送通知注册。</strong>推送服务器需要订阅的端点来发送消息。</p><p id="0c50" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">8.当推送服务器接收到推送订阅时，它保存它。</p><p id="680c" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">9.推送服务器向订阅的端点发送推送消息，接着，服务工作者接收到该消息，该服务工作者具有对<strong class="lg ja">推送事件</strong>的监听器。</p><p id="c147" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">10.服务人员向用户显示通知</p><p id="6781" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">11.当用户单击通知或通知操作(稍后您将看到是什么操作)时，服务工作器接收到该点击，因为它有一个对<strong class="lg ja">通知点击事件的监听器。</strong></p><p id="c86e" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">12.当服务人员接收到点击时，它可以对通知和通知数据做任何它想做的事情，比如显示网页、调用API，或者任何你能想到的事情。</p><p id="4a44" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">现在您已经知道了流程，是时候继续进行真正的实现了。</p></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><h1 id="3f73" class="oo np iq bd nq op oq or nt os ot ou nw kf ov kg nz ki ow kj oc kl ox km of oy bi translated">通知</h1><h2 id="ec34" class="no np iq bd nq nr ns dn nt nu nv dp nw ln nx ny nz lr oa ob oc lv od oe of iw bi translated">询问用户许可</h2><p id="bf48" class="pw-post-body-paragraph le lf iq lg b lh og ka lj lk oh kd lm ln oi lp lq lr oj lt lu lv ok lx ly lz ij bi translated">要发送通知，您需要请求用户的许可。未经用户同意，不能发送通知。用户可以:</p><ul class=""><li id="89c1" class="na nb iq lg b lh li lk ll ln nc lr nd lv ne lz nf ng nh ni bi translated">什么都不做:<code class="fe oz pa pb pc b">default</code>不会显示通知</li><li id="edd2" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">Grant: <code class="fe oz pa pb pc b">granted</code>将显示通知</li><li id="d032" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">拒绝:<code class="fe oz pa pb pc b">denied</code>通知不会显示</li></ul><h2 id="22b4" class="no np iq bd nq nr ns dn nt nu nv dp nw ln nx ny nz lr oa ob oc lv od oe of iw bi translated">什么是通知</h2><p id="2a9d" class="pw-post-body-paragraph le lf iq lg b lh og ka lj lk oh kd lm ln oi lp lq lr oj lt lu lv ok lx ly lz ij bi translated">通知是一个JavaScript对象，具有一些属性和方法:标题、数据、图标、图像等等。我们稍后将查看这些属性。</p><p id="2619" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">键入<code class="fe oz pa pb pc b">new Notification()</code>是一个很好的起点。重击🤟！你完了。</p><p id="96b2" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">让我们添加一个标题和一些选项，使它看起来更好。在这个链接，你可以看到选项的完整列表。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="pe pf l"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">显示web通知的示例代码</figcaption></figure><p id="de88" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">上面的代码片段显示了一个<em class="pg">推送通知</em>，带有标题、文本、图像、动作和其他一些好东西。结果在您的智能手机上会是这样的:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ph"><img src="../Images/660061e52a51a00b718060e10a60014c.png" data-original-src="https://miro.medium.com/v2/resize:fit:936/format:webp/1*sMTQpz5G-M9eQSr4_hoLvg.png"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">这是生成的通知</figcaption></figure><p id="5f07" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">正如您在代码示例(<code class="fe oz pa pb pc b">navigator.serviceWorker.ready...</code>)中看到的，要显示这种通知，您需要使用一个<strong class="lg ja">服务工作器</strong> r</p><h2 id="68de" class="no np iq bd nq nr ns dn nt nu nv dp nw ln nx ny nz lr oa ob oc lv od oe of iw bi translated">服务人员</h2><p id="22e5" class="pw-post-body-paragraph le lf iq lg b lh og ka lj lk oh kd lm ln oi lp lq lr oj lt lu lv ok lx ly lz ij bi translated">根据<a class="ae pd" href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API" rel="noopener ugc nofollow" target="_blank"> Mdn </a>:</p><blockquote class="pi pj pk"><p id="4e96" class="le lf pg lg b lh li ka lj lk ll kd lm pl lo lp lq pm ls lt lu pn lw lx ly lz ij bi translated">服务工作者本质上充当代理服务器，位于web应用程序、浏览器和网络(如果可用的话)之间。</p></blockquote><p id="6bb2" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">为了简单起见，我们可以说<em class="pg">服务工作者</em>是一个JavaScript文件，它在应用程序的后台以一个单独的线程运行。它可以与应用程序“对话”,必须注册，不能访问dom，只能在HTTPS或本地主机下运行。</p><p id="bb32" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">一旦你了解了服务人员的工作方式，他们就很容易了。</p><h2 id="d482" class="no np iq bd nq nr ns dn nt nu nv dp nw ln nx ny nz lr oa ob oc lv od oe of iw bi translated">把东西放在一起</h2><p id="e82c" class="pw-post-body-paragraph le lf iq lg b lh og ka lj lk oh kd lm ln oi lp lq lr oj lt lu lv ok lx ly lz ij bi translated">为了让推送通知发挥作用，我们将创建:</p><ul class=""><li id="9702" class="na nb iq lg b lh li lk ll ln nc lr nd lv ne lz nf ng nh ni bi translated">请求用户许可的JavaScript文件</li><li id="02ac" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">管理通知的服务人员</li></ul><p id="4722" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">让我们创建一个名为<code class="fe oz pa pb pc b">push-notifications.js</code>的文件:</p><ul class=""><li id="a9c0" class="na nb iq lg b lh li lk ll ln nc lr nd lv ne lz nf ng nh ni bi translated">了解浏览器是否支持推送通知。</li><li id="94fc" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">要求用户同意</li><li id="4f05" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">注册一个<em class="pg">服务人员</em>，</li><li id="ce61" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">使用服务人员显示通知</li></ul><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="pe pf l"/></div></figure><p id="197f" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">该脚本导出上述所有函数。要使用这些函数，我们可以使用这样的脚本:(这只是一个示例，我将在文章结尾分享完整的代码)</p><pre class="kp kq kr ks gt po pc pp pq aw pr bi"><span id="8774" class="no np iq pc b gy ps pt l pu pv">import {<br/> isPushNotificationSupported,<br/> sendNotification,<br/> initializePushNotifications,<br/> registerServiceWorker<br/>} from "./push-notifications.js";</span><span id="620f" class="no np iq pc b gy pw pt l pu pv">const pushNotificationSuported = isPushNotificationSupported();</span><span id="4217" class="no np iq pc b gy pw pt l pu pv">if (pushNotificationSuported) {</span><span id="6641" class="no np iq pc b gy pw pt l pu pv">registerServiceWorker();<br/>  initializePushNotifications().then(function(consent){<br/>    if(consent === 'granted') {<br/>     sendNotification();<br/>    }<br/>  });</span><span id="787a" class="no np iq pc b gy pw pt l pu pv">}</span></pre><p id="6cb5" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">接下来，创建服务人员文件:<code class="fe oz pa pb pc b">sw.js</code>。现在，它将是一个空文件。</p></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><h1 id="73fc" class="oo np iq bd nq op oq or nt os ot ou nw kf ov kg nz ki ow kj oc kl ox km of oy bi translated">推</h1><p id="b5b4" class="pw-post-body-paragraph le lf iq lg b lh og ka lj lk oh kd lm ln oi lp lq lr oj lt lu lv ok lx ly lz ij bi translated">如开头所述，您需要一个服务器来向用户发送通知。我们称它为<strong class="lg ja">推送服务器</strong>。</p><p id="67de" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">设想这样一个场景:一个电子商务网站想要在新产品发布时向用户发送通知。这些是必需的步骤:</p><ul class=""><li id="4f3b" class="na nb iq lg b lh li lk ll ln nc lr nd lv ne lz nf ng nh ni bi translated">服务人员创建推送通知<strong class="lg ja">订阅</strong>。</li><li id="50b1" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">这个<strong class="lg ja">订阅</strong>为应用程序/服务工作者/用户创建了一个唯一的<strong class="lg ja">端点</strong>。这个端点是推送服务器将用来向其发送推送消息的端点。</li><li id="bdb7" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">应用程序将<strong class="lg ja">端点</strong>发送到<strong class="lg ja">推送服务器</strong>。</li><li id="1877" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated"><strong class="lg ja">推送服务器</strong>保存用户的订阅。</li><li id="53c8" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">当发布新产品时，<strong class="lg ja">推送服务器</strong>向保存的订阅端点发送推送消息/通知。</li><li id="bb57" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">由应用程序注册的服务人员接收通知，并将其显示给用户。</li></ul><h2 id="439c" class="no np iq bd nq nr ns dn nt nu nv dp nw ln nx ny nz lr oa ob oc lv od oe of iw bi translated">创建推送通知订阅。</h2><p id="7ef9" class="pw-post-body-paragraph le lf iq lg b lh og ka lj lk oh kd lm ln oi lp lq lr oj lt lu lv ok lx ly lz ij bi translated">要创建推送通知订阅，您可以使用方法<code class="fe oz pa pb pc b">serviceWorker.pushManager.subscribe()</code>(这里描述的<a class="ae pd" href="https://developer.mozilla.org/en-US/docs/Web/API/PushManager/subscribe" rel="noopener ugc nofollow" target="_blank">)来获取表示选项的参数。这些选项的属性是:</a></p><ul class=""><li id="3a9f" class="na nb iq lg b lh li lk ll ln nc lr nd lv ne lz nf ng nh ni bi translated">userVisibleOnly:一个布尔值，指示返回的推送订阅将仅用于其效果对用户可见的消息。</li><li id="7a08" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">applicationServerKey:一个<a class="ae pd" href="https://en.wikipedia.org/wiki/Elliptic_Curve_Digital_Signature_Algorithm" rel="noopener ugc nofollow" target="_blank"> ECDSA </a>(椭圆曲线数字签名算法)P-256公钥，推送服务器将使用它来认证您的应用程序。不要担心，稍后我将向您展示如何创建它。</li></ul><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="pe pf l"/></div></figure><p id="ee8d" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">访问服务人员最安全的方法<code class="fe oz pa pb pc b">navigator.serviceWorker.ready</code>返回一个解决<em class="pg">服务人员注册的承诺。当服务人员准备好的时候，这个承诺就兑现了。如果我们以其他方式访问服务人员，它可能没有准备好(可能<em class="pg">正在安装</em>，或者<em class="pg">正在等待</em>)。</em></p><h2 id="8634" class="no np iq bd nq nr ns dn nt nu nv dp nw ln nx ny nz lr oa ob oc lv od oe of iw bi translated">将订阅发送到服务器。</h2><p id="c8a4" class="pw-post-body-paragraph le lf iq lg b lh og ka lj lk oh kd lm ln oi lp lq lr oj lt lu lv ok lx ly lz ij bi translated">将订阅发送到服务器没有标准的方法，需要记住的重要事情是:</p><ul class=""><li id="7b75" class="na nb iq lg b lh li lk ll ln nc lr nd lv ne lz nf ng nh ni bi translated">应用程序和推送服务器之间的通信必须是<strong class="lg ja"> <em class="pg">安全的</em> </strong>，因为订阅信息是发送通知所需的信息。如果被盗可以用来代表应用程序发送不想要的通知。</li><li id="4cc2" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">如果可能，订阅应该与特定用户相关联，以便仅发送相关通知。</li></ul><p id="62d8" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">这可以通过简单的获取或应用程序的HTTP客户端(如果存在)来实现。要发送的对象是一个<code class="fe oz pa pb pc b"><a class="ae pd" href="https://developer.mozilla.org/en-US/docs/Web/API/PushSubscription" rel="noopener ugc nofollow" target="_blank">PushSubscription</a></code>。类似这样的东西</p><pre class="kp kq kr ks gt po pc pp pq aw pr bi"><span id="14e6" class="no np iq pc b gy ps pt l pu pv">fetch(’push-server/user/{id}/push-subscription’, {<br/>headers: { "content-type": "application/json;charset=UTF-8", "sec-fetch-mode": "cors" , &lt;AUTH HEADERS&gt;},<br/>body: JSON.stringify(subscription),<br/>method: "POST",<br/>mode: "cors"<br/>})</span></pre><p id="6a3a" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">接收这个调用的推送服务器应该验证并保存请求，这个例子是用<code class="fe oz pa pb pc b">express</code>和NodeJS在内存中的地图上保存订阅。在生产中，您希望更持久地保存订阅，如数据库。</p><pre class="kp kq kr ks gt po pc pp pq aw pr bi"><span id="a180" class="no np iq pc b gy ps pt l pu pv">function handlePushNotificationSubscription(req, res) {<br/>  const subscriptionRequest = req.body;<br/>  const susbscriptionId = createHash(JSON.stringify(subscriptionRequest));<br/>  subscriptions[susbscriptionId] = subscriptionRequest;<br/>  res.status(201).json({ id: susbscriptionId });<br/>}</span><span id="0916" class="no np iq pc b gy pw pt l pu pv">app.post("/subscription", handlePushNotificationSubscription);</span></pre><p id="5e85" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">完整代码在这里:<a class="ae pd" href="https://github.com/Spyna/push-notification-demo/blob/master/back-end/src/subscriptionHandler.js#L18" rel="noopener ugc nofollow" target="_blank">https://github . com/Spyna/push-notification-demo/blob/master/back-end/src/subscription handler . js # L18</a></p><h2 id="bd5c" class="no np iq bd nq nr ns dn nt nu nv dp nw ln nx ny nz lr oa ob oc lv od oe of iw bi translated">发送推送通知</h2><p id="1a37" class="pw-post-body-paragraph le lf iq lg b lh og ka lj lk oh kd lm ln oi lp lq lr oj lt lu lv ok lx ly lz ij bi translated">这是推送服务器的工作。有一些实现推送服务器的库和框架，我将向您展示一个用JavaScript和NodeJS制作的例子。下面的代码使用了一个名为web-push的库</p><pre class="kp kq kr ks gt po pc pp pq aw pr bi"><span id="ead9" class="no np iq pc b gy ps pt l pu pv">const webpush = require("web-push");</span><span id="4b20" class="no np iq pc b gy pw pt l pu pv">// <strong class="pc ja">VAPID</strong> keys should only be generated only once.<br/>// const vapidKeys = webpush.generateVAPIDKeys();</span><span id="1337" class="no np iq pc b gy pw pt l pu pv">const vapidKeys = {<br/>  privateKey: "bdSiNzUhUP6piAxLH-tW88zfBlWWveIx0dAsDO66aVU",<br/>  publicKey: "BIN2Jc5Vmkmy-S3AUrcMlpKxJpLeVRAfu9WBqUbJ70SJOCWGCGXKY-Xzyh7HDr6KbRDGYHjqZ06OcS3BjD7uAm8"<br/>};</span><span id="a386" class="no np iq pc b gy pw pt l pu pv">webpush.setVapidDetails("<a class="ae pd" href="mailto:example@yourdomain.org" rel="noopener ugc nofollow" target="_blank">example@yourdomain.org</a>", vapidKeys.publicKey, vapidKeys.privateKey);</span><span id="e3cd" class="no np iq pc b gy pw pt l pu pv">webpush.sendNotification(<strong class="pc ja">pushSubscription</strong>, "The text of the notification")</span></pre><p id="e2e8" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">Vapid的意思是<em class="pg">自愿的应用服务器标识</em>并且是这里记录的<a class="ae pd" href="https://tools.ietf.org/html/rfc8292" rel="noopener ugc nofollow" target="_blank">web标准。</a></p><p id="859f" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">VAPID公钥是与web应用程序(发送通知订阅的那个)共享的公钥。</p><p id="4a7e" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">方法<code class="fe oz pa pb pc b">sendNotification</code>接受两个参数:</p><ul class=""><li id="8b1c" class="na nb iq lg b lh li lk ll ln nc lr nd lv ne lz nf ng nh ni bi translated"><em class="pg"> pushSubscription </em>:一个<code class="fe oz pa pb pc b">PushSubscription </code>对象，就是通过前面说的<code class="fe oz pa pb pc b">serviceWorker.pushManager.subscribe()</code>方法从服务工作者那里得到的那个。</li><li id="bd44" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">payload:推送通知的内容，必须是字符串或缓冲区。这个例子是一个简单的文本，但是它可以是更有趣的东西，比如关于要显示的通知的信息或者要调用的API的引用，简而言之，就是您希望在通知中包含的任何内容。</li></ul><pre class="kp kq kr ks gt po pc pp pq aw pr bi"><span id="c26f" class="no np iq pc b gy ps pt l pu pv">const payload = JSON.stringify({<br/>        title: "New Product Available ",<br/>        text: "HEY! Take a look at this brand new t-shirt!",<br/>        image: "/images/jason-leung-HM6TMmevbZQ-unsplash.jpg",<br/>        tag: "new-product",<br/>        url: "/new-product-jason-leung-HM6TMmevbZQ-unsplash.html"<br/>      });</span><span id="b4f7" class="no np iq pc b gy pw pt l pu pv">const payload = `/product/&lt;product-id&gt;`;</span></pre><h2 id="6ee6" class="no np iq bd nq nr ns dn nt nu nv dp nw ln nx ny nz lr oa ob oc lv od oe of iw bi translated">接收推送的通知</h2><p id="2106" class="pw-post-body-paragraph le lf iq lg b lh og ka lj lk oh kd lm ln oi lp lq lr oj lt lu lv ok lx ly lz ij bi translated">我之前说过，您需要服务人员来发送通知。算了吧！此时，推送消息由推送服务器发送。</p><p id="6627" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">您仍然需要一个服务人员来接收推送消息。您已经注册了一个服务人员，但是它没有任何作用。所以我们将添加一个监听器来接收<code class="fe oz pa pb pc b">push</code>事件:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="pe pf l"/></div></figure><p id="58bd" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">在这个脚本中，我们向服务工作器中的事件<code class="fe oz pa pb pc b">push</code>添加了一个监听器。<code class="fe oz pa pb pc b">event</code>是一个类型为<a class="ae pd" href="https://developer.mozilla.org/en-US/docs/Web/API/PushMessageData" rel="noopener ugc nofollow" target="_blank"> PushMessageData </a>的对象，包含从推送服务器发送的数据，可以使用方法<code class="fe oz pa pb pc b">event.data.text()</code>、<code class="fe oz pa pb pc b">event.data.json()</code>或blob()以字符串、对象和其他格式访问。</p><p id="6a41" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">从通知事件中读取数据后，您可以显示通知。你前面称之为<code class="fe oz pa pb pc b">serviceWorkerRegistration.showNotification</code>外役工的方法。在服务人员内部，您使用<code class="fe oz pa pb pc b">self.registration.showNotification()</code>。</p><h2 id="425d" class="no np iq bd nq nr ns dn nt nu nv dp nw ln nx ny nz lr oa ob oc lv od oe of iw bi translated">点击通知</h2><p id="eae6" class="pw-post-body-paragraph le lf iq lg b lh og ka lj lk oh kd lm ln oi lp lq lr oj lt lu lv ok lx ly lz ij bi translated">通知可以是不言自明的，不需要任何动作，但是通常，我们希望当用户点击通知时发生一些事情。您需要为事件<code class="fe oz pa pb pc b">notificationclick</code>在服务工作器中添加一个监听器</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="pe pf l"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">该代码片段是演示项目的一部分，完整代码可从<a class="ae pd" href="https://github.com/Spyna/push-notification-demo/blob/master/front-end/public/sw.js#L19" rel="noopener ugc nofollow" target="_blank">https://github . com/Spyna/push-notification-demo/blob/master/front-end/public/SW . js # L19</a>获得</figcaption></figure><p id="7b42" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">在这段代码中，您添加了一个事件监听器，它读取<code class="fe oz pa pb pc b">event.notification.data</code>属性，并对其进行处理。在这个例子中，数据是一个URL(因为我们在前面的例子中将其创建为一个URL)。接下来，我们在浏览器窗口中打开该URL。当然，您可以做任何您想做的事情，处理通知的内容和服务人员。</p><p id="45cb" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">例如，如果用户已经有一个通知，您可以避免添加另一个通知，而是使用类似<code class="fe oz pa pb pc b">you have N messages to read</code>的东西修改现有的通知。</p><p id="052d" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">或者，如果您考虑通知中的这些操作:</p><pre class="kp kq kr ks gt po pc pp pq aw pr bi"><span id="5ae9" class="no np iq pc b gy ps pt l pu pv">self.registration.showNotification("Your friend has posted a video", {<br/>  actions: [<br/>   {action: 'like', title: 'Like'},<br/>   {action: 'reply', title: ' Reply'}]<br/>});</span></pre><p id="e265" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">您可以基于动作类型做出不同的决定，这可以在事件的属性<code class="fe oz pa pb pc b">action</code>中访问。</p><pre class="kp kq kr ks gt po pc pp pq aw pr bi"><span id="cb4f" class="no np iq pc b gy ps pt l pu pv">function handleNotification(event) {<br/>  event.notification.close();<br/>  if (event.action === 'like') {<br/>   // silently like the video;<br/>  }<br/>  else if (event.action === 'reply') {<br/>   // open the reply page  }<br/>  else {<br/>    // do something else<br/>  }<br/>}}</span><span id="1b54" class="no np iq pc b gy pw pt l pu pv">self.addEventListener('notificationclick', handleNotificaiton);</span></pre></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><h2 id="67b0" class="no np iq bd nq nr ns dn nt nu nv dp nw ln nx ny nz lr oa ob oc lv od oe of iw bi translated">React.js推送通知</h2><p id="d9a5" class="pw-post-body-paragraph le lf iq lg b lh og ka lj lk oh kd lm ln oi lp lq lr oj lt lu lv ok lx ly lz ij bi translated">如果您对React.js的推送通知感兴趣，请查看这篇文章。</p><div class="ma mb gp gr mc md"><a rel="noopener  ugc nofollow" target="_blank" href="/react-push-notifications-with-hooks-d293d36f4836"><div class="me ab fo"><div class="mf ab mg cl cj mh"><h2 class="bd ja gy z fp mi fr fs mj fu fw iz bi translated">反应推送通知(带挂钩)</h2><div class="mk l"><h3 class="bd b gy z fp mi fr fs mj fu fw dk translated">推送通知如何工作以及如何做出反应</h3></div><div class="ml l"><p class="bd b dl z fp mi fr fs mj fu fw dk translated">itnext.io</p></div></div><div class="mm l"><div class="px l mo mp mq mm mr ky md"/></div></div></a></div></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><h2 id="0e47" class="no np iq bd nq nr ns dn nt nu nv dp nw ln nx ny nz lr oa ob oc lv od oe of iw bi translated">要记住的高级主题</h2><p id="a8b5" class="pw-post-body-paragraph le lf iq lg b lh og ka lj lk oh kd lm ln oi lp lq lr oj lt lu lv ok lx ly lz ij bi translated">这是对网络推送通知的介绍。如果你读到这里，你应该是一个<em class="pg">推送通知冠军。</em>在开发管理通知的生产应用程序时，需要记住一些主题，其中包括:</p><ul class=""><li id="8e81" class="na nb iq lg b lh li lk ll ln nc lr nd lv ne lz nf ng nh ni bi translated">处理<em class="pg">权限被拒绝</em>以显示来自用户的通知</li><li id="5a23" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">更新或<a class="ae pd" href="https://developer.mozilla.org/en-US/docs/Web/API/PushSubscription/unsubscribe" rel="noopener ugc nofollow" target="_blank">取消</a>通知订阅。</li><li id="73cd" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">当服务器推送通知时，客户端可能会离线…</li><li id="4916" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">通知负载加密</li></ul></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><p id="c93b" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">您可以在这里看到我们将要制作的现场演示:</p><div class="ma mb gp gr mc md"><a href="https://push-notifications-demo.netlify.app/" rel="noopener  ugc nofollow" target="_blank"><div class="me ab fo"><div class="mf ab mg cl cj mh"><h2 class="bd ja gy z fp mi fr fs mj fu fw iz bi translated">网络推送通知</h2><div class="mk l"><h3 class="bd b gy z fp mi fr fs mj fu fw dk translated">询问用户许可这将创建一个必须发送到推送服务器创建通知的端点…</h3></div><div class="ml l"><p class="bd b dl z fp mi fr fs mj fu fw dk translated">推送-通知-demo.netlify.app</p></div></div><div class="mm l"><div class="mn l mo mp mq mm mr ky md"/></div></div></a></div><p id="e793" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">您可以下载并在本地运行该演示，完整说明的源代码在这里:</p><div class="ma mb gp gr mc md"><a href="https://github.com/Spyna/push-notification-demo" rel="noopener  ugc nofollow" target="_blank"><div class="me ab fo"><div class="mf ab mg cl cj mh"><h2 class="bd ja gy z fp mi fr fs mj fu fw iz bi translated">spyna/推送通知-演示</h2><div class="mk l"><h3 class="bd b gy z fp mi fr fs mj fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="ml l"><p class="bd b dl z fp mi fr fs mj fu fw dk translated">github.com</p></div></div><div class="mm l"><div class="ms l mo mp mq mm mr ky md"/></div></div></a></div></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><h2 id="9c9b" class="no np iq bd nq nr ns dn nt nu nv dp nw ln nx ny nz lr oa ob oc lv od oe of iw bi translated">参考</h2><ul class=""><li id="74b6" class="na nb iq lg b lh og lk oh ln py lr pz lv qa lz nf ng nh ni bi translated">PushManager:<a class="ae pd" href="https://developer.mozilla.org/en-US/docs/Web/API/PushManager" rel="noopener ugc nofollow" target="_blank">https://developer . Mozilla . org/en-US/docs/Web/API/PushManager</a></li><li id="179d" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">push subscription:<a class="ae pd" href="https://developer.mozilla.org/en-US/docs/Web/API/PushSubscription" rel="noopener ugc nofollow" target="_blank">https://developer . Mozilla . org/en-US/docs/Web/API/push subscription</a></li><li id="79c7" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">服务工作者:<a class="ae pd" href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API" rel="noopener ugc nofollow" target="_blank">https://developer . Mozilla . org/en-US/docs/Web/API/Service _ Worker _ API</a></li><li id="9a67" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">索然无味:https://tools.ietf.org/html/rfc8292</li><li id="1beb" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">网络推送协议:<a class="ae pd" href="https://tools.ietf.org/html/rfc8030" rel="noopener ugc nofollow" target="_blank">https://tools.ietf.org/html/rfc8030</a></li><li id="0042" class="na nb iq lg b lh nj lk nk ln nl lr nm lv nn lz nf ng nh ni bi translated">网页推送的消息加密:<a class="ae pd" href="https://tools.ietf.org/html/rfc8291" rel="noopener ugc nofollow" target="_blank">https://tools.ietf.org/html/rfc8291</a></li></ul><p id="726f" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">恭喜你！！😎你坚持到了最后。如果你喜欢👌这篇文章，点击下面按钮👏。这对我意义重大，也有助于其他人了解这个故事。</p><p id="b4ae" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">更多故事由<a class="qb qc ep" href="https://medium.com/u/dee217da30b7?source=post_page-----a701783917ce--------------------------------" rel="noopener" target="_blank">洛伦佐·斯皮纳</a></p><div class="ma mb gp gr mc md"><a rel="noopener  ugc nofollow" target="_blank" href="/an-oauth-2-0-introduction-for-beginners-6e386b19f7a9"><div class="me ab fo"><div class="mf ab mg cl cj mh"><h2 class="bd ja gy z fp mi fr fs mj fu fw iz bi translated">面向初学者的OAuth 2.0简介</h2><div class="mk l"><h3 class="bd b gy z fp mi fr fs mj fu fw dk translated">OAuth 2.0如何工作以及如何选择正确的流程</h3></div><div class="ml l"><p class="bd b dl z fp mi fr fs mj fu fw dk translated">itnext.io</p></div></div><div class="mm l"><div class="qd l mo mp mq mm mr ky md"/></div></div></a></div><div class="ma mb gp gr mc md"><a href="https://medium.com/@spyna/the-truth-about-amazon-job-interview-b940a2190585" rel="noopener follow" target="_blank"><div class="me ab fo"><div class="mf ab mg cl cj mh"><h2 class="bd ja gy z fp mi fr fs mj fu fw iz bi translated">如何在亚马逊找到工作</h2><div class="mk l"><h3 class="bd b gy z fp mi fr fs mj fu fw dk translated">我们听说了很多关于亚马逊招聘流程的故事，有些是真的，有些不是。我想分享我的…</h3></div><div class="ml l"><p class="bd b dl z fp mi fr fs mj fu fw dk translated">medium.com</p></div></div><div class="mm l"><div class="qe l mo mp mq mm mr ky md"/></div></div></a></div></div></div>    
</body>
</html>