<html>
<head>
<title>How to cache Ruby gems or NPM dependencies on CircleCI 2.0</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在CircleCI 2.0上缓存Ruby gems或NPM依赖项</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-cache-ruby-gems-or-npm-dependencies-on-circleci-2-0-eae8208f9d7b?source=collection_archive---------8-----------------------#2018-12-20">https://itnext.io/how-to-cache-ruby-gems-or-npm-dependencies-on-circleci-2-0-eae8208f9d7b?source=collection_archive---------8-----------------------#2018-12-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c4c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">CircleCI 2.0允许我们缓存特定的文件或文件夹。我们可以使用它来缓存随bundler安装的ruby gems，并在运行另一个CI构建时恢复它们。这样，新的CI构建可以通过使用以前构建的缓存文件运行得更快。本文还向您展示了如何缓存npm依赖项。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/a2692efb50ba03904d42de663108313f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*O67Zq-Mo_QXogL7f.jpg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">隐藏物</figcaption></figure><h1 id="54d7" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">缓存红宝石</h1><p id="be2f" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">第一步是检查对于我们的<code class="fe me mf mg mh b">Gemfile.lock</code>是否存在可用的缓存<code class="fe me mf mg mh b">v1-dependencies-bundler-{{ checksum "Gemfile.lock" }}</code>。这就是为什么我们将<code class="fe me mf mg mh b">Gemfile.lock</code>文件的校验和作为缓存键的一部分。这样，如果不同的git提交有不同的<code class="fe me mf mg mh b">Gemfile.lock</code>内容，当新的CI构建有相同的<code class="fe me mf mg mh b">Gemfile.lock</code>校验和时，我们将使用适当的缓存文件。</p><p id="212c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当您安装新的gem并使用更新的内容<code class="fe me mf mg mh b">Gemfile.lock</code>推送新的git commit时，新的<code class="fe me mf mg mh b">Gemfile.lock</code>的缓存键将不存在。在这种情况下，我们希望使用回退缓存键匹配模式<code class="fe me mf mg mh b">v1-dependencies-bundler-</code>。</p><p id="013f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">缓存恢复后，我们可以用bundler将gems安装到指定的目录<code class="fe me mf mg mh b">vendor/bundle</code>，然后我们可以在特定的缓存键<code class="fe me mf mg mh b">v1-dependencies-bundler-{{ checksum "Gemfile.lock" }}</code>下缓存它</p><pre class="km kn ko kp gt mi mh mj mk aw ml bi"><span id="45e3" class="mm lc iq mh b gy mn mo l mp mq"><em class="mr"># .circleci/config.yml</em><br/>version: 2<br/>jobs:<br/>  build:<br/>    <em class="mr"># other config</em><br/><br/>    steps:<br/>      - checkout<br/><br/>      <em class="mr"># Restore bundle cache</em><br/>      - type: cache-restore<br/>        keys:<br/>          - v1-dependencies-bundler-{{ checksum "Gemfile.lock" }}<br/>          <em class="mr"># fallback to using the latest cache if no exact match is found</em><br/>          - v1-dependencies-bundler-<br/><br/>      <em class="mr"># Bundle install dependencies</em><br/>      - run: bundle install --jobs=4 --retry=3 --path vendor/bundle<br/><br/>      <em class="mr"># Store bundle cache</em><br/>      - type: cache-save<br/>        key: v1-dependencies-bundler-{{ checksum "Gemfile.lock" }}<br/>        paths:<br/>          - vendor/bundle<br/><br/>      <em class="mr"># other config</em></span></pre><p id="7dfb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想看Ruby on Rails项目的CircleCI 2.0配置文件的完整示例，请查看这篇文章。</p><h1 id="83ab" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">缓存npm依赖项</h1><p id="100b" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">缓存npm包的流程类似。这里你可以看到一个例子。</p><pre class="km kn ko kp gt mi mh mj mk aw ml bi"><span id="fcad" class="mm lc iq mh b gy mn mo l mp mq"><em class="mr"># .circleci/config.yml</em><br/>version: 2<br/>jobs:<br/>  build:<br/>    <em class="mr"># other config</em><br/><br/>    steps:<br/>      <em class="mr"># other config</em><br/><br/>      - restore_cache:<br/>          keys:<br/>          - v1-dependencies-{{ checksum "package.json" }}<br/>          <em class="mr"># fallback to using the latest cache if no exact match is found</em><br/>          - v1-dependencies-<br/><br/>      - run: npm install<br/><br/>      - save_cache:<br/>          paths:<br/>            - node_modules<br/>          key: v1-dependencies-{{ checksum "package.json" }}<br/><br/>      <em class="mr"># other config</em></span></pre><p id="fa3e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">CircleCI 2.0提供的缓存非常有用，可以帮助我们减少CI构建的时间。还有更多的选项来加快我们的CI构建。其中之一是CircleCI 2.0 的<a class="ae ms" href="https://docs.knapsackpro.com/2018/improve-circleci-parallelisation-for-rspec-minitest-cypress" rel="noopener ugc nofollow" target="_blank"> CI并行化，您可以在文章中了解更多信息，或者查看</a><a class="ae ms" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=circleci-2-0-cache-ruby-gems-or-npm-dependencies" rel="noopener ugc nofollow" target="_blank">backpack Pro</a>上的演示。</p></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><p id="4d0e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mr">原载于</em><a class="ae ms" href="https://docs.knapsackpro.com/2018/circleci-2-0-cache-ruby-gems-or-npm-dependencies" rel="noopener ugc nofollow" target="_blank"><em class="mr"/></a><em class="mr">。</em></p></div></div>    
</body>
</html>