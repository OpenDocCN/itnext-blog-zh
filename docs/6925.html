<html>
<head>
<title>Deploy Kubernetes (K8s) on Amazon AWS using mixed on-demand and spot instances</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Amazon AWS上部署Kubernetes (K8s ),使用混合的按需实例和现场实例</h1>
<blockquote>原文：<a href="https://itnext.io/deploy-kubernetes-k8s-on-amazon-aws-using-mixed-on-demand-and-spot-instances-5440e5bece7?source=collection_archive---------3-----------------------#2022-04-14">https://itnext.io/deploy-kubernetes-k8s-on-amazon-aws-using-mixed-on-demand-and-spot-instances-5440e5bece7?source=collection_archive---------3-----------------------#2022-04-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/4319259ac8c2d835fcdf3e0fcf50582c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*JcHn2Nvd4kK480z-NhPtSQ.png"/></div></figure><p id="970f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用混合的按需实例和现场实例，在几分钟内即可在Amazon AWS上部署高可用性Kubernetes集群。</p><p id="7565" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">请<strong class="jw ir">注意</strong>，这只是一个如何部署Kubernetes集群的例子。对于生产环境，您应该使用<a class="ae ks" href="https://aws.amazon.com/eks/" rel="noopener ugc nofollow" target="_blank"> EKS </a>或<a class="ae ks" href="https://aws.amazon.com/it/ecs/" rel="noopener ugc nofollow" target="_blank"> ECS </a>。</p><p id="2a47" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此报告的范围是展示部署高可用性K8s集群所需的所有AWS组件。</p><h1 id="4556" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">要求</h1><ul class=""><li id="6911" class="lr ls iq jw b jx lt kb lu kf lv kj lw kn lx kr ly lz ma mb bi translated">Terraform是一个开源的基础设施代码软件工具，提供一致的CLI工作流来管理数百个云服务。Terraform将云API编码成声明性的配置文件。</li><li id="4473" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated"><a class="ae ks" href="https://aws.amazon.com/it/console/" rel="noopener ugc nofollow" target="_blank">亚马逊AWS账户</a> -启用计费的亚马逊AWS账户</li><li id="7a3b" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated"><a class="ae ks" href="https://kubernetes.io/docs/tasks/tools/" rel="noopener ugc nofollow" target="_blank">kube CTL</a>——Kubernetes命令行工具(可选)</li><li id="d3d3" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">可选的aws cli</li></ul><p id="ba05" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您还需要:</p><ul class=""><li id="22d2" class="lr ls iq jw b jx jy kb kc kf mh kj mi kn mj kr ly lz ma mb bi translated">一个带有私有和公有子网的VPC</li><li id="8d43" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">一个ssh密钥已经上传到您的AWS帐户</li><li id="cec4" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">一台bastion主机连接所有私有EC2实例</li></ul><p id="4ecd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于VPC和堡垒主机你可以参考<a class="ae ks" href="https://github.com/garutilorenzo/aws-terraform-examples" rel="noopener ugc nofollow" target="_blank">这个</a>库。</p><h1 id="aa9d" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">基础设施概述</h1><p id="0ac9" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mk kh ki kj ml kl km kn mm kp kq kr ij bi translated">最终的基础设施将由以下人员建造:</p><ul class=""><li id="be41" class="lr ls iq jw b jx jy kb kc kf mh kj mi kn mj kr ly lz ma mb bi translated">两个自动伸缩组，一个用于kubernetes主节点，一个用于worker节点</li><li id="ad3d" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">助理秘书长使用的两个启动模板</li><li id="8d2b" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">一个内部负载平衡器(L4 ),将流量路由到Kubernetes服务器</li><li id="c29c" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">一个外部负载平衡器(L7 ),将流量路由到Kubernetes工作人员</li><li id="27d1" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">一个安全组，允许来自VPC子网CIDR的流量通过所有k8s端口(kube api、nginx入口节点端口等)</li><li id="1b1c" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">一个安全组，允许来自所有互联网的流量进入端口80和443上的公共负载平衡器(L7)</li><li id="5a3f" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">一个S3存储桶，用于存储集群加入证书</li><li id="87f4" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">一个IAM角色，用于允许集群中的所有EC2实例写入S3桶，用于共享连接证书</li><li id="ee96" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">一个公共LB使用的证书，存储在AWS ACM上。该证书是自签名证书。</li></ul><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi mn"><img src="../Images/ac99d70f3c6d214398c8dfd0361d9fdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vHIvYn5eVr4NuwHnOUTSkg.png"/></div></div></figure><h1 id="d5a9" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">Kubernetes设置</h1><p id="16a6" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mk kh ki kj ml kl km kn mm kp kq kr ij bi translated">K8s的安装是由<a class="ae ks" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/" rel="noopener ugc nofollow" target="_blank"> kubeadm </a>完成的。在这个装置中，<a class="ae ks" href="https://containerd.io/" rel="noopener ugc nofollow" target="_blank">集装箱</a>用作CRI，<a class="ae ks" href="https://github.com/flannel-io/flannel" rel="noopener ugc nofollow" target="_blank">法兰绒</a>用作CNI。</p><p id="b152" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">你可以选择安装<a class="ae ks" href="https://kubernetes.github.io/ingress-nginx/" rel="noopener ugc nofollow" target="_blank"> Nginx入口控制器</a>和<a class="ae ks" href="https://garutilorenzo.github.io/k8s-aws-terraform-cluster/#https://longhorn.io/" rel="noopener ugc nofollow" target="_blank">长角牛</a>。</p><p id="665c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要安装Nginx ingress，将变量<em class="mw"> install_nginx_ingress </em>设置为yes(默认为no)。要安装longhorn，将变量<em class="mw"> install_longhorn </em>设置为yes(默认为no)。<strong class="jw ir">注意</strong>如果不安装nginx ingress，公共负载均衡器和SSL证书不会被部署。</p><p id="5fa7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在该安装中，使用S3桶来存储加入证书/令牌。在实例第一次启动时，如果集群不存在，则使用S3桶来获取连接证书/令牌。</p><h1 id="7945" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">开始之前</h1><p id="fd9e" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mk kh ki kj ml kl km kn mm kp kq kr ij bi translated">注意，本教程使用了AWS免费层之外的AWS资源，所以要小心！</p><h1 id="ff9d" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">项目设置</h1><p id="61f1" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mk kh ki kj ml kl km kn mm kp kq kr ij bi translated">克隆<a class="ae ks" href="https://github.com/garutilorenzo/k8s-aws-terraform-cluster" rel="noopener ugc nofollow" target="_blank">这个</a> repo并进入示例/目录:</p><pre class="mo mp mq mr gt mx my mz na aw nb bi"><span id="efec" class="nc ku iq my b gy nd ne l nf ng">git clone <a class="ae ks" href="https://github.com/garutilorenzo/k8s-aws-terraform-cluster" rel="noopener ugc nofollow" target="_blank">https://github.com/garutilorenzo/k8s-aws-terraform-cluster</a><br/>cd k8s-aws-terraform-cluster/example/</span></pre><p id="698d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，您必须编辑main.tf文件，并创建terraform.tfvars文件。更多详情请参见<a class="ae ks" href="https://garutilorenzo.github.io/k8s-aws-terraform-cluster/#aws-provider-setup" rel="noopener ugc nofollow" target="_blank"> AWS供应商设置</a>和<a class="ae ks" href="https://garutilorenzo.github.io/k8s-aws-terraform-cluster/#pre-flight-checklist" rel="noopener ugc nofollow" target="_blank">飞行前清单</a>。</p><p id="4420" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">或者，如果您愿意，可以在工作区中创建一个新的空目录，并创建以下三个文件:</p><ul class=""><li id="5f0b" class="lr ls iq jw b jx jy kb kc kf mh kj mi kn mj kr ly lz ma mb bi translated">terraform.tfvars</li><li id="df55" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">main.tf</li><li id="2a25" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">provider.tf</li></ul><p id="0a07" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">main.tf文件将如下所示:</p><pre class="mo mp mq mr gt mx my mz na aw nb bi"><span id="80c9" class="nc ku iq my b gy nd ne l nf ng">variable "AWS_ACCESS_KEY" {</span><span id="9684" class="nc ku iq my b gy nh ne l nf ng">}</span><span id="c125" class="nc ku iq my b gy nh ne l nf ng">variable "AWS_SECRET_KEY" {</span><span id="835e" class="nc ku iq my b gy nh ne l nf ng">}</span><span id="5fb6" class="nc ku iq my b gy nh ne l nf ng">variable "environment" {<br/>  default = "staging"<br/>}</span><span id="50e1" class="nc ku iq my b gy nh ne l nf ng">variable "AWS_REGION" {<br/>  default = "&lt;YOUR_REGION&gt;"<br/>}</span><span id="67e5" class="nc ku iq my b gy nh ne l nf ng">module "k8s-cluster" {<br/>  ssk_key_pair_name      = "&lt;SSH_KEY_NAME&gt;"<br/>  uuid                   = "&lt;GENERATE_UUID&gt;"<br/>  environment            = var.environment<br/>  vpc_id                 = "&lt;VPC_ID&gt;"<br/>  vpc_private_subnets    = "&lt;PRIVATE_SUBNET_LIST&gt;"<br/>  vpc_public_subnets     = "&lt;PUBLIC_SUBNET_LIST&gt;"<br/>  vpc_subnet_cidr        = "&lt;SUBNET_CIDR&gt;"<br/>  PATH_TO_PUBLIC_LB_CERT = "&lt;PAHT_TO_PUBLIC_LB_CERT&gt;"<br/>  PATH_TO_PUBLIC_LB_KEY  = "&lt;PAHT_TO_PRIVATE_LB_CERT&gt;"<br/>  install_nginx_ingress  = true<br/>  source                 = "github.com/garutilorenzo/k8s-aws-terraform-cluster"<br/>}</span><span id="f95f" class="nc ku iq my b gy nh ne l nf ng">output "k8s_dns_name" {<br/>  value = module.k8s-cluster.k8s_dns_name<br/>}</span><span id="d9d9" class="nc ku iq my b gy nh ne l nf ng">output "k8s_server_private_ips" {<br/>  value = module.k8s-cluster.k8s_server_private_ips<br/>}</span><span id="adad" class="nc ku iq my b gy nh ne l nf ng">output "k8s_workers_private_ips" {<br/>  value = module.k8s-cluster.k8s_workers_private_ips<br/>}</span></pre><p id="5309" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所有可能的变量见<a class="ae ks" href="https://garutilorenzo.github.io/k8s-aws-terraform-cluster/#pre-flight-checklist" rel="noopener ugc nofollow" target="_blank">飞行前清单</a></p><p id="b50c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">provider.tf将类似于:</p><pre class="mo mp mq mr gt mx my mz na aw nb bi"><span id="b896" class="nc ku iq my b gy nd ne l nf ng">provider "aws" {<br/>  region     = var.AWS_REGION<br/>  access_key = var.AWS_ACCESS_KEY<br/>  secret_key = var.AWS_SECRET_KEY<br/>}</span></pre><p id="6036" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">terraform.tfvars将如下所示:</p><pre class="mo mp mq mr gt mx my mz na aw nb bi"><span id="d63d" class="nc ku iq my b gy nd ne l nf ng">AWS_ACCESS_KEY = "xxxxxxxxxxxxxxxxx"<br/>AWS_SECRET_KEY = "xxxxxxxxxxxxxxxxx"</span></pre><p id="46af" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，我们可以用以下命令初始化terraform:</p><pre class="mo mp mq mr gt mx my mz na aw nb bi"><span id="e4bc" class="nc ku iq my b gy nd ne l nf ng">terraform init</span><span id="1069" class="nc ku iq my b gy nh ne l nf ng">Initializing modules...<br/>- k8s-cluster in ..</span><span id="22a5" class="nc ku iq my b gy nh ne l nf ng">Initializing the backend...</span><span id="1557" class="nc ku iq my b gy nh ne l nf ng">Initializing provider plugins...<br/>- Finding latest version of hashicorp/template...<br/>- Finding latest version of hashicorp/aws...<br/>- Installing hashicorp/template v2.2.0...<br/>- Installed hashicorp/template v2.2.0 (signed by HashiCorp)<br/>- Installing hashicorp/aws v4.9.0...<br/>- Installed hashicorp/aws v4.9.0 (signed by HashiCorp)</span><span id="66cf" class="nc ku iq my b gy nh ne l nf ng">Terraform has created a lock file .terraform.lock.hcl to record the provider<br/>selections it made above. Include this file in your version control repository<br/>so that Terraform can guarantee to make the same selections by default when<br/>you run "terraform init" in the future.</span><span id="ea7b" class="nc ku iq my b gy nh ne l nf ng">Terraform has been successfully initialized!</span><span id="898a" class="nc ku iq my b gy nh ne l nf ng">You may now begin working with Terraform. Try running "terraform plan" to see<br/>any changes that are required for your infrastructure. All Terraform commands<br/>should now work.</span><span id="4bb4" class="nc ku iq my b gy nh ne l nf ng">If you ever set or change modules or backend configuration for Terraform,<br/>rerun this command to reinitialize your working directory. If you forget, other<br/>commands will detect it and remind you to do so if necessary.</span></pre><h1 id="6b32" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">为公共LB生成自签名SSL证书(L7)</h1><p id="4d44" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mk kh ki kj ml kl km kn mm kp kq kr ij bi translated"><strong class="jw ir">注意</strong>如果您已经拥有一个有效的证书，请跳过这一步，为变量PATH_TO_PUBLIC_LB_CERT和PATH_TO_PUBLIC_LB_KEY设置正确的值</p><p id="efb8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们需要为我们的公共负载平衡器(第7层)生成证书(sel签名)。为此，我们需要<em class="mw"> openssl </em>，打开一个终端并遵循以下步骤:</p><p id="76b6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">生成密钥:</p><pre class="mo mp mq mr gt mx my mz na aw nb bi"><span id="3fcb" class="nc ku iq my b gy nd ne l nf ng">openssl genrsa 2048 &gt; privatekey.pem<br/>Generating RSA private key, 2048 bit long modulus (2 primes)<br/>.......+++++<br/>...............+++++<br/>e is 65537 (0x010001)</span></pre><p id="ba0b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">生成新的证书请求:</p><pre class="mo mp mq mr gt mx my mz na aw nb bi"><span id="a3d1" class="nc ku iq my b gy nd ne l nf ng">openssl req -new -key privatekey.pem -out csr.pem<br/>You are about to be asked to enter information that will be incorporated<br/>into your certificate request.<br/>What you are about to enter is what is called a Distinguished Name or a DN.<br/>There are quite a few fields but you can leave some blank<br/>For some fields there will be a default value,<br/>If you enter '.', the field will be left blank.<br/>-----<br/>Country Name (2 letter code) [AU]:IT<br/>State or Province Name (full name) [Some-State]:Italy<br/>Locality Name (eg, city) []:Brescia<br/>Organization Name (eg, company) [Internet Widgits Pty Ltd]:GL Ltd<br/>Organizational Unit Name (eg, section) []:IT<br/>Common Name (e.g. server FQDN or YOUR name) []:testlb.domainexample.com<br/>Email Address []:<a class="ae ks" href="mailto:email@you.com" rel="noopener ugc nofollow" target="_blank">email@you.com</a></span><span id="66d3" class="nc ku iq my b gy nh ne l nf ng">Please enter the following 'extra' attributes<br/>to be sent with your certificate request<br/>A challenge password []:<br/>An optional company name []:</span></pre><p id="b77e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">生成公共CRT:</p><pre class="mo mp mq mr gt mx my mz na aw nb bi"><span id="0948" class="nc ku iq my b gy nd ne l nf ng">openssl x509 -req -days 365 -in csr.pem -signkey privatekey.pem -out public.crt<br/>Signature ok<br/>subject=C = IT, ST = Italy, L = Brescia, O = GL Ltd, OU = IT, CN = testlb.domainexample.com, emailAddress = email@you.com<br/>Getting Private key</span></pre><p id="1713" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这是最后的结果:</p><pre class="mo mp mq mr gt mx my mz na aw nb bi"><span id="5d4e" class="nc ku iq my b gy nd ne l nf ng">ls</span><span id="1cb9" class="nc ku iq my b gy nh ne l nf ng">csr.pem  privatekey.pem  public.crt</span></pre><p id="a196" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在设置变量:</p><ul class=""><li id="a7e9" class="lr ls iq jw b jx jy kb kc kf mh kj mi kn mj kr ly lz ma mb bi translated">PATH _ TO _ PUBLIC _ LB _ CERT:~/full _ PATH/PUBLIC . CRT</li><li id="c0bc" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">PATH _ TO _ PUBLIC _ LB _ KEY:~/full _ PATH/private KEY . PEM</li></ul><h1 id="22ed" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">AWS提供程序设置</h1><p id="c8f6" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mk kh ki kj ml kl km kn mm kp kq kr ij bi translated">遵循<a class="ae ks" href="https://learn.hashicorp.com/tutorials/terraform/aws-build?in=terraform/aws-get-started" rel="noopener ugc nofollow" target="_blank">这个</a>环节上的先决条件步骤。在您的工作区文件夹或此报告的examples目录中，创建一个名为terraform.tfvars的文件:</p><pre class="mo mp mq mr gt mx my mz na aw nb bi"><span id="d362" class="nc ku iq my b gy nd ne l nf ng">AWS_ACCESS_KEY = "xxxxxxxxxxxxxxxxx"<br/>AWS_SECRET_KEY = "xxxxxxxxxxxxxxxxx"</span></pre><h1 id="ad0b" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">飞行前清单</h1><p id="a9c5" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mk kh ki kj ml kl km kn mm kp kq kr ij bi translated">一旦你创建了terraform.tfvars文件，编辑main.tf文件(总是在范例/目录中)并设置变量后面的<a class="ae ks" href="https://github.com/garutilorenzo/k8s-aws-terraform-cluster/blob/master/README.md#pre-flight-checklist" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="82b3" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">部署</h1><p id="9b5e" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mk kh ki kj ml kl km kn mm kp kq kr ij bi translated">我们现在已经准备好部署我们的基础设施。首先，我们要求terraform计划执行:</p><pre class="mo mp mq mr gt mx my mz na aw nb bi"><span id="806a" class="nc ku iq my b gy nd ne l nf ng">terraform plan</span><span id="91c8" class="nc ku iq my b gy nh ne l nf ng">...<br/>...<br/>      + name                   = "k8s-sg"<br/>      + name_prefix            = (known after apply)<br/>      + owner_id               = (known after apply)<br/>      + revoke_rules_on_delete = false<br/>      + tags                   = {<br/>          + "Name"        = "sg-k8s-cluster-staging"<br/>          + "environment" = "staging"<br/>          + "provisioner" = "terraform"<br/>          + "scope"       = "k8s-cluster"<br/>          + "uuid"        = "xxxxx-xxxxx-xxxx-xxxxxx-xxxxxx"<br/>        }<br/>      + tags_all               = {<br/>          + "Name"        = "sg-k8s-cluster-staging"<br/>          + "environment" = "staging"<br/>          + "provisioner" = "terraform"<br/>          + "scope"       = "k8s-cluster"<br/>          + "uuid"        = "xxxxx-xxxxx-xxxx-xxxxxx-xxxxxx"<br/>        }<br/>      + vpc_id                 = "vpc-xxxxxx"<br/>    }</span><span id="08a7" class="nc ku iq my b gy nh ne l nf ng">Plan: 25 to add, 0 to change, 0 to destroy.</span><span id="fb14" class="nc ku iq my b gy nh ne l nf ng">Changes to Outputs:<br/>  + k8s_dns_name            = (known after apply)<br/>  + k8s_server_private_ips  = [<br/>      + (known after apply),<br/>    ]<br/>  + k8s_workers_private_ips = [<br/>      + (known after apply),<br/>    ]</span><span id="10dc" class="nc ku iq my b gy nh ne l nf ng">Note: You didn't use the -out option to save this plan, so Terraform can't guarantee to take exactly these actions if you run "terraform apply" now.</span></pre><p id="b1b9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，我们可以通过以下方式部署我们的资源:</p><pre class="mo mp mq mr gt mx my mz na aw nb bi"><span id="733a" class="nc ku iq my b gy nd ne l nf ng">terraform apply</span><span id="0574" class="nc ku iq my b gy nh ne l nf ng">...</span><span id="58c9" class="nc ku iq my b gy nh ne l nf ng">+ tags_all               = {<br/>          + "Name"        = "sg-k8s-cluster-staging"<br/>          + "environment" = "staging"<br/>          + "provisioner" = "terraform"<br/>          + "scope"       = "k8s-cluster"<br/>          + "uuid"        = "xxxxx-xxxxx-xxxx-xxxxxx-xxxxxx"<br/>        }<br/>      + vpc_id                 = "vpc-xxxxxxxx"<br/>    }</span><span id="5ae4" class="nc ku iq my b gy nh ne l nf ng">Plan: 25 to add, 0 to change, 0 to destroy.</span><span id="6335" class="nc ku iq my b gy nh ne l nf ng">Changes to Outputs:<br/>  + k8s_dns_name            = (known after apply)<br/>  + k8s_server_private_ips  = [<br/>      + (known after apply),<br/>    ]<br/>  + k8s_workers_private_ips = [<br/>      + (known after apply),<br/>    ]</span><span id="b82c" class="nc ku iq my b gy nh ne l nf ng">Do you want to perform these actions?<br/>  Terraform will perform the actions described above.<br/>  Only 'yes' will be accepted to approve.</span><span id="1850" class="nc ku iq my b gy nh ne l nf ng">Enter a value: yes</span><span id="f712" class="nc ku iq my b gy nh ne l nf ng">...<br/>...</span><span id="7d2b" class="nc ku iq my b gy nh ne l nf ng">Apply complete! Resources: 25 added, 0 changed, 0 destroyed.</span><span id="2d27" class="nc ku iq my b gy nh ne l nf ng">Outputs:</span><span id="485f" class="nc ku iq my b gy nh ne l nf ng">k8s_dns_name = "k8s-ext-&lt;REDACTED&gt;.elb.amazonaws.com"<br/>k8s_server_private_ips = [<br/>  tolist([<br/>    "172.x.x.x",<br/>    "172.x.x.x",<br/>    "172.x.x.x",<br/>  ]),<br/>]<br/>k8s_workers_private_ips = [<br/>  tolist([<br/>    "172.x.x.x",<br/>    "172.x.x.x",<br/>    "172.x.x.x",<br/>  ]),<br/>]</span></pre><p id="8222" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，在一个主节点上，您可以使用以下命令检查集群的状态:</p><pre class="mo mp mq mr gt mx my mz na aw nb bi"><span id="7471" class="nc ku iq my b gy nd ne l nf ng">ssh -j bastion@&lt;BASTION_IP&gt; ubuntu@172.x.x.x</span><span id="3c04" class="nc ku iq my b gy nh ne l nf ng">Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.13.0-1021-aws x86_64)</span><span id="8140" class="nc ku iq my b gy nh ne l nf ng">* Documentation:  <a class="ae ks" href="https://help.ubuntu.com" rel="noopener ugc nofollow" target="_blank">https://help.ubuntu.com</a><br/> * Management:     <a class="ae ks" href="https://landscape.canonical.com" rel="noopener ugc nofollow" target="_blank">https://landscape.canonical.com</a><br/> * Support:        <a class="ae ks" href="https://ubuntu.com/advantage" rel="noopener ugc nofollow" target="_blank">https://ubuntu.com/advantage</a></span><span id="3061" class="nc ku iq my b gy nh ne l nf ng">System information as of Wed Apr 13 12:41:52 UTC 2022</span><span id="ad80" class="nc ku iq my b gy nh ne l nf ng">System load:  0.52               Processes:             157<br/>  Usage of /:   17.8% of 19.32GB   Users logged in:       0<br/>  Memory usage: 11%                IPv4 address for cni0: 10.244.0.1<br/>  Swap usage:   0%                 IPv4 address for ens3: 172.68.4.237</span><span id="c3d8" class="nc ku iq my b gy nh ne l nf ng">0 updates can be applied immediately.</span><span id="1c8c" class="nc ku iq my b gy nh ne l nf ng">Last login: Wed Apr 13 12:40:32 2022 from 172.68.0.6<br/>ubuntu@i-04d089ed896cfafe1:~$ sudo su -</span><span id="2ff7" class="nc ku iq my b gy nh ne l nf ng">root@i-04d089ed896cfafe1:~# kubectl get nodes<br/>NAME                  STATUS   ROLES                  AGE     VERSION<br/>i-0033b408f7a1d55f3   Ready    control-plane,master   3m33s   v1.23.5<br/>i-0121c2149821379cc   Ready    &lt;none&gt;                 4m16s   v1.23.5<br/>i-04d089ed896cfafe1   Ready    control-plane,master   4m53s   v1.23.5<br/>i-072bf7de2e94e6f2d   Ready    &lt;none&gt;                 4m15s   v1.23.5<br/>i-09b23242f40eabcca   Ready    control-plane,master   3m56s   v1.23.5<br/>i-0cb1e2e7784768b22   Ready    &lt;none&gt;                 3m57s   v1.23.5</span><span id="e5ff" class="nc ku iq my b gy nh ne l nf ng">root@i-04d089ed896cfafe1:~# kubectl get ns<br/>NAME              STATUS   AGE<br/>default           Active   5m18s<br/>ingress-nginx     Active   111s # &lt;- ingress controller ns<br/>kube-node-lease   Active   5m19s<br/>kube-public       Active   5m19s<br/>kube-system       Active   5m19s<br/>longhorn-system   Active   109s  # &lt;- longhorn ns</span><span id="f2e6" class="nc ku iq my b gy nh ne l nf ng">root@i-04d089ed896cfafe1:~# kubectl get pods --all-namespaces<br/>NAMESPACE         NAME                                          READY   STATUS      RESTARTS        AGE<br/>ingress-nginx     ingress-nginx-admission-create-v2fpx          0/1     Completed   0               2m33s<br/>ingress-nginx     ingress-nginx-admission-patch-54d9f           0/1     Completed   0               2m33s<br/>ingress-nginx     ingress-nginx-controller-7fc8d55869-cxv87     1/1     Running     0               2m33s<br/>kube-system       coredns-64897985d-8cg8g                       1/1     Running     0               5m46s<br/>kube-system       coredns-64897985d-9v2r8                       1/1     Running     0               5m46s<br/>kube-system       etcd-i-0033b408f7a1d55f3                      1/1     Running     0               4m33s<br/>kube-system       etcd-i-04d089ed896cfafe1                      1/1     Running     0               5m42s<br/>kube-system       etcd-i-09b23242f40eabcca                      1/1     Running     0               5m<br/>kube-system       kube-apiserver-i-0033b408f7a1d55f3            1/1     Running     1 (4m30s ago)   4m30s<br/>kube-system       kube-apiserver-i-04d089ed896cfafe1            1/1     Running     0               5m46s<br/>kube-system       kube-apiserver-i-09b23242f40eabcca            1/1     Running     0               5m1s<br/>kube-system       kube-controller-manager-i-0033b408f7a1d55f3   1/1     Running     0               4m36s<br/>kube-system       kube-controller-manager-i-04d089ed896cfafe1   1/1     Running     1 (4m50s ago)   5m49s<br/>kube-system       kube-controller-manager-i-09b23242f40eabcca   1/1     Running     0               5m1s<br/>kube-system       kube-flannel-ds-7c65s                         1/1     Running     0               5m2s<br/>kube-system       kube-flannel-ds-bb842                         1/1     Running     0               4m10s<br/>kube-system       kube-flannel-ds-q27gs                         1/1     Running     0               5m21s<br/>kube-system       kube-flannel-ds-sww7p                         1/1     Running     0               5m3s<br/>kube-system       kube-flannel-ds-z8h5p                         1/1     Running     0               5m38s<br/>kube-system       kube-flannel-ds-zrwdq                         1/1     Running     0               5m22s<br/>kube-system       kube-proxy-6rbks                              1/1     Running     0               5m2s<br/>kube-system       kube-proxy-9npgg                              1/1     Running     0               5m21s<br/>kube-system       kube-proxy-px6br                              1/1     Running     0               5m3s<br/>kube-system       kube-proxy-q9889                              1/1     Running     0               4m10s<br/>kube-system       kube-proxy-s5qnv                              1/1     Running     0               5m22s<br/>kube-system       kube-proxy-tng4x                              1/1     Running     0               5m46s<br/>kube-system       kube-scheduler-i-0033b408f7a1d55f3            1/1     Running     0               4m27s<br/>kube-system       kube-scheduler-i-04d089ed896cfafe1            1/1     Running     1 (4m50s ago)   5m58s<br/>kube-system       kube-scheduler-i-09b23242f40eabcca            1/1     Running     0               5m1s<br/>longhorn-system   csi-attacher-6454556647-767p2                 1/1     Running     0               115s<br/>longhorn-system   csi-attacher-6454556647-hz8lj                 1/1     Running     0               115s<br/>longhorn-system   csi-attacher-6454556647-z5ftg                 1/1     Running     0               115s<br/>longhorn-system   csi-provisioner-869bdc4b79-2v4wx              1/1     Running     0               115s<br/>longhorn-system   csi-provisioner-869bdc4b79-4xcv4              1/1     Running     0               114s<br/>longhorn-system   csi-provisioner-869bdc4b79-9q95d              1/1     Running     0               114s<br/>longhorn-system   csi-resizer-6d8cf5f99f-dwdrq                  1/1     Running     0               114s<br/>longhorn-system   csi-resizer-6d8cf5f99f-klvcr                  1/1     Running     0               114s<br/>longhorn-system   csi-resizer-6d8cf5f99f-ptpzb                  1/1     Running     0               114s<br/>longhorn-system   csi-snapshotter-588457fcdf-dlkdq              1/1     Running     0               113s<br/>longhorn-system   csi-snapshotter-588457fcdf-p2c7c              1/1     Running     0               113s<br/>longhorn-system   csi-snapshotter-588457fcdf-p5smn              1/1     Running     0               113s<br/>longhorn-system   engine-image-ei-fa2dfbf0-bkwhx                1/1     Running     0               2m7s<br/>longhorn-system   engine-image-ei-fa2dfbf0-cqq9n                1/1     Running     0               2m8s<br/>longhorn-system   engine-image-ei-fa2dfbf0-lhjjc                1/1     Running     0               2m7s<br/>longhorn-system   instance-manager-e-542b1382                   1/1     Running     0               119s<br/>longhorn-system   instance-manager-e-a5e124bb                   1/1     Running     0               2m4s<br/>longhorn-system   instance-manager-e-acb2a517                   1/1     Running     0               2m7s<br/>longhorn-system   instance-manager-r-11ab6af6                   1/1     Running     0               119s<br/>longhorn-system   instance-manager-r-5b82fba2                   1/1     Running     0               2m4s<br/>longhorn-system   instance-manager-r-c2561fa0                   1/1     Running     0               2m6s<br/>longhorn-system   longhorn-csi-plugin-4br28                     2/2     Running     0               113s<br/>longhorn-system   longhorn-csi-plugin-8gdxf                     2/2     Running     0               113s<br/>longhorn-system   longhorn-csi-plugin-wc6tt                     2/2     Running     0               113s<br/>longhorn-system   longhorn-driver-deployer-7dddcdd5bb-zjh4k     1/1     Running     0               2m31s<br/>longhorn-system   longhorn-manager-cbsh7                        1/1     Running     0               2m31s<br/>longhorn-system   longhorn-manager-d2t75                        1/1     Running     1 (2m9s ago)    2m31s<br/>longhorn-system   longhorn-manager-xqlfv                        1/1     Running     1 (2m9s ago)    2m31s<br/>longhorn-system   longhorn-ui-7648d6cd69-tc6b9                  1/1     Running     0               2m31s</span></pre><h2 id="f2cd" class="nc ku iq bd kv ni nj dn kz nk nl dp ld kf nm nn lh kj no np ll kn nq nr lp ns bi translated">公共LB支票</h2><p id="994b" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mk kh ki kj ml kl km kn mm kp kq kr ij bi translated">我们现在可以测试公共负载平衡器、nginx入口控制器和安全组入口规则。在本地PC上运行:</p><pre class="mo mp mq mr gt mx my mz na aw nb bi"><span id="435a" class="nc ku iq my b gy nd ne l nf ng">curl -k -v <a class="ae ks" href="https://k8s-ext-" rel="noopener ugc nofollow" target="_blank">https://k8s-ext-</a>&lt;REDACTED&gt;.elb.amazonaws.com/<br/>*   Trying 34.x.x.x:443...<br/>* TCP_NODELAY set<br/>* Connected to k8s-ext-&lt;REDACTED&gt;.elb.amazonaws.com (34.x.x.x) port 443 (#0)<br/>* ALPN, offering h2<br/>* ALPN, offering http/1.1<br/>* successfully set certificate verify locations:<br/>*   CAfile: /etc/ssl/certs/ca-certificates.crt<br/>  CApath: /etc/ssl/certs<br/>* TLSv1.3 (OUT), TLS handshake, Client hello (1):<br/>* TLSv1.3 (IN), TLS handshake, Server hello (2):<br/>* TLSv1.2 (IN), TLS handshake, Certificate (11):<br/>* TLSv1.2 (IN), TLS handshake, Server key exchange (12):<br/>* TLSv1.2 (IN), TLS handshake, Server finished (14):<br/>* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):<br/>* TLSv1.2 (OUT), TLS change cipher, Change cipher spec (1):<br/>* TLSv1.2 (OUT), TLS handshake, Finished (20):<br/>* TLSv1.2 (IN), TLS handshake, Finished (20):<br/>* SSL connection using TLSv1.2 / ECDHE-RSA-AES128-GCM-SHA256<br/>* ALPN, server accepted to use h2<br/>* Server certificate:<br/>*  subject: C=IT; ST=Italy; L=Brescia; O=GL Ltd; OU=IT; CN=testlb.domainexample.com; <a class="ae ks" href="mailto:emailAddress=email@you.com" rel="noopener ugc nofollow" target="_blank">emailAddress=email@you.com</a><br/>*  start date: Apr 11 08:20:12 2022 GMT<br/>*  expire date: Apr 11 08:20:12 2023 GMT<br/>*  issuer: C=IT; ST=Italy; L=Brescia; O=GL Ltd; OU=IT; CN=testlb.domainexample.com; <a class="ae ks" href="mailto:emailAddress=email@you.com" rel="noopener ugc nofollow" target="_blank">emailAddress=email@you.com</a><br/>*  SSL certificate verify result: self signed certificate (18), continuing anyway.<br/>* Using HTTP2, server supports multi-use<br/>* Connection state changed (HTTP/2 confirmed)<br/>* Copying HTTP/2 data in stream buffer to connection buffer after upgrade: len=0<br/>* Using Stream ID: 1 (easy handle 0x55c6560cde10)<br/>&gt; GET / HTTP/2<br/>&gt; Host: k8s-ext-&lt;REDACTED&gt;.elb.amazonaws.com<br/>&gt; user-agent: curl/7.68.0<br/>&gt; accept: */*<br/>&gt; <br/>* Connection state changed (MAX_CONCURRENT_STREAMS == 128)!<br/>&lt; HTTP/2 404 <br/>&lt; date: Tue, 12 Apr 2022 10:08:18 GMT<br/>&lt; content-type: text/html<br/>&lt; content-length: 146<br/>&lt; strict-transport-security: max-age=15724800; includeSubDomains<br/>&lt; <br/>&lt;html&gt;<br/>&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;<br/>&lt;body&gt;<br/>&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;<br/>&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;<br/>* Connection #0 to host k8s-ext-&lt;REDACTED&gt;.elb.amazonaws.com left intact</span></pre><p id="fca2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="mw"> 404 </em>是正确的响应，因为集群是空的。</p><h1 id="6f2e" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">部署示例堆栈</h1><p id="36d2" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mk kh ki kj ml kl km kn mm kp kq kr ij bi translated">我们使用在<a class="ae ks" href="https://github.com/garutilorenzo/k3s-oci-cluster" rel="noopener ugc nofollow" target="_blank">这个</a>仓库中使用的相同堆栈。这个堆栈需要longhorn和nginx入口。</p><p id="8909" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了测试集群的所有组件，我们可以部署一个示例堆栈。堆栈由以下组件组成:</p><ul class=""><li id="af08" class="lr ls iq jw b jx jy kb kc kf mh kj mi kn mj kr ly lz ma mb bi translated">MariaDB</li><li id="3052" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">Nginx</li><li id="2037" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated">wordpress软件</li></ul><p id="799e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">每个组件由以下部分组成:一个部署和一个服务。Wordpress和nginx共享同一个持久卷(具有longhorn存储类的ReadWriteMany)。nginx配置存储在四个配置图中，nginx服务由nginx入口控制器公开。</p><p id="34d6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">通过以下方式部署资源:</p><pre class="mo mp mq mr gt mx my mz na aw nb bi"><span id="e0b4" class="nc ku iq my b gy nd ne l nf ng">kubectl apply -f <a class="ae ks" href="https://raw.githubusercontent.com/garutilorenzo/k3s-oci-cluster/master/deployments/mariadb/all-resources.yml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/garutilorenzo/k3s-oci-cluster/master/deployments/mariadb/all-resources.yml</a><br/>kubectl apply -f <a class="ae ks" href="https://raw.githubusercontent.com/garutilorenzo/k3s-oci-cluster/master/deployments/nginx/all-resources.yml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/garutilorenzo/k3s-oci-cluster/master/deployments/nginx/all-resources.yml</a><br/>kubectl apply -f <a class="ae ks" href="https://raw.githubusercontent.com/garutilorenzo/k3s-oci-cluster/master/deployments/wordpress/all-resources.yml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/garutilorenzo/k3s-oci-cluster/master/deployments/wordpress/all-resources.yml</a></span></pre><p id="a271" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">注意:要安装WP并到达<em class="mw"> wp-admin </em>路径，您必须编辑nginx部署并更改以下代码行:</p><pre class="mo mp mq mr gt mx my mz na aw nb bi"><span id="4d1b" class="nc ku iq my b gy nd ne l nf ng">env:<br/>  - name: SECURE_SUBNET<br/>    value: 8.8.8.8/32 # change-me</span></pre><p id="4f85" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并设置您的公共ip地址。</p><p id="5d0f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要检查状态:</p><pre class="mo mp mq mr gt mx my mz na aw nb bi"><span id="4872" class="nc ku iq my b gy nd ne l nf ng">root@i-04d089ed896cfafe1:~# kubectl get pods -o wide<br/>NAME                         READY   STATUS    RESTARTS   AGE     IP            NODE                  NOMINATED NODE   READINESS GATES<br/>mariadb-6cbf998bd6-s98nh     1/1     Running   0          2m21s   10.244.2.13   i-072bf7de2e94e6f2d   &lt;none&gt;           &lt;none&gt;<br/>nginx-68b4dfbcb6-s6zfh       1/1     Running   0          19s     10.244.1.12   i-0121c2149821379cc   &lt;none&gt;           &lt;none&gt;<br/>wordpress-558948b576-jgvm2   1/1     Running   0          71s     10.244.3.14   i-0cb1e2e7784768b22   &lt;none&gt;           &lt;none&gt;</span><span id="b3bf" class="nc ku iq my b gy nh ne l nf ng">root@i-04d089ed896cfafe1:~# kubectl get deployments<br/>NAME        READY   UP-TO-DATE   AVAILABLE   AGE<br/>mariadb     1/1     1            1           2m32s<br/>nginx       1/1     1            1           30s<br/>wordpress   1/1     1            1           82s</span><span id="2bc9" class="nc ku iq my b gy nh ne l nf ng">root@i-04d089ed896cfafe1:~# kubectl get svc<br/>NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE<br/>kubernetes      ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP    14m<br/>mariadb-svc     ClusterIP   10.108.78.60    &lt;none&gt;        3306/TCP   2m43s<br/>nginx-svc       ClusterIP   10.103.145.57   &lt;none&gt;        80/TCP     41s<br/>wordpress-svc   ClusterIP   10.103.49.246   &lt;none&gt;        9000/TCP   93s</span></pre><p id="902b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在你已经准备好设置WP，打开LB公共ip并按照向导进行操作。注意nginx和Kubernetes入口规则是在没有虚拟主机/服务器名称的情况下配置的。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/e31c7ce734812b83df2a9de788ce0f4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:938/format:webp/1*C4pnWSXKTJ2ih0S0EheT4Q.png"/></div></figure><p id="591f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要清理部署的资源:</p><pre class="mo mp mq mr gt mx my mz na aw nb bi"><span id="d2b3" class="nc ku iq my b gy nd ne l nf ng">kubectl delete -f <a class="ae ks" href="https://raw.githubusercontent.com/garutilorenzo/k3s-oci-cluster/master/deployments/mariadb/all-resources.yml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/garutilorenzo/k3s-oci-cluster/master/deployments/mariadb/all-resources.yml</a><br/>kubectl delete -f <a class="ae ks" href="https://raw.githubusercontent.com/garutilorenzo/k3s-oci-cluster/master/deployments/nginx/all-resources.yml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/garutilorenzo/k3s-oci-cluster/master/deployments/nginx/all-resources.yml</a><br/>kubectl delete -f <a class="ae ks" href="https://raw.githubusercontent.com/garutilorenzo/k3s-oci-cluster/master/deployments/wordpress/all-resources.yml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/garutilorenzo/k3s-oci-cluster/master/deployments/wordpress/all-resources.yml</a></span></pre><h1 id="7034" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">打扫</h1><p id="201a" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mk kh ki kj ml kl km kn mm kp kq kr ij bi translated">在摧毁所有的基础设施之前，删除S3桶中的所有对象。</p><pre class="mo mp mq mr gt mx my mz na aw nb bi"><span id="35b9" class="nc ku iq my b gy nd ne l nf ng">terraform destroy</span></pre></div></div>    
</body>
</html>