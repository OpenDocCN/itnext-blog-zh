<html>
<head>
<title>Vault cluster with auto unseal on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes上具有自动解封功能的保险库集群</h1>
<blockquote>原文：<a href="https://itnext.io/vault-cluster-with-auto-unseal-on-kubernetes-8e469f9cdcfd?source=collection_archive---------0-----------------------#2022-06-22">https://itnext.io/vault-cluster-with-auto-unseal-on-kubernetes-8e469f9cdcfd?source=collection_archive---------0-----------------------#2022-06-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="4350" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这又是一个有趣的跳马话题。</p><p id="6c0e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个脚本来实现一个简单的保险库集群，它作为后台存储集成到Consul集群中，并作为中转服务器来自动解封保险库集群，<strong class="jp ir">当然是为了测试目的</strong>。</p><p id="b9e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在解释剧本之前，让我们先回顾一些介绍。</p><h1 id="4b28" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">什么是跳马？</h1><p id="d65f" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">使用UI、CLI或HTTP API保护、存储和严格控制对令牌、密码、证书和加密密钥的访问，以保护机密和其他敏感数据。</p><h1 id="97ed" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">领事是什么？</h1><p id="5b71" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">Consul使用服务身份和传统网络实践来帮助组织安全地连接在任何环境中运行的应用程序。</p><h1 id="b0d5" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">什么是中转服务器？</h1><p id="b57d" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">Vault支持通过transit secrets引擎选择自动解封。此功能使操作员能够将解封过程委托给受信任的Vault环境，以简化操作。传输密封将Vault配置为使用Vault的传输密码引擎作为自动解封机制。</p><p id="489e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">在此查找代码:</strong></p><p id="409b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lo" href="https://github.com/hosein-yousefii/kubernetes-vault-cluster" rel="noopener ugc nofollow" target="_blank">https://github.com/hosein-yousefii/kubernetes-vault-cluster</a></p></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><p id="deae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">入门</strong>:</p><p id="f5de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如您可以在这里找到的，vault中的Transit secrets引擎能够为您的vault集群存储密钥，以便自动解封它。</p><p id="9f7d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于此设置，我们需要:</p><p id="ba2a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1-每个vault节点都有consul客户端的vault集群</p><p id="81e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2-作为传输秘密引擎的另一个vault实例</p><p id="2483" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3-咨询集群以存储我们节点的数据</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi lw"><img src="../Images/a826211906c0c6d582b7a445580e3d0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KP3a4L3v93reVSBH1TDsIQ.png"/></div></div></figure><p id="7fa6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们有一个脚本来在Kubernetes上实现和配置所有这些功能。</p><p id="1c2a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们来了解一下剧本“<code class="fe mi mj mk ml b">vault-cluster.sh</code>”:</p><p id="2a28" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 1。</strong>我们通过删除“vault-cluster”命名空间及其持久卷来清理环境。然后从部署Consul集群开始。</p><pre class="lx ly lz ma gt mm ml mn mo aw mp bi"><span id="4069" class="mq km iq ml b gy mr ms l mt mu">kubectl create namespace vault-cluster <br/>kubectl apply -f consul/cm.yaml <br/>kubectl apply -f consul/svc.yaml <br/>kubectl apply -f consul/deploy.yaml </span><span id="a2b1" class="mq km iq ml b gy mv ms l mt mu">REPLICAS=$(kubectl get statefulsets.apps --namespace=vault-cluster -o custom-columns=:.spec.replicas consul|tail -1)<br/>REPLICA=$(expr ${REPLICAS} - 1)</span><span id="a6f7" class="mq km iq ml b gy mv ms l mt mu">while [[ ! $(kubectl get po --namespace=vault-cluster --field-selector status.phase=Running|grep consul-$REPLICA ) ]]<br/>do <br/> echo -ne .<br/> sleep 5s<br/> <br/>done</span></pre><p id="742a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为你能在我的<a class="ae lo" href="https://github.com/hosein-yousefii/kubernetes-vault-cluster" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到文件:</p><p id="4fc7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">cm参考配置图。</p><p id="f828" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">svc指服务。</p><p id="329a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">部署参考主文件进行部署。</p><p id="89c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 2。</strong>我们部署了Vault transit server和Vault cluster。</p><p id="4452" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 3。</strong>让我们配置Vault中转服务器:</p><pre class="lx ly lz ma gt mm ml mn mo aw mp bi"><span id="f01f" class="mq km iq ml b gy mr ms l mt mu"># FIRSTLY initialize the vault <br/>kubectl exec --namespace=vault-cluster --stdin --tty $TRANSIT_SERVER_NAME -- vault operator init -format=yaml &gt; vault-auto-unseal-keys.txt   </span><span id="260f" class="mq km iq ml b gy mv ms l mt mu"># SECONDLY unseal it                                                       <br/>kubectl exec --namespace=vault-cluster --stdin --tty $TRANSIT_SERVER_NAME -- vault operator unseal -tls-skip-verify $(grep -A 5 unseal_keys_b64 vault-auto-unseal-keys.txt |head -2|tail -1|sed 's/- //g')</span><span id="ebbc" class="mq km iq ml b gy mv ms l mt mu">kubectl exec --namespace=vault-cluster --stdin --tty $TRANSIT_SERVER_NAME -- vault operator unseal -tls-skip-verify $(grep -A 5 unseal_keys_b64 vault-auto-unseal-keys.txt |head -3|tail -1|sed 's/- //g')</span><span id="f4e3" class="mq km iq ml b gy mv ms l mt mu">kubectl exec --namespace=vault-cluster --stdin --tty $TRANSIT_SERVER_NAME -- vault operator unseal -tls-skip-verify $(grep -A 5 unseal_keys_b64 vault-auto-unseal-keys.txt |head -4|tail -1|sed 's/- //g')</span></pre><p id="9846" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">是时候启用机密、策略和令牌了:</p><pre class="lx ly lz ma gt mm ml mn mo aw mp bi"><span id="7d73" class="mq km iq ml b gy mr ms l mt mu">VAULT_AUTO_UNSEAL_ROOT_TOKEN=$(grep root_token vault-auto-unseal-keys.txt |awk -F: '{print $2}'|sed 's/ //g')</span><span id="cf55" class="mq km iq ml b gy mv ms l mt mu">kubectl exec --namespace=vault-cluster --stdin --tty $TRANSIT_SERVER_NAME -- vault login -tls-skip-verify ${VAULT_AUTO_UNSEAL_ROOT_TOKEN} </span><span id="d501" class="mq km iq ml b gy mv ms l mt mu">kubectl exec --namespace=vault-cluster --stdin --tty $TRANSIT_SERVER_NAME -- vault audit enable file file_path=/vault/logs/audit.log </span><span id="3b4f" class="mq km iq ml b gy mv ms l mt mu">kubectl exec --namespace=vault-cluster --stdin --tty $TRANSIT_SERVER_NAME -- vault secrets enable transit </span><span id="b5c5" class="mq km iq ml b gy mv ms l mt mu">kubectl exec --namespace=vault-cluster --stdin --tty $TRANSIT_SERVER_NAME -- vault write -f transit/keys/autounseal </span><span id="2939" class="mq km iq ml b gy mv ms l mt mu">kubectl exec --namespace=vault-cluster --stdin --tty $TRANSIT_SERVER_NAME -- vault policy write autounseal /vault/unseal/autounseal.hcl </span><span id="e281" class="mq km iq ml b gy mv ms l mt mu">kubectl exec --namespace=vault-cluster --stdin --tty $TRANSIT_SERVER_NAME -- vault token create -policy="autounseal" -wrap-ttl=12000 -format=yaml &gt; .vault-auto-unseal-token.txt</span></pre><p id="4939" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">金库包裹:</strong></p><p id="f1c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在许多Vault部署中，客户端可以直接访问Vault并使用返回的机密。在其他情况下，分离特权可能是有意义的或者是期望的，使得一个受信任的实体负责与大多数Vault API进行交互，并且将秘密传递给最终消费者。</p><p id="d5cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当响应被包装时，来自Vault的普通API响应不包含原始机密，而是包含一组与响应包装标记相关的信息:TTL、标记、创建时间、创建路径、包装的访问器。</p><p id="a78a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后:解开令牌，返回里面的响应。返回的响应将是原始的有线格式响应；它可以直接用于API客户端。</p><p id="2883" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们把它自动化:</p><pre class="lx ly lz ma gt mm ml mn mo aw mp bi"><span id="ccda" class="mq km iq ml b gy mr ms l mt mu">VAULT_AUTO_UNSEAL_TOKEN=$(grep token: .vault-auto-unseal-token.txt|awk '{print $2}'|tr -d '\r')</span><span id="e543" class="mq km iq ml b gy mv ms l mt mu">kubectl exec --namespace=vault-cluster --stdin --tty $TRANSIT_SERVER_NAME -- env VAULT_TOKEN=${VAULT_AUTO_UNSEAL_TOKEN} vault unwrap -format=yaml &gt; .vault-unwrap-token.txt</span><span id="e610" class="mq km iq ml b gy mv ms l mt mu">VAULT_AUTO_UNSEAL_TOKEN=$(grep client_token: .vault-unwrap-token.txt|awk '{print $2}'|tr -d '\r')</span></pre><p id="70fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 4。</strong>下一步是配置存储集群并咨询客户端配置图:</p><pre class="lx ly lz ma gt mm ml mn mo aw mp bi"><span id="8c20" class="mq km iq ml b gy mr ms l mt mu">tee vault/cm-updated.yaml &lt;&lt; EOF<br/>apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: vault-config<br/>  namespace: vault-cluster<br/>  labels:<br/>    app.kubernetes.io/name: vault<br/>    app.kubernetes.io/creator: hossein-yousefi<br/>    app.kubernetes.io/stack: vault-cluster<br/>data:<br/>  config.hcl: |<br/>    listener "tcp" {<br/>      tls_disable = 1<br/>      address          = "0.0.0.0:8200"<br/>      cluster_address  = "0.0.0.0:8201"   <br/>     }<br/>    storage "consul" {<br/>      address = "consul:8500"<br/>      path    = "vault/"<br/>     }<br/>    disable_mlock = true<br/>    seal "transit" {<br/>      address = "<a class="ae lo" href="http://vault-auto-unseal:8200" rel="noopener ugc nofollow" target="_blank">http://vault-auto-unseal:8200</a>"<br/>      token = "${VAULT_AUTO_UNSEAL_TOKEN}"<br/>      disable_renewal = "false"<br/>      key_name = "autounseal"<br/>      mount_path = "transit/"<br/>      tls_skip_verify = "true"<br/>     }</span><span id="a240" class="mq km iq ml b gy mv ms l mt mu">---</span><span id="fbd3" class="mq km iq ml b gy mv ms l mt mu">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  namespace: vault-cluster<br/>  name: consul-client-config<br/>  labels:<br/>    app.kubernetes.io/name: vault<br/>    app.kubernetes.io/creator: hossein-yousefi<br/>    app.kubernetes.io/stack: vault-cluster<br/>data:<br/>  consul.json: |<br/>   {<br/>      "server": false,<br/>      "datacenter": "dc1",<br/>      "data_dir": "/consul/data/",<br/>      "bind_addr": "0.0.0.0",<br/>      "client_addr": "0.0.0.0",<br/>      "retry_join": ["vault"],<br/>      "log_level": "DEBUG",<br/>      "acl_enforce_version_8": false<br/>   } <br/>EOF</span><span id="fd69" class="mq km iq ml b gy mv ms l mt mu">kubectl apply -f vault/cm-updated.yaml &amp;&gt; /dev/null</span><span id="ee9f" class="mq km iq ml b gy mv ms l mt mu">kubectl rollout restart statefulsets --namespace=vault-cluster vault</span></pre><p id="23f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 5。</strong>最后一步是初始化vault-0:</p><pre class="lx ly lz ma gt mm ml mn mo aw mp bi"><span id="4750" class="mq km iq ml b gy mr ms l mt mu">kubectl exec — namespace=vault-cluster — stdin — tty vault-0 -c vault — vault operator init -format=yaml &gt; vault-keys.txt</span><span id="9a8e" class="mq km iq ml b gy mv ms l mt mu">kubectl exec — namespace=vault-cluster — stdin — tty vault-1 -c vault — vault operator unseal -tls-skip-verify $(grep -A 5 unseal_keys_b64 vault-keys.txt |head -2|tail -1|sed ‘s/- //g’)</span><span id="06b1" class="mq km iq ml b gy mv ms l mt mu">kubectl exec — namespace=vault-cluster — stdin — tty vault-1 -c vault — vault operator unseal -tls-skip-verify $(grep -A 5 unseal_keys_b64 vault-keys.txt |head -3|tail -1|sed ‘s/- //g’)</span><span id="1101" class="mq km iq ml b gy mv ms l mt mu">kubectl exec — namespace=vault-cluster — stdin — tty vault-1 -c vault — vault operator unseal -tls-skip-verify $(grep -A 5 unseal_keys_b64 vault-keys.txt |head -4|tail -1|sed ‘s/- //g’)</span></pre><p id="9d89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">最后:</strong>我们有一个保险库集群，它可以使用另一个保险库服务器作为传输秘密引擎来解封自己。</p><p id="5da5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">在我的</strong><a class="ae lo" href="https://github.com/hosein-yousefii/kubernetes-vault-cluster" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">GitHub</strong></a><strong class="jp ir">上找到所有文件，有问题尽管提。</strong></p></div></div>    
</body>
</html>