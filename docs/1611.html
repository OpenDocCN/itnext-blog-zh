<html>
<head>
<title>Testing Ansible Roles: A practical application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">测试可承担的角色:一个实际应用</h1>
<blockquote>原文：<a href="https://itnext.io/testing-ansible-roles-a-practical-application-2afc96e0d7d?source=collection_archive---------3-----------------------#2018-12-11">https://itnext.io/testing-ansible-roles-a-practical-application-2afc96e0d7d?source=collection_archive---------3-----------------------#2018-12-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/edfea6aa068b5552af5ef6a2d1175cd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SFHa5-fFCQGNqb6T"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">克里斯里德在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="aaba" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> Ansible </strong>是<a class="ae kc" href="https://www.ansible.com/use-cases" rel="noopener ugc nofollow" target="_blank">配置管理、编排、持续交付等</a>的强大工具。作为一名软件开发人员，在过去的两年里，我一直在利用Ansible作为核心机制，以可共享和人类可读的方式完成可重复的步骤。说得好听点，当一个同事指给我看<a class="ae kc" href="https://molecule.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">分子</strong> </a>时，我很困惑。</p><div class="lc ld gp gr le lf"><a href="https://molecule.readthedocs.io/en/latest/" rel="noopener  ugc nofollow" target="_blank"><div class="lg ab fo"><div class="lh ab li cl cj lj"><h2 class="bd ir gy z fp lk fr fs ll fu fw ip bi translated">分子-分子0.0.1.dev49文档</h2><div class="lm l"><h3 class="bd b gy z fp lk fr fs ll fu fw dk translated">Molecule旨在帮助开发和测试可能的角色。分子为测试提供支持…</h3></div><div class="ln l"><p class="bd b dl z fp lk fr fs ll fu fw dk translated">分子. readthedocs.io</p></div></div><div class="lo l"><div class="lp l lq lr ls lo lt jw lf"/></div></div></a></div><p id="8d4d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">来自一个对照目标<em class="lb">测试</em>系统运行剧本的世界，看看会发生什么，然后接下来启动一个虚拟机、流浪者或docker系统，然后在我开发角色或剧本时不得不回滚错误；我发现这个工具非常有趣。<em class="lb"> Molecule </em>不仅允许你测试你正在构建的角色，比如语法，还允许测试系统的可重复设置和拆卸。来自<a class="ae kc" href="https://opensource.com/article/18/12/testing-ansible-roles-molecule" rel="noopener ugc nofollow" target="_blank">opensource.com</a>的以下文章涵盖了<em class="lb">分子</em>的基础知识。稍微浏览一下Molecule的介绍性文章和文档，然后我们可以从我如何将它应用到一个实际用例开始，以及一些关于如何充分利用<em class="lb"> Molecule </em>的提示/技巧。</p></div><div class="ab cl lu lv hu lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ij ik il im in"><h1 id="9f6f" class="mb mc iq bd md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my bi translated">用例</h1><p id="81bf" class="pw-post-body-paragraph kd ke iq kf b kg mz ki kj kk na km kn ko nb kq kr ks nc ku kv kw nd ky kz la ij bi translated">在我当前的项目中，我们从<a class="ae kc" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir">Kubernetes</strong></a>(<a class="ae kc" href="https://www.openshift.com/" rel="noopener ugc nofollow" target="_blank"><em class="lb">open shift</em></a>)中提取数据来确定运行一个集群的成本。我们利用<a class="ae kc" href="https://github.com/operator-framework/operator-metering" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">操作员计量</strong> </a>，它从<a class="ae kc" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">普罗米修斯</strong> </a>中提取度量来收集使用信息。我们构建了一个项目，<a class="ae kc" href="https://github.com/project-koku/korekuta" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir"><em class="lb">Kore kuta</em></strong></a>，它利用<em class="lb"> Ansible </em>来执行两个任务:</p><p id="3499" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">(1)设置运营商计量报告并存储配置数据</p><p id="f6c3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">(2)从运营商计量API收集数据，并发送到云存储进行处理</p><figure class="nf ng nh ni gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ne"><img src="../Images/1889ea9e23a6977ccf7b6d67ae31c907.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_N6Q-jIoKzoC9_OLFrrEjQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Korekuta的可翻译剧本</figcaption></figure><p id="dd1e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了实现这一点，创建了两个角色(<em class="lb"> setup </em>和<em class="lb"> collec </em> t ),并在剧本中使用标记来触发每个角色。</p><h1 id="6314" class="mb mc iq bd md me nj mg mh mi nk mk ml mm nl mo mp mq nm ms mt mu nn mw mx my bi translated">分子设置</h1><p id="ffaf" class="pw-post-body-paragraph kd ke iq kf b kg mz ki kj kk na km kn ko nb kq kr ks nc ku kv kw nd ky kz la ij bi translated">正如在介绍性文章中所述，<em class="lb"> Molecule </em>可以与从Docker到流浪者和Virtualbox等各种驱动程序一起工作。设置过程的美妙之处在于它使用了<em class="lb"> Ansible </em>，这是您非常熟悉的东西，用来准备测试系统。当您为测试构建一个角色时，您可以添加一个<em class="lb"> prepare.yml </em>作为测试系统设置的剧本。<em class="lb"> prepare.yml </em>位于<em class="lb">&lt;role&gt;/Molecule/default/</em>目录中，由<em class="lb"> Molecule </em>测试流程的<strong class="kf ir"> Prepare </strong>步骤触发。</p><p id="5141" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于<em class="lb"> Korekuta </em>设置角色<a class="ae kc" href="https://github.com/project-koku/korekuta/blob/master/roles/setup/molecule/default/prepare.yml" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">准备</strong> </a>步骤执行以下操作:</p><ol class=""><li id="6620" class="no np iq kf b kg kh kk kl ko nq ks nr kw ns la nt nu nv nw bi translated">使用Ansible Galaxy 中的<a class="ae kc" href="https://galaxy.ansible.com/andrewrothstein/openshift-origin-client-tools" rel="noopener ugc nofollow" target="_blank">现有角色安装Openshift客户端工具</a></li><li id="3bff" class="no np iq kf b kg nx kk ny ko nz ks oa kw ob la nt nu nv nw bi translated">创建命令行工具的存在</li><li id="f804" class="no np iq kf b kg nx kk ny ko nz ks oa kw ob la nt nu nv nw bi translated">在一个已知的位置创建一个文件作为额外的变量输入</li><li id="c3aa" class="no np iq kf b kg nx kk ny ko nz ks oa kw ob la nt nu nv nw bi translated">创建一个简单的web服务器来响应预期的有效负载</li></ol><p id="c6e3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb"> Molecule的</em>与<a class="ae kc" href="https://galaxy.ansible.com/home" rel="noopener ugc nofollow" target="_blank"> Ansible Galaxy的</a>整合，让你可以搭载其他人之前构建的所有伟大角色。不幸的是，我发现缺少关于此功能的文档，因此您可以在下面看到角色的用法示例:</p><figure class="nf ng nh ni gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/4b78f72adbe650944fc3d757eed88b08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YxE7Mn08jKyNfmAFmZ1K-Q.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">执行来自Ansible Galaxy的角色</figcaption></figure><p id="6477" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了利用这个角色，您必须通过将<em class="lb"> requirements.yml </em>添加到<em class="lb">&lt;role&gt;/molecule/default/</em>目录来指定您的角色对它的依赖。对于<em class="lb"> Korekuta </em>，<a class="ae kc" href="https://github.com/project-koku/korekuta/blob/master/roles/setup/molecule/default/requirements.yml" rel="noopener ugc nofollow" target="_blank">要求. yml </a>如下:</p><figure class="nf ng nh ni gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/2d1958a617e726e18f4cb3c9bed194d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lmNwTiZcA15VK0fhN1dGEA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">要求使用一个可回答的银河角色。</figcaption></figure><p id="7713" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过这些小步骤，您可以利用<em class="lb"> Ansible Galaxy </em>充满活力的生态系统，轻松设置测试系统。</p><h1 id="371e" class="mb mc iq bd md me nj mg mh mi nk mk ml mm nl mo mp mq nm ms mt mu nn mw mx my bi translated">分子测试执行</h1><p id="57bd" class="pw-post-body-paragraph kd ke iq kf b kg mz ki kj kk na km kn ko nb kq kr ks nc ku kv kw nd ky kz la ij bi translated"><em class="lb"> Molecule </em>再次利用用户熟悉的领域，让角色的“测试者”成为剧本。上一节我提到了<em class="lb"> &lt;角色&gt;/分子/默认/ </em>目录，然而<strong class="kf ir"> <em class="lb">默认</em> </strong>目录只是一个测试用例，所以概括其实际<em class="lb"> &lt;角色&gt;/分子/ &lt;测试_用例&gt;/</em>；并且其中每个都有一个<em class="lb"> playbook.yml </em>将在<strong class="kf ir"> Converge </strong>步骤中执行。使用这种结构，您可以为您的角色设置各种各样的测试流，以及前面部分提到的专门设置。</p><figure class="nf ng nh ni gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oe"><img src="../Images/20cf6666c90ae34b39795baa0ad08650.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rmZTZrVC_e_bK-vM1yfZTA.png"/></div></div></figure><p id="0b8b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Korekuta的设置角色的<a class="ae kc" href="https://github.com/project-koku/korekuta/blob/master/roles/setup/molecule/default/playbook.yml" rel="noopener ugc nofollow" target="_blank"> playbook.yml </a>相当简单，然而，它的“运行时”执行依赖于用户使用<em class="lb"> Ansible </em>的<em class="lb">-e VARIABLE = VALUE】</em>机制向命令行提供额外的变量。出于测试目的，我们可以使用行动手册中的<strong class="kf ir"> <em class="lb">变量</em> </strong>选项来提供这些输入值，然后使用多个测试用例来改变不同行动手册的输入，如示例所示。</p><p id="d008" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正如介绍文章中提到的，<em class="lb"> Molecule </em>允许您测试测试用例的预期结果，并建立一个持续的集成流程。因为这些在文章和文档中已经足够清楚地涵盖了，为了完整起见，我将只在<em class="lb"> Korekuta </em>中链接这些项目。</p><ul class=""><li id="c67c" class="no np iq kf b kg kh kk kl ko nq ks nr kw ns la of nu nv nw bi translated"><a class="ae kc" href="https://github.com/project-koku/korekuta/blob/master/roles/setup/molecule/default/tests/test_default.py" rel="noopener ugc nofollow" target="_blank">使用TestInfra的默认测试用例</a></li><li id="a227" class="no np iq kf b kg nx kk ny ko nz ks oa kw ob la of nu nv nw bi translated"><a class="ae kc" href="https://github.com/project-koku/korekuta/blob/master/.travis.yml" rel="noopener ugc nofollow" target="_blank">使用Tox、Pipenv和Molecule的TravisCI】</a></li></ul><h1 id="532d" class="mb mc iq bd md me nj mg mh mi nk mk ml mm nl mo mp mq nm ms mt mu nn mw mx my bi translated">摘要</h1><p id="8f65" class="pw-post-body-paragraph kd ke iq kf b kg mz ki kj kk na km kn ko nb kq kr ks nc ku kv kw nd ky kz la ij bi translated">在本文中，我们已经介绍了如何使用<em class="lb">分子</em>和一些高级资源来测试<em class="lb">角色</em>。接下来，我们进入了一个利用<em class="lb">分子</em>的项目，讨论了测试设置和执行是如何工作的，包括使用<em class="lb"> Ansible Galaxy </em>角色和用多个测试用例驱动额外变量流的技巧。希望与测试一个<em class="lb">责任</em>角色的实际应用相关的资源能为您提供价值。</p><p id="f2c4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">自动化快乐！</p></div></div>    
</body>
</html>