<html>
<head>
<title>Save up to 80% using Azure Cosmos DB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure Cosmos DB节省高达80%的费用</h1>
<blockquote>原文：<a href="https://itnext.io/azure-cosmos-db-costs-down-by-up-to-80-da9e0028049?source=collection_archive---------2-----------------------#2020-04-28">https://itnext.io/azure-cosmos-db-costs-down-by-up-to-80-da9e0028049?source=collection_archive---------2-----------------------#2020-04-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/9bf0dde00f494b2deb2c133441a8274e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1382/format:webp/0*Fi3K8mMyoZ58DeIJ.png"/></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk translated">Azure Cosmos DB徽标</figcaption></figure><p id="c8de" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你一直在使用Azure Cosmos DB，有可能你支付的比你需要支付的要多。</p><h2 id="7a70" class="kz la it bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">Azure Cosmos DB是什么？</h2><p id="de7d" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">它是Azure中的NoSQL数据库即服务。它非常适合存储JSON文档并通过一个键检索它。主要区别在于，在这种情况下，您不需要像SQL那样维护显式模式，并且您的查询/更新是针对整个文档的。</p><h2 id="2945" class="kz la it bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">这种省钱的标准</h2><p id="c715" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">你有多个收藏吗？如果是，您是在集合级别还是在数据库级别使用DTU(数据传输单位)？如果您使用DTU每集合，您可能能够为您的公司节省一些钱。</p><p id="8777" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Azure Cosmos DB最小DTU大小为400，每月花费23.36美元。例如，假设您有3个集合:</p><ul class=""><li id="e823" class="lx ly it kd b ke kf ki kj km lz kq ma ku mb ky mc md me mf bi translated">客户——23.36美元</li><li id="2862" class="lx ly it kd b ke mg ki mh km mi kq mj ku mk ky mc md me mf bi translated">客户配置—23.36美元</li><li id="2113" class="lx ly it kd b ke mg ki mh km mi kq mj ku mk ky mc md me mf bi translated">客户订单—23.36美元</li></ul><p id="6af0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这意味着这种数据库配置的成本约为每月70美元。假设这些集合的使用率非常低，那么您可以在数据库级别配置400个DTU，而不是每个集合一个处理单元(DTU)。</p><p id="1a96" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这样每月可以节省46.72美元。</p><p id="7e14" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您不太可能运行单个生产环境，您最有可能有一个转移环境和一个活动环境，如果不是更多的话，那么您可以将这些节省乘以环境的数量。<strong class="kd iu">每次申请每月93.44美元或以上。</strong></p><p id="bbf7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">即使不是所有的集合使用率都很低，您仍然可以从跨集合共享资源中受益。</p><h1 id="5811" class="ml la it bd lb mm mn mo le mp mq mr lh ms mt mu lk mv mw mx ln my mz na lq nb bi translated">如何从DTU每集合迁移到DTU每数据库</h1><p id="aefd" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">首先，您需要创建新的数据库和集合。您可以使用此代码创建包含400个DTU的数据库:</p><figure class="nc nd ne nf gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk translated">宇宙数据库和集合初始化，DTU的数据库级</figcaption></figure><p id="4a0a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Azure门户的最终结果是:</p><figure class="nc nd ne nf gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="nj nk di nl bf nm"><div class="gh gi ni"><img src="../Images/cf813bc6e5bd382e649b2df8259f7d22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rYN1poK7_P1CJOSwb8fh5w.png"/></div></div></figure><p id="726d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">你可以看到<em class="nn">“DTUCollectionLevelDB”</em>中的收藏都有它们的“比例&amp;设置”。而在数据库<em class="nn">“DTUDatabaseLevelDb”</em>中，只有一个“Scale”，是数据库级别的。</p><p id="85df" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">第二步是你需要考虑两件事，如何迁移数据和如何进行这种改变。这是交换数据库的挑战:</p><ul class=""><li id="09a7" class="lx ly it kd b ke kf ki kj km lz kq ma ku mb ky mc md me mf bi translated">如果有读取，它们的读取会有多陈旧？</li><li id="01b9" class="lx ly it kd b ke mg ki mh km mi kq mj ku mk ky mc md me mf bi translated">我们可以让应用程序离线还是在一个安静的时间进行？</li><li id="2c25" class="lx ly it kd b ke mg ki mh km mi kq mj ku mk ky mc md me mf bi translated">如何在不丢失任何记录的情况下将数据迁移到新的数据库中？</li></ul><h2 id="bd71" class="kz la it bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">让我们首先解决部署问题:</h2><figure class="nc nd ne nf gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="nj nk di nl bf nm"><div class="gh gi no"><img src="../Images/49113477d6fb22586378f277e928f598.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EttRU_xXyQVL23Xkv7V6Wg.png"/></div></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk translated">多个数据库的蓝/绿部署—在<a class="ae np" href="https://draw.io" rel="noopener ugc nofollow" target="_blank"> draw.io </a>创建</figcaption></figure><p id="aa86" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你在Azure中，你很可能会做一些蓝/绿部署，所以用户会点击绿色区域，同时有一个准备好的API等待上线。</p><p id="6e0c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一旦数据被迁移，您可以通过将您的用户发送到使用新数据库的Staging API来简单地交换它们。</p><figure class="nc nd ne nf gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="nj nk di nl bf nm"><div class="gh gi no"><img src="../Images/497a9c6a01fa267e8ee71c178b6326cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KNm2gtTWlyYqF8tmDS5nqA.png"/></div></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk translated">多个数据库的蓝/绿部署，交换—在<a class="ae np" href="https://draw.io" rel="noopener ugc nofollow" target="_blank"> draw.io </a>创建</figcaption></figure><h2 id="d7e6" class="kz la it bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">迁移数据</h2><p id="30f9" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">微软提供了这个<a class="ae np" href="https://docs.microsoft.com/en-us/azure/cosmos-db/import-data" rel="noopener ugc nofollow" target="_blank">工具</a>来轻松迁移数据。</p><p id="d3ad" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下载并安装后，我们可以从选择要迁移的源数据开始，例如:</p><figure class="nc nd ne nf gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="nj nk di nl bf nm"><div class="gh gi nq"><img src="../Images/07a3dfaed9c953352dcf223bad18ec21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P27U7JccoVTtRuLXDGsvWw.png"/></div></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk translated">Azure Cosmos DB迁移工具—选择源数据库</figcaption></figure><p id="0f4d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您可以从Azure门户的keys区域获取连接字符串。<br/>唯一的技巧是你需要在最后添加<strong class="kd iu"> Database={DatabaseName} </strong>来选择数据库。</p><p id="11ad" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后我们需要选择目标，例如:</p><figure class="nc nd ne nf gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="nj nk di nl bf nm"><div class="gh gi nr"><img src="../Images/3961a16e9a2b458f02ff2d557df5ebd7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZAY7_y_51ZdJ8l_1H-qFhA.png"/></div></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk translated">Azure Cosmos DB迁移工具—选择目标数据库</figcaption></figure><p id="d1a2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在您触发迁移之前，最好捕获当前的<a class="ae np" href="https://www.unixtimestamp.com/" rel="noopener ugc nofollow" target="_blank"> Unix时间戳</a>，因为这将是您迁移数据的时间点，我们稍后将使用它。</p><blockquote class="ns nt nu"><p id="1b76" class="kb kc nn kd b ke kf kg kh ki kj kk kl nv kn ko kp nw kr ks kt nx kv kw kx ky im bi translated">例如:1588103482</p></blockquote><p id="679f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">迁移结果:</p><figure class="nc nd ne nf gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="nj nk di nl bf nm"><div class="gh gi nr"><img src="../Images/d96ff1f731980d16b20a413c9f7ef991.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*colP3PaS7lFu--wmWx5ZWQ.png"/></div></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk translated">Azure Cosmos DB迁移工具—结果</figcaption></figure><blockquote class="ny"><p id="0d4b" class="nz oa it bd ob oc od oe of og oh ky dk translated">提示:如果您正在迁移大量数据，您最好使用更多的DTU来扩展数据库，这样迁移可以平稳快速地进行。</p></blockquote><p id="edff" class="pw-post-body-paragraph kb kc it kd b ke oi kg kh ki oj kk kl km ok ko kp kq ol ks kt ku om kw kx ky im bi translated">在删除旧数据库之前，为了安全起见，您可以通过将目标更改为以下形式，轻松地在JSON文件中创建备份:</p><figure class="nc nd ne nf gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="nj nk di nl bf nm"><div class="gh gi on"><img src="../Images/a7243227a959ccd93f47b6a6271aee36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kmItSEoCEEkl7--OnUfW4w.png"/></div></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk translated">Azure Cosmos DB迁移工具—以JSON文件为目标</figcaption></figure><p id="1d8f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">作为健全性检查，如果您想要验证您获得了先前数据库中的所有数据，您可以在您的Cosmos DB上运行查询，以找出在我们触发迁移后是否有任何记录被修改，为此我们可以:</p><figure class="nc nd ne nf gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk translated">Cosmos DB查询，以便在我们开始迁移后修改记录</figcaption></figure><p id="7589" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您看到任何记录被修改，您可以手动移动这些记录，或者在应用程序写入新的DB时，使用前面的查询再次触发同步。</p><h1 id="bdd2" class="ml la it bd lb mm mn mo le mp mq mr lh ms mt mu lk mv mw mx ln my mz na lq nb bi translated">包装它</h1><p id="3cc0" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">每当进行这样的数据迁移时，您最好在测试环境中预演一下，这样您就会熟悉这个过程。相信我，如果您需要让应用程序重新上线，而迁移过程又出了问题，那就一点也不好玩了。</p><p id="c510" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果在正确的情况下使用，Cosmos DB可以大大加快开发速度，但是您还需要关注它的成本，如果您使用多个集合，可以考虑在它们之间共享DTU资源，从而为企业节省一些资金。</p></div></div>    
</body>
</html>