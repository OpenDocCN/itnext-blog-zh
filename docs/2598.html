<html>
<head>
<title>Deploy ELK stack in Docker to monitor containers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Docker中部署ELK堆栈来监控容器</h1>
<blockquote>原文：<a href="https://itnext.io/deploy-elk-stack-in-docker-to-monitor-containers-c647d7e2bfcd?source=collection_archive---------1-----------------------#2019-06-21">https://itnext.io/deploy-elk-stack-in-docker-to-monitor-containers-c647d7e2bfcd?source=collection_archive---------1-----------------------#2019-06-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><blockquote class="jq jr js"><p id="a1a4" class="jt ju jv jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr im bi translated">在这篇博客中，我将展示如何创建一个集中的日志解决方案，从不同的容器中收集所有的Docker日志。这里我们将使用众所周知的<a class="ae ks" href="https://www.elastic.co/elk-stack" rel="noopener ugc nofollow" target="_blank">麋鹿栈</a> (Elasticsearch，Logstash，Kibana)。</p></blockquote><p id="b763" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">我们将使用docker-compose来部署我们的ELK堆栈。Docker-compose为我们提供了同时部署多个容器的解决方案。</p><p id="04de" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">先决条件:</p><ul class=""><li id="50b0" class="kw kx it jw b jx jy kb kc kt ky ku kz kv la kr lb lc ld le bi translated"><a class="ae ks" href="https://docs.docker.com/install/" rel="noopener ugc nofollow" target="_blank">码头工人</a></li><li id="54e3" class="kw kx it jw b jx lf kb lg kt lh ku li kv lj kr lb lc ld le bi translated"><a class="ae ks" href="https://docs.docker.com/compose/install/" rel="noopener ugc nofollow" target="_blank"> Docker-Compose </a></li></ul><p id="ba5c" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">我的GitHub 上有完整的模板<a class="ae ks" href="https://github.com/lvthillo/docker-elk" rel="noopener ugc nofollow" target="_blank">。使用Docker-compose克隆存储库并启动容器。</a></p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="fd76" class="lt lu it lp b gy lv lw l lx ly">$ git clone <a class="ae ks" href="https://github.com/lvthillo/docker-elk.git" rel="noopener ugc nofollow" target="_blank">https://github.com/lvthillo/docker-elk.git</a><br/>$ cd docker-elk<br/>$ docker-compose up -d</span></pre><p id="3068" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">部署的第一个资源是Elasticsearch。Elasticsearch是一个快速分析和剖析不同类型数据的系统。我们可以使用单个实例，并通过使用环境变量来禁用<a class="ae ks" href="https://www.elastic.co/products/stack" rel="noopener ugc nofollow" target="_blank"> xpack </a>(付费功能)。它部署在<code class="fe lz ma mb lp b">logging-network</code>中，这是一个<a class="ae ks" href="https://docs.docker.com/network/bridge/" rel="noopener ugc nofollow" target="_blank"> Docker桥接网络</a>。</p><figure class="lk ll lm ln gt mc"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="609b" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">现在我们将部署Logstash。Logstash是一个开源的服务器端数据处理管道，它同时从多个来源获取数据，对其进行转换，然后将其发送到Elasticsearch等工具。</p><figure class="lk ll lm ln gt mc"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="3c16" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">Logstash依赖于需要首先部署的Elasticsearch。端口<code class="fe lz ma mb lp b">12201</code>在服务器上公开并映射。其他Docker容器会通过连接到这个UDP端口将它们的日志发送到Logstash。作为体积我们将把<code class="fe lz ma mb lp b">logstash.conf</code>装在集装箱里面。</p><p id="df6c" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">我们将期待Gelf输入。Gelf是Graylog扩展日志格式，是从应用程序内部进行日志记录的绝佳选择。我们会将日志发送到我们的ElasticSearch容器中。它们可以使用它们的服务名相互通信，因为它们部署在同一个Docker网桥网络中。</p><figure class="lk ll lm ln gt mc"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="e1a5" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">文件<code class="fe lz ma mb lp b">/usr/share/logstash/config/pipelines.yml</code>包含Logstash运行的可用管道。在这里，我们可以定义特定的文件(管道)，但我们现在只使用一个管道。默认文件描述了我们的<code class="fe lz ma mb lp b">logstash.conf</code>可用的目录，因此我们不需要更新我们的管道配置。如果你想运行多个管道，你可以添加额外的id并指向特定的<code class="fe lz ma mb lp b">.conf</code>文件，而不是像现在这样(默认)指向一个目录。欲了解更多信息，请看这里的<a class="ae ks" href="https://www.elastic.co/guide/en/logstash/current/multiple-pipelines.html" rel="noopener ugc nofollow" target="_blank"/>。</p><figure class="lk ll lm ln gt mc"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="5a0a" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">如果配置了多个管道，那么调试Logstash容器会很有用。您可以使用<code class="fe lz ma mb lp b">docker exec</code>来调试您的Logstash容器并检查配置文件。这超出了我们当前基本设置的范围。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="cbfa" class="lt lu it lp b gy lv lw l lx ly">$ <!-- -->docker exec -it docker-elk_logstash_1 bash<br/>bash-4.2$ cat /usr/share/logstash/pipeline/logstash.conf<br/>input {<br/>  gelf {}<br/>}</span><span id="8412" class="lt lu it lp b gy mf lw l lx ly">output {<br/>  elasticsearch {<br/>    hosts =&gt; "elasticsearch:9200"<br/>  }<br/>}</span></pre><p id="c1c1" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">模板中最后一个与ELK stack相关的服务是Kibana的设置。Kibana让我们可视化我们的弹性搜索数据。</p><figure class="lk ll lm ln gt mc"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="83f7" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">基巴纳依赖于Logstash，将暴露和地图港口<code class="fe lz ma mb lp b">5601</code>。像所有其他ELK堆栈相关资源一样，Logstash部署在日志网络内部。这允许容器通过使用服务名相互通信。</p><p id="6f50" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">现在我们可以测试我们的设置。已经使用Docker-compose启动了一个Apache (httpd)容器。Docker Desktop for Mac的用户应编辑<code class="fe lz ma mb lp b">docker-compose.yml</code>至<code class="fe lz ma mb lp b">udp://host.docker.internal:12201</code>中的gelf地址。查看<a class="ae ks" href="https://github.com/lvthillo/docker-elk/issues/1" rel="noopener ugc nofollow" target="_blank">此处的</a>了解更多信息。不要忘记通过再次运行<code class="fe lz ma mb lp b">docker-compose up -d</code>来更新您的环境。</p><p id="4d93" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">我们将使用Docker CLI启动一个额外的Nginx容器。</p><p id="da5c" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">Docker Desktop for Mac的用户应该将gelf-address更新为<code class="fe lz ma mb lp b">udp://host.docker.internal:12201</code>。查看<a class="ae ks" href="https://github.com/lvthillo/docker-elk/issues/1" rel="noopener ugc nofollow" target="_blank">此处</a>了解更多信息。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="d917" class="lt lu it lp b gy lv lw l lx ly">$ docker run -d -p 8080:80 --log-driver gelf --log-opt gelf-address=udp://localhost:12201 nginx:latest</span></pre><p id="fb04" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">让我们在浏览器中访问这两个应用程序。</p><figure class="lk ll lm ln gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi mg"><img src="../Images/4ddea97d4135823f045b9f22534d2e95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WLZct5TPmOMtfw3KctEtaA.png"/></div></div></figure><p id="fb5d" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">现在在http://localhost:5601 上访问Kibana。单击左侧的“发现”和“创建索引模式”。使用“<code class="fe lz ma mb lp b">*</code>”和“<code class="fe lz ma mb lp b">@timestamp</code>”创建图案。</p><figure class="lk ll lm ln gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi mn"><img src="../Images/2ddc88c048abaf09745324e161d786c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9UD9zJp-nDkSC6i_lBF2rg.png"/></div></div></figure><p id="f9c2" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">现在，单击发现并验证日志。</p><figure class="lk ll lm ln gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi mo"><img src="../Images/7158d30cd40b4002af1c75084657ac19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Npah0HxeOkRf2fpfaEmtrQ.png"/></div></div></figure><p id="f363" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">我们有Nginx和Apache容器的日志！</p><figure class="lk ll lm ln gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi mp"><img src="../Images/9aacea7ed8fbbb6f0b08603d77df8cb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VaJ2ta_s0InDIgVRmO_fxQ.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">Nginx</figcaption></figure><figure class="lk ll lm ln gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi mu"><img src="../Images/1db1b36caf3a9c5b8c810f6e1cc8c570.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hbM8J7GCi9qdjlCbKwaE9w.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">阿帕奇(httpd)</figcaption></figure><h1 id="f1a1" class="mv lu it bd mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr bi translated">结论</h1><p id="e991" class="pw-post-body-paragraph jt ju it jw b jx ns jz ka kb nt kd ke kt nu kh ki ku nv kl km kv nw kp kq kr im bi translated">在这篇博客中，我向您展示了在Docker中部署一个基本的ELK堆栈来监控其他Docker容器是多么容易。这里的重点是ELK堆栈的设置，而不是管道或附加的Logstash和Elasticsearch配置。</p><p id="dffe" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">我希望你喜欢它！如果你有任何问题，请随时提问！</p><figure class="lk ll lm ln gt mc gh gi paragraph-image"><a href="https://www.buymeacoffee.com/dZb8fLN"><div class="gh gi nx"><img src="../Images/83dc7212ef8502659c81086ad58b8d96.png" data-original-src="https://miro.medium.com/v2/resize:fit:340/format:webp/1*bk_C8Um34KavCkO2yzMCZg.png"/></div></a><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">如果真的对你有帮助…:)</figcaption></figure></div></div>    
</body>
</html>