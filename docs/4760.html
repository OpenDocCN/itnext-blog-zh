<html>
<head>
<title>Getting Code Coverage through integration Tests in Node</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过节点中的集成测试获得代码覆盖率</h1>
<blockquote>原文：<a href="https://itnext.io/getting-code-coverage-through-integration-tests-in-node-342392300b3a?source=collection_archive---------1-----------------------#2020-09-10">https://itnext.io/getting-code-coverage-through-integration-tests-in-node-342392300b3a?source=collection_archive---------1-----------------------#2020-09-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="0920" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大约两年前，我开始了一个项目，由于时间限制，我必须快速开发。该项目本身从一个由文件数据库支持的CLI工具变成了一个具有API支持的后端但仍然是文件数据库的web应用程序。在某个时候，我决定将数据转移到持久存储中，这也是分两步进行的，首先是mlab上的MongoDB，然后转移到MongoDB Atlas。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/0406f2d551aac87ca42fc07c3c6f113a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QRMPny9g9mP9ADSvaYzung.jpeg"/></div></div></figure><p id="834c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我知道我将很快面临技术债务——特别是在那些重写期间——但是只要我不确定这个项目是否有潜力公开发布，我就不能在编写测试上花费太多时间。</p><p id="1b2c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它现在在<a class="ae kx" href="https://www.qzmkr.com" rel="noopener ugc nofollow" target="_blank">qzmkr.com</a>直播，可以根据邀请为公众或封闭观众进行多项选择测试。</p><h2 id="c487" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">测试策略</h2><p id="0f5d" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">如前所述，我看到了npm的本杰明·科的<a class="ae kx" href="https://github.com/bcoe/c8" rel="noopener ugc nofollow" target="_blank"> c8 </a>工具。他的工具使得利用设置NODE_V8_COVERAGE路径和直接从V8输出代码覆盖信息以及添加伊斯坦布尔报告器支持成为可能。无需特殊的伊斯坦布尔/纽约或其他覆盖工具，就可以针对您的节点服务运行一个测试套件，并获得详细的覆盖数据。<br/>我已经维护了一个postman集合来测试我的ReSTful API，它也可以通过<a class="ae kx" href="https://npmjs.com/package/newman" rel="noopener ugc nofollow" target="_blank"> newman </a>从cli用作测试场景。<br/>最后剩下的部分是用c8启动服务器，一旦启动，运行testsuite并再次关闭服务器，返回testsuite的退出代码，以便能够在CI中运行它。</p><h2 id="ce4e" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated"><strong class="ak">重要！</strong></h2><p id="b47f" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">为了使对环境变量NODE_V8_COVERAGE的支持生效，它至少需要节点10.12</p><p id="5607" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">值得一提的是，nodejs服务需要正常关闭，这样V8就可以完成覆盖报告的编写，而不会突然退出流程。</p><p id="31ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为此，我开始监听进程上的SIGINT和SIGTERM，断开数据库连接，然后优雅地停止服务器。</p><h1 id="6811" class="lw kz iq bd la lx ly lz ld ma mb mc lg md me mf lj mg mh mi lm mj mk ml lp mm bi translated">操作方法</h1><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="0dad" class="ky kz iq mo b gy ms mt l mu mv">npm install --save-dev newman c8<br/><br/># run your service (change your js accordingly)<br/>c8 node server.js<br/><br/># run your tests with newman<br/>newman -e postman-environment.json run testsuite.postman-collection.json</span></pre><h1 id="b6f6" class="lw kz iq bd la lx ly lz ld ma mb mc lg md me mf lj mg mh mi lm mj mk ml lp mm bi translated">结果</h1><p id="f80e" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">现在，我能够保持一定程度的稳定性，因为我让我的postman集合保持最新，并在CI中运行我的集成测试套件。对于复杂的算法和逻辑，我仍然保留我的单元测试。但是对于大多数与API相关的代码，我不必再去模仿这个世界，仍然可以得到有用的覆盖率输出，从而获得信心。</p><h1 id="f950" class="lw kz iq bd la lx ly lz ld ma mb mc lg md me mf lj mg mh mi lm mj mk ml lp mm bi translated">密码</h1><p id="8e82" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">示例代码可以在<a class="ae kx" href="https://github.com/chrkaatz/coverage-test" rel="noopener ugc nofollow" target="_blank"> github </a>上找到</p><h1 id="6d37" class="lw kz iq bd la lx ly lz ld ma mb mc lg md me mf lj mg mh mi lm mj mk ml lp mm bi translated">链接</h1><p id="aeb2" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated"><a class="ae kx" href="https://blog.npmjs.org/post/178487845610/rethinking-javascript-test-coverage" rel="noopener ugc nofollow" target="_blank">Benjamin Coe的初始帖子</a></p></div></div>    
</body>
</html>