<html>
<head>
<title>Validating HelmReleases in CI using hrval</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用hrval验证CI中的HelmReleases</h1>
<blockquote>原文：<a href="https://itnext.io/validating-helmreleases-in-ci-using-hrval-7a785b1c1b21?source=collection_archive---------1-----------------------#2020-04-17">https://itnext.io/validating-helmreleases-in-ci-using-hrval-7a785b1c1b21?source=collection_archive---------1-----------------------#2020-04-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/b6737996d8705a12346c4324a4c49d12.png" data-original-src="https://miro.medium.com/v2/resize:fit:932/format:webp/1*-kcMqf3faMoGMMNSJLPecg.png"/></div></figure><h1 id="0dd3" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">问题陈述</h1><p id="d7ef" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">这项工作的问题陈述如下:</p><p id="9592" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">作为一名工程师，我希望在我的头盔被部署之前对它们有信心。<br/> <strong class="ku ir">这样</strong>部署在Kubernetes更有可能成功而不是失败。</p><h1 id="e77d" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">当前的问题</h1><p id="178f" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">如前所述，在Mettle，我们在将工作负载部署到Kubernetes集群时严格遵循GitOps原则。然而，在过去，我们已经被部署无效的<code class="fe lv lw lx ly b">HelmRelease</code>清单所困扰，导致<code class="fe lv lw lx ly b">tiller</code>吞下错误而没有浮出水面。</p><p id="10ea" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">迁移到Helm 3使得这些错误在描述HelmRelease本身时出现(见下文)</p><pre class="lz ma mb mc gt md ly me mf aw mg bi"><span id="7b94" class="mh jv iq ly b gy mi mj l mk ml">Status:<br/>  Conditions:<br/>    Last Transition Time:  2020-04-15T16:40:49Z<br/>    Last Update Time:      2020-04-15T16:40:49Z<br/>    Message:               Chart fetch failed for Helm release 'redacted' in 'redacted'.<br/>    Reason:                ChartFetchFailed<br/>    Status:                False<br/>    Type:                  ChartFetched<br/>  Observed Generation:     1<br/>  Phase:                   ChartFetchFailed<br/>Events:<br/>  Type     Reason             Age   From           Message<br/>  ----     ------             ----  ----           -------<br/>  Warning  FailedReleaseSync  58s   helm-operator  synchronization of release 'redacted in namespace 'redacted' failed: failed to prepare chart for release: chart unavailable: chart "redacted" version "2.0.34" not found in <a class="ae mm" href="https://redacted-charts.storage.googleapis.com" rel="noopener ugc nofollow" target="_blank">https://redacted-charts.storage.googleapis.com</a> repository</span></pre><h1 id="f16e" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">理想的解决方案</h1><p id="c02d" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">理想的解决方案是在将HelmRelease部署到一个或多个集群之前，尽可能彻底地测试HelmRelease的所有组件。这些组件包括:</p><ul class=""><li id="9136" class="mn mo iq ku b kv lq kz lr ld mp lh mq ll mr lp ms mt mu mv bi translated">舵图本身(带有默认值)</li><li id="a19b" class="mn mo iq ku b kv mw kz mx ld my lh mz ll na lp ms mt mu mv bi translated">具有来自舵释放值的舵图表也适用</li></ul><h1 id="5908" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">舵图测试</h1><p id="5b1b" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我们的自定义舵图表已经有严格的林挺运行对他们作为CI的一部分。我们使用以下工具:</p><ul class=""><li id="0f94" class="mn mo iq ku b kv lq kz lr ld mp lh mq ll mr lp ms mt mu mv bi translated"><a class="ae mm" href="https://github.com/helm/chart-testing" rel="noopener ugc nofollow" target="_blank">https://github.com/helm/chart-testing</a></li><li id="8968" class="mn mo iq ku b kv mw kz mx ld my lh mz ll na lp ms mt mu mv bi translated"><a class="ae mm" href="https://github.com/instrumenta/kubeval" rel="noopener ugc nofollow" target="_blank">https://github.com/instrumenta/kubeval</a></li></ul><h2 id="a598" class="mh jv iq bd jw nb nc dn ka nd ne dp ke ld nf ng ki lh nh ni km ll nj nk kq nl bi translated">舵/制图-测试</h2><p id="201c" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我们在林挺的第一份工作是将我们的舵轮图与上游的舵轮图测试码头集装箱进行对比。该工具执行以下操作:</p><blockquote class="nm nn no"><p id="1aa5" class="ks kt np ku b kv lq kx ky kz lr lb lc nq ls lf lg nr lt lj lk ns lu ln lo lp ij bi translated"><code class="fe lv lw lx ly b">ct</code>是测试舵图的工具。它旨在用于林挺和测试拉请求。它会自动检测针对目标分支更改的图表。</p></blockquote><p id="f3ad" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">请参见下面的CircleCI配置:</p><pre class="lz ma mb mc gt md ly me mf aw mg bi"><span id="8f15" class="mh jv iq ly b gy mi mj l mk ml">lint:<br/>    docker:<br/>      - image: quay.io/helmpack/chart-testing:v3.0.0-rc.1<br/>    steps:<br/>      - checkout<br/>      - run:<br/>          name: lint<br/>          command: ct lint --all --config test/ct.yaml</span></pre><h2 id="4dc6" class="mh jv iq bd jw nb nc dn ka nd ne dp ke ld nf ng ki lh nh ni km ll nj nk kq nl bi translated">库贝瓦尔</h2><p id="e8bf" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我们对所有掌舵图运行<code class="fe lv lw lx ly b">kubeval</code>，通过循环每个掌舵图，运行<code class="fe lv lw lx ly b">helm template</code>，然后对输出执行严格的<code class="fe lv lw lx ly b">kubeval</code>林挺(见下文):</p><pre class="lz ma mb mc gt md ly me mf aw mg bi"><span id="8d5c" class="mh jv iq ly b gy mi mj l mk ml">#! /usr/bin/env bash<br/><br/>set -euo pipefail<br/><br/>mkdir -p /tmp/mettle<br/><br/>for chart in mettle/*; do<br/><br/>  printf "\nChecking %s\n" "${chart#*/}"<br/><br/>  helm template ${chart}  &gt; /tmp/${chart}.yaml<br/><br/>  export KUBEVAL_SCHEMA_LOCATION=file:///usr/local/kubeval/schemas<br/><br/>  kubeval --kubernetes-version 1.17.0 --strict --force-color --ignore-missing-schemas /tmp/${chart}.yaml<br/><br/>done</span></pre><p id="b1fb" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">因此，我们已经使用上游的<code class="fe lv lw lx ly b">helm/chart-testing</code>容器和<code class="fe lv lw lx ly b">kubeval</code>本身对我们的自定义舵图进行了linted和静态分析，但是没有任何东西可以将我们的HelmRelease值与我们的默认值混合，这将是圣杯！</p><h1 id="9116" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">拼图中缺失的部分</h1><p id="e865" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在网上做了一些挖掘之后，我的好朋友斯特凡·普罗丹已经创造了<code class="fe lv lw lx ly b">hrval</code>(【https://github.com/stefanprodan/hrval-action】)。</p><p id="f059" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">该操作通过以下方式工作:</p><ol class=""><li id="8aae" class="mn mo iq ku b kv lq kz lr ld mp lh mq ll mr lp nt mt mu mv bi translated">下载舵图。</li><li id="8c8e" class="mn mo iq ku b kv mw kz mx ld my lh mz ll na lp nt mt mu mv bi translated">使用默认值和给定HelmRelease中指定的值运行<code class="fe lv lw lx ly b">helm template</code>。</li><li id="8d79" class="mn mo iq ku b kv mw kz mx ld my lh mz ll na lp nt mt mu mv bi translated">对渲染输出运行严格的<code class="fe lv lw lx ly b">kubeval</code>。</li></ol><p id="e9b1" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">这听起来很完美，是我们理想解决方案中缺失的部分。</p><h1 id="fda3" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">添加到我们的工具包容器中</h1><p id="122b" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在Mettle，我们已经将CircleCI用于我们所有的Kubernetes林挺和静态分析，因此我们使用Stefan的docker文件作为参考，将他的脚本移植到我们的<a class="ae mm" href="https://quay.io/repository/mettle/kubernetes-toolkit." rel="noopener ugc nofollow" target="_blank">工具包</a>容器中。我们的docker文件现在包括以下附加部分:</p><pre class="lz ma mb mc gt md ly me mf aw mg bi"><span id="a3f6" class="mh jv iq ly b gy mi mj l mk ml"># Install hrval scripts<br/>COPY src/hrval.sh /usr/local/bin/hrval.sh<br/>COPY src/hrval-all.sh /usr/local/bin/hrval<br/>RUN chmod +x /usr/local/bin/hrval.sh<br/>RUN chmod +x /usr/local/bin/hrval</span></pre><h1 id="cfe7" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">将它连接到我们的CI管道</h1><p id="21a9" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">如果你读过我以前的博客文章，你会知道在Mettle我们大量利用<code class="fe lv lw lx ly b"><a class="ae mm" href="https://github.com/kubernetes-sigs/kustomize" rel="noopener ugc nofollow" target="_blank">Kustomize</a></code>来尽量保持我们的仓库干燥(不要重复你自己)。</p><p id="cc18" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">因此，我们编写了一个bash脚本，它将针对给定环境的<code class="fe lv lw lx ly b">kustomize build</code>的输出运行<code class="fe lv lw lx ly b">hrval</code>(见下文)。</p><pre class="lz ma mb mc gt md ly me mf aw mg bi"><span id="51ef" class="mh jv iq ly b gy mi mj l mk ml">#! /usr/bin/env bash</span><span id="dd36" class="mh jv iq ly b gy nu mj l mk ml">ENV=$1<br/>IGNORE_VALUES=false<br/>KUBE_VERSION=1.17.0<br/>HELM_VERSION=v2</span><span id="4c22" class="mh jv iq ly b gy nu mj l mk ml">set -eu</span><span id="f4ce" class="mh jv iq ly b gy nu mj l mk ml">printf "Running hrval against all %s HelmReleases\n" "${ENV}"</span><span id="cc2c" class="mh jv iq ly b gy nu mj l mk ml">mkdir -p /tmp/"${ENV}"<br/>kustomize build kustomize/"${ENV}" -o /tmp/"${ENV}"<br/>hrval /tmp/"${ENV}"/ ${IGNORE_VALUES} ${KUBE_VERSION} ${HELM_VERSION}</span></pre><p id="9d16" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">然后在我们的CircleCI配置中，我们简单地在每个环境中运行这个脚本:</p><pre class="lz ma mb mc gt md ly me mf aw mg bi"><span id="d71e" class="mh jv iq ly b gy mi mj l mk ml">defaults: &amp;defaults<br/>  working_directory: ~/project<br/>  docker:<br/>    - image: quay.io/mettle/kubernetes-toolkit:1.17.2</span><span id="fbb8" class="mh jv iq ly b gy nu mj l mk ml">hrval-for-sbx:<br/>  &lt;&lt;: *defaults<br/>  steps:<br/>    - checkout<br/>    - run:<br/>        name: kubeval helmreleases for sbx<br/>        command: bash -c "bin/hrval-for-environment sbx"</span></pre><p id="4a95" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">注意:我们对我们的定制舵图和上游舵图运行<code class="fe lv lw lx ly b">hrval</code>,以确保我们的<code class="fe lv lw lx ly b">HelmRelease</code>清单尽可能符合要求。</p><h1 id="4140" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">摘要</h1><p id="77e4" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">将<code class="fe lv lw lx ly b">hrval</code>添加到我们的工具包和CI渠道中，从<code class="fe lv lw lx ly b">kubeval</code>的角度来看，可能为我们提供了最完整的CI工作流程，它符合我们理想工作流程的所有要点。设置完成后，它已经发现了两个问题:</p><ol class=""><li id="20a6" class="mn mo iq ku b kv lq kz lr ld mp lh mq ll mr lp nt mt mu mv bi translated">我们引用了一个不存在的舵图版本。</li><li id="b0eb" class="mn mo iq ku b kv mw kz mx ld my lh mz ll na lp nt mt mu mv bi translated">我们在<code class="fe lv lw lx ly b">HelmRelease</code>中传递了无效的值</li></ol><p id="dd48" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">我们希望这能让我们在未来避免类似的问题。🤞</p><p id="d7aa" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">**作为参考，<code class="fe lv lw lx ly b">hrval</code>大约需要60到90秒的时间来识别每个环境中最多100个<code class="fe lv lw lx ly b">HelmRelease</code>清单。</p></div></div>    
</body>
</html>