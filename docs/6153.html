<html>
<head>
<title>Build a scalable front-end with Rush monorepo and React — Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Rush monorepo和React构建可扩展的前端—第2部分</h1>
<blockquote>原文：<a href="https://itnext.io/build-a-scalable-front-end-with-rush-monorepo-and-react-part-2-d7f1c19c1797?source=collection_archive---------2-----------------------#2021-09-03">https://itnext.io/build-a-scalable-front-end-with-rush-monorepo-and-react-part-2-d7f1c19c1797?source=collection_archive---------2-----------------------#2021-09-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="1bb2" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">Webpack + Jest</h1><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/89a248ffe0ec5a346b3fb966902b87be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3d4-KghKBezzZm2j.jpg"/></div></div></figure></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="eed0" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">这是博客系列“用Rush monorepo和React构建可伸缩前端”的第二部分</p><ul class=""><li id="2e21" class="mc md iq lg b lh li ll lm lp me lt mf lx mg mb mh mi mj mk bi translated"><a class="ae ml" href="https://medium.com/@alexandrubereghici/build-a-scalable-front-end-with-rush-monorepo-and-react-part-1-dd50ae38ad3e" rel="noopener">第1部分</a> : Monorepo设置，导入保留git历史的项目，<br/>添加更漂亮的</li><li id="3db7" class="mc md iq lg b lh mm ll mn lp mo lt mp lx mq mb mh mi mj mk bi translated">第2部分:用Webpack和react-scripts创建构建工具包</li><li id="75ea" class="mc md iq lg b lh mm ll mn lp mo lt mp lx mq mb mh mi mj mk bi translated"><a class="ae ml" href="https://medium.com/@alexandrubereghici/build-a-scalable-front-end-with-rush-monorepo-and-react-part-3-b90430f15af7" rel="noopener">第3部分</a>:添加共享ESLint配置，并与lint-staged一起使用</li><li id="a8be" class="mc md iq lg b lh mm ll mn lp mo lt mp lx mq mb mh mi mj mk bi translated"><a class="ae ml" href="https://medium.com/@alexandrubereghici/build-a-scalable-front-end-with-rush-monorepo-and-react-part-4-d0939bfb8b8a" rel="noopener">第4部分</a>:用Github动作和Netlify设置部署工作流。</li><li id="9b34" class="mc md iq lg b lh mm ll mn lp mo lt mp lx mq mb mh mi mj mk bi translated"><a class="ae ml" href="https://medium.com/@alexandrubereghici/build-a-scalable-front-end-with-rush-monorepo-and-react-part-5-355f5391fd27" rel="noopener">第5部分</a>:增加VSCode配置，获得更好的开发体验。</li></ul></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="812b" class="jn jo iq bd jp jq mr js jt ju ms jw jx jy mt ka kb kc mu ke kf kg mv ki kj kk bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="616a" class="pw-post-body-paragraph le lf iq lg b lh mw lj lk ll mx ln lo lp my lr ls lt mz lv lw lx na lz ma mb ij bi translated">如果你有兴趣只是看看代码，你可以在这里找到它:<a class="ae ml" href="https://github.com/abereghici/rush-monorepo-boilerplate" rel="noopener ugc nofollow" target="_blank">https://github.com/abereghici/rush-monorepo-boilerplate</a></p><p id="4c14" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">如果你想看看Rush在一个真实的大型项目中的应用，你可以看看Bentley Systems开发的开源项目<a class="ae ml" href="https://github.com/imodeljs/imodeljs" rel="noopener ugc nofollow" target="_blank"> ITwin.js </a>。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="6bb5" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated"><a class="ae ml" href="https://create-react-app.dev/" rel="noopener ugc nofollow" target="_blank"> create-react-app </a>是一个伟大的工具，它允许你开发react应用程序，而不必手动配置构建工具。当您开发小型项目时，管理您自己的构建工具可能有些多余，CRA已经足够了，但是当您开始构建大型项目时，您可能会发现缺少CRA配置。CRA是一个固执己见的预配置工具，所以总会有一些你不满意的设置，你不能改变它们。</p><p id="f462" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">在这篇文章中，我们将基于<a class="ae ml" href="https://create-react-app.dev/" rel="noopener ugc nofollow" target="_blank"> create-react-app </a>创建我们自己的构建工具。这将使我们能够完全控制构建过程。</p><h2 id="857d" class="nb jo iq bd jp nc nd dn jt ne nf dp jx lp ng nh kb lt ni nj kf lx nk nl kj nm bi translated">创建反应脚本包</h2><p id="ec1d" class="pw-post-body-paragraph le lf iq lg b lh mw lj lk ll mx ln lo lp my lr ls lt mz lv lw lx na lz ma mb ij bi translated">让我们为<code class="fe nn no np nq b">react-scripts</code>包创建一个新文件夹。</p><pre class="km kn ko kp gt nr nq ns nt aw nu bi"><span id="b88b" class="nb jo iq nq b gy nv nw l nx ny">mkdir -p packages/react-scripts</span></pre><p id="2d95" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">在<code class="fe nn no np nq b">react-scripts</code>文件夹中创建一个<code class="fe nn no np nq b">package.json</code>文件，并添加以下配置:</p><pre class="km kn ko kp gt nr nq ns nt aw nu bi"><span id="c24d" class="nb jo iq nq b gy nv nw l nx ny">{<br/>  "name": "@monorepo/react-scripts",<br/>  "version": "1.0.0",<br/>  "files": ["bin", "config", "lib", "scripts", "utils"],<br/>  "bin": {<br/>    "react-scripts": "./bin/react-scripts.js"<br/>  },<br/>  "types": "./lib/react-app.d.ts",<br/>  "dependencies": {<br/>    "@babel/core": "7.12.3",<br/>    "@pmmmwh/react-refresh-webpack-plugin": "0.4.3",<br/>    "@svgr/webpack": "5.5.0",<br/>    "@testing-library/jest-dom": "^5.14.1",<br/>    "@testing-library/react": "^11.2.7",<br/>    "@testing-library/user-event": "^12.8.3",<br/>    "@types/jest": "^26.0.24",<br/>    "@types/node": "^12.20.19",<br/>    "@types/react": "^17.0.18",<br/>    "@types/react-dom": "^17.0.9",<br/>    "@typescript-eslint/eslint-plugin": "^4.5.0",<br/>    "@typescript-eslint/parser": "^4.5.0",<br/>    "babel-eslint": "^10.1.0",<br/>    "babel-jest": "^26.6.0",<br/>    "babel-loader": "8.1.0",<br/>    "babel-plugin-named-asset-import": "^0.3.7",<br/>    "babel-preset-react-app": "^10.0.0",<br/>    "bfj": "^7.0.2",<br/>    "camelcase": "^6.1.0",<br/>    "case-sensitive-paths-webpack-plugin": "2.3.0",<br/>    "css-loader": "4.3.0",<br/>    "dotenv": "8.2.0",<br/>    "dotenv-expand": "5.1.0",<br/>    "file-loader": "6.1.1",<br/>    "fs-extra": "^9.0.1",<br/>    "html-webpack-plugin": "4.5.0",<br/>    "identity-obj-proxy": "3.0.0",<br/>    "jest": "26.6.0",<br/>    "jest-circus": "26.6.0",<br/>    "jest-resolve": "26.6.0",<br/>    "jest-watch-typeahead": "0.6.1",<br/>    "mini-css-extract-plugin": "0.11.3",<br/>    "optimize-css-assets-webpack-plugin": "5.0.4",<br/>    "pnp-webpack-plugin": "1.6.4",<br/>    "postcss-flexbugs-fixes": "4.2.1",<br/>    "postcss-loader": "3.0.0",<br/>    "postcss-normalize": "8.0.1",<br/>    "postcss-preset-env": "6.7.0",<br/>    "postcss-safe-parser": "5.0.2",<br/>    "prompts": "2.4.0",<br/>    "react-app-polyfill": "^2.0.0",<br/>    "react-dev-utils": "^11.0.3",<br/>    "react-refresh": "^0.8.3",<br/>    "resolve": "1.18.1",<br/>    "resolve-url-loader": "^3.1.2",<br/>    "sass-loader": "^10.0.5",<br/>    "semver": "7.3.2",<br/>    "style-loader": "1.3.0",<br/>    "terser-webpack-plugin": "4.2.3",<br/>    "ts-pnp": "1.2.0",<br/>    "url-loader": "4.1.1",<br/>    "web-vitals": "^1.1.2",<br/>    "webpack": "4.44.2",<br/>    "webpack-dev-server": "3.11.1",<br/>    "webpack-manifest-plugin": "2.2.0",<br/>    "workbox-webpack-plugin": "5.1.4"<br/>  },<br/>  "devDependencies": {<br/>    "react": "^17.0.1",<br/>    "react-dom": "^17.0.1"<br/>  }<br/>}</span></pre><p id="4b50" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">正如您已经注意到的，我们将所有构建依赖项从<code class="fe nn no np nq b">react-app</code>项目转移到了<code class="fe nn no np nq b">react-scripts</code>包中。</p><p id="6ee2" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">将<code class="fe nn no np nq b">config</code>和<code class="fe nn no np nq b">scripts</code>文件夹从<code class="fe nn no np nq b">react-app</code>移到<code class="fe nn no np nq b">react-scripts</code>，让我们调整配置。</p><p id="5fae" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">从<code class="fe nn no np nq b">packages/react-scripts/config/webpack.config.js</code>中移除<code class="fe nn no np nq b">ESLint</code>插件及其依赖项。稍后，我们将在构建过程中使用它作为一个单独的操作。</p><p id="2e85" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">打开<code class="fe nn no np nq b">packages/react-scripts/config/paths.js</code>，将文件内容替换为:</p><pre class="km kn ko kp gt nr nq ns nt aw nu bi"><span id="a5e5" class="nb jo iq nq b gy nv nw l nx ny">const path = require('path');<br/>const fs = require('fs');<br/>const getPublicUrlOrPath = require('react-dev-utils/getPublicUrlOrPath');<br/><br/><em class="nz">// Make sure any symlinks in the project folder are resolved:</em><br/><em class="nz">// https://github.com/facebook/create-react-app/issues/637</em><br/>const appDirectory = fs.realpathSync(process.cwd());<br/>const resolveApp = relativePath =&gt; path.resolve(appDirectory, relativePath);<br/><br/><em class="nz">// We use `PUBLIC_URL` environment variable or "homepage" field to infer</em><br/><em class="nz">// "public path" at which the app is served.</em><br/><em class="nz">// webpack needs to know it to put the right &lt;script&gt; hrefs into HTML even in</em><br/><em class="nz">// single-page apps that may serve index.html for nested URLs like /todos/42.</em><br/><em class="nz">// We can't use a relative path in HTML because we don't want to load something</em><br/><em class="nz">// like /todos/42/static/js/bundle.7289d.js. We have to know the root.</em><br/>const publicUrlOrPath = getPublicUrlOrPath(<br/>  process.env.NODE_ENV === 'development',<br/>  require(resolveApp('package.json')).homepage,<br/>  process.env.PUBLIC_URL<br/>);<br/><br/>const buildPath = process.env.BUILD_PATH || 'build';<br/><br/>const moduleFileExtensions = [<br/>  'web.mjs',<br/>  'mjs',<br/>  'web.js',<br/>  'js',<br/>  'web.ts',<br/>  'ts',<br/>  'web.tsx',<br/>  'tsx',<br/>  'json',<br/>  'web.jsx',<br/>  'jsx',<br/>];<br/><br/><em class="nz">// Resolve file paths in the same order as webpack</em><br/>const resolveModule = (resolveFn, filePath) =&gt; {<br/>  const extension = moduleFileExtensions.find(extension =&gt;<br/>    fs.existsSync(resolveFn(`${filePath}.${extension}`))<br/>  );<br/><br/>  if (extension) {<br/>    return resolveFn(`${filePath}.${extension}`);<br/>  }<br/><br/>  return resolveFn(`${filePath}.js`);<br/>};<br/><br/>const resolveOwn = relativePath =&gt; path.resolve(__dirname, '..', relativePath);<br/><br/>module.exports = {<br/>  dotenv: resolveApp('.env'),<br/>  appPath: resolveApp('.'),<br/>  appBuild: resolveApp(buildPath),<br/>  appPublic: resolveApp('public'),<br/>  appHtml: resolveApp('public/index.html'),<br/>  appIndexJs: resolveModule(resolveApp, 'src/index'),<br/>  appPackageJson: resolveApp('package.json'),<br/>  appSrc: resolveApp('src'),<br/>  appTsConfig: resolveApp('tsconfig.json'),<br/>  appJsConfig: resolveApp('jsconfig.json'),<br/>  yarnLockFile: resolveApp('yarn.lock'),<br/>  testsSetup: resolveModule(resolveApp, 'src/setupTests'),<br/>  proxySetup: resolveApp('src/setupProxy.js'),<br/>  appNodeModules: resolveApp('node_modules'),<br/>  appWebpackCache: resolveApp('node_modules/.cache'),<br/>  appTsBuildInfoFile: resolveApp('node_modules/.cache/tsconfig.tsbuildinfo'),<br/>  swSrc: resolveModule(resolveApp, 'src/service-worker'),<br/>  publicUrlOrPath,<br/>  <em class="nz">// These properties only exist before ejecting:</em><br/>  ownPath: resolveOwn('.'),<br/>  ownNodeModules: resolveOwn('node_modules'), <em class="nz">// This is empty on npm 3</em><br/>  appTypeDeclarations: resolveApp('src/react-app-env.d.ts'),<br/>  ownTypeDeclarations: resolveOwn('lib/react-app.d.ts'),<br/>};<br/><br/>module.exports.moduleFileExtensions = moduleFileExtensions;</span></pre><p id="bd68" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">这个文件中最重要的变化是<code class="fe nn no np nq b">resolveApp</code>函数调用。我们不应该再使用相对路径，因为我们正在将配置文件移动到<code class="fe nn no np nq b">react-scripts</code>包中。我们将使用<code class="fe nn no np nq b">path.resolve</code>和<code class="fe nn no np nq b">process.cwd()</code>的组合来获取项目文件路径。</p><p id="348b" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">创建一个<code class="fe nn no np nq b">bin</code>文件夹，并在<code class="fe nn no np nq b">react-scripts.js</code>文件中添加以下代码:</p><pre class="km kn ko kp gt nr nq ns nt aw nu bi"><span id="a84d" class="nb jo iq nq b gy nv nw l nx ny">process.on('unhandledRejection', err =&gt; {<br/>  throw err;<br/>});<br/><br/>const spawn = require('react-dev-utils/crossSpawn');<br/>const args = process.argv.slice(2);<br/><br/>const scriptIndex = args.findIndex(<br/>  x =&gt; x === 'build' || x === 'start' || x === 'test'<br/>);<br/>const script = scriptIndex === -1 ? args[0] : args[scriptIndex];<br/>const nodeArgs = scriptIndex &gt; 0 ? args.slice(0, scriptIndex) : [];<br/><br/>if (['build', 'start', 'test'].includes(script)) {<br/>  const result = spawn.sync(<br/>    process.execPath,<br/>    nodeArgs<br/>      .concat(require.resolve('../scripts/' + script))<br/>      .concat(args.slice(scriptIndex + 1)),<br/>    { stdio: 'inherit' }<br/>  );<br/>  if (result.signal) {<br/>    if (result.signal === 'SIGKILL') {<br/>      console.log(<br/>        'The build failed because the process exited too early. ' +<br/>          'This probably means the system ran out of memory or someone called ' +<br/>          '`kill -9` on the process.'<br/>      );<br/>    } else if (result.signal === 'SIGTERM') {<br/>      console.log(<br/>        'The build failed because the process exited too early. ' +<br/>          'Someone might have called `kill` or `killall`, or the system could ' +<br/>          'be shutting down.'<br/>      );<br/>    }<br/>    process.exit(1);<br/>  }<br/>  process.exit(result.status);<br/>} else {<br/>  console.log('Unknown script "' + script + '".');<br/>}</span></pre><p id="0a8a" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">这将是我们CLI的入口点。每次当你想添加一个新的命令时，你必须调整这个文件。</p><p id="bef0" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">创建另一个名为<code class="fe nn no np nq b">lib</code>的文件夹，并在<code class="fe nn no np nq b">react-app.d.ts</code>文件中添加以下代码:</p><pre class="km kn ko kp gt nr nq ns nt aw nu bi"><span id="fdd9" class="nb jo iq nq b gy nv nw l nx ny"><em class="nz">/// &lt;reference types="node" /&gt;</em><br/><em class="nz">/// &lt;reference types="react" /&gt;</em><br/><em class="nz">/// &lt;reference types="react-dom" /&gt;</em><br/><br/>declare namespace NodeJS {<br/>  interface ProcessEnv {<br/>    readonly NODE_ENV: 'development' | 'production' | 'test';<br/>    readonly PUBLIC_URL: string;<br/>  }<br/>}<br/><br/>declare module '*.avif' {<br/>  const src: string;<br/>  export default src;<br/>}<br/><br/>declare module '*.bmp' {<br/>  const src: string;<br/>  export default src;<br/>}<br/><br/>declare module '*.gif' {<br/>  const src: string;<br/>  export default src;<br/>}<br/><br/>declare module '*.jpg' {<br/>  const src: string;<br/>  export default src;<br/>}<br/><br/>declare module '*.jpeg' {<br/>  const src: string;<br/>  export default src;<br/>}<br/><br/>declare module '*.png' {<br/>  const src: string;<br/>  export default src;<br/>}<br/><br/>declare module '*.webp' {<br/>  const src: string;<br/>  export default src;<br/>}<br/><br/>declare module '*.svg' {<br/>  import * as React from 'react';<br/><br/>  export const ReactComponent: React.FunctionComponent&lt;<br/>    React.SVGProps&lt;SVGSVGElement&gt; &amp; { title?: string }<br/>  &gt;;<br/><br/>  const src: string;<br/>  export default src;<br/>}<br/><br/>declare module '*.module.css' {<br/>  const classes: { readonly [key: string]: string };<br/>  export default classes;<br/>}<br/><br/>declare module '*.module.scss' {<br/>  const classes: { readonly [key: string]: string };<br/>  export default classes;<br/>}<br/><br/>declare module '*.module.sass' {<br/>  const classes: { readonly [key: string]: string };<br/>  export default classes;<br/>}</span></pre><p id="07af" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">这里我们将存储CSS、SASS、SCSS和图像文件的所有类型定义。我们将在monorepo内部的所有react应用程序中重用它们。您可以通过在react项目中创建一个名为<code class="fe nn no np nq b">react-app-env.d.ts</code>的文件来处理这些类型定义，该文件包含以下内容:</p><pre class="km kn ko kp gt nr nq ns nt aw nu bi"><span id="7df1" class="nb jo iq nq b gy nv nw l nx ny"><em class="nz">/// &lt;reference types="@monorepo/react-scripts" /&gt;</em></span></pre><p id="ab0e" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">现在让我们在rush配置文件中注册<code class="fe nn no np nq b">@monorepo/react-scripts</code>包。打开<code class="fe nn no np nq b">rush.json</code>文件，在项目清单下添加一个条目，如下所示:</p><pre class="km kn ko kp gt nr nq ns nt aw nu bi"><span id="74d0" class="nb jo iq nq b gy nv nw l nx ny">. . .<br/> "projects": [<br/>    {<br/>      "packageName": "@monorepo/react-scripts",<br/>      "projectFolder": "packages/react-scripts",<br/>      "reviewCategory": "tools"<br/>    }<br/>  ]<br/>. . .</span></pre><p id="fe66" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">现在，让我们通过删除所有与构建工具相关的依赖项来清理<code class="fe nn no np nq b">apps/react-app/package-json</code>文件。我们还将删除<code class="fe nn no np nq b">eslint</code>、<code class="fe nn no np nq b">babel</code>或<code class="fe nn no np nq b">jest</code>的配置，因为我们会将它们存储在一个单独的文件中。在我们的依赖项中，我们将列出<code class="fe nn no np nq b">@monorepo/react-scripts</code>包。</p><p id="2ed2" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">编辑<code class="fe nn no np nq b">apps/react-app/package.json</code>文件并添加以下配置:</p><pre class="km kn ko kp gt nr nq ns nt aw nu bi"><span id="f2a4" class="nb jo iq nq b gy nv nw l nx ny">{<br/>  "name": "@monorepo/react-app",<br/>  "version": "0.1.0",<br/>  "private": true,<br/>  "dependencies": {<br/>    "@testing-library/jest-dom": "^5.14.1",<br/>    "@testing-library/react": "^11.2.7",<br/>    "@testing-library/user-event": "^12.8.3",<br/>    "@types/jest": "^26.0.24",<br/>    "@types/react": "^17.0.18",<br/>    "@types/react-dom": "^17.0.9",<br/>    "react": "^17.0.2",<br/>    "react-dom": "^17.0.2",<br/>    "typescript": "^4.3.5",<br/>    "web-vitals": "^1.1.2",<br/>    "@monorepo/react-scripts": "1.0.0"<br/>  },<br/>  "scripts": {<br/>    "start": "react-scripts start",<br/>    "build": "react-scripts build",<br/>    "test": "react-scripts test"<br/>  }<br/>}</span></pre><p id="4de0" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">运行<code class="fe nn no np nq b">rush update</code>来安装所有的依赖项，让我们试着用刚刚创建的<code class="fe nn no np nq b">react-script</code>包来构建我们的应用程序。</p><pre class="km kn ko kp gt nr nq ns nt aw nu bi"><span id="4e24" class="nb jo iq nq b gy nv nw l nx ny">cd apps/react-app </span><span id="2ec9" class="nb jo iq nq b gy oa nw l nx ny">rushx build</span></pre><h2 id="f6d9" class="nb jo iq bd jp nc nd dn jt ne nf dp jx lp ng nh kb lt ni nj kf lx nk nl kj nm bi translated">设置浏览器列表</h2><p id="9d21" class="pw-post-body-paragraph le lf iq lg b lh mw lj lk ll mx ln lo lp my lr ls lt mz lv lw lx na lz ma mb ij bi translated">默认情况下，<code class="fe nn no np nq b">react-scripts</code>期望在每个项目中找到一个<code class="fe nn no np nq b">browserslist</code>配置，否则，它会退回到默认的<code class="fe nn no np nq b">browserslist</code>配置。如果您想对所有项目使用相同的配置，您可以修改<code class="fe nn no np nq b">packages/react-scripts/build.js</code>以使用来自<code class="fe nn no np nq b">package.json</code>和<code class="fe nn no np nq b">@monorepo/react-scripts</code>的<code class="fe nn no np nq b">browserslist</code>。</p><p id="4396" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">从<code class="fe nn no np nq b">@monorepo/react-scripts</code>打开<code class="fe nn no np nq b">package.json</code>，添加以下配置:</p><pre class="km kn ko kp gt nr nq ns nt aw nu bi"><span id="1429" class="nb jo iq nq b gy nv nw l nx ny">"browserslist": {<br/>    "production": [<br/>      "&gt;0.2%",<br/>      "not dead",<br/>      "not op_mini all"<br/>    ],<br/>    "development": [<br/>      "last 1 chrome version",<br/>      "last 1 firefox version",<br/>      "last 1 safari version"<br/>    ]<br/>  },</span></pre><p id="8c84" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">用以下命令修改来自<code class="fe nn no np nq b">packages/react-scripts/build.js</code>和<code class="fe nn no np nq b">packages/react-scripts/start.js</code>的<code class="fe nn no np nq b">checkBrowsers</code>函数调用:</p><pre class="km kn ko kp gt nr nq ns nt aw nu bi"><span id="cd74" class="nb jo iq nq b gy nv nw l nx ny">checkBrowsers(paths.ownPath, isInteractive)</span></pre><h2 id="605a" class="nb jo iq bd jp nc nd dn jt ne nf dp jx lp ng nh kb lt ni nj kf lx nk nl kj nm bi translated">设置笑话</h2><p id="33e4" class="pw-post-body-paragraph le lf iq lg b lh mw lj lk ll mx ln lo lp my lr ls lt mz lv lw lx na lz ma mb ij bi translated">我们当前的<code class="fe nn no np nq b">test</code>脚本期望在每个项目中找到一个<code class="fe nn no np nq b">jest</code>配置。我们将修改它以使用共享配置。</p><p id="7424" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">在<code class="fe nn no np nq b">packages/react-scripts/scripts</code>中创建一个<code class="fe nn no np nq b">utils</code>文件夹，并在<code class="fe nn no np nq b">createJestConfig.js</code>文件中添加以下内容:</p><pre class="km kn ko kp gt nr nq ns nt aw nu bi"><span id="cd65" class="nb jo iq nq b gy nv nw l nx ny">const fs = require('fs');<br/>const chalk = require('react-dev-utils/chalk');<br/>const paths = require('../../config/paths');<br/>const modules = require('../../config/modules');<br/><br/>module.exports = (resolve, rootDir, isEjecting) =&gt; {<br/>  <em class="nz">// Use this instead of `paths.testsSetup` to avoid putting</em><br/>  <em class="nz">// an absolute filename into configuration after ejecting.</em><br/>  const setupTestsMatches = paths.testsSetup.match(/src[/\\]setupTests\.(.+)/);<br/>  const setupTestsFileExtension =<br/>    (setupTestsMatches &amp;&amp; setupTestsMatches[1]) || 'js';<br/>  const setupTestsFile = fs.existsSync(paths.testsSetup)<br/>    ? `&lt;rootDir&gt;/src/setupTests.${setupTestsFileExtension}`<br/>    : undefined;<br/><br/>  const config = {<br/>    roots: ['&lt;rootDir&gt;/src'],<br/><br/>    collectCoverageFrom: ['src/**/*.{js,jsx,ts,tsx}', '!src/**/*.d.ts'],<br/><br/>    setupFiles: [<br/>      isEjecting<br/>        ? 'react-app-polyfill/jsdom'<br/>        : require.resolve('react-app-polyfill/jsdom'),<br/>    ],<br/><br/>    setupFilesAfterEnv: setupTestsFile ? [setupTestsFile] : [],<br/>    testMatch: [<br/>      '&lt;rootDir&gt;/src/**/__tests__/**/*.{js,jsx,ts,tsx}',<br/>      '&lt;rootDir&gt;/src/**/*.{spec,test}.{js,jsx,ts,tsx}',<br/>    ],<br/>    testEnvironment: 'jsdom',<br/>    testRunner: require.resolve('jest-circus/runner'),<br/>    transform: {<br/>      '^.+\\.(js|jsx|mjs|cjs|ts|tsx)$': resolve(<br/>        'config/jest/babelTransform.js'<br/>      ),<br/>      '^.+\\.css$': resolve('config/jest/cssTransform.js'),<br/>      '^(?!.*\\.(js|jsx|mjs|cjs|ts|tsx|css|json)$)': resolve(<br/>        'config/jest/fileTransform.js'<br/>      ),<br/>    },<br/>    transformIgnorePatterns: [<br/>      '[/\\\\]node_modules[/\\\\].+\\.(js|jsx|mjs|cjs|ts|tsx)$',<br/>      '^.+\\.module\\.(css|sass|scss)$',<br/>    ],<br/>    modulePaths: modules.additionalModulePaths || [],<br/>    moduleNameMapper: {<br/>      '^react-native$': 'react-native-web',<br/>      '^.+\\.module\\.(css|sass|scss)$': 'identity-obj-proxy',<br/>      ...(modules.jestAliases || {}),<br/>    },<br/>    moduleFileExtensions: [...paths.moduleFileExtensions, 'node'].filter(<br/>      ext =&gt; !ext.includes('mjs')<br/>    ),<br/>    watchPlugins: [<br/>      'jest-watch-typeahead/filename',<br/>      'jest-watch-typeahead/testname',<br/>    ],<br/>    resetMocks: true,<br/>  };<br/>  if (rootDir) {<br/>    config.rootDir = rootDir;<br/>  }<br/>  const overrides = Object.assign({}, require(paths.appPackageJson).jest);<br/>  const supportedKeys = [<br/>    'clearMocks',<br/>    'collectCoverageFrom',<br/>    'coveragePathIgnorePatterns',<br/>    'coverageReporters',<br/>    'coverageThreshold',<br/>    'displayName',<br/>    'extraGlobals',<br/>    'globalSetup',<br/>    'globalTeardown',<br/>    'moduleNameMapper',<br/>    'resetMocks',<br/>    'resetModules',<br/>    'restoreMocks',<br/>    'snapshotSerializers',<br/>    'testMatch',<br/>    'transform',<br/>    'transformIgnorePatterns',<br/>    'watchPathIgnorePatterns',<br/>  ];<br/>  if (overrides) {<br/>    supportedKeys.forEach(key =&gt; {<br/>      if (Object.prototype.hasOwnProperty.call(overrides, key)) {<br/>        if (Array.isArray(config[key]) || typeof config[key] !== 'object') {<br/>          <em class="nz">// for arrays or primitive types, directly override the config key</em><br/>          config[key] = overrides[key];<br/>        } else {<br/>          <em class="nz">// for object types, extend gracefully</em><br/>          config[key] = Object.assign({}, config[key], overrides[key]);<br/>        }<br/><br/>        delete overrides[key];<br/>      }<br/>    });<br/>    const unsupportedKeys = Object.keys(overrides);<br/>    if (unsupportedKeys.length) {<br/>      const isOverridingSetupFile =<br/>        unsupportedKeys.indexOf('setupFilesAfterEnv') &gt; -1;<br/><br/>      if (isOverridingSetupFile) {<br/>        console.error(<br/>          chalk.red(<br/>            'We detected ' +<br/>              chalk.bold('setupFilesAfterEnv') +<br/>              ' in your package.json.\n\n' +<br/>              'Remove it from Jest configuration, and put the initialization code in ' +<br/>              chalk.bold('src/setupTests.js') +<br/>              '.\nThis file will be loaded automatically.\n'<br/>          )<br/>        );<br/>      } else {<br/>        console.error(<br/>          chalk.red(<br/>            '\nOut of the box, Create React App only supports overriding ' +<br/>              'these Jest options:\n\n' +<br/>              supportedKeys<br/>                .map(key =&gt; chalk.bold('  \u2022 ' + key))<br/>                .join('\n') +<br/>              '.\n\n' +<br/>              'These options in your package.json Jest configuration ' +<br/>              'are not currently supported by Create React App:\n\n' +<br/>              unsupportedKeys<br/>                .map(key =&gt; chalk.bold('  \u2022 ' + key))<br/>                .join('\n') +<br/>              '\n\nIf you wish to override other Jest options, you need to ' +<br/>              'eject from the default setup. You can do so by running ' +<br/>              chalk.bold('npm run eject') +<br/>              ' but remember that this is a one-way operation. ' +<br/>              'You may also file an issue with Create React App to discuss ' +<br/>              'supporting more options out of the box.\n'<br/>          )<br/>        );<br/>      }<br/><br/>      process.exit(1);<br/>    }<br/>  }<br/>  return config;<br/>};</span></pre><p id="75f2" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">现在让我们使用这个配置。修改<code class="fe nn no np nq b">packages/react-scripts/scripts/test.js</code>中的<code class="fe nn no np nq b">test</code>脚本，如下所示:</p><pre class="km kn ko kp gt nr nq ns nt aw nu bi"><span id="271b" class="nb jo iq nq b gy nv nw l nx ny"><em class="nz">// Do this as the first thing so that any code reading it knows the right env.</em><br/>process.env.BABEL_ENV = 'test';<br/>process.env.NODE_ENV = 'test';<br/>process.env.PUBLIC_URL = '';<br/><br/>process.on('unhandledRejection', err =&gt; {<br/>  throw err;<br/>});<br/><br/><em class="nz">// Ensure environment variables are read.</em><br/>require('../config/env');<br/><br/>const jest = require('jest');<br/>const execSync = require('child_process').execSync;<br/>let argv = process.argv.slice(2);<br/><br/>function isInGitRepository() {<br/>  try {<br/>    execSync('git rev-parse --is-inside-work-tree', { stdio: 'ignore' });<br/>    return true;<br/>  } catch (e) {<br/>    return false;<br/>  }<br/>}<br/><br/>function isInMercurialRepository() {<br/>  try {<br/>    execSync('hg --cwd . root', { stdio: 'ignore' });<br/>    return true;<br/>  } catch (e) {<br/>    return false;<br/>  }<br/>}<br/><br/><em class="nz">// Watch unless on CI or explicitly running all tests</em><br/>if (<br/>  !process.env.CI &amp;&amp;<br/>  argv.indexOf('--watchAll') === -1 &amp;&amp;<br/>  argv.indexOf('--watchAll=false') === -1<br/>) {<br/>  <em class="nz">// https://github.com/facebook/create-react-app/issues/5210</em><br/>  const hasSourceControl = isInGitRepository() || isInMercurialRepository();<br/>  argv.push(hasSourceControl ? '--watch' : '--watchAll');<br/>}<br/><br/>const createJestConfig = require('./utils/createJestConfig');<br/>const path = require('path');<br/>const paths = require('../config/paths');<br/>argv.push(<br/>  '--config',<br/>  JSON.stringify(<br/>    createJestConfig(<br/>      relativePath =&gt; path.resolve(__dirname, '..', relativePath),<br/>      path.resolve(paths.appSrc, '..'),<br/>      false<br/>    )<br/>  )<br/>);<br/><br/><em class="nz">// This is a very dirty workaround for https://github.com/facebook/jest/issues/5913.</em><br/><em class="nz">// We're trying to resolve the environment ourselves because Jest does it incorrectly.</em><br/><em class="nz">// TODO: remove this as soon as it's fixed in Jest.</em><br/>const resolve = require('resolve');<br/>function resolveJestDefaultEnvironment(name) {<br/>  const jestDir = path.dirname(<br/>    resolve.sync('jest', {<br/>      basedir: __dirname,<br/>    })<br/>  );<br/>  const jestCLIDir = path.dirname(<br/>    resolve.sync('jest-cli', {<br/>      basedir: jestDir,<br/>    })<br/>  );<br/>  const jestConfigDir = path.dirname(<br/>    resolve.sync('jest-config', {<br/>      basedir: jestCLIDir,<br/>    })<br/>  );<br/>  return resolve.sync(name, {<br/>    basedir: jestConfigDir,<br/>  });<br/>}<br/>let cleanArgv = [];<br/>let env = 'jsdom';<br/>let next;<br/>do {<br/>  next = argv.shift();<br/>  if (next === '--env') {<br/>    env = argv.shift();<br/>  } else if (next.indexOf('--env=') === 0) {<br/>    env = next.substring('--env='.length);<br/>  } else {<br/>    cleanArgv.push(next);<br/>  }<br/>} while (argv.length &gt; 0);<br/>argv = cleanArgv;<br/>let resolvedEnv;<br/>try {<br/>  resolvedEnv = resolveJestDefaultEnvironment(`jest-environment-${env}`);<br/>} catch (e) {<br/>  <em class="nz">// ignore</em><br/>}<br/>if (!resolvedEnv) {<br/>  try {<br/>    resolvedEnv = resolveJestDefaultEnvironment(env);<br/>  } catch (e) {<br/>    <em class="nz">// ignore</em><br/>  }<br/>}<br/>const testEnvironment = resolvedEnv || env;<br/>argv.push('--env', testEnvironment);<br/><br/>jest.run(argv);</span></pre><p id="6782" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">现在我们可以在<code class="fe nn no np nq b">react-app</code>项目中运行<code class="fe nn no np nq b">rushx test</code>并测试共享配置。</p><p id="cfbd" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">如果你在这个过程中遇到了任何问题，你可以在<a class="ae ml" href="https://github.com/abereghici/rush-monorepo-boilerplate/commit/de30f0a1bc1f3958e34bcccf7089d3439d153e2c" rel="noopener ugc nofollow" target="_blank">这个提交</a>中检查所有的修改。</p><p id="c02b" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">在下一部分的<a class="ae ml" href="https://medium.com/@alexandrubereghici/build-a-scalable-front-end-with-rush-monorepo-and-react-part-3-b90430f15af7" rel="noopener">中，我们将添加一个共享的ESLint配置，并将它与</a><a class="ae ml" href="https://github.com/okonet/lint-staged" rel="noopener ugc nofollow" target="_blank"> lint-staged </a>集成。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="d483" class="pw-post-body-paragraph le lf iq lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated"><em class="nz">原发布于</em><a class="ae ml" href="https://bereghici.dev/blog/build-a-scalable-front-end-with-rush-monorepo-and-react--webpack+jest" rel="noopener ugc nofollow" target="_blank"><em class="nz">https://bereghici . dev</em></a><em class="nz">。</em></p></div></div>    
</body>
</html>