<html>
<head>
<title>The definitive guide to running EC2 Spot Instances as Kubernetes worker nodes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">作为Kubernetes工作节点运行EC2 Spot实例的权威指南</h1>
<blockquote>原文：<a href="https://itnext.io/the-definitive-guide-to-running-ec2-spot-instances-as-kubernetes-worker-nodes-68ef2095e767?source=collection_archive---------0-----------------------#2019-05-20">https://itnext.io/the-definitive-guide-to-running-ec2-spot-instances-as-kubernetes-worker-nodes-68ef2095e767?source=collection_archive---------0-----------------------#2019-05-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="886c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">[Edit 2020 December 2020]虽然这篇博客文章仍然值得一读，其中有关于Kubernetes、自动伸缩和Spot实例的有趣背景和历史，但我强烈建议您研究一下在EKS管理的节点组中运行Spot实例——这是在re:Invent 2020期间推出的一项功能。你可以在AWS容器博客上阅读我的发布博文:</p><div class="kl km gp gr kn ko"><a href="https://aws.amazon.com/blogs/containers/amazon-eks-now-supports-provisioning-and-managing-ec2-spot-instances-in-managed-node-groups/" rel="noopener  ugc nofollow" target="_blank"><div class="kp ab fo"><div class="kq ab kr cl cj ks"><h2 class="bd ir gy z fp kt fr fs ku fu fw ip bi translated">Amazon EKS现在支持在托管节点组中提供和管理EC2 Spot实例</h2><div class="kv l"><h3 class="bd b gy z fp kt fr fs ku fu fw dk translated">本文由首席解决方案架构师Ran Sheinberg和高级产品经理Deepthi Chelupati撰写…</h3></div><div class="kw l"><p class="bd b dl z fp kt fr fs ku fu fw dk translated">aws.amazon.com</p></div></div><div class="kx l"><div class="ky l kz la lb kx lc ld ko"/></div></div></a></div><p id="a7e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇文章中，我将向您展示如何在EC2 Spot实例上运行Kubernetes (EKS或其他)worker节点，并节省高达90%的EC2随需应变价格，而不会影响应用程序的性能或可用性。要在Spot实例上运行健壮且有弹性的集群，您需要采取一些步骤，这篇文章是指导您完成这些步骤的权威(并且不断发展——就像Kubernetes一样)指南。我将描述您需要在集群中实现的不同最佳实践，以及实现这些最佳实践的工具和配置。读完这篇文章后，您将拥有开始使用Spot实例作为Kubernetes工作节点所需的所有信息。在我们开始之前，我叫Ran Sheinberg，是AWS的一名解决方案架构师。我专门研究Spot实例，并与数百名AWS客户讨论过如何在他们的特定工作负载中实施Spot实例，与他们一起规划POC，并帮助他们排查和解决生产工作负载中的问题。许多对话都围绕着基于Kubernetes的工作负载以及如何在现场运行它们。我在GitHub/Slack上就Kubernetes和Spot的主题与之交流的每个客户、AWS同事或人员都在不知不觉中对本指南做出了或大或小的贡献。</p></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><h1 id="a40d" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">现场实例——在几个段落中从零到英雄</h1><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/44fb56b24de67223edd536d03d5197fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:534/format:webp/1*QVb_emry1UHvTaGUFDJbXg.png"/></div></figure><p id="06bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你是现货实例的新手，或者如果你没有赶上2017年11月推出的定价模式(<a class="ae mq" href="https://aws.amazon.com/blogs/compute/new-amazon-ec2-spot-pricing/" rel="noopener ugc nofollow" target="_blank">无投标，无价格飙升</a>)的重大变化，你一定要阅读这一部分。如果你不熟悉EC2自动缩放组如何允许<a class="ae mq" href="https://aws.amazon.com/blogs/aws/new-ec2-auto-scaling-groups-with-multiple-instance-types-purchase-options/" rel="noopener ugc nofollow" target="_blank">从2018年11月开始混合购买选项和实例类型</a>，也是如此。</p><p id="0e7a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Spot实例是备用的EC2计算能力，与按需价格相比，您可以使用高达90%的折扣。与具有静态价格(除非AWS降低其价格)的按需和保留实例购买选项相反，Spot实例的价格可能会根据每个容量池(可用性区域中实例类型的组合)中的长期供应和需求，在非常小的间隔内一天只波动几次。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi mr"><img src="../Images/12ad08f855ad7eb7a1822b8526f64ead.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qbF79XrX6uBL5L7DQle5Rw.png"/></div></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">过去3个月的现货价格历史显示，美国东部(N. Virginia)的r4.xlarge在各供货区之间的价格差异非常小(小于约0.002美元)，并且现货价格实际上仅在过去3个月的某些供货区发生了变化</figcaption></figure><p id="fd17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你应该从这部分学到的一个绝对重要的最佳实践是灵活性和多样化。如果您正在运行无状态、容错、分布式工作负载(例如:ELB背后的web/应用服务器集群、消耗队列中的作业的批处理，或者容器实例/工作节点),并在特定的实例类型上按需使用(使用RI、节约计划，或者不使用任何一种),因为您已经验证了该实例或者刚刚开始成功地使用它，当您开始在应用程序中采用Spot时，您需要将使用分散到尽可能多的容量池(AZs中的实例类型)。原因很简单:通过使用多个容量池，您可以:(a)增加获得现货容量的机会，而不是试图从特定AZ中的单个实例类型获得现货容量，如果容量池中没有备用容量，就会失败。(b)如果EC2需要恢复容量以供按需使用，通常不会同时中断所有容量池，因此只有一小部分工作负载会被中断，仅由自动扩展组(或Spot Fleet，我们稍后会谈到)补充，从而避免对您的可用性造成任何影响，或者需要按需运行并支付更多费用。</p><p id="56ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如:如果我今天在c5.large上运行我的应用程序，我可能也可以在m5.large上运行它——在大多数情况下，如果操作系统只是看到更多的内存和稍慢的CPU时钟速度，应用程序就可以正常工作(除非我们谈论的是CPU敏感的工作负载或使用特定指令集的工作负载，如AVX-512)。类似地，您可以使用具有更多内存的r5.large，回到上一代，也可以使用c4.large / m4.large / r4.large。这个概念在Kubernetes调度程序中工作得很好，但在开始讨论Kuberentes中的自动缩放时需要一些调整——这个主题我们将在本文的后面深入探讨。</p><p id="bf9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还要看一下EC2自动扩展组支持的分配策略。为了遵循多样化最佳实践并将您的节点/单元分布在尽可能多的容量池中，客户通常使用的是最低价格分配策略，其数量等于或等于您选择的实例类型的n-1个数量。然而，<strong class="jp ir">建议采用2019年8月推出的容量优化分配策略</strong>。这种分配策略将选择最不可能被中断的点实例，因为它以最深的容量池为目标。点击此处，了解有关容量优化分配策略<a class="ae mq" href="https://aws.amazon.com/blogs/compute/introducing-the-capacity-optimized-allocation-strategy-for-amazon-ec2-spot-instances/" rel="noopener ugc nofollow" target="_blank">发布的更多信息。</a></p><p id="1a70" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么AWS如何使遵循这些实例类型灵活性最佳实践变得容易呢？输入EC2自动缩放组。</p><h1 id="e58f" class="ll lm iq bd ln lo na lq lr ls nb lu lv lw nc ly lz ma nd mc md me ne mg mh mi bi translated">EC2自动缩放组</h1><p id="1acf" class="pw-post-body-paragraph jn jo iq jp b jq nf js jt ju ng jw jx jy nh ka kb kc ni ke kf kg nj ki kj kk ij bi translated">如果您对您的Kubernetes集群的ASGs vs Spot Fleet或EC2 Fleet感到困惑，不要这样。这些工具或API有相似的特征，但是我会让它变得非常简单。如今，机群更适合有始有终的大规模作业，例如，我需要3000个vCPUs来处理我在S3上的视频或图像，或者运行夜间Hadoop/Spark作业，或者任何其他类型的批处理计算作业。虽然Spot Fleet确实具有与ASG非常相似的自动扩展能力，但ASG更适合于作为服务的一部分连续运行且不需要到达终点的工作负载。对于这些类型的工作负载，ASG的一些好处包括:生命周期挂钩(当有“扩展”活动时，它将允许您轻松地清空您的容器实例，我们将在稍后的帖子中谈到这一点)，保护实例免于扩展，将实例附加到ASG或从其分离，终止ELB ASG health check集成的特定实例，平衡每个可用性区域中的实例数量。此外，对于我们手头的主题来说最重要的是:社区驱动的工具与EC2 ASGs集成在一起——例如eksctl、Kubernetes cluster-autoscaler、Kops等。</p><p id="376d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是一个从AWS管理控制台创建EC2自动伸缩组的示例。注意，在使用eksctl或kops时，您实际上不必这样做，因为这些工具已经为您设置了ASG。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi nk"><img src="../Images/3229132e153654f3c440a66e0f3cb755.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LCL6X1JLptbVvaPoWDBa4A.png"/></div></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">在AWS控制台中创建新的EC2自动缩放组。我选择了7种具有相似vCPU和内存规格的实例类型，并将在3个可用性区域中运行该集群，总共有24个容量池，这样就增加了我获得所需的现场容量的机会，同时也增加了在EC2需要恢复容量时一些池中断的情况下保持所需容量的机会。现货分配策略是容量优化的。</figcaption></figure><p id="262b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后:我如何知道哪些实例最适合我的Spot使用？使用<a class="ae mq" href="https://aws.amazon.com/ec2/spot/instance-advisor/" rel="noopener ugc nofollow" target="_blank"> Spot Instance Advisor </a>工具检查您选择的区域中每个实例类型的历史中断率(最近30天)。我们的Kubernetes集群将被设置为通过捕捉现场2分钟中断警告和清空将要终止的工作节点来对现场中断进行完全容错，但关注中断率较低的实例类型仍然是一个好主意。</p><p id="3958" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">围绕多AZ自动缩放组的两个注意事项:</p><ul class=""><li id="1fd8" class="nl nm iq jp b jq jr ju jv jy nn kc no kg np kk nq nr ns nt bi translated">如果您将持久卷与EBS一起使用，那么您将需要在单个可用性分区中为该应用程序运行节点组/自动扩展组，因为EBS卷是分区的，您不希望您的pod被安排在EBS卷不存在的错误AZ上。如果您的用例允许使用跨多个az的Amazon弹性文件系统(EFS ),那么您可以忽略这个限制，在多个az中运行针对EFS挂载的pods，如果您使用Amazon FSx for Lustre，情况也是如此。</li><li id="073f" class="nl nm iq jp b jq nu ju nv jy nw kc nx kg ny kk nq nr ns nt bi translated">自动缩放组努力在它运行的所有AZs中保持相同数量的实例。当ASG试图减少AZ中的实例数量时，这可能会导致工作节点终止。如果您运行一个工具来自动排出ASG扩展活动中的实例(我们将在本文后面谈到)，那么您不应该担心这个问题。否则，您可以通过<a class="ae mq" href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/as-suspend-resume-processes.html#as-suspend-resume-aws-cli" rel="noopener ugc nofollow" target="_blank">暂停AZRebalance进程</a>来简单地禁用该功能，但是您可能会面临这样的风险，即您的容量会在AZs之间变得不平衡。请注意，cluster-autoscaler本身会选择要终止的实例，因此这个ASG扩展问题与cluster-autoscaler的操作无关，而只与AZRebalance进程有关。</li></ul><p id="9db5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于混合ASG的最后两个词:启动模板。如果要运行具有多个采购选项和例程类型的ASG，这些是必需的。从概念上讲，它们与启动配置相同，因为它们允许您配置AMI、存储、网络、用户数据和其他设置等内容，并使用模板启动实例、ASG、Spot Fleet或在AWS批处理中使用，将来还可能启动更多服务。启动模板也更高级，因为它们支持版本控制，但是我们不会深入研究LTs。<a class="ae mq" href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/LaunchTemplates.html" rel="noopener ugc nofollow" target="_blank">如果你想了解更多，请阅读文档</a>。</p><p id="2cfc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想获得在EC2自动伸缩组上运行无状态应用程序的实践经验(不一定是用Kubernetes)，看看<a class="ae mq" href="https://www.ec2spotworkshops.com" rel="noopener ugc nofollow" target="_blank">https://www.ec2spotworkshops.com</a></p><p id="510f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我强烈推荐Spot/Kubernetes deep dive workshop，它将帮助您实现本文中描述的最佳实践，并在此过程中获得更多的学习点<a class="ae mq" href="https://ec2spotworkshops.com/using_ec2_spot_instances_with_eks.html" rel="noopener ugc nofollow" target="_blank">https://EC 2 Spot workshop . com/using _ ec2 _ Spot _ instances _ with _ eks . html</a></p></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><h1 id="cebb" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">让我们开始:向Kubernetes集群添加Spot实例</h1><p id="01f7" class="pw-post-body-paragraph jn jo iq jp b jq nf js jt ju ng jw jx jy nh ka kb kc ni ke kf kg nj ki kj kk ij bi translated">在AWS中，节点组被广泛接受为EC2 ASG——这是eks CTL(EKS的官方CLI工具)和kops供应实例的方式，这是EKS文档建议使用CFn向您的EKS集群添加实例的方式，cluster-autoscaler也与它集成——因此，这一点，加上我在上一节中描述的ASG优势，使ASG成为运行和管理我们的工作节点的完美选择。</p><p id="d8ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">EKS(通过eksctl)和Kops是在AWS上启动和管理Kubernetes集群的常见且简单的方法。因此在这一节中，我将描述如何为这两个选项添加Spot实例作为worker节点。</p><h2 id="9c04" class="nz lm iq bd ln oa ob dn lr oc od dp lv jy oe of lz kc og oh md kg oi oj mh ok bi translated">使用eksctl向EKS集群添加Spot实例</h2><p id="d7f7" class="pw-post-body-paragraph jn jo iq jp b jq nf js jt ju ng jw jx jy nh ka kb kc ni ke kf kg nj ki kj kk ij bi translated">作为https://ec2spotworkshops.com站点的一部分，AWS有一个分步指南，这也适用于非EKS集群，但我在本节后面还会谈到kops选项。您可以在Spot模块下找到说明:<a class="ae mq" href="https://ec2spotworkshops.com/using_ec2_spot_instances_with_eks/spotworkers.html" rel="noopener ugc nofollow" target="_blank">https://EC 2 Spot workshop . com/using _ ec2 _ Spot _ instances _ with _ eks/Spot workers . html</a><br/>您可以通读模块了解完整的详细信息。</p><p id="f54d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您只是对使用EKS集群的Spot实例设置混合ASG感兴趣，那么您可以简单地使用eksctl和一个包含混合ASG所需参数的配置文件。</p><p id="ea1e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ol om on oo b">eksctl create nodegroup -f eksctl-mixed.yaml <br/></code>和我的配置文件，该文件类似于<a class="ae mq" href="https://ec2spotworkshops.com/using_ec2_spot_instances_with_eks/spotworkers/workers_eksctl.html" rel="noopener ugc nofollow" target="_blank">EKS/现场车间</a>中的示例:</p><blockquote class="op oq or"><p id="71c1" class="jn jo os jp b jq jr js jt ju jv jw jx ot jz ka kb ou kd ke kf ov kh ki kj kk ij bi translated"><em class="iq">API version:eksctl.io/v1alpha5<br/>kind:cluster config<br/>metadata:<br/>name:&lt;您现有的集群名称&gt; <br/> region: &lt; AWS您启动EKS集群的区域&gt;<br/>node groups:<br/>—name:spot-node-group-2v CPU-8gb<br/>minSize:3<br/>maxSize:5<br/>desired capacity:3<br/>instance distribution:<br/>instance types:[" M5 . " m4.large "、" m5a.large "、" m5ad.large "、" m5n.large "、" m5dn . large "]<br/>on demand base capacity:0<br/>on demand percentageaboverbase capacity:0<br/>spot allocationstrategy:" capacity-optimized "<br/>labels:<br/>life cycle:ec2 spot<br/>iam:<br/>withdonpolicies:<br/>auto scaler:true<br/>—name:spot-node-group-4v CPU-16gb【T2</em></p></blockquote><p id="1f97" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在这里做的是添加<strong class="jp ir">两个Spot节点组(ASG)，运行100% Spot，其中7个实例类型具有相同的vCPU:内存计数</strong>，因为这对于使用假定同构节点组的cluster-autoscaler非常重要。此外，Spot分配策略是“容量优化的”，因此每次ASG扩展时，都会从具有最多备用容量的Spot容量池中选择一个实例。为了进一步丰富我的用法，我可以添加更多其他大小的节点组，例如所有的*.2xl实例类型。<a class="ae mq" href="https://ec2spotworkshops.com/using_ec2_spot_instances_with_eks/spotworkers/workers_eksctl.html" rel="noopener ugc nofollow" target="_blank">EKS/现场车间模块</a>有更详细的例子。</p><p id="7358" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">几分钟后，eksctl将根据您的配置文件打开一个新的混合ASG，您将在您的EKS集群中运行新的Spot实例。</p><h2 id="8cf8" class="nz lm iq bd ln oa ob dn lr oc od dp lv jy oe of lz kc og oh md kg oi oj mh ok bi translated">使用Kops向Kubernetes集群添加Spot实例</h2><p id="666e" class="pw-post-body-paragraph jn jo iq jp b jq nf js jt ju ng jw jx jy nh ka kb kc ni ke kf kg nj ki kj kk ij bi translated">Kops还支持开箱即用地添加混合的ASG。所以一旦我运行了我的kops集群，我就运行<code class="fe ol om on oo b">kops edit ig --name=&lt;cluster-name&gt; nodes</code>并在MixedInstancePolicy下添加我的Spot实例类型，就像描述的<a class="ae mq" href="https://github.com/kubernetes/kops/blob/master/docs/instance_groups.md#creating-a-instance-group-of-mixed-instances-types-aws-only" rel="noopener ugc nofollow" target="_blank"> GitHub自述文件</a>一样，然后运行<code class="fe ol om on oo b">kops update</code>来应用它。</p><blockquote class="op oq or"><p id="2ba6" class="jn jo os jp b jq jr js jt ju jv jw jx ot jz ka kb ou kd ke kf ov kh ki kj kk ij bi translated">mixedinstanseconpolicy:<br/>实例:<br/>—M5 . large<br/>—M4 . large<br/>—m5a . large<br/>—m5d . large<br/>—m5ad . large<br/>—m5n . large<br/>—m5dn . large<br/>—T3 . large<br/>on demand above base:0<br/>spot allocationstrategy:容量优化</p></blockquote><p id="e1cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种配置意味着我的ASG中将有0个按需实例(ondemandabowebase:0)，ASG将从我在集群中每个已配置的可用性区域中指定的类型(spotInstancePools: 4)中选择四个最便宜的实例类型。我在这里设置4是为了在我的ASG中获得最大的多样性，因为这是我指定的实例类型的数量。</p></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><h1 id="bda9" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">自动缩放Spot worker节点</h1><p id="9ac0" class="pw-post-body-paragraph jn jo iq jp b jq nf js jt ju ng jw jx jy nh ka kb kc ni ke kf kg nj ki kj kk ij bi translated">[为了在Kubernetes集群中自动伸缩您的应用程序以响应可变负载，您可能会使用Horizontal Pod Autoscaler，但是我在这里不打算触及这个主题，因为它已经有了很好的证明。相反，这篇文章的重点只是在Spot实例上运行时扩展底层硬件(工作节点)。]</p><h2 id="deaa" class="nz lm iq bd ln oa ob dn lr oc od dp lv jy oe of lz kc og oh md kg oi oj mh ok bi translated">输入Kuberentes集群-自动缩放</h2><p id="e0da" class="pw-post-body-paragraph jn jo iq jp b jq nf js jt ju ng jw jx jy nh ka kb kc ni ke kf kg nj ki kj kk ij bi translated">Cluster-autoscaler是一个开源工具，发布在核心Kubernetes代码之外。您可以像任何部署一样在集群中安装和运行它，并将其指向您的ASG。当它看到由于群集中缺少可用资源(CPU/Mem)而处于“挂起”状态的单元时，它会向ASG发送一个API命令，根据它计算的安装挂起单元所需的实例数来增加组的所需容量。当集群中有空闲的工作节点时，它会减小ASG的大小。</p><p id="2a25" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你在阅读这篇文章之前已经研究过如何使用Spot和cluster-autoscaler (CA从这里开始)，那么你应该知道事情变得复杂了。官方上，CA只支持同构节点组——在我们的上下文中，这意味着它需要指向只运行相同实例类型的ASG(这就是ASG从2010年由AWS推出到2018年底推出新型混合ASG的工作方式)。这是官方文档所说的，并且在CA的GitHub repo中讨论的用户/贡献者也强烈认为不应该将CA与具有多个实例类型的ASG一起使用。</p><p id="67b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">CA不支持异构节点组的原因是它的决策算法(又名模拟)。它假设组中的所有节点都具有相同的硬件规格(CPU/Mem)，因此当它需要做出扩展决策时，它确切知道将向集群添加或从中删除多少CPU/Mem。</p><p id="1bf7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么解决办法是什么呢？您猜对了(或者刚刚阅读了关于创建混合ASG节点组的前一节)——只需使用不同EC2实例族和代中大小相似的实例类型。这将允许您遵循多样化的现场最佳实践，以实现和保持您想要的规模，并且不会对CA与ASG的合作方式产生任何影响。</p><h2 id="7f25" class="nz lm iq bd ln oa ob dn lr oc od dp lv jy oe of lz kc og oh md kg oi oj mh ok bi translated">使用混合ASG的集群自动缩放器</h2><p id="0965" class="pw-post-body-paragraph jn jo iq jp b jq nf js jt ju ng jw jx jy nh ka kb kc ni ke kf kg nj ki kj kk ij bi translated">我按照ec2spotworkshops.com上的<a class="ae mq" href="https://ec2spotworkshops.com/using_ec2_spot_instances_with_eks/scaling.html" rel="noopener ugc nofollow" target="_blank">自动缩放模块在我的EKS集群上设置CA，并将其指向我在上一步中创建的具有多个Spot实例类型的混合ASG。我在nodes参数中配置了我的混合ASG名称，还更改了image参数以使用最新版本(1.14.6适用于EKS 1.14)。</a></p><blockquote class="op oq or"><p id="534d" class="jn jo os jp b jq jr js jt ju jv jw jx ot jz ka kb ou kd ke kf ov kh ki kj kk ij bi translated">规格:<br/>集装箱:<br/> —指令:<br/> —。/cluster-auto scaler<br/>———v = 4<br/>———stderrthreshold = info<br/>———cloud-provider = AWS<br/>———skip-nodes-with-local-storage = false<br/>———nodes = 2:15:eks workshop-eks CTL 9-mixed-spot-NodeGroup-10 aydz 7 obguag<br/>—name:AWS _ REGION<br/>value:eu-west-1<br/>图片:k8s.gcr.io/cluster-autoscaler:v1.14.6</p></blockquote><p id="ce08" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我将我的部署扩展到20个副本:<br/><em class="os">kubectl scale—replicas = 20个部署/nginx-to-scaleout </em></p><p id="3b5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这导致群集中的一些单元由于群集中缺少CPU资源而保持挂起状态:</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/f6b98c0f776673188925f4aaca113eb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*c-9Ezv7KncolD6rP2mkTSQ.png"/></div></figure><p id="7b90" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">并遵循了cluster-autoscaler日志:<br/><em class="os">kubectl logs-f deployment/cluster-auto scaler-n kube-system</em></p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ox"><img src="../Images/0a897c59447c9b5964cd05f930af65af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oNaWpAdlJ_KX0sIOUCkguQ.png"/></div></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">cluster-autoscaler识别集群中存在不可调度的pod，并将混合ASG的大小从7个实例增加到14个实例，以便调度pod。</figcaption></figure><p id="3fd9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">EC2实例控制台中CA缩放活动的结果:</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi oy"><img src="../Images/2c7a634e32a37a93d8aeef1af5a0d44b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aOfhynre3c3eiKzaX3ty2A.png"/></div></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">按自动缩放组名称过滤的EC2实例控制台</figcaption></figure><p id="5677" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我的扩展部署现在在跨三个可用性区域的一组多样化实例类型的Spot实例上运行，增加了我获得所需容量并在Spot中断时保持所需容量的机会。</p><p id="97f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个演示针对多个ASG配置cluster-autoscaler的快速图示，其中每个ASG都有类似大小的实例类型。因为我使用的是容量优化分配策略，所以每次我横向扩展ASG时，它都会选择最不可能被中断的实例类型，从而有效地提高我的集群的稳定性和弹性。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div class="gh gi oz"><img src="../Images/8adb354b619cb27fb959a600f71ecccc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1082/format:webp/1*9GBIHINUCu5o5ep_k7uBwg.png"/></div></figure><h2 id="3f70" class="nz lm iq bd ln oa ob dn lr oc od dp lv jy oe of lz kc og oh md kg oi oj mh ok bi translated">集群自动扩展—底线</h2><p id="431e" class="pw-post-body-paragraph jn jo iq jp b jq nf js jt ju ng jw jx jy nh ka kb kc ni ke kf kg nj ki kj kk ij bi translated">具有多个相似实例类型的混合ASG适用于1.14版的cluster-autoscaler。现在，您有了一个基于混合ASG的节点组或多个节点组，如果您想安装并运行CA，您可以遵循ec2spotworkshops.com的<a class="ae mq" href="https://ec2spotworkshops.com/using_ec2_spot_instances_with_eks/scaling.html" rel="noopener ugc nofollow" target="_blank">自动缩放模块，只需将CA指向您使用eksctl、CFn模板或kops创建的混合ASG或多个ASG。</a></p></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><h1 id="f65c" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">在集群上运行的其他工具</h1><p id="4c4b" class="pw-post-body-paragraph jn jo iq jp b jq nf js jt ju ng jw jx jy nh ka kb kc ni ke kf kg nj ki kj kk ij bi translated">现在，集群中的Spot实例在混合ASG中运行，该混合由cluster-autoscaler自动缩放。</p><p id="58ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了拥有一个健壮且有弹性的集群，还推荐运行一些工具:</p><ol class=""><li id="8b99" class="nl nm iq jp b jq jr ju jv jy nn kc no kg np kk pa nr ns nt bi translated">AWS节点终止处理程序是一个可操作的<a class="ae mq" href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/" rel="noopener ugc nofollow" target="_blank"> DaemonSet </a>构建为使用AWS <a class="ae mq" href="https://aws.amazon.com/ec2/spot/" rel="noopener ugc nofollow" target="_blank"> EC2 Spot实例</a>在任何Kubernetes集群上运行。当用户启动终止处理程序时，该处理程序监视AWS <a class="ae mq" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html" rel="noopener ugc nofollow" target="_blank">实例元数据服务</a>在客户帐户内的<a class="ae mq" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/spot-interruptions.html" rel="noopener ugc nofollow" target="_blank">点实例中断</a>。如果收到正在集群上运行的实例的终止通知，终止处理程序将开始对该节点进行多步隔离和排空处理。<br/><a class="ae mq" href="https://github.com/aws/aws-node-termination-handler" rel="noopener ugc nofollow" target="_blank">https://github.com/aws/aws-node-termination-handler</a></li><li id="2fba" class="nl nm iq jp b jq nu ju nv jy nw kc nx kg ny kk pa nr ns nt bi translated">亚马逊EKS节点引流器提供了一种方法，当ASG启动“扩大”事件时，即如果您没有暂停ASG的AZrebalance进程(这在本文前面有所介绍)，可以优雅地终止EKS集群的节点。请注意，当缩小节点时，cluster-autoscaler <a class="ae mq" href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#how-does-scale-down-work" rel="noopener ugc nofollow" target="_blank">会自己清空</a>。<br/>代码提供了一个AWS Lambda函数，该函数集成为Amazon EC2自动扩展组生命周期挂钩。当被调用时，Lambda函数调用Kubernetes API来封锁，并从被终止的节点中驱逐所有pod。一旦放置在EC2实例上的所有单元被驱逐，自动缩放组将继续终止EC2实例。<br/><a class="ae mq" href="https://github.com/aws-samples/amazon-eks-node-drainer" rel="noopener ugc nofollow" target="_blank">https://github.com/aws-samples/amazon-eks-node-drainer</a><br/>注意:这个工具是为EKS设计的，但也可以适应Kops。请留下你的回复，如果你有一个预制的Kops工具来实现这个目的，或者对实现这个有任何疑问。</li><li id="905a" class="nl nm iq jp b jq nu ju nv jy nw kc nx kg ny kk pa nr ns nt bi translated">Kubernetes Descheduler将通过不断执行评估来提高集群的效率，并停止pods，以便在未充分利用的节点上对它们进行重新调度。这是必要的，因为Kubernetes调度程序只在需要调度pod时做出一次性决定，但是集群是动态的，而Descheduler将有助于保持工作节点的类似利用率。如果您打算基于资源预留自动缩放集群，这是一个必要的工具，但也可以在使用cluster-autoscaler时使用。<br/><a class="ae mq" href="https://github.com/kubernetes-incubator/descheduler" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes-incubator/descheduler</a></li><li id="014d" class="nl nm iq jp b jq nu ju nv jy nw kc nx kg ny kk pa nr ns nt bi translated">如果您打算使用Cluster-autoscaler，并希望在您的集群中保留一些扩展空间(过度配置)以允许更快的横向扩展，并允许中断的Spot实例中的pods在其他工作节点上快速重新调度，官方建议从<a class="ae mq" href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#how-can-i-configure-overprovisioning-with-cluster-autoscaler" rel="noopener ugc nofollow" target="_blank"> CA常见问题</a>中获得扩展空间:<br/> " <em class="os">可以使用分配了非常低优先级的部署运行暂停pods(请参见</em> <a class="ae mq" href="https://kubernetes.io/docs/concepts/configuration/pod-priority-preemption/" rel="noopener ugc nofollow" target="_blank"> <em class="os">优先级抢占</em> </a> <em class="os">)来配置过度配置，该部署运行暂停pods保留可由其他节点使用的资源如果没有足够的资源，暂停单元将被抢占，新单元将取代它们的位置。下一个暂停单元变得不可调度，并迫使CA扩大集群。”<br/> </em>集群过度配置工具可以帮助您实现这种方法:<br/><a class="ae mq" href="https://github.com/helm/charts/tree/master/stable/cluster-overprovisioner" rel="noopener ugc nofollow" target="_blank">https://github . com/helm/charts/tree/master/stable/cluster-over provisioner</a></li></ol></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><h1 id="09bd" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">购买而不是构建</h1><p id="e3c1" class="pw-post-body-paragraph jn jo iq jp b jq nf js jt ju ng jw jx jy nh ka kb kc ni ke kf kg nj ki kj kk ij bi translated">AWS客户正在使用EC2自动扩展组运行具有Spot实例的大规模关键任务Kubernetes集群，但是在Spot实例上运行弹性Kubernetes集群所需的一些步骤可能不适合所有用户。如果你想使用付费的交钥匙解决方案，我强烈推荐<a class="ae mq" href="https://spotinst.com/products/ocean/" rel="noopener ugc nofollow" target="_blank"> Spotinst Ocean </a>。Spotinst是AWS的高级技术合作伙伴，自2015年以来一直专注于通过Spot实例对AWS客户的工作负载进行成本优化，并在通过其海洋服务对Kubernetes工作负载进行成本优化方面取得了巨大进展。该服务将基本上为您管理本文中讨论的一切，包括根据pod规格以及价格和可用性智能选择Spot实例，在集群中保持自动和精确的扩展空间，同时运行异构节点组，以满足跨多个容量池进行多样化的Spot最佳实践。它还具有其他有用的功能，如允许您为您的群集确定所需实例类型的优先级、pod合适的规模调整建议工具，并且它还将提供您正在运行的部署的成本，用于显示/按存储容量使用计费。首先，你可以去eksworkshop.com的海洋舱<a class="ae mq" href="https://eksworkshop.com/beginner/190_ocean/" rel="noopener ugc nofollow" target="_blank"/></p></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><h1 id="4381" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">总结和要点</h1><p id="9a95" class="pw-post-body-paragraph jn jo iq jp b jq nf js jt ju ng jw jx jy nh ka kb kc ni ke kf kg nj ki kj kk ij bi translated">我希望这篇文章对您有所帮助，它将帮助您在Kubernetes集群中采用Spot实例，从而节省大量成本。如果您有任何反馈、意见、问题或其他您希望在这篇文章或未来的文章中看到的内容，请随时回复或在LinkedIn 上<a class="ae mq" href="https://www.linkedin.com/in/ransheinberg/" rel="noopener ugc nofollow" target="_blank">联系我。</a></p></div></div>    
</body>
</html>