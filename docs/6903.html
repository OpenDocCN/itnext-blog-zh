<html>
<head>
<title>Improve your initial load using React</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用React提高初始负载</h1>
<blockquote>原文：<a href="https://itnext.io/improve-your-initial-load-using-react-abfb27feb000?source=collection_archive---------2-----------------------#2022-04-08">https://itnext.io/improve-your-initial-load-using-react-abfb27feb000?source=collection_archive---------2-----------------------#2022-04-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="62fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为什么客户会离开你的网站？</p><p id="4c2c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">厌倦了装酒吧和纺车？你的网站是否挣扎于高跳出率？在这篇文章中，我将描述如何使用三种互补的方法来增强获取数据时的初始用户体验。</p><p id="0cde" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你网站的最初体验对访问者的再次访问至关重要。让我们想象一下，我们有一个咖啡公司的营销网站，在那里我们举例说明了一些指标，如销售的咖啡数量，研磨的咖啡豆数量等。</p><p id="c018" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是你的客户可能会感兴趣的非关键数据，也是为你的咖啡公司做广告的好方法。理想情况下，我们总是希望用户收到最新版本的数据。但是，如果数据更改的速度超过了服务器进行新构建的速度，用户将会看到过时的数据。另一方面，我们不希望我们的服务器一直进行新的构建。</p><p id="ebd5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于这种数据，如果用户在几毫秒内看到一些过时的数据，这是可以接受的，至少如果它们分别是不同的。最终，构建版本数据将与实际的实时版本数据如此不同，以至于售出咖啡数量的计数器可能会飙升，使其看起来像一个假计数器。我们会用Next.js做一个网站，一个React上面的框架，来解决这个问题。Next.js在服务器端渲染上很厉害。它提供了几种不同的获取数据的方式，这取决于你的网站的需求。对于这个特殊的用例，我们将使用增量静态再生。这个方法允许我们在x秒后重新生成构建版本，这取决于您的数据变化的程度。对于小咖啡公司来说，一分钟一次绰绰有余。</p><p id="b8dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Next.js中的getStaticProps方法将在构建时获取数据。将重新验证属性添加到返回对象，将使函数每分钟最多重新生成一次构建版本。第一个在一分钟内访问网站的用户会看到旧版本，但会触发新版本。</p><p id="693b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以用任何你喜欢的方式获取你的数据，但是这里我用的是Firebase。Firebase有一个NoSQL数据库，可以让你把数据传输到前端。因此，除了增量静态再生，我们还在初始加载后为用户提供实时数据流。</p><p id="0e5f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">getStaticProps函数:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="d236" class="ku kv iq kq b gy kw kx l ky kz">export async function getStaticProps() {</span><span id="b579" class="ku kv iq kq b gy la kx l ky kz">   const statsRef = doc(firestore, 'stats', 'home');</span><span id="54fd" class="ku kv iq kq b gy la kx l ky kz">   const statsData = await getDoc(statsRef);</span><span id="45a5" class="ku kv iq kq b gy la kx l ky kz">   return {</span><span id="aae8" class="ku kv iq kq b gy la kx l ky kz">      props: statsData.data(),</span><span id="be09" class="ku kv iq kq b gy la kx l ky kz">      revalidate: 60,</span><span id="750d" class="ku kv iq kq b gy la kx l ky kz">   };</span><span id="c207" class="ku kv iq kq b gy la kx l ky kz">}</span></pre><p id="f578" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我们想要实现的生命周期:</p><figure class="kl km kn ko gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi lb"><img src="../Images/cfe24b515e3f6c0cdbb3aa4285ac2baa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dd25CzQs8TqaboyFmtcBHQ.png"/></div></div></figure><p id="bc7d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在接收到初始数据加载后，我们应该创建一个钩子，在客户端加载时为数据设置一个监听器。钩子应该有一个状态，每当Firestore中的数据发生变化时，这个状态就会更新。</p><p id="8d35" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">钩子:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="d006" class="ku kv iq kq b gy kw kx l ky kz">export function useStats() {</span><span id="e303" class="ku kv iq kq b gy la kx l ky kz">   const [stats, setStats] = useState(null);</span><span id="0655" class="ku kv iq kq b gy la kx l ky kz">   const statsReference = useMemo(() =&gt; doc(firestore, ‘stats’, ‘home’), []);</span><span id="d92e" class="ku kv iq kq b gy la kx l ky kz">   useEffect(() =&gt; {</span><span id="5ad6" class="ku kv iq kq b gy la kx l ky kz">      onSnapshot(statsReference, snapshot =&gt; {</span><span id="cf36" class="ku kv iq kq b gy la kx l ky kz">         setStats(snapshot.data());</span><span id="add7" class="ku kv iq kq b gy la kx l ky kz">      });</span><span id="913f" class="ku kv iq kq b gy la kx l ky kz">   }, [statsReference]);</span><span id="631e" class="ku kv iq kq b gy la kx l ky kz">   return stats;</span><span id="2be4" class="ku kv iq kq b gy la kx l ky kz">}</span></pre><p id="542f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，将数据插入页面，如下所示:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="b147" class="ku kv iq kq b gy kw kx l ky kz">&lt;h2&gt;{stats ? stats.coffeesSold : initialDataCoffeesSold}&lt;/h2&gt;</span><span id="fa32" class="ku kv iq kq b gy la kx l ky kz">&lt;p&gt;coffee&amp;apos;s sold&lt;/p&gt;</span></pre><p id="aa92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最终结果是:</p><figure class="kl km kn ko gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi lj"><img src="../Images/5b854ca10f1219c2cda4b57ed9ac2085.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Elks1l4QICWe0TZdfX7AqA.png"/></div></div></figure></div></div>    
</body>
</html>