<html>
<head>
<title>Hive Metastore on Nomad</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Nomad上的Hive Metastore</h1>
<blockquote>原文：<a href="https://itnext.io/hive-metastore-on-nomad-5378bf1e0a2c?source=collection_archive---------2-----------------------#2021-05-13">https://itnext.io/hive-metastore-on-nomad-5378bf1e0a2c?source=collection_archive---------2-----------------------#2021-05-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/deef98acef1851296017c9f671290102.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PysoKhvgMq5XjcvfYhxUHQ.png"/></div></div></figure><p id="ef01" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Hive Metastore是数据湖中最重要的组件之一。Hive Metastore用作数据湖中的数据目录。有许多执行引擎可以使用Hive Metastore，例如Spark、Presto、Tez上的Hive、Spark上的Hive等。你可以在Kubernetes 上部署<a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/hive-on-spark-in-kubernetes-115c8e9fa5c1"> Hive Metastore，但是在这里，我将讨论如何在Nomad上部署Hive Metastore。</a></p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="1c18" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">先决条件</h1><p id="0093" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">实际上，因为我有在Kubernetes上部署Hive Metastore的经验，所以将Kubernetes Yaml转换为Nomad Job并不困难。你可以在Kubernetes 的Spark上看到<a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/hive-on-spark-in-kubernetes-115c8e9fa5c1"> Hive的<code class="fe mh mi mj mk b">Install Hive Metastore</code>部分，先了解一下如何在Kubernetes上部署Hive Metastore。</a></p><p id="a97a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Nomad上部署Hive Metastore之前，以下组件应该可用。</p><ul class=""><li id="98fd" class="ml mm iq ka b kb kc kf kg kj mn kn mo kr mp kv mq mr ms mt bi translated">Ceph v14</li><li id="9f2e" class="ml mm iq ka b kb mu kf mv kj mw kn mx kr my kv mq mr ms mt bi translated">Ceph CSI v3.3.1:使用Ceph CSI，可以从Ceph块存储配置nomad卷。</li><li id="8bf5" class="ml mm iq ka b kb mu kf mv kj mw kn mx kr my kv mq mr ms mt bi translated">S3或迷你S3对象存储</li><li id="b1df" class="ml mm iq ka b kb mu kf mv kj mw kn mx kr my kv mq mr ms mt bi translated">nomad 1 . 0 . 4版</li></ul><h1 id="576c" class="le lf iq bd lg lh mz lj lk ll na ln lo lp nb lr ls lt nc lv lw lx nd lz ma mb bi translated">为Hive Metastore部署MySQL服务器</h1><p id="2c3e" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">需要部署MySQL服务器来保存Hive Metastore的元数据。我们需要在Nomad中创建一个名称空间。在此命名空间中，将创建与Hive Metastore相关的所有作业。</p><pre class="ne nf ng nh gt ni mk nj nk aw nl bi"><span id="506b" class="nm lf iq mk b gy nn no l np nq">nomad namespace apply -description "Hive Metastore" hive-metastore;</span></pre><p id="70f4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要在MySQL中持久化数据，需要由Ceph CSI提供卷。您可以查看<a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/provision-volumes-from-external-ceph-storage-on-kubernetes-and-nomad-using-ceph-csi-7ad9b15e9809">如何使用Ceph CSI </a>在Nomad上提供卷的详细信息。在Nomad上注册卷之前，让我们在ceph中创建一个池的映像。</p><pre class="ne nf ng nh gt ni mk nj nk aw nl bi"><span id="688a" class="nm lf iq mk b gy nn no l np nq">sudo rbd create csi-vol-00000000-1111-2222-bbbb-cacacacacac1 --size 2048 --pool myPool --image-feature layering;</span></pre><p id="b934" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">向Nomad注册一个卷。</p><pre class="ne nf ng nh gt ni mk nj nk aw nl bi"><span id="1dd9" class="nm lf iq mk b gy nn no l np nq">cat &lt;&lt;EOF &gt; hive-metastore-mysql-volume.hcl<br/>type = "csi"<br/>id   = "hive-metastore-mysql"<br/>name = "hive-metastore-mysql"<br/>external_id     = "0001-0024-62c42aed-9839-4da6-8c09-9d220f56e924-0000000000000009-00000000-1111-2222-bbbb-cacacacacac1"<br/>access_mode     = "single-node-writer"<br/>attachment_mode = "file-system"<br/>mount_options {<br/>  fs_type = "ext4"<br/>}<br/>plugin_id       = "ceph-csi"<br/>secrets {<br/>  userID  = "admin"<br/>  userKey = "AQAvo5JgP++oEhAAeZb1j/MTWyLGGJC6abCNFw=="<br/>}<br/>context {<br/>  clusterID = "62c42aed-9839-4da6-8c09-9d220f56e924"<br/>  pool      = "myPool"<br/>  imageFeatures = "layering"<br/>}<br/>EOF</span><span id="c43d" class="nm lf iq mk b gy nr no l np nq"># register volume.<br/>nomad volume register -namespace=hive-metastore hive-metastore-mysql-volume.hcl;</span></pre><p id="2524" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">音量状态可以这样看。</p><pre class="ne nf ng nh gt ni mk nj nk aw nl bi"><span id="97a3" class="nm lf iq mk b gy nn no l np nq">nomad volume status -namespace hive-metastore;<br/>Container Storage Interface<br/>ID        Name                  Plugin ID  Schedulable  Access Mode<br/>hive-met  hive-metastore-mysql  ceph-csi   true         single-node-writer</span></pre><p id="5b39" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个注册的卷将安装在以下mysql服务器作业中。让我们在Nomad上运行MySQL服务器作业。</p><pre class="ne nf ng nh gt ni mk nj nk aw nl bi"><span id="60c7" class="nm lf iq mk b gy nn no l np nq">cat &lt;&lt;EOF &gt; hive-metastore-mysql-server.nomad<br/>job "hive-metastore-mysql-server" {<br/>  namespace = "hive-metastore"<br/>  datacenters = ["dc1"]<br/>  type        = "service"</span><span id="f5c7" class="nm lf iq mk b gy nr no l np nq">group "mysql-server" {<br/>    count = 1</span><span id="746f" class="nm lf iq mk b gy nr no l np nq">volume "ceph-mysql" {<br/>      type      = "csi"<br/>      read_only = false<br/>      source    = "hive-metastore-mysql"<br/>    }</span><span id="216c" class="nm lf iq mk b gy nr no l np nq">network {<br/>      port "db" {<br/>        static = 3306<br/>      }<br/>    }</span><span id="72cd" class="nm lf iq mk b gy nr no l np nq">restart {<br/>      attempts = 10<br/>      interval = "5m"<br/>      delay    = "25s"<br/>      mode     = "delay"<br/>    }</span><span id="7adf" class="nm lf iq mk b gy nr no l np nq">task "mysql-server" {<br/>      driver = "docker"</span><span id="f4c4" class="nm lf iq mk b gy nr no l np nq">volume_mount {<br/>        volume      = "ceph-mysql"<br/>        destination = "/srv"<br/>        read_only   = false<br/>      }</span><span id="99b1" class="nm lf iq mk b gy nr no l np nq">env {<br/>        MYSQL_ROOT_PASSWORD = "password"<br/>      }</span><span id="4e78" class="nm lf iq mk b gy nr no l np nq">config {<br/>        image = "mysql:5.7"     <br/> args  = ["--datadir", "/srv/mysql"]<br/>        ports = ["db"]<br/>      }</span><span id="e1fc" class="nm lf iq mk b gy nr no l np nq">resources {<br/>        cpu    = 500<br/>        memory = 1024<br/>      }</span><span id="f6f3" class="nm lf iq mk b gy nr no l np nq">service {<br/>        name = "hive-metastore-mysql-server"<br/>  port = "db"</span><span id="d1d7" class="nm lf iq mk b gy nr no l np nq">check {<br/>          type     = "tcp"<br/>          interval = "10s"<br/>          timeout  = "2s"<br/>        }<br/>      }<br/>    }<br/>  }<br/>}<br/>EOF</span><span id="0f7f" class="nm lf iq mk b gy nr no l np nq"># run mysql server job.<br/>nomad job run hive-metastore-mysql-server.nomad;</span></pre><p id="1a27" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们来看看乔布斯的状态。</p><pre class="ne nf ng nh gt ni mk nj nk aw nl bi"><span id="861a" class="nm lf iq mk b gy nn no l np nq">nomad status -namespace hive-metastore;<br/>ID                           Type     Priority  Status   Submit Date<br/>hive-metastore-mysql-server  service  50        running  2021-05-13T05:20:53Z</span></pre><p id="34d6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有一些方法可以连接到运行在Nomad上的MySQL服务器。可以直接访问分配的mysql服务器容器，也可以像这样使用MySQL客户端访问。</p><pre class="ne nf ng nh gt ni mk nj nk aw nl bi"><span id="5edf" class="nm lf iq mk b gy nn no l np nq">mysql -h hive-metastore-mysql-server.service.consul -u root -p</span></pre><p id="4dee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mh mi mj mk b">hive-metastore-mysql-server.service.consul</code>的主机名可以使用BIND进行解析，以转发Consul服务的DNS，更多详情请查阅<a class="ae kw" href="https://learn.hashicorp.com/tutorials/consul/dns-forwarding#bind-setup" rel="noopener ugc nofollow" target="_blank">Consul文档</a>，或者可以查看<a class="ae kw" href="https://mykidong.medium.com/install-nomad-cluster-d9a40d2206f5" rel="noopener">https://myki dong . medium . com/install-nomad-cluster-d9a 40d 2206 F5</a>中的<code class="fe mh mi mj mk b">Forward DNS for Consul Service Discovery</code>部分。</p><h1 id="501d" class="le lf iq bd lg lh mz lj lk ll na ln lo lp nb lr ls lt nc lv lw lx nd lz ma mb bi translated">初始化配置单元Metastore数据库架构</h1><p id="594a" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">为Hive Metastore部署MySQL服务器后，需要在MySQL服务器中创建Hive Metastore DB模式。</p><p id="8d68" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们在Nomad上运行Hive Metastore架构初始化作业。</p><pre class="ne nf ng nh gt ni mk nj nk aw nl bi"><span id="a594" class="nm lf iq mk b gy nn no l np nq">cat &lt;&lt;EOF &gt; init-hive-metastore-schema.nomad<br/>job "init-hive-metastore-schema" {<br/>  namespace = "hive-metastore"<br/>  datacenters = ["dc1"]<br/>  type        = "batch"</span><span id="5908" class="nm lf iq mk b gy nr no l np nq">group "mysql-server" {<br/>    task "init-schema" {<br/>      driver = "docker"  <br/>      config {<br/>        image = "mykidong/hivemetastore:v3.0.0"  <br/>  command = "/opt/hive-metastore/bin/schematool"<br/>  args  = [<br/>    "--verbose",<br/>    "-initSchema", <br/>    "-dbType", <br/>    "mysql" , <br/>    "-userName", <br/>    "root",<br/>          "-passWord", "password", <br/>    "-url", <br/>    "jdbc:mysql://hive-metastore-mysql-server.service.consul:3306/metastore_db?createDatabaseIfNotExist=true&amp;connectTimeout=1000"<br/>  ]       <br/>      }<br/>      resources {<br/>        cpu    = 100<br/>        memory = 256<br/>      }<br/>    }<br/>  }<br/>}<br/>EOF</span><span id="a5d6" class="nm lf iq mk b gy nr no l np nq"># run init schema batch job.<br/>nomad job run init-hive-metastore-schema.nomad;</span></pre><p id="4571" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这份工作是<code class="fe mh mi mj mk b">batch</code>的类型。运行作业后，MySQL中已经创建了许多db表。</p><pre class="ne nf ng nh gt ni mk nj nk aw nl bi"><span id="1132" class="nm lf iq mk b gy nn no l np nq">MySQL [(none)]&gt; use metastore_db;<br/>Reading table information for completion of table and column names<br/>You can turn off this feature to get a quicker startup with -A</span><span id="22ae" class="nm lf iq mk b gy nr no l np nq">Database changed<br/>MySQL [metastore_db]&gt; show tables;<br/>+---------------------------+<br/>| Tables_in_metastore_db    |<br/>+---------------------------+<br/>| AUX_TABLE                 |<br/>| BUCKETING_COLS            |<br/>| CDS                       |<br/>| COLUMNS_V2                |<br/>| COMPACTION_QUEUE          |<br/>| COMPLETED_COMPACTIONS     |<br/>| COMPLETED_TXN_COMPONENTS  |<br/>| CTLGS                     |<br/>| DATABASE_PARAMS           |<br/>| DBS                       |<br/>| DB_PRIVS                  |<br/>| DELEGATION_TOKENS         |<br/>| FUNCS                     |<br/>| FUNC_RU                   |<br/>| GLOBAL_PRIVS              |<br/>| HIVE_LOCKS                |<br/>| IDXS                      |<br/>| INDEX_PARAMS              |<br/>| I_SCHEMA                  |<br/>| KEY_CONSTRAINTS           |<br/>| MASTER_KEYS               |<br/>| METASTORE_DB_PROPERTIES   |<br/>| MIN_HISTORY_LEVEL         |<br/>| MV_CREATION_METADATA      |<br/>| MV_TABLES_USED            |<br/>| NEXT_COMPACTION_QUEUE_ID  |<br/>| NEXT_LOCK_ID              |<br/>| NEXT_TXN_ID               |<br/>| NEXT_WRITE_ID             |<br/>| NOTIFICATION_LOG          |<br/>| NOTIFICATION_SEQUENCE     |<br/>| NUCLEUS_TABLES            |<br/>| PARTITIONS                |<br/>| PARTITION_EVENTS          |<br/>| PARTITION_KEYS            |<br/>| PARTITION_KEY_VALS        |<br/>| PARTITION_PARAMS          |<br/>| PART_COL_PRIVS            |<br/>| PART_COL_STATS            |<br/>| PART_PRIVS                |<br/>| REPL_TXN_MAP              |<br/>| ROLES                     |<br/>| ROLE_MAP                  |<br/>| RUNTIME_STATS             |<br/>| SCHEMA_VERSION            |<br/>| SDS                       |<br/>| SD_PARAMS                 |<br/>| SEQUENCE_TABLE            |<br/>| SERDES                    |<br/>| SERDE_PARAMS              |<br/>| SKEWED_COL_NAMES          |<br/>| SKEWED_COL_VALUE_LOC_MAP  |<br/>| SKEWED_STRING_LIST        |<br/>| SKEWED_STRING_LIST_VALUES |<br/>| SKEWED_VALUES             |<br/>| SORT_COLS                 |<br/>| TABLE_PARAMS              |<br/>| TAB_COL_STATS             |<br/>| TBLS                      |<br/>| TBL_COL_PRIVS             |<br/>| TBL_PRIVS                 |<br/>| TXNS                      |<br/>| TXN_COMPONENTS            |<br/>| TXN_TO_WRITE_ID           |<br/>| TYPES                     |<br/>| TYPE_FIELDS               |<br/>| VERSION                   |<br/>| WM_MAPPING                |<br/>| WM_POOL                   |<br/>| WM_POOL_TO_TRIGGER        |<br/>| WM_RESOURCEPLAN           |<br/>| WM_TRIGGER                |<br/>| WRITE_SET                 |<br/>+---------------------------+<br/>73 rows in set (0.01 sec)</span></pre><p id="7fc3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">目前，我们已经在Nomad上部署了MySQL服务器，并在MySQL中为Hive Metastore创建了db模式。</p><p id="e82d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在继续之前，让我们检查一下在Nomad上重启mysql服务器作业后，MySQL数据是否丢失。</p><p id="b83f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Nomad上重新提交MySQL服务器作业。</p><pre class="ne nf ng nh gt ni mk nj nk aw nl bi"><span id="ce4c" class="nm lf iq mk b gy nn no l np nq"># stop mysql server.<br/>nomad stop -purge -namespace hive-metastore hive-metastore-mysql-server;</span><span id="1bd9" class="nm lf iq mk b gy nr no l np nq"># run mysql server job.<br/>nomad job run hive-metastore-mysql-server.nomad;</span></pre><p id="412a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并再次访问mysql服务器。</p><pre class="ne nf ng nh gt ni mk nj nk aw nl bi"><span id="b20d" class="nm lf iq mk b gy nn no l np nq">MySQL [(none)]&gt; show databases;<br/>+--------------------+<br/>| Database           |<br/>+--------------------+<br/>| information_schema |<br/>| metastore_db       |<br/>| mysql              |<br/>| performance_schema |<br/>| sys                |<br/>+--------------------+<br/>5 rows in set (0.00 sec)</span><span id="1109" class="nm lf iq mk b gy nr no l np nq">MySQL [(none)]&gt; use metastore_db;<br/>Reading table information for completion of table and column names<br/>You can turn off this feature to get a quicker startup with -A</span><span id="d972" class="nm lf iq mk b gy nr no l np nq">Database changed<br/>MySQL [metastore_db]&gt; show tables;<br/>+---------------------------+<br/>| Tables_in_metastore_db    |<br/>+---------------------------+<br/>| AUX_TABLE                 |<br/>| BUCKETING_COLS            |<br/>| CDS                       |<br/>| COLUMNS_V2                |<br/>| COMPACTION_QUEUE          |<br/>| COMPLETED_COMPACTIONS     |<br/>| COMPLETED_TXN_COMPONENTS  |<br/>...</span></pre><p id="b2b5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">正如所见，Hive Metastore的MySQL服务器中没有数据丢失。</p><h1 id="9444" class="le lf iq bd lg lh mz lj lk ll na ln lo lp nb lr ls lt nc lv lw lx nd lz ma mb bi translated">在Nomad上部署配置单元Metastore服务器</h1><p id="389d" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">要运行hive metastore，我们需要用于hadoop配置的<code class="fe mh mi mj mk b">core-site.xml</code>和用于Hive Metastore配置的<code class="fe mh mi mj mk b">metastore-site.xml</code>。</p><p id="db09" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mh mi mj mk b">core-site.xml</code>的hadoop配置如下。</p><pre class="ne nf ng nh gt ni mk nj nk aw nl bi"><span id="0051" class="nm lf iq mk b gy nn no l np nq">&lt;configuration&gt;<br/>    &lt;property&gt;<br/>        &lt;name&gt;fs.s3a.connection.ssl.enabled&lt;/name&gt;<br/>     &lt;value&gt;true&lt;/value&gt;<br/>    &lt;/property&gt;<br/>    &lt;property&gt;<br/>        &lt;name&gt;fs.defaultFS&lt;/name&gt;<br/>        &lt;value&gt;s3a://mykidong&lt;/value&gt;<br/>    &lt;/property&gt;<br/>    &lt;property&gt;<br/>        &lt;name&gt;fs.s3a.path.style.access&lt;/name&gt;<br/>        &lt;value&gt;true&lt;/value&gt;<br/>    &lt;/property&gt;<br/>    &lt;property&gt;<br/>        &lt;name&gt;fs.s3a.access.key&lt;/name&gt;<br/>        &lt;value&gt;cclminio&lt;/value&gt;<br/>    &lt;/property&gt;<br/>    &lt;property&gt;<br/>        &lt;name&gt;fs.s3a.secret.key&lt;/name&gt;<br/>        &lt;value&gt;rhksflja!@#&lt;/value&gt;<br/>    &lt;/property&gt;<br/>    &lt;property&gt;<br/>        &lt;name&gt;fs.s3a.impl&lt;/name&gt;<br/>        &lt;value&gt;org.apache.hadoop.fs.s3a.S3AFileSystem&lt;/value&gt;<br/>    &lt;/property&gt;<br/>    &lt;property&gt;<br/>        &lt;name&gt;fs.s3a.endpoint&lt;/name&gt;<br/>        &lt;value&gt;<a class="ae kw" href="https://nginx-test.cloudchef-labs.com" rel="noopener ugc nofollow" target="_blank">https://nginx-test.cloudchef-labs.com</a>&lt;/value&gt;<br/>    &lt;/property&gt;<br/>    &lt;property&gt;<br/>        &lt;name&gt;fs.s3a.fast.upload&lt;/name&gt;<br/>        &lt;value&gt;true&lt;/value&gt;<br/>    &lt;/property&gt;<br/>&lt;/configuration&gt;</span></pre><p id="51a9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">看看与s3相关的属性，比如s3存储桶、访问密钥、秘密密钥和S3端点，应该对它们进行更改以满足您的需求。</p><p id="7dea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mh mi mj mk b">metastore-site.xml</code>的hive metastore配置如下所示。</p><pre class="ne nf ng nh gt ni mk nj nk aw nl bi"><span id="b308" class="nm lf iq mk b gy nn no l np nq">&lt;configuration&gt;<br/> &lt;property&gt;<br/>  &lt;name&gt;metastore.task.threads.always&lt;/name&gt;<br/>  &lt;value&gt;org.apache.hadoop.hive.metastore.events.EventCleanerTask&lt;/value&gt;<br/> &lt;/property&gt;<br/> &lt;property&gt;<br/>  &lt;name&gt;metastore.expression.proxy&lt;/name&gt;<br/>  &lt;value&gt;org.apache.hadoop.hive.metastore.DefaultPartitionExpressionProxy&lt;/value&gt;<br/> &lt;/property&gt;<br/> &lt;property&gt;<br/>  &lt;name&gt;javax.jdo.option.ConnectionDriverName&lt;/name&gt;<br/>  &lt;value&gt;com.mysql.jdbc.Driver&lt;/value&gt;<br/> &lt;/property&gt;<br/> &lt;property&gt;<br/>  &lt;name&gt;javax.jdo.option.ConnectionURL&lt;/name&gt;<br/>  &lt;value&gt;jdbc:mysql://hive-metastore-mysql-server.service.consul:3306/metastore_db?useSSL=false&lt;/value&gt;<br/> &lt;/property&gt;<br/> &lt;property&gt;<br/>  &lt;name&gt;javax.jdo.option.ConnectionUserName&lt;/name&gt;<br/>  &lt;value&gt;root&lt;/value&gt;<br/> &lt;/property&gt;<br/> &lt;property&gt;<br/>  &lt;name&gt;javax.jdo.option.ConnectionPassword&lt;/name&gt;<br/>  &lt;value&gt;password&lt;/value&gt;<br/> &lt;/property&gt;<br/> &lt;property&gt;<br/>  &lt;name&gt;metastore.warehouse.dir&lt;/name&gt;<br/>  &lt;value&gt;s3a://mykidong/warehouse/&lt;/value&gt;<br/> &lt;/property&gt;<br/> &lt;property&gt;<br/>  &lt;name&gt;metastore.thrift.port&lt;/name&gt;<br/>  &lt;value&gt;9083&lt;/value&gt;<br/> &lt;/property&gt;<br/>&lt;/configuration&gt;</span></pre><p id="a638" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">看看连接到MySQL for Hive Metastore的属性。</p><p id="c3a7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们来看看Hive Metastore服务器的完整作业脚本。</p><pre class="ne nf ng nh gt ni mk nj nk aw nl bi"><span id="0fcc" class="nm lf iq mk b gy nn no l np nq">job "hive-metastore-server" {<br/>  namespace = "hive-metastore"<br/>  datacenters = ["dc1"]<br/>  type = "service"<br/>  group "hive-metastore" {<br/>    count = 1<br/>    network {<br/>      port "hms" {<br/>        static = 9083<br/>      }<br/>    }<br/> restart {<br/>      attempts = 10<br/>      interval = "5m"<br/>      delay    = "25s"<br/>      mode     = "delay"<br/>    }<br/>    task "hive-metastore-server" {<br/>      template {<br/>        data        = &lt;&lt;EOF<br/>&lt;configuration&gt;<br/>    &lt;property&gt;<br/>        &lt;name&gt;fs.s3a.connection.ssl.enabled&lt;/name&gt;<br/>     &lt;value&gt;true&lt;/value&gt;<br/>    &lt;/property&gt;<br/>    &lt;property&gt;<br/>        &lt;name&gt;fs.defaultFS&lt;/name&gt;<br/>        &lt;value&gt;s3a://mykidong&lt;/value&gt;<br/>    &lt;/property&gt;<br/>    &lt;property&gt;<br/>        &lt;name&gt;fs.s3a.path.style.access&lt;/name&gt;<br/>        &lt;value&gt;true&lt;/value&gt;<br/>    &lt;/property&gt;<br/>    &lt;property&gt;<br/>        &lt;name&gt;fs.s3a.access.key&lt;/name&gt;<br/>        &lt;value&gt;cclminio&lt;/value&gt;<br/>    &lt;/property&gt;<br/>    &lt;property&gt;<br/>        &lt;name&gt;fs.s3a.secret.key&lt;/name&gt;<br/>        &lt;value&gt;rhksflja!@#&lt;/value&gt;<br/>    &lt;/property&gt;<br/>    &lt;property&gt;<br/>        &lt;name&gt;fs.s3a.impl&lt;/name&gt;<br/>        &lt;value&gt;org.apache.hadoop.fs.s3a.S3AFileSystem&lt;/value&gt;<br/>    &lt;/property&gt;<br/>    &lt;property&gt;<br/>        &lt;name&gt;fs.s3a.endpoint&lt;/name&gt;<br/>        &lt;value&gt;<a class="ae kw" href="https://nginx-test.cloudchef-labs.com" rel="noopener ugc nofollow" target="_blank">https://nginx-test.cloudchef-labs.com</a>&lt;/value&gt;<br/>    &lt;/property&gt;<br/>    &lt;property&gt;<br/>        &lt;name&gt;fs.s3a.fast.upload&lt;/name&gt;<br/>        &lt;value&gt;true&lt;/value&gt;<br/>    &lt;/property&gt;<br/>&lt;/configuration&gt;<br/>EOF<br/>        destination = "local/core-site.xml"<br/>        change_mode = "restart"<br/>      }   <br/>   template {<br/>        data        = &lt;&lt;EOF<br/>&lt;configuration&gt;<br/> &lt;property&gt;<br/>  &lt;name&gt;metastore.task.threads.always&lt;/name&gt;<br/>  &lt;value&gt;org.apache.hadoop.hive.metastore.events.EventCleanerTask&lt;/value&gt;<br/> &lt;/property&gt;<br/> &lt;property&gt;<br/>  &lt;name&gt;metastore.expression.proxy&lt;/name&gt;<br/>  &lt;value&gt;org.apache.hadoop.hive.metastore.DefaultPartitionExpressionProxy&lt;/value&gt;<br/> &lt;/property&gt;<br/> &lt;property&gt;<br/>  &lt;name&gt;javax.jdo.option.ConnectionDriverName&lt;/name&gt;<br/>  &lt;value&gt;com.mysql.jdbc.Driver&lt;/value&gt;<br/> &lt;/property&gt;<br/> &lt;property&gt;<br/>  &lt;name&gt;javax.jdo.option.ConnectionURL&lt;/name&gt;<br/>  &lt;value&gt;jdbc:mysql://hive-metastore-mysql-server.service.consul:3306/metastore_db?useSSL=false&lt;/value&gt;<br/> &lt;/property&gt;<br/> &lt;property&gt;<br/>  &lt;name&gt;javax.jdo.option.ConnectionUserName&lt;/name&gt;<br/>  &lt;value&gt;root&lt;/value&gt;<br/> &lt;/property&gt;<br/> &lt;property&gt;<br/>  &lt;name&gt;javax.jdo.option.ConnectionPassword&lt;/name&gt;<br/>  &lt;value&gt;password&lt;/value&gt;<br/> &lt;/property&gt;<br/> &lt;property&gt;<br/>  &lt;name&gt;metastore.warehouse.dir&lt;/name&gt;<br/>  &lt;value&gt;s3a://mykidong/warehouse/&lt;/value&gt;<br/> &lt;/property&gt;<br/> &lt;property&gt;<br/>  &lt;name&gt;metastore.thrift.port&lt;/name&gt;<br/>  &lt;value&gt;9083&lt;/value&gt;<br/> &lt;/property&gt;<br/>&lt;/configuration&gt;<br/>EOF<br/>        destination = "local/metastore-site.xml"<br/>        change_mode = "restart"<br/>      }   <br/>   env {<br/>        AWS_ACCESS_KEY_ID = "cclminio"<br/>  AWS_SECRET_ACCESS_KEY = "rhksflja!@#"<br/>      }   <br/>      driver = "docker"<br/>      config {<br/>        image = "mykidong/hivemetastore:v3.0.0"<br/>        volumes = [<br/>          "./local/core-site.xml:/opt/hadoop/etc/hadoop/core-site.xml",<br/>    "./local/metastore-site.xml:/opt/hive-metastore/conf/metastore-site.xml"<br/>        ]   <br/>        command = "/opt/hive-metastore/bin/start-metastore" <br/>        args = ["-p", "9083"] <br/>  ports = [<br/>          "hms",<br/>        ]<br/>      }   <br/>   resources {<br/>        cpu    = 500<br/>        memory = 256<br/>      }<br/>      service {<br/>        name = "hive-metastore"<br/>        port = "hms"<br/>        check {<br/>          type     = "tcp"<br/>          interval = "10s"<br/>          timeout  = "2s"<br/>        }<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="90d0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将文件另存为<code class="fe mh mi mj mk b">hive-metastore-server.nomad</code>，并在Nomad上运行Hive Metastore作业。</p><pre class="ne nf ng nh gt ni mk nj nk aw nl bi"><span id="69bf" class="nm lf iq mk b gy nn no l np nq">nomad job run hive-metastore-server.nomad;</span></pre><p id="9c1d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果已成功提交配置单元metastore作业，您可以看到作业的状态。</p><pre class="ne nf ng nh gt ni mk nj nk aw nl bi"><span id="762d" class="nm lf iq mk b gy nn no l np nq">nomad status -namespace hive-metastore;<br/>ID                           Type     Priority  Status   Submit Date<br/>hive-metastore-mysql-server  service  50        running  2021-05-13T05:20:53Z<br/>hive-metastore-server        service  50        running  2021-05-13T06:40:28Z</span></pre><p id="e631" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以在<code class="fe mh mi mj mk b">9083</code>上检查到Hive Metastore服务器侦听的连接。</p><pre class="ne nf ng nh gt ni mk nj nk aw nl bi"><span id="a5f9" class="nm lf iq mk b gy nn no l np nq">nc -zv hive-metastore.service.consul 9083;</span></pre></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="af9b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就是这样。</p></div></div>    
</body>
</html>