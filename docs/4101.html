<html>
<head>
<title>Velero backup/restore for K8s Stateful Applications managed by Operators</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">针对运营商管理的K8s有状态应用的Velero备份/恢复</h1>
<blockquote>原文：<a href="https://itnext.io/velero-backup-restore-for-k8s-stateful-applications-managed-by-operators-8fd9c732ffcc?source=collection_archive---------0-----------------------#2020-04-27">https://itnext.io/velero-backup-restore-for-k8s-stateful-applications-managed-by-operators-8fd9c732ffcc?source=collection_archive---------0-----------------------#2020-04-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="2609" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://velero.io/" rel="noopener ugc nofollow" target="_blank"> Velero </a>是Kubernetes的备份和恢复工具，Kubernetes是最广泛采用和使用的容器编制器。Kubernetes已经发展成为拥抱容器世界的开发人员的救星，缩短了他们的冲刺时间，使生活变得更加轻松。从CI/CD管道到生产就绪Pod(K8s中构成容器的最小单元/对象),构建部署已经从几周缩减到几天和几小时。</p><p id="6761" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一方面，IT系统已经采用了Kubernetes，与开发人员有着相同的基调和活力，但随之而来的是管理它和为日常操作运行它的麻烦。K8s通过将网络、计算和存储抽象化，在管理基础架构方面带来了新的挑战。所有这些资源都变成了JSON文件中的一个对象，并存储在一个有状态的<strong class="jp ir"> etcd </strong>数据库中。Kubernetes现在是所有主要公共云中的PaaS，用于工作负载部署，并推动云原生应用程序的概念。</p><p id="41bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">企业面临的主要挑战之一是保持应用程序的高可用性和弹性。K8s上应用程序的云原生设计通过内置的关键功能高度可用，如自动扩展、集群节点的跨区域实施、ReplicaSet、StatefulSet、metro-stretch存储系统等。</p><p id="e795" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们退后一点，应用程序托管在一个高度可用的架构上的一个云上。但是它们有弹性吗？BCP，当灾难来临的时候怎么样！，公司还有吗？是的，自磁带备份和异地保险存储时代以来，备份和恢复技术一直在拯救我们的任务关键型业务应用程序。</p><p id="1efb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">TL；dr我在这里尝试列举并说明弹性是如何构建到托管在Kubernetes或公共云上的Kubernetes即服务上的任务关键型有状态应用程序中的。</p><p id="68c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了集中讨论，我将使用IBM公共云的<a class="ae kl" href="https://www.ibm.com/in-en/cloud/container-service" rel="noopener ugc nofollow" target="_blank"> IKS </a> (Kubernetes服务)和<a class="ae kl" href="https://www.ibm.com/in-en/cloud/object-storage" rel="noopener ugc nofollow" target="_blank"> COS </a>(云对象存储——不可变)。您还可以将<a class="ae kl" href="https://min.io/" rel="noopener ugc nofollow" target="_blank"> Minio </a>用于您的对象存储，这是一个很好的工具，可以通过将更快的存储层映射到您的节点来获得更好的性能。该指南也非常适合普通的Kubernetes内部部署。</p><p id="4f84" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Velero架构及其内部工作原理在他们的网站Github文档中有很好的记录，所以我在这里不做尝试。但是下面的架构会给你一个整体的视角。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/aeb2e1b2b0c3acaf983f78b2663a38d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A9sBekZZTpfWeFBMXlUUbw.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">Velero与K8s集成，用于备份到COS/Minio</figcaption></figure><p id="1236" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我们开始吧！</p><p id="6fa3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">下载并安装Velero客户端</strong></p><p id="d620" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下载Velero如这里所述:【https://github.com/vmware-tanzu/velero/releases/tag/v1.3.2】T2。一次tar ball下载应该会安装Velero客户机程序以及集群所需的配置文件。</p><p id="28d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">提取tar.gz文件，并将其移动到本地工作目录。将Velero目录添加到路径中。例如，如果您已经下载了velero-v1.3.0-darwin-amd64，则运行以下命令</p><blockquote class="lc ld le"><p id="cf37" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq">导出路径= $ PATH:/usr/local/bin/velero-v 1 . 3 . 0-Darwin-amd64/</em></p></blockquote><p id="2d9d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行命令velero - help来探索它提供的选项。</p><p id="8491" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">配置Velero设置和设置COS </strong></p><p id="b2be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">配置您的kubectl客户机来访问您的IKS部署。创建一个COS bucket和相关的服务凭据，以便在Velero安装期间使用。在本地目录中创建一个特定于Velero的凭证文件(credentials-velero)。将您的<cos access="" key="" id="">和<cos secret="" access="" key="">替换为您为COS bucket创建的COS服务凭证。</cos></cos></p><pre class="kn ko kp kq gt lj lk ll lm aw ln bi"><span id="6e39" class="lo lp iq lk b gy lq lr l ls lt">echo “[default] <br/>aws_access_key_id = &lt;COS access key ID&gt; <br/>aws_secret_access_key = &lt;COS secret Access key&gt;” &gt; credentials-velero</span></pre><p id="19aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在使用下面的Velero install命令安装Velero服务器。用您的COS桶名替换<cos bucket="" name="">。编辑COS区域和s3URL以匹配您的选择。插件是必需的，如下所示。</cos></p><pre class="kn ko kp kq gt lj lk ll lm aw ln bi"><span id="818e" class="lo lp iq lk b gy lq lr l ls lt">velero install \<br/> — provider aws \<br/> — bucket &lt;COS bucket name&gt; \<br/> — secret-file ./credentials-velero \<br/> — use-volume-snapshots=false \<br/> — backup-location-config region=us- east,s3ForcePathStyle=”true”,s3Url=https://&lt;S3 URL&gt;<br/> — plugins velero/velero-plugin-for-aws:v1.0.0</span></pre><p id="b5dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将在IKS集群上执行Velero安装作为部署，如下所示。完成后，输出应该类似于下图。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi lu"><img src="../Images/e00904e4b551078873ddf7182f3cb3c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rcNcsEfMGwfs5dGJtwBrxw.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">Velero安装</figcaption></figure><p id="2efd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Velero部署创建了一个名为Velero的独立名称空间，Velero pod驻留在该名称空间中。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi lv"><img src="../Images/f586a379ed7961f3bccb8b749c75c747.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8vz5f7yHZ4PZKj-mO_CNVA.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">“Velero”命名空间内的Velero pod</figcaption></figure><p id="9e55" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">设置您的应用程序进行备份</strong></p><p id="8e9e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将部署一个示例应用程序(在我们的例子中是一个带有MySQL DB的WordPress应用程序),其中包含一个使用PVC备份的卷，并将其动态映射到IKS的一个预定义存储类。在本练习中，我们将为IKS使用IBM NFS文件存储。</p><p id="0e93" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个与存储类ibmc-file-silver关联的PVC</p><pre class="kn ko kp kq gt lj lk ll lm aw ln bi"><span id="1d8c" class="lo lp iq lk b gy lq lr l ls lt">---<br/>apiVersion: v1<br/>kind: PersistentVolumeClaim<br/>metadata:<br/> name: mysql-silver-pvc<br/> labels:<br/> billingType: hourly<br/> region: us-south<br/> zone: dal10<br/>spec:<br/> accessModes:<br/> — ReadWriteMany<br/> resources:<br/> requests:<br/> storage: 24Gi<br/> storageClassName: ibmc-file-silver</span></pre><p id="9293" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">PVC与存储类ibmc-file-silver绑定</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi lw"><img src="../Images/51340ecddea8eb410b23f7d41873c24f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qDNC7wqaBBA39aew-Hs8Fg.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">动态创建和绑定PVC</figcaption></figure><p id="0e4d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用MySQL部署wordpress，下面是yaml。使用您选择的编辑器(vi)创建一个名为mysql.yaml的. yaml文件。用您选择的安全密码替换&lt;<em class="lf">密码</em> &gt;的env值。这个密码将在以后用于登录MySQL数据库。快跑。yaml文件，带有kubectl命令kubectl apply-f&lt;MySQL . YAML&gt;</p><pre class="kn ko kp kq gt lj lk ll lm aw ln bi"><span id="c34a" class="lo lp iq lk b gy lq lr l ls lt">apiVersion: apps/v1 # for versions before 1.9.0 use apps/v1beta2<br/>kind: Deployment<br/>metadata:<br/> name: wordpress-mysql<br/> labels:<br/> app: wordpress<br/>spec:<br/> selector:<br/> matchLabels:<br/> app: wordpress<br/> tier: mysql<br/> strategy:<br/> type: Recreate<br/> template:<br/> metadata:<br/> labels:<br/> app: wordpress<br/> tier: mysql<br/> spec:<br/> containers:<br/> — image: mysql:5.6<br/> name: mysql<br/> env:<br/> — name: MYSQL_ROOT_PASSWORD<br/> value: &lt;password&gt;<br/> ports:<br/> — containerPort: 3306<br/> name: mysql<br/> volumeMounts:<br/> — name: pvc-3cb5302d-5cb5–43ed-bff3–4926f1d4852d<br/> mountPath: /var/lib/mysql<br/> volumes:<br/> — name: pvc-3cb5302d-5cb5–43ed-bff3–4926f1d4852d<br/> persistentVolumeClaim:<br/> claimName: mysql-silver-pvc</span></pre><p id="35c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用程序窗格被派生出来，看起来类似于下图。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi lx"><img src="../Images/bbc56599069030d9ddf6dfb8b0a41441.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fqqdRnmCfrOj2QkBt7gPOA.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">Wordpress窗格已创建</figcaption></figure><p id="73ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们已经创建了一个有状态的应用程序pod，我们将检查pod是否正在运行，并验证pod的详细信息。详细的pod描述将显示所有信息，如节点、PVC、IP详细信息、卷安装等。如下图。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ly"><img src="../Images/f00eedc646846c9233a2e93fdafb4c32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oWlmlMp8uKKR2xXrxn9i4w.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">Wordpress窗格详细信息</figcaption></figure><p id="c2ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">配置MySQL pod </strong></p><p id="b555" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以通过将备份范围限定到应用程序的名称空间来备份示例应用程序。因为我们已经在默认名称空间中部署了我们的应用程序，所以我们可以将其保留为默认名称空间。</p><p id="c921" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将进入分离舱的外壳。以用户“root”和我们在部署yaml文件中提供的<password>身份登录MySQL数据库。然后，我们将创建如下所示的几个示例数据库(test1、test2 ),在卷中创建一个持久数据。</password></p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ly"><img src="../Images/fd1876c2c370c8b120739186f9fc79e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5M-lTCLaEHQSUK3X9nUGhQ.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">进入MySQL pod并创建数据库</figcaption></figure><p id="ba26" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">使用Velero备份K8S配置和卷</strong></p><p id="dfe6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用Velero命令创建备份。Velero提供了一种在不同名称空间中查找pod的粒度方法。这里我们可以使用Pod选择器app=wordpress，它已经在MySQL部署期间声明了。这将让Velero使用匹配的选择器创建特定pod的备份。下图还提供了所创建备份的详细描述。</p><p id="ba7d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意:我们需要每个POD的Restic注释，以便Velero能够进行备份。这在博客中没有显示。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ly"><img src="../Images/d36e2a4159a940f10e762724d1a1dc9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8O_oythyPBGKCa4zW7lepQ.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">使用Velero创建备份</figcaption></figure><p id="6aca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">验证COS中的备份</strong></p><p id="5cf8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下图显示了为MySQL pod备份的文件。仔细查看，了解Velero备份的文件</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ly"><img src="../Images/55f059110df59c4c81e0de95bbf0ba05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3xDQf8yhBN6NGArI1j2JIg.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">对象存储(COS)中的备份文件</figcaption></figure><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi lz"><img src="../Images/7a0d2730633744535c84c2487cd123e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lheKhkPOykekfMr9M3HuPg.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">迷你备份文件(例如)</figcaption></figure><p id="3a21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">模拟灾难和恢复应用</strong></p><p id="b33d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们现在将删除MySQL部署，并验证部署和关联的pod是否也被删除，如下所示。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ly"><img src="../Images/c479357f34d8d11f2ea5ce5e9238dd11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w-c79aEx566JxenrP2iJeg.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">删除部署和窗格</figcaption></figure><p id="97d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">使用Velero恢复并验证部署和MySQL数据库</strong></p><p id="f745" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将运行Velero restore命令，从COS中的备份文件恢复MySql部署。不一会儿，我们注意到Velero已成功恢复部署。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ly"><img src="../Images/e9efebcd7c0db4d0728ef5c547a470de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C-7k8_5Msz-mOvl1pJRC4A.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">使用Velero从COS(对象存储)恢复MySQL</figcaption></figure><p id="dca0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦我们恢复了部署，相关联的吊舱也启动了。我们进入shell并登录MySQL数据库。我们可以看到我们之前创建的数据库(test1和test2)完好无损。</p><p id="9a10" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi ma translated"><span class="l mb mc md bm me mf mg mh mi di">在</span>下一节中，我们将更深入地了解Velero的功能</p><p id="0ebf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">使用K8s操作符通过CRD设置应用</strong></p><p id="14ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kubernetes有控制器，这些控制器是控制循环，监视您的<a class="ae kl" href="https://kubernetes.io/docs/reference/glossary/?all=true#term-cluster" rel="noopener ugc nofollow" target="_blank">集群</a>的状态，然后根据需要做出或请求更改。每个控制器都试图将当前的群集状态移至更接近所需的状态。</p><p id="b240" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kubernetes还有名为CRD的定制控制器，它定义了定制资源和相关的控制器。自定义资源本身只是让您存储和检索结构化数据。当您将自定义资源与自定义控制器相结合时，自定义资源提供了真正的声明性API。一个<a class="ae kl" href="https://kubernetes.io/docs/concepts/overview/kubernetes-api/" rel="noopener ugc nofollow" target="_blank">声明式API </a>允许您声明或指定您的资源的期望状态，并试图保持Kubernetes对象的当前状态与期望状态同步。控制器将结构化数据解释为用户期望状态的记录，并持续保持该状态。</p><p id="164a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">操作符是一种打包、部署和管理Kubernetes应用程序的方法</p><p id="f6ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，当定制控制器在本地Kubernetes资源和事件上操作和监听时，操作员使用定制资源定义(CRD)，即用户为解决复杂的业务问题而创建的资源。操作员可以被认为是人类操作员的替代品。知道应用程序的技术细节，也知道业务需求并据此行动的人。</p><p id="5a9e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">安装OLM和CouchDB操作器</strong></p><p id="b221" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将在IKS部署一个用于CouchDB安装的操作员。CouchDB安装需要操作员和一些其他先决条件。</p><p id="a435" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">CouchDB操作员管理CouchDB集群安装的每一步。此后，它管理CouchDB集群的健康和集群仲裁。</p><p id="8be9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要安装操作符，您必须安装<a class="ae kl" href="https://github.com/operator-framework/operator-lifecycle-manager" rel="noopener ugc nofollow" target="_blank">操作符生命周期管理器</a> (OLM)，这是Red Hat的一个工具，用于帮助管理在您的集群上运行的操作符。运行以下命令来安装OLM和CouchDB操作符</p><blockquote class="lc ld le"><p id="1afb" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated">curl-sL<a class="ae kl" href="https://github.com/operator-framework/operator-lifecycle-manager/releases/download/$OLM_RELEASE/install.sh" rel="noopener ugc nofollow" target="_blank">https://github . com/operator-framework/operator-life cycle-manager/releases/download/$ OLM _ RELEASE/install . sh</a>| bash-s $ OLM _ RELEASE</p><p id="7626" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated">https://operatorhub.io/install/couchdb-operator.yaml</p><p id="3b00" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated">kubectl获取csv -n运算符</p></blockquote><p id="2795" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">治疗床DB的操作器安装在一个单独的名称空间中，如下图所示(见图中突出显示的行)。另请参见部署在Operators名称空间中的CouchDB Operator pod。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/2dc4c6450da42d022abc2f4c291bcb13.png" data-original-src="https://miro.medium.com/v2/resize:fit:902/format:webp/1*ZWaZCEfYDDhvSi4ldX1UeQ.png"/></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">运算符作为单独的命名空间</figcaption></figure><p id="6c70" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">安装CouchDB集群</strong></p><p id="efa1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用CouchDB操作符，我们安装了CouchDB集群。CouchDB集群部署在一个单独的名称空间上。下面显示了CouchDB集群和集群的相关pod的详细信息。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ly"><img src="../Images/e3689d3604f3b5ca351f83a297d05d5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PVKInrybJokSCVtNhsEelQ.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">CouchDB集群和Pod详细信息</figcaption></figure><p id="1a40" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">couch db集群的Velero备份</strong></p><p id="5eb1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们运行相同的Velero命令来备份CouchDB集群。请注意，我们使用-include-namespace选项来指定集群。我们不需要使用pod选择器，因为所有的pod都是类似的CouchDB集群的一部分。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ly"><img src="../Images/b29abbbc3d8e9cf9755341eda378f1ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JKhUp4TRHbs3pCPvmdmoDQ.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">使用Velero备份CouchDB集群</figcaption></figure><p id="3adc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是COS bucket中的图像，显示了CouchDB备份的文件。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ly"><img src="../Images/54cf322dda2b737cd52b4610c84681fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1YZ8EBaAhAjBydhQEtITuw.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">COS中的CouchDB备份</figcaption></figure><p id="2a6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">couch db集群的Velero恢复</strong></p><p id="fcef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们不会删除CouchDB的所有名称空间和所有关联的pod，以便运行Velero restore命令来恢复所有集群。操作员和OLM不会被移除，将保持不变。现在，我们将从COS中的备份中恢复CouchDB。下图显示了Velero中可用的备份以及运行restore命令后的结果。您会注意到名称空间(hun-couchDB突出显示)已恢复。现在，CouchDB集群恢复了之前集群中的所有三个pod。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ly"><img src="../Images/3aff05f7456c5ba12723e15a50b50c2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o1aCWMuOpb9YOyzkguj1Pw.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">使用Velero恢复CouchDB</figcaption></figure><p id="2fa2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望这些插图能够让您清楚地了解Velero及其功能，以及如何使用正确的技术轻松部署。</p><h2 id="cc45" class="lo lp iq bd mk ml mm dn mn mo mp dp mq jy mr ms mt kc mu mv mw kg mx my mz na bi translated">结论</h2><p id="b430" class="pw-post-body-paragraph jn jo iq jp b jq nb js jt ju nc jw jx jy nd ka kb kc ne ke kf kg nf ki kj kk ij bi translated"><em class="lf">免责声明:在结束之前，我想就Velero作为运行在Kubernetes上的云本地有状态应用程序的备份和恢复解决方案发表一下我个人的看法。</em></p><p id="dcef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们有各种各样的行业供应商，他们一直在销售备份和恢复产品。我曾经尝试使用Kubernetes的一个主要供应商的备份产品，但是我可以说它与Kubernetes的耦合非常松散。它在每个工作节点内运行一个客户端pod，该pod与它的主/媒体服务器通信，并且该pod需要被映射到持久卷(PV ),该持久卷被映射到应用程序。同一个pod也可以在您的应用程序pod中作为边车容器运行。这些对应用程序pod及其PVs的严重依赖必然会成为一种限制和障碍。</p><p id="b769" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Velero与Kubernetes API紧密结合。从架构的角度来看，Velero有一个服务器组件，它可以作为名称空间部署在您的集群中，这本身就为它提供了多租户功能，并与不同名称空间中的其他工作负载相隔离。它在使用标签:选择器和名称空间等进行备份时引入了粒度。您可以运行一个高效的Kubernetes多租户工作负载环境，Velero也是该集群的一部分，为您的所有应用程序创建备份策略。</p><p id="4a08" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我相信这篇文章已经阐明了Velero的一些特性和功能，将来还会有更多关于Velero与Kubernetes更详细集成的文章和讨论。</p></div></div>    
</body>
</html>