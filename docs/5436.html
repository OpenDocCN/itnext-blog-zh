<html>
<head>
<title>Breaking down and fixing etcd cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">分解和修复etcd集群</h1>
<blockquote>原文：<a href="https://itnext.io/breaking-down-and-fixing-etcd-cluster-d81e35b9260d?source=collection_archive---------0-----------------------#2021-03-05">https://itnext.io/breaking-down-and-fixing-etcd-cluster-d81e35b9260d?source=collection_archive---------0-----------------------#2021-03-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/8dc605cf858ebecb681898c3e253bd69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zp50MnKH708J9vYm.png"/></div></div></figure><p id="0771" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">etcd 是一个快速、可靠、容错的键值数据库。它是Kubernetes的核心，也是其控制平面不可或缺的一部分。拥有备份和恢复单个节点和整个etcd集群的可操作性的经验非常重要。</p><p id="6265" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/breaking-down-and-fixing-kubernetes-4df2f22f87c3">上一篇文章</a>中，我们详细讨论了为Kubernetes重新生成SSL证书和静态清单，以及与恢复其控制平面的可操作性相关的问题。本文将完全致力于恢复etcd集群。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="e9b5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，我应该做一个保留，我们将只考虑一个特定的情况，当etcd在Kubernetes的一部分被部署和直接使用时。本文中给出的例子假设您的etcd集群是使用静态清单部署的，并在容器中运行。</p><p id="3ff5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了清楚起见，让我们采用来自<a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/breaking-down-and-fixing-kubernetes-4df2f22f87c3">上一篇文章</a>的堆叠控制平面节点方案:</p><figure class="lf lg lh li gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi le"><img src="../Images/6b63e26c26e966f42441837746528705.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*T2ZwqZWoyB9LF1n3.png"/></div></div><figcaption class="lj lk gj gh gi ll lm bd b be z dk translated">(箭头表示客户端到服务器的连接)</figcaption></figure><p id="c2ef" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面建议的命令也可以使用kubectl执行，但是在我们的例子中，我们将尝试从Kubernetes控制平面中抽象出来，并考虑使用crictl本地管理容器化etcd集群的选项。</p><p id="00b1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">即使在Kubernetes API不工作的情况下，这项技能也将有助于修复etcd。</p><h1 id="593b" class="ln lo iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">准备</h1><p id="9ac2" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">因此，我们要做的第一件事是在一个主节点上通过ssh登录，并找到我们的etcd容器:</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="6344" class="mv lo iq mr b gy mw mx l my mz">CONTAINER_ID=$(crictl ps -a --label io.kubernetes.container.name=etcd --label io.kubernetes.pod.namespace=kube-system | awk 'NR&gt;1{r=$1} $0~/Running/{exit} END{print r}')</span></pre><p id="f427" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们还设置一个别名，不要在每个our命令中传递证书选项:</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="5276" class="mv lo iq mr b gy mw mx l my mz">alias etcdctl='crictl exec "$CONTAINER_ID" etcdctl --cert /etc/kubernetes/pki/etcd/peer.crt --key /etc/kubernetes/pki/etcd/peer.key --cacert /etc/kubernetes/pki/etcd/ca.crt'</span></pre><p id="69f0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="na">以上命令是临时的。在使用etcd进行操作之前，您每次都需要运行它们。当然，你可以把它们加到</em> <strong class="ka ir"> <em class="na">。为了您的方便，bashrc </em> </strong> <em class="na">。但是，这已经超出了本文的范围。</em></p><blockquote class="nb nc nd"><p id="15a8" class="jy jz na ka b kb kc kd ke kf kg kh ki ne kk kl km nf ko kp kq ng ks kt ku kv ij bi translated"><em class="iq">如果有什么地方出错了，并且您不能执行到一个正在运行的容器中，请查看etcd日志:</em></p><p id="12ae" class="jy jz na ka b kb kc kd ke kf kg kh ki ne kk kl km nf ko kp kq ng ks kt ku kv ij bi translated"><code class="fe nh ni nj mr b"><em class="iq">crictl logs "$CONTAINER_ID"</em></code></p><p id="3a9e" class="jy jz na ka b kb kc kd ke kf kg kh ki ne kk kl km nf ko kp kq ng ks kt ku kv ij bi translated"><em class="iq">还要确保您有一个静态清单和所有证书，以防容器不存在。有时候阅读kubelet日志也非常有用。</em></p></blockquote><h1 id="3b46" class="ln lo iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">检查集群状态</h1><p id="413d" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">在这一点上很简单:</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="da51" class="mv lo iq mr b gy mw mx l my mz"># etcdctl member list -w table<br/>+------------------+---------+-------+---------------------------+---------------------------+------------+<br/>|        ID        | STATUS  | NAME  |        PEER ADDRS         |       CLIENT ADDRS        | IS LEARNER |<br/>+------------------+---------+-------+---------------------------+---------------------------+------------+<br/>| 409dce3eb8a3c713 | started | node1 | https://10.20.30.101:2380 | https://10.20.30.101:2379 |      false |<br/>| 74a6552ccfc541e5 | started | node2 | https://10.20.30.102:2380 | https://10.20.30.102:2379 |      false |<br/>| d70c1c10cb4db26c | started | node3 | https://10.20.30.103:2380 | https://10.20.30.103:2379 |      false |<br/>+------------------+---------+-------+---------------------------+---------------------------+------------+</span></pre><p id="d0c7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">每个etcd实例都知道彼此的一切。关于成员的信息存储在etcd内部，因此其中的任何变化也会更新集群的其他实例。</p><p id="0ff8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">重要提示</strong>,<code class="fe nh ni nj mr b">member list</code>命令只显示配置状态，而不是具体实例的状态。为了检查实例的状态，有一个<code class="fe nh ni nj mr b">endpoint status</code>命令。但是，它需要明确指定要检查的集群的所有端点。</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="4018" class="mv lo iq mr b gy mw mx l my mz">ENDPOINTS=$(etcdctl member list | grep -o '[^ ]\+:2379' | paste -s -d,)<br/>etcdctl endpoint status --endpoints=$ENDPOINTS -w table</span></pre><p id="10eb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果有任何端点不可访问，您将会看到以下错误:</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="2495" class="mv lo iq mr b gy mw mx l my mz">Failed to get the status of endpoint https://10.20.30.103:2379 (context deadline exceeded)</span></pre><h1 id="5e37" class="ln lo iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">移除故障节点</h1><p id="2e31" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">有时会发生其中一个节点无法运行的情况。而你需要恢复etcd集群的可操作性，那么该怎么做呢？</p><p id="cb64" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，您需要删除失败的成员:</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="5623" class="mv lo iq mr b gy mw mx l my mz">etcdctl member remove d70c1c10cb4db26c</span></pre><p id="4dc8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在继续之前，让我们确保etcd容器不再在故障节点上运行，并且该节点不再包含任何数据:</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="09c5" class="mv lo iq mr b gy mw mx l my mz">rm -rf /etc/kubernetes/manifests/etcd.yaml /var/lib/etcd/<br/>crictl rm "$CONTAINER_ID"</span></pre><p id="08da" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上面的命令将删除etcd的静态pod和节点上的数据目录<code class="fe nh ni nj mr b">/var/lib/etcd</code>。</p><p id="ea1c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当然，你也可以使用<code class="fe nh ni nj mr b">kubeadm reset</code>命令作为替代。但是，它也将从该节点中删除所有与Kubernetes相关的资源和证书。</p><h1 id="8ed7" class="ln lo iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">添加新节点</h1><p id="03f3" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">现在我们有两种方法:</p><p id="bfa2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">在第一种情况下</strong>，我们可以使用标准的<code class="fe nh ni nj mr b">kubeadm join</code>机制简单地添加一个新的控制平面节点:</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="8757" class="mv lo iq mr b gy mw mx l my mz">kubeadm init phase upload-certs --upload-certs<br/>kubeadm token create --print-join-command --certificate-key &lt;certificate_key&gt;<!-- --> </span></pre><p id="c6ee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上述命令将生成一个命令来加入Kubernetes中的一个新控制平面节点。该案例在【Kubernetes官方文档中有详细描述，无需澄清。</p><p id="41e9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当您从头开始部署一个新节点或执行<code class="fe nh ni nj mr b">kubeadm reset</code>命令后，此选项最方便。</p><p id="64fa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">第二个选项</strong>更准确，因为它允许您考虑并做出仅用于etcd的必要更改。节点上的其他容器不会受到影响。</p><p id="9e5a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，让我们确保我们的节点拥有etcd的有效CA证书:</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="fe4c" class="mv lo iq mr b gy mw mx l my mz">/etc/kubernetes/pki/etcd/ca.{key,crt}</span></pre><p id="e22e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果它不存在，请从集群的其他节点复制它。现在让我们为节点生成其余的证书:</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="4770" class="mv lo iq mr b gy mw mx l my mz">kubeadm init phase certs etcd-healthcheck-client<br/>kubeadm init phase certs etcd-peer<br/>kubeadm init phase certs etcd-server</span></pre><p id="eb71" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并加入集群:</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="ba38" class="mv lo iq mr b gy mw mx l my mz">kubeadm join phase control-plane-join etcd --control-plane</span></pre><p id="119c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了便于理解，上述命令将执行以下步骤:</p><ol class=""><li id="b590" class="nk nl iq ka b kb kc kf kg kj nm kn nn kr no kv np nq nr ns bi translated">向现有etcd集群添加新成员:<br/> <code class="fe nh ni nj mr b">etcdctl member add node3 --endpoints=https://10.20.30.101:2380,https://10.20.30.102:2379 --peer-urls=https://10.20.30.103:2380</code></li><li id="6e82" class="nk nl iq ka b kb nt kf nu kj nv kn nw kr nx kv np nq nr ns bi translated">用选项<br/> <code class="fe nh ni nj mr b">--initial-cluster-state=existing<br/>--initial-cluster=node1=https://10.20.30.101:2380,node2=https://10.20.30.102:2380,node3=https://10.20.30.103:2380</code>为etcd <code class="fe nh ni nj mr b"><strong class="ka ir">/etc/kubernetes/manifests/etcd.yaml</strong></code>生成一个新的静态清单</li></ol><p id="9fd5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这些选项将允许我们的节点自动添加到现有的etcd集群中。</p><h1 id="cf11" class="ln lo iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">创建快照</h1><p id="f83c" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">现在，让我们来看看如何从备份中创建和恢复etcd。</p><p id="03e4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过在任何etcd节点上执行以下命令，可以非常简单地创建备份:</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="c95c" class="mv lo iq mr b gy mw mx l my mz">etcdctl snapshot save /var/lib/etcd/snap1.db</span></pre><p id="348b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意，我故意使用了<code class="fe nh ni nj mr b">/var/lib/etcd</code>，因为这个目录已经被传递到etcd容器中(您可以在静态清单文件<code class="fe nh ni nj mr b">/etc/kubernetes/manifests/etcd.yaml</code>中找到它)</p><p id="18a4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">执行此命令后，您将找到一个快照，其中包含指定路径上的数据。让我们将它保存在一个安全的地方，并看看从备份过程中恢复。</p><h1 id="02fe" class="ln lo iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">从快照恢复</h1><p id="2f98" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">现在让我们来看一个案例，当所有东西都损坏了，我们最终需要从备份中恢复集群。</p><p id="1b89" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们在前面的步骤中创建了一个快照文件<strong class="ka ir"> snap1.db </strong>。现在，让我们从所有节点中完全删除所有etcd静态pod和数据:</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="e539" class="mv lo iq mr b gy mw mx l my mz">rm -rf /etc/kubernetes/manifests/etcd.yaml /var/lib/etcd/member/<br/>crictl rm "$CONTAINER_ID"</span></pre><p id="be74" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们现在又有两条路:</p><p id="9826" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">第一个选项</strong>是创建一个节点etcd集群，并根据上述过程将其余节点加入其中。</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="37d0" class="mv lo iq mr b gy mw mx l my mz">kubeadm init phase etcd local</span></pre><p id="c091" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该命令将使用选项为etcd生成静态清单:</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="91f6" class="mv lo iq mr b gy mw mx l my mz">--initial-cluster-state=new<br/>--initial-cluster=node1=https://10.20.30.101:2380</span></pre><p id="c926" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这样，我们将在一个节点上获得一个全新的etcd集群。</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="e99b" class="mv lo iq mr b gy mw mx l my mz"># etcdctl member list -w table<br/>+------------------+---------+-------+---------------------------+---------------------------+------------+<br/>|        ID        | STATUS  | NAME  |        PEER ADDRS         |       CLIENT ADDRS        | IS LEARNER |<br/>+------------------+---------+-------+---------------------------+---------------------------+------------+<br/>| 1afbe05ae8b5fbbe | started | node1 | https://10.20.30.101:2380 | https://10.20.30.101:2379 |      false |<br/>+------------------+---------+-------+---------------------------+---------------------------+------------+</span></pre><p id="c56b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们在第一个节点上恢复备份:</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="9300" class="mv lo iq mr b gy mw mx l my mz">etcdctl snapshot restore /var/lib/etcd/snap1.db \<br/>  --data-dir=/var/lib/etcd/new<br/>  --name=node1 \<br/>  --initial-advertise-peer-urls=https://10.20.30.101:2380 \<br/>  --initial-cluster=node1=https://10.20.30.101:2380<br/><br/>mv /var/lib/etcd/member /var/lib/etcd/member.old<br/>mv /var/lib/etcd/new/member /var/lib/etcd/member<br/>crictl rm "$CONTAINER_ID"<br/>rm -rf /var/lib/etcd/member.old/ /var/lib/etcd/new/</span></pre><p id="3bd3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在其余节点上，我们将运行命令来加入集群:</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="2293" class="mv lo iq mr b gy mw mx l my mz">kubeadm join phase control-plane-join etcd --control-plane</span></pre><p id="4ed6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">第二个选项</strong>是立即恢复集群所有节点上的备份。为此，请将快照文件复制到所有节点，并执行上述恢复过程。但是在这种情况下，我们需要在etcdctl命令的选项中指定集群的所有节点，例如:</p><p id="cea7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于<strong class="ka ir">节点1 </strong>:</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="07a2" class="mv lo iq mr b gy mw mx l my mz">etcdctl snapshot restore /var/lib/etcd/snap1.db \<br/>  --data-dir=/var/lib/etcd/new \<br/>  --name=node1 \<br/>  --initial-advertise-peer-urls=https://10.20.30.101:2380 \<br/>  --initial-cluster=node1=https://10.20.30.101:2380,node2=https://10.20.30.102:2380,node3=https://10.20.30.103:2380<!-- --> </span></pre><p id="a13a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于<strong class="ka ir">节点2 </strong>:</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="c31b" class="mv lo iq mr b gy mw mx l my mz">etcdctl snapshot restore /var/lib/etcd/snap1.db \<br/>  --data-dir=/var/lib/etcd/new \<br/>  --name=node2 \<br/>  --initial-advertise-peer-urls=https://10.20.30.102:2380 \<br/>  --initial-cluster=node1=https://10.20.30.101:2380,node2=https://10.20.30.102:2380,node3=https://10.20.30.103:2380</span></pre><p id="1d3c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于<strong class="ka ir">节点3 </strong>:</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="777b" class="mv lo iq mr b gy mw mx l my mz">etcdctl snapshot restore /var/lib/etcd/snap1.db \<br/>  --data-dir=/var/lib/etcd/new \<br/>  --name=node3 \<br/>  --initial-advertise-peer-urls=https://10.20.30.103:2380 \<br/>  --initial-cluster=node1=https://10.20.30.101:2380,node2=https://10.20.30.102:2380,node3=https://10.20.30.103:2380</span></pre><h1 id="6829" class="ln lo iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">法定人数的丧失</h1><p id="0919" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">有时会发生这样的情况，您已经失去了集群中的大部分节点，etcd进入了不起作用的状态。您将无法在集群中删除或添加新成员，也无法创建快照。</p><p id="64e8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这种情况是有出路的。你只需要编辑静态清单文件，并添加<code class="fe nh ni nj mr b">--force-new-cluster</code>键到etcd:</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="5749" class="mv lo iq mr b gy mw mx l my mz">/etc/kubernetes/manifests/etcd.yaml</span></pre><p id="0145" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此后，etcd实例将在具有单个实例的集群中重启:</p><pre class="lf lg lh li gt mq mr ms mt aw mu bi"><span id="e04e" class="mv lo iq mr b gy mw mx l my mz"># etcdctl member list -w table<br/>+------------------+---------+-------+---------------------------+---------------------------+------------+<br/>|        ID        | STATUS  | NAME  |        PEER ADDRS         |       CLIENT ADDRS        | IS LEARNER |<br/>+------------------+---------+-------+---------------------------+---------------------------+------------+<br/>| 1afbe05ae8b5fbbe | started | node1 | https://10.20.30.101:2380 | https://10.20.30.101:2379 |      false |<br/>+------------------+---------+-------+---------------------------+---------------------------+------------+</span></pre><p id="38f8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，您需要清理剩余的节点并将其添加到集群中，如上所述。完成这些操作后，请不要忘记取下<code class="fe nh ni nj mr b">--force-new-cluster</code>键；-)</p></div></div>    
</body>
</html>