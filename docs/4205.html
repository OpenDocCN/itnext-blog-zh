<html>
<head>
<title>Source Code Walkthrough of Telegram-iOS Part 3: Other Foundations</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Telegram-iOS源代码演练第3部分:其他基础</h1>
<blockquote>原文：<a href="https://itnext.io/source-code-walkthrough-of-telegram-ios-part-3-other-foundations-66ace05954a4?source=collection_archive---------2-----------------------#2020-05-15">https://itnext.io/source-code-walkthrough-of-telegram-ios-part-3-other-foundations-66ace05954a4?source=collection_archive---------2-----------------------#2020-05-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><blockquote class="jn jo jp"><p id="2a24" class="jq jr js jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated"><a class="ae kp" href="https://hubo.dev/2020-05-15-source-code-walkthrough-of-telegram-ios-part-3/" rel="noopener ugc nofollow" target="_blank"> hubo.dev </a>的镜像</p></blockquote><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi kq"><img src="../Images/a31b03b37244427e21f06390b21059f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*J0t9M0yYewxJV8Hs"/></div></div><figcaption class="lc ld gj gh gi le lf bd b be z dk translated">照片由<a class="ae kp" href="https://unsplash.com/@mirkoblicke?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Mirko Blicke </a>在<a class="ae kp" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="e9fa" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">让我再用一个帖子来完成这个项目的基础模块的介绍。</p><h1 id="1681" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">记录</h1><p id="da3b" class="pw-post-body-paragraph jq jr iq jt b ju mh jw jx jy mi ka kb lg mj ke kf lh mk ki kj li ml km kn ko ij bi translated">模块<code class="fe mm mn mo mp b">TelegramCore</code>提供了一个简单的<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/master/submodules/TelegramCore/Sources/Log.swift" rel="noopener ugc nofollow" target="_blank">日志</a>实现。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="523f" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">如果标志打开，它支持登录到控制台和文件系统。<code class="fe mm mn mo mp b">queue</code>用于在非主线程中运行文件写入。<code class="fe mm mn mo mp b">redactSensitiveData</code>由其他代码决定是否在日志消息中包含敏感数据。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="7945" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">在公共版本中，仍然可以通过上一节介绍的应用内调试控制器来更改设置。</p><p id="e645" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">对于不依赖于TelegramCore的模块，项目设置通过<code class="fe mm mn mo mp b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/master/submodules/TelegramCore/Sources/Network.swift" rel="noopener ugc nofollow" target="_blank">Network.swift</a></code>中的<code class="fe mm mn mo mp b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/master/submodules/TelegramCore/Sources/Network.swift#L156" rel="noopener ugc nofollow" target="_blank">registeredLoggingFunctions</a></code>桥接功能。它将日志调用从<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/master/submodules/MtProtoKit/Sources/MTLogging.m" rel="noopener ugc nofollow" target="_blank"> MtProtoKit </a>、<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/master/submodules/Postbox/Sources/PostboxLogging.swift" rel="noopener ugc nofollow" target="_blank">邮箱</a>和<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/master/submodules/TelegramApi/Sources/TelegramApiLogger.swift" rel="noopener ugc nofollow" target="_blank"> TelegramApi </a>等模块重定向到共享日志记录器。</p><p id="47f4" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">它不是一个甚至不支持日志记录级别的花哨框架。还有很多模块根本不做日志记录或者只是通过<code class="fe mm mn mo mp b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/search?l=Swift&amp;q=print&amp;type=Code" rel="noopener ugc nofollow" target="_blank">print</a></code> / <code class="fe mm mn mo mp b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/search?q=NSLog&amp;type=Code" rel="noopener ugc nofollow" target="_blank">NSLog</a></code>进行日志记录。它可能需要进一步清理海事组织。例如，聊天中打开的URL通过打印记录到系统输出中的<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/commit/d5142c876e084bb2df39f0d56a8c2e12d961f91b#diff-7cef1a32e852176c8b9240cd5e3d5e40R8001" rel="noopener ugc nofollow" target="_blank">最近提交</a>，这听起来不是一个好主意。</p><h1 id="9eca" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">崩溃报告</h1><p id="2747" class="pw-post-body-paragraph jq jr iq jt b ju mh jw jx jy mi ka kb lg mj ke kf lh mk ki kj li ml km kn ko ij bi translated">Telegram不使用第三方SDK来防止<a class="ae kp" href="https://blog.zoom.us/wordpress/2020/03/27/zoom-use-of-facebook-sdk-in-ios-client/" rel="noopener ugc nofollow" target="_blank">用户数据</a>泄露是合理的。让我感到惊讶的是，这个项目没有任何内置的崩溃报告模块，甚至没有一个自己开发的模块。在查看提交历史后，它确实整合了Hockey SDK，然后在今年1月通过commit <code class="fe mm mn mo mp b">bdc0bb2</code>移除了它。工程师可能会依靠AppStore的崩溃报告来检查稳定性问题。</p><p id="05ad" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">Hockey SDK已经被微软淘汰，转而支持<a class="ae kp" href="https://docs.microsoft.com/en-us/appcenter/transition/" rel="noopener ugc nofollow" target="_blank">应用中心</a>。Telegram-iOS使用一个<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/b3ab501a75cd12ff079f32c299dea4a38ac61bba/submodules/TelegramUI/Sources/AppDelegate.swift#L2198" rel="noopener ugc nofollow" target="_blank">应用中心API </a>来检查更新。没有与SDK集成。</p><h1 id="7edd" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">磁盘存储器</h1><p id="af2e" class="pw-post-body-paragraph jq jr iq jt b ju mh jw jx jy mi ka kb lg mj ke kf lh mk ki kj li ml km kn ko ij bi translated">为了支持主应用程序、观察应用程序、意图应用程序扩展之间的数据共享，该项目将大多数数据存储在名为<code class="fe mm mn mo mp b">telegram-data</code>的<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/b3ab501a75cd12ff079f32c299dea4a38ac61bba/submodules/TelegramUI/Sources/AppDelegate.swift#L373" rel="noopener ugc nofollow" target="_blank">组容器文件夹</a>中。一些<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/master/submodules/LegacyComponents/PublicHeaders/LegacyComponents/LegacyComponentsGlobals.h#L56" rel="noopener ugc nofollow" target="_blank">遗留组件</a>仍然使用<code class="fe mm mn mo mp b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/master/submodules/LegacyUI/Sources/TelegramInitializeLegacyComponents.swift#L374" rel="noopener ugc nofollow" target="_blank">Documents</a></code>文件夹。下面是<code class="fe mm mn mo mp b">telegram-data</code>的典型布局:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="a874" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">除了直接读写文件之外，项目对结构化数据大多使用<code class="fe mm mn mo mp b">SQLite</code>。启用了两个SQLite扩展:<code class="fe mm mn mo mp b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/tree/b3ab501a75cd12ff079f32c299dea4a38ac61bba/submodules/sqlcipher" rel="noopener ugc nofollow" target="_blank">SQLCipher</a></code>用于完全数据库加密，而<code class="fe mm mn mo mp b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/master/submodules/Database/ValueBox/Sources/SqliteValueBox.swift#L617" rel="noopener ugc nofollow" target="_blank">FTS5</a></code>用于全文搜索。这种方式在其他流行的信使中也很流行，比如<a class="ae kp" href="https://github.com/Tencent/wcdb" rel="noopener ugc nofollow" target="_blank">微信</a>和<a class="ae kp" href="https://github.com/signalapp/Signal-iOS/tree/master/SignalServiceKit/src/Storage" rel="noopener ugc nofollow" target="_blank"> SignalApp </a>。</p><p id="a6b6" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated"><a class="ae kp" href="http://www.lmdb.tech/doc/" rel="noopener ugc nofollow" target="_blank"> LMDB </a>，一个基于BTree的事务键值存储，为一些Objective-C组件提供:比如<code class="fe mm mn mo mp b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/master/submodules/LegacyComponents/Sources/TGEmbedCoubPlayerView.m" rel="noopener ugc nofollow" target="_blank">TGEmbedCoubPlayerView</a></code>(<a class="ae kp" href="http://coub.com" rel="noopener ugc nofollow" target="_blank">coub.com</a>的嵌入式播放器)，以及负责在发送媒体消息时编辑照片和视频的<code class="fe mm mn mo mp b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/master/submodules/LegacyComponents/Sources/TGMediaEditingContext.m" rel="noopener ugc nofollow" target="_blank">TGMediaEditingContext</a></code>。</p><h1 id="b953" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">网络传输</h1><p id="13f4" class="pw-post-body-paragraph jq jr iq jt b ju mh jw jx jy mi ka kb lg mj ke kf lh mk ki kj li ml km kn ko ij bi translated">消息传递和VoIP呼叫是需要网络传输的两个主要场景。可靠的连接和实时更新是messenger应用程序的重要特征，这是一个迷人的挑战，因为全球网络环境相当复杂。一些工程技巧被发明出来，并在messenger应用程序中广泛应用，如流量混淆、混合端点发现、域名转发等。我会试着在其他文章中写更多关于这个主题的内容。</p><p id="8ebb" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">电报的核心协议<a class="ae kp" href="https://core.telegram.org/mtproto" rel="noopener ugc nofollow" target="_blank"> MTProto </a>，被设计成支持<a class="ae kp" href="https://core.telegram.org/mtproto/transports" rel="noopener ugc nofollow" target="_blank">多种传输协议</a>。目前版本的Telegram-iOS只支持<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/master/submodules/MtProtoKit/Sources/MTTcpTransport.m" rel="noopener ugc nofollow" target="_blank"> TCP传输</a>。HTTP传输在2018年被<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/commit/80c64348dcebe2c972ddfef1e2f78bf3c6109391" rel="noopener ugc nofollow" target="_blank">移除</a>。VoIP模块<code class="fe mm mn mo mp b"><a class="ae kp" href="https://github.com/telegramdesktop/libtgvoip/tree/522550a1e975b17e9048d7a2ab2d5b97cfc2f5d4" rel="noopener ugc nofollow" target="_blank">libtgvoip</a></code>支持UDP和TCP传输。</p><p id="1775" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">Telegram-iOS还利用来自PushKit 的<a class="ae kp" href="https://developer.apple.com/documentation/pushkit/responding_to_voip_notifications_from_pushkit" rel="noopener ugc nofollow" target="_blank"> VoIP通知，通过苹果的网络接收数据。这是另一个广泛使用的技巧，使应用程序能够将数据封装在通知负载中，并在后台处理它，而无需用户交互。正常的APNS无法复制同样的行为。这对于一些核心功能是必不可少的，如更新未读计数，如果应用程序无法连接到后端，检索新的端点，更新实时位置等。</a></p><p id="1c44" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">由于任何滥用都可能导致严重的电池消耗问题，自iOS SDK 13以来，苹果开始要求应用程序在收到VoIP通知后<a class="ae kp" href="https://developer.apple.com/videos/play/wwdc2019/707?time=624" rel="noopener ugc nofollow" target="_blank">调用CallKit </a>。但是Telegram-iOS似乎从新规则中幸存了下来，因为它从苹果那里获得了一项特殊权利。在<a class="ae kp" href="https://github.com/signalapp/Signal-iOS/blob/master/Signal/Signal-AppStore.entitlements#L22" rel="noopener ugc nofollow" target="_blank"> SignalApp </a>中也可以找到相同的未记录权利。</p><h1 id="b816" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">UI框架</h1><p id="c776" class="pw-post-body-paragraph jq jr iq jt b ju mh jw jx jy mi ka kb lg mj ke kf lh mk ki kj li ml km kn ko ij bi translated">除了使用<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/tree/master/submodules/AsyncDisplayKit" rel="noopener ugc nofollow" target="_blank"> AsyncDisplayKit </a>作为其核心UI渲染框架，Telegram-iOS更进一步，用它重新实现了常见的UIKit控制器和视图。大部分UIKit组件都可以在项目内部找到对应的组件:<code class="fe mm mn mo mp b">NavigationController</code>、<code class="fe mm mn mo mp b">TabBarController</code>、<code class="fe mm mn mo mp b">AlertController</code>、<code class="fe mm mn mo mp b">ActionSheetController</code>、<code class="fe mm mn mo mp b">NavigationBar</code>、<code class="fe mm mn mo mp b">ItemListController</code>(替换UITableViewController)等。这种方法相当合理，一旦你被主要iOS版本中系统控制器的不一致行为所困扰。</p><blockquote class="jn jo jp"><p id="43d5" class="jq jr js jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">跑题了。有趣的是，大多数iOS工程师最终会在UIKit上学习一些swizzing技巧。不知何故，重新实现像UINavigationController这样的组件并不像破解原始组件那样简单。我最喜欢的一个细节是UINavigationController如何设法推动和弹出一个只支持风景的控制器。</p></blockquote><p id="f4a4" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">关于UI属性动画，<code class="fe mm mn mo mp b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/master/submodules/LegacyComponents/Sources/POPAnimation.mm" rel="noopener ugc nofollow" target="_blank">POP</a></code>是Objective-C中<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/tree/master/submodules/LegacyComponents" rel="noopener ugc nofollow" target="_blank">遗留UI组件</a>的动画，而swift模块大多在<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/master/submodules/Display/Source/DisplayLinkAnimator.swift" rel="noopener ugc nofollow" target="_blank"> CADisplayLink </a>或<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/master/submodules/Display/Source/CAAnimationUtils.swift" rel="noopener ugc nofollow" target="_blank"> CoreAnimation </a>上使用自己的animator实现。</p><p id="5680" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">这款应用内置了两个洛蒂库<code class="fe mm mn mo mp b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/tree/master/submodules/rlottie" rel="noopener ugc nofollow" target="_blank">rlottie</a></code>和<code class="fe mm mn mo mp b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/tree/master/submodules/lottie-ios" rel="noopener ugc nofollow" target="_blank">lottie-ios</a></code>，以支持后期效果动画。<code class="fe mm mn mo mp b">rlottie</code>主要用于<code class="fe mm mn mo mp b">tgs</code>格式的<a class="ae kp" href="https://telegram.org/blog/animated-stickers" rel="noopener ugc nofollow" target="_blank">动画贴纸</a>。<code class="fe mm mn mo mp b">Lottie-ios</code>用于从<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/tree/master/submodules/TelegramUI/Resources/Animations" rel="noopener ugc nofollow" target="_blank">捆绑资源</a>中加载动画文件。看起来实际上没有必要为同一件事创建两个库，<code class="fe mm mn mo mp b">lottie-ios</code>可以被<code class="fe mm mn mo mp b">rlottie</code>代替。</p><h1 id="a1b0" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">单元测试</h1><p id="7daf" class="pw-post-body-paragraph jq jr iq jt b ju mh jw jx jy mi ka kb lg mj ke kf lh mk ki kj li ml km kn ko ij bi translated">项目中基本没有单元测试。</p><h1 id="32ef" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">应用内调试</h1><p id="c96a" class="pw-post-body-paragraph jq jr iq jt b ju mh jw jx jy mi ka kb lg mj ke kf lh mk ki kj li ml km kn ko ij bi translated">点击设置10次会出现<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/master/submodules/SettingsUI/Sources/DebugController.swift" rel="noopener ugc nofollow" target="_blank">调试控制器</a>，在这里可以调整<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/master/submodules/TelegramCore/Sources/LoggingSettings.swift" rel="noopener ugc nofollow" target="_blank">日志设置</a>，收集日志，尝试<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/master/submodules/TelegramUIPreferences/Sources/ExperimentalUISettings.swift" rel="noopener ugc nofollow" target="_blank">实验UI设置</a>等。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/ab92bfd6ba3143b3678baa7a9286df93.png" data-original-src="https://miro.medium.com/v2/resize:fit:592/format:webp/1*gcRu7EqWt6bOtlLvNlGv2g.jpeg"/></div></figure></div></div>    
</body>
</html>