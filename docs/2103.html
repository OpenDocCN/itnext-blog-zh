<html>
<head>
<title>Azure Kubernetes Service (AKS) Observability with Istio Service Mesh</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure Kubernetes服务(AKS)与Istio服务网格的可观察性</h1>
<blockquote>原文：<a href="https://itnext.io/azure-kubernetes-service-aks-observability-with-istio-service-mesh-4eb28da0f764?source=collection_archive---------2-----------------------#2019-04-01">https://itnext.io/azure-kubernetes-service-aks-observability-with-istio-service-mesh-4eb28da0f764?source=collection_archive---------2-----------------------#2019-04-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="15e2" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Jaeger、Prometheus、Grafana和Kiali在Azure的AKS和Istio服务网格上观察分布式系统</h2></div><p id="dbba" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在上一篇由两部分组成的文章<a class="ae le" rel="noopener ugc nofollow" target="_blank" href="/kubernetes-based-microservice-observability-with-istio-service-mesh-part-1-bed3dd0fac0b">中，我们将Istio及其观察工具Prometheus、Grafana、Jaeger和Kiali部署到Google Kubernetes引擎(GKE)中。在那篇帖子之后，我收到了几个关于在其他流行的托管Kubernetes平台上使用Istio的可观察性工具的问题，主要是</a><a class="ae le" href="https://azure.microsoft.com/en-us/services/kubernetes-service/" rel="noopener ugc nofollow" target="_blank"> Azure Kubernetes服务</a> (AKS)。在大多数情况下，包括AKS，Istio和可观察性工具都是兼容的。</p><p id="1ec2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在上一篇文章的后续文章中，我们将替换上一篇文章第一部分中的GKE集群设置命令，用新的命令在Azure上提供类似的AKS集群。新的AKS集群将运行Istio 1.1.3，<a class="ae le" href="https://istio.io/about/notes/1.1.3/" rel="noopener ugc nofollow" target="_blank">2019年4月15日发布的</a>，以及AKS (Kubernetes)的最新可用版本1.12.6。我们将用Azure Monitor日志取代Google的Stackdriver日志。我们将保留外部MongoDB Atlas集群和外部CloudAMQP集群依赖关系。</p><p id="ce97" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">之前关于AKS的文章包括<a class="ae le" href="https://programmaticponderings.com/2017/11/20/first-impressions-of-aks-azures-new-managed-kubernetes-container-service/" rel="noopener ugc nofollow" target="_blank">AKS的第一印象，Azure的新托管Kubernetes容器服务</a>(2017年11月)和<a class="ae le" href="https://programmaticponderings.com/2017/12/10/architecting-cloud-optimized-apps-with-aks-azures-managed-kubernetes-azure-service-bus-and-cosmos-db/" rel="noopener ugc nofollow" target="_blank">用AKS (Azure的托管Kubernetes)、Azure服务总线和Cosmos DB </a>架构云优化的应用(2017年12月)。</p><h1 id="cfa1" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">源代码</h1><p id="a7f5" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">这篇文章的所有源代码都可以在GitHub的两个项目中找到。基于Go的微服务源代码、所有Kubernetes资源和所有部署脚本都位于<a class="ae le" href="https://github.com/garystafford/k8s-istio-observe-backend" rel="noopener ugc nofollow" target="_blank">k8s-istio-observe-back end</a>项目存储库中。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="1547" class="ml lg it mh b gy mm mn l mo mp">git clone \<br/>  --branch master --single-branch \<br/>  --depth 1 --no-tags \<br/>  <a class="ae le" href="https://github.com/garystafford/k8s-istio-observe-backend.git" rel="noopener ugc nofollow" target="_blank">https://github.com/garystafford/k8s-istio-observe-backend.git</a></span></pre><p id="dd0a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">基于Angular UI <a class="ae le" href="https://en.wikipedia.org/wiki/TypeScript" rel="noopener ugc nofollow" target="_blank">类型脚本的</a>源代码位于<a class="ae le" href="https://github.com/garystafford/k8s-istio-observe-frontend" rel="noopener ugc nofollow" target="_blank">k8s-istio-observe-frontend</a>库中。对于本文的演示，您不需要克隆Angular UI项目。</p><h1 id="334d" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">设置</h1><p id="b88f" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">这篇文章假设你有一个注册了必要资源提供者的Microsoft Azure帐户，并且已经安装了<a class="ae le" href="https://docs.microsoft.com/en-us/cli/azure/?view=azure-cli-latest" rel="noopener ugc nofollow" target="_blank"> Azure命令行界面</a>(CLI)<code class="fe mq mr ms mh b">az</code>，并且可以用于你的命令shell。你还需要安装和配置<a class="ae le" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank">头盔</a>和<a class="ae le" href="https://github.com/istio/istio/releases/tag/1.1.3" rel="noopener ugc nofollow" target="_blank"> Istio 1.1.3 </a>，这将在上一篇文章中介绍。</p><figure class="mc md me mf gt mu gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/44071ad99fdc10d2a948ee42ec00ab0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*IiHmH81dNMNLK_Y8"/></div></figure><p id="ae0a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，从您的命令shell登录Azure。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="13a7" class="ml lg it mh b gy mm mn l mo mp">az login \<br/>  --username {{ your_username_here }} \<br/>  --password {{ your_password_here }}</span></pre><h1 id="5fdf" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">资源提供者</h1><p id="60ac" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">如果你是Azure或AKS的新手，你可能需要注册一些额外的<a class="ae le" href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-supported-services" rel="noopener ugc nofollow" target="_blank">资源提供者</a>来完成这个演示。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="0b43" class="ml lg it mh b gy mm mn l mo mp">az provider list --output table</span></pre><figure class="mc md me mf gt mu gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/666c15171fd450a0256efdea422739d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*gNCsgv6yJ5tokRkr"/></div></figure><p id="f20b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您缺少必需的资源提供程序，您将会看到类似下面所示的错误。只需激活与错误对应的特定提供程序。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="ce8b" class="ml lg it mh b gy mm mn l mo mp">Operation failed with status:'Bad Request'. <br/>Details: Required resource provider registrations <br/><strong class="mh iu">Microsoft.Compute</strong>, <strong class="mh iu">Microsoft.Network</strong> are missing.</span></pre><p id="451e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要注册必要的提供者，请使用Azure CLI或Azure Portal UI。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="a7a8" class="ml lg it mh b gy mm mn l mo mp">az provider register --namespace Microsoft.ContainerService<br/>az provider register --namespace Microsoft.Network<br/>az provider register --namespace Microsoft.Compute</span></pre><h1 id="0271" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">资源组</h1><p id="d356" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">AKS需要一个<a class="ae le" href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-overview" rel="noopener ugc nofollow" target="_blank"> Azure资源组</a>。根据Azure的说法，资源组是一个容器，保存Azure解决方案的相关资源。资源组包括那些要作为一个组来管理的资源。我选择使用Azure CLI创建一个与我最近的地理位置<a class="ae le" href="https://azure.microsoft.com/en-us/global-infrastructure/regions/" rel="noopener ugc nofollow" target="_blank"> Azure区域</a>美国东部相关联的新资源组。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="45fa" class="ml lg it mh b gy mm mn l mo mp">az group create \<br/>  --resource-group aks-observability-demo \<br/>  --location eastus</span></pre><figure class="mc md me mf gt mu gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/1894b3d5bcebbd1ae4d8d3e8181dc727.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*oxkADqk47kEoXUvj"/></div></figure><h1 id="57e3" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">创建AKS集群</h1><p id="eeaf" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">在创建GKE集群之前，请检查AKS的最新版本。在这篇文章发表时，AKS的最新版本是1.12.6。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="eced" class="ml lg it mh b gy mm mn l mo mp">az aks get-versions \<br/>  --location eastus \<br/>  --output table</span></pre><figure class="mc md me mf gt mu gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/b125b81760f0e9c9c9a096357f1c974f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*gGwclmhD4RwtW_Rp"/></div></figure><p id="55c1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用最新的GKE版本，创建GKE管理的集群。<code class="fe mq mr ms mh b">az aks create</code>命令有许多可用的配置选项。在这篇文章中，我将使用Azure <a class="ae le" href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes-general#dsv2-series" rel="noopener ugc nofollow" target="_blank"> Standard_DS3_v2 </a> VM类型创建三个worker节点，这将为我们提供总共12个vCPUs和42 GB的内存。任何更小的和所有的pod可能都是不可调度的。我将让Azure创建一个新的SSH密钥，而不是提供现有的SSH密钥。您应该不需要SSH到工作节点。我还启用了<a class="ae le" href="https://docs.microsoft.com/en-us/azure/azure-monitor/insights/container-insights-onboard" rel="noopener ugc nofollow" target="_blank">监控插件</a>。根据Azure的说法，该插件为容器设置了<a class="ae le" href="https://azure.microsoft.com/en-us/services/monitor/" rel="noopener ugc nofollow" target="_blank"> Azure Monitor </a>，于2018年12月宣布，它可以监控部署到AKS上托管的Kubernetes环境的工作负载的性能。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="8243" class="ml lg it mh b gy mm mn l mo mp">time az aks create \<br/>  --name aks-observability-demo \<br/>  --resource-group aks-observability-demo \<br/>  --node-count 3 \<br/>  --node-vm-size Standard_DS3_v2 \<br/>  --enable-addons monitoring \<br/>  --generate-ssh-keys \<br/>  --kubernetes-version 1.12.6</span></pre><p id="61d8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用<code class="fe mq mr ms mh b">time</code>命令，我们观察到集群需要大约5分48秒的时间来进行配置；我见过长达10分钟的时间。AKS资源调配不如GKE快，根据我的经验，对于类似规模的群集，后者至少比AKS快2-3倍。</p><figure class="mc md me mf gt mu gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/4cf80b8d48905426f82f85f6c336ea76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*nkCpwKGreup27INk"/></div></figure><p id="29ec" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">集群创建完成后，检索您的AKS集群凭据。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="e27a" class="ml lg it mh b gy mm mn l mo mp">az aks get-credentials \<br/>  --name aks-observability-demo \<br/>  --resource-group aks-observability-demo \<br/>  --overwrite-existing</span></pre><h1 id="2636" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">检查集群</h1><p id="edca" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">使用以下命令，通过检查三个工作节点的状态来确认集群准备就绪。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="1d1c" class="ml lg it mh b gy mm mn l mo mp">kubectl get nodes --output=wide</span></pre><figure class="mc md me mf gt mu gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/f645d8083238b0c792e58569d9e6935a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*Qzvo44bzW7hOVnJT"/></div></figure><p id="dbfe" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意Azure目前使用<a class="ae le" href="http://releases.ubuntu.com/16.04/" rel="noopener ugc nofollow" target="_blank"> Ubuntu 16.04.5 LTS </a>作为worker节点的主机操作系统。如果你还记得的话，GKE提供了Ubuntu和谷歌的容器优化操作系统。</p><h2 id="f874" class="ml lg it bd lh mx my dn ll mz na dp lp kr nb nc lr kv nd ne lt kz nf ng lv nh bi translated">Kubernetes仪表板</h2><p id="ca4f" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">不像<a class="ae le" href="https://cloud.google.com/kubernetes-engine/docs/concepts/dashboards" rel="noopener ugc nofollow" target="_blank"> GKE </a>，没有定制的AKS仪表盘。因此，我们将使用<a class="ae le" href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" rel="noopener ugc nofollow" target="_blank">Kubernetes Web UI</a>(dashboard)，它默认与AKS一起安装，不像GKE。根据<a class="ae le" href="https://docs.microsoft.com/en-us/azure/aks/kubernetes-dashboard#for-rbac-enabled-clusters" rel="noopener ugc nofollow" target="_blank"> Azure </a>的说法，为了充分利用仪表盘，由于AKS集群使用<a class="ae le" href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/" rel="noopener ugc nofollow" target="_blank"> RBAC </a>，所以必须先创建一个ClusterRoleBinding，才能正确访问仪表盘。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="7f72" class="ml lg it mh b gy mm mn l mo mp">kubectl create clusterrolebinding kubernetes-dashboard \<br/>  --clusterrole=cluster-admin \<br/>  --serviceaccount=kube-system:kubernetes-dashboard</span></pre><p id="1940" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们必须在本地端口<code class="fe mq mr ms mh b">8001</code>上创建一个代理隧道，连接到运行在AKS集群上的仪表板。这个CLI命令在您的本地系统和Kubernetes API之间创建一个代理，并打开您的web浏览器到Kubernetes仪表板。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="b144" class="ml lg it mh b gy mm mn l mo mp">az aks browse \<br/>  --name aks-observability-demo \<br/>  --resource-group aks-observability-demo</span></pre><figure class="mc md me mf gt mu gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/0d54cc2aa08a90222e4eec446c1e2a8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*qRvQXip7AgA-Hg6S"/></div></figure><p id="6fdc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">尽管您应该使用Azure CLI、PowerShell或<a class="ae le" href="https://azure.microsoft.com/en-us/downloads/" rel="noopener ugc nofollow" target="_blank"> SDK </a>来完成所有AKS配置任务，但使用仪表板来监控集群和其上运行的资源是非常宝贵的。</p><figure class="mc md me mf gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi mt"><img src="../Images/a38f0abb884e2e80fcc7b832d64a7188.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*WBRZhUqKZ8eFSTY2"/></div></div></figure><p id="2e73" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Kubernetes仪表板还提供对原始容器日志的访问。Azure Monitor提供了构建复杂日志查询的能力，但为了快速排除故障，您可能只想从仪表板中查看特定容器输出的原始日志。</p><figure class="mc md me mf gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi mt"><img src="../Images/177da84e051753fb6d524dd78e39e268.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*HJbzslCRJIdOhXJ0"/></div></div></figure><h2 id="7dd7" class="ml lg it bd lh mx my dn ll mz na dp lp kr nb nc lr kv nd ne lt kz nf ng lv nh bi translated">Azure门户</h2><p id="bf26" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">登录到<a class="ae le" href="https://azure.microsoft.com/en-us/features/azure-portal/" rel="noopener ugc nofollow" target="_blank"> Azure门户</a>，我们可以观察到新资源组中的AKS集群。</p><figure class="mc md me mf gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi mt"><img src="../Images/e0027eb2a9ae55345d50545aac3c2b4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*SPfu5yUYEWI91Cji"/></div></div></figure><p id="6297" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">除了我们创建的Azure资源组之外，在AKS集群的创建过程中还会自动创建第二个资源组。该组包含组成AKS集群的所有资源。这些资源包括三个工作节点虚拟机实例，以及它们对应的存储磁盘和网卡。该组还包括网络安全组、路由表、虚拟网络和一个<a class="ae le" href="https://social.technet.microsoft.com/wiki/contents/articles/51828.azure-vms-availability-sets-and-availability-zones.aspx#Availability_Set" rel="noopener ugc nofollow" target="_blank">可用性集</a>。</p><figure class="mc md me mf gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi mt"><img src="../Images/817dd02032b1ad3189283262e5dab3f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*3rZvH2Uys8isy1Y0"/></div></div></figure><h1 id="912d" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">部署Istio</h1><p id="9ce2" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">从这一点开始，部署Istio服务网格和基于Go的微服务平台的过程遵循上一篇文章，并使用完全相同的脚本。修改Kubernetes资源文件后，要部署Istio，使用bash脚本，<a class="ae le" href="https://github.com/garystafford/golang-srv-demo/blob/master/part4_install_istio.sh" rel="noopener ugc nofollow" target="_blank"> part4_install_istio.sh </a>。我在脚本中添加了更多的停顿，以解释AKS相对于GKE明显较慢的响应时间。在AKS上启动Istio资源肯定要比在GKE上花费更长的时间，如果您不在部署过程的每个阶段之间暂停，这可能会导致错误。</p><figure class="mc md me mf gt mu gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/4fbe7374c0a82e5ea407d8112c462f78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*ectMZV9fUHbLR5-A"/></div></figure><figure class="mc md me mf gt mu gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/61d6a560a95d841c128d164014a1171b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*MyhmamLHD-6ZMe7T"/></div></figure><p id="83a1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用Kubernetes仪表板，我们可以查看在<code class="fe mq mr ms mh b">istio-system</code>名称空间中运行的Istio资源，如下所示。在部署基于Go的微服务平台之前，请确认所有的资源容器都在运行并且状况良好。</p><figure class="mc md me mf gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi mt"><img src="../Images/1980429ec6f861892c5b09dcaf891cec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*_1QRM_KqhdO9ez4Z"/></div></div></figure><h1 id="4e86" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">部署平台</h1><p id="64b8" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">使用bash部署脚本<a class="ae le" href="https://github.com/garystafford/golang-srv-demo/blob/master/part5a_deploy_resources.sh" rel="noopener ugc nofollow" target="_blank">part5a _ deploy _ resources . sh</a>部署基于Go的微服务平台。</p><figure class="mc md me mf gt mu gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/0070d0e22dd6d73a9c33eaac2dfb88ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*pIvYNYnTLl2FiokO"/></div></figure><p id="d4af" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该脚本将八个微服务(Service-A到Service-H)和Angular UI中的每一个的两个副本(pod)部署到<code class="fe mq mr ms mh b">dev</code>和<code class="fe mq mr ms mh b">test</code>名称空间，总共36个pod。每个Pod都将有一个<a class="ae le" href="https://istio.io/docs/concepts/what-is-istio/#envoy" rel="noopener ugc nofollow" target="_blank"> Istio sidecar代理</a>(特使代理)注入其中，与微服务或UI放在一起。</p><figure class="mc md me mf gt mu gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/4105ace3c2db7ed2aa82a6e0ed797a25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*kx-muXdOzf7d851m"/></div></figure><h2 id="daae" class="ml lg it bd lh mx my dn ll mz na dp lp kr nb nc lr kv nd ne lt kz nf ng lv nh bi translated">Azure负载平衡器</h2><p id="8678" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">如果我们返回到创建AKS集群时自动创建的资源组，我们现在将看到两个额外的资源。现在有了一个<a class="ae le" href="https://azure.microsoft.com/en-us/services/load-balancer/" rel="noopener ugc nofollow" target="_blank"> Azure负载平衡器</a>和公共IP地址。</p><figure class="mc md me mf gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi mt"><img src="../Images/9d3dcd065c1f6d7b0ef847ed5a2e5ca3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*B6PqMQtgmjc5sJsS"/></div></div></figure><p id="41c4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">类似于上一篇文章中的GKE集群，当Istio入口网关作为平台的一部分部署时，它被具体化为一个<a class="ae le" href="https://azure.microsoft.com/en-us/services/load-balancer/" rel="noopener ugc nofollow" target="_blank"> Azure负载平衡器</a>。负载平衡器的前端是新的公共IP地址。负载平衡器的后端是一个包含三个AKS工作节点虚拟机的池。负载平衡器与一组规则和健康状况探测器相关联。</p><figure class="mc md me mf gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi mt"><img src="../Images/752867583f7b28e7e7d30c850b96274e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*CmbOTdWCv9IA0al5"/></div></div></figure><h1 id="af80" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">域名服务器(Domain Name Server)</h1><p id="1973" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">我已经将新的Azure公共IP地址(连接到负载平衡器的前端)与四个子域相关联，我使用这四个子域来表示两个名称空间中的UI和边缘服务Service-A。如果Azure是你的主要云提供商，那么<a class="ae le" href="https://docs.microsoft.com/en-us/azure/dns/" rel="noopener ugc nofollow" target="_blank"> Azure DNS </a>是管理你的域名DNS记录的好选择。对于此演示，您将需要自己的域。</p><figure class="mc md me mf gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi mt"><img src="../Images/9dc387a2061935b1d81edb2851b67401.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*t_ZxOjDf6HCGNQyO"/></div></div></figure><h1 id="2422" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">测试平台</h1><p id="9266" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">部署好所有东西后，测试平台是否响应，并生成HTTP流量供可观察性工具记录。和上次一样，我选择了<a class="ae le" href="https://github.com/rakyll/hey" rel="noopener ugc nofollow" target="_blank"> hey </a>，一个现代的负载生成器和基准测试工具，也是Apache Bench ( <code class="fe mq mr ms mh b">ab</code>)的一个值得替代的工具。与<code class="fe mq mr ms mh b">ab</code>不同，<code class="fe mq mr ms mh b">hey</code>支持HTTP/2。下面，我直接从<a class="ae le" href="https://azure.microsoft.com/en-us/features/cloud-shell/" rel="noopener ugc nofollow" target="_blank"> Azure云壳</a>运行<code class="fe mq mr ms mh b">hey</code>。该工具模拟10个并发用户，向服务a总共生成500个HTTP GET请求。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="31fb" class="ml lg it mh b gy mm mn l mo mp"># quick setup from Azure Shell using Bash<br/>go get -u github.com/rakyll/hey<br/>cd go/src/github.com/rakyll/hey/<br/>go build<br/>  <br/>./hey -n 500 -c 10 -h2 http://api.dev.example-api.com/api/ping</span></pre><p id="c84c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们获得了100%的成功，所有500个调用都产生了HTTP 200 OK成功状态响应代码。根据结果，我们可以观察到该平台每秒能够处理大约4个请求，平均响应时间为2.48秒，平均时间为2.80秒。正如细节所示，几乎所有的时间都是等待响应的结果。</p><figure class="mc md me mf gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi mt"><img src="../Images/67a0b452a6861acef66e49bf673fdc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*DlstiqvmDiP0-Qji"/></div></div></figure><h1 id="2b8f" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">记录</h1><p id="9f1f" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">在这篇文章中，我们用Azure Monitor日志代替了GCP的Stackdriver日志。据微软称，Azure Monitor通过提供一个全面的解决方案来收集、分析和处理来自云和内部环境的遥测数据，从而最大限度地提高应用程序的可用性和性能。在我看来，Stackdriver是搜索和关联运行在Kubernetes上的分布式应用程序的日志的优秀解决方案。我发现Stackdriver的界面和查询语言比Azure Monitor更容易、更直观，Azure Monitor虽然功能强大，但需要大量的查询知识才能获得有意义的结果。例如，这里有一个查询，用于查看最近一天内来自<code class="fe mq mr ms mh b">dev</code>名称空间中的服务的日志条目。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="2446" class="ml lg it mh b gy mm mn l mo mp">let startTimestamp = ago(1d);<br/>KubePodInventory<br/>| where TimeGenerated &gt; startTimestamp<br/>| where ClusterName =~ "aks-observability-demo"<br/>| where Namespace == "dev"<br/>| where Name contains "service-"<br/>| distinct ContainerID<br/>| join<br/>(<br/>    ContainerLog<br/>    | where TimeGenerated &gt; startTimestamp<br/>)<br/>on ContainerID<br/>| project LogEntrySource, LogEntry, TimeGenerated, Name<br/>| order by TimeGenerated desc<br/>| render table</span></pre><p id="7e9c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面，我们看到了带有搜索查询和日志条目结果的日志界面。</p><figure class="mc md me mf gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi mt"><img src="../Images/3ca102d3bbe5d308c6dfe741b792feb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*HpDu-QB1xbAPWay3"/></div></div></figure><p id="5280" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面，我们看到了服务a的单个日志条目的详细视图。</p><figure class="mc md me mf gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi mt"><img src="../Images/3a4a4ce138496b3966ad56abbf171355.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*oUvax2xUHZRwqIXX"/></div></div></figure><h1 id="2017" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">可观察性工具</h1><p id="d230" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">前一篇文章更详细地介绍了Istio提供的每个可观测性工具的特性，包括Prometheus、Grafana、Jaeger和Kiali。</p><p id="e63f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以使用与在GKE上完全相同的<code class="fe mq mr ms mh b">kubectl port-forward</code>命令来连接AKS上的工具。根据Google的说法，Kubernetes <a class="ae le" href="https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/" rel="noopener ugc nofollow" target="_blank">端口转发</a>允许使用一个资源名，比如一个服务名，来选择一个匹配的pod进行端口转发，从Kubernetes v1.10开始。我们将一个本地端口转发到工具pod上的一个端口。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="53ad" class="ml lg it mh b gy mm mn l mo mp"># Grafana<br/>kubectl port-forward -n istio-system \<br/>  $(kubectl get pod -n istio-system -l app=grafana \<br/>  -o jsonpath='{.items[0].metadata.name}') 3000:3000 &amp;<br/>  <br/># Prometheus<br/>kubectl -n istio-system port-forward \<br/>  $(kubectl -n istio-system get pod -l app=prometheus \<br/>  -o jsonpath='{.items[0].metadata.name}') 9090:9090 &amp;<br/>  <br/># Jaeger<br/>kubectl port-forward -n istio-system \<br/>$(kubectl get pod -n istio-system -l app=jaeger \<br/>-o jsonpath='{.items[0].metadata.name}') 16686:16686 &amp;<br/>  <br/># Kiali<br/>kubectl -n istio-system port-forward \<br/>  $(kubectl -n istio-system get pod -l app=kiali \<br/>  -o jsonpath='{.items[0].metadata.name}') 20001:20001 &amp;</span></pre><figure class="mc md me mf gt mu gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/32dd63784628cf5ac516562559ec315b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*PxX9eibRaJw5Rldf"/></div></figure><h2 id="bfb1" class="ml lg it bd lh mx my dn ll mz na dp lp kr nb nc lr kv nd ne lt kz nf ng lv nh bi translated">普罗米修斯和格拉夫纳</h2><p id="0afb" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated"><a class="ae le" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank"> Prometheus </a>是一个完全开源的社区驱动的系统监控和警报工具包，最初于2012年左右在SoundCloud创建。有趣的是，普罗米修斯在2016年加入了<a class="ae le" href="https://cncf.io/" rel="noopener ugc nofollow" target="_blank">云原生计算基金会</a> (CNCF)，作为继<a class="ae le" href="http://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>之后主持的第二个项目。</p><p id="cb80" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Grafana称自己是领先的时间序列分析开源软件。根据<a class="ae le" href="https://grafana.com/grafana" rel="noopener ugc nofollow" target="_blank"> Grafana Labs的说法，</a> Grafana允许您查询、可视化、提醒和了解您的指标，无论它们存储在哪里。您可以轻松创建、浏览和共享视觉效果丰富的数据驱动仪表板。Grafana还允许用户为他们最重要的指标可视化地定义警报规则。Grafana将不断评估规则，并可以发送通知。</p><p id="4e5b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据<a class="ae le" href="https://istio.io/docs/tasks/telemetry/using-istio-dashboard/#about-the-grafana-add-on" rel="noopener ugc nofollow" target="_blank"> Istio </a>，Grafana附加组件是Grafana的预配置实例。Grafana Docker基本映像已经过修改，可以在安装了Prometheus数据源和Istio仪表板的情况下启动。下面，我们看到一个预配置的控制面板，Istio服务控制面板。</p><figure class="mc md me mf gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi mt"><img src="../Images/071c82f7959105bbc7f5b532e85a5b22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*EfxpobzIF98sjahK"/></div></div></figure><h2 id="f035" class="ml lg it bd lh mx my dn ll mz na dp lp kr nb nc lr kv nd ne lt kz nf ng lv nh bi translated">贼鸥</h2><p id="b2ed" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">根据他们的网站介绍，<a class="ae le" href="https://www.jaegertracing.io/docs/1.10/" rel="noopener ugc nofollow" target="_blank"> Jaeger </a>受<a class="ae le" href="https://research.google.com/pubs/pub36356.html" rel="noopener ugc nofollow" target="_blank"> Dapper </a>和<a class="ae le" href="http://zipkin.io/" rel="noopener ugc nofollow" target="_blank"> OpenZipkin </a>的启发，是由<a class="ae le" href="http://uber.github.io/" rel="noopener ugc nofollow" target="_blank">优步科技</a>开源发布的分布式追踪系统。它用于对基于微服务的分布式系统进行监控和故障排除，包括分布式上下文传播、分布式事务监控、根本原因分析、服务依赖性分析以及性能和延迟优化。Jaeger <a class="ae le" href="https://www.jaegertracing.io/docs/1.10/architecture/" rel="noopener ugc nofollow" target="_blank">网站</a>包含了Jaeger架构和一般追踪相关术语的良好概述。</p><figure class="mc md me mf gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi mt"><img src="../Images/eae9fcf7a86012197f4ba0120fa563ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*JkJ3bKseA6tmo8tj"/></div></div></figure><p id="435f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面，我们看到一个典型的分布式服务跟踪，从入口网关开始，经过上游服务依赖关系。</p><figure class="mc md me mf gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi mt"><img src="../Images/f337201314f202228a3cb0ba0aa8652a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*QDZ35d6AvluCYxZM"/></div></div></figure><h2 id="1b8c" class="ml lg it bd lh mx my dn ll mz na dp lp kr nb nc lr kv nd ne lt kz nf ng lv nh bi translated">凯里</h2><p id="a40d" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">根据他们的<a class="ae le" href="https://www.kiali.io/documentation/overview/" rel="noopener ugc nofollow" target="_blank">网站</a>，Kiali提供了以下问题的答案:我的Istio服务网格中有哪些微服务，它们是如何连接的？Kiali在OpenShift或Kubernetes中与Istio合作，以可视化服务网状拓扑，提供对断路器、请求率等功能的可见性。它提供了从抽象应用程序到服务和工作负载的不同级别的网格组件的见解。</p><p id="aea8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有一个共同的Kubernetes <a class="ae le" href="https://istio.io/docs/tasks/telemetry/kiali/#before-you-begin" rel="noopener ugc nofollow" target="_blank">秘密</a>控制着对Kiali API和UI的访问。默认登录名为<code class="fe mq mr ms mh b">admin</code>，密码为<code class="fe mq mr ms mh b">1f2d1e2e67df</code>。</p><figure class="mc md me mf gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi mt"><img src="../Images/3aa15ef71fa03dfa68e3f04a606a491a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*mem4E3P21fA9kGno"/></div></div></figure><p id="5215" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面，我们看到了我们平台的详细视图，它运行在AKS上的<code class="fe mq mr ms mh b">dev</code>命名空间中。</p><figure class="mc md me mf gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi mt"><img src="../Images/50879fd441bbf37deccfe96f09e32f2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*4CQ_yNvheXTqdryA"/></div></div></figure><h1 id="78e0" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">删除AKS群</h1><p id="3e26" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">完成本演示后，使用以下两个命令拆除AKS集群，并从本地配置中删除集群上下文。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="863a" class="ml lg it mh b gy mm mn l mo mp">time az aks delete \<br/>  --name aks-observability-demo \<br/>  --resource-group aks-observability-demo \<br/>  --yes</span><span id="d46e" class="ml lg it mh b gy nm mn l mo mp">kubectl config delete-context aks-observability-demo</span></pre><h1 id="eb97" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">结论</h1><p id="be68" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">在这篇简短的后续文章中，我们探讨了当前的可观察性工具集(Istio Service Mesh最新版本的一部分)如何与Azure Kubernetes Service (AKS)集成。</p></div><div class="ab cl nn no hx np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="im in io ip iq"><p id="88e7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="nu">本文表达的所有观点都是我个人的，不一定代表我现在或过去的雇主或他们的客户的观点。</em></p></div></div>    
</body>
</html>