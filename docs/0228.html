<html>
<head>
<title>Downloading files from Ajax POST Requests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Ajax POST请求下载文件</h1>
<blockquote>原文：<a href="https://itnext.io/downloading-files-from-ajax-post-requests-26babc7661d4?source=collection_archive---------1-----------------------#2018-01-13">https://itnext.io/downloading-files-from-ajax-post-requests-26babc7661d4?source=collection_archive---------1-----------------------#2018-01-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/a8adb7ceebe0e7292b1d38e2ab03727f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rb7-YTwRtKnIH29UHCT9vg.png"/></div></div></figure><p id="5cb5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">偶尔，我偶然发现需要从POST请求中下载文件。一个例子是生成PDF文件，其中PDF内容依赖于请求。有趣的是，这并不像你想象的那么简单，但也并不难。</p><h1 id="ad8c" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">简单的服务器</h1><p id="b22d" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">我们将实现一个<em class="lz">非常简单的</em>服务器，它从POST请求生成pdf:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="e233" class="mj kx iq mf b gy mk ml l mm mn">require_once 'vendor/autoload.php';</span><span id="a3a7" class="mj kx iq mf b gy mo ml l mm mn">if($_SERVER['REQUEST_METHOD'] === 'POST') {<br/>    header('Content-type: application/pdf');<br/>    http_response_code(200);</span><span id="1ccf" class="mj kx iq mf b gy mo ml l mm mn">// Contents<br/>    $pdfContent = !empty($_POST['content']) ? $_POST['content'] : 'no content specified';<br/>    <br/>    // Generate the PDOF<br/>    $pdf = new FPDF();<br/>    $pdf-&gt;AddPage();<br/>    $pdf-&gt;SetFont('Arial','B',16);<br/>    $pdf-&gt;Cell(40,10, $pdfContent);<br/>    <br/>    return $pdf-&gt;Output(null, 'foobar-' . time() . '.pdf');<br/>}</span><span id="1a2d" class="mj kx iq mf b gy mo ml l mm mn">// Bad method<br/>http_response_code(405);<br/>exit();</span></pre><p id="65ed" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="lz">注意</em>:这段代码使用<a class="ae mp" href="https://github.com/Setasign/FPDF" rel="noopener ugc nofollow" target="_blank"> FPDF </a>库来生成PDF文件。出于演示目的，pdf中填充了来自<code class="fe mq mr ms mf b">$_POST['content']</code>的内容。</p><p id="1af4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">FPDF自动负责将<a class="ae mp" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Disposition" rel="noopener ugc nofollow" target="_blank">内容处理</a>设置为<code class="fe mq mr ms mf b">attachment</code>。如果您不使用FPDF，需要手动设置，只需在输出前添加以下内容:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="edef" class="mj kx iq mf b gy mk ml l mm mn">header('Content-Disposition: attachment; filename="filename.ext"');</span></pre><h1 id="8603" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">下载文件</h1><p id="4129" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">更有趣的是，在发送HTTP请求后，文件是如何下载的。让我们直入主题:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="6f3f" class="mj kx iq mf b gy mk ml l mm mn">&lt;!doctype html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>  &lt;meta charset="utf-8"&gt;<br/>  &lt;title&gt;Download POST Request&lt;/title&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>Enter a text and click the button: &lt;input type="text" id="content" value="Text for the generated pdf"&gt;<br/>&lt;button id="download"&gt;Send AJAX Request and download file&lt;/button&gt;</span><span id="3fd5" class="mj kx iq mf b gy mo ml l mm mn">&lt;script&gt;<br/>  document.getElementById('download').addEventListener('click', function () {<br/>    var content = document.getElementById('content').value;<br/>    var request = new XMLHttpRequest();<br/>    request.open('POST', '../server/', true);<br/>    request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');<br/>    request.responseType = 'blob';</span><span id="4e3d" class="mj kx iq mf b gy mo ml l mm mn">request.onload = function() {<br/>      // Only handle status code 200<br/>      if(request.status === 200) {<br/>        // Try to find out the filename from the content disposition `filename` value<br/>        var disposition = request.getResponseHeader('content-disposition');<br/>        var matches = /"([^"]*)"/.exec(disposition);<br/>        var filename = (matches != null &amp;&amp; matches[1] ? matches[1] : 'file.pdf');</span><span id="497d" class="mj kx iq mf b gy mo ml l mm mn">// The actual download<br/>        var blob = new Blob([request.response], { type: 'application/pdf' });<br/>        var link = document.createElement('a');<br/>        link.href = window.URL.createObjectURL(blob);<br/>        link.download = filename;</span><span id="5b60" class="mj kx iq mf b gy mo ml l mm mn">document.body.appendChild(link);</span><span id="6883" class="mj kx iq mf b gy mo ml l mm mn">link.click();</span><span id="d01d" class="mj kx iq mf b gy mo ml l mm mn">document.body.removeChild(link);<br/>      }<br/>      <br/>      // some error handling should be done here...<br/>    };</span><span id="e97b" class="mj kx iq mf b gy mo ml l mm mn">request.send('content=' + content);<br/>  });<br/>&lt;/script&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="742b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="lz">深呼吸… </em></p><p id="f770" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">实际的下载是通过创建一个对象来完成的，该对象用于一个新创建的<code class="fe mq mr ms mf b">a</code>标签，该标签带有一个到所创建的<code class="fe mq mr ms mf b">Blob</code>对象的链接，该链接被自动点击，最终打开“保存文件”对话框。此外，它被附加到<code class="fe mq mr ms mf b">body</code>(这是对Firefox的一个修复)之后从主体中移除(我们不希望我们的主体上有大量不可见的<code class="fe mq mr ms mf b">a</code>标签)。</p><p id="7d0d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">嗯，<em class="lz">和divs </em>中的内容垂直居中一样简单！(<em class="lz"> Flexbox作弊！</em>)</p><p id="a2eb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请记住，这个实现使用普通的JavaScript(使每个人都更容易理解这个例子)，但是实际的下载对于大多数框架(jQuery、Vue、Angular等等)都是一样的。</p><p id="39db" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当然，你可以在GitHub 上找到完整的实现。</p></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><p id="5887" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你喜欢这篇文章，请留下👏，关注我上 <a class="ae mp" href="https://twitter.com/nehalist" rel="noopener ugc nofollow" target="_blank"> <em class="lz">推特</em> </a> <em class="lz">并订阅</em> <a class="ae mp" href="https://nehalist.io/newsletter/" rel="noopener ugc nofollow" target="_blank"> <em class="lz">我的快讯</em> </a> <em class="lz">。原载于2018年1月13日</em><a class="ae mp" href="https://nehalist.io/downloading-files-from-post-requests/" rel="noopener ugc nofollow" target="_blank"><em class="lz">https://nehalist . io</em></a><em class="lz">。</em></p></div></div>    
</body>
</html>