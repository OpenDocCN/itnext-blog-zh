<html>
<head>
<title>Using PostgreSQL pgoutput plugin for change data capture with Debezium on Azure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用PostgreSQL pgoutput插件在Azure上通过Debezium捕获变更数据</h1>
<blockquote>原文：<a href="https://itnext.io/using-postgresql-pgoutput-plugin-for-change-data-capture-with-debezium-on-azure-845d3bb2787a?source=collection_archive---------2-----------------------#2020-08-13">https://itnext.io/using-postgresql-pgoutput-plugin-for-change-data-capture-with-debezium-on-azure-845d3bb2787a?source=collection_archive---------2-----------------------#2020-08-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="9bed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://dev.to/azure/tutorial-set-up-a-change-data-capture-architecture-on-azure-using-debezium-postgres-and-kafka-49h6" rel="noopener ugc nofollow" target="_blank">使用Debezium、Postgres和Kafka在Azure上建立变更数据捕获架构</a>是一个关于如何使用Debezium从Azure PostgreSQL捕获变更数据并将它们发送到Azure Event Hubs for Kafka的教程——它使用了<code class="fe km kn ko kp b">wal2json</code>输出插件。</p><h2 id="58a0" class="kq kr iq bd ks kt ku dn kv kw kx dp ky jy kz la lb kc lc ld le kg lf lg lh li bi translated">那<code class="fe km kn ko kp b">pgoutput</code>插件呢？</h2><p id="32e6" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">这个博客将提供一个如何使用<code class="fe km kn ko kp b">pgoutput</code>插件的快速浏览。为了简单起见，我不会重复很多细节，而是使用Kafka connect、Kafka(和Zookeeper)的容器化版本(使用Docker Compose)。所以，你唯一需要的是Azure PostgreSQL，你可以使用各种选项来设置它，包括<a class="ae kl" href="https://docs.microsoft.com/azure/postgresql/quickstart-create-server-database-portal?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure门户</a>、<a class="ae kl" href="https://docs.microsoft.com/azure/postgresql/quickstart-create-server-database-azure-cli?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a>、<a class="ae kl" href="https://docs.microsoft.com/azure/postgresql/quickstart-create-postgresql-server-database-using-azure-powershell?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure PowerShell </a>、<a class="ae kl" href="https://docs.microsoft.com/azure/postgresql/quickstart-create-postgresql-server-database-using-arm-template?tabs=azure-portal&amp;WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> ARM模板</a>。</p><blockquote class="lo lp lq"><p id="9205" class="jn jo lr jp b jq jr js jt ju jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj kk ij bi translated"><em class="iq">GitHub上有资源—</em><a class="ae kl" href="https://github.com/abhirockzz/debezium-postgres-pgoutput" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://github.com/abhirockzz/debezium-postgres-pgoutput</em></a></p></blockquote><h2 id="b9b4" class="kq kr iq bd ks kt ku dn kv kw kx dp ky jy kz la lb kc lc ld le kg lf lg lh li bi translated">使用右边的<code class="fe km kn ko kp b"><em class="lv">publication.autocreate.mode</em></code></h2><p id="1e38" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">使用<code class="fe km kn ko kp b">pgoutput</code>插件，为<a class="ae kl" href="https://debezium.io/documentation/reference/connectors/postgresql.html#postgresql-publication-autocreate-mode" rel="noopener ugc nofollow" target="_blank">publication . auto create . mode</a>使用合适的值是很重要的。如果您正在使用<strong class="jp ir"> all_tables </strong>(这是默认设置)，<em class="lr">您需要确保预先为您想要为变更数据捕获配置的特定表创建发布。如果找不到发布，连接器将尝试使用</em> <code class="fe km kn ko kp b"><em class="lr">CREATE PUBLICATION &lt;publication_name&gt; FOR ALL TABLES;</em></code> <em class="lr">创建一个，这将由于缺少权限而失败。</em></p><p id="720e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其他两个选项按预期工作:</p><ul class=""><li id="75f6" class="lw lx iq jp b jq jr ju jv jy ly kc lz kg ma kk mb mc md me bi translated"><strong class="jp ir">禁用</strong>:您需要确保出版物是预先创建的。如果在启动时没有发现发布，连接器将<em class="lr">而不是</em>尝试创建发布——它将抛出一个异常并停止。</li><li id="8810" class="lw lx iq jp b jq mf ju mg jy mh kc mi kg mj kk mb mc md me bi translated"><strong class="jp ir">过滤</strong>:您可以(可选)选择预先创建出版物。如果找不到发布，连接器将为所有匹配当前筛选器配置的表创建一个新的发布。</li></ul><blockquote class="lo lp lq"><p id="9a9e" class="jn jo lr jp b jq jr js jt ju jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj kk ij bi translated"><em class="iq">这一点在docs</em><a class="ae kl" href="https://debezium.io/documentation/reference/1.3/connectors/postgresql.html#postgresql-on-azure" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://debezium . io/documentation/reference/1.3/connectors/PostgreSQL . html # PostgreSQL-on-azure</em></a>中已经强调过了</p></blockquote></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h2 id="9310" class="kq kr iq bd ks kt ku dn kv kw kx dp ky jy kz la lb kc lc ld le kg lf lg lh li bi translated">让我们尝试不同的场景..</h2><p id="4dca" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">在此之前:</p><pre class="mr ms mt mu gt mv kp mw mx aw my bi"><span id="1a21" class="kq kr iq kp b gy mz na l nb nc">git clone https://github.com/abhirockzz/debezium-postgres-pgoutput &amp;&amp; cd debezium-postgres-pgoutput</span></pre><p id="3c4b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动Kafka、Zookeeper和Kafka连接容器:</p><pre class="mr ms mt mu gt mv kp mw mx aw my bi"><span id="6bca" class="kq kr iq kp b gy mz na l nb nc">export DEBEZIUM_VERSION=1.2<br/>docker-compose up</span></pre><blockquote class="lo lp lq"><p id="cd91" class="jn jo lr jp b jq jr js jt ju jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj kk ij bi translated">第一次拉集装箱可能需要一段时间</p></blockquote><p id="fb86" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所有容器启动并运行后，连接到Azure PostgreSQL，创建一个表并插入一些数据:</p><pre class="mr ms mt mu gt mv kp mw mx aw my bi"><span id="be9b" class="kq kr iq kp b gy mz na l nb nc">psql -h &lt;DBNAME&gt;.postgres.database.azure.com -p 5432 -U &lt;DBUSER&gt;@&lt;DBNAME&gt; -W -d postgres --set=sslmode=require</span><span id="515a" class="kq kr iq kp b gy nd na l nb nc">psql -h abhishgu-pg.postgres.database.azure.com -p 5432 -U abhishgu@abhishgu-pg -W -d postgres --set=sslmode=require</span><span id="a8a5" class="kq kr iq kp b gy nd na l nb nc">CREATE TABLE inventory (id SERIAL, item VARCHAR(30), qty INT, PRIMARY KEY(id));</span></pre><p id="ab9e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">当publication.autocreate.mode设置为过滤时</strong></p><p id="60e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这与Azure PostgreSQL配合得很好——它不需要超级用户权限，因为连接器基于filter/*list值为特定于<em class="lr">的</em>表创建发布</p><p id="e773" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用Azure PostgreSQL实例的详细信息更新连接器配置文件(<code class="fe km kn ko kp b">pg-source-connector.json</code>)，然后创建连接器</p><p id="c8c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要创建连接器，请执行以下操作:</p><pre class="mr ms mt mu gt mv kp mw mx aw my bi"><span id="ee11" class="kq kr iq kp b gy mz na l nb nc">curl -X POST -H "Content-Type: application/json" --data @pg-source-connector.json <a class="ae kl" href="http://localhost:8083/connectors" rel="noopener ugc nofollow" target="_blank">http://localhost:8083/connectors</a></span></pre><p id="0a43" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意日志(在docker编写终端中):</p><pre class="mr ms mt mu gt mv kp mw mx aw my bi"><span id="b119" class="kq kr iq kp b gy mz na l nb nc">Creating new publication 'mytestpub' for plugin 'PGOUTPUT'   [io.debezium.connector.postgresql.connection.PostgresReplicationConnection]</span></pre><p id="a876" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">连接器启动后，检查PostgreSQL中的发布:</p><pre class="mr ms mt mu gt mv kp mw mx aw my bi"><span id="34f6" class="kq kr iq kp b gy mz na l nb nc">pubname  | schemaname | tablename <br/>-----------+------------+-----------<br/> mytestpub | public     | inventory</span></pre><p id="2614" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有用吗？</p><p id="f1e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe km kn ko kp b">inventory</code>表中插入几条记录</p><pre class="mr ms mt mu gt mv kp mw mx aw my bi"><span id="05dd" class="kq kr iq kp b gy mz na l nb nc">psql -h &lt;DBNAME&gt;.postgres.database.azure.com -p 5432 -U &lt;DBUSER&gt;@&lt;DBNAME&gt; -W -d postgres --set=sslmode=require</span><span id="b687" class="kq kr iq kp b gy nd na l nb nc">INSERT INTO inventory (item, qty) VALUES ('apples', '100');<br/>INSERT INTO inventory (item, qty) VALUES ('oranges', '42');</span><span id="b258" class="kq kr iq kp b gy nd na l nb nc">select * from inventory;</span></pre><p id="98b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">连接器应该将变更事件从PostgreSQL WAL(预写日志)推送到Kafka。查看相应Kafka主题中的消息:</p><pre class="mr ms mt mu gt mv kp mw mx aw my bi"><span id="cec7" class="kq kr iq kp b gy mz na l nb nc">//exec into the kafka docker container<br/>docker exec -it debezium-postgres-pgoutput_kafka_1 bash</span><span id="4023" class="kq kr iq kp b gy nd na l nb nc">cd bin &amp;&amp; ./kafka-console-consumer.sh --topic myserver.public.inventory --bootstrap-server kafka:9092 --from-beginnin</span></pre><p id="fdc5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您应该看到几个变更日志事件有效负载(对应于两个<code class="fe km kn ko kp b">INSERT</code>)</p><blockquote class="lo lp lq"><p id="c0f0" class="jn jo lr jp b jq jr js jt ju jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj kk ij bi translated"><em class="iq">是的，它们是冗长的，因为模式包含在有效负载中</em></p></blockquote><p id="6c33" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">将publication.autocreate.mode更改为禁用</strong></p><p id="a7d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于这种模式，我们需要预先创建一个出版物。既然我们已经有一个(<code class="fe km kn ko kp b">mytestpub</code>)，那就用吧。你所需要做的就是将<code class="fe km kn ko kp b">pg-source-connector.json</code>中的<code class="fe km kn ko kp b">publication.autocreate.mode</code>更新为<code class="fe km kn ko kp b">disabled</code>。</p><p id="87bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">重新创建连接器:</p><pre class="mr ms mt mu gt mv kp mw mx aw my bi"><span id="a3fc" class="kq kr iq kp b gy mz na l nb nc">//delete<br/>curl -X DELETE localhost:8083/connectors/inventory-connector</span><span id="3e6e" class="kq kr iq kp b gy nd na l nb nc">//create<br/>curl -X POST -H "Content-Type: application/json" --data @pg-source-connector.json <a class="ae kl" href="http://localhost:8083/connectors" rel="noopener ugc nofollow" target="_blank">http://localhost:8083/connectors</a></span></pre><p id="9aa6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用与上一节中相同的步骤进行端到端测试——一切都应该正常工作！</p><blockquote class="lo lp lq"><p id="81ad" class="jn jo lr jp b jq jr js jt ju jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj kk ij bi translated"><em class="iq">确认一下，将连接器配置中的</em> <code class="fe km kn ko kp b"><em class="iq">publication.name</em></code> <em class="iq">更新为一个不存在的。由于缺少发布，连接器将无法启动(如预期的那样)</em></p></blockquote><p id="e2b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">试试publication . auto create . mode = all _ tables</strong></p><p id="aa9f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将<code class="fe km kn ko kp b">publication.autocreate.mode</code>设置为<code class="fe km kn ko kp b">all_tables</code>，<code class="fe km kn ko kp b">publication.name</code>设置为不存在的(如<code class="fe km kn ko kp b">testpub1</code>)并创建连接器:</p><pre class="mr ms mt mu gt mv kp mw mx aw my bi"><span id="42f5" class="kq kr iq kp b gy mz na l nb nc">curl -X POST -H "Content-Type: application/json" --data @pg-source-connector.json <a class="ae kl" href="http://localhost:8083/connectors" rel="noopener ugc nofollow" target="_blank">http://localhost:8083/connectors</a></span></pre><p id="9b06" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">(不出所料)它将失败，并出现类似如下的错误:</p><pre class="mr ms mt mu gt mv kp mw mx aw my bi"><span id="eb6a" class="kq kr iq kp b gy mz na l nb nc">....<br/>INFO Creating new publication 'testpub1' for plugin 'PGOUTPUT' (io.debezium.connector.postgresql.connection.PostgresReplicationConnection:127)<br/>ERROR WorkerSourceTask{id=inventory-connector-0} Task threw an uncaught and unrecoverable exception (org.apache.kafka.connect.runtime.WorkerTask:179)<br/>io.debezium.jdbc.JdbcConnectionException: ERROR: must be superuser to create FOR ALL TABLES publication<br/>....</span></pre><p id="f6ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意部分<code class="fe km kn ko kp b">must be superuser to create FOR ALL TABLES publication</code>——如前所述，<code class="fe km kn ko kp b">CREATE PUBLICATION &lt;publication_name&gt; FOR ALL TABLES;</code>由于缺乏超级用户权限而失败。</p><blockquote class="lo lp lq"><p id="b916" class="jn jo lr jp b jq jr js jt ju jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj kk ij bi translated"><em class="iq">正如我前面提到的，你需要通过手工为</em>特定的<em class="iq">表</em>创建发布来解决这个问题</p></blockquote></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h2 id="52ce" class="kq kr iq bd ks kt ku dn kv kw kx dp ky jy kz la lb kc lc ld le kg lf lg lh li bi translated">打扫</h2><p id="781f" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">为了清理，使用<a class="ae kl" href="https://docs.microsoft.com/cli/azure/postgres/server?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-postgres-server-delete" rel="noopener ugc nofollow" target="_blank"> az postgres server delete </a>删除Azure PostgreSQL实例并移除容器</p><pre class="mr ms mt mu gt mv kp mw mx aw my bi"><span id="fc95" class="kq kr iq kp b gy mz na l nb nc">az postgres server delete -g &lt;resource group&gt; -n &lt;server name&gt;</span><span id="4983" class="kq kr iq kp b gy nd na l nb nc">docker-compose down -v</span></pre><p id="c3c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇简短的博文就到这里。敬请关注更多内容！</p></div></div>    
</body>
</html>