<html>
<head>
<title>Backup and Restore of K8s using K10 and Kanister(Mutating Web Hooks) with Minio</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用带Minio的K10和Kanister(变异Web挂钩)备份和恢复K8s</h1>
<blockquote>原文：<a href="https://itnext.io/backup-and-restore-of-k8s-using-k10-and-kanister-mutating-web-hooks-with-minio-a1511a79638e?source=collection_archive---------3-----------------------#2020-09-05">https://itnext.io/backup-and-restore-of-k8s-using-k10-and-kanister-mutating-web-hooks-with-minio-a1511a79638e?source=collection_archive---------3-----------------------#2020-09-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="cf67" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您偶然发现在Kubernetes上寻找备份和恢复容器化有状态工作负载的方法，那么我希望您不会失望。在你深入研究这个之前，需要注意的是这是一个特定的用例，而不是一个典型的用例，这就是我写这个博客的原因。</p><p id="d9f8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这里，我将向您展示如何部署一个简单的有状态MySQL POD部署和注入一些数据，并通过截图和命令向您展示使用<a class="ae ko" href="https://www.kasten.io/" rel="noopener ugc nofollow" target="_blank"> Kasten </a>和<a class="ae ko" href="https://kanister.io/" rel="noopener ugc nofollow" target="_blank"> Kanister </a>的复杂性和细节，这将帮助您了解它是如何工作的，并像DIY一样亲自尝试。</p><p id="2bd3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我强烈推荐你看看我的<a class="ae ko" href="https://medium.com/@Sandeepkallazhi/velero-backup-restore-for-k8s-stateful-applications-managed-by-operators-8fd9c732ffcc" rel="noopener">早期博客</a>，关于使用Velero备份和恢复运行在Kubernetes上的应用程序。</p><p id="a470" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Velero和Kasten在Kubernetes应用程序的备份和恢复领域的工作方式存在显著差异。我不想提供这些区别是什么或它们的利弊，因为我想这会给读者带来偏见。</p><p id="3abd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在继续阅读之前，您应该知道的一件事是，Kasten K10平台是专有的，并附带许可证，尽管对于较小的部署来说是免费的，并且它们有不同的定价。但是Kanister是Kasten的开源项目(就像Velero(heptio ark)是VMware的开源项目一样)</p><p id="e8d5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">什么是变异网页钩子？</strong></p><p id="9dec" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了理解这一点，你需要理解“动态准入控制”以及它在Kubernetes中是什么。</p><p id="1a63" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi kp translated"><span class="l kq kr ks bm kt ku kv kw kx di"/><em class="ky">准入控制器是一段代码，它在对象持久化之前，但在请求被认证和授权之后，拦截对Kubernetes API服务器的请求。[……]准入控制器可能是“验证”、“突变”或两者兼有。变异的控制器可以修改它们接纳的对象；验证控制器可能不会。[……]如果任一阶段的任何控制器拒绝请求，整个请求将立即被拒绝，并向最终用户返回一个错误。</em></p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi kz"><img src="../Images/03b8171399a9c64917ed46f91232d781.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-Vfdov6tfty60mTs9BpEUA.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">K8s接纳控制流</figcaption></figure><p id="b985" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Kubernetes中的许多高级功能需要启用准入控制器，以便正确支持该功能。因此，没有正确配置许可控制器的Kubernetes API服务器是一个不完整的服务器，不会支持您期望的所有特性。这里有一个准入控制器列表，许多Kubernetes固有的特性都是由准入控制器完成的。</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi lp"><img src="../Images/67178496f5cbc0cafac04643f014b19b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KLg8SwD2sepN976c-5qQiQ.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">Webhooks</figcaption></figure><p id="9359" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里使用的是MutatingAdmissionWebhook和ValidatingAdmissionWebhook。如果你想了解更多关于MutatingAdmissionWebhook的信息，亚历克斯·莱恩哈特写了一篇关于这个话题的博客<a class="ae ko" href="https://medium.com/ovni/writing-a-very-basic-kubernetes-mutating-admission-webhook-398dbbcb63ec" rel="noopener">。</a></p><p id="4722" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">MutatingAdmissionWebhook有不同的用例，其中之一是将Sidecar注入到您的工作负载或应用程序中。K10实现了一个变异的Webhook服务器，它通过在创建工作负载时向工作负载中注入一个Kanister sidecar来变异工作负载对象(<a class="ae ko" href="https://docs.kasten.io/latest/install/generic.html" rel="noopener ugc nofollow" target="_blank">阅读更多..</a>)</p><p id="7274" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我使用的Kubernetes集群是<a class="ae ko" href="https://www.ibm.com/in-en/cloud/container-service" rel="noopener ugc nofollow" target="_blank"> IBM云IKS </a>，我的工作负载在这个托管服务平台上运行。截至目前，IKS使用的底层存储提供商不支持K10，因此克服这一限制的途径是使用通用备份，这需要向您的工作负载POD添加一个sidecar容器，并为您的应用程序部署添加注释。</p><p id="e2ea" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，让我们开始部署K10和所有必要的依赖项。在部署K10之前，需要运行特定的先决条件脚本。我们将使用Helm部署K10，同时请参考K10文档，了解有关先决条件和步骤的更多详细信息。</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi lq"><img src="../Images/5d1a25ae6469d6dd36b8f7442f7a0b96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tu1RncrkT38QRCMTywhS0w.png"/></div></div></figure><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi lq"><img src="../Images/2a0b04703830eb4854298ca18c3c48ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oj50gmESMbKVpkDHbTBIVQ.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">K10仪表板</figcaption></figure><p id="c777" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">K10部署在自己的命名空间中，并附带了如下所示的所有组件</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div class="gh gi lr"><img src="../Images/89687bfc109680719f2b23f6485804fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/1*bQRrsMwvAXS6RPPb7fSA3A.png"/></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">卡斯滕-木卫一吊舱</figcaption></figure><p id="8c2d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下一步将是为K10设置位置配置文件。位置配置文件只是备份存储目标。它支持主要的云对象存储解决方案，也支持任何其他S3兼容存储。我正在使用Minio实例进行备份。</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi ls"><img src="../Images/b15f188e79c88664d99038f384263e85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Sa5EgNwnFTjuT81B-KT3Zw.png"/></div></div></figure><p id="7900" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我已经为Kasten配置了新的Minio bucket(名为<em class="ky"> db-s3 </em>)和Minio凭证(密钥和秘密)，如下所示</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi lq"><img src="../Images/ba29ed1a0846e76cc559741a3cce421e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6avkTKiAW8jJRs4gfyZCcA.png"/></div></div></figure><p id="5c64" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我应该提一下Kasten与<a class="ae ko" href="https://medium.com/@Sandeepkallazhi/velero-backup-restore-for-k8s-stateful-applications-managed-by-operators-8fd9c732ffcc" rel="noopener"> Velero </a>提供的非常显著的不同之处，那就是能够为备份目标存储创建多个配置文件。这让你有多个S3兼容或云对象存储，如AWS S3或GCP/Azure对象存储。根据应用程序需求和Kubernetes架构，在多个租户使用一个Kubernetes集群的情况下，我可以看到这个用例支持多个不同的首选项。</p><p id="fd3b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Kasten还发现作为集群一部分的应用程序，并自动提取与每个应用程序相关的所有元数据信息和对象，如its、持久卷、机密、配置映射、服务等。它还为您提供了每个命名空间的直观形象，并列出是否定义了备份策略，以及这些策略是否保护了应用程序。这提供了一个很好的视图，并提供了Kubernetes工作负载的可见性。</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi lt"><img src="../Images/8652354d916da2323a24828e5899556c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VWOz3neK1hlrLwNw5sgUGQ.png"/></div></div></figure><p id="22f5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">它使您能够执行手动快照或创建策略，然后针对需要保护的应用程序或命名空间运行策略。在上面的图像中，你可以看到我正在尝试手动抓图，它为我提供了选择，要么拍摄整个应用程序的快照，要么只在应用程序中指定特定的标签。</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi lt"><img src="../Images/bc2b2b16891d1119e38b95b09907fa3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vsOeL5OO-IZf-aN3SFHFqQ.png"/></div></div></figure><p id="2896" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上图显示了我如何从所有发现的标签中选择一个标签，当我在下拉菜单中列出它时，它会显示出来。这非常有用，可以使创建备份策略更加简单，我唯一需要做的就是使用一个有意义的名称标签作为我所有Kubernetes应用程序部署yaml的标签。</p><h2 id="beb7" class="lu lv it bd lw lx ly dn lz ma mb dp mc kb md me mf kf mg mh mi kj mj mk ml mm bi translated">使用持久卷创建MySQL部署</h2><p id="f6b8" class="pw-post-body-paragraph jq jr it js b jt mn jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj mr kl km kn im bi translated">下面你可以看到一个典型的MySQL部署和相关的持久卷。请注意，就绪部分显示1/1，这意味着副本仅为1。这是正常的，因为我已经将MySQL的副本设置为只有1，但是我们将在本文后面更详细地研究这个问题。</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi ms"><img src="../Images/b1e3d5d00f33d741d1cf638ff34b323a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DbN42CPDFOw-EyyGiu8Pkg.png"/></div></div></figure><p id="1622" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我将创建一些虚拟数据库，并将一些样本数据注入到数据库中的持久存储中，然后模拟数据是否位于映射到此POD的持久存储卷中。</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi mt"><img src="../Images/faaecc81298646f6404155ba8cecad09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y5lL22DV7pxEE1UuFTe36w.png"/></div></div></figure><h2 id="51d6" class="lu lv it bd lw lx ly dn lz ma mb dp mc kb md me mf kf mg mh mi kj mj mk ml mm bi translated">边车喷射</h2><p id="db5b" class="pw-post-body-paragraph jq jr it js b jt mn jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj mr kl km kn im bi translated">在博客的前面，我们谈到了变异的Webhook及其意义。变异的webhook是一个Kubernetes准入控制，我们在这里与Kasten一起使用，用于注入Kanister sidecar容器，该容器需要进行一般备份。我重申，使用sidecar容器的原因是为了装载需要保护的应用程序的数据量。</p><p id="d990" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在可以使用Helm upgrade或使用普通的Kubernetes资源部署sidecar容器，并在清单中对它们进行必要的修改。在这里，当我使用头盔安装K10时，我将继续使用头盔添加Kanister边车容器。运行以下命令来完成这项工作。</p><pre class="la lb lc ld gt mu mv mw mx aw my bi"><span id="6ddd" class="lu lv it mv b gy mz na l nb nc">helm upgrade k10 kasten/k10 --namespace=kasten-io -f k10_val.yaml \<br/>--set injectKanisterSidecar.enabled=true \<br/>--set-string injectKanisterSidecar.namespaceSelector.matchLabels.name=mysql</span></pre><p id="d977" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在您运行上面的Helm命令之后，一个sidecar容器会随着您需要保护的工作负载POD一起创建。如果您仔细观察如下所示的命令(它的第二部分)。</p><pre class="la lb lc ld gt mu mv mw mx aw my bi"><span id="9456" class="lu lv it mv b gy mz na l nb nc">--set-string injectKanisterSidecar.namespaceSelector.matchLabels.k10/injectKanisterSidecar=true</span></pre><p id="45fc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是为了使用namespaceSelector选择一个名称空间，它包含您想要保护的应用程序或工作负载。在我的例子中，它是名为mysql的名称空间，我在该名称空间中部署了MySql部署。现在，我们通常不标记我们创建的名称空间，但我们在这里这样做是必要的，因为我们使用标签来让Helm知道要保护哪个名称空间。参见下面的命名空间“mysql”的json文件。</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nd"><img src="../Images/d242efd06ba6ea6414f372b336cee17d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oHsI6tGFz-BvzcDM_AE4dg.png"/></div></div></figure><p id="d518" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您也可以选择使用Helm升级中的以下命令，使用objectSelector来保护特定的POD/工作负荷。</p><pre class="la lb lc ld gt mu mv mw mx aw my bi"><span id="e2e4" class="lu lv it mv b gy mz na l nb nc">--set-string injectKanisterSidecar.objectSelector.matchLabels.key=value</span></pre><p id="599c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，这个Helm升级设置为在名称空间“mysql”中添加一个sidecar容器，并对该名称空间中的工作负载或POD进行注释。</p><p id="1e08" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在下图中，看看我的MySQL部署，注意yaml文件中的选定行，您可以看到注释:<em class="ky">k10.kasten.io/forcegenericbackup: " true "</em></p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi ne"><img src="../Images/af8ea0c287f6e6b377a64ba1f8907c5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KDVKgdELxgzBkiMiGwMr0g.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">kubectl编辑部署mysql -n mysql</figcaption></figure><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nf"><img src="../Images/c7b8610717bbf95fc4c1e66c18ca39ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xkV6_El0imSZmf9LhQjNZw.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">mysql部署和POD</figcaption></figure><p id="49c6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请看上图，仔细注意“就绪”部分，您会看到它显示为2/2，这意味着MySQL pod中有两个容器。如果你记得在前面的章节中，我们只有一个MySQL容器，因为我的副本只有一个。在头盔升级后，边车容器被添加到同一个容器中。</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi ng"><img src="../Images/18c8a94fb7c7bf64ab1bde1787b37e23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CrzJ-bqC3AfAUXJe-isaKg.png"/></div></div></figure><p id="6de6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请参见上面的图像，这是POD描述的输出，您可以看到两个容器，一个是实际工作负载MySQL，另一个是Kanister sidecar容器。还要记下卷装载，您将看到sidecar容器装载点与MySQL容器的装载点完全相同，这是启用我们之前讨论的通用备份所需的装载点。</p><p id="8b21" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我应该说，并不是所有的应用程序部署都喜欢这种使用边柜容器进行备份的方式，但是当我们遇到这样的场景，底层存储提供商不支持Kasten时，K10会采用这种方法来解决这个问题。</p><h2 id="32f8" class="lu lv it bd lw lx ly dn lz ma mb dp mc kb md me mf kf mg mh mi kj mj mk ml mm bi translated">创建备份策略</h2><p id="05d8" class="pw-post-body-paragraph jq jr it js b jt mn jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj mr kl km kn im bi translated">现在，让我们在K10中创建一个备份策略并运行它。</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nh"><img src="../Images/919892d2118760d600ff714210112517.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aoKR1fnF7w7m89o3VSNXCA.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">备份策略</figcaption></figure><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi ni"><img src="../Images/70db2dcb4be5eb7294280928bf79ef0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p5lqq45KvNjM1zwkf8iUQQ.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">操作表示备份成功</figcaption></figure><p id="c8d7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在上面的图片中，您可以看到我已经创建并运行了一个备份策略。在创建策略时，您可以调整不同的参数，K10页面已经详细介绍了这些参数是如何完成的，所以我不打算在此展示。</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nj"><img src="../Images/cc2dd05c9abca4b6125b5affe86a6fce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oo2iOrGFowgvEyD6qxey0w.png"/></div></div></figure><p id="19e9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上图显示了我通过“位置配置文件”配置的Minio存储桶中的备份。</p><h2 id="af24" class="lu lv it bd lw lx ly dn lz ma mb dp mc kb md me mf kf mg mh mi kj mj mk ml mm bi translated">删除工作负荷命名空间并恢复</h2><p id="d9c8" class="pw-post-body-paragraph jq jr it js b jt mn jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj mr kl km kn im bi translated">参见下图，有两个屏幕叠加在一起，一个在左侧显示应用程序卡中的9，另一个是Compliant，即命名空间mysql中的MySQl应用程序。现在看右边的屏幕，终端显示名称空间“mysql”被删除，卡中的应用程序数量减少到8个。</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nk"><img src="../Images/ca37fd8d3f66cc18431eb9b93c25b0a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I6BOeYXrZxvuBBtB61Cysg.png"/></div></div></figure><p id="c38b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您还记得，我已经选择将名称空间作为一个整体进行注释，因此如果该名称空间中有其他pod，那么所有pod都将受到保护。在这个例子中，我没有另一个POD，但是我会稍后尝试添加一个，然后回来编辑博客。目前它只是MySQL的一个工作负载POD。</p><h2 id="af80" class="lu lv it bd lw lx ly dn lz ma mb dp mc kb md me mf kf mg mh mi kj mj mk ml mm bi translated">从Minio恢复MySQL</h2><p id="3014" class="pw-post-body-paragraph jq jr it js b jt mn jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj mr kl km kn im bi translated">下图显示了从还原点开始的逐步恢复，在本例中，我只进行了一次备份，因此只有一个还原点。</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nl"><img src="../Images/7794ede5c9b9702e4a33dde5b88fe4a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6qLtfgLpGxyLwkjOp1GbZA.png"/></div></div></figure><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nl"><img src="../Images/2ce6ab15936f79d0e1cb2ee889f1bdb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C_t-Eo3f_fyzgwoeAJf_Rg.png"/></div></div></figure><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nl"><img src="../Images/6e2a2bebd0f288f591e6595fd4b717bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IhyPeffgVszuVuUJLK4kCA.png"/></div></div></figure><p id="d88e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">仔细查看规范部分，找到所有要恢复的资源。它列出了蓝图(kanister)、部署、名称空间、机密、服务帐户、存储类。此外，在最后一个图像中，仔细查看Kanister部分，它显示了MySQL的确切备份路径，这是我最初创建MySQL部署时的确切挂载卷路径。</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nl"><img src="../Images/a162a1fb0895ee7b309a5390e849078a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A1xtT2rhk8okRiVl8ZrCGw.png"/></div></div></figure><p id="1f2a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，我们可以看到MySQL pod正在部署，并注意到有一个恢复数据pod，它是在恢复过程中创建的，在恢复完成后会被撕掉。</p><p id="a01f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，我们应该验证出现的POD是否具有从备份中恢复的持久数据。让我们通过检查mysql数据库并运行一些MySQL查询来进行验证。</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nm"><img src="../Images/cdb7a6e1c660a6476301df772671cd85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L4hAXLQt0PQK5E8E9rSi3g.png"/></div></div></figure><p id="a1dc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们进入POD并运行mysql query，发现数据库和表完好无损，并且已经从备份中恢复。</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi nn"><img src="../Images/2a363ca2de867f88c53668e538950e7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1VjsZuA8GY6yy9L7zdNOhw.png"/></div></div></figure><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi no"><img src="../Images/991ce7f160bab1bbc9997802ea5ef003.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S3kAmnmgP0LEFFZ5OT7_0Q.png"/></div></div></figure><p id="ffe8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上面的图片显示MySQL被列在应用程序中并且是兼容的，这意味着它受到K10的保护。现在，我们可以继续指定更好的备份策略和保留时间，以及特定于我们需要的解决方案的其他重要参数。</p><p id="d5be" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，我想指出，Kasten是备份和恢复Kubernetes上运行的应用程序或工作负载的绝佳解决方案。但是也有警告、问题和限制。在这篇文章中，我的重点是展示当底层存储提供商不支持像Kasten这样的解决方案时，Kubernetes的应用程序或名称空间备份。在这个解决方案中，我们使用Kanister的功能将sidecar注入到工作负载中，并使用Kasten的功能创建策略和恢复有状态的MySQL应用程序。</p><h2 id="dd2f" class="lu lv it bd lw lx ly dn lz ma mb dp mc kb md me mf kf mg mh mi kj mj mk ml mm bi translated">结论</h2><p id="123b" class="pw-post-body-paragraph jq jr it js b jt mn jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj mr kl km kn im bi translated">我一直在为Kubernetes上运行的工作负载的备份和恢复用例研究和构建测试平台。与传统的仅备份/恢复卷不同，我主要关注应用程序特定的使用情形。应用感知备份和恢复可以更好地了解Kubernetes中托管的应用的需求和复杂性。</p><p id="25df" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我在这个领域的重点和工作是Velero和Kasten，我期待着做更多的架构，具体的用例，并与社区分享我学到的东西。如果你想看我做什么，想和我聊天，就找我发关于Kubernetes，开源，Linux <a class="ae ko" href="https://twitter.com/sandeepkallazhi" rel="noopener ugc nofollow" target="_blank"> @sandeepkallazhi </a>，DM开放的微博。</p><p id="e50e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下次博客前，再见，注意安全！</p><p id="3e49" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">干杯！</p></div></div>    
</body>
</html>