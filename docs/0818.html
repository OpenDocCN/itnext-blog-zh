<html>
<head>
<title>Building RESTful Web APIs with Node.js, Express, MongoDB and TypeScript — Part 5</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Node.js、Express、MongoDB和TypeScript构建RESTful Web APIs第5部分</h1>
<blockquote>原文：<a href="https://itnext.io/building-restful-web-apis-with-node-js-express-mongodb-and-typescript-part-5-a80e5a7f03db?source=collection_archive---------0-----------------------#2018-06-04">https://itnext.io/building-restful-web-apis-with-node-js-express-mongodb-and-typescript-part-5-a80e5a7f03db?source=collection_archive---------0-----------------------#2018-06-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/e448896648e7a16f3be0c2707c5a95ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*ZZRtwzUVGyBkfkKurbHjwg.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">(图片来自OctoPerf)</figcaption></figure><p id="fa4f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有一个关于<a class="ae kw" href="https://www.lynda.com/Node-js-tutorials/Next-steps/633869/671263-4.html" rel="noopener ugc nofollow" target="_blank">如何在Lynda </a>上构建Web APIs的课程，但是他们没有使用TypeScript。所以我决定用TypeScript做一个。这个项目中有许多需要改进的地方。如果你找到了，请留下评论。我很感激。)</p><p id="3fd0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://medium.com/@dalenguyen/building-restful-web-apis-with-node-js-express-mongodb-and-typescript-part-1-2-195bdaf129cf" rel="noopener"> <strong class="ka ir">第一部分:设置项目</strong> </a></p><p id="4cf5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://medium.com/@dalenguyen/building-restful-web-apis-with-node-js-express-mongodb-and-typescript-part-2-98c34e3513a2" rel="noopener"> <strong class="ka ir">第二部分:实现路由和CRUD </strong> </a></p><p id="2ebf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://medium.com/@dalenguyen/building-restful-web-apis-with-node-js-express-mongodb-and-typescript-part-3-d545b243541e" rel="noopener"> <strong class="ka ir">第3部分:为Web APIs使用控制器和模型</strong> </a></p><p id="7273" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://medium.com/@dalenguyen/building-restful-web-apis-with-node-js-express-mongodb-and-typescript-part-4-954c8c059cd4" rel="noopener"> <strong class="ka ir">第4部分:将Web APIs连接到MongoDB或其他</strong> </a></p><p id="fcc3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://medium.com/@dalenguyen/building-restful-web-apis-with-node-js-express-mongodb-and-typescript-part-5-a80e5a7f03db" rel="noopener"> <strong class="ka ir">第5部分:我们的Web APIs的安全性</strong> </a></p><p id="53b5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/building-a-serverless-restful-api-with-cloud-functions-firestore-and-express-f917a305d4e6"> <strong class="ka ir">奖励:用云函数、Firestore和Express </strong> </a>构建“无服务器”RESTful API</p><p id="28ac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/handling-long-running-api-requests-in-nodejs-403bd566d47"> <strong class="ka ir">奖励:在Nodejs </strong> </a>中处理长时间运行的API请求</p><p id="6b01" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这一部分，我将向您展示保护RESTful Web APIs的各种方法。对于更安全的API应用程序，您应该至少使用一种或组合使用这些方法。</p><p id="7c7b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你想使用像<a class="ae kw" href="https://mlab.com/" rel="noopener ugc nofollow" target="_blank"> mLab </a>、<a class="ae kw" href="https://www.compose.com" rel="noopener ugc nofollow" target="_blank">compose</a>……这样的服务，他们已经在他们的终端实现了一个安全的系统。你需要做的就是按照他们的指示将数据库连接到你的应用程序。</p><p id="b5ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">方法1 </strong> : <strong class="ka ir">首先也是最重要的是，你应该始终使用HTTP上的HTTPS</strong></p><p id="7d9a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于本地测试，我将在Windows上使用<a class="ae kw" href="https://slproweb.com/products/Win32OpenSSL.html" rel="noopener ugc nofollow" target="_blank"> OpenSSL </a>来为HTTPS配置生成密钥和证书。这个过程在Mac或Linux上是相似的。</p><p id="3fe1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">安装OpenSSL后，我将打开OpenSSL并开始生成密钥和证书文件。</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="3483" class="lg lh iq lc b gy li lj l lk ll">OpenSSL&gt; req -newkey rsa:2048 -nodes -keyout keytemp.pem -x509 -days 365 -out cert.pem<br/>OpenSSL&gt; rsa -in keytemp.pem -out key.pem</span></pre><p id="72c9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">之后，我们将把<strong class="ka ir"> key.pem </strong>和<strong class="ka ir"> cert.pem </strong>文件移到我们的项目中。它们将位于config文件夹中。</p><p id="d943" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后我们将编辑server.ts文件来启用https。</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="6840" class="lg lh iq lc b gy li lj l lk ll">import app from './app';<br/><strong class="lc ir">import * as https from 'https';<br/>import * as fs from 'fs';</strong><br/>const PORT = 3000;</span><span id="bc47" class="lg lh iq lc b gy lm lj l lk ll"><strong class="lc ir">const httpsOptions = {<br/>    key: fs.readFileSync('./config/key.pem'),<br/>    cert: fs.readFileSync('./config/cert.pem')<br/>}</strong></span><span id="2638" class="lg lh iq lc b gy lm lj l lk ll"><strong class="lc ir">https.createServer(httpsOptions, app).listen(PORT, () =&gt; {<br/>    console.log('Express server listening on port ' + PORT);<br/>})</strong></span></pre><p id="504c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了测试服务器，我们将运行</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="3cbe" class="lg lh iq lc b gy li lj l lk ll">ts-node .\lib\server.ts</span></pre><p id="290b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从现在开始，我们的应用程序将始终在HTTPS上运行。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="gh gi ln"><img src="../Images/de4e3cf3906d76a807041cb7ff766982.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/format:webp/1*mbzIGbGceFmIAdyMS_vXCQ.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">通过HTTPS(邮递员)获取数据</figcaption></figure><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi lo"><img src="../Images/f28f2bd79ff76652e82098e917c54704.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GTxzTcLfH0Z3wxg9ljvsqA.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">如果试图通过HTTP访问，您将得不到任何响应并出现错误</figcaption></figure><p id="24fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">方法2:使用密钥进行认证</strong></p><p id="0929" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个方法使用一个惟一的键来传递URL，因此您可以访问数据库。您可以使用crypto从命令行创建密钥。</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="ffb2" class="lg lh iq lc b gy li lj l lk ll">node -e "console.log(require('crypto').randomBytes(20).toString('hex'))"</span></pre><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi lt"><img src="../Images/40b18c14c30eeea67c5d7eeaf610bf8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZTyMmHr9z8k3SLcNr5fmng.png"/></div></div></figure><p id="079c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们将使用中间件在响应请求之前检查密钥。例如，如果您想要获取所有联系人，您需要传递一个键。</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="89e6" class="lg lh iq lc b gy li lj l lk ll">// GET request<br/>https://127.0.0.1:3000?key=<strong class="lc ir">78942ef2c1c98bf10fca09c808d718fa3734703e</strong></span></pre><p id="5f71" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将在发送请求之前编辑<strong class="ka ir">/lib/routes/CRM routers . ts</strong>。<em class="lu">请记住，在生产中，您应该在环境中传递密钥，而不是像示例中那样直接传递</em>。</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="123a" class="lg lh iq lc b gy li lj l lk ll">// lib/routes/crmRouters.ts<br/>// get all contacts</span><span id="f0fb" class="lg lh iq lc b gy lm lj l lk ll">app.route('/contact')<br/>.get((req: Request, res: Response, <strong class="lc ir">next: NextFunction</strong>) =&gt; {<br/> // middleware          <br/> if(req.query.key !== '<strong class="lc ir">78942ef2c1c98bf10fca09c808d718fa3734703e</strong>'){<br/>  <strong class="lc ir">res.status(401).send('You shall not pass!');</strong><br/> } else {<br/>  <strong class="lc ir">next();</strong><br/> }                        <br/>}, this.contactController.getContacts)</span></pre><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/b57a2242a6463e7456863f9a4b11a3ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1310/format:webp/1*fBNqXclkRGzMLxaav-3OEA.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">我们被允许用密钥获取数据</figcaption></figure><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi lw"><img src="../Images/ecc9d50af08f79183e2b6d12f108f69b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*El1cocWFFKLqSXDRlCla6Q.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">没有钥匙你不能进入</figcaption></figure><p id="ab69" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">方法3:保护您的MongoDB </strong></p><p id="2dea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">很悲哀的是，默认情况下，MongoDB根本就没有像这样的安全性。如果您想检查您当前的配置。转到您的mongo安装目录并键入mongo。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi lx"><img src="../Images/55f42124c8f3c90591b88366b31d86ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*deOeIv2ZKJqnCSeYH2EEtQ.png"/></div></div></figure><p id="83cf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如您所见，对数据库没有访问控制，任何人都可以对数据库做任何事情。因此，我们将为MongoDB启用身份验证特性。</p><p id="ab34" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，我们需要创建一个帐户，以便通过Mongodb进行身份验证。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="gh gi ly"><img src="../Images/89379515c68c13b9e1b58b780f660a69.png" data-original-src="https://miro.medium.com/v2/resize:fit:766/format:webp/1*D_l2oioQ-6cKKIbOwT_F9g.png"/></div></figure><p id="2083" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">之后，我们将停止并重启带身份验证的MongoDB。记得检查你的dbpath。</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="8b10" class="lg lh iq lc b gy li lj l lk ll">// Stop MongoDB (Windows)<br/>net stop MongoDB</span><span id="81b1" class="lg lh iq lc b gy lm lj l lk ll">// Start mongodb with authentication<br/>mongod --auth --port 27017 --dbpath C:\your-data\path</span></pre><p id="0a8d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，如果我们登录到mongo shell，就不会有关于访问控制的警告。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/701d0a22b633f7ef831d2cd506a44e80.png" data-original-src="https://miro.medium.com/v2/resize:fit:586/format:webp/1*iXsYtcmJJW8a7364BTGeXQ.png"/></div></figure><p id="e215" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者您可以使用刚刚创建的用户名和密码连接到mongo shell。</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="886a" class="lg lh iq lc b gy li lj l lk ll">mongo --port 27017 -u dalenguyen -p 123123  --authenticationDatabase CRMdb</span></pre><p id="2149" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，如果我们试图访问数据库，即使有密钥，我们也不能。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi ma"><img src="../Images/8e40b95e57a8fcd7ca5dccaacf58e1a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DOJfxGpS-6rYzD9YEIZbjw.png"/></div></div></figure><p id="c12a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这就是为什么我们需要编辑mongodb的URL，以便应用程序能够工作。<em class="lu">同样，您应该将mongodb URI放到环境中。</em></p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="0029" class="lg lh iq lc b gy li lj l lk ll">// lib/app.ts</span><span id="e516" class="lg lh iq lc b gy lm lj l lk ll">class App {<br/>...</span><span id="3060" class="lg lh iq lc b gy lm lj l lk ll">public mongoUrl: string = '<strong class="lc ir">mongodb://dalenguyen:123123@localhost:27017/CRMdb</strong>';</span></pre><p id="c829" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后你重启RESTful API，一切将再次开始正常工作，但现在你有一个更安全和可控的API应用程序。我们可以实现更多的安全方法来改进我们的应用程序。我会试着在其他帖子中更新它们。</p><p id="ee53" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这之后，现在我们有了一个完全安全的工作RESTful Web APIs应用程序，它带有TypeScript和Nodejs。如果你想检查所有代码，请访问我的<a class="ae kw" href="https://github.com/dalenguyen/rest-api-node-typescript" rel="noopener ugc nofollow" target="_blank"> github库</a>获取完整代码。</p><p id="6eec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://github.com/dalenguyen/rest-api-node-typescript" rel="noopener ugc nofollow" target="_blank">https://github.com/dalenguyen/rest-api-node-typescript</a></p></div></div>    
</body>
</html>