<html>
<head>
<title>CI/CD with Jenkins and Ansible</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Jenkins和Ansible的CI/CD</h1>
<blockquote>原文：<a href="https://itnext.io/ci-cd-with-jenkins-and-ansible-f41ef2b33977?source=collection_archive---------1-----------------------#2018-07-03">https://itnext.io/ci-cd-with-jenkins-and-ansible-f41ef2b33977?source=collection_archive---------1-----------------------#2018-07-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="5641" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在是2018年。Kubernetes赢得了容器编排之战。我们中的一些人正在嫉妒地阅读硅谷创业公司的文章(是的，也许他们也已经在你的城市了！)但是我们又回到了我们良好的旧的遗留系统。</p><p id="918d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">基于主干的开发，云中的容器在路线图上，但在短期内它们根本不可能实现。</p><p id="39ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">向DevOps方向迈进的一步是消除孤岛(开发、质量保证、运营),因此我们必须以一种能让每个角色轻松协作的方式构建代码。</p><p id="f5d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我读过很多非常好的文章，关于如何用一些单页Javascript应用程序构建Spring Boot后端，也关于配置管理、基础设施供应、持续集成和交付，但现在我将所有这些结合起来，并提供一些脚手架供您构建。</p><h2 id="5699" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated">设置</h2><p id="ab36" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">我手头上有一个<a class="ae lj" href="https://jenkins.io/" rel="noopener ugc nofollow" target="_blank"> Jenkins </a>实例、ssh和一个漂亮的可运行的<a class="ae lj" href="https://spring.io/projects/spring-boot" rel="noopener ugc nofollow" target="_blank"> Spring Boot </a> jar。还有一个<a class="ae lj" href="https://www.redhat.com/en/technologies/linux-platforms/enterprise-linux" rel="noopener ugc nofollow" target="_blank"> RedHat7 </a> VM和一个<a class="ae lj" href="https://www.sonatype.com/nexus-repository-sonatype" rel="noopener ugc nofollow" target="_blank"> Nexus </a>作为工件库。所以我想我应该高兴我不再部署耳朵了！</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div class="gh gi lk"><img src="../Images/33a765f21566834be6850aa3e2e98807.png" data-original-src="https://miro.medium.com/v2/resize:fit:472/format:webp/1*g0FEMx1sQpSiJzKcjovuxg.png"/></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">詹金斯和ansi ble——一个简单但强大的组合</figcaption></figure><p id="f367" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我将使用这些工具构建一个<a class="ae lj" href="https://martinfowler.com/bliki/DeploymentPipeline.html" rel="noopener ugc nofollow" target="_blank">部署管道</a>,并将一切置于版本控制中，这样团队中的每个人都可以访问一切，并且知道他们的代码从提交到部署发生了什么(在这种情况下，直到测试环境)。</p><p id="07b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我使用以下结构:</p><pre class="ll lm ln lo gt lw lx ly lz aw ma bi"><span id="5866" class="kl km iq lx b gy mb mc l md me">parent<br/>+- backend<br/>+- frontend<br/>+- deployment<br/>Jenkinsfile</span></pre><p id="7b8e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了简单起见，<code class="fe mf mg mh lx b">backend</code> —一个Spring Boot应用程序—包含了<code class="fe mf mg mh lx b">frontend</code> <a class="ae lj" href="https://reactjs.org/" rel="noopener ugc nofollow" target="_blank"> ReactJS </a>应用程序，<code class="fe mf mg mh lx b">deployment</code>是工具持续交付的地方，根目录中的<code class="fe mf mg mh lx b"><a class="ae lj" href="https://jenkins.io/doc/book/pipeline/jenkinsfile/" rel="noopener ugc nofollow" target="_blank">Jenkinsfile</a></code>是我们管道的声明性描述符。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/f17475d445ccc7c14f9de4eea72598fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/1*CdMsiQpKpyy1wja9sElnVQ.png"/></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">Spring Boot与React——web应用程序的共同选择</figcaption></figure><p id="3f31" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们稍微了解一下这些模块！</p><h2 id="256c" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated">后端</h2><p id="db65" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">首先，它继承了Spring Boot的父代:</p><pre class="ll lm ln lo gt lw lx ly lz aw ma bi"><span id="0b1d" class="kl km iq lx b gy mb mc l md me">&lt;<strong class="lx ir">parent</strong>&gt;<br/>    &lt;<strong class="lx ir">groupId</strong>&gt;org.springframework.boot&lt;/<strong class="lx ir">groupId</strong>&gt;<br/>    &lt;<strong class="lx ir">artifactId</strong>&gt;spring-boot-starter-parent&lt;/<strong class="lx ir">artifactId</strong>&gt;<br/>    &lt;<strong class="lx ir">version</strong>&gt;2.0.3.RELEASE&lt;/<strong class="lx ir">version</strong>&gt;<br/>    &lt;<strong class="lx ir">relativePath</strong>/&gt;<br/>&lt;/<strong class="lx ir">parent</strong>&gt;</span></pre><p id="2d9e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们将<code class="fe mf mg mh lx b">frontend</code>应用程序包括在其他依赖项中:</p><pre class="ll lm ln lo gt lw lx ly lz aw ma bi"><span id="2987" class="kl km iq lx b gy mb mc l md me">&lt;<strong class="lx ir">dependencies</strong>&gt;<br/>... <br/>  &lt;<strong class="lx ir">dependency</strong>&gt;<br/>        &lt;<strong class="lx ir">groupId</strong>&gt;com.company.skeleton&lt;/<strong class="lx ir">groupId</strong>&gt;<br/>        &lt;<strong class="lx ir">artifactId</strong>&gt;frontend&lt;/<strong class="lx ir">artifactId</strong>&gt;<br/>        &lt;<strong class="lx ir">version</strong>&gt;0.0.1-SNAPSHOT&lt;/<strong class="lx ir">version</strong>&gt;<br/>    &lt;/<strong class="lx ir">dependency</strong>&gt;<br/>...<br/>&lt;/<strong class="lx ir">dependencies</strong>&gt;</span></pre><p id="7346" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我还使用<code class="fe mf mg mh lx b"><a class="ae lj" href="https://github.com/spotbugs/spotbugs" rel="noopener ugc nofollow" target="_blank">Spotbugs</a></code>、<code class="fe mf mg mh lx b"><a class="ae lj" href="http://checkstyle.sourceforge.net/" rel="noopener ugc nofollow" target="_blank">Checkstyle</a></code>和<code class="fe mf mg mh lx b"><a class="ae lj" href="https://www.eclemma.org/jacoco/" rel="noopener ugc nofollow" target="_blank">Jacoco</a></code>进行静态分析和代码覆盖，所以我们也必须包含那些插件。注意 <code class="fe mf mg mh lx b"><a class="ae lj" href="http://find-sec-bugs.github.io/" rel="noopener ugc nofollow" target="_blank">Spotbugs</a></code>的<a class="ae lj" href="http://find-sec-bugs.github.io/" rel="noopener ugc nofollow" target="_blank">安全插件，是安全</a>上的一个小<a class="ae lj" href="https://www.twistlock.com/2017/05/31/shift-left-security/" rel="noopener ugc nofollow" target="_blank">左移。</a></p><pre class="ll lm ln lo gt lw lx ly lz aw ma bi"><span id="8026" class="kl km iq lx b gy mb mc l md me">&lt;<strong class="lx ir">build</strong>&gt;<br/>    &lt;<strong class="lx ir">plugins</strong>&gt;<br/>        &lt;<strong class="lx ir">plugin</strong>&gt;<br/>            &lt;<strong class="lx ir">groupId</strong>&gt;org.springframework.boot&lt;/<strong class="lx ir">groupId</strong>&gt;<br/>            &lt;<strong class="lx ir">artifactId</strong>&gt;spring-boot-maven-plugin&lt;/<strong class="lx ir">artifactId</strong>&gt;<br/>            &lt;<strong class="lx ir">configuration</strong>&gt;<br/>                &lt;<strong class="lx ir">executable</strong>&gt;true&lt;/<strong class="lx ir">executable</strong>&gt;<br/>            &lt;/<strong class="lx ir">configuration</strong>&gt;<br/>        &lt;/<strong class="lx ir">plugin</strong>&gt;<br/>        &lt;<strong class="lx ir">plugin</strong>&gt;<br/>            &lt;<strong class="lx ir">groupId</strong>&gt;com.github.spotbugs&lt;/<strong class="lx ir">groupId</strong>&gt;<br/>            &lt;<strong class="lx ir">artifactId</strong>&gt;spotbugs-maven-plugin&lt;/<strong class="lx ir">artifactId</strong>&gt;<br/>            &lt;<strong class="lx ir">version</strong>&gt;3.1.3.1&lt;/<strong class="lx ir">version</strong>&gt;<br/>            &lt;<strong class="lx ir">configuration</strong>&gt;<br/>                &lt;<strong class="lx ir">effort</strong>&gt;Max&lt;/<strong class="lx ir">effort</strong>&gt;<br/>                &lt;<strong class="lx ir">threshold</strong>&gt;Low&lt;/<strong class="lx ir">threshold</strong>&gt;<br/>                &lt;<strong class="lx ir">failOnError</strong>&gt;true&lt;/<strong class="lx ir">failOnError</strong>&gt;<br/>                &lt;<strong class="lx ir">plugins</strong>&gt;<br/>                    &lt;<strong class="lx ir">plugin</strong>&gt;<br/>                        &lt;<strong class="lx ir">groupId</strong>&gt;com.h3xstream.findsecbugs&lt;/<strong class="lx ir">groupId</strong>&gt;<br/>                        &lt;<strong class="lx ir">artifactId</strong>&gt;findsecbugs-plugin&lt;/<strong class="lx ir">artifactId</strong>&gt;<br/>                        &lt;<strong class="lx ir">version</strong>&gt;LATEST&lt;/<strong class="lx ir">version</strong>&gt;<br/>                    &lt;/<strong class="lx ir">plugin</strong>&gt;<br/>                &lt;/<strong class="lx ir">plugins</strong>&gt;<br/>            &lt;/<strong class="lx ir">configuration</strong>&gt;<br/>        &lt;/<strong class="lx ir">plugin</strong>&gt;<br/>        &lt;<strong class="lx ir">plugin</strong>&gt;<br/>            &lt;<strong class="lx ir">groupId</strong>&gt;org.apache.maven.plugins&lt;/<strong class="lx ir">groupId</strong>&gt;<br/>            &lt;<strong class="lx ir">artifactId</strong>&gt;maven-checkstyle-plugin&lt;/<strong class="lx ir">artifactId</strong>&gt;<br/>            &lt;<strong class="lx ir">version</strong>&gt;3.0.0&lt;/<strong class="lx ir">version</strong>&gt;<br/>        &lt;/<strong class="lx ir">plugin</strong>&gt;<br/>        &lt;<strong class="lx ir">plugin</strong>&gt;<br/>            &lt;<strong class="lx ir">groupId</strong>&gt;org.jacoco&lt;/<strong class="lx ir">groupId</strong>&gt;<br/>            &lt;<strong class="lx ir">artifactId</strong>&gt;jacoco-maven-plugin&lt;/<strong class="lx ir">artifactId</strong>&gt;<br/>            &lt;<strong class="lx ir">version</strong>&gt;0.8.1&lt;/<strong class="lx ir">version</strong>&gt;<br/>            &lt;<strong class="lx ir">configuration</strong>&gt;<br/>                &lt;<strong class="lx ir">fileSets</strong>&gt;<br/>                    &lt;<strong class="lx ir">fileSet</strong>&gt;<br/>                        &lt;<strong class="lx ir">directory</strong>&gt;${project.build.directory}&lt;/<strong class="lx ir">directory</strong>&gt;<br/>                        &lt;<strong class="lx ir">includes</strong>&gt;<br/>                            &lt;<strong class="lx ir">include</strong>&gt;*.exec&lt;/<strong class="lx ir">include</strong>&gt;<br/>                        &lt;/<strong class="lx ir">includes</strong>&gt;<br/>                    &lt;/<strong class="lx ir">fileSet</strong>&gt;<br/>                &lt;/<strong class="lx ir">fileSets</strong>&gt;<br/>            &lt;/<strong class="lx ir">configuration</strong>&gt;<br/>            &lt;<strong class="lx ir">executions</strong>&gt;<br/>                &lt;<strong class="lx ir">execution</strong>&gt;<br/>                    &lt;<strong class="lx ir">id</strong>&gt;default-prepare-agent&lt;/<strong class="lx ir">id</strong>&gt;<br/>                    &lt;<strong class="lx ir">phase</strong>&gt;process-classes&lt;/<strong class="lx ir">phase</strong>&gt;<br/>                    &lt;<strong class="lx ir">goals</strong>&gt;<br/>                        &lt;<strong class="lx ir">goal</strong>&gt;prepare-agent&lt;/<strong class="lx ir">goal</strong>&gt;<br/>                    &lt;/<strong class="lx ir">goals</strong>&gt;<br/>                    &lt;<strong class="lx ir">configuration</strong>&gt;<br/>                        &lt;<strong class="lx ir">destFile</strong>&gt;${project.build.directory}/jacoco.exec&lt;/<strong class="lx ir">destFile</strong>&gt;<br/>                    &lt;/<strong class="lx ir">configuration</strong>&gt;<br/>                &lt;/<strong class="lx ir">execution</strong>&gt;<br/><br/>                &lt;<strong class="lx ir">execution</strong>&gt;<br/>                    &lt;<strong class="lx ir">id</strong>&gt;pre-integration-test&lt;/<strong class="lx ir">id</strong>&gt;<br/>                    &lt;<strong class="lx ir">phase</strong>&gt;pre-integration-test&lt;/<strong class="lx ir">phase</strong>&gt;<br/>                    &lt;<strong class="lx ir">goals</strong>&gt;<br/>                        &lt;<strong class="lx ir">goal</strong>&gt;prepare-agent&lt;/<strong class="lx ir">goal</strong>&gt;<br/>                    &lt;/<strong class="lx ir">goals</strong>&gt;<br/>                    &lt;<strong class="lx ir">configuration</strong>&gt;<br/>                        &lt;<strong class="lx ir">destFile</strong>&gt;${project.build.directory}/jacoco-it.exec&lt;/<strong class="lx ir">destFile</strong>&gt;<br/>                        &lt;<strong class="lx ir">propertyName</strong>&gt;failsafeArgLine&lt;/<strong class="lx ir">propertyName</strong>&gt;<br/>                    &lt;/<strong class="lx ir">configuration</strong>&gt;<br/>                &lt;/<strong class="lx ir">execution</strong>&gt;<br/>                &lt;<strong class="lx ir">execution</strong>&gt;<br/>                    &lt;<strong class="lx ir">id</strong>&gt;post-integration-test&lt;/<strong class="lx ir">id</strong>&gt;<br/>                    &lt;<strong class="lx ir">phase</strong>&gt;post-integration-test&lt;/<strong class="lx ir">phase</strong>&gt;<br/>                    &lt;<strong class="lx ir">goals</strong>&gt;<br/>                        &lt;<strong class="lx ir">goal</strong>&gt;report&lt;/<strong class="lx ir">goal</strong>&gt;<br/>                    &lt;/<strong class="lx ir">goals</strong>&gt;<br/>                    &lt;<strong class="lx ir">configuration</strong>&gt;<br/>                        &lt;<strong class="lx ir">dataFile</strong>&gt;${project.build.directory}/jacoco-it.exec&lt;/<strong class="lx ir">dataFile</strong>&gt;<br/>                        &lt;<strong class="lx ir">outputDirectory</strong>&gt;${project.reporting.outputDirectory}/jacoco-it&lt;/<strong class="lx ir">outputDirectory</strong>&gt;<br/>                    &lt;/<strong class="lx ir">configuration</strong>&gt;<br/>                &lt;/<strong class="lx ir">execution</strong>&gt;<br/>            &lt;/<strong class="lx ir">executions</strong>&gt;<br/>        &lt;/<strong class="lx ir">plugin</strong>&gt;<br/>        &lt;<strong class="lx ir">plugin</strong>&gt;<br/>            &lt;<strong class="lx ir">groupId</strong>&gt;pl.project13.maven&lt;/<strong class="lx ir">groupId</strong>&gt;<br/>            &lt;<strong class="lx ir">artifactId</strong>&gt;git-commit-id-plugin&lt;/<strong class="lx ir">artifactId</strong>&gt;<br/>        &lt;/<strong class="lx ir">plugin</strong>&gt;<br/>    &lt;/<strong class="lx ir">plugins</strong>&gt;<br/>&lt;/<strong class="lx ir">build</strong>&gt;</span></pre><p id="a2c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们准备搬到<code class="fe mf mg mh lx b">frontend.</code></p><h2 id="1a9b" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated">前端</h2><p id="5d71" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">由于我们需要一个可以作为maven依赖项包含的库，我们将把构建的资源复制到带有<code class="fe mf mg mh lx b">maven-resources-plugin</code>的jar的<code class="fe mf mg mh lx b">public</code>目录中。</p><p id="f505" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是首先我们也需要构建和测试这个模块。我们将使用<code class="fe mf mg mh lx b">frontend-maven-plugin</code>来完成这两个步骤，但是如果不喜欢maven方法，这两个步骤都可以用脚本或者直接在<code class="fe mf mg mh lx b">Jenkinsfile</code>中完成。</p><pre class="ll lm ln lo gt lw lx ly lz aw ma bi"><span id="f190" class="kl km iq lx b gy mb mc l md me">&lt;<strong class="lx ir">build</strong>&gt;<br/>    &lt;<strong class="lx ir">plugins</strong>&gt;<br/>        &lt;<strong class="lx ir">plugin</strong>&gt;<br/>            &lt;<strong class="lx ir">artifactId</strong>&gt;maven-resources-plugin&lt;/<strong class="lx ir">artifactId</strong>&gt;<br/>            &lt;<strong class="lx ir">version</strong>&gt;3.0.2&lt;/<strong class="lx ir">version</strong>&gt;<br/>            &lt;<strong class="lx ir">executions</strong>&gt;<br/>                &lt;<strong class="lx ir">execution</strong>&gt;<br/>                    &lt;<strong class="lx ir">id</strong>&gt;prepare-package&lt;/<strong class="lx ir">id</strong>&gt;<br/>                    &lt;<strong class="lx ir">phase</strong>&gt;prepare-package&lt;/<strong class="lx ir">phase</strong>&gt;<br/>                    &lt;<strong class="lx ir">goals</strong>&gt;<br/>                        &lt;<strong class="lx ir">goal</strong>&gt;copy-resources&lt;/<strong class="lx ir">goal</strong>&gt;<br/>                    &lt;/<strong class="lx ir">goals</strong>&gt;<br/>                    &lt;<strong class="lx ir">configuration</strong>&gt;<br/>                        &lt;<strong class="lx ir">outputDirectory</strong>&gt;${basedir}/target/classes/public&lt;/<strong class="lx ir">outputDirectory</strong>&gt;<br/>                        &lt;<strong class="lx ir">resources</strong>&gt;<br/>                            &lt;<strong class="lx ir">resource</strong>&gt;<br/>                                &lt;<strong class="lx ir">directory</strong>&gt;${project.basedir}/build&lt;/<strong class="lx ir">directory</strong>&gt;<br/>                            &lt;/<strong class="lx ir">resource</strong>&gt;<br/>                        &lt;/<strong class="lx ir">resources</strong>&gt;<br/>                    &lt;/<strong class="lx ir">configuration</strong>&gt;<br/>                &lt;/<strong class="lx ir">execution</strong>&gt;<br/>            &lt;/<strong class="lx ir">executions</strong>&gt;<br/>        &lt;/<strong class="lx ir">plugin</strong>&gt;<br/>        &lt;<strong class="lx ir">plugin</strong>&gt;<br/>            &lt;<strong class="lx ir">groupId</strong>&gt;com.github.eirslett&lt;/<strong class="lx ir">groupId</strong>&gt;<br/>            &lt;<strong class="lx ir">artifactId</strong>&gt;frontend-maven-plugin&lt;/<strong class="lx ir">artifactId</strong>&gt;<br/>            &lt;<strong class="lx ir">version</strong>&gt;1.6&lt;/<strong class="lx ir">version</strong>&gt;<br/>            &lt;<strong class="lx ir">executions</strong>&gt;<br/>                &lt;<strong class="lx ir">execution</strong>&gt;<br/>                    &lt;<strong class="lx ir">id</strong>&gt;install node and yarn&lt;/<strong class="lx ir">id</strong>&gt;<br/>                    &lt;<strong class="lx ir">goals</strong>&gt;<br/>                        &lt;<strong class="lx ir">goal</strong>&gt;install-node-and-yarn&lt;/<strong class="lx ir">goal</strong>&gt;<br/>                    &lt;/<strong class="lx ir">goals</strong>&gt;<br/>                    &lt;<strong class="lx ir">configuration</strong>&gt;<br/>                        &lt;<strong class="lx ir">nodeVersion</strong>&gt;v9.9.0&lt;/<strong class="lx ir">nodeVersion</strong>&gt;<br/>                        &lt;<strong class="lx ir">yarnVersion</strong>&gt;v1.5.1&lt;/<strong class="lx ir">yarnVersion</strong>&gt;<br/>                    &lt;/<strong class="lx ir">configuration</strong>&gt;<br/>                &lt;/<strong class="lx ir">execution</strong>&gt;<br/>                &lt;<strong class="lx ir">execution</strong>&gt;<br/>                    &lt;<strong class="lx ir">id</strong>&gt;yarn&lt;/<strong class="lx ir">id</strong>&gt;<br/>                    &lt;<strong class="lx ir">goals</strong>&gt;<br/>                        &lt;<strong class="lx ir">goal</strong>&gt;yarn&lt;/<strong class="lx ir">goal</strong>&gt;<br/>                    &lt;/<strong class="lx ir">goals</strong>&gt;<br/>                    &lt;<strong class="lx ir">phase</strong>&gt;prepare-package&lt;/<strong class="lx ir">phase</strong>&gt;<br/>                    &lt;<strong class="lx ir">configuration</strong>&gt;<br/>                    &lt;/<strong class="lx ir">configuration</strong>&gt;<br/>                &lt;/<strong class="lx ir">execution</strong>&gt;<br/>                &lt;<strong class="lx ir">execution</strong>&gt;<br/>                    &lt;<strong class="lx ir">id</strong>&gt;yarn build&lt;/<strong class="lx ir">id</strong>&gt;<br/>                    &lt;<strong class="lx ir">goals</strong>&gt;<br/>                        &lt;<strong class="lx ir">goal</strong>&gt;yarn&lt;/<strong class="lx ir">goal</strong>&gt;<br/>                    &lt;/<strong class="lx ir">goals</strong>&gt;<br/>                    &lt;<strong class="lx ir">phase</strong>&gt;prepare-package&lt;/<strong class="lx ir">phase</strong>&gt;<br/>                    &lt;<strong class="lx ir">configuration</strong>&gt;<br/>                        &lt;<strong class="lx ir">arguments</strong>&gt;build&lt;/<strong class="lx ir">arguments</strong>&gt;<br/>                    &lt;/<strong class="lx ir">configuration</strong>&gt;<br/>                &lt;/<strong class="lx ir">execution</strong>&gt;<br/>                &lt;<strong class="lx ir">execution</strong>&gt;<br/>                    &lt;<strong class="lx ir">id</strong>&gt;test&lt;/<strong class="lx ir">id</strong>&gt;<br/>                    &lt;<strong class="lx ir">goals</strong>&gt;<br/>                        &lt;<strong class="lx ir">goal</strong>&gt;yarn&lt;/<strong class="lx ir">goal</strong>&gt;<br/>                    &lt;/<strong class="lx ir">goals</strong>&gt;<br/>                    &lt;<strong class="lx ir">phase</strong>&gt;test&lt;/<strong class="lx ir">phase</strong>&gt;<br/>                    &lt;<strong class="lx ir">configuration</strong>&gt;&gt;<br/>                        &lt;<strong class="lx ir">arguments</strong>&gt;test&lt;/<strong class="lx ir">arguments</strong>&gt;<br/>                        &lt;<strong class="lx ir">environmentVariables</strong>&gt;<br/>                            &lt;<strong class="lx ir">CI</strong>&gt;true&lt;/<strong class="lx ir">CI</strong>&gt;<br/>                        &lt;/<strong class="lx ir">environmentVariables</strong>&gt;<br/>                    &lt;/<strong class="lx ir">configuration</strong>&gt;<br/>                &lt;/<strong class="lx ir">execution</strong>&gt;<br/>            &lt;/<strong class="lx ir">executions</strong>&gt;<br/>        &lt;/<strong class="lx ir">plugin</strong>&gt;<br/>    &lt;/<strong class="lx ir">plugins</strong>&gt;<br/>&lt;/<strong class="lx ir">build</strong>&gt;</span></pre><p id="4e52" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们和Jenkins一起构建一切！</p><h2 id="2349" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated">詹金斯文件</h2><p id="d2e1" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">我们将在这里创建以下管道:</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mj"><img src="../Images/9789b2e96d2bf0eedf69d6900e85eb79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yHIPUy7Sh8xAZEGjoKgWqw.png"/></div></div></figure><p id="48f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们用声明的方式。</p><p id="c59e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe mf mg mh lx b">Build</code>阶段，我们并行构建<code class="fe mf mg mh lx b">frontend</code>和<code class="fe mf mg mh lx b">backend</code>。</p><p id="6ead" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当然，我们必须记住<code class="fe mf mg mh lx b">backend</code>依赖于<code class="fe mf mg mh lx b">frontend</code>模块产生的工件，因此我们必须在两个并行构建之后包含另一个步骤来创建runnable jar，但是这次我们可以跳过运行测试。</p><pre class="ll lm ln lo gt lw lx ly lz aw ma bi"><span id="babf" class="kl km iq lx b gy mb mc l md me">pipeline {<br/>    agent { label 'RHEL' }<br/>    tools {<br/>        maven 'Maven 3.3.9'<br/>        jdk 'jdk1.8.0'<br/>    }<br/>    stages {<br/>        stage('Build') {<br/>            parallel {<br/>                stage('Build Backend'){<br/>                    steps {<br/>                        dir('backend'){<br/>                            sh 'mvn clean test spotbugs:spotbugs checkstyle:checkstyle'<br/>                        }<br/>                    }<br/>                    post {<br/>                        always {<br/>                            junit 'backend/target/surefire-reports/*.xml'<br/>                            findbugs canComputeNew: false, defaultEncoding: '', excludePattern: '', healthy: '', includePattern: '', pattern: '**/spotbugsXml.xml', unHealthy: ''<br/>                            checkstyle canComputeNew: false, defaultEncoding: '', healthy: '', pattern: '**/checkstyle-result.xml', unHealthy: ''<br/>                            jacoco()<br/>                        }<br/>                    }<br/>                }<br/>                stage('Build Frontend'){<br/>                    steps {<br/>                        dir('frontend'){<br/>                            sh 'mvn clean install'<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>        stage('Create runnable jar'){<br/>             steps {<br/>                dir('backend'){<br/>                    sh 'mvn deploy -DskipTests'<br/>                }<br/>            }<br/>        }        <br/>    }<br/>}</span></pre><p id="4dc4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可能你已经注意到我使用了<code class="fe mf mg mh lx b">mvn deploy</code>而不是<code class="fe mf mg mh lx b">mvn install</code>，这是因为我们在这里使用了一个工件库，也就是Nexus。</p><p id="b3a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那是我们唯一的真相来源，我们所有的人造物品都存放在那里。这是我们在所有环境中提取工件的地方。</p><p id="8952" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个工件库必须在<code class="fe mf mg mh lx b">backend</code>的<code class="fe mf mg mh lx b">pom.xml</code>中定义。</p><pre class="ll lm ln lo gt lw lx ly lz aw ma bi"><span id="cad0" class="kl km iq lx b gy mb mc l md me">&lt;<strong class="lx ir">distributionManagement</strong>&gt;<br/>    &lt;<strong class="lx ir">repository</strong>&gt;<br/>        &lt;<strong class="lx ir">uniqueVersion</strong>&gt;true&lt;/<strong class="lx ir">uniqueVersion</strong>&gt;<br/>        &lt;<strong class="lx ir">id</strong>&gt;Releases&lt;/<strong class="lx ir">id</strong>&gt;<br/>        &lt;<strong class="lx ir">layout</strong>&gt;default&lt;/<strong class="lx ir">layout</strong>&gt;<br/>        &lt;<strong class="lx ir">url</strong>&gt;http://nexus.edudoo.com/&lt;/<strong class="lx ir">url</strong>&gt;<br/>    &lt;/<strong class="lx ir">repository</strong>&gt;<br/>    &lt;<strong class="lx ir">snapshotRepository</strong>&gt;<br/>        &lt;<strong class="lx ir">uniqueVersion</strong>&gt;false&lt;/<strong class="lx ir">uniqueVersion</strong>&gt;<br/>        &lt;<strong class="lx ir">id</strong>&gt;Snapshots&lt;/<strong class="lx ir">id</strong>&gt;<br/>        &lt;<strong class="lx ir">layout</strong>&gt;default&lt;/<strong class="lx ir">layout</strong>&gt;<br/>        &lt;<strong class="lx ir">url</strong>&gt;http://nexus.edudoo.com/&lt;/<strong class="lx ir">url</strong>&gt;<br/>    &lt;/<strong class="lx ir">snapshotRepository</strong>&gt;<br/>&lt;/<strong class="lx ir">distributionManagement</strong>&gt;</span></pre><h2 id="966f" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated">部署</h2><p id="037a" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">正如我提到的，我有一个RedHat7虚拟机和ssh访问。只需要ssh访问的最简单的工具是<a class="ae lj" href="https://www.ansible.com/" rel="noopener ugc nofollow" target="_blank"> Ansible </a>，所以我们使用它，它必须安装在Jenkins节点上。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/aae5dcdf4df19258afbd6793b399bdbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1318/format:webp/1*7q6_c3qDzfm--XHXzI7Eew.png"/></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">简单的IT自动化</figcaption></figure><p id="e86d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一个要做的决定是如何运行我们的应用程序。我们可以创建一些shell脚本来启动/停止java jar，但是更复杂一点的解决方案是使用流程/服务管理器。</p><p id="12f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我可以选择<a class="ae lj" href="http://supervisord.org/index.html" rel="noopener ugc nofollow" target="_blank"> Supervisor </a>或其他，但这不是我们的RedHat Linux机器所支持的，所以让我们继续使用<a class="ae lj" href="https://en.wikipedia.org/wiki/Systemd" rel="noopener ugc nofollow" target="_blank"> systemd </a>。</p><p id="ac42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们每次将要执行的步骤如下:</p><ul class=""><li id="09dd" class="mp mq iq jp b jq jr ju jv jy mr kc ms kg mt kk mu mv mw mx bi translated">通过安装所需的软件包来准备环境，</li><li id="a3e4" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk mu mv mw mx bi translated">准备并推送应用程序的配置，</li><li id="96f8" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk mu mv mw mx bi translated">把罐子从Nexus拉出来，</li><li id="ccc2" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk mu mv mw mx bi translated">创建(或更新)并(重新)启动systemd服务。</li></ul><p id="ca6c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们的例子中，创建环境意味着更新包并安装java。这些在角色<code class="fe mf mg mh lx b">common</code>中定义:</p><pre class="ll lm ln lo gt lw lx ly lz aw ma bi"><span id="36a8" class="kl km iq lx b gy mb mc l md me">- <strong class="lx ir">name: </strong>Ensure kernel is at the latest version<br/>  <strong class="lx ir">yum: </strong>name=kernel state=latest<br/><br/>- <strong class="lx ir">name: </strong>Install latest Java 8<br/>  <strong class="lx ir">yum: </strong>name=java-1.8.0-openjdk.x86_64 state=latest</span></pre><p id="0ef6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mf mg mh lx b">deploy</code>角色包含剩下的部分，首先我们将jar放入<code class="fe mf mg mh lx b">/opt</code>的一个目录中:</p><pre class="ll lm ln lo gt lw lx ly lz aw ma bi"><span id="b9df" class="kl km iq lx b gy mb mc l md me">- <strong class="lx ir">name: </strong>Create skeleton directory<br/>  <strong class="lx ir">file: </strong>path=/opt/skeleton state=directory<br/><br/>- <strong class="lx ir">name: </strong>Download skeleton runnable jar<br/>  <strong class="lx ir">get_url:<br/>    url: </strong>http://nexus.edudoo.com/artifact/maven/content?g=com.edudoo.skeleton&amp;a=backend&amp;v=0.0.1-SNAPSHOT&amp;r=snapshots<br/>    <strong class="lx ir">dest: </strong>/opt/skeleton/skeleton.jar<br/>    <strong class="lx ir">backup: </strong>yes<br/>    <strong class="lx ir">force: </strong>yes</span></pre><p id="4443" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在配置管理部分:</p><pre class="ll lm ln lo gt lw lx ly lz aw ma bi"><span id="f5aa" class="kl km iq lx b gy mb mc l md me">- <strong class="lx ir">name: </strong>Ensure app is configured<br/>  <strong class="lx ir">template:<br/>    src: </strong>application.properties.j2<br/>    <strong class="lx ir">dest: </strong>/opt/skeleton/application.properties<br/><br/>- <strong class="lx ir">name: </strong>Ensure logging is configured<br/>  <strong class="lx ir">template:<br/>    src: </strong>logback-spring.xml.j2<br/>    <strong class="lx ir">dest: </strong>/opt/skeleton/logback-spring.xml</span></pre><p id="afc1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Spring boot应用程序是由runnable jar旁边的<code class="fe mf mg mh lx b">application.properties</code>文件配置的。有了上面的<code class="fe mf mg mh lx b">template</code>，我们可以从一个环境到另一个环境替换它的内容。</p><p id="b025" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们来看看模板本身:</p><pre class="ll lm ln lo gt lw lx ly lz aw ma bi"><span id="8c70" class="kl km iq lx b gy mb mc l md me">server.port={{skeleton_port}}<br/>logging.config=/opt/skeleton/logback-spring.xml<br/>logging.file=/opt/skeleton/skeleton.log</span></pre><p id="5a47" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我们运行ansible脚本时，<code class="fe mf mg mh lx b">skeleton_port</code>将被一个提供的值替换。我们稍后再回到这个话题。</p><p id="5cf3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">(这同样适用于日志配置。)</p><p id="2469" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后是关于服务的部分:</p><pre class="ll lm ln lo gt lw lx ly lz aw ma bi"><span id="40d2" class="kl km iq lx b gy mb mc l md me">- <strong class="lx ir">name: </strong>Install skeleton systemd unit file<br/>  <strong class="lx ir">template: </strong>src=skeleton.service.j2 dest=/etc/systemd/system/skeleton.service<br/><br/>- <strong class="lx ir">name: </strong>Start skeleton<br/>  <strong class="lx ir">systemd: </strong>state=restarted name=skeleton daemon_reload=yes</span></pre><p id="43ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">模板目前实际上不包含任何变量(但是可以，例如，java args来动态控制内存消耗):</p><pre class="ll lm ln lo gt lw lx ly lz aw ma bi"><span id="f1f7" class="kl km iq lx b gy mb mc l md me">[Unit]<br/>Description=Skeleton Service<br/><br/>[Service]<br/>User=root<br/>WorkingDirectory=/opt/skeleton/<br/>ExecStart=/usr/bin/java -Xmx256m -jar skeleton.jar<br/>SuccessExitStatus=143<br/>TimeoutStopSec=10<br/>Restart=always<br/>RestartSec=5<br/><br/>[Install]<br/>WantedBy=multi-user.target</span></pre><p id="595d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">剩下要定义的是一个包含环境的清单文件(例如<code class="fe mf mg mh lx b">dev-servers</code>):</p><pre class="ll lm ln lo gt lw lx ly lz aw ma bi"><span id="1eab" class="kl km iq lx b gy mb mc l md me">[test]<br/>11.22.33.44</span><span id="b739" class="kl km iq lx b gy nd mc l md me">[prod]<br/>11.22.33.45<br/>11.22.33.46</span></pre><p id="df82" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以及一个包含所有步骤的剧本(<code class="fe mf mg mh lx b">site.yml</code>):</p><pre class="ll lm ln lo gt lw lx ly lz aw ma bi"><span id="6bff" class="kl km iq lx b gy mb mc l md me">---<br/>- <strong class="lx ir">hosts: </strong>test<br/>  <strong class="lx ir">remote_user: </strong>clouduser<br/>  <strong class="lx ir">roles:<br/>     </strong>- common<br/>     - deploy<br/><br/>  <strong class="lx ir">vars:<br/>    </strong>- <strong class="lx ir">skeleton_port: </strong>80</span></pre><p id="2bff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意，我们在这里为变量<code class="fe mf mg mh lx b">skeleton_port</code>定义了一个值，它将在application.properties文件的模板中被替换。</p><p id="5ac6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，让我们将它添加到我们的<code class="fe mf mg mh lx b">Jenkinsfile</code>:</p><pre class="ll lm ln lo gt lw lx ly lz aw ma bi"><span id="8bf4" class="kl km iq lx b gy mb mc l md me">...<br/>stage('Deploy to test'){<br/>    steps {<br/>        dir('deployment'){ //do this in the deployment directory!<br/>            echo 'Deploying to test'<br/>            sh 'ansible-playbook -i dev-servers site.yml'<br/>        }<br/>    }<br/>}<br/>...</span></pre><p id="3fa7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们已经准备好了，我们只需要将所有东西提交到一个git存储库中，并让Jenkins知道可以从那里取出<code class="fe mf mg mh lx b">Jenkinsfile</code>。</p><h2 id="10dc" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated">配置Jenkins</h2><p id="b4dc" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">在Jenkins中，您应该创建一个新的<code class="fe mf mg mh lx b">Multibranch Pipeline</code>，在配置页面上，唯一需要设置的是源:</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi ne"><img src="../Images/66808679cf391531ff9f4cdb7d9d09e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ggxQ7YPe24j1BgITai09EA.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">詹金斯构型</figcaption></figure><p id="f447" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">保存、运行和享受！</p><p id="9bfd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该代码可在<a class="ae lj" href="https://github.com/balazsmaria/skeleton" rel="noopener ugc nofollow" target="_blank">https://github.com/balazsmaria/skeleton</a>获得</p></div></div>    
</body>
</html>