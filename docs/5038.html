<html>
<head>
<title>ArgoCD: an overview, SSL configuration, and an application deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ArgoCD:概述、SSL配置和应用程序部署</h1>
<blockquote>原文：<a href="https://itnext.io/argocd-an-overview-ssl-configuration-and-an-application-deploy-89d8947d95cf?source=collection_archive---------3-----------------------#2020-11-22">https://itnext.io/argocd-an-overview-ssl-configuration-and-an-application-deploy-89d8947d95cf?source=collection_archive---------3-----------------------#2020-11-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/6fa9fa8d92e262b4258055084897046e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8MDBjrYv5W2ANPok4EO3Tg.png"/></div></div></figure><p id="823a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ArgoCD通过使用GitOps方法帮助向Kubernetes交付应用程序，即当Git-repository用作信任源时，所有清单、配置和其他数据都存储在一个存储库中。</p><p id="0d11" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它可以和Kubernetes manifest、<a class="ae kw" href="https://kustomize.io/" rel="noopener ugc nofollow" target="_blank"> kustomize </a>、<a class="ae kw" href="https://ksonnet.io/" rel="noopener ugc nofollow" target="_blank"> ksonnet </a>、<a class="ae kw" href="https://jsonnet.org/" rel="noopener ugc nofollow" target="_blank"> jsonnet </a>以及我们在项目中使用的东西——舵图一起使用。</p><p id="baf3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ArgoCD在集群中旋转其控制器，并观察存储库中的变化，以将其与部署在集群中的资源进行比较，同步它们的状态。</p><p id="54c6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一些真正有用的附加功能是带SAML的SSO，因此我们可以将其与我们的<a class="ae kw" href="https://rtfm.co.ua/en/what-is-saml-an-overview-its-structure-and-requests-tracing-between-a-jenkins-and-okta-sso/" rel="noopener ugc nofollow" target="_blank"> Okta </a>集成，它可以部署到多个集群，Kubernetes RBAC支持，出色的WebUI和CLI，Github，GitLab等webhooks集成，加上开箱即用的Prometheus metrics，以及出色的<a class="ae kw" href="https://argoproj.github.io/argo-cd/" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="80d3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我正计划用詹金斯和赫尔姆来取代我们目前的部署流程，请参见<a class="ae kw" href="https://rtfm.co.ua/helm-poshagovoe-sozdanie-charta-i-deplojmenta-iz-jenkins/" rel="noopener ugc nofollow" target="_blank">赫尔姆:пошаговое·созданиечартаиелокментаиаа詹金斯</a>帖子(<em class="kx">俄罗斯</em>)。</p><h1 id="7f9b" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">内容</h1><ul class=""><li id="3494" class="lw lx iq ka b kb ly kf lz kj ma kn mb kr mc kv md me mf mg bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-an-overview-ssl-configuration-and-an-application-deploy/#Components" rel="noopener ugc nofollow" target="_blank">组件</a></li><li id="8721" class="lw lx iq ka b kb mh kf mi kj mj kn mk kr ml kv md me mf mg bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-an-overview-ssl-configuration-and-an-application-deploy/#ArgoCD_CLI_installation" rel="noopener ugc nofollow" target="_blank"> ArgoCD CLI安装</a></li><li id="e0c1" class="lw lx iq ka b kb mh kf mi kj mj kn mk kr ml kv md me mf mg bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-an-overview-ssl-configuration-and-an-application-deploy/#Running_ArgoCD_in_Kubernetes" rel="noopener ugc nofollow" target="_blank">在Kubernetes中运行ArgoCD</a></li><li id="8163" class="lw lx iq ka b kb mh kf mi kj mj kn mk kr ml kv md me mf mg bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-an-overview-ssl-configuration-and-an-application-deploy/#LoadBalancer,_SSL,_and_DNS" rel="noopener ugc nofollow" target="_blank">负载平衡器、SSL和DNS </a></li><li id="5b49" class="lw lx iq ka b kb mh kf mi kj mj kn mk kr ml kv md me mf mg bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-an-overview-ssl-configuration-and-an-application-deploy/#ArgoCD_SSL_ERRTOOMANYREDIRECTS" rel="noopener ugc nofollow" target="_blank">ArgoCD SSL:ERR _ TOO _ MANY _ REDIRECTS</a></li><li id="497b" class="lw lx iq ka b kb mh kf mi kj mj kn mk kr ml kv md me mf mg bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-an-overview-ssl-configuration-and-an-application-deploy/#ArgoCD_deploy_from_a_Github_repository" rel="noopener ugc nofollow" target="_blank"> ArgoCD:从Github库部署</a></li><li id="0d17" class="lw lx iq ka b kb mh kf mi kj mj kn mk kr ml kv md me mf mg bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-an-overview-ssl-configuration-and-an-application-deploy/#ArgocD_ComparisonError_failed_to_load_initial_state_of_resource" rel="noopener ugc nofollow" target="_blank"> ArgocD: ComparisonError加载资源初始状态失败</a></li></ul><h1 id="1f1f" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">成分</h1><p id="825c" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">ArgoCD由三个主要组件组成— API服务器、存储库服务器和应用程序控制器。</p><ul class=""><li id="25aa" class="lw lx iq ka b kb kc kf kg kj mp kn mq kr mr kv md me mf mg bi translated">API服务器(pod: <em class="kx"> argocd-server </em>):控制整个argocd实例，它的所有操作、认证和存储为Kubernetes秘密的秘密访问等</li><li id="8971" class="lw lx iq ka b kb mh kf mi kj mj kn mk kr ml kv md me mf mg bi translated">存储库服务器(pod: <em class="kx"> argocd-repo-server </em>):存储和同步来自已配置的Git存储库的数据，并生成Kubernetes清单</li><li id="4f88" class="lw lx iq ka b kb mh kf mi kj mj kn mk kr ml kv md me mf mg bi translated">应用程序控制器(pod:<em class="kx">argocd-application-Controller</em>):用于监控Kubernetes集群中的应用程序，使它们与存储库中描述的一致，并控制PreSync、Sync、PostSync挂钩</li></ul><h1 id="459e" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">ArgoCD CLI安装</h1><p id="3443" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">在macOS中:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="eed0" class="nb kz iq mx b gy nc nd l ne nf">$ brew install argocd</span></pre><p id="9147" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Linux中—来自Github存储库:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="a5c9" class="nb kz iq mx b gy nc nd l ne nf">$ VERSION=$(curl — silent “https://api.github.com/repos/argoproj/argo-cd/releases/latest" | grep ‘“tag_name”’ | sed -E ‘s/.*”([^”]+)”.*/\1/’)</span><span id="5768" class="nb kz iq mx b gy ng nd l ne nf">$ sudo curl -sSL -o /usr/local/bin/argocd <a class="ae kw" href="https://github.com/argoproj/argo-cd/releases/download/$VERSION/argocd-linux-amd64" rel="noopener ugc nofollow" target="_blank">https://github.com/argoproj/argo-cd/releases/download/$VERSION/argocd-linux-amd64</a></span><span id="6acc" class="nb kz iq mx b gy ng nd l ne nf">$ sudo chmod +x /usr/local/bin/argocd</span></pre><p id="a01f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查一下:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="cff1" class="nb kz iq mx b gy nc nd l ne nf">$ argocd version<br/>argocd: v1.7.9+f6dc8c3<br/>BuildDate: 2020–11–17T23:18:20Z<br/>GitCommit: f6dc8c389a00d08254f66af78d0cae1fdecf7484<br/>GitTreeState: clean<br/>GoVersion: go1.14.12<br/>Compiler: gc<br/>Platform: linux/amd64</span></pre><h1 id="0947" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">在Kubernetes运行ArgoCD</h1><p id="20f5" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">让我们旋转一个ArgoCD实例。我们可以使用文档中的清单来创建所有必要的资源，如CRD、服务帐户、RBAC角色和绑定配置映射、机密、服务和部署。</p><p id="47a0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我很确定ArgoCD已经有一个现成的舵图，但是这次让我们按照<a class="ae kw" href="https://argoproj.github.io/argo-cd/getting_started/" rel="noopener ugc nofollow" target="_blank">入门</a>中的描述使用清单。</p><p id="786c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">文档建议使用<em class="kx"> argocd </em>名称空间，这样会更简单，但我们并不追求简单，所以让我们创建自己的名称空间:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="00f6" class="nb kz iq mx b gy nc nd l ne nf">$ kubectl create namespace dev-1-devops-argocd-ns<br/>namespace/dev-1-devops-argocd-ns created</span></pre><p id="c799" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署资源:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="51ff" class="nb kz iq mx b gy nc nd l ne nf">$ kubectl apply -n dev-1-devops-argocd-ns -f <a class="ae kw" href="https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml</a></span></pre><p id="1e2d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">编辑<em class="kx"> argcd-server </em>服务——将其类型更改为LoadBalancer，以便从世界访问WebUI:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="2e48" class="nb kz iq mx b gy nc nd l ne nf">$ kubectl -n dev-1-devops-argocd-ns patch svc argocd-server -p ‘{“spec”: {“type”: “LoadBalancer”}}’<br/>service/argocd-server patched</span></pre><p id="8d71" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">找到它的网址:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="0d56" class="nb kz iq mx b gy nc nd l ne nf">$ kubectl -n dev-1-devops-argocd-ns get svc argocd-server<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br/>argocd-server LoadBalancer 172.20.142.44 ada***585.us-east-2.elb.amazonaws.com 80:32397/TCP,443:31693/TCP 4m21s</span></pre><p id="8bc7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ArgoCD的密码是自动生成的，设置为其pod的名称，使用下一个命令获取它:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="40b7" class="nb kz iq mx b gy nc nd l ne nf">$ kubectl -n dev-1-devops-argocd-ns get pods -l app.kubernetes.io/name=argocd-server -o name | cut -d’/’ -f 2<br/>argocd-server-794857c8fb-xqgmv</span></pre><p id="8529" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过CLI登录，不要注意证书错误:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="edc9" class="nb kz iq mx b gy nc nd l ne nf">$ argocd login ada***585.us-east-2.elb.amazonaws.com<br/>WARNING: server certificate had error: x509: certificate is valid for localhost, argocd-server, argocd-server.dev-1-devops-argocd-ns, argocd-server.dev-1-devops-argocd-ns.svc, argocd-server.dev-1-devops-argocd-ns.svc.cluster.local, not ada***585.us-east-2.elb.amazonaws.com. Proceed insecurely (y/n)? y<br/>Username: admin<br/>Password:<br/>‘admin’ logged in successfully<br/>Context ‘ada***585.us-east-2.elb.amazonaws.com’ updated</span></pre><p id="9721" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更改密码:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="6724" class="nb kz iq mx b gy nc nd l ne nf">$ argocd account update-password<br/>*** Enter current password:<br/>*** Enter new password:<br/>*** Confirm new password:<br/>Password updated</span></pre><p id="99f6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">打开WebUI，再次忽略SSL警告，我们将立即设置它，然后登录:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/96c094a4eb1a2a818eb794d313f61f09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5NtHqF48WqobMzTb.png"/></div></div></figure><h1 id="7de9" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">负载平衡器、SSL和DNS</h1><p id="1560" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">酷—我们已经运行了所有服务，现在让我们配置一个DNS名称和一个SSL证书。</p><p id="152b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">AWS ALB和ELB不支持gRPC，参见<a class="ae kw" href="https://argoproj.github.io/argo-cd/operator-manual/ingress/#aws-application-load-balancers-albs-and-classic-elb-http-mode" rel="noopener ugc nofollow" target="_blank"> AWS应用负载平衡器(ALBs)和经典ELB (HTTP模式)</a>，因此这里我们不能使用<a class="ae kw" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-running-alb-ingress-controller/" rel="noopener ugc nofollow" target="_blank"> ALB入口控制器</a>。</p><p id="5fa5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们像上面一样保留负载平衡器类型的服务—它创建了一个AWS经典负载平衡器。</p><p id="fc39" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">SSL证书可以在创建我们的集群和负载平衡器并保存其ARN的同一区域使用<a class="ae kw" href="https://aws.amazon.com/certificate-manager/" rel="noopener ugc nofollow" target="_blank"> AWS证书管理器</a>发布。</p><p id="1076" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下载清单文件:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="46e8" class="nb kz iq mx b gy nc nd l ne nf">$ wget <a class="ae kw" href="https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml</a></span></pre><p id="1306" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">找到<em class="kx"> argocd-server </em>服务:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="d5d6" class="nb kz iq mx b gy nc nd l ne nf">---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  labels:<br/>    app.kubernetes.io/component: server<br/>    app.kubernetes.io/name: argocd-server<br/>    app.kubernetes.io/part-of: argocd<br/>  name: argocd-server<br/>spec:<br/>  ports:<br/>  - name: http<br/>    port: 80<br/>    protocol: TCP<br/>    targetPort: 8080<br/>  - name: https<br/>    port: 443<br/>    protocol: TCP<br/>    targetPort: 8080<br/>  selector:<br/>    app.kubernetes.io/name: argocd-server</span></pre><p id="efae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe ni nj nk mx b">spec.type</code>-<code class="fe ni nj nk mx b">LoadBalancer</code>类型中添加<code class="fe ni nj nk mx b">service.beta.kubernetes.io/aws-load-balancer-ssl-cert</code>，并用<code class="fe ni nj nk mx b">loadBalancerSourceRanges</code>限制访问:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="13d0" class="nb kz iq mx b gy nc nd l ne nf">---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  labels:<br/>    app.kubernetes.io/component: server<br/>    app.kubernetes.io/name: argocd-server<br/>    app.kubernetes.io/part-of: argocd<br/>  name: argocd-server<br/>  annotations:<br/>    service.beta.kubernetes.io/aws-load-balancer-ssl-cert: "arn:aws:acm:us-east-1:534***385:certificate/ddaf55b0-***-53d57c5ca706"<br/>spec:<br/>  type: LoadBalancer<br/>  loadBalancerSourceRanges:<br/>  - "31.***.***.117/32"<br/>  - "194.***.***.24/29"<br/>  ports:<br/>  - name: http<br/>    port: 80<br/>    protocol: TCP<br/>    targetPort: 8080<br/>  - name: https<br/>    port: 443<br/>    protocol: TCP<br/>    targetPort: 8080<br/>  selector:<br/>    app.kubernetes.io/name: argocd-server</span></pre><p id="6084" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署它:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="f581" class="nb kz iq mx b gy nc nd l ne nf">$ kubectl -n dev-1-devops-argocd-ns apply -f install.yaml</span></pre><p id="7df6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查ELB的SSL:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/2b46aa4532953bc9cd94941087746c1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*myfaFlL1O-_Dj7lY.png"/></div></div></figure><p id="cd73" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建DNS记录:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/a8e3c3f4ff9f49bf4f011ee9ab108221.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/0*zHDbNxtghjOuS5QG.png"/></div></figure><p id="ce1f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">打开URL —并获得<strong class="ka ir"><em class="kx">ERR _ TOO _ MANY _ REDIRECTS</em></strong>error<em class="kx">:</em></p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/4536bc83fb84e85b8b3a6d8d20c4fb82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/0*T4uzQFm8XwugFLx3.png"/></div></figure><h2 id="5d72" class="nb kz iq bd la no np dn le nq nr dp li kj ns nt lm kn nu nv lq kr nw nx lu ny bi translated">ArgoCD SSL:ERR _ TOO _ MANY _ REDIRECTS</h2><p id="8a55" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">去谷歌上找这个话题——<a class="ae kw" href="https://github.com/argoproj/argo-cd/issues/2953" rel="noopener ugc nofollow" target="_blank">https://github.com/argoproj/argo-cd/issues/2953</a>。</p><p id="bdd8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">回到<code class="fe ni nj nk mx b">install.yaml</code>，在<code class="fe ni nj nk mx b">Deployment</code> <em class="kx"> argocd-server </em>中添加<code class="fe ni nj nk mx b">--insecure</code>标志:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="c32e" class="nb kz iq mx b gy nc nd l ne nf">---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  labels:<br/>    app.kubernetes.io/component: server<br/>    app.kubernetes.io/name: argocd-server<br/>    app.kubernetes.io/part-of: argocd<br/>  name: argocd-server<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app.kubernetes.io/name: argocd-server<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app.kubernetes.io/name: argocd-server<br/>    spec:<br/>      containers:<br/>      - command:<br/>        - argocd-server<br/>        - --staticassets<br/>        - /shared/app<br/>        - --insecure<br/>...</span></pre><p id="f62f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署它，并检查:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/ba6e7396e1caa7ad02e2a94472eb683d.png" data-original-src="https://miro.medium.com/v2/resize:fit:990/format:webp/0*FM_anLMx3qwJsETS.png"/></div></figure><p id="949c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好了——我们到此为止。</p><h1 id="e3ee" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">ArgoCD:从Github存储库部署</h1><p id="1094" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">让我们从《入门指南》中的示例开始——在接下来的部分中，我们将观察Helm的部署。</p><p id="7ca9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">点击<em class="kx">新建App </em>，指定名称，并设置<em class="kx">项目</em>=<em class="kx">默认</em>:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/e07119da8aa309260913deb5d8fd7d6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:848/format:webp/0*c4wwmhw80BRR1Xo1.png"/></div></figure><p id="c3bd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<em class="kx"> Git </em>中设置<a class="ae kw" href="https://github.com/argoproj/argocd-example-apps.gi" rel="noopener ugc nofollow" target="_blank">https://github.com/argoproj/argocd-example-apps.git</a>URL和repo — <em class="kx">留言簿</em>中的路径:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/725057e758b9b9f4f5b27c678c4796ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dLdhIFG95ktbFmJM.png"/></div></div></figure><p id="4af2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在目的地—<a class="ae kw" href="https://kubernetes.default.svc" rel="noopener ugc nofollow" target="_blank"><em class="kx">https://kubernetes . default . SVC</em></a>和<em class="kx">默认</em>命名空间中，点击<em class="kx">创建</em>:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/fa6827c1dd13b912847b7e375f50c4dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:870/format:webp/0*JMQanS6BHai07mFg.png"/></div></figure><p id="8965" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">貌似是创建的，但是为什么它的同步状态是<em class="kx">未知</em>？</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/9a3a8279ca462055d0e5b98fcc9b6f37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sTSz7exRFMJai_Q9.png"/></div></div></figure><p id="1fa6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有些事情出错了:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="567d" class="nb kz iq mx b gy nc nd l ne nf">$ argocd app get guestbook<br/>Name: guestbook<br/>Project: default<br/>Server: <a class="ae kw" href="https://kubernetes.default.svc" rel="noopener ugc nofollow" target="_blank">https://kubernetes.default.svc</a><br/>Namespace: default<br/>…<br/>CONDITION MESSAGE LAST TRANSITION<br/>ComparisonError failed to load initial state of resource PersistentVolumeClaim: persistentvolumeclaims is forbidden: User “system:serviceaccount:dev-1-devops-argocd-ns:argocd-application-controller” cannot list resource “persistentvolumeclaims” in API group “” at the cluster scope 2020–11–19 15:35:51 +0200 EET<br/>ComparisonError failed to load initial state of resource PersistentVolumeClaim: persistentvolumeclaims is forbidden: User “system:serviceaccount:dev-1-devops-argocd-ns:argocd-application-controller” cannot list resource “persistentvolumeclaims” in API group “” at the cluster scope 2020–11–19 15:35:51 +0200 EET</span></pre><p id="f1c1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从CLI尝试使用<code class="fe ni nj nk mx b">sync</code>命令——也不起作用:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="e5bc" class="nb kz iq mx b gy nc nd l ne nf">$ argocd app sync guestbook<br/>Name: guestbook<br/>Project: default<br/>Server: <a class="ae kw" href="https://kubernetes.default.svc" rel="noopener ugc nofollow" target="_blank">https://kubernetes.default.svc</a><br/>Namespace: default<br/>…<br/>Sync Status: Unknown<br/>Health Status: Healthy<br/>Operation: Sync<br/>Sync Revision:<br/>Phase: Error<br/>Start: 2020–11–19 15:37:01 +0200 EET<br/>Finished: 2020–11–19 15:37:01 +0200 EET<br/>Duration: 0s<br/>Message: ComparisonError: failed to load initial state of resource Pod: pods is forbidden: User “system:serviceaccount:dev-1-devops-argocd-ns:argocd-application-controller” cannot list resource “pods” in API group “” at the cluster scope;ComparisonError: failed to load initial state of resource Pod: pods is forbidden: User “system:serviceaccount:dev-1-devops-argocd-ns:argocd-application-controller” cannot list resource “pods” in API group “” at the cluster scope<br/>FATA[0001] Operation has completed with phase: Error</span></pre><h2 id="86fc" class="nb kz iq bd la no np dn le nq nr dp li kj ns nt lm kn nu nv lq kr nw nx lu ny bi translated">ArgocD: ComparisonError无法加载资源的初始状态</h2><p id="a861" class="pw-post-body-paragraph jy jz iq ka b kb ly kd ke kf lz kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">实际上，最好考虑一下“<strong class="ka ir"> <em class="kx">用户“系统:服务帐户:dev-1-devo PS-argocd-ns:argocd-应用程序-控制器”无法在集群范围</em> </strong>列出API组中的资源“pods”错误。</p><p id="5b5d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查<em class="kx">argocd-application-controller</em>service account(这里真正有用的是<a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-serviceaccounts-jwt-tokens-authentication-and-rbac-authorization/" rel="noopener ugc nofollow" target="_blank"> Kubernetes: ServiceAccounts、JWT-令牌、认证和RBAC授权</a>帖子):</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="1c9d" class="nb kz iq mx b gy nc nd l ne nf">$ kubectl -n dev-1-devops-argocd-ns get serviceaccount argocd-application-controller<br/>NAME SECRETS AGE<br/>argocd-application-controller 1 36m</span></pre><p id="8647" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">是的，我们已经创建了<code class="fe ni nj nk mx b">User system:serviceaccount:dev1-devops-argocd-ns:argocd-application-controller</code>用户。</p><p id="eb56" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并且映射了<em class="kx">argocd-application-controller</em>ClusterRoleBinding:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="42ba" class="nb kz iq mx b gy nc nd l ne nf">$ kubectl -n dev-1-devops-argocd-ns get clusterrolebinding argocd-application-controller<br/>NAME AGE<br/>argocd-application-controller 24h</span></pre><p id="cdf3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是它不能执行<code class="fe ni nj nk mx b">list pods</code>动作:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="b324" class="nb kz iq mx b gy nc nd l ne nf">$ kubectl auth can-i list pods -n dev-1-devops-argocd-ns — as system:serviceaccount:dev-1-devops-argocd-ns:argocd-application-controller<br/>no</span></pre><p id="2adc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尽管它的ClusterRole提供了所有权限:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="c243" class="nb kz iq mx b gy nc nd l ne nf">---<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRole<br/>metadata:<br/>  labels:<br/>    app.kubernetes.io/component: application-controller<br/>    app.kubernetes.io/name: argocd-application-controller<br/>    app.kubernetes.io/part-of: argocd<br/>  name: argocd-application-controller<br/>rules:<br/>- apiGroups:<br/>  - '*'<br/>  resources:<br/>  - '*'<br/>  verbs:<br/>  - '*'<br/>- nonResourceURLs:<br/>  - '*'<br/>  verbs:<br/>  - '*'</span></pre><p id="7f84" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">再次检查ClusterRoleBinding，但这次使用的是<code class="fe ni nj nk mx b">-o yaml</code>输出:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="6c5d" class="nb kz iq mx b gy nc nd l ne nf">$ kubectl get clusterrolebinding argocd-application-controller -o yaml<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRoleBinding<br/>…<br/>roleRef:<br/>apiGroup: rbac.authorization.k8s.io<br/>kind: ClusterRole<br/>name: argocd-application-controller<br/>subjects:<br/>- kind: ServiceAccount<br/>name: argocd-application-controller<br/>namespace: argocd</span></pre><p id="33da" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">啊哈，我们到了。</p><p id="4c1c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe ni nj nk mx b">install.yaml</code>-<em class="kx">argocd-应用程序-控制器</em>和<em class="kx">argocd-服务器</em>中找到两个ClusterRoleBinding，更新它们的名称空间:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="7696" class="nb kz iq mx b gy nc nd l ne nf">---<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  labels:<br/>    app.kubernetes.io/component: application-controller<br/>    app.kubernetes.io/name: argocd-application-controller<br/>    app.kubernetes.io/part-of: argocd<br/>  name: argocd-application-controller<br/>roleRef:<br/>  apiGroup: rbac.authorization.k8s.io<br/>  kind: ClusterRole<br/>  name: argocd-application-controller<br/>subjects:<br/>- kind: ServiceAccount<br/>  name: argocd-application-controller<br/>  namespace: dev-1-devops-argocd-ns<br/>---<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  labels:<br/>    app.kubernetes.io/component: server<br/>    app.kubernetes.io/name: argocd-server<br/>    app.kubernetes.io/part-of: argocd<br/>  name: argocd-server<br/>roleRef:<br/>  apiGroup: rbac.authorization.k8s.io<br/>  kind: ClusterRole<br/>  name: argocd-server<br/>subjects:<br/>- kind: ServiceAccount<br/>  name: argocd-server<br/>  namespace: dev-1-devops-argocd-ns</span></pre><p id="dccf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这就是为什么我讲述了默认的<em class="kx"> argocd </em>名称空间，以及为什么使用它更简单，就好像你正在使用一个定制的名称空间，然后你必须更新那些绑定。</p><p id="043f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以，修复它，重新部署:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="0e7c" class="nb kz iq mx b gy nc nd l ne nf">$ kubectl auth can-i list pods -n dev-1-devops-argocd-ns — as system:serviceaccount:dev-1-devops-argocd-ns:argocd-application-controller<br/>yes</span></pre><p id="dbaf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尝试再次执行<code class="fe ni nj nk mx b">sync</code>:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="73d9" class="nb kz iq mx b gy nc nd l ne nf">$ argocd app sync guestbook<br/>TIMESTAMP GROUP KIND NAMESPACE NAME STATUS HEALTH HOOK MESSAGE<br/>2020–11–19T15:47:08+02:00 Service default guestbook-ui Running Synced service/guestbook-ui unchanged<br/>2020–11–19T15:47:08+02:00 apps Deployment default guestbook-ui Running Synced deployment.apps/guestbook-ui unchanged<br/>Name: guestbook<br/>Project: default<br/>Server: <a class="ae kw" href="https://kubernetes.default.svc" rel="noopener ugc nofollow" target="_blank">https://kubernetes.default.svc</a><br/>…<br/>Sync Status: Synced to HEAD (6bed858)<br/>Health Status: Healthy<br/>Operation: Sync<br/>Sync Revision: 6bed858de32a0e876ec49dad1a2e3c5840d3fb07<br/>Phase: Succeeded<br/>Start: 2020–11–19 15:47:06 +0200 EET<br/>Finished: 2020–11–19 15:47:08 +0200 EET<br/>Duration: 2s<br/>Message: successfully synced (all tasks run)<br/>GROUP KIND NAMESPACE NAME STATUS HEALTH HOOK MESSAGE<br/>Service default guestbook-ui Synced Healthy service/guestbook-ui unchanged<br/>apps Deployment default guestbook-ui Synced Healthy deployment.apps/guestbook-ui unchanged</span></pre><p id="b8d6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它正在起作用:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oe"><img src="../Images/46c34b49389c71c9bb0f3dd292519ed1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LxYePuaK03pQ1BeM.png"/></div></div></figure><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi of"><img src="../Images/786cea075f7b6f4a510f7806ed177f3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dxWM7Bgd-vD73zZH.png"/></div></div></figure><p id="a0f1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">pod的日志:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi og"><img src="../Images/9c774139a906fe71cbfaa30b3fe0b599.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OvC9inBaIZTQGyg2.png"/></div></div></figure><p id="c798" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下一步将是部署一个舵图，并找出如何与<a class="ae kw" href="https://rtfm.co.ua/en/helm-helm-secrets-sensitive-data-encryption-with-aws-kms-and-use-it-from-jenkins/" rel="noopener ugc nofollow" target="_blank">舵秘密</a>合作。</p></div><div class="ab cl oh oi hu oj" role="separator"><span class="ok bw bk ol om on"/><span class="ok bw bk ol om on"/><span class="ok bw bk ol om"/></div><div class="ij ik il im in"><p id="5628" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kx">原发表于</em> <a class="ae kw" href="https://rtfm.co.ua/en/argocd-an-overview-ssl-configuration-and-an-application-deploy/" rel="noopener ugc nofollow" target="_blank"> <em class="kx"> RTFM: Linux，devo PSисистемноеадммитииииииованниое</em></a><em class="kx">。</em></p></div></div>    
</body>
</html>