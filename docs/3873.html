<html>
<head>
<title>Declarative WebAssembly deployment for Istio</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Istio的声明性WebAssembly部署</h1>
<blockquote>原文：<a href="https://itnext.io/declarative-webassembly-deployment-for-istio-fd71ff697bc5?source=collection_archive---------6-----------------------#2020-03-16">https://itnext.io/declarative-webassembly-deployment-for-istio-fd71ff697bc5?source=collection_archive---------6-----------------------#2020-03-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="0599" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如在<a class="ae kl" href="https://istio.io/blog/2020/tradewinds-2020/" rel="noopener ugc nofollow" target="_blank"> Istio 2020 trade winds博客</a>和最近发布的Istio 1.5 中所概述的，WebAssembly (Wasm)现在是扩展Istio服务代理(Envoy proxy)功能的一个(alpha)选项。使用Wasm，用户可以构建对新协议、自定义指标、记录器和其他过滤器的支持。我们在社区(<a class="ae kl" href="https://solo.io" rel="noopener ugc nofollow" target="_blank"> Solo.io </a>)与Google密切合作，专注于构建、社交和部署Wasm扩展到Istio的用户体验。我们已经宣布了<a class="ae kl" href="https://webassemblyhub.io" rel="noopener ugc nofollow" target="_blank"> WebAssembly Hub </a>和<a class="ae kl" href="https://docs.solo.io/web-assembly-hub/latest/installation/" rel="noopener ugc nofollow" target="_blank">相关工具</a>来构建一个“docker式”的Wasm使用体验。</p><h1 id="bcb0" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">背景</h1><p id="0a8b" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">借助WebAssembly Hub工具，我们可以使用<code class="fe lp lq lr ls b">wasme</code> CLI轻松引导Envoy的Wasm项目，将其推送到存储库，然后将其拉/部署到Istio。例如，要使用<code class="fe lp lq lr ls b">wasme</code>将Wasm扩展部署到Istio，我们可以运行以下命令:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="9557" class="mb kn iq ls b gy mc md l me mf">$ wasme deploy istio webassemblyhub.io/ceposta/demo-add-header:v0.2\ <br/>--id=myfilter \ <br/>--namespace=bookinfo \ <br/>--config 'tomorrow'</span></pre><p id="14f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将把<code class="fe lp lq lr ls b">demo-add-header</code>扩展添加到在<code class="fe lp lq lr ls b">bookinfo</code>名称空间中运行的所有工作负载中。通过使用<code class="fe lp lq lr ls b">--labels</code>参数，我们可以更细粒度地控制哪些工作负载获得扩展:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="bcbb" class="mb kn iq ls b gy mc md l me mf">$ wasme deploy istio webassemblyhub.io/ceposta/demo-add-header:v0.2\ <br/>--id=myfilter \ <br/>--namespace=bookinfo \ <br/>--config 'tomorrow' \ <br/>--labels app=details</span></pre><p id="a006" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种体验比手动创建<code class="fe lp lq lr ls b">EnvoyFilter</code>资源并尝试将Wasm模块安装到作为目标工作负载一部分的每个pod上要容易得多。然而，这是与Istio交互的一种非常必要的方法。就像用户通常不会在生产中直接使用<code class="fe lp lq lr ls b">kubectl</code>而更喜欢声明式的、基于资源的工作流一样，我们也希望对我们的Istio代理进行定制。</p><h1 id="4f79" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">声明式方法</h1><p id="ab65" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">WebAssembly Hub工具还包括<a class="ae kl" href="https://docs.solo.io/web-assembly-hub/latest/tutorial_code/wasme_operator/" rel="noopener ugc nofollow" target="_blank">一个操作员，用于将Wasm扩展部署到Istio工作负载</a>。<a class="ae kl" href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/" rel="noopener ugc nofollow" target="_blank">操作符</a>允许用户使用声明格式定义他们的WebAssembly扩展，并让操作符来调整部署。例如，我们使用<code class="fe lp lq lr ls b">FilterDeployment</code>资源来定义哪些映像和工作负载需要扩展:</p><figure class="lt lu lv lw gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mg"><img src="../Images/d31977a338baf6eeb31184ac045d28dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FwEmNl6Fix-lnyNYDNPyLg.png"/></div></div></figure><p id="a207" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我们可以使用这个<code class="fe lp lq lr ls b">FilterDeployment</code>文档，并用我们剩余的Istio资源对其进行版本化。您可能想知道为什么我们需要这个定制资源来配置Istio的服务代理使用Wasm扩展，而Istio已经有了<code class="fe lp lq lr ls b">EnvoyFilter</code>资源。</p><p id="2360" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们来看看所有这些在幕后是如何运作的。</p><h1 id="320b" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">它是如何工作的</h1><p id="9ae2" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">在幕后，运营商正在做一些事情，帮助将Wasm扩展部署和配置到Istio服务代理(Envoy代理)中。</p><ul class=""><li id="fe2b" class="mo mp iq jp b jq jr ju jv jy mq kc mr kg ms kk mt mu mv mw bi translated">设置Wasm扩展的本地缓存</li><li id="7ba4" class="mo mp iq jp b jq mx ju my jy mz kc na kg nb kk mt mu mv mw bi translated">将所需的Wasm扩展拉入本地缓存</li><li id="ea10" class="mo mp iq jp b jq mx ju my jy mz kc na kg nb kk mt mu mv mw bi translated">将<code class="fe lp lq lr ls b">wasm-cache</code>装载到适当的工作负载中</li><li id="8ade" class="mo mp iq jp b jq mx ju my jy mz kc na kg nb kk mt mu mv mw bi translated">配置特使与<code class="fe lp lq lr ls b">EnvoyFilter</code> CRD使用Wasm过滤器</li></ul><figure class="lt lu lv lw gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi nc"><img src="../Images/0e2bb8edd46652ef589803ec57306b71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*KybZvtYYdgiqVBsI.png"/></div></div></figure><p id="276f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">了解wasme运算符如何工作</p><p id="f0cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">目前，Wasm映像需要发布到注册表中，以便运营商正确缓存它。缓存窗格在每个节点上作为DaemonSet运行，以便缓存可以装入Envoy容器。这正在改进，因为它不是理想的机制。理想情况下，我们不需要安装任何东西，可以直接通过HTTP将模块传输到代理，所以请继续关注更新(应该会在几天内发布)。通过使用<code class="fe lp lq lr ls b">sidecar.istio.io/userVolume</code>和<code class="fe lp lq lr ls b">sidecar.istio.io/userVolumeMount</code>注释建立安装。有关如何工作的更多信息，请参见<a class="ae kl" href="https://istio.io/docs/reference/config/annotations/" rel="noopener ugc nofollow" target="_blank">Istio资源注释文档</a>。</p><p id="6c21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦Wasm模块被正确缓存并安装到工作负载的服务代理中，操作员就可以配置<code class="fe lp lq lr ls b">EnvoyFilter</code>资源。</p><figure class="lt lu lv lw gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi nd"><img src="../Images/4367941061d140cda7c9b25339c83f3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-uWesIiH7VBVai1IIGHddA.png"/></div></div></figure><p id="4b54" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以看到<code class="fe lp lq lr ls b">EnvoyFilter</code>资源配置代理来添加<code class="fe lp lq lr ls b">envoy.filter.http.wasm</code>过滤器并从<code class="fe lp lq lr ls b">wasme-cache</code>加载Wasm模块。</p><p id="aa47" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦Wasm扩展被加载到Istio服务代理中，它将使用您引入的任何定制代码来扩展代理的功能。</p><h1 id="0634" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">后续步骤</h1><p id="02c1" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">在这篇博客中，我们探讨了在Istio工作负载中安装Wasm扩展的选项。在Istio上开始使用WebAssembly最简单的方法是使用<code class="fe lp lq lr ls b">wasme</code>工具<a class="ae kl" href="https://docs.solo.io/web-assembly-hub/latest/tutorial_code/getting_started/" rel="noopener ugc nofollow" target="_blank">来引导一个新的Wasm项目</a>使用C++，assembly script[或者Rust即将到来！].例如，要设置C++ Wasm模块，可以运行:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="158b" class="mb kn iq ls b gy mc md l me mf">$ wasme init ./filter --language cpp --platform istio \<br/>--platform-version 1.5.x</span></pre><p id="70ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们没有额外的标志，<code class="fe lp lq lr ls b">wasme init</code>将进入交互模式，引导您选择正确的值。</p><p id="83be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">看一看<a class="ae kl" href="https://docs.solo.io/web-assembly-hub/latest/tutorial_code/getting_started/" rel="noopener ugc nofollow" target="_blank">web assembly Hub wasme tooling</a>，开始使用Istio上的Wasm。</p></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><p id="8990" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nl">原载于2020年3月16日</em><a class="ae kl" href="https://istio.io/blog/2020/deploy-wasm-declarative/" rel="noopener ugc nofollow" target="_blank"><em class="nl">https://istio . io</em></a><em class="nl">。</em></p></div></div>    
</body>
</html>