<html>
<head>
<title>Let’s encrypt Certs with Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们用Terraform加密证书</h1>
<blockquote>原文：<a href="https://itnext.io/lets-encrypt-certs-with-terraform-f870def3ce6d?source=collection_archive---------0-----------------------#2021-10-28">https://itnext.io/lets-encrypt-certs-with-terraform-f870def3ce6d?source=collection_archive---------0-----------------------#2021-10-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="30ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">SSL证书的免费、安全和自动化存储</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/fc75d1e7967414fdc6f3d5d6002d01e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AigFRqUBj3Ko0-kqib3YWg.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">克里斯·巴巴利斯在<a class="ae lb" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="7cd7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我不知道你对使用<a class="ae lb" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank">让我们加密</a>的印象如何，但我的印象是，与市场上其他昂贵的替代品相比，它们是为我们的网站获得<strong class="jp ir">生产就绪免费SSL证书</strong>的绝佳资源。</p><p id="fba5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然⚠️ ( <a class="ae lb" href="https://letsencrypt.org/docs/rate-limits/" rel="noopener ugc nofollow" target="_blank">参考</a>)也有一些收获:</p><ul class=""><li id="7261" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">证书生成依赖于我们管理下的有效DNS区域。这是必要的，因为证书生成过程将需要放入DNS记录，以验证我们对要颁发的域的权限。</li><li id="219c" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">一个证书最多可以包含100个(子)域。</li><li id="bdba" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">证书(重新)生成限制为每周5次。我艰难地认识到，超过这个限制将不会允许你在7天内生成新版本的证书😅</li></ul><p id="2c81" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这意味着我们必须非常小心地为我们的应用程序生成证书。我建议采取以下行动来避免我所经历的头痛:</p><ul class=""><li id="fd6a" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">出于测试目的(即，每当我们不完全确定将要颁发的证书时)，我们可以使用let ' s encrypt<a class="ae lb" href="https://letsencrypt.org/docs/staging-environment/" rel="noopener ugc nofollow" target="_blank">staging environment</a>。尽管这些证书在生产应用程序中不起作用(用户将在其浏览器中看到一个<em class="lq">红色锁</em>),但它们是验证这些证书生成的一个很好的替代方法，其限制比生产证书高得多。</li><li id="87a6" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">自动生成和存储这些证书，以便在过期前定期重新生成它们，并从负载平衡器或web服务器等其他组件使用它们。</li></ul><p id="c090" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">实现这些目标的最简单的开源方法之一是使用<strong class="jp ir"> Terraform </strong>来自动生成证书(重新生成)。</p><p id="2ad4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们下面的简短示例中，我们将通过Terraform使用<strong class="jp ir"> Route53 </strong>来验证DNS质询，以自动放置Let's encrypt所需的验证记录。</p><p id="8fcb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为第一步，我们将指定要使用的Terraform版本&amp; ACME提供者:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="lr ls l"/></div></figure><p id="de43" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如你可能看到的，这个地形定义是非常基本的。那是有目的的🙂因为我只关注创建，所以让我们加密资源。您可以随意为您的代码的其余部分添加任何额外的配置(比如远程后端，这总是一个好主意！).</p><p id="03b1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如Terraform Registry中所记录的，使用<a class="ae lb" href="https://registry.terraform.io/providers/vancluever/acme/latest" rel="noopener ugc nofollow" target="_blank"> ACME provider </a>发布let's encrypt证书非常容易:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="lr ls l"/></div></figure><p id="19a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如你从上面的定义中看到的，我们在这里:</p><ul class=""><li id="8ae2" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">使用“让我们加密试运行环境”,并保留生产环境以备将来使用。</li><li id="56a2" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">使用一个<strong class="jp ir">现有的</strong> Route53 DNS区域，以便放置我们新SSL证书的DNS挑战记录。</li><li id="0ac0" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">使用加密Terraform资源创建SSL证书。</li></ul><p id="b160" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你喜欢冒险，可以在你的管理下更新<em class="lq"> base_domain </em>数据源的DNS区域。如果Route53中还没有DNS区域，请随意将此数据源转换为Terraform资源，创建一个新的DNS区域并将其用于加密验证。</p><p id="f196" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，我们不会使用电子邮件作为确认质询。但是，在注册资源中输入真实的电子邮件地址是一个好主意，这样可以将证书与您在let's encrypt records上的身份相关联。</p><p id="3661" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与提供者<a class="ae lb" href="https://registry.terraform.io/providers/vancluever/acme/latest/docs/resources/certificate#using-dns-challenges" rel="noopener ugc nofollow" target="_blank">文档</a>相比，本例使用Terraform基于<em class="lq"> AWS_ACCESS_KEY_ID </em>、<em class="lq"> AWS_SECRET_ACCESS_KEY </em>和<em class="lq"> AWS_DEFAULT_REGION </em>变量继承的默认AWS凭证。但是，请记住，可以在<em class="lq"> config </em>块中显式设置AWS凭证，甚至可以使用其他DNS提供商，如Azure、GCP，甚至自定义HTTP/TLS挑战。</p><p id="9526" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步是将这个证书存储在一个安全的地方，根据我们的需要在其他地方使用。在这种情况下，我们将介绍三种实现方式:使用<strong class="jp ir"> S3对象</strong>(可以使用外部服务/应用程序下载)、使用<strong class="jp ir"> Terraform输出</strong>(可以手动复制以备将来使用)，以及使用<strong class="jp ir">亚马逊证书管理器(ACM) </strong>(稍后可以在其他AWS资源中使用，如负载平衡器、API网关等)。</p><p id="3fcd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">⚠️坚持住！:SSL证书密钥被视为域有效性的敏感材料。使用以下任一替代方法存储和暴露它们时要小心:</p><h2 id="bc49" class="lt lu iq bd lv lw lx dn ly lz ma dp mb jy mc md me kc mf mg mh kg mi mj mk ml bi translated">第一种选择:将证书存储为S3对象</h2><p id="3da4" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">我们可以扩展Terraform代码，将我们的证书保存为S3对象，指定存储桶名称和保存每个证书密钥的路径:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="lr ls l"/></div></figure><p id="06e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如上面的代码所示，我们指定了一个现有的 S3桶的名称<strong class="jp ir">。如果没有资源，考虑使用<em class="lq"> aws_s3_bucket </em>资源创建一个新的bucket。</strong></p><h2 id="31f8" class="lt lu iq bd lv lw lx dn ly lz ma dp mb jy mc md me kc mf mg mh kg mi mj mk ml bi translated">第二种选择:将证书显示为Terraform输出</h2><p id="1695" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">如果我们想使用一次证书，而他们的密钥可以手动获取，那么使用Terraform输出可能是一个不错的选择。对于这种情况，我们必须创建三个输出对象，如下所示:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="lr ls l"/></div></figure><p id="35cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，私钥对象是一个敏感的元素。这就是为什么我们使用<a class="ae lb" href="https://www.terraform.io/docs/language/functions/nonsensitive.html" rel="noopener ugc nofollow" target="_blank">非敏感</a>函数在控制台中显示其内容，⚠️小心在公共场所暴露敏感内容，如证书私钥，如GitHub repos或公共CI管道。</p><h2 id="c01a" class="lt lu iq bd lv lw lx dn ly lz ma dp mb jy mc md me kc mf mg mh kg mi mj mk ml bi translated">第三个选项:将证书存储在AWS证书管理器(ACM)中</h2><p id="97cd" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">也许新生成的证书的用例将用于其他AWS资源，如负载平衡器、CloudFront或API网关。如果这是您的情况，我们可以使用如下方式将Let's encrypt证书作为新的ACM证书导入:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="lr ls l"/></div></figure><p id="5cf2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将在AWS中被视为一个新的ACM证书(不是由Amazon发布的):</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mr"><img src="../Images/eb2130eefd60bf1172266fd341d879f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HNX28RFJ3yz3bg8ds2LGwA.png"/></div></div></figure><p id="5ae0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样！从现在开始，你可以在你的负载平衡器中使用你的全新证书，如ELB、Nginx或HAProxy🔐</p><p id="68da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我真的很感激任何类型的反馈，疑问或评论。请随意在此给我<a class="ae lb" href="https://www.linkedin.com/in/nicosingh" rel="noopener ugc nofollow" target="_blank">留言，或者在这个帖子里发表任何评论。</a></p><div class="ms mt gp gr mu mv"><a href="https://github.com/sponsors/nicosingh" rel="noopener  ugc nofollow" target="_blank"><div class="mw ab fo"><div class="mx ab my cl cj mz"><h2 class="bd ir gy z fp na fr fs nb fu fw ip bi translated">GitHub赞助商上的赞助商@nicosingh</h2><div class="nc l"><h3 class="bd b gy z fp na fr fs nb fu fw dk translated">非常感谢你的支持😊我感谢你对做开源软件和分享知识的认可…</h3></div><div class="nd l"><p class="bd b dl z fp na fr fs nb fu fw dk translated">github.com</p></div></div><div class="ne l"><div class="nf l ng nh ni ne nj kv mv"/></div></div></a></div></div></div>    
</body>
</html>