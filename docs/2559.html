<html>
<head>
<title>How to split RSpec tests with Jenkins Parallel Pipeline to run faster CI builds</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Jenkins并行管道拆分RSpec测试以运行更快的CI构建</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-split-rspec-tests-with-jenkins-parallel-pipeline-to-run-faster-ci-builds-17955692c16e?source=collection_archive---------6-----------------------#2019-06-14">https://itnext.io/how-to-split-rspec-tests-with-jenkins-parallel-pipeline-to-run-faster-ci-builds-17955692c16e?source=collection_archive---------6-----------------------#2019-06-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="98db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Jenkins CI服务器有一个声明性管道，允许您设置Jenkins并行阶段。您可以使用阶段来同时运行它们(并行运行),以在几个更小更快的块中执行您的RSpec测试套件，而不是一个长时间的测试套件运行。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/5b72206d4ae33d4e546cca4142c68fa0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*myXxSbD_uF_wIk52.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">RSpec + Jenkins</figcaption></figure><h1 id="4a75" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">与Jenkins工作流管道并行运行阶段</h1><p id="bb93" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">您将使用Jenkinsfile和管道语法来并行执行任务。RSpec测试需要在各个阶段中以相等的时间分割，要做到这一点，您需要确保每个RSpec规范文件的时间不会在其中一个阶段上混合，因为这可能会导致瓶颈——一个比其他阶段花费更多时间来运行测试的阶段。</p><p id="dea8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了平均分割RSpec测试，您可以使用<a class="ae me" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=split-rspec-tests-with-jenkins-parallel-pipeline-to-run-specs-faster" rel="noopener ugc nofollow" target="_blank">backpack _ pro gem</a>及其队列模式，该模式将动态分割并行Jenkins阶段的规格，以确保每个阶段花费相似的时间。你可以从下面的视频中了解更多关于<a class="ae me" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=split-rspec-tests-with-jenkins-parallel-pipeline-to-run-specs-faster" rel="noopener ugc nofollow" target="_blank">背包_专业队列模式</a>以及当你在CI服务器上拆分测试时它解决了什么样的边缘情况。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><h1 id="5cb4" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">声明性Jenkins管道中的阶段</h1><p id="53fe" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">在Jenkins中，管道作为代码是定义配置的一种非常流行的方式。这里有一个用<a class="ae me" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=split-rspec-tests-with-jenkins-parallel-pipeline-to-run-specs-faster" rel="noopener ugc nofollow" target="_blank">背包_pro ruby gem </a>运行RSpec测试的例子，以确保你的Ruby on Rails测试在并行阶段中以最佳方式分割。</p><pre class="km kn ko kp gt mh mi mj mk aw ml bi"><span id="0c04" class="mm lc iq mi b gy mn mo l mp mq">timeout(time: 60, unit: 'MINUTES') {<br/>  node() {<br/>    stage('Checkout') {<br/>      checkout([/* checkout code from git */])<br/><br/>      // determine git commit hash because we need to pass it to knapsack_pro<br/>      COMMIT_HASH = sh(returnStdout: true, script: 'git rev-parse HEAD').trim()<br/><br/>      stash 'source'<br/>    }<br/>  }<br/><br/>  def num_nodes = 4; // define your total number of CI nodes (how many parallel jobs will be executed)<br/>  def nodes = [:]<br/><br/>  for (int i = 0; i &lt; num_nodes; i++) {<br/>    def index = i;<br/>    nodes["ci_node_${i}"] = {<br/>      node() {<br/>        stage('Setup') {<br/>          unstash 'source'<br/>          // other setup steps<br/>        }<br/><br/>        def knapsack_options = """\<br/>            KNAPSACK_PRO_CI_NODE_TOTAL=${num_nodes}\<br/>            KNAPSACK_PRO_CI_NODE_INDEX=${index}\<br/>            KNAPSACK_PRO_COMMIT_HASH=${COMMIT_HASH}\<br/>            KNAPSACK_PRO_BRANCH=${env.BRANCH_NAME}\<br/>        """<br/><br/>        // Example how to run RSpec tests in Knapsack Pro Queue Mode<br/>        // Queue Mode should be a last stage if you have other stages in your pipeline<br/>        // thanks to that it can autobalance CI build time if other tests were not perfectly distributed<br/>        stage('Run rspec') {<br/>          sh """KNAPSACK_PRO_CI_NODE_BUILD_ID=${env.BUILD_TAG} ${knapsack_options} bundle exec rake knapsack_pro:queue:rspec"""<br/>        }<br/>      }<br/>    }<br/>  }<br/><br/>  parallel nodes // run CI nodes in parallel<br/>}</span></pre><h1 id="bf3a" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">摘要</h1><p id="940f" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">自动拆分测试以加速测试阶段是确保您的Ruby on Rails项目CI构建最终尽可能快地完成的一种方式。您可以了解其他Ruby或JavaScript测试运行程序的<a class="ae me" href="https://docs.knapsackpro.com/2018/jenkins-pipeline-how-to-run-parallel-tests-in-your-workflow-stages" rel="noopener ugc nofollow" target="_blank"> Jenkins并行管道，如Cypress或Jest </a>，以及CI并行化如何通过更快的测试节省时间。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="8702" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi">— — —</p><p id="5b86" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最初发布于:<a class="ae me" href="https://docs.knapsackpro.com/2019/split-rspec-tests-with-jenkins-parallel-pipeline-to-run-specs-faster" rel="noopener ugc nofollow" target="_blank">https://docs . knapsackpro . com/2019/split-rspec-tests-with-Jenkins-parallel-pipeline-to-run-specs-faster</a></p></div></div>    
</body>
</html>