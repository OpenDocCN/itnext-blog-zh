<html>
<head>
<title>Golang and clean architecture</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Golang与清洁建筑</h1>
<blockquote>原文：<a href="https://itnext.io/golang-and-clean-architecture-19ae9aae5683?source=collection_archive---------0-----------------------#2021-06-22">https://itnext.io/golang-and-clean-architecture-19ae9aae5683?source=collection_archive---------0-----------------------#2021-06-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/c4b0b56a427de5ccf15f7f8e9bcb4a78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1382/format:webp/1*iDZjgnKUbv2Mcus42P1qJA.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">不仅是Dame时间，还有Go时间</figcaption></figure><p id="177b" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我想在NBA季后赛早期发表这篇文章，当时<a class="ae jy" href="https://thedailymixreport.files.wordpress.com/2020/08/damianlillard_dametime1-1.jpg?w=950" rel="noopener ugc nofollow" target="_blank">达米恩·利拉德</a>正在打球。虽然现在有点晚了，但他仍然值得大声呼喊。</p><h2 id="a9dd" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">在本帖中，我们将回顾并部署一个遵循干净架构原则的golang应用程序。<br/>源代码可以在<a class="ae jy" href="https://github.com/subzero112233/aws-golang-lambda" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</h2><ul class=""><li id="b482" class="lq lr iq kb b kc ls kg lt kk lu ko lv ks lw kw lx ly lz ma bi translated">更新:3.7.2021:删除了OpenAPI客户端生成，因为它没有多大帮助(而且我还必须手动编写验证/错误)，而是创建了请求-响应模型。</li></ul><h1 id="6430" class="mb ky iq bd kz mc md me lc mf mg mh lf mi mj mk li ml mm mn ll mo mp mq lo mr bi translated">简介:</h1><p id="9ab2" class="pw-post-body-paragraph jz ka iq kb b kc ls ke kf kg lt ki kj kk ms km kn ko mt kq kr ks mu ku kv kw ij bi translated">我们中的大多数人可能都参与过大型项目，其中部分代码很难扩展、理解，有时甚至难以维护。有时混乱是如此严重，以至于没人想碰那个部分/组件/系统，在你意识到之前，你已经陷入了一个需要严重重构的系统，甚至更糟，需要完全重写。</p><p id="3e54" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">团队的规模只是在一定程度上有关系，因为当软件的架构很差时，用新的功能来扩展系统迟早会变得很困难，而且如上所述，困难会非常严重，甚至维护都变得非常繁重。</p><p id="5390" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">幸运的是，随着项目的增长，架构良好的软件仍然易于更改和理解，并使开发人员专注于支持业务。</p><p id="2338" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">Bob叔叔的“干净的架构”一书提供了指导方针和深入的解释，并举例说明了如何确保你的项目不会随着时间的推移而腐烂。这是一本绝对必读的书。</p><p id="a144" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><strong class="kb ir">遵循清洁架构原则的项目将是:</strong></p><p id="b818" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">1.<strong class="kb ir"> UI无关:</strong>改变UI不应该影响项目的其他部分。<br/> 2。<strong class="kb ir">独立于框架:</strong>使用什么库并不重要。框架将被用作工具，不会强制任何业务规则。<br/> 3。<strong class="kb ir">数据库无关:</strong>项目不应该关心或者依赖于所选择的数据库。此外，我们希望尽可能晚地选择数据库，以保持灵活性<br/> 4。<strong class="kb ir">可测试的:</strong>可测试的系统是您有信心与之一起工作的系统——因此它是一个易于扩展或维护的系统。<br/> 5。<strong class="kb ir">严格它的依赖规则:</strong>源代码依赖只能指向内部，意味着一个内圈对外圈一无所知。</p><p id="c544" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我们应用程序的整体架构:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/270a7fded42881e528b41647600b149e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/1*7TOeidIPEOMR4Sns7Uvy8w.png"/></div></figure><p id="6b3c" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">使用的技术:<br/> Golang，Gin (golang) <br/> AWS: Lambda，带自定义授权器的API网关，DynamoDB。</p><p id="3d4e" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">目录结构:</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="c67c" class="kx ky iq nb b gy nf ng l nh ni">.<br/>├── api<br/>│   ├── handler<br/>│   │   ├── handler.go<br/>│   │   ├── helpers.go<br/>│   │   └── model.go<br/>│   └── middleware<br/>│       └── middleware.go<br/>├── cloudformation<br/>│   └── apigateway<br/>│       ├── apig.yaml<br/>│       └── create_apigateway.sh<br/>├── entity<br/>│   ├── entity.go<br/>│   ├── errors.go<br/>│   └── validations.go<br/>├── go.mod<br/>├── go.sum<br/>├── lambdas<br/>│   ├── authorizer<br/>│   │   ├── deploy.sh<br/>│   │   ├── main.go<br/>│   │   └── template.yaml<br/>│   └── users<br/>│       ├── deploy.sh<br/>│       ├── env.json<br/>│       ├── main.go<br/>│       └── template.yaml<br/>├── Makefile<br/>├── openapi.yaml<br/>├── pkg<br/>│   └── jwtparser<br/>│       ├── jwtparser.go<br/>│       └── jwtparser_test.go<br/>├── README.md<br/>├── repository<br/>│   ├── dynamodb<br/>│   │   └── dynmodb.go<br/>│   ├── mockdatabase<br/>│   │   └── mockdatabase.go<br/>│   └── mysql<br/>│       ├── init.sql<br/>│       ├── model.go<br/>│       └── mysql.go<br/>└── usecase<br/>    └── users<br/>        ├── repository.go<br/>        ├── service.go<br/>        ├── usecase.go<br/>        ├── users.go<br/>        └── users_test.go</span><span id="aa51" class="kx ky iq nb b gy nj ng l nh ni">17 directories, 33 files</span></pre><h1 id="09fe" class="mb ky iq bd kz mc md me lc mf mg mh lf mi mj mk li ml mm mn ll mo mp mq lo mr bi translated">干净的建筑:</h1><p id="65ac" class="pw-post-body-paragraph jz ka iq kb b kc ls ke kf kg lt ki kj kk ms km kn ko mt kq kr ks mu ku kv kw ij bi translated">干净的建筑由四个圆圈组成</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div class="ab gu cl nk"><img src="../Images/7bc856a133b00839e0e634ff235627e1.png" data-original-src="https://miro.medium.com/v2/format:webp/1*HwV1WkWjf9mnECGcB94lpA.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">清洁建筑四圈</figcaption></figure><h2 id="479a" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">实体:</h2><blockquote class="nl nm nn"><p id="1548" class="jz ka no kb b kc kd ke kf kg kh ki kj np kl km kn nq kp kq kr nr kt ku kv kw ij bi translated">实体封装了最通用和最高级的业务规则。当外界发生变化时，他们最不可能改变。</p></blockquote><p id="512f" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">这些实体不依赖于任何其他圆。</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="0d36" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">实体包还包含验证和自定义错误。</p><h2 id="4f23" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">使用案例:</h2><blockquote class="nl nm nn"><p id="23b4" class="jz ka no kb b kc kd ke kf kg kh ki kj np kl km kn nq kp kq kr nr kt ku kv kw ij bi translated">用例层包含<strong class="kb ir">应用特定的</strong>业务规则。</p></blockquote><p id="b84f" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">用例层只依赖于实体。实体的变化需要用例层的变化，但是其他层的变化不需要。</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="820a" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">在我们的应用程序中，这些是注册、登录和问好方法。</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><h2 id="b4b9" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">接口适配器:</h2><blockquote class="nl nm nn"><p id="6d61" class="jz ka no kb b kc kd ke kf kg kh ki kj np kl km kn nq kp kq kr nr kt ku kv kw ij bi translated">接口适配器层包含一组适配器，将数据从对用例和实体最方便的格式转换为对某些外部机构(如数据库或Web)最方便的格式。</p></blockquote><p id="2e2c" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">在api目录中，我们有<code class="fe nu nv nw nb b"><strong class="kb ir">handler</strong></code>和<code class="fe nu nv nw nb b"><strong class="kb ir">middleware</strong></code>包。<br/>处理器处理http请求、响应和验证:</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="3a3f" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">中间件:</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><h2 id="59c7" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">框架和适配器:</h2><blockquote class="nl nm nn"><p id="b340" class="jz ka no kb b kc kd ke kf kg kh ki kj np kl km kn nq kp kq kr nr kt ku kv kw ij bi translated">这一层是所有细节的所在:网络是一个细节，数据库也是。</p></blockquote><p id="636a" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">在框架和适配器层，我们有数据库、UI等。<br/>这是最外在的层次，必然比其他圈子变化更频繁。然而，这里的变化应该不会影响到内部圈子。</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><h2 id="3671" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">让我们看看这一切是如何组合在一起的:</h2><p id="7e8c" class="pw-post-body-paragraph jz ka iq kb b kc ls ke kf kg lt ki kj kk ms km kn ko mt kq kr ks mu ku kv kw ij bi translated">首先，需要在<a class="ae jy" href="https://github.com/subzero112233/aws-golang-lambda/blob/master/Makefile" rel="noopener ugc nofollow" target="_blank"> Makefile </a>中设置你的S3工件桶。<br/>如果你没有水桶，那就跑:</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="676f" class="kx ky iq nb b gy nf ng l nh ni">aws s3api create-bucket --bucket &lt;BUCKET_NAME&gt; --region &lt;REGION&gt;</span></pre><p id="8d56" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">展开<code class="fe nu nv nw nb b">users</code>和<code class="fe nu nv nw nb b">authorizer</code>兰姆达斯:</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="a0d8" class="kx ky iq nb b gy nf ng l nh ni">make build &amp;&amp; make deploy</span></pre><p id="e272" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后，部署我们的api网关。</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="a27f" class="kx ky iq nb b gy nf ng l nh ni">reshef ~ $ make deploy-apig</span><span id="fbfc" class="kx ky iq nb b gy nj ng l nh ni">Waiting for changeset to be created..<br/>Waiting for stack create/update to complete<br/>Successfully created/updated stack - aws-lambda-go-apigateway</span><span id="7e40" class="kx ky iq nb b gy nj ng l nh ni"><a class="ae jy" href="https://gjfwhy1kzg.execute-api.us-east-1.amazonaws.com/deploy/" rel="noopener ugc nofollow" target="_blank">https://</a>acrymgwwwf<a class="ae jy" href="https://gjfwhy1kzg.execute-api.us-east-1.amazonaws.com/deploy/" rel="noopener ugc nofollow" target="_blank">.execute-api.us-east-1.amazonaws.com/deploy/</a></span></pre><p id="1576" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">脚本输出的最后一行包含我们将使用的api端点—<a class="ae jy" href="https://gjfwhy1kzg.execute-api.us-east-1.amazonaws.com/deploy/" rel="noopener ugc nofollow" target="_blank"><em class="no">https://gjwhy1kzg . execute-API . us-east-1 . amazonaws . com/deploy/</em></a></p><h1 id="28f8" class="mb ky iq bd kz mc md me lc mf mg mh lf mi mj mk li ml mm mn ll mo mp mq lo mr bi translated">API端点</h1><p id="21b2" class="pw-post-body-paragraph jz ka iq kb b kc ls ke kf kg lt ki kj kk ms km kn ko mt kq kr ks mu ku kv kw ij bi translated"><strong class="kb ir">报名:</strong></p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="cea7" class="kx ky iq nb b gy nf ng l nh ni">reshef ~ $ curl --location --request POST 'https://acrymgwwwf.execute-api.us-east-1.amazonaws.com/deploy/users/signup' --header 'Content-Type: application/json' --data-raw '{"username": "batz", "password": "batz123456", "address": "mapo 4", "first_name": "batz", "last_name": "hatzav"}'<br/></span><span id="de17" class="kx ky iq nb b gy nj ng l nh ni">{"message":"user successfully created"}</span></pre><p id="8306" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><strong class="kb ir">签到:</strong></p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="1c91" class="kx ky iq nb b gy nf ng l nh ni">reshef ~ $ curl --location --request POST 'https://acrymgwwwf.execute-api.us-east-1.amazonaws.com/deploy/users/signin' --header 'Content-Type: application/json' --data-raw '{"username": "batz", "password": "batz123456"}'</span><span id="653d" class="kx ky iq nb b gy nj ng l nh ni"><br/>{"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MjQyODE0NTUsImlhdCI6MTYyNDI3Nzg1NSwidXNlcm5hbWUiOiJ5b3plciJ9.qht3rQoKymZeIBDUBhn5My4CPMexR_8ItqbsOMhYaxM"}</span></pre><p id="4263" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><strong class="kb ir"> /hello端点:<br/> </strong>使用从前面的api调用中收到的令牌，我们向/hello端点发送一个请求</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="7b56" class="kx ky iq nb b gy nf ng l nh ni">reshef ~ $ curl --location --request GET 'https://acrymgwwwf.execute-api.us-east-1.amazonaws.com/deploy/hello' --header 'Content-Type: application/json' --header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MjQyODUyOTIsImlhdCI6MTYyNDI4MTY5MiwidXNlcm5hbWUiOiJiYXR6In0.L19gD2MOPBma5yBd43UIHBj6ThdCYLl9_jn3wRPHBpo'</span><span id="e360" class="kx ky iq nb b gy nj ng l nh ni"><br/>{"message":"Hello batz"}</span></pre><h2 id="25f0" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated"><strong class="ak">解决清洁架构方法</strong></h2><p id="c890" class="pw-post-body-paragraph jz ka iq kb b kc ls ke kf kg lt ki kj kk ms km kn ko mt kq kr ks mu ku kv kw ij bi translated">我个人喜欢Lambda和DynamoDB的组合。两者都是无服务器的，规模惊人，并为您节省大量的维护和操作时间。<br/> DynamoDB可以轻松地(在正确配置的情况下)处理(几乎)任意数量的并发请求，而无需使用连接池、设置RDS代理或任何类似的东西。</p><p id="5ce5" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然而，在我们想象的公司中，一段时间后，我们的业务开始高速增长，产品经理要求我们添加更多的功能。<br/>分解需求后，我们最终意识到NoSQL数据库不再适合这项任务，我们决定改用SQL数据库。</p><p id="8cda" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">这完全没问题:我们可能会以某种方式开始做一些事情，随着业务的增长，需求会发生变化，我们无法预料和无法知道的事情会发生。</p><p id="9842" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">在我们的存储库目录中，我们有一个名为<strong class="kb ir"> mysql: </strong>的包</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="76a5" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我们唯一需要修改的文件是<strong class="kb ir"> users lambda中的<strong class="kb ir"> main.go </strong>文件。<br/> </strong>那就不一样了<strong class="kb ir"> : </strong></p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ny nz di oa bf ob"><div class="gh gi nx"><img src="../Images/d863058b2e08c6ecd80c9f06fb352025.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-O52TldUD0-4tkdDPl9Yjg.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">main .走左边的dynamodb。对于右边的mysql。</figcaption></figure><p id="f75f" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">微小的变化。为了部署我们的更改，我们再次运行:</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="5fce" class="kx ky iq nb b gy nf ng l nh ni">make build<br/>make deploy</span></pre><p id="8ad1" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我们准备好了。</p><p id="fb07" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">PS:考虑到在现实生活场景中，我们需要将现有数据从旧数据库迁移到新数据库，对于SQL数据库，最好有一个数据库迁移工具来管理数据库模式。我推荐<a class="ae jy" href="https://flywaydb.org/" rel="noopener ugc nofollow" target="_blank">飞行路线</a>来完成这个任务。</p><p id="3186" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">现在想想从AWS lambda迁移到Kubernetes或其他平台，或者从Gin迁移到Echo，等等，有多容易。通过这种方式，技术和业务的转换、改变和发展都很容易。</p><p id="754b" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">希望你觉得有用。</p></div></div>    
</body>
</html>