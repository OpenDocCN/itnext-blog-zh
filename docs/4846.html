<html>
<head>
<title>How We Used Terraform to Create and Manage a HA AKS Kubernetes Cluster in Azure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我们如何使用Terraform在Azure中创建和管理HA AKS Kubernetes集群</h1>
<blockquote>原文：<a href="https://itnext.io/how-we-used-terraform-to-create-and-manage-a-ha-aks-kubernetes-cluster-in-azure-812f64896c08?source=collection_archive---------1-----------------------#2020-10-05">https://itnext.io/how-we-used-terraform-to-create-and-manage-a-ha-aks-kubernetes-cluster-in-azure-812f64896c08?source=collection_archive---------1-----------------------#2020-10-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="ebf9" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">了解如何使用Terraform管理启用了Azure AD集成和Calico网络策略的高可用性Azure AKS Kubernetes集群。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/962fee73328d24a1316618eeef8282a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*epRvAjuMjxACt2bP.png"/></div></div></figure><blockquote class="kr ks kt"><p id="c80e" class="ku kv kw kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><a class="ae lr" href="https://codersociety.com/blog/articles/terraform-azure-kubernetes" rel="noopener ugc nofollow" target="_blank">文章最初发表在Coder Society这里</a>。</p></blockquote><h1 id="fb66" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">什么是Azure Kubernetes服务(AKS)</h1><p id="c544" class="pw-post-body-paragraph ku kv iq kx b ky mk jr la lb ml ju ld mm mn lg lh mo mp lk ll mq mr lo lp lq ij bi translated">Azure Kubernetes Service (AKS)是Azure中的托管Kubernetes产品，可让您快速部署生产就绪的Kubernetes集群。它允许客户专注于应用程序开发和部署，而不是Kubernetes集群管理的细节。群集控制平面由Microsoft部署和管理，而部署应用程序的节点和节点池由客户处理。</p><p id="383d" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">AKS集群部署可以使用Terraform完全自动化。Terraform使您能够安全、可预测地创建、更改和改进基础设施。它还支持高级AKS配置，如可用性区域、Azure AD集成和Kubernetes的网络策略。</p><p id="9d7c" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">让我们来看看我们将在本文中涉及的关键AKS特性。</p><h1 id="f99c" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">跨多个可用性区域的AKS部署</h1><p id="6f95" class="pw-post-body-paragraph ku kv iq kx b ky mk jr la lb ml ju ld mm mn lg lh mo mp lk ll mq mr lo lp lq ij bi translated">确保部署的高可用性是企业工作负载的必备条件。Azure可用性区域通过将资源分布在Azure区域中的一个或多个数据中心来保护资源免受数据中心级故障的影响。</p><p id="ebe5" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">AKS集群也可以部署在可用性区域中，其中节点部署在一个区域的不同区域中。在数据中心发生故障的情况下，部署在集群中的工作负载将继续从不同区域中的节点运行，从而保护它们免受此类事件的影响。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ms"><img src="../Images/d4843fd9ff66325e8603fd3033a49ca3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*B0X_32x1lQxPIhGB.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated"><em class="mx">AKS集群可用区域概述</em></figcaption></figure><h1 id="6f76" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">Azure活动目录集成</h1><p id="78e1" class="pw-post-body-paragraph ku kv iq kx b ky mk jr la lb ml ju ld mm mn lg lh mo mp lk ll mq mr lo lp lq ij bi translated">随着身份被视为新的安全边界，客户现在选择使用Azure AD对云原生部署进行身份验证和授权。AKS集群可以与Azure Active Directory集成，以便用户可以使用他们现有的Azure AD凭据获得对集群或集群级资源中的名称空间的访问权限。这消除了在AKS集群中部署和管理工作负载时对多个凭证的需求。</p><p id="c4b0" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">这在混合云部署中有更大的好处，在混合云部署中，内部AD凭据会同步到Azure AD。它为身份验证和授权提供了一致、统一的体验。下面的图1显示了与Azure Active Directory集成时的高级AKS身份验证流程。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ms"><img src="../Images/40b5f076c473ee04f57a0f13173900c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9hP2LB6IgFNSqGFR.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated"><em class="mx">与Azure AD集成的高级AKS认证流程</em></figcaption></figure><h1 id="ceae" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">通过网络策略实现的Pod流量控制</h1><p id="bee9" class="pw-post-body-paragraph ku kv iq kx b ky mk jr la lb ml ju ld mm mn lg lh mo mp lk ll mq mr lo lp lq ij bi translated">默认情况下，AKS集群中的所有pod可以不受任何限制地相互通信。但是，在生产中，出于安全原因，客户可能希望限制这种流量。这可以通过在Kubernetes集群中实现网络策略来实现。网络策略可用于定义一组规则，根据匹配的标签允许或拒绝pod之间的流量。</p><p id="06c1" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">AKS支持两种类型的网络实现:Kubenet(基本网络)和Azure CNI(高级网络)。客户还可以在两种类型的网络策略之间进行选择:Azure(原生)或<a class="ae lr" href="https://www.projectcalico.org/" rel="noopener ugc nofollow" target="_blank"> Calico </a>网络策略(开源)。虽然Azure网络策略仅在Azure CNI受到支持，但Calico在基于Kubenet和Azure CNI的网络实现中都受到支持。</p><h1 id="615f" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">部署先决条件</h1><p id="89ee" class="pw-post-body-paragraph ku kv iq kx b ky mk jr la lb ml ju ld mm mn lg lh mo mp lk ll mq mr lo lp lq ij bi translated">以下是部署AKS集群的先决条件:</p><ul class=""><li id="3863" class="my mz iq kx b ky kz lb lc mm na mo nb mq nc lq nd ne nf ng bi translated"><strong class="kx ir"> Azure订阅访问:</strong>建议拥有贡献者权限的用户运行Terraform脚本。在部署过程中，会为AKS节点创建一个额外的资源组。受限的权限可能会导致部署失败。</li><li id="5924" class="my mz iq kx b ky nh lb ni mm nj mo nk mq nl lq nd ne nf ng bi translated"><strong class="kx ir"> Azure AD服务器和客户端应用:</strong> OpenID Connect用于集成Azure Active Directory和AKS集群。要做到这一点，需要两个Azure AD应用程序:一个服务器应用程序和一个客户端应用程序。服务器应用程序充当身份请求的端点，而客户端应用程序在用户试图通过kubectl命令访问AKS集群时用于身份验证。微软为<a class="ae lr" href="https://docs.microsoft.com/en-us/azure/aks/azure-ad-integration-cli" rel="noopener ugc nofollow" target="_blank">创建这些Azure广告应用</a>提供了分步指南。</li><li id="6a4f" class="my mz iq kx b ky nh lb ni mm nj mo nk mq nl lq nd ne nf ng bi translated"><strong class="kx ir">云壳中的Terraform用法:</strong> <a class="ae lr" href="https://docs.microsoft.com/en-us/azure/cloud-shell/overview#:~:text=Azure%20Cloud%20Shell%20is%20an,work%2C%20either%20Bash%20or%20PowerShell.&amp;text=Try%20from%20Azure%20portal%20using%20the%20Cloud%20Shell%20icon." rel="noopener ugc nofollow" target="_blank"> Azure云壳</a>在bash环境中默认安装了Terraform。你可以使用你最喜欢的文本编辑器，比如vim，或者使用Azure Cloud Shell中的代码编辑器来编写Terraform模板。参考微软的<a class="ae lr" href="https://docs.microsoft.com/en-us/azure/cloud-shell/example-terraform-bash" rel="noopener ugc nofollow" target="_blank">Azure云壳中Terraform入门指南</a>。</li></ul><h1 id="b759" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">创建Terraform模板</h1><p id="32f6" class="pw-post-body-paragraph ku kv iq kx b ky mk jr la lb ml ju ld mm mn lg lh mo mp lk ll mq mr lo lp lq ij bi translated">为了创建模板，Terraform使用HashiCorp配置语言(HCL ),因为它被设计为机器友好和人类可读。要更深入地了解Terraform语法，请参考<a class="ae lr" href="https://www.terraform.io/docs/configuration/index.html" rel="noopener ugc nofollow" target="_blank"> Terraform文档</a>。跨部署变化的值可被定义为<a class="ae lr" href="https://www.terraform.io/docs/configuration/variables.html" rel="noopener ugc nofollow" target="_blank">变量</a>，并通过变量文件或在运行时应用Terraform模板时提供。</p><p id="a360" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">在本节中，我们将描述用于创建集群的Terraform模板的相关模块。</p><p id="6ed2" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">注意:本次部署的Terraform模板以及变量和<a class="ae lr" href="https://www.terraform.io/docs/configuration/outputs.html" rel="noopener ugc nofollow" target="_blank">输出文件</a>都可以在<a class="ae lr" href="https://github.com/coder-society/terraform-aks-azure" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>中找到。</p><h1 id="eeaa" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">网络安装程序</h1><p id="127f" class="pw-post-body-paragraph ku kv iq kx b ky mk jr la lb ml ju ld mm mn lg lh mo mp lk ll mq mr lo lp lq ij bi translated">应使用以下Terraform代码块来创建Azure VNet和子网，这是Azure CNI网络实施所需的:</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="4521" class="nr lt iq nn b gy ns nt l nu nv">resource "azurerm_virtual_network" "demo" {<br/>  name                = "${var.prefix}-network"<br/>  location            = azurerm_resource_group.demo.location<br/>  resource_group_name = azurerm_resource_group.demo.name<br/>  address_space       = ["10.1.0.0/16"]<br/>}<br/><br/>resource "azurerm_subnet" "demo" {<br/>  name                 = "${var.prefix}-akssubnet"<br/>  virtual_network_name = azurerm_virtual_network.demo.name<br/>  resource_group_name  = azurerm_resource_group.demo.name<br/>  address_prefixes     = ["10.1.0.0/22"]<br/>}</span></pre><p id="0226" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated"><strong class="kx ir"> var.prefix: </strong>在Terraform变量文件中将定义一个前缀，用于区分部署。</p><p id="0044" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated"><strong class="kx ir">演示:</strong>这是Terraform用来引用已定义资源(如Azure VNet和子网)的<a class="ae lr" href="https://www.terraform.io/docs/configuration/resources.html" rel="noopener ugc nofollow" target="_blank">本地名称</a>。可以根据您的使用情况对其进行重命名。</p><p id="53af" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated"><strong class="kx ir">地址空间和地址前缀:</strong>这是指虚拟网络和子网的地址空间。您可以用自己喜欢的私有IP地址块替换这些值。</p><h1 id="1ecf" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">Azure广告集成</h1><p id="a050" class="pw-post-body-paragraph ku kv iq kx b ky mk jr la lb ml ju ld mm mn lg lh mo mp lk ll mq mr lo lp lq ij bi translated">为了实现Azure AD集成，我们需要提供服务器应用程序、客户端应用程序和Azure AD租户详细信息。应在AKS群集定义中使用以下代码块，以便为AKS群集启用RBAC，并使用Azure AD进行RBAC身份验证。</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="3d11" class="nr lt iq nn b gy ns nt l nu nv">role_based_access_control {<br/>    azure_active_directory {<br/>      client_app_id     = var.client_app_id<br/>      server_app_id     = var.server_app_id<br/>      server_app_secret = var.server_app_secret<br/>      tenant_id         = var.tenant_id<br/>    }    <br/>    enabled = true<br/>  }</span></pre><p id="21ed" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated"><strong class="kx ir"> var.client_app_id: </strong>此变量指的是前提条件部分提到的Azure AD客户端应用程序的客户端应用程序id。</p><p id="cf10" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated"><strong class="kx ir"> var.server_app_id: </strong>此变量指的是先决条件部分提到的Azure AD server应用程序的服务器应用程序id。</p><p id="558f" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated"><strong class="kx ir"> var.server_app_secret: </strong>这个变量是指为Azure AD server应用程序创建的秘密。</p><p id="79e7" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated"><strong class="kx ir"> var.tenant_id: </strong>该变量指的是与将部署集群的订阅相关联的Azure AD租户id。这个值可以从Azure门户或者通过<a class="ae lr" href="https://docs.microsoft.com/en-us/azure/aks/azure-ad-integration-cli#deploy-the-cluster" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a>获得。</p><h1 id="261d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">网络策略配置</h1><p id="9cb2" class="pw-post-body-paragraph ku kv iq kx b ky mk jr la lb ml ju ld mm mn lg lh mo mp lk ll mq mr lo lp lq ij bi translated">以下Terraform代码将用于AKS集群定义中，以启用Calico网络策略。请注意，这只能在群集部署期间进行配置，任何更改都需要重新创建群集。</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="ff1d" class="nr lt iq nn b gy ns nt l nu nv">network_profile {<br/>    network_plugin     = "azure"<br/>    load_balancer_sku  = "standard"<br/>    network_policy     = "calico"<br/>  }</span></pre><p id="d797" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated"><strong class="kx ir">网络插件:</strong>该值应设置为<code class="fe nw nx ny nn b">azure</code>以使用CNI网络。</p><p id="f202" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated"><strong class="kx ir"> load_balancer_sku: </strong>该值应该设置为<code class="fe nw nx ny nn b">standard</code>，因为我们将使用虚拟机规模集。</p><p id="acc6" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated"><strong class="kx ir"> network_policy: </strong>该值应该设置为<code class="fe nw nx ny nn b">calico</code>，因为我们将使用Calico网络策略。</p><h1 id="62ac" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">节点池和可用性区域配置</h1><p id="74f0" class="pw-post-body-paragraph ku kv iq kx b ky mk jr la lb ml ju ld mm mn lg lh mo mp lk ll mq mr lo lp lq ij bi translated">以下代码将用于配置节点池和可用性区域。</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="e514" class="nr lt iq nn b gy ns nt l nu nv">default_node_pool {<br/>    name                = "default"<br/>    node_count          = 2<br/>    vm_size             = "Standard_D2_v2"<br/>    type                = "VirtualMachineScaleSets"<br/>    availability_zones  = ["1", "2"]<br/>    enable_auto_scaling = true<br/>    min_count           = 2<br/>    max_count           = 4<br/><br/>    # Required for advanced networking<br/>    vnet_subnet_id = azurerm_subnet.demo.id<br/>  }</span></pre><p id="289f" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated"><strong class="kx ir"> node_count: </strong>节点池中部署的初始节点数量。</p><p id="ffcc" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">本例中使用了<strong class="kx ir">VM _ size:</strong><code class="fe nw nx ny nn b">Standard_D2_v2</code>；它可以替换为您喜欢的SKU。</p><p id="a01c" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated"><strong class="kx ir">类型:</strong>应该设置为<code class="fe nw nx ny nn b">VirtualMachineScaleSets</code>，这样虚拟机就可以跨可用性区域分布。</p><p id="360e" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated"><strong class="kx ir"> availability_zones: </strong>列出可使用的区域。</p><p id="6112" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated"><strong class="kx ir"> enable_auto_scaling: </strong>应设置为<code class="fe nw nx ny nn b">true</code>以启用自动缩放。</p><p id="6ab0" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">应该设置变量<code class="fe nw nx ny nn b">min_count</code>和<code class="fe nw nx ny nn b">max_count</code>来定义节点池中的最小和最大节点数。此处的值应该介于1和100之间。</p><h1 id="73a0" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">部署HA AKS集群</h1><p id="30ec" class="pw-post-body-paragraph ku kv iq kx b ky mk jr la lb ml ju ld mm mn lg lh mo mp lk ll mq mr lo lp lq ij bi translated">将Terraform文件从<a class="ae lr" href="https://github.com/coder-society/terraform-aks-azure" rel="noopener ugc nofollow" target="_blank"> GitHub存储库</a>下载到您的云Shell会话，并根据您的AKS集群部署需求编辑配置参数。上一节提供的指导可用于更新这些值。</p><p id="e359" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">1 /运行以下命令在CloudShell中克隆GitHub存储库:</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="d847" class="nr lt iq nn b gy ns nt l nu nv">git clone https://github.com/coder-society/terraform-aks-azure.git<br/>Cloning into 'terraform-aks-azure'...<br/>remote: Enumerating objects: 12, done.<br/>remote: Counting objects: 100% (12/12), done.<br/>remote: Compressing objects: 100% (10/10), done.<br/>remote: Total 12 (delta 1), reused 12 (delta 1), pack-reused 0<br/>Unpacking objects: 100% (12/12), done.<br/>Checking connectivity... done.</span></pre><p id="24c0" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">2/进入<code class="fe nw nx ny nn b">/terraform</code>目录，运行<code class="fe nw nx ny nn b">terraform init</code>命令初始化Terraform:</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="1587" class="nr lt iq nn b gy ns nt l nu nv">terraform init</span><span id="d28b" class="nr lt iq nn b gy nz nt l nu nv">Initializing the backend...</span><span id="1c78" class="nr lt iq nn b gy nz nt l nu nv">Initializing provider plugins...<br/>- Finding hashicorp/azurerm versions matching "~&gt; 2.0"...<br/>- Installing hashicorp/azurerm v2.28.0...<br/>- Installed hashicorp/azurerm v2.28.0 (signed by HashiCorp)</span><span id="02fa" class="nr lt iq nn b gy nz nt l nu nv">Terraform has been successfully initialized!</span><span id="25bb" class="nr lt iq nn b gy nz nt l nu nv">You may now begin working with Terraform. Try running "terraform plan" to see<br/>any changes that are required for your infrastructure. All Terraform commands<br/>should now work.</span><span id="0ed4" class="nr lt iq nn b gy nz nt l nu nv">If you ever set or change modules or backend configuration for Terraform,<br/>rerun this command to reinitialize your working directory. If you forget, other<br/>commands will detect it and remind you to do so if necessary.</span></pre><p id="3c7f" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">3 /导出要在运行时使用的Terraform变量，用特定于环境的值替换占位符。您也可以在变量文件中定义值。</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="85d2" class="nr lt iq nn b gy ns nt l nu nv">export TF_VAR_prefix=&lt;Environment prefix&gt;<br/>export TF_VAR_client_app_id=&lt;The client app ID of the AKS client application&gt;  <br/>export TF_VAR_server_app_id=&lt;The server app ID of the AKS server application&gt;<br/>export TF_VAR_server_app_secret=&lt;The secret created for AKS server application&gt;<br/>export TF_VAR_tenant_id=&lt;The Azure AD tenant id&gt;</span></pre><p id="c918" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">4 /通过执行<code class="fe nw nx ny nn b">terraform plan -out out.plan</code>创建地形图。</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="7309" class="nr lt iq nn b gy ns nt l nu nv">terraform plan -out out.plan<br/>Refreshing Terraform state in-memory prior to plan...<br/>The refreshed state will be used to calculate this plan, but will not be<br/>persisted to local or remote state storage.<br/></span><span id="6d89" class="nr lt iq nn b gy nz nt l nu nv">------------------------------------------------------------------------</span><span id="4bea" class="nr lt iq nn b gy nz nt l nu nv">An execution plan has been generated and is shown below.<br/>Resource actions are indicated with the following symbols:<br/>  + create</span><span id="d1d6" class="nr lt iq nn b gy nz nt l nu nv">Terraform will perform the following actions:</span><span id="974a" class="nr lt iq nn b gy nz nt l nu nv">  # azurerm_kubernetes_cluster.demo will be created<br/>  + resource "azurerm_kubernetes_cluster" "demo" {<br/>      + dns_prefix              = "cs-aks"<br/>      + fqdn                    = (known after apply)<br/>      + id                      = (known after apply)<br/>      + kube_admin_config       = (known after apply)<br/>      + kube_admin_config_raw   = (sensitive value)<br/>      + kube_config             = (known after apply)<br/>      + kube_config_raw         = (sensitive value)<br/>      + kubelet_identity        = (known after apply)<br/>      + kubernetes_version      = (known after apply)<br/>      + location                = "westeurope"<br/>      + name                    = "cs-aks"<br/>      + node_resource_group     = (known after apply)<br/>      + private_cluster_enabled = (known after apply)<br/>      + private_fqdn            = (known after apply)<br/>      + private_link_enabled    = (known after apply)<br/>      + resource_group_name     = "cs-rg"<br/>      + sku_tier                = "Free"<br/>      + tags                    = {<br/>          + "Environment" = "Development"<br/>        }</span><span id="739f" class="nr lt iq nn b gy nz nt l nu nv">      + addon_profile {<br/>          + aci_connector_linux {<br/>              + enabled     = (known after apply)<br/>              + subnet_name = (known after apply)<br/>            }</span><span id="a1c2" class="nr lt iq nn b gy nz nt l nu nv">          + azure_policy {<br/>              + enabled = (known after apply)<br/>            }</span><span id="8a11" class="nr lt iq nn b gy nz nt l nu nv">          + http_application_routing {<br/>              + enabled                            = (known after apply)<br/>              + http_application_routing_zone_name = (known after apply)<br/>            }</span><span id="36bb" class="nr lt iq nn b gy nz nt l nu nv">          + kube_dashboard {<br/>              + enabled = (known after apply)<br/>            }</span><span id="bba9" class="nr lt iq nn b gy nz nt l nu nv">          + oms_agent {<br/>              + enabled                    = (known after apply)<br/>              + log_analytics_workspace_id = (known after apply)<br/>              + oms_agent_identity         = (known after apply)<br/>            }<br/>        }</span><span id="30d1" class="nr lt iq nn b gy nz nt l nu nv">      + auto_scaler_profile {<br/>          + balance_similar_node_groups      = (known after apply)<br/>          + max_graceful_termination_sec     = (known after apply)<br/>          + scale_down_delay_after_add       = (known after apply)<br/>          + scale_down_delay_after_delete    = (known after apply)<br/>          + scale_down_delay_after_failure   = (known after apply)<br/>          + scale_down_unneeded              = (known after apply)<br/>          + scale_down_unready               = (known after apply)<br/>          + scale_down_utilization_threshold = (known after apply)<br/>          + scan_interval                    = (known after apply)<br/>        }</span><span id="8c3f" class="nr lt iq nn b gy nz nt l nu nv">      + default_node_pool {<br/>          + availability_zones   = [<br/>              + "1",<br/>              + "2",<br/>            ]<br/>          + enable_auto_scaling  = true<br/>          + max_count            = 4<br/>          + max_pods             = (known after apply)<br/>          + min_count            = 2<br/>          + name                 = "default"<br/>          + node_count           = 2<br/>          + orchestrator_version = (known after apply)<br/>          + os_disk_size_gb      = (known after apply)<br/>          + type                 = "VirtualMachineScaleSets"<br/>          + vm_size              = "Standard_D2_v2"<br/>          + vnet_subnet_id       = (known after apply)<br/>        }</span><span id="cc6b" class="nr lt iq nn b gy nz nt l nu nv">      + identity {<br/>          + principal_id = (known after apply)<br/>          + tenant_id    = (known after apply)<br/>          + type         = "SystemAssigned"<br/>        }</span><span id="bde4" class="nr lt iq nn b gy nz nt l nu nv">      + network_profile {<br/>          + dns_service_ip     = (known after apply)<br/>          + docker_bridge_cidr = (known after apply)<br/>          + load_balancer_sku  = "standard"<br/>          + network_plugin     = "azure"<br/>          + network_policy     = "calico"<br/>          + outbound_type      = "loadBalancer"<br/>          + pod_cidr           = (known after apply)<br/>          + service_cidr       = (known after apply)</span><span id="cf63" class="nr lt iq nn b gy nz nt l nu nv">          + load_balancer_profile {<br/>              + effective_outbound_ips    = (known after apply)<br/>              + idle_timeout_in_minutes   = (known after apply)<br/>              + managed_outbound_ip_count = (known after apply)<br/>              + outbound_ip_address_ids   = (known after apply)<br/>              + outbound_ip_prefix_ids    = (known after apply)<br/>              + outbound_ports_allocated  = (known after apply)<br/>            }<br/>        }</span><span id="6b79" class="nr lt iq nn b gy nz nt l nu nv">      + role_based_access_control {<br/>          + enabled = true</span><span id="afaa" class="nr lt iq nn b gy nz nt l nu nv">          + azure_active_directory {<br/>              + client_app_id     = "f9bf8772-aaba-4773-a815-784b31f9ab8b"<br/>              + server_app_id     = "fa7775b3-ea31-4e99-92f5-8ed0bac3e6a8"<br/>              + server_app_secret = (sensitive value)<br/>              + tenant_id         = "8f55a88a-7752-4e10-9bbb-e847ae93911d"<br/>            }<br/>        }</span><span id="6694" class="nr lt iq nn b gy nz nt l nu nv">      + windows_profile {<br/>          + admin_password = (sensitive value)<br/>          + admin_username = (known after apply)<br/>        }<br/>    }</span><span id="f996" class="nr lt iq nn b gy nz nt l nu nv">  # azurerm_resource_group.demo will be created<br/>  + resource "azurerm_resource_group" "demo" {<br/>      + id       = (known after apply)<br/>      + location = "westeurope"<br/>      + name     = "cs-rg"<br/>    }</span><span id="b304" class="nr lt iq nn b gy nz nt l nu nv">  # azurerm_subnet.demo will be created<br/>  + resource "azurerm_subnet" "demo" {<br/>      + address_prefix                                 = (known after apply)<br/>      + address_prefixes                               = [<br/>          + "10.1.0.0/22",<br/>        ]<br/>      + enforce_private_link_endpoint_network_policies = false<br/>      + enforce_private_link_service_network_policies  = false<br/>      + id                                             = (known after apply)<br/>      + name                                           = "cs-subnet"<br/>      + resource_group_name                            = "cs-rg"<br/>      + virtual_network_name                           = "cs-network"<br/>    }</span><span id="d9a7" class="nr lt iq nn b gy nz nt l nu nv">  # azurerm_virtual_network.demo will be created<br/>  + resource "azurerm_virtual_network" "demo" {<br/>      + address_space       = [<br/>          + "10.1.0.0/16",<br/>        ]<br/>      + guid                = (known after apply)<br/>      + id                  = (known after apply)<br/>      + location            = "westeurope"<br/>      + name                = "cs-network"<br/>      + resource_group_name = "cs-rg"<br/>      + subnet              = (known after apply)<br/>    }</span><span id="04ce" class="nr lt iq nn b gy nz nt l nu nv">Plan: 4 to add, 0 to change, 0 to destroy.</span><span id="3e12" class="nr lt iq nn b gy nz nt l nu nv">------------------------------------------------------------------------</span><span id="3d4b" class="nr lt iq nn b gy nz nt l nu nv">This plan was saved to: out.plan</span><span id="8eff" class="nr lt iq nn b gy nz nt l nu nv">To perform exactly these actions, run the following command to apply:<br/>    terraform apply "out.plan"</span></pre><p id="c8b2" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">5 /使用<code class="fe nw nx ny nn b">terraform apply out.plan</code>命令应用该计划。</p><p id="fac1" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">成功部署后，集群、网络等的详细信息。将在命令行中显示:</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="055c" class="nr lt iq nn b gy ns nt l nu nv">terraform apply out.plan<br/>azurerm_resource_group.demo: Creating...<br/>azurerm_resource_group.demo: Creation complete after 1s [id=/subscriptions/a7a456e9-0307-4196-b786-5a33ce52b5fd/resourceGroups/cs-rg]<br/>azurerm_virtual_network.demo: Creating...<br/>azurerm_virtual_network.demo: Still creating... [10s elapsed]<br/>azurerm_virtual_network.demo: Creation complete after 15s [id=/subscriptions/a7a456e9-0307-4196-b786-5a33ce52b5fd/resourceGroups/cs-rg/providers/Microsoft.Network/virtualNetworks/cs-network]<br/>azurerm_subnet.demo: Creating...<br/>azurerm_subnet.demo: Creation complete after 2s [id=/subscriptions/a7a456e9-0307-4196-b786-5a33ce52b5fd/resourceGroups/cs-rg/providers/Microsoft.Network/virtualNetworks/cs-network/subnets/cs-subnet]<br/>azurerm_kubernetes_cluster.demo: Creating...<br/>azurerm_kubernetes_cluster.demo: Still creating... [10s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [20s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [30s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [40s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [50s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [1m0s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [1m10s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [1m20s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [1m30s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [1m40s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [1m50s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [2m0s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [2m10s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [2m20s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [2m30s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [2m40s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [2m50s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [3m0s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [3m10s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [3m20s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [3m30s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [3m40s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [3m50s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [4m0s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [4m10s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [4m20s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [4m30s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [4m40s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [4m50s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [5m0s elapsed]<br/>azurerm_kubernetes_cluster.demo: Still creating... [5m10s elapsed]<br/>azurerm_kubernetes_cluster.demo: Creation complete after 5m16s [id=/subscriptions/a7a456e9-0307-4196-b786-5a33ce52b5fd/resourcegroups/cs-rg/providers/Microsoft.ContainerService/managedClusters/cs-aks]</span><span id="1a66" class="nr lt iq nn b gy nz nt l nu nv">Apply complete! Resources: 4 added, 0 changed, 0 destroyed.</span><span id="b5a6" class="nr lt iq nn b gy nz nt l nu nv">The state of your infrastructure has been saved to the path<br/>below. This state is required to modify and destroy your<br/>infrastructure, so keep it safe. To inspect the complete state<br/>use the `terraform show` command.</span><span id="964f" class="nr lt iq nn b gy nz nt l nu nv">State path: terraform.tfstate</span><span id="11c1" class="nr lt iq nn b gy nz nt l nu nv">Outputs:</span><span id="7814" class="nr lt iq nn b gy nz nt l nu nv">client_certificate =<br/>kube_config = apiVersion: v1<br/>clusters:<br/>- cluster:<br/>    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUV5akNDQXJLZ0F3SUJBZ0lSQU01eXFucWJNNmoxekFhbk8vczdIeVV3RFFZSktvWklodmNOQVFFTEJRQXcKRFRFTE1Ba0dBMVVFQXhNQ1kyRXdJQmNOTWpBd09USXlNakEwTWpJeFdoZ1BNakExTURBNU1qSXlNRFV5TWpGYQpNQTB4Q3pBSkJnTlZCQU1UQW1OaE1JSUNJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBZzhBTUlJQ0NnS0NBZ0VBCnc5WlYwd0hORkJiaURUcnZMQ1hJU2JoTHdScFZ1WVowMVJ5QzU0QWo1WUJjNzZyRXZIQVZlRXhWYlRYc0wrdDEKMVJPOG85bVY2UG01UXprUzdPb2JvNEV6ampTY2RBcjUvazJ4eC9BLzk0ZFl2Q20wWHZQaktXSWxiS08yaDBuNQp4VW03OFNsUks4RFVReUtGWmxTMEdXQ0hKbEhnNnpVZU8xMVB5MTQvaXBic1JYdTNFYVVLeWFJczgrekxSK2NNCm5tSU5wcHFPNUVNSzZKZVZKM0V0SWFDaFBNbHJiMVEzNHlZbWNKeVkyQmZaVkVvV2pRL1BMNFNFbGw0T0dxQjgKK3Rlc3I2TDBvOW5LT25LVlB0ZCtvSXllWnQ1QzBiMnJScnFDU1IyR09VZmsvMTV3emFiNTJ6M0JjempuV0VNOApnWWszZlBDU3JvNGE5a0xQVS9Udnk1UnZaUjJsc09mUWk3eGZpNm91dzJQeEkxc1ZPcmJnRWdza2o5Qmc4WnJYCk5GZjJpWlptSFM0djNDM1I4Q25NaHNRSVdiSmlDalhDclZCak1QbzVNS0xzNEF5U1M2dU1MelFtSjhNQWVZQlEKSHJrWEhZa21OeHlGMkhqSVlTcTdjZWFOVHJ1dTh2SFlOT2c3MGM5aGEvakZ0MXczWVl4N3NwbGRSRGpmZHZiQgpaeEtwbWNkUzY3RVNYT0dtTEhwZis1TTZXMVI3UWQwYk1SOGRQdFZJb1NmU2RZSFFLM0FDdUxrd1ZxOWpGMXlnCiswcklWMC9rN0F6bzNnUlVxeFBIV0twcHN2bFhaZCtsK0VqcTRLMnFMRXd4MlFOMDJHL1dGVUhFdGJEUXAvZWYKZGxod3Z0OHp1VklIbXE0ejlsMGZSOU9QaGN6UFpXR0dyWnUrTlQ2cm5RTUNBd0VBQWFNak1DRXdEZ1lEVlIwUApBUUgvQkFRREFnS2tNQThHQTFVZEV3RUIvd1FGTUFNQkFmOHdEUVlKS29aSWh2Y05BUUVMQlFBRGdnSUJBQjQ0CmRzbExhRzFrSzFHaFZiR1VEbWtWNndsTHJ1a1F3SHc2Vkt2azJ0T0UwMU1Hbng5SkJwVFFIL2FMdWYxUTN0WVAKaVhWSnp1bGsxOWg2MjUrcEs0ekpQcDZSWkhMV3htK2M0a1pLejlwV3F3RERuNmZqTVlKOEdMNVZFOUwvQUdSRgpscEI5ZTZNOVNGY20ra2lMVVlLazg3VG1YaGd4dzFXYXhtaDEwd01DNlZPOGNuZlVRQkJJQkVMVXhNZy9DRE9SCjZjSGFTdU5ETlg0UG80eFF3NnV4c0d1R2xDbHltOUt4Z2pIYjQ5SWp2NnN5clRIcGkrVkxmQ3d4TmdLZUwxZ1cKNURVR3ZoMmpoTVJqNDhyV3FoY3JjUHI4aWtoeVlwOXMwcFJYQVlUTk52SlFzaDhmYllOcTIzbDZwVW16dUV0UwpQS2J2WUJDVmxxa29ualZiRkxIeXJuRWNFbllqdXhwYy94bWYvT09keHhUZzlPaEtFQTRLRTQySFJ2cW1SZER5CkFldVhIcUxvUm54TXF1Z0JxL0tTclM2S0tjQW11eVJWdkhJL21MUlhmY1k1VThCWDBXcUF0N1lrWm54d1JnRkQKQndRcnEvdDJrUkMySSsxR1pUd2d1Y3hyc0VrYlVoVG5DaStVbjNDRXpTbmg5anBtdDBDcklYaDYzeC9LY014egpGM0ZXNWlnZDR4MHNxYk5oK3B4K1VSVUlsUmZlMUxDRWg3dGlraVRHRGtGT05EQXBSQUMycnUrM0I5TlpsR0hZCm9jWS9tcTlpdUtXTUpobjFHeXJzWGZLZXQrakliZzhUNzZzaEora0E4djU3VmdBdlRRSEh1YTg2SHl6d1d2Z0QKQ2ZaZFhpeURvZGlWRXhPNGlGaG00T1dhZld5U0ltSUsrOCs1Z2daZwotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==<br/>    server: https://cs-aks-f9e8be99.hcp.westeurope.azmk8s.io:443<br/>  name: cs-aks<br/>contexts:<br/>- context:<br/>    cluster: cs-aks<br/>    user: clusterUser_cs-rg_cs-aks<br/>  name: cs-aks<br/>current-context: cs-aks<br/>kind: Config<br/>preferences: {}<br/>users:<br/>- name: clusterUser_cs-rg_cs-aks<br/>  user:<br/>    auth-provider:<br/>      config:<br/>        apiserver-id: fa7775b3-ea31-4e99-92f5-8ed0bac3e6a8<br/>        client-id: f9bf8772-aaba-4773-a815-784b31f9ab8b<br/>        config-mode: "1"<br/>        environment: AzurePublicCloud<br/>        tenant-id: 8f55a88a-7752-4e10-9bbb-e847ae93911d<br/>      name: azure</span></pre><p id="5110" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">6 /浏览到Azure门户中的资源池，以查看由部署创建的群集和网络:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/a3bcd03c63e021312bd36f289560ca34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*oWgNC1dksb2AVxDQ.png"/></div></div></figure><p id="4a7c" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">7 /使用Azure客户端检索admin kubeconfig:</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="23be" class="nr lt iq nn b gy ns nt l nu nv">az aks get-credentials --resource-group $prefix-rg --name $prefix-aks --admin --overwrite-existing</span></pre><p id="e4f4" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">8 /运行以下命令列出节点和可用性区域配置:</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="3a38" class="nr lt iq nn b gy ns nt l nu nv">kubectl describe nodes | grep -e "Name:" -e "failure-domain.beta.kubernetes.io/zone"<br/>Name:               aks-default-36042037-vmss000000<br/>                    failure-domain.beta.kubernetes.io/zone=westeurope-1<br/>Name:               aks-default-36042037-vmss000001<br/>                    failure-domain.beta.kubernetes.io/zone=westeurope-2</span></pre><p id="1e73" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated"><code class="fe nw nx ny nn b">failure-domain.beta.kubernetes.io/zone</code>是一个与Kubernetes节点相关联的标签，表示它被部署的区域。输出显示节点部署在西欧的两个可用性区域。</p><h1 id="88c1" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">配置Azure Active Directory集成</h1><ol class=""><li id="a364" class="my mz iq kx b ky mk lb ml mm ob mo oc mq od lq oe ne nf ng bi translated">在Azure AD中创建群。</li></ol><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="dccd" class="nr lt iq nn b gy ns nt l nu nv">GROUP_ID=$(az ad group create --display-name dev --mail-nickname dev --query objectId -o tsv)</span></pre><p id="7f99" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">2 /检索AKS集群的资源ID</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="6487" class="nr lt iq nn b gy ns nt l nu nv">AKS_ID=$(az aks show \<br/>    --resource-group $prefix-rg \<br/>    --name $prefix-aks \<br/>    --query id -o tsv)</span></pre><p id="d4fb" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">3 /创建一个Azure角色分配，这样<code class="fe nw nx ny nn b">dev</code>组的任何成员都可以使用<code class="fe nw nx ny nn b">kubectl</code>与Kubernetes集群交互。</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="5b98" class="nr lt iq nn b gy ns nt l nu nv">az role assignment create \<br/>  --assignee $GROUP_ID \<br/>  --role "Azure Kubernetes Service Cluster User Role" \<br/>  --scope $AKS_ID</span></pre><p id="9272" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">4 /将您自己添加到<code class="fe nw nx ny nn b">dev</code>广告组。</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="81f8" class="nr lt iq nn b gy ns nt l nu nv">USER_ID=$(az ad signed-in-user show --query objectId -o tsv)<br/>az ad group member add --group dev --member-id $USER_ID</span></pre><p id="e432" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">5 /使用admin kubeconfig，创建一个<code class="fe nw nx ny nn b">development</code>和<code class="fe nw nx ny nn b">production</code> Kubernetes名称空间。<code class="fe nw nx ny nn b">kubectl create namespace development kubectl create namespace production</code></p><p id="3248" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">6 /用之前创建的组的资源ID替换<code class="fe nw nx ny nn b">groupObjectId</code>并应用<code class="fe nw nx ny nn b">rolebinding.yaml</code>文件。</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="e3ac" class="nr lt iq nn b gy ns nt l nu nv">sed -i '' "s/groupObjectId/$GROUP_ID/g" rolebinding.yaml<br/>kubectl apply -f rolebinding.yaml</span></pre><p id="1424" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">7 /在测试Azure AD集成之前，运行以下命令获取群集凭据。</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="65d8" class="nr lt iq nn b gy ns nt l nu nv">az aks get-credentials --resource-group $prefix-rg --name $prefix-aks --overwrite-existing</span></pre><p id="089c" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">8 /运行下面的kubectl命令来查看Azure AD集成的运行情况:</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="b4f4" class="nr lt iq nn b gy ns nt l nu nv">kubectl get pods --namespace development<br/>To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DSFV9H98W to authenticate.<br/>No resources found in development namespace.</span></pre><p id="77a0" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">在设备登录页面中输入代码，然后输入您的Azure AD登录凭据:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="ab gu cl of"><img src="../Images/31573030d1a65a61fbd5e375cc6c1f55.png" data-original-src="https://miro.medium.com/v2/format:webp/1*b31hiO4ynbDLRrXWEFF4aQ.png"/></div></figure><p id="8771" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">请注意，只有<code class="fe nw nx ny nn b">dev</code>组中的用户才能通过此过程登录。</p><p id="5e8d" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">9 /尝试访问<code class="fe nw nx ny nn b">production</code>名称空间中的资源:</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="c1ef" class="nr lt iq nn b gy ns nt l nu nv">kubectl get pods --namespace production<br/>Error from server (Forbidden): pods is forbidden: User "kentaro@codersociety.com" cannot list resource "pods" in API group "" in the namespace "production"</span><span id="61de" class="nr lt iq nn b gy nz nt l nu nv">kubectl get pods --namespace development<br/>To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DSFV9H98W to authenticate.<br/>No resources found in development namespace.</span></pre><h1 id="fc06" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">使用Calico配置网络策略</h1><p id="27ad" class="pw-post-body-paragraph ku kv iq kx b ky mk jr la lb ml ju ld mm mn lg lh mo mp lk ll mq mr lo lp lq ij bi translated">1 /为了测试Calico网络策略，使用<a class="ae lr" href="https://github.com/coder-society/terraform-aks-azure/blob/master/k8s/httpbin.yaml" rel="noopener ugc nofollow" target="_blank"> k8s/httpbin.yaml </a>在名称空间中创建一个httpbin服务和部署。</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="4e17" class="nr lt iq nn b gy ns nt l nu nv">kubectl apply -f httpbin.yaml --namespace development</span></pre><p id="cca5" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">2 /使用<a class="ae lr" href="https://github.com/coder-society/terraform-aks-azure/blob/master/k8s/networkpolicy.yaml" rel="noopener ugc nofollow" target="_blank"> k8s/networkpolicy.yaml </a>创建一个网络策略，限制对部署的所有入站访问。我们只允许标签为<code class="fe nw nx ny nn b">app: webapp</code>的pod进行网络访问。</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="3548" class="nr lt iq nn b gy ns nt l nu nv">kubectl apply -f networkpolicy.yaml --namespace development</span></pre><p id="464b" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">3 /创建一个新的pod并测试对httpbin服务的访问。在pod的命令提示符下，尝试通过端口8000访问httpbin服务。访问将超时。测试后，您可以键入“exit”退出并删除pod。</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="45e0" class="nr lt iq nn b gy ns nt l nu nv">kubectl run --rm -it --image=alpine frontend --namespace development<br/>If you don't see a command prompt, try pressing enter.<br/>/ # wget --timeout=2 http://httpbin:8000<br/>Connecting to httpbin:8000 (10.0.233.179:8000)<br/>wget: download timed out<br/>/ # exit</span></pre><p id="7043" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">4 /创建一个新的测试盒，但这次标签要符合入口规则。然后运行wget命令检查通过端口8000对httpbin服务的访问。</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="a882" class="nr lt iq nn b gy ns nt l nu nv">kubectl run --rm -it --image=alpine frontend --labels app=webapp --namespace development<br/>If you don't see a command prompt, try pressing enter.<br/>/ # wget --timeout=2 http://httpbin:8000<br/>Connecting to httpbin:8000 (10.0.233.179:8000)<br/>saving to 'index.html'<br/>index.html           100% |************************************************************************************|  9593  0:00:00 ETA<br/>'index.html' saved</span></pre><p id="aeca" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">您可以看到，现在可以检索index.html，这表明pod可以访问httpbin服务，因为pod标签与入口策略相匹配。</p><h1 id="cd4a" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">删除演示资源</h1><p id="c0fd" class="pw-post-body-paragraph ku kv iq kx b ky mk jr la lb ml ju ld mm mn lg lh mo mp lk ll mq mr lo lp lq ij bi translated">进入<code class="fe nw nx ny nn b">terraform</code>目录并运行<code class="fe nw nx ny nn b">terraform destroy</code>。当您通过输入<code class="fe nw nx ny nn b">yes</code>确认时，系统会询问您是否真的想要删除资源。</p><h1 id="a166" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">摘要</h1><p id="02e3" class="pw-post-body-paragraph ku kv iq kx b ky mk jr la lb ml ju ld mm mn lg lh mo mp lk ll mq mr lo lp lq ij bi translated">可用性区域、Azure AD集成和Calico网络策略都有助于为部署在AKS中的应用程序实现高可用性、无缝身份管理和高级网络流量管理。</p><p id="427a" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">可用性区域有助于保护您的工作负载免受Azure数据中心故障的影响，并确保生产系统的弹性。Azure AD集成对于统一集群的身份管理至关重要，因为客户也可以继续利用他们在Azure AD上的投资来管理AKS工作负载。Calico网络策略通过确保只有合法流量到达您的工作负载，帮助增强部署在AKS中的业务线应用程序的安全状况。</p><p id="a010" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">这些功能是确保您的AKS集群生产就绪的关键。</p><p id="cd6a" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">作为下一步，本文中涉及的AKS集群的自动化部署也可以与您现有的基础设施即代码DevOps管道集成，用于生产规模的部署。</p></div><div class="ab cl og oh hu oi" role="separator"><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol"/></div><div class="ij ik il im in"><p id="6b6e" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated"><em class="kw">原载于</em><a class="ae lr" href="https://codersociety.com/blog/articles/terraform-azure-kubernetes" rel="noopener ugc nofollow" target="_blank"><em class="kw">https://codersociety.com</em></a><em class="kw">。</em></p></div></div>    
</body>
</html>