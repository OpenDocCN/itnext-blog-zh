<html>
<head>
<title>Datadog — Azure API Management logs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Datadog — Azure API管理日志</h1>
<blockquote>原文：<a href="https://itnext.io/datadog-azure-api-management-logs-60f9d45d667a?source=collection_archive---------1-----------------------#2020-11-07">https://itnext.io/datadog-azure-api-management-logs-60f9d45d667a?source=collection_archive---------1-----------------------#2020-11-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/32ba2a7ee6f590e3ba0d0632b978da65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*83K-XbbNY6hhU-HL.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://devclass.com/2019/12/05/datadog-serves-rum-brings-users-into-focus/" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><p id="9bfa" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Azure资源通常与日志和APM(应用程序性能监控)的App Insights有很好的集成。但有时您的监控堆栈是由第三方公司提供的，如New Relic、Zabbix或Datadog。</p><p id="f864" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本指南中，我们将介绍如何将每个触及Azure API管理的请求记录到Datadog中。</p><h2 id="76a8" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">什么是Datadog？</h2><p id="8fa2" class="pw-post-body-paragraph kg kh it ki b kj lx kl km kn ly kp kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">Datadog是一种针对云规模应用程序的监控服务，通过位于SaaS的数据分析平台提供对服务器、数据库、工具和服务的监控。[维基百科]</p><h1 id="5fdd" class="mc lf it bd lg md me mf lj mg mh mi lm mj mk ml lp mm mn mo ls mp mq mr lv ms bi translated">从API管理记录日志</h1><p id="ade5" class="pw-post-body-paragraph kg kh it ki b kj lx kl km kn ly kp kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">我在<a class="ae kf" href="https://docs.datadoghq.com/integrations/azure/?tab=azurecliv20#datadog-azure-function" rel="noopener ugc nofollow" target="_blank">基地文档</a>中了解到这个测井流程。</p><h1 id="69fb" class="mc lf it bd lg md me mf lj mg mh mi lm mj mk ml lp mm mn mo ls mp mq mr lv ms bi translated">台阶</h1><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/19eb654bca9b163fe37f26072316465c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1278/format:webp/1*pLA56jAQWYR1N6gWAK0ryQ.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">图表:Azure API管理&gt;事件中心&gt;功能应用&gt;数据狗</figcaption></figure><p id="1c2c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这种集成需要一些组件，所以让我们来手动配置一下:</p><blockquote class="my mz na"><p id="3769" class="kg kh nb ki b kj kk kl km kn ko kp kq nc ks kt ku nd kw kx ky ne la lb lc ld im bi translated"><strong class="ki iu"> *确保您将资源添加到同一个区域</strong></p></blockquote><h2 id="ff43" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated"><strong class="ak"> 1。添加事件中心名称空间</strong></h2><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nf"><img src="../Images/c0e93b90fe8fefe6e1db591dbcafaa67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8l_NX-vQk6CMBYKI6p5e9A.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">创建事件中心命名空间Azure页面</figcaption></figure><h2 id="0e7b" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated"><strong class="ak"> 2。在名称空间中创建事件中心:</strong></h2><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ng"><img src="../Images/b49e31636b94024dd940ee4004a9a6c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a1aVmvj2X3r3r9ZH4L9c5A.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">创建事件中心Azure页面</figcaption></figure><h2 id="cee1" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated"><strong class="ak"> 3。启用诊断记录:</strong></h2><p id="3e7c" class="pw-post-body-paragraph kg kh it ki b kj lx kl km kn ly kp kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">Azure似乎正在向这种模式发展，在这种模式下，每个资源都将公开诊断设置，因此本教程可以用于其他资源类型的Datadog集成。</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nh"><img src="../Images/a095987669a3ac2681e9567b5bab07ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rWDDDLqAmQ2vzc2QOm8PAg.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">在API管理中启用诊断</figcaption></figure><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ni"><img src="../Images/b148ea0d98e8d80d2d086eaf78aa50c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*14OdXv2xdn3pgwdVxpiB3Q.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">启用诊断设置，将“网关日志”记录到我们创建的事件中心</figcaption></figure><p id="325f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">至此，我们已经完成了一半的集成:</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/1aa35b1d9c0e67898748bf2ad44276fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1278/format:webp/1*LMmJTuLgjo21fv1BBJP4kw.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">图表:Azure API管理&gt;事件中心&gt;其他组件被禁用</figcaption></figure><h2 id="0274" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">4.创建功能应用程序:</h2><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nj"><img src="../Images/acf4ee39b9a70bc452e3c4a3fd667692.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t9uIIQNB8KE-0wjNMGV9IQ.png"/></div></div></figure><h2 id="2218" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">5.添加配置:</h2><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nk"><img src="../Images/2d797e382c396fb3717ca7bd2a1600f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-WMxP5AW9gep2ZH5Yr2kVg.png"/></div></div></figure><ul class=""><li id="8d04" class="nl nm it ki b kj kk kn ko kr nn kv no kz np ld nq nr ns nt bi translated">DD_API_KEY —数据狗的API密钥</li><li id="56c6" class="nl nm it ki b kj nu kn nv kr nw kv nx kz ny ld nq nr ns nt bi translated">DD_SITE —下面的函数使用它来决定使用哪个数据狗站点。(默认为美国)</li><li id="84f7" class="nl nm it ki b kj nu kn nv kr nw kv nx kz ny ld nq nr ns nt bi translated">下面的函数用于元数据:DD_SERVICE，DD_SOURCE，DD_TAGS，DD_SOURCE_CATEGORY</li></ul><h2 id="8a68" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">6.部署功能代码:</h2><p id="fa3d" class="pw-post-body-paragraph kg kh it ki b kj lx kl km kn ly kp kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">创建带有事件中心触发器的应用程序功能</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nz"><img src="../Images/f9134deff083aa09e1d550d08a512bdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*InDnSjuic8mU-9v6ce9oDA.png"/></div></div></figure><p id="aaec" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">确保连接指向我们之前创建的事件中心:</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oa"><img src="../Images/8e3b2636ad1fedec5abfb16b6615b679.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kpFr-YsZVJsLEmtGf_btwg.png"/></div></div></figure><p id="833b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">部署此代码:</p><figure class="mu mv mw mx gt ju"><div class="bz fp l di"><div class="ob oc l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">来源于</figcaption></figure><h2 id="63fd" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">7.单独测试功能</h2><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi od"><img src="../Images/e4f6f6e9062c921a39850bdb0c86b0a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FlEYTBcENNhBMRsEhtDGXg.png"/></div></div></figure><h2 id="198c" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">8.确认日志到达数据狗</h2><p id="36d1" class="pw-post-body-paragraph kg kh it ki b kj lx kl km kn ly kp kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">通过在API管理实例中进行API调用来测试整个流程。</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oe"><img src="../Images/c76f22daec59fe6d8ba0dc399457f454.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WnhpPu9ZyHnppZF0j5sl2A.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">数据狗日志页面</figcaption></figure><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi of"><img src="../Images/04e30481eb7258f8bb7f18ea5fa4780d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gZAV-7oSPyOkhbvpsSbX3Q.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">数据狗日志</figcaption></figure><h1 id="6431" class="mc lf it bd lg md me mf lj mg mh mi lm mj mk ml lp mm mn mo ls mp mq mr lv ms bi translated">Terraform自动化:</h1><p id="7fd6" class="pw-post-body-paragraph kg kh it ki b kj lx kl km kn ly kp kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">当然，我不会让您手动设置，以下是Terraform脚本:</p><figure class="mu mv mw mx gt ju"><div class="bz fp l di"><div class="ob oc l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">Terraform脚本，创建所有步骤并将它们链接在一起。</figcaption></figure><p id="94e2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://github.com/RaphaelYoshiga/ApiManagementLogsDatadog" rel="noopener ugc nofollow" target="_blank">在Github上</a></p><p id="1087" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这一点上，我还没有自动化Node.js函数的部署，因为这是最不复杂的部分，但是如果需要的话，这不会太难。</p><h1 id="16eb" class="mc lf it bd lg md me mf lj mg mh mi lm mj mk ml lp mm mn mo ls mp mq mr lv ms bi translated">结论</h1><p id="c363" class="pw-post-body-paragraph kg kh it ki b kj lx kl km kn ly kp kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">这不是一个简单的集成，但我希望展示了将API管理日志与Datadog集成的可能性，并且像这样复杂的手动设置可以使用Terraform自动完成。</p></div></div>    
</body>
</html>