<html>
<head>
<title>Leveraging Consul for Thanos Query Discovery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用Consul进行灭霸查询发现</h1>
<blockquote>原文：<a href="https://itnext.io/leveraging-consul-for-thanos-query-discovery-34212d496c88?source=collection_archive---------3-----------------------#2022-05-25">https://itnext.io/leveraging-consul-for-thanos-query-discovery-34212d496c88?source=collection_archive---------3-----------------------#2022-05-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="61aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于要求高可伸缩性和动态性的环境，服务发现是一个至关重要的工具，今天我将向您展示如何使用Consul来帮助我们构建一个分布式监控平台。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/3ab38e4e7f169253db3cee07395dcf90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8iB6ZsV8x-4_wV8b2ubmSg.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">利用Consul进行灭霸查询发现</figcaption></figure><h1 id="5cca" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">放弃</h1><p id="4f12" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">在这篇博文中，我假设你熟悉灭霸、领事以及我将在这里介绍的所有其他工具。</p><h1 id="ac39" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">多集群监控用例</h1><p id="47e4" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">多集群监控是企业环境中的一个日常用例，通常，您有一个控制平面，作为所有集群的集中视图，如下图所示。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi me"><img src="../Images/69aea417aa09a4ac5355e91160cbb215.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bX0J9sCdCFDvn0C-.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated"><a class="ae mf" href="https://banzaicloud.com/blog/multi-cluster-monitoring/" rel="noopener ugc nofollow" target="_blank">来自巴扎因的图像——多集束监测哨</a></figcaption></figure><p id="fa1e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我建议你看一下<a class="ae mf" href="https://banzaicloud.com/blog/multi-cluster-monitoring/" rel="noopener ugc nofollow" target="_blank">坂仔云的博客帖子</a>，以了解关于该解决方案的详细信息。</p><h1 id="4406" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">灭霸极限</h1><p id="eab0" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">正如灭霸的官方文档中所描述的，对于诸如Consul这样的商业服务发现解决方案，没有官方支持。</p><p id="e3ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是按照他们的文档，您可以自己实现它，并利用发现特定操作的API目标。</p><blockquote class="mg mh mi"><p id="72fc" class="jn jo mj jp b jq jr js jt ju jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj kk ij bi translated">目前，还没有计划添加其他服务发现机制，如Consul SD、Kubernetes SD等。但是，我们欢迎人们通过将结果写入文件SD来实现他们首选的服务发现，这些结果可以由不同的灭霸组件使用。</p><p id="3a18" class="jn jo mj jp b jq jr js jt ju jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj kk ij bi translated"><a class="ae mf" href="https://thanos.io/tip/thanos/service-discovery.md/#other" rel="noopener ugc nofollow" target="_blank">灭霸指标</a></p></blockquote><h1 id="040a" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">技术解决方案</h1><p id="539d" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">现在您已经有了关于用例及限制的所有需要的上下文，让我们构建一个解决方案，利用Consul和Consul模板来发现不同集群中的灭霸查询实例。</p><h2 id="abe6" class="mn lc iq bd ld mo mp dn lh mq mr dp ll jy ms mt lp kc mu mv lt kg mw mx lx my bi translated">营造环境</h2><p id="9c99" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">为了构建模拟上面提到的用例所需的所有东西，我将使用minikube并使用名称空间模拟多个本地集群，只是为了让示例尽可能简单。</p><p id="934e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">创建迷你库</strong></p><p id="1cc7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要启动一个新的minikube集群，可以使用下面的例子。</p><pre class="km kn ko kp gt mz na nb nc aw nd bi"><span id="04bb" class="mn lc iq na b gy ne nf l ng nh">minikube start --kubernetes-version=v1.23.0 --memory=4g</span></pre><p id="389e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">安装领事</strong></p><p id="622b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于这个例子，我将为Consul使用<a class="ae mf" href="https://github.com/hashicorp/consul-k8s/tree/main/charts/consul" rel="noopener ugc nofollow" target="_blank">官方掌舵图</a>，但是在安装Consul之前，您需要使用下面的内容创建一个值文件。</p><p id="6bf3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mj">我想强调的是，我正在启用同步目录</em> <strong class="jp ir"> <em class="mj"> </em> </strong> <em class="mj">功能，它允许我们将Kubernetes服务同步到Consul目录中。</em></p><pre class="km kn ko kp gt mz na nb nc aw nd bi"><span id="7c0a" class="mn lc iq na b gy ne nf l ng nh">global:<br/>  name: consul<br/>  datacenter: central</span><span id="e144" class="mn lc iq na b gy ni nf l ng nh">server:<br/>  replicas: 1<br/>  <br/>ui:<br/>  enabled: true<br/>  service:<br/>    type: 'NodePort'</span><span id="34a9" class="mn lc iq na b gy ni nf l ng nh">syncCatalog:<br/>  enabled: true<br/>  default: false<br/>  k8sAllowNamespaces: ['*']<br/>  k8sDenyNamespaces: ['kube-system', 'kube-public']</span></pre><p id="d2df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您可以运行以下命令:</p><pre class="km kn ko kp gt mz na nb nc aw nd bi"><span id="4241" class="mn lc iq na b gy ne nf l ng nh">helm upgrade -i consul hashicorp/consul --create-namespace -n consul -f consul-values.yaml</span></pre><p id="e459" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，如果您想访问Consul UI，您可以运行以下命令:</p><pre class="km kn ko kp gt mz na nb nc aw nd bi"><span id="284b" class="mn lc iq na b gy ne nf l ng nh">kubectl -n consul port-forward svc/consul-server 8500:8500</span></pre><p id="e3ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">为西欧“集群”安装监控堆栈</strong></p><p id="8db1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">监控堆栈由不同的组件组成。我正在使用<strong class="jp ir"> kube-prometheus-stack </strong>掌舵图来帮助我部署prometheus、Node-Exporter和KubeStateMetrics，对于灭霸查询我正在使用<a class="ae mf" href="https://github.com/bitnami/charts/tree/master/bitnami/thanos/" rel="noopener ugc nofollow" target="_blank">灭霸Bitnami掌舵图</a>。</p><p id="f0d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">创建名称空间集群</strong></p><p id="3b94" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如前所述，我使用名称空间来模拟集群。记住这一点，让我们创建一个名为<strong class="jp ir"> West Europe的名称空间。</strong></p><pre class="km kn ko kp gt mz na nb nc aw nd bi"><span id="6bf6" class="mn lc iq na b gy ne nf l ng nh">kubectl create ns westeurope</span></pre><p id="9c3c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">创建灭霸对象存储秘密</strong></p><p id="b5f9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在安装<strong class="jp ir"> kube-prometheus-stack之前，</strong>我们需要使用下面的内容创建一个将被灭霸边车使用的对象存储配置的秘密。</p><pre class="km kn ko kp gt mz na nb nc aw nd bi"><span id="a1ce" class="mn lc iq na b gy ne nf l ng nh">apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  name: thanos-secret<br/>type: Opaque<br/>stringData:<br/>  objstorage.yaml: |-<br/>    type: FILESYSTEM<br/>    config:<br/>      directory: "/etc/thanos/data"</span></pre><p id="f92d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为这是一个本地主机环境，并且想法是尽可能简单，所以我使用文件系统选项。</p><pre class="km kn ko kp gt mz na nb nc aw nd bi"><span id="8512" class="mn lc iq na b gy ne nf l ng nh">kubectl apply -f thanos-secret.yaml -n westeurope</span></pre><p id="915d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">安装kube-prometheus-stack </strong></p><p id="f380" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在灭霸秘密创建之后，我们能够使用以下内容作为值文件来安装<strong class="jp ir"> kube-prometheus-stack </strong>。</p><pre class="km kn ko kp gt mz na nb nc aw nd bi"><span id="c8f3" class="mn lc iq na b gy ne nf l ng nh">alertmanager:<br/>  enabled: false</span><span id="9b16" class="mn lc iq na b gy ni nf l ng nh">grafana:<br/>  enabled: false</span><span id="9feb" class="mn lc iq na b gy ni nf l ng nh">prometheus:<br/>  prometheusSpec:<br/>    volumes:<br/>      - name: object-storage<br/>        secret:<br/>          secretName: thanos-secret</span><span id="032e" class="mn lc iq na b gy ni nf l ng nh">thanos:<br/>  objectStorageConfigFile: /etc/conf/objstorage.yaml<br/>   volumeMounts:<br/>     - mountPath: /etc/conf/<br/>       name: object-storage</span></pre><p id="c94e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建值文件后，我们可以运行以下命令。</p><pre class="km kn ko kp gt mz na nb nc aw nd bi"><span id="dd17" class="mn lc iq na b gy ne nf l ng nh">helm upgrade -i westeurope prometheus-community/kube-prometheus-stack -n westeurope -f kube-prometheus-values.yaml</span></pre><p id="ed5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">安装灭霸查询</strong></p><p id="f37e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要进入西欧集群的最后一个组件是灭霸查询。</p><p id="4924" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">灭霸查询将允许我们从观察者群集查询西欧群集的数据。</p><p id="48d2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在安装灭霸查询之前，您必须创建一个包含以下内容的值文件。</p><pre class="km kn ko kp gt mz na nb nc aw nd bi"><span id="4f91" class="mn lc iq na b gy ne nf l ng nh">queryFrontend:<br/>  enabled: false</span><span id="9a64" class="mn lc iq na b gy ni nf l ng nh">query:<br/>  extraFlags:<br/>    - --endpoint=dnssrv+_grpc._tcp.prometheus-operated.monitoring-agent.svc</span><span id="f06f" class="mn lc iq na b gy ni nf l ng nh">  service:<br/>    annotations:<br/>      consul.hashicorp.com/service-sync: 'true'<br/>      consul.hashicorp.com/service-name: 'thanos-query'<br/>      consul.hashicorp.com/service-port: 'grpc'</span></pre><p id="80eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我想在这里强调一下我添加到灭霸查询服务的注释，这些注释将允许领事目录同步到灭霸查询服务。</p><p id="1263" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建值文件后，您可以运行下面的命令来安装灭霸查询。</p><pre class="km kn ko kp gt mz na nb nc aw nd bi"><span id="8b93" class="mn lc iq na b gy ne nf l ng nh">helm upgrade -i thanos-agent bitnami/thanos -n westeurope -f thanos-agent-values.yaml</span></pre><p id="ef64" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">西欧监控栈概述</strong></p><p id="8f6b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装完我上面描述的所有组件后，西欧“集群”上的监控堆栈应该如下所示。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nj"><img src="../Images/a54654caaee487cab7369c8689b28cbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZkZ-497IUjEPhlqrbLF3RQ.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">监控堆栈西欧集群</figcaption></figure><p id="5084" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">为北欧“集群”安装监控堆栈</strong></p><p id="8f46" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">北欧集群将使用我在西欧使用的相同配置。所以你只需要把所有的东西安装在一个不同的名为<em class="mj"> northeurope </em>的名称空间中。</p><p id="3b5a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">检查咨询界面</strong></p><p id="a129" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此时，您可能已经启动了两个“集群”,并运行了所有必需的监控组件。现在，如果您使用我共享给port-forward的命令访问Consul UI，您将能够在服务菜单中看到带有两个实例的灭霸查询服务。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nk"><img src="../Images/f69a7467ac1c54f1f908266fe1b9b1dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eHwWZUzYaxlZKdsvmdypuw.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">领事UI</figcaption></figure><h2 id="5c03" class="mn lc iq bd ld mo mp dn lh mq mr dp ll jy ms mt lp kc mu mv lt kg mw mx lx my bi translated">构建观察者“集群”</h2><p id="a629" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">在这篇博文中，观察者集群将只包含灭霸查询，以保持对重要内容的关注。</p><p id="8dbf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">领事模板</strong></p><p id="63c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Consul Template是一个项目，它提供了一种便捷的方式将来自<a class="ae mf" href="https://www.consul.io/" rel="noopener ugc nofollow" target="_blank"> Consul </a>的值填充到文件系统中，其思想是使用Consul模板功能来编写灭霸将寻找的服务发现文件。</p><p id="4154" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">创建领事模板文件</strong></p><p id="9b60" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Consul Template使用Go template引擎的子集来呈现值，记住这一点，我们可以创建一个包含模板逻辑的配置映射。</p><pre class="km kn ko kp gt mz na nb nc aw nd bi"><span id="ca9a" class="mn lc iq na b gy ne nf l ng nh">kind: ConfigMap<br/>apiVersion: v1<br/>metadata:<br/>  name: consul-template-config-map<br/>data:<br/>  thanos-sd-file.tpl: |<br/>    - targets:<br/>      {{ range service "thanos-query" -}}<br/>      - {{ .Address }}:{{ .Port }}<br/>      {{ end -}}</span></pre><p id="932d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个模板迭代了Consul上的灭霸查询服务，并构建了灭霸查询可以用来发现新目标的结构。</p><p id="7699" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">创建领事模板HCL配置</strong></p><p id="b691" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您熟悉HashiCorp产品，您已经知道我们将在下面使用的HCL配置标准。</p><pre class="km kn ko kp gt mz na nb nc aw nd bi"><span id="e5c1" class="mn lc iq na b gy ne nf l ng nh">kind: ConfigMap<br/>apiVersion: v1<br/>metadata:<br/>  name: consul-template-hcl-config-map<br/>data:<br/>  config.hcl: |<br/>    consul {<br/>      address = "consul-server.consul.svc.cluster.local:8500"<br/>    }</span><span id="f9cf" class="mn lc iq na b gy ni nf l ng nh">    log_level = "info"</span><span id="a2d1" class="mn lc iq na b gy ni nf l ng nh">    template {<br/>      source = "/consul-template/templates/thanos-sd-file.tpl"<br/>      destination = "/etc/thanos/sd/thanos-sd-file.yaml"<br/>    }</span></pre><p id="ce72" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我正在配置Consul模板，以使用我在上面创建的TPL文件，并将其呈现在灭霸目录中。</p><h2 id="82c6" class="mn lc iq bd ld mo mp dn lh mq mr dp ll jy ms mt lp kc mu mv lt kg mw mx lx my bi translated"><strong class="ak">灭霸查询</strong></h2><p id="8c71" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">现在我们已经有了使用Consul模板的所有基础，让我们开始构建灭霸查询舵图将使用的值文件。</p><p id="b6b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">安装领事模板卷</strong></p><p id="dc53" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们开始添加Consul模板SideCar容器之前，我们需要在灭霸查询上将Consul模板配置挂载为卷。</p><pre class="km kn ko kp gt mz na nb nc aw nd bi"><span id="00a5" class="mn lc iq na b gy ne nf l ng nh">extraVolumes:<br/>  - name: consul-template-hcl-config<br/>    configMap:<br/>      name: consul-template-hcl-config-map<br/>  - name: consul-template-config<br/>    configMap:<br/>      name: consul-template-config-map<br/>  - name: thanos-sd-dir<br/>    emptyDir: {}<br/>  <br/>extraVolumeMounts:<br/>  - name: thanos-sd-dir<br/>    mountPath: /etc/thanos/sd</span></pre><p id="bd17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">添加领事模板边车</strong></p><p id="987b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在卷配置之后，让我们添加Consul模板SideCar容器。</p><pre class="km kn ko kp gt mz na nb nc aw nd bi"><span id="1fc3" class="mn lc iq na b gy ne nf l ng nh">sidecars:<br/>  - name: consul-template<br/>    image: hashicorp/consul-template<br/>    imagePullPolicy: IfNotPresent<br/>    args: <br/>      - consul-template<br/>      - -config <br/>      - /consul-template/config.d/config.hcl<br/>    volumeMounts:<br/>      - name: consul-template-hcl-config<br/>        mountPath: /consul-template/config.d<br/>      - name: consul-template-config<br/>        mountPath: /consul-template/templates<br/>      - name: thanos-sd-dir<br/>        mountPath: /etc/thanos/sd</span></pre><p id="49ba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">灭霸查询SD配置文件路径</strong></p><p id="1fc9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后但同样重要的是，我们必须提供一个额外的标志，通知灭霸查询使用服务发现文件。</p><pre class="km kn ko kp gt mz na nb nc aw nd bi"><span id="2e21" class="mn lc iq na b gy ne nf l ng nh">extraFlags:<br/>  - --store.sd-files=/etc/thanos/sd/thanos-sd-file.yaml</span></pre><p id="e3c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">灭霸查询终值文件</strong></p><p id="83b1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">按照我上面描述的所有步骤，您的灭霸查询值文件应该看起来像下面的例子。</p><pre class="km kn ko kp gt mz na nb nc aw nd bi"><span id="b24c" class="mn lc iq na b gy ne nf l ng nh">queryFrontend:<br/>  enabled: false</span><span id="cc50" class="mn lc iq na b gy ni nf l ng nh">query:<br/>  extraFlags:<br/>    - --store.sd-files=/etc/thanos/sd/thanos-sd-file.yaml</span><span id="967d" class="mn lc iq na b gy ni nf l ng nh">sidecars:<br/>  - name: consul-template<br/>    image: hashicorp/consul-template<br/>    imagePullPolicy: IfNotPresent<br/>    args: <br/>      - consul-template<br/>      - -config <br/>      - /consul-template/config.d/config.hcl<br/>    volumeMounts:<br/>      - name: consul-template-hcl-config<br/>        mountPath: /consul-template/config.d<br/>      - name: consul-template-config<br/>        mountPath: /consul-template/templates<br/>      - name: thanos-sd-dir<br/>        mountPath: /etc/thanos/sd</span><span id="4ab8" class="mn lc iq na b gy ni nf l ng nh">extraVolumes:<br/>  - name: consul-template-hcl-config<br/>    configMap:<br/>      name: consul-template-hcl-config-map<br/>  - name: consul-template-config<br/>    configMap:<br/>      name: consul-template-config-map<br/>  - name: thanos-sd-dir<br/>    emptyDir: {}<br/>  <br/>  extraVolumeMounts:<br/>    - name: thanos-sd-dir<br/>      mountPath: /etc/thanos/sd</span></pre><p id="79c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们只需要通过运行下面的命令，将灭霸查询安装到观察者集群中。</p><pre class="km kn ko kp gt mz na nb nc aw nd bi"><span id="8335" class="mn lc iq na b gy ne nf l ng nh">helm upgrade -i thanos bitnami/thanos -n observer -f thanos.yaml</span></pre><p id="58ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">瞧，神奇的事情开始发生了，如果我们访问灭霸查询用户界面并查看商店菜单，我们将能够看到来自其他集群的灭霸查询实例。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi no"><img src="../Images/5384ae4318eb4a3b605ff02be78e2513.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SgTMTc51_twe_pMJ3_5z7w.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">观察者灭霸查询-商店列表</figcaption></figure><h2 id="e215" class="mn lc iq bd ld mo mp dn lh mq mr dp ll jy ms mt lp kc mu mv lt kg mw mx lx my bi translated">解决方案概述</h2><p id="0bfd" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">让我们快速了解一下解决方案概述，以确保所有内容都清晰明了，可以开始了。</p><p id="8cea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们利用Consul模板来观察在不同集群中运行的Consul上所有可用的灭霸查询服务，然后将这些实例的地址和端口写入<a class="ae mf" href="https://thanos.io/tip/thanos/service-discovery.md/#file-service-discovery" rel="noopener ugc nofollow" target="_blank">灭霸文件服务发现格式</a>。</p><p id="b279" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这意味着，每当一个新的集群诞生并且该集群的灭霸查询将其自身注册到Consul目录中时，它将被观察者集群中的灭霸查询自动发现。</p><h2 id="8cb7" class="mn lc iq bd ld mo mp dn lh mq mr dp ll jy ms mt lp kc mu mv lt kg mw mx lx my bi translated">结论</h2><p id="4276" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">嗯！</p><p id="71cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望您喜欢这些内容，并且它可以帮助您轻松实现和扩展您的分布式监控解决方案。</p><p id="a431" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您需要更多信息或解决对此解决方案的任何疑问或分享您的反馈，请随时联系我。</p></div></div>    
</body>
</html>