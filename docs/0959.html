<html>
<head>
<title>GraphQL &amp; Jest: snapshot testing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GraphQL &amp; Jest:快照测试</h1>
<blockquote>原文：<a href="https://itnext.io/graphql-jest-snapshot-testing-7f7345ee2be?source=collection_archive---------3-----------------------#2018-06-24">https://itnext.io/graphql-jest-snapshot-testing-7f7345ee2be?source=collection_archive---------3-----------------------#2018-06-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/fc1921124f0ca6930b39a3bab59da6d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1jmi5wkZG7qE4x4zmfNElA.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">GraphQL &amp; Jest</figcaption></figure><p id="9869" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">测试在日常开发流程中非常重要。每当你构建一个新的特性或者重构一个现有的特性时，你都希望确保你没有破坏其他的东西。你怎么能确定？您可以要求您的QA提交回归，但是如果您的团队中有10个以上的开发人员呢？对，QA很可能很快就会退出。更糟糕的是，如果你的团队没有QA，开发人员只会不断破坏彼此的代码。为了防止这种情况，您可以用测试来覆盖您的代码。稍后，当你改变一些东西或者增加一些东西时，你需要做的就是运行测试来确保你的应用程序没有被破坏。</p></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><p id="b6d5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">什么问题？</strong></p><p id="7e3a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在我目前的团队中，有5名后端开发人员，他们都并行工作。在开发应用的过程中，我们遇到了一些问题:</p><ul class=""><li id="1b9d" class="lh li iq ke b kf kg kj kk kn lj kr lk kv ll kz lm ln lo lp bi translated">当有人改变一个模式时，我们的前端就会崩溃。</li><li id="bad2" class="lh li iq ke b kf lq kj lr kn ls kr lt kv lu kz lm ln lo lp bi translated">当有人更换旋变器时，我们的前端就会崩溃。</li></ul><p id="9e32" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为了解决这些问题，我决定尽可能多地用测试来覆盖这些边角案例，这就是我最终的结果。</p><p id="e0c5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">当模式改变时，我希望确保这四种情况都得到测试:</p><ul class=""><li id="d9c3" class="lh li iq ke b kf kg kj kk kn lj kr lk kv ll kz lm ln lo lp bi translated">删除字段时。</li><li id="c2d6" class="lh li iq ke b kf lq kj lr kn ls kr lt kv lu kz lm ln lo lp bi translated">当字段被重命名时。</li><li id="467d" class="lh li iq ke b kf lq kj lr kn ls kr lt kv lu kz lm ln lo lp bi translated">添加字段时。</li><li id="5b2b" class="lh li iq ke b kf lq kj lr kn ls kr lt kv lu kz lm ln lo lp bi translated">当解析器函数改变时，我希望确保我没有改变的数据与我之前得到的数据相同。</li></ul><p id="2fda" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">它非常类似于快照测试。我不检查特定的字段或长度或结构。我只检查我现在得到的和我以前得到的。唯一不同的是，我自己写快照。可以将这项工作委托给graphql服务器，但在我的情况下，手动完成也可以。</p><p id="368a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">它给了我什么？至少我能看到有人的改变打破了别的东西。我在两个环境中运行这种测试:本地环境和CI环境。当我在本地运行它时，我会看到我的更改是什么，以及它们破坏了什么或没有破坏什么。当CI运行它时，我们的团队会在一个松弛通道中得到错误(如果有的话)。</p></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><p id="d35c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">计划是什么？</strong></p><p id="6838" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">它是如何工作的非常简单:我向graphql服务器发送一个查询，因为它应该工作，但只有一个不同——我模仿了resolvers函数。我指定我想为一个查询获取什么数据。基本上，它是我手动创建的数据快照。如果有人更改了模式中的某些内容，graphql服务器将返回一个与mock中所写内容不同的响应。</p><p id="463f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">让我们写一些代码。它将会是javascript，但是你可以把同样的想法应用到任何你喜欢的语言上。</p><p id="df11" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我决定不在本地运行任何服务器，我使用一个express中间件，所以对我来说，它只是一个在响应对象a.k.a单元测试中获取模式、请求、响应和设置JSON对象的函数。对于相同的查询输入，我们总是期望相同的输出。</p><figure class="lv lw lx ly gt jr"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="c088" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">当我运行这个测试时，我得到了这样的响应:</p><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div class="gh gi mb"><img src="../Images/21fbd7a863d1b764b0481d9e40a719fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:796/format:webp/1*s4KBk5Td213BlnCFA0pXWA.png"/></div></figure><p id="6e8e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">它说我的测试已经正确地通过了。</p><p id="aa02" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在，假设我想更改我的模式，并将countries <code class="fe mc md me mf b">name</code>字段重命名为<code class="fe mc md me mf b">label</code>。让我们看看输出会是什么。</p><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/e2918a904b784dabe40908d798d41206.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xxzOQK6y7C6BxqVfAkDrdw.png"/></div></div></figure><p id="73e7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">厉害！我的测试失败了，错误是国家类型中不存在字段名。让我们更改测试查询中的字段名称，并添加一个标签而不是名称</p><pre class="lv lw lx ly gt mh mf mi mj aw mk bi"><span id="4bcb" class="ml mm iq mf b gy mn mo l mp mq">{ query: '{ viewer { countries { label } } }' } </span></pre><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mr"><img src="../Images/d02f7a491abd2b43b86dcd2edf7e0479.png" data-original-src="https://miro.medium.com/v2/resize:fit:1278/format:webp/1*5uao8BhqkGrET1gAWxqhCw.png"/></div></div></figure><p id="97bd" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">仍然没有通过。没错，我改变了模式，但是我的测试的快照和模拟仍然保持不变。现在我需要更新我的模拟并再次运行它。</p><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/37ab24dc2f01525d27cbe9973e1e05db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lhInRZfjqvS62Bkb4m3ZdA.png"/></div></div></figure><p id="acae" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">所以，这样更好。现在我可以看到我的更改破坏了什么，如果我同意，我需要做的就是运行<code class="fe mc md me mf b">npm run test -- -u</code>来更新我的测试快照。</p><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/9a054fbbc9637f278b6f33b71d42d121.png" data-original-src="https://miro.medium.com/v2/resize:fit:870/format:webp/1*jSL2fO4mOxYx8-PpBm2UFw.png"/></div></figure></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><p id="54b4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">结论。</strong></p><p id="759d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">基本就这些了。我还添加了一个额外的检查来确保响应的结构等于模拟的结构，但是我认为只使用jest.snapshot就足够了。这是我测试graphql的方法。它并不理想，还有很多需要改进的地方，但是到目前为止，这个解决方案帮助我的团队保持了代码的稳定性。</p><p id="59d9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">喜欢故事？鼓掌和分享。谢谢！</p></div></div>    
</body>
</html>