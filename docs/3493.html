<html>
<head>
<title>EKS RBAC: How to use IAM roles for Service accounts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">EKS·RBAC:如何为服务帐户使用IAM角色</h1>
<blockquote>原文：<a href="https://itnext.io/k8s-rbac-how-to-use-iam-roles-for-service-accounts-b77f91505f79?source=collection_archive---------4-----------------------#2019-12-26">https://itnext.io/k8s-rbac-how-to-use-iam-roles-for-service-accounts-b77f91505f79?source=collection_archive---------4-----------------------#2019-12-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d5037e0bf9b65d94682194147a312523.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EW-5IJ3TJX1q8GnRNI_P-Q.jpeg"/></div></div></figure><h1 id="a61f" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">介绍</h1><p id="69a6" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在本文中，我将解释如何为EKS集群中的服务帐户使用IAM角色，以便为pods提供细粒度的权限并安全地访问AWS API。让我们来详细看看如何实现这一点。</p></div><div class="ab cl lu lv hu lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ij ik il im in"><h1 id="2434" class="jy jz iq bd ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv bi translated">为服务帐户启用IAM角色</h1><ul class=""><li id="8382" class="mg mh iq ky b kz la ld le lh mi ll mj lp mk lt ml mm mn mo bi translated">从EKS群集中复制OpenID连接提供程序URL。</li></ul><figure class="mq mr ms mt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mp"><img src="../Images/5dbca5287b5d9226f7ad9e539b028daf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wU2nDYV12sTaDeHIfTNiOg.png"/></div></div></figure><p id="3b95" class="pw-post-body-paragraph kw kx iq ky b kz mu lb lc ld mv lf lg lh mw lj lk ll mx ln lo lp my lr ls lt ij bi translated">如果您喜欢使用AWS CLI，可以运行以下AWS CLI命令。用您的群集名称替换CLUSTER_NAME。</p><pre class="mq mr ms mt gt mz na nb nc aw nd bi"><span id="cd9a" class="ne jz iq na b gy nf ng l nh ni">aws eks describe-cluster --name CLUSTER_NAME --query "cluster.identity.oidc.issuer" --output text</span></pre><ul class=""><li id="ed01" class="mg mh iq ky b kz mu ld mv lh nj ll nk lp nl lt ml mm mn mo bi translated">创建IAM OIDC身份提供者。<br/> 1。导航至IAM控制台<br/> 2。选择<strong class="ky ir">身份提供者</strong>，然后选择<strong class="ky ir">创建提供者<br/> </strong> 3。为提供者类型<br/> 4选择<strong class="ky ir"> OpenID </strong> Connect。粘贴上述<br/> 5中复制的<strong class="ky ir">提供者URL </strong>。底下的观众类型sts.amazonaws.com<br/>6。验证并创建提供者</li></ul><figure class="mq mr ms mt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/c3a8529b3bd478b5b0d9b6709eef7d0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X35GyNYPVPEjyKH26YDeuA.png"/></div></div></figure><p id="2f97" class="pw-post-body-paragraph kw kx iq ky b kz mu lb lc ld mv lf lg lh mw lj lk ll mx ln lo lp my lr ls lt ij bi translated"><strong class="ky ir">注意:</strong> IAM服务帐户角色功能适用于使用1.14创建或在2019年9月3日或之后升级到1.13或1.14的EKS集群。如果您的EKS集群不满足这一要求，那么就应该更新版本以利用这一特性。</p><h1 id="aec5" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">为服务帐户创建IAM角色</h1><p id="2f1f" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">现在，我们的集群已经准备好将IAM用于服务帐户。让我们创建一个IAM角色，以便我们可以将此IAM角色分配给pod。</p><p id="d3ec" class="pw-post-body-paragraph kw kx iq ky b kz mu lb lc ld mv lf lg lh mw lj lk ll mx ln lo lp my lr ls lt ij bi translated">根据您的要求，使用以下信任策略和IAM策略创建一个只能从特定命名空间承担的IAM角色。遵循信任策略允许给定命名空间中的任何服务帐户。如果您希望限制到某个特定的服务帐户，请用一个服务帐户名称替换*以仅允许该服务帐户承担此角色。</p><pre class="mq mr ms mt gt mz na nb nc aw nd bi"><span id="3cb1" class="ne jz iq na b gy nf ng l nh ni">{</span><span id="550c" class="ne jz iq na b gy nn ng l nh ni">"Version": "2012-10-17",</span><span id="1cd6" class="ne jz iq na b gy nn ng l nh ni">"Statement": [</span><span id="0d14" class="ne jz iq na b gy nn ng l nh ni">{</span><span id="aefc" class="ne jz iq na b gy nn ng l nh ni">"Effect": "Allow",</span><span id="f72c" class="ne jz iq na b gy nn ng l nh ni">"Principal": {</span><span id="3b45" class="ne jz iq na b gy nn ng l nh ni">"Federated": "arn:aws:iam::1111111111:oidc-provider/oidc.eks.ap-southeast-1.amazonaws.com/id/XXXXXXX"</span><span id="de12" class="ne jz iq na b gy nn ng l nh ni">},</span><span id="3791" class="ne jz iq na b gy nn ng l nh ni">"Action": "sts:AssumeRoleWithWebIdentity",</span><span id="0b5f" class="ne jz iq na b gy nn ng l nh ni">"Condition": {</span><span id="70e3" class="ne jz iq na b gy nn ng l nh ni">"StringLike": {</span><span id="4402" class="ne jz iq na b gy nn ng l nh ni">"oidc.eks.ap-southeast-1.amazonaws.com/id/XXXXXXX:sub": "system:serviceaccount:<!-- -->NAMESPACE<!-- -->:*"</span><span id="6fe9" class="ne jz iq na b gy nn ng l nh ni">}<br/>}<br/>}<br/>]<br/>}</span></pre><p id="e77a" class="pw-post-body-paragraph kw kx iq ky b kz mu lb lc ld mv lf lg lh mw lj lk ll mx ln lo lp my lr ls lt ij bi translated">替换:<br/> <code class="fe no np nq na b">1111111111</code> — AWS帐户ID<br/><code class="fe no np nq na b">XXXXXXX </code>—OpenID连接提供者URL的URI路径，<br/> <code class="fe no np nq na b">NAMESPACE</code> —运行pod的名称空间名称。</p><p id="a295" class="pw-post-body-paragraph kw kx iq ky b kz mu lb lc ld mv lf lg lh mw lj lk ll mx ln lo lp my lr ls lt ij bi translated">或者，您可以使用以下AWS CLI脚本来创建角色。</p><figure class="mq mr ms mt gt jr"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="4680" class="pw-post-body-paragraph kw kx iq ky b kz mu lb lc ld mv lf lg lh mw lj lk ll mx ln lo lp my lr ls lt ij bi translated">让我们创建一个名称空间(演示)并部署一个pod，然后验证它是否能够承担这个角色。</p><h2 id="7b9f" class="ne jz iq bd ka nt nu dn ke nv nw dp ki lh nx ny km ll nz oa kq lp ob oc ku od bi translated">创建名称空间</h2><figure class="mq mr ms mt gt jr"><div class="bz fp l di"><div class="nr ns l"/></div><figcaption class="oe of gj gh gi og oh bd b be z dk translated">namespace.yaml</figcaption></figure><pre class="mq mr ms mt gt mz na nb nc aw nd bi"><span id="909b" class="ne jz iq na b gy nf ng l nh ni">kubectl apply -f namespace.yaml</span></pre><h2 id="8db0" class="ne jz iq bd ka nt nu dn ke nv nw dp ki lh nx ny km ll nz oa kq lp ob oc ku od bi translated">创建服务帐户</h2><figure class="mq mr ms mt gt jr"><div class="bz fp l di"><div class="nr ns l"/></div><figcaption class="oe of gj gh gi og oh bd b be z dk translated">serviceaccount.yaml</figcaption></figure><pre class="mq mr ms mt gt mz na nb nc aw nd bi"><span id="ccd5" class="ne jz iq na b gy nf ng l nh ni">kubectl apply -f serviceaccount.yaml</span></pre><h2 id="ed25" class="ne jz iq bd ka nt nu dn ke nv nw dp ki lh nx ny km ll nz oa kq lp ob oc ku od bi translated">创建部署</h2><p id="9eae" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在pod规范中定义服务帐户并部署。</p><figure class="mq mr ms mt gt jr"><div class="bz fp l di"><div class="nr ns l"/></div><figcaption class="oe of gj gh gi og oh bd b be z dk translated">部署. yaml</figcaption></figure><pre class="mq mr ms mt gt mz na nb nc aw nd bi"><span id="fd6a" class="ne jz iq na b gy nf ng l nh ni">kubectl apply -f deployment.yaml</span></pre><h2 id="2ea5" class="ne jz iq bd ka nt nu dn ke nv nw dp ki lh nx ny km ll nz oa kq lp ob oc ku od bi translated">验证:</h2><p id="ee32" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">Exec进入容器并运行AWS CLI命令进行验证。</p><pre class="mq mr ms mt gt mz na nb nc aw nd bi"><span id="3238" class="ne jz iq na b gy nf ng l nh ni">kubectl get pods -n demo</span></pre><p id="4725" class="pw-post-body-paragraph kw kx iq ky b kz mu lb lc ld mv lf lg lh mw lj lk ll mx ln lo lp my lr ls lt ij bi translated">将任何pod名称和exec复制到其中(替换pod Name)。</p><pre class="mq mr ms mt gt mz na nb nc aw nd bi"><span id="999c" class="ne jz iq na b gy nf ng l nh ni">kubectl -n demo exec -it &lt;podname&gt; — bash</span></pre><p id="137f" class="pw-post-body-paragraph kw kx iq ky b kz mu lb lc ld mv lf lg lh mw lj lk ll mx ln lo lp my lr ls lt ij bi translated">我在pod定义中使用了默认的<code class="fe no np nq na b">httpd</code>映像，默认情况下没有安装AWS CLI。安装<a class="ae oi" href="https://docs.aws.amazon.com/cli/latest/userguide/install-linux.html" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a>并验证。</p><h1 id="6f41" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">其他资源:</h1><p id="48fe" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">[1] <a class="ae oi" href="https://aws.amazon.com/about-aws/whats-new/2019/09/amazon-eks-adds-support-to-assign-iam-permissions-to-kubernetes-service-accounts/" rel="noopener ugc nofollow" target="_blank">发行说明</a></p><p id="2a50" class="pw-post-body-paragraph kw kx iq ky b kz mu lb lc ld mv lf lg lh mw lj lk ll mx ln lo lp my lr ls lt ij bi translated">[2] <a class="ae oi" href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html" rel="noopener ugc nofollow" target="_blank"> EKS文献</a></p><p id="bcb6" class="pw-post-body-paragraph kw kx iq ky b kz mu lb lc ld mv lf lg lh mw lj lk ll mx ln lo lp my lr ls lt ij bi translated">[3] <a class="ae oi" href="https://aws.amazon.com/blogs/opensource/introducing-fine-grained-iam-roles-service-accounts/" rel="noopener ugc nofollow" target="_blank">官方博文</a></p></div></div>    
</body>
</html>