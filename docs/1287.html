<html>
<head>
<title>You shouldn’t use truthy tests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你不应该使用真实性测试</h1>
<blockquote>原文：<a href="https://itnext.io/you-shouldnt-use-truthy-tests-753b39ef8893?source=collection_archive---------1-----------------------#2018-08-29">https://itnext.io/you-shouldnt-use-truthy-tests-753b39ef8893?source=collection_archive---------1-----------------------#2018-08-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b133" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我讨厌truthy测试，我认为你不应该使用它们，每当它们出现在Pull请求中时，我都反对。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/defbb5ebec94f678f9990ee6777f1fe8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N1nyJG0ZznVZqGrkp6Tuuw.jpeg"/></div></div></figure><p id="a8ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为什么？因为以我的经验来看，更多的bug来自于错误的真值测试，而不是其他类型的错误。而且来自不可靠测试的错误也是最难追踪的。</p><p id="c561" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你不知道我说的真值测试是什么意思，那就是这个(用Python，但是我们一会儿会看一些其他语言):</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="ca49" class="lc ld iq ky b gy le lf l lg lh">if some_variable:<br/>    do_something()</span></pre><p id="60c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将询问<code class="fe li lj lk ky b">some_variable</code> <em class="ll">是否在执行某些条件动作之前对</em>到<code class="fe li lj lk ky b">true</code>求值。</p><p id="095f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正是这个词<em class="ll">评估了</em>，真实性测试的所有问题都出现了。看，有些情况真的是<code class="fe li lj lk ky b">true</code>或<code class="fe li lj lk ky b">false</code>，就像这样:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="c5a8" class="lc ld iq ky b gy le lf l lg lh">my_var = True<br/>if my_var: do_something()</span></pre><p id="23f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe li lj lk ky b">my_var</code>实际上是<code class="fe li lj lk ky b">true</code>，因为我们只是将其设置为<code class="fe li lj lk ky b">True</code>。</p><p id="a69b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这些呢:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="1f79" class="lc ld iq ky b gy le lf l lg lh">my_var = 0<br/>my_var = 74<br/>my_var = 0.0<br/>my_var = ""<br/>my_var = "false"<br/>my_var = []<br/>my_var = {}</span></pre><p id="f116" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那些<em class="ll">中的一部分评估</em>到<code class="fe li lj lk ky b">true</code>，另一部分<em class="ll">评估</em>到<code class="fe li lj lk ky b">false</code>。<a class="ae lm" href="https://docs.python.org/2.4/lib/truth.html" rel="noopener ugc nofollow" target="_blank">这里有一页</a>告诉你哪些Python值等同于<code class="fe li lj lk ky b">false</code>。</p><p id="feda" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">错误出现是因为这些东西<em class="ll">实际上并不相同</em>，试图将它们视为相同必然会导致意想不到的行为。</p><p id="1252" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里有一个简单的JavaScript例子。向函数传递参数时，通常会将它们默认为如下形式:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="57f8" class="lc ld iq ky b gy le lf l lg lh">function whatever(params) {<br/>    var myparam = params.myparam || 1;<br/>}</span></pre><p id="e939" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这会将<code class="fe li lj lk ky b">myparam</code>设置为你传入的值，如果你没有传入什么，那么它会被设置为<code class="fe li lj lk ky b">1</code>。</p><p id="fc12" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">挑战</strong>:将<code class="fe li lj lk ky b">myparam</code>设置为<code class="fe li lj lk ky b">0</code>。</p><p id="6025" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">解决方法</strong>:不能。</p><p id="ebb0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">JavaScript中的truthy测试，当然是把<code class="fe li lj lk ky b">0</code>当成<code class="fe li lj lk ky b">false</code>，所以初始测试失败，把<code class="fe li lj lk ky b">myparam</code>设为<code class="fe li lj lk ky b">1</code>。该模式实际上是为了检查<code class="fe li lj lk ky b">params.myparam</code>是否为<code class="fe li lj lk ky b">undefined</code>(即未指定)，其也评估为<code class="fe li lj lk ky b">false</code>，但它也捕捉评估为<code class="fe li lj lk ky b">false</code>的所有其他<em class="ll">实际值</em>。</p><p id="ca83" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正确的做法应该是:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="98f6" class="lc ld iq ky b gy le lf l lg lh">function whatever(params) {<br/>    var myparam = params.hasOwnProperty("myparam") ? <br/>                      params.myparam : 1;<br/>}</span></pre><p id="5e2a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">也就是:<em class="ll">如果我们真的意味着参数应该是未定义的，那么我们应该</em> <strong class="jp ir"> <em class="ll">这么说</em> </strong>。</p><p id="4448" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">尽管如此，在JavaScript代码中到处都可以看到懒惰、容易出错的方法。</p><p id="da6d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我听到开发人员为使用真值测试辩护的一些理由:</p><ul class=""><li id="d3fc" class="ln lo iq jp b jq jr ju jv jy lp kc lq kg lr kk ls lt lu lv bi translated">它们写起来更快</li><li id="795e" class="ln lo iq jp b jq lw ju lx jy ly kc lz kg ma kk ls lt lu lv bi translated">因为<a class="ae lm" href="https://www.python.org/dev/peps/pep-0008" rel="noopener ugc nofollow" target="_blank"> PEP8 </a>这么说</li><li id="3109" class="ln lo iq jp b jq lw ju lx jy ly kc lz kg ma kk ls lt lu lv bi translated">当你不确定你在处理什么样的变量时，它们是很好的选择(例如，在鸭式语言中)</li></ul><p id="9114" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我尽快解决这些问题:</p><p id="d69e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">他们写起来更快。那又怎样？现在允许了吗？我为你写了这个软件——它坏了，但这比写一些有用的东西要快。</p><p id="54aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">因为PEP8这么说</strong>。并没有。在<a class="ae lm" href="https://www.python.org/dev/peps/pep-0008/#programming-recommendations" rel="noopener ugc nofollow" target="_blank">编程建议</a>中说，你不应该使用<code class="fe li lj lk ky b">==</code>操作符来比较带有<code class="fe li lj lk ky b">True</code>或<code class="fe li lj lk ky b">False</code>的布尔值。也就是说，您可以使用truthy风格测试，其中操作数是<em class="ll">实际上是一个布尔值</em>。</p><p id="f26b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当你不确定你在处理什么样的变量时，它们很有用。的确，在鸭式语言中，有时你不确定变量实际上是什么，而真值测试可以是避免找出答案的一种便捷方式。我的回答是，如果你不知道你在处理什么样的变量，对它的价值进行价差押注会有什么帮助？如果你的传播范围不够广怎么办？如果给你变量的函数用<code class="fe li lj lk ky b">-1</code>来表示“我不知道答案”，而不是用<code class="fe li lj lk ky b">0</code>或<code class="fe li lj lk ky b">None</code>或其他什么，那会怎样？在这种情况下，你的真实性测试救不了你。找出变量是什么，适当对待它。</p><p id="76b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于我们这些跨多种语言工作的人来说，一个复杂的因素是真实性的规则不是共享的。因此，很容易犯错误并测试在一种语言中可以工作但在另一种语言中不能工作的东西。我们已经链接到falsy值的<a class="ae lm" href="https://docs.python.org/2.4/lib/truth.html" rel="noopener ugc nofollow" target="_blank"> Python </a>列表，这里是<a class="ae lm" href="http://ruby-doc.org/core-2.1.1/FalseClass.html" rel="noopener ugc nofollow" target="_blank"> Ruby </a>，这里是<a class="ae lm" href="https://developer.mozilla.org/en-US/docs/Glossary/Falsy" rel="noopener ugc nofollow" target="_blank"> JavaScript </a>，这里是<a class="ae lm" href="http://php.net/manual/en/language.types.boolean.php" rel="noopener ugc nofollow" target="_blank"> PHP </a>，这里是<a class="ae lm" href="https://perldoc.perl.org/perlsyn.html#Truth-and-Falsehood" rel="noopener ugc nofollow" target="_blank"> Perl </a>。</p><p id="9db7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你会看到一些共性，但也有一些关键的区别。例如，Ruby相对来说比较理智，它只在实际的<code class="fe li lj lk ky b">false</code>和<code class="fe li lj lk ky b">nil</code>上计算<code class="fe li lj lk ky b">false</code>，而大多数其他语言都包含了空字符串和<code class="fe li lj lk ky b">0</code>这样的东西。这里有一些非常讨厌的错误，它们肯定会给你的代码逻辑带来问题:</p><ul class=""><li id="c4d3" class="ln lo iq jp b jq jr ju jv jy lp kc lq kg lr kk ls lt lu lv bi translated">JavaScript说<code class="fe li lj lk ky b">document.all</code>是<code class="fe li lj lk ky b">false</code>——这是有原因的，它们与语言的历史使用有关，而不是任何原因。</li><li id="14d7" class="ln lo iq jp b jq lw ju lx jy ly kc lz kg ma kk ls lt lu lv bi translated">Perl和PHP说字符串<code class="fe li lj lk ky b">"0"</code>是<code class="fe li lj lk ky b">false</code>——如果这不是等待发生的灾难，我不知道什么是。</li><li id="fed9" class="ln lo iq jp b jq lw ju lx jy ly kc lz kg ma kk ls lt lu lv bi translated">在Python中，用户定义的对象可以自己决定它是真还是假。</li><li id="d02e" class="ln lo iq jp b jq lw ju lx jy ly kc lz kg ma kk ls lt lu lv bi translated">关于空列表/字典是真的还是假的，有相当大的差异。</li></ul><p id="6d27" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你使用的语言注重真实性，那么你可以做一些事情来让人们的生活变得更容易，如果你给他们提供代码来集成的话。例如，您的函数不应该返回空字符串，当您指的是<code class="fe li lj lk ky b">false</code>时，它应该返回<code class="fe li lj lk ky b">false</code>。或者，当函数无法获得合适的返回类型时，可以使用异常。</p><p id="4182" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">反过来，代码的消费者也应该尊重你的函数。如果他们问你要一份清单，他们应该认为空清单是一个有效的回答，并在继续之前检查清单的长度。</p><p id="6cd9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以让我回来总结一下。当你不能确定你正在处理的是一个纯布尔值时，你不应该使用真值测试，理由如下:</p><ul class=""><li id="58c2" class="ln lo iq jp b jq jr ju jv jy lp kc lq kg lr kk ls lt lu lv bi translated">没有借口不知道你在处理什么样的变量。如果那是因为给你变量的函数是模糊的，那么那个函数很烂，应该被修正。如果你不能修复函数，艰难，你仍然需要弄清楚它。</li><li id="c7bc" class="ln lo iq jp b jq lw ju lx jy ly kc lz kg ma kk ls lt lu lv bi translated">空字符串、<code class="fe li lj lk ky b">"0"</code>、<code class="fe li lj lk ky b">0</code>、<code class="fe li lj lk ky b">false</code>、空列表、<code class="fe li lj lk ky b">document.all</code>等等都是不一样的，把它们一视同仁不是好主意。</li><li id="404a" class="ln lo iq jp b jq lw ju lx jy ly kc lz kg ma kk ls lt lu lv bi translated">这是一个如此重要的错误来源，从长远来看，不这样做可以节省你的时间。</li></ul><p id="d98c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或许最重要的是:</p><blockquote class="mb mc md"><p id="f496" class="jn jo ll jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated"><strong class="jp ir">明确你要测试的是优秀的、自我记录的、干净的代码，未来的开发者会感谢你的。</strong></p></blockquote><p id="9e64" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以说真的。不要使用它们。</p><p id="efd4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ll"> Richard是软件开发咨询公司</em><a class="ae lm" href="https://cottagelabs.com" rel="noopener ugc nofollow" target="_blank"><em class="ll">Cottage Labs</em></a><em class="ll">的创始人和高级合伙人，专门研究数据生命周期的各个方面。他偶尔会在推特上发</em><a class="ae lm" href="https://twitter.com/richard_d_jones" rel="noopener ugc nofollow" target="_blank"><em class="ll">@ Richard _ d _ Jones</em></a></p></div></div>    
</body>
</html>