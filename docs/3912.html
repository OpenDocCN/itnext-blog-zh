<html>
<head>
<title>Adding Cloudwatch Alarms to EC2s via Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Terraform向EC2s添加Cloudwatch警报</h1>
<blockquote>原文：<a href="https://itnext.io/adding-cloudwatch-alarms-to-ec2s-via-terraform-d19c006ad95a?source=collection_archive---------3-----------------------#2020-03-24">https://itnext.io/adding-cloudwatch-alarms-to-ec2s-via-terraform-d19c006ad95a?source=collection_archive---------3-----------------------#2020-03-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3e756d337a5f4be0cf27cf1718561929.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pqg0E-tcSOrcCxwCPan98g.png"/></div></div></figure><p id="fdf7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我想将Cloudwatch状态检查警报添加到我的ec2实例中，并使用terraform来实现这一点。以下是方法。</p><p id="f188" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">基本上。下面的tf示例在与我的terraform工作空间相关联的VPC中查找任何正在运行的ec2实例。它<a class="ae kw" href="https://www.terraform.io/docs/configuration/functions/zipmap.html" rel="noopener ugc nofollow" target="_blank">将InstanceIDs与<a class="ae kw" href="https://www.terraform.io/docs/providers/aws/d/instances.html" rel="noopener ugc nofollow" target="_blank">公共或私有IP</a>进行zipmaps </a>(下面的例子使用“private_ip”，但也可以很容易地替换为“public_ip”)。我还将警报动作设置为触发lambda的SNS，但这不是这篇文章的内容。</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="f1be" class="lg lh iq lc b gy li lj l lk ll">locals {<br/>  vpc_env = local.vpc_env_lookup[terraform.workspace]</span><span id="2aae" class="lg lh iq lc b gy lm lj l lk ll">vpc_env_lookup = {<br/>    Production = [<br/>      "vpc-xxxxxxxxxxxxxxxx1",<br/>      "vpc-xxxxxxxxxxxxxxxx2"<br/>    ]<br/>    Staging = [<br/>      "vpc-xxxxxxxxxxxxxxxx1"<br/>    ]<br/>    Acceptance = [<br/>      "vpc-xxxxxxxxxxxxxxxx1"<br/>    ]<br/>  }</span><span id="4d78" class="lg lh iq lc b gy lm lj l lk ll">actions = local.actions_lookup[terraform.workspace]</span><span id="babc" class="lg lh iq lc b gy lm lj l lk ll">actions_lookup = {<br/>    Prod  = [aws_sns_topic.ProductionCloudWatchLambda.arn]<br/>    Stage = [aws_sns_topic.StagingCloudWatchLambda.arn]<br/>    Test  = [aws_sns_topic.AcceptanceCloudWatchLambda.arn]<br/>  }</span><span id="a23a" class="lg lh iq lc b gy lm lj l lk ll"># Associate IDs with IPs (Key is InstanceID, Value is Private_IP)<br/>  all_ec2s = zipmap(data.aws_instances.all_ec2.ids, data.aws_instances.all_ec2.private_ips)<br/>}</span><span id="b1be" class="lg lh iq lc b gy lm lj l lk ll">data "aws_instances" "all_ec2" {<br/>  instance_state_names = ["running"]</span><span id="80cf" class="lg lh iq lc b gy lm lj l lk ll">filter {<br/>    name   = "vpc-id"<br/>    values = local.vpc_env<br/>  }<br/>}</span><span id="e9e4" class="lg lh iq lc b gy lm lj l lk ll">resource "aws_cloudwatch_metric_alarm" "instance_statuscheck" {<br/>  for_each = local.all_ec2s</span><span id="6eec" class="lg lh iq lc b gy lm lj l lk ll">  alarm_name          = join(local.delim, compact([local.envname_prefix, "StatusCheck: ${each.value}"]))<br/>    comparison_operator = "GreaterThanOrEqualToThreshold"<br/>    evaluation_periods  = "2"<br/>    metric_name         = "StatusCheckFailed"<br/>    namespace           = "AWS/EC2"<br/>    period              = "300"<br/>    statistic           = "Maximum"<br/>    threshold           = "1.0"<br/>    alarm_description   = "EC2 Status Check"<br/>    alarm_actions       = local.actions<br/>    ok_actions          = local.actions<br/>    dimensions          = { InstanceId = each.key }<br/>}</span></pre><p id="f747" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在上面的例子中，警报名称使用了本地envname前缀，这是我在terraform repo中的其他地方建立的。最终结果是一个类似这样的警报名称:<strong class="ka ir"> Staging-StatusCheck: IP。OF.MY.EC2 </strong></p><p id="ae6a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">希望这对您有所帮助！</p></div></div>    
</body>
</html>