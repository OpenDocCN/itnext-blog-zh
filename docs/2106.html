<html>
<head>
<title>Telegram bot in Go: concurrent SQLite</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Go中的电报机器人:并发SQLite</h1>
<blockquote>原文：<a href="https://itnext.io/telegram-bot-in-go-concurrent-sqlite-e6176fac088e?source=collection_archive---------5-----------------------#2019-04-01">https://itnext.io/telegram-bot-in-go-concurrent-sqlite-e6176fac088e?source=collection_archive---------5-----------------------#2019-04-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/28f85def32accb315107a48fcb55bce7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nY_a-4oN4fbGA9Pu"/></div></div></figure><p id="5b9d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://medium.com/@detunized/telegram-bot-in-go-database-f8714381c858" rel="noopener">上次</a>我将SQLite添加到我的机器人中，同时将请求处理转移到一个goroutine中。这意味着我在我的代码库中引入了并发数据库访问。</p><p id="2c45" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通常一个人应该想，然后做。虽然不理想，但当使用<code class="fe kx ky kz la b">git</code>时，也可以反过来做。但重要的是不要忘记在某些时候思考。就像我差一点就做了，差一点就在我刚刚介绍的基础上堆上更多的bug。</p><p id="46d3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我记得前几天读过或看过一些关于SQLite的东西，他们明确表示我必须确保不要同时从多个地方访问数据库。Go是为并发而生的，所以我确信我使用的go-sqlite3 已经控制住了它。事实证明，并不尽然。</p><p id="cede" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">来自<a class="ae kw" href="https://github.com/mattn/go-sqlite3#faq" rel="noopener ugc nofollow" target="_blank">常见问题解答</a>:</p><blockquote class="lb lc ld"><p id="9e22" class="jy jz le ka b kb kc kd ke kf kg kh ki lf kk kl km lg ko kp kq lh ks kt ku kv ij bi translated">我可以在多个例程中同时使用它吗？</p><p id="947a" class="jy jz le ka b kb kc kd ke kf kg kh ki lf kk kl km lg ko kp kq lh ks kt ku kv ij bi translated">是只读的。但是，不可写。参见<a class="ae kw" href="https://github.com/mattn/go-sqlite3/issues/50" rel="noopener ugc nofollow" target="_blank"> #50 </a>、<a class="ae kw" href="https://github.com/mattn/go-sqlite3/issues/51" rel="noopener ugc nofollow" target="_blank"> #51 </a>、<a class="ae kw" href="https://github.com/mattn/go-sqlite3/issues/209" rel="noopener ugc nofollow" target="_blank"> #209 </a>、<a class="ae kw" href="https://github.com/mattn/go-sqlite3/issues/274" rel="noopener ugc nofollow" target="_blank"> #274 </a>。</p></blockquote><p id="8501" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就这样，我掉进了一个大兔子洞。我搜索和研究，googled和binged(不，不是真的)，阅读了<code class="fe kx ky kz la b">go-sqlite3</code>的源代码和SQLite的文档(顺便说一下，这些都很好)。所有这些只是为了发现自己处于一种不知道是否可以信任<code class="fe kx ky kz la b">go-sqlite3</code>包来处理我的数据库工作的境地。尽管FAQ声明不支持写并发，但我发现了矛盾的说法。人们说如果我使用多个连接就没问题。但是我不会每次都打开一个新的连接。</p><p id="603d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">长话短说，我发现了一个<a class="ae kw" href="https://crawshaw.io/blog/go-and-sqlite" rel="noopener ugc nofollow" target="_blank">博客帖子</a>解决了完全相同的问题，并以<a class="ae kw" href="https://github.com/crawshaw/sqlite" rel="noopener ugc nofollow" target="_blank"> Go包</a>的形式提供了一个解决方案。</p><pre class="li lj lk ll gt lm la ln lo aw lp bi"><span id="1aaa" class="lq lr iq la b gy ls lt l lu lv">go get -u crawshaw.io/sqlite</span></pre><p id="494e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">根据这篇文章和这个包的作者David所说，我应该能够相信这个包能够可靠地处理并发性。现在，我不是简单地建立一个到数据库的连接，而是创建一个我想要的大小的显式池(在本例中是16个):</p><pre class="li lj lk ll gt lm la ln lo aw lp bi"><span id="e532" class="lq lr iq la b gy ls lt l lu lv">import "crawshaw.io/sqlite/sqlitex"<br/><br/>func openDB() *sqlitex.Pool {<br/>    db, err := sqlitex.Open("./since.db", 0, 16)<br/>    if err != nil {<br/>        log.Panic(err)<br/>    }<br/><br/>    return db<br/>}</span></pre><p id="20f3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，每次我想访问数据库时，我都必须从池中获得一个连接，并且不要忘记在完成后将它放回原处。在连接可用之前，从池中获取连接可能会被阻塞。</p><pre class="li lj lk ll gt lm la ln lo aw lp bi"><span id="b02a" class="lq lr iq la b gy ls lt l lu lv">func execSQL(db *sqlitex.Pool, sql string) {<br/>    connection := db.Get(nil)<br/>    defer db.Put(connection)<br/><br/>    err := sqlitex.Exec(connection, sql, nil)<br/>    if err != nil {<br/>        log.Panic(err)<br/>    }<br/>}</span></pre><p id="6c3f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">关于错误处理的补充说明。我目前不会故意处理错误，以免减慢自己的速度。但我也不忽视他们。像任何自尊的软件工程师一样，当我收到一个错误时，我会惊慌失措。对于某些错误，比如启动时无法打开数据库，惊慌失措是完全正常的。但是，如果其中一个消息有错误，恐慌就不是一个好的选择。这就像在我们应该返回HTTP/404的时候关闭服务器一样。</p><p id="f9ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，将传入的消息存储在数据库中变成了这样:</p><pre class="li lj lk ll gt lm la ln lo aw lp bi"><span id="4971" class="lq lr iq la b gy ls lt l lu lv">func store(message *tgbotapi.Message, db *sqlitex.Pool) {<br/>    connection := db.Get(nil)<br/>    defer db.Put(connection)<br/><br/>    err := sqlitex.Exec(<br/>        connection,<br/>        "INSERT INTO events (user, name, date) VALUES (?, ?, ?);",<br/>        nil,<br/>        message.From.ID,<br/>        message.Text,<br/>        message.Date)<br/><br/>    if err != nil {<br/>        log.Panic(err)<br/>    }<br/>}</span></pre><p id="b507" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我不喜欢的一点是，如果我想使用<code class="fe kx ky kz la b">sqlitex.Exec</code>，我会被迫使用位置SQL参数。如果我想使用像<code class="fe kx ky kz la b">"... VALUES ($user, $name, $date)"</code>这样的列名，我就必须使用更加冗长的API。我自己准备陈述，然后逐步完成。像这样:</p><pre class="li lj lk ll gt lm la ln lo aw lp bi"><span id="697b" class="lq lr iq la b gy ls lt l lu lv">func store(message *tgbotapi.Message, db *sqlitex.Pool) {<br/>    connection := db.Get(nil)<br/>    defer db.Put(connection)<br/><br/>    insert := connection.Prep("INSERT INTO events (user, name, date) VALUES ($user, $name, $date);")<br/>    insert.SetInt64("$user", int64(message.From.ID))<br/>    insert.SetText("$name", message.Text)<br/>    insert.SetInt64("$date", int64(message.Date))<br/><br/>    _, err := insert.Step()<br/>    if err != nil {<br/>        log.Panic(err)<br/>    }<br/><br/>    // Done with this query<br/>    // TODO: Is it really needed? What happens when this isn't called?<br/>    err = insert.Reset()<br/>    if err != nil {<br/>        log.Panic(err)<br/>    }<br/>}</span></pre><p id="d9ea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果我看到位置论点成为一个问题，我会切换到这种做事方式。</p><p id="615d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">虽然这次我很想让我的机器人不那么笨，但我只是在尝试防弹我的SQLite访问方法的同时设法切换了库。只是重构，没有特色。这是软件工程师典型的一天。好吧，那就第二天。</p><p id="efaf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你好奇，可以在GitHub 上找到代码<a class="ae kw" href="https://github.com/detunized/since-bot/tree/day-3" rel="noopener ugc nofollow" target="_blank">。这个版本被标记为<code class="fe kx ky kz la b">day-3</code>。</a></p></div><div class="ab cl lw lx hu ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="ij ik il im in"><p id="78f9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="le">原发布于</em><a class="ae kw" href="https://detunized.net/posts/2019-04-01-telegram-bot-in-go-concurrent-sqlite/" rel="noopener ugc nofollow" target="_blank"><em class="le">detunized.net</em></a><em class="le">2019年4月1日</em></p></div></div>    
</body>
</html>