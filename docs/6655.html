<html>
<head>
<title>Deploying an Istio Gateway with TLS in EKS using the AWS Load Balancer Controller</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS负载平衡器控制器在EKS部署带TLS的Istio网关</h1>
<blockquote>原文：<a href="https://itnext.io/deploying-an-istio-gateway-with-tls-in-eks-using-the-aws-load-balancer-controller-448812e081e5?source=collection_archive---------0-----------------------#2022-01-19">https://itnext.io/deploying-an-istio-gateway-with-tls-in-eks-using-the-aws-load-balancer-controller-448812e081e5?source=collection_archive---------0-----------------------#2022-01-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/3a7f59eed2bfae3b9beda8f663861b8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*CcSkrMnz5G1ExiynxayCsQ.jpeg"/></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk translated">图片来自Pixabay用户publicdomainpictures-14</figcaption></figure><p id="eb90" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我使用Linkerd作为服务网格已经有一段时间了。一个新的需求是进行服务到服务的授权，这是可能的，但是对于Linkerd来说很麻烦。Istio提供更容易的<a class="ae kz" href="https://www.openpolicyagent.org/docs/latest/envoy-tutorial-istio/" rel="noopener ugc nofollow" target="_blank">集成</a>与<a class="ae kz" href="https://www.openpolicyagent.org/" rel="noopener ugc nofollow" target="_blank">开放策略代理</a>和其他<a class="ae kz" href="https://istio.io/latest/blog/2021/better-external-authz/" rel="noopener ugc nofollow" target="_blank">外部授权系统</a>。但是这个帖子不是关于授权的。我想展示如何在运行Kubernetes 1.21(也在1.20上测试)的EKS集群中使用TLS和http-to-https重定向来配置安全的Istio网关。</p><h2 id="46cd" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">用istioctl安装Istio</h2><p id="1482" class="pw-post-body-paragraph kb kc it kd b ke lt kg kh ki lu kk kl km lv ko kp kq lw ks kt ku lx kw kx ky im bi translated">我按照推荐的安装方法在Mac上安装了<code class="fe ly lz ma mb b">istioctl</code>:</p><pre class="mc md me mf gt mg mb mh mi aw mj bi"><span id="5d44" class="la lb it mb b gy mk ml l mm mn">$ curl -sL https://istio.io/downloadIstioctl | sh -</span></pre><p id="d313" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后我<a class="ae kz" href="https://istio.io/latest/docs/setup/getting-started/" rel="noopener ugc nofollow" target="_blank">使用默认配置文件安装了Istio </a>:</p><pre class="mc md me mf gt mg mb mh mi aw mj bi"><span id="d697" class="la lb it mb b gy mk ml l mm mn">$ istioctl install</span></pre><p id="80f6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在撰写本文时，最新的Istio版本是<code class="fe ly lz ma mb b">1.12.1</code>。</p><p id="ca52" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我确保<code class="fe ly lz ma mb b">istiod</code>和<code class="fe ly lz ma mb b">istio-ingressgateway</code>pod在<code class="fe ly lz ma mb b">istio-system</code>命名空间中运行:</p><pre class="mc md me mf gt mg mb mh mi aw mj bi"><span id="cd6a" class="la lb it mb b gy mk ml l mm mn">$ kubectl get pods -n istio-system</span><span id="a160" class="la lb it mb b gy mo ml l mm mn">NAME                                  READY   STATUS    RESTARTS   AGE</span><span id="93dc" class="la lb it mb b gy mo ml l mm mn">istio-ingressgateway-8c48d875-h2cj9   1/1     Running   0          25h</span><span id="f72d" class="la lb it mb b gy mo ml l mm mn">istiod-58d79b7bff-gjbll               1/1     Running   0          27h</span></pre><p id="ccdb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我用标签<code class="fe ly lz ma mb b">istio-inject=enabled</code>标记了<code class="fe ly lz ma mb b">default</code>名称空间，这样<code class="fe ly lz ma mb b">istio-proxy</code>容器将作为sidecar自动注入到部署在该名称空间中的每个pod中:</p><pre class="mc md me mf gt mg mb mh mi aw mj bi"><span id="c1ad" class="la lb it mb b gy mk ml l mm mn">$ kubectl label namespace default istio-inject=enabled</span></pre><p id="b547" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">默认情况下，<code class="fe ly lz ma mb b">istio-ingressgateway</code>服务的类型是<code class="fe ly lz ma mb b">LoadBalancer</code>。在这种情况下，由于我正在运行EKS，AWS将为它创建一个网络负载平衡器。我试图让TLS与NLB合作，但没有成功。经过大量的搜索，似乎更好的方法是将<code class="fe ly lz ma mb b">istio-ingressgateway</code>部署为<code class="fe ly lz ma mb b">NodePort</code>服务，然后在它前面创建一个由ALB表示的<code class="fe ly lz ma mb b">Ingress</code>(作为先决条件，这个解决方案需要安装AWS负载平衡器控制器)。所以…以下是实现这一目标的步骤。</p><h2 id="3463" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">安装AWS负载平衡器控制器</h2><p id="8454" class="pw-post-body-paragraph kb kc it kd b ke lt kg kh ki lu kk kl km lv ko kp kq lw ks kt ku lx kw kx ky im bi translated">我跟踪了官方AWS文档。在下面的命令中，我的EKS集群名称是<code class="fe ly lz ma mb b">us-east-1</code>区域中的<code class="fe ly lz ma mb b">my-cluster</code>。</p><pre class="mc md me mf gt mg mb mh mi aw mj bi"><span id="8d63" class="la lb it mb b gy mk ml l mm mn">$ curl -o iam_policy.json <a class="ae kz" href="https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.3.1/docs/install/iam_policy.json" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.3.1/docs/install/iam_policy.json</a></span><span id="eef4" class="la lb it mb b gy mo ml l mm mn">$ aws iam create-policy \</span><span id="e0d8" class="la lb it mb b gy mo ml l mm mn">  --policy-name AWSLoadBalancerControllerIAMPolicy \</span><span id="e497" class="la lb it mb b gy mo ml l mm mn">  --policy-document file://iam_policy.json</span><span id="8ead" class="la lb it mb b gy mo ml l mm mn">$ eksctl utils associate-iam-oidc-provider --region=us-east-1 — cluster=my-cluster --approve</span><span id="f3b0" class="la lb it mb b gy mo ml l mm mn">$ eksctl create iamserviceaccount \</span><span id="2fc0" class="la lb it mb b gy mo ml l mm mn">  --cluster=my-cluster \</span><span id="c4a4" class="la lb it mb b gy mo ml l mm mn">  --region=us-east-1 \</span><span id="2300" class="la lb it mb b gy mo ml l mm mn">  --namespace=kube-system \</span><span id="ff80" class="la lb it mb b gy mo ml l mm mn">  --name=aws-load-balancer-controller \</span><span id="da0e" class="la lb it mb b gy mo ml l mm mn">  --attach-policy-arn=arn:aws:iam::MYAWSACCOUNTID:policy/AWSLoadBalancerControllerIAMPolicy \</span><span id="0d7e" class="la lb it mb b gy mo ml l mm mn">  --override-existing-serviceaccounts \</span><span id="79cf" class="la lb it mb b gy mo ml l mm mn">  --approve</span><span id="5b5a" class="la lb it mb b gy mo ml l mm mn">$ curl -o iam_policy_v1_to_v2_additional.json <a class="ae kz" href="https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.3.1/docs/install/iam_policy_v1_to_v2_additional.json" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.3.1/docs/install/iam_policy_v1_to_v2_additional.json</a></span><span id="22dc" class="la lb it mb b gy mo ml l mm mn">$ aws iam create-policy \</span><span id="399b" class="la lb it mb b gy mo ml l mm mn">  --policy-name AWSLoadBalancerControllerAdditionalIAMPolicy \</span><span id="bdd6" class="la lb it mb b gy mo ml l mm mn">  --policy-document file://iam_policy_v1_to_v2_additional.json</span><span id="bd0b" class="la lb it mb b gy mo ml l mm mn">$ aws iam attach-role-policy \</span><span id="efab" class="la lb it mb b gy mo ml l mm mn">  --role-name eksctl-addon-iamserviceaccount-kub-Role1–1WA99F4J8QYNU \</span><span id="e1d4" class="la lb it mb b gy mo ml l mm mn">  --policy-arn arn:aws:iam::MYAWSACCOUNTID:policy/AWSLoadBalancerControllerAdditionalIAMPolicy</span><span id="82d2" class="la lb it mb b gy mo ml l mm mn">$ wget <a class="ae kz" href="https://github.com/jetstack/cert-manager/releases/download/v1.5.4/cert-manager.yaml" rel="noopener ugc nofollow" target="_blank">https://github.com/jetstack/cert-manager/releases/download/v1.5.4/cert-manager.yaml</a></span><span id="2d30" class="la lb it mb b gy mo ml l mm mn">$ kubectl apply \</span><span id="40b3" class="la lb it mb b gy mo ml l mm mn">  --validate=false \</span><span id="1172" class="la lb it mb b gy mo ml l mm mn">  -f cert-manager.yaml</span><span id="5140" class="la lb it mb b gy mo ml l mm mn">$ curl -Lo v2_3_1_full.yaml <a class="ae kz" href="https://github.com/kubernetes-sigs/aws-load-balancer-controller/releases/download/v2.3.1/v2_3_1_full.yaml" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes-sigs/aws-load-balancer-controller/releases/download/v2.3.1/v2_3_1_full.yaml</a></span><span id="1cca" class="la lb it mb b gy mo ml l mm mn">* Make the following edits to the v2_3_1_full.yaml file:</span><span id="04e7" class="la lb it mb b gy mo ml l mm mn">  * Delete the ServiceAccount section of the file. Deleting this section prevents the annotation with the IAM role from being overwritten when the controller is deployed and preserves the service account that you created in step 3 if you delete the controller.</span><span id="4f94" class="la lb it mb b gy mo ml l mm mn">  * Replace your-cluster-name in the Deployment spec section of the file with the name of your cluster.</span><span id="cb82" class="la lb it mb b gy mo ml l mm mn">$ kubectl apply -f v2_3_1_full.yaml</span></pre><p id="6a64" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">此时，我验证了<code class="fe ly lz ma mb b">aws-load-balancer-controller</code>部署是健康的，并且相应的pod正在运行:</p><pre class="mc md me mf gt mg mb mh mi aw mj bi"><span id="2378" class="la lb it mb b gy mk ml l mm mn">$ kubectl get deployment -n kube-system aws-load-balancer-controller</span><span id="1d68" class="la lb it mb b gy mo ml l mm mn">$ kubectl get pods -n kube-system</span></pre><h2 id="ba44" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">为istio-Ingres gateway配置服务和入口</h2><p id="9f5a" class="pw-post-body-paragraph kb kc it kd b ke lt kg kh ki lu kk kl km lv ko kp kq lw ks kt ku lx kw kx ky im bi translated">我删除了由<code class="fe ly lz ma mb b">istioctl</code>安装的<code class="fe ly lz ma mb b">LoadBalancer</code>类型的<code class="fe ly lz ma mb b">istio-ingressgateway</code>服务，并将其重新创建为<code class="fe ly lz ma mb b">NodePort</code>类型。下面是我为它使用的清单(然后我通过<code class="fe ly lz ma mb b">kubectl apply -f manifest-filename.yaml</code>应用了它):</p><pre class="mc md me mf gt mg mb mh mi aw mj bi"><span id="6591" class="la lb it mb b gy mk ml l mm mn">apiVersion: v1</span><span id="cd96" class="la lb it mb b gy mo ml l mm mn">kind: Service</span><span id="332b" class="la lb it mb b gy mo ml l mm mn">  metadata:</span><span id="bea5" class="la lb it mb b gy mo ml l mm mn">    labels:</span><span id="68c4" class="la lb it mb b gy mo ml l mm mn">      app: istio-ingressgateway</span><span id="7558" class="la lb it mb b gy mo ml l mm mn">      install.operator.istio.io/owning-resource: unknown</span><span id="a7fb" class="la lb it mb b gy mo ml l mm mn">      install.operator.istio.io/owning-resource-namespace: istio-system</span><span id="1513" class="la lb it mb b gy mo ml l mm mn">      istio: ingressgateway</span><span id="ad92" class="la lb it mb b gy mo ml l mm mn">      istio.io/rev: default</span><span id="9147" class="la lb it mb b gy mo ml l mm mn">      operator.istio.io/component: IngressGateways</span><span id="97b7" class="la lb it mb b gy mo ml l mm mn">      operator.istio.io/managed: Reconcile</span><span id="7b23" class="la lb it mb b gy mo ml l mm mn">      operator.istio.io/version: 1.12.1</span><span id="4f64" class="la lb it mb b gy mo ml l mm mn">      release: istio</span><span id="7bf0" class="la lb it mb b gy mo ml l mm mn">    name: istio-ingressgateway</span><span id="6c75" class="la lb it mb b gy mo ml l mm mn">    namespace: istio-system</span><span id="12f7" class="la lb it mb b gy mo ml l mm mn">spec:</span><span id="d239" class="la lb it mb b gy mo ml l mm mn">  externalTrafficPolicy: Cluster</span><span id="914f" class="la lb it mb b gy mo ml l mm mn">  ipFamilies:</span><span id="f69a" class="la lb it mb b gy mo ml l mm mn">  - IPv4</span><span id="fe5e" class="la lb it mb b gy mo ml l mm mn">  ipFamilyPolicy: SingleStack</span><span id="c367" class="la lb it mb b gy mo ml l mm mn">  ports:</span><span id="33d0" class="la lb it mb b gy mo ml l mm mn">  - name: status-port</span><span id="1edc" class="la lb it mb b gy mo ml l mm mn">    nodePort: 30276</span><span id="cd86" class="la lb it mb b gy mo ml l mm mn">    port: 15021</span><span id="52f6" class="la lb it mb b gy mo ml l mm mn">    protocol: TCP</span><span id="1ba5" class="la lb it mb b gy mo ml l mm mn">    targetPort: 15021</span><span id="c101" class="la lb it mb b gy mo ml l mm mn">  - name: http2</span><span id="5685" class="la lb it mb b gy mo ml l mm mn">    nodePort: 32361</span><span id="1735" class="la lb it mb b gy mo ml l mm mn">    port: 80</span><span id="2c4a" class="la lb it mb b gy mo ml l mm mn">    protocol: TCP</span><span id="9ed0" class="la lb it mb b gy mo ml l mm mn">    targetPort: 8080</span><span id="583b" class="la lb it mb b gy mo ml l mm mn">  - name: https</span><span id="9f6d" class="la lb it mb b gy mo ml l mm mn">    nodePort: 30626</span><span id="60c9" class="la lb it mb b gy mo ml l mm mn">    port: 443</span><span id="5b9e" class="la lb it mb b gy mo ml l mm mn">    protocol: TCP</span><span id="3880" class="la lb it mb b gy mo ml l mm mn">    targetPort: 8443</span><span id="38c8" class="la lb it mb b gy mo ml l mm mn">  selector:</span><span id="14bc" class="la lb it mb b gy mo ml l mm mn">    app: istio-ingressgateway</span><span id="1390" class="la lb it mb b gy mo ml l mm mn">    istio: ingressgateway</span><span id="e9dd" class="la lb it mb b gy mo ml l mm mn">  sessionAffinity: None</span><span id="3ca7" class="la lb it mb b gy mo ml l mm mn">  type: NodePort</span></pre><p id="7dfd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">整个练习中最难的部分是为入口对象提供合适的咒语，这将导致在<code class="fe ly lz ma mb b">istio-ingressgateway</code>服务前面创建一个ALB。我发现<a class="ae kz" href="https://aws.amazon.com/blogs/containers/secure-end-to-end-traffic-on-amazon-eks-using-tls-certificate-in-acm-alb-and-istio/" rel="noopener ugc nofollow" target="_blank">这篇文章</a>非常有帮助，还有这篇<a class="ae kz" href="https://stackoverflow.com/questions/62407364/how-to-set-aws-alb-instead-of-elb-in-istio" rel="noopener ugc nofollow" target="_blank"> StackOverflow讨论</a>。</p><p id="13cb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这是我最后拿到的入口清单。我将这个文件命名为istio- <code class="fe ly lz ma mb b">ingressgateway-alb-ingress.yaml</code>:</p><pre class="mc md me mf gt mg mb mh mi aw mj bi"><span id="6477" class="la lb it mb b gy mk ml l mm mn">apiVersion: networking.k8s.io/v1</span><span id="4ed5" class="la lb it mb b gy mo ml l mm mn">kind: Ingress</span><span id="40ee" class="la lb it mb b gy mo ml l mm mn">metadata:</span><span id="83b3" class="la lb it mb b gy mo ml l mm mn">  name: istio-ingressgateway-alb</span><span id="2274" class="la lb it mb b gy mo ml l mm mn">  namespace: istio-system</span><span id="008a" class="la lb it mb b gy mo ml l mm mn">  annotations:</span><span id="28af" class="la lb it mb b gy mo ml l mm mn">    kubernetes.io/ingress.class: alb</span><span id="ce0f" class="la lb it mb b gy mo ml l mm mn">    alb.ingress.kubernetes.io/scheme: internet-facing</span><span id="1346" class="la lb it mb b gy mo ml l mm mn">    alb.ingress.kubernetes.io/target-type: instance</span><span id="00f1" class="la lb it mb b gy mo ml l mm mn">    alb.ingress.kubernetes.io/certificate-arn: ARN_FOR_ACM_CERT</span><span id="36a4" class="la lb it mb b gy mo ml l mm mn">    alb.ingress.kubernetes.io/backend-protocol: HTTPS</span><span id="2dd0" class="la lb it mb b gy mo ml l mm mn">    alb.ingress.kubernetes.io/healthcheck-path: /healthz/ready</span><span id="719e" class="la lb it mb b gy mo ml l mm mn">    alb.ingress.kubernetes.io/healthcheck-port: traffic-port</span><span id="1ebe" class="la lb it mb b gy mo ml l mm mn">    alb.ingress.kubernetes.io/healthcheck-protocol: HTTP</span><span id="e1b9" class="la lb it mb b gy mo ml l mm mn">    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS":443}]'</span><span id="56e0" class="la lb it mb b gy mo ml l mm mn">    alb.ingress.kubernetes.io/actions.ssl-redirect: |</span><span id="bade" class="la lb it mb b gy mo ml l mm mn">      {</span><span id="c5a7" class="la lb it mb b gy mo ml l mm mn">        "Type": "redirect",</span><span id="9fc7" class="la lb it mb b gy mo ml l mm mn">        "RedirectConfig": {</span><span id="5c40" class="la lb it mb b gy mo ml l mm mn">        "Protocol": "HTTPS",</span><span id="b416" class="la lb it mb b gy mo ml l mm mn">        "Port": "443",</span><span id="6d57" class="la lb it mb b gy mo ml l mm mn">        "StatusCode": "HTTP_301"</span><span id="1f56" class="la lb it mb b gy mo ml l mm mn">        }</span><span id="8697" class="la lb it mb b gy mo ml l mm mn">      }</span><span id="74c5" class="la lb it mb b gy mo ml l mm mn">spec:</span><span id="2303" class="la lb it mb b gy mo ml l mm mn">  rules:</span><span id="603e" class="la lb it mb b gy mo ml l mm mn">    - http:</span><span id="805e" class="la lb it mb b gy mo ml l mm mn">      paths:</span><span id="42f3" class="la lb it mb b gy mo ml l mm mn">      - backend:</span><span id="effd" class="la lb it mb b gy mo ml l mm mn">        service:</span><span id="3ef7" class="la lb it mb b gy mo ml l mm mn">          name: ssl-redirect</span><span id="05d4" class="la lb it mb b gy mo ml l mm mn">          port:</span><span id="aab0" class="la lb it mb b gy mo ml l mm mn">            name: use-annotation</span><span id="432d" class="la lb it mb b gy mo ml l mm mn">        path: /</span><span id="29c7" class="la lb it mb b gy mo ml l mm mn">        pathType: Prefix</span><span id="0fb5" class="la lb it mb b gy mo ml l mm mn">      - backend:</span><span id="b010" class="la lb it mb b gy mo ml l mm mn">        service:</span><span id="8427" class="la lb it mb b gy mo ml l mm mn">          name: istio-ingressgateway</span><span id="9841" class="la lb it mb b gy mo ml l mm mn">          port:</span><span id="4747" class="la lb it mb b gy mo ml l mm mn">            number: 15021</span><span id="b474" class="la lb it mb b gy mo ml l mm mn">        path: /healthz/ready</span><span id="44f1" class="la lb it mb b gy mo ml l mm mn">        pathType: Prefix</span><span id="8209" class="la lb it mb b gy mo ml l mm mn">      - backend:</span><span id="1d06" class="la lb it mb b gy mo ml l mm mn">        service:</span><span id="1e1e" class="la lb it mb b gy mo ml l mm mn">          name: istio-ingressgateway</span><span id="641b" class="la lb it mb b gy mo ml l mm mn">          port:</span><span id="6060" class="la lb it mb b gy mo ml l mm mn">            number: 443</span><span id="0e08" class="la lb it mb b gy mo ml l mm mn">        path: /</span><span id="82a2" class="la lb it mb b gy mo ml l mm mn">        pathType: Prefix</span></pre><p id="3761" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">几个注意事项:</p><ul class=""><li id="0a2e" class="mp mq it kd b ke kf ki kj km mr kq ms ku mt ky mu mv mw mx bi translated">我已经使用AWS证书管理器为<code class="fe ly lz ma mb b">mydomain.com</code>和<code class="fe ly lz ma mb b">*.mydomain.com</code>创建了一个SSL证书(我使用了DNS验证，这很简单，因为<code class="fe ly lz ma mb b">mydomain.com</code>在Route53中管理)</li><li id="f317" class="mp mq it kd b ke my ki mz km na kq nb ku nc ky mu mv mw mx bi translated">我指定ALB为<code class="fe ly lz ma mb b">internet-facing</code>。在这种情况下，为了使AWS负载均衡器控制器能够正确地将公共子网与ALB相关联，这些子网需要分别用名为<code class="fe ly lz ma mb b">kubernetes.io/role/elb</code>和值为<code class="fe ly lz ma mb b">1</code>的标签进行标记。相反，如果我想创建一个内部ALB，那么注释<code class="fe ly lz ma mb b">alb.ingress.kubernetes.io/scheme</code>将会是<code class="fe ly lz ma mb b">internal</code>并且私有子网将会被标记上一个名为<code class="fe ly lz ma mb b">kubernetes.io/role/internal-elb</code>和值为<code class="fe ly lz ma mb b">1</code>的标签。</li></ul><p id="5d9f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后我通过以下方式创建了上面的入口:</p><pre class="mc md me mf gt mg mb mh mi aw mj bi"><span id="e2ca" class="la lb it mb b gy mk ml l mm mn">$ kubectl apply -f istio-ingressgateway-alb-ingress.yaml</span></pre><p id="a3e0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我验证了入口对象是正确创建的:</p><pre class="mc md me mf gt mg mb mh mi aw mj bi"><span id="7adc" class="la lb it mb b gy mk ml l mm mn">$ kubectl get ingress -n istio-system</span><span id="cc5e" class="la lb it mb b gy mo ml l mm mn">NAME                       CLASS    HOSTS   ADDRESS                                                                  PORTS   AGE</span><span id="db83" class="la lb it mb b gy mo ml l mm mn">istio-ingressgateway-alb   &lt;none&gt;   *       k8s-istiosys-istioing-charstring1-charstring2.us-east-1.elb.amazonaws.com   80      22h</span></pre><p id="930e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了解决ALB创建错误，我检查了<code class="fe ly lz ma mb b">kube-system</code>名称空间中<code class="fe ly lz ma mb b">aws-load-balancer-controller</code> pod的日志:</p><pre class="mc md me mf gt mg mb mh mi aw mj bi"><span id="8f34" class="la lb it mb b gy mk ml l mm mn">$ kubectl logs aws-load-balancer-controller-75d8b947c5-vdhdc -n kube-system</span></pre><p id="c1b5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果成功，这些日志会显示:</p><pre class="mc md me mf gt mg mb mh mi aw mj bi"><span id="1dfe" class="la lb it mb b gy mk ml l mm mn">{"level":"info","ts":1642466289.4974704,"logger":"controllers.ingress","msg":"successfully deployed model","ingressGroup":"istio-system/istio-ingressgateway-alb"}</span></pre><p id="c2f6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一个让我措手不及的奇怪行为是，这个ALB的端口80和443上的两个侦听器都显示为“Default:returning fixed response 404”:</p><figure class="mc md me mf gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nd"><img src="../Images/75a3878bafc6427144209344ca4926f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YjJ8npVIYXoWVTERqN3Q4Q.png"/></div></div></figure><p id="7732" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我期望看到与httpS侦听器相关联的目标组，以及与HTTP侦听器相关联的从HTTP到https的重定向规则。但是我想AWS负载平衡器控制器这种方式有点古怪。无论如何，我浪费了大量的时间在Istio之外部署另一个示例应用程序,只是为了让自己相信当使用ALB类型的入口时，事情会像预期的那样工作。</p><p id="19bb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">此时，我已经准备好用一个示例应用程序测试Istio网关。我选择了一个被许多其他Istio例子使用的例子:<code class="fe ly lz ma mb b">httpbin</code>。</p><h2 id="5a4b" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">创建httpbin部署、服务、Istio网关和Istio虚拟服务</h2><p id="9ed5" class="pw-post-body-paragraph kb kc it kd b ke lt kg kh ki lu kk kl km lv ko kp kq lw ks kt ku lx kw kx ky im bi translated">我使用这个清单为httpbin应用程序定义了ServiceAccount、服务和部署:</p><pre class="mc md me mf gt mg mb mh mi aw mj bi"><span id="866f" class="la lb it mb b gy mk ml l mm mn">$ cat httpbin.yaml</span><span id="c405" class="la lb it mb b gy mo ml l mm mn">apiVersion: v1</span><span id="44a7" class="la lb it mb b gy mo ml l mm mn">kind: ServiceAccount</span><span id="157a" class="la lb it mb b gy mo ml l mm mn">metadata:</span><span id="671e" class="la lb it mb b gy mo ml l mm mn">  name: httpbin</span><span id="b7f8" class="la lb it mb b gy mo ml l mm mn">---</span><span id="72ce" class="la lb it mb b gy mo ml l mm mn">apiVersion: v1</span><span id="a8fd" class="la lb it mb b gy mo ml l mm mn">kind: Service</span><span id="f4e4" class="la lb it mb b gy mo ml l mm mn">metadata:</span><span id="a22a" class="la lb it mb b gy mo ml l mm mn">  name: httpbin</span><span id="26a7" class="la lb it mb b gy mo ml l mm mn">  labels:</span><span id="bfb6" class="la lb it mb b gy mo ml l mm mn">    app: httpbin</span><span id="b081" class="la lb it mb b gy mo ml l mm mn">spec:</span><span id="666d" class="la lb it mb b gy mo ml l mm mn">  ports:</span><span id="b932" class="la lb it mb b gy mo ml l mm mn">  - name: http</span><span id="0783" class="la lb it mb b gy mo ml l mm mn">    port: 8000</span><span id="fa9a" class="la lb it mb b gy mo ml l mm mn">    targetPort: 80</span><span id="e94e" class="la lb it mb b gy mo ml l mm mn">  selector:</span><span id="dac7" class="la lb it mb b gy mo ml l mm mn">    app: httpbin</span><span id="31de" class="la lb it mb b gy mo ml l mm mn">---</span><span id="bac8" class="la lb it mb b gy mo ml l mm mn">apiVersion: apps/v1</span><span id="1800" class="la lb it mb b gy mo ml l mm mn">kind: Deployment</span><span id="01ae" class="la lb it mb b gy mo ml l mm mn">metadata:</span><span id="dd8a" class="la lb it mb b gy mo ml l mm mn">  name: httpbin</span><span id="818e" class="la lb it mb b gy mo ml l mm mn">spec:</span><span id="689d" class="la lb it mb b gy mo ml l mm mn">  replicas: 1</span><span id="6eb3" class="la lb it mb b gy mo ml l mm mn">  selector:</span><span id="8933" class="la lb it mb b gy mo ml l mm mn">    matchLabels:</span><span id="3290" class="la lb it mb b gy mo ml l mm mn">      app: httpbin</span><span id="a624" class="la lb it mb b gy mo ml l mm mn">      version: v1</span><span id="3d0e" class="la lb it mb b gy mo ml l mm mn">  template:</span><span id="30c0" class="la lb it mb b gy mo ml l mm mn">    metadata:</span><span id="412f" class="la lb it mb b gy mo ml l mm mn">      labels:</span><span id="d0e7" class="la lb it mb b gy mo ml l mm mn">        app: httpbin</span><span id="b80c" class="la lb it mb b gy mo ml l mm mn">        version: v1</span><span id="b852" class="la lb it mb b gy mo ml l mm mn">    spec:</span><span id="e7f5" class="la lb it mb b gy mo ml l mm mn">      serviceAccountName: httpbin</span><span id="76d5" class="la lb it mb b gy mo ml l mm mn">      containers:</span><span id="d945" class="la lb it mb b gy mo ml l mm mn">      - image: docker.io/asankov/httpbin:1.0</span><span id="76f0" class="la lb it mb b gy mo ml l mm mn">        imagePullPolicy: IfNotPresent</span><span id="0685" class="la lb it mb b gy mo ml l mm mn">        name: httpbin</span><span id="13c0" class="la lb it mb b gy mo ml l mm mn">        ports:</span><span id="81e1" class="la lb it mb b gy mo ml l mm mn">        - containerPort: 80</span></pre><p id="2b1b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我没有指定名称空间，所以当我运行<code class="fe ly lz ma mb b">kubectl apply -f httpbin.yaml</code>时，所有这些对象都是在<code class="fe ly lz ma mb b">default</code>名称空间中创建的。</p><pre class="mc md me mf gt mg mb mh mi aw mj bi"><span id="eee9" class="la lb it mb b gy mk ml l mm mn">$ kubectl get services</span><span id="f1ba" class="la lb it mb b gy mo ml l mm mn">NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><span id="ab26" class="la lb it mb b gy mo ml l mm mn">httpbin      ClusterIP   172.20.165.191   &lt;none&gt;        8000/TCP   28h</span><span id="dd80" class="la lb it mb b gy mo ml l mm mn">kubernetes   ClusterIP   172.20.0.1       &lt;none&gt;        443/TCP    12d</span><span id="821a" class="la lb it mb b gy mo ml l mm mn">$ kubectl get pods</span><span id="8cf8" class="la lb it mb b gy mo ml l mm mn">NAME                       READY   STATUS    RESTARTS   AGE</span><span id="2d20" class="la lb it mb b gy mo ml l mm mn">httpbin-5dd5c4dc87-4mqhx   2/2     Running   0          28h</span></pre><p id="270d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">注意<code class="fe ly lz ma mb b">httpbin</code> pod有2个容器。这是因为我用<code class="fe ly lz ma mb b">istio-inject=enabled</code>标记了<code class="fe ly lz ma mb b">default</code>名称空间，所以<code class="fe ly lz ma mb b">istio-proxy</code>容器被自动作为sidecar注入到pod中。</p><p id="6e0c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在为httpbin服务创建Istio网关对象之前，我创建了一个自签名的TLS秘密:</p><pre class="mc md me mf gt mg mb mh mi aw mj bi"><span id="57f9" class="la lb it mb b gy mk ml l mm mn">$ mkdir -p .tls</span><span id="53b4" class="la lb it mb b gy mo ml l mm mn"># Create a root certificate and private key to sign the certificates for our services</span><span id="0472" class="la lb it mb b gy mo ml l mm mn">$ openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -subj '/O=My Company Inc./CN=mydomain.com' -keyout .tls/mydomain.com.key -out .tls/mydomain.com.crt</span><span id="bcf2" class="la lb it mb b gy mo ml l mm mn"># Create a certificate and a private key for httpbin.mydomain.com</span><span id="b5ed" class="la lb it mb b gy mo ml l mm mn">$ openssl req -out .tls/httpbin.mydomain.com.csr -newkey rsa:2048 -nodes -keyout .tls/httpbin.mydomain.com.key -subj "/CN=httpbin.mydomain.com/O=httpbin organization"</span><span id="57a3" class="la lb it mb b gy mo ml l mm mn">$ openssl x509 -req -days 365 -CA .tls/mydomain.com.crt -CAkey .tls/mydomain.com.key -set_serial 0 -in .tls/httpbin.mydomain.com.csr -out .tls/httpbin.mydomain.com.crt</span><span id="7aab" class="la lb it mb b gy mo ml l mm mn"># Create a secret for the istio ingress gateway</span><span id="3501" class="la lb it mb b gy mo ml l mm mn">$ kubectl create secret tls httpbin-tls \<br/>  --key=.tls/httpbin.mydomain.com.key \<br/>  --cert=.tls/httpbin.mydomain.com.crt</span></pre><p id="1559" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">所有这些的最终结果是在名称空间<code class="fe ly lz ma mb b">default</code>中创建了一个名为<code class="fe ly lz ma mb b">httpbin-tls</code>的类型为<code class="fe ly lz ma mb b">tls</code>的Kubernetes secret，其中包含私钥和用于<code class="fe ly lz ma mb b">httpbin.mydomain.com</code>的自签名证书。</p><p id="f56a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我在Istio网关对象的定义中使用了这个秘密:</p><pre class="mc md me mf gt mg mb mh mi aw mj bi"><span id="8a92" class="la lb it mb b gy mk ml l mm mn">$ cat httpbin-gateway-tls.yaml</span><span id="c6c6" class="la lb it mb b gy mo ml l mm mn">apiVersion: networking.istio.io/v1alpha3</span><span id="0143" class="la lb it mb b gy mo ml l mm mn">kind: Gateway</span><span id="f203" class="la lb it mb b gy mo ml l mm mn">metadata:</span><span id="c16b" class="la lb it mb b gy mo ml l mm mn">  name: httpbin-gateway</span><span id="373f" class="la lb it mb b gy mo ml l mm mn">spec:</span><span id="c64c" class="la lb it mb b gy mo ml l mm mn">  selector:</span><span id="2b14" class="la lb it mb b gy mo ml l mm mn">    istio: ingressgateway # use Istio default gateway implementation</span><span id="5d20" class="la lb it mb b gy mo ml l mm mn">  servers:</span><span id="bba3" class="la lb it mb b gy mo ml l mm mn">  - port:</span><span id="cb1f" class="la lb it mb b gy mo ml l mm mn">      number: 80</span><span id="2d63" class="la lb it mb b gy mo ml l mm mn">      name: http</span><span id="bad0" class="la lb it mb b gy mo ml l mm mn">      protocol: HTTP</span><span id="48b7" class="la lb it mb b gy mo ml l mm mn">    hosts:</span><span id="0ef6" class="la lb it mb b gy mo ml l mm mn">    - "*"</span><span id="8277" class="la lb it mb b gy mo ml l mm mn">  - port:</span><span id="346a" class="la lb it mb b gy mo ml l mm mn">      number: 443</span><span id="b390" class="la lb it mb b gy mo ml l mm mn">      name: https</span><span id="8edb" class="la lb it mb b gy mo ml l mm mn">      protocol: HTTPS</span><span id="311f" class="la lb it mb b gy mo ml l mm mn">    tls:</span><span id="1259" class="la lb it mb b gy mo ml l mm mn">      mode: SIMPLE</span><span id="e535" class="la lb it mb b gy mo ml l mm mn">      credentialName: httpbin-tls</span><span id="d940" class="la lb it mb b gy mo ml l mm mn">    hosts:</span><span id="1acf" class="la lb it mb b gy mo ml l mm mn">    - "*"</span><span id="5760" class="la lb it mb b gy mo ml l mm mn">---</span><span id="02d5" class="la lb it mb b gy mo ml l mm mn">apiVersion: networking.istio.io/v1alpha3</span><span id="360d" class="la lb it mb b gy mo ml l mm mn">kind: VirtualService</span><span id="7355" class="la lb it mb b gy mo ml l mm mn">metadata:</span><span id="edc2" class="la lb it mb b gy mo ml l mm mn">  name: httpbin</span><span id="226d" class="la lb it mb b gy mo ml l mm mn">spec:</span><span id="b76d" class="la lb it mb b gy mo ml l mm mn">  hosts:</span><span id="86bb" class="la lb it mb b gy mo ml l mm mn">  - "httpbin.mydomain.com"</span><span id="7754" class="la lb it mb b gy mo ml l mm mn">  gateways:</span><span id="ffb6" class="la lb it mb b gy mo ml l mm mn">  - httpbin-gateway</span><span id="e02a" class="la lb it mb b gy mo ml l mm mn">  http:</span><span id="0799" class="la lb it mb b gy mo ml l mm mn">  - match:</span><span id="9191" class="la lb it mb b gy mo ml l mm mn">    - uri:</span><span id="7cd5" class="la lb it mb b gy mo ml l mm mn">        prefix: /status</span><span id="3fe1" class="la lb it mb b gy mo ml l mm mn">    - uri:</span><span id="57dd" class="la lb it mb b gy mo ml l mm mn">        prefix: /delay</span><span id="30ca" class="la lb it mb b gy mo ml l mm mn">    route:</span><span id="0991" class="la lb it mb b gy mo ml l mm mn">    - destination:</span><span id="ea84" class="la lb it mb b gy mo ml l mm mn">        port:</span><span id="c28b" class="la lb it mb b gy mo ml l mm mn">          number: 8000</span><span id="6644" class="la lb it mb b gy mo ml l mm mn">        host: httpbin</span></pre><p id="9317" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">上面的清单定义了一个<a class="ae kz" href="https://istio.io/latest/docs/reference/config/networking/gateway/" rel="noopener ugc nofollow" target="_blank"> Istio网关</a>对象和一个<a class="ae kz" href="https://istio.io/latest/docs/reference/config/networking/virtual-service/" rel="noopener ugc nofollow" target="_blank"> Istio虚拟服务</a>对象。</p><p id="2f6b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe ly lz ma mb b">Gateway</code>对象的<code class="fe ly lz ma mb b">selector</code>是<code class="fe ly lz ma mb b">istio: ingressgateway</code>，这意味着它将使用我们在前面的步骤中在ALB入口后面创建的<code class="fe ly lz ma mb b">istio-ingressgateway</code>服务。网关定义了两个“服务器”或监听器，公开端口80和443。对于端口443，网关也使用我们之前创建的TLS秘密<code class="fe ly lz ma mb b">httpbin-tls</code>，因此它处理去往<code class="fe ly lz ma mb b">httpbin</code>服务/pod的流量的TLS终止(这由<code class="fe ly lz ma mb b">tls mode SIMPLE</code>表示)。</p><p id="5217" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe ly lz ma mb b">VirtualService</code>对象指定流量路由规则。它将上面定义的<code class="fe ly lz ma mb b">httpbin-gateway</code>声明为其网关，并为主机<code class="fe ly lz ma mb b">httpbin.mydomain.com</code>指定HTTP URL匹配规则。可以把它们看作Apache VirtualHost或Nginx“服务器块”声明。</p><p id="6216" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我通过以下方式创建了网关和虚拟服务:</p><pre class="mc md me mf gt mg mb mh mi aw mj bi"><span id="87da" class="la lb it mb b gy mk ml l mm mn">$ kubectl apply -f httpbin-gateway-tls.yaml</span></pre><p id="dfaf" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后我可以检查这两个物体:</p><pre class="mc md me mf gt mg mb mh mi aw mj bi"><span id="5948" class="la lb it mb b gy mk ml l mm mn">$ kubectl describe gateway httpbin-gateway<br/>$ kubectl describe virtualservice httpbin</span></pre><p id="80f7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">最后，我为httpbin.mydomain.com创建了一个DNS CNAME记录，指向ALB的名称。我已经准备好测试了！</p><p id="f847" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">对http URL使用curl会导致指向https URL的310重定向响应，正如所料:</p><pre class="mc md me mf gt mg mb mh mi aw mj bi"><span id="9405" class="la lb it mb b gy mk ml l mm mn">$ curl -Iv <a class="ae kz" href="http://httpbin.mydomain.com" rel="noopener ugc nofollow" target="_blank">http://httpbin.mydomain.com</a></span><span id="0132" class="la lb it mb b gy mo ml l mm mn">* TCP_NODELAY set</span><span id="0918" class="la lb it mb b gy mo ml l mm mn">* Connected to httpbin.mydomain.com (IP address here) port 80 (#0)</span><span id="99bf" class="la lb it mb b gy mo ml l mm mn">&gt; HEAD / HTTP/1.1</span><span id="d993" class="la lb it mb b gy mo ml l mm mn">&gt; Host: httpbin.mydomain.com</span><span id="8ba3" class="la lb it mb b gy mo ml l mm mn">&gt; User-Agent: curl/7.64.1</span><span id="1d7e" class="la lb it mb b gy mo ml l mm mn">&gt; Accept: */*</span><span id="6d27" class="la lb it mb b gy mo ml l mm mn">&gt;<br/>&lt; HTTP/1.1 301 Moved Permanently</span><span id="6ba0" class="la lb it mb b gy mo ml l mm mn">HTTP/1.1 301 Moved Permanently</span><span id="0913" class="la lb it mb b gy mo ml l mm mn">&lt; Server: awselb/2.0</span><span id="0d66" class="la lb it mb b gy mo ml l mm mn"><strong class="mb iu">Server</strong>: awselb/2.0</span><span id="e986" class="la lb it mb b gy mo ml l mm mn">&lt; Date: Wed, 19 Jan 2022 00:05:01 GMT</span><span id="95d4" class="la lb it mb b gy mo ml l mm mn"><strong class="mb iu">Date</strong>: Wed, 19 Jan 2022 00:05:01 GMT</span><span id="3d85" class="la lb it mb b gy mo ml l mm mn">&lt; Content-Type: text/html</span><span id="8f78" class="la lb it mb b gy mo ml l mm mn"><strong class="mb iu">Content-Type</strong>: text/html</span><span id="f556" class="la lb it mb b gy mo ml l mm mn">&lt; Content-Length: 134</span><span id="0d78" class="la lb it mb b gy mo ml l mm mn"><strong class="mb iu">Content-Length</strong>: 134</span><span id="05d8" class="la lb it mb b gy mo ml l mm mn">&lt; Connection: keep-alive</span><span id="0d4c" class="la lb it mb b gy mo ml l mm mn"><strong class="mb iu">Connection</strong>: keep-alive</span><span id="2087" class="la lb it mb b gy mo ml l mm mn">&lt; Location: https://httpbin.mydomain.com:443/</span><span id="0a6c" class="la lb it mb b gy mo ml l mm mn"><strong class="mb iu">Location</strong>: https://httpbin.mydomain.com:443/</span></pre><p id="b093" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">对https URL使用curl对抗<code class="fe ly lz ma mb b">/status/418</code>,也如预期的那样，导致了与HTTP代码418相关联的现在经典的“我是茶壶”响应:</p><pre class="mc md me mf gt mg mb mh mi aw mj bi"><span id="e576" class="la lb it mb b gy mk ml l mm mn">$ curl https://httpbin.mydomain.com/status/418</span><span id="0460" class="la lb it mb b gy mo ml l mm mn">-=[ teapot ]=-</span><span id="a033" class="la lb it mb b gy mo ml l mm mn">_...._<br/>.'  _ _ `.<br/>| ."` ^ `". _,<br/>\_;`"---"`|//<br/>|       ;/<br/>\_     _/</span></pre><p id="66d5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">虽然这篇文章写得相当流畅，但它掩盖了谷歌搜索和发帖子的大量时间。总共大约8个小时。希望它能帮助到外面的人！我将重温Istio主题，写一些关于可观察性、认证和授权的帖子，敬请关注！</p></div></div>    
</body>
</html>