<html>
<head>
<title>How to run parallel tests in RSpec on GitLab CI Pipeline and speed up Ruby &amp; JavaScript testing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在GitLab CI管道上运行RSpec中的并行测试并加速Ruby &amp; JavaScript测试</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-run-parallel-tests-in-rspec-on-gitlab-ci-pipeline-and-speed-up-ruby-javascript-testing-6fca26817693?source=collection_archive---------0-----------------------#2019-07-15">https://itnext.io/how-to-run-parallel-tests-in-rspec-on-gitlab-ci-pipeline-and-speed-up-ruby-javascript-testing-6fca26817693?source=collection_archive---------0-----------------------#2019-07-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="90d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于CI并行化特性，GitLab CI允许您更快地运行测试。您可以在多个GitLab运行程序上运行并行作业。为了做到这一点，您将学习如何在并行任务之间以动态的方式分割测试，以确保GitLab管道中没有瓶颈。由于CI构建可以尽可能快地运行，所以您的<strong class="jp ir"> Ruby &amp; JS测试也可以非常快</strong>。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/222ccda752dce145cb0871791b9a8524.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VyrCAf0c6zA8fLOd.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">GitLab CI</figcaption></figure><h1 id="56a2" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">GitLab CI并行化</h1><p id="0772" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">当您想要并行运行测试以在几分钟内而不是等待几小时内完成您的1小时测试套件时，常见的问题是找到一种如何在并行作业上分割测试的方法。对于每个测试文件，一些Ruby或JavaScript测试可能需要几毫秒甚至几分钟的时间(例如在RSpec特性测试中使用Capybara)。当使用<a class="ae me" href="https://docs.knapsackpro.com/2019/cypress-parallel-testing-with-jenkins-pipeline-stages" rel="noopener ugc nofollow" target="_blank"> Cypress test runner作为浏览器测试</a>可能需要相当长的时间来执行时，在E2E也会出现测试缓慢的问题(端到端测试)。</p><p id="f02d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您添加更多的并行GitLab运行程序，您可能还会注意到一些运行程序可以稍后开始工作，或者不是所有的作业都可以同时开始(例如，当您在自己的基础设施上运行GitLab运行程序，而其他CI构建占用了一些运行程序)。</p><h1 id="8d22" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">动态测试套件拆分消除CI构建瓶颈</h1><p id="44c6" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">跨并行作业(并行CI节点)优化测试分布的一个解决方案是跨并行GitLab运行程序以较小的块分布测试文件。这确保了活跃的运行者可以消耗和执行你的测试，而过于忙碌的运行者和缓慢的测试会运行较少的测试用例。重要的是确保所有并行的跑步者在相同的时间完成工作，这样你就不会看到有太多工作要处理的GitLab跑步者停滞不前。</p><p id="ce1f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了以动态的方式为Ruby &amp; JavaScript测试划分测试，你可以在backpack Pro中使用队列模式。下面我将解释队列模式是如何工作的，它解决了什么问题。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><h1 id="bd3f" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">并行测试的GitLab YAML配置</h1><p id="bb78" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">在这里你可以找到一个Ruby on Rails项目的示例配置<code class="fe mh mi mj mk b">.gitlab-ci.yml</code>，它使用<a class="ae me" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=how-to-run-parallel-jobs-for-rspec-tests-on-gitlab-ci-pipeline-and-speed-up-ruby-javascript-testing" rel="noopener ugc nofollow" target="_blank">背包Pro队列模式</a>在2个并行任务上执行了RSpec测试。类似的配置将用于带有Jest或Cypress测试的JavaScript项目(背包Pro中支持的测试运行程序的完整列表可以在这里找到)。</p><p id="2f40" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请记住在GitLab设置-&gt;CI/CD-&gt;Variables(Expand)中将<a class="ae me" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=how-to-run-parallel-jobs-for-rspec-tests-on-gitlab-ci-pipeline-and-speed-up-ruby-javascript-testing" rel="noopener ugc nofollow" target="_blank">backpack Pro</a>的API token设置为环境变量名<code class="fe mh mi mj mk b">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC</code>作为屏蔽变量。</p><pre class="km kn ko kp gt ml mk mm mn aw mo bi"><span id="a474" class="mp lc iq mk b gy mq mr l ms mt"><em class="mu"># .gitlab-ci.yml</em><br/>image: "ruby:2.6"<br/><br/>services:<br/>  - postgres<br/><br/>variables:<br/>  RAILS_ENV: test<br/>  POSTGRES_DB: database_name<br/>  POSTGRES_USER: postgres<br/>  POSTGRES_PASSWORD: ""<br/>  DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/database_name"<br/>  <em class="mu"># KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC: it is set in Settings -&gt; CI/CD -&gt; Variables (Expand) as masked variable</em><br/><br/>before_script:<br/>  - apt-get update -qq &amp;&amp; apt-get install -y -qq nodejs<br/>  - ruby -v<br/>  - which ruby<br/>  - gem install bundler --no-document<br/>  - bundle install --jobs $(nproc)  "${FLAGS[@]}"<br/><br/>  <em class="mu"># Database setup</em><br/>  - bin/rails db:setup<br/><br/>rspec:<br/>  parallel: 2<br/>  script:<br/>    - bundle exec rake knapsack_pro:queue:rspec</span></pre><p id="a580" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意，通过改变<code class="fe mh mi mj mk b">parallel</code>选项，你可以运行几十个并行任务，这使得你可以在几分钟内运行非常长的测试套件，而不是等待几个小时。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mv mg l"/></div></figure><h1 id="f9ac" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">摘要</h1><p id="c663" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">由于测试的并行化，GitLab及其CI/CD工具允许运行快速CI构建。通过使用<a class="ae me" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=how-to-run-parallel-jobs-for-rspec-tests-on-gitlab-ci-pipeline-and-speed-up-ruby-javascript-testing" rel="noopener ugc nofollow" target="_blank">backpack Pro队列模式</a>，你可以确保你的测试以一种最佳的方式被分割到并行任务中，这样你的团队就能尽快得到测试结果。</p><p id="95b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi">— — —</p><p id="2825" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最初发布于:<a class="ae me" href="https://docs.knapsackpro.com/2019/how-to-run-parallel-jobs-for-rspec-tests-on-gitlab-ci-pipeline-and-speed-up-ruby-javascript-testing" rel="noopener ugc nofollow" target="_blank">https://docs . knapsackpro . com/2019/how-to-run-parallel-jobs-for-rspec-tests-on-git lab-ci-pipeline-and-speed-up-ruby-JavaScript-testing</a></p></div></div>    
</body>
</html>