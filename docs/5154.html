<html>
<head>
<title>Amazon Managed Workflows for Apache Airflow — Configuration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Amazon管理的Apache Airflow工作流—配置</h1>
<blockquote>原文：<a href="https://itnext.io/amazon-managed-workflows-for-apache-airflow-configuration-77db7fd633c5?source=collection_archive---------1-----------------------#2020-12-26">https://itnext.io/amazon-managed-workflows-for-apache-airflow-configuration-77db7fd633c5?source=collection_archive---------1-----------------------#2020-12-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a0c2" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解亚马逊MWAA的配置选项</h2></div><h1 id="1bf7" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">介绍</h1><p id="6a3a" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">对于任何不熟悉Amazon Managed Workflows for Apache Airflow(Amazon MWAA)的人，尤其是那些习惯于管理自己的Apache air flow平台的人，Amazon MWAA的配置可能一开始看起来有点像黑盒。这篇简短的帖子将探索亚马逊MWAA的配置——如何检查和修改它。我们将使用Airflow DAGs来查看MWAA环境的<code class="fe lw lx ly lz b">airflow.cfg</code>文件、环境变量和Python包。</p><h2 id="2d01" class="ma kj it bd kk mb mc dn ko md me dp ks lj mf mg ku ln mh mi kw lr mj mk ky ml bi translated">亚马逊MWAA</h2><p id="5862" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated"><a class="ae mm" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Airflow </a>是一个流行的开源平台，旨在调度和监控工作流。根据<a class="ae mm" href="https://en.wikipedia.org/wiki/Apache_Airflow" rel="noopener ugc nofollow" target="_blank">维基百科</a>的说法，Airbnb于2014年创建了Airflow，以管理该公司日益复杂的工作流程。项目从一开始就做开源，成为2016年<a class="ae mm" href="https://incubator.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache孵化器</a>项目，2019年顶级Apache软件基础项目。</p><p id="1ce1" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">随着亚马逊MWAA于2020年11月发布<a class="ae mm" href="https://aws.amazon.com/blogs/aws/introducing-amazon-managed-workflows-for-apache-airflow-mwaa/" rel="noopener ugc nofollow" target="_blank">公告</a>，AWS客户现在可以专注于开发工作流自动化，而将气流管理留给AWS。亚马逊MWAA可以作为<a class="ae mm" href="https://aws.amazon.com/step-functions/" rel="noopener ugc nofollow" target="_blank"> AWS步骤函数</a>的替代品，用于AWS上的工作流自动化。</p><p id="4148" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">亚马逊MWAA服务可以使用AWS管理控制台，以及使用最新版本的<a class="ae mm" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/mwaa.html" rel="noopener ugc nofollow" target="_blank"> AWS SDK </a>和<a class="ae mm" href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/mwaa/index.html" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a>的<a class="ae mm" href="https://docs.aws.amazon.com/mwaa/latest/userguide/mwaa-actions-resources.html" rel="noopener ugc nofollow" target="_blank">亚马逊MWAA API </a>获得。关于亚马逊MWAA的更多信息，请阅读我的上一篇文章，<a class="ae mm" rel="noopener ugc nofollow" target="_blank" href="/running-spark-jobs-on-amazon-emr-with-apache-airflow-2e16647fea0c">使用Apache Airflow在亚马逊EMR上运行Spark作业</a>。</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi ms"><img src="../Images/156047d5ba8100a3f373c542020ec999.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q17rNQRD0g_ZQ0RvG4YPHg.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">Apache气流用户界面</figcaption></figure><h1 id="4156" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">源代码</h1><p id="a469" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">这篇文章中引用的Dag可以在GitHub上获得。使用这个<code class="fe lw lx ly lz b">git clone</code>命令，下载这篇文章的<a class="ae mm" href="https://github.com/garystafford/aws-airflow-demo" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>到你的本地环境。</p><pre class="mt mu mv mw gt ni lz nj nk aw nl bi"><span id="807e" class="ma kj it lz b gy nm nn l no np">git clone --branch main --single-branch --depth 1 --no-tags \<br/>    https://github.com/garystafford/aws-airflow-demo.git</span></pre><h1 id="8626" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">访问配置</h1><h2 id="36fe" class="ma kj it bd kk mb mc dn ko md me dp ks lj mf mg ku ln mh mi kw lr mj mk ky ml bi translated">环境变量</h2><p id="cf24" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">环境变量是MWAA环境配置的重要组成部分。有多种方法可以检查环境变量。您可以使用Airflow的<code class="fe lw lx ly lz b">BashOperator</code>来简单地调用命令<code class="fe lw lx ly lz b">env</code>，或者使用<code class="fe lw lx ly lz b">PythonOperator</code>来调用Python迭代器函数，如下所示。项目中包含一个示例DAG，<code class="fe lw lx ly lz b"><a class="ae mm" href="https://github.com/garystafford/aws-airflow-demo/blob/main/dags/get_env_vars.py" rel="noopener ugc nofollow" target="_blank">dags/get_env_vars.py</a></code>。</p><figure class="mt mu mv mw gt mx"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="5bb2" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">DAG的<code class="fe lw lx ly lz b">PythonOperator</code>将迭代MWAA环境的环境变量，并将它们输出到任务的日志中。下面是一个示例任务日志的片段。</p><figure class="mt mu mv mw gt mx"><div class="bz fp l di"><div class="nq nr l"/></div></figure><h2 id="1d1b" class="ma kj it bd kk mb mc dn ko md me dp ks lj mf mg ku ln mh mi kw lr mj mk ky ml bi translated">气流配置文件</h2><p id="060a" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">根据<a class="ae mm" href="https://airflow.apache.org/docs/apache-airflow/1.10.12/howto/set-config.html" rel="noopener ugc nofollow" target="_blank">气流</a>，<code class="fe lw lx ly lz b">airflow.cfg</code>文件包含<a class="ae mm" href="https://airflow.apache.org/docs/apache-airflow/1.10.12/configurations-ref.html#" rel="noopener ugc nofollow" target="_blank">气流的配置</a>。您可以编辑它来更改任何设置。第一次运行Apache Airflow时，它会在您的<code class="fe lw lx ly lz b">AIRFLOW_HOME</code>目录中创建一个<code class="fe lw lx ly lz b">airflow.cfg</code>配置文件，并将这些配置作为环境变量附加到您的环境中。</p><p id="1417" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">亚马逊MWAA没有在环境的Apache Airflow UI中公开<code class="fe lw lx ly lz b">airflow.cfg</code>。虽然不能直接访问，但是可以查看<code class="fe lw lx ly lz b">airflow.cfg</code>文件。配置文件位于您的<code class="fe lw lx ly lz b">AIRFLOW_HOME</code>目录下，<code class="fe lw lx ly lz b">/usr/local/airflow</code>(默认为<code class="fe lw lx ly lz b">~/airflow</code>)。</p><p id="a2a1" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">有多种方法可以检查您的MWAA环境的<code class="fe lw lx ly lz b">airflow.cfg</code>文件。您可以使用Airflow的<code class="fe lw lx ly lz b">PythonOperator</code>来调用读取文件内容的Python函数，如下所示。该函数使用<code class="fe lw lx ly lz b">AIRFLOW_HOME</code>环境变量来定位和读取<code class="fe lw lx ly lz b">airflow.cfg</code>。项目中包含一个示例DAG，<code class="fe lw lx ly lz b"><a class="ae mm" href="https://github.com/garystafford/aws-airflow-demo/blob/main/dags/get_airflow_cfg.py" rel="noopener ugc nofollow" target="_blank">dags/get_airflow_cfg.py</a></code>。</p><figure class="mt mu mv mw gt mx"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="7d95" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">DAG的任务将读取MWAA环境的<code class="fe lw lx ly lz b">airflow.cfg</code>文件，并将其输出到任务的日志中。下面是一个示例任务日志的片段。</p><figure class="mt mu mv mw gt mx"><div class="bz fp l di"><div class="nq nr l"/></div></figure><h2 id="80bb" class="ma kj it bd kk mb mc dn ko md me dp ks lj mf mg ku ln mh mi kw lr mj mk ky ml bi translated">定制气流配置</h2><p id="96d7" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">虽然AWS没有在您的环境的Apache Airflow UI中公开<code class="fe lw lx ly lz b">airflow.cfg</code>，但是您可以直接在亚马逊MWAA控制台中更改默认的Apache Airflow配置选项，并继续使用<code class="fe lw lx ly lz b">airflow.cfg</code>中的所有其他设置。亚马逊MWAA控制台中更改的配置选项被转换为环境变量。</p><p id="35b5" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">要定制Apache气流配置，请直接在亚马逊MWAA控制台上更改默认选项。选择<strong class="lc iu">编辑</strong>，在<strong class="lc iu">气流配置选项</strong>菜单中添加或修改配置选项和值，然后选择<strong class="lc iu">保存</strong>。例如，我们可以将Airflow的<a class="ae mm" href="https://airflow.apache.org/docs/apache-airflow/1.10.12/configurations-ref.html#default-ui-timezone" rel="noopener ugc nofollow" target="_blank">默认时区</a> ( <code class="fe lw lx ly lz b">core.default_ui_timezone</code>)更改为<code class="fe lw lx ly lz b">America/New_York</code>。</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi ms"><img src="../Images/f2cdd1814b6cdd29a2f9d741985743db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q9MVsrQLl8RuNkFmTqXIPg.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">亚马逊MWAA的气流配置选项</figcaption></figure><p id="0df5" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">MWAA环境更新后(这可能需要几分钟时间)，通过重新运行DAG来查看您的更改。请注意下面显示的日志片段的第2行和第6行中的新配置项。配置项单独出现(<code class="fe lw lx ly lz b">AIRFLOW__CORE_DEFAULT__UI_TIMEZONE</code>)，也是<code class="fe lw lx ly lz b">AIRFLOW_CONFIG_SECRETS</code>字典环境变量的一部分。</p><figure class="mt mu mv mw gt mx"><div class="bz fp l di"><div class="nq nr l"/></div></figure><h2 id="ffed" class="ma kj it bd kk mb mc dn ko md me dp ks lj mf mg ku ln mh mi kw lr mj mk ky ml bi translated">使用MWAA API</h2><p id="e55c" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">我们还可以使用<a class="ae mm" href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/mwaa/index.html" rel="noopener ugc nofollow" target="_blank"> MWAA API </a>进行配置更改。例如，要更改默认的Airflow UI时区，请使用AWS CLI调用MWAA API的<code class="fe lw lx ly lz b">update-environment</code>命令。包括<code class="fe lw lx ly lz b">--airflow-configuration-option</code>参数，将<code class="fe lw lx ly lz b">core.default_ui_timezone</code>键/值对作为JSON blob传递。</p><figure class="mt mu mv mw gt mx"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="b532" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">要查看环境的配置，请结合使用<code class="fe lw lx ly lz b">get-environment</code>命令和<code class="fe lw lx ly lz b">jq</code>。</p><figure class="mt mu mv mw gt mx"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="c42a" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">下面，我们看到了一个输出示例。</p><figure class="mt mu mv mw gt mx"><div class="bz fp l di"><div class="nq nr l"/></div></figure><h2 id="d0d3" class="ma kj it bd kk mb mc dn ko md me dp ks lj mf mg ku ln mh mi kw lr mj mk ky ml bi translated">Python包</h2><p id="394d" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">气流是用Python写的，工作流是通过Python脚本创建的。Python包是MWAA环境配置的重要组成部分。根据<a class="ae mm" href="https://docs.aws.amazon.com/mwaa/latest/userguide/working-dags-dependencies.html" rel="noopener ugc nofollow" target="_blank">文档</a>，一个“额外包”是一个Python子包，它不包含在Apache Airflow base中，安装在您的MWAA环境中。作为设置MWAA环境的一部分，您可以在气流S3桶中指定<code class="fe lw lx ly lz b">requirements.txt</code>文件的位置。使用<code class="fe lw lx ly lz b">requirements.txt</code>文件安装额外的包。</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi ms"><img src="../Images/e05979bd1331d3274de11a0851fae91e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gBvzpr8_3JzhRm6pInVPSA.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">亚马逊MWAA环境的配置</figcaption></figure><p id="1b78" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">有多种方法可以检查您的MWAA环境中已安装的Python包和版本。您可以使用Airflow的<code class="fe lw lx ly lz b">BashOperator</code>来调用命令<code class="fe lw lx ly lz b">python3 -m pip list</code>。项目中包含一个示例DAG<code class="fe lw lx ly lz b"><a class="ae mm" href="https://github.com/garystafford/aws-airflow-demo/blob/main/dags/get_py_pkgs.py" rel="noopener ugc nofollow" target="_blank">dags/get_py_pkgs.py</a></code>。</p><figure class="mt mu mv mw gt mx"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="72f1" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">DAG的任务会将所有Python包和包版本的列表输出到任务日志中。下面是一个示例任务日志的片段。</p><figure class="mt mu mv mw gt mx"><div class="bz fp l di"><div class="nq nr l"/></div></figure><h1 id="f2a5" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">结论</h1><p id="9401" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">理解您的亚马逊MWAA环境的<code class="fe lw lx ly lz b">airflow.cfg</code>文件、环境变量和Python包对于正确的气流平台管理都很重要。这篇简短的帖子了解了更多关于亚马逊MWAA的配置——如何使用DAGs检查它，以及如何通过亚马逊MWAA控制台修改它。</p></div><div class="ab cl ns nt hx nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="im in io ip iq"><p id="6aae" class="pw-post-body-paragraph la lb it lc b ld mn ju lf lg mo jx li lj mp ll lm ln mq lp lq lr mr lt lu lv im bi translated">本博客代表我自己的观点，不代表我的雇主亚马逊网络服务公司的观点。所有产品名称、徽标和品牌都是其各自所有者的财产。</p></div></div>    
</body>
</html>