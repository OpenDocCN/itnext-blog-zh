<html>
<head>
<title>Deploying your Vapor 4 app to Heroku</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将您的Vapor 4应用程序部署到Heroku</h1>
<blockquote>原文：<a href="https://itnext.io/deploying-your-vapor-4-app-to-heroku-48b26f9f46cb?source=collection_archive---------1-----------------------#2020-05-15">https://itnext.io/deploying-your-vapor-4-app-to-heroku-48b26f9f46cb?source=collection_archive---------1-----------------------#2020-05-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/63108d6568994dbf4959bd3d2d90f627.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8-cKXbhQ8bjhQoWSituEZQ.png"/></div></div></figure><p id="7537" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi kw translated">你已经完成了你那令人敬畏的<a class="ae lf" href="https://vapor.codes" rel="noopener ugc nofollow" target="_blank"> Vapor 4应用</a>的构建。但现在是时候让世界欣赏你的工作了。这意味着您将面临下一个挑战:让您的应用程序上线。</p><p id="b5d3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有许多方法可以部署您的应用程序。您可以在VPS上运行它，在Docker容器中运行它，甚至使用Kubernetes编排整个集群。在部署应用程序时，这些都是可行的选择。但是等等……我们不想弄脏自己的手，去摆弄容器、代理、监管器等等。我们只是想把这段漂亮的代码放到网上。</p></div><div class="ab cl lg lh hu li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="ij ik il im in"><p id="713d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这就是Heroku进入游戏的地方。Heroku是一个PaaS(平台即服务)。它会为你处理各种事情。它将安排TLS，允许你查看你的应用程序的日志，监控流量等等。</p><p id="d2d3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先去Heroku注册你的免费账户。完成后，安装CLI，从您的终端舒适地与Heroku通信。</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="e0c8" class="lw lx iq ls b gy ly lz l ma mb">$ brew tap heroku/brew &amp;&amp; brew install heroku</span></pre><p id="ba25" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">安装后，运行<code class="fe mc md me ls b">heroku login</code>并遵循说明。它们应该不言自明。</p><p id="5f6f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">登录后，我们可以创建一个新的应用程序。</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="fda7" class="lw lx iq ls b gy ly lz l ma mb">$ heroku create vapor-heroku-tutorial --region eu</span></pre><p id="be1d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">区域参数是可选的，默认为<code class="fe mc md me ls b">us</code>。该名称将是可以访问您的应用程序的子域。</p><p id="9bb3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们希望将Heroku应用程序连接到本地git存储库。你可以通过跑步做到这一点</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="3ec1" class="lw lx iq ls b gy ly lz l ma mb">$ heroku git:remote -a vapor-heroku-tutorial</span></pre><p id="9ce3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当然，别忘了用你自己的应用程序名替换<code class="fe mc md me ls b">vapor-heroku-tutorial</code>。如果您还没有本地git存储库，请先运行<code class="fe mc md me ls b">git init</code>。</p></div><div class="ab cl lg lh hu li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="ij ik il im in"><p id="18fa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们已经连接好了，我们需要创建一个Procfile。Heroku使用这个Procfile来启动您的应用程序。所以继续创建你的Procfile <code class="fe mc md me ls b">$ touch Procfile</code>。Procfile的内容应该如下:</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="2892" class="lw lx iq ls b gy ly lz l ma mb">web: Run serve --env production --hostname 0.0.0.0 --port $PORT</span></pre><p id="b075" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">那里发生了很多事情，所以让我们来看一下。</p><p id="28d5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，我们定义过程的类型。在这种情况下，它是一个web过程，因为我们希望使用HTTP向外界公开我们的应用程序。有多种进程可用于各种任务，但这是我们希望用于应该可以从外部访问的应用程序的一种。其他类型的进程例如可以是运行计划任务的工人。</p><p id="cdf4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">之后，我们定义Heroku应该执行什么命令来启动我们的应用程序。我们想要启动在我们的<code class="fe mc md me ls b">Package.swift</code>文件中定义的<code class="fe mc md me ls b">Run</code>可执行文件，并且我们想要<code class="fe mc md me ls b">serve</code>我们的应用程序。接下来是一些用来配置我们的应用程序的标志。我们希望在生产环境中运行它，以获得适当的日志记录和行为。我们定义主机名，最后定义我们想要绑定的端口。当使用Xcode运行您的应用程序时，它会自动绑定到端口8080。然而，Heroku为我们决定的端口可能会有所不同，并不能保证是8080。为了解决这个问题，Heroku提供了一个<code class="fe mc md me ls b">PORT</code>环境变量，我们可以使用它来绑定。</p><p id="3b0a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将该文件添加到git存储库中。</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="bc2e" class="lw lx iq ls b gy ly lz l ma mb">$ git add Procfile<br/>$ git commit -m "Added Procfile"</span></pre></div><div class="ab cl lg lh hu li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="ij ik il im in"><p id="0810" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们都设置好了，我们想部署我们的应用程序。然而，如果我们运行命令<code class="fe mc md me ls b">git push heroku master</code>，我们将面临一个严重的错误。</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="45a2" class="lw lx iq ls b gy ly lz l ma mb">remote: Building source:<br/>remote:<br/>remote:  !     No default language could be detected for this app.<br/>remote:    HINT: This occurs when Heroku cannot detect the buildpack to use for this application automatically.<br/>remote:    See <a class="ae lf" href="https://devcenter.heroku.com/articles/buildpacks" rel="noopener ugc nofollow" target="_blank">https://devcenter.heroku.com/articles/buildpacks</a><br/>remote:<br/>remote:  !     Push failed<br/>remote: Verifying deploy...<br/>remote:<br/>remote: ! Push rejected to vapor-heroku-tutorial.<br/>remote:<br/>To <a class="ae lf" href="https://git.heroku.com/vapor-heroku-tutorial.git" rel="noopener ugc nofollow" target="_blank">https://git.heroku.com/vapor-heroku-tutorial.git</a><br/>! [remote rejected] master -&gt; master (pre-receive hook declined)<br/>error: failed to push some refs to 'https://git.heroku.com/vapor-heroku-tutorial.git'</span></pre><p id="7bc7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该错误实际上是不言自明的，因为它表明Heroku无法检测到您的构建包。Heroku使用buildpack来决定你的应用程序应该如何构建。因为你输入的代码当然可以包含任何内容。对于所有Heroku关心的，你可以推动一个Perl应用程序。</p><p id="a6d5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">幸运的是，一些优秀的贡献者和Vapor爱好者为Vapor 维护了一个<a class="ae lf" href="https://github.com/vapor-community/heroku-buildpack" rel="noopener ugc nofollow" target="_blank"> Heroku buildpack。所以我们可以通过运行<code class="fe mc md me ls b">heroku buildpacks:set vapor/vapor</code>将它添加到我们的应用程序中。如果我们现在再次推送Heroku，它将开始构建我们的应用程序。</a></p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="b25f" class="lw lx iq ls b gy ly lz l ma mb">$ git push heroku master</span></pre><p id="55e8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这可能需要一段时间，但至少我们可以坐下来放松一下。</p><p id="9118" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦你喝完咖啡，写好备忘录，重新摆放好茶杯。您应该会看到一条可爱的消息，说明您的应用程序已经部署好了。</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="088b" class="lw lx iq ls b gy ly lz l ma mb">https://vapor-heroku-tutorial.herokuapp.com/ deployed to Heroku</span></pre><p id="896b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以现在我们可以点击网址，看看我们可爱的作品！</p></div><div class="ab cl lg lh hu li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="ij ik il im in"><h1 id="f2f7" class="mf lx iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">数据库</h1><p id="5648" class="pw-post-body-paragraph jy jz iq ka b kb nc kd ke kf nd kh ki kj ne kl km kn nf kp kq kr ng kt ku kv ij bi kw translated">对于一个静态应用程序来说，我们能享受的乐趣就只有这么多了。所以让我们进入稍微高级一点的东西:向我们的应用程序添加一个数据库。</p><p id="8f7a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">伟大的事情是，Heroku也有一些伟大的内置支持这一点！他们有自己的托管Postgres数据库。外部提供者也支持其他数据库类型，但是为了简单起见，我们将使用本地支持的数据库。</p><p id="e980" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了向您的应用程序添加一个简单的Postgres数据库，我们返回到我们的终端并运行以下命令:</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="ecb5" class="lw lx iq ls b gy ly lz l ma mb">$ heroku addons:create heroku-postgresql:hobby-dev</span></pre><p id="fb45" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个命令的作用是用免费计划<code class="fe mc md me ls b">hobby-dev</code>为你的类型<code class="fe mc md me ls b">heroku-postgresql</code>的应用程序创建一个新的附加组件，现在应该足够了。</p><p id="a35f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你对你的终端不太适应，你也可以去Heroku仪表板，导航到你的应用程序的“资源”标签，并添加我们的免费爱好Postgres数据库。</p><figure class="ln lo lp lq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/c15f50339c96102a9aa1baba9b8d1182.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9XWjCpWykTRepoLXtO-4Bg.png"/></div></div></figure><figure class="ln lo lp lq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/9c4d780d7a9b1653b03bd8e5c7e64bd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pX5Yvbe0PQ2QbKi3iH4ZCA.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">我们现在将选择免费选项</figcaption></figure><p id="04e0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦数据库被提供，它将被添加到资源列表中。但是我们如何联系呢？</p><p id="2690" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就像Procfile中的<code class="fe mc md me ls b">PORT</code>环境变量一样，也有一个连接到数据库的环境变量。当我们运行命令<code class="fe mc md me ls b">$ heroku config</code>时，我们将看到为我们的应用程序定义的所有变量。正如你将看到的，有一个<code class="fe mc md me ls b">DATABASE_URL</code>变量，我们可以用它来连接到我们新创建的数据库。</p><p id="b512" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">请注意你千万不要！复制该环境变量的值，或者将其存储在代码中的任意位置。</strong></p><p id="9d8b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个环境变量将在Heroku运行我们的应用程序时出现，因此我们可以使用它来连接到我们的数据库，而不必将这些高度敏感的信息存储在任何地方。我们可以在Vapor中使用<code class="fe mc md me ls b">Environment</code>对象读取环境变量。</p><figure class="ln lo lp lq gt jr"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="ef3a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我总是喜欢用所有的变量为环境创建一个扩展。它使它们很好地聚集在一起，并给出很好的概述。</p><p id="8a3c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，我们可以使用这个属性连接到configure.swift文件中的数据库。</p><figure class="ln lo lp lq gt jr"><div class="bz fp l di"><div class="nn no l"/></div></figure></div><div class="ab cl lg lh hu li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="ij ik il im in"><p id="1fee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果我们提交并部署它。一切都会很好，但我们的数据库不会有太多变化。</p><p id="3487" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要向我们的数据库添加一个表，我们必须创建一个实体和迁移。有关说明，请参见:<a class="ae lf" href="https://docs.vapor.codes/4.0/fluent/overview/" rel="noopener ugc nofollow" target="_blank">https://docs . vapor . codes/4.0/fluent/overview/</a></p><p id="3a38" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦我们设置了迁移和实体，我们就将迁移添加到迁移列表中。</p><figure class="ln lo lp lq gt jr"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="1ff6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然而，这仍然不会对我们的数据库产生任何影响。您可以像这样手动强制迁移:</p><figure class="ln lo lp lq gt jr"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="43b3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在开发设置中，这很好，但是它将应用程序的运行与数据库迁移紧密耦合在一起。这可能会带来各种各样的麻烦。因此，请确保我们仅在开发时强制运行迁移:</p><figure class="ln lo lp lq gt jr"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="e6f9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是现在最大的问题是，当不开发时，我们应该如何运行我们的迁移？</p><p id="c891" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这就是我们之前讨论的Procfile中的另一种进程发挥作用的地方。Heroku也有一个<code class="fe mc md me ls b">release</code>过程类型。这个过程在<a class="ae lf" href="https://devcenter.heroku.com/articles/release-phase#when-does-the-release-command-run" rel="noopener ugc nofollow" target="_blank">成功的应用构建</a>上运行。</p><p id="ee24" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以用这个来运行蒸汽<code class="fe mc md me ls b">migrate</code>命令。我们可以用类似于<code class="fe mc md me ls b">serve</code>命令的方式来执行它。但是，migrate命令只会运行数据库迁移并完成。</p><p id="6144" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们编辑我们的Procfile，如下所示:</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="cc85" class="lw lx iq ls b gy ly lz l ma mb">release: Run migrate -y<br/>web: Run serve --env production --hostname 0.0.0.0 --port $PORT</span></pre><p id="595a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意，我们添加了一个类型为<code class="fe mc md me ls b">release</code>的新流程。</p><p id="e9c3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为migrate命令不关心环境、主机、端口和所有这些东西，我们可以简单地称之为<code class="fe mc md me ls b">Run migrate</code>。添加<code class="fe mc md me ls b">-y</code>标志是为了直接确认我们在迁移时得到的确认。</p><p id="76f4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果我们提交并将其推送到Heroku，我们可以在数据库查看器(可以从Heroku项目的Resources选项卡中访问)中看到我们新创建的表🎉</p></div><div class="ab cl lg lh hu li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="ij ik il im in"><p id="bc08" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我希望这篇文章能够帮助您快速在Heroku上运行您的Vapor应用程序。</p><p id="33e4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">感谢阅读！我也活跃在推特和Instagram 上，在那里我会发布一些技巧和窍门。</p></div></div>    
</body>
</html>