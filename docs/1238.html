<html>
<head>
<title>Fault-tolerant OpenVPN in AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS中的容错OpenVPN</h1>
<blockquote>原文：<a href="https://itnext.io/fault-tolerant-openvpn-in-aws-a47e0d17ca85?source=collection_archive---------2-----------------------#2018-08-18">https://itnext.io/fault-tolerant-openvpn-in-aws-a47e0d17ca85?source=collection_archive---------2-----------------------#2018-08-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/0bbffe7377073dd210551974e62c5d51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bhzoWgBhjZHvLT5QNSwaBA.png"/></div></div></figure><p id="cb7d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">采用RDS MySql后端部署的OpenVPN可以承受AWS AZ崩溃。</strong></p><p id="b1b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我确信你们中的许多人已经在使用OpenVPN安全地访问你们的VPCs。我也确信，和我一样，你也试图找出一种方法，以高度可用或容错的方式部署<strong class="ka ir">支持的</strong><a class="ae kw" href="https://aws.amazon.com/marketplace/search/results?page=1&amp;filters=vendor_id&amp;vendor_id=aac3a8a3-2823-483c-b5aa-60022894b89d&amp;searchTerms=openvpn" rel="noopener ugc nofollow" target="_blank">AWS market place ami</a>。</p><p id="ee21" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我必须说，不幸的是，AWS没有为EC2服务提供实时迁移，而事实上，其他云提供商，如Azure和谷歌云平台提供了这种服务。简而言之，该特性允许机器在一个机架中自由地发生故障，并自动地连同它们的状态一起转移到不同的机架或数据中心(尽力而为)。</p><p id="0291" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">虽然我同意这种特性会给一些工作负载带来潜在的不确定性，但我们仍然有大量像OpenVPN这样的宠物服务器应用程序，它们与某种类型的网络或存储状态紧密绑定。</p><blockquote class="kx ky kz"><p id="acc1" class="jy jz la ka b kb kc kd ke kf kg kh ki lb kk kl km lc ko kp kq ld ks kt ku kv ij bi translated">更新:正如<a class="ae kw" href="https://medium.com/@LukeYoungblood?source=responses---------0----------------" rel="noopener">卢克·扬布拉德</a>在下面的评论中提到的，AWS提供了一个<a class="ae kw" href="https://aws.amazon.com/blogs/aws/new-auto-recovery-for-amazon-ec2/" rel="noopener ugc nofollow" target="_blank"> CloudWatch事件</a>你可以监听并恢复EC2附件。</p></blockquote><p id="86dd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">AWS中一个典型的解决方法是将应用程序启动编码为一个<strong class="ka ir">启动配置</strong>，并在一个多AZ <strong class="ka ir">自动伸缩组</strong>的一个实例上运行服务器。为了使这项技术适用于Marketplace OpenVPN AMI，我们需要确保设置满足以下要求:</p><ol class=""><li id="ec5a" class="le lf iq ka b kb kc kf kg kj lg kn lh kr li kv lj lk ll lm bi translated">能够将OpenVPN的配置数据库卸载到多AZ RDS实例。</li><li id="a13f" class="le lf iq ka b kb ln kf lo kj lp kn lq kr lr kv lj lk ll lm bi translated">能够在第一次启动时自动更新OpenVPN的DNS记录以解析到一个全新的弹性IP。</li></ol><p id="0b0f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">幸运的是，这都可以通过AWS实例UserData和IAM权限来实现。以下脚本用几个亮点描述了我们当前的实现:</p><ul class=""><li id="654a" class="le lf iq ka b kb kc kf kg kj lg kn lh kr li kv ls lk ll lm bi translated">我们为OpenVPN 创建了一个<strong class="ka ir">唯一的Route53托管区域，该区域仅包含它自己的记录，我们赋予OpenVPN实例角色更新该区域中记录的能力。尽管这听起来没有必要，但这是保证OpenVPN服务器角色不会被恶意使用并删除共享区域中所有其他记录的唯一方法。</strong></li><li id="0ae3" class="le lf iq ka b kb ln kf lo kj lp kn lq kr lr kv ls lk ll lm bi translated">我们将一个离线加密的秘密传递给包含数据库密码的实例。我们这样做是为了防止数据库密码以明文形式存储在terraform状态文件中。</li></ul><figure class="lt lu lv lw gt jr"><div class="bz fp l di"><div class="lx ly l"/></div><figcaption class="lz ma gj gh gi mb mc bd b be z dk translated">启动配置和自动缩放组</figcaption></figure><p id="44c5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下UserData Terraform模板将OpenVPN本地数据库迁移到RDS中，更新其DNS记录并设置一些默认的有用运行时设置。</p><figure class="lt lu lv lw gt jr"><div class="bz fp l di"><div class="lx ly l"/></div><figcaption class="lz ma gj gh gi mb mc bd b be z dk translated">启动配置用户数据脚本。</figcaption></figure><p id="75bb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，IAM策略使自动化成为可能。</p><figure class="lt lu lv lw gt jr"><div class="bz fp l di"><div class="lx ly l"/></div><figcaption class="lz ma gj gh gi mb mc bd b be z dk translated">OpenVPN服务器的IAM策略</figcaption></figure><h1 id="e32c" class="md me iq bd mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na bi translated">包扎</h1><p id="c350" class="pw-post-body-paragraph jy jz iq ka b kb nb kd ke kf nc kh ki kj nd kl km kn ne kp kq kr nf kt ku kv ij bi translated">这并不是火箭科学，但是花了一点时间摆弄OpenVPN来让这些脚本工作。我希望当你需要在AWS中设置一个新的OpenVPN服务器时，这可以作为你的参考。</p><p id="286d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">干杯</p></div></div>    
</body>
</html>