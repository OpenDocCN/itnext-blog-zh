<html>
<head>
<title>Setup a Multi env JAMSTACK production deployment on GCP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在GCP上设置多环境JAMSTACK生产部署</h1>
<blockquote>原文：<a href="https://itnext.io/setup-a-multi-env-jamstack-production-deployment-on-gcp-34f10d75dd7f?source=collection_archive---------1-----------------------#2022-09-24">https://itnext.io/setup-a-multi-env-jamstack-production-deployment-on-gcp-34f10d75dd7f?source=collection_archive---------1-----------------------#2022-09-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/a4cf26770a99fb7715556165d8c09d31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eGEkXXvutTGfzdaP"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@prics?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">巴累·j·理查德</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><h1 id="8095" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">(或者如何从Netlify迁移)</h1><p id="16af" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">以JAMSTACK方式部署web应用程序有无数种方法。并且有大量的工具可以提供即插即用的体验。其中之一是Netlify。将gatsby.js应用程序部署到Netlify就像创建github repo一样简单。然而，如果你需要离开他们。以节省成本或提高速度/可靠性。事情开始变得棘手..</p></div><div class="ab cl lz ma hu mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="ij ik il im in"><p id="2c50" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">最近，我们在Netlify上几乎每天都遇到中断，在获得支持后，我们被建议升级到每月3，000美元起的企业计划，并保证99.9%的SLA。在发现我们可以使用具有99.9% SLA、出色性能且价格仅为我们的一小部分的google CLOUD CDN来满足我们的需求后，我们决定进行迁移。在这篇文章中，我将解释如何迁移一个运行在Netlify上并使用了<strong class="ld ir"> Netlify重定向</strong>的现有web应用。希望这将有利于其他处于相同情况的人。</p><div class="ml mm gp gr mn mo"><a href="https://answers.netlify.com/t/why-is-netlify-down-so-often-the-last-days/74545" rel="noopener  ugc nofollow" target="_blank"><div class="mp ab fo"><div class="mq ab mr cl cj ms"><h2 class="bd ir gy z fp mt fr fs mu fu fw ip bi translated">为什么最近几天netlify总是情绪低落？</h2><div class="mv l"><h3 class="bd b gy z fp mt fr fs mu fu fw dk translated">我们理解最近的降级对我们的客户造成的影响，并对服务中断表示歉意…</h3></div><div class="mw l"><p class="bd b dl z fp mt fr fs mu fu fw dk translated">answers.netlify.com</p></div></div><div class="mx l"><div class="my l mz na nb mx nc jw mo"/></div></div></a></div><p id="e17e" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">正如我在他们论坛看到的，他们是相当多的…</p><p id="4f26" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">下面的一切也可以用于新的部署。</p></div><div class="ab cl lz ma hu mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="ij ik il im in"><h2 id="853c" class="nd ke iq bd kf ne nf dn kj ng nh dp kn lm ni nj kr lq nk nl kv lu nm nn kz no bi translated">关键概念和计划</h2><p id="920f" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated"><a class="ae kc" href="https://jamstack.org/" rel="noopener ugc nofollow" target="_blank"><strong class="ld ir">【jam stack</strong></a>:一种部署web应用程序的方式，它宣传前端和它们使用的API端点的分离，这非常适合微服务架构。</p><p id="b354" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated"><strong class="ld ir">相同站点请求:</strong>对服务于web应用程序的相同域/协议的web请求。例如，浏览器对<code class="fe np nq nr ns b">/api/login</code>(注意没有域或协议)的请求是一个相同的站点请求，浏览器将自动使用当前打开标签的相同域/协议。</p><p id="3a73" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">为什么这很重要？因为使用(https)相同站点请求是使用“相同站点、服务器端、安全cookies”的唯一方式。最安全合法的cookies，即使是苹果也不会限制/删除。浏览器上运行的javascript无法访问的Cookies。存储用户授权信息的最佳方式。但是如果你有运行在你的web应用的不同域/子域上的微服务，你需要一个特殊的技巧来将请求从你的站点域重定向到网关。</p><p id="0b2c" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">Netlify通过使用对我们来说非常方便的<a class="ae kc" href="https://docs.netlify.com/routing/redirects/" rel="noopener ugc nofollow" target="_blank">重定向/重写</a>特性来实现这一点。在这篇文章中，我们将用GCP url-map替换Netlify重定向来达到相同的效果，并做其他一切来创建相同的基础架构，甚至更多。只需价格的一小部分。</p><p id="165b" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">我们将使用Terraform创建以下GCP资源</p><ul class=""><li id="58c7" class="nt nu iq ld b le mg li mh lm nv lq nw lu nx ly ny nz oa ob bi translated">存储桶</li><li id="6381" class="nt nu iq ld b le oc li od lm oe lq of lu og ly ny nz oa ob bi translated">桶后端</li><li id="1cff" class="nt nu iq ld b le oc li od lm oe lq of lu og ly ny nz oa ob bi translated">负载平衡器</li><li id="4f09" class="nt nu iq ld b le oc li od lm oe lq of lu og ly ny nz oa ob bi translated">IP地址；网络地址</li><li id="00a7" class="nt nu iq ld b le oc li od lm oe lq of lu og ly ny nz oa ob bi translated">dns记录</li><li id="fb45" class="nt nu iq ld b le oc li od lm oe lq of lu og ly ny nz oa ob bi translated">托管证书</li><li id="097f" class="nt nu iq ld b le oc li od lm oe lq of lu og ly ny nz oa ob bi translated">http到https重定向</li><li id="2002" class="nt nu iq ld b le oc li od lm oe lq of lu og ly ny nz oa ob bi translated">用GCP url映射替换Netlify重写</li><li id="f918" class="nt nu iq ld b le oc li od lm oe lq of lu og ly ny nz oa ob bi translated">云甲DDOS防护(加成)</li><li id="968f" class="nt nu iq ld b le oc li od lm oe lq of lu og ly ny nz oa ob bi translated">托管证书</li><li id="4e61" class="nt nu iq ld b le oc li od lm oe lq of lu og ly ny nz oa ob bi translated">一些其他的东西</li></ul><p id="16f3" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">配置一切。</p><ul class=""><li id="b817" class="nt nu iq ld b le mg li mh lm nv lq nw lu nx ly ny nz oa ob bi translated">将负载平衡器连接到bucket端点以及k8s服务(api网关)、ip和托管证书。</li><li id="1076" class="nt nu iq ld b le oc li od lm oe lq of lu og ly ny nz oa ob bi translated">创建一个github动作来部署我们的应用程序。</li></ul><p id="80dc" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">如果这听起来很酷，那就喝杯咖啡，系好安全带。</p></div><div class="ab cl lz ma hu mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="ij ik il im in"><p id="6b8e" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">首先，我们需要一个IP地址、一个DNS记录和一个GCS存储桶</p><figure class="oh oi oj ok gt jr"><div class="bz fp l di"><div class="ol om l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">这将创建一个什么也没有连接的ip地址和一个dns记录</figcaption></figure><figure class="oh oi oj ok gt jr"><div class="bz fp l di"><div class="ol om l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">创建一个配置为托管网站的存储桶</figcaption></figure><p id="12fb" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">然后我们需要将这个桶公开(供阅读)</p><figure class="oh oi oj ok gt jr"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="e381" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">现在，如何将这个桶连接到负载平衡器？为了实现这一点，我们需要创建一个“后端”，这是一个GCP术语，指可以连接到LB和目标的托管服务(如k8s服务或GCS bucket)，定义健康检查等内容。</p><p id="7502" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">当在GKE上创建K8S服务时，会为它创建一个GCP“默认后端”。(我们将很快回来)</p><figure class="oh oi oj ok gt jr"><div class="bz fp l di"><div class="ol om l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">请注意CDN定义以及与bucket和安全策略的连接</figcaption></figure><p id="e8c7" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">“backend_bucket”本质上是将CDN连接到bucket的东西，但是它还没有连接到ip。</p><p id="f8c1" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">到目前为止，我们有一个ip，dns记录和一个后端公共桶。不，我们需要将它们连接在一起并连接到一个LB上。</p><p id="d44f" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">但首先我们还需要一些东西。</p><figure class="oh oi oj ok gt jr"><div class="bz fp l di"><div class="ol om l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">这一点很重要</figcaption></figure><p id="4fdd" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">URL映射是一个定义负载平衡器“大脑”的实体。它还包含我们正在使用的Netlify重写规则的替换。</p><figure class="oh oi oj ok gt jr"><div class="bz fp l di"><div class="ol om l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">netlify.toml</figcaption></figure><p id="f422" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">上面的url映射包含与netlify.toml文件相同的逻辑。每个带有“/api”或“/stage/api”前缀的自身站点请求将被重写到环境的api网关(位于其自身的k8s集群中)。所有其他请求都将被定向到我们之前创建的“bucket backend”。</p><h2 id="a372" class="nd ke iq bd kf ne nf dn kj ng nh dp kn lm ni nj kr lq nk nl kv lu nm nn kz no bi translated">查找api网关后端服务</h2><p id="90b3" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">上面定义的黑魔法“API-gateway-back end”terra form数据资源，带有每个env的硬编码id。是为API网关k8s服务(由GKE)创建的默认后端的定义，这些硬编码的id可以在GCP web控制台中找到。</p><p id="561b" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">打开控制台&gt;负载平衡&gt;后端服务</p><p id="2c19" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">在ui过滤器中，开始键入k8s服务名。</p><figure class="oh oi oj ok gt jr gh gi paragraph-image"><div class="gh gi on"><img src="../Images/07582ae9581fd8eb9461b12fae681c4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1216/format:webp/1*_p2YE2ZYpQvb6d4H8b_fMA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">找到您的k8s服务后端服务</figcaption></figure><figure class="oh oi oj ok gt jr"><div class="bz fp l di"><div class="ol om l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">它是由GKE从这样的k8s资源中创建的</figcaption></figure><p id="ad4b" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">搜索您为k8s服务指定的名称以找到其后端，如果您的k8s服务名称包含“api ”,只需键入“api ”,如上例所示</p><h2 id="c048" class="nd ke iq bd kf ne nf dn kj ng nh dp kn lm ni nj kr lq nk nl kv lu nm nn kz no bi translated">配置GCP后端(奖金)</h2><p id="69df" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">可以使用名为<code class="fe np nq nr ns b">BackendConfig</code>的GKE资源来配置这些后端，以做一些有趣的事情。</p><figure class="oh oi oj ok gt jr"><div class="bz fp l di"><div class="ol om l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">自定义后端配置(CRD)</figcaption></figure><p id="3e82" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">它可以做很多事情，比如添加自定义地理标题，(你不再需要<a class="ae kc" href="https://www.maxmind.com/en/home" rel="noopener ugc nofollow" target="_blank"> maxmind </a>了……)或者附加到云装甲安全策略。(稍后将详细介绍)</p><p id="922a" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">请注意，我们没有使用terraform创建api网关后端服务，我们只是使用了<code class="fe np nq nr ns b">data</code>指令来引用它</p><figure class="oh oi oj ok gt jr"><div class="bz fp l di"><div class="ol om l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">引用GKE创建的后端服务</figcaption></figure><p id="6c5e" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">这是k8s和地球资源相遇的地方。我认为这很酷..</p><p id="13b5" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">到目前为止，我们有一个url映射，它将让我们的LB如何处理传入的请求。现在让我们将它连接到我们之前创建的IP和一个托管证书。</p><figure class="oh oi oj ok gt jr"><div class="bz fp l di"><div class="ol om l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">google托管证书</figcaption></figure><p id="0582" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">为了使https握手有效，我们的LB需要一个TLS证书。浏览器可以“信任”LB身份的方式，就像护照一样。幸运的是，GCP可以为我们管理这些证书，轮换并与SA授权机构签署证书。</p><p id="3b2c" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">这里唯一需要注意的是，我们想要签名的域，在上面的例子中是它的["foo.bar-prod.com . " 、" app.foo.ua . "。需要解析到LB的IP。否则证书不会被签署。</p><p id="16c3" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">这就引出了下两个资源</p><figure class="oh oi oj ok gt jr"><div class="bz fp l di"><div class="ol om l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">将一切联系在一起</figcaption></figure><p id="defe" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">以上两个资源连接了url-map、证书和ip地址，基本上创建了负载平衡器，它完成了我们需要的所有工作。</p><p id="408b" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">从GCS bucket为我们的web应用程序提供服务，并重写对我们的api网关的self站点请求。</p><p id="2b0a" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">还有一件事，http-https重定向。目前只有端口443连接到我们的LB。如果用户导航到我们的应用程序，端口80 ( http)上没有任何响应。这将我们引向下一个资源。</p><figure class="oh oi oj ok gt jr"><div class="bz fp l di"><div class="ol om l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">http-https重定向</figcaption></figure><p id="7bac" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">以上创造了谷歌所谓的“部分负载平衡器”。它是部分的，因为它没有连接到后端。它只有一个简单的url-map和一个默认的https重定向规则。它和我们的HTTPS LB连接在同一个IP上。</p><p id="8dc1" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">现在，将在端口80导航到您的应用程序的用户将被立即重定向到端口443并使用https。</p><h2 id="9602" class="nd ke iq bd kf ne nf dn kj ng nh dp kn lm ni nj kr lq nk nl kv lu nm nn kz no bi translated">云甲(加成)</h2><figure class="oh oi oj ok gt jr"><div class="bz fp l di"><div class="ol om l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">边缘安全策略</figcaption></figure><p id="85f3" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">云装甲安全策略可以连接到我们之前讨论过的“后端”。它可以做很多事情，像晶圆保护，DDOS保护，速率限制，阻止ip范围和国家等等。</p><p id="f760" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">基本上有两种类型的策略，边缘策略和非边缘策略。边缘策略可以附加到桶后端，顾名思义，它们在边缘上保护后端，所以它们不能做一些像WAF绘制和L7 DDOS绘制这样的事情。不过不用担心，云CDN内置了那些功能。将安全策略附加到bucket后端的原因是，例如，如果将来您想要阻止来自俄罗斯、朝鲜或伊朗等国家的访问您的站点。这将是做它的地方。</p><h2 id="95e8" class="nd ke iq bd kf ne nf dn kj ng nh dp kn lm ni nj kr lq nk nl kv lu nm nn kz no bi translated">Github操作</h2><p id="53b2" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">我差点忘了我们还没有部署我们的应用程序。让我们看看这样做的动作。我们还想使用缓存来加速我们的构建。</p><figure class="oh oi oj ok gt jr"><div class="bz fp l di"><div class="ol om l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">ga-action.yaml</figcaption></figure><p id="b2d7" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">上面的GH动作构建了一个gatsby.js app，使用缓存。构建步骤需要大约30秒。比Netlify快三到四倍。</p><p id="deba" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">除了以下几点之外，该文件基本上是自我解释的:</p><p id="cbee" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">我们使用<code class="fe np nq nr ns b">rsync</code>将我们的站点上传到桶中，它不是原子的。但是，因为我们使用缓存，所以它只同步已更改的文件，这只是公共目录的一小部分(在我们的例子中是几百个文件中的大约30个)。我们将CDN定义为一分钟TTL。因此，如果用户恰好在运行<code class="fe np nq nr ns b">rsync</code>的那一秒浏览我们的应用，那么在部署后使CDN无效几乎可以保证他们不会得到一个损坏的状态。</p><p id="dd1f" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">我们是如何将GHA与我们的GCP项目联系起来的？</p><pre class="oh oi oj ok gt oo ns op oq aw or bi"><span id="9c43" class="nd ke iq ns b gy os ot l ou ov">service_account_key: ${{ secrets.GCLOUD_SERVICE_KEY }}</span></pre><p id="5f92" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">保存我们为github操作创建的服务帐户导出的base64 JSON密钥(对我们的bucket有写访问权)。但是这种方式已经被弃用了！他们有一种叫做<a class="ae kc" href="https://cloud.google.com/iam/docs/workload-identity-federation" rel="noopener ugc nofollow" target="_blank">的工作负载身份联合</a>的东西，可以以一种更安全的方式实现同样的功能(没有共享密钥)。所以如果我是你，我会试试。</p></div><div class="ab cl lz ma hu mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="ij ik il im in"><h2 id="e5dc" class="nd ke iq bd kf ne nf dn kj ng nh dp kn lm ni nj kr lq nk nl kv lu nm nn kz no bi translated">最后</h2><p id="9b1b" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">迁移出Netlify花了我们大约220个地形线和一些黑色魔术。我们不得不这样做，因为我们需要一个有弹性的快速生产部署，并且不想支付企业账单。但在最初的日子里，Netlify是一个非常简单的解决方案，它让我们专注于应用程序的业务逻辑，而不是一个完美的基础设施。因此，建议那些想在第一天跳过以上所有这些麻烦的人大胆尝试一下。但是，对于生产部署来说。我建议使用GCP。在迁移后，您仍然可以使用netlify进行暂存和预览部署。SLA和性能并不重要。</p><p id="411c" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">感谢您阅读这篇非常专业的帖子！！</p><p id="6460" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">如果你喜欢这样的东西，请给我留言。</p><p id="5e6a" class="pw-post-body-paragraph lb lc iq ld b le mg lg lh li mh lk ll lm mi lo lp lq mj ls lt lu mk lw lx ly ij bi translated">干杯！</p></div></div>    
</body>
</html>