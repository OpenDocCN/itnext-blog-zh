<html>
<head>
<title>GraphQL in a Micro Services Architecture</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">微服务架构中的GraphQL</h1>
<blockquote>原文：<a href="https://itnext.io/graphql-in-a-microservices-architecture-d17922b886eb?source=collection_archive---------0-----------------------#2019-02-27">https://itnext.io/graphql-in-a-microservices-architecture-d17922b886eb?source=collection_archive---------0-----------------------#2019-02-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e8e9" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">GraphQL拼接提高了开发人员的灵活性和生产力</h2></div><h1 id="8aa7" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">背景</h1><p id="787a" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在最近的一篇文章<a class="ae lt" rel="noopener ugc nofollow" target="_blank" href="/exploring-tokens-with-stellar-291172208639">探索带有恒星的令牌</a>中，我顺便提到了在我们构建解决方案的方法中如何使用<a class="ae lt" href="https://www.apollographql.com/docs/graphql-tools/schema-stitching.html" rel="noopener ugc nofollow" target="_blank"> GraphQL拼接</a>。为了理解我们如何以简单优雅的方式解决这个问题，我将首先分享我们解决方案的整体拓扑结构。</p><p id="777a" class="pw-post-body-paragraph kx ky iq kz b la lu jr lc ld lv ju lf lg lw li lj lk lx lm ln lo ly lq lr ls ij bi translated"><strong class="kz ir">作者注:</strong>由于对这个话题的强烈兴趣，我们于2019年3月14日在GitHub上发布了组织<a class="ae lt" href="https://github.com/token-factory" rel="noopener ugc nofollow" target="_blank"> token-factory </a>下的源代码。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi lz"><img src="../Images/ab0122e66cb5c479aaa5270ab223ddba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S6sI4vnB5o4ktXzrY3Orkg.png"/></div></div></figure><h1 id="557b" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">GraphQL环境下微服务的成长烦恼</h1><p id="e41d" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">当我们使用GraphQL构建编程模型时，我们发现为我们的每项功能提供独立服务的好处是允许我们的团队快速工作并迭代编程模型，同时提供微服务和12因素应用程序的典型好处。另一方面，分离出这些服务阻止了团队充分利用更多GraphQL高级功能，如服务器端<a class="ae lt" href="https://graphql.org/learn/best-practices/#server-side-batching-caching" rel="noopener ugc nofollow" target="_blank">批处理和缓存</a>。与此同时，我们也在尝试简化客户端编程模型，而Apollo如何基于定义良好的端点来初始化客户端，这给开发团队带来了另一系列棘手问题。</p><h1 id="8dea" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">GraphQL拼接如何解决我们的问题</h1><p id="3a6f" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">为了尝试解决我们的痛点，团队决定看看其他人是如何用GraphQL处理微服务架构的，并很快想到了<a class="ae lt" href="https://www.apollographql.com/docs/graphql-tools/schema-stitching.html" rel="noopener ugc nofollow" target="_blank">模式拼接</a>的想法。在我们的微服务架构中，每个微服务都有自己独特的端点和为入口控制器配置的路由规则。这种方法要求前端开发团队定义多个Apollo客户端来支持各种端点，或者在入口中配置复杂的路由规则，而不仅仅是简单的上下文路径路由规则，以支持到各种微服务端点的路由。通过启用模式拼接，我们能够合并来自各种微服务的模式，这些微服务代表了所有支持GraphQL APIs的复合视图，从而简化了我们的客户端编程模型。结果是针对单个GraphQL端点进行编程。此外，这允许我们的客户端编程模型真正包含跨越多个服务的GraphQL和批处理查询，这在以前的架构中是不可能的。</p><h1 id="b4cf" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">GraphQL拼接的体系结构</h1><p id="6bfb" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">GraphQL拼接是一个额外的运行时服务，它被部署到一个现有的拓扑中(参见上面的拓扑)。在我们的解决方案中，我们部署了一个<code class="fe ml mm mn mo b">GraphQL Proxy</code>，它在我们的<code class="fe ml mm mn mo b">Ingress Controller</code>和GraphQL端点之间路由流量。核心功能由一个名为<code class="fe ml mm mn mo b">graphql-tools</code>的社区Node.js模块提供，该模块带有一组需要实现的定义良好的API。拼接的作用是从一组定义的GraphQL端点导入和合并模式。这个运行时服务负责将入站请求有效负载映射到适当的端点，以及错误处理和安全性。</p><h1 id="18f6" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">我们服务的GraphQL拼接方法</h1><p id="36e9" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在下面的例子中，我包含了负责合并模式和用各种GraphQL变化和查询初始化Apollo服务器的全部资源。请注意，拼接充当实际服务的代理，并且在模式合并后是静态的。因此，如果您所管理的缝合GraphQL模式是易变的，您将希望让定期监控这些端点的变化。在我们的例子中，我们利用Kubernetes的就绪性和活性探测来跟踪变化，并在发生变化时触发服务的重载。</p><figure class="ma mb mc md gt me"><div class="bz fp l di"><div class="mp mq l"/></div></figure><h1 id="04e5" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">引入远程第三方模式</h1><p id="a2f9" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">这个脚本中的一个微妙之处可以在第22行看到</p><pre class="ma mb mc md gt mr mo ms mt aw mu bi"><span id="e9f4" class="mv kg iq mo b gy mw mx l my mz">const STELLAR_NODE_URI = ‘https://core-test.gly.sh/graphql’</span></pre><p id="c539" class="pw-post-body-paragraph kx ky iq kz b la lu jr lc ld lv ju lf lg lw li lj lk lx lm ln lo ly lq lr ls ij bi translated">迁移到GraphQL拼接最强大的功能之一是能够使用第三方API，并将它们与您现有的GraphQL APIs合并。Stellar开发者社区相当活跃，为开发者提供了许多有用的资产。我们非常依赖的是GraphQL支持的API层，它位于Stellar testnet的Postgres数据库之上。在文章<a class="ae lt" rel="noopener ugc nofollow" target="_blank" href="/building-stellar-apps-36303d0e6f45">构建明星应用</a>中可以找到这个和其他关于开发者生态系统力量的令人敬畏的例子。这个端点扩展了我们的API，为每个stellar核心数据库提供了一组丰富的GraphQL查询。太棒了。</p><h1 id="afe3" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">结论</h1><p id="606f" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">GraphQL来自以REST API为中心的世界，它能够执行非常适合多个前端应用程序的细粒度查询，是真正的游戏规则改变者。通过利用GraphQL拼接，我们构建了一个健壮的API策略，该策略既可消费又可扩展，并且能够在未来添加额外的微服务。</p><h1 id="7a30" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">信用</h1><p id="ccc5" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我还要感谢<a class="na nb ep" href="https://medium.com/u/3e25da742cf4?source=post_page-----d17922b886eb--------------------------------" rel="noopener" target="_blank">罗崇信</a>推动了这项工作的前期调研和实施。</p></div></div>    
</body>
</html>