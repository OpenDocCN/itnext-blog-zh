<html>
<head>
<title>Terraform with TypeScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带打字稿的地形</h1>
<blockquote>原文：<a href="https://itnext.io/terraform-with-typescript-7643defb4eb1?source=collection_archive---------1-----------------------#2020-11-03">https://itnext.io/terraform-with-typescript-7643defb4eb1?source=collection_archive---------1-----------------------#2020-11-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3f184c153506f6ca28e91a1f04847323.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UrDRTS75acOjUBFR"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">迈克·肯尼利在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="4e57" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">作为代码的基础设施正在慢慢崛起，而且是永久性的。</p><p id="06d4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如今，用流行的手动方法来处理基础架构编排已不再被接受。虽然向云的转变带来了丰富的工具箱，但复杂性也呈指数级增长，因此应该部署一个管理解决方案。</p><p id="4b43" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">过去，运营和基础架构管理一直是一个隐藏的领域，该领域完全局限于少数专家或团队。</p><p id="8971" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从发展的角度来看，这个“<em class="lb">挑战</em>”可以解决吗？</p><p id="6882" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当然了。面对这个问题有很多解决方案。<strong class="kf ir"> Terraform </strong>就是其中之一。</p><p id="4873" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为什么不把开发者纳入范围？</p><p id="77a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们来了。</p><p id="0999" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最近<em class="lb"> Hashicorp </em>为<strong class="kf ir"> CDK </strong>(云开发工具包——仍在开发中)引入了新的语言，支持<strong class="kf ir">类型脚本</strong>、<strong class="kf ir"> Python、</strong>和<strong class="kf ir"> Java </strong>。太神奇了！</p><p id="4c16" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我将重点介绍如何将Terraform与Typescript结合起来，并将基础设施作为代码推向下一个层次。</p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="444c" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">CDKTF</h1><p id="b3fa" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">Hashicorp提供的CDKTF使得用Terraform实用程序及其相关的实现提供程序创建Typescript环境变得简单。</p><p id="dcf2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在撰写本文时，有许多官方提供者和社区提供者，都可以在Typescript生态系统中使用。</p><p id="64b4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">开始使用CDKTF非常容易，它需要地形(&gt; 0.12)和NPM/纱线:</p><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="fa27" class="mv lk iq mr b gy mw mx l my mz">npm install --global cdktf-cli@next</span></pre><p id="c322" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或使用brew:</p><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="5830" class="mv lk iq mr b gy mw mx l my mz">brew install cdktf</span></pre></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="d499" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated"><strong class="ak">使用Terraform创建和部署资源</strong></h1><p id="6e9e" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">多亏了CLI，才有可能创建一个基本的样板文件:</p><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="7362" class="mv lk iq mr b gy mw mx l my mz">mkdir typescript-k8s &amp;&amp; cd $_</span><span id="703c" class="mv lk iq mr b gy na mx l my mz">cdktf init --template=typescript --local</span></pre><p id="280f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">cdktf init 命令正在生成开始所需的文件:</p><ul class=""><li id="1f6f" class="nb nc iq kf b kg kh kk kl ko nd ks ne kw nf la ng nh ni nj bi translated">json:包含cdktf配置，明确说明要使用的提供者(它们可以是官方提供的，也可以是社区提供的——最后一个需要手动安装)。</li><li id="c5f0" class="nb nc iq kf b kg nk kk nl ko nm ks nn kw no la ng nh ni nj bi translated">typescript相关文件:package.json、main.ts等…</li></ul><p id="497a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以做的演示是，将Kubernetes资源简单地部署到一个已经创建的集群中(例如本地类实例)。以下代码重复使用了CDK Github官方页面上的一个官方示例，或者如果你想了解更多，请访问官方页面教程。</p><p id="9e8a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，让我们将Kubernetes提供者添加到我们的cdktf.json中，作为我们的主要提供者(并用样板文件替换这个提供者):</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="6936" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">CDKTF的美妙之处在于，我们可以下载缺少的提供者(列在官方提供者列表中)，并使用下面的命令自动生成类型/实现(也可以作为初始引导):</p><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="0258" class="mv lk iq mr b gy mw mx l my mz">cdktf get</span></pre><p id="8b97" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一个<em class="lb">。gen </em>文件夹被创建，它包含与期望的提供者相关的所有类型/实现。</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/b104766978117c848f6080f44b7834f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:972/format:webp/1*YdnHx4SSU8aURZkfxCl0FQ.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">。带有创建的打字和打字稿文件的gen文件夹</figcaption></figure><p id="81dd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在是编辑“main.ts”的时候了，它包括一个在开始时提供帮助的极简方法:</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="e69d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个示例代码什么也不做，它只是实例化MyStack(它扩展了TerraformStack)并调用“synth”方法，在幕后执行<em class="lb"> init-plan-apply </em>。</p><p id="ee08" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以在集群上部署Nginx控制器(名称空间、部署和相关服务):</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="86c4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">嵌入在main.ts文件中的代码创建了3样东西:</p><ul class=""><li id="789b" class="nb nc iq kf b kg kh kk kl ko nd ks ne kw nf la ng nh ni nj bi translated">将保存我们的资源的名称空间</li><li id="fd26" class="nb nc iq kf b kg nk kk nl ko nm ks nn kw no la ng nh ni nj bi translated">具有指定Nginx映像的部署</li><li id="a259" class="nb nc iq kf b kg nk kk nl ko nm ks nn kw no la ng nh ni nj bi translated">公开Nginx的服务</li></ul><p id="83bd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们想要部署这些资源，让我们调用以下命令:</p><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="1707" class="mv lk iq mr b gy mw mx l my mz">cdktf deploy</span></pre><p id="513d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面您可以看到相关的输出:</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="76e1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们用<em class="lb"> kubectl </em>运行基本命令，比如:</p><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="9ea4" class="mv lk iq mr b gy mw mx l my mz">+ kubectl get namespaces<br/>NAME                 STATUS   AGE<br/>default              Active   3d5h<br/>kube-node-lease      Active   3d5h<br/>kube-public          Active   3d5h<br/>kube-system          Active   3d5h<br/>local-path-storage   Active   3d5h<br/>tf-cdk-nginx         Active   1m<br/></span><span id="c089" class="mv lk iq mr b gy na mx l my mz">+ kubectl get deployments -n tf-cdk-nginx<br/>NAME               READY   UP-TO-DATE   AVAILABLE   AGE<br/>nginx-example-tf   2/2     2            2           1m</span></pre><p id="8092" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一切都已正确创建！</p><p id="8f23" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果愿意，我们甚至可以通过调用以下命令来销毁创建的资源:</p><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="aaab" class="mv lk iq mr b gy mw mx l my mz">cdktf destroy</span></pre><p id="9829" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者，如果我们快疯了，我们可以通过再次执行<em class="lb"> deploy </em>命令来重新部署资源。难以置信！！！</p><p id="fc5f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">多亏了哈希公司提供的这些工具，一个新的世界打开了！</p><h1 id="6a17" class="lj lk iq bd ll lm ns lo lp lq nt ls lt lu nu lw lx ly nv ma mb mc nw me mf mg bi translated">介绍(最后)单元测试</h1><p id="07ee" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">是什么让IaC更加强大？是的，单元测试！</p><p id="205e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，有了Typescript环境，我们可以连接我们喜欢的测试工具。</p><p id="8c49" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这篇文章中(也是我个人的选择)，我推荐<strong class="kf ir"> Jest </strong>！</p><p id="acf9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们开始安装依赖项并设置测试环境:</p><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="9d3c" class="mv lk iq mr b gy mw mx l my mz">npm install --save-dev jest babel-jest <a class="ae kc" href="http://twitter.com/babel/core" rel="noopener ugc nofollow" target="_blank">@babel/core</a> <a class="ae kc" href="http://twitter.com/babel/preset-env" rel="noopener ugc nofollow" target="_blank">@babel/preset-env</a> <a class="ae kc" href="http://twitter.com/babel/preset-typescript" rel="noopener ugc nofollow" target="_blank">@babel/preset-typescript</a> @types/jest</span></pre><p id="2ed7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并创建babel.config.js:</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="d8ee" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了调用测试，我们实际上可以替换package.json中现有的“测试”脚本:</p><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="6161" class="mv lk iq mr b gy mw mx l my mz">{<br/>  "name": "typescript-k8s",<br/>  ...<br/>  "scripts": {<br/>    ...<br/>    "test": "jest",<br/>    ...<br/>  },<br/>  ...<br/>}</span></pre><p id="4ac9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">之后，让我们为集群堆栈添加一个简单的测试，并对我们编写的实际代码进行一些小的重构:</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="43d1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果执行“npm运行测试”,输出如下:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/b0beedea83792b98b2f9fe6ff5845d37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1376/format:webp/1*c7Q77kTh8jqg6cAMUq7Pxg.png"/></div></figure><p id="4eba" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">免责声明:这只是为了演示，可能只是测试配置(这不是一个很酷的做法)。但是，这显示了现在为准备和烘烤所需云资源的逻辑编写一些测试是多么容易。</p><p id="e875" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你想玩它，你可以在<a class="ae kc" href="https://github.com/cdbkr/terraform-typescript-k8s-example" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到这个示例代码库。</p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><p id="723f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最近推出的这些新工具为IaaC的专业人士和热情人士打开了新的视野。</p><p id="df3d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">管理基础设施在过去是一个棘手的问题，将云与开发世界结合起来实际上改善了整体体验。</p><p id="99fe" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我希望你从这篇文章中学到了一些新东西，并随时分享任何反馈。</p><p id="739d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">干杯！！</p></div></div>    
</body>
</html>