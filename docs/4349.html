<html>
<head>
<title>Create Your Own Network Namespace</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">创建您自己的网络名称空间</h1>
<blockquote>原文：<a href="https://itnext.io/create-your-own-network-namespace-90aaebc745d?source=collection_archive---------0-----------------------#2020-06-13">https://itnext.io/create-your-own-network-namespace-90aaebc745d?source=collection_archive---------0-----------------------#2020-06-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/e1fa973dff2137e6fbb7f1c0985deb81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sTlvg-tI42LMrsm5hzKqJQ.png"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">两个不同网络名称空间中的一对veth接口</figcaption></figure><div class=""/><p id="b1f7" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi ld translated"><span class="l le lf lg bm lh li lj lk ll di">如果</span>您一直在使用Docker和Kubernetes等容器虚拟化和编排软件，那么您可能听说过<a class="ae lm" href="https://www.man7.org/linux/man-pages/man8/ip-netns.8.html" rel="noopener ugc nofollow" target="_blank">网络名称空间</a>。</p><p id="623d" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">最近开始探索Linux <code class="fe ln lo lp lq b"><a class="ae lm" href="https://linux.die.net/man/8/ip" rel="noopener ugc nofollow" target="_blank">ip</a></code> <a class="ae lm" href="https://linux.die.net/man/8/ip" rel="noopener ugc nofollow" target="_blank">命令</a>。在本文中，我将向您展示如何使用该命令通过一对<code class="fe ln lo lp lq b"><a class="ae lm" href="https://man7.org/linux/man-pages/man4/veth.4.html" rel="noopener ugc nofollow" target="_blank">veth</a></code>接口连接不同子网中两个不同网络名称空间中的进程。</p><h1 id="2e4c" class="lr ls ji bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">关于网络命名空间</h1><p id="e34f" class="pw-post-body-paragraph kf kg ji kh b ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky mt la lb lc im bi translated">容器运行时使用<a class="ae lm" href="https://www.man7.org/linux/man-pages/man7/namespaces.7.html" rel="noopener ugc nofollow" target="_blank">命名空间</a>内核特性来划分系统资源，以实现某种形式的进程隔离，这样对一个命名空间中的资源的更改不会影响其他命名空间中的资源。此类资源的示例包括进程id、主机名、用户id、文件名和网络接口。</p><p id="3392" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">尤其是网络命名空间虚拟化了网络堆栈。每个网络名称空间都有自己的一组资源，如网络接口、IP地址、路由表、隧道、防火墙等。例如，添加到网络命名空间的<code class="fe ln lo lp lq b">iptables</code>规则只会影响进出该命名空间的流量。</p><h1 id="a84d" class="lr ls ji bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">命令语法</h1><p id="0e55" class="pw-post-body-paragraph kf kg ji kh b ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky mt la lb lc im bi translated">这篇文章剩余部分的一些<code class="fe ln lo lp lq b">ip</code>命令最初看起来可能很复杂。但它们其实很简单。</p><p id="f212" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">一般来说，所有的<code class="fe ln lo lp lq b">ip</code>命令都采用以下形式:</p><figure class="mu mv mw mx gt iv"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">ip命令语法</figcaption></figure><p id="aa04" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">举个例子，</p><ul class=""><li id="3928" class="na nb ji kh b ki kj km kn kq nc ku nd ky ne lc nf ng nh ni bi translated">要添加新的网络接口，请使用<code class="fe ln lo lp lq b">ip link add &lt;interface-name&gt; type &lt;interface-type&gt; &lt;interface-arguments&gt;...</code></li><li id="7f75" class="na nb ji kh b ki nj km nk kq nl ku nm ky nn lc nf ng nh ni bi translated">要为接口(设备)分配新的IP地址范围，请使用<code class="fe ln lo lp lq b">ip addr add &lt;ip-address-range&gt; dev &lt;device-name&gt;</code></li><li id="4ac1" class="na nb ji kh b ki nj km nk kq nl ku nm ky nn lc nf ng nh ni bi translated">要从路由表中删除一个路由条目，使用<code class="fe ln lo lp lq b">ip route del &lt;route-ip-range&gt; dev &lt;device-name&gt;</code></li></ul><p id="4227" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><code class="fe ln lo lp lq b">-n</code>选项可以用来切换目标名称空间。例如，要将10.0.1.0/24 IP地址范围分配给<code class="fe ln lo lp lq b">vnet0</code>网络名称空间中的接口<code class="fe ln lo lp lq b">veth0</code>，请使用<code class="fe ln lo lp lq b">ip -n vnet0 addr add 10.0.1.0/24 dev veth0</code>。</p><blockquote class="no np nq"><p id="1213" class="kf kg nr kh b ki kj kk kl km kn ko kp ns kr ks kt nt kv kw kx nu kz la lb lc im bi translated">💡<code class="fe ln lo lp lq b">-n</code>选项是<code class="fe ln lo lp lq b">ip netns exec</code>的简称。</p></blockquote><h1 id="454a" class="lr ls ji bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">配置第一个网络命名空间</h1><p id="f341" class="pw-post-body-paragraph kf kg ji kh b ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky mt la lb lc im bi translated"><em class="nr">执行所有后续命令需要sudo权限，已经在Ubuntu 16.04.6 LTS上测试。</em></p><p id="2454" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们的第一个任务是使用<code class="fe ln lo lp lq b">ip link add</code>命令创建一对新的<code class="fe ln lo lp lq b">veth</code>接口<code class="fe ln lo lp lq b">veth0</code>和<code class="fe ln lo lp lq b">veth1</code>:</p><figure class="mu mv mw mx gt iv"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">创建一对veth接口</figcaption></figure><p id="f632" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><code class="fe ln lo lp lq b">veth</code>接口通常被创建为互连对，其中在一端传输的数据在另一端被立即接收。这种类型的接口通常在容器运行时用于在不同的网络名称空间之间传输数据包。</p><p id="08d9" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">让我们创建我们的第一个网络名称空间，<code class="fe ln lo lp lq b">vnet0</code>。然后，我们可以将<code class="fe ln lo lp lq b">veth0</code>接口分配给这个网络名称空间，并为其分配10.0.1.0/24 IP地址范围:</p><figure class="mu mv mw mx gt iv"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">创建和配置veth0接口</figcaption></figure><p id="c926" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">如果我们试图从主机和网络名称空间都<code class="fe ln lo lp lq b">ping</code>接口<code class="fe ln lo lp lq b">veth0</code>会发生什么？</p><figure class="mu mv mw mx gt iv"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">Pinging veth0只能在vnet0中使用</figcaption></figure><p id="7728" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">请注意，从主机网络名称空间无法再访问<code class="fe ln lo lp lq b">veth0</code>。</p><p id="091f" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在进入下一步之前，让我们看看上面代码片段中的最后一个<code class="fe ln lo lp lq b">ip netns exec</code>命令。这个命令允许我们在网络命名空间中执行任意命令。</p><p id="795b" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">它由两部分组成:</p><ol class=""><li id="841d" class="na nb ji kh b ki kj km kn kq nc ku nd ky ne lc nv ng nh ni bi translated"><code class="fe ln lo lp lq b">ip netns exec vnet0</code>标识目标网络名称空间</li><li id="3564" class="na nb ji kh b ki nj km nk kq nl ku nm ky nn lc nv ng nh ni bi translated"><code class="fe ln lo lp lq b">ping -c10 10.0.1.0</code>是要在目标名称空间中执行的命令</li></ol><p id="f796" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">稍后我们将看到一个例子，这个命令被用来运行<code class="fe ln lo lp lq b">tcpdump</code>来调试网络名称空间之间的一些路由问题。</p><h1 id="499f" class="lr ls ji bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">配置第二个网络命名空间</h1><p id="9cf0" class="pw-post-body-paragraph kf kg ji kh b ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky mt la lb lc im bi translated">我们将重用上面的命令来创建我们的第二个网络名称空间，<code class="fe ln lo lp lq b">vnet1</code>。然后我们将<code class="fe ln lo lp lq b">veth1</code>接口分配给这个网络名称空间，并将10.0.2.0/24 IP地址范围分配给这个接口:</p><figure class="mu mv mw mx gt iv"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">创建和配置veth1接口</figcaption></figure><p id="f246" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">请注意，我们特意为<code class="fe ln lo lp lq b">veth1</code>使用不同的子网IP范围，以便稍后建立路由调试会话。</p><p id="0c33" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">与<code class="fe ln lo lp lq b">veth0</code>接口类似，<code class="fe ln lo lp lq b">veth1</code>接口不再可以从主机网络名称空间到达。<code class="fe ln lo lp lq b">ping</code>仅适用于<code class="fe ln lo lp lq b">vnet1</code>网络名称空间:</p><figure class="mu mv mw mx gt iv"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">Pniging veth1仅在vnet1中工作</figcaption></figure><h1 id="bcf5" class="lr ls ji bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">配置子网之间的路由</h1><p id="b193" class="pw-post-body-paragraph kf kg ji kh b ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky mt la lb lc im bi ld translated"><span class="l le lf lg bm lh li lj lk ll di"> H </span>然而，我们不能<code class="fe ln lo lp lq b">ping</code>从它们的对等网络名称空间中选择任何一个<code class="fe ln lo lp lq b">veth</code>对😟😟😟…</p><figure class="mu mv mw mx gt iv"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">Ping不能从对等网络命名空间中工作</figcaption></figure><p id="5c9c" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">由于两个接口都是<code class="fe ln lo lp lq b">up</code>，并且<code class="fe ln lo lp lq b">ping</code>在网络名称空间内工作，所以问题很可能与路由有关。</p><p id="218d" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">让我们使用<code class="fe ln lo lp lq b">ip</code>命令进行一些调试！</p><p id="1e7d" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们可以通过使用<code class="fe ln lo lp lq b">ip route get</code>命令来确定数据包采用的路由:</p><figure class="mu mv mw mx gt iv"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">确定数据包将采用的路由</figcaption></figure><p id="a167" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">让我们检查两个网络名称空间中的路由表:</p><figure class="mu mv mw mx gt iv"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">路由表中缺少路由条目</figcaption></figure><p id="2dc5" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">你能发现问题吗？</p><p id="bfcc" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">两个网络名称空间中的路由表仅具有用于它们各自子网IP范围的路由条目。它们没有通往其它子网的路由。我们可以使用<code class="fe ln lo lp lq b">ip route add</code>命令将新的路由条目插入路由表:</p><figure class="mu mv mw mx gt iv"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">使用对等网络的路由条目更新路由表</figcaption></figure><p id="f03e" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">如果我们试图从对等网络名称空间再次与<code class="fe ln lo lp lq b">ping</code>和<code class="fe ln lo lp lq b">veth</code>接口…</p><figure class="mu mv mw mx gt iv"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">对等接口之间的成功pings</figcaption></figure><p id="bb53" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">...有用！！🎉🎉🎉</p><p id="fe57" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们还可以使用<code class="fe ln lo lp lq b">tcpdump</code>来捕获在两个网络名称空间之间传输的数据包:</p><figure class="mu mv mw mx gt iv"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">使用tcpdump捕获vnet0中的ICMP数据包</figcaption></figure><p id="7cae" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">让我们通过测试TCP连接来结束这一部分。</p><p id="a432" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">使用<code class="fe ln lo lp lq b">nc</code>命令在<code class="fe ln lo lp lq b">vnet0</code>名称空间中的端口7096启动一个TCP服务器。然后从<code class="fe ln lo lp lq b">vnet1</code>名称空间发起TCP握手连接:</p><figure class="mu mv mw mx gt iv"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">启动vnet0和vnet1之间的TCP握手连接</figcaption></figure><p id="5997" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">一旦TCP连接建立，我们可以从<code class="fe ln lo lp lq b">vnet1</code>向<code class="fe ln lo lp lq b">vnet0</code>发送一条测试消息:</p><figure class="mu mv mw mx gt iv"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">通过TCP连接发送消息</figcaption></figure><p id="afcb" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们应该看到测试消息出现在<code class="fe ln lo lp lq b">vnet0</code>网络名称空间中。</p><p id="f685" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><code class="fe ln lo lp lq b">tcpdump</code>还将获取在两个网络名称空间之间传输的所有数据包:</p><figure class="mu mv mw mx gt iv"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">使用tcpdump捕获网络名称空间之间的流量</figcaption></figure><h1 id="0420" class="lr ls ji bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">结论</h1><p id="1e21" class="pw-post-body-paragraph kf kg ji kh b ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky mt la lb lc im bi translated">在这篇文章中，我们看了不同的<code class="fe ln lo lp lq b">ip</code>子命令，它们可以用来创建和配置网络名称空间、接口和路由。我们创建了一对<code class="fe ln lo lp lq b">veth</code>接口。这些接口被分配给两个不同的网络名称空间，具有不同的子网IP地址范围。网络命名空间中的路由表配置了额外的路由，以支持两个子网之间的通信。</p><p id="bd99" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">从主机网络命名空间无法访问两个<code class="fe ln lo lp lq b">veth</code>接口。并且对它们的IP地址范围和路由表的更改被隔离到它们自己的网络名称空间。</p><p id="3d60" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们使用<code class="fe ln lo lp lq b">ip netns exec</code>命令运行类似<code class="fe ln lo lp lq b">ping</code>和<code class="fe ln lo lp lq b">tcpdump</code>的工具来调试网络名称空间之间的连接问题。</p><p id="fcd2" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">通过桥接接口将<code class="fe ln lo lp lq b">veth</code>接口连接到主机网络名称空间将是未来文章的内容。</p></div></div>    
</body>
</html>