<html>
<head>
<title>Migration from ASP.NET Core 2.2 to 3.0</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从ASP.NET核心2.2迁移到3.0</h1>
<blockquote>原文：<a href="https://itnext.io/migration-from-asp-net-core-2-2-to-3-0-73954cea8a06?source=collection_archive---------8-----------------------#2019-10-21">https://itnext.io/migration-from-asp-net-core-2-2-to-3-0-73954cea8a06?source=collection_archive---------8-----------------------#2019-10-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="f4e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">9月23日<a class="ae kl" href="https://devblogs.microsoft.com/dotnet/announcing-net-core-3-0/" rel="noopener ugc nofollow" target="_blank">。NET Core 3.0 </a>发布包括【ASP.NET】Core 3.0和<a class="ae kl" href="https://devblogs.microsoft.com/dotnet/announcing-ef-core-3-0-and-ef-6-3-general-availability/" rel="noopener ugc nofollow" target="_blank">实体框架Core 3.0 </a>。这篇文章将采用<a class="ae kl" href="https://elanderson.net/category/asp-net-core/asp-net-core-basics/" rel="noopener ugc nofollow" target="_blank">ASP.NET基础系列</a>中使用的联系人项目，并将其从。NET Core 2.2到。网芯3.0。本次迁移使用的大部分信息来自微软文档，该文档将涵盖比本文更多的场景。</p><p id="b9ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">之前的代码任何改动都可以在这个<a class="ae kl" href="https://github.com/elanderson/ASP.NET-Core-Basics/tree/134c7fbed806a156aaee92aab90ccd05191c8ff3" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>中找到。提醒一下，联系人项目是这篇文章中唯一更新的项目，回购中的项目将暂时保留在ASP.NET核心2.2中。</p><h2 id="033e" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">装置</h2><p id="1f5a" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">如果您是Visual Studio用户，您可以获得。NET Core 3.0通过至少安装<a class="ae kl" href="https://visualstudio.microsoft.com/downloads/" rel="noopener ugc nofollow" target="_blank"> Visual Studio 16.3 </a>。对于不使用Visual Studio的用户，可以下载并安装。网芯3.0 SDK从<a class="ae kl" href="https://dotnet.microsoft.com/download/dotnet-core/3.0" rel="noopener ugc nofollow" target="_blank">这里</a>。与以前的版本一样，SDK适用于Windows、Linux和Mac。</p><p id="e3f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装完成后，您可以在命令提示符下运行以下命令来查看。你已经安装的NET Core SDK。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="53fe" class="km kn iq lp b gy lt lu l lv lw">dotnet --list-sdks</span></pre><p id="334c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您应该会看到列出的<strong class="jp ir"> 3.0.100 </strong>。如果你像我一样，你可能还会看到一些可以卸载的SDK预览版。</p><h2 id="eec4" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">项目文件更改</h2><p id="3e25" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">右键单击项目并选择<strong class="jp ir">编辑项目名称. csproj </strong>。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/d3212671de441e02435e565a8b5ef875.png" data-original-src="https://miro.medium.com/v2/resize:fit:788/format:webp/0*R3qN1HJ03GpXrC7_.png"/></div></figure><p id="8a50" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将<strong class="jp ir"> TargetFramework </strong>改为<strong class="jp ir"> netcoreapp3.0 </strong>。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="8468" class="km kn iq lp b gy lt lu l lv lw">Before: <br/>&lt;TargetFramework&gt;netcoreapp2.2&lt;/TargetFramework&gt; <br/><br/>After: <br/>&lt;TargetFramework&gt;netcoreapp3.0&lt;/TargetFramework&gt;</span></pre><p id="58fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">包装部分有很多变化。微软。AspNetCore.App 现在已经不存在了，是。NET核心，而不需要特定的引用。另一件要注意的事情是，实体框架核心不再是“在盒子里”,所以你会看到增加了许多参考，使实体框架核心可用。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="50d0" class="km kn iq lp b gy lt lu l lv lw">Before:<br/>&lt;PackageReference Include="Microsoft.AspNetCore.App" /&gt;<br/>&lt;PackageReference Include="Microsoft.VisualStudio.Web.CodeGeneration.Design" Version="2.2.0" PrivateAssets="All" /&gt;<br/>&lt;PackageReference Include="Swashbuckle.AspNetCore" Version="4.0.1" /&gt;<br/><br/>After:<br/>&lt;PackageReference Include="Microsoft.EntityFrameworkCore" Version="3.0.0" /&gt;<br/>&lt;PackageReference Include="Microsoft.AspNetCore.Diagnostics.EntityFrameworkCore" Version="3.0.0" /&gt;<br/>&lt;PackageReference Include="Microsoft.AspNetCore.Identity.EntityFrameworkCore" Version="3.0.0" /&gt;<br/>&lt;PackageReference Include="Microsoft.AspNetCore.Identity.UI" Version="3.0.0" /&gt;<br/>&lt;PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="3.0.0" /&gt;<br/>&lt;PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="3.0.0" /&gt;<br/>&lt;PackageReference Include="Microsoft.VisualStudio.Web.CodeGeneration.Design" Version="3.0.0" PrivateAssets="All" /&gt;<br/>&lt;PackageReference Include="Swashbuckle.AspNetCore" Version="5.0.0-rc4" /&gt;</span></pre><p id="12c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后要注意的是Swashbuckle没有为。NET Core 3，所以你必须确保你至少使用版本5 rc2。</p><p id="453f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是我完整的项目文件供参考。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="10ef" class="km kn iq lp b gy lt lu l lv lw">&lt;Project Sdk="Microsoft.NET.Sdk.Web"&gt;<br/><br/>  &lt;PropertyGroup&gt;<br/>    &lt;TargetFramework&gt;netcoreapp3.0&lt;/TargetFramework&gt;<br/>    &lt;AspNetCoreHostingModel&gt;InProcess&lt;/AspNetCoreHostingModel&gt;<br/>    &lt;UserSecretsId&gt;aspnet-Contacts-cd2c7b27-e79c-43c7-b3ef-1ecb04374b70&lt;/UserSecretsId&gt;<br/>  &lt;/PropertyGroup&gt;<br/><br/>  &lt;ItemGroup&gt;<br/>    &lt;PackageReference Include="Microsoft.EntityFrameworkCore" Version="3.0.0" /&gt;<br/>    &lt;PackageReference Include="Microsoft.AspNetCore.Diagnostics.EntityFrameworkCore" Version="3.0.0" /&gt;<br/>    &lt;PackageReference Include="Microsoft.AspNetCore.Identity.EntityFrameworkCore" Version="3.0.0" /&gt;<br/>    &lt;PackageReference Include="Microsoft.AspNetCore.Identity.UI" Version="3.0.0" /&gt;<br/>    &lt;PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="3.0.0" /&gt;<br/>    &lt;PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="3.0.0" /&gt;<br/>    &lt;PackageReference Include="Microsoft.VisualStudio.Web.CodeGeneration.Design" Version="3.0.0" PrivateAssets="All" /&gt;<br/>    &lt;PackageReference Include="Swashbuckle.AspNetCore" Version="5.0.0-rc4" /&gt;<br/>  &lt;/ItemGroup&gt;<br/><br/>&lt;/Project&gt;</span></pre><h2 id="7a80" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">程序变更</h2><p id="3475" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">在<strong class="jp ir"> Program.cs </strong>中，主机的构造方式发生了一些变化。这个版本可能有用，也可能没用，但是我创建了一个新的应用程序，并把它取出来，以确保我使用的是当前的设置。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="f875" class="km kn iq lp b gy lt lu l lv lw">using Microsoft.AspNetCore.Hosting;<br/>using Microsoft.Extensions.Hosting;<br/><br/>namespace Contacts<br/>{<br/>    public class Program<br/>    {<br/>        public static void Main(string[] args)<br/>        {<br/>            CreateHostBuilder(args).Build().Run();<br/>        }<br/><br/>        public static IHostBuilder CreateHostBuilder(string[] args) =&gt;<br/>            Host.CreateDefaultBuilder(args)<br/>                .ConfigureWebHostDefaults(webBuilder =&gt;<br/>                                          {<br/>                                              webBuilder.UseStartup&lt;Startup&gt;();<br/>                                          });<br/>    }<br/>}</span></pre><h2 id="1906" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">启动更改</h2><p id="2fb0" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">在<strong class="jp ir"> Startup.cs </strong>中，我们有相当多的变化要做。只要您没有在构造函数中做任何定制，您就可以用下面的代码替换它。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="3240" class="km kn iq lp b gy lt lu l lv lw">public Startup(IConfiguration configuration)<br/>{<br/>    Configuration = configuration;<br/>}</span></pre><p id="f335" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，他们输入从<strong class="jp ir"> IConfigurationRoot </strong>更改为<strong class="jp ir"> IConfiguration </strong>的配置属性。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="7a41" class="km kn iq lp b gy lt lu l lv lw">Before:<br/>public IConfigurationRoot Configuration { get; }<br/><br/>After:<br/>public IConfiguration Configuration { get; }</span></pre><p id="103e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">转到<strong class="jp ir"> ConfigureServices </strong>函数，需要做一些更改。第一个是更新到Swagger包的新版本的结果，其中的<strong class="jp ir"> Info </strong>类已经被替换为<strong class="jp ir"> OpenApiInfo </strong>。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="ee04" class="km kn iq lp b gy lt lu l lv lw">Before:<br/>services.AddSwaggerGen(c =&gt;<br/>{<br/>    c.SwaggerDoc("v1", new Info { Title = "Contacts API", Version = "v1"});<br/>});<br/><br/>After:<br/>services.AddSwaggerGen(c =&gt;<br/>{<br/>    c.SwaggerDoc("v1",  new OpenApiInfo { Title = "Contacts API", Version = "v1" })<br/>});</span></pre><p id="47dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们将从使用<strong class="jp ir"> UserMvc </strong>转移到新的<strong class="jp ir">AddControllersWithViews</strong>，这是一种新的更有针对性的方法，可以添加您需要的框架。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="650c" class="km kn iq lp b gy lt lu l lv lw">Before:<br/>services.AddMvc().SetCompatibilityVersion(CompatibilityVersion.Version_2_2);<br/><br/>After:<br/>services.AddControllersWithViews();</span></pre><p id="1343" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，在<strong class="jp ir">配置</strong>功能中，需要更新功能签名并删除日志工厂位。如果你确实需要<a class="ae kl" href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/logging/?view=aspnetcore-3.0" rel="noopener ugc nofollow" target="_blank">配置日志</a>，那应该作为<strong class="jp ir"> HostBuilder </strong>的一部分来处理。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="544b" class="km kn iq lp b gy lt lu l lv lw">Before:<br/>public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory)<br/>{<br/>    loggerFactory.AddConsole(Configuration.GetSection("Logging"));<br/>    loggerFactory.AddDebug();<br/><br/>After:<br/>public void Configure(IApplicationBuilder app, IWebHostEnvironment env)<br/>{</span></pre><p id="ccc9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于下一组更改，我将只显示结果，而不是之前的结果。如果您想要使用新的端点路由功能，则<strong class="jp ir"> UseCors </strong>可能适用也可能不适用，但添加<strong class="jp ir"> UserRouting </strong>并用<strong class="jp ir"> UserEndpoint </strong>替换<strong class="jp ir"> UseMvc </strong>将适用。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="25fb" class="km kn iq lp b gy lt lu l lv lw">app.UseStaticFiles();<br/>app.UseRouting();<br/><br/>app.UseCors(builder =&gt;<br/>            {<br/>                builder.AllowAnyHeader();<br/>                builder.AllowAnyMethod();<br/>                builder.AllowAnyOrigin();<br/>            }<br/>           );<br/><br/>app.UseAuthentication();<br/>app.UseAuthorization();<br/><br/>app.UseEndpoints(endpoints =&gt;<br/>                 {<br/>                     endpoints.MapControllerRoute(<br/>                                                  name: "default",<br/>                                                  pattern: "{controller=Home}/{action=Index}/{id?}");<br/>                     endpoints.MapRazorPages();<br/>                 });</span></pre><h2 id="0dad" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">其他杂项变化</h2><p id="b3ba" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">我做的另一个改变是删除了一些与登录相关的cshtml文件中的<code class="fe mb mc md lp b">@using Microsoft.AspNetCore.Http.Authentication</code>。</p><h2 id="46db" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">包扎</h2><p id="21ee" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">从2.2到3.0的迁移比从2.1到2.2的迁移要复杂一些，但这并不奇怪这个版本中的所有变化。记得查看<a class="ae kl" href="https://docs.microsoft.com/en-us/aspnet/core/migration/22-to-30?view=aspnetcore-3.0" rel="noopener ugc nofollow" target="_blank">官方迁移指南</a>了解更多详情。</p><p id="751c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上述变更后的联系人项目代码可以在<a class="ae kl" href="https://github.com/elanderson/ASP.NET-Core-Basics/tree/1366a31de3604f5146f9fbab6b8768a45b021cd4" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。</p></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><p id="14bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ml">原载于</em><a class="ae kl" href="https://elanderson.net/2019/10/migration-from-asp-net-core-2-2-to-3-0/" rel="noopener ugc nofollow" target="_blank"><em class="ml"/></a><em class="ml">。</em></p></div></div>    
</body>
</html>