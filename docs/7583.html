<html>
<head>
<title>Observability strategies to not overload engineering teams — OpenTelemetry Strategy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">不使工程团队超负荷的可观测性策略——开放式遥测策略</h1>
<blockquote>原文：<a href="https://itnext.io/observability-strategies-to-not-overload-engineering-teams-opentelemetry-strategy-d064b806435c?source=collection_archive---------0-----------------------#2022-11-15">https://itnext.io/observability-strategies-to-not-overload-engineering-teams-opentelemetry-strategy-d064b806435c?source=collection_archive---------0-----------------------#2022-11-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="995c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated"><strong class="ak"> OpenTelemetry </strong>提供了将可观测性数据大众化的能力，并赋予工程团队力量。</h2></div><p id="8759" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我在第一篇博文中提到的策略之一<a class="ae lb" rel="noopener ugc nofollow" target="_blank" href="/observability-strategies-to-not-overload-engineering-teams-b2b53cc2b22f">不使工程团队超负荷的可观测性策略</a>，是利用open telemetry auto instrumentation方法，帮助我们在不需要工程努力的情况下实现可观测性。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/68f00f3c1c8c2066c8ed2f39851e4c51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2mW0uOb2uoEw5Q0f.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">OpenTelemetry徽标</figcaption></figure><p id="986b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">今天，我将向您展示如何在不修改代码的情况下从python服务中收集指标和跟踪。</p><p id="4f88" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="ls">为了保持内容的整洁，我将保留一些设置，如Prometheus配置文件。</em></p><h2 id="9e98" class="lt lu iq bd lv lw lx dn ly lz ma dp mb ko mc md me ks mf mg mh kw mi mj mk ml bi translated">什么是开放式遥测自动仪器</h2><p id="56da" class="pw-post-body-paragraph kf kg iq kh b ki mm jr kk kl mn ju kn ko mo kq kr ks mp ku kv kw mq ky kz la ij bi translated">OpenTelemetry提供了一个自动插装特性，旨在充当一个从非插装应用程序收集遥测数据的代理。</p><p id="8c7e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是大多数O11y供应商(如New Relic和Data Dog)收集遥测数据并将其推送到他们的平台的做法，这是一个有价值的功能，因为工程团队可以通过零仪器工作实现可观测性。</p><h2 id="9afa" class="lt lu iq bd lv lw lx dn ly lz ma dp mb ko mc md me ks mf mg mh kw mi mj mk ml bi translated">演示应用程序</h2><p id="411f" class="pw-post-body-paragraph kf kg iq kh b ki mm jr kk kl mn ju kn ko mo kq kr ks mp ku kv kw mq ky kz la ij bi translated">为了帮助我们理解auto instrument如何工作，我创建了以下简单的python服务。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi mr"><img src="../Images/47443a4b781e811eb8e7d81bd19c16ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LeKpiBmU8LeU9f25663zVw.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated"><a class="ae lb" href="https://carbon.now.sh/" rel="noopener ugc nofollow" target="_blank"> Python服务</a></figcaption></figure><p id="28b2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> Docker图像</strong></p><p id="d658" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个Docker映像具有所有必需的依赖项，包括OpenTelemetry自动仪器包。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi ms"><img src="../Images/8d93c592c353eb0d6e80967d13802ae0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JU6XE-QnitdZLizOw-nGUA.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated"><a class="ae lb" href="https://carbon.now.sh/" rel="noopener ugc nofollow" target="_blank"> Dockerfile </a></figcaption></figure><p id="40be" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们继续之前，我想强调一下<code class="fe mt mu mv mw b">cmd</code>条目，我们用<code class="fe mt mu mv mw b">opentelemetry-instrument</code>命令修饰了<code class="fe mt mu mv mw b">python server.py</code>命令，这是要做的自动仪器工作，我们不需要改变应用程序端的任何东西来收集遥测数据。</p><h2 id="a31a" class="lt lu iq bd lv lw lx dn ly lz ma dp mb ko mc md me ks mf mg mh kw mi mj mk ml bi translated">服务基础设施</h2><p id="545e" class="pw-post-body-paragraph kf kg iq kh b ki mm jr kk kl mn ju kn ko mo kq kr ks mp ku kv kw mq ky kz la ij bi translated">使用下面的配置，让我们构建上面创建的docker映像。</p><p id="b297" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mt mu mv mw b">opentelemetry-instrument</code>接受几个标志或环境变量，允许您配置协议和属性，有关可用环境变量的更多信息，请查看<a class="ae lb" href="https://opentelemetry.io/docs/reference/specification/sdk-environment-variables/" rel="noopener ugc nofollow" target="_blank">此</a>链接。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi mx"><img src="../Images/f6afaa8a5657580bd19296405ee2ce6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qQdttQ2VINIsx8Xw1jV7zg.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated"><a class="ae lb" href="https://carbon.now.sh/" rel="noopener ugc nofollow" target="_blank">服务docker-compose </a></figcaption></figure><p id="a0b0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">上面，我们配置跟踪导出器使用<code class="fe mt mu mv mw b">otel</code>格式，设置将出现在跟踪上的服务名为<code class="fe mt mu mv mw b">server</code>，并提供<code class="fe mt mu mv mw b">opentelemetry-collector</code>端点。</p><h2 id="17a8" class="lt lu iq bd lv lw lx dn ly lz ma dp mb ko mc md me ks mf mg mh kw mi mj mk ml bi translated">可观测性基础设施</h2><p id="4f53" class="pw-post-body-paragraph kf kg iq kh b ki mm jr kk kl mn ju kn ko mo kq kr ks mp ku kv kw mq ky kz la ij bi translated">现在让我们添加构建块来提供可观察性工具基础设施。</p><p id="6a8f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">打开遥测采集器</strong></p><p id="b5b2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Opentelemetry collector是一个组件，它将接收、处理python应用程序生成的遥测数据，并将其导出到后端，如<strong class="kh ir"> Prometheus </strong>和<strong class="kh ir"> Jaeger。</strong></p><p id="81fc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">打开遥测采集器配置</strong></p><p id="fa98" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面的配置将接收应用程序产生的轨迹，然后处理所有跨度以将其导出到jaeger。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi my"><img src="../Images/413612e1def9731171dff5e5ac2219cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bN2kHTy1htaVJ_kVzQgLiw.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated"><a class="ae lb" href="https://carbon.now.sh/" rel="noopener ugc nofollow" target="_blank">打开遥测采集器配置</a></figcaption></figure><p id="0fed" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于所有跨度都通过收集器，我们可以利用一个名为<code class="fe mt mu mv mw b">spanmetrics</code>的处理器，该处理器使用Prometheus标准公开关于调用数量和每个操作延迟的指标。</p><p id="925f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这种方法有助于我们根据跨度生成指标，并获得两种不同的现成遥测数据。</p><p id="f17c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">Docker-撰写文件</strong></p><p id="0aa8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们有了开放式遥测收集器配置，我们可以使用以下配置启动Jaeger和Prometheus</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi mz"><img src="../Images/603cfc9ce447c2d067af2d747fe07159.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QeKM4hSn9r_IabEd67WudA.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated"><a class="ae lb" href="https://carbon.now.sh/?bg=rgba%28171%2C184%2C195%2C0%29&amp;t=one-dark&amp;wt=none&amp;l=application%2Fjson&amp;width=680&amp;ds=false&amp;dsyoff=20px&amp;dsblur=68px&amp;wc=true&amp;wa=true&amp;pv=56px&amp;ph=56px&amp;ln=false&amp;fl=1&amp;fm=Hack&amp;fs=14px&amp;lh=133%25&amp;si=false&amp;es=2x&amp;wm=false" rel="noopener ugc nofollow" target="_blank"> docker-compose.yaml </a></figcaption></figure><p id="576d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我只想强调jaeger服务中的环境变量，因为我们在OpenTelemetry Collector上激活了<code class="fe mt mu mv mw b">spanmetrics</code>处理器，我们可以利用jaeger的SPM功能，有关更多信息，请查看<a class="ae lb" href="https://www.jaegertracing.io/docs/1.39/spm/" rel="noopener ugc nofollow" target="_blank">此</a>链接。</p><h2 id="f06a" class="lt lu iq bd lv lw lx dn ly lz ma dp mb ko mc md me ks mf mg mh kw mi mj mk ml bi translated">最后的结果</h2><p id="ffc0" class="pw-post-body-paragraph kf kg iq kh b ki mm jr kk kl mn ju kn ko mo kq kr ks mp ku kv kw mq ky kz la ij bi translated">是时候看结果了；所有这些配置将支持我们收集遥测数据，这些数据将有助于整个公司开始采用可观测性，而无需工程努力。</p><h2 id="1089" class="lt lu iq bd lv lw lx dn ly lz ma dp mb ko mc md me ks mf mg mh kw mi mj mk ml bi translated">HTTP负载测试</h2><p id="42a4" class="pw-post-body-paragraph kf kg iq kh b ki mm jr kk kl mn ju kn ko mo kq kr ks mp ku kv kw mq ky kz la ij bi translated">为了正确查看遥测数据，我将使用<a class="ae lb" href="https://github.com/tsenart/vegeta" rel="noopener ugc nofollow" target="_blank">贝吉塔</a>在服务上创建一个小负载。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi na"><img src="../Images/239d7d46626ec82cd891ae91ed11a6a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i_QNQ3ccZXVrgbpr2bzXJA.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated"><a class="ae lb" href="https://carbon.now.sh/" rel="noopener ugc nofollow" target="_blank"> HTTP负载测试</a></figcaption></figure><p id="da19" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">耶格追踪</strong></p><p id="e0e2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Tracing视图中，我们可以跟踪整个平台上的请求流，并收集有用的数据来帮助团队理解性能问题以及复杂的分布式体系结构。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nb"><img src="../Images/5bce08cd88c0affeb107b0f99779f37b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*60iju32l63f5iTHj0BgNJA.png"/></div></div></figure><p id="f86b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">积家SPM </strong></p><p id="9f5c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Jaeger Service Performance Monitor提供了请求率、错误率和持续时间(P95、P75和P50)的服务级汇总和服务内的操作级汇总，也称为红色指标。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nb"><img src="../Images/2bfbedae23a168c670aba17bbf3db093.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8OacjYQk5IyF8VijK874Vg.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">耶格SPM</figcaption></figure><p id="052d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该选项卡由Opentelemetry collector上的span metrics处理器创建的信息填充，这在Prometheus中也是可用的，如下所示。</p><p id="01f3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">普罗米修斯指标</strong></p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nb"><img src="../Images/88f7c3a16d0293ec651ae2d57871d40d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DktlGMqBkqMBCmQCeEjkpg.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">普罗米修斯UI</figcaption></figure><p id="f6d7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如上所述，<code class="fe mt mu mv mw b">spanmetrics</code>处理器创建两个度量，例如<code class="fe mt mu mv mw b">calls_total</code>和<code class="fe mt mu mv mw b">latency_bucket</code></p><h2 id="9efb" class="lt lu iq bd lv lw lx dn ly lz ma dp mb ko mc md me ks mf mg mh kw mi mj mk ml bi translated">结论</h2><p id="f99b" class="pw-post-body-paragraph kf kg iq kh b ki mm jr kk kl mn ju kn ko mo kq kr ks mp ku kv kw mq ky kz la ij bi translated">这是一个非常简单的例子，主要思想是提供关于使用open telemetry auto instrumentation可以收集什么类型的遥测数据的见解。</p><p id="1111" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我的<a class="ae lb" href="https://github.com/nicolastakashi/o11y-strategies-medium" rel="noopener ugc nofollow" target="_blank"> GitHub账户</a>上有该代码，您可以通过在您的本地环境中运行它来随意查看和探索它。</p><p id="5d01" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我知道你是否正在利用你的公司来收集遥测数据或打算使用它。</p><p id="b50f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">谢谢😃</p></div></div>    
</body>
</html>