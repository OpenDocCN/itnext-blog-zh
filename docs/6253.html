<html>
<head>
<title>Kubernetes: Helm — “x509: certificate signed by unknown authority”, and ServiceAccount for Pod</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">kubernetes:Helm—“x509:由未知机构签署的证书”，以及Pod的服务帐户</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-helm-x509-certificate-signed-by-unknown-authority-and-serviceaccount-for-pod-900f70638c32?source=collection_archive---------4-----------------------#2021-09-29">https://itnext.io/kubernetes-helm-x509-certificate-signed-by-unknown-authority-and-serviceaccount-for-pod-900f70638c32?source=collection_archive---------4-----------------------#2021-09-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/48ab6731fc89f28452dfdf73d5fe5ec8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5-LJw8RG96qMMxPZeKcV5w.png"/></div></div></figure><p id="1888" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们的AWS Elastic Kubernetes服务集群中有Github runners，用于构建Docker映像，并通过Helm或ArgoCD部署它们。</p><p id="1403" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Github runner的Pod中第一次运行<code class="fe kw kx ky kz b">helm install</code>时，我们得到了“<strong class="ka ir"> <em class="la"> x509:由未知机构</em> </strong>签署的证书”错误:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="1eac" class="lj lk iq kz b gy ll lm l ln lo">$ helm --kube-apiserver=https://kubernetes.default.svc.cluster.local list<br/>Error: Kubernetes cluster unreachable: Get “https://kubernetes.default.svc.cluster.local/version?timeout=32s": x509: certificate signed by unknown authority</span></pre><p id="bdfa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者，如果没有设置API URL，那么我们可以看到一个权限错误:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="5563" class="lj lk iq kz b gy ll lm l ln lo">$ helm list<br/>Error: list: failed to list: secrets is forbidden: User “system:serviceaccount:dev-1–18-backend-github-runners-helm-ns:default” cannot list resource “secrets” in API group “” in the namespace “dev-1–18-backend-github-runners-helm-ns”</span></pre><p id="b1ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以，原因很明显:Pod中的Helm试图使用Github runner部署期间创建的<em class="la">默认</em> ServiceAccount访问Kubernetes API服务器。</p><h1 id="4e74" class="lp lk iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">检查服务帐户的权限</h1><p id="c0da" class="pw-post-body-paragraph jy jz iq ka b kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">正如在<a class="ae mr" href="https://rtfm.co.ua/en/kubernetes-serviceaccounts-jwt-tokens-authentication-and-rbac-authorization/" rel="noopener ugc nofollow" target="_blank"> Kubernetes: ServiceAccounts，JWT令牌，认证和RBAC授权</a>帖子中已经讨论过的，要在API服务器上进行认证，我们需要有它的认证中心密钥和令牌。</p><p id="5913" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">连接到pod:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="e727" class="lj lk iq kz b gy ll lm l ln lo">$ kubectl -n dev-1–18-backend-github-runners-helm-ns exec -ti actions-runner-deployment-7f78968949-tmrtt bash<br/>Defaulting container name to runner.<br/>Use ‘kubectl describe pod/actions-runner-deployment-7f78968949-tmrtt -n dev-1–18-backend-github-runners-helm-ns’ to see all of the containers in this pod.<br/>root@actions-runner-deployment-7f78968949-tmrtt:/actions-runner#</span></pre><p id="719b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">设置变量:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="5ec9" class="lj lk iq kz b gy ll lm l ln lo">root@actions-runner-deployment-7f78968949-tmrtt:/actions-runner# CA_CERT=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><span id="4f3f" class="lj lk iq kz b gy ms lm l ln lo">root@actions-runner-deployment-7f78968949-tmrtt:/actions-runner# TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)</span><span id="4ca5" class="lj lk iq kz b gy ms lm l ln lo">root@actions-runner-deployment-7f78968949-tmrtt:/actions-runner# NAMESPACE=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)</span></pre><p id="0ed0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在尝试访问API:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="2ca8" class="lj lk iq kz b gy ll lm l ln lo">root@actions-runner-deployment-7f78968949-tmrtt:/actions-runner# curl -s — cacert $CA_CERT -H “Authorization: Bearer $TOKEN” “https://kubernetes.default.svc.cluster.local/api/v1/namespaces/$NAMESPACE/pods" | jq ‘{message, code}’<br/>{<br/>“message”: “pods is forbidden: User \”system:serviceaccount:dev-1–18-backend-github-runners-helm-ns:default\” cannot list resource \”pods\” in API group \”\” in the namespace \”dev-1–18-backend-github-runners-helm-ns\””,<br/>“code”: 403<br/>}</span></pre><p id="806a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果尝试运行<code class="fe kw kx ky kz b">kubectl get pod</code>，您会得到类似的错误:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="a57a" class="lj lk iq kz b gy ll lm l ln lo">root@actions-runner-deployment-7f78968949-tmrtt:/actions-runner# kubectl get pod<br/>Error from server (Forbidden): pods is forbidden: User “system:serviceaccount:dev-1–18-backend-github-runners-helm-ns:default” cannot list resource “pods” in API group “” in the namespace “dev-1–18-backend-github-runners-helm-ns”</span></pre><p id="a86a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好吧，我们能做什么呢？</p><h1 id="fe53" class="lp lk iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">为Kubernetes Pod创建Kubernetes服务帐户</h1><p id="fe19" class="pw-post-body-paragraph jy jz iq ka b kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">实际上，我们可以使用Kubernetes RBAC角色和Kubernetes RBAC角色绑定来创建自己的权限集，而不是将默认的ServiceAccount安装到pod。</p><h2 id="e616" class="lj lk iq bd lq mt mu dn lu mv mw dp ly kj mx my mc kn mz na mg kr nb nc mk nd bi translated">创建RBAC角色</h2><p id="785f" class="pw-post-body-paragraph jy jz iq ka b kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">我们可以使用此处列表中的预定义角色— <a class="ae mr" href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#user-facing-roles" rel="noopener ugc nofollow" target="_blank">面向用户的角色</a>，例如<em class="la">集群管理</em>:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="717f" class="lj lk iq kz b gy ll lm l ln lo">$ kubectl get clusterrole cluster-admin<br/>NAME CREATED AT<br/>cluster-admin 2020–11–27T14:44:52Z</span></pre><p id="5689" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者，我们可以自己写，有严格的限制。例如，让我们授予对<em class="la">资源</em> <code class="fe kw kx ky kz b">pod</code>的<em class="la">动词</em> <code class="fe kw kx ky kz b">get</code>和<code class="fe kw kx ky kz b">list</code>的访问权:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="94e4" class="lj lk iq kz b gy ll lm l ln lo">kind: Role<br/>apiVersion: rbac.authorization.k8s.io/v1beta1<br/>metadata:<br/>   name: "github-runner-deployer-role"<br/>rules:<br/> - apiGroups: [""]<br/>   resources: ["pods"]<br/>   verbs: ["get", "list"]</span></pre><p id="10f4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在必要的Kubernetes名称空间中创建角色:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="357a" class="lj lk iq kz b gy ll lm l ln lo">$ kubectl -n dev-1–18-backend-github-runners-helm-ns apply -f github-runner-deployer-role.yaml<br/>role.rbac.authorization.k8s.io/github-runner-deployer-role created</span></pre><p id="daab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查一下:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="9e87" class="lj lk iq kz b gy ll lm l ln lo">$ kubectl -n dev-1–18-backend-github-runners-helm-ns get role<br/>NAME CREATED AT<br/>github-runner-deployer-role 2021–09–28T08:05:20Z</span></pre><h2 id="5b34" class="lj lk iq bd lq mt mu dn lu mv mw dp ly kj mx my mc kn mz na mg kr nb nc mk nd bi translated">创建服务帐户</h2><p id="040e" class="pw-post-body-paragraph jy jz iq ka b kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">接下来，在同一个命名空间中创建一个新的ServiceAccount:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="c06a" class="lj lk iq kz b gy ll lm l ln lo">apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: "github-runner-deployer-sa"</span></pre><p id="1669" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">应用它:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="416c" class="lj lk iq kz b gy ll lm l ln lo">$ kubectl -n dev-1–18-backend-github-runners-helm-ns apply -f github-runner-deployer-sa.yaml</span></pre><h2 id="b8b8" class="lj lk iq bd lq mt mu dn lu mv mw dp ly kj mx my mc kn mz na mg kr nb nc mk nd bi translated">创建角色绑定</h2><p id="7c9e" class="pw-post-body-paragraph jy jz iq ka b kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">现在，我们需要创建一个<em class="la">绑定</em>——这个ServiceAccount和上面创建的角色之间的连接。</p><p id="2271" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建角色绑定:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="581c" class="lj lk iq kz b gy ll lm l ln lo">kind: RoleBinding<br/>apiVersion: rbac.authorization.k8s.io/v1beta1<br/>metadata:<br/>   name: "github-runner-deployer-rolebinding"<br/>subjects:<br/> - kind: ServiceAccount<br/>   name: "github-runner-deployer-sa"<br/>   namespace: "dev-1-18-backend-github-runners-helm-ns"<br/>roleRef:<br/>   kind: Role<br/>   name: "github-runner-deployer-role"<br/>   apiGroup: rbac.authorization.k8s.io</span></pre><p id="7744" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">应用它:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="d0ff" class="lj lk iq kz b gy ll lm l ln lo">$ kubectl -n dev-1–18-backend-github-runners-helm-ns apply -f github-runner-deployer-rolebinding.yaml<br/>rolebinding.rbac.authorization.k8s.io/github-runner-deployer-rolebinding created</span></pre><h2 id="bde1" class="lj lk iq bd lq mt mu dn lu mv mw dp ly kj mx my mc kn mz na mg kr nb nc mk nd bi translated">将服务帐户安装到Kubernetes Pod</h2><p id="5d3c" class="pw-post-body-paragraph jy jz iq ka b kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">最后一件事是将这个服务帐户附加到我们的pod上。</p><p id="da1a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，让我们手动进行检查，无需部署:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="4770" class="lj lk iq kz b gy ll lm l ln lo">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  name: "github-runners-deployer-pod"<br/>spec:<br/>  containers:<br/>    - name: "github-runners-deployer"<br/>      image: "nginx"<br/>      ports:<br/>        - name: "web"<br/>          containerPort: 80<br/>          protocol: TCP<br/>  serviceAccountName: "github-runner-deployer-sa"</span></pre><p id="7f9f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建此窗格:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="b4b5" class="lj lk iq kz b gy ll lm l ln lo">$ kubectl -n dev-1–18-backend-github-runners-helm-ns apply -f github-runner-deployer-pod.yaml<br/>pod/github-runners-deployer-pod created</span></pre><p id="a2b6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">连接到它:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="93e2" class="lj lk iq kz b gy ll lm l ln lo">$ kubectl -n dev-1–18-backend-github-runners-helm-ns exec -ti github-runners-deployer-pod bash<br/>root@github-runners-deployer-pod:/#</span></pre><p id="360c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并检查API访问:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="9670" class="lj lk iq kz b gy ll lm l ln lo">root@github-runners-deployer-pod:/# CA_CERT=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><span id="1216" class="lj lk iq kz b gy ms lm l ln lo">root@github-runners-deployer-pod:/# TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)</span><span id="f544" class="lj lk iq kz b gy ms lm l ln lo">root@github-runners-deployer-pod:/# NAMESPACE=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)</span><span id="71fa" class="lj lk iq kz b gy ms lm l ln lo"><br/>root@github-runners-deployer-pod:/# curl -s --cacert $CA_CERT -H “Authorization: Bearer $TOKEN” “https://kubernetes.default.svc.cluster.local/api/v1/namespaces/$NAMESPACE/pods"<br/>{<br/>“kind”: “PodList”,<br/>“apiVersion”: “v1”,<br/>“metadata”: {<br/>“selfLink”: “/api/v1/namespaces/dev-1–18-backend-github-runners-helm-ns/pods”,<br/>“resourceVersion”: “251020450”<br/>},<br/>“items”: [<br/>{<br/>“metadata”: {<br/>“name”: “actions-runner-deployment-7f78968949-jsh6l”,<br/>“generateName”: “actions-runner-deployment-7f78968949-”,<br/>“namespace”: “dev-1–18-backend-github-runners-helm-ns”,<br/>…</span></pre><p id="0f4d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们可以对pod使用<code class="fe kw kx ky kz b">get</code>和<code class="fe kw kx ky kz b">list</code>，但不能对秘密使用，因为我们没有添加这个权限:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="e6eb" class="lj lk iq kz b gy ll lm l ln lo">root@github-runners-deployer-pod:/# curl -s — cacert $CA_CERT -H “Authorization: Bearer $TOKEN” “https://kubernetes.default.svc.cluster.local/api/v1/namespaces/$NAMESPACE/secrets"<br/>{<br/>“kind”: “Status”,<br/>“apiVersion”: “v1”,<br/>“metadata”: {<br/>},<br/>“status”: “Failure”,<br/>“message”: “secrets is forbidden: User \”system:serviceaccount:dev-1–18-backend-github-runners-helm-ns:github-runner-deployer-sa\” cannot list resource \”secrets\” in API group \”\” in the namespace \”dev-1–18-backend-github-runners-helm-ns\””,<br/>…</span></pre><h1 id="581e" class="lp lk iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">Helm服务帐户</h1><p id="9478" class="pw-post-body-paragraph jy jz iq ka b kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">让我们回到Github Runners和helm那里。</p><p id="b44a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，由于这个舵将用于在EKS集群中的任何地方部署任何东西，我们可以通过使用<em class="la">cluster-admin</em>cluster role授予它管理员访问权限。</p><p id="8670" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">删除之前创建的RoleBinding:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="9ff0" class="lj lk iq kz b gy ll lm l ln lo">$ kubectl -n dev-1–18-backend-github-runners-helm-ns delete rolebinding github-runner-deployer-rolebinding<br/>rolebinding.rbac.authorization.k8s.io “github-runner-deployer-rolebinding” deleted</span></pre><p id="7d6d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个新的，但是此时通过使用ClusterRoleBinding <code class="fe kw kx ky kz b">type</code>来授予对整个集群的访问权:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="7082" class="lj lk iq kz b gy ll lm l ln lo">kind: ClusterRoleBinding<br/>apiVersion: rbac.authorization.k8s.io/v1beta1<br/>metadata:<br/>   name: "github-runner-deployer-cluster-rolebinding"<br/>subjects:<br/> - kind: ServiceAccount<br/>   name: "github-runner-deployer-sa"<br/>   namespace: "dev-1-18-backend-github-runners-helm-ns"<br/>roleRef:<br/>   kind: ClusterRole<br/>   name: "cluster-admin"<br/>   apiGroup: rbac.authorization.k8s.io</span></pre><p id="ecac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将此服务帐户附加到此群集角色:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="b750" class="lj lk iq kz b gy ll lm l ln lo">$ kubectl -n dev-1–18-backend-github-runners-helm-ns apply -f github-runner-deployer-clusterrolebinding.yaml<br/>clusterrolebinding.rbac.authorization.k8s.io/github-runner-deployer-rolebinding created</span></pre><p id="f2e2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">回到舱里去，现在试着获取一个库本内特的秘密:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="d84c" class="lj lk iq kz b gy ll lm l ln lo">root@github-runners-deployer-pod:/# curl -s --cacert $CA_CERT -H “Authorization: Bearer $TOKEN” “https://kubernetes.default.svc.cluster.local/api/v1/namespaces/$NAMESPACE/secrets"<br/>{<br/>“kind”: “SecretList”,<br/>“apiVersion”: “v1”,<br/>“metadata”: {<br/>“selfLink”: “/api/v1/namespaces/dev-1–18-backend-github-runners-helm-ns/secrets”,<br/>“resourceVersion”: “251027845”<br/>},<br/>“items”: [<br/>{<br/>“metadata”: {<br/>“name”: “bttrm-docker-secret”,<br/>“namespace”: “dev-1–18-backend-github-runners-helm-ns”,<br/>“selfLink”: “/api/v1/namespaces/dev-1–18-backend-github-runners-helm-ns/secrets/bttrm-docker-secret”,<br/>…</span></pre><p id="718a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">很好—现在我们的掌舵人可以完全访问集群了！</p><p id="ed91" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们更新Github Runners部署来使用这个ServiceAccount。</p><p id="a3f2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">编辑它:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="0a02" class="lj lk iq kz b gy ll lm l ln lo">$ kubectl -n dev-1–18-backend-github-runners-helm-ns edit deploy actions-runner-deployment</span></pre><p id="0402" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过添加<code class="fe kw kx ky kz b">serviceAccount</code>来设置新的ServiceAccount:</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/b1c082fc552f9918699a07c2f1f90e62.png" data-original-src="https://miro.medium.com/v2/resize:fit:918/format:webp/0*cOK55jKXRj3VQN7s.png"/></div></figure><p id="09fd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">等待新的Pod被创建(检查<a class="ae mr" href="https://rtfm.co.ua/en/kubernetes-configmap-and-secrets-data-auto-reload-in-pods/" rel="noopener ugc nofollow" target="_blank"> Kubernetes: ConfigMap和Secrets—Pod中的数据自动重新加载</a>)，现在连接并检查Pod的权限:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="1c23" class="lj lk iq kz b gy ll lm l ln lo">root@actions-runner-deployment-6dfc9b457f-mc7rt:/actions-runner# kubectl auth can-i list pods<br/>yes</span></pre><p id="88c1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并检查对另一个名称空间的访问，因为我们已经创建了适用于整个集群的ClusterRoleBinding:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="9798" class="lj lk iq kz b gy ll lm l ln lo">root@actions-runner-deployment-6dfc9b457f-mc7rt:/actions-runner# kubectl auth can-i list pods — namespace istio-system<br/>yes</span></pre><p id="196e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">很好——我们还可以访问<em class="la"> istio-system </em>名称空间。</p><p id="629d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查舵:</p><pre class="lb lc ld le gt lf kz lg lh aw li bi"><span id="9189" class="lj lk iq kz b gy ll lm l ln lo">root@actions-runner-deployment-6dfc9b457f-mc7rt:/actions-runner# helm list<br/>NAME NAMESPACE REVISION UPDATED STATUS CHART APP VERSION<br/>github-runners dev-1–18-backend-github-runners-helm-ns 2 2021–09–22 19:50:18.828686642 +0300 +0300 deployed github-runners-1632329415 v1.0.0</span></pre><p id="2069" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成了。</p></div><div class="ab cl nf ng hu nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="ij ik il im in"><p id="7f31" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="la">最初发布于</em> <a class="ae mr" href="https://rtfm.co.ua/en/kubernetes-helm-x509-certificate-signed-by-unknown-authority-and-serviceaccount-for-pod/" rel="noopener ugc nofollow" target="_blank"> <em class="la"> RTFM: Linux、DevOps、系统管理</em> </a> <em class="la">。</em></p></div></div>    
</body>
</html>