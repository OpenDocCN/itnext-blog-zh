<html>
<head>
<title>Build Cloud-Native apps with AWS App Runner, Redis and AWS CDK</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS App Runner、Redis和AWS CDK构建云原生应用</h1>
<blockquote>原文：<a href="https://itnext.io/build-cloud-native-go-apps-with-aws-app-runner-redis-and-aws-cdk-e1bd7ba6ddf3?source=collection_archive---------4-----------------------#2022-05-23">https://itnext.io/build-cloud-native-go-apps-with-aws-app-runner-redis-and-aws-cdk-e1bd7ba6ddf3?source=collection_archive---------4-----------------------#2022-05-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="155e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated"><em class="kf">在App Runner上运行您的Go应用程序，将其与Redis的MemoryDB集成，并使用AWS CDK将应用程序与基础架构一起打包和部署</em></h2></div><p id="2fc2" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><a class="ae lc" href="https://docs.aws.amazon.com/apprunner/latest/dg/what-is-apprunner.html" rel="noopener ugc nofollow" target="_blank"> AWS App Runner </a>允许您以快速、简单且经济高效的方式部署和运行云原生应用。您可以选择自己喜欢的编程语言，因为App Runner可以直接从源代码(例如GitHub中)或Docker容器映像(来自ECR 中的<a class="ae lc" href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/Repositories.html" rel="noopener ugc nofollow" target="_blank">私有或公共回购)进行部署——所有这些都无需担心底层基础设施的供应和管理。</a></p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi ld"><img src="../Images/ad0b5e726d7750299051458e7dc77a6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Krz2-2iDXdXwX8Ee.png"/></div></div><figcaption class="lp lq gj gh gi lr ls bd b be z dk translated">高级解决方案架构</figcaption></figure><p id="70aa" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这篇博客文章展示了如何在AWS App Runner上运行Go应用程序，该应用程序将进一步与Redis的<a class="ae lc" href="https://docs.aws.amazon.com/memorydb/latest/devguide/what-is-memorydb-for-redis.html" rel="noopener ugc nofollow" target="_blank">Amazon MemoryDB</a>(Redis兼容的、持久的内存数据库服务)集成。您将使用AWS CDK部署应用程序及其基础设施。这包括<a class="ae lc" href="https://docs.aws.amazon.com/apprunner/latest/dg/network-vpc.html" rel="noopener ugc nofollow" target="_blank"> App Runner VPC连接器</a>配置以连接MemoryDB，以及使用CDK将您的Go应用程序打包为Docker映像，上传到ECR并无缝部署到App Runner(无需手动步骤)。</p><p id="66b5" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">我将以简短地浏览一下用Go编写的CDK代码来结束我的博客，这要感谢<a class="ae lc" href="https://docs.aws.amazon.com/cdk/v2/guide/work-with-cdk-go.html" rel="noopener ugc nofollow" target="_blank"> CDK Go支持</a>(在撰写本文时它在<em class="lt">开发者预览版</em>)。</p><blockquote class="lu lv lw"><p id="e5b9" class="kg kh lt ki b kj kk jr kl km kn ju ko lx kq kr ks ly ku kv kw lz ky kz la lb ij bi translated"><em class="iq">代码为</em> <a class="ae lc" href="https://github.com/abhirockzz/go-redis-apprunner" rel="noopener ugc nofollow" target="_blank"> <em class="iq">可在GitHub </em> </a>上找到</p></blockquote><p id="19f6" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">继续之前，请确保您已准备好以下内容:</p><h1 id="60a9" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">先决条件</h1><ul class=""><li id="a3a4" class="ms mt iq ki b kj mu km mv kp mw kt mx kx my lb mz na nb nc bi translated">创建一个AWS账户(如果你还没有的话)并登录。您使用的IAM用户必须有足够的权限进行必要的AWS服务调用和管理AWS资源。</li><li id="0cc4" class="ms mt iq ki b kj nd km ne kp nf kt ng kx nh lb mz na nb nc bi translated">安装和配置<a class="ae lc" href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a></li><li id="f394" class="ms mt iq ki b kj nd km ne kp nf kt ng kx nh lb mz na nb nc bi translated">安装并引导<a class="ae lc" href="https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html#getting_started_install" rel="noopener ugc nofollow" target="_blank"> AWS CDK </a></li><li id="374d" class="ms mt iq ki b kj nd km ne kp nf kt ng kx nh lb mz na nb nc bi translated">设置<a class="ae lc" href="https://docs.docker.com/get-docker/" rel="noopener ugc nofollow" target="_blank">对接</a></li><li id="7191" class="ms mt iq ki b kj nd km ne kp nf kt ng kx nh lb mz na nb nc bi translated"><a class="ae lc" href="https://go.dev/dl/" rel="noopener ugc nofollow" target="_blank">安装Go </a></li></ul></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><h1 id="65d0" class="ma mb iq bd mc md np mf mg mh nq mj mk jw nr jx mm jz ns ka mo kc nt kd mq mr bi translated">使用单一命令部署基础架构和应用程序</h1><p id="a9cd" class="pw-post-body-paragraph kg kh iq ki b kj mu jr kl km mv ju ko kp nu kr ks kt nv kv kw kx nw kz la lb ij bi translated">克隆GitHub repo并切换到正确的目录:</p><pre class="le lf lg lh gt nx ny nz oa aw ob bi"><span id="3fee" class="oc mb iq ny b gy od oe l of og">git clone https://github.com/abhirockzz/go-redis-apprunner</span><span id="43d1" class="oc mb iq ny b gy oh oe l of og">cd cdk</span></pre><p id="3444" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">设置环境变量:</p><ul class=""><li id="75ec" class="ms mt iq ki b kj kk km kn kp oi kt oj kx ok lb mz na nb nc bi translated">App Runner服务名称和端口</li><li id="558e" class="ms mt iq ki b kj nd km ne kp nf kt ng kx nh lb mz na nb nc bi translated">您为MemoryDB选择的密码(这只是出于演示目的—对于生产，您将有特定的流程来处理敏感信息)</li></ul><p id="9ad3" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">请注意密码要求。来自<a class="ae lc" href="https://docs.aws.amazon.com/memorydb/latest/devguide/clusters.acls.html" rel="noopener ugc nofollow" target="_blank">文档</a>:</p><blockquote class="lu lv lw"><p id="2343" class="kg kh lt ki b kj kk jr kl km kn ju ko lx kq kr ks ly ku kv kw lz ky kz la lb ij bi translated"><em class="iq">"特别是，在对MemoryDB使用ACL时要注意这些用户密码限制:</em></p><p id="e1a9" class="kg kh lt ki b kj kk jr kl km kn ju ko lx kq kr ks ly ku kv kw lz ky kz la lb ij bi translated">密码必须是16–128个可打印字符。</p><p id="7b10" class="kg kh lt ki b kj kk jr kl km kn ju ko lx kq kr ks ly ku kv kw lz ky kz la lb ij bi translated">不允许使用下列非字母数字字符:，" "/ @。"</p></blockquote><pre class="le lf lg lh gt nx ny nz oa aw ob bi"><span id="67d6" class="oc mb iq ny b gy od oe l of og">export APPRUNNER_SERVICE_NAME=apprunner-memorydb-go-app<br/>export APPRUNNER_SERVICE_PORT=8080<br/>export MEMORYDB_PASSWORD=&lt;password of your choice e.g. P@ssw0rd12345678&gt;</span><span id="e36c" class="oc mb iq ny b gy oh oe l of og">cdk deploy --all</span></pre><p id="0d8e" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这将启动堆栈创建。你现在需要做的就是…等等。</p><p id="a4c7" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><strong class="ki ir">为什么？？嗯，那是因为CDK在幕后为我们做了一切。从VPC(和子网、NAT网关等)开始。)、MemoryDB集群、安全组、打包并将我们的应用程序作为Docker映像上传(到私有ECR repo)并最终将其部署为应用程序运行器服务——这相当多！</strong></p></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><p id="6d39" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">随意导航到<em class="lt"> AWS控制台&gt;cloud formation&gt;Stacks</em>查看发生了什么…</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi ol"><img src="../Images/3e79cf54c4bdf56286f226876860053f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GrD1E_puYp3R840l.png"/></div></div></figure><p id="9ff9" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">一旦两个堆栈都运行完成，您就可以浏览所有组件:</p><p id="de75" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">MemoryDB子网组— VPC和两个子网，每个子网位于一个可用性分区中。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi om"><img src="../Images/99b1934e3e38dacb97691c798b6a8977.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sU7LRoIgQ7tfLktM.png"/></div></div></figure><p id="fb5d" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">内存数据库集群— CDK代码被硬编码以创建双节点集群(单个碎片)，即一个主节点和一个副本节点。请注意，主节点和副本节点分布在不同的az上(按照上面的子网组配置)</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi om"><img src="../Images/ae6f28e353d474ae6754ce3820bf813e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IzNpcGOuNLngKk44.png"/></div></div></figure><p id="e990" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">此外，MemoryDB的ACL和用户设置—这将用于身份验证(用户名/密码)和访问控制(授权)。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi on"><img src="../Images/32aa528a6824912b9655c2d86e4ae3d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7Nqv6SFb5Ixln8Q8.png"/></div></div></figure><p id="c14c" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">请记住，MemoryDB在不同的VPC中运行，默认情况下不可能将您的App Runner服务连接到它。您需要将您的服务与MemoryDB VPC相关联——这就是App Runner VPC连接器的用武之地，并允许它与MemoryDB通信。</p><p id="de70" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">VPC和子网与MemoryDB的相同。还要注意安全组——稍后将详细介绍</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi oo"><img src="../Images/772fc37c9591ccbdc0408a94f03103ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*FLfDBw8G9Fd463fw.png"/></div></div></figure><p id="7226" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">检查MemoryDB安全组。有一个入站规则规定:<em class="lt">源</em>安全组(在本例中与App Runner VPC连接器配置相关联)可以访问与<em class="lt">目标</em>安全组(在本例中为MemoryDB)相关联的实例的TCP端口<code class="fe op oq or ny b">6379</code></p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi om"><img src="../Images/83f1341ac79bd4264e0316bbfe80c310.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*179EDGAKbnL-WjIx.png"/></div></div></figure><p id="f7ca" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">您还可以确认为App Runner创建的IAM访问角色以及服务环境变量:</p><blockquote class="lu lv lw"><p id="e7db" class="kg kh lt ki b kj kk jr kl km kn ju ko lx kq kr ks ly ku kv kw lz ky kz la lb ij bi translated"><em class="iq">环境变量已用于演示目的。对于生产应用程序，您应该使用AWS Secrets Manager来存储和检索敏感信息，如密码、身份验证令牌等。</em></p></blockquote><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi os"><img src="../Images/5c02ec92ac8a094468b6282732071b29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GvHX7yvW0lhO7np4.png"/></div></div></figure></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><h1 id="bfc4" class="ma mb iq bd mc md np mf mg mh nq mj mk jw nr jx mm jz ns ka mo kc nt kd mq mr bi translated">测试应用程序</h1><p id="8426" class="pw-post-body-paragraph kg kh iq ki b kj mu jr kl km mv ju ko kp nu kr ks kt nv kv kw kx nw kz la lb ij bi translated">应用程序本身相当简单，公开了几个HTTP端点来创建样本数据。从详细信息页面找到App Runner服务URL。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi om"><img src="../Images/8119cafeab867fd0b6303d053693e610.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*o9MX8IxHt1BcPLOt.png"/></div></div></figure><p id="3944" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">您可以使用任何HTTP客户端测试应用程序(在本例中我使用了<code class="fe op oq or ny b">curl</code>):</p><pre class="le lf lg lh gt nx ny nz oa aw ob bi"><span id="ea3a" class="oc mb iq ny b gy od oe l of og"><em class="lt"># create a couple of user entries</em><br/>curl -i -X POST -d '{"email":"user1@foo.com", "name":"user1"}' &lt;enter APPRUNNER_APP_URL&gt;<br/>curl -i -X POST -d '{"email":"user2@foo.com", "name":"user2"}' &lt;enter APPRUNNER_APP_URL&gt;</span><span id="0c68" class="oc mb iq ny b gy oh oe l of og">HTTP/1.1 200 OK<br/>Date: Fri, 20 May 2022 08:05:06 GMT<br/>Content-Length: 0</span><span id="d924" class="oc mb iq ny b gy oh oe l of og"><em class="lt"># search for user via email</em><br/>curl -i &lt;enter APPRUNNER_APP_URL&gt;/user2@foo.com</span><span id="652d" class="oc mb iq ny b gy oh oe l of og">HTTP/1.1 200 OK<br/>Date: Fri, 20 May 2022 08:05:11 GMT<br/>Content-Length: 41<br/>Content-Type: text/plain; charset=utf-8</span><span id="8a9f" class="oc mb iq ny b gy oh oe l of og">{"email":"user2@foo.com","name":"user2"}</span><span id="2a52" class="oc mb iq ny b gy oh oe l of og"><em class="lt"># is a user does not exist</em><br/>curl -i &lt;enter APPRUNNER_APP_URL&gt;/not_there@foo.com</span><span id="a3f0" class="oc mb iq ny b gy oh oe l of og">HTTP/1.1 404 Not Found<br/>Content-Type: text/plain; charset=utf-8<br/>X-Content-Type-Options: nosniff<br/>Date: Fri, 20 May 2022 08:05:36 GMT<br/>Content-Length: 38</span><span id="1d21" class="oc mb iq ny b gy oh oe l of og">user does not exist not_there@foo.co</span></pre></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><h1 id="ba66" class="ma mb iq bd mc md np mf mg mh nq mj mk jw nr jx mm jz ns ka mo kc nt kd mq mr bi translated">打扫</h1><p id="b441" class="pw-post-body-paragraph kg kh iq ki b kj mu jr kl km mv ju ko kp nu kr ks kt nv kv kw kx nw kz la lb ij bi translated">完成本教程后，删除堆栈:</p><pre class="le lf lg lh gt nx ny nz oa aw ob bi"><span id="33c4" class="oc mb iq ny b gy od oe l of og">cdk destroy --all</span></pre><h1 id="9b81" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">快速浏览CDK代码</h1><p id="e38a" class="pw-post-body-paragraph kg kh iq ki b kj mu jr kl km mv ju ko kp nu kr ks kt nv kv kw kx nw kz la lb ij bi translated">基础设施部分(具体来说是IaaC)由两个(CDK) <a class="ae lc" href="https://docs.aws.amazon.com/cdk/v2/guide/stacks.html" rel="noopener ugc nofollow" target="_blank">栈</a>组成(在单个<a class="ae lc" href="https://docs.aws.amazon.com/cdk/v2/guide/apps.html" rel="noopener ugc nofollow" target="_blank"> CDK App </a>的上下文中)。</p><p id="5d67" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">我将提供一个用Go编写的CDK代码的演示，感谢<a class="ae lc" href="https://docs.aws.amazon.com/cdk/v2/guide/work-with-cdk-go.html" rel="noopener ugc nofollow" target="_blank"> CDK Go支持</a>(在撰写本文时是开发者预览版)。</p><blockquote class="lu lv lw"><p id="325f" class="kg kh lt ki b kj kk jr kl km kn ju ko lx kq kr ks ly ku kv kw lz ky kz la lb ij bi translated"><em class="iq">请注意，为了简洁起见，一些代码已经被编辑/省略——您可以随时在</em><a class="ae lc" href="https://github.com/abhirockzz/go-redis-apprunner" rel="noopener ugc nofollow" target="_blank"><em class="iq">GitHub repo</em></a>中查阅完整的代码</p></blockquote><p id="240d" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这是第一个堆栈:</p><p id="97d7" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">总结一下:</p><ul class=""><li id="1d26" class="ms mt iq ki b kj kk km kn kp oi kt oj kx ok lb mz na nb nc bi translated">创建VPC和相关组件的一行代码！</li><li id="b37a" class="ms mt iq ki b kj nd km ne kp nf kt ng kx nh lb mz na nb nc bi translated">我们为MemoryDB集群创建ACL、用户、子网组，并在使用<code class="fe op oq or ny b">awsmemorydb.NewCfnCluster</code>创建集群时引用它们</li><li id="72c9" class="ms mt iq ki b kj nd km ne kp nf kt ng kx nh lb mz na nb nc bi translated">我们还为MemoryDB和AppRunner (VPC配置)创建所需的安全组</li></ul><pre class="le lf lg lh gt nx ny nz oa aw ob bi"><span id="ed19" class="oc mb iq ny b gy od oe l of og">...<br/>vpc = awsec2.NewVpc(stack, jsii.String("demo-vpc"), nil)</span><span id="5774" class="oc mb iq ny b gy oh oe l of og">authInfo := map[string]interface{}{"Type": "password", "Passwords": []string{getMemoryDBPassword()}}<br/>user = awsmemorydb.NewCfnUser(stack, jsii.String("demo-memorydb-user"), &amp;awsmemorydb.CfnUserProps{UserName: jsii.String("demo-user"), AccessString: jsii.String(accessString), AuthenticationMode: authInfo})<br/>acl := awsmemorydb.NewCfnACL(stack, jsii.String("demo-memorydb-acl"), &amp;awsmemorydb.CfnACLProps{AclName: jsii.String("demo-memorydb-acl"), UserNames: &amp;[]*string{user.UserName()}})</span><span id="fb05" class="oc mb iq ny b gy oh oe l of og"><em class="lt">//snip...</em></span><span id="28d6" class="oc mb iq ny b gy oh oe l of og">subnetGroup := awsmemorydb.NewCfnSubnetGroup(stack, jsii.String("demo-memorydb-subnetgroup"), &amp;awsmemorydb.CfnSubnetGroupProps{SubnetGroupName: jsii.String("demo-memorydb-subnetgroup"), SubnetIds: &amp;subnetIDsForSubnetGroup})</span><span id="9eaf" class="oc mb iq ny b gy oh oe l of og">memorydbSecurityGroup := awsec2.NewSecurityGroup(stack, jsii.String("memorydb-demo-sg"), &amp;awsec2.SecurityGroupProps{Vpc: vpc, SecurityGroupName: jsii.String("memorydb-demo-sg"), AllowAllOutbound: jsii.Bool(true)})</span><span id="749c" class="oc mb iq ny b gy oh oe l of og">memorydbCluster = awsmemorydb.NewCfnCluster(stack, jsii.String("demo-memorydb-cluster"), &amp;awsmemorydb.CfnClusterProps{ClusterName: jsii.String("demo-memorydb-cluster"), NodeType: jsii.String(memoryDBNodeType), AclName: acl.AclName(), NumShards: jsii.Number(numMemoryDBShards), EngineVersion: jsii.String(memoryDBRedisEngineVersion), Port: jsii.Number(memoryDBRedisPort), SubnetGroupName: subnetGroup.SubnetGroupName(), NumReplicasPerShard: jsii.Number(numMemoryDBReplicaPerShard), TlsEnabled: jsii.Bool(true), SecurityGroupIds: &amp;[]*string{memorydbSecurityGroup.SecurityGroupId()}, ParameterGroupName: jsii.String(memoryDBDefaultParameterGroupName)})</span><span id="211b" class="oc mb iq ny b gy oh oe l of og"><em class="lt">//snip...</em></span><span id="7363" class="oc mb iq ny b gy oh oe l of og">appRunnerVPCConnSecurityGroup = awsec2.NewSecurityGroup(stack, jsii.String("apprunner-demo-sg"), &amp;awsec2.SecurityGroupProps{Vpc: vpc, SecurityGroupName: jsii.String("apprunner-demo-sg"), AllowAllOutbound: jsii.Bool(true)})</span><span id="b144" class="oc mb iq ny b gy oh oe l of og">memorydbSecurityGroup.AddIngressRule(awsec2.Peer_SecurityGroupId(appRunnerVPCConnSecurityGroup.SecurityGroupId(), nil), awsec2.Port_Tcp(jsii.Number(memoryDBRedisPort)), jsii.String("for apprunner to access memorydb"), jsii.Bool(false))<br/>...</span></pre><p id="5cbd" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">对于App Runner服务:</p><ul class=""><li id="8b9b" class="ms mt iq ki b kj kk km kn kp oi kt oj kx ok lb mz na nb nc bi translated">Docker映像构建和上传至私有ECR回购流程由CDK 完成<a class="ae lc" href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_ecr_assets-readme.html" rel="noopener ugc nofollow" target="_blank"/></li><li id="8168" class="ms mt iq ki b kj nd km ne kp nf kt ng kx nh lb mz na nb nc bi translated">我们指定服务将需要的环境变量</li><li id="8db0" class="ms mt iq ki b kj nd km ne kp nf kt ng kx nh lb mz na nb nc bi translated">App Runner源配置引用IAM角色、ECR映像和环境变量</li><li id="7f60" class="ms mt iq ki b kj nd km ne kp nf kt ng kx nh lb mz na nb nc bi translated">然后是封装VPC连接器配置的网络配置，</li><li id="742d" class="ms mt iq ki b kj nd km ne kp nf kt ng kx nh lb mz na nb nc bi translated">最后，创建了App Runner服务</li></ul><pre class="le lf lg lh gt nx ny nz oa aw ob bi"><span id="f015" class="oc mb iq ny b gy od oe l of og">...<br/>ecrAccessPolicy := awsiam.ManagedPolicy_FromManagedPolicyArn(stack, jsii.String("ecr-access-policy"), jsii.String(appRunnerServicePolicyForECRAccessARN))</span><span id="c51a" class="oc mb iq ny b gy oh oe l of og">apprunnerECRIAMrole := awsiam.NewRole(stack, jsii.String("role-apprunner-ecr"), &amp;awsiam.RoleProps{AssumedBy: awsiam.NewServicePrincipal(jsii.String(appRunnerServicePrincipal), nil), RoleName: jsii.String("role-apprunner-ecr"), ManagedPolicies: &amp;[]awsiam.IManagedPolicy{ecrAccessPolicy}})</span><span id="3495" class="oc mb iq ny b gy oh oe l of og">ecrAccessRoleConfig := awsapprunner.CfnService_AuthenticationConfigurationProperty{AccessRoleArn: apprunnerECRIAMrole.RoleArn()}</span><span id="e254" class="oc mb iq ny b gy oh oe l of og">memoryDBEndpointURL := fmt.Sprintf("%s:%s", *memorydbCluster.AttrClusterEndpointAddress(), strconv.Itoa(int(*memorydbCluster.Port())))</span><span id="a878" class="oc mb iq ny b gy oh oe l of og">appRunnerServiceEnvVarConfig := []awsapprunner.CfnService_KeyValuePairProperty{{Name: jsii.String("MEMORYDB_CLUSTER_ENDPOINT"), Value: jsii.String(memoryDBEndpointURL)}, {Name: jsii.String("MEMORYDB_USERNAME"), Value: user.UserName()}, {Name: jsii.String("MEMORYDB_PASSWORD"), Value: jsii.String(getMemoryDBPassword())}}</span><span id="c567" class="oc mb iq ny b gy oh oe l of og">imageConfig := awsapprunner.CfnService_ImageConfigurationProperty{RuntimeEnvironmentVariables: appRunnerServiceEnvVarConfig, Port: jsii.String(getAppRunnerServicePort())}</span><span id="32fc" class="oc mb iq ny b gy oh oe l of og">appDockerImage := awsecrassets.NewDockerImageAsset(stack, jsii.String("app-image"), &amp;awsecrassets.DockerImageAssetProps{Directory: jsii.String("../app/")})</span><span id="3775" class="oc mb iq ny b gy oh oe l of og">sourceConfig := awsapprunner.CfnService_SourceConfigurationProperty{AuthenticationConfiguration: ecrAccessRoleConfig, ImageRepository: awsapprunner.CfnService_ImageRepositoryProperty{ImageIdentifier: jsii.String(*appDockerImage.ImageUri()), ImageRepositoryType: jsii.String(ecrImageRepositoryType), ImageConfiguration: imageConfig}}</span><span id="76b6" class="oc mb iq ny b gy oh oe l of og"><em class="lt">//snip...</em></span><span id="b8f0" class="oc mb iq ny b gy oh oe l of og">vpcConnector := awsapprunner.NewCfnVpcConnector(stack, jsii.String("apprunner-vpc-connector"), &amp;awsapprunner.CfnVpcConnectorProps{Subnets: &amp;subnetIDsForSubnetGroup, SecurityGroups: &amp;[]*string{appRunnerVPCConnSecurityGroup.SecurityGroupId()}, VpcConnectorName: jsii.String("demo-apprunner-vpc-connector")})</span><span id="f5a1" class="oc mb iq ny b gy oh oe l of og">networkConfig := awsapprunner.CfnService_NetworkConfigurationProperty{EgressConfiguration: awsapprunner.CfnService_EgressConfigurationProperty{EgressType: jsii.String(appRunnerEgressType), VpcConnectorArn: vpcConnector.AttrVpcConnectorArn()}}</span><span id="588d" class="oc mb iq ny b gy oh oe l of og">app := awsapprunner.NewCfnService(stack, jsii.String("apprunner-app"), &amp;awsapprunner.CfnServiceProps{SourceConfiguration: sourceConfig, ServiceName: jsii.String(getAppRunnerServiceName()), NetworkConfiguration: networkConfig})<br/>...</span></pre></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><h1 id="2bf6" class="ma mb iq bd mc md np mf mg mh nq mj mk jw nr jx mm jz ns ka mo kc nt kd mq mr bi translated">该结束了！</h1><p id="5e6d" class="pw-post-body-paragraph kg kh iq ki b kj mu jr kl km mv ju ko kp nu kr ks kt nv kv kw kx nw kz la lb ij bi translated">您使用AWS CDK在App Runner上部署了一个Go应用程序(以及下面的！).在此过程中，您还学习了如何配置App Runner，以便使用VPC连接器与MemoryDB for Redis集成，以及整个解决方案的CDK代码的高级概述。</p><p id="d278" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这个博客到此为止。敬请关注更多和快乐的编码！</p></div></div>    
</body>
</html>