<html>
<head>
<title>CDK: Once more unto the breach</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CDK:再一次突破</h1>
<blockquote>原文：<a href="https://itnext.io/cdk-once-more-unto-the-breach-f2673cf219a6?source=collection_archive---------2-----------------------#2021-12-29">https://itnext.io/cdk-once-more-unto-the-breach-f2673cf219a6?source=collection_archive---------2-----------------------#2021-12-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5867" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">符合NIST 800系列安全要求的网络安全自动化和基础设施代码。</h2></div><p id="d424" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在过去的几年里，有一个未成年人(主要？？)云工程师之间关于哪种基础设施是最好的代码解决方案的争论。我们中的一些人甚至在《re:Invent》的快乐时光参与其中。有些人更喜欢Terraform的模块、不可知论和状态管理。一些人更喜欢AWS的CDK，因为它的抽象，支持“普通”编程概念(有人循环吗？？)以及类似TypeScript和Python这样的语言。我们中的一些人更喜欢云的形成——因为它有效，我们知道这一点。我当然属于后一类人，我的一部分现在仍然是。“CDK只是云形成的包装”我们会大喊。抱歉，普鲁米，我在网上读过一些好东西，但从未见过任何人使用它——我们都是自己回音室的受害者。但这并不意味着我们应该呆在自己的舒适区——只有当你不舒服的时候才会成长。</p><p id="2b02" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当《CDK》第一次发行时，我记得摆弄过它，想看看爵士乐是怎么回事，留下了相当深刻的印象，但不足以改变。显然这些抽象很棒。你可以写作</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="1704" class="lk ll iq lg b gy lm ln l lo lp">const vpc = new ec2.Vpc(this, 'TheVPC', {<br/>   cidr: "10.0.0.0/16"<br/>})</span></pre><p id="6e71" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它会旋转VPC，将其分割成子网，并配置路由、互联网网关、NAT网关(抱歉，是Corey Quinn)等。我非常懒——我努力工作，但只是因为我想放松一下。我最初喜欢子网配置的想法。我可以很容易地用不同的预定义子网规范分割我的VPC，它将处理引擎盖下的魔法。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="dc96" class="lk ll iq lg b gy lm ln l lo lp">new ec2.Vpc(this, 'VPC', {<br/>   subnetConfiguration: [<br/>      {<br/>        cidrMask: 24,<br/>        name: 'ingress',<br/>        subnetType: ec2.SubnetType.PUBLIC,<br/>      },<br/>      {<br/>        cidrMask: 24,<br/>        name: 'application',<br/>        subnetType: ec2.SubnetType.PRIVATE_WITH_NAT,<br/>      },<br/>      {<br/>        cidrMask: 28,<br/>        name: 'rds',<br/>        subnetType: ec2.SubnetType.PRIVATE_ISOLATED,<br/>      }<br/>   ]<br/>});</span></pre><p id="990c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这一小段代码可以处理定义VPC时的大部分繁重工作。我特别喜欢它处理子网掩码的方式。CloudFormation确实有一个CIDR函数，可以用来动态计算子网，但我发现它并没有被广泛使用(我个人很喜欢它，但我注意到有很多模板——甚至是由不使用它的AWS编写的)。此外，CFN·CIDR函数将子网中的位作为参数，而不是实际的CIDR掩码——如果需要/27，可以传递5。CDK取的是比较容易处理的掩码值。从32中减去很难！(讽刺…有点)。此外，即使使用异构掩码，CDKis也能够计算连续的子网，如上例所示。如果我在CloudFormation中这样做，我只需要特别注意记住每个子网是如何划分的，以及我的CIDR的哪一部分还剩下。小的胜利，但是很高兴看到大家的关注。</p><p id="368d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">不过，最终我还是暂时避开了CDK。我已经可以用云的形式下雨了，但我对打字稿感到不舒服，为什么要改变呢？(是的，我可以用Python来写CDK，但是我的直觉告诉我要坚持使用母语)。搬到CDK最大的吸引力是它能让别人为我做工作——我希望能更多地使用别人的抽象概念！</p><p id="1ec4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在re:Invent 2021输入ConstructHub。终于有地方让社区分享他们的抽象了！这重新点燃了我对CDK的兴趣。</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="676c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我在联邦云世界工作——在那里我们有很多安全需求——(好像其他人没有安全需求)。一些口味的字母汤是:NIST 800-53，FedRAMP和国防部SRG IL-4/5。其中一项要求是边界保护，即出入流量控制。我立即查看了ConstructHub，看它是否有新的网络防火墙构造，看看是否有人破解了CDK的路由配置；遗憾的是，事实并非如此。所以我自己跳进水里。</p><figure class="lb lc ld le gt ly gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/7c640117e00520557463c75be36445d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:892/format:webp/0*LthOI2fAMqVGVQSb.png"/></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">来自AWS文档。AWS NFW使用一种特殊类型的负载平衡器，网关负载平衡器，它利用GENEVE路由封装来路由和检查您的流量。</figcaption></figure><p id="ad6b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">AWS网络防火墙利用边缘路由表关联，并在您的互联网网关和您的公共子网之间注入自身。我从前面提到的带有子网配置的vpc构造开始—我想我应该相应地更新路由。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="0913" class="lk ll iq lg b gy lm ln l lo lp">const vpc = new ec2.Vpc(this, ‘firewall-vpc’, {<br/>  cidr: ‘10.0.0.0/24’,<br/>  maxAzs: 3,<br/>  subnetConfiguration: [<br/>  {<br/>    subnetType: ec2.SubnetType.PRIVATE_ISOLATED,<br/>    name: ‘firewall’,<br/>    cidrMask: 28,<br/>  },<br/>  {<br/>    cidrMask: 28,<br/>    name: ‘public’,<br/>    subnetType: ec2.SubnetType.PUBLIC,<br/>  },<br/>  {<br/>    cidrMask: 28,<br/>    name: ‘tgw-attach’,<br/>    subnetType: ec2.SubnetType.PRIVATE_WITH_NAT<br/>  }<br/>  ],<br/>}</span></pre><p id="cc80" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用Cloudformation，我将不得不盲目地复制代码片段，并在进行过程中更改一些小参数；有了TypeScript，我可以把它内置进去。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="4f94" class="lk ll iq lg b gy lm ln l lo lp">for (let i = 0; i &lt; vpc.availabilityZones.length ; i++) {<br/>  //invokes the custom resource to look up the vpc endpoint to use  <br/>  const fw_ep_az = new CustomResource(this, ‘fweplookup_cr_az’+i, {<br/>  serviceToken: fweplookup_lambda.functionArn,<br/>  properties: {<br/>    PubSubnet: pubsubnets.subnets[i].subnetId<br/>    }<br/>  })<br/>//adds the route to the edge route table w proper az mapping <br/>  new ec2.CfnRoute(this, ‘edge-ingress-route-az’+i, {<br/>    routeTableId: edgeroutetable.attrRouteTableId,<br/>    destinationCidrBlock: pubsubnets.subnets[i].ipv4CidrBlock,<br/>    vpcEndpointId: fw_ep_az.getAtt(‘FWEP’).toString()<br/>  });</span></pre><p id="161b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面是该循环的一个片段。想出真正的循环需要一些努力——但这比查找和替换并在头脑中保持一个更新内容的运行列表要好！</p><p id="2f66" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">密切关注lambda支持自定义资源。这是将NFW的VPC端点映射到正确的公共子网所必需的。您将公共子网id传递给它，它将返回要使用的VPC端点。这对自动化至关重要，因为知道正确的VPC端点ID的唯一方法是等待它被创建，然后查询它。</p><p id="bed3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">另一项要求是更新公共路由表，使其不再有通往IGW的默认路由。这需要删除路由，然后重新创建一条到正确的VPC端点的路由。删除VPC航线需要另一个自定义资源，因为航线删除不是标准的CFN资源。幸运的是**，CDK提供了一个新的抽象，如果你的定制资源是一个单独的AWS API调用，CDK将自动生成lamba、定制资源和lambda角色。以前的自定义资源需要更多的逻辑，因此我选择了传统的路线。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="5db8" class="lk ll iq lg b gy lm ln l lo lp">const deleteroute = new cr.AwsCustomResource(this, ‘delete-igw-route-az’+i, {<br/>  policy: cr.AwsCustomResourcePolicy.fromSdkCalls({resources:  cr.AwsCustomResourcePolicy.ANY_RESOURCE}),<br/>  onCreate: {<br/>  physicalResourceId:   cr.PhysicalResourceId.fromResponse(‘requestId’),<br/>  service:’EC2',<br/>  action:’DeleteRoute’,<br/>  parameters: {<br/>    DestinationCidrBlock: ‘0.0.0.0/0’,<br/>    RouteTableId: pubsubnets.subnets[i].routeTable.routeTableId,<br/>  }<br/>}</span></pre><ul class=""><li id="ca90" class="mf mg iq kh b ki kj kl km ko mh ks mi kw mj la mk ml mm mn bi translated">*这是一个非常方便的想法——它甚至基于API调用以编程方式生成IAM策略！然而，我最终还是走了传统路线，我希望CDKs的作者们有不同的做法。当您部署您的CDK应用程序时，它会生成这个lambda代码并将其上传到s3存储桶中，生成的模板在创建时会引用该存储桶。我更希望代码是一行一行写的。我的许多模板只是交给工程师，他们在Cloudformation中运行它们——我不希望打破这种流程。这将要求您运行cdk deploy作为唯一的部署方式。我喜欢尽可能避免外部依赖。</li></ul></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="596e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">网络防火墙提供了3种不同的规则组，您可以利用它们进行检查。</p><ol class=""><li id="3bbe" class="mf mg iq kh b ki kj kl km ko mh ks mi kw mj la mo ml mm mn bi translated">无状态—定义标准的五元组标准，用于单独检查数据包，没有额外的上下文。</li><li id="660a" class="mf mg iq kh b ki mp kl mq ko mr ks ms kw mt la mo ml mm mn bi translated">Stateful —定义在通信流和与数据包相关的其他通信的上下文中检查数据包的标准。</li><li id="47cb" class="mf mg iq kh b ki mp kl mq ko mr ks ms kw mt la mo ml mm mn bi translated">域允许/拒绝列表—定义域名列表并指定要检查的协议类型。</li></ol><p id="ea52" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请注意，NFW只检查第4层，它不检查上面的任何内容(无解密、无应用层等)。但是，它会检查TLS客户端Hello中的SNI报头(以及http中的HTTP主机报头),以确定是否允许某个域。</p><p id="b635" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所有防火墙的最佳做法是只允许所需的流量通过。通过锁定防火墙，我们可以对VPC资源与互联网的通信方式增加另一层保护。这将符合“零信任”架构；通过为我们的整个网络(一个或多个VPC)集中定义流量策略，我们不再需要“信任”安全出口规则是否配置正确(尽管它们仍然应该正确，因为您不能“信任”NFW是否有正确的规则)。正确的防火墙配置可以保护您免受各种恶意攻击——特别是Log4Shell漏洞中使用的回调。恶意请求可能会到达您的服务器，但是正确配置的防火墙可能会阻止对恶意服务器的LDAP(或其他协议)查询。</p><p id="51a1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我使用了两个规则组:</p><ol class=""><li id="1b23" class="mf mg iq kh b ki kj kl km ko mh ks mi kw mj la mo ml mm mn bi translated">允许123/UDP (NTP)、80/TCP (HTTP)、443/TCP (HTTPS)的出站端口。如果您在EC2上托管您的递归DNS解析器，您将需要添加53/IP(DNS—UDP和TCP)。</li><li id="5cfc" class="mf mg iq kh b ki mp kl mq ko mr ks ms kw mt la mo ml mm mn bi translated">一个域允许列表，仅允许我们的VPC资源与批准的域进行通信，主要用于软件更新。我也为一些主要的ca添加了一些CRL，因为它也过滤OCSP的流量。</li></ol><p id="409e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我发现编写这些L1结构的体验比标准的CloudFormation更好。我在VS代码中有cfn-lint和一些其他的扩展，这很有帮助，但是VS代码在使用CDK时显示了更多的信息——比如哪些属性是必需的，它们需要是什么类型等等。这导致了比以前稍微少的文档查找。</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="b533" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">总之，这次在CDK的经历促使我考虑采用它作为我的首选。我的下一站是在ConstructHub上发表这篇文章。完成后会更新。</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="2007" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">编辑:这已经发布到ConstructHub！</p><p id="0525" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">npm安装CDK-NW防火墙</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="6e5e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在推特上关注我<a class="mu mv ep" href="https://medium.com/u/860633c3a9d2?source=post_page-----f2673cf219a6--------------------------------" rel="noopener" target="_blank">马修·文恩</a></p></div></div>    
</body>
</html>