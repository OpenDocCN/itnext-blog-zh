<html>
<head>
<title>How to run Jenkins agents with cross-account ECR images using instance roles on EKS.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在EKS上使用实例角色运行具有跨帐户ECR映像的Jenkins代理。</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-run-jenkins-agents-with-cross-account-ecr-images-using-instance-roles-on-eks-2544b0fc6819?source=collection_archive---------1-----------------------#2020-05-21">https://itnext.io/how-to-run-jenkins-agents-with-cross-account-ecr-images-using-instance-roles-on-eks-2544b0fc6819?source=collection_archive---------1-----------------------#2020-05-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/5ad63a235c07590e772e06c9197fd4ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BRO89ceImWBB3Jj28Ugexw.jpeg"/></div></div></figure><p id="b533" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们对Jenkins又爱又恨，一方面它是一个久经考验的CI/CD解决方案，另一方面它有最过时的界面，但我们一直在使用它，我们必须让它适应新工具。</p><p id="79c6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我的例子中，我希望有一个AWS帐户保存我在ECR上的所有docker图像，并能够在同一组织下的任何其他帐户上使用它，以运行基于它的Jenkins代理。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="298e" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated"><strong class="ak">让您的组织可以访问ECR</strong></h1><p id="2a7a" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">从AWS的角度来看，这很容易实现，您只需要对您的映像制定一个策略，在我的情况下，该策略允许从与我们的组织ID匹配的所有内容进行只读访问。<br/>你可以在这里找到一篇很棒的博文，展示了如何使用terraform完成这个过程:<a class="ae mg" href="https://tech.scribd.com/blog/2020/orgwide-ecr.html" rel="noopener ugc nofollow" target="_blank">https://tech.scribd.com/blog/2020/orgwide-ecr.html</a></p><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">ECR跨账户访问政策</figcaption></figure><p id="f495" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从EC2实例和您的本地开发机器，通过正确配置的AWS CLI，您应该能够读取这个存储库。<br/>这个AWS教程应该够用了:<a class="ae mg" href="https://aws.amazon.com/blogs/compute/authenticating-amazon-ecr-repositories-for-docker-cli-with-credential-helper/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/compute/authenticating-Amazon-ECR-repositories-for-docker-CLI-with-credential-helper/</a></p><p id="7b1b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还没有完成，我们想用这个图像作为一个詹金斯代理。<br/>接下来的步骤应该在另一个账户上完成，而不是在持有ECR的账户上。</p><h1 id="f22c" class="ld le iq bd lf lg mr li lj lk ms lm ln lo mt lq lr ls mu lu lv lw mv ly lz ma bi translated"><strong class="ak">设置正确的詹金斯凭证</strong></h1><p id="b219" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">现在我们开始为我们的詹金斯经纪人准备一切。<br/>我假设EKS已经有一个Jenkins在使用声明性管道运行jobs。<br/><a class="ae mg" href="https://github.com/jenkinsci/kubernetes-plugin" rel="noopener ugc nofollow" target="_blank">https://github.com/jenkinsci/kubernetes-plugin</a></p><p id="2917" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，让我们在Jenkins上创建AWS凭证:</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/07791e1eef72f7dd49727e6982ff59db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0oiy3YNKHDAHH9Dobr_1Dw.png"/></div></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">AWS凭据创建表单</figcaption></figure><p id="fbfc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将<code class="fe mx my mz na b">Access Key ID</code>和<code class="fe mx my mz na b">Secret Access Key</code>字段留空很重要，这将允许詹金斯<code class="fe mx my mz na b">docker-commons</code>和<code class="fe mx my mz na b">amazon-ecr</code>插件使用实例角色。</p><p id="7e4b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">确保您的EC2 EKS工人正在使用实例角色<code class="fe mx my mz na b">arn:aws:iam::&lt;account-id&gt;:role/my-jenkins-worker-instance-role</code></p><h1 id="6bd2" class="ld le iq bd lf lg mr li lj lk ms lm ln lo mt lq lr ls mu lu lv lw mv ly lz ma bi translated">配置Jenkins角色</h1><p id="1dbb" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">该角色应包含以下策略:</p><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="103f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">奇怪的是，我们需要允许一个角色承担它自己，但这是我让它与Jenkins管道代理定义的当前状态一起工作的唯一方法。</p><h1 id="bbb1" class="ld le iq bd lf lg mr li lj lk ms lm ln lo mt lq lr ls mu lu lv lw mv ly lz ma bi translated">在管道上使用它</h1><p id="9732" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">现在，我们只需要把它用在我们的管道上:</p><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="ef13" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们使用来自交叉帐户ECR的图像和我们创建的空凭证，诀窍是始终设置<code class="fe mx my mz na b">registryCredentialsId</code>和<code class="fe mx my mz na b">registryUrl</code>。</p><p id="f3b1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这应该足以让Jenkins代理使用共享的ECR映像在EKS上运行。</p><p id="c168" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我希望这对你有帮助，我第一次花了将近一周的时间让它工作。</p></div></div>    
</body>
</html>