<html>
<head>
<title>AWS: WAF WebACL logging and Logz.io integration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS: WAF WebACL日志记录和Logz.io集成</h1>
<blockquote>原文：<a href="https://itnext.io/aws-waf-webacl-logging-and-logz-io-integration-da2803cbb8da?source=collection_archive---------5-----------------------#2021-07-22">https://itnext.io/aws-waf-webacl-logging-and-logz-io-integration-da2803cbb8da?source=collection_archive---------5-----------------------#2021-07-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/4db53edc2d31ceaf0cc5efaa8b7bac60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8QppZuMnRQSngTE4H4UqzA.png"/></div></div></figure><p id="3598" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在第一篇文章中— <a class="ae kw" href="https://rtfm.co.ua/en/aws-web-application-firewall-overview-configuration-and-its-monitoring/" rel="noopener ugc nofollow" target="_blank"> AWS: Web应用防火墙概述、配置及其监控</a> —我们谈到了它的主要组件，为它创建了一个WebACL和规则，并进行了基本的监控。</p><p id="a5c9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，我们已经用AWS Kinesis配置了WebACL的日志集合，但现在是时候查看它们Logz.io了，因为CloudWatch Logs还不可用。</p><p id="43c0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，在这篇文章中，我们将配置日志通过AWS Kinesis发送到AWS S3桶，然后将配置Logz.io从S3获取这些日志，并将谈论日志内容以及如何使用它们进行调试。</p><h1 id="be94" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated"><strong class="ak">内容</strong></h1><ul class=""><li id="5a9c" class="lv lw iq ka b kb lx kf ly kj lz kn ma kr mb kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-waf-webacl-logging-and-logz-io-integration/#AWS_WAF_logs" rel="noopener ugc nofollow" target="_blank"> AWS晶圆日志</a></li><li id="0062" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-waf-webacl-logging-and-logz-io-integration/#AWS_Kinesis" rel="noopener ugc nofollow" target="_blank"> AWS Kinesis </a></li><li id="1798" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-waf-webacl-logging-and-logz-io-integration/#WAF_ACL_logging" rel="noopener ugc nofollow" target="_blank"> WAF ACL记录</a></li><li id="80b9" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-waf-webacl-logging-and-logz-io-integration/#Logzio_S3_Bucket" rel="noopener ugc nofollow" target="_blank"> Logz.io S3桶</a></li><li id="7c2a" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-waf-webacl-logging-and-logz-io-integration/#Logzio_S3_configuration" rel="noopener ugc nofollow" target="_blank"> Logz.io S3配置</a></li><li id="6f0c" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-waf-webacl-logging-and-logz-io-integration/#IAM_policy" rel="noopener ugc nofollow" target="_blank"> IAM策略</a></li><li id="4b75" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-waf-webacl-logging-and-logz-io-integration/#IAM_role" rel="noopener ugc nofollow" target="_blank">我的角色</a></li><li id="d60c" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-waf-webacl-logging-and-logz-io-integration/#WAF_logs_-_fields" rel="noopener ugc nofollow" target="_blank">晶圆日志—字段</a></li><li id="6aee" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-waf-webacl-logging-and-logz-io-integration/#Redacted_fields_-_excluding_data_from_logs" rel="noopener ugc nofollow" target="_blank">编辑字段—从日志中排除数据</a></li><li id="447a" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-waf-webacl-logging-and-logz-io-integration/#Logzio_alerting" rel="noopener ugc nofollow" target="_blank"> Logz.io报警</a></li></ul><h1 id="b61e" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">AWS晶圆日志</h1><p id="55ec" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">除了CloudWatch指标，我们还可以为通过WebACL传递的所有请求启用日志。</p><p id="8e45" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">AWS WAF使用AWS Kinesis发送数据，使用AWS S3存储日志。</p><p id="50ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">遗憾的是，WAF和Kinesis无法使用CloudWatch日志(至少，在绞拧的那一刻，正如AWS技术支持告诉我的，计划启用它们)。</p><p id="9f37" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以，让我们做以下事情:</p><ol class=""><li id="755f" class="lv lw iq ka b kb kc kf kg kj mo kn mp kr mq kv mr md me mf bi translated">配置Kinesis消防站流</li><li id="35db" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mr md me mf bi translated">配置WebACL以向流发送数据</li><li id="9bb1" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mr md me mf bi translated">Kinesis流将数据发送到AWS S3桶</li><li id="02f8" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mr md me mf bi translated">Logz.io将使用它的连接器从这个S3获取日志</li></ol><h2 id="7bb3" class="ms ky iq bd kz mt mu dn ld mv mw dp lh kj mx my ll kn mz na lp kr nb nc lt nd bi translated">AWS室壁运动</h2><blockquote class="ne nf ng"><p id="c896" class="jy jz nh ka b kb kc kd ke kf kg kh ki ni kk kl km nj ko kp kq nk ks kt ku kv ij bi translated"><strong class="ka ir">注:</strong>一个AWS WAF日志相当于一个Kinesis数据消防软管记录。如果您通常每秒收到10，000个请求，请在Kinesis Data Firehose中设置每秒10，000条记录的限制，以启用完整日志记录。</p></blockquote><p id="a654" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">转到AWS Kinesis，创建一个新的<em class="nh">数据消防软管传输流</em>，记住其名称必须以“<em class="nh"> aws-waf-logs- </em>为前缀。</p><p id="7d66" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择<em class="nh">直接放或者其他来源</em>，点击<em class="nh">下一个</em>:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/8888d1556d996c69d8b84f07307a15c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8CkXs6H56vfB3Kfv.png"/></div></div></figure><p id="8014" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在下一页跳过数据转换，点击<em class="nh">下一个</em>，然后对于<em class="nh">目的地</em>选择<em class="nh"> S3 </em>，并创建一个新的S3桶:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/4ec71ded3f740df1588b4e05609456a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*nNX9DA00IC4idovn.png"/></div></div></figure><p id="e3cb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里，我使用一个已经存在的桶。为避免混合不同ACL的日志，请添加前缀:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/cff00033faadcb2945953a8da2b1229f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*B-KLK9vvPu8l4wIN.png"/></div></div></figure><p id="8428" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在下一页，保留所有默认值。如果出现任何问题，Kinesis将通过CloudWatch发送一条消息:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/b7f3997f5e8ed2243558927d8ad83039.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3qOWU7SOW0ioKFPg.png"/></div></div></figure><p id="1d3d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要获得这些信息，请启用<em class="nh">错误记录</em>选项:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/a04eadcd0924b470022edd08f0f7abbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0q4NFAjEdgtS1q9B.png"/></div></div></figure><p id="c709" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查设置，并创建流:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/4eda12d56c6927523c865fa573e05e32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PjIVS5ic4AdSQ33x.png"/></div></div></figure><p id="9424" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">等待几分钟以创建流:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/5ac6618689e6c3e7777d6a8038673d05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1256/format:webp/0*2osM6m_gFd8hgjV2.png"/></div></figure><p id="c5c9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者直接访问网络访问列表。</p><h2 id="e6c6" class="ms ky iq bd kz mt mu dn ld mv mw dp lh kj mx my ll kn mz na lp kr nb nc lt nd bi translated">WAF ACL记录</h2><p id="1ad0" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">转到ACL，在<em class="nh">日志记录和指标</em>选项卡上点击<em class="nh">启用日志记录</em>:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/a50689d0b2680e77da956e5be32d2018.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wURFhEQCPfNATsfZ.png"/></div></div></figure><p id="0d95" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择上面创建的流:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/89ee3c0bf64ee42628e12d5aec5cf0ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*KNif30ss8KpBn31N.png"/></div></div></figure><p id="789b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这里，我们还可以启用过滤器，这将在下面谈到它们。</p><h1 id="8be6" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Logz.io S3桶</h1><p id="b0a2" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">这里的文献资料是<a class="ae kw" href="https://app.logz.io/#/dashboard/send-your-data/log-sources/s3-bucket" rel="noopener ugc nofollow" target="_blank">&gt;&gt;&gt;</a>。</p><p id="442a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，我们需要创建一个IAM策略和一个角色，它将提供对包含日志的S3存储桶的访问。查看其文档<a class="ae kw" href="https://docs.logz.io/user-guide/give-aws-access-with-iam-roles/" rel="noopener ugc nofollow" target="_blank">此处&gt; &gt; &gt; </a>。</p><p id="99ea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Logz.io将通过这个角色来获取访问bucket的权限。</p><h2 id="cf96" class="ms ky iq bd kz mt mu dn ld mv mw dp lh kj mx my ll kn mz na lp kr nb nc lt nd bi translated">Logz.io S3配置</h2><p id="6da1" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">要向<a class="ae kw" href="https://app.logz.io/#/dashboard/send-your-data/log-sources/s3-bucket" rel="noopener ugc nofollow" target="_blank"> S3添加铲斗，点击<em class="nh">上的</em></a>添加铲斗:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nx"><img src="../Images/4d4a2ea56362627e5f179b30ca0c7fff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ga7x69GXpzEeCiQM.png"/></div></div></figure><p id="34ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择<em class="nh">用角色</em>认证:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/6c7789d56c38e92d4145ff3838f4d11b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/format:webp/0*TdLUUD-jB5ThZid7.png"/></div></figure><p id="06a8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">指定桶的名称，点击<em class="nh">获取角色策略</em>:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/fc7c78dce9d5b3ceee24a7046b53c742.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/format:webp/0*n-EEXH-mW53X9_OS.png"/></div></figure><h2 id="15c6" class="ms ky iq bd kz mt mu dn ld mv mw dp lh kj mx my ll kn mz na lp kr nb nc lt nd bi translated">IAM策略</h2><p id="2871" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">复制策略内容，转到AWS IAM，创建新策略:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/e5a06cea52e9a3b5f1af0b78a16a6bdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1156/format:webp/0*ofPqYNWXdB8Df6Fh.png"/></div></figure><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/0eed1d491450c3ff0358a73d59863de0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0iRXbTrFBi5VlT4t.png"/></div></div></figure><p id="0be6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从Logz.io添加JSON:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/1a2f74c0eea37c18cc932521e7983291.png" data-original-src="https://miro.medium.com/v2/resize:fit:1036/format:webp/0*pj-CnQkMeP8lJvrh.png"/></div></figure><p id="60c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">保存策略:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/0eae47c66ecd093c6e0101abe98fc499.png" data-original-src="https://miro.medium.com/v2/resize:fit:1316/format:webp/0*_cSz4kwtXgil7Xqn.png"/></div></figure><h2 id="4b52" class="ms ky iq bd kz mt mu dn ld mv mw dp lh kj mx my ll kn mz na lp kr nb nc lt nd bi translated">IAM角色</h2><p id="ec3a" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">转到в AWS IAM角色，创建一个新角色。</p><p id="7ce4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择<em class="nh">另一个AWS账户</em>，从Logz.io页面指定账户ID和外部ID:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div class="gh gi od"><img src="../Images/cd5eb0b5a27985a4d9ae2459be0d24bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*GLJJxnD8fX9igxLe.png"/></div></figure><p id="31d1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<em class="nh">权限</em>页面上，附加我们在上面创建的策略:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/2571d046de1b783a86f2cf0e02c0641e.png" data-original-src="https://miro.medium.com/v2/resize:fit:982/format:webp/0*5wzh3ej4rBnwcGfw.png"/></div></figure><p id="6f26" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">保存角色:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div class="gh gi of"><img src="../Images/d05691b4542b7c99c54a972e869b1779.png" data-original-src="https://miro.medium.com/v2/resize:fit:1388/format:webp/0*QHn8-mLAgz6m1i1m.png"/></div></figure><p id="0c81" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在其<em class="nh">可信实体</em>中，我们可以看到帐户ID，它将能够承担该角色。</p><p id="9372" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">复制角色的ARN:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi og"><img src="../Images/4daee76a191709dfe821af8a79ad8930.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*L4CQGmMDIle7bwe9.png"/></div></div></figure><p id="9763" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">返回Logz.io，设置ARN，并选择一个AWS区域。</p><p id="4209" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在数据类型中选择<em class="nh">其他</em>:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oh"><img src="../Images/5eb5ee6ab31567afa2dd1226b91c6124.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OGXESWeD2rJms_Dk.png"/></div></div></figure><p id="47ed" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并将其值设置为<em class="nh"> awswaf </em>(此处参见所有类型<a class="ae kw" href="https://docs.logz.io/user-guide/log-shipping/built-in-log-types.html" rel="noopener ugc nofollow" target="_blank">&gt;&gt;&gt;</a>)，这样ELK将能够解析日志JSON:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/e370a9fa4a54a44a41f8962b7a29013b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/0*qEUjeVma4iJIjzFr.png"/></div></figure><p id="f386" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">点击<em class="nh">保存</em>，水桶就连接到你的Logz.io账号了。</p><h1 id="6750" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">WAF日志-字段</h1><p id="9e26" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">现在，需要为WebACL附加一个ALB，并等待流量查看ACL日志中的内容。</p><p id="bd00" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将ACL附加到入口— <code class="fe oj ok ol om b"><a class="ae kw" href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.1/guide/ingress/annotations/#wafv2-acl-arn" rel="noopener ugc nofollow" target="_blank">alb.ingress.kubernetes.io/wafv2-acl-arn</a></code>:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi on"><img src="../Images/e047124b75a304feaac1974c2c298b5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wtG2qkbNYrgELrkl.png"/></div></div></figure><p id="6de8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">几分钟后，查看S3——一个带有我们前缀的新目录将被创建，它是由Kinesis添加的:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/6aeda3a995dec7ca4c0a41dc86445f26.png" data-original-src="https://miro.medium.com/v2/resize:fit:836/format:webp/0*zs8I0hcaPXkz_nr5.png"/></div></figure><p id="1953" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第一个日志文件:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi op"><img src="../Images/2f38d7ebd42f7e7e7a3273b7a6f5ae44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8b0ax9TfFGTOgF8j.png"/></div></div></figure><p id="65fe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">同样，等待几分钟，以便日志将被传送到Kibana。</p><p id="ac64" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ELK将解析它的字段，我们可以在搜索时使用它们。</p><p id="6350" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有两个主要使用的字段:<code class="fe oj ok ol om b">type: "awsfaw"</code>，用于查看所有日志，或者<code class="fe oj ok ol om b">webaclId</code>，用于仅选择特定的WebACL日志:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oq"><img src="../Images/b8c30247f0c499e72d71658ff050c17a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rA7IGYcUjByr2lAD.png"/></div></div></figure><p id="823a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，值得在结果表中使用以下字段(参见<a class="ae kw" href="https://docs.aws.amazon.com/waf/latest/developerguide/logging.html#logging-fields" rel="noopener ugc nofollow" target="_blank">文档&gt; &gt; &gt; </a>):</p><ul class=""><li id="176a" class="lv lw iq ka b kb kc kf kg kj mo kn mp kr mq kv mc md me mf bi translated"><code class="fe oj ok ol om b">httpRequest.clientIp</code>:发起请求的IP</li><li id="f7c8" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><code class="fe oj ok ol om b">httpRequest.uri</code> : URI用于请求</li><li id="4bbd" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><code class="fe oj ok ol om b">httpRequest.args</code>:其论据</li><li id="ebbc" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><code class="fe oj ok ol om b">terminatingRuleId</code>:WebACL的规则，这是最后一个允许或阻止的规则</li><li id="50b0" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><code class="fe oj ok ol om b">ruleGroupList</code>:WebACL的所有规则，针对请求进行检查</li></ul><p id="74e2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们看看在日志消息中到底能找到什么。</p><p id="d24c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，让我们检查一个请求，该请求被允许访问我们的应用程序，即使用ALLOW操作:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi or"><img src="../Images/35631a853dae0c2a6a18bf1dd2fea740.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*i9ENco_22D_7EsBv.png"/></div></div></figure><p id="658d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是来自IP <em class="nh"> 99的请求。***.***.101 </em>到URI <em class="nh"> /***/126/like </em>，按<code class="fe oj ok ol om b">ruleGroupList</code>链规定的规则检查，最后用WebACL的<code class="fe oj ok ol om b">Default_Action</code>允许。</p><p id="c1c4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，在<code class="fe oj ok ol om b">ruleGroupList</code>中，我们可以看到一个规则被应用于请求- <code class="fe oj ok ol om b">SignalNonBrowserUserAgent</code>，但是由于我们将该规则设置为<em class="nh">计数</em>操作，因此它被忽略:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi os"><img src="../Images/62cb46c7ba1200d17f6749442c9900b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CLeIoeaAkk4W3whM.png"/></div></div></figure><p id="92ab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，在<code class="fe oj ok ol om b">terminatingRuleId</code>в中，我们看到<code class="fe oj ok ol om b">Default_Action</code>被应用，因为<code class="fe oj ok ol om b">SignalNonBrowserUserAgent</code>由于计数动作而被排除。</p><p id="85f0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果一个请求被阻塞，那么在<code class="fe oj ok ol om b">Default_Action</code>中，我们将看到一个应用了<em class="nh">阻塞</em>操作的规则:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ot"><img src="../Images/0a075fd65deb47947937b0fa3a9115b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9rrz7x8pMrxPYs_T.png"/></div></div></figure><h2 id="57d1" class="ms ky iq bd kz mt mu dn ld mv mw dp lh kj mx my ll kn mz na lp kr nb nc lt nd bi translated">密文字段—从日志中排除数据</h2><p id="7fd4" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">在日志中，我们可以获得一些我们不希望存在的数据，如cookies信息或身份验证令牌:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/179c7ac05a434fe422f2cdbd6335182f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/0*Optxc8mFxuyAok3V.png"/></div></figure><p id="cde8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要删除该数据，请转到日志设置，然后在<em class="nh">修订字段</em>中选择需要排除的字段。</p><p id="661c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在当前的例子中，它将是标题和来自那里的两个字段— <code class="fe oj ok ol om b">authorization</code>和<code class="fe oj ok ol om b">cookie</code>:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ov"><img src="../Images/d7e9d1575c63dd1c93b3138c291a051b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1150/format:webp/0*Hk9P0EBtRKg4DzqT.png"/></div></div></figure><p id="b01c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">应用更改，现在您将看到它们的值被编辑为<em class="nh"/>:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/81e6072826e649613dd1c8ef24b6949e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1038/format:webp/0*ow3845LTKU-TxoUP.png"/></div></figure><h1 id="f4f4" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Logz.io警报</h1><p id="f08e" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">此外，获得块的通知也是一个好主意。</p><p id="9fee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们通过<a class="ae kw" href="https://support.atlassian.com/opsgenie/docs/integrate-opsgenie-with-logzio/" rel="noopener ugc nofollow" target="_blank"> Logz.io与Opsgenie的集成</a>创建一个警报，Opsgenie将向我们的Slack发送通知。</p><p id="7042" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">描述警报的条件，在<em class="nh">过滤器</em>中添加<code class="fe oj ok ol om b">action != ALLOW</code>:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ox"><img src="../Images/0255273c770f70a59b2275e91b4b326f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*j3KAUVctNs6xeVJ3.png"/></div></div></figure><p id="fe1e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择发送通知的渠道，以及您希望在消息中看到的字段:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/cd039a11673fdde062a823cca44e31c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1010/format:webp/0*ASDIdDy73LPYAXNn.png"/></div></figure><p id="aadc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在空闲时等待警报:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/65f971f065df6704f229914d1cf51b63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1316/format:webp/0*QKpUPl5R4bP8B4yL.png"/></div></figure><p id="1ebe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成了。</p></div><div class="ab cl oz pa hu pb" role="separator"><span class="pc bw bk pd pe pf"/><span class="pc bw bk pd pe pf"/><span class="pc bw bk pd pe"/></div><div class="ij ik il im in"><p id="246c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nh">最初发布于</em> <a class="ae kw" href="https://rtfm.co.ua/en/aws-waf-webacl-logging-and-logz-io-integration/" rel="noopener ugc nofollow" target="_blank"> <em class="nh"> RTFM: Linux，DevOps，和系统管理</em> </a> <em class="nh">。</em></p></div></div>    
</body>
</html>