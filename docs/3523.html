<html>
<head>
<title>Helm Is Not Enough, You Also Need Kustomize</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">头盔是不够的，你还需要Kustomize</h1>
<blockquote>原文：<a href="https://itnext.io/helm-is-not-enough-you-also-need-kustomize-82bae896816e?source=collection_archive---------0-----------------------#2020-01-03">https://itnext.io/helm-is-not-enough-you-also-need-kustomize-82bae896816e?source=collection_archive---------0-----------------------#2020-01-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d804" class="pw-subtitle-paragraph jo ip iq bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">自定义YAML以实施来自应用程序操作员、安全操作员和群集操作员的策略。✊</h2></div><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi kg"><img src="../Images/346016364dfa9ec3208f55b0d4091a7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qZV6wiQr4yet746qAl-G7A.png"/></div></div></figure><p id="b021" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">Kubernetes让我们声明性地指定我们的意图，即应用程序应该如何通过YAML部署在底层基础设施中。这些YAML将包含应用程序定义、治理所需的标签、日志记录等横切关注点所需的标签、应用程序安全上下文定义、应用程序资源依赖性等。当我们开始将我们的Kubernetes扩展到数十个或数百个pod时，管理所有YAML将成为一场噩梦。</p><p id="9177" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">为了便于理解，这些声明性配置可以分为三个主要类别</p><ol class=""><li id="b264" class="lo lp iq ku b kv kw ky kz lb lq lf lr lj ls ln lt lu lv lw bi translated">应用程序打包</li><li id="7fa0" class="lo lp iq ku b kv lx ky ly lb lz lf ma lj mb ln lt lu lv lw bi translated">应用程序配置</li><li id="f7bd" class="lo lp iq ku b kv lx ky ly lb lz lf ma lj mb ln lt lu lv lw bi translated">运行时配置</li></ol><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi mc"><img src="../Images/66badfdf61862b8024ebc7797d0d0167.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PQBK4ITeq-3X-4fl-laRVA.png"/></div></div></figure><p id="1ad1" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">难道赫尔姆不能轻松地帮我们做到这一点吗？我们为什么需要新工具？新工具能带来什么？Helm和Kustomize如何一起实现一些强大的用例？让我们在这篇博客中尝试回答所有这些问题。</p><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi md"><img src="../Images/44884a7994db8e53483971caeba47b52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lf_e4YMiqyVB4OLArTEktQ.png"/></div></div></figure><h2 id="beaf" class="me mf iq bd mg mh mi dn mj mk ml dp mm lb mn mo mp lf mq mr ms lj mt mu mv mw bi translated">什么舵好不好？</h2><p id="82f6" class="pw-post-body-paragraph ks kt iq ku b kv mx js kx ky my jv la lb mz ld le lf na lh li lj nb ll lm ln ij bi translated">首先，让我们看看将应用程序部署到Kubernetes中所需的不同技术能力。</p><p id="8520" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir"> <em class="nc">应用打包&amp;描述</em> </strong></p><blockquote class="nd ne nf"><p id="7e07" class="ks kt nc ku b kv kw js kx ky kz jv la ng lc ld le nh lg lh li ni lk ll lm ln ij bi translated">帮助我们描述应用程序并将相关资源打包在一起的功能，例如，1)应用程序元数据定义，如资源约束，2)将配置和服务打包在一起</p></blockquote><p id="63be" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir"> <em class="nc">依赖关系管理</em> </strong></p><blockquote class="nd ne nf"><p id="15ab" class="ks kt nc ku b kv kw js kx ky kz jv la ng lc ld le nh lg lh li ni lk ll lm ln ij bi translated">该功能将帮助我们定义依赖性，例如，在部署pod资源之前部署配置资源。</p></blockquote><p id="03c1" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir"> <em class="nc">应用发现&amp;仪表盘</em> </strong></p><blockquote class="nd ne nf"><p id="1795" class="ks kt nc ku b kv kw js kx ky kz jv la ng lc ld le nh lg lh li ni lk ll lm ln ij bi translated">该功能将帮助我们发现部署在集群中的应用程序，以及它们的部署历史、依赖关系等。,</p></blockquote><p id="fa68" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir"> <em class="nc">生命周期管理</em> </strong></p><blockquote class="nd ne nf"><p id="d04f" class="ks kt nc ku b kv kw js kx ky kz jv la ng lc ld le nh lg lh li ni lk ll lm ln ij bi translated">该功能将帮助我们执行不同的应用程序部署策略，如首次展示、回滚、蓝绿色部署。</p></blockquote><p id="3a00" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">应用描述定制</strong></p><blockquote class="nd ne nf"><p id="69ee" class="ks kt nc ku b kv kw js kx ky kz jv la ng lc ld le nh lg lh li ni lk ll lm ln ij bi translated">该功能将帮助我们将应用/安全/集群标记添加到YAML中，以解决治理/安全/跨领域问题</p></blockquote><p id="8f25" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">Helm可以很好地完成所有这些工作，但对于“<em class="nc">应用描述定制</em>”类别下的用例来说，它不是一个很好的工具。让我们看一些坚实的例子来理解这一点。</p><p id="e88d" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">案例1:维护成本——Git Fork或Copy </strong></p><p id="edb6" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">假设我们使用Nginx helm charts将Nginx WAF部署到我们的集群中。作为产品团队需求的一部分，我们应该添加一个注释来指定负责部署的团队名称。我们不能对主要的Nginx git库进行修改，因为它只与我们组织中的应用<em class="nc">操作治理策略相关。为了实现这一点，我们应该从Nginx存储库中派生或复制图表模板，并根据我们的定制需求对其进行修改。维护分支/副本的成本很高。Kustomize能帮上忙。</em></p><p id="cf8d" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">案例2:泄漏的抽象</strong></p><p id="15fe" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">假设我们有一些网络策略要应用于一组pod。安全操作员希望将标签添加到所有相关的pod，然后他可以将网络策略资源添加到具有给定标签的所有pod。按照传统的掌舵方式，我们应该将标签添加到开发人员工作的图表模板中。很明显，我们将安全声明性标签泄露给了应用程序开发人员。</p><p id="99a3" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">案例3:不同横切关注点之间的耦合</strong></p><p id="8b33" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在Kubernetes资源YAML上，有关于应用程序开发人员、应用程序操作人员、安全操作人员和集群操作人员的声明性标签。应用、安全和集群运营商的关注本质上是交叉的。耦合所有这些问题会阻碍团队的敏捷性。</p><p id="faa0" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">案例4:在连续部署管道中应用补丁</strong></p><p id="f484" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">假设Nginx pod中存在一个安全漏洞，安全团队正在寻找一种方法来拦截所有持续部署管道，并使用最新版本更新Nginx映像版本。Kustomize在这种情况下会工作得很好。</p><blockquote class="nd ne nf"><p id="999e" class="ks kt nc ku b kv kw js kx ky kz jv la ng lc ld le nh lg lh li ni lk ll lm ln ij bi translated">这是Kustomize的最佳位置。这有助于我们定制YAML的文件，而不影响YAML的原作。Kustomize是一个简单的命令行CLI工具，可以添加到任何持续部署/集成工作流中，甚至可以根据需要作为一个独立的工具</p></blockquote><p id="203d" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">下图可以给我们一个高层次的视角，让我们了解Helm和Kustomize如何合作来创建一些强大的工作流。</p><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi nj"><img src="../Images/5cbf14ff95f2a01e4c415984e2ae6dba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UPsjTPxk6hSoY0-DX6Lrmg.png"/></div></div></figure><h2 id="e7da" class="me mf iq bd mg mh mi dn mj mk ml dp mm lb mn mo mp lf mq mr ms lj mt mu mv mw bi translated">Kustomize是如何工作的？</h2><p id="9ace" class="pw-post-body-paragraph ks kt iq ku b kv mx js kx ky my jv la lb mz ld le lf na lh li lj nb ll lm ln ij bi translated">非常简单的三个步骤</p><ul class=""><li id="ee15" class="lo lp iq ku b kv kw ky kz lb lq lf lr lj ls ln nk lu lv lw bi translated">将“kustomization.yaml”添加到我们希望定制的yaml中</li><li id="5a45" class="lo lp iq ku b kv lx ky ly lb lz lf ma lj mb ln nk lu lv lw bi translated">在YAML中定义您的自定义</li><li id="2131" class="lo lp iq ku b kv lx ky ly lb lz lf ma lj mb ln nk lu lv lw bi translated">然后运行“kustomize build”</li></ul><p id="9e9e" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">现在，kustomization.yaml的内容是什么？我们举个例子，看看相关的“kustomization.yaml”</p><p id="849f" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">例1 </strong>:我们有一个由购物车团队部署的pod，供移动应用团队使用。此外，安全团队要求将移动应用团队使用的所有服务保存在“后端对前端”的名称空间中。除此之外，应用程序操作者有一个横切标签，其中包括用于分布式跟踪的团队名称。上例中的“kustomization.yaml”如下所示</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="7987" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">吊舱YAML</p><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/e1f06a98c38d4474c6f7f9cd5e2cc397.png" data-original-src="https://miro.medium.com/v2/resize:fit:872/format:webp/1*J5WK44QyZr9J1Xz5hjuYhw.png"/></div></figure><p id="c418" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">YAML的kustomization</p><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div class="gh gi no"><img src="../Images/144a55b0e67a31d48d8529fb1c9c475a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*Uw9qF1fSqK1lqy6LYZtooA.png"/></div></figure><p id="3910" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">运行“kustomize build”的输出</p><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi np"><img src="../Images/444ec74dbcfb265e7faf7d868b7c640d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QoKFtba02BT--iYFRaNcmw.png"/></div></div></figure><p id="7499" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">如果您想直接安装到您的kubernetes集群中，请使用</p><blockquote class="nd ne nf"><p id="2d02" class="ks kt nc ku b kv kw js kx ky kz jv la ng lc ld le nh lg lh li ni lk ll lm ln ij bi translated">kustomize build | kubectl apply -f -</p></blockquote><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi nq"><img src="../Images/480ec21a383170cc9ca2c767f82e72b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FKOUOtYBk0M3aKRrt1kRjw.png"/></div></div></figure><h2 id="afe1" class="me mf iq bd mg mh mi dn mj mk ml dp mm lb mn mo mp lf mq mr ms lj mt mu mv mw bi translated">赫尔姆·➕·库什托米泽</h2><p id="8363" class="pw-post-body-paragraph ks kt iq ku b kv mx js kx ky my jv la lb mz ld le lf na lh li lj nb ll lm ln ij bi translated">同时使用helm和kustomize是一个非常简单的三步过程。让我们这样安装MariaDB。</p><p id="01a0" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">将值文件覆盖到mariadb.yaml后，保存一个helm模板。在下面的示例中，值被config.yaml替换</p><blockquote class="nd ne nf"><p id="85e9" class="ks kt nc ku b kv kw js kx ky kz jv la ng lc ld le nh lg lh li ni lk ll lm ln ij bi translated">舵模板-f config . YAML stable/Maria db &gt; Maria db . YAML</p></blockquote><p id="7232" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">然后为mariadb.yaml添加kustomization YAML</p><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi nr"><img src="../Images/d00e3ad0cd249c1dc804e86a2fa2472f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dB4tlixZfzO4PoqnO4OpDQ.png"/></div></div></figure><p id="e42f" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">最后，定制更改并应用到集群</p><blockquote class="nd ne nf"><p id="4c3b" class="ks kt nc ku b kv kw js kx ky kz jv la ng lc ld le nh lg lh li ni lk ll lm ln ij bi translated">kustomize build | kubectl apply -f -</p></blockquote><p id="0c45" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">阅读有关Kubernetes DevOps 的端到端DevOps工作流<a class="ae ns" href="https://link.medium.com/yqPhMzi4G5" rel="noopener">的更多信息。</a></p><p id="e838" class="pw-post-body-paragraph ks kt iq ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">希望阅读有用。让我们创建一些强大的声明性工作流🚀。在下一篇文章中再见🏄</p></div></div>    
</body>
</html>