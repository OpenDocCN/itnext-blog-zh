<html>
<head>
<title>Write your own Javascript/Typescript tests runner in 80 lines of code &gt;</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用80行代码编写您自己的Javascript/Typescript测试运行程序&gt;</h1>
<blockquote>原文：<a href="https://itnext.io/write-your-own-javascript-typescript-tests-runner-in-80-lines-of-code-8eb00eeb2e63?source=collection_archive---------3-----------------------#2022-06-17">https://itnext.io/write-your-own-javascript-typescript-tests-runner-in-80-lines-of-code-8eb00eeb2e63?source=collection_archive---------3-----------------------#2022-06-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/33afa3604c7f55cd40b77f53442d8afb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9NdlhhQXhshN9TGKb9ADhw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">声音图像来自网络</figcaption></figure><p id="483a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在javascript echosystem中有许多测试运行程序，Jest、Karma、艾娃、Mocha等等。Deno有一个内置的，在echosystem中内置test和fmt是更好更成熟的IMO。</p><p id="1aff" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">那么这个帖子的动机是什么呢？基本上是为了表明在当前的nodejs echosystem中设计一个高性能的跑步者并不难。</p><p id="05a0" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">最初我想用Rust写一个，所以我问自己，我的基本技术要求是什么？</p><ol class=""><li id="423f" class="la lb iq ke b kf kg kj kk kn lc kr ld kv le kz lf lg lh li bi translated">我需要<strong class="ke ir">测试</strong> <strong class="ke ir">源代码</strong>包括它的依赖项，所以我需要一个捆绑器，为此我可以使用<a class="ae lj" href="https://github.com/swc-project/swc" rel="noopener ugc nofollow" target="_blank"> SWC </a>。</li></ol><blockquote class="lk ll lm"><p id="ffdf" class="kc kd ln ke b kf kg kh ki kj kk kl km lo ko kp kq lp ks kt ku lq kw kx ky kz ij bi translated">SWC是一个可扩展的基于Rust的平台，用于下一代快速开发工具。它被Next.js、Parcel和Deno等工具以及Vercel、字节跳动、腾讯、Shopify等公司使用。</p></blockquote><p id="dc34" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> 2。</strong>如果我要支持Typescript，我需要一个将转换成javascript的前一步<strong class="ke ir">——也可以使用<a class="ae lj" href="https://github.com/swc-project/swc" rel="noopener ugc nofollow" target="_blank"> SWC </a>。</strong></p><p id="f791" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> 3。</strong>我需要<strong class="ke ir">在javascript运行时上执行代码</strong>——嗯，我可以尝试使用来自deno项目的<a class="ae lj" href="https://github.com/denoland/rusty_v8" rel="noopener ugc nofollow" target="_blank">rusty _ V8</a>crate(crate = lib，类似于npm的节点模块)，该API看起来非常好——创建一个脚本并在<a class="ae lj" href="https://v8docs.nodesource.com/node-0.8/d5/dda/classv8_1_1_isolate.html" rel="noopener ugc nofollow" target="_blank"> isolate </a>上运行它(如果我目前理解的话)。</p><p id="171f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> 4。我需要设计一个测试结构和套件本身的API，这部分必须在Javascript中，因为这是用户将使用的东西，用户是Javascript开发人员。</strong></p><p id="0b17" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">当我想到4个要求时，我明白用Rust写一个并不值得，也不会以80行结束:P</p><h2 id="e9b8" class="lr ls iq bd lt lu lv dn lw lx ly dp lz kn ma mb mc kr md me mf kv mg mh mi mj bi translated">Run-Chewy CLI</h2><p id="335d" class="pw-post-body-paragraph kc kd iq ke b kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv mo kx ky kz ij bi translated">长话短说，我决定在nodejs中编写一个小小的runner:<a class="ae lj" href="https://github.com/LironHazan/run-chewy" rel="noopener ugc nofollow" target="_blank">run-chewy</a>这样我就可以更好地理解SWC核心包并使用工人线程。SWC公开了一个易于使用的javascript API，顺便说一句，这个插件系统可以添加你自己的访问者，也很不错..</p><p id="95b1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">切入点:</strong></p><p id="5011" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">测试运行器是一个<strong class="ke ir"> CLI工具</strong>，为了简单起见，我将传递给它一个参数，要求用户指定他是否使用Typescript。<br/>另一个选择是像chewy.json这样的配置文件</p><p id="f0c6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">项目入口点是触发run()方法的<strong class="ke ir"> cli.js </strong>文件。</p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="46dc" class="lr ls iq mu b gy my mz l na nb">const yargs = require('yargs/yargs')<br/>const { hideBin } = require('yargs/helpers')<br/>const argv = yargs(hideBin(<strong class="mu ir"><em class="ln">process</em></strong>.argv)).argv<br/>const ChewyRunner = require('./lib/runner');<br/><br/>if (argv.isTS) {<br/>    <strong class="mu ir"><em class="ln">console</em></strong>.log("running")<br/>    ChewyRunner.<em class="ln">run</em>({isTS: argv.isTS});<br/>} else {<br/>    <strong class="mu ir"><em class="ln">console</em></strong>.log("supply the isTS arg to decide if running js or ts tests")<br/>}</span></pre><p id="f43b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">亚军:</strong></p><p id="13ee" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">对跑者最基本的技术要求是:<br/> 1。我们需要运行测试文件的列表，该列表应该从我们正在运行的当前文件夹中获取。<br/> 2。我们需要迭代列表并解析每个文件，以获得完整的源代码(包括依赖项)。<br/> 3。如果是Typescript，我们需要在执行之前将源代码转换成javascript。<br/> 4。我们需要并行执行这些代码。<br/> 5。我们需要打印测试结果/打印错误，以防任何运行时故障。</p><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="11e9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">免责声明</strong> : <br/>以上代码在不到60行的代码中涵盖了我们定义的基本需求，但是<strong class="ke ir">缺少了</strong> the: <br/> 1。对于每个测试，我们都启动一个新的工作线程，而不是通过使用池来限制创建。<br/> 2。run方法是异步的，但是我没有捕获worker错误事件并拒绝。<br/> 3。在这个实现中不支持es模块。<br/> 4。我没有使用Typescript来编写runner :P</p><p id="8efe" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在我看来，实现中有趣的部分是使用swc javascript API。<br/>了解其配置的一个好地方是:</p><div class="ne nf gp gr ng nh"><a href="https://swc.rs/playground" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">SWC SWC游乐场</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">SWC是一个可扩展的基于Rust的平台，用于下一代快速开发工具。它被工具使用，例如…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">西南铁路公司</p></div></div><div class="nq l"><div class="nr l ns nt nu nq nv jw nh"/></div></div></a></div><p id="e6c7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">API:<br/></strong>API应该包括一个分组块，用于运行几个作为“套件”的测试，以及套件的描述，对于测试块也是如此，并且应该支持异步功能。<br/>这个块应该是热切的并立即运行，类似于我们熟悉的常见测试框架的“描述”结构。<br/>API应该公开比较器(不是必须的，因为我们可以使用外部库)。</p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="7f03" class="lr ls iq mu b gy my mz l na nb">Chewy.suite('suite', async () =&gt; {<br/>    <strong class="mu ir"><em class="ln">console</em></strong>.log('suite cb');<br/>    Chewy.test('test', () =&gt; {<br/>        Chewy.assertEq([[[1, 2, 3]], 4, 5], [[[1, 2, '3']], 4, 5]);<br/>    })<br/>})</span></pre><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="657b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">免责声明</strong> : <br/>上面的代码在大约20行中涵盖了我们为API定义的基本要求，但是有一些缺失的特性，比如可能更好的错误处理、before/teardown挂钩、跳过测试/套件实现以及可能的mocking utils..</p><p id="8bb6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">综上所述——用nodejs编写一个简单的几乎没有依赖的运行器是非常容易和有趣的，我没有发布到npm，所以不要在家里使用它:P</p><p id="3a19" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">目前就这些:)<br/>感谢您的阅读，欢迎您开始<a class="ae lj" href="https://github.com/LironHazan/run-chewy" rel="noopener ugc nofollow" target="_blank">回购</a>，祝您编码愉快！</p><p id="a680" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Liron \m/\m/</p></div></div>    
</body>
</html>