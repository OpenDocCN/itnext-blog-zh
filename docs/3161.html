<html>
<head>
<title>Azure App Service with On-premises Connection</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有内部连接的Azure应用服务</h1>
<blockquote>原文：<a href="https://itnext.io/azure-app-service-with-on-premises-connection-61ad773b0d8c?source=collection_archive---------2-----------------------#2019-10-14">https://itnext.io/azure-app-service-with-on-premises-connection-61ad773b0d8c?source=collection_archive---------2-----------------------#2019-10-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="4be1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">想象一下，你得到了一个新项目，它能够使用你想要的任何云服务。你欣然接受了这一变化，并使用<a class="ae kl" href="https://azure.microsoft.com/" rel="noopener ugc nofollow" target="_blank"> Azure </a>设计了一个令人惊叹的架构。接下来，您向团队的其他成员展示您的计划，并发现必须使用现有内部数据库的新需求。</p><p id="a9a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是不是意味着你的宏伟计划泡汤了？幸好没有，因为Azure有多种解决方案，允许您连接到现有的内部资源，以实现混合云策略。</p><p id="fe3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，我们将使用其中一个选项<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/app-service/app-service-hybrid-connections" rel="noopener ugc nofollow" target="_blank">混合连接</a>，从应用服务中托管的网站连接到本地数据库。</p><h2 id="de0d" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">示例应用程序</h2><p id="b434" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">我们将在这篇文章中使用的基本示例应用程序是一个新的Razor Pages应用程序。网芯3。在这篇文章的后面，我们将实际连接到数据库。要开始，你需要在Azure应用服务中创建和运行新应用。</p><p id="9466" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我已经多次演练了如何创建一个新的应用程序并将它们发布到Azure，所以我不打算在这里重复。如果你需要帮助来创建你的应用并将其发布到Azure，你可以查看我的<a class="ae kl" href="https://elanderson.net/2018/07/deploying-an-asp-net-core-application-to-microsoft-azure/" rel="noopener ugc nofollow" target="_blank">将ASP.NET核心应用部署到微软Azure </a>的帖子，不要使用Razor模板，而是使用如下的Web应用模板。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="ae68" class="km kn iq lp b gy lt lu l lv lw">dotnet new webapp</span></pre><p id="8dde" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，请注意，混合连接在免费或共享主机计划中不可用，因此当您设置发布配置文件时，请避免这些选项。</p><h2 id="3a25" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">向应用服务添加混合连接</h2><p id="ebf0" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">从<a class="ae kl" href="https://portal.azure.com/" rel="noopener ugc nofollow" target="_blank"> Azure门户</a>打开上面创建的应用服务，在菜单的<strong class="jp ir">设置</strong>部分点击<strong class="jp ir">联网</strong>。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/79d5f84635c4a7d8bfbc53620fdccc46.png" data-original-src="https://miro.medium.com/v2/resize:fit:464/format:webp/0*DHqjOJgLimLepKGT.png"/></div></figure><p id="9440" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在网络详细信息中，我们希望单击<strong class="jp ir">配置您的混合连接端点</strong>。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div class="gh gi mb"><img src="../Images/8eb3242f1e84b8c22e055f3e29512ab5.png" data-original-src="https://miro.medium.com/v2/resize:fit:906/format:webp/0*r9w5bimzXT6IyY5n.png"/></div></figure><p id="32e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我要再次指出，混合连接在免费和共享规模级别上不可用。如果您的应用服务是免费或共享的，使用<strong class="jp ir">向上扩展</strong>菜单选项切换到支持混合连接的规模级别。</p><p id="408d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从混合连接详细页面点击<strong class="jp ir">下载连接管理器</strong>。完成后，需要将它安装在运行要连接的本地数据库的计算机上。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi mc"><img src="../Images/5ee18534e089537bd37047267120807f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kXX0Sl6WD-OFVpCR.png"/></div></div></figure><p id="4786" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，点击<strong class="jp ir">刷新</strong>，然后点击<strong class="jp ir">添加混合连接</strong>。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi mh"><img src="../Images/a6d916894813328be01135df6629f35b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*esiKpmlDb7Ib4nBn.png"/></div></div></figure><p id="908c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，在添加混合连接页面上，单击<strong class="jp ir">创建新的混合连接</strong>。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi mi"><img src="../Images/19c6cb4d323fa0cb3aca88e354ad8c90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-A_xUBn7GRSuXKDi.png"/></div></div></figure><p id="1994" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了创建新的混合连接，Azure将需要一些信息。这里的关键部分是<strong class="jp ir">端点主机</strong>，它是托管您希望与之通信的数据库的机器的名称，以及<strong class="jp ir">端点端口</strong>，它需要是您的数据库被配置为通过其进行通信的端口。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/9818f7be896dada8c48f406a629d14ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:568/format:webp/0*x6fLWHWtZ0lOlqcB.png"/></div></figure><h2 id="bd2e" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">主机上的混合连接管理器</h2><p id="2ccb" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">既然Azure端已经配置好了，我们需要使用我们在上面的目标机器上安装的<strong class="jp ir">混合连接管理器</strong>应用程序来允许与我们的应用服务对话。</p><p id="4000" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在目标机器上打开混合连接管理器后，点击<strong class="jp ir">添加新的混合连接</strong>。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi mk"><img src="../Images/ae2820f05ed0fbf7b9f7af870997d1c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SBh8bivNILYwXQj2.png"/></div></div></figure><p id="e53f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在选择应用服务所属的<strong class="jp ir">订阅</strong>。列出可用连接后，加载<strong class="jp ir">选择上面创建的</strong>，最后点击<strong class="jp ir">保存</strong>。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi ml"><img src="../Images/784f2a48dbce7566b863a48f6e5d3561.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*H53W9-8Eco8Dh13i.png"/></div></div></figure><p id="a7f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在做了上面的更改后，我的混合连接在Azure中继续显示离线。经过一番搜索，我发现一篇博文建议<a class="ae kl" href="https://community.dynamics.com/crm/b/nishantranaweblog/posts/using-azure-hybrid-connections-to-connect-to-sql-on-prem-database-from-azure-webjob" rel="noopener ugc nofollow" target="_blank">重述Azure混合连接管理器服务</a>，这为我解决了问题。</p><h2 id="cf2b" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">连接到内部数据库的示例应用程序更改</h2><p id="02ba" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">这是一个非常原始的测试，但它表达了要点。首先，添加对<strong class="jp ir">系统的引用。data . SqlClient</strong>n获取包。接下来在<strong class="jp ir"> Index.cshtml.cs </strong>中删除<strong class="jp ir"> OnGet </strong>函数，并替换为以下内容。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="bb3b" class="km kn iq lp b gy lt lu l lv lw">public async Task OnGetAsync()<br/>{<br/>    Tables.Clear();<br/>    var connectionString = "data source=Server;initial catalog=master; User Id=User;Password=Password"";<br/>    await using var connection = new SqlConnection(connectionString);<br/>    await connection.OpenAsync();<br/>    await using var command = <br/>                    new SqlCommand("SELECT name FROM sys.tables", connection);<br/>    await using var reader = command.ExecuteReader();<br/><br/>    while (await reader.ReadAsync())<br/>    {<br/>        Tables.Add(reader["name"].ToString());<br/>    }<br/>}</span></pre><p id="477c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的代码连接到指定服务器上的master数据库，并提取一个表列表。请注意，您需要将连接字符串修改为对您的系统有效的字符串。同样重要的是要知道，您不能在此设置中使用集成安全性，因此您需要指定一个存在于您的SQL Server上的用户名和密码。在同一文件中添加以下属性。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="1257" class="km kn iq lp b gy lt lu l lv lw">public List&lt;string&gt; Tables { get; set; } = new List&lt;string&gt;();</span></pre><p id="d82a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将下面的内容添加到Index.cshtml的底部，这将输出我们在上面拉到页面上的表格列表。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="a456" class="km kn iq lp b gy lt lu l lv lw">@foreach (var table in Model.Tables)<br/>{<br/>    @table &lt;br/&gt;<br/>}</span></pre><p id="e03c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完成更改后，将应用程序重新发布到Azure应用服务。发布完成后，您的站点应该显示SQL Server的master数据库中存在的表的列表。</p><h2 id="25c9" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">包扎</h2><p id="c634" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">混合连接是一种将工作负载转移到云的好方法，而无需实际移动所有数据。这也是一周前我还不知道的Azure的特性之一。</p><p id="96cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您需要大量混合连接，请密切关注价格，因为您可以使用的数量与您使用的应用服务规模相关。可用的数量从5个开始，随着更昂贵的应用服务规模的增加，可以增加到200个。</p></div><div class="ab cl mm mn hu mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ij ik il im in"><p id="e0d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mt">原载于</em><a class="ae kl" href="https://elanderson.net/2019/10/azure-app-service-with-on-premises-connection/" rel="noopener ugc nofollow" target="_blank"><em class="mt"/></a><em class="mt">。</em></p></div></div>    
</body>
</html>