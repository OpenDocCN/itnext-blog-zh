<html>
<head>
<title>Getting Started with Infrastructure as Code (IaC) using Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform开始使用基础设施即代码(IaC)</h1>
<blockquote>原文：<a href="https://itnext.io/getting-started-with-infrastructure-as-code-iac-using-terraform-84f15fb72ae6?source=collection_archive---------1-----------------------#2018-05-26">https://itnext.io/getting-started-with-infrastructure-as-code-iac-using-terraform-84f15fb72ae6?source=collection_archive---------1-----------------------#2018-05-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><blockquote class="jn"><p id="4bba" class="jo jp iq bd jq jr js jt ju jv jw jx dk translated">基础设施作为代码的思想是，用来运行软件的系统和设备可以被视为软件本身。基夫·莫里斯的基础设施代码</p></blockquote><p id="7cba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku jx ij bi translated">我在YouTube上制作了两个视频:</p><ul class=""><li id="9e35" class="kv kw iq ka b kb kx kf ky kj kz kn la kr lb jx lc ld le lf bi translated"><a class="ae lg" href="https://www.youtube.com/watch?v=53X-HAw7BbA&amp;t=61s" rel="noopener ugc nofollow" target="_blank">基础设施代码简介(IaC) </a></li><li id="9a06" class="kv kw iq ka b kb lh kf li kj lj kn lk kr ll jx lc ld le lf bi translated"><a class="ae lg" href="https://www.youtube.com/watch?v=cpxKbf51ccU&amp;t=225s" rel="noopener ugc nofollow" target="_blank">地形介绍</a></li></ul><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi lm"><img src="../Images/ff586d3cb8b13741724931ef187aed19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rrEa9B9rJC1CatONfoytGQ.png"/></div></div></figure><p id="36f0" class="pw-post-body-paragraph jy jz iq ka b kb kx kd ke kf ky kh ki kj ly kl km kn lz kp kq kr ma kt ku jx ij bi translated">在本文中，我们将在Mac OSX上安装Terraform，并使用Terraform在AWS上部署EC2实例，而不是通过单击AWS EC2 Web控制台进行手动部署。</p><ul class=""><li id="b646" class="kv kw iq ka b kb kx kf ky kj kz kn la kr lb jx lc ld le lf bi translated">在$HOME下创建一个目录，下载并解压<a class="ae lg" href="https://www.terraform.io/downloads.html" rel="noopener ugc nofollow" target="_blank"> Terraform </a>。</li></ul><pre class="ln lo lp lq gt mb mc md me aw mf bi"><span id="78c7" class="mg mh iq mc b gy mi mj l mk ml">$ mkdir terraform<br/>$ cd $HOME/terraform<br/><br/>$ curl -O https://releases.hashicorp.com/terraform/0.11.7/terraform_0.11.7_darwin_amd64.zip<br/><br/>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current<br/><br/>                                 Dload  Upload   Total   Spent    Left  Speed<br/><br/>100 16.9M  100 16.9M    0     0  18.7M      0 --:--:-- --:--:-- --:--:-- 18.7M<br/><br/>$ unzip terraform_0.11.7_darwin_amd64.zip<br/><br/>Archive:  terraform_0.11.7_darwin_amd64.zip<br/><br/>  inflating: terraform</span></pre><ul class=""><li id="a018" class="kv kw iq ka b kb kx kf ky kj kz kn la kr lb jx lc ld le lf bi translated">在~/下设置路径。bash_profile</li></ul><pre class="ln lo lp lq gt mb mc md me aw mf bi"><span id="e817" class="mg mh iq mc b gy mi mj l mk ml"><em class="mm"># Setting PATH for Terraform</em><br/><br/>TERRAFORM=~/terraform/<br/><br/>PATH=$PATH:$TERRAFORM</span></pre><ul class=""><li id="5795" class="kv kw iq ka b kb kx kf ky kj kz kn la kr lb jx lc ld le lf bi translated">打开一个新的终端并验证。</li></ul><pre class="ln lo lp lq gt mb mc md me aw mf bi"><span id="9019" class="mg mh iq mc b gy mi mj l mk ml"><em class="mm">$</em> <em class="mm">terraform</em> --<em class="mm">version</em><br/><br/><em class="mm">Terraform</em> <em class="mm">v0</em>.<em class="mm">11</em>.<em class="mm">7</em></span><span id="be07" class="mg mh iq mc b gy mn mj l mk ml">$ terraform<br/><br/>Usage: terraform [<em class="mm">--version] [--help] &lt;command&gt; [args]</em><br/>The available commands for execution are listed below.<br/>The most common, useful commands are shown first, followed by<br/>less common or more advanced commands. If you're just getting<br/>started with Terraform, stick with the common commands. For the<br/>other commands, please read the help and docs before usage.<br/>Common commands:<br/><br/>    apply              Builds or changes infrastructure<br/><br/>    console            Interactive console for Terraform interpolations<br/><br/>    destroy            Destroy Terraform-managed infrastructure<br/><br/>    env                Workspace management<br/><br/>    fmt                Rewrites config files to canonical format<br/><br/>    get                Download and install modules for the configuration<br/><br/>    graph              Create a visual graph of Terraform resources<br/><br/>    import             Import existing infrastructure into Terraform<br/><br/>    init               Initialize a Terraform working directory<br/><br/>    output             Read an output from a state file<br/><br/>    plan               Generate and show an execution plan<br/><br/>    providers          Prints a tree of the providers used in the configuration<br/><br/>    push               Upload this Terraform module to Atlas to run<br/><br/>    refresh            Update local state file against real resources<br/><br/>    show               Inspect Terraform state or plan<br/><br/>    taint              Manually mark a resource for recreation<br/><br/>    untaint            Manually unmark a resource as tainted<br/><br/>    validate           Validates the Terraform files<br/><br/>    version            Prints the Terraform version<br/><br/>    workspace          Workspace management<br/><br/><br/><br/>All other commands:<br/><br/>    debug              Debug output management (experimental)<br/><br/>    force-unlock       Manually unlock the terraform state<br/><br/>    state              Advanced state management</span></pre><p id="1825" class="pw-post-body-paragraph jy jz iq ka b kb kx kd ke kf ky kh ki kj ly kl km kn lz kp kq kr ma kt ku jx ij bi translated">恭喜你！！！Terraform已经启动并运行。</p><ul class=""><li id="15c0" class="kv kw iq ka b kb kx kf ky kj kz kn la kr lb jx lc ld le lf bi translated">让我们使用Terraform在AWS中启动一个虚拟机。我们必须已经有AWS帐户，否则我们可以<a class="ae lg" href="https://aws.amazon.com/free/" rel="noopener ugc nofollow" target="_blank">在这里</a>创建一个。</li><li id="970b" class="kv kw iq ka b kb lh kf li kj lj kn lk kr ll jx lc ld le lf bi translated">我们将在~HOME/下创建一个名为“terraform”的配置文件。存储我们的aws配置和凭证的AWS。</li></ul><pre class="ln lo lp lq gt mb mc md me aw mf bi"><span id="6dad" class="mg mh iq mc b gy mi mj l mk ml">$ cd .aws<br/>$ more credentials <br/><br/>[terraform]<br/>aws_access_key_id= [paste-access-key-here]<br/>aws_secret_access_key= [paste-secret-access-key-here]<br/><br/>$ more config<br/>[profile terraform]<br/>region = us-east-1<br/>output = json</span></pre><ul class=""><li id="e59c" class="kv kw iq ka b kb kx kf ky kj kz kn la kr lb jx lc ld le lf bi translated">在$HOME/terraform下创建一个名为“webserver.tf”的terraform配置。</li></ul><pre class="ln lo lp lq gt mb mc md me aw mf bi"><span id="f6d5" class="mg mh iq mc b gy mi mj l mk ml">$ more webserver.tf<br/>provider "aws" {<br/>  region                   = "us-east-1"<br/>  shared_credentials_file  = "/Users/hellocloud/.aws/credentials"<br/>  profile                  = "terraform"<br/>}<br/><br/>resource "aws_instance" "web_svr" {<br/>    ami = "ami-1c47407f"<br/>    instance_type = "t2.micro"<br/>    key_name      = "helloterraform"<br/>}</span></pre><ul class=""><li id="1d54" class="kv kw iq ka b kb kx kf ky kj kz kn la kr lb jx lc ld le lf bi translated">运行命令$ terraform plan，并观察输出。</li></ul><pre class="ln lo lp lq gt mb mc md me aw mf bi"><span id="dbb7" class="mg mh iq mc b gy mi mj l mk ml">$ terraform plan<br/>Refreshing Terraform state in-memory prior to plan...<br/>The refreshed state will be used to calculate this plan, but<br/>will not be persisted to local or remote state storage.<br/><br/><br/>The Terraform execution plan has been generated and is shown below.<br/>Resources are shown in alphabetical order for quick scanning. Green resources<br/>will be created (or destroyed and then created if an existing resource<br/>exists), yellow resources are being changed in-place, and red resources<br/>will be destroyed. Cyan entries are data sources to be read.<br/><br/>Note: You didn't specify an "-out" parameter to save this plan, so when<br/>"apply" is called, Terraform can't guarantee this is what will execute.<br/><br/>+ aws_instance.web_svr<br/>    ami:                         "ami-1c47407f"<br/>    associate_public_ip_address: "&lt;computed&gt;"<br/>    availability_zone:           "&lt;computed&gt;"<br/>    ebs_block_device.<em class="mm">#:          "&lt;computed&gt;"</em><br/>    ephemeral_block_device.<em class="mm">#:    "&lt;computed&gt;"</em><br/>    instance_state:              "&lt;computed&gt;"<br/>    instance_type:               "t2.micro"<br/>    ipv6_addresses.<em class="mm">#:            "&lt;computed&gt;"</em><br/>    key_name:                    "helloterraform"<br/>    network_interface_id:        "&lt;computed&gt;"<br/>    placement_group:             "&lt;computed&gt;"<br/>    private_dns:                 "&lt;computed&gt;"<br/>    private_ip:                  "&lt;computed&gt;"<br/>    public_dns:                  "&lt;computed&gt;"<br/>    public_ip:                   "&lt;computed&gt;"<br/>    root_block_device.<em class="mm">#:         "&lt;computed&gt;"</em><br/>    security_groups.<em class="mm">#:           "&lt;computed&gt;"</em><br/>    source_dest_check:           "true"<br/>    subnet_id:                   "&lt;computed&gt;"<br/>    tenancy:                     "&lt;computed&gt;"<br/>    vpc_security_group_ids.<em class="mm">#:    "&lt;computed&gt;"</em><br/><br/><br/>Plan: 1 to add, 0 to change, 0 to destroy.</span></pre><ul class=""><li id="a42c" class="kv kw iq ka b kb kx kf ky kj kz kn la kr lb jx lc ld le lf bi translated">运行命令terraform apply，并观察输出。</li></ul><pre class="ln lo lp lq gt mb mc md me aw mf bi"><span id="7ba8" class="mg mh iq mc b gy mi mj l mk ml">$ terraform apply<br/>aws_instance.web_svr: Creating...<br/>  ami:                         "" =&gt; "ami-1c47407f"<br/>  associate_public_ip_address: "" =&gt; "&lt;computed&gt;"<br/>  availability_zone:           "" =&gt; "&lt;computed&gt;"<br/>  ebs_block_device.<em class="mm">#:          "" =&gt; "&lt;computed&gt;"</em><br/>  ephemeral_block_device.<em class="mm">#:    "" =&gt; "&lt;computed&gt;"</em><br/>  instance_state:              "" =&gt; "&lt;computed&gt;"<br/>  instance_type:               "" =&gt; "t2.micro"<br/>  ipv6_addresses.<em class="mm">#:            "" =&gt; "&lt;computed&gt;"</em><br/>  key_name:                    "" =&gt; "helloterraform"<br/>  network_interface_id:        "" =&gt; "&lt;computed&gt;"<br/>  placement_group:             "" =&gt; "&lt;computed&gt;"<br/>  private_dns:                 "" =&gt; "&lt;computed&gt;"<br/>  private_ip:                  "" =&gt; "&lt;computed&gt;"<br/>  public_dns:                  "" =&gt; "&lt;computed&gt;"<br/>  public_ip:                   "" =&gt; "&lt;computed&gt;"<br/>  root_block_device.<em class="mm">#:         "" =&gt; "&lt;computed&gt;"</em><br/>  security_groups.<em class="mm">#:           "" =&gt; "&lt;computed&gt;"</em><br/>  source_dest_check:           "" =&gt; "true"<br/>  subnet_id:                   "" =&gt; "&lt;computed&gt;"<br/>  tenancy:                     "" =&gt; "&lt;computed&gt;"<br/>  vpc_security_group_ids.<em class="mm">#:    "" =&gt; "&lt;computed&gt;"</em><br/>aws_instance.web_svr: Still creating... (10s elapsed)<br/>aws_instance.web_svr: Creation complete<br/><br/>Apply complete! Resources: 1 added, 0 changed, 0 destroyed.<br/><br/>The state of your infrastructure has been saved to the path<br/>below. This state is required to modify and destroy your<br/>infrastructure, so keep it safe. To inspect the complete state<br/>use the `terraform show` command.<br/><br/>State path: terraform.tfstate</span></pre><p id="872f" class="pw-post-body-paragraph jy jz iq ka b kb kx kd ke kf ky kh ki kj ly kl km kn lz kp kq kr ma kt ku jx ij bi translated">将有一个名为“terraform.tfstate”的文件被创建。该状态文件非常重要，因为它将各种资源元数据映射到实际的资源id，以便Terraform知道它正在管理什么。该文件必须保存并分发给任何可能运行Terraform的人。[摘自:<a class="ae lg" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank">https://www.terraform.io/</a>]</p><ul class=""><li id="f783" class="kv kw iq ka b kb kx kf ky kj kz kn la kr lb jx lc ld le lf bi translated">运行命令$ terraform show进行验证。</li></ul><pre class="ln lo lp lq gt mb mc md me aw mf bi"><span id="4371" class="mg mh iq mc b gy mi mj l mk ml">$ terraform show<br/>aws_instance.web_svr:<br/>  id = i-03caa2b3676820d9d<br/>  ami = ami-1c47407f<br/>  associate_public_ip_address = true<br/>  availability_zone = ap-southeast-2b<br/>  disable_api_termination = false<br/>  ebs_block_device.<em class="mm"># = 0</em><br/>  ebs_optimized = false<br/>  ephemeral_block_device.<em class="mm"># = 0</em><br/>  iam_instance_profile = <br/>  instance_state = running<br/>  instance_type = t2.micro<br/>  ipv6_address_count = 0<br/>  ipv6_addresses.<em class="mm"># = 0</em><br/>  key_name = helloterraform<br/>  monitoring = false<br/>  network_interface_id = eni-f80d9c83<br/>  private_dns = ip-172-31-14-81.ap-southeast-2.compute.internal<br/>  private_ip = 172.31.14.81<br/>  public_dns = ec2-13-55-176-59.ap-southeast-2.compute.amazonaws.com<br/>  public_ip = 13.55.176.59<br/>  root_block_device.<em class="mm"># = 1</em><br/>  root_block_device.0.delete_on_termination = true<br/>  root_block_device.0.iops = 100<br/>  root_block_device.0.volume_size = 8<br/>  root_block_device.0.volume_type = gp2<br/>  security_groups.<em class="mm"># = 0</em><br/>  source_dest_check = true<br/>  subnet_id = subnet-ea4f928e<br/>  tags.% = 0<br/>  tenancy = default<br/>  vpc_security_group_ids.<em class="mm"># = 1</em><br/>  vpc_security_group_ids.2657148695 = sg-1e683a7a</span></pre><ul class=""><li id="d761" class="kv kw iq ka b kb kx kf ky kj kz kn la kr lb jx lc ld le lf bi translated">让我们登录AWS控制台并进行验证。</li></ul><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/28fed1cd0645bcc2b576b4ce1b41947e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*HGhh3-4RCfeK6_hyD_UmQw.png"/></div></figure><p id="3b47" class="pw-post-body-paragraph jy jz iq ka b kb kx kd ke kf ky kh ki kj ly kl km kn lz kp kq kr ma kt ku jx ij bi translated">酷！！！</p><p id="13eb" class="pw-post-body-paragraph jy jz iq ka b kb kx kd ke kf ky kh ki kj ly kl km kn lz kp kq kr ma kt ku jx ij bi translated">但是，我们忘了标记实例。所以我们编辑一下webserver.tf如下。</p><pre class="ln lo lp lq gt mb mc md me aw mf bi"><span id="547f" class="mg mh iq mc b gy mi mj l mk ml">provider "aws" {<br/>  region                   = "ap-southeast-2"<br/>  shared_credentials_file  = "/Users/hellocloud/.aws/credentials"<br/>  profile                  = "terraform"<br/>}<br/><br/>resource "aws_instance" "web_svr" {<br/>    ami = "ami-1c47407f"<br/>    instance_type = "t2.micro"<br/>    key_name      = "helloterraform"<br/>    <strong class="mc ir">tags = { Name = "web_svr"}</strong><br/>}</span></pre><ul class=""><li id="7e54" class="kv kw iq ka b kb kx kf ky kj kz kn la kr lb jx lc ld le lf bi translated">现在我们要重复同样的地形改造过程。</li></ul><pre class="ln lo lp lq gt mb mc md me aw mf bi"><span id="8093" class="mg mh iq mc b gy mi mj l mk ml">$ terraform plan<br/>$ terraform apply<br/>$ terraform show</span></pre><ul class=""><li id="2c4f" class="kv kw iq ka b kb kx kf ky kj kz kn la kr lb jx lc ld le lf bi translated">登录AWS控制台并验证名称列。</li></ul><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/cc6810acc9f46884c1e993d87476a886.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*FMRpj_NoreZ568uF4CAkvA.png"/></div></figure><ul class=""><li id="4678" class="kv kw iq ka b kb kx kf ky kj kz kn la kr lb jx lc ld le lf bi translated">让我们通过键入$ terraform plan -destroy进行清理。</li></ul><pre class="ln lo lp lq gt mb mc md me aw mf bi"><span id="f030" class="mg mh iq mc b gy mi mj l mk ml">$ terraform plan -destroy<br/>Refreshing Terraform state in-memory prior to plan...<br/>The refreshed state will be used to calculate this plan, but<br/>will not be persisted to local or remote state storage.<br/><br/>aws_instance.web_svr: Refreshing state... (ID: i-03caa2b3676820d9d)<br/><br/>The Terraform execution plan has been generated and is shown below.<br/>Resources are shown in alphabetical order for quick scanning. Green resources<br/>will be created (or destroyed and then created if an existing resource<br/>exists), yellow resources are being changed in-place, and red resources<br/>will be destroyed. Cyan entries are data sources to be read.<br/><br/>Note: You didn't specify an "-out" parameter to save this plan, so when<br/>"apply" is called, Terraform can't guarantee this is what will execute.<br/><br/>- aws_instance.web_svr<br/><br/><br/>Plan: 0 to add, 0 to change, 1 to destroy.</span></pre><ul class=""><li id="0d7d" class="kv kw iq ka b kb kx kf ky kj kz kn la kr lb jx lc ld le lf bi translated">让我们现在就毁灭吧。$ terraform毁灭。</li></ul><pre class="ln lo lp lq gt mb mc md me aw mf bi"><span id="4ffc" class="mg mh iq mc b gy mi mj l mk ml">$ terraform destroy<br/>Do you really want to destroy?<br/>  Terraform will delete all your managed infrastructure.<br/>  There is no undo. Only 'yes' will be accepted to confirm.<br/><br/>  Enter a value: yes<br/><br/>aws_instance.web_svr: Refreshing state... (ID: i-03caa2b3676820d9d)<br/>aws_instance.web_svr: Destroying...<br/>aws_instance.web_svr: Still destroying... (10s elapsed)<br/>aws_instance.web_svr: Still destroying... (20s elapsed)<br/>aws_instance.web_svr: Still destroying... (30s elapsed)<br/>aws_instance.web_svr: Still destroying... (40s elapsed)<br/>aws_instance.web_svr: Still destroying... (50s elapsed)<br/>aws_instance.web_svr: Still destroying... (1m0s elapsed)<br/>aws_instance.web_svr: Destruction complete<br/><br/>Destroy complete! Resources: 1 destroyed.</span></pre><ul class=""><li id="9921" class="kv kw iq ka b kb kx kf ky kj kz kn la kr lb jx lc ld le lf bi translated">在AWS控制台上验证。</li></ul><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/d86022cd5070444259f9e20e8f6861f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*FHs5A2ysOVwp3eB1NjEHow.png"/></div></figure><p id="e34c" class="pw-post-body-paragraph jy jz iq ka b kb kx kd ke kf ky kh ki kj ly kl km kn lz kp kq kr ma kt ku jx ij bi translated">终止！！！</p><p id="7b49" class="pw-post-body-paragraph jy jz iq ka b kb kx kd ke kf ky kh ki kj ly kl km kn lz kp kq kr ma kt ku jx ij bi translated">现在我们有了使用Terraform将基础设施作为代码的想法。</p><p id="75b5" class="pw-post-body-paragraph jy jz iq ka b kb kx kd ke kf ky kh ki kj ly kl km kn lz kp kq kr ma kt ku jx ij bi translated">我们想要自动化或定义资源，如虚拟机、网络、存储和容器，如Google Cloud、Azure、Docker、Kubernetes等的IaC。查看一下<a class="ae lg" href="https://www.terraform.io/docs/providers/" rel="noopener ugc nofollow" target="_blank"> Terraform提供商。</a></p></div></div>    
</body>
</html>