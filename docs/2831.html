<html>
<head>
<title>Getting Started with PostgreSQL using Amazon RDS, CloudFormation, pgAdmin, and Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Amazon RDS、CloudFormation、pgAdmin和Python开始使用PostgreSQL</h1>
<blockquote>原文：<a href="https://itnext.io/getting-started-with-postgresql-using-amazon-rds-cloudformation-pgadmin-and-python-d11aa98e6409?source=collection_archive---------2-----------------------#2019-08-10">https://itnext.io/getting-started-with-postgresql-using-amazon-rds-cloudformation-pgadmin-and-python-d11aa98e6409?source=collection_archive---------2-----------------------#2019-08-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><h1 id="ddec" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">介绍</h1><p id="f7f0" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在接下来的文章中，我们将探讨如何开始为PostgreSQL使用Amazon关系数据库服务(RDS)。CloudFormation将用于在新的VPC中构建PostgreSQL主数据库实例和单个读取副本。AWS系统管理器参数存储将用于存储我们的云形成配置值。Amazon RDS事件通知将向我们的移动设备发送文本消息，让我们知道RDS实例何时可以使用。运行之后，我们将研究与数据库实例交互的各种方法，包括pgAdmin、Adminer和Python。</p><h1 id="7e66" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">技术</h1><p id="43fe" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">本文中使用的主要技术包括。</p><h2 id="871f" class="lm jr it bd js ln lo dn jw lp lq dp ka kz lr ls ke ld lt lu ki lh lv lw km lx bi translated">一种数据库系统</h2><p id="9953" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">据其网站介绍，<a class="ae ly" href="https://www.postgresql.org/" rel="noopener ugc nofollow" target="_blank"> PostgreSQL </a>，俗称Postgres，是世界上最先进的开源关系数据库。PostgreSQL起源于1986年的加州大学伯克利分校，拥有30多年的核心开发经验。PostgreSQL因其成熟的架构、可靠性、数据完整性、强大的功能集和可扩展性而赢得了良好的声誉。PostgreSQL可以在所有主流操作系统上运行，并且自2001年以来一直是ACID兼容的。</p><h2 id="0236" class="lm jr it bd js ln lo dn jw lp lq dp ka kz lr ls ke ld lt lu ki lh lv lw km lx bi translated">亚马逊RDS for PostgreSQL</h2><p id="5a21" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">据亚马逊介绍，<a class="ae ly" href="https://aws.amazon.com/rds/" rel="noopener ugc nofollow" target="_blank">亚马逊关系数据库服务</a> (RDS)提供了六种熟悉的数据库引擎可供选择，包括亚马逊Aurora、PostgreSQL、MySQL、MariaDB、Oracle数据库和SQL Server。RDS可用于几种数据库实例类型——针对内存、性能或I/O进行了优化。</p><p id="07f3" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">Amazon RDS for PostgreSQL使得在云中设置、操作和扩展PostgreSQL部署变得非常容易。亚马逊RDS支持最新的<a class="ae ly" href="https://www.postgresql.org/docs/11/release-11-4.html" rel="noopener ugc nofollow" target="_blank"> PostgreSQL版本11 </a>，其中包括性能、健壮性、事务管理、查询并行性等多项增强。</p><h1 id="7e9a" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">自动气象站云形成</h1><p id="9f8a" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">据Amazon称，<a class="ae ly" href="https://aws.amazon.com/cloudformation/" rel="noopener ugc nofollow" target="_blank"> CloudFormation </a>提供了一种通用语言来描述和供应基于AWS的云环境中的所有基础设施资源。CloudFormation允许您使用基于JSON或YAML的模板，以自动化和安全的方式，跨所有AWS区域和帐户建模和提供应用程序所需的所有资源。</p><h1 id="b65a" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">示范</h1><h2 id="35a0" class="lm jr it bd js ln lo dn jw lp lq dp ka kz lr ls ke ld lt lu ki lh lv lw km lx bi translated">体系结构</h2><p id="e0e7" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">下面，我们将看到演示中将要构建的架构。这不是典型的<a class="ae ly" href="https://blog.stratus10.com/aws-best-practices-3-tier-infrastructure" rel="noopener ugc nofollow" target="_blank">三层AWS架构</a>，其中RDS实例将被放置在私有子网(数据层)中，并且只能由运行在AWS上的应用层访问。演示的架构设计用于通过外部数据库客户端(如pgAdmin)和应用程序(如本地Python脚本)与RDS进行交互，这将在本文后面详细介绍。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi me"><img src="../Images/c02da6421577e2376d0fa74bd146b191.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WsqLmSgyfSSIVEERqyUm4w.png"/></div></div></figure><h2 id="696e" class="lm jr it bd js ln lo dn jw lp lq dp ka kz lr ls ke ld lt lu ki lh lv lw km lx bi translated">源代码</h2><p id="e64e" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这篇文章的所有源代码都可以在GitHub的一个公共存储库中获得，<a class="ae ly" href="https://github.com/garystafford/aws-rds-postgres" rel="noopener ugc nofollow" target="_blank"> postgres-rds-demo </a>。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="8c02" class="lm jr it mr b gy mv mw l mx my">.<br/>├── LICENSE.md<br/>├── README.md<br/>├── cfn-templates<br/>│   ├── event.template<br/>│   ├── rds.template<br/>├── parameter_store_values.sh<br/>├── python-scripts<br/>│   ├── create_pagila_data.py<br/>│   ├── database.ini<br/>│   ├── db_config.py<br/>│   ├── query_postgres.py<br/>│   ├── requirements.txt<br/>│   └── unit_tests.py<br/>├── sql-scripts<br/>│   ├── pagila-insert-data.sql<br/>│   └── pagila-schema.sql<br/>└── stack.yml</span></pre><p id="e3c9" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">要克隆<a class="ae ly" href="https://github.com/garystafford/aws-rds-postgres" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>，执行以下命令。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="ceb0" class="lm jr it mr b gy mv mw l mx my">git clone --branch master --single-branch --depth 1 --no-tags \ <a class="ae ly" href="https://github.com/garystafford/aws-rds-postgres.git" rel="noopener ugc nofollow" target="_blank">https://github.com/garystafford/aws-rds-postgres.git</a></span></pre><h2 id="0b6f" class="lm jr it bd js ln lo dn jw lp lq dp ka kz lr ls ke ld lt lu ki lh lv lw km lx bi translated">先决条件</h2><p id="94eb" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在本演示中，我假设您已经拥有一个AWS帐户。此外，您的开发机器上安装了最新版本的AWS CLI和Python 3。或者，对于pgAdmin和Adminer，您还需要安装Docker。</p><h2 id="e49d" class="lm jr it bd js ln lo dn jw lp lq dp ka kz lr ls ke ld lt lu ki lh lv lw km lx bi translated">步伐</h2><p id="96de" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在本演示中，我们将执行以下步骤。</p><ul class=""><li id="a737" class="mz na it kq b kr lz kv ma kz nb ld nc lh nd ll ne nf ng nh bi translated">将云信息配置值放入参数存储中；</li><li id="289a" class="mz na it kq b kr ni kv nj kz nk ld nl lh nm ll ne nf ng nh bi translated">执行CloudFormation模板以创建AWS资源；</li><li id="ce7e" class="mz na it kq b kr ni kv nj kz nk ld nl lh nm ll ne nf ng nh bi translated">使用Python执行SQL脚本，用样本数据填充新数据库；</li><li id="f654" class="mz na it kq b kr ni kv nj kz nk ld nl lh nm ll ne nf ng nh bi translated">配置到RDS PostgreSQL实例的pgAdmin和Python连接；</li></ul><h1 id="3a1e" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">AWS系统管理器参数存储</h1><p id="f05b" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">对于AWS，通常使用像<a class="ae ly" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html" rel="noopener ugc nofollow" target="_blank"> AWS系统管理器参数存储</a>和<a class="ae ly" href="https://aws.amazon.com/secrets-manager/" rel="noopener ugc nofollow" target="_blank"> AWS秘密管理器</a>这样的服务来存储公开的、敏感的和秘密的配置值。这些值由您的代码使用，或者来自像CloudFormation这样的AWS服务。参数存储允许我们遵循适当的十二因素、云原生实践<a class="ae ly" href="https://12factor.net/config" rel="noopener ugc nofollow" target="_blank">将配置与代码</a>分离。</p><p id="4b4e" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">为了演示参数存储的使用，我们将把一些CloudFormation配置项放入参数存储中。该演示的GitHub存储库包括一个shell脚本<code class="fe nn no np mr b"><a class="ae ly" href="https://github.com/garystafford/aws-rds-postgres/blob/master/parameter_store_values.sh" rel="noopener ugc nofollow" target="_blank">parameter_store_values.sh</a></code>，它将把必要的参数放入参数存储中。</p><p id="2429" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">下面，我们看到几个演示的配置值，这些值已被放入参数存储。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nq"><img src="../Images/3160f00ddd532fe2353f50663b291318.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*GmN2A_8blDh4pXr-"/></div></div></figure><h2 id="a41d" class="lm jr it bd js ln lo dn jw lp lq dp ka kz lr ls ke ld lt lu ki lh lv lw km lx bi translated">安全措施</h2><p id="311d" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们的其他参数以<a class="ae ly" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/parameter-store-about-examples.html" rel="noopener ugc nofollow" target="_blank"> String </a>数据类型存储在参数存储中，而数据库的主用户密码以<a class="ae ly" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-paramstore-securestring.html" rel="noopener ugc nofollow" target="_blank"> SecureString </a>数据类型存储。参数存储使用一个<a class="ae ly" href="https://aws.amazon.com/kms/" rel="noopener ugc nofollow" target="_blank"> AWS密钥管理服务</a> (KMS)客户主密钥(CMK)来加密安全参数值。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nq"><img src="../Images/f0a1c065de0f10728fe5368a111e1da2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*3r8IDHDMu564a7ds"/></div></div></figure><h2 id="a1bb" class="lm jr it bd js ln lo dn jw lp lq dp ka kz lr ls ke ld lt lu ki lh lv lw km lx bi translated">短信文本提醒选项</h2><p id="7585" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在运行参数存储脚本之前，您需要将脚本中的<code class="fe nn no np mr b">/rds_demo/alert_phone</code>参数值(<em class="nr">显示在</em>下方)更改为您的移动设备号码，包括国家代码，例如“+12038675309”。亚马逊SNS将使用它发送短信，使用<a class="ae ly" href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_Events.html" rel="noopener ugc nofollow" target="_blank">亚马逊RDS事件通知</a>。如果您不想使用这个消息传递特性，只需忽略这个参数，不要执行前面步骤中的<code class="fe nn no np mr b">event.template</code> CloudFormation模板。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="719b" class="lm jr it mr b gy mv mw l mx my">aws ssm put-parameter \<br/>  <strong class="mr iu">--name /rds_demo/alert_phone</strong> \<br/>  --type String \<br/>  --value "<strong class="mr iu">your_phone_number_here</strong>" \<br/>  --description "RDS alert SMS phone number" \<br/>  --overwrite</span></pre><p id="c5d4" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">运行以下命令来执行shell脚本<code class="fe nn no np mr b">parameter_store_values.sh</code>，它会将必要的参数放入参数存储中。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="616a" class="lm jr it mr b gy mv mw l mx my">sh ./<!-- -->parameter_store_values.sh</span></pre><h1 id="e19f" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">云形成模板</h1><p id="7b2c" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">GitHub存储库包括两个CloudFormation模板，<code class="fe nn no np mr b"><a class="ae ly" href="https://github.com/garystafford/aws-rds-postgres/blob/master/cfn-templates/event.template" rel="noopener ugc nofollow" target="_blank">cfn-templates/event.template</a></code>和<code class="fe nn no np mr b"><a class="ae ly" href="https://github.com/garystafford/aws-rds-postgres/blob/master/cfn-templates/rds.template" rel="noopener ugc nofollow" target="_blank">cfn-templates/rds.template</a></code>。此事件模板包含两个资源，即AWS SNS主题和AWS RDS事件订阅。RDS模板还包括几个资源，包括一个VPC、互联网网关、<a class="ae ly" href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html" rel="noopener ugc nofollow" target="_blank"> VPC安全组</a>、两个公共子网、一个RDS主数据库实例和一个<a class="ae ly" href="https://aws.amazon.com/rds/details/read-replicas/" rel="noopener ugc nofollow" target="_blank"> AWS RDS读取副本</a>数据库实例。</p><p id="1ab6" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">这些资源被分成两个CloudFormation模板，因此我们可以首先独立于创建或删除RDS实例来创建通知资源。这将确保我们收到所有关于数据库创建和删除的短信提醒。</p><h2 id="8b2a" class="lm jr it bd js ln lo dn jw lp lq dp ka kz lr ls ke ld lt lu ki lh lv lw km lx bi translated">模板参数</h2><p id="b749" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">两个CloudFormation模板总共包含大约15个参数。大多数情况下，您可以使用我设置的默认值，或者选择覆盖它们。四个参数将从参数存储中实现。其中，master数据库密码的处理略有不同，因为它是安全的(在参数存储中加密)。下面是显示这两种类型参数的模板片段。最后两个从参数存储中完成。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="62b0" class="lm jr it mr b gy mv mw l mx my">DBInstanceClass:<br/>  Type: String<br/>  Default: "db.t3.small"<br/>DBStorageType:<br/>  Type: String<br/>  Default: "gp2"<br/>DBUser:<br/>  Type: String<br/>  Default: "{{resolve:ssm:/rds_demo/master_username:1}}"<br/>DBPassword:<br/>  Type: String<br/><strong class="mr iu">  Default: "{{resolve:ssm-secure:/rds_demo/master_password:1}}"</strong><br/>  NoEcho: True</span></pre><p id="fa29" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">选择默认的CloudFormation参数值将导致两个最低配置的RDS实例在具有10 GiB通用(SSD)存储的db.t3.small实例上运行PostgreSQL 11.4数据库引擎。<a class="ae ly" href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.DBInstanceClass.html#Concepts.DBInstanceClass.Types" rel="noopener ugc nofollow" target="_blank"> db.t3 </a> DB实例是最新一代可突发性能实例类的一部分。主实例没有针对<a class="ae ly" href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.MultiAZ.html" rel="noopener ugc nofollow" target="_blank">多AZ </a>高可用性进行配置。但是，主副本和读取副本都在同一个AWS区域内的不同可用性区域(AZ)中运行。</p><h2 id="ef26" class="lm jr it bd js ln lo dn jw lp lq dp ka kz lr ls ke ld lt lu ki lh lv lw km lx bi translated">参数版本化</h2><p id="f6e3" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">将参数放入参数存储时，对参数的后续更新会导致该参数的版本号递增。注意在上面的例子中，参数的版本是CloudFormation所需要的，这里是“1”。如果您选择更新参数存储中的值，从而增加参数的版本，您还需要更新CloudFormation模板的参数中的相应版本号。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="8769" class="lm jr it mr b gy mv mw l mx my">{<br/>    "Parameter": {<br/><strong class="mr iu">        "Name": "/rds_demo/rds_username",</strong><br/>        "Type": "String",<br/>        "Value": "masteruser",<br/><strong class="mr iu">        "Version": 1,</strong><br/>        "LastModifiedDate": 1564962073.774,<br/>        "ARN": "arn:aws:ssm:us-east-1:1234567890:parameter/rds_demo/rds_username"<br/>    }<br/>}</span></pre><h2 id="17c7" class="lm jr it bd js ln lo dn jw lp lq dp ka kz lr ls ke ld lt lu ki lh lv lw km lx bi translated">验证模板</h2><p id="18e3" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">虽然我已经测试了这两个模板，但是我建议您自己验证这些模板，就像您通常对您正在创建的任何CloudFormation模板所做的那样。您可以使用AWS CLI CloudFormation <code class="fe nn no np mr b">validate-template</code> CLI命令来验证模板。或者，或者我另外建议，你可以使用<a class="ae ly" href="https://github.com/aws-cloudformation/cfn-python-lint" rel="noopener ugc nofollow" target="_blank"> CloudFormation Linter </a>，<code class="fe nn no np mr b">cfn-lint</code>命令。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="961d" class="lm jr it mr b gy mv mw l mx my">aws cloudformation validate-template \<br/>  --template-body file://cfn-templates/rds.template<br/><br/>cfn-lint -t cfn-templates/cfn-templates/rds.template</span></pre><h2 id="ffa0" class="lm jr it bd js ln lo dn jw lp lq dp ka kz lr ls ke ld lt lu ki lh lv lw km lx bi translated">创建堆栈</h2><p id="4854" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">要执行第一个CloudFormation模板并创建包含两个事件通知资源的<a class="ae ly" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacks.html" rel="noopener ugc nofollow" target="_blank"> CloudFormation堆栈</a>，请运行以下<code class="fe nn no np mr b">create-stack</code> CLI命令。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="590f" class="lm jr it mr b gy mv mw l mx my">aws cloudformation create-stack \<br/>  --template-body file://cfn-templates/event.template \<br/>  --stack-name RDSEventDemoStack</span></pre><p id="50cf" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">创建第一个堆栈只需要不到一分钟的时间。使用AWS CloudFormation控制台，确保在使用下面的命令创建第二个堆栈之前成功完成第一个堆栈。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="c782" class="lm jr it mr b gy mv mw l mx my">aws cloudformation create-stack \<br/>  --template-body file://cfn-templates/rds.template \<br/>  --stack-name RDSDemoStack</span></pre><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/33540b608ecca9d1da63d32fc8d4047e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*0nEZ8lV_j0qei7Id"/></div></figure><h2 id="a166" class="lm jr it bd js ln lo dn jw lp lq dp ka kz lr ls ke ld lt lu ki lh lv lw km lx bi translated">等我的短信</h2><p id="567c" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在我的测试中，CloudFormation RDS堆栈平均需要25-30分钟来创建，15-20分钟来删除，这看起来像是永恒的。您可以使用AWS CloudFormation控制台(下面显示的<em class="nr">)或继续使用CLI来跟踪RDS堆栈的创建进度。</em></p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nq"><img src="../Images/2da274affd104159190f73b5b9016227.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*2sJrf1zISAVTGXja"/></div></div></figure><p id="1938" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">但是，如果您还记得，CloudFormation事件模板创建了一个AWS RDS事件订阅。该资源将通过向我们的移动设备发送文本消息来通知我们数据库何时准备好。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nq"><img src="../Images/9e47c30d6d4907a638962fb96de73502.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*J6gR4SdGxDJqiZlt"/></div></div></figure><p id="2a4e" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">在CloudFormation events模板中，RDS事件订阅被配置为针对几种特定的事件类型生成Amazon简单通知服务(SNS)通知，包括RDS实例的创建和删除。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="da44" class="lm jr it mr b gy mv mw l mx my">MyEventSubscription:<br/>  Properties:<br/>    Enabled: true<br/>    EventCategories:<br/>      - availability<br/>      - configuration change<br/><strong class="mr iu">      - creation<br/>      - deletion<br/></strong>      - failover<br/>      - failure<br/>      - recovery<br/>    SnsTopicArn:<br/>      Ref: MyDBSNSTopic<br/>    SourceType: db-instance<br/>  Type: AWS::RDS::EventSubscription</span></pre><p id="2251" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">亚马逊社交网络将向您放入参数商店的手机号码发送短信。下面，我们看到在创建两个实例期间生成的消息，显示在Apple iPhone上。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/5ee9c015a00c008337638bb35e03fd48.png" data-original-src="https://miro.medium.com/v2/resize:fit:742/0*Lt2MG1eH1uAsELmV"/></div></figure><h1 id="b703" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">亚马逊RDS仪表板</h1><p id="dfd4" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">一旦成功构建了RDS CloudFormation堆栈，查看结果的最简单方法就是使用Amazon RDS仪表板，如下所示。在这里，我们看到主复制副本实例和读取复制副本实例都已创建，可供我们使用。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nq"><img src="../Images/e8b027dd68d0350c83ff94d1c107709f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*9b33jipj32wz77KN"/></div></div></figure><p id="8995" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">RDS仪表板提供对每个RDS实例的CloudWatch监控。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nq"><img src="../Images/de2a6933fe7de2f83cf477e142c181c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*3B2PqdxA_b3n5DU5"/></div></div></figure><p id="4d9a" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">RDS仪表板还提供了每个RDS实例的详细配置信息。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nq"><img src="../Images/631feb1b3319c89786debc379ff3ce76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*6GiBmOEn1uYMPt2q"/></div></div></figure><p id="90c2" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">在RDS仪表板的Connection &amp; security选项卡上，我们可以获取RDS实例的连接信息，包括RDS实例的端点。演示的下一部分将需要端点信息。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nq"><img src="../Images/7b09b19f8df15e93748af2de538d438c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*qcL3gviApr3HXTMH"/></div></div></figure><h1 id="8a0f" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">抽样资料</h1><p id="9319" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在，我们已经在AWS上成功地提供和配置了PostgreSQL数据库实例和读取副本，并且数据库为空，我们需要一些测试数据。互联网上有几个来源的<a class="ae ly" href="https://wiki.postgresql.org/wiki/Sample_Databases" rel="noopener ugc nofollow" target="_blank">示例PostgreSQL数据库</a>可供探索。我们将使用由<a class="ae ly" href="http://pgfoundry.org/projects/dbsamples/" rel="noopener ugc nofollow" target="_blank"> pgFoundry </a>提供的<a class="ae ly" href="http://pgfoundry.org/frs/shownotes.php?release_id=998" rel="noopener ugc nofollow" target="_blank"> Pagila </a>样本电影租赁数据库。尽管这个数据库已经有几年的历史了，但它提供了一个相对复杂的关系模式(<em class="nr">表关系，如下图</em>所示)和大量要查询的样本数据，大约100个数据库对象和46K行数据。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/e17f2ce418734f7666398b9833993049.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*7OBGlT5htNq609EW"/></div></figure><p id="bd03" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">在GitHub存储库中，我包含了安装示例数据库的数据结构(<a class="ae ly" href="https://en.wikipedia.org/wiki/Data_definition_language" rel="noopener ugc nofollow" target="_blank"> DDL </a>)、<code class="fe nn no np mr b">sql-scripts/pagila-schema.sql</code>和数据本身(<a class="ae ly" href="https://en.wikipedia.org/wiki/Data_Manipulation_Language" rel="noopener ugc nofollow" target="_blank"> DML </a>)、<code class="fe nn no np mr b">sql-scripts/pagila-insert-data.sql</code>所需的两个Pagila数据库SQL脚本。</p><p id="2e65" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">为了执行Pagila SQL脚本并安装示例数据，我包含了一个Python脚本。如果你不想使用Python，你可以跳到这篇文章的管理员部分。Adminer还能够导入SQL脚本。</p><p id="8bf5" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">在运行任何包含的Python脚本之前，您需要安装所需的Python包并配置<code class="fe nn no np mr b"><a class="ae ly" href="https://github.com/garystafford/aws-rds-postgres/blob/master/python-scripts/database.ini" rel="noopener ugc nofollow" target="_blank">database.ini</a></code>文件。</p><h2 id="6bbb" class="lm jr it bd js ln lo dn jw lp lq dp ka kz lr ls ke ld lt lu ki lh lv lw km lx bi translated">Python包</h2><p id="8828" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">要使用提供的<code class="fe nn no np mr b"><a class="ae ly" href="https://github.com/garystafford/aws-rds-postgres/blob/master/python-scripts/requirements.txt" rel="noopener ugc nofollow" target="_blank">python-script/requirements.txt</a></code>文件安装所需的Python包，请运行以下命令。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="f981" class="lm jr it mr b gy mv mw l mx my">cd python-scripts<br/>pip3 install --upgrade -r requirements.txt</span></pre><p id="4748" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">我们为脚本使用了两个包，<a class="ae ly" href="http://initd.org/psycopg/docs/index.html" rel="noopener ugc nofollow" target="_blank"> psycopg2 </a>和<a class="ae ly" href="https://docs.python.org/3/library/configparser.html" rel="noopener ugc nofollow" target="_blank"> configparser </a>。Psycopg是Python的PostgreSQL数据库适配器。根据他们的网站，Psycopg是Python编程语言最流行的PostgreSQL数据库适配器。<code class="fe nn no np mr b">configparser</code>模块允许我们从类似Microsoft Windows INI文件的文件中读取配置。包含项目的一组Python单元测试也需要<a class="ae ly" href="https://docs.python.org/3/library/unittest.html" rel="noopener ugc nofollow" target="_blank"> unittest </a>包，但不作为演示的一部分讨论。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/bffebca951ba56f2ca4bbaaae4575c0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*6BWrI4F_GTjbQgld"/></div></figure><p id="9d84" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">数据库配置</p><p id="47e7" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">由<code class="fe nn no np mr b">configparser</code>读取的<code class="fe nn no np mr b"><a class="ae ly" href="https://github.com/garystafford/aws-rds-postgres/blob/master/python-scripts/database.ini" rel="noopener ugc nofollow" target="_blank">python-scripts/database.ini</a></code>文件向我们的RDS主服务器和读取副本实例的数据库提供所需的连接信息。使用CloudFormation RDS模板或Amazon RDS仪表板中的输入参数和输出值来获取所需的连接信息，如下例所示。您的<code class="fe nn no np mr b">host</code>值对于您的主副本和读取副本将是唯一的。主机值是实例的端点，列在RDS仪表板的“配置”选项卡中。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="9971" class="lm jr it mr b gy mv mw l mx my">[docker]<br/>host=localhost<br/>port=5432<br/>database=pagila<br/>user=masteruser<br/>password=5up3r53cr3tPa55w0rd<br/><br/>[master]<br/><strong class="mr iu">host=demo-instance.dkfvbjrazxmd.us-east-1.rds.amazonaws.com</strong><br/>port=5432<br/>database=pagila<br/>user=masteruser<br/>password=5up3r53cr3tPa55w0rd<br/><br/>[replica]<br/><strong class="mr iu">host=demo-replica.dkfvbjrazxmd.us-east-1.rds.amazonaws.com</strong><br/>port=5432<br/>database=pagila<br/>user=masteruser<br/>password=5up3r53cr3tPa55w0rd</span></pre><p id="585c" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">配置好INI文件后，运行下面的命令，该命令执行提供的Python脚本<code class="fe nn no np mr b"><a class="ae ly" href="https://github.com/garystafford/aws-rds-postgres/blob/master/python-scripts/create_pagila_data.py" rel="noopener ugc nofollow" target="_blank">python-scripts/create_pagila_data.py</a></code>，创建数据结构并将示例数据插入主RDS实例的Pagila数据库。数据库将自动复制到RDS读取复制副本实例。在我的本地笔记本电脑上，我发现Python脚本创建所有100个数据库对象并插入46K行电影租赁数据大约需要40秒。相比之下，在本地使用基于Docker的PostgreSQL实例大约需要13秒。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="09fc" class="lm jr it mr b gy mv mw l mx my">python3 ./create_pagila_data.py</span></pre><p id="0762" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">Python脚本的主要功能<code class="fe nn no np mr b">create_pagila_db()</code>，读取并执行两个外部SQL脚本。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="818b" class="lm jr it mr b gy mv mw l mx my">def create_pagila_db():<br/>    <em class="nr">"""<br/>    Creates Pagila database by running DDL and DML scripts<br/>    """<br/><br/>    </em>try:<br/>        global conn<br/>        with conn:<br/>            with conn.cursor() as curs:<br/><strong class="mr iu">                curs.execute(open("../sql-scripts/pagila-schema.sql", "r").read())<br/>                curs.execute(open("../sql-scripts/pagila-insert-data.sql", "r").read())<br/></strong>                conn.commit()<br/>                print('Pagila SQL scripts executed')<br/>    except (psycopg2.OperationalError, psycopg2.DatabaseError, FileNotFoundError) as err:<br/>        print(create_pagila_db.__name__, err)<br/>        close_conn()<br/>        exit(1)</span></pre><p id="ad42" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">如果Python脚本执行正确，您应该会看到输出，表明主RDS实例的数据库中现在有28个表。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/dea8ea22e2ff60efc3bad6b585baacab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*rrCWB5D-VoctJ6CO"/></div></figure><h1 id="0b35" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">pgAdmin</h1><p id="331a" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">pgAdmin是一个用于与PostgreSQL数据库进行交互和管理的常用工具。根据其<a class="ae ly" href="https://www.pgadmin.org/" rel="noopener ugc nofollow" target="_blank">网站</a>，pgAdmin是PostgreSQL最受欢迎、功能最丰富的开源管理和开发平台。</p><p id="89bf" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">该项目包括一个可选的<a class="ae ly" href="https://docs.docker.com/engine/swarm/stack-deploy/" rel="noopener ugc nofollow" target="_blank">Docker Swarm</a>T5】文件。该堆栈将创建一组三个Docker容器，包括PostgreSQL 11.4、Adminer和pgAdmin 4的本地副本。拥有PostgreSQL的本地副本，使用<a class="ae ly" href="https://hub.docker.com/_/postgres" rel="noopener ugc nofollow" target="_blank">官方Docker镜像</a>，有助于开发和解决RDS问题。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/c5685853ab7185ee7c1e5511a2bb45d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*8KvnBQdC2bD3Pgo-"/></div></figure><p id="8660" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">使用以下命令部署Swarm堆栈。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="cd60" class="lm jr it mr b gy mv mw l mx my"># create stack<br/>docker swarm init<br/>docker stack deploy -c stack.yml postgres<br/><br/># get status of new containers<br/>docker stack ps postgres --no-trunc<br/>docker container ls</span></pre><p id="160e" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">如果您不想启动整个Docker Swarm堆栈，您可以使用<code class="fe nn no np mr b">docker run</code>命令创建一个pgAdmin Docker容器。正在使用的pgAdmin 4 Docker图像是pgAdmin 推荐的图像<a class="ae ly" href="https://www.pgadmin.org/download/pgadmin-4-container/" rel="noopener ugc nofollow" target="_blank">。</a></p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="34bf" class="lm jr it mr b gy mv mw l mx my">docker pull dpage/pgadmin4<br/><br/>docker run -p 81:80 \<br/>  -e "PGADMIN_DEFAULT_EMAIL=user@domain.com" \<br/>  -e "PGADMIN_DEFAULT_PASSWORD=SuperSecret" \<br/>  -d dpage/pgadmin4<br/><br/>docker container ls | grep pgadmin4</span></pre><h2 id="94cc" class="lm jr it bd js ln lo dn jw lp lq dp ka kz lr ls ke ld lt lu ki lh lv lw km lx bi translated">数据库服务器配置</h2><p id="fc9d" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">一旦pgAdmin启动并运行，我们就可以使用来自您的<code class="fe nn no np mr b">database.ini</code>文件或Amazon RDS仪表板的连接字符串信息来配置主数据库服务器和读取副本数据库服务器(RDS实例)。下面，我正在配置主RDS实例(服务器)。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nq"><img src="../Images/55093a03dd7cbede62078637bad02ea3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*Sie8YHDQmnM-F4A0"/></div></div></figure><p id="185c" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">任务完成后，在下面，我们看到主RDS实例和read副本，以及在pgAdmin中配置的本地Docker实例(<em class="nr">屏幕截图的左侧</em>)。请注意Pagila数据库是如何从RDS主服务器自动复制到read复制副本实例的。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nq"><img src="../Images/df3781da05a5e3c6bf5235755d1dbcf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*veFxK0I_in8WdDP2"/></div></div></figure><h2 id="650a" class="lm jr it bd js ln lo dn jw lp lq dp ka kz lr ls ke ld lt lu ki lh lv lw km lx bi translated">构建SQL查询</h2><p id="d6d4" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">切换到Query选项卡，我们可以对任何数据库实例运行常规的SQL查询。下面，我对主RDS实例的Pagila数据库运行了一个简单的SELECT查询，返回电影标题的完整列表，以及它们的类型和发行日期。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nq"><img src="../Images/cf87944bc3fb178a8003f68c6a480efe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*wu4R6LB66IDRG4nr"/></div></div></figure><p id="c44f" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">pgAdmin查询工具甚至包括一个<a class="ae ly" href="https://www.pgadmin.org/docs/pgadmin4/development/query_tool.html" rel="noopener ugc nofollow" target="_blank"> Explain </a>选项卡来查看相同查询的图形表示，这对优化非常有用。这里我们看到了同一个查询，显示了对执行顺序的分析。弹出窗口显示关于选定对象的信息。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nq"><img src="../Images/f97af2a8f44fbd293a25be7bf99862f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*fCWCCLhxVbtmJloz"/></div></div></figure><h2 id="4785" class="lm jr it bd js ln lo dn jw lp lq dp ka kz lr ls ke ld lt lu ki lh lv lw km lx bi translated">查询读取副本</h2><p id="b5b1" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">为了演示读取副本的使用，下面我对Pagila数据库的RDS读取副本的副本运行了相同的查询。针对主实例的任何模式和数据更改都会复制到读取副本。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nq"><img src="../Images/65a965611ef2abf48c4559974f576de2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*MwHVSzWjuqlCjEfo"/></div></div></figure><h1 id="e36b" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">管理员</h1><p id="9b5d" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">Adminer是另一个很好的通用数据库管理工具，类似于pgAdmin，但是具有一些不同的功能。根据它的<a class="ae ly" href="https://www.adminer.org/" rel="noopener ugc nofollow" target="_blank">网站</a>，使用Adminer，你可以获得整洁的用户界面、对多个数据库的丰富支持、性能和安全性，所有这些都来自单个PHP文件。Adminer是我处理数据库管理任务的首选工具。令人惊讶的是，Adminer可以与MySQL、MariaDB、PostgreSQL、SQLite、MS SQL、Oracle、SimpleDB、Elasticsearch和MongoDB一起工作。</p><p id="f037" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">下面，我们看到在Adminer中显示的Pagila数据库的表和视图，以及关于每个数据库对象的一些有用的统计信息。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nq"><img src="../Images/89b8cd483944d3cd46a5edce7c5406b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*qilH5Hwza4pEpEdz"/></div></div></figure><p id="7dcc" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">与pgAdmin类似，我们也可以在Adminer界面中运行查询，以及其他常见的开发和管理任务。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nq"><img src="../Images/f950f6c3c0521105b5330c30c7680457.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*m3SYjL9QomdPEQkJ"/></div></div></figure><h2 id="4dcb" class="lm jr it bd js ln lo dn jw lp lq dp ka kz lr ls ke ld lt lu ki lh lv lw km lx bi translated">用Adminer导入Pagila</h2><p id="9ad8" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">Adminer的另一个很棒的特性是能够轻松地导入和导出数据。作为Python的替代方法，您可以使用Adminer的SQL文件导入功能导入Pagila数据。下面，您将看到一个使用文件上传功能将Pagila数据库对象导入Pagila数据库的示例。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nq"><img src="../Images/65f3260c659235ea03e126b6e966ab0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*QHnTqGvqGAj6qqoZ"/></div></div></figure><h1 id="0adf" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">集成驱动电子设备</h1><p id="e1cf" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">对于将我的AWS基础设施写成代码文件和Python脚本，我更喜欢JetBrains<a class="ae ly" href="https://www.jetbrains.com/pycharm/" rel="noopener ugc nofollow" target="_blank">py charm Professional Edition</a>(v 19.2)。与所有JetBrains IDEs一样，PyCharm能够连接和管理PostgreSQL数据库。您可以编写和运行SQL查询，包括Pagila SQL导入脚本。微软<a class="ae ly" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank"> Visual Studio Code </a>是另一个优秀的免费选择，可在多个平台上使用。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nt"><img src="../Images/503e4f8c1d442935330e8db13fa830a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lV7N3sqX_gTzbdwDusigqg.png"/></div></div></figure><h1 id="896b" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">Python和RDS</h1><p id="668a" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">尽管我们的IDE、pgAdmin和Adminer对于构建和测试我们的查询很有用，但最终，我们仍然需要连接到Amazon RDS PostgreSQL实例，并从我们的应用程序代码执行数据操作。GitHub存储库包含一个示例python脚本<code class="fe nn no np mr b"><a class="ae ly" href="https://github.com/garystafford/aws-rds-postgres/blob/master/python-scripts/query_postgres.py" rel="noopener ugc nofollow" target="_blank">python-scripts/query_postgres.py</a></code>。这个脚本使用与我们之前运行的Pagila数据创建脚本相同的Python包和连接函数。这一次，我们将使用Python执行与之前使用pgAdmin和Adminer相同的SELECT查询。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="0be2" class="lm jr it mr b gy mv mw l mx my">cd python-scripts python3 ./query_postgres.py</span></pre><p id="5c53" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">成功建立数据库连接后，脚本的主要功能<code class="fe nn no np mr b">get_movies(return_count)</code>执行选择查询。该函数接受一个整数，表示从SELECT查询中返回的电影数量。脚本中有一个独立的函数负责在查询完成时关闭数据库连接。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="3746" class="lm jr it mr b gy mv mw l mx my">def get_movies(return_count=100):<br/>    """<br/>    Queries for all films, by genre and year<br/>    """<br/><br/>    try:<br/>        global conn<br/>        with conn:<br/>            with conn.cursor() as curs:<br/>                curs.execute("""<br/><strong class="mr iu">                    SELECT title AS title, name AS genre, release_year AS released<br/>                    FROM film f<br/>                             JOIN film_category fc<br/>                                  ON f.film_id = fc.film_id<br/>                             JOIN category c<br/>                                  ON fc.category_id = c.category_id<br/>                    ORDER BY title<br/>                    LIMIT %s;<br/></strong>                """, (return_count,))<br/><br/>                movies = []<br/>                row = curs.fetchone()<br/>                while row is not None:<br/>                    movies.append(row)<br/>                    row = curs.fetchone()<br/><br/>                return movies<br/>    except (psycopg2.OperationalError, psycopg2.DatabaseError) as err:<br/>        print(get_movies.__name__, err)<br/>    finally:<br/>        close_conn()<br/><br/><br/>def main():<br/>    set_connection('docker')<br/>    for movie in get_movies(10):<br/>        print('Movie: {0}, Genre: {1}, Released: {2}'<br/>              .format(movie[0], movie[1], movie[2]))</span></pre><p id="a082" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">下面，我们看到一个Python脚本格式化输出的例子，仅限于前十部电影。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/2b1714a8e0a4c8e36d9dc2f1e360907f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*w7vV02HsQCQ6IVVD"/></div></figure><h1 id="7bdc" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">使用读取副本</h1><p id="c606" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">为了获得更好的应用程序性能，最好将部分或全部数据库读取重定向到读取副本，而将写入、更新和删除操作留给主实例。在对<code class="fe nn no np mr b">set_connection(section)</code>函数的调用中，只需传递所需的“副本”和“主”部分，就可以很容易地修改脚本，对读取副本而不是主RDS实例执行相同的查询。section参数指的是<code class="fe nn no np mr b">database.ini</code>文件中的两个部分之一。<code class="fe nn no np mr b">configparser</code>模块将处理检索正确的连接信息。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="dcb3" class="lm jr it mr b gy mv mw l mx my">set_connection('replica')</span></pre><h1 id="0fbe" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">清理</h1><p id="d4ae" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">完成演示后，清理所有AWS资源并停止计费的最简单方法是使用AWS CLI按以下顺序删除两个CloudFormation堆栈。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="c208" class="lm jr it mr b gy mv mw l mx my">aws cloudformation delete-stack \<br/>  --stack-name RDSDemoStack<br/><br/># wait until the above resources are completely deleted<br/>aws cloudformation delete-stack \<br/>  --stack-name RDSEventDemoStack</span></pre><p id="efa7" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">当第一个CloudFormation堆栈被删除时，您应该会收到以下SMS通知。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/30a74c30dbc2202fe6ec5b10c0eaf945.png" data-original-src="https://miro.medium.com/v2/resize:fit:742/0*HOpc2lh7Y2rj2Q4C"/></div></figure><p id="124c" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">您可以使用以下命令删除正在运行的Docker堆栈。注意，您将丢失所有的pgAdmin服务器连接信息，以及您的本地Pagila数据库。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="7e0b" class="lm jr it mr b gy mv mw l mx my">docker stack rm postgres</span></pre><h1 id="fe50" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">结论</h1><p id="99fb" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在这篇简短的文章中，我们只是简单介绍了Amazon RDS for PostgreSQL的许多好处和功能。学习PostgreSQL和Amazon RDS的好处的最好方法是设置自己的RDS实例，插入一些示例数据，并开始用自己喜欢的数据库客户机或编程语言编写查询。</p><p id="3346" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated">本文表达的所有观点都是我个人的，不一定代表我现在或过去的雇主或他们的客户的观点。</p></div><div class="ab cl nu nv hx nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="im in io ip iq"><p id="d627" class="pw-post-body-paragraph ko kp it kq b kr lz kt ku kv ma kx ky kz mb lb lc ld mc lf lg lh md lj lk ll im bi translated"><em class="nr">原载于2019年8月10日</em><a class="ae ly" href="https://programmaticponderings.com/2019/08/09/getting-started-with-postgresql-using-amazon-rds-cloudformation-pgadmin-and-python/" rel="noopener ugc nofollow" target="_blank"><em class="nr">【http://programmaticponderings.com</em></a><em class="nr">。</em></p></div></div>    
</body>
</html>