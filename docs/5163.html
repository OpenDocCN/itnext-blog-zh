<html>
<head>
<title>Build and Run Telegram-iOS v7.3 in Simulator with Bazel</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Bazel在模拟器中构建并运行Telegram-iOS v7.3</h1>
<blockquote>原文：<a href="https://itnext.io/build-and-run-telegram-ios-v7-3-in-simulator-with-bazel-fe36f305bd55?source=collection_archive---------0-----------------------#2020-12-29">https://itnext.io/build-and-run-telegram-ios-v7-3-in-simulator-with-bazel-fe36f305bd55?source=collection_archive---------0-----------------------#2020-12-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><blockquote class="jn jo jp"><p id="c022" class="jq jr js jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated"><a class="ae kp" href="https://hubo.dev/2020-12-28-build-and-run-telegram-ios-v7-3-on-simulator-with-bazel/" rel="noopener ugc nofollow" target="_blank"> hubo.dev </a>的镜像</p></blockquote><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi kq"><img src="../Images/131e60d01c40d662d7f70ec051a86aec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kp2eIbOWF0dJz8emMWBk-w.jpeg"/></div></div></figure><p id="cdb4" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated">Telegram-iOS上周发布了7.3版<a class="ae kp" href="https://telegram.org/blog/voice-chats" rel="noopener ugc nofollow" target="_blank">和新的群组语音聊天及其他改进。我的</a><a class="ae kp" rel="noopener ugc nofollow" target="_blank" href="/build-and-run-telegram-ios-on-xcode-12-x-simulator-2aff89c25a9f">上一篇关于在模拟器中构建和运行的文章</a>因为几个原因而不起作用:</p><ul class=""><li id="616b" class="lf lg iq jt b ju jv jy jz lc lh ld li le lj ko lk ll lm ln bi translated">巴克在大苏尔破产了。最新版本2020.10.21.01给出了一个内部错误，由<a class="ae kp" href="https://github.com/facebook/buck/issues/2491" rel="noopener ugc nofollow" target="_blank"> facebook/buck#2491 </a>报告。Big Sur附带了一个内置的动态链接器缓存，这使得JNA无法检查动态库是否存在<a class="ae kp" href="https://github.com/java-native-access/jna/issues/1215" rel="noopener ugc nofollow" target="_blank">Java-native-access/jna # 1215</a>目前，除了Airbnb的fork <a class="ae kp" href="https://github.com/airbnb/buck/pull/24" rel="noopener ugc nofollow" target="_blank"> airbnb/buck#24 </a>的一个变通办法之外，Buck团队还没有正式修复它。</li><li id="f9a4" class="lf lg iq jt b ju lo jy lp lc lq ld lr le ls ko lk ll lm ln bi translated">Telegram-iOS已经升级了构建工具链，以使用Xcode 12以及子模块<code class="fe lt lu lv lw b">webrtc-ios</code>。我之前帖子中的一些变通方法已经没有必要了。</li></ul><p id="0ce1" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated">这个项目已经并行使用Buck和Bazel作为构建系统有一段时间了。现在是我们换到大苏尔的巴泽尔的好时机。</p><h1 id="bf1e" class="lx ly iq bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">说明</h1><p id="62a6" class="pw-post-body-paragraph jq jr iq jt b ju mv jw jx jy mw ka kb lc mx ke kf ld my ki kj le mz km kn ko ij bi translated">我的开发机器运行的是macOS Big Sur v11.1和Xcode 12.2 (12B45b)。我们可以先用家酿安装Bazel和Yasm。构建一些第三方依赖项需要Yasm和CMake。</p><pre class="kr ks kt ku gt na lw nb nc aw nd bi"><span id="a520" class="ne ly iq lw b gy nf ng l nh ni">brew install bazel yasm cmake</span></pre><p id="6f75" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated">以下是我机器上的版本信息:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="1545" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated">让我们克隆项目代码并切换到标签<code class="fe lt lu lv lw b">release-7.3</code>:</p><pre class="kr ks kt ku gt na lw nb nc aw nd bi"><span id="38d3" class="ne ly iq lw b gy nf ng l nh ni">git clone --recursive <a class="ae kp" href="https://github.com/TelegramMessenger/telegram-ios.git" rel="noopener ugc nofollow" target="_blank">https://github.com/TelegramMessenger/telegram-ios.git</a><br/>cd telegram-ios<br/>git checkout release-7.3</span></pre><p id="456c" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated">我想重用项目中存在的伪发行版代码设计文件，因为它对于在模拟器中运行来说无关紧要。我需要在<code class="fe lt lu lv lw b">Makefile</code>上应用一个小的变化:</p><pre class="kr ks kt ku gt na lw nb nc aw nd bi"><span id="88f3" class="ne ly iq lw b gy nf ng l nh ni">sed -i'' -e 's/Telegram development/Telegram distribution/g' Makefile</span></pre><p id="25ce" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated">sed命令用“电报分发”替换了两次“电报开发”,这使得构建系统不会对伪造的代码设计文件感到恐慌。不同之处如下，供您参考:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="d288" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated">是时候让目标<code class="fe lt lu lv lw b">bazel_project_noextensions</code>或<code class="fe lt lu lv lw b">bazel_project</code>生成Xcode项目文件了:</p><pre class="kr ks kt ku gt na lw nb nc aw nd bi"><span id="2087" class="ne ly iq lw b gy nf ng l nh ni">CODESIGNING_DATA_PATH="build-system/fake-codesigning" \<br/>CODESIGNING_CERTS_VARIANT="distribution" \<br/>CODESIGNING_PROFILES_VARIANT="appstore" \<br/>COMMIT_ID=`git rev-parse HEAD` \<br/>BUILD_NUMBER=`git rev-list --count HEAD` \<br/>LOCAL_CODESIGNING=1 \<br/>IGNORE_XCODE_VERSION_MISMATCH=1 \<br/>sh build-system/verify.sh make bazel_project_noextensions</span></pre><p id="71b5" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated">Bazel在<code class="fe lt lu lv lw b">build-input/gen/project/Telegram.xcodeproj/</code>保存项目文件后，Xcode会自动打开。我们可以继续在模拟器中构建和运行Telegram-iOS。没有扩展的构建在我的机器上需要大约11分钟。如果你有的话，请让我知道苹果M1需要什么。</p><h1 id="06b1" class="lx ly iq bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">结论</h1><p id="52fe" class="pw-post-body-paragraph jq jr iq jt b ju mv jw jx jy mw ka kb lc mx ke kf ld my ki kj le mz km kn ko ij bi translated">由巴泽尔来建项目更顺畅。我非常欣赏的另一个变化是，所有依赖项都是源代码文件的目标，而不是Buck预先构建的二进制文件，这使得调试更加容易。</p></div></div>    
</body>
</html>