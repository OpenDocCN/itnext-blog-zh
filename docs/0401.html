<html>
<head>
<title>Node.js — Integration Testing with Pact.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js —使用Pact.js进行集成测试</h1>
<blockquote>原文：<a href="https://itnext.io/node-js-integration-testing-with-pact-js-1a2ea8aa3116?source=collection_archive---------3-----------------------#2018-03-05">https://itnext.io/node-js-integration-testing-with-pact-js-1a2ea8aa3116?source=collection_archive---------3-----------------------#2018-03-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/8ad6aa8bed269916e4a7daeeeba04251.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SRXBXHAovcH_xkQ5ZSttyg.jpeg"/></div></div></figure><p id="eb59" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在上一篇文章中，我们回顾了消费者驱动的契约(CDC)如何在微服务丰富的环境中帮助集成测试。</p><div class="kx ky gp gr kz la"><a href="https://medium.com/nmc-techblog/scalable-integration-testing-for-microservices-deployments-e03e29dd1280" rel="noopener follow" target="_blank"><div class="lb ab fo"><div class="lc ab ld cl cj le"><h2 class="bd ir gy z fp lf fr fs lg fu fw ip bi translated">微服务部署的可扩展集成测试</h2><div class="lh l"><h3 class="bd b gy z fp lf fr fs lg fu fw dk translated">许多人在微服务上操之过急，它们在今天比以往任何时候都更普遍地用于实现面向服务…</h3></div><div class="li l"><p class="bd b dl z fp lf fr fs lg fu fw dk translated">medium.com</p></div></div><div class="lj l"><div class="lk l ll lm ln lj lo jw la"/></div></div></a></div><h1 id="86bb" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">用契约解决它</h1><p id="aa6b" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">pact是一个开源项目，它实现了消费者驱动的契约测试，并使用Pact基金会组织为不同的语言和平台创建和协作Pact框架。</p><p id="f9e4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一些Pact实施包括:</p><ul class=""><li id="b540" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">红宝石</li><li id="2f6b" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated">Java 语言(一种计算机语言，尤用于创建网站)</li><li id="000d" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated">节点. js</li></ul><h1 id="aff4" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">Pact.js简介</h1><p id="2f57" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">虽然硬币有两面，但我们将只关注Node.js项目的消费者测试，并回顾Ava.js测试运行程序和框架的集成测试。</p><h1 id="cfc2" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">0.装置</h1><p id="196f" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">将pact npm软件包作为开发依赖项安装:</p><pre class="ng nh ni nj gt nk nl nm nn aw no bi"><span id="96ce" class="np lq iq nl b gy nq nr l ns nt">npm install <em class="nu">--save-dev pact</em></span></pre><h1 id="4bbe" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">1.创建测试文件</h1><p id="b07e" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">根据您的Node.js框架和目录结构，创建一个测试(spec)文件，我们将在其中编写与pact的集成测试。</p><pre class="ng nh ni nj gt nk nl nm nn aw no bi"><span id="f27b" class="np lq iq nl b gy nq nr l ns nt"><em class="nu">// consumer-example-test.integration.test.js</em><br/>const path = require('path')<br/>const test = require('ava')<br/>const pact = require('pact')<br/>const request = require('request')</span></pre><h1 id="972d" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">2.定义契约服务器</h1><pre class="ng nh ni nj gt nk nl nm nn aw no bi"><span id="4157" class="np lq iq nl b gy nq nr l ns nt">  const MOCK_SERVER_PORT = 2202<br/>﻿<br/>  const provider = pact({<br/>    consumer: 'TodoApp',<br/>    provider: 'TodoService',<br/>    port: MOCK_SERVER_PORT,<br/>    log: path.resolve(process.cwd(), 'logs', 'pact.log'),<br/>    dir: path.resolve(__dirname, 'pacts'),<br/>    logLevel: 'INFO',<br/>    spec: 2<br/>  })</span></pre><p id="98a4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当我们说我们正在编写消费者测试时，不要被<em class="nu">提供者</em>变量定义误导。这是我们定义pact服务器的地方，它模仿我们的提供者，并响应我们对它的API请求。</p><ol class=""><li id="926f" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv nv my mz na bi translated"><strong class="ka ir"> <em class="nu">消费者</em> </strong>和<strong class="ka ir"> <em class="nu">提供者</em> </strong> <em class="nu"> </em>仅仅是名称，以便在调试、检查测试日志时更容易使用，并在最终生成的契约中使用。</li><li id="f014" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv nv my mz na bi translated">Pact将启动一个监听端口2202的服务，将日志写到一个执行测试的<em class="nu"> logs/ </em>目录中，并将在一个目录<em class="nu"> pacts/ </em>中创建实际的pact契约文件，该目录位于您创建测试文件的位置旁边。</li><li id="536a" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv nv my mz na bi translated">Pact将使用它支持的最新规范版本(v2)</li></ol><h1 id="f9f1" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">3.测试设置</h1><pre class="ng nh ni nj gt nk nl nm nn aw no bi"><span id="4c3e" class="np lq iq nl b gy nq nr l ns nt">test.before('setting up pact', async t =&gt; {<br/>  <em class="nu">// this is the response you expect from your Provider</em><br/>  const EXPECTED_BODY = [{<br/>    id: 1,<br/>    name: 'Project 1', <br/>    type: '1',<br/>    due: '2016-02-11T09:46:56.023Z',<br/>    tasks: [<br/>      {id: 1, name: 'Do the laundry', 'done': true},<br/>      {id: 2, name: 'Do the dishes', 'done': false},<br/>      {id: 3, name: 'Do the backyard', 'done': false},<br/>      {id: 4, name: 'Do nothing', 'done': false}<br/>    ]<br/>  }]</span><span id="6e58" class="np lq iq nl b gy nw nr l ns nt">  await provider.setup()<br/>    .then(() =&gt; {<br/>      provider.addInteraction({<br/>        <em class="nu">// The 'state' field specifies a "Provider State"</em><br/>        state: 'i have a list of projects',<br/>        uponReceiving: 'a request for projects',<br/>        withRequest: {<br/>          method: 'GET',<br/>          path: '/projects',<br/>          headers: {'Accept': 'application/json'},<br/>          query: {<br/>            projectTypes: pact.Matchers.term({<br/>              matcher: '\\d+',<br/>              generate: '1'</span><span id="992a" class="np lq iq nl b gy nw nr l ns nt">            })<br/>          }<br/>        },<br/>        willRespondWith: {<br/>          status: 200,<br/>          headers: {'Content-Type': 'application/json'},<br/>          body: EXPECTED_BODY<br/>        }<br/>      })<br/>    })<br/>})</span></pre><p id="c1f1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我们的测试实际运行之前，我们需要启动Pact服务，并为它提供我们期望的交互。</p><blockquote class="nx ny nz"><p id="1773" class="jy jz nu ka b kb kc kd ke kf kg kh ki oa kk kl km ob ko kp kq oc ks kt ku kv ij bi translated">这是我们定义期望的地方。预期交互之间的任何不匹配都将导致测试在断言时抛出错误。</p></blockquote><ol class=""><li id="af19" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv nv my mz na bi translated"><em class="nu"> withRequest </em>和<em class="nu"> willRespondWith </em>定义了API消费者和提供者之间的预期交互。</li><li id="9035" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv nv my mz na bi translated">您会注意到，请求部分的期望还定义了一个名为<em class="nu"> projectTypes </em>的查询参数，消费者API将发送该参数，我们使用pact库中的一个称为matchers的功能，通过使用一个number regex，允许提供者灵活地实现契约。</li></ol><h1 id="602e" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">4.消费者测试</h1><pre class="ng nh ni nj gt nk nl nm nn aw no bi"><span id="a067" class="np lq iq nl b gy nq nr l ns nt">test.cb('should generate a list of TODOs for the main screen', t =&gt; {<br/>  t.plan(1)</span><span id="69f7" class="np lq iq nl b gy nw nr l ns nt">  <em class="nu">// const todoApp = new TodoApp()</em><br/>  <em class="nu">// todoApp.getProjects() // &lt;- this method would make the remote http call</em><br/>  <em class="nu">//   .then((projects) =&gt; {</em><br/>  <em class="nu">//     expect(projects).to.be.a('array')</em><br/>  <em class="nu">//     expect(projects).to.have.deep.property('projects[0].id', 1)</em><br/>  <em class="nu">//</em><br/>  <em class="nu">//     // (5) validate the interactions occurred, this will throw an error if it fails telling you what went wrong</em><br/>  <em class="nu">//     return provider.verify()</em><br/>  <em class="nu">//   })</em></span><span id="3e52" class="np lq iq nl b gy nw nr l ns nt">  const reqOptions = {<br/>    url: `http://localhost:${MOCK_SERVER_PORT}/projects?projectTypes=1`,<br/>    method: 'GET',<br/>    json: true<br/>  }</span><span id="44a7" class="np lq iq nl b gy nw nr l ns nt">  request(reqOptions, async (error, response, body) =&gt; {<br/>    if (error) {<br/>      t.fail()<br/>    }<br/></span><span id="7a46" class="np lq iq nl b gy nw nr l ns nt">    // This is the important part, where we assert expected interactions with our Pact service<br/>    await t.notThrows(provider.verify())<br/>    t.end()<br/>  })</span><span id="5ed9" class="np lq iq nl b gy nw nr l ns nt">})</span></pre><p id="22ea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是我们实际的消费者测试，我们使用<em class="nu"> request </em>模块向pact库为我们创建的模拟API服务发出HTTP请求。</p><p id="d4b5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">关于实际的消费者测试——被注释的顶部显示了在真实世界中的实际预期使用，其中您调用了一个内部逻辑，该逻辑在幕后预期向提供者发出一个API调用。另一种情况是，您用<em class="nu"> supertest </em>向您自己的消费者内部的一个内部API端点模拟请求，它反过来向提供者发出那个API调用。</p><p id="51a5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们向提供者发出API调用的测试的底部只是为了一个工作示例。</p><p id="5206" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">最重要的是</strong>，我们用<em class="nu"> provider.verify() </em>断言，通过确保它不抛出错误，确实所有预期的交互都已经完成，然后结束测试。</p><h1 id="3042" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">5.测试拆卸</h1><pre class="ng nh ni nj gt nk nl nm nn aw no bi"><span id="16b5" class="np lq iq nl b gy nq nr l ns nt">test.always.after(async () =&gt; {<br/>  <em class="nu">// (6) write the pact file for this consumer-provider pair,</em><br/>  <em class="nu">// and shutdown the associated mock server.</em><br/>  <em class="nu">// You should do this only _once_ per Provider you are testing.</em><br/>  await provider.finalize()<br/>})</span></pre><p id="bbd5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在运行测试之后，您可以参考详细的pact.log文件来更清楚地了解交互是如何工作的，更好的是，您现在在<em class="nu"> pacts/ </em>目录中有了一个pact文件，您可以与您的提供者协作！</p><h1 id="4fdb" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">摘要</h1><ul class=""><li id="0b5a" class="ms mt iq ka b kb mn kf mo kj od kn oe kr of kv mx my mz na bi translated">Pact.js让我们编写消费者测试变得非常容易，我们邀请你以开源精神与我们合作:<a class="ae kw" href="https://github.com/pact-foundation/pact-js" rel="noopener ugc nofollow" target="_blank">https://github.com/pact-foundation/pact-js</a></li><li id="4fc8" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated">注意您的测试设置——通常您将依赖于消费者可用的数据来测试提供者，所以在您编写消费者测试时要为此做好准备。</li></ul><p id="345f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">简而言之，测试代码本身是以简单的方式编写的，但是有更好的模式可以用来编写测试，例如在测试用例本身中定义交互及其期望，而不是在全局测试套件中。</p><p id="e0ef" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在下一篇后续文章中，我们将更深入地回顾Pact.js框架生命周期，以及更好测试的测试模式。</p></div></div>    
</body>
</html>