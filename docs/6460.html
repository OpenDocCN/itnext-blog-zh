<html>
<head>
<title>Building Restful APIs with Symfony 5 and PHP 8</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Symfony 5和PHP 8构建Restful APIs</h1>
<blockquote>原文：<a href="https://itnext.io/building-restful-apis-with-symfony-5-and-php-8-35368a6246ad?source=collection_archive---------1-----------------------#2021-11-22">https://itnext.io/building-restful-apis-with-symfony-5-and-php-8-35368a6246ad?source=collection_archive---------1-----------------------#2021-11-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c799" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Symfony是一个全功能的模块化PHP框架，用于构建各种应用程序，从传统的web应用程序到小型微服务组件。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/f08daefead13fc15e5d706ddba36d212.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7zVWP_mRMsd2gPIrKrxrNA.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated"><a class="ae lb" href="https://unsplash.com/@kakachen?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> te chan </a>在<a class="ae lb" href="https://unsplash.com/s/photos/china-snow?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="d32c" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">把你的脚弄湿</h1><p id="7872" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">安装PHP 8和PHP Composer工具。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="ca48" class="mr lk iq mn b gy ms mt l mu mv"># choco php composer</span></pre><p id="4d5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装【Symfony CLI】(Symfony check:requirements)，检查系统需求。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="f309" class="mr lk iq mn b gy ms mt l mu mv"># symfony check:requirements</span><span id="6cf4" class="mr lk iq mn b gy mw mt l mu mv">Symfony Requirements Checker<br/>~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span id="13e0" class="mr lk iq mn b gy mw mt l mu mv">&gt; PHP is using the following php.ini file:<br/>C:\tools\php80\php.ini</span><span id="b338" class="mr lk iq mn b gy mw mt l mu mv">&gt; Checking Symfony requirements:</span><span id="908d" class="mr lk iq mn b gy mw mt l mu mv">....................WWW.........</span><span id="8a00" class="mr lk iq mn b gy mw mt l mu mv">                                              <br/> [OK]                                         <br/> Your system is ready to run Symfony projects <br/>                                              </span><span id="969c" class="mr lk iq mn b gy mw mt l mu mv">Optional recommendations to improve your setup<br/>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span id="3203" class="mr lk iq mn b gy mw mt l mu mv"> * intl extension should be available<br/>   &gt; Install and enable the intl extension (used for validators).</span><span id="4b8d" class="mr lk iq mn b gy mw mt l mu mv"> * a PHP accelerator should be installed<br/>   &gt; Install and/or enable a PHP accelerator (highly recommended).</span><span id="5806" class="mr lk iq mn b gy mw mt l mu mv"> * realpath_cache_size should be at least 5M in php.ini<br/>   &gt; Setting "realpath_cache_size" to e.g. "5242880" or "5M" in<br/>   &gt; php.ini* may improve performance on Windows significantly in some<br/>   &gt; cases.<br/></span><span id="c266" class="mr lk iq mn b gy mw mt l mu mv">Note  The command console can use a different php.ini file<br/>~~~~  than the one used by your web server.<br/>      Please check that both the console and the web server<br/>      are using the same PHP version and configuration.</span></pre><p id="bc64" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据<em class="mx">建议</em>信息，在<em class="mx"> php.ini </em>中调整您的PHP配置。我们将在示例应用程序中使用Postgres作为数据库，确保启用了<code class="fe my mz na mn b">pdo_pgsql</code>和<code class="fe my mz na mn b">pgsql</code>模块。</p><p id="84c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，您可以通过以下命令确认启用的模块。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="830d" class="mr lk iq mn b gy ms mt l mu mv"># php -m</span></pre><p id="8638" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个新的Symfony项目。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="f8ab" class="mr lk iq mn b gy ms mt l mu mv"># symfony new rest-sample</span><span id="6ec7" class="mr lk iq mn b gy mw mt l mu mv">// a classic website application<br/># symfony new web-sample --full</span></pre><p id="b22e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">默认情况下，它将创建一个简单的Symfony骨架项目，只包含核心内核配置，这有利于启动一个轻量级Restful API应用程序。</p><p id="4b39" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者，您可以使用Composer创建它。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="b364" class="mr lk iq mn b gy ms mt l mu mv"># composer create-project symfony/skeleton rest-sample</span><span id="6079" class="mr lk iq mn b gy mw mt l mu mv">//start a classic website application<br/># composer create-project symfony/website-skeleton web-sample</span></pre><p id="edf7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">进入生成的项目根文件夹，启动应用程序。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="9a47" class="mr lk iq mn b gy ms mt l mu mv"># symfony server:start</span><span id="6412" class="mr lk iq mn b gy mw mt l mu mv"> [WARNING] run "symfony.exe server:ca:install" first if you want to run the web server with TLS support, or use "--no-  <br/> tls" to avoid this warning                                                                                             <br/>                                                                                                                       <br/>Tailing PHP-CGI log file (C:\Users\hantsy\.symfony\log\499d60b14521d4842ba7ebfce0861130efe66158\79ca75f9e90b4126a5955a33ea6a41ec5e854698.log)<br/>Tailing Web Server log file (C:\Users\hantsy\.symfony\log\499d60b14521d4842ba7ebfce0861130efe66158.log)<br/>                                                                                                                        <br/> [OK] Web server listening                                                                                              <br/>      The Web server is using PHP CGI 8.0.10                                                                            <br/>      <a class="ae lb" href="http://127.0.0.1:8000" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8000</a>                                                                                             <br/>                                                                                                                        </span><span id="25e0" class="mr lk iq mn b gy mw mt l mu mv">[Web Server ] Oct  4 13:33:01 |DEBUG  | PHP    Reloading PHP versions<br/>[Web Server ] Oct  4 13:33:01 |DEBUG  | PHP    Using PHP version 8.0.10 (from default version in $PATH)<br/>[Web Server ] Oct  4 13:33:01 |INFO   | PHP    listening path="C:\\tools\\php80\\php-cgi.exe" php="8.0.10" port=61738</span></pre></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="3f61" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">你好，Symfony</h1><p id="647b" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">在HTTP响应中为资源实体创建一个简单的类。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="3c46" class="mr lk iq mn b gy ms mt l mu mv">class Post<br/>{<br/>    private ?string $id = null;</span><span id="5a77" class="mr lk iq mn b gy mw mt l mu mv">    private string $title;</span><span id="1828" class="mr lk iq mn b gy mw mt l mu mv">    private string $content;<br/>    <br/>    //getters and setters.<br/>}</span></pre><p id="6f9f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">并使用工厂创建一个新的Post实例。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="94b4" class="mr lk iq mn b gy ms mt l mu mv">class PostFactory<br/>{<br/>    public static function create(string $title, string $content): Post<br/>    {<br/>        $post = new Post();<br/>        $post-&gt;setTitle($title);<br/>        $post-&gt;setContent($content);<br/>        return $post;<br/>    }<br/>}</span></pre><p id="0659" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们创建一个简单的控制器类。</p><p id="9674" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要使用最新的PHP 8属性来配置路由规则，请在项目配置中应用以下更改。</p><ul class=""><li id="8715" class="nb nc iq jp b jq jr ju jv jy nd kc ne kg nf kk ng nh ni nj bi translated">打开<em class="mx">config/packages/doctrine . YAML</em>，移除<code class="fe my mz na mn b">doctrine/orm/mapping/App/type</code>或将其值改为<code class="fe my mz na mn b">attribute</code></li><li id="46d9" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated">打开<em class="mx"> composer.json </em>，将PHP版本改为<code class="fe my mz na mn b">&gt;=8.0.0</code>。</li></ul><p id="3f5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要将响应主体呈现为JSON字符串，请使用一个<code class="fe my mz na mn b">JsonReponse</code>来包装响应。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="5d40" class="mr lk iq mn b gy ms mt l mu mv">#[Route(path: "/posts", name: "posts_")]<br/>class PostController<br/>{</span><span id="ea90" class="mr lk iq mn b gy mw mt l mu mv">    #[Route(path: "", name: "all", methods: ["GET"])]<br/>    function all(): Response<br/>    {<br/>        $post1 = PostFactory::create("test title", "test content");<br/>        $post1-&gt;setId("1");</span><span id="3b17" class="mr lk iq mn b gy mw mt l mu mv">        $post2 = PostFactory::create("test title", "test content");<br/>        $post2-&gt;setId("2");<br/>        $data = [$post1-&gt;asArray(), $post2-&gt;asArray()];<br/>        return new JsonResponse($data, 200, ["Content-Type" =&gt; "application/json"]);<br/>        //return $this-&gt;json($data, 200, ["Content-Type" =&gt; "application/json"]);<br/>    }<br/>}</span></pre><p id="aae7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe my mz na mn b">JsonReponse</code>的第一个参数接受一个数组作为数据，因此在<code class="fe my mz na mn b">Post</code>类中添加一个函数来实现这个目的。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="8809" class="mr lk iq mn b gy ms mt l mu mv">class Post{<br/>    //...<br/>    public function asArray(): array<br/>    {<br/>        return [<br/>            'id' =&gt; $this-&gt;id,<br/>            'title' =&gt; $this-&gt;title,<br/>            'content' =&gt; $this-&gt;content<br/>        ];<br/>    }<br/>}</span></pre><p id="e179" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行应用程序，使用<code class="fe my mz na mn b">curl</code>测试<code class="fe my mz na mn b">/posts</code>端点。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="cf33" class="mr lk iq mn b gy ms mt l mu mv"># curl <a class="ae lb" href="http://localhost:8000/posts" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/posts</a></span></pre><p id="3e41" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Symfony提供了一个简单的<code class="fe my mz na mn b">AbstractController</code>,它包括几个函数来简化响应并采用容器和依赖注入管理。</p><p id="429a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的控制器中，从<code class="fe my mz na mn b">AbstractController</code>扩展而来，只需调用<code class="fe my mz na mn b">$this-&gt;json</code>以JSON格式渲染响应，无需在渲染响应前将数据转换为数组。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="2c3e" class="mr lk iq mn b gy ms mt l mu mv">class PostController extends AbstractController<br/>{</span><span id="1a93" class="mr lk iq mn b gy mw mt l mu mv">    function all(): Response<br/>    {<br/>        //...<br/>        return $this-&gt;json($data, 200, ["Content-Type" =&gt; "application/json"]);<br/>    }<br/>}</span></pre></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="d3da" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">连接到数据库</h1><p id="85fa" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">Doctrine是一个流行的ORM框架，它高度受现有Java ORM工具的启发，如JPA spec和Hibernate框架。教义中有两个核心组件，<code class="fe my mz na mn b">doctrine/dbal</code>和<code class="fe my mz na mn b">doctrine/orm</code>，前者是用于数据库操作的底层API，如果你懂Java开发，就把它当成<em class="mx"> Jdbc </em>层。后者是高级ORM框架，公共API类似于JPA/Hibernate。</p><p id="5463" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将原则纳入项目。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="5660" class="mr lk iq mn b gy ms mt l mu mv"># composer require symfony/orm-pack<br/># composer require --dev symfony/maker-bundle</span></pre><p id="4a39" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">包</strong>是一个虚拟的Symfony包，它会安装一系列的包和基本配置。</p><p id="f112" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">打开项目根目录下的<code class="fe my mz na mn b">.env</code>文件，编辑<code class="fe my mz na mn b">DATABASE_URL</code>值，设置数据库名称、用户名、密码进行连接。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="d37e" class="mr lk iq mn b gy ms mt l mu mv">DATABASE_URL="postgresql://user:password@127.0.0.1:5432/blogdb?serverVersion=13&amp;charset=utf8"</span></pre><p id="8f92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用以下命令生成docker合成文件模板。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="8968" class="mr lk iq mn b gy ms mt l mu mv"># php bin/console make:docker:database</span></pre><p id="42db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将其更改为以下内容，以启动正在开发的Postgres数据库。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="9a8b" class="mr lk iq mn b gy ms mt l mu mv">version: "3.5" # specify docker-compose version, v3.5 is compatible with docker 17.12.0+</span><span id="6199" class="mr lk iq mn b gy mw mt l mu mv"># Define the services/containers to be run<br/>services:</span><span id="1be6" class="mr lk iq mn b gy mw mt l mu mv">  postgres:<br/>    image: postgres:${POSTGRES_VERSION:-13}-alpine<br/>    ports:<br/>      - "5432:5432"<br/>    environment:<br/>      POSTGRES_DB: ${POSTGRES_DB:-blogdb}<br/>      # You should definitely change the password in production<br/>      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}<br/>      POSTGRES_USER: ${POSTGRES_USER:-user}<br/>    volumes:<br/>      - ./data/blogdb:/var/lib/postgresql/data:rw<br/>      - ./pg-initdb.d:/docker-entrypoint-initdb.d</span></pre><p id="b06d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用<code class="fe my mz na mn b">UUID</code>作为主键的数据类型，添加一个脚本以在Postgres启动时启用<code class="fe my mz na mn b">uuid-ossp</code>扩展。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="952d" class="mr lk iq mn b gy ms mt l mu mv">-- file: pg-initdb.d/ini.sql<br/>SET search_path TO public;<br/>DROP EXTENSION IF EXISTS "uuid-ossp";<br/>CREATE EXTENSION "uuid-ossp" SCHEMA public;</span></pre><p id="de4c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">打开<em class="mx">config/packages/test/doctrine . YAML</em>，注释掉<code class="fe my mz na mn b">dbname_suffix</code>行。我们使用Docker容器来引导数据库，以确保开发和生产之间的应用程序行为是相同的。</p><p id="046b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在启动应用程序并确保控制台中没有异常，这意味着数据库连接成功。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="81c9" class="mr lk iq mn b gy ms mt l mu mv">symfony server:start</span></pre><p id="d51d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在启动应用程序之前，请确保数据库正在运行。运行以下命令在Docker中启动Postgres。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="f9c8" class="mr lk iq mn b gy ms mt l mu mv"># docker compose up postgres<br/># docker ps -a # to list all containers and make the postgres is running</span></pre></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="1da8" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">构建数据模型</h1><p id="ce93" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">现在，我们将构建将在下一节中使用的实体。我们正在建模一个简单的博客系统，它包括以下概念。</p><ul class=""><li id="f1b9" class="nb nc iq jp b jq jr ju jv jy nd kc ne kg nf kk ng nh ni nj bi translated">A <code class="fe my mz na mn b">Post</code>在博客系统中呈现文章帖子。</li><li id="f04e" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated">A <code class="fe my mz na mn b">Comment</code>呈现特定帖子下的评论。</li><li id="ee2d" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated">常用的<code class="fe my mz na mn b">Tag</code>可以应用在不同的帖子上，按照主题、类别等对帖子进行分类。</li></ul><p id="ce8a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以在头脑中或通过一些图形数据建模工具来绘制模型关系。</p><ul class=""><li id="beca" class="nb nc iq jp b jq jr ju jv jy nd kc ne kg nf kk ng nh ni nj bi translated">帖子和评论是一种<code class="fe my mz na mn b">one-to-many</code>关系</li><li id="9c4e" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated">发布和标记是一种<code class="fe my mz na mn b">many-to-many</code>关系</li></ul><p id="684b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过教义很容易将想法转化为真正的代码。运行以下命令创建<code class="fe my mz na mn b">Post</code>、<code class="fe my mz na mn b">Comment</code>和<code class="fe my mz na mn b">Tag</code>实体。</p><p id="380f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在ORM 2.10.x和Dbal 3.x中，UUID类型ID生成器已被弃用。我们将切换到Uuid形式<code class="fe my mz na mn b">symfony\uid</code>。</p><p id="a648" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">先安装<code class="fe my mz na mn b">symfony\uid</code>。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="4246" class="mr lk iq mn b gy ms mt l mu mv"># composer require symfony/uid</span></pre><p id="60d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">简单地说，您可以使用下面的命令快速创建实体。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="bad1" class="mr lk iq mn b gy ms mt l mu mv"># php bin/console make:entity  # following the interactive steps to create them one by one.</span></pre><p id="66dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后我们在<em class="mx"> src/Entity </em>文件夹中得到三个实体。按照您的期望修改它们。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="aea7" class="mr lk iq mn b gy ms mt l mu mv">// src/Entity/Post.php<br/>#[Entity(repositoryClass: PostRepository::class)]<br/>class Post<br/>{<br/>    #[Id]<br/>    //#[GeneratedValue(strategy: "UUID")<br/>    //#[Column(type: "string", unique: true)]<br/>    #[Column(type: "uuid", unique: true)]<br/>    #[GeneratedValue(strategy: "CUSTOM")]<br/>    #[CustomIdGenerator(class: UuidGenerator::class)]<br/>    private ?Uuid $id = null;</span><span id="539f" class="mr lk iq mn b gy mw mt l mu mv">    #[Column(type: "string", length: 255)]<br/>    private string $title;</span><span id="6d90" class="mr lk iq mn b gy mw mt l mu mv">    #[Column(type: "string", length: 255)]<br/>    private string $content;</span><span id="cebe" class="mr lk iq mn b gy mw mt l mu mv">    #[Column(name: "created_at", type: "datetime", nullable: true)]<br/>    private DateTime|null $createdAt = null;</span><span id="9636" class="mr lk iq mn b gy mw mt l mu mv">    #[Column(name: "published_at", type: "datetime", nullable: true)]<br/>    private DateTime|null $publishedAt = null;</span><span id="98d8" class="mr lk iq mn b gy mw mt l mu mv">    #[OneToMany(mappedBy: "post", targetEntity: Comment::class, cascade: ['persist', 'merge', "remove"], fetch: 'LAZY', orphanRemoval: true)]<br/>    private Collection $comments;</span><span id="13ed" class="mr lk iq mn b gy mw mt l mu mv">    #[ManyToMany(targetEntity: Tag::class, mappedBy: "posts", cascade: ['persist', 'merge'], fetch: 'EAGER')]<br/>    private Collection $tags;</span><span id="a182" class="mr lk iq mn b gy mw mt l mu mv">    public function __construct()<br/>    {<br/>        $this-&gt;createdAt = new DateTime();<br/>        $this-&gt;comments = new ArrayCollection();<br/>        $this-&gt;tags = new ArrayCollection();<br/>    }<br/>    //other getters and setters<br/>}</span><span id="ac85" class="mr lk iq mn b gy mw mt l mu mv">// src/Entity/Comment.php<br/>#[Entity(repositoryClass: CommentRepository::class)]<br/>class Comment<br/>{<br/>    #[Id]<br/>    //#[GeneratedValue(strategy: "UUID")]<br/>    #[Column(type: "uuid", unique: true)]<br/>    #[GeneratedValue(strategy: "CUSTOM")]<br/>    #[CustomIdGenerator(class: UuidGenerator::class)]<br/>    private ?Uuid $id = null;</span><span id="ded6" class="mr lk iq mn b gy mw mt l mu mv">    #[Column(type: "string", length: 255)]<br/>    private string $content;</span><span id="e963" class="mr lk iq mn b gy mw mt l mu mv">    #[Column(name: "created_at", type: "datetime", nullable: true)]<br/>    private DateTime|null $createdAt = null;</span><span id="c983" class="mr lk iq mn b gy mw mt l mu mv">    #[ManyToOne(targetEntity: "Post", inversedBy: "comments")]<br/>    #[JoinColumn(name: "post_id", referencedColumnName: "id")]<br/>    private Post $post;</span><span id="6873" class="mr lk iq mn b gy mw mt l mu mv">    public function __construct()<br/>    {<br/>        $this-&gt;createdAt = new DateTime();<br/>    }<br/>    //other getters and setters<br/>}</span><span id="8695" class="mr lk iq mn b gy mw mt l mu mv">//src/Entity/Tag.php<br/>#[Entity(repositoryClass: TagRepository::class)]<br/>class Tag<br/>{<br/>    #[Id]<br/>    //#[GeneratedValue(strategy: "UUID")<br/>    //#[Column(type: "string", unique: true)]<br/>    #[Column(type: "uuid", unique: true)]<br/>    #[GeneratedValue(strategy: "CUSTOM")]<br/>    #[CustomIdGenerator(class: UuidGenerator::class)]<br/>    private ?Uuid $id = null;</span><span id="901d" class="mr lk iq mn b gy mw mt l mu mv">    #[Column(type: "string", length: 255)]<br/>    private ?string $name;</span><span id="9c0b" class="mr lk iq mn b gy mw mt l mu mv">    #[ManyToMany(targetEntity: Post::class, inversedBy: "tags")]<br/>    private Collection $posts;</span><span id="f289" class="mr lk iq mn b gy mw mt l mu mv">    public function __construct()<br/>    {<br/>        $this-&gt;posts = new ArrayCollection();<br/>    }<br/>}</span></pre><p id="5cff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">同时，它为这些实体生成了三个<code class="fe my mz na mn b">Repository</code>类。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="8929" class="mr lk iq mn b gy ms mt l mu mv">// src/Repository/PostRepsoitory.php<br/>class PostRepository extends ServiceEntityRepository<br/>{<br/>    public function __construct(ManagerRegistry $registry)<br/>    {<br/>        parent::__construct($registry, Post::class);<br/>    }<br/>}</span><span id="d196" class="mr lk iq mn b gy mw mt l mu mv">// src/Repository/CommentRepsoitory.php<br/>class CommentRepository extends ServiceEntityRepository<br/>{<br/>    public function __construct(ManagerRegistry $registry)<br/>    {<br/>        parent::__construct($registry, Comment::class);<br/>    }<br/>}</span><span id="6330" class="mr lk iq mn b gy mw mt l mu mv">//src/Repository/TagRepository.php<br/>class TagRepository extends ServiceEntityRepository<br/>{<br/>    public function __construct(ManagerRegistry $registry)<br/>    {<br/>        parent::__construct($registry, Tag::class);<br/>    }<br/>}</span></pre><p id="7856" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以使用原则迁移来生成一个<em class="mx">迁移</em>文件，以在生产环境中维护数据库模式。</p><p id="6ff0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行以下命令生成一个<em class="mx">迁移</em>文件。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="f8ee" class="mr lk iq mn b gy ms mt l mu mv"># php bin/console make:migration</span></pre><p id="ff38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">执行后，在<em class="mx">迁移</em>文件夹中生成一个迁移文件，其命名类似于<code class="fe my mz na mn b">Version20211104031420</code>。这是一个简单的扩展<code class="fe my mz na mn b">AbstractMigration</code>类，<code class="fe my mz na mn b">up</code>函数用于升级到这个版本，<code class="fe my mz na mn b">down</code>函数用于降级到以前的版本。</p><p id="a8a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">自动在数据库上应用迁移。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="41e7" class="mr lk iq mn b gy ms mt l mu mv"># php bin/console doctrine:migrations:migrate</span><span id="1677" class="mr lk iq mn b gy mw mt l mu mv"># return to prev version<br/># php bin/console doctrine:migrations:migrate prev</span><span id="bf6a" class="mr lk iq mn b gy mw mt l mu mv"># migrate to next<br/># php bin/console doctrine:migrations:migrate next</span><span id="9a3a" class="mr lk iq mn b gy mw mt l mu mv"># These alias are defined : first, latest, prev, current and next</span><span id="d439" class="mr lk iq mn b gy mw mt l mu mv"># certain version fully qualified class name<br/># php bin/console doctrine:migrations:migrate FQCN</span></pre><p id="e4e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Doctrine bundle还包括一些维护数据库和模式命令。例如。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="5807" class="mr lk iq mn b gy ms mt l mu mv"># php bin/console doctrine:database:create<br/># php bin/console doctrine:database:drop</span><span id="43e0" class="mr lk iq mn b gy mw mt l mu mv">// schema create, drop, update and validate<br/># php bin/console doctrine:schema:create<br/># php bin/console doctrine:schema:drop<br/># php bin/console doctrine:schema:update<br/># php bin/console doctrine:schema:validate</span></pre><h1 id="f40c" class="lj lk iq bd ll lm np lo lp lq nq ls lt lu nr lw lx ly ns ma mb mc nt me mf mg bi translated">添加样本数据</h1><p id="7fc3" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">创建一个自定义命令来加载一些示例数据。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="ca7e" class="mr lk iq mn b gy ms mt l mu mv"># php bin/console make:command add-post</span></pre><p id="815e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它会在<em class="mx"> src/Command </em>文件夹下生成一个<code class="fe my mz na mn b">AddPostCommand</code>。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="3932" class="mr lk iq mn b gy ms mt l mu mv">#[AsCommand(<br/>    name: 'app:add-post',<br/>    description: 'Add a short description for your command',<br/>)]<br/>class AddPostCommand extends Command<br/>{<br/></span><span id="819b" class="mr lk iq mn b gy mw mt l mu mv">    public function __construct(private EntityManagerInterface $manager)<br/>    {<br/>        parent::__construct();<br/>    }</span><span id="139d" class="mr lk iq mn b gy mw mt l mu mv">    protected function configure(): void<br/>    {<br/>        $this<br/>            -&gt;addArgument('title', InputArgument::REQUIRED, 'Title of a post')<br/>            -&gt;addArgument('content', InputArgument::REQUIRED, 'Content of a post')<br/>            //-&gt;addOption('option1', null, InputOption::VALUE_NONE, 'Option description')<br/>        ;<br/>    }</span><span id="3636" class="mr lk iq mn b gy mw mt l mu mv">    protected function execute(InputInterface $input, OutputInterface $output): int<br/>    {<br/>        $io = new SymfonyStyle($input, $output);<br/>        $title = $input-&gt;getArgument('title');</span><span id="942f" class="mr lk iq mn b gy mw mt l mu mv">        if ($title) {<br/>            $io-&gt;note(sprintf('Title: %s', $title));<br/>        }</span><span id="c2fa" class="mr lk iq mn b gy mw mt l mu mv">        $content = $input-&gt;getArgument('content');</span><span id="6925" class="mr lk iq mn b gy mw mt l mu mv">        if ($content) {<br/>            $io-&gt;note(sprintf('Content: %s', $content));<br/>        }</span><span id="fa88" class="mr lk iq mn b gy mw mt l mu mv">        $entity = PostFactory::create($title, $content);<br/>        $this -&gt;manager-&gt;persist($entity);<br/>        $this -&gt;manager-&gt;flush();</span><span id="9f26" class="mr lk iq mn b gy mw mt l mu mv">//        if ($input-&gt;getOption('option1')) {<br/>//            // ...<br/>//        }</span><span id="7b3c" class="mr lk iq mn b gy mw mt l mu mv">        $io-&gt;success('Post is saved: '.$entity);</span><span id="df09" class="mr lk iq mn b gy mw mt l mu mv">        return Command::SUCCESS;<br/>    }<br/>}</span></pre><p id="25e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">教条<code class="fe my mz na mn b">EntityManagerInterface</code>由Symfony <em class="mx">服务容器</em>管理，用于数据持久化操作。</p><p id="f9ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行以下命令，将帖子添加到数据库中。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="5332" class="mr lk iq mn b gy ms mt l mu mv"># php bin/console app:add-post "test title" "test content"<br/> ! [NOTE] Title: test title                                               <br/> ! [NOTE] Content: test content                                                             <br/> [OK] Post is saved: Post: [ id =1ec3d3ec-895d-685a-b712-955865f6c134, title=test title, content=test content, createdAt=1636010040, blishedAt=]</span></pre><h1 id="06df" class="lj lk iq bd ll lm np lo lp lq nq ls lt lu nr lw lx ly ns ma mb mc nt me mf mg bi translated">测试存储库</h1><p id="3845" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">PHPUnit是PHP世界中最流行的测试框架，Symfony紧密地集成了PHPUnit。</p><p id="2b62" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行以下命令来安装PHPUnit和Symfony <strong class="jp ir">测试包</strong>。<strong class="jp ir">测试包</strong>将安装所有用于测试Symfony组件的必要包，并添加PHPUnit配置，如<em class="mx"> phpunit.xml.dist </em>。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="8cbc" class="mr lk iq mn b gy ms mt l mu mv"># composer require --dev phpunit/phpunit symfony/test-pack</span></pre><p id="d0a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个用纯PHPUnit编写的简单测试示例。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="5d75" class="mr lk iq mn b gy ms mt l mu mv">class PostTest extends TestCase<br/>{</span><span id="cc4c" class="mr lk iq mn b gy mw mt l mu mv">    public function testPost()<br/>    {<br/>        $p = PostFactory::create("tests title", "tests content");</span><span id="a345" class="mr lk iq mn b gy mw mt l mu mv">        $this-&gt;assertEquals("tests title", $p-&gt;getTitle());<br/>        $this-&gt;assertEquals("tests content", $p-&gt;getContent());<br/>        $this-&gt;assertNotNull( $p-&gt;getCreatedAt());<br/>    }<br/>}</span></pre><p id="7988" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Symfony提供了一些特定的基类(<code class="fe my mz na mn b">KernelTestCase</code>、<code class="fe my mz na mn b">WebTestCase</code>等)。)来简化Symfony项目中的测试工作。</p><p id="5671" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是测试一个<code class="fe my mz na mn b">Repository</code> - <code class="fe my mz na mn b">PostRepository</code>的例子。<code class="fe my mz na mn b">KernelTestCase</code>包含引导应用内核的工具，并提供服务容器。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="40cc" class="mr lk iq mn b gy ms mt l mu mv">class PostRepositoryTest extends KernelTestCase<br/>{</span><span id="74c2" class="mr lk iq mn b gy mw mt l mu mv">    private EntityManagerInterface $entityManager;</span><span id="4b52" class="mr lk iq mn b gy mw mt l mu mv">    private PostRepository $postRepository;</span><span id="080d" class="mr lk iq mn b gy mw mt l mu mv">    protected function setUp(): void<br/>    {<br/>        //(1) boot the Symfony kernel<br/>        $kernel = self::bootKernel();<br/>        $this-&gt;assertSame('test', $kernel-&gt;getEnvironment());<br/>        $this-&gt;entityManager = $kernel-&gt;getContainer()<br/>            -&gt;get('doctrine')<br/>            -&gt;getManager();</span><span id="c2aa" class="mr lk iq mn b gy mw mt l mu mv">        //(2) use static::getContainer() to access the service container<br/>        $container = static::getContainer();</span><span id="25aa" class="mr lk iq mn b gy mw mt l mu mv">        //(3) get PostRepository from container.<br/>        $this-&gt;postRepository = $container-&gt;get(PostRepository::class);<br/>    }</span><span id="a024" class="mr lk iq mn b gy mw mt l mu mv">    protected function tearDown(): void<br/>    {<br/>        parent::tearDown();<br/>        $this-&gt;entityManager-&gt;close();<br/>    }</span><span id="8a70" class="mr lk iq mn b gy mw mt l mu mv">    public function testCreatePost(): void<br/>    {<br/>        $entity = PostFactory::create("test post", "test content");<br/>        $this-&gt;entityManager-&gt;persist($entity);<br/>        $this-&gt;entityManager-&gt;flush();<br/>        $this-&gt;assertNotNull($entity-&gt;getId());</span><span id="1114" class="mr lk iq mn b gy mw mt l mu mv">        $byId = $this-&gt;postRepository-&gt;findOneBy(["id" =&gt; $entity-&gt;getId()]);<br/>        $this-&gt;assertEquals("test post", $byId-&gt;getTitle());<br/>        $this-&gt;assertEquals("test content", $byId-&gt;getContent());<br/>    }</span><span id="8375" class="mr lk iq mn b gy mw mt l mu mv">}</span></pre><p id="67a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的代码中，在<code class="fe my mz na mn b">setUp</code>函数中，启动应用内核，启动后，测试范围<em class="mx">服务容器</em>可用。然后从服务容器中取出<code class="fe my mz na mn b">EntityManagerInterface</code>和<code class="fe my mz na mn b">PostRepository</code>。</p><p id="ceac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe my mz na mn b">testCreatePost</code>函数中，持久化一个<code class="fe my mz na mn b">Post</code>实体，通过id找到这个帖子，并验证<em class="mx">标题</em>和<em class="mx">内容</em>字段。</p><blockquote class="nu nv nw"><p id="490e" class="jn jo mx jp b jq jr js jt ju jv jw jx nx jz ka kb ny kd ke kf nz kh ki kj kk ij bi translated"><em class="iq">目前，PHPUnit不包括PHP 8属性支持，测试代码类似于遗留的JUnit 4代码风格。</em></p></blockquote></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="9bb9" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">创建后置控制器:公开第一个Rest API</h1><p id="dfa4" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">与其他MVC框架类似，我们可以通过Symfony <code class="fe my mz na mn b">Controller</code>组件公开RESTful APIs。遵循REST惯例，我们计划为博客系统创建以下API。</p><ul class=""><li id="ad93" class="nb nc iq jp b jq jr ju jv jy nd kc ne kg nf kk ng nh ni nj bi translated"><code class="fe my mz na mn b">GET /posts</code>获取所有帖子。</li><li id="515f" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated"><code class="fe my mz na mn b">GET /posts/{id}</code>通过ID获取单个帖子，如果没有找到，返回状态404</li><li id="4441" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated"><code class="fe my mz na mn b">POST /posts</code>从请求体创建一个新帖子，将新帖子URI添加到响应头<code class="fe my mz na mn b">Location</code>，并返回状态201</li><li id="3854" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated"><code class="fe my mz na mn b">DELETE /posts/{id}</code>按ID删除单个帖子，返回状态204。如果没有找到帖子，则返回状态404。</li><li id="8308" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi">…</li></ul><p id="45e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行以下命令创建控制器骨架。按照交互式指南创建一个名为<code class="fe my mz na mn b">PostController</code>的控制器。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="8c97" class="mr lk iq mn b gy ms mt l mu mv"># php bin/console make:constroller</span></pre><p id="4cc1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在IDE中打开<em class="mx">src/Controller/post Controller . PHP</em>。</p><p id="1d25" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在类级别上添加<code class="fe my mz na mn b">Route</code>属性和两个函数:一个用于获取所有帖子，另一个用于通过ID获取单个帖子。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="205b" class="mr lk iq mn b gy ms mt l mu mv">#[Route(path: "/posts", name: "posts_")]<br/>class PostController extends AbstractController<br/>{<br/>    public function __construct(private PostRepository      $posts)<br/>    {<br/>    }</span><span id="ed49" class="mr lk iq mn b gy mw mt l mu mv">    #[Route(path: "", name: "all", methods: ["GET"])]<br/>    function all(): Response<br/>    {<br/>        $data = $this-&gt;posts-&gt;findAll();<br/>        return $this-&gt;json($data);<br/>    }<br/>    <br/>}</span></pre><p id="0ec0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动应用程序，尝试访问<a class="ae lb" href="http://localhost:8000/posts" rel="noopener ugc nofollow" target="_blank"><em class="mx">http://localhost:8000/posts</em></a>，直接在JSON视图中渲染模型时会抛出循环依赖异常。有一些解决方案可以避免这种情况，最简单的是在呈现JSON视图之前打破双向关系。在<code class="fe my mz na mn b">Comment.post</code>和<code class="fe my mz na mn b">Tag.posts</code>上添加一个<code class="fe my mz na mn b">Ignore</code>属性。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="043a" class="mr lk iq mn b gy ms mt l mu mv">//src/Entity/Comment.php<br/>class Comment<br/>{<br/>    #[Ignore]<br/>    private Post $post;<br/>}</span><span id="070c" class="mr lk iq mn b gy mw mt l mu mv">//src/Entity/Tag.php<br/>class Tag<br/>{<br/>    #[Ignore]<br/>    private Collection $posts;<br/>}</span></pre><h1 id="b6b3" class="lj lk iq bd ll lm np lo lp lq nq ls lt lu nr lw lx ly ns ma mb mc nt me mf mg bi translated">测试控制器</h1><p id="3c39" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">如前几节所述，为了测试控制器/API，创建一个测试类来扩展<code class="fe my mz na mn b">WebTestCase</code>，它提供了大量处理请求和断言响应的工具。</p><p id="f9f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行以下命令创建一个测试框架。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="0046" class="mr lk iq mn b gy ms mt l mu mv"># php bin/console make:test</span></pre><p id="00a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">按照交互步骤在<code class="fe my mz na mn b">WebTestCase</code>上创建一个测试库。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="f4c4" class="mr lk iq mn b gy ms mt l mu mv">class PostControllerTest extends WebTestCase<br/>{<br/>    public function testGetAllPosts(): void<br/>    {<br/>        $client = static::createClient();<br/>        $crawler = $client-&gt;request('GET', '/posts');</span><span id="cbbe" class="mr lk iq mn b gy mw mt l mu mv">        $this-&gt;assertResponseIsSuccessful();</span><span id="3e90" class="mr lk iq mn b gy mw mt l mu mv">        //<br/>        $response = $client-&gt;getResponse();<br/>        $data = $response-&gt;getContent();<br/>        //dump($data);<br/>        $this-&gt;assertStringContainsString("Symfony and PHP", $data);<br/>    }</span><span id="15c7" class="mr lk iq mn b gy mw mt l mu mv">}</span></pre><p id="7ae8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您尝试运行测试，它将会失败。目前，没有任何数据可供测试。</p><h1 id="b792" class="lj lk iq bd ll lm np lo lp lq nq ls lt lu nr lw lx ly ns ma mb mc nt me mf mg bi translated">为测试目的准备数据</h1><p id="64b7" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated"><code class="fe my mz na mn b">doctrine/doctrine-fixtures-bundle</code>用于为测试目的填充样本数据，而<code class="fe my mz na mn b">dama/doctrine-test-bundle</code>确保在每次测试运行前恢复数据。</p><p id="8370" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装<code class="fe my mz na mn b">doctrine/doctrine-fixtures-bundle</code>和<code class="fe my mz na mn b">dama/doctrine-test-bundle</code>。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="1c5a" class="mr lk iq mn b gy ms mt l mu mv">composer require --dev doctrine/doctrine-fixtures-bundle dama/doctrine-test-bundle</span></pre><p id="4fea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创造一个新的<code class="fe my mz na mn b">Fixture</code>。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="1825" class="mr lk iq mn b gy ms mt l mu mv"># php bin/console make:fixtures</span></pre><p id="ee5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe my mz na mn b">load</code>功能中，保存一些测试数据。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="a6c3" class="mr lk iq mn b gy ms mt l mu mv">class AppFixtures extends Fixture<br/>{<br/>    public function load(ObjectManager $manager): void<br/>    {<br/>        $data = PostFactory::create("Building Restful APIs with Symfony and PHP 8", "test content");<br/>        $data-&gt;addTag(Tag::of( "Symfony"))<br/>            -&gt;addTag( Tag::of("PHP 8"))<br/>            -&gt;addComment(Comment::of("test comment 1"))<br/>            -&gt;addComment(Comment::of("test comment 2"));</span><span id="55ff" class="mr lk iq mn b gy mw mt l mu mv">        $manager-&gt;persist($data);<br/>        $manager-&gt;flush();<br/>    }<br/>}</span></pre><p id="f022" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行命令将示例数据手动加载到数据库中。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="3b55" class="mr lk iq mn b gy ms mt l mu mv"># php bin/console doctrine:fixtures:load</span></pre><p id="702c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将下面的扩展配置添加到<code class="fe my mz na mn b">phpunit.xml.dist</code>中，这样每次测试运行时，数据都将被清除并重新创建。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="dbc8" class="mr lk iq mn b gy ms mt l mu mv">&lt;extensions&gt;<br/>    &lt;extension class="DAMA\DoctrineTestBundle\PHPUnit\PHPUnitExtension"/&gt;<br/>&lt;/extensions&gt;</span></pre><p id="9476" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行以下命令执行<code class="fe my mz na mn b">PostControllerTest.php</code>。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="b333" class="mr lk iq mn b gy ms mt l mu mv"># php .\vendor\bin\phpunit .\tests\Controller\PostControllerTest.php</span></pre><h1 id="b403" class="lj lk iq bd ll lm np lo lp lq nq ls lt lu nr lw lx ly ns ma mb mc nt me mf mg bi translated">分页结果</h1><p id="3e83" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">有许多web应用程序提供了一个输入字段，用于键入关键字和对搜索结果进行分页。假设请求提供了一个<em class="mx">关键字</em>来匹配帖子<em class="mx">标题</em>或<em class="mx">内容</em>字段，一个<em class="mx">偏移</em>来设置分页的偏移位置，一个<em class="mx">限制</em>来设置每页元素的限制大小。在<code class="fe my mz na mn b">PostRepository</code>中创建一个函数，接受一个<em class="mx">关键字</em>、<em class="mx">偏移</em>和<em class="mx">限制</em>作为参数。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="cd8c" class="mr lk iq mn b gy ms mt l mu mv">public function findByKeyword(string $q, int $offset = 0, int $limit = 20): Page<br/>{<br/>    $query = $this-&gt;createQueryBuilder("p")<br/>        -&gt;andWhere("p.title like :q or p.content like :q")<br/>        -&gt;setParameter('q', "%" . $q . "%")<br/>        -&gt;orderBy('p.createdAt', 'DESC')<br/>        -&gt;setMaxResults($limit)<br/>        -&gt;setFirstResult($offset)<br/>        -&gt;getQuery();</span><span id="0813" class="mr lk iq mn b gy mw mt l mu mv">    $paginator = new Paginator($query, $fetchJoinCollection = false);<br/>    $c = count($paginator);<br/>    $content = new ArrayCollection();<br/>    foreach ($paginator as $post) {<br/>        $content-&gt;add(PostSummaryDto::of($post-&gt;getId(), $post-&gt;getTitle()));<br/>    }<br/>    return Page::of ($content, $c, $offset, $limit);<br/>}</span></pre><p id="7721" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，使用<code class="fe my mz na mn b">createQueryBuilder</code>创建一个动态查询，然后创建一个教条<code class="fe my mz na mn b">Paginator</code>实例来执行查询。<code class="fe my mz na mn b">Paginator</code>实现<code class="fe my mz na mn b">Countable</code>接口，使用<code class="fe my mz na mn b">count</code>获取元素总数。最后，我们使用一个定制的<code class="fe my mz na mn b">Page</code>对象来包装结果。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="3433" class="mr lk iq mn b gy ms mt l mu mv">class Page<br/>{<br/>    private Collection $content;<br/>    private int $totalElements;<br/>    private int $offset;<br/>    private int $limit;</span><span id="d760" class="mr lk iq mn b gy mw mt l mu mv">    #[Pure] public function __construct()<br/>    {<br/>        $this-&gt;content = new ArrayCollection();<br/>    }<br/></span><span id="6448" class="mr lk iq mn b gy mw mt l mu mv">    public static function of(Collection $content, int $totalElements, int $offset = 0, int $limit = 20): Page<br/>    {<br/>        $page = new Page();<br/>        $page-&gt;setContent($content)<br/>            -&gt;setTotalElements($totalElements)<br/>            -&gt;setOffset($offset)<br/>            -&gt;setLimit($limit);</span><span id="a3f4" class="mr lk iq mn b gy mw mt l mu mv">        return $page;<br/>    }<br/>    <br/>    //<br/>    //getters</span><span id="058c" class="mr lk iq mn b gy mw mt l mu mv">}</span></pre><h1 id="5041" class="lj lk iq bd ll lm np lo lp lq nq ls lt lu nr lw lx ly ns ma mb mc nt me mf mg bi translated">自定义ArgumentResolver</h1><p id="04bf" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">在<code class="fe my mz na mn b">PostController</code>中，让我们改进服务于路线<code class="fe my mz na mn b">/posts</code>的函数，使其接受类似<em class="mx"> /posts？q = Symfony&amp;offset = 0&amp;limit = 10</em>，确保参数可选。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="cdad" class="mr lk iq mn b gy ms mt l mu mv">#[Route(path: "", name: "all", methods: ["GET"])]<br/>    function all(Request $req): Response<br/>    {<br/>        $keyword = $req-&gt;query-&gt;get('q')??'';<br/>        $offset = $req-&gt;query-&gt;get('offset')??0;<br/>        $limit = $req-&gt;query-&gt;get('limit')??10;<br/>        <br/>        $data = $this-&gt;posts-&gt;findByKeyword($keyword, $offset, $limit);<br/>        return $this-&gt;json($data);<br/>    }</span></pre><p id="d821" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它可以工作，但是查询参数处理看起来有点难看。如果它们可以作为路由路径参数来处理，那就太好了。</p><p id="f3b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以创建一个定制的<code class="fe my mz na mn b">ArgumentResolver</code>来解析绑定的查询参数。</p><p id="871a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先创建一个注释/属性类来标识需要由这个<code class="fe my mz na mn b">ArgumentResolver</code>解析的查询参数。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="9031" class="mr lk iq mn b gy ms mt l mu mv">#[Attribute(Attribute::TARGET_PARAMETER)]<br/>final class QueryParam<br/>{<br/>    private null|string $name;<br/>    private bool $required;</span><span id="fc37" class="mr lk iq mn b gy mw mt l mu mv">    /**<br/>     * @param string|null $name<br/>     * @param bool $required<br/>     */<br/>    public function __construct(?string $name = null, bool $required = false)<br/>    {<br/>        $this-&gt;name = $name;<br/>        $this-&gt;required = $required;<br/>    }<br/>    <br/>    //getters and setters<br/>    <br/>}</span></pre><p id="e6c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建自定义<code class="fe my mz na mn b">ArgumentResolver</code>实现内置<code class="fe my mz na mn b">ArgugmentResolverInterface</code>。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="edeb" class="mr lk iq mn b gy ms mt l mu mv">class QueryParamValueResolver implements ArgumentValueResolverInterface, LoggerAwareInterface<br/>{<br/>    public function __construct()<br/>    {<br/>    }</span><span id="3a7f" class="mr lk iq mn b gy mw mt l mu mv">    private LoggerInterface $logger;</span><span id="d9bb" class="mr lk iq mn b gy mw mt l mu mv">    /**<br/>     * @inheritDoc<br/>     */<br/>    public function resolve(Request $request, ArgumentMetadata $argument)<br/>    {<br/>        $argumentName = $argument-&gt;getName();<br/>        $this-&gt;logger-&gt;info("Found [QueryParam] annotation/attribute on argument '" . $argumentName . "', applying [QueryParamValueResolver]");<br/>        $type = $argument-&gt;getType();<br/>        $nullable = $argument-&gt;isNullable();<br/>        $this-&gt;logger-&gt;debug("The method argument type: '" . $type . "' and nullable: '" . $nullable . "'");</span><span id="0d38" class="mr lk iq mn b gy mw mt l mu mv">        //read name property from QueryParam<br/>        $attr = $argument-&gt;getAttributes(QueryParam::class)[0];// `QueryParam` is not repeatable<br/>        $this-&gt;logger-&gt;debug("QueryParam:" . $attr);<br/>        //if name property is not set in `QueryParam`, use the argument name instead.<br/>        $name = $attr-&gt;getName() ?? $argumentName;<br/>        $required = $attr-&gt;isRequired() ?? false;<br/>        $this-&gt;logger-&gt;debug("Polished QueryParam values: name='" . $name . "', required='" . $required . "'");</span><span id="1827" class="mr lk iq mn b gy mw mt l mu mv">        //fetch query name from request<br/>        $value = $request-&gt;query-&gt;get($name);<br/>        $this-&gt;logger-&gt;debug("The request query parameter value: '" . $value . "'");</span><span id="1032" class="mr lk iq mn b gy mw mt l mu mv">        //if default value is set and query param value is not set, use default value instead.<br/>        if (!$value &amp;&amp; $argument-&gt;hasDefaultValue()) {<br/>            $value = $argument-&gt;getDefaultValue();<br/>            $this-&gt;logger-&gt;debug("After set default value: '" . $value . "'");<br/>        }</span><span id="5069" class="mr lk iq mn b gy mw mt l mu mv">        if ($required &amp;&amp; !$value) {<br/>            throw new \InvalidArgumentException("Request query parameter '" . $name . "' is required, but not set.");<br/>        }</span><span id="2229" class="mr lk iq mn b gy mw mt l mu mv">        $this-&gt;logger-&gt;debug("final resolved value: '" . $value . "'");<br/>        <br/>        //must return  a `yield` clause<br/>        yield match ($type) {<br/>            'int' =&gt; $value ? (int)$value : 0,<br/>            'float' =&gt; $value ? (float)$value : .0,<br/>            'bool' =&gt; (bool)$value,<br/>            'string' =&gt; $value ? (string)$value : ($nullable ? null : ''),<br/>            null =&gt; null<br/>        };<br/>    }</span><span id="7a62" class="mr lk iq mn b gy mw mt l mu mv">    public function supports(Request $request, ArgumentMetadata $argument): bool<br/>    {<br/>        $attrs = $argument-&gt;getAttributes(QueryParam::class);<br/>        return count($attrs) &gt; 0;<br/>    }</span><span id="f450" class="mr lk iq mn b gy mw mt l mu mv">    public function setLogger(LoggerInterface $logger)<br/>    {<br/>        $this-&gt;logger = $logger;<br/>    }<br/>}</span></pre><p id="637b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行时，调用<code class="fe my mz na mn b">supports</code>函数检查当前请求是否满足要求，如果满足，则调用<code class="fe my mz na mn b">resovle</code>函数。</p><p id="ca49" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe my mz na mn b">supports</code>函数中，我们检查参数是否用<code class="fe my mz na mn b">QueryParam</code>标注，如果存在，则从请求查询字符串中解析参数。</p><p id="f385" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在将服务于<em class="mx">/post</em>端点的函数改为如下。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="c6da" class="mr lk iq mn b gy ms mt l mu mv">#[Route(path: "", name: "all", methods: ["GET"])]<br/>function all(#[QueryParam] $keyword,<br/>    #[QueryParam] int $offset = 0,<br/>    #[QueryParam] int $limit = 20): Response<br/>    {<br/>        $data = $this-&gt;posts-&gt;findByKeyword($keyword || '', $offset, $limit);<br/>        return $this-&gt;json($data);<br/>    }</span></pre><p id="6a55" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行应用程序并使用<code class="fe my mz na mn b">curl</code>测试<em class="mx">/post</em>。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="b0f7" class="mr lk iq mn b gy ms mt l mu mv"># curl <a class="ae lb" href="http://localhost:8000/posts" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/posts</a><br/>{<br/>    "content":[<br/>    	{<br/>            "id":"1ec3e1e0-17b3-6ed2-a01c-edecc112b436",<br/>            "title":"Building Restful APIs with Symfony and PHP 8"<br/>        }<br/>    ],<br/>    "totalElements":1,<br/>    "offset":0,<br/>    "limit":20<br/>}</span></pre></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="f335" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">按ID获取帖子</h1><p id="1d6f" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">按照上一节的设计，给<code class="fe my mz na mn b">PostController</code>增加另一个功能来绘制路线<code class="fe my mz na mn b">/posts/{id}</code>。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="a883" class="mr lk iq mn b gy ms mt l mu mv">class PostController extends AbstractController<br/>{<br/>	//other functions...</span><span id="30fc" class="mr lk iq mn b gy mw mt l mu mv">    #[Route(path: "/{id}", name: "byId", methods: ["GET"])]<br/>    function getById(Uuid $id): Response<br/>    {<br/>        $data = $this-&gt;posts-&gt;findOneBy(["id" =&gt; $id]);<br/>        if ($data) {<br/>            return $this-&gt;json($data);<br/>        } else {<br/>            return $this-&gt;json(["error" =&gt; "Post was not found by id:" . $id], 404);<br/>        }<br/>    }<br/>}</span></pre><p id="581d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行应用程序，尝试访问<a class="ae lb" href="http://localhost:8000/posts/%7Bid%7D" rel="noopener ugc nofollow" target="_blank"><em class="mx">http://localhost:8000/posts/{ id }</em></a>，会抛出这样的异常。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="26b0" class="mr lk iq mn b gy ms mt l mu mv">App\Controller\PostController::getById(): Argument #1 ($id) must be of type Symfony\Component\Uid\Uuid, string given, cal<br/>led in D:\hantsylabs\symfony5-sample\rest-sample\vendor\symfony\http-kernel\HttpKernel.php on line 156</span></pre><p id="9007" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">URI中的<code class="fe my mz na mn b">id</code>是一个字符串，不能直接作为<code class="fe my mz na mn b">Uuid</code>使用。</p><p id="d0e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Symfony提供了<code class="fe my mz na mn b">ParamConverter</code>来将请求属性转换成目标类型。我们可以创建一个自定义的<code class="fe my mz na mn b">ParamConverter</code>来达到存档的目的。</p><h1 id="eea6" class="lj lk iq bd ll lm np lo lp lq nq ls lt lu nr lw lx ly ns ma mb mc nt me mf mg bi translated">自定义ParamConverter</h1><p id="f77f" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">在<em class="mx"> src/Request/ </em>文件夹下创建一个新的类<code class="fe my mz na mn b">UuidParamCovnerter</code>。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="7d45" class="mr lk iq mn b gy ms mt l mu mv">class UuidParamConverter implements ParamConverterInterface<br/>{<br/>    public function __construct(private LoggerInterface $logger)<br/>    {<br/>    }<br/></span><span id="927a" class="mr lk iq mn b gy mw mt l mu mv">    /**<br/>     * @inheritDoc<br/>     */<br/>    public function apply(Request $request, ParamConverter $configuration): bool<br/>    {</span><span id="d665" class="mr lk iq mn b gy mw mt l mu mv">        $param = $configuration-&gt;getName();</span><span id="4877" class="mr lk iq mn b gy mw mt l mu mv">        if (!$request-&gt;attributes-&gt;has($param)) {<br/>            return false;<br/>        }</span><span id="40c5" class="mr lk iq mn b gy mw mt l mu mv">        $value = $request-&gt;attributes-&gt;get($param);<br/>        $this-&gt;logger-&gt;info("parameter value:" . $value);<br/>        if (!$value &amp;&amp; $configuration-&gt;isOptional()) {<br/>            $request-&gt;attributes-&gt;set($param, null);</span><span id="829a" class="mr lk iq mn b gy mw mt l mu mv">            return true;<br/>        }</span><span id="1d9b" class="mr lk iq mn b gy mw mt l mu mv">        $data = Uuid::fromString($value);<br/>        $request-&gt;attributes-&gt;set($param, $data);</span><span id="2379" class="mr lk iq mn b gy mw mt l mu mv">        return true;<br/>    }</span><span id="445e" class="mr lk iq mn b gy mw mt l mu mv">    /**<br/>     * @inheritDoc<br/>     */<br/>    public function supports(ParamConverter $configuration): bool<br/>    {<br/>        $className = $configuration-&gt;getClass();<br/>        $this-&gt;logger-&gt;info("converting to UUID :{c}", ["c" =&gt; $className]);<br/>        return $className &amp;&amp; $className == Uuid::class;<br/>    }<br/>}</span></pre><p id="60e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上述代码中，</p><ul class=""><li id="8312" class="nb nc iq jp b jq jr ju jv jy nd kc ne kg nf kk ng nh ni nj bi translated"><code class="fe my mz na mn b">supports</code>功能检查执行环境是否符合要求</li><li id="de89" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated">执行转换的<code class="fe my mz na mn b">apply</code>功能。如果<code class="fe my mz na mn b">supports</code>返回false，将跳过该转换步骤。</li></ul></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="e2ce" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">创建帖子</h1><p id="2fb3" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">遵循REST约定，定义以下规则来服务一个端点来处理请求。</p><ul class=""><li id="e7f6" class="nb nc iq jp b jq jr ju jv jy nd kc ne kg nf kk ng nh ni nj bi translated">请求匹配Http动词/HTTP方法:<code class="fe my mz na mn b">POST</code></li><li id="17c6" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated">请求匹配路由端点:<em class="mx">/发布</em></li><li id="f4e1" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated">将请求头<code class="fe my mz na mn b">Content-Type</code>值设置为<em class="mx">应用程序/json </em>，并使用请求体以json格式保存请求数据</li><li id="1948" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated">如果成功，返回一个<code class="fe my mz na mn b">CREATED</code> (201) Http状态码，并将响应头<em class="mx">位置</em>值设置为新创建的帖子的URI。</li></ul><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="bee2" class="mr lk iq mn b gy ms mt l mu mv">#[Route(path: "", name: "create", methods: ["POST"])]<br/>public function create(Request $request): Response<br/>{<br/>    $data = $this-&gt;serializer-&gt;deserialize($request-&gt;getContent(), CreatePostDto::class, 'json');<br/>    $entity = PostFactory::create($data-&gt;getTitle(), $data-&gt;getContent());<br/>    $this-&gt;posts-&gt;getEntityManager()-&gt;persist($entity);</span><span id="e10e" class="mr lk iq mn b gy mw mt l mu mv">    return $this-&gt;json([], 201, ["Location" =&gt; "/posts/" . $entity-&gt;getId()]);<br/>}</span></pre><p id="7cd6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe my mz na mn b">posts-&gt;getEntityManager()</code>覆盖父方法以从父类获得一个<code class="fe my mz na mn b">EntityManager</code>，你也可以直接在<code class="fe my mz na mn b">PostController</code>中注入<code class="fe my mz na mn b">ObjectManager</code>或<code class="fe my mz na mn b">EntityManagerInterface</code>来完成持久化工作。教条<code class="fe my mz na mn b">Repository</code>主要用于建立查询标准和执行定制查询。</p><p id="f103" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe my mz na mn b">PostControllerTest</code>文件中创建一个测试函数进行验证。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="b2f8" class="mr lk iq mn b gy ms mt l mu mv">public function testCreatePost(): void<br/>{<br/>    $client = static::createClient();<br/>    $data = CreatePostDto::of("test title", "test content");<br/>    $crawler = $client-&gt;request(<br/>        'POST',<br/>        '/posts',<br/>        [],<br/>        [],<br/>        [],<br/>        $this-&gt;getContainer()-&gt;get('serializer')-&gt;serialize($data, 'json')<br/>    );</span><span id="1c3c" class="mr lk iq mn b gy mw mt l mu mv">    $this-&gt;assertResponseIsSuccessful();</span><span id="3ecc" class="mr lk iq mn b gy mw mt l mu mv">    $response = $client-&gt;getResponse();<br/>    $url = $response-&gt;headers-&gt;get('Location');<br/>    //dump($data);<br/>    $this-&gt;assertNotNull($url);<br/>    $this-&gt;assertStringStartsWith("/posts/", $url);<br/>}</span></pre><h1 id="43a3" class="lj lk iq bd ll lm np lo lp lq nq ls lt lu nr lw lx ly ns ma mb mc nt me mf mg bi translated">转换请求正文</h1><p id="1b60" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">我们还可以使用注释/属性，通过引入自定义的<code class="fe my mz na mn b">ArgumentResolver</code>来删除处理<code class="fe my mz na mn b">Request</code>对象的原始代码。</p><p id="afd0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个<code class="fe my mz na mn b">Body</code> <em class="mx">属性</em>。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="779d" class="mr lk iq mn b gy ms mt l mu mv">#[Attribute(Attribute::TARGET_PARAMETER)]<br/>final class Body<br/>{<br/>}</span></pre><p id="68a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后创建一个<code class="fe my mz na mn b">BodyValueResolver</code>。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="69a4" class="mr lk iq mn b gy ms mt l mu mv">class BodyValueResolver implements ArgumentValueResolverInterface, LoggerAwareInterface<br/>{<br/>    public function __construct(private SerializerInterface $serializer)<br/>    {<br/>    }</span><span id="6e01" class="mr lk iq mn b gy mw mt l mu mv">    private LoggerInterface $logger;</span><span id="0a56" class="mr lk iq mn b gy mw mt l mu mv">    /**<br/>     * @inheritDoc<br/>     */<br/>    public function resolve(Request $request, ArgumentMetadata $argument)<br/>    {<br/>        $type = $argument-&gt;getType();<br/>        $this-&gt;logger-&gt;debug("The argument type:'" . $type . "'");<br/>        $format = $request-&gt;getContentType() ?? 'json';<br/>        $this-&gt;logger-&gt;debug("The request format:'" . $format . "'");</span><span id="2fe3" class="mr lk iq mn b gy mw mt l mu mv">        //read request body<br/>        $content = $request-&gt;getContent();<br/>        $data = $this-&gt;serializer-&gt;deserialize($content, $type, $format);<br/>       // $this-&gt;logger-&gt;debug("deserialized data:{0}", [$data]);<br/>        yield $data;<br/>    }</span><span id="5793" class="mr lk iq mn b gy mw mt l mu mv">    /**<br/>     * @inheritDoc<br/>     */<br/>    public function supports(Request $request, ArgumentMetadata $argument): bool<br/>    {<br/>        $attrs = $argument-&gt;getAttributes(Body::class);<br/>        return count($attrs) &gt; 0;<br/>    }</span><span id="678b" class="mr lk iq mn b gy mw mt l mu mv">    public function setLogger(LoggerInterface $logger)<br/>    {<br/>        $this-&gt;logger = $logger;<br/>    }</span></pre><p id="1852" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe my mz na mn b">supports</code>方法中，它只是检测方法参数是否用<code class="fe my mz na mn b">Body</code>属性进行了注释，然后应用<code class="fe my mz na mn b">resolve</code>方法将请求体内容反序列化为类型化对象。</p><p id="3895" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行应用程序并通过<em class="mx">/post</em>测试端点。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="884c" class="mr lk iq mn b gy ms mt l mu mv">curl -v <a class="ae lb" href="http://localhost:8000/posts" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/posts</a> -H "Content-Type:application/json" -d "{\"title\":\"test title\",\"content\":\"test content\"}"<br/>&gt; POST /posts HTTP/1.1<br/>&gt; Host: localhost:8000<br/>&gt; User-Agent: curl/7.55.1<br/>&gt; Accept: */*<br/>&gt; Content-Type:application/json<br/>&gt; Content-Length: 47<br/>&gt;<br/>&lt; HTTP/1.1 201 Created<br/>&lt; Cache-Control: no-cache, private<br/>&lt; Content-Type: application/json<br/>&lt; Date: Sun, 21 Nov 2021 08:42:49 GMT<br/>&lt; Location: /posts/1ec4aa70-1b21-6bce-93f8-b39330fe328e<br/>&lt; X-Powered-By: PHP/8.0.10<br/>&lt; X-Robots-Tag: noindex<br/>&lt; Content-Length: 2<br/>&lt;<br/>[]</span></pre></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="99f2" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">异常处理</h1><p id="4c53" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">Symfony内核提供了一个事件机制来在<code class="fe my mz na mn b">Controller</code>类中引发一个<code class="fe my mz na mn b">Exception</code>，并在你的自定义<code class="fe my mz na mn b">EventListener</code>或<code class="fe my mz na mn b">EventSubscriber</code>中处理它们。</p><p id="e342" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，创建一个<code class="fe my mz na mn b">PostNotFoundException</code>。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="e234" class="mr lk iq mn b gy ms mt l mu mv">class PostNotFoundException extends \RuntimeException<br/>{</span><span id="d1dd" class="mr lk iq mn b gy mw mt l mu mv">    public function __construct(Uuid $uuid)<br/>    {<br/>        parent::__construct("Post #" . $uuid . " was not found");<br/>    }</span><span id="2887" class="mr lk iq mn b gy mw mt l mu mv">}</span></pre><p id="cfdf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个EventListener来捕获该异常，并按预期处理该异常。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="e9fb" class="mr lk iq mn b gy ms mt l mu mv">class ExceptionListener implements LoggerAwareInterface<br/>{<br/>    private LoggerInterface $logger;</span><span id="595a" class="mr lk iq mn b gy mw mt l mu mv">    public function __construct()<br/>    {<br/>    }</span><span id="62f2" class="mr lk iq mn b gy mw mt l mu mv">    public function onKernelException(ExceptionEvent $event)<br/>    {<br/>        // You get the exception object from the received event<br/>        $exception = $event-&gt;getThrowable();<br/>        $data = ["error" =&gt; $exception-&gt;getMessage()];</span><span id="0352" class="mr lk iq mn b gy mw mt l mu mv">        // Customize your response object to display the exception details<br/>        $response = new JsonResponse($data);</span><span id="7db9" class="mr lk iq mn b gy mw mt l mu mv">        // HttpExceptionInterface is a special type of exception that<br/>        // holds status code and header details</span><span id="88e4" class="mr lk iq mn b gy mw mt l mu mv">        if ($exception instanceof PostNotFoundException) {<br/>            $response-&gt;setStatusCode(Response::HTTP_NOT_FOUND);<br/>        } else if ($exception instanceof HttpExceptionInterface) {<br/>            $response-&gt;setStatusCode($exception-&gt;getStatusCode());<br/>            $response-&gt;headers-&gt;replace($exception-&gt;getHeaders());<br/>        } else {<br/>            $response-&gt;setStatusCode(Response::HTTP_INTERNAL_SERVER_ERROR);<br/>        }</span><span id="4aa7" class="mr lk iq mn b gy mw mt l mu mv">        // sends the modified response object to the event<br/>        $event-&gt;setResponse($response);<br/>    }</span><span id="5d60" class="mr lk iq mn b gy mw mt l mu mv">    public function setLogger(LoggerInterface $logger)<br/>    {<br/>        $this-&gt;logger = $logger;<br/>    }<br/>}</span></pre><p id="4cd5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将此<code class="fe my mz na mn b">ExceptionListener</code>注册到<em class="mx"> config/service.yml </em>文件中。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="3cf7" class="mr lk iq mn b gy ms mt l mu mv">App\EventListener\ExceptionListener:<br/>    tags:<br/>      - { name: kernel.event_listener, event: kernel.exception, priority: 50 }</span></pre><p id="4ccb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">表示将<code class="fe my mz na mn b">event.exception</code>事件绑定到<code class="fe my mz na mn b">ExceptionListener</code>，并设置<code class="fe my mz na mn b">priority</code>来设置执行时的顺序。</p><p id="9524" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行以下命令显示事件<em class="mx">内核上所有注册的<code class="fe my mz na mn b">EventListener</code> / <code class="fe my mz na mn b">EventSubscriber</code>。</em></p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="bda9" class="mr lk iq mn b gy ms mt l mu mv">php bin/console debug:event-subscriber kernel.exception</span></pre><p id="d58e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将<code class="fe my mz na mn b">getById</code>功能更改如下。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="eb30" class="mr lk iq mn b gy ms mt l mu mv">#[Route(path: "/{id}", name: "byId", methods: ["GET"])]<br/>function getById(Uuid $id): Response<br/>{<br/>    $data = $this-&gt;posts-&gt;findOneBy(["id" =&gt; $id]);<br/>    if ($data) {<br/>   		return $this-&gt;json($data);<br/>    } else {<br/>    	throw new PostNotFoundException($id);<br/>    }<br/>}</span></pre><p id="af2e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">添加一个测试来验证是否没有找到post并获得404状态代码。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="6a60" class="mr lk iq mn b gy ms mt l mu mv">public function testGetANoneExistingPost(): void<br/>{<br/>    $client = static::createClient();<br/>    $id = Uuid::v4();<br/>    $crawler = $client-&gt;request('GET', '/posts/' . $id);</span><span id="24e6" class="mr lk iq mn b gy mw mt l mu mv">    //<br/>    $response = $client-&gt;getResponse();<br/>    $this-&gt;assertResponseStatusCodeSame(404);<br/>    $data = $response-&gt;getContent();<br/>    $this-&gt;assertStringContainsString("Post #" . $id . " was not found", $data);<br/>}</span></pre><p id="f084" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">再次运行应用程序，并尝试通过一个不存在的id访问一篇文章。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="4506" class="mr lk iq mn b gy ms mt l mu mv">curl <a class="ae lb" href="http://localhost:8000/posts/1ec3e1e0-17b3-6ed2-a01c-edecc112b438" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/posts/1ec3e1e0-17b3-6ed2-a01c-edecc112b438</a> -H "Accept: application/json" -v<br/>&gt; GET /posts/1ec3e1e0-17b3-6ed2-a01c-edecc112b438 HTTP/1.1<br/>&gt; Host: localhost:8000<br/>&gt; User-Agent: curl/7.55.1<br/>&gt; Accept: application/json<br/>&gt;<br/>&lt; HTTP/1.1 404 Not Found<br/>&lt; Cache-Control: no-cache, private<br/>&lt; Content-Type: application/json<br/>&lt; Date: Mon, 22 Nov 2021 03:57:51 GMT<br/>&lt; X-Powered-By: PHP/8.0.10<br/>&lt; X-Robots-Tag: noindex<br/>&lt; Content-Length: 69<br/>&lt;<br/>{"error":"Post #1ec3e1e0-17b3-6ed2-a01c-edecc112b438 was not found."}</span></pre><h2 id="a881" class="mr lk iq bd ll oa ob dn lp oc od dp lt jy oe of lx kc og oh mb kg oi oj mf ok bi translated">从我的Github获取<a class="ae lb" href="https://github.com/hantsy/symfony5-sample/tree/master/rest-sample" rel="noopener ugc nofollow" target="_blank">完整的源代码</a>。</h2></div></div>    
</body>
</html>