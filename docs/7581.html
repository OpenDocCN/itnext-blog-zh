<html>
<head>
<title>Snowflake Scripting: load a million rows table to table</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">雪花脚本:从一个表到另一个表加载一百万行</h1>
<blockquote>原文：<a href="https://itnext.io/snowflake-scripting-load-a-million-rows-table-to-table-b24d7621fbff?source=collection_archive---------1-----------------------#2022-11-14">https://itnext.io/snowflake-scripting-load-a-million-rows-table-to-table-b24d7621fbff?source=collection_archive---------1-----------------------#2022-11-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="75d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">了解如何以最佳方式在表中插入多行。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/a5a683975d2d15935aa3f7f31cf680d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qZpCgNmezGUY446592L4pw.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">罗伯特·卡茨基在<a class="ae lb" href="https://unsplash.com/s/photos/million-color?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="1a20" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">雪花正在以令人难以置信的低成本接管数据仓库领域，提供大量出色的产品和功能。</p><p id="325c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">雪花以两种方式帮助组织，</p><ol class=""><li id="beed" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">支持和提升创新。</li><li id="a9c5" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">抑制技术债务和复杂性。</li></ol><p id="1e27" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Snowflake拥有精致的特性，令人瞩目，另一方面，文档则是另一个争论的话题。</p><p id="3f37" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">存储过程是SQL世界中众所周知的怪兽，也是雪花提供的众多特性之一。雪花中的存储过程可以通过大量的编程语言来开发。</p><p id="afd5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本帖中，我们将看看如何使用雪花脚本优化地将一百万个修改过的行写入一个新表。</p><p id="f254" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一种称为雪花脚本的语言特性使您能够用普通SQL创建通用脚本和存储过程。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi lq"><img src="../Images/d2523b36ec5e2315de330300dc52773d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/format:webp/1*lOwG5l1JH3EO_sKSznRbYw.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">图片由<a class="ae lb" href="https://www.linkedin.com/in/jayachandra-sekhar-reddy/" rel="noopener ugc nofollow" target="_blank">作者</a></figcaption></figure><p id="d0cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">设置所需的占位符:</strong></p><ol class=""><li id="a2e8" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">创建表格</li></ol><p id="6549" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们构建两个示例表，因为数据库表是所有SQL操作的基础。</p><pre class="km kn ko kp gt lr ls lt bn lu lv bi"><span id="592f" class="lw lx iq ls b be ly lz l ma mb">create or replace table snowflake_insert_main(col1 varchar, col2 number(30,0), col3 varchar);<br/>create or replace table snowflake_insert_transformed(col1 varchar);</span></pre><p id="ea6d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在表格已经准备好了，让我们添加一些数据。</p><pre class="km kn ko kp gt lr ls lt bn lu lv bi"><span id="2b9f" class="lw lx iq ls b be ly lz l ma mb">insert into snowflake_insert_main(col1) values ('Jay_Test', 5 , 'New_Val' ), ('Medium_Test', 8, 'New_Val1');</span></pre><p id="2d1d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最直接、最流行的策略是这个insert然而，即使它很简单，当涉及大量插入时，它就变得复杂了。这同样适用于在表之间输入数据。</p><pre class="km kn ko kp gt lr ls lt bn lu lv bi"><span id="529b" class="lw lx iq ls b be ly lz l ma mb">insert into snowflake_insert_transformed(col1) select col1 from snowflake_insert_main;</span></pre><p id="1a61" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个insert语句将把源表中每一行的值插入到目标表的一列中。</p><p id="5b81" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将启动对雪花集群的插入请求，它将等待操作完成后再开始下一次插入。</p><p id="6b73" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当处理大量数据时，这一过程变得开销大且耗时。</p></div><div class="ab cl mc md hu me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ij ik il im in"><p id="d3d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当存在大量行时，读取、转换和写入将花费很长时间。为了手动选择要修改和加载的列，雪花有一个for循环。</p><pre class="km kn ko kp gt lr ls lt bn lu lv bi"><span id="48c6" class="lw lx iq ls b be ly lz l ma mb">BEGIN<br/>  LET res RESULTSET := (select top 2 col1 from snowflake_insert_main);<br/>  LET cur CURSOR for res;<br/>      for row_variable IN cur DO<br/>          LET my_table_value STRING := row_variable."col1";<br/>          INSERT INTO snowflake_insert_transformed(col1) VALUES (:my_table_value);<br/>      end for;<br/>  END</span></pre><p id="52b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个循环给了操作者更多的控制，但是当处理数百万条记录时，这种推理就变得过度了。</p><p id="3ff3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这背后的基本原理是保留一个临时数据容器，将其展平，然后写入目标表。</p><p id="90e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在写之前，让我们利用一个数组来存储更改后的数据。</p><pre class="km kn ko kp gt lr ls lt bn lu lv bi"><span id="efe4" class="lw lx iq ls b be ly lz l ma mb">DECLARE<br/>  tmp_array ARRAY default ARRAY_CONSTRUCT();<br/>  rs_output RESULTSET;<br/>BEGIN<br/>  LET res RESULTSET := (select top 2 substr(col1, -4) from snowflake_insert_main);<br/>  LET cur CURSOR for res;<br/>      for row_variable IN cur DO<br/>          LET my_table_value STRING := row_variable."col1";<br/>          INSERT INTO snowflake_insert_transformed(col1) VALUES (:my_table_value);<br/>      end for;<br/>  END</span></pre><p id="f920" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的摘录显示了我们如何在加载之前转换结果集，并且只选择了字符串的最后四个字符。</p><p id="c4fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">解决这个问题的方法是将100K行的加载时间减少一半，从6000秒减少到大约120秒。</p><p id="d65f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后一个选项是使用我们的数组构造将数组展平成一个新表，然后选择所需的值，在单个集群调用中创建一个新表。</p><p id="eefd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">完整代码:</strong></p><pre class="km kn ko kp gt lr ls lt bn lu lv bi"><span id="b225" class="lw lx iq ls b be ly lz l ma mb">CREATE OR REPLACE PROCEDURE multi_insert_prod(my_val number(38,0))<br/>RETURNS varchar<br/>LANGUAGE SQL<br/>EXECUTE AS CALLER<br/>AS '<br/>  DECLARE<br/>  tmp_array ARRAY default ARRAY_CONSTRUCT();<br/>  rs_output RESULTSET;<br/><br/>  BEGIN<br/>  LET res RESULTSET := (select top 1000000 substr(col1, -4) from snowflake_insert_main);<br/>  LET cur CURSOR for res;<br/>      for row_variable IN cur DO<br/>          let my_table_value STRING := row_variable."col1";<br/>          tmp_array := ARRAY_APPEND(:tmp_array, my_table_value);<br/>      end for;<br/>  rs_output := (CREATE or REPLACE TABLE <br/>                  my_database.my_schema.snowflake_insert_transformed(col1) <br/>                  AS SELECT VALUE FROM TABLE(FLATTEN(:tmp_array));<br/>  RETURN rs_output;<br/>  END<br/>';</span></pre><h2 id="a373" class="mj lx iq bd mk ml mm dn mn mo mp dp mq jy mr ms mt kc mu mv mw kg mx my mz na bi translated"><strong class="ak">结论:</strong></h2><p id="4e81" class="pw-post-body-paragraph jn jo iq jp b jq nb js jt ju nc jw jx jy nd ka kb kc ne ke kf kg nf ki kj kk ij bi translated">由于它让开发人员和工程师能够更好地控制只使用SQL的存储过程，雪花脚本是雪花最新特性列表中的一个新特性，正迅速受到欢迎。</p><p id="51a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章的重点是通过向数据分析师和工程师展示精彩的雪花功能来改善他们的思维过程，这些功能允许他们尽可能有效地执行表与表之间的批量加载，而雪花并没有默认提供这些功能。</p><p id="811f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望这篇文章能让开发者的职责和障碍变得更容易。</p><p id="0816" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">快乐学习…..😀😀</p><p id="f996" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关注我了解更多信息:</p><p id="a3dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">【https://www.linkedin.com/in/jayachandra-sekhar-reddy/ T4】</p><p id="5af3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lb" href="https://twitter.com/ReddyJaySekhar" rel="noopener ugc nofollow" target="_blank">https://twitter.com/ReddyJaySekhar</a></p></div></div>    
</body>
</html>