<html>
<head>
<title>C# code quality tooling with Roslyn, Resharper and NDepend</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Roslyn、Resharper和NDepend的C#代码质量工具</h1>
<blockquote>原文：<a href="https://itnext.io/c-code-quality-tooling-with-roslyn-resharper-and-ndepend-a4fd4540724c?source=collection_archive---------3-----------------------#2022-02-21">https://itnext.io/c-code-quality-tooling-with-roslyn-resharper-and-ndepend-a4fd4540724c?source=collection_archive---------3-----------------------#2022-02-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="c974" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最近，我正在研究(自动化)代码质量工具的一些选项，包括代码度量、依赖图和自我强加的编码风格。为了有一个可维护的、可伸缩的和整洁的解决方案，这些是需要跟踪的非常重要的方面。</p><p id="bcf8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本文中，我将重点介绍三种方法，从简单到复杂。</p></div><div class="ab cl ko kp hx kq" role="separator"><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt"/></div><div class="im in io ip iq"><h1 id="f6cc" class="kv kw it bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">本地与方法</h1><p id="0d37" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">先说简单的。如果你只是想在你的代码中添加一些基本的警告，最容易接近和最简单的方法是在你的代码中，而不是在出现错误和警告时允许大量的定制。最基本的方法是在代码中添加一个<em class="ly"> #warning </em>指令<em class="ly"> </em>，或者滥用<em class="ly">【过时】</em>属性，这是一个编译器支持的属性，用于生成特殊的警告。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="1429" class="mi kw it me b gy mj mk l ml mm">#warning Warn me about this<br/>DoSomething();</span><span id="b205" class="mi kw it me b gy mn mk l ml mm">[Obsolete("Warning two")]<br/>static void DoSomething(){ }</span></pre><p id="c268" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这段代码将像这样出现在警告和错误视图中。</p><figure class="lz ma mb mc gt mp gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/81ab264045b349f7785bc97887a8315d.png" data-original-src="https://miro.medium.com/v2/resize:fit:686/format:webp/1*P-WqQI8T5h_VHXi7ValolQ.png"/></div></figure><p id="8766" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">正如您所看到的，这是相当笨拙和具体的，但它可能足以到达您想要的地方。请注意，您还可以对。csproj文件，见各自属性<a class="ae ms" href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/compiler-options/errors-warnings" rel="noopener ugc nofollow" target="_blank">此处</a>。</p><p id="e235" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">确保编码指南的另一个创造性和简单的想法是通过反射和单元测试。假设您希望确保程序集X不包含对特定其他程序集的引用。</p><p id="6533" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为此，您可以编写一个简单的单元测试来加载程序集，并检查其中的引用程序集。如果您检测到无效的引用，您的测试将会失败，并且不允许代码更改。</p><p id="25d9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">以类似的方式，您也可以检查属性/方法/字段等的命名。通过反射，确保命名标准。</p><p id="3e9f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这些都是一些简单但足够好的想法，告诉你如何用最少的努力完成一些基本的检查。</p><h1 id="dc81" class="kv kw it bd kx ky mt la lb lc mu le lf lg mv li lj lk mw lm ln lo mx lq lr ls bi translated">源分析器</h1><p id="8001" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">经过这个小小的迂回之后，现在让我们进入适当的工具。如果除了默认的可用警告和错误之外，您还想要自定义触发器的警告和错误，比方说，对于您运行的团队特定的编码标准，您可能想要编写一个自定义roslyn分析器来检测它。</p><p id="d63b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你最近因为非常流行的源生成器而遇到Roslyn——Roslyn已经存在很长时间了，分析器正在通过与源生成器非常相似的流程运行。</p><p id="1fa7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您的分析器将在编译期间运行，并且能够分析语法树。参见下面的例子(<a class="ae ms" href="https://sharplab.io/#v2:EYLgtghglgdgNAFxBAzggPgAQMwAJMBMuAwrgN4CwAULrfnpgCy4CyAFAJTnV2+6wJcEXAF5cAVgDcPPrSgAzXG2Eix4rpgCMAOi0BONgCJxhjtJqzcM2QqUq1Ha30oXLdLbs0HjpyXSe8AL5OwVSBQA" rel="noopener ugc nofollow" target="_blank"> Sharplab link </a>):</p><figure class="lz ma mb mc gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi my"><img src="../Images/6bddf00a6307d1d6b6d1275d6d1764e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HfjLDJiDcATCf2ftgGLlsw.png"/></div></div></figure><p id="cf18" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如您所见，Roslyn语法树能够确定这两个语句中哪个包含大括号，哪个不包含。这将是一个潜在的警告，您可以为您的构建工具创建该警告，以获取并拒绝合并请求。</p><p id="222a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">罗斯林分析器真正的优点是，它们将与VS集成，甚至允许添加建议来修复各自的触发器。</p><p id="0124" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你也可以在这里找到一个关于如何实现分析器<a class="ae ms" href="https://devblogs.microsoft.com/dotnet/how-to-write-a-roslyn-analyzer/" rel="noopener ugc nofollow" target="_blank">的很棒的教程。</a></p><p id="a50e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，有一些很棒的开源项目已经提供了大量的通用分析器，比如<a class="ae ms" href="https://github.com/DotNetAnalyzers/StyleCopAnalyzers" rel="noopener ugc nofollow" target="_blank"> StyleCop </a>，所以你不一定要自己实现。</p></div><div class="ab cl ko kp hx kq" role="separator"><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt"/></div><div class="im in io ip iq"><h1 id="e7ef" class="kv kw it bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">雷沙尔珀</h1><p id="cfa7" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">这是我们使用第三方工具的地方。Resharper是一个非常流行的Visual Studio扩展，它向各个方向添加了功能。说到用C#开发，基本就是瑞士军刀了。</p><p id="0fdf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当谈到代码质量时，Resharper添加了许多可配置的警告，旨在支持开发人员跟上行业编码标准，并通过扩展将这些警告添加为自定义警告。它<strong class="js iu">不</strong>使用罗斯林分析器，而是通过自己的进程和观察器来分析代码。</p><p id="0044" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在选项中，我们可以根据严重性和应用程序配置大量的检查，以便根据开发人员的需求进行定制。</p><figure class="lz ma mb mc gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi nd"><img src="../Images/5e2c67f8847b66a0a65cacd8dabe4602.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1VlHlfX6zjxvFKQATqYNYA.png"/></div></div></figure><p id="4767" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae ms" href="https://www.jetbrains.com/help/resharper/Code_Inspection__Creating_Custom_Inspections_and_QuickFixes.html" rel="noopener ugc nofollow" target="_blank">添加自定义分析器</a>也非常容易。</p><p id="718e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另一个需要特别注意的主题是处理项目之间的引用。如果您正在处理一个超过50个项目的解决方案，您知道它们之间的引用可能会很快失去控制。Visual Studio也提供了一些简洁的工具来帮助您。</p><p id="9c07" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您右键单击一个项目，您会发现下面的菜单点稍微靠下一些</p><figure class="lz ma mb mc gt mp gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/c4b2c19636052db5889cc3a05f333597.png" data-original-src="https://miro.medium.com/v2/resize:fit:706/format:webp/1*7kN3gAO7SB1OZdBCyJI7Dw.png"/></div></figure><ul class=""><li id="45f5" class="nf ng it js b jt ju jx jy kb nh kf ni kj nj kn nk nl nm nn bi translated">查找依赖代码:这将从所有其他项目中查找对这个项目的引用。</li><li id="9e5a" class="nf ng it js b jt no jx np kb nq kf nr kj ns kn nk nl nm nn bi translated">显示类型依赖关系图:这将显示项目中类型的依赖关系。</li><li id="06a5" class="nf ng it js b jt no jx np kb nq kf nr kj ns kn nk nl nm nn bi translated">显示项目依赖关系图:这将向您显示一个惊人的图，图中有解决方案中所有项目之间的参考箭头。重构更大代码库的天赐良机。</li><li id="5390" class="nf ng it js b jt no jx np kb nq kf nr kj ns kn nk nl nm nn bi translated">显示项目层次结构:这将为您提供解决方案中程序集之间的文本表示。</li></ul><p id="1a48" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果我要涵盖Resharper的各个方面，我可能需要多篇文章来完成，但它是每个开发人员都应该拥有的一个神奇的工具。可以肯定地说，虽然代码分析不是Resharper带来的主要东西，但它仍然提供了大量有用的工具。它通过惊人的重构和代码编辑工具大放异彩，专注于开发人员的生产力。</p><p id="579e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">不过，使用Resharper是有代价的，还需要在您的构建机器上运行Resharper analyzer，因为它运行在一个专用的进程上，而这个进程并没有与MSBuild嵌入式工具集成。</p></div><div class="ab cl ko kp hx kq" role="separator"><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt"/></div><div class="im in io ip iq"><h1 id="1298" class="kv kw it bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">NDepend</h1><p id="ff40" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">是时候拿出大枪了。如果您希望尽可能提高代码质量，NDepend是C#解决方案的最佳选择。虽然Resharper是一把非常全面的瑞士军刀，但NDepend纯粹专注于为您提供最详细的代码质量分析。</p><p id="f049" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">NDepend可作为独立产品和IDE集成产品提供。说实话，在我的评估中，我主要看了一下独立的应用程序。</p><p id="2ed2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我惊讶地发现，获得我所分析的应用程序的洞察力是如此容易。基本上，您所要做的就是获得NDepend，选择一个解决方案进行分析，并让NDepend在短时间内完成它的工作。</p><p id="c5f5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">分析完您的解决方案后，NDepend将为您提供一个html文件摘要，其中包含您的应用程序分析:</p><figure class="lz ma mb mc gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi nt"><img src="../Images/bda427c1b92fc8632f9b782dd0ee3182.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SdJ8NhqNOcrqFLJ9kX4yNg.png"/></div></div></figure><p id="b813" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这包含了许多有趣的度量标准的快速概述，例如，代码行、解决方案中的类型，或者仅仅是从各种度量标准中浓缩的质量的一般评估。它还会根据一些最佳实践向您显示您的解决方案中违反的规则的摘要。</p><p id="8311" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个独立的应用程序感觉像是Visual Studio(它包括许多已知的组件，如类浏览器等)和一个大型分析平台的混合体。</p><figure class="lz ma mb mc gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi nu"><img src="../Images/f12d9e0cacc29e030b075cdc1ea14122.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vWPe4_kT_CMi-VWFKt2hFg.png"/></div></div></figure><p id="11c5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">除了熟悉Resharper依赖图之外，真正给我留下深刻印象的是NDepend中依赖图的详细程度。看一下上面的截图——在常规的引用连接之上，您可以一路向下钻取，从项目到类，一直到方法。它非常详细，可以让你从申请的每个方面获得尽可能多的信息。</p><p id="1305" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">除了这个图，您还可以获得一个基于表格的依赖矩阵。</p><figure class="lz ma mb mc gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi nv"><img src="../Images/8ab9cc82f54518e082b6be52c8693ac6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fRBN_qebfWXCDd_JDgk3jA.png"/></div></div></figure><p id="4ce2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下一个可用视图是一个类似热图的度量图，它可以让您快速了解应用程序的哪些组件在复杂性、注释覆盖率、方法数量等方面表现最好和最差。</p><p id="74c4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">NDepend还让您可以快速查看每个项目的纯引用数量，包括NuGet包和项目引用，所有这些都可以在一个非常简洁的视图中获得(当然，它比针对所有解决方案的VS-embedded NuGet概述要快<strong class="js iu">很多</strong>)。</p><p id="9fac" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">视觉图表到此为止。NDepend还会给你一个代码度量列表，你的代码可能会通过或者失败，并标记出相应的程序集或者类型，让你可以快速的查看哪里出了问题。一个非常漂亮的功能是CQLinq，这是一个独立的集成的类似Linq的语言，用于查询技术债务、问题、规则或其他东西，允许你轻松地定制视图、过滤组件等。如果我想创建一个查询，提供所有违反和关键规则的名称和问题，您可以相应地编写(并保存和共享)如下内容:</p><figure class="lz ma mb mc gt mp gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/4fc155c5d68079977f523da5e0bf9885.png" data-original-src="https://miro.medium.com/v2/resize:fit:1246/format:webp/1*dzgjwx1Mul7_4P-GzaE5SQ.png"/></div></figure><p id="8ad0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">太好了，这让C#开发人员感觉很熟悉！</p><p id="e0be" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当然，NDepend也允许添加可定制的指标，但是可以肯定地说，默认可用的指标已经非常全面了。</p><p id="a5ea" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">总而言之，我希望我至少能够让您对NDepend的能力有一点粗浅的了解。它包含了<strong class="js iu">所以</strong> <strong class="js iu">多了许多</strong>强大的功能，我几乎无法一一介绍。我只能建议你尝试一下，亲自看看你能多快掌握你以前不知道的应用洞察。</p><p id="a05e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">NDepend在我看来是终极的C#分析工具。当然，您也可以在较小的团队中使用它，虽然它也有许可成本，但是您也可以使用单个构建服务器许可证来运行，以便将NDepend分析集成到您的自动化构建中。我可以想象，如果您有机会让专门的架构师为您的应用程序观察和定制可靠的指标，这将是非常棒的。</p><p id="ad95" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">与Resharper相比，NDepend剥离了开发人员生产力工具，而是明显地专注于深入和有洞察力的代码分析。因此，当谈到什么值得使用时，这不是一个非此即彼的问题，而是一个“两者兼有”的问题。</p><p id="6eda" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是我今天想提出的三个选择。我希望我能给你一些灵感或者对一些你可能还不知道的工具有所了解。如果你想尝试一些工具，大多数还会提供试用时间，所以你可以免费试用。如果你想去纯粹的自由选择，罗斯林是一个很好的和可靠的选择。</p></div></div>    
</body>
</html>