<html>
<head>
<title>Build Kubernetes clusters using Sidero Metal &amp; Talos Linux on Raspberry Pi</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Raspberry Pi上使用Sidero Metal和Talos Linux构建Kubernetes集群</h1>
<blockquote>原文：<a href="https://itnext.io/build-kubernetes-clusters-using-sidero-metal-talos-linux-on-raspberry-pi-54a9961a7d4c?source=collection_archive---------6-----------------------#2022-02-27">https://itnext.io/build-kubernetes-clusters-using-sidero-metal-talos-linux-on-raspberry-pi-54a9961a7d4c?source=collection_archive---------6-----------------------#2022-02-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="eab6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第二部分:设置控制平面Kubernetes集群</p><p id="dd8c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">合著者:安东尼·拉比托</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/dccc10e29aa5c8f17c53ce3ebf9592f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mFKVUvbNjoy_IyLgFqDO2Q.jpeg"/></div></div></figure></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="b4ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在第一部分中，我们介绍了一些高级概念和工具；如果你没有看过第一部分，请点击这里查看。</p><p id="ada5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在第二部分中，我们将介绍一些快速入门指南，介绍如何创建一个将在Talos Linux上运行并安装Sidero Metal的控制平面集群。第三部分将继续介绍如何将集群API与Sidero Metal一起使用，以声明方式提供集群并管理其生命周期。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h2 id="410a" class="lf lg iq bd lh li lj dn lk ll lm dp ln jy lo lp lq kc lr ls lt kg lu lv lw lx bi translated">先决条件</h2><ul class=""><li id="a07e" class="ly lz iq jp b jq ma ju mb jy mc kc md kg me kk mf mg mh mi bi translated"><a class="ae le" href="https://www.sidero.dev/docs/v0.5/getting-started/prereq-cli-tools/" rel="noopener ugc nofollow" target="_blank"> CLI工具</a></li><li id="7281" class="ly lz iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated"><a class="ae le" href="https://www.sidero.dev/docs/v0.5/getting-started/prereq-kubernetes/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a></li><li id="f661" class="ly lz iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated"><a class="ae le" href="https://www.sidero.dev/docs/v0.5/getting-started/prereq-dhcp/" rel="noopener ugc nofollow" target="_blank"> DHCP服务</a></li></ul><h2 id="ac88" class="lf lg iq bd lh li lj dn lk ll lm dp ln jy lo lp lq kc lr ls lt kg lu lv lw lx bi translated">设置控制平面集群</h2><p id="d8f7" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">要安装Sidero Metal，它必须先部署在Kubernetes集群中，然后才能用于提供其他Kubernetes集群。因此，有几个选项可供考虑——您可以创建Sidero Metal的docker托管实例来创建控制平面集群，然后将Sidero Metal转换为在该集群中运行；或者你也可以用Talos Linux在裸机上手动部署你的控制平面集群，部署Sidero Metal ( <a class="ae le" href="https://www.sidero.dev/docs/v0.5/guides/sidero-on-rpi4" rel="noopener ugc nofollow" target="_blank">推荐</a>)。</p><p id="3d77" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您选择按照推荐的方法在裸机上安装Talos，可以使用以下指南；<a class="ae le" href="https://www.sidero.dev/docs/v0.5/guides/sidero-on-rpi4/#installing-talos" rel="noopener ugc nofollow" target="_blank">https://www . sidero . dev/docs/v 0.5/guides/sidero-on-rpi 4/# installing-talos</a></p><p id="b600" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mr">注意:在撰写本博客时，v0.5是最新版本，但是在浏览本博客时，您应该使用基于的最新文档。</em></p><h2 id="8bce" class="lf lg iq bd lh li lj dn lk ll lm dp ln jy lo lp lq kc lr ls lt kg lu lv lw lx bi translated">安装集群API和Sidero Metal</h2><p id="eb1f" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">在很大程度上安装集群API和Sidero Metal是非常简单的，但是，要让它在一些裸机上工作，可能需要注意一些小问题。例如，当使用Raspberry Pis时，我们将采取一些额外的步骤来让iPXE和Sider Metal管理这些裸机。</p><p id="6b5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，按照官方文档安装Sidero Metal，可以在这里查看:<a class="ae le" href="https://www.sidero.dev/docs/v0.5/getting-started/install-clusterapi/" rel="noopener ugc nofollow" target="_blank">https://www . Sidero . dev/docs/v 0.5/guides/Sidero-on-rpi 4/# installing-Sidero</a></p><p id="aa3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">确保安装完成后，验证Sidero Metal是否暴露，并且可以从群集外部接触到它。</p><pre class="km kn ko kp gt ms mt mu mv aw mw bi"><span id="38b9" class="lf lg iq mt b gy mx my l mz na">$ curl -I http://192.168.1.150:8081/tftp/ipxe.efi<br/>HTTP/1.1 200 OK<br/>Accept-Ranges: bytes<br/>Content-Length: 1020416<br/>Content-Type: application/octet-stream</span></pre><p id="6716" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果在对您的实例运行该命令时得到以上输出，那么<strong class="jp ir">恭喜您。</strong>尽管对那些使用树莓酱的人来说，我们还没有完全完成！</p><h2 id="7988" class="lf lg iq bd lh li lj dn lk ll lm dp ln jy lo lp lq kc lr ls lt kg lu lv lw lx bi translated">设置裸机RPi</h2><p id="60c1" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">Raspberry Pi有一些特定的引导文件夹结构，我们需要解决这些结构，以便让EEPROM引导到UEFI，然后允许RPi通过iPXE引导到Talos Lmux。</p><p id="7a36" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">【https://www.sidero.dev/docs/v0.5/guides/rpi4-as-servers/】注:这里通过他们有用的指南进一步阐述:<a class="ae le" href="https://www.sidero.dev/docs/v0.5/guides/rpi4-as-servers/" rel="noopener ugc nofollow" target="_blank"><em class="mr"/></a></p><p id="2d38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">更新EEPROM </strong></p><p id="d0b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为一次性事件，您需要使用此方法更新EEPROM<a class="ae le" href="https://www.sidero.dev/docs/v0.5/guides/rpi4-as-servers/#update-eeprom" rel="noopener ugc nofollow" target="_blank">https://www . sidero . dev/docs/v 0.5/guides/rpi 4-as-servers/# update-EEPROM</a></p><p id="f6ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">序列号</strong></p><p id="7eca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要收集每个设备的序列号，这些序列号在启动时以下列格式显示:</p><pre class="km kn ko kp gt ms mt mu mv aw mw bi"><span id="b829" class="lf lg iq mt b gy mx my l mz na">board: xxxxxx &lt;serial&gt; &lt;MAC address&gt;</span></pre><p id="c2c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">否则，如果您可以通过SSH访问RPi，您可以使用以下命令:</p><pre class="km kn ko kp gt ms mt mu mv aw mw bi"><span id="33d3" class="lf lg iq mt b gy mx my l mz na">$ cat /proc/cpuinfo | grep Serial | cut -d ' ' -f 2<br/>100000003bc47760</span></pre><p id="354a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个新目录，并在里面为你的每一个覆盆子Pi系列创建一个新文件夹。</p><p id="7094" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如。</p><pre class="km kn ko kp gt ms mt mu mv aw mw bi"><span id="2cf1" class="lf lg iq mt b gy mx my l mz na">serials/<br/>├── 1836c205<br/>├── 3e79ca27<br/>├── 56af08e4<br/>└── 8e2bc983</span></pre><p id="c61b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后把RPi UEFI写到SD卡上——可以在这里找到:<a class="ae le" href="https://github.com/pftf/RPi4/releases" rel="noopener ugc nofollow" target="_blank">https://github.com/pftf/RPi4/releases</a></p><p id="9caa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动每个RPi，并更改启动顺序，优先启动网络，然后启动硬盘。</p><p id="cf24" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在更改启动顺序后，您将在每个RPi上执行此操作。移动“RPI_EFI.fd ”,并将其放在相应的串行文件夹中。这使得RPi可以完全通过TFTP Sidero Metal上的网络服务UEFI进行无sd卡网络引导。</p><p id="81cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mr">注意:在移动RPI_EFI.fd并准备移动到下一个RPI后，确保“RPI_EFI.fd”实际上已被移动而不是被复制。这是UEFI的nvram，与RPi序列号相关。这意味着它在每个RPi中都是唯一的。因此，确保在移动到下一个RPi时该文件不存在是很重要的。</em></p><p id="3973" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完成后，您的目录结构应该如下所示:</p><pre class="km kn ko kp gt ms mt mu mv aw mw bi"><span id="2965" class="lf lg iq mt b gy mx my l mz na">serials/<br/>├── 1836c205<br/>│   └── RPI_EFI.fd<br/>├── 3e79ca27<br/>│   └── RPI_EFI.fd<br/>├── 56af08e4<br/>│   └── RPI_EFI.fd<br/>└── 8e2bc983    <br/>    └── RPI_EFI.fd</span></pre><p id="d895" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">创建赛德洛金属初始容器图像</strong></p><p id="6c37" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们可以为Sidero Metal可以使用的这些nvrams构建一个容器映像。</p><p id="f28b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将足以构建容器映像。</p><pre class="km kn ko kp gt ms mt mu mv aw mw bi"><span id="9a9c" class="lf lg iq mt b gy mx my l mz na">FROM docker.io/library/alpine:3.15.0</span><span id="b111" class="lf lg iq mt b gy nb my l mz na">COPY ./serials /serials</span><span id="b36c" class="lf lg iq mt b gy nb my l mz na">ADD https://github.com/pftf/RPi4/releases/download/v1.31/RPi4_UEFI_Firmware_v1.31.zip RPi4_UEFI_Firmware.zip</span><span id="5dd1" class="lf lg iq mt b gy nb my l mz na">RUN apk add --update --no-cache \<br/>  unzip \<br/>  &amp;&amp; mkdir /rpi4 \<br/>  &amp;&amp; mv RPi4_UEFI_Firmware.zip /rpi4/RPi4_UEFI_Firmware.zip \<br/>  &amp;&amp; cd /rpi4 \<br/>  &amp;&amp; ls \<br/>  &amp;&amp; unzip RPi4_UEFI_Firmware.zip \<br/>  &amp;&amp; rm RPi4_UEFI_Firmware.zip \<br/>  &amp;&amp; mkdir /tftp \<br/>  &amp;&amp; ls /serials | while read serial; do mkdir /tftp/$serial &amp;&amp; cp -r /rpi4/* /tftp/$serial &amp;&amp; cp -r /serials/$serial/* /tftp/$serial/; done</span></pre><p id="043d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦构建了映像，就将其推送到一个容器映像repo，如GHCR.io或docker.io。</p><p id="0d9d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">修补Sidero金属初始容器</strong></p><p id="3e3c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Sidero Metal随后可以使用它，并在init容器中复制rpi后对其进行网络引导。</p><p id="7817" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，使用以下内容创建一个patch.yaml文件:</p><pre class="km kn ko kp gt ms mt mu mv aw mw bi"><span id="49af" class="lf lg iq mt b gy mx my l mz na">spec:<br/>  template:<br/>    spec:<br/>      volumes:<br/>      - name: tftp-folder<br/>        emptyDir: {} <br/>      initContainers:<br/>      - image: ghcr.io/&lt;USER&gt;/raspberrypi4-uefi:v&lt;TAG&gt; # &lt;-- change accordingly.<br/>        imagePullPolicy: Always<br/>        name: tftp-folder-setup<br/>        command: ["cp"]<br/>        args: ["-r", "/tftp", "/var/lib/sidero/"]<br/>        volumeMounts:<br/>        - mountPath: /var/lib/sidero/tftp <br/>          name: tftp-folder<br/>      containers:<br/>      - name: manager<br/>        volumeMounts:<br/>        - mountPath: /var/lib/sidero/tftp<br/>          name: tftp-folder</span></pre><p id="824a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，您可以运行以下命令:</p><pre class="km kn ko kp gt ms mt mu mv aw mw bi"><span id="631b" class="lf lg iq mt b gy mx my l mz na">kubectl patch --patch-file patch.yaml deploy sidero-controller-manager  -n sidero-system</span></pre><p id="0b91" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">修补Sidero Metal部署后，使用以下命令尝试netboot一个RPi，只连接一个空白硬盘或SD卡，如果成功，Talos Linux将引导loop，RPi将作为服务器出现在kubernetes资源列表中:</p><pre class="km kn ko kp gt ms mt mu mv aw mw bi"><span id="a4b5" class="lf lg iq mt b gy mx my l mz na">kubectl get servers -o wide</span></pre><p id="a5fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请继续关注第3部分——我们将展示如何使用我们目前正在使用的Sider Metal配置以声明方式构建Kubernetes集群！</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nc"><img src="../Images/cd0bd889ef9f1f44049d4a60a1021bb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tObaYIXNsm0R5K3YbUlvhA.png"/></div></div></figure></div></div>    
</body>
</html>