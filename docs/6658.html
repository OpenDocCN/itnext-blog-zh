<html>
<head>
<title>Bending DateTime in .NET to Test Your Code Better</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在中弯曲日期时间。NET来更好地测试您的代码</h1>
<blockquote>原文：<a href="https://itnext.io/bending-datetime-in-net-to-test-your-code-better-141574de60f5?source=collection_archive---------3-----------------------#2022-01-19">https://itnext.io/bending-datetime-in-net-to-test-your-code-better-141574de60f5?source=collection_archive---------3-----------------------#2022-01-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="07ec" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">模拟中的日期时间。网络是痛苦的，这里有一个让它不那么痛苦的方法。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/63cb880df545af78c0325e4e6fcf3d1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*15Cl4DStLHMIxFQW8rhPFw.jpeg"/></div></div></figure><p id="9ad5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">好吧，我会减少夸张，在我作为一名工程师的这么多年里(我感觉自己老了)，我遇到过一个问题，我的代码包含了一个<code class="fe ln lo lp lq b">DateTime.Now</code>或<code class="fe ln lo lp lq b">DateTime.UtcNow</code>。当我编写一个测试时，我不能验证实际的时间，因为从代码运行到我的测试开始验证已经过去了几毫秒。这不是一个很大的问题，但很烦人，因为我喜欢验证一切，以确保我不会在其他地方意外地操纵这些值。</p><p id="6de8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">对此有一个简单的解决方案，在我详细说明我所使用的解决方案之前，我需要为此调用<a class="ae lr" href="https://github.com/stphnwlsh/SimpleDateTimeProvider#inspiration" rel="noopener ugc nofollow" target="_blank">灵感</a>。TL；DR就是你可以消费我的<a class="ae lr" href="https://www.nuget.org/packages/SimpleDateTimeProvider/" rel="noopener ugc nofollow" target="_blank">SimpleDateTimeProvider NuGet包</a>帮你解决这个。这方面的代码实现如下。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="6ab7" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">解决方案</h1><p id="a817" class="pw-post-body-paragraph kr ks iq kt b ku mr jr kw kx ms ju kz la mt lc ld le mu lg lh li mv lk ll lm ij bi translated">我创建了一个由一个接口和该接口的两个实现组成的<code class="fe ln lo lp lq b">DateTimeProvider</code>。一个实现返回系统值，另一个返回用户预设的模拟值。</p><h1 id="6911" class="lz ma iq bd mb mc mw me mf mg mx mi mj jw my jx ml jz mz ka mn kc na kd mp mq bi translated">界面</h1><pre class="kg kh ki kj gt nb lq nc nd aw ne bi"><span id="d8c3" class="nf ma iq lq b gy ng nh l ni nj">public interface IDateTimeProvider<br/>{<br/>    DateTime Now { get; }<br/>    DateTime Today { get; }<br/>    DateTime UtcNow { get; }<br/>}</span></pre><h1 id="2e1e" class="lz ma iq bd mb mc mw me mf mg mx mi mj jw my jx ml jz mz ka mn kc na kd mp mq bi translated">系统实现</h1><pre class="kg kh ki kj gt nb lq nc nd aw ne bi"><span id="6c04" class="nf ma iq lq b gy ng nh l ni nj">public class SystemDateTimeProvider : IDateTimeProvider<br/>{<br/>    public DateTime Now =&gt; DateTime.Now;<br/>    public DateTime Today =&gt; DateTime.Today;<br/>    public DateTime UtcNow =&gt; DateTime.UtcNow;<br/>}</span></pre><h1 id="c760" class="lz ma iq bd mb mc mw me mf mg mx mi mj jw my jx ml jz mz ka mn kc na kd mp mq bi translated">模拟实现</h1><pre class="kg kh ki kj gt nb lq nc nd aw ne bi"><span id="298e" class="nf ma iq lq b gy ng nh l ni nj">public class MockDateTimeProvider : IDateTimeProvider<br/>{<br/>    public DateTime Now<br/>    {<br/>        get =&gt; this.now.ThrowIfNotSet(DateTimeType.Now);<br/>        set =&gt; this.now = value;<br/>    }<br/>    public DateTime Today<br/>    {<br/>        get =&gt; this.today.ThrowIfNotSet(DateTimeType.Today);<br/>        set =&gt; this.today = value;<br/>    }<br/>    public DateTime UtcNow<br/>    {<br/>        get =&gt; this.utcNow.ThrowIfNotSet(DateTimeType.UtcNow);<br/>        set =&gt; this.utcNow = value;<br/>    }<br/>}</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="95ed" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">弯曲日期和时间</h1><p id="f9b8" class="pw-post-body-paragraph kr ks iq kt b ku mr jr kw kx ms ju kz la mt lc ld le mu lg lh li mv lk ll lm ij bi translated">这是一个简单的解决方案，使用提供者很容易开始，只需在功能代码中的<code class="fe ln lo lp lq b">IDateTimeProvider</code>接口下注入系统提供者。如果你正在使用另一个库，你会知道语法，但遵循相同的公式。</p><pre class="kg kh ki kj gt nb lq nc nd aw ne bi"><span id="127d" class="nf ma iq lq b gy ng nh l ni nj">_ = services.AddSingleton&lt;IDateTimeProvider, SystemDateTimeProvider&gt;();</span></pre><p id="47e3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">下一步是创建您的类，并使用我们刚刚通过<code class="fe ln lo lp lq b">IDateTimeProvider</code>接口创建的注册的<code class="fe ln lo lp lq b">SystemDateTimeProvider</code>。然后使用提供程序在您的类中设置<code class="fe ln lo lp lq b">DateTime</code>值。</p><pre class="kg kh ki kj gt nb lq nc nd aw ne bi"><span id="b724" class="nf ma iq lq b gy ng nh l ni nj">public class Service<br/>{<br/>    private readonly IDateTimeProvider dateTimeProvider;</span><span id="4dc4" class="nf ma iq lq b gy nk nh l ni nj">    public Service(IDateTimeProvider dateTimeProvider)<br/>    {<br/>        this.dateTimeProvider = dateTimeProvider;<br/>    }</span><span id="500f" class="nf ma iq lq b gy nk nh l ni nj">    public string DateTimeNow()<br/>    {<br/>        return $"DateTime.Now is {this.dateTimeProvider.Now}";<br/>    }<br/>}</span></pre><p id="96ee" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这样做的全部目的是考虑到可测试的代码。现在你有了上面的类，你可以在它的位置注入<code class="fe ln lo lp lq b">MockDateTimeProvider</code>来控制测试中的<code class="fe ln lo lp lq b">DateTime</code>值。以下示例显示了如何在<a class="ae lr" href="https://xunit.net/" rel="noopener ugc nofollow" target="_blank"> XUnit </a>中编写测试，使用<a class="ae lr" href="https://shouldly.io/" rel="noopener ugc nofollow" target="_blank"> Shouldly </a>进行断言。</p><pre class="kg kh ki kj gt nb lq nc nd aw ne bi"><span id="7642" class="nf ma iq lq b gy ng nh l ni nj">[Fact]<br/>public void Today_ShouldReturn_MockedToday()<br/>{<br/>    // Arrange<br/>    var provider = new MockDateTimeProvider();<br/>    var service = new Service(provider);<br/>    var today = DateTime.Today;</span><span id="b200" class="nf ma iq lq b gy nk nh l ni nj">    provider.Today = today;</span><span id="3f7f" class="nf ma iq lq b gy nk nh l ni nj">    // Act<br/>    var result = service.DateTimeToday();</span><span id="9829" class="nf ma iq lq b gy nk nh l ni nj">    // Assert<br/>    _ = result.ShouldBeOfType&lt;string&gt;();<br/>    result.ShouldBe($"DateTime.Today is {today}");<br/>}</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="bb6e" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">我能在哪里找到这个？</h1><p id="5f99" class="pw-post-body-paragraph kr ks iq kt b ku mr jr kw kx ms ju kz la mt lc ld le mu lg lh li mv lk ll lm ij bi translated">所有这些都是开源的。你可以在<a class="ae lr" href="https://github.com/stphnwlsh/SimpleDateTimeProvider" rel="noopener ugc nofollow" target="_blank">SimpleDateTimeProvider Repository</a>找到我在GitHub <br/>上的工作，在<a class="ae lr" href="https://www.nuget.org/packages/SimpleDateTimeProvider/" rel="noopener ugc nofollow" target="_blank">SimpleDateTimeProvider NuGet</a>找到发布的包。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="e8c7" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">支持</h1><p id="8120" class="pw-post-body-paragraph kr ks iq kt b ku mr jr kw kx ms ju kz la mt lc ld le mu lg lh li mv lk ll lm ij bi translated">如果你喜欢这个，在<a class="ae lr" href="https://github.com/stphnwlsh" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上看看我的其他例子，并考虑在<a class="ae lr" href="https://www.buymeacoffee.com/stphnwlsh" rel="noopener ugc nofollow" target="_blank">给我买杯咖啡</a>上支持我。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/d391e374cf2d7e544d2a5e8768be87e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:520/format:webp/1*HOcFY-abQPBCqlIvZwjMrA.png"/></div></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="bd1c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="nm">原载于2022年1月19日</em><a class="ae lr" href="https://dev.to/stphnwlsh/bending-datetime-in-net-to-test-your-code-better-2lon" rel="noopener ugc nofollow" target="_blank"><em class="nm">https://dev . to</em></a><em class="nm">。</em></p></div></div>    
</body>
</html>