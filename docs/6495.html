<html>
<head>
<title>Migrate from Keil to SDCC</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从基尔迁移到SDCC</h1>
<blockquote>原文：<a href="https://itnext.io/migrate-from-keil-to-sdcc-dd3362c087a7?source=collection_archive---------2-----------------------#2021-12-03">https://itnext.io/migrate-from-keil-to-sdcc-dd3362c087a7?source=collection_archive---------2-----------------------#2021-12-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/fc5b12f746b31e8c0e4d12e794ed0c28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CLzXDq4YIwzb4nhT.jpg"/></div></div></figure><p id="43fb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">今天我在用Keil uVision 5编译代码时出现了以下错误:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="e8e6" class="li lj it le b gy lk ll l lm ln">*** FATAL ERROR L250: CODE SIZE LIMIT IN RESTRICTED VERSION EXCEEDED MODULE: C:\KEIL\C51\LIB\C51FPS.LIB (-----) LIMIT: 0800H BYTES</span></pre><p id="c59f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在谷歌搜索后，我发现<code class="fe lo lp lq le b">0800H</code> (2KB)是评估版的代码大小限制，这意味着如果我想在我的程序中添加更多的功能，我必须购买一个许可证。然而，Keil没有在他们的网站上给出准确的定价模型，我真的不想只为我的爱好项目填写他们的报价表。</p><p id="2a23" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">所以唯一的选择就是找到一个开源的替代品。幸运的是我很容易就找到了<a class="ae lr" href="http://sdcc.sourceforge.net/" rel="noopener ugc nofollow" target="_blank"> SSDC </a>(小型设备C编译器)，它支持8051。</p><h1 id="09d7" class="ls lj it bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">装置</h1><p id="04c7" class="pw-post-body-paragraph kb kc it kd b ke mp kg kh ki mq kk kl km mr ko kp kq ms ks kt ku mt kw kx ky im bi translated">安装非常简单——只需进入他们的下载页面，下载适合您操作系统的版本。我用的是Windows，所以我下载了一个64位的Windows。安装后，您将得到<code class="fe lo lp lq le b">sdcc</code>命令:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="41b3" class="li lj it le b gy lk ll l lm ln">&gt; sdcc --version<br/>SDCC : mcs51/z80/z180/r2k/r2ka/r3ka/gbz80/tlcs90/ez80_z80/z80n/ds390/pic16/pic14/TININative/ds400/hc08/s08/stm8/pdk13/pdk14/pdk15 4.1.0 #12072 (MINGW64)<br/>published under GNU General Public License (GPL)</span></pre><h1 id="e949" class="ls lj it bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">移民</h1><p id="eb87" class="pw-post-body-paragraph kb kc it kd b ke mp kg kh ki mq kk kl km mr ko kp kq ms ks kt ku mt kw kx ky im bi translated">然后我试着编译我的源代码。我的Keil项目有两个C文件:<code class="fe lo lp lq le b">main.c</code>和<code class="fe lo lp lq le b">tm1638.c</code>。根据SDCC文件，支持文件应该用<code class="fe lo lp lq le b">-c</code>选项编译，然后链接到主程序:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="5811" class="li lj it le b gy lk ll l lm ln">&gt; sdcc -c tm1638.c<br/>&gt; sdcc main.c tm1638.rel</span></pre><p id="6bca" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我尝试运行这两个命令，并修复了一些凯尔和SDCC之间的不兼容。不同之处在于:</p><ul class=""><li id="eaac" class="mu mv it kd b ke kf ki kj km mw kq mx ku my ky mz na nb nc bi translated">自定义头文件必须用双引号括起来。例如，我的项目在与<code class="fe lo lp lq le b">main.c</code>相同的目录中有一个<code class="fe lo lp lq le b">tm1638.h</code>。在基尔<code class="fe lo lp lq le b">#include &lt;tm1638.h&gt;</code>作品中，但在SDCC，它必须写成<code class="fe lo lp lq le b">#include "tm1638.h"</code>。</li><li id="fc82" class="mu mv it kd b ke nd ki ne km nf kq ng ku nh ky mz na nb nc bi translated">8051头文件有不同的名称。在基尔我们用<code class="fe lo lp lq le b">#include &lt;reg52.h&gt;</code>，但是在SDCC我们用<code class="fe lo lp lq le b">#include &lt;8052.h&gt;</code>。</li><li id="4e8f" class="mu mv it kd b ke nd ki ne km nf kq ng ku nh ky mz na nb nc bi translated">Keil中的<code class="fe lo lp lq le b">sbit</code>、<code class="fe lo lp lq le b">sfr</code>对应SDCC的<code class="fe lo lp lq le b">__sbit</code>、<code class="fe lo lp lq le b">__sfr</code>。在基尔我们用<code class="fe lo lp lq le b">sfr P0 = 0x80; sbit P0_1 = P0 ^ 1;</code>，而在SSDC我们用<code class="fe lo lp lq le b">__sfr __at (0x80) P0; __sbit __at (0x81) P0_1;</code>。详见<a class="ae lr" href="http://sdcc.sourceforge.net/doc/sdccman.pdf" rel="noopener ugc nofollow" target="_blank">文件</a>。</li><li id="edf9" class="mu mv it kd b ke nd ki ne km nf kq ng ku nh ky mz na nb nc bi translated">大多数时候我们不需要使用<code class="fe lo lp lq le b">__sfr</code>来定义端口。<code class="fe lo lp lq le b">8052.h</code>已经为我们定义了公共端口，所以我们只需要用宏给它们起一个可读的名字。例如:<code class="fe lo lp lq le b">#define DIO P1_0</code></li><li id="ad20" class="mu mv it kd b ke nd ki ne km nf kq ng ku nh ky mz na nb nc bi translated">Keil中的<code class="fe lo lp lq le b"><a class="ae lr" href="https://www.keil.com/support/man/docs/c51/c51_le_pgmmem.htm" rel="noopener ugc nofollow" target="_blank">code</a></code>关键字对应SDCC中的<code class="fe lo lp lq le b">__code</code>。所以我们在基尔<code class="fe lo lp lq le b">unsiged char code sevenseg_hex[] = {...};</code>所做的必须写成在SSDC<code class="fe lo lp lq le b">__code unsigend char sevenseg_hex[] = {...};</code>。</li><li id="c5fb" class="mu mv it kd b ke nd ki ne km nf kq ng ku nh ky mz na nb nc bi translated"><code class="fe lo lp lq le b">interrupt</code>在基尔变成了<code class="fe lo lp lq le b">__interrupt</code>。所以使用下面的代码来定义一个中断处理程序:<code class="fe lo lp lq le b">void timer0() __interrupt 1 { ... }</code></li></ul><p id="f694" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">有了这些修改，我的代码编译得相当好，并且成功地生成了<code class="fe lo lp lq le b">main.ihx</code>文件。然后我只需要用下面的命令将其转换成<code class="fe lo lp lq le b">hex</code>格式:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="a2b9" class="li lj it le b gy lk ll l lm ln">&gt; packihx main.ihx &gt; main.hex</span></pre><p id="eeb5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">而且这个十六进制文件是可以下载并正常工作的！</p><h1 id="a2f3" class="ls lj it bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">生成文件</h1><p id="a406" class="pw-post-body-paragraph kb kc it kd b ke mp kg kh ki mq kk kl km mr ko kp kq ms ks kt ku mt kw kx ky im bi translated">使用SSDC的另一个好处是命令行支持，这意味着我可以使用<code class="fe lo lp lq le b">Makefile</code>来管理我的项目。首先我安装了GNU Make for Windows:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="1652" class="li lj it le b gy lk ll l lm ln">(with adminstrator) &gt; chocolatey.exe install make</span></pre><p id="9ce0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后创建了下面的<code class="fe lo lp lq le b">Makefile</code>:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="0451" class="li lj it le b gy lk ll l lm ln">ifeq ($(OS),Windows_NT) <br/>RM = del /Q /F<br/>CP = copy /Y<br/>ifdef ComSpec<br/>SHELL := $(ComSpec)<br/>endif<br/>ifdef COMSPEC<br/>SHELL := $(COMSPEC)<br/>endif<br/>else<br/>RM = rm -rf<br/>CP = cp -f<br/>endif</span><span id="9f3d" class="li lj it le b gy ni ll l lm ln">CC := sdcc<br/>PACKIHX := packihx</span><span id="ab8c" class="li lj it le b gy ni ll l lm ln">.PHONY: all clean</span><span id="31ad" class="li lj it le b gy ni ll l lm ln">all: tm1638-counter.hex</span><span id="5ad2" class="li lj it le b gy ni ll l lm ln">clean:<br/>        -$(RM) -f *.asm *.lk *.lst *.map *.mem *.rel *.rst *.sym *.asm *.ihx *.hex</span><span id="2b32" class="li lj it le b gy ni ll l lm ln">tm1638.rel: tm1638.h tm1638.c<br/>        $(CC) -c tm1638.c</span><span id="93b3" class="li lj it le b gy ni ll l lm ln">main.ihx: tm1638.h main.c tm1638.rel<br/>        $(CC) main.c tm1638.rel</span><span id="ab4e" class="li lj it le b gy ni ll l lm ln">main.hex: main.ihx<br/>        $(PACKIHX) main.ihx &gt; main.hex</span></pre><p id="f619" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在运行<code class="fe lo lp lq le b">make</code>将生成十六进制文件。不再需要离开VSCode编辑器。</p></div></div>    
</body>
</html>