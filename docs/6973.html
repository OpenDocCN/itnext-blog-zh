<html>
<head>
<title>Run WASM at Ingress to Validate, Verify and Transform a request</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在入口运行WASM来验证、检验和转换请求</h1>
<blockquote>原文：<a href="https://itnext.io/run-wasm-at-ingress-to-validate-verify-and-transform-a-request-5670fa2c1fd3?source=collection_archive---------0-----------------------#2022-04-30">https://itnext.io/run-wasm-at-ingress-to-validate-verify-and-transform-a-request-5670fa2c1fd3?source=collection_archive---------0-----------------------#2022-04-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="07dc" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">介绍</h1><p id="5856" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">当开发人员得到他们喜欢的工具时，他们往往会更有生产力。所选语言的可扩展性提供了可扩展性的便利，而无需学习新的语言。WebAssembly运行时执行字节码，字节码是通过编译用高级语言编写的代码生成的，高级语言包括javascript、C、C++、Python、Rust或Golang。</p><p id="bc94" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">我们探索了在Route gateway中对WebAssembly的支持，以及我们如何加载用选择的语言编写的自定义逻辑生成的字节码。使用EnRoute加载到WebAssembly运行时。</p><p id="5f51" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">我们从验证请求、验证其模式和转换请求的目标开始。我们使用编译并加载到WebAssembly运行时的自定义代码来实现这一点</p><p id="c950" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">WASM支持是<a class="ae lo" href="https://getenroute.io/features" rel="noopener ugc nofollow" target="_blank">途中社区版</a>的一部分，无需任何企业许可即可免费使用。</p><h1 id="5b6d" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">本文涵盖的内容</h1><p id="6dba" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">以下步骤介绍了处理请求所需的内容</p><ul class=""><li id="8048" class="lp lq iq kn b ko lj ks lk kw lr la ls le lt li lu lv lw lx bi translated">在WASM支持下安装</li><li id="3639" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">安装示例工作负载</li><li id="89cd" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">正在编写程序以使服务对外可用</li><li id="37e8" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">创建WebAssembly筛选器</li><li id="64a4" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">为服务启用WebAssembly筛选器</li><li id="69a5" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">确保请求MAC得到验证，并转换请求以编辑敏感信息</li><li id="fca1" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">确保验证了JSON模式</li></ul><p id="8d1d" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">接下来，我们将详细介绍上述步骤。我们还将了解如何在<a class="ae lo" href="https://github.com/solo-io/wasm/blob/master/spec/spec-compat.md" rel="noopener ugc nofollow" target="_blank"> compat variant </a>中构建WebAssembly映像，然后通过EnRoute将其加载到Envoy WebAssembly运行时</p><h2 id="574e" class="md jo iq bd jp me mf dn jt mg mh dp jx kw mi mj kb la mk ml kf le mm mn kj mo bi translated">在WASM支持下安装</h2><p id="eb66" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">WASM支持在单独的途中映像中提供。在添加helm repo并安装带有<code class="fe mp mq mr ms b">wasm</code>标签的途中映像后，可以使用以下helm命令进行安装</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="b0a4" class="md jo iq ms b gy nb nc l nd ne">helm repo add saaras https://getenroute.io <br/>helm install enroute-demo saaras/enroute \<br/>--set serviceAccount.create=true \<br/>--create-namespace \<br/>--namespace enroutedemo \<br/>--set images.enrouteService.tag=wasm</span></pre><h2 id="734f" class="md jo iq bd jp me mf dn jt mg mh dp jx kw mi mj kb la mk ml kf le mm mn kj mo bi translated">安装示例工作负载</h2><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="dc08" class="md jo iq ms b gy nb nc l nd ne">kubectl create namespace httpbin kubectl apply -f <a class="ae lo" href="https://raw.githubusercontent.com/saarasio/enroute/master/helm-chart/httpbin-bin-service.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/saarasio/enroute/master/helm-chart/httpbin-bin-service.yaml</a></span></pre><h2 id="087a" class="md jo iq bd jp me mf dn jt mg mh dp jx kw mi mj kb la mk ml kf le mm mn kj mo bi translated">正在编写程序以使服务对外可用</h2><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="67d9" class="md jo iq ms b gy nb nc l nd ne">helm install httpbin-service-policy saaras/service-policy<br/>--set service.name=httpbin<br/>--set service.prefix=/post<br/>--set service.port= 80<br/>--namespace httpbin</span></pre><p id="e205" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">向<code class="fe mp mq mr ms b">LoadBalancer</code>服务的外部IP发送请求，以验证它是否按预期工作。<a class="ae lo" href="https://getenroute.io/docs/getting-started-enroute-ingress-controller/" rel="noopener ugc nofollow" target="_blank">入门</a>指南详细介绍了如何设置。</p><p id="561d" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">获取路由负载平衡器服务的公共IP(<code class="fe mp mq mr ms b">212.2.241.255</code>)并发送请求</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="465e" class="md jo iq ms b gy nb nc l nd ne"><strong class="ms ir">curl -X POST -H 'Content-Type: application/json' -d '{}' 212.2.241.255/post</strong></span><span id="7184" class="md jo iq ms b gy nf nc l nd ne"><strong class="ms ir">{</strong><br/>  "args": <strong class="ms ir">{}</strong>,<br/>  "data": "{}",<br/>  "files": <strong class="ms ir">{}</strong>,<br/>  "form": <strong class="ms ir">{}</strong>,<br/>  "headers": <strong class="ms ir">{</strong><br/>    "Accept": "*/*",<br/>    "Content-Length": "2",<br/>    "Content-Type": "application/json",<br/>    "Host": "212.2.241.255",<br/>    "User-Agent": "curl/7.68.0",<br/>    "X-Envoy-Expected-Rq-Timeout-Ms": "15000",<br/>    "X-Envoy-External-Address": "192.168.1.5"<br/>  <strong class="ms ir">}</strong>,<br/>  "json": <strong class="ms ir">{}</strong>,<br/>  "origin": "152.70.114.65,192.168.1.5",<br/>  "url": "http://212.2.241.255/post"<br/><strong class="ms ir">}</strong></span></pre><h2 id="a48b" class="md jo iq bd jp me mf dn jt mg mh dp jx kw mi mj kb la mk ml kf le mm mn kj mo bi translated">创建WebAssembly筛选器</h2><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="9d82" class="md jo iq ms b gy nb nc l nd ne">cat &lt;&lt;EOF | kubectl apply -f -<br/>apiVersion: enroute.saaras.io/v1<br/>kind: HttpFilter<br/>metadata:<br/>  name: httpbin-wasm-wasmfilter-oci<br/>  namespace: httpbin<br/>spec:<br/>  httpFilterConfig:<br/>    config: |<br/>      {<br/>              "url" : "oci://saarasio/vvx-json"<br/>      }<br/>  name: httpbin-wasm-wasmfilter-oci<br/>  type: http_filter_wasm<br/>EOF</span></pre><h2 id="0344" class="md jo iq bd jp me mf dn jt mg mh dp jx kw mi mj kb la mk ml kf le mm mn kj mo bi translated">为服务启用WebAssembly筛选器</h2><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="a316" class="md jo iq ms b gy nb nc l nd ne"><strong class="ms ir">kubectl edit -n httpbin gatewayhosts.enroute.saaras.io httpbin-80-gatewayhost</strong></span><span id="d6c0" class="md jo iq ms b gy nf nc l nd ne"><strong class="ms ir">  5</strong> apiVersion: enroute.saaras.io/v1<br/>  <strong class="ms ir">6</strong> kind: GatewayHost<br/>  <strong class="ms ir">7</strong> metadata:<br/>  <strong class="ms ir">8</strong>   annotations:<br/>  <strong class="ms ir">9</strong>     meta.helm.sh/release-name: httpbin-service-policy<br/> <strong class="ms ir">10</strong>     meta.helm.sh/release-namespace: httpbin<br/> <strong class="ms ir">11</strong>   creationTimestamp: "2022-04-26T14:56:48Z"<br/> <strong class="ms ir">12</strong>   generation: <strong class="ms ir">3</strong><br/> <strong class="ms ir">13</strong>   labels:<br/> <strong class="ms ir">14</strong>     app: httpbin<br/> <strong class="ms ir">15</strong>     app.kubernetes.io/managed-by: Helm<br/> <strong class="ms ir">16</strong>   name: httpbin-80-gatewayhost<br/> <strong class="ms ir">17</strong>   namespace: httpbin<br/> <strong class="ms ir">18</strong>   resourceVersion: "3736"<br/> <strong class="ms ir">19</strong>   uid: b2e39054-a959-40c3-9754-365b518b8ee6<br/> <strong class="ms ir">20</strong> spec:<br/> <strong class="ms ir">21</strong>   routes:<br/> <strong class="ms ir">22</strong>   - conditions:<br/> <strong class="ms ir">23</strong>     - prefix: /post<br/> <strong class="ms ir">24</strong>     filters:<br/> <strong class="ms ir">25</strong>     - name: httpbin-80-rl2<br/> <strong class="ms ir">26</strong>       type: route_filter_ratelimit<br/> <strong class="ms ir">27</strong>     services:<br/> <strong class="ms ir">28</strong>     - healthCheck:<br/> <strong class="ms ir">29</strong>         healthyThresholdCount: <strong class="ms ir">3</strong><br/> <strong class="ms ir">30</strong>         host: hc<br/> <strong class="ms ir">31</strong>         intervalSeconds: <strong class="ms ir">5</strong><br/> <strong class="ms ir">32</strong>         path: /<br/> <strong class="ms ir">33</strong>         timeoutSeconds: <strong class="ms ir">3</strong><br/> <strong class="ms ir">34</strong>         unhealthyThresholdCount: <strong class="ms ir">3</strong><br/> <strong class="ms ir">35</strong>       name: httpbin<br/> <strong class="ms ir">36</strong>       port: <strong class="ms ir">80</strong><br/> <strong class="ms ir">37</strong>   virtualhost:<br/> <strong class="ms ir">38</strong>     filters:<br/> <strong class="ms ir">39</strong>     - name: httpbin-80-luatestfilter<br/> <strong class="ms ir">40</strong>       type: http_filter_lua<br/> <strong class="ms ir">41</strong>     - name: httpbin-wasm-wasmfilter-oci<br/> <strong class="ms ir">42</strong>       type: http_filter_wasm<br/> <strong class="ms ir">43</strong>     fqdn: '*'</span></pre><h2 id="ad35" class="md jo iq bd jp me mf dn jt mg mh dp jx kw mi mj kb la mk ml kf le mm mn kj mo bi translated">确保MAC得到验证，并且通过编辑个人信息来转换请求</h2><p id="6101" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我们首先创建一个有效负载JSON，并使用POST请求将其发送给服务器。这是一个名为payload.json的文件中的json有效负载</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="4f6b" class="md jo iq ms b gy nb nc l nd ne"><strong class="ms ir">cat payload.json</strong></span><span id="75ac" class="md jo iq ms b gy nf nc l nd ne"><strong class="ms ir">{</strong><br/>  "data": <strong class="ms ir">[{</strong><br/>    "type": "articles",<br/>    "id": "1",<br/>    "attributes": <strong class="ms ir">{</strong><br/>      "title": "JSON:API paints my bikeshed!",<br/>      "body": "The shortest article. Ever.",<br/>      "created": "2006-01-02 15:04",<br/>      "updated": "2011-01-19 22:15",<br/>      "dob": "2022-01-19 22:15"<br/>    <strong class="ms ir">}</strong>,<br/>    "relationships": <strong class="ms ir">{</strong><br/>      "author": <strong class="ms ir">{</strong><br/>        "data": <strong class="ms ir">{</strong>"id": "42", "type": "people"<strong class="ms ir">}</strong><br/>      <strong class="ms ir">}</strong><br/>    <strong class="ms ir">}</strong><br/>  <strong class="ms ir">}]</strong>,<br/>  "included": <strong class="ms ir">[</strong><br/>    <strong class="ms ir">{</strong><br/>      "type": "people",<br/>      "id": "42",<br/>      "attributes": <strong class="ms ir">{</strong><br/>        "name": "John",<br/>        "age": 80,<br/>        "gender": "male"<br/>      <strong class="ms ir">}</strong><br/>    <strong class="ms ir">}</strong><br/>  <strong class="ms ir">]</strong><br/><strong class="ms ir">}</strong></span></pre><p id="29df" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">为了验证，我们计算有效负载的SHA256，并将其与我们计算并在摘要报头中发送的值进行比较</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="07b4" class="md jo iq ms b gy nb nc l nd ne"><strong class="ms ir">cat payload.json | tr -d "\n" | openssl dgst -sha256 -binary | base64</strong></span><span id="9849" class="md jo iq ms b gy nf nc l nd ne">h3wEb7jrjmwD8O7TDvOD3WGG23lfnzsfmODcbwLmdlk =</span></pre><p id="cdb7" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">发送请求</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="b604" class="md jo iq ms b gy nb nc l nd ne">curl -vv 212.2.241.255/post -H 'Content-Type: application/json' -H "Digest: sha256=h3wEb7jrjmwD8O7TDvOD3WGG23lfnzsfmODcbwLmdlk=" --data @/home/ubuntu/payload.json</span><span id="2236" class="md jo iq ms b gy nf nc l nd ne"><strong class="ms ir">{</strong><br/>  "args": <strong class="ms ir">{}</strong>,<br/>  "data": "{  \"data\": [{    \"type\": \"articles\",    \"id\": \"1\",    \"attributes\": {      \"title\": \"JSON:API paints my bikeshed!\",      \"body\": \"The shortest article. Ever.\",      \"created\": \"2006-01-02 15:04\",      \"updated\": \"2011-01-19 22:15\",      \"dob\": \"0000-00-00 00:00\"    },    \"relationships\": {      \"author\": {        \"data\": {\"id\": \"42\", \"type\": \"people\"}      }    }  }],  \"included\": [    {      \"type\": \"people\",      \"id\": \"42\",      \"attributes\": {        \"name\": \"John\",        \"age\": 80,        \"gender\": \"male\"      }    }  ]}",<br/>  "files": <strong class="ms ir">{}</strong>,<br/>  "form": <strong class="ms ir">{}</strong>,<br/>  "headers": <strong class="ms ir">{</strong><br/>    "Accept": "*/*",<br/>    "Content-Length": "532",<br/>    "Content-Type": "application/json",<br/>    "Digest": "sha256=h3wEb7jrjmwD8O7TDvOD3WGG23lfnzsfmODcbwLmdlk=",<br/>    "Host": "212.2.241.255",<br/>    "User-Agent": "curl/7.68.0",<br/>    "X-Envoy-Expected-Rq-Timeout-Ms": "15000",<br/>    "X-Envoy-External-Address": "192.168.1.5"<br/>  <strong class="ms ir">}</strong>,<br/>  "json": <strong class="ms ir">{</strong><br/>    "data": <strong class="ms ir">[</strong><br/>      <strong class="ms ir">{</strong><br/>        "attributes": <strong class="ms ir">{</strong><br/>          "body": "The shortest article. Ever.",<br/>          "created": "2006-01-02 15:04",<br/>          "dob": "0000-00-00 00:00",<br/>          "title": "JSON:API paints my bikeshed!",<br/>          "updated": "2011-01-19 22:15"<br/>        <strong class="ms ir">}</strong>,<br/>        "id": "1",<br/>        "relationships": <strong class="ms ir">{</strong><br/>          "author": <strong class="ms ir">{</strong><br/>            "data": <strong class="ms ir">{</strong><br/>              "id": "42",<br/>              "type": "people"<br/>            <strong class="ms ir">}</strong><br/>          <strong class="ms ir">}</strong><br/>        <strong class="ms ir">}</strong>,<br/>        "type": "articles"<br/>      <strong class="ms ir">}</strong><br/>    <strong class="ms ir">]</strong>,<br/>    "included": <strong class="ms ir">[</strong><br/>      <strong class="ms ir">{</strong><br/>        "attributes": <strong class="ms ir">{</strong><br/>          "age": 80,<br/>          "gender": "male",<br/>          "name": "John"<br/>        <strong class="ms ir">}</strong>,<br/>        "id": "42",<br/>        "type": "people"<br/>      <strong class="ms ir">}</strong><br/>    <strong class="ms ir">]</strong><br/>  <strong class="ms ir">}</strong>,<br/>  "origin": "152.70.114.65,192.168.1.5",<br/>  "url": "http://212.2.241.255/post"<br/><strong class="ms ir">}</strong></span></pre><p id="5a47" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">JSON验证检查有效负载中是否存在一些JSON元素以及某些字段的格式。在上面的有效负载中，它检查<code class="fe mp mq mr ms b">type</code>、<code class="fe mp mq mr ms b">id</code>、<code class="fe mp mq mr ms b">title</code>、<code class="fe mp mq mr ms b">body</code>，并验证<code class="fe mp mq mr ms b">created</code>和<code class="fe mp mq mr ms b">updated</code>文件的格式，以确保提供有效的日期。</p><figure class="mt mu mv mw gt ng"><div class="bz fp l di"><div class="nh ni l"/></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">使用WASM演示进行验证、检验和改造</figcaption></figure><h1 id="f9cc" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">结论</h1><p id="4ad0" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">WebAssembly提供了一种灵活的扩展机制来定制请求验证、确认和转换。代理中的WebAssembly实现由SDK实现的proxy-wasm abi规范。不同语言的SDK提供了一种与WebAssembly运行时交互的机制。我们使用<a class="ae lo" href="https://github.com/tetratelabs/proxy-wasm-go-sdk" rel="noopener ugc nofollow" target="_blank"> go sdk </a>实现<a class="ae lo" href="https://github.com/proxy-wasm/spec" rel="noopener ugc nofollow" target="_blank">代理-wasm abi规范</a>来实现这一点。</p><figure class="mt mu mv mw gt ng gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi nn"><img src="../Images/37ff0a7d5deafd3aee0a87cc73fb8ab5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ez3IiMnhafZeRNia.jpeg"/></div></div></figure><p id="39ca" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">使用<a class="ae lo" href="https://github.com/WebAssembly/wasi-libc" rel="noopener ugc nofollow" target="_blank"> WASI libc </a>将上述步骤中生成的代码编译成WASM。当使用<a class="ae lo" href="https://tinygo.org/docs/reference/usage/basic/#building-hello-world-program-for-webassembly" rel="noopener ugc nofollow" target="_blank"> tinygo </a>进行编译时，编译后生成的字节码被打包成compat variant中的WASM工件，然后加载到Envoy WebAssembly运行时中。</p><p id="0c7c" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">在下一篇文章中，我们将介绍如何构建一个可以在途中加载的图像的compat变体，并详细介绍代理wasm ABI，它让我们可以接收请求处理的回调。</p></div><div class="ab cl nu nv hu nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="ij ik il im in"><p id="da65" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><em class="ob">最初发布于</em><a class="ae lo" href="https://getenroute.io/blog/developer-program-ingress-wasm-validate-verify-transform/" rel="noopener ugc nofollow" target="_blank"><em class="ob">https://geten route . io</em></a><em class="ob">。</em></p></div></div>    
</body>
</html>