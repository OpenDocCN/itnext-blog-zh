<html>
<head>
<title>NGINX: IP Geolocation by Cloudflare and “nested” if conditions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">NGINX:通过Cloudflare和“嵌套”if条件进行IP地理定位</h1>
<blockquote>原文：<a href="https://itnext.io/nginx-ip-geolocation-by-cloudflare-and-nested-if-conditions-1e305beb8efd?source=collection_archive---------1-----------------------#2022-04-02">https://itnext.io/nginx-ip-geolocation-by-cloudflare-and-nested-if-conditions-1e305beb8efd?source=collection_archive---------1-----------------------#2022-04-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/762e0d196d87fcd111cd49277cf43d3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:260/format:webp/0*pft2fOozAuSSuwqB.jpg"/></div></figure><p id="a7d2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在Cloudflare提供的其他功能中，它可以添加一个带有国家值的特殊标题，访问者来自哪里。</p><p id="49f7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">作为一个乌克兰人，我想禁止所有来自俄罗斯的游客，但是:</p><ol class=""><li id="ebe9" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated">将所有来自俄罗斯IP的访问者重定向到另一个web域—<em class="lb">russki-voenny-korabl-idi-nahuy.com</em></li><li id="b8f7" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated">在此期间，我想过滤请求，让来自俄罗斯Yandex搜索系统的请求不受影响，因此它将继续在俄罗斯听觉搜索结果中返回我的RTFM博客。</li></ol><h1 id="e59a" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">Cloudflare IP地理定位和NGINX</h1><p id="a6b5" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">这里最简单的部分是通过来自Cloudflare的标题来配置过滤器。</p><p id="8fad" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">首先启用<a class="ae mk" href="https://support.cloudflare.com/hc/en-us/articles/200168236-Configuring-Cloudflare-IP-Geolocation" rel="noopener ugc nofollow" target="_blank"> CF-IPCountry </a>表头。</p><p id="83fd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">转到您的Cloudflare <em class="lb">仪表盘&gt;网络</em>，激活该选项，即使在其基本计划中也是免费的:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi ml"><img src="../Images/10a316d7165ce5234d2b5c634b71e022.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sLXxNDx5YPN4gOBp.png"/></div></div></figure><p id="4066" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后，在NGINX的虚拟主机配置中，在<code class="fe mu mv mw mx b">server {}</code>块中使用<code class="fe mu mv mw mx b"><a class="ae mk" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header" rel="noopener ugc nofollow" target="_blank">proxy_set_header</a></code>创建一个变量<code class="fe mu mv mw mx b">$http_cf_ipcountry</code>:</p><pre class="mm mn mo mp gt my mx mz na aw nb bi"><span id="f91d" class="nc li iq mx b gy nd ne l nf ng">...<br/>proxy_set_header CF-IPCountry $http_cf_ipcountry;<br/>...</span></pre><h1 id="3139" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">NGINX和“嵌套”<code class="fe mu mv mw mx b">if</code></h1><p id="e984" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">第二部分更有趣。</p><p id="ca76" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以，我们需要检查两个条件:</p><ol class=""><li id="f1f0" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated">是一个来自俄罗斯的游客</li><li id="2dc4" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated">是普通访客，还是Yandex搜索机器人？</li></ol><p id="1236" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在NGINX中，我们不能使用带有<code class="fe mu mv mw mx b">if</code>的真正嵌套条件，例如:</p><pre class="mm mn mo mp gt my mx mz na aw nb bi"><span id="51d4" class="nc li iq mx b gy nd ne l nf ng">...<br/>    if ($country_allowed = no) {<br/>        if ($http_user_agent !~* (YandexBot) ) {<br/>            rewrite ^ <a class="ae mk" href="https://russki-voenny-korabl-idi-nahuy.com" rel="noopener ugc nofollow" target="_blank">https://russki-voenny-korabl-idi-nahuy.com</a> break;<br/>        }<br/>    }<br/>...</span></pre><p id="4424" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是我们在这里能做的，就是使用变量和专用的<code class="fe mu mv mw mx b">if</code>。</p><p id="2ef3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们检查一下。</p><p id="b1b7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">启用VPN，并检查您现在的位置，例如使用<a class="ae mk" href="https://www.iplocation.net" rel="noopener ugc nofollow" target="_blank">https://www.iplocation.net</a>服务:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/5304642a661b06edf27006d8a81c39d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1172/format:webp/0*HRMohuQOz4eB_d_M.png"/></div></figure><p id="a7e0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">GB  —大不列颠。</p><p id="da39" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<code class="fe mu mv mw mx b">nginx.conf</code>中，您还可以启用<code class="fe mu mv mw mx b">access_log</code>的扩展日志格式来查看更多信息，并检查<code class="fe mu mv mw mx b">$http_cf_ipcountry</code>和我们将在下面添加的新变量<code class="fe mu mv mw mx b">$visitor</code>的值:</p><pre class="mm mn mo mp gt my mx mz na aw nb bi"><span id="e60b" class="nc li iq mx b gy nd ne l nf ng">...<br/>    log_format  main_ext '$time_local client: $remote_addr fwd_for: $http_x_forwarded_for '<br/>                         'status: $status user_agent: "$http_user_agent" '<br/>                         'server: "$server_name" country: $http_cf_ipcountry visitor: $visitor';<br/>...</span></pre><p id="b466" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来，创建条件并运行测试。测试成功后，我们会将条件更改为区域<em class="lb"> RU </em>和“如果不相等”<em class="lb"> Yandex </em>(参见服务器日志中的<a class="ae mk" href="https://yandex.com/support/webmaster/robot-workings/check-yandex-robots.html" rel="noopener ugc nofollow" target="_blank"> Yandex机器人)。</a></p><p id="6573" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以:</p><ol class=""><li id="1ebf" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated">从<code class="fe mu mv mw mx b">CF-IPCountry</code>头创建一个名为<code class="fe mu mv mw mx b">$http_cf_ipcountry</code>的变量；</li><li id="2bb1" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated">在第一个<code class="fe mu mv mw mx b">if</code>条件中，检查<code class="fe mu mv mw mx b">$http_cf_ipcountry</code>的值:现在，检查<em class="lb"> GB </em>并创建一个变量<code class="fe mu mv mw mx b">$visitor</code>，该变量将保存一个值<em class="lb"> rus </em>，如果region = =<em class="lb">CA</em>；</li><li id="67a6" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated">在第二个<code class="fe mu mv mw mx b">if</code>条件中，检查<code class="fe mu mv mw mx b">User-Agent</code>，如果是== <em class="lb"> Firefox </em>则给<code class="fe mu mv mw mx b">$visitor</code>变量增加另一个值- " <em class="lb">重定向</em>；</li><li id="44ac" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated">在第三个<code class="fe mu mv mw mx b">if</code>条件中检查<code class="fe mu mv mw mx b">$visitor</code>变量的值，如果它等于<em class="lb"> rusredirect </em>字符串，那么对<em class="lb">russki-voenny-korabl-idi-nahuy.com</em>域做一个<code class="fe mu mv mw mx b">rewrite</code>；</li></ol><p id="99ff" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，您可以将<code class="fe mu mv mw mx b"><a class="ae mk" href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite_log" rel="noopener ugc nofollow" target="_blank">rewrite_log</a></code>参数设置为上的<em class="lb">，并将<code class="fe mu mv mw mx b">error_log</code>设置为<em class="lb">通知</em>级别，这样您就能够检查重写是否按预期工作。</em></p><p id="b8eb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这是我的配置在测试期间的样子:</p><pre class="mm mn mo mp gt my mx mz na aw nb bi"><span id="8f07" class="nc li iq mx b gy nd ne l nf ng">...<br/>    rewrite_log on;<br/>    access_log /var/log/nginx/rtfm.co.ua-access-ext.log main_ext;<br/>    error_log /var/log/nginx/rtfm.co.ua-error.log notice;<br/>...<br/>    proxy_set_header CF-IPCountry $http_cf_ipcountry;<br/>    <br/>    if ($http_cf_ipcountry = GB) {<br/>        set $visitor rus;<br/>    }<br/>    <br/>    if ($http_user_agent ~* (Firefox) ) {<br/>        set $visitor "${visitor}redirect";<br/>    }<br/>    <br/>    if ($visitor = "rusredirect") {<br/>        rewrite ^ <a class="ae mk" href="https://russki-voenny-korabl-idi-nahuy.com" rel="noopener ugc nofollow" target="_blank">https://russki-voenny-korabl-idi-nahuy.com</a> break;<br/>    }<br/>...</span></pre><p id="6f30" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查配置文件并重新加载<code class="fe mu mv mw mx b">nginx</code>:</p><pre class="mm mn mo mp gt my mx mz na aw nb bi"><span id="b997" class="nc li iq mx b gy nd ne l nf ng">root@rtfm-do-production-d10:~# nginx -t<br/>nginx: the configuration file /etc/nginx/nginx.conf syntax is ok<br/>nginx: configuration file /etc/nginx/nginx.conf test is successful<br/>root@rtfm-do-production-d10:~# systemctl reload nginx</span></pre><p id="f1b4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用Firefox浏览器访问博客:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/f7bd59a326d66431bd93dd475689783c.png" data-original-src="https://miro.medium.com/v2/resize:fit:902/format:webp/0*9qir3Louk9azquDi.png"/></div></figure><p id="6ea3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">访问日志:</p><pre class="mm mn mo mp gt my mx mz na aw nb bi"><span id="5488" class="nc li iq mx b gy nd ne l nf ng">root@rtfm-do-production-d10:~# tail -f /var/log/nginx/rtfm.co.ua-access-ext.log | grep GB<br/>02/Apr/2022:06:22:29 +0000 client: 162.158.91.190 fwd_for: 146.70.46.20,146.70.46.20 status: 302 user_agent: “Mozilla/5.0 (X11; Linux x86_64; rv:98.0) Gecko/20100101 Firefox/98.0” server: “rtfm.co.ua” country: GB visitor: rusredirect</span></pre><p id="0db9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">错误日志:</p><pre class="mm mn mo mp gt my mx mz na aw nb bi"><span id="ba8c" class="nc li iq mx b gy nd ne l nf ng">root@rtfm-do-production-d10:~# tail -f /var/log/nginx/rtfm.co.ua-error.log | grep ‘rewritten redirect’<br/>2022/04/02 06:22:29 [notice] 21018#21018: *33766595 rewritten redirect: “https://russki-voenny-korabl-idi-nahuy.com", client: 162.158.91.190, server: rtfm.co.ua, request: “GET / HTTP/1.1”, host: “rtfm.co.ua”</span></pre><p id="69b4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">用<code class="fe mu mv mw mx b">user_agent: "Firefox"</code>得到了一个<code class="fe mu mv mw mx b">country: GB</code>的访客，又得到了一个<code class="fe mu mv mw mx b">redirect: "https://russki-voenny-korabl-idi-nahuy.com"</code>-<em class="lb">的作品！</em>(丙)。</p><p id="498c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，用<em class="lb"> RU </em>区域和<em class="lb"> Yandex </em>为<code class="fe mu mv mw mx b">User-Agent</code>更改条件到最终版本:</p><ul class=""><li id="c034" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr nj ky kz la bi translated">设置地区:<code class="fe mu mv mw mx b">if ($http_cf_ipcountry = RU)</code></li><li id="5f4e" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr nj ky kz la bi translated">并将<code class="fe mu mv mw mx b">~* (Firefox)</code>改为不相等，即<code class="fe mu mv mw mx b">!~* (Yandex)</code> - <code class="fe mu mv mw mx b">if ($http_user_agent !~* (Yandex) )</code>:</li></ul><pre class="mm mn mo mp gt my mx mz na aw nb bi"><span id="c93f" class="nc li iq mx b gy nd ne l nf ng">...<br/>    proxy_set_header CF-IPCountry $http_cf_ipcountry;<br/>    <br/>    if ($http_cf_ipcountry = RU) {<br/>        set $visitor rus;<br/>    }<br/><br/>    if ($http_user_agent !~* (Yandex) ) {<br/>        set $visitor "${visitor}redirect";<br/>    }<br/><br/>    if ($visitor = "rusredirect") {<br/>        rewrite_log on;<br/>        rewrite ^ <a class="ae mk" href="https://russki-voenny-korabl-idi-nahuy.com" rel="noopener ugc nofollow" target="_blank">https://russki-voenny-korabl-idi-nahuy.com</a> break;<br/>    }<br/>...</span></pre><p id="a5b8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">完成了。</p></div><div class="ab cl nk nl hu nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ij ik il im in"><p id="0388" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="lb">最初发布于</em> <a class="ae mk" href="https://rtfm.co.ua/en/nginx-ip-geolocation-by-cloudflare-and-nested-if-conditions/" rel="noopener ugc nofollow" target="_blank"> <em class="lb"> RTFM: Linux、DevOps、系统管理</em> </a> <em class="lb">。</em></p></div></div>    
</body>
</html>