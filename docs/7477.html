<html>
<head>
<title>Integration tests in Angular using PollyJS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用PollyJS在Angular中进行集成测试</h1>
<blockquote>原文：<a href="https://itnext.io/integration-tests-in-angular-using-pollyjs-6fb8b7c84d38?source=collection_archive---------8-----------------------#2022-10-05">https://itnext.io/integration-tests-in-angular-using-pollyjs-6fb8b7c84d38?source=collection_archive---------8-----------------------#2022-10-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div class="gh gi io"><img src="../Images/87ccc284e046afbb31aa0a960cb90f8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:500/format:webp/1*nbJ41jD1-r2Oe6FsLjKaOg.png"/></div></figure><div class=""/><p id="0d45" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">https://github.com/JonJam/angular_pollyjs_playground的<a class="ae ks" href="https://github.com/JonJam/angular_pollyjs_playground" rel="noopener ugc nofollow" target="_blank">有代码</a></p><h1 id="7db4" class="kt ku ix bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated"><strong class="ak">背景故事</strong></h1><p id="66b9" class="pw-post-body-paragraph ju jv ix jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">在2022年期间，我的团队一直试图通过加快我们工作的整体建筑的建造时间(平均30分钟)来提高开发人员的生产率。通过将前端分离出来，我们取得了一些巨大的成功，前端是一个大型的Angular应用程序，它有自己的git存储库。</p><p id="d66d" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Angular应用程序构建需要大约25分钟，主要原因是端到端测试设置；这平均需要运行12分钟，占总构建时间的47%。</p><p id="be90" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">其他使用React的团队有一个集成测试框架，该框架利用了以下几个方面:</p><blockquote class="lw lx ly"><p id="353c" class="ju jv lz jw b jx jy jz ka kb kc kd ke ma kg kh ki mb kk kl km mc ko kp kq kr ij bi translated"><em class="ix">“帮助将大量的E2E测试转化为更快速和确定性的集成测试”。</em></p></blockquote><p id="0455" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">出于这些原因，我开始为Angular做同样的事情，但在网上看时，我没有遇到太多的指导。这就是我写这篇文章的动机，来分享我是如何做到这一点的，希望它能帮助别人。</p><h1 id="4e3f" class="kt ku ix bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">目标</h1><p id="8b9a" class="pw-post-body-paragraph ju jv ix jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">正如背景故事部分所提到的，目标是在Angular中构建一个集成测试框架，它将:</p><ol class=""><li id="c0c3" class="md me ix jw b jx jy kb kc kf mf kj mg kn mh kr mi mj mk ml bi translated">使用与单元测试相同的包:<a class="ae ks" href="https://github.com/just-jeb/angular-builders/tree/master/packages/jest" rel="noopener ugc nofollow" target="_blank">jest</a>with<a class="ae ks" href="https://ngneat.github.io/spectator/" rel="noopener ugc nofollow" target="_blank">ng neat/spectator</a>。</li></ol><p id="cd0f" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">2.自动记录任何网络请求/响应，并能够为CI/CD重放它们。</p><p id="5114" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">3.允许使用<a class="ae ks" href="https://en.wikipedia.org/wiki/Black-box_testing" rel="noopener ugc nofollow" target="_blank">黑盒</a>风格以与端到端测试相同的方式编写测试。</p><h1 id="0645" class="kt ku ix bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">包装</h1><h2 id="5705" class="mm ku ix bd kv mn mo dn kz mp mq dp ld kf mr ms lh kj mt mu ll kn mv mw lp mx bi translated">棱角分明的建设者——笑话建设者</h2><p id="8d41" class="pw-post-body-paragraph ju jv ix jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated"><a class="ae ks" href="https://github.com/just-jeb/angular-builders/tree/master/packages/jest" rel="noopener ugc nofollow" target="_blank">Angular Builders——Jest Builder</a>允许用Jest而不是Karma&amp;Jasmine(Angular中的默认设置)运行<code class="fe my mz na nb b">ng test</code>(即单元测试)。</p><p id="12e2" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">与Aim 1相关，这被重用来为集成测试创建一个新的<a class="ae ks" href="https://angular.io/guide/workspace-config#configuring-builder-targets" rel="noopener ugc nofollow" target="_blank">构建目标</a>。</p><h2 id="828b" class="mm ku ix bd kv mn mo dn kz mp mq dp ld kf mr ms lh kj mt mu ll kn mv mw lp mx bi translated">ngneat/旁观者</h2><p id="7217" class="pw-post-body-paragraph ju jv ix jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">ngneat/spectator 用于使单元测试更容易编写，并允许查询类似于<a class="ae ks" href="https://testing-library.com/" rel="noopener ugc nofollow" target="_blank">测试库</a>的DOM。</p><p id="2467" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">ngneat/spectator有一个特殊的工厂，<code class="fe my mz na nb b">createRoutingFactory</code>，可以用来测试路由(甚至提到了<a class="ae ks" href="https://ngneat.github.io/spectator/docs/testing-with-routing#integration-testing-with-routertestingmodule" rel="noopener ugc nofollow" target="_blank">集成测试</a>)。</p><p id="9b11" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">与Aim 1和3相关，这用于创建和查询测试中的Angular应用程序/与之交互。</p><h2 id="4291" class="mm ku ix bd kv mn mo dn kz mp mq dp ld kf mr ms lh kj mt mu ll kn mv mw lp mx bi translated">PollyJS</h2><p id="9a99" class="pw-post-body-paragraph ju jv ix jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">PollyJ是由网飞创建的JavaScript库，正如他们的文档所述:</p><blockquote class="lw lx ly"><p id="bc1d" class="ju jv lz jw b jx jy jz ka kb kc kd ke ma kg kh ki mb kk kl km mc ko kp kq kr ij bi translated">波利。JS是一个独立的、与框架无关的JavaScript库，支持HTTP交互的记录、重放和存根。</p></blockquote><p id="1662" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这个方案使我们能够实现目标2。</p><h1 id="d91b" class="kt ku ix bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">集成测试框架</h1><p id="0c90" class="pw-post-body-paragraph ju jv ix jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">利用<a class="ae ks" href="https://angular.io/tutorial/toh-pt6" rel="noopener ugc nofollow" target="_blank">Angular Tutorial——Tour of Heroes</a>作为一个应用程序来测试和组合上一节中提到的包，产生了我们将演练的这个集成测试框架。</p><p id="a21f" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">完整的例子可以在GitHub上找到:<a class="ae ks" href="https://github.com/JonJam/angular_pollyjs_playground" rel="noopener ugc nofollow" target="_blank">JonJam/angular _ Polly js _ playground</a>。</p><h2 id="05a2" class="mm ku ix bd kv mn mo dn kz mp mq dp ld kf mr ms lh kj mt mu ll kn mv mw lp mx bi translated">集成测试目录</h2><p id="ba76" class="pw-post-body-paragraph ju jv ix jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">一个新的目录<code class="fe my mz na nb b">integration-tests </code>存在于<code class="fe my mz na nb b">src </code>文件夹之外，它包含了测试，以及支持测试所需的大部分配置。</p><h2 id="f633" class="mm ku ix bd kv mn mo dn kz mp mq dp ld kf mr ms lh kj mt mu ll kn mv mw lp mx bi translated">集成测试的类型脚本配置</h2><p id="7866" class="pw-post-body-paragraph ju jv ix jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated"><a class="ae ks" href="https://github.com/JonJam/angular_pollyjs_playground/blob/main/tsconfig.integration.json" rel="noopener ugc nofollow" target="_blank">ts config . integration . JSON</a>扩展单元测试配置以包含<code class="fe my mz na nb b">integration-tests</code>目录中的代码。</p><pre class="nc nd ne nf gt ng nb nh ni aw nj bi"><span id="2053" class="mm ku ix nb b gy nk nl l nm nn">{<br/>  "extends": "./tsconfig.spec.json",<br/>  "include": [<br/>    "integration-tests/**/*.ts",<br/>  ],<br/>  "compilerOptions": {<br/>    "types": [<br/>      "integration-tests/index.d.ts"<br/>    ]<br/>  }<br/>}</span></pre><h2 id="d815" class="mm ku ix bd kv mn mo dn kz mp mq dp ld kf mr ms lh kj mt mu ll kn mv mw lp mx bi translated"><strong class="ak">角度整合测试建立目标</strong></h2><p id="1ad9" class="pw-post-body-paragraph ju jv ix jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">一个新的构建目标<code class="fe my mz na nb b">test-integration</code>已经被添加到<a class="ae ks" href="https://github.com/JonJam/angular_pollyjs_playground/blob/main/angular.json#L90" rel="noopener ugc nofollow" target="_blank"> angular.json </a>中，它使用带有集成测试特定配置文件的Jest Builder。</p><pre class="nc nd ne nf gt ng nb nh ni aw nj bi"><span id="212c" class="mm ku ix nb b gy nk nl l nm nn">"test-integration": {<br/>  "builder": "@angular-builders/jest:run",<br/>  "options": {<br/>    "configPath": "integration-tests/jest-integration.config.js",<br/>    "tsConfig": "tsconfig.integration.json"<br/>  }<br/>}</span></pre><h2 id="8c3f" class="mm ku ix bd kv mn mo dn kz mp mq dp ld kf mr ms lh kj mt mu ll kn mv mw lp mx bi translated">集成测试npm脚本</h2><p id="22ac" class="pw-post-body-paragraph ju jv ix jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">在<a class="ae ks" href="https://github.com/JonJam/angular_pollyjs_playground/blob/main/package.json" rel="noopener ugc nofollow" target="_blank"> package.json </a>中有两个新的npm脚本来运行集成测试。</p><pre class="nc nd ne nf gt ng nb nh ni aw nj bi"><span id="4e0e" class="mm ku ix nb b gy nk nl l nm nn">"test:integration": "ng run angular.io-example:test-integration",<br/>"test:integration:record": "POLLY_MODE=record ng run angular.io-example:test-integration"</span></pre><p id="80b3" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe my mz na nb b">test:integration:record</code>将在<code class="fe my mz na nb b">record</code>模式下运行集成测试，这意味着测试将发出实际的网络请求，然后在完成后，将记录保存为<code class="fe my mz na nb b">.har</code>文件。</p><p id="9f6d" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe my mz na nb b">test:integration</code>将在<code class="fe my mz na nb b">replay</code>模式下运行集成测试，这意味着将使用记录而不是发出实际请求。这是您将在CI/CD管道中使用的内容。</p><h2 id="47df" class="mm ku ix bd kv mn mo dn kz mp mq dp ld kf mr ms lh kj mt mu ll kn mv mw lp mx bi translated">Jest自定义环境</h2><p id="88fd" class="pw-post-body-paragraph ju jv ix jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">为了用jest设置PollyJS，我们需要使用一个定制环境<a class="ae ks" href="https://github.com/JonJam/angular_pollyjs_playground/blob/main/integration-tests/jest-integration.environment.js" rel="noopener ugc nofollow" target="_blank">jest-integration . environment . js</a>，按照这个<a class="ae ks" href="https://netflix.github.io/pollyjs/#/test-frameworks/jest-jasmine" rel="noopener ugc nofollow" target="_blank">指南</a>。</p><pre class="nc nd ne nf gt ng nb nh ni aw nj bi"><span id="9bfc" class="mm ku ix nb b gy nk nl l nm nn">// custom-environment<br/>const SetupPollyJestEnvironment = require('setup-polly-jest/jest-environment-jsdom');<br/><br/>class JestIntegrationEnvironment extends SetupPollyJestEnvironment {<br/>  constructor(config, context) {<br/>    super(config, context);<br/><br/>    // Setting up testPath global for pollyContext.ts<br/>    // Followed https://stackoverflow.com/questions/62995762/how-do-you-find-the-filename-and-path-of-a-running-test-in-jest<br/>    this.global.testPath = context.testPath;<br/>  }<br/>}<br/><br/>module.exports = JestIntegrationEnvironment;</span></pre><p id="9535" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这扩展了由<a class="ae ks" href="https://github.com/gribnoysup/setup-polly-jest" rel="noopener ugc nofollow" target="_blank">gribnoysup/setup-Polly-jest</a>提供的设置用于PollyJS配置的<code class="fe my mz na nb b">testPath</code>全局。</p><h2 id="dd8b" class="mm ku ix bd kv mn mo dn kz mp mq dp ld kf mr ms lh kj mt mu ll kn mv mw lp mx bi translated">PollyJS设置</h2><p id="1c6f" class="pw-post-body-paragraph ju jv ix jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">PollyJS在jest配置中引用的<a class="ae ks" href="https://github.com/JonJam/angular_pollyjs_playground/blob/main/integration-tests/jest/setupFilesAfterEnv/pollyContext.ts" rel="noopener ugc nofollow" target="_blank"> pollyContext.ts </a>中配置。</p><pre class="nc nd ne nf gt ng nb nh ni aw nj bi"><span id="06f9" class="mm ku ix nb b gy nk nl l nm nn">import { setupPolly } from 'setup-polly-jest';<br/>import <strong class="nb iy"><em class="lz">path </em></strong>from 'path';<br/>import {PollyConfig} from '@pollyjs/core';<br/>import {MODES} from '@pollyjs/utils';<br/><br/>function getPollyMode() : "record" | "replay" {<br/>  let mode: PollyConfig['mode'] = MODES.<em class="lz">REPLAY</em>;<br/><br/>  switch (<strong class="nb iy"><em class="lz">process</em></strong>.env['POLLY_MODE']) {<br/>    case 'record':<br/>      mode = MODES.<em class="lz">RECORD</em>;<br/>      break;<br/>    case 'replay':<br/>      mode = MODES.<em class="lz">REPLAY</em>;<br/>      break;<br/>    case 'offline':<br/>      mode = MODES.<em class="lz">REPLAY</em>;<br/>      break;<br/>  }<br/><br/>  return mode;<br/>}<br/><br/>function getDefaultRecordingDir() {<br/>  // This is setup using a custom jest environment<br/>  const testPath: string = (<strong class="nb iy"><em class="lz">global </em></strong>as any).testPath;<br/><br/>  return path.relative(<br/>    <strong class="nb iy"><em class="lz">process</em></strong>.cwd(),<br/>    `${path.dirname(testPath)}/__recordings__`,<br/>  );<br/>}<br/><br/>const pollyContext = setupPolly({<br/>    recordIfMissing: false,<br/>    mode: getPollyMode(),<br/>    // Having to use require imports due to https://github.com/gribnoysup/setup-polly-jest/issues/23<br/>    adapters: [require('@pollyjs/adapter-xhr')],<br/>    persister: require('@pollyjs/persister-fs'),<br/>    persisterOptions: {<br/>      fs: {<br/>        recordingsDir: getDefaultRecordingDir(),<br/>      },<br/>      // Improve diff readability for git. See https://netflix.github.io/pollyjs/#/configuration?id=disablesortingharentries<br/>      disableSortingHarEntries: true,<br/>    },<br/>    flushRequestsOnStop: true,<br/>    recordFailedRequests: true,<br/>    // Default level is warn. Useful to see PollyJs Recorded or Replayed logs<br/>    logLevel: 'info',<br/>    expiryStrategy: 'error',<br/>    expiresIn: '14d',<br/>    // Insulate the tests from differences in session data.<br/>    //<br/>    // See https://netflix.github.io/pollyjs/#/configuration?id=matchrequestsby for options.<br/>    matchRequestsBy: {<br/>      headers: false,<br/>      body: false,<br/>    },<br/>  });<br/><br/>beforeEach(() =&gt; {<br/>  // Grouping common requests so that they share a single recording.<br/>  //<br/>  // See https://netflix.github.io/pollyjs/#/server/route-handler?id=recordingname<br/>  //<br/>  // <em class="lz">TODO Add common requests.<br/>  </em>// pollyContext.polly.server.any('/api/example').recordingName('Example');<br/>});<br/><br/><strong class="nb iy"><em class="lz">global</em></strong>.pollyContext = pollyContext;</span></pre><p id="7070" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这是使用PollyJS中的<a class="ae ks" href="https://github.com/Netflix/pollyjs/blob/master/examples/typescript-jest-node-fetch/src/utils/auto-setup-polly.ts" rel="noopener ugc nofollow" target="_blank">类型脚本示例</a>和<a class="ae ks" href="https://github.com/spotify/polly-jest-presets/blob/master/src/pollyContext.ts" rel="noopener ugc nofollow" target="_blank">Spotify/Polly-jest-preset</a>放在一起的。</p><p id="6fb4" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我鼓励你阅读<a class="ae ks" href="https://netflix.github.io/pollyjs/#/configuration" rel="noopener ugc nofollow" target="_blank"> PollyJS配置文档</a>来理解所有的选项，但是总结一下这是在做什么:</p><ul class=""><li id="96d1" class="md me ix jw b jx jy kb kc kf mf kj mg kn mh kr no mj mk ml bi translated">它允许根据环境变量在<code class="fe my mz na nb b">record</code>和<code class="fe my mz na nb b">replay</code>模式之间切换。</li><li id="245e" class="md me ix jw b jx np kb nq kf nr kj ns kn nt kr no mj mk ml bi translated">它将网络请求和响应的记录保存到带有<code class="fe my mz na nb b">__tests__</code>目录的<code class="fe my mz na nb b">__recordings__</code>文件夹中(类似于jest快照)。</li><li id="8873" class="md me ix jw b jx np kb nq kf nr kj ns kn nt kr no mj mk ml bi translated">它每14天使记录过期一次，并在过期时导致构建出错。</li><li id="d988" class="md me ix jw b jx np kb nq kf nr kj ns kn nt kr no mj mk ml bi translated">它定义了请求匹配标准来忽略头部和主体内容。</li><li id="c6f1" class="md me ix jw b jx np kb nq kf nr kj ns kn nt kr no mj mk ml bi translated">它将指定的公共请求分组以共享单个记录。</li><li id="3e59" class="md me ix jw b jx np kb nq kf nr kj ns kn nt kr no mj mk ml bi translated">它创建了一个可以在测试中引用的全局<code class="fe my mz na nb b">pollyContext</code>。</li></ul><h2 id="98bc" class="mm ku ix bd kv mn mo dn kz mp mq dp ld kf mr ms lh kj mt mu ll kn mv mw lp mx bi translated">Jest配置</h2><p id="a4df" class="pw-post-body-paragraph ju jv ix jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated"><a class="ae ks" href="https://github.com/JonJam/angular_pollyjs_playground/blob/main/integration-tests/jest-integration.config.js" rel="noopener ugc nofollow" target="_blank">jest-integration . config . js</a>参考前面提到的一些文件，为集成测试配置jest环境。</p><pre class="nc nd ne nf gt ng nb nh ni aw nj bi"><span id="6ae1" class="mm ku ix nb b gy nk nl l nm nn">// This is merged with default config as per https://github.com/just-jeb/angular-builders/tree/master/packages/jest#builder-options<br/><br/>// Test environment copied from: https://netflix.github.io/pollyjs/#/test-frameworks/jest-jasmine?id=supported-test-runners<br/>module.exports = {<br/>  testEnvironment: "&lt;rootDir&gt;/integration-tests/jest-integration.environment.js",<br/>  testMatch: ["&lt;rootDir&gt;/integration-tests/__tests__/**/*.spec.ts"],<br/>  setupFilesAfterEnv: [<br/>    "&lt;rootDir&gt;/integration-tests/jest/setupFilesAfterEnv/pollyContext.ts",<br/>  ]<br/>};</span></pre><h2 id="c3d4" class="mm ku ix bd kv mn mo dn kz mp mq dp ld kf mr ms lh kj mt mu ll kn mv mw lp mx bi translated">utils/testUtils.ts</h2><p id="d3bd" class="pw-post-body-paragraph ju jv ix jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated"><a class="ae ks" href="https://github.com/JonJam/angular_pollyjs_playground/blob/main/integration-tests/utils/testUtils.ts" rel="noopener ugc nofollow" target="_blank"> testUtil.ts </a>包含助手功能，例如启动应用程序和导航到初始页面，这些功能在集成测试中被重用。</p><pre class="nc nd ne nf gt ng nb nh ni aw nj bi"><span id="5d7b" class="mm ku ix nb b gy nk nl l nm nn">import {createRoutingFactory, SpectatorRouting} from '@ngneat/spectator/jest';<br/>import {<strong class="nb iy"><em class="lz">TestBed</em></strong>} from '@angular/core/testing';<br/>import {NgZone} from '@angular/core';<br/><br/>import {AppComponent} from '../../src/app/app.component';<br/>import {AppModule} from '../../src/app/app.module';<br/><br/>const createComponent = createRoutingFactory({<br/>  component: AppComponent,<br/>  imports: [AppModule],<br/>  // Setting to false as per https://ngneat.github.io/spectator/docs/testing-with-routing#integration-testing-with-routertestingmodule<br/>  // to perform an integration test.<br/>  stubsEnabled: false,<br/>  detectChanges: false<br/>});<br/><br/>function startApp() : SpectatorRouting&lt;AppComponent&gt; {<br/>  // Create app<br/>  return createComponent();<br/>}<br/><br/>async function navigateToInitialPage(spectator: SpectatorRouting&lt;AppComponent&gt;, url: string) : Promise&lt;void&gt; {<br/>  // Navigate to page under test<br/>  const ngZone = <strong class="nb iy"><em class="lz">TestBed</em></strong>.inject(NgZone);<br/>  await ngZone.run(async () =&gt; {<br/>    await spectator.router.navigateByUrl(url);<br/>  });<br/><br/>  // Wait for any HTTP and UI updates<br/>  await <strong class="nb iy"><em class="lz">global</em></strong>.pollyContext.polly.flush();<br/>  spectator.detectChanges();<br/>}<br/><br/>export { startApp, navigateToInitialPage };</span></pre><h1 id="bc60" class="kt ku ix bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">把所有的放在一起</h1><p id="c7cb" class="pw-post-body-paragraph ju jv ix jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">让我们用一个示例测试来实践这一点:<a class="ae ks" href="https://github.com/JonJam/angular_pollyjs_playground/blob/main/integration-tests/__tests__/heroes.spec.ts" rel="noopener ugc nofollow" target="_blank"> heroes.spec.ts </a>。</p><pre class="nc nd ne nf gt ng nb nh ni aw nj bi"><span id="3822" class="mm ku ix nb b gy nk nl l nm nn">import {<strong class="nb iy"><em class="lz">byRole</em></strong>} from '@ngneat/spectator/jest';<br/><br/>import {navigateToInitialPage, startApp} from '../utils/testUtils';<br/><br/>describe('Heroes', () =&gt; {<br/>  it('renders a list of heroes', async () =&gt; {<br/>    // Start app and navigate to heroes page<br/>    const spectator = startApp();<br/>    const url = `heroes`;<br/>    await navigateToInitialPage(spectator, url);<br/><br/>    // Update view with heroes data<br/>    await <strong class="nb iy"><em class="lz">global</em></strong>.pollyContext.polly.flush();<br/>    spectator.detectChanges();<br/><br/>    // ASSERT<br/>    const heroes : HTMLLIElement[] = spectator.queryAll(<strong class="nb iy"><em class="lz">byRole</em></strong>('listitem'));<br/><br/>    const linkContents = heroes.map(li =&gt; {<br/>      const link = li.querySelector('a');<br/><br/>      if (link === null || link.textContent === null) {<br/>        return "";<br/>      }<br/><br/>      return link.textContent.trim();<br/><br/>    });<br/><br/>    const expected =  [<br/>      '1 Leanne Graham',<br/>      '2 Ervin Howell',<br/>      '3 Clementine Bauch',<br/>      '4 Patricia Lebsack',<br/>      '5 Chelsey Dietrich',<br/>      '6 Mrs. Dennis Schulist',<br/>      '7 Kurtis Weissnat',<br/>      '8 Nicholas Runolfsdottir V',<br/>      '9 Glenna Reichert',<br/>      '10 Clementina DuBuque'<br/>    ];<br/><br/>    expect(linkContents).toEqual(expect.arrayContaining(expected));<br/>  });<br/>});</span></pre><p id="56d3" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这项测试:</p><ul class=""><li id="7d61" class="md me ix jw b jx jy kb kc kf mf kj mg kn mh kr no mj mk ml bi translated">启动应用程序。</li><li id="3859" class="md me ix jw b jx np kb nq kf nr kj ns kn nt kr no mj mk ml bi translated">导航到<code class="fe my mz na nb b">/heroes</code>。</li><li id="5d9e" class="md me ix jw b jx np kb nq kf nr kj ns kn nt kr no mj mk ml bi translated">等待网络请求和UI更新。</li><li id="e53d" class="md me ix jw b jx np kb nq kf nr kj ns kn nt kr no mj mk ml bi translated">断言显示预期的列表。</li></ul><p id="a5c5" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">首先，我们使用<code class="fe my mz na nb b">test:integration:record</code>创建记录来运行这个测试。</p><pre class="nc nd ne nf gt ng nb nh ni aw nj bi"><span id="79fd" class="mm ku ix nb b gy nk nl l nm nn">➜  angular_pollyjs_playground git:(main) yarn test:integration:record<br/>yarn run v1.22.15<br/>$ POLLY_MODE=record ng run angular.io-example:test-integration<br/>Warning: 'no-cache' option has been declared with a 'no' prefix in the schema.Please file an issue with the author of this package.<br/>Warning: 'noStackTrace' option has been declared with a 'no' prefix in the schema.Please file an issue with the author of this package.<br/>Determining test suites to run...<br/>ngcc-jest-processor: running ngcc<br/>Request: GET <a class="ae ks" href="https://jsonplaceholder.typicode.com/users" rel="noopener ugc nofollow" target="_blank">https://jsonplaceholder.typicode.com/users</a><br/>Response: Recorded ➞ GET <a class="ae ks" href="https://jsonplaceholder.typicode.com/users" rel="noopener ugc nofollow" target="_blank">https://jsonplaceholder.typicode.com/users</a> 200 • 447ms<br/> PASS  integration-tests/__tests__/heroes.spec.ts (8.964 s)<br/>  Heroes<br/>    ✓ renders a list of heroes (502 ms)</span><span id="22b7" class="mm ku ix nb b gy nu nl l nm nn">Test Suites: 1 passed, 1 total<br/>Tests:       1 passed, 1 total<br/>Snapshots:   0 total<br/>Time:        15.446 s<br/>Ran all test suites.<br/>✨  Done in 32.81s.</span></pre><p id="d953" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">PollyJS日志有助于显示记录了哪些请求和响应。现在我们已经有了一些记录，我们可以在<code class="fe my mz na nb b">replay</code>模式下运行<code class="fe my mz na nb b">test:integration</code>:</p><pre class="nc nd ne nf gt ng nb nh ni aw nj bi"><span id="b238" class="mm ku ix nb b gy nk nl l nm nn">➜  angular_pollyjs_playground git:(main) ✗ yarn test:integration       <br/>yarn run v1.22.15<br/>$ ng run angular.io-example:test-integration<br/>Warning: 'no-cache' option has been declared with a 'no' prefix in the schema.Please file an issue with the author of this package.<br/>Warning: 'noStackTrace' option has been declared with a 'no' prefix in the schema.Please file an issue with the author of this package.<br/>Determining test suites to run...<br/>ngcc-jest-processor: running ngcc<br/>Request: GET <a class="ae ks" href="https://jsonplaceholder.typicode.com/users" rel="noopener ugc nofollow" target="_blank">https://jsonplaceholder.typicode.com/users</a><br/>Response: Replayed ➞ GET <a class="ae ks" href="https://jsonplaceholder.typicode.com/users" rel="noopener ugc nofollow" target="_blank">https://jsonplaceholder.typicode.com/users</a> 200 • 2ms<br/> PASS  integration-tests/__tests__/heroes.spec.ts<br/>  Heroes<br/>    ✓ renders a list of heroes (53 ms)</span><span id="5722" class="mm ku ix nb b gy nu nl l nm nn">Test Suites: 1 passed, 1 total<br/>Tests:       1 passed, 1 total<br/>Snapshots:   0 total<br/>Time:        2.087 s, estimated 9 s<br/>Ran all test suites.<br/>✨  Done in 4.55s.</span></pre><p id="7a5d" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">那都是乡亲:)</p></div><div class="ab cl nv nw hu nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="ij ik il im in"><h1 id="a5a5" class="kt ku ix bd kv kw oc ky kz la od lc ld le oe lg lh li of lk ll lm og lo lp lq bi translated">逮到你了</h1><p id="0946" class="pw-post-body-paragraph ju jv ix jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">当我真正这么做的时候，我遇到了一些可能有用的事情。</p><h2 id="3a3a" class="mm ku ix bd kv mn mo dn kz mp mq dp ld kf mr ms lh kj mt mu ll kn mv mw lp mx bi translated">具有自签名证书的服务器</h2><p id="e37c" class="pw-post-body-paragraph ju jv ix jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">如果你的测试运行在一个使用自签名证书的后端，你可能会遇到测试失败的错误，比如<code class="fe my mz na nb b">Error: self signed certificate</code>。</p><p id="9163" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了解决这个问题，我发现了这个<a class="ae ks" href="https://github.com/facebook/jest/issues/8449#issuecomment-781661413" rel="noopener ugc nofollow" target="_blank">玩笑问题</a>，并采取了以下措施:</p><ul class=""><li id="9be3" class="md me ix jw b jx jy kb kc kf mf kj mg kn mh kr no mj mk ml bi translated">从jest复制<code class="fe my mz na nb b">JSDOMEnvironment</code>(确保复制正确的版本)到应用程序中。</li><li id="87ae" class="md me ix jw b jx np kb nq kf nr kj ns kn nt kr no mj mk ml bi translated">修改了类构造函数中的<code class="fe my mz na nb b">JSDOM </code>构造，以在创建<code class="fe my mz na nb b">ResourceLoader.</code>时指定<code class="fe my mz na nb b">strictSSL:false</code></li><li id="a5f3" class="md me ix jw b jx np kb nq kf nr kj ns kn nt kr no mj mk ml bi translated">更改<code class="fe my mz na nb b">jest-integration.environment.js</code>以使用该自定义<code class="fe my mz na nb b">JSDOMEnvironment.</code></li></ul><h2 id="7794" class="mm ku ix bd kv mn mo dn kz mp mq dp ld kf mr ms lh kj mt mu ll kn mv mw lp mx bi translated">ng neat/观众和活动路线</h2><p id="7cbd" class="pw-post-body-paragraph ju jv ix jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">通常为了获得Angular中的活动路径，我们使用<a class="ae ks" href="https://angular.io/api/router/ActivatedRoute" rel="noopener ugc nofollow" target="_blank">ActivatedRoute</a>；但是当使用ngneat/spectator的<code class="fe my mz na nb b">createRoutingFactory</code>(即使有<code class="fe my mz na nb b">stubsEnabled: false)</code>值也是存根<code class="fe my mz na nb b">ActivatedRouteStub</code>；你可以在这里看到代码<a class="ae ks" href="https://github.com/ngneat/spectator/blob/master/projects/spectator/src/lib/spectator-routing/create-factory.ts#L68" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="1904" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这给测试中的应用程序带来了问题，因为某些功能没有实现(访问<code class="fe my mz na nb b">snapshot</code>和<code class="fe my mz na nb b">firstchild</code>属性)。</p><p id="b927" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一个解决方法是使用<code class="fe my mz na nb b">router.routerstate.root</code>而不是<code class="fe my mz na nb b">ActivatedRoute</code>，因为这是Angular在内部使用的(参见<a class="ae ks" href="https://github.com/angular/angular/blob/14.2.3/packages/router/src/router_module.ts#L50" rel="noopener ugc nofollow" target="_blank"> router_module </a>和<a class="ae ks" href="https://github.com/angular/angular/blob/14.2.3/packages/router/src/provide_router.ts" rel="noopener ugc nofollow" target="_blank"> provide_router </a>)。</p><h2 id="acb1" class="mm ku ix bd kv mn mo dn kz mp mq dp ld kf mr ms lh kj mt mu ll kn mv mw lp mx bi translated">相对请求的基本URL</h2><p id="3a9a" class="pw-post-body-paragraph ju jv ix jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">测试中的应用程序使用了相对请求，即<code class="fe my mz na nb b">/api/example</code>，因为它希望在与API相同的域中运行。</p><p id="9208" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">当作为集成测试运行时，我发现正在向<code class="fe my mz na nb b">https://github.com/just-jeb/angular-builders/api/example</code>发出请求。</p><p id="f125" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了解决这个问题，我必须在<code class="fe my mz na nb b">jest-integration.config.js</code>中添加以下内容来设置基本url:</p><pre class="nc nd ne nf gt ng nb nh ni aw nj bi"><span id="5c1c" class="mm ku ix nb b gy nk nl l nm nn">testEnvironmentOptions: {<br/>  url: "https://localhost",<br/>},</span></pre></div></div>    
</body>
</html>