<html>
<head>
<title>How to secure Azure Functions API with IdentityServer4.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用IdentityServer4保护Azure Functions API？</h1>
<blockquote>原文：<a href="https://itnext.io/secure-function-with-identityserver-3f414a28c92f?source=collection_archive---------1-----------------------#2019-10-23">https://itnext.io/secure-function-with-identityserver-3f414a28c92f?source=collection_archive---------1-----------------------#2019-10-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3289" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">有自定义处理程序，没有Azure API管理。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2c91dca1e51eaa20a388a020170a58f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q6ceMhKmz-PKEOxQmxogjQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">来自<a class="ae ky" href="https://www.pexels.com/photo/antique-close-up-equipment-hanging-615350/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">像素</a>的<a class="ae ky" href="https://www.pexels.com/@skitterphoto?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">摄影记者</a>的照片。</figcaption></figure><p id="fb01" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Azure函数在安全性和身份验证方面有丰富的功能，但自定义身份验证的选项有限。并且您必须创建自己的JWT令牌处理程序，以便与基于Identity Server 4的提供者一起工作。网上有几篇关于这个主题的文章，但是没有一篇完全符合我的需求，所以我决定也分享一下我的解决方案。</p><blockquote class="lv lw lx"><p id="66cf" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">TLDR；我将解释如何验证由Identity Server 4发布的承载令牌。我将分享一个处理程序的代码示例，该处理程序通过JWKS端点或本地键值来验证令牌签名和受众。</p></blockquote><p id="b1b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我想强调的是，验证请求的正确且昂贵的方法是使用Azure API管理外观。虽然有一个无服务器的API管理层，但它在功能和冷启动方面有很大的局限性。</p><p id="e6a8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">更新2020–06–05:我对这篇文章有一个跟进:<a class="ae ky" href="https://medium.com/microsoftazure/secure-functions-apim-identityserver4-4b6f62d773b0" rel="noopener">用API管理和身份服务器保护Azure函数4 </a></p></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h2 id="4166" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">Azure应用服务中的身份验证选项</h2><p id="8244" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">平台选项包括Azure AD和四个EasyAuth提供商，如脸书、谷歌、Twitter和一个微软账户。它们可以通过Azure门户应用服务配置进行身份验证/授权。</p><blockquote class="lv lw lx"><p id="ec33" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">有一种通过自定义Azure AD对话框添加Identity Server 4端点的简单方法，但我强烈建议不要这样做。平台行为随时可能改变，这是一条通向灾难的高速公路。</p></blockquote><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/b04e39505488c6cb23d72380f9a8737a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XreCAl7dJj0iVakBgnBsvA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">应用服务支持的身份验证提供程序。</figcaption></figure></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h2 id="d2e8" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">功能级身份验证选项</h2><p id="d3aa" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">功能代码级别有几种可用的授权级别。</p><ul class=""><li id="b5df" class="ni nj it lb b lc ld lf lg li nk lm nl lq nm lu nn no np nq bi translated">匿名-接受所有请求。</li><li id="2175" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated">函数-函数代码应该通过请求参数传递。</li><li id="b881" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated">Admin -任何主机密钥都必须通过请求参数传递。</li><li id="10a2" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated">系统-主密钥必须通过请求参数传递。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/60801e37638583bba7b7c65c33f0043a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/format:webp/1*yjyygsgdl0ZTIssSx7tK2g.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">带有认证密钥的功能管理页面。</figcaption></figure></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h2 id="6353" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">身份服务器。</h2><p id="d8c5" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">Identity Server 4完全实现了OIDC规范，通常有中间件为您验证令牌，但函数不是这样。因此，让我们回忆一下需要检查什么——不记名令牌签名、发行者和受众。该信息可以从任何OIDC兼容提供商的发现端点获得。</p><blockquote class="lv lw lx"><p id="378a" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">发现端点可用于检索关于您的身份服务器的元数据—它返回诸如发布者名称、密钥材料、支持的范围等信息。<a class="ae ky" href="https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration" rel="noopener ugc nofollow" target="_blank">举例</a>。</p></blockquote><p id="5fbb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您访问该端点时，可以找到各种信息，但最重要的是到JWKS端点的链接。因为您可以在那里找到RSA密钥的开放部分，它用于令牌加密。</p><blockquote class="lv lw lx"><p id="bd15" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">JSON Web密钥集(JWKS)是一组包含公钥的密钥，应该使用这些公钥来验证由授权服务器发布的任何JSON Web令牌(JWT)。<a class="ae ky" href="https://login.microsoftonline.com/common/discovery/v2.0/keys" rel="noopener ugc nofollow" target="_blank">举例</a>。</p></blockquote><p id="6a23" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后要回忆的是，为什么需要进行受众检查，因为不同的应用程序可以在同一个Identity Server上注册。因此，有必要检查客户端是否有权访问这个特定的应用程序。</p><blockquote class="lv lw lx"><p id="e61a" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">代币的受众是代币的预期接收者。</p></blockquote></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h2 id="bcdc" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">解决方案。</h2><p id="8edc" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">行动步骤非常简单。</p><ul class=""><li id="94a7" class="ni nj it lb b lc ld lf lg li nk lm nl lq nm lu nn no np nq bi translated">在函数中启用匿名身份验证。</li><li id="22fb" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated">从JWKS端点或本地配置中检索证书签名。</li><li id="6b44" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated">为令牌验证添加自定义处理程序。</li><li id="8450" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated">通过邮递员在本地测试解决方案，并进行试运行。</li><li id="0c1b" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated">在功能App上设置每日记忆时间配额。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/d05c3025b8d007b77ddb610e63d70498.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C7XCQQkN2R7HipjWt2QJJQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">具有匿名授权级别的Azure函数。</figcaption></figure><p id="c572" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，功能授权级别是匿名的，因此您应该<strong class="lb iu">将每日内存时间配额</strong>设置为功能App的预计GB/s值。并为过度的应用程序使用创建警报。否认钱包攻击是真事。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/0b552e56d5dee1e9c1d5db34cc324d91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1382/format:webp/1*dGx6dojC4GE9uJjgDIKaEA.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">通过平台功能设置配额= &gt;功能app设置。</figcaption></figure><p id="350e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以使用Azure CLI进行每日内存配额设置。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/c887857e42ef184cbfa8b33491d2a0b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5agI82-OQVsRx3KS"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">设置配额的Azure CLI命令。</figcaption></figure><p id="0d0e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以，让我们从依赖注入开始。令牌签名可以通过JWKS endpoint公开获得，因此您可以将它嵌入到应用程序配置中，以避免额外的HTTP请求。而且最好把所有秘密都放在Azure KeyVault里，方便轮换和安全。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="cab9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们继续使用一个密钥检索器助手。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="6764" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的方法有问题。当您向KeyVault添加签名密钥时，您可能会错过将来更新密钥的时刻。为了避免这个问题，下面的方法将通过HTTP请求从JWKS端点获取数据。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="cfcb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">令牌验证的功能代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h2 id="c2f5" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">结论。</h2><p id="7bcf" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">这是一个混合袋解决方案，但它会做到这一点。我将在下一篇文章中继续身份验证主题，通过Azure API管理来讨论不记名令牌验证。</p><p id="e72e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">就这些，感谢阅读。干杯！</strong></p><p id="d9af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">PS。还有更多选项，如OIDC发现端点处理程序和下面的参考tokes - links。</p></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><p id="b7d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">有用的链接。</strong></p><ul class=""><li id="78b7" class="ni nj it lb b lc ld lf lg li nk lm nl lq nm lu nn no np nq bi translated"><a class="ae ky" href="https://www.jerriepelser.com/blog/manually-validating-rs256-jwt-dotnet/" rel="noopener ugc nofollow" target="_blank">使用手动验证JWT。Jerrie Pelser的NET </a>。</li><li id="dc57" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated"><a class="ae ky" href="https://www.ben-morris.com/custom-token-authentication-in-azure-functions-using-bindings/" rel="noopener ugc nofollow" target="_blank">Azure Functions中的自定义令牌认证</a>Ben Morris。</li><li id="e6f2" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated"><a class="ae ky" href="https://blog.wille-zone.de/post/protecting-http-triggered-azure-functions/" rel="noopener ugc nofollow" target="_blank">保护HTTP触发的Azure功能</a>。</li><li id="8bd2" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated">Shawn Meyer的RS256和JWKS导航。</li><li id="3bc2" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated"><a class="ae ky" href="https://blogs.msdn.microsoft.com/stuartleeks/2018/02/19/azure-functions-and-app-service-authentication/" rel="noopener ugc nofollow" target="_blank"> Azure功能和App服务认证</a>。</li><li id="f63a" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated">文森特-菲利普·劳宗著<a class="ae ky" href="https://vincentlauzon.com/2017/12/04/azure-functions-http-authorization-levels/" rel="noopener ugc nofollow" target="_blank"> Azure Functions HTTP —授权级别。</a></li><li id="d1e5" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated"><a class="ae ky" href="https://identitymodel.readthedocs.io/en/latest/client/discovery.html" rel="noopener ugc nofollow" target="_blank">发现端点上的身份模型文档</a>。</li><li id="9b5a" class="ni nj it lb b lc nr lf ns li nt lm nu lq nv lu nn no np nq bi translated"><a class="ae ky" href="http://docs.identityserver.io/en/latest/topics/reference_tokens.html" rel="noopener ugc nofollow" target="_blank">参考令牌文档</a>。</li></ul></div></div>    
</body>
</html>