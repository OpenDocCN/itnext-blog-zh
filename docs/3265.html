<html>
<head>
<title>Validated builds using CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用CircleCI验证构建</h1>
<blockquote>原文：<a href="https://itnext.io/validated-builds-using-circleci-28eaeb15987d?source=collection_archive---------4-----------------------#2019-11-08">https://itnext.io/validated-builds-using-circleci-28eaeb15987d?source=collection_archive---------4-----------------------#2019-11-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="5b2a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于CircleCI是市场上最受欢迎的CI/CD工具之一，我们最近收到大量请求并不奇怪。用户在我们的博客帖子中注意到了<a class="ae kl" href="https://www.codenotary.io/securing-your-azure-devops-ecosystem-jenkins-and-kubernetes-aks-using-codenotary-part-1/" rel="noopener ugc nofollow" target="_blank">詹金斯</a>的整合，我们想知道CircleCI会是什么样子。</p><p id="1769" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们听取了意见，CircleCI集成产生了可以被任何地方的任何人验证和认证的有效构建。</p><p id="72be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的博客文章涵盖了生成经验证的构建所需的所有步骤:</p><ul class=""><li id="f7b6" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">以一个现有的Git存储库为例</li><li id="41cc" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">创建Circle CI配置</li><li id="74da" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">定义Circle CI构建步骤</li><li id="c40e" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">下载最新的code公证人vcn命令行</li><li id="74f8" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">验证下载的二进制文件(安全比遗憾好)</li><li id="dd18" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">建立docker形象</li><li id="2206" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">公证包括Circle CI构建号的docker图像</li><li id="837e" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">将docker映像部署到Dockerhub</li><li id="d639" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">验证上传的docker图像</li></ul><h1 id="855e" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">设置</h1><h1 id="8bcb" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">创建或派生存储库</h1><p id="054b" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">让我们从git存储库的设置开始，它包含一个简单静态网站项目的分支。【https://github.com/katacoda/golang-http-server T4】</p><p id="6904" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于我们的例子，repo包含一个有效的Dockerfile来构建容器映像是很重要的。</p><p id="8b9e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们分叉该项目后，我们需要添加Circle CI构建配置。</p><h1 id="968c" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">创建循环CI配置</h1><p id="bf2d" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">为此，只需在。分叉存储库中的circleci文件夹。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi md"><img src="../Images/88c88ab699ad52c7ea881911a6870211.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jJbyLJKGRMHei597.png"/></div></div></figure><h1 id="d076" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">定义Circle CI步骤以创建经验证的构建</h1><p id="7247" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">该config.yml文件的内容包含了构建所需的所有步骤:</p><p id="e124" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">常规构建设置</p><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="da08" class="mu lb iq mq b gy mv mw l mx my">version: 2<br/>jobs:<br/>  build:<br/>    docker:<br/>      - image: golang:1.13.4-stretch<br/>    environment:<br/>      TEST_RESULTS: /tmp/test-results<br/>    steps:<br/>      - checkout<br/>      - setup_remote_docker</span></pre><h2 id="f0bd" class="mu lb iq bd lc mz na dn lg nb nc dp lk jy nd ne lo kc nf ng ls kg nh ni lw nj bi translated">准备远程docker客户端</h2><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="beed" class="mu lb iq mq b gy mv mw l mx my"># This should go into custom primary image, here's only for the sake of explanation<br/>      - run:<br/>          name: Install Docker client<br/>          command: |<br/>            set -x<br/>            VER="17.03.0-ce"<br/>            curl -L -o /tmp/docker-$VER.tgz https://get.docker.com/builds/Linux/x86_64/docker-$VER.tgz<br/>            tar -xz -C /tmp -f /tmp/docker-$VER.tgz<br/>            mv /tmp/docker/* /usr/bin</span></pre><p id="898f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下载最新的code公证人vcn命令行</p><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="d35b" class="mu lb iq mq b gy mv mw l mx my">- run:<br/>          name: Download CodeNotary vcn binary<br/>          command: |<br/>            set -x<br/>            VER="v0.7.3"<br/>            curl -L -o /tmp/vcn https://github.com/vchain-us/vcn/releases/download/v0.7.3/vcn-$VER-linux-amd64<br/>            CHECKSUM=$(sha256sum /tmp/vcn | cut -d " " -f 1)<br/>            curl -s https://api.codenotary.io/authenticate/$CHECKSUM?org=vchain.us | grep -q :0</span></pre><p id="fae5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该代码片段的重要部分是下载最新版本(请确保相应地更改版本)，独立计算文件校验和以进行验证。<a class="ae kl" href="https://www.codenotary.io" rel="noopener ugc nofollow" target="_blank">code公证人</a>验证确保下载的二进制文件确实经过了vcn cli的制作者<a class="ae kl" href="https://www.vchain.us" rel="noopener ugc nofollow" target="_blank"> vchain.us </a>的公证:</p><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="6ac0" class="mu lb iq mq b gy mv mw l mx my">curl -s https://api.codenotary.io/authenticate/$CHECKSUM?org=vchain.us | grep -q :0</span></pre><p id="3f2c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当校验和可以被验证并且已经被给定的组织公证时，退出代码总是0(成功)。</p><p id="fc55" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">这样，我们可以确认我们不会使用伪造或篡改的vcn！</strong>如果无法验证，则管道断开。</p><h2 id="f1bb" class="mu lb iq bd lc mz na dn lg nb nc dp lk jy nd ne lo kc nf ng ls kg nh ni lw nj bi translated">将vcn二进制文件移动到路径中，并使其可执行</h2><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="8e86" class="mu lb iq mq b gy mv mw l mx my">- run:<br/>          name: move CodeNotary vcn binary<br/>          command: |<br/>            chmod +x /tmp/vcn<br/>            mv /tmp/vcn /usr/local/bin/vcn</span></pre><h2 id="1ac5" class="mu lb iq bd lc mz na dn lg nb nc dp lk jy nd ne lo kc nf ng ls kg nh ni lw nj bi translated">建立docker形象</h2><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="0e6a" class="mu lb iq mq b gy mv mw l mx my">- run:<br/>          name: Build Docker image<br/>          command: |<br/>            TAG="0.1.${CIRCLE_BUILD_NUM}"<br/>            docker build -t codenotarydemo/demowebserver:$TAG .</span></pre><h2 id="9c96" class="mu lb iq bd lc mz na dn lg nb nc dp lk jy nd ne lo kc nf ng ls kg nh ni lw nj bi translated">公证包括Circle CI构建号的docker图像</h2><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="5667" class="mu lb iq mq b gy mv mw l mx my">- run:<br/>          name: Notarize Docker image<br/>          command: |<br/>            TAG="0.1.${CIRCLE_BUILD_NUM}"<br/>            VCN_USER=${codenotary_user} VCN_PASSWORD=${codenotary_pass} vcn login<br/>            VCN_NOTARIZATION_PASSWORD=${codenotary_pass} vcn n --attr CircleCI=$TAG docker://codenotarydemo/demowebserver:$TAG</span></pre><p id="0962" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这项工作确保docker图像在上传Dockerhub之前经过公证，所以没有人可以干预。为了增加安全性，我们还在公证过程中添加了CircleCI内部版本号。</p><p id="57e7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，我们在该步骤中使用了不同的环境变量，这些变量需要在Circle CI中定义。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi md"><img src="../Images/f10f9d0ccf02b646c8fcdb0c0bdb0f16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GACMkt7Pk73XXsui.png"/></div></div></figure><h2 id="8e06" class="mu lb iq bd lc mz na dn lg nb nc dp lk jy nd ne lo kc nf ng ls kg nh ni lw nj bi translated">将docker映像部署到Dockerhub</h2><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="6bbe" class="mu lb iq mq b gy mv mw l mx my">- run:<br/>          name: Push Docker image<br/>          command: |<br/>            TAG="0.1.${CIRCLE_BUILD_NUM}"<br/>            docker login -u ${docker_user} -p ${docker_pass}<br/>            docker push codenotarydemo/demowebserver:$TAG</span></pre><p id="0c3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">管道的最后一步是确保使用正确的标签将新构建的docker容器映像上传到我们的DockerHub.com存储库中。请确保也为DockerHub设置Circle CI环境变量。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi md"><img src="../Images/61af969606c0bfd13dba9fad92255004.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EopD9VZZ38soS8Wh.png"/></div></div></figure><h1 id="36d6" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">结果</h1><p id="244b" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">让我们将所有部分放在一起，形成一个完整的Circle CI构建流程。circleci/config.yml)</p><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="2364" class="mu lb iq mq b gy mv mw l mx my">version: 2<br/>jobs:<br/>  build:<br/>    docker:<br/>      - image: golang:1.13.4-stretch<br/>    environment:<br/>      TEST_RESULTS: /tmp/test-results<br/><br/>    steps:<br/>      - checkout<br/>      - setup_remote_docker<br/><br/>      # This should go into custom primary image, here's only for the sake of explanation<br/>      - run:<br/>          name: Install Docker client<br/>          command: |<br/>            set -x<br/>            VER="17.03.0-ce"<br/>            curl -L -o /tmp/docker-$VER.tgz https://get.docker.com/builds/Linux/x86_64/docker-$VER.tgz<br/>            tar -xz -C /tmp -f /tmp/docker-$VER.tgz<br/>            mv /tmp/docker/* /usr/bin<br/><br/>      - run:<br/>          name: Download CodeNotary vcn binary<br/>          command: |<br/>            set -x<br/>            VER="v0.7.3"<br/>            curl -L -o /tmp/vcn https://github.com/vchain-us/vcn/releases/download/v0.7.3/vcn-$VER-linux-amd64<br/>            CHECKSUM=$(sha256sum /tmp/vcn | cut -d " " -f 1)<br/>            curl -s https://api.codenotary.io/authenticate/$CHECKSUM?org=vchain.us | grep -q :0<br/><br/>      - run:<br/>          name: Authenticate and move CodeNotary vcn binary<br/>          command: |<br/>            chmod +x /tmp/vcn<br/>            mv /tmp/vcn /usr/local/bin/vcn<br/><br/>      - run:<br/>          name: Build Docker image<br/>          command: |<br/>            TAG="0.1.${CIRCLE_BUILD_NUM}"<br/>            docker build -t codenotarydemo/demowebserver:$TAG .<br/><br/>      - run:<br/>          name: Notarize Docker image<br/>          command: |<br/>            TAG="0.1.${CIRCLE_BUILD_NUM}"<br/>            VCN_USER=${codenotary_user} VCN_PASSWORD=${codenotary_pass} vcn login<br/>            VCN_NOTARIZATION_PASSWORD=${codenotary_pass} vcn n --attr CircleCI=$TAG docker://codenotarydemo/demowebserver:$TAG <br/><br/>      - run:<br/>          name: Push Docker image<br/>          command: |<br/>            TAG="0.1.${CIRCLE_BUILD_NUM}"<br/>            docker login -u ${docker_user} -p ${docker_pass}<br/>            docker push codenotarydemo/demowebserver:$TAG</span></pre><p id="979e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当一切顺利时，您应该看到构建过程从您的config.yml更改开始，一切都在运行。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi md"><img src="../Images/816e26192a7225ef4802bae4fc722d0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rR-IRplhAST5DKeC.png"/></div></div></figure><h1 id="842e" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">验证上传的docker图像</h1><p id="b10b" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">因为这是第一次运行，所以让我们确保图像的公证进行得很顺利，并且世界上的任何人都能够验证构建。</p><p id="fe9d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，让我们将上传的映像拉至一个完全不同的系统，并使用<a class="ae kl" href="https://github.com/vchain-us/vcn" rel="noopener ugc nofollow" target="_blank"> vcn来验证所有信息</a>。</p><p id="5fce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">docker pull codenotary demo/demowebserver:0 . 1 . 4</strong><strong class="jp ir">vcn认证docker://codenotary demo/demowebserver:0 . 1 . 4</strong></p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nk"><img src="../Images/77e6c30dd2a26e38558d6a190c87c70e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MULQT-6phR8-unoR.png"/></div></div></figure><p id="32fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所有检查都是成功的，我们肯定不会发布任何软件、容器映像或其他无法验证的工件。</p><p id="ce93" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您对安全性、DevSecOps和构建验证很认真，那么就没有借口了，因为它是免费的:</p></div><div class="ab cl nl nm hu nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="ij ik il im in"><p id="8226" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ns">原载于2019年11月8日</em><a class="ae kl" href="https://www.codenotary.io/validated-builds-using-circleci-ci-cd/" rel="noopener ugc nofollow" target="_blank"><em class="ns">https://www . code公证人. io </em> </a> <em class="ns">。</em></p></div></div>    
</body>
</html>