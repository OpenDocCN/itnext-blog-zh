<html>
<head>
<title>Application Observability in Kubernetes with Datadog APM and Logging — A simple and actionable example</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Datadog APM和日志记录在Kubernetes中观察应用程序——一个简单可行的示例</h1>
<blockquote>原文：<a href="https://itnext.io/application-observability-in-kubernetes-with-datadog-apm-and-logging-a-simple-and-actionable-790ee8aefe29?source=collection_archive---------6-----------------------#2019-05-13">https://itnext.io/application-observability-in-kubernetes-with-datadog-apm-and-logging-a-simple-and-actionable-790ee8aefe29?source=collection_archive---------6-----------------------#2019-05-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class="gl gn jq jr js ab cb"><figure class="jt ju jv jw jx jy jz paragraph-image"><img src="../Images/20e523061fcc7e75a7be03daa8d3e869.png" data-original-src="https://miro.medium.com/v2/resize:fit:632/format:webp/1*jJZocPhCFg8nDxlLosB_OQ.png"/></figure><figure class="jt ju kc jw jx jy jz paragraph-image"><img src="../Images/0c0d1448015a2dd684ca2ef3a8776d26.png" data-original-src="https://miro.medium.com/v2/resize:fit:418/format:webp/1*L9-xA9iVLBNg-a4ic_f6hw.png"/></figure></div><p id="7102" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">去年我与Istio和Jaeger 分享了一个如何在Kuberntes中实现<a class="ae lb" rel="noopener ugc nofollow" target="_blank" href="/when-istio-meets-jaeger-an-example-of-end-to-end-distributed-tracing-2c136eb335eb">应用追踪的例子。在那之后，业界在这方面取得了一些实质性的进展，结果我们看到了更多的供应商支持。在Buffer中，由于我们主要使用</a><a class="ae lb" href="https://www.datadoghq.com/" rel="noopener ugc nofollow" target="_blank"> Datadog </a>进行Kubernetes和应用程序监控，因此只需要使用<a class="ae lb" href="https://docs.datadoghq.com/tracing/" rel="noopener ugc nofollow" target="_blank"> Datadog APM </a>和<a class="ae lb" href="https://docs.datadoghq.com/logs/" rel="noopener ugc nofollow" target="_blank">日志</a>来完成这个循环。我有机会为团队创造了一个小例子，并非常乐意与社区分享。</p><p id="1b6d" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">好了，事不宜迟，我们开始吧！</p><h1 id="4bd3" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">安装Datadog代理</h1><p id="2d30" class="pw-post-body-paragraph kd ke it kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la im bi translated">首先，为了从Kubernetes收集指标和日志，必须在集群中安装一个Datadog代理。Datadog团队为我们简化了这一过程。除了遵循本指南中的<a class="ae lb" href="https://docs.datadoghq.com/agent/kubernetes/" rel="noopener ugc nofollow" target="_blank">之外，别无他法。我建议</a><a class="ae lb" href="https://docs.datadoghq.com/agent/kubernetes/daemonset_setup/?tab=k8sfile" rel="noopener ugc nofollow" target="_blank">部署为守护集</a>，因为这就是我们所需要的。主机级部署不在本文讨论范围之内。如果您真的想知道，它会使用<code class="fe mf mg mh mi b"><a class="ae lb" href="https://github.com/kubernetes/kube-state-metrics" rel="noopener ugc nofollow" target="_blank">kube_state_metrcis</a></code>在集群级别监控更多指标。</p><p id="9e13" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">因为我们需要启用APM和日志记录，所以需要在DaemonSet上设置两个环境变量。</p><h2 id="c349" class="mj ld it bd le mk ml dn li mm mn dp lm ko mo mp lq ks mq mr lu kw ms mt ly mu bi translated">对于APM(跟踪)</h2><p id="146e" class="pw-post-body-paragraph kd ke it kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la im bi translated">在容器环境变量部分下，添加以下内容</p><pre class="mv mw mx my gt mz mi na nb aw nc bi"><span id="c093" class="mj ld it mi b gy nd ne l nf ng">- name: DD_APM_ENABLED<br/>  value: 'true'</span></pre><h2 id="64be" class="mj ld it bd le mk ml dn li mm mn dp lm ko mo mp lq ks mq mr lu kw ms mt ly mu bi translated">用于记录</h2><p id="6913" class="pw-post-body-paragraph kd ke it kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la im bi translated">与APM类似，我们需要打开标志来告诉Datadog代理捕获日志</p><pre class="mv mw mx my gt mz mi na nb aw nc bi"><span id="98b4" class="mj ld it mi b gy nd ne l nf ng">- name: DD_LOGS_ENABLED <br/>  value: 'true'</span></pre><p id="24b1" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">目前为止非常简单是吗？让我们试着保持下去！现在我们可以有把握地假设Datadog代理将完成它的工作。让我们转到应用程序检测。</p><h1 id="3582" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">APM和日志记录的工具</h1><p id="3c48" class="pw-post-body-paragraph kd ke it kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la im bi translated">我有一个梦想，有一天这个重要的步骤可以被完全跳过。想象一下，如果有一种方法可以让监控代理接入另一个运行时，而无需担心安全性。不幸的是，尽管事情已经有了很大的改善，但现在这还不太可能。在这个例子中，我致力于提供最简单的方法来开始工作。这是我对你的承诺。</p><p id="9269" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">现在，让我们看看代码(在node.js中)</p><figure class="mv mw mx my gt ju"><div class="bz fp l di"><div class="nh ni l"/></div></figure><h2 id="4f18" class="mj ld it bd le mk ml dn li mm mn dp lm ko mo mp lq ks mq mr lu kw ms mt ly mu bi translated">对于APM</h2><p id="ca65" class="pw-post-body-paragraph kd ke it kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la im bi translated">这就是我们所需要的！第1–7行告诉软件包将跟踪发送到当前安装在主机(<code class="fe mf mg mh mi b">process.env.DD_AGENT_HOST</code>)端口8126上的Datadog代理。稍后，我将向您展示如何设置环境变量。恭喜你发现了这个！</p><p id="709d" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">5号线在我看来相当神奇。该标志将跟踪与其执行期间生成的相关日志结合起来。它们将在Datadog接口上很好地表现出来。有了这个，我们将能够更有效地进行诊断。</p><p id="7b3f" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">第6行将把痕迹放到<a class="ae lb" href="https://docs.datadoghq.com/tracing/trace_search_and_analytics/" rel="noopener ugc nofollow" target="_blank">分析</a>中，这样它们就可以被标记，方便搜索。</p><p id="572e" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">APM部分到此为止。我希望它足够简单。现在让我们继续记录。</p><h2 id="b8f0" class="mj ld it bd le mk ml dn li mm mn dp lm ko mo mp lq ks mq mr lu kw ms mt ly mu bi translated">用于记录</h2><p id="9152" class="pw-post-body-paragraph kd ke it kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la im bi translated">你猜怎么着？根本不需要任何仪器。只需使用您选择的记录器(我用的是<a class="ae lb" href="https://www.npmjs.com/package/winston" rel="noopener ugc nofollow" target="_blank">温斯顿</a>)，Datadog代理就会很高兴地自动采集数据。在我的例子中，我甚至没有在文件级别记录事情。我所要做的就是从第10–13行创建一个格式，为每个日志添加一个标记。这将帮助我们更容易地过滤感兴趣的日志。</p><p id="1a85" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">到目前为止还好吗？现在我们来谈谈对Kubernetes的实际部署。</p><h1 id="bc45" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">部署应用程序</h1><p id="3362" class="pw-post-body-paragraph kd ke it kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la im bi translated">我喜欢简单。我希望我们仍然在同一页上。Kubernetes部署文件也非常简单。</p><figure class="mv mw mx my gt ju"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="a0de" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">如果您还记得告诉<code class="fe mf mg mh mi b">dd-trace</code>应该将指标发送到哪里的环境变量。这就是奇迹发生的地方。第17 - 21行将主机IP设置为应用程序可以使用的环境变量。</p><h1 id="0ff8" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">尝试新事物</h1><p id="21ec" class="pw-post-body-paragraph kd ke it kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la im bi translated">我了解到Datadog APM并不总是为每个请求生成一个跟踪。相反，对<a class="ae lb" href="https://docs.datadoghq.com/tracing/guide/trace_sampling_and_storage/" rel="noopener ugc nofollow" target="_blank">请求进行采样</a>。正因为如此，我们不能指望几次点击一个端点就能看到生成的痕迹。然而，如果我们使用一个简单的基准测试工具，这是可以解决的。在这里，让我们使用<a class="ae lb" href="https://httpd.apache.org/docs/2.4/programs/ab.html" rel="noopener ugc nofollow" target="_blank"> Apache基准</a></p><p id="22da" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">这将向应用程序抛出100个请求，以确保生成一些跟踪。根据我的经验，结果会生成大约6–10条跟踪。这对于一个概念验证来说已经足够了。</p><h1 id="f0cc" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">利润</h1><p id="0fe3" class="pw-post-body-paragraph kd ke it kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la im bi translated">现在，一切都设置正确。让我们看看我们将在Datadog UI上看到什么。</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi nj"><img src="../Images/9d38a6999ddd125127ede1e4e5c964d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t119AvBfc-b4T0pJJmyxFA.png"/></div></div></figure><p id="2017" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">酷！原木大量涌入。来看看痕迹吧！</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi no"><img src="../Images/24982f67b9b7ccaa06a4241a45812d1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TLnZpiY33uknaYbrCLt0Bw.png"/></div></div></figure><p id="f123" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">厉害！他们也在这里。最棒的是，它们已经与运行时生成的日志相关联。就是这样！很好很容易！</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi no"><img src="../Images/e4f07cb9d437afead936aec01bbd4b51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RjOeBSxnb2ojY3fG6xuCRg.png"/></div></div></figure><h1 id="1a8b" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">结束语</h1><p id="207c" class="pw-post-body-paragraph kd ke it kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la im bi translated">我们都喜欢Kubernetes的应用程序和资源管理能力。然而，如果没有良好的应用程序可观察性，它可能会损害开发人员的速度，充其量使它成为一个时髦的词。这甚至会给开发人员和产品工程团队增加不必要的压力。幸运的是，随着生态系统的成熟，我们看到了更多的供应商支持，因此诞生了这篇文章。我对正在进行的轨迹感到非常兴奋。</p><p id="d00d" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated">你可以在https://github.com/bufferapp/dd-tracing-logging-examples找到这篇文章的完整源代码。干杯！</p></div><div class="ab cl np nq hx nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="im in io ip iq"><p id="a1b8" class="pw-post-body-paragraph kd ke it kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la im bi translated"><em class="nw">最初发表于</em><a class="ae lb" href="https://gist.github.com/stevenc81/918207547ca22b8c86ff34e8e79e953a" rel="noopener ugc nofollow" target="_blank">T5【http://github.com】</a><em class="nw">。</em></p></div></div>    
</body>
</html>