<html>
<head>
<title>Making a hyper-engineered water alarm solution</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">打造超级工程水报警解决方案</h1>
<blockquote>原文：<a href="https://itnext.io/making-a-hyper-engineered-water-alarm-solution-19ba5078d2bc?source=collection_archive---------1-----------------------#2020-12-18">https://itnext.io/making-a-hyper-engineered-water-alarm-solution-19ba5078d2bc?source=collection_archive---------1-----------------------#2020-12-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="4ed7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">树莓Pi，ESP32，Docker，Nodejs，CI/CD，还有一个安卓应用。它拥有一切。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/9794878dcad67a13125fb3e81308703d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DXCEoGxtqEKXjTPUcGaD7g.png"/></div></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kx"><img src="../Images/e6b289c5837718de2b3cf74e1ee9097d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gGAlK9PdG3RoV8dMGItGUg.jpeg"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">看似危险的供水系统</figcaption></figure><p id="64a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">每个独立的房子都有一个主要问题，当谈到水。通过走上许多楼梯来检查水箱中的当前水位总是一项令人生畏的任务。</p><p id="a226" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我一直想在我的房子里“IoTfy”东西，通常只限于简单的家庭自动化任务，如灯和开关。因此，当我被分配到找出解决这个看似危险的水系统的任务时，我想通过制造一个真正独特的系统来充分利用它。</p><h2 id="70aa" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">传统水位系统</h2><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/a21c4ca7616f6547504ad56ea99aa9fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:910/format:webp/1*ajQCa-oPJ-ulv1Aic11Wrg.png"/></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">可用的水位系统</figcaption></figure><p id="7616" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">传统系统利用水的导电特性来完成电路。通过在不同的水平面上保持金属接触来监测水箱中的水位。通过增加接触次数，我们可以获得更高的水位分辨率。</p><p id="4bb1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种系统的缺点是需要对坦克进行大量改装，需要大量体积的硬件，最重要的是需要<em class="lw">联系</em>。</p><h2 id="8e28" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">全无接触——一种新的测量方法。</h2><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/70174bbb2590f89fd5139c2fbc7170df.png" data-original-src="https://miro.medium.com/v2/resize:fit:804/format:webp/1*uMfFefjipfXDIAGpWeRYLA.png"/></div></figure><p id="262a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如2020年的所有事情一样，我通过使用超声波传感器尝试了一种非接触式替代方案。</p><p id="8965" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">超声波传感器测量原始波和反射波之间的时间差，从中我们可以推断出传感器和任何物体之间的距离。</p><p id="f8ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过将这样的传感器固定在水箱的顶部，我们可以通过从水箱的高度减去距离来获得水箱中的水位。</p><h2 id="fdab" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">ESP32:低功率野兽</h2><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ly"><img src="../Images/b13e84be493e1874e2634737adba47d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FLYCm1kUUUP9-xYcZ8GSVw.jpeg"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">用于测试的原型</figcaption></figure><p id="a6de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于一些原因，我们选择的微控制器是ESP32。</p><ul class=""><li id="f1d9" class="lz ma iq jp b jq jr ju jv jy mb kc mc kg md kk me mf mg mh bi translated">我们需要一个完全无线的解决方案，因为它被安装在阳台上，处理所有的电线是一个麻烦。ESP32内置wifi模块，可以轻松地将数据发送到服务器。Arduino库可以很容易地发送HTTP请求。</li><li id="820b" class="lz ma iq jp b jq mi ju mj jy mk kc ml kg mm kk me mf mg mh bi translated">一个非常重要的因素是，ESP32有一个低功耗模式，它基本上是<em class="lw">消耗</em>功率。加载时需要几mA电流，深度睡眠模式下仅需要几uA电流。将它连接到一个10000毫安的电源上可以让它运行几个月。它非常节能，我们不得不缩短电源组的轮询间隔，以意识到有东西连接。</li></ul><p id="b2dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ESP32每20秒从低功耗模式中唤醒，并连接到wifi网络。然后，它使用超声波传感器模块获得传感器和水之间的距离，并将其发送到服务器。为了省电，我们不执行任何额外的计算。</p><h2 id="0d81" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">服务器以及我们为什么使用Docker和Github操作</h2><p id="1b9b" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">ESP32必须向Express API发送请求，该API将距离存储在Redis集群中。这是一个简单的API，有一些更新当前值和获取数据的途径。它通过执行计算和发送最新的水位和填充百分比来响应Android应用程序客户端。当达到临界水位时，它还会连续发出蜂鸣声。</p><p id="cf78" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果没有Docker和GitHub的行动，这个项目也可以完成。将Raspberry Pi挂接到显示器和键盘/鼠标上就足够了，但是开发和调试起来会非常糟糕。</p><p id="cc29" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是为什么Docker的构建、发布和随处运行的口号是一个容易集成的选择。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ms"><img src="../Images/d795917925f5d0c37203b5f7b3a581f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3OSfJYBXiGyFO2LUGyFf5g.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">工作流程</figcaption></figure><p id="438b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我可能会为此制作一个单独的教程，因为有太多关于docker多拱构建的内容需要解释。跟着走，这样你就不会错过。</p><p id="5413" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击这里查看知识库:<a class="ae mt" href="https://github.com/vinay-lanka/water-level-api" rel="noopener ugc nofollow" target="_blank">https://github.com/vinay-lanka/water-level-api</a>。</p><p id="d2e7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">手动设置Redis集群非常繁琐。使用docker-compose可以很容易地将Express API和Redis集群设置为容器。</p><p id="8331" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里的挑战是用Nodejs脚本中使用的<a class="ae mt" href="https://www.npmjs.com/package/onoff" rel="noopener ugc nofollow" target="_blank">“onoff”</a>NPM包发出蜂鸣声(控制I/O)。在容器内部这样做需要容器具有硬件特权，并且在测试时会产生问题。</p><p id="4ead" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最终的系统使得在Raspberry Pi上构建、测试和部署应用程序变得非常容易。甚至启动服务器也是一个简单的命令，如果一个服务出了问题，容器会通过重启来修复自己。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mu"><img src="../Images/f99cac91b44c5a9fa4e8c7d0b2748f4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L-Di-83uSqjAKztgjhy7dw.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">ssh和启动服务器。</figcaption></figure><h2 id="f6db" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">Android应用程序</h2><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mv"><img src="../Images/9f907701aa8982c193a031ec3afecaae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bNygvIoO8XrNS6wF9ll3yw.png"/></div></div></figure><p id="e6e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要一个一直存在于我们手机上的界面，随时向我们展示信息。一个网站将导致UX(用户体验)差，因为人们将不得不去网站找到水平。</p><p id="dacd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一款手机应用解决了这个问题。最近，家里有不少人转用了安卓系统，制作应用程序变得非常容易。</p><p id="b80d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该应用程序显示当前的水位和百分比值，以及一个自定义的进度条，以图形方式显示值。</p><p id="a5d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它向raspberry pi express API发送接收数据的请求。</p><p id="c39d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当用户需要时，整个应用程序使用SwipeToRefresh布局来更新值。</p><p id="415d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它使用凌空作为网络库和自定义按钮的进度条和按钮。</p><p id="0757" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Raspberry Pi上的蜂鸣器持续鸣响，直到按下应用程序上的按钮，确保填充油箱的电机确实关闭。</p><h2 id="c248" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">打包并安装</h2><p id="96e2" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">我们将ESP32、电源组和超声波传感器打包在一个可以无线操作的单元中。</p><p id="2cdf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">电子产品和水不能很好地混合。这就是为什么我们需要一个防水盒，可以承受飞溅和偶尔的降雨。</p><p id="9a60" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们仍然需要超声波传感器的开口，所以我们在防水盒上钻了两个孔。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mw"><img src="../Images/a1fa076f70fbfc6879a6a2d40ed0c832.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kJFJDVS6gyroBiMhINlvPw.jpeg"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">我们用一个特殊的钻头在外壳上钻孔</figcaption></figure><p id="88f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">装有所有组件的盒子如图所示。我只是用了一个防水盒，所以它不是最合适的。理想情况下，我会选择一个更小的盒子，以便更有效地包装部件。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mx"><img src="../Images/7f018096e3db34cd45e63de1a2ca9114.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1x3S1E9qBwLBWnGYN0Whww.jpeg"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">都在一个整洁的包装中</figcaption></figure><h1 id="85d9" class="my ld iq bd le mz na nb lh nc nd ne lk nf ng nh ln ni nj nk lq nl nm nn lt no bi translated">结论</h1><p id="81b6" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">因此，这是一个相当不错的3-4天的项目，目前看来运作良好。尽管我有所保留，超声波传感器到目前为止似乎在潮湿的环境中保持良好。将来我可能会尝试用一个更好的防水超声波传感器来替换它。</p><p id="1f98" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该项目是完全开源的，所以如果任何人想为该项目做贡献，他们可以，回购是链接<a class="ae mt" href="https://github.com/vinay-lanka/water-level-api" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="6188" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我也会试着上传这个应用的源代码，我没有任何上传Android项目到GitHub的经验，但是如果有人想改进这个应用(它非常乏味..我不是一个应用程序开发人员xD)，我会尽量上传。</p><p id="4aab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我知道你们是否想要一个关于多架构docker构建过程或esp32深度睡眠模式的博客，因为它们是我在制作这个项目时探索的非常有趣的主题。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mx"><img src="../Images/e442837ff72118abd20c71efeac6c3c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i2S8sEv7HdeX28DDprssig.jpeg"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">希望能少去几次露台。</figcaption></figure></div></div>    
</body>
</html>