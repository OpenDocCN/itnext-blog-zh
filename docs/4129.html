<html>
<head>
<title>Managing Azure RBAC Roles and Assignments with Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform管理Azure RBAC角色和任务</h1>
<blockquote>原文：<a href="https://itnext.io/managing-azure-rbac-roles-and-assignments-with-terraform-1a1cdb2f8eb6?source=collection_archive---------2-----------------------#2020-05-03">https://itnext.io/managing-azure-rbac-roles-and-assignments-with-terraform-1a1cdb2f8eb6?source=collection_archive---------2-----------------------#2020-05-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/5a5b3588e4c86ec9fd8e3cc6457cbb6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qO5mbBcw2mpjBZLE"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">火星表面。我们还没有把这个地球化。Yuliya Kosolapova 在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="8e30" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是一个我迫不及待想分享的快速指南。这是一种使用Terraform在Azure中管理自定义角色和角色分配的方法。我使用的Terraform、AzureRM和AzureAD提供程序的版本如下:</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="9c01" class="ln lo it lj b gy lp lq l lr ls">➜ terraform version <br/>Terraform v0.12.24<br/>+ provider.azuread v0.7.0<br/>+ provider.azurerm v2.0.0</span></pre><p id="ab41" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本例中，我创建了一个自定义角色，允许一些用户在我们的Azure订阅中查看共享仪表板。用户应该能够查看Terraform已经创建的仪表板，它由terraform资源<code class="fe lt lu lv lj b">azurerm_dashboard.insights-dashboard</code>引用:</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="7ea5" class="ln lo it lj b gy lp lq l lr ls">resource "azurerm_role_definition" "support_dash_read" {<br/>  name        = "dashboard-${var.environment}-support"<br/>  scope       = data.azurerm_subscription.current.id<br/>  description = "Custom Role for viewing Dashboards"<br/>  permissions {<br/>    actions = [<br/>      "Microsoft.Portal/dashboards/read",<br/>      "Microsoft.Insights/*/read",<br/>      "Microsoft.OperationalInsights/workspaces/search/action",<br/>    ]<br/>    not_actions = []<br/>  }<br/>  assignable_scopes = [<br/>    azurerm_dashboard.insights-dashboard.id,<br/>  ]<br/>}</span></pre><p id="2d04" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该角色授予以下用户读取权限:</p><ul class=""><li id="0472" class="lw lx it ki b kj kk kn ko kr ly kv lz kz ma ld mb mc md me bi translated">在Terraform中的其他地方创建的特定共享仪表板，方法是将此角色的范围限定在仪表板上</li><li id="917c" class="lw lx it ki b kj mf kn mg kr mh kv mi kz mj ld mb mc md me bi translated">与内置的监视读取器角色具有相同的读取权限，但不具备提出支持票证的能力。由于Insights查询大量数据——每个数据都显示在不同的权限条目中，例如<code class="fe lt lu lv lj b">Microsoft.Insights/metricAlerts/read</code>、<code class="fe lt lu lv lj b">Microsoft.Insights/alertRules/read</code>、<code class="fe lt lu lv lj b">Microsoft.Insights/components/*/read </code>——我发现更容易使读取权限更加宽松，并模仿其中一个内置角色。该角色的范围仍然只能分配给仪表板，因此我们有效地授予了仪表板显示的任何洞察数据的读取权限。</li></ul><p id="66a6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">向用户分配角色时，您需要他们在Azure AD中的主体ID(也称为对象ID)来执行分配。就我个人而言，我不希望在运行terraform之前，通过一些手动过程或使用CLI来找出每个用户的对象ID。相反，我们可以创建一个变量来存储Azure中与用户相关联的所有电子邮件地址(也是他们的UPN，或用户的主要名称):</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="8b26" class="ln lo it lj b gy lp lq l lr ls">support_users = [<br/>  "user1@contoso.com",<br/>  "user2@contoso.com",<br/>  "user3@contoso.com",<br/>  "user4@contoso.com",<br/>]</span></pre><p id="bc37" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我们将该变量传递给AzureAD提供者，并使用<code class="fe lt lu lv lj b">for_each</code>参数遍历用户:</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="431f" class="ln lo it lj b gy lp lq l lr ls"><em class="mk"># Query the Principal ID for each user in support_users<br/></em>data "azuread_user" "user" {<br/>  for_each            = toset(var.support_users)<br/>  user_principal_name = format("%s", each.key)<br/>}</span></pre><p id="09df" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，当我们想要将所有这些用户分配给我们上面创建的自定义角色时，我们再次使用<code class="fe lt lu lv lj b">for_each</code>来完成，这次提供我们上面创建的数据资源(<code class="fe lt lu lv lj b">azuread_user</code>):</p><pre class="le lf lg lh gt li lj lk ll aw lm bi"><span id="9ce9" class="ln lo it lj b gy lp lq l lr ls">resource "azurerm_role_assignment" "example" {<br/>  for_each           = data.azuread_user.user<br/>  scope              = azurerm_dashboard.insights-dashboard.id<br/>  role_definition_id = azurerm_role_definition.support_dash_read.id<br/>  principal_id       = data.azuread_user.user[each.key].object_id<br/>}</span></pre><p id="0131" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">就是这样！现在，您可以使用Terraform将一批用户分配到Azure中的RBAC角色。</p></div></div>    
</body>
</html>