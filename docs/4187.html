<html>
<head>
<title>GraphQL API for SQL Database in .NET — setting up access to the data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">中SQL数据库的GraphQL API。NET —设置对数据的访问</h1>
<blockquote>原文：<a href="https://itnext.io/graphql-api-for-sql-database-in-net-setting-up-access-to-the-data-e7be91326576?source=collection_archive---------3-----------------------#2020-05-12">https://itnext.io/graphql-api-for-sql-database-in-net-setting-up-access-to-the-data-e7be91326576?source=collection_archive---------3-----------------------#2020-05-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="2e92" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在上一篇文章中，我们对. Net下的SQL数据库的GraphQL技术和组件做了一个简短的概述。在那里，您可以找到一些关于如何设置metaDbSchema、使用分页或定义过滤器的示例，因此，如果您还没有阅读它，请点击这里。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/fc0f876346c51288bd23449a0f5abff6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yy6GyKwbobV4tgZtbFj8YA.png"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">因为我们有一个API访问点——权限是应用程序中重要而敏感的部分</figcaption></figure><p id="9410" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于从DB获取数据来说，这一切都很好，但是如果您需要对结果集进行更多的控制，并且需要能够在字段级别快速方便地设置基于角色的权限，该怎么办呢？在这种情况下，我们需要实现对系统的访问，以及允许特定用户获取数据的权限。这意味着我们需要认证/授权事实和JSON Web Token (JWT ),这是一个开放标准(RFC 7519 ),它定义了传输这些事实的方式。</p><p id="4137" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">尽管授权和认证这两个术语都与安全性和访问数据或系统功能的一部分有关，但它们经常被混淆。因此，让我们简短地回忆一下认证、授权和JSON Web令牌的含义。</p><p id="5859" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">认证</strong></p><p id="88aa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在验证您的用户名和密码等凭据(以验证您的身份)时，系统会检查您是否使用了自己的凭据。本质上，认证是确定某人确实是他们所声称的那个人的过程。</p><p id="b153" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">授权</strong></p><p id="122c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">相反，授权是确定用户访问级别的工具。例如，用户Harald是否有权查看这些数据？还是他只能看到和他相关的数据？</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi lf"><img src="../Images/dd2104ac50acfbf1659f1d4b444638d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3yYX_f7sNUPPwrXg3otLgg.png"/></div></div></figure><p id="4de1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">什么是JSON Web Token (JWT)？</strong></p><blockquote class="lg lh li"><p id="8a58" class="jq jr lj js b jt ju jv jw jx jy jz ka lk kc kd ke ll kg kh ki lm kk kl km kn im bi translated">JSON Web Token (JWT)是一个开放标准(RFC 7519 ),它定义了一种紧凑且独立的方式，以JSON对象的形式在各方之间安全地传输信息。该信息可以被验证和信任，因为它是数字签名的。</p></blockquote><p id="4342" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">授权是使用JWT最常见的场景。用户登录后，每个后续请求都将包含JWT，允许用户访问该令牌允许的路由、服务和资源。</p><p id="76d8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用JWT的目的不是隐藏数据，而是确保数据的真实性。JWT是签名和编码的，不是加密的。</p><p id="9b3e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">为GraphQL API应用程序设置权限</strong></p><p id="5898" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们已经完成了所有的魔术，你可以下载它作为例子，但让我们把重点放在几个关键的步骤。</p><ol class=""><li id="5f05" class="ln lo it js b jt ju jx jy kb lp kf lq kj lr kn ls lt lu lv bi translated">首先，让我们在Startup.cs文件中设置身份验证选项</li></ol><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="35ee" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2.我们还需要生成JWT访问令牌的web api方法:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="7a1c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3.现在，我们可以使用检查和应用权限，我们有两个选项来完成此操作。第一个是在生成GraphQL模式时应用用户权限。因此，我们可以省略模式或模式字段，它们不会出现，也不能在进一步的操作中使用:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="a39a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我们的示例中，如果登录用户是“用户”角色，我们省略“客户”模式。例如，如果我们必须确保对登录用户隐藏一些敏感的实体，即使数据库返回了错误和数据，这可能是有用的。让我们看看它是如何工作的:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ly"><img src="../Images/ced6e73a4ea97aded784c224ac432bc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*WmSgqX0JT0i6P5ah0YEt0A.gif"/></div></div></figure><p id="7001" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第二种方式非常有趣——预过滤数据基于SQL查询级别的角色。让我们从DbCommandBuilder继承(我们用的是NReco。数据作为lighweight-ORM)并在SQL-query运行之前在Startup.cs:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="93a8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">并通过使用Relex查询设置权限—如果登录者拥有“admin”权限，将获取所有客户订单(relex-where表达式将为“true”)，或者如果我们作为普通客户端登录，将仅获取与该客户相关的订单:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="1f0a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，我们可以根据我们的访问权限仅获取用户的订单:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ly"><img src="../Images/b2de22c2de80d7c096d1d7cc381da2f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*F0Q3oP9JJxL5XfgUn0NBxA.gif"/></div></div></figure><p id="b9cf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">例如，如果我们生成admin的toke并尝试获取相同的数据，我们将获得所有订单:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ly"><img src="../Images/385cf98078c0c8ccd8e009e4c1ea1b58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*OyeoiE1vBMsCgdyDDdLBCA.gif"/></div></div></figure><p id="dd78" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Relex是一个强大且非常灵活的工具，它不仅允许我们编写where子句过滤条件，还允许我们决定选择哪些字段，编写复杂的子查询来检查权限等。</p><p id="b4ea" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个主题中，我们在下面设置了对<a class="ae ko" href="https://www.nrecosite.com/graphql_to_sql_database.aspx" rel="noopener ugc nofollow" target="_blank"> NReco GraphQL </a> API的访问权限。Net，展示了我们如何在不同的级别上定义和应用权限(甚至在字段级别)。根据业务需要，技术顾问可以很容易地添加或修改权限规则，不会花费太多时间。同时，要清楚地了解我们向特定用户展示什么。</p><p id="7b99" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">感谢你的阅读，如果能在评论中听到你的想法会很酷。</p></div></div>    
</body>
</html>