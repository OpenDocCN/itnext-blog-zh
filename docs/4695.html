<html>
<head>
<title>Deploy Argo CD with Ingress and TLS in Three Steps: No YAML Yak Shaving Required</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">分三步部署带有入口和TLS的Argo CD:不需要YAML牦牛毛</h1>
<blockquote>原文：<a href="https://itnext.io/deploy-argo-cd-with-ingress-and-tls-in-three-steps-no-yaml-yak-shaving-required-bc536d401491?source=collection_archive---------1-----------------------#2020-08-25">https://itnext.io/deploy-argo-cd-with-ingress-and-tls-in-three-steps-no-yaml-yak-shaving-required-bc536d401491?source=collection_archive---------1-----------------------#2020-08-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/7e5efacc43fba8ea2c89d413e2c18579.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jXE9hoLLCwmAI1IDmZt_tg.jpeg"/></div></div></figure><figure class="jz ka kb kc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jy"><img src="../Images/502be062d98cee39fbfbb17a260606dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GImzYxn2oOpsOd2K"/></div></div></figure><p id="e43b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在您的Kubernetes集群中安装Argo CD很容易，但是将它作为服务提供给团队的其他成员却很有挑战性。虽然Argo CD文档<a class="ae lb" href="https://argoproj.github.io/argo-cd/operator-manual/ingress/" rel="noopener ugc nofollow" target="_blank">提供了配置入口、TLS和服务端口的指令</a>，但并不是每个工程师都觉得这很容易做到，或者他们不想参与操作细节。</p><p id="a6d2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本教程使用K8s初始化器来自动生成所有必要的安装YAML，然后引导您完成配置Argo CD的过程，以连续部署一个应用程序，该应用程序在互联网上向最终用户公开。</p><h1 id="227f" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">先决条件</h1><p id="da02" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">在本教程中，我们将从零开始，在GKE上运行一个空的Kubernetes集群。我们选择了GKE，这样我们就可以分享Argo CD如何安全地公开给一组开发人员，而不是将演示局限于低调的本地和私人环境。当然，如果您希望只使用您的工作站，您可以在一分钟内创建一个<code class="fe mf mg mh mi b"><a class="ae lb" href="https://kind.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank">Kind</a></code>集群。</p><p id="f762" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本教程还假设您已经下载并安装了<code class="fe mf mg mh mi b"><a class="ae lb" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank">kubectl</a></code>和<code class="fe mf mg mh mi b"><a class="ae lb" href="https://argoproj.github.io/argo-cd/cli_installation/" rel="noopener ugc nofollow" target="_blank">argocd</a></code> CLI。</p><h1 id="815f" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">您环境中的引导网络和入口</h1><p id="21c9" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">从零开始，我们将使用位于<a class="ae lb" href="https://app.getambassador.io" rel="noopener ugc nofollow" target="_blank"> app.getambassador.io </a>的K8s初始化器，通过几次点击，用所有需要的工具搭建我们的Kubernetes环境。</p><figure class="jz ka kb kc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mj"><img src="../Images/a754e21f206e68b532c1cc8c0b807b7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pc_DXm4YN1UXprjD"/></div></div></figure><p id="754c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">K8s初始化器将询问关于您的目标Kubernetes集群、您的负载平衡器以及您希望在哪里终止TLS的问题。它将为您提供配置CI/CD的选项，Argo是显而易见的选择，以及监控。回答完问卷后，K8s初始化器将生成一个zip文件，其中包含一组YAML文件，准备安装到您的远程集群上。</p><p id="7159" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在就试试:<a class="ae lb" href="https://app.getambassador.io/" rel="noopener ugc nofollow" target="_blank">https://app . getambassador . io</a>。</p><p id="9c8a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">按照类似向导的K8s初始化问卷，我们选择了我们的目标Kubernetes集群:“Google Kubernetes引擎”和“Google外部负载平衡器(L4)”负载平衡器。由于所有主要的云提供商都支持Kubernetes，因此它们的实现和支持往往存在细微的差异，这使得很难配置入口控制器来公开公共流量。K8s初始化器会给我们提供一个最优的配置。</p><p id="7f49" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们为我们的安装选择了主机名。我们选择了一个我们可以控制DNS的主机名，以便在我们的DNS区域中建立一个公共入口。</p><p id="6243" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下一步是选择我们的CI/CD配置。显而易见的选择是将Argo CD与Ambassador Edge Stack放在一起。在这个演示中，我们允许匿名用户访问，并设置了一个虚拟的临时管理员密码。</p><h1 id="79e8" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">根据说明安装Ambassador Edge堆栈</h1><p id="988e" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">K8s初始化器为我们提供了一套现成的YAML文件和指令。我们差不多完成了，现在可以下载一个zip文件，其中包含一组YAML文件，准备安装在我们的远程集群上。按照说明中的指示，按照<code class="fe mf mg mh mi b">kubectl apply</code>命令安装所有组件非常简单。</p><h2 id="d81f" class="mk ld iq bd le ml mm dn li mn mo dp lm ko mp mq lq ks mr ms lu kw mt mu ly mv bi translated">设置DNS</h2><p id="45b9" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">现在我们已经部署了Ambassador Edge Stack，我们需要用我们的云提供商分配给<code class="fe mf mg mh mi b">ambassador</code>服务的外部地址来更新您的主机名的DNS条目。</p><pre class="jz ka kb kc gt mw mi mx my aw mz bi"><span id="748f" class="mk ld iq mi b gy na nb l nc nd">kubectl get service -n ambassador ambassador \<br/>  -o jsonpath='{.status.loadBalancer.ingress[0]}'</span></pre><p id="3cb3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">导航到我们的DNS提供商管理界面，我们用上面的输出值为我们选择的$HOSTNAME创建或更新DNS条目。</p><p id="febc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">完成Ambassador Edge Stack安装说明后，我们可以创建其他用户定义的资源配置(如果有)。</p><pre class="jz ka kb kc gt mw mi mx my aw mz bi"><span id="7f50" class="mk ld iq mi b gy na nb l nc nd">kubectl apply -f 3-user.yml</span></pre><p id="6d55" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">DNS传播和TLS证书生成可能需要几分钟时间，具体取决于您的云提供商。</p><h1 id="5650" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">安装Argo CD</h1><p id="1556" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">按照K8s初始化器提供的说明，Argo CD的安装非常简单，因为所有需要的资源都预先配置在下载的YAML文件中。说明书上说我们应该运行:</p><pre class="jz ka kb kc gt mw mi mx my aw mz bi"><span id="be09" class="mk ld iq mi b gy na nb l nc nd">kubectl apply -n argocd -f 4-argocd.yml</span></pre><h2 id="2f5b" class="mk ld iq bd le ml mm dn li mn mo dp lm ko mp mq lq ks mr ms lu kw mt mu ly mv bi translated">访问和使用Argo光盘</h2><p id="a316" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">给Argo CD几秒钟的启动时间，然后我们将能够使用<code class="fe mf mg mh mi b">argocd</code> CLI、默认的<code class="fe mf mg mh mi b">admin</code>用户名和我们之前选择的临时密码登录到安装。</p><pre class="jz ka kb kc gt mw mi mx my aw mz bi"><span id="3b74" class="mk ld iq mi b gy na nb l nc nd">argocd login $HOSTNAME --grpc-web-root-path /argo-cd</span></pre><p id="4a50" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在当然是更改临时密码的好时机！</p><p id="e95c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过导航到<a class="ae lb" href="https://$HOSTNAME/argo-cd" rel="noopener ugc nofollow" target="_blank">https://$HOSTNAME/Argo-CD</a>，Argo UI也可以在相同的$ HOSTNAME下使用。请注意，当访问Argo CD时，我们没有收到任何可怕的浏览器警告，因为Ambassador Edge堆栈正在使用可信证书处理安全连接。</p><h1 id="9be8" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">创建Argo留言簿应用程序</h1><p id="a9e8" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">然后让我们使用Argo CD部署一个示例应用程序。我们从Argo应用程序的所有可用示例中挑选了<a class="ae lb" href="https://github.com/argoproj/argocd-example-apps" rel="noopener ugc nofollow" target="_blank">留言簿。</a></p><p id="d5ba" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，让我们花点时间确保我们的目标Kubernetes集群已经用Argo <code class="fe mf mg mh mi b">ServiceAccount</code>和<code class="fe mf mg mh mi b">ClusterRole</code>设置好了:</p><pre class="jz ka kb kc gt mw mi mx my aw mz bi"><span id="a254" class="mk ld iq mi b gy na nb l nc nd">argocd cluster add $(kubectl config current-context)</span></pre><p id="78a7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用CLI创建Argo应用程序资源非常简单。使用Argo UI也可以很好地完成这一步。</p><pre class="jz ka kb kc gt mw mi mx my aw mz bi"><span id="a92c" class="mk ld iq mi b gy na nb l nc nd">argocd app create guestbook \<br/> --repo <a class="ae lb" href="https://github.com/argoproj/argocd-example-apps.git" rel="noopener ugc nofollow" target="_blank">https://github.com/argoproj/argocd-example-apps.gi</a>t \<br/> --path guestbook \<br/> --dest-server <a class="ae lb" href="https://kubernetes.default.svc" rel="noopener ugc nofollow" target="_blank">https://kubernetes.default.sv</a>c \<br/> --dest-namespace default</span></pre><p id="e00b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了完成安装，我们需要同步应用程序并监控其可用性。</p><pre class="jz ka kb kc gt mw mi mx my aw mz bi"><span id="c8ce" class="mk ld iq mi b gy na nb l nc nd">argocd app sync guestbook<br/>argocd app list</span></pre><p id="f83b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们现在知道已经部署了留言簿应用程序，但不幸的是，我们无法访问它…</p><h1 id="f2be" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">为我们的留言簿创建一个入口路径</h1><p id="01c0" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">使用Ambassador Edge Stack公开任何服务都非常容易。给定安装了getambassador.io CRDs的K8s初始化器，我们可以利用映射资源来告诉入口控制器如何处理和路由来自互联网的流量到我们的私有应用。</p><p id="d15d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">运行以下命令创建映射:</p><pre class="jz ka kb kc gt mw mi mx my aw mz bi"><span id="fa8f" class="mk ld iq mi b gy na nb l nc nd">echo ‘---<br/>apiVersion: getambassador.io/v2<br/>kind: Mapping<br/>metadata:<br/> name: guestbook-ui<br/> namespace: default<br/>spec:<br/> prefix: /guestbook/<br/> rewrite: /<br/> service: guestbook-ui:80<br/>‘ | kubectl apply -f -</span></pre><h2 id="45af" class="mk ld iq bd le ml mm dn li mn mo dp lm ko mp mq lq ks mr ms lu kw mt mu ly mv bi translated">访问留言簿</h2><p id="37d3" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">与Argo UI非常相似，我们的留言簿示例应用程序现在也可以在相同的＄HOSTNAME下获得，方法是导航到<a class="ae lb" href="https://$HOSTNAME/guestbook/" rel="noopener ugc nofollow" target="_blank">https://＄HOSTNAME/guest book/</a>。Ambassador Edge堆栈将再次提供公共信任的TLS证书，并将流量适当地路由到我们的私人留言簿服务。</p><h1 id="1891" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">了解更多信息</h1><p id="4671" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">在本教程中，我们展示了如何使用ArgoCD和Ambassador Edge堆栈配置您的Kubernetes集群，以便持续部署Kubernetes应用程序并将其公开到互联网。在K8s初始化器的帮助下，只需点击几下鼠标就可以生成所有需要的YAML。</p><p id="6d4d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要了解有关这些工具的更多信息，请查看以下资源:</p><ul class=""><li id="b6a2" class="ne nf iq kf b kg kh kk kl ko ng ks nh kw ni la nj nk nl nm bi translated"><a class="ae lb" href="https://argoproj.github.io/argo/" rel="noopener ugc nofollow" target="_blank">逃离</a></li><li id="bfd0" class="ne nf iq kf b kg nn kk no ko np ks nq kw nr la nj nk nl nm bi translated"><a class="ae lb" href="https://www.getambassador.io" rel="noopener ugc nofollow" target="_blank">大使缘栈</a></li><li id="f1b6" class="ne nf iq kf b kg nn kk no ko np ks nq kw nr la nj nk nl nm bi translated"><a class="ae lb" href="https://argoproj.github.io/community/join-slack" rel="noopener ugc nofollow" target="_blank">蓉城萧条</a></li><li id="2c61" class="ne nf iq kf b kg nn kk no ko np ks nq kw nr la nj nk nl nm bi translated"><a class="ae lb" href="http://d6e.co/slack" rel="noopener ugc nofollow" target="_blank">大使懈频道</a></li></ul></div></div>    
</body>
</html>