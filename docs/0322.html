<html>
<head>
<title>Kubernetes over Ubuntu on VirtualBox</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">kubernetes over Ubuntu on VirtualBox</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-on-ubuntu-on-virtualbox-60e8ce7c85ed?source=collection_archive---------2-----------------------#2018-02-19">https://itnext.io/kubernetes-on-ubuntu-on-virtualbox-60e8ce7c85ed?source=collection_archive---------2-----------------------#2018-02-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8c8f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Kubernetes是一个主流。让我们在本地环境中创建用于开发的集群</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/69ea6784cc9654be6ecc84b173c0f8f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H4LGWbq9u-H5Jra907P7tA.png"/></div></div></figure><p id="cfd4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><a class="ae ln" href="https://www.linkedin.com/cws/share?url=https%3A%2F%2Fitnext.io%2Fkubernetes-on-ubuntu-on-virtualbox-60e8ce7c85ed" rel="noopener ugc nofollow" target="_blank"> <em class="lo">点击这里在LinkedIn </em>上分享这篇文章</a></p><h2 id="a277" class="lp lq iq bd lr ls lt dn lu lv lw dp lx la ly lz ma le mb mc md li me mf mg mh bi translated">环境:</h2><ul class=""><li id="5e15" class="mi mj iq kt b ku mk kx ml la mm le mn li mo lm mp mq mr ms bi translated">ArchLinux上的VirtualBox 5.2.6</li><li id="7bbb" class="mi mj iq kt b ku mt kx mu la mv le mw li mx lm mp mq mr ms bi translated">每台虚拟机上安装Ubuntu 16.04。</li><li id="788c" class="mi mj iq kt b ku mt kx mu la mv le mw li mx lm mp mq mr ms bi translated">Kubernetes 1.9.3</li></ul><h2 id="dde9" class="lp lq iq bd lr ls lt dn lu lv lw dp lx la ly lz ma le mb mc md li me mf mg mh bi translated">最低<a class="ae ln" href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#before-you-begin" rel="noopener ugc nofollow" target="_blank">要求</a>:</h2><ul class=""><li id="80eb" class="mi mj iq kt b ku mk kx ml la mm le mn li mo lm mp mq mr ms bi translated">2CPU</li><li id="fe15" class="mi mj iq kt b ku mt kx mu la mv le mw li mx lm mp mq mr ms bi translated">2GB内存</li><li id="fa64" class="mi mj iq kt b ku mt kx mu la mv le mw li mx lm mp mq mr ms bi translated"><strong class="kt ir">禁用交换</strong></li><li id="e052" class="mi mj iq kt b ku mt kx mu la mv le mw li mx lm mp mq mr ms bi translated">20GB硬盘(仅用于测试)</li></ul><p id="07bb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">虚拟机有两个网络接口。一个位于NAT网络之后，用于互联网连接，第二个主机仅用于虚拟机之间的内部通信。纯主机网络应该不同于kubernetes虚拟网络。我选172.30.56.0/24。Kubernetes将有3个节点:</p><ul class=""><li id="725d" class="mi mj iq kt b ku kv kx ky la my le mz li na lm mp mq mr ms bi translated">kube-master(管理、监控)</li><li id="8fff" class="mi mj iq kt b ku mt kx mu la mv le mw li mx lm mp mq mr ms bi translated">kube-工人-1</li><li id="f56d" class="mi mj iq kt b ku mt kx mu la mv le mw li mx lm mp mq mr ms bi translated">kube-工人-2</li></ul><p id="f6f6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">worker-1和worker-2将用于所有用户窗格。</p><p id="ab97" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了构建kubernetes集群，我使用了<strong class="kt ir"> kubeadm。</strong>关于如何设置kubeadm的所有说明，kubectl在这里描述<a class="ae ln" href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="7e8f" class="lp lq iq bd lr ls lt dn lu lv lw dp lx la ly lz ma le mb mc md li me mf mg mh bi translated">让我们开始:</h2><ol class=""><li id="f74c" class="mi mj iq kt b ku mk kx ml la mm le mn li mo lm nb mq mr ms bi translated">安装<a class="ae ln" href="https://docs.docker.com/install/linux/docker-ce/ubuntu/" rel="noopener ugc nofollow" target="_blank">docker环境。</a></li><li id="6686" class="mi mj iq kt b ku mt kx mu la mv le mw li mx lm nb mq mr ms bi translated"><a class="ae ln" href="https://kubernetes.io/docs/setup/independent/install-kubeadm/" rel="noopener ugc nofollow" target="_blank">安装</a> kubelet，kubeadm，kubectl。</li><li id="c964" class="mi mj iq kt b ku mt kx mu la mv le mw li mx lm nb mq mr ms bi translated">为kubelet和docker更改<strong class="kt ir"> cgroup-driver </strong></li></ol><p id="8ec8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">对于码头工人:</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="d488" class="lp lq iq nd b gy nh ni l nj nk">cat &lt;&lt; EOF &gt; /etc/docker/daemon.json<br/>{<br/>  "exec-opts": ["native.cgroupdriver=systemd"]<br/>}<br/>EOF</span></pre><p id="1903" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">对于库伯莱:</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="3291" class="lp lq iq nd b gy nh ni l nj nk">#edit kubeadm.service file<br/>&gt; vim /etc/systemd/system/kubelet.service.d/10-kubeadm.conf<br/># add to the end <strong class="nd ir">--cgroup-driver=systemd<br/></strong>&gt; systemctl daemon-reload &amp;&amp; systemctl restart kubelet docker</span></pre><p id="4317" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">4.初始化主机</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="2bf4" class="lp lq iq nd b gy nh ni l nj nk">&gt; kubeadm init --apiserver-advertise-address=172.30.56.120 <!-- -->--pod-network-cidr=192.168.0.0/16</span></pre><blockquote class="nl nm nn"><p id="9d5a" class="kr ks lo kt b ku kv jr kw kx ky ju kz no lb lc ld np lf lg lh nq lj lk ll lm ij bi translated">—API server-advertise-address =<ip adress="">—更改标准API IP地址。</ip></p><p id="32f9" class="kr ks lo kt b ku kv jr kw kx ky ju kz no lb lc ld np lf lg lh nq lj lk ll lm ij bi translated">—pod-network-CIDR = 192 . 168 . 0 . 0/16—引导印花棉布网络时需要。</p></blockquote><p id="5fac" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">5.将kube配置复制到主文件夹。需要通过kubectl管理集群。此外，如果需要在不同于master的主机上管理集群，您可以将此配置复制到workers或本地机器。</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="6703" class="lp lq iq nd b gy nh ni l nj nk">&gt; mkdir -p $HOME/.kube<br/>&gt; sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br/>&gt; sudo chown $(id -u):$(id -g) $HOME/.kube/config</span></pre><p id="cec3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">6.安装虚拟网络。我选择<a class="ae ln" href="https://www.projectcalico.org/" rel="noopener ugc nofollow" target="_blank">印花布</a>。</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="459c" class="lp lq iq nd b gy nh ni l nj nk">&gt; kubectl apply -f https://docs.projectcalico.org/v3.0/getting-started/kubernetes/installation/hosted/kubeadm/1.7/calico.yaml</span></pre><p id="9834" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">7.不要忘记复制令牌散列。将工人添加到集群和登录仪表板时需要它。代币将24小时开放。</p><blockquote class="nl nm nn"><p id="5453" class="kr ks lo kt b ku kv jr kw kx ky ju kz no lb lc ld np lf lg lh nq lj lk ll lm ij bi translated">不要担心令牌是否会过期<strong class="kt ir"> kubeadm令牌创建</strong>和<strong class="kt ir"> kubeadm令牌列表</strong>将帮助创建新令牌用于加入节点和登录仪表板。</p></blockquote><p id="3ff7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">每个工人都应该安装<strong class="kt ir"> docker </strong>软件和<strong class="kt ir"> kubeadm </strong>。要将节点加入群集，请在每个虚拟机上执行下一个命令。</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="bb48" class="lp lq iq nd b gy nh ni l nj nk">&gt; kubeadm join --token 6a1c63.4d6b405ebfba2021 172.30.56.120:6443 --discovery-token-ca-cert-hash sha256:8fac8a430850de77f17e7eab0bdfbcd59107bf8f60edd3538e098f46e0d2287b</span></pre><p id="499a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">显示集群成员(在主服务器上):</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="b99c" class="lp lq iq nd b gy nh ni l nj nk">&gt; kubectl get nodes</span></pre><p id="e301" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">8.默认情况下，主设备不处理用户单元，但是如果集群很小，主设备可以放置用户单元。</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="e528" class="lp lq iq nd b gy nh ni l nj nk">&gt; kubectl taint nodes --all node-role.kubernetes.io/master-</span></pre><p id="d356" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">9.集群已创建并可供使用。只需启动内置linux的简单pod。</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="cbc8" class="lp lq iq nd b gy nh ni l nj nk">&gt; kubectl run -i --tty busybox --image=busybox --restart=Never -- sh</span></pre><p id="4334" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><a class="ae ln" href="https://www.busybox.net/" rel="noopener ugc nofollow" target="_blank"> busybox </a> —它是简单的linux，里面有最少的软件。适合从头开始创建容器。</p><p id="ca8e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在<strong class="kt ir"> kubernetes </strong>集群已经为豆荚做好了准备。<strong class="kt ir"> kubectl </strong>是管理集群的主命令。</p><h2 id="fc2c" class="lp lq iq bd lr ls lt dn lu lv lw dp lx la ly lz ma le mb mc md li me mf mg mh bi translated">仪表板安装</h2><blockquote class="nl nm nn"><p id="4031" class="kr ks lo kt b ku kv jr kw kx ky ju kz no lb lc ld np lf lg lh nq lj lk ll lm ij bi translated">仪表板不是管理kubernetes集群的安全方式。仪表板以完全管理权限执行。小心共享对dashboard的访问。用户可以强奸你的集群。</p></blockquote><ol class=""><li id="fe2d" class="mi mj iq kt b ku kv kx ky la my le mz li na lm nb mq mr ms bi translated"><a class="ae ln" href="https://github.com/kubernetes/dashboard" rel="noopener ugc nofollow" target="_blank">安装</a>仪表板。</li></ol><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="9488" class="lp lq iq nd b gy nh ni l nj nk">&gt; kubectl apply -f <a class="ae ln" href="https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml</a></span></pre><p id="445e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">仪表板-具有管理功能的用户界面。对于度量收集，需要安装Heapster。</p><p id="db39" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">2.<a class="ae ln" href="https://github.com/kubernetes/heapster/" rel="noopener ugc nofollow" target="_blank">安装带有influxDB的</a> heapster，用于度量存储。</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="cf04" class="lp lq iq nd b gy nh ni l nj nk">&gt; git clone <a class="ae ln" href="https://github.com/kubernetes/heapster.git" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes/heapster.git</a><br/>&gt; cd heapster<br/>&gt; kubectl create -f deploy/kube-config/influxdb/<br/>&gt; kubectl create -f deploy/kube-config/rbac/heapster-rbac.yaml</span></pre><p id="ee24" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">3.在所有pod成功启动后，启动ku bectl proxy for open dashboard web应用程序。</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="117c" class="lp lq iq nd b gy nh ni l nj nk">&gt; kubectl proxy</span></pre><p id="8082" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">kube代理开始监听本地主机上的8001端口。将下一行放到浏览器中。</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="5a0d" class="lp lq iq nd b gy nh ni l nj nk"><a class="ae ln" href="http://localhost:8001/" rel="noopener ugc nofollow" target="_blank"><strong class="nd ir">http://localhost:8001/ui</strong></a></span></pre><p id="8d8a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">kebernetes给你一个日志页面，有两个选项:用kubeconfig或token登录。最简单的方法是使用令牌。<strong class="kt ir"> kubeadm令牌列表</strong>将显示所有创建的令牌。选择其中一个登录应用程序。</p><h2 id="8dd6" class="lp lq iq bd lr ls lt dn lu lv lw dp lx la ly lz ma le mb mc md li me mf mg mh bi translated">提示和技巧</h2><ul class=""><li id="0844" class="mi mj iq kt b ku mk kx ml la mm le mn li mo lm mp mq mr ms bi translated"><strong class="kt ir">如果虚拟机的CPU少于2个，kube-dns </strong>不会启动。</li><li id="4ccf" class="mi mj iq kt b ku mt kx mu la mv le mw li mx lm mp mq mr ms bi translated">有时登录仪表板后会返回安全错误:</li></ul><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="0418" class="lp lq iq nd b gy nh ni l nj nk">User "system:bootstrap:883ae1" cannot list configmaps in the namespace "default"</span></pre><p id="9106" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">只需将用户添加到集群管理组:</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="1f76" class="lp lq iq nd b gy nh ni l nj nk">&gt; kubectl create clusterrolebinding --user system:bootstrap:883ae1 kube-system-cluster-admin --clusterrole cluster-admin</span></pre><ul class=""><li id="dd96" class="mi mj iq kt b ku kv kx ky la my le mz li na lm mp mq mr ms bi translated">描述系统单元:</li></ul><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="9533" class="lp lq iq nd b gy nh ni l nj nk">kubectl describe pod kube-apiserver-kube-master -n kube-system</span></pre><ul class=""><li id="d33d" class="mi mj iq kt b ku kv kx ky la my le mz li na lm mp mq mr ms bi translated">显示窗格中的日志:</li></ul><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="b490" class="lp lq iq nd b gy nh ni l nj nk">kubectl logs kube-dns-6f4fd4bdf-kr8wh -n kube-system</span></pre><p id="976f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">享受吧。</p></div></div>    
</body>
</html>