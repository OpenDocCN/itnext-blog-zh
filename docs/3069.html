<html>
<head>
<title>GitHub Actions CI configuration for Ruby on Rails project with MySQL, Redis, Elasticsearch — how to run parallel tests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用MySQL、Redis、Elasticsearch为Ruby on Rails项目配置GitHub Actions CI——如何运行并行测试</h1>
<blockquote>原文：<a href="https://itnext.io/github-actions-ci-configuration-for-ruby-on-rails-project-with-mysql-redis-elasticsearch-how-82ed417e3a3d?source=collection_archive---------6-----------------------#2019-09-27">https://itnext.io/github-actions-ci-configuration-for-ruby-on-rails-project-with-mysql-redis-elasticsearch-how-82ed417e3a3d?source=collection_archive---------6-----------------------#2019-09-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="ee5c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将学习如何在GitHub Actions上配置Ruby on Rails项目。这个特定的Rails项目有MySQL和Redis数据库。CI上还运行着Elasticsearch服务。如果您的项目接近下面的设置，那么yaml配置将允许您在GitHub CI服务器上运行测试。</p><p id="d8c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你碰巧使用PostgreSQL，你可以查看我们之前的一篇关于在GitHub上使用Postgres配置<a class="ae kl" href="https://docs.knapsackpro.com/2019/how-to-run-rspec-on-github-actions-for-ruby-on-rails-app-using-parallel-jobs" rel="noopener ugc nofollow" target="_blank"> Rails应用程序的文章</a>。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/5065110ca43528a45e93198a924320fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DDDTJgK1OTMry-RI.png"/></div></div></figure><h1 id="c4a3" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">Rails的GitHub操作配置</h1><p id="bad7" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">在您的存储库中，您需要创建文件<code class="fe mb mc md me b">.github/workflows/main.yaml</code>,由于它GitHub Actions将运行您的CI构建。您可以在GitHub存储库页面上的Actions选项卡中找到已执行CI构建的结果。</p><p id="b48e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本例中，<strong class="jp ir"> Rails </strong>应用有<strong class="jp ir"> MySQL </strong>、<strong class="jp ir"> Redis </strong>和<strong class="jp ir"> Elasticsearch </strong>数据库。您需要用docker容器设置服务来运行每个服务。在下面的配置中，还有一个对MySQL和Elasticsearch进行健康检查的步骤，以确保在开始运行测试之前两者都已启动并运行。</p><p id="6a71" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于GitHub Actions中的矩阵特性和<a class="ae kl" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=github-actions-ci-config-for-ruby-on-rails-project-with-mysql-redis-elasticsearch-how-to-run-parallel-tests" rel="noopener ugc nofollow" target="_blank">backpack Pro</a>ruby gem可以自动平衡任务间的测试分布，所以测试可以跨并行任务执行。使用背包Pro队列模式的自动平衡测试将确保每个并行作业在相似的时间完成工作。由于没有瓶颈(没有运行太多测试的缓慢工作),您可以享受快速的CI构建时间，因为您可以在并行任务中获得最佳的测试划分。</p><pre class="kn ko kp kq gt mf me mg mh aw mi bi"><span id="9980" class="mj kz iq me b gy mk ml l mm mn"># .github/workflows/main.yaml<br/>name: Main</span><span id="1208" class="mj kz iq me b gy mo ml l mm mn">on: [push]</span><span id="1259" class="mj kz iq me b gy mo ml l mm mn">jobs:<br/>  vm-job:<br/>    name: CI<br/>    runs-on: ubuntu-latest</span><span id="e2ea" class="mj kz iq me b gy mo ml l mm mn"># If you need DB like MySQL then define service below.<br/>    # Example for PostgreSQL and Redis can be found here:<br/>    # <a class="ae kl" href="https://github.com/actions/example-services/tree/master/.github/workflows" rel="noopener ugc nofollow" target="_blank">https://github.com/actions/example-services/tree/master/.github/workflows</a><br/>    services:<br/>      # How to use MySQL<br/>      mysql:<br/>        image: mysql:5.7<br/>        env:<br/>          MYSQL_ROOT_PASSWORD: root<br/>        ports:<br/>        - 3306<br/>        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3<br/>      # How to use Redis<br/>      redis:<br/>        image: redis<br/>        ports:<br/>        - 6379/tcp<br/>      # How to use Elasticsearch<br/>      elasticsearch:<br/>        image: elasticsearch:6.8.3<br/>        ports:<br/>        - 9200/tcp<br/>        options: -e="discovery.type=single-node" --health-cmd="curl <a class="ae kl" href="http://localhost:9200/_cluster/health" rel="noopener ugc nofollow" target="_blank">http://localhost:9200/_cluster/health</a>" --health-interval=10s --health-timeout=5s --health-retries=10</span><span id="1f10" class="mj kz iq me b gy mo ml l mm mn"># <a class="ae kl" href="https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idstrategymatrix" rel="noopener ugc nofollow" target="_blank">https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idstrategymatrix</a><br/>    strategy:<br/>      fail-fast: false<br/>      matrix:<br/>        # Set N number of parallel jobs you want to run tests on.<br/>        # Use higher number if you have slow tests to split them on more parallel jobs.<br/>        # Remember to update ci_node_index below to 0..N-1<br/>        ci_node_total: [5]<br/>        # set N-1 indexes for parallel jobs<br/>        # When you run 2 parallel jobs then first job will have index 0, the second job will have index 1 etc<br/>        ci_node_index: [0, 1, 2, 3, 4]</span><span id="5393" class="mj kz iq me b gy mo ml l mm mn">steps:<br/>    - name: Set up Ruby 2.6<br/>      uses: actions/setup-ruby@v1<br/>      with:<br/>        ruby-version: 2.6.3</span><span id="1fb4" class="mj kz iq me b gy mo ml l mm mn">- name: Checkout<br/>      uses: actions/checkout@v1<br/>      with:<br/>        fetch-depth: 1</span><span id="16ce" class="mj kz iq me b gy mo ml l mm mn">- name: Verify MySQL connection from host<br/>      run: |<br/>        sudo apt-get install -y mysql-client libmysqlclient-dev<br/>        mysql --host 127.0.0.1 --port ${{ job.services.mysql.ports[3306] }} -uroot -proot -e "SHOW GRANTS FOR 'root'@'localhost'"<br/>        mysql_tzinfo_to_sql /usr/share/zoneinfo | mysql --host 127.0.0.1 --port ${{ job.services.mysql.ports[3306] }} -uroot -proot mysql<br/>    - name: Verify Elasticsearch connection from host<br/>      env:<br/>        ELASTIC_SEARCH_URL: <a class="ae kl" href="http://localhost:${{" rel="noopener ugc nofollow" target="_blank">http://localhost:${{</a> job.services.elasticsearch.ports[9200] }}<br/>      run: |<br/>        echo $ELASTIC_SEARCH_URL<br/>        curl -fsSL "$ELASTIC_SEARCH_URL/_cat/health?h=status"<br/>    - name: Bundle Install and Create DB<br/>      env:<br/>        RAILS_ENV: test<br/>        DB_PASSWORD: root<br/>        # tell Rails to use proper port for MySQL<br/>        DB_PORT: ${{ job.services.mysql.ports[3306] }}<br/>      run: |<br/>        cp .env.sample .env<br/>        cp config/database.yml.ci config/database.yml<br/>        gem install bundler --version 1.17.3 --no-ri --no-rdoc<br/>        bundle install --jobs 4 --retry 3 --path vendor/bundle<br/>        # create DB for Rails 5.x<br/>        bin/rails db:setup<br/>        # create DB for Rails 6.x<br/>        bin/rails db:prepare<br/>    - name: Run tests<br/>      env:<br/>        DB_PASSWORD: root<br/>        DB_PORT: ${{ job.services.mysql.ports[3306] }} # get randomly assigned published port<br/>        REDIS_PORT: ${{ job.services.redis.ports[6379] }}<br/>        ELASTIC_SEARCH_URL: <a class="ae kl" href="http://localhost:${{" rel="noopener ugc nofollow" target="_blank">http://localhost:${{</a> job.services.elasticsearch.ports[9200] }}<br/>        RAILS_ENV: test<br/>        # You need to set API tokens in GitHub repository Settings -&gt; Secrets<br/>        KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC: ${{ secrets.KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC }}<br/>        KNAPSACK_PRO_TEST_SUITE_TOKEN_CUCUMBER: ${{ secrets.KNAPSACK_PRO_TEST_SUITE_TOKEN_CUCUMBER }}<br/>        KNAPSACK_PRO_TEST_SUITE_TOKEN_MINITEST: ${{ secrets.KNAPSACK_PRO_TEST_SUITE_TOKEN_MINITEST }}<br/>        KNAPSACK_PRO_TEST_SUITE_TEST_UNIT: ${{ secrets.KNAPSACK_PRO_TEST_SUITE_TOKEN_TEST_UNIT }}<br/>        KNAPSACK_PRO_TEST_SUITE_TOKEN_SPINACH: ${{ secrets.KNAPSACK_PRO_TEST_SUITE_TOKEN_SPINACH }}<br/>        KNAPSACK_PRO_CI_NODE_TOTAL: ${{ matrix.ci_node_total }}<br/>        KNAPSACK_PRO_CI_NODE_INDEX: ${{ matrix.ci_node_index }}<br/>      run: |<br/>        # run tests in Knapsack Pro Regular Mode<br/>        bundle exec rake knapsack_pro:rspec<br/>        bundle exec rake knapsack_pro:cucumber<br/>        bundle exec rake knapsack_pro:minitest<br/>        bundle exec rake knapsack_pro:test_unit<br/>        bundle exec rake knapsack_pro:spinach<br/>        # you can use Knapsack Pro in Queue Mode once recorded first CI build with Regular Mode<br/>        bundle exec rake knapsack_pro:queue:rspec<br/>        bundle exec rake knapsack_pro:queue:cucumber<br/>        bundle exec rake knapsack_pro:queue:minitest</span></pre><h1 id="1838" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">背包专业队列模式如何工作</h1><p id="5a9b" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">在本视频中，您将了解跨并行作业(并行CI节点)拆分的动态测试套件如何工作。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><h1 id="76a0" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">背包专业常规模式如何工作</h1><p id="fc86" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated"><a class="ae kl" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=github-actions-ci-config-for-ruby-on-rails-project-with-mysql-redis-elasticsearch-how-to-run-parallel-tests" rel="noopener ugc nofollow" target="_blank">backpack Pro</a>也有一种确定性的拆分测试方式。在运行测试之前，测试只被拆分一次。在切换到队列模式之前，这是您第一次尝试记录CI构建的最简单的方法。</p><p id="5a15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在<a class="ae kl" href="https://docs.knapsackpro.com/integration/" rel="noopener ugc nofollow" target="_blank">安装指南</a>中了解更多关于背包Pro的信息。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><h1 id="77f3" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">摘要</h1><p id="a37c" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">如果你想了解更多关于GitHub动作的信息，请查看我们之前的文章<a class="ae kl" href="https://docs.knapsackpro.com/2019/how-to-run-rspec-on-github-actions-for-ruby-on-rails-app-using-parallel-jobs" rel="noopener ugc nofollow" target="_blank">在GitHub动作上用PostgreSQL测试Rails应用</a>。还有一个视频展示了它的作用。</p></div><div class="ab cl mr ms hu mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="ij ik il im in"><p id="b3fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="my">原载于2019年9月27日</em><a class="ae kl" href="https://docs.knapsackpro.com/2019/github-actions-ci-config-for-ruby-on-rails-project-with-mysql-redis-elasticsearch-how-to-run-parallel-tests" rel="noopener ugc nofollow" target="_blank"><em class="my">https://docs.knapsackpro.com</em></a><em class="my">。</em></p></div></div>    
</body>
</html>