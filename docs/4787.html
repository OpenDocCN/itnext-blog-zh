<html>
<head>
<title>GitHub actions code coverage — Without third parties</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GitHub actions代码覆盖——没有第三方</h1>
<blockquote>原文：<a href="https://itnext.io/github-actions-code-coverage-without-third-parties-f1299747064d?source=collection_archive---------0-----------------------#2020-09-18">https://itnext.io/github-actions-code-coverage-without-third-parties-f1299747064d?source=collection_archive---------0-----------------------#2020-09-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="gh gi ju"><img src="../Images/a2d620d70f07246acac2ed61fa93187c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GQFActqsTfK2wLiH"/></div></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk translated">格伦·卡丽在<a class="ae kk" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="6bef" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi lj translated"><span class="l lk ll lm bm ln lo lp lq lr di">事实证明。使用GitHub actions将代码覆盖集成到构建管道中的方法是使用第三方解决方案，如<a class="ae kk" href="https://codecov.io/" rel="noopener ugc nofollow" target="_blank"> codcov.io </a>等。这些解决方案非常棒，但是每个用户每月的成本高达20美元。而且它们有许多并非每个人都需要的高级功能。对于拉请求的基本代码覆盖率检查和README.md中的代码覆盖率徽章，我不想按月付费。</span></p><p id="255a" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在网上搜寻免费解决方案后，我没有找到任何有用的东西。决定黑掉我的路。</p><p id="67bc" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在这篇文章中，我将展示如何使用GitHub actions和一些云存储(如s3)来为您的存储库创建一个代码覆盖率标记，以及一个GitHub status，它可以用来保护主分支，因此如果一个pull请求丢弃了代码覆盖率，它将被阻止合并。</p></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><p id="c2ab" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">GitHub徽章只是嵌入在repo README.md中的一个小SVG。创建它最简单的方法是使用<a class="ae kk" href="http://shields.io/" rel="noopener ugc nofollow" target="_blank"> shields.io </a> API。</p><p id="d85a" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kn ir"> <em class="ls">卷曲https://img.shields.io/badge/coavrege-$total%-$COLOR&gt;badge . SVG</em></strong></p><p id="1934" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">其中$COLOR是一个bash变量，包含CSS颜色，如红色、绿色、橙色。$total是另一个bash变量，百分位在0到100之间。<a class="ae kk" href="http://shields.io/" rel="noopener ugc nofollow" target="_blank"> shields.io </a>提供这个免费的实用程序太棒了。</p><p id="0249" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这个简单的一行程序可以创建一个徽章，剩下的就是将它上传到一个禁用缓存的公共存储中，并将其嵌入到一个<a class="ae kk" href="http://README.md" rel="noopener ugc nofollow" target="_blank"> README.md </a></p><h1 id="d13a" class="lt lu iq bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">徽章生成</h1><figure class="jv jw jx jy gt jz"><div class="bz fp l di"><div class="mr ms l"/></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk translated">GCP云存储示例</figcaption></figure><p id="9d2b" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">GitHub actions工作流可以在主分支的推送/合并上运行上述内容，并上传徽章，请注意<strong class="kn ir">“Cache-Control”</strong>标头，这很重要，因为至少在GCP是如此，但在AWS上也可能如此，如果您将对象上传到公共存储，默认情况下会缓存该对象，然后项目的README.md将始终包含过期版本。</p><h2 id="e23c" class="mt lu iq bd lv mu mv dn lz mw mx dp md kw my mz mh la na nb ml le nc nd mp ne bi translated">README.md</h2><figure class="jv jw jx jy gt jz"><div class="bz fp l di"><div class="mr ms l"/></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk translated">将此链接放入您的自述文件中，它将指向最新的代码覆盖率徽章。</figcaption></figure><h2 id="011a" class="mt lu iq bd lv mu mv dn lz mw mx dp md kw my mz mh la na nb ml le nc nd mp ne bi translated">GitHub操作工作流文件</h2><figure class="jv jw jx jy gt jz"><div class="bz fp l di"><div class="mr ms l"/></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk translated">GitHub工作流的一个例子，运行golang测试，并生成代码覆盖率徽章。</figcaption></figure></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><h1 id="7080" class="lt lu iq bd lv lw nf ly lz ma ng mc md me nh mg mh mi ni mk ml mm nj mo mp mq bi translated">GitHub状态</h1><p id="7224" class="pw-post-body-paragraph kl km iq kn b ko nk kq kr ks nl ku kv kw nm ky kz la nn lc ld le no lg lh li ij bi translated">这是这篇文章最令人讨厌的部分。如果代码覆盖率下降，CI失败是很常见的，使用GitHub动作实现这一点的方法是使用<a class="ae kk" href="https://docs.github.com/en/rest/reference/repos#statuses" rel="noopener ugc nofollow" target="_blank"> GitHub状态</a></p><p id="1b5c" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">GitHub <a class="ae kk" href="https://docs.github.com/en/rest/reference/repos#statuses" rel="noopener ugc nofollow" target="_blank">状态</a>是一个连接到提交的实体，任何提交都可以有许多与之相关的状态。状态可以有一个状态(错误、失败、挂起或成功)。最常见的状态示例是您的项目测试套件，当测试正在运行时，状态为挂起，如果失败，则状态为失败，如果通过，则状态为成功。这对于拉请求来说很方便，因为可以“<a class="ae kk" href="https://docs.github.com/en/github/administering-a-repository/about-protected-branches" rel="noopener ugc nofollow" target="_blank">保护分支</a>”，只有当所有状态都通过时才允许合并拉请求。</p><p id="7b3e" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">当您运行GitHub工作流时，该工作流中的任何作业都将创建一个状态(以及一个工卡)，但是状态的名称是静态的(作业的名称，就像上面示例中的<code class="fe np nq nr ns b">CodeCov</code>—第9行)。如果您希望您的状态包含动态信息，比如代码覆盖率的百分比，您将不得不更加努力地工作，所以让我们深入研究代码，稍后再解释它。</p><h2 id="bb23" class="mt lu iq bd lv mu mv dn lz mw mx dp md kw my mz mh la na nb ml le nc nd mp ne bi translated">代码覆盖率状态GitHub工作流</h2><figure class="jv jw jx jy gt jz"><div class="bz fp l di"><div class="mr ms l"/></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk translated">一个戈兰的例子</figcaption></figure><p id="f34f" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这一部分稍微长一点，它为当前的提交创建一个挂起状态，运行测试，下载主分支的代码覆盖率(当发布徽章时，我们在前面的工作流中上传了它)，并与当前运行的代码覆盖率进行比较。如果代码覆盖率下降，则它处于失败状态，否则它会将其标记为成功。</p><p id="0f48" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">注意调用<strong class="kn ir">api.github.com</strong>的两个curl命令。他们创建并更新代码覆盖率状态。</p><h1 id="b3bd" class="lt lu iq bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">这是它看起来的样子</h1><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="gh gi nt"><img src="../Images/28c6effca386cb926b600a085e86cc6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b-VbluaoAY7BP6ivUhQGcA.png"/></div></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk translated">待定支票</figcaption></figure><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="gh gi nu"><img src="../Images/35ca920f017e984f534b2f61b3059843.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fuGzJkjuEkNAyuJLEZLaXA.png"/></div></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk translated">通过检查(注意代码覆盖率的百分比)</figcaption></figure><p id="d34c" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">就是这样:)</p><p id="4e19" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">关心你的代码。测试它，不要忽略代码覆盖率。这不是最好的质量度量(90%的覆盖率并不能说明你的测试质量)，但总比什么都没有好。干杯。</p></div></div>    
</body>
</html>