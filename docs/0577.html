<html>
<head>
<title>Working with Firebase Functions — HTTP Request</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Firebase函数— HTTP请求</h1>
<blockquote>原文：<a href="https://itnext.io/working-with-firebase-functions-http-request-22fd1ab644d3?source=collection_archive---------0-----------------------#2018-04-04">https://itnext.io/working-with-firebase-functions-http-request-22fd1ab644d3?source=collection_archive---------0-----------------------#2018-04-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/4c161f1fc512a9a6dfbb7a64de7de297.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eGLVD4OsDN2aO8B979sh_g.png"/></div></div></figure><p id="1cab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您不熟悉Firebase函数，请阅读<a class="ae kw" href="https://firebase.google.com/docs/functions/get-started" rel="noopener ugc nofollow" target="_blank">函数入门文档</a>。我有机会玩一会儿HTTP请求和Firebase函数，有几个小技巧我想分享一下。</p><ol class=""><li id="720a" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated"><strong class="ka ir">如何启动HTTP请求功能</strong></li></ol><p id="fa9a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先在index.js文件中声明它</p><pre class="lg lh li lj gt lk ll lm ln aw lo bi"><span id="97c0" class="lp lq iq ll b gy lr ls l lt lu">exports.request = functions.https.onRequest((request, response) =&gt; {<br/>  // ...<br/>});</span></pre><p id="97ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过从浏览器、方法或使用HTTP服务直接调用该函数来触发该函数。有一篇关于<a class="ae kw" href="https://medium.com/google-cloud/startups-now-cronjob-your-google-firebase-functions-securely-and-externally-without-paying-for-503b0f4ca539" rel="noopener">如何调度HTTP请求到你的firebase函数</a>的非常好的文章值得一读。</p><p id="4d32" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.<strong class="ka ir">如何检查请求方法</strong></p><p id="5f1a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Firebase函数支持GET、POST、PUT、DELETE和OPTIONS方法，并且您可以检查哪种方法触发了您的函数。</p><pre class="lg lh li lj gt lk ll lm ln aw lo bi"><span id="ea79" class="lp lq iq ll b gy lr ls l lt lu">// Check for POST request<br/>if(request.method !== "POST"){<br/> res.status(400).send('Please send a POST request');<br/> return;<br/>}</span></pre><p id="6f43" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.<strong class="ka ir">如何从POST请求中获取数据</strong></p><p id="6887" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">数据(例如JSON类型)将在请求的头中。</p><pre class="lg lh li lj gt lk ll lm ln aw lo bi"><span id="5d4c" class="lp lq iq ll b gy lr ls l lt lu">let data = request.body;</span></pre><p id="db5c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">4.<strong class="ka ir">如何从你的应用/网站发送帖子请求</strong></p><p id="89a6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是我的Angular应用程序中的一个例子，它发送POST请求来触发firebase函数</p><pre class="lg lh li lj gt lk ll lm ln aw lo bi"><span id="7ae8" class="lp lq iq ll b gy lr ls l lt lu">// Using Angular HttpClient to send POST request</span><span id="3f5f" class="lp lq iq ll b gy lv ls l lt lu">const httpOptions = {<br/> headers: new HttpHeaders({<br/>   'Content-Type':  'application/json',<br/>   'Authorization': 'secret-key'<br/> })<br/>};</span><span id="1adb" class="lp lq iq ll b gy lv ls l lt lu">let data = {name: 'Dale Nguyen'};</span><span id="e7d7" class="lp lq iq ll b gy lv ls l lt lu">this.http.post('https://us-central1-dale-nguyen.cloudfunctions.net/request', data, httpOptions)<br/>.subscribe(<br/> res =&gt; {<br/>   console.log(res);<br/> },<br/> err =&gt; {<br/>   console.log("Error occured");<br/> }<br/>)</span></pre><p id="a699" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">5.<strong class="ka ir">为您的功能增加额外安全性的方法</strong></p><p id="5d17" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">感谢上面关于HTTP请求时间表的帖子，这是一些可以为你的应用程序增加额外安全性的方法。</p><p id="a698" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了安全起见，您需要创建一个唯一的密钥</p><pre class="lg lh li lj gt lk ll lm ln aw lo bi"><span id="a9c6" class="lp lq iq ll b gy lr ls l lt lu">npm install -g crypto<br/>node -e "console.log(require('crypto').randomBytes(20).toString('hex'))"</span></pre><p id="3809" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后将密钥添加到firebase配置中</p><pre class="lg lh li lj gt lk ll lm ln aw lo bi"><span id="4f34" class="lp lq iq ll b gy lr ls l lt lu">functions:config:set app_name.key='secret-key'</span></pre><p id="a817" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用密钥验证app的方式可以和上面的文章类似，直接在firebase server上对比就可以检查了。</p><pre class="lg lh li lj gt lk ll lm ln aw lo bi"><span id="9fb4" class="lp lq iq ll b gy lr ls l lt lu">// POST headers before sending to firebase server</span><span id="dd73" class="lp lq iq ll b gy lv ls l lt lu">const httpOptions = {<br/> headers: new HttpHeaders({<br/>   'Content-Type':  'application/json',<br/>   'Authorization': 'secret-key'<br/> })<br/>};</span><span id="2ce0" class="lp lq iq ll b gy lv ls l lt lu">// firebase functions check</span><span id="92da" class="lp lq iq ll b gy lv ls l lt lu">let key = functions.config().app_name.key;</span><span id="8a07" class="lp lq iq ll b gy lv ls l lt lu">let request_key = request.get('authorization');</span><span id="dec7" class="lp lq iq ll b gy lv ls l lt lu">if(key === request_key){<br/> console.log('Awesome!!!')<br/>} else {<br/> response.status(400).send('You shall not pass!!!');<br/> return;<br/>}</span></pre><p id="a7fb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">6.<strong class="ka ir">处理CORS—‘访问控制-允许-来源’</strong></p><p id="a1fb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">感谢<a class="ae kw" href="https://stackoverflow.com/questions/42755131/enabling-cors-in-cloud-functions-for-firebase" rel="noopener ugc nofollow" target="_blank"> StackOverFlow </a>，这很容易处理。</p><p id="a507" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在导入CORS之前，我们需要先安装它。</p><pre class="lg lh li lj gt lk ll lm ln aw lo bi"><span id="d19d" class="lp lq iq ll b gy lr ls l lt lu">npm install cors // Thanks John Theo for remind this step :)</span></pre><p id="1e41" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后把它放到index.js文件中</p><pre class="lg lh li lj gt lk ll lm ln aw lo bi"><span id="32c0" class="lp lq iq ll b gy lr ls l lt lu">// Add CORS to your index.js<br/>const cors = require('cors')({origin: true});</span><span id="9129" class="lp lq iq ll b gy lv ls l lt lu">// Put this line to your function<br/>// Automatically allow cross-origin requests<br/>cors(req, res, () =&gt; {});</span></pre><p id="b099" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> 7。发送带参数的GET请求(Angular) </strong></p><pre class="lg lh li lj gt lk ll lm ln aw lo bi"><span id="971f" class="lp lq iq ll b gy lr ls l lt lu">/*<br/> * Send GET request with parameters from Angular<br/> * https://angular.io/api/http/RequestOptionsArgs<br/> */<br/><br/>import { Http, Headers } from '@angular/http';<br/><br/>// Prepare the header <br/>let headers: Headers = new Headers();<br/>headers.set('parameter-name' , 'parameter-value);<br/><br/>// Send request with parameters            <br/>this.http.get('url', {<br/>  headers: headers<br/>}).subscribe(res =&gt; resolve(res.json()));            </span></pre><p id="6644" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了从header中获取参数，您可以在firebase函数中使用这段代码</p><pre class="lg lh li lj gt lk ll lm ln aw lo bi"><span id="d18a" class="lp lq iq ll b gy lr ls l lt lu">// In order get the request value <br/>let params = req.headers['parameter-name'];</span></pre><p id="8bb5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">目前就这些。遇到另一个有趣的问题我会更新；)</p><p id="0e3a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请查看我的github，了解更多关于firebase函数的有趣片段。</p><div class="lw lx gp gr ly lz"><a href="https://github.com/dalenguyen/firebase-functions-snippets" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd ir gy z fp me fr fs mf fu fw ip bi translated">GitHub-dalen guyen/firebase-Functions-snippets:不可思议的Firebase函数片段…</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">这里包含了我所有涉及到编写firebase函数的作品，为了使用它，你应该知道如何…</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">github.com</p></div></div><div class="mi l"><div class="mj l mk ml mm mi mn jw lz"/></div></div></a></div><p id="277a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://twitter.com/dale_nguyen" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir">在Twitter上关注我</strong> </a>获取Angular、JavaScript &amp; WebDevelopment的最新内容👐</p></div></div>    
</body>
</html>