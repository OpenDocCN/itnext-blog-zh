<html>
<head>
<title>Kafka on Kubernetes, the Strimzi way! (Part 3)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">库伯内特斯上的卡夫卡，斯特里姆兹之路！(第三部分)</h1>
<blockquote>原文：<a href="https://itnext.io/kafka-on-kubernetes-the-strimzi-way-part-3-19cfdfe86660?source=collection_archive---------1-----------------------#2020-07-07">https://itnext.io/kafka-on-kubernetes-the-strimzi-way-part-3-19cfdfe86660?source=collection_archive---------1-----------------------#2020-07-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="562c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">欢迎来到这个关于在Kubernetes上运行卡夫卡的博客系列:</p><ul class=""><li id="3fc5" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated"><a class="ae ku" rel="noopener ugc nofollow" target="_blank" href="/kafka-on-kubernetes-the-strimzi-way-part-1-bdff3e451788?source=friends_link&amp;sk=dd9cb0a8b07ec65e62c9b9f5ae7b3986">第一部分</a></li><li id="ca5f" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated"><a class="ae ku" rel="noopener ugc nofollow" target="_blank" href="/kafka-on-kubernetes-the-strimzi-way-part-2-43192f1dd831?source=friends_link&amp;sk=e5089aa7fc2d879e11989ba141b9d3a4">第二部分</a></li><li id="83e0" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated">第3部分:这个博客</li><li id="5176" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated"><a class="ae ku" href="https://medium.com/@abhishek1987/kafka-on-kubernetes-the-strimzi-way-part-4-bf1e651e25b8" rel="noopener">第四部分</a></li></ul><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi la"><img src="../Images/b153c5eaeee335658e895a19a688f7b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dxw5n_is61e0NE3___7YYw.png"/></div></div></figure></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><p id="d4b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本博客系列的前两部分中，我们在Kubernetes上设置了一个单节点Kafka集群，使用TLS加密保护它，并使用内部和外部客户机访问代理。我们继续迭代吧！在本帖中，我们将通过Strimzi和cover继续Kafka在Kubernetes的旅程:</p><ul class=""><li id="43fc" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">如何应用不同的认证类型:<code class="fe lt lu lv lw b">TLS</code>和<code class="fe lt lu lv lw b">SASL SCRAM-SHA-512</code></li><li id="00fa" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated">使用Strimzi实体运算符管理Kafka用户和主题</li><li id="400d" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated">如何配置Kafka CLI和Go客户端应用程序以安全地连接到Kafka集群</li></ul><blockquote class="lx ly lz"><p id="aa01" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><em class="iq">代码在GitHub上可以找到—</em><a class="ae ku" href="https://github.com/abhirockzz/kafka-kubernetes-strimzi/" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://github.com/abhirockzz/kafka-kubernetes-strimzi/</em></a></p></blockquote></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><h1 id="30b0" class="me mf iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">我需要什么来浏览这个教程？</h1><p id="75de" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">https://kubernetes.io/docs/tasks/tools/install-kubectl/<code class="fe lt lu lv lw b">kubectl</code>-<a class="ae ku" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank"/></p><p id="2f43" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将使用<a class="ae ku" href="https://docs.microsoft.com/azure/aks/intro-kubernetes?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">Azure Kubernetes Service(AKS)</a>来演示这些概念，但总的来说，它是独立于Kubernetes提供者的(例如，可以随意使用本地设置，如<code class="fe lt lu lv lw b">minikube</code>)。如果你想使用<code class="fe lt lu lv lw b">AKS</code>，你只需要一个<a class="ae ku" href="https://docs.microsoft.com/azure/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">微软Azure账户</a>，如果你还没有的话，你可以<a class="ae ku" href="https://azure.microsoft.com/free/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">免费获得</a>。</p><blockquote class="lx ly lz"><p id="595b" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><em class="iq">在本系列的这一部分或后续部分，我不会重复一些常见的部分(例如安装/设置(Helm、Strimzi、Azure Kubernetes服务)、Strimzi概述),请参考第一部分</em></p></blockquote></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><h1 id="ea41" class="me mf iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">创建带有TLS身份验证的Kafka集群</h1><p id="f565" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">为了实施双向相互<code class="fe lt lu lv lw b">TLS</code>授权，我们需要做的就是调整Strimzi <code class="fe lt lu lv lw b">Kafka</code>资源。我在下面突出重点部分。其他部分保持不变(<a class="ae ku" href="https://github.com/abhirockzz/kafka-kubernetes-strimzi/raw/master/part-2/kafka.yaml" rel="noopener ugc nofollow" target="_blank">这是来自第2部分</a>的清单)，即单节点Kafka和Zookeeper、短暂存储以及<code class="fe lt lu lv lw b">TLS</code>加密</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="0c0c" class="nl mf iq lw b gy nm nn l no np">external:<br/>  type: loadbalancer<br/>  tls: true<br/>  authentication:<br/>    type: tls</span></pre><p id="4d00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们所做的就是将所有的<code class="fe lt lu lv lw b">tls</code>认证类型作为<code class="fe lt lu lv lw b">external</code>监听器的一个属性。除此之外，我们还包括<code class="fe lt lu lv lw b">entityOperator</code>配置:</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="b47f" class="nl mf iq lw b gy nm nn l no np">entityOperator:<br/>  userOperator: {}<br/>  topicOperator: {}</span></pre><p id="8944" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将激活Strimzi <code class="fe lt lu lv lw b">Entity Operator</code>，该Strimzi由<code class="fe lt lu lv lw b">Topic Operator</code>和<code class="fe lt lu lv lw b">User Operator</code>组成。正如<code class="fe lt lu lv lw b">Kafka</code> CRD允许您控制Kubernetes上的Kafka集群一样，主题操作符允许您通过名为<code class="fe lt lu lv lw b">KafkaTopic</code>的自定义资源管理Kafka集群中的主题，即您可以在Kafka集群中创建、删除和更新主题。</p><blockquote class="lx ly lz"><p id="5e30" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><em class="iq">有趣的是，这是一个双向同步，即您仍然可以通过直接访问Kafka集群来创建主题，这将反映在正在创建/更新/删除的</em> <code class="fe lt lu lv lw b"><em class="iq">KafkaTopic</em></code> <em class="iq">资源中</em></p></blockquote><p id="9980" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用户操作者的目标是在<code class="fe lt lu lv lw b">KafkaUser</code> CRD的帮助下，使Kafka用户管理更加容易。您所做的就是创建<code class="fe lt lu lv lw b">KafkaUser</code> CRDs的实例，Strimzi负责Kafka特定的用户管理部分</p><blockquote class="lx ly lz"><p id="057a" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><em class="iq">与主题操作符不同，这不是双向同步</em></p></blockquote><p id="13f9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里阅读更多关于实体操作符的内容<a class="ae ku" href="https://strimzi.io/docs/operators/master/using.html#assembly-kafka-entity-operator-deployment-configuration-kafka" rel="noopener ugc nofollow" target="_blank">https://strim zi . io/docs/operators/master/using . html # assembly-Kafka-Entity-Operator-deployment-configuration-Kafka</a></p><p id="a87c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在接下来的章节中，我们将深入探讨这两个操作符的实际应用。</p><p id="0cd7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要创建Kafka集群，请执行以下操作:</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="c5db" class="nl mf iq lw b gy nm nn l no np">kubectl apply -f <a class="ae ku" href="https://raw.githubusercontent.com/abhirockzz/kafka-kubernetes-strimzi/master/part-3/kafka-tls-auth.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/abhirockzz/kafka-kubernetes-strimzi/master/part-3/kafka-tls-auth.yaml</a></span></pre><p id="b939" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，Strimzi运算符为我们做了什么？</p><p id="d566" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在<a class="ae ku" href="https://dev.to/azure/kafka-on-kubernetes-the-strimzi-way-part-1-57g7" rel="noopener ugc nofollow" target="_blank">第一部分</a> — <code class="fe lt lu lv lw b">StatefulSet</code>(和<code class="fe lt lu lv lw b">Pods</code>)、<code class="fe lt lu lv lw b">LoadBalancer</code>服务、<code class="fe lt lu lv lw b">ConfigMap</code>、<code class="fe lt lu lv lw b">Secret</code>等中涵盖了其中的大部分。如何实施<code class="fe lt lu lv lw b">TLS</code>授权配置？为了弄清楚这一点，让我们反思一下Kafka服务器的配置</p><blockquote class="lx ly lz"><p id="5367" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><em class="iq">如第1部分所述，它存储在</em>T6中</p></blockquote><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="e0c5" class="nl mf iq lw b gy nm nn l no np">export CLUSTER_NAME=my-kafka-cluster<br/>kubectl get configmap/${CLUSTER_NAME}-kafka-config -o yaml</span></pre><p id="80fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查看<code class="fe lt lu lv lw b">server.config</code>中的<code class="fe lt lu lv lw b">External listener</code>部分:</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="7c16" class="nl mf iq lw b gy nm nn l no np">listener.name.external-9094.ssl.client.auth=required</span><span id="1269" class="nl mf iq lw b gy nq nn l no np">listener.name.external-9094.ssl.truststore.location=/tmp/kafka/clients.truststore.p12</span><span id="580f" class="nl mf iq lw b gy nq nn l no np">listener.name.external-9094.ssl.truststore.password=${CERTS_STORE_PASSWORD}</span><span id="e36f" class="nl mf iq lw b gy nq nn l no np">listener.name.external-9094.ssl.truststore.type=PKCS12</span></pre><p id="71ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面突出显示的片段是添加的部分——注意<code class="fe lt lu lv lw b">listener.name.external-9094.ssl.client.auth=required</code>是和信任库细节一起添加的。</p><p id="e2cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">别忘了实体操作符</strong></p><p id="5967" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">实体操作员运行一个单独的<code class="fe lt lu lv lw b">Deployment</code></p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="20b0" class="nl mf iq lw b gy nm nn l no np">export CLUSTER_NAME=my-kafka-cluster</span><span id="d351" class="nl mf iq lw b gy nq nn l no np">kubectl get deployment $CLUSTER_NAME-entity-operator<br/>kubectl get pod -l=app.kubernetes.io/name=entity-operator</span><span id="ec47" class="nl mf iq lw b gy nq nn l no np">NAME                                                READY   STATUS     <br/>my-kafka-cluster-entity-operator-666f8758f6-gj54h   3/3     Running</span></pre><p id="6f5a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">实体操作符<code class="fe lt lu lv lw b">Pod</code>运行三个容器- <code class="fe lt lu lv lw b">topic-operator</code>、<code class="fe lt lu lv lw b">user-operator</code>、<code class="fe lt lu lv lw b">tls-sidecar</code></p><p id="f427" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们已经配置了集群来验证客户端连接，但是客户端应用程序将使用的用户凭证呢？</p></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><h1 id="1443" class="me mf iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">是时候使用用户操作符了！</h1><p id="3aa3" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">用户操作符允许我们创建<code class="fe lt lu lv lw b">KafkaUser</code>来表示客户端认证凭证。正如博文开头提到的，支持的认证类型包括<code class="fe lt lu lv lw b">TLS</code>和<code class="fe lt lu lv lw b">SCRAM-SHA-512</code>。在幕后，Strimzi创建了一个Kubernetes <code class="fe lt lu lv lw b">Secret</code>来存储凭证</p><blockquote class="lx ly lz"><p id="811e" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><em class="iq"> OAuth 2.0也受支持，但它不由用户操作者处理</em></p></blockquote><p id="69c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们创建一个<code class="fe lt lu lv lw b">KafkaUser</code>来存储TLS auth的客户端凭证。下面是用户信息的样子:</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="7860" class="nl mf iq lw b gy nm nn l no np">apiVersion: kafka.strimzi.io/v1beta1<br/>kind: KafkaUser<br/>metadata:<br/>  name: kafka-tls-client-credentials<br/>  labels:<br/>    strimzi.io/cluster: my-kafka-cluster<br/>spec:<br/>  authentication:<br/>    type: tls</span></pre><p id="ff92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将用户命名为<code class="fe lt lu lv lw b">kafka-tls-client-credentials</code>，与我们之前创建的Kafka集群相关联(使用标签<code class="fe lt lu lv lw b">strimzi.io/cluster: my-kafka-cluster</code>，并指定<code class="fe lt lu lv lw b">tls</code>认证类型</p><blockquote class="lx ly lz"><p id="b664" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><em class="iq">您还可以在一个</em> <code class="fe lt lu lv lw b"><em class="iq">KafkaUser</em></code> <em class="iq">定义中定义授权规则(本博客未涉及)——参见</em><a class="ae ku" href="https://strimzi.io/docs/operators/master/using.html#type-KafkaUser-reference" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://strim zi . io/docs/operators/master/using . html # type-KafkaUser-reference</em></a></p></blockquote><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="1a7a" class="nl mf iq lw b gy nm nn l no np">kubectl apply -f <a class="ae ku" href="https://raw.githubusercontent.com/abhirockzz/kafka-kubernetes-strimzi/master/part-3/user-tls-auth.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/abhirockzz/kafka-kubernetes-strimzi/master/part-3/user-tls-auth.yaml</a></span></pre><p id="7f3d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">自省<code class="fe lt lu lv lw b">Secret</code>(与<code class="fe lt lu lv lw b">KafkaUser</code>同名)；</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="c7d5" class="nl mf iq lw b gy nm nn l no np">kubectl get secret/kafka-tls-client-credentials -o yaml</span></pre></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><h1 id="da7c" class="me mf iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">TLS客户端身份验证</h1><p id="9a18" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">就是这样！现在由客户机来使用凭证。我们将使用Kafka CLI和Go客户端应用程序对此进行测试。首先要做的是:</p><p id="534e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">提取并配置用户凭证</strong></p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="3602" class="nl mf iq lw b gy nm nn l no np">export KAFKA_USER_NAME=kafka-tls-client-credentials</span><span id="1f70" class="nl mf iq lw b gy nq nn l no np">kubectl get secret $KAFKA_USER_NAME -o jsonpath='{.data.user\.crt}' | base64 --decode &gt; user.crt</span><span id="9463" class="nl mf iq lw b gy nq nn l no np">kubectl get secret $KAFKA_USER_NAME -o jsonpath='{.data.user\.key}' | base64 --decode &gt; user.key</span><span id="f032" class="nl mf iq lw b gy nq nn l no np">kubectl get secret $KAFKA_USER_NAME -o jsonpath='{.data.user\.p12}' | base64 --decode &gt; user.p12</span><span id="071a" class="nl mf iq lw b gy nq nn l no np">kubectl get secret $KAFKA_USER_NAME -o jsonpath='{.data.user\.password}' | base64 --decode &gt; user.password</span></pre><p id="2101" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将<code class="fe lt lu lv lw b">user.p12</code>中的条目导入到另一个密钥库中</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="a457" class="nl mf iq lw b gy nm nn l no np">export USER_P12_FILE_PATH=user.p12<br/>export USER_KEY_PASSWORD_FILE_PATH=user.password<br/>export KEYSTORE_NAME=kafka-auth-keystore.jks<br/>export KEYSTORE_PASSWORD=foobar<br/>export PASSWORD=`cat $USER_KEY_PASSWORD_FILE_PATH`</span><span id="a188" class="nl mf iq lw b gy nq nn l no np">sudo keytool -importkeystore -deststorepass $KEYSTORE_PASSWORD -destkeystore $KEYSTORE_NAME -srckeystore $USER_P12_FILE_PATH -srcstorepass $PASSWORD -srcstoretype PKCS12</span><span id="c94c" class="nl mf iq lw b gy nq nn l no np">sudo keytool -list -alias $KAFKA_USER_NAME -keystore $KEYSTORE_NAME</span></pre><p id="504f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就像我们在第2部分中所做的一样，TLS加密配置需要在客户端信任库中导入集群CA证书</p><p id="74fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">提取并配置服务器CA证书</strong></p><p id="61e7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">提取群集CA证书和密码</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="78b9" class="nl mf iq lw b gy nm nn l no np">export CLUSTER_NAME=my-kafka-cluster</span><span id="59c7" class="nl mf iq lw b gy nq nn l no np">kubectl get secret $CLUSTER_NAME-cluster-ca-cert -o jsonpath='{.data.ca\.crt}' | base64 --decode &gt; ca.crt</span><span id="1edc" class="nl mf iq lw b gy nq nn l no np">kubectl get secret $CLUSTER_NAME-cluster-ca-cert -o jsonpath='{.data.ca\.password}' | base64 --decode &gt; ca.password</span></pre><p id="d81b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将它导入<code class="fe lt lu lv lw b">truststore</code> -我使用的是JDK (Java)安装自带的内置信任库-但这只是为了方便，你可以自由使用其他信任库</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="9512" class="nl mf iq lw b gy nm nn l no np">export CERT_FILE_PATH=ca.crt<br/>export CERT_PASSWORD_FILE_PATH=ca.password</span><span id="6383" class="nl mf iq lw b gy nq nn l no np"># replace this with the path to your truststore</span><span id="48aa" class="nl mf iq lw b gy nq nn l no np">export KEYSTORE_LOCATION=/Library/Java/JavaVirtualMachines/jdk1.8.0_221.jdk/Contents/Home/jre/lib/security/cacerts<br/>export PASSWORD=`cat $CERT_PASSWORD_FILE_PATH`</span><span id="9485" class="nl mf iq lw b gy nq nn l no np"># you will prompted for the truststore password. for JDK truststore, the default password is "changeit"<br/># Type yes in response to the 'Trust this certificate? [no]:' prompt</span><span id="a07e" class="nl mf iq lw b gy nq nn l no np">sudo keytool -importcert -alias strimzi-kafka-cert -file $CERT_FILE_PATH -keystore $KEYSTORE_LOCATION -keypass $PASSWORD</span><span id="cc19" class="nl mf iq lw b gy nq nn l no np">sudo keytool -list -alias strimzi-kafka-cert -keystore $KEYSTORE_LOCATION</span></pre><p id="19f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您应该能够使用Kafka CLI客户端对Kafka集群进行身份验证</p><blockquote class="lx ly lz"><p id="13da" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><em class="iq">请注意，下面详述的Kafka CLI配置步骤也适用于Java客户端——也可以随意尝试一下</em></p></blockquote><p id="be46" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">为Kafka CLI客户端创建属性文件</strong></p><p id="f5f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">提取Kafka集群的<code class="fe lt lu lv lw b">LoadBalancer</code>公共IP</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="501a" class="nl mf iq lw b gy nm nn l no np">export KAFKA_CLUSTER_NAME=my-kafka-cluster</span><span id="ae04" class="nl mf iq lw b gy nq nn l no np">kubectl get service/${KAFKA_CLUSTER_NAME}-kafka-external-bootstrap --output=jsonpath={.status.loadBalancer.ingress[0].ip}</span></pre><p id="e675" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用以下内容创建一个名为<code class="fe lt lu lv lw b">client-ssl-auth.properties</code>的文件:</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="d6ee" class="nl mf iq lw b gy nm nn l no np">bootstrap.servers=[LOADBALANCER_PUBLIC_IP]:9094<br/>security.protocol=SSL<br/>ssl.truststore.location=[TRUSTSTORE_LOCATION]<br/>ssl.truststore.password=changeit<br/>ssl.keystore.location=kafka-auth-keystore.jks<br/>ssl.keystore.password=foobar<br/>ssl.key.password=[contents of user.password file]</span></pre><blockquote class="lx ly lz"><p id="7254" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><code class="fe lt lu lv lw b"><em class="iq">changeit</em></code> <em class="iq">是默认的信任库密码。如果需要，请使用另一个</em></p></blockquote><p id="f651" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你还没有卡夫卡，请下载—<a class="ae ku" href="https://kafka.apache.org/downloads" rel="noopener ugc nofollow" target="_blank">https://kafka.apache.org/downloads</a></p><p id="8859" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">继续之前还有最后一件事</p><p id="8b61" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">创建一个</strong>T8】</p><p id="4fe5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如我前面提到的，主题操作符使得以<code class="fe lt lu lv lw b">KafkaTopic</code>清单的形式嵌入主题信息成为可能，如下所示:</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="d43e" class="nl mf iq lw b gy nm nn l no np">apiVersion: kafka.strimzi.io/v1beta1<br/>kind: KafkaTopic<br/>metadata:<br/>  name: strimzi-test-topic<br/>  labels:<br/>    strimzi.io/cluster: my-kafka-cluster<br/>spec:<br/>  partitions: 3<br/>  replicas: 1</span></pre><p id="a6d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要创建主题:</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="3ba5" class="nl mf iq lw b gy nm nn l no np">kubectl apply -f <a class="ae ku" href="https://raw.githubusercontent.com/abhirockzz/kafka-kubernetes-strimzi/master/part-3/topic.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/abhirockzz/kafka-kubernetes-strimzi/master/part-3/topic.yaml</a></span></pre><blockquote class="lx ly lz"><p id="15e5" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><em class="iq">这里参考一个</em><code class="fe lt lu lv lw b"><em class="iq">KafkaTopic</em></code><em class="iq">CRD</em><a class="ae ku" href="https://strimzi.io/docs/operators/master/using.html#type-KafkaTopic-reference" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://strim zi . io/docs/operators/master/using . html # type-KafkaTopic-reference</em></a></p></blockquote><p id="7277" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您所需要做的就是通过将<code class="fe lt lu lv lw b">kafka-console-producer</code>和<code class="fe lt lu lv lw b">kafka-console-consumer</code>指向您刚刚创建的<code class="fe lt lu lv lw b">client-ssl-auth.properties</code>文件来使用它们</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="e5af" class="nl mf iq lw b gy nm nn l no np">export KAFKA_HOME=[replace with kafka installation] e.g. /Users/foobar/kafka_2.12-2.3.0<br/>export LOADBALANCER_PUBLIC_IP=[replace with public-ip]<br/>export TOPIC_NAME=strimzi-test-topic</span><span id="9298" class="nl mf iq lw b gy nq nn l no np"># on a terminal, start producer and send a few messages<br/>$KAFKA_HOME/bin/kafka-console-producer.sh --broker-list $LOADBALANCER_PUBLIC_IP:9094 --topic $TOPIC_NAME --producer.config client-ssl-auth.properties</span><span id="c09e" class="nl mf iq lw b gy nq nn l no np"># on another terminal, start consumer<br/>$KAFKA_HOME/bin/kafka-console-consumer.sh --bootstrap-server $LOADBALANCER_PUBLIC_IP:9094 --topic $TOPIC_NAME --consumer.config client-ssl-auth.properties --from-beginning</span></pre><p id="1d14" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你应该看到生产者和消费者协同工作。太好了！</p><blockquote class="lx ly lz"><p id="8cd9" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><em class="iq">如果您遇到SSL握手错误，请检查密钥和证书是否已正确导入，以及您是否使用了正确的密码。如果Kafka集群不可达，请确保您对公共IP使用了正确的值</em></p></blockquote><p id="c085" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，让我们尝试一个编程式客户端。因为Java客户端行为(必需的配置属性)与CLI相同，所以我使用Go客户端来尝试一些不同的东西。不要担心，如果你不是一个围棋程序员，这应该很容易理解。</p><p id="e162" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我不会介绍整个程序，只介绍创建连接相关配置的部分。以下是片段:</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="9fad" class="nl mf iq lw b gy nm nn l no np">bootstrapServers = os.Getenv("KAFKA_BOOTSTRAP_SERVERS")<br/>caLocation = os.Getenv("CA_CERT_LOCATION")<br/>topic = os.Getenv("KAFKA_TOPIC")</span><span id="0faa" class="nl mf iq lw b gy nq nn l no np">userCertLocation = os.Getenv("USER_CERT_LOCATION")<br/>userKeyLocation = os.Getenv("USER_KEY_LOCATION")<br/>userKeyPassword = os.Getenv("USER_KEY_PASSWORD")</span><span id="1054" class="nl mf iq lw b gy nq nn l no np">producerConfig := &amp;kafka.ConfigMap{"bootstrap.servers": bootstrapServers, "security.protocol": "SSL", "ssl.ca.location": caLocation, "ssl.certificate.location": userCertLocation, "ssl.key.location": userKeyLocation, "ssl.key.password": userKeyPassword}</span></pre><p id="ac38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，<code class="fe lt lu lv lw b">bootstrap.servers</code>和<code class="fe lt lu lv lw b">security.protocol</code>与您在Kafka CLI客户端中使用的相同(对于Java也是如此)。</p><ul class=""><li id="9f96" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">对于TLS加密:<code class="fe lt lu lv lw b">ssl.ca.location</code>用于直接指向CA证书，而不是信任库</li><li id="51d0" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated">客户端认证:<code class="fe lt lu lv lw b">ssl.certificate.location</code>、<code class="fe lt lu lv lw b">ssl.key.location</code>和<code class="fe lt lu lv lw b">ssl.key.password</code>分别指用户证书、用户密钥和密码</li></ul><p id="5876" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你已经安装了<code class="fe lt lu lv lw b">Go</code>，可以尝试一下。克隆Git repo</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="f273" class="nl mf iq lw b gy nm nn l no np">git clone https://github.com/abhirockzz/kafka-kubernetes-strimzi<br/>cd part-3/go-client-app</span></pre><p id="434e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">..并运行程序:</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="d7f6" class="nl mf iq lw b gy nm nn l no np">export KAFKA_BOOTSTRAP_SERVERS=[replace with public-ip:9094] e.g. 20.43.176.7:9094<br/>export CA_CERT_LOCATION=[replace with location of ca.crt file] e.g. /Users/code/kafka-kubernetes-strimzi/part-3/ca.crt<br/>export KAFKA_TOPIC=test-strimzi-topic</span><span id="601d" class="nl mf iq lw b gy nq nn l no np">export USER_CERT_LOCATION=[path to user.crt file] e.g. /Users/code/kafka-kubernetes-strimzi/part-3/user.crt<br/>export USER_KEY_LOCATION=[path to user.key file] e.g. /Users/code/kafka-kubernetes-strimzi/part-3/user.key<br/>export USER_KEY_PASSWORD=[contents of user.password file]</span><span id="94e3" class="nl mf iq lw b gy nq nn l no np">go run kafka-tls-auth-client.go</span></pre><p id="5d58" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">日志应该确认消息是否被生成和使用</p></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><h1 id="6256" class="me mf iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">强制紧急停堆-SHA-512授权</h1><p id="f209" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated"><code class="fe lt lu lv lw b">SCRAM</code>代表“Salted Challenge Response认证机制”。我不会假装是安全专家或<code class="fe lt lu lv lw b">SCRAM</code>专家，但是我想强调的是，它是Kafka中受支持的和常用的认证机制之一(除此之外还有其他如<code class="fe lt lu lv lw b">PLAIN</code></p><blockquote class="lx ly lz"><p id="ac88" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><em class="iq">请注意，在编写</em>时，Strimzi不支持 <code class="fe lt lu lv lw b"><em class="iq">SASL PLAIN</em></code> <em class="iq"> auth</em></p></blockquote><p id="50cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">更新卡夫卡集群</strong></p><p id="0839" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要应用<code class="fe lt lu lv lw b">SCRAM</code>认证方案——您需要做的就是将<code class="fe lt lu lv lw b">authentication.type</code>设置为<code class="fe lt lu lv lw b">scram-sha-512</code></p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="0d2b" class="nl mf iq lw b gy nm nn l no np">external:<br/>  type: loadbalancer<br/>  tls: true<br/>  authentication:<br/>    <strong class="lw ir">type: scram-sha-512</strong></span></pre><p id="0099" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">更新Kafka集群以使用<code class="fe lt lu lv lw b">SCRAM-SHA</code>认证</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="3174" class="nl mf iq lw b gy nm nn l no np">kubectl apply -f <a class="ae ku" href="https://raw.githubusercontent.com/abhirockzz/kafka-kubernetes-strimzi/master/part-3/kafka-tls-auth.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/abhirockzz/kafka-kubernetes-strimzi/master/part-3/kafka-tls-auth.yaml</a></span></pre><p id="2fb5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们看看Kafka服务器配置在这种情况下是什么样子的:</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="2ce9" class="nl mf iq lw b gy nm nn l no np">export CLUSTER_NAME=my-kafka-cluster<br/>kubectl get configmap/${CLUSTER_NAME}-kafka-config -o yaml</span></pre><p id="d450" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">检查<code class="fe lt lu lv lw b">server.config</code>中的<code class="fe lt lu lv lw b">External listener</code>部分，注意配置是如何更新的</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="37bd" class="nl mf iq lw b gy nm nn l no np">listener.name.external-9094.scram-sha-512.sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required;<br/>    <br/>listener.name.external-9094.sasl.enabled.mechanisms=SCRAM-SHA-512</span></pre><p id="0ea4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">创建急停凭证(</strong> <code class="fe lt lu lv lw b"><strong class="jp ir">KafkaUser</strong></code> <strong class="jp ir"> ) </strong></p><p id="a0e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就像我们对<code class="fe lt lu lv lw b">TLS</code> auth所做的一样，我们也需要为<code class="fe lt lu lv lw b">SCRAM</code>创建客户端凭证。它只是在名称和类型上不同于它的TLS等价物(当然！)</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="a08f" class="nl mf iq lw b gy nm nn l no np">apiVersion: kafka.strimzi.io/v1beta1<br/>kind: KafkaUser<br/>metadata:<br/>  name: kafka-scram-client-credentials<br/>  labels:<br/>    strimzi.io/cluster: my-kafka-cluster<br/>spec:<br/>  authentication:<br/>    <strong class="lw ir">type: scram-sha-512</strong></span></pre><blockquote class="lx ly lz"><p id="dd86" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><em class="iq">注意，</em> <code class="fe lt lu lv lw b"><em class="iq">authentication.type</em></code> <em class="iq">是</em> <code class="fe lt lu lv lw b"><em class="iq">scram-sha-512</em></code></p></blockquote><p id="cc9e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建<code class="fe lt lu lv lw b">KafkaUser</code></p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="574f" class="nl mf iq lw b gy nm nn l no np">kubectl apply -f <a class="ae ku" href="https://raw.githubusercontent.com/abhirockzz/kafka-kubernetes-strimzi/master/part-3/user-scram-auth.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/abhirockzz/kafka-kubernetes-strimzi/master/part-3/user-scram-auth.yaml</a></span></pre><p id="2e0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">自省<code class="fe lt lu lv lw b">Secret</code>(与<code class="fe lt lu lv lw b">KafkaUser</code>同名):</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="8276" class="nl mf iq lw b gy nm nn l no np">kubectl get secret/kafka-scram-client-credentials -o yaml</span></pre><p id="d85f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lt lu lv lw b">Secret</code>包含<code class="fe lt lu lv lw b">base64</code>编码形式的<code class="fe lt lu lv lw b">password</code></p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="5160" class="nl mf iq lw b gy nm nn l no np">apiVersion: v1<br/>kind: Secret<br/>name: kafka-scram-client-credentials<br/>data:<br/>  password: SnpteEQwek1DNkdi<br/>...</span></pre><blockquote class="lx ly lz"><p id="dfa1" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><em class="iq">用户名与</em> <code class="fe lt lu lv lw b"><em class="iq">KafkaUser</em></code> <em class="iq"> / </em> <code class="fe lt lu lv lw b"><em class="iq">Secret</em></code> <em class="iq">名称相同，在本例中为</em><code class="fe lt lu lv lw b"><em class="iq">kafka-scram-client-credentials</em></code><em class="iq"/></p></blockquote><p id="02bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">运行客户端应用</strong></p><p id="f2b8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了运行客户端示例，请下载密码:</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="ff80" class="nl mf iq lw b gy nm nn l no np">export USER_NAME=kafka-scram-client-credentials</span><span id="b0ac" class="nl mf iq lw b gy nq nn l no np">kubectl get secret $USER_NAME -o jsonpath='{.data.password}' | base64 --decode &gt; user-scram.password</span></pre><p id="a75d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了测试Kafka CLI客户端，创建一个包含以下内容的文件<code class="fe lt lu lv lw b">client-scram-auth.properties</code>:</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="6172" class="nl mf iq lw b gy nm nn l no np">bootstrap.servers=[replace with public-ip:9094]<br/>security.protocol=SASL_SSL<br/>sasl.mechanism=SCRAM-SHA-512<br/>ssl.truststore.location=[replace with path to truststore with kafka CA cert]</span><span id="7474" class="nl mf iq lw b gy nq nn l no np"># "changeit" is the default password for JDK truststore, please use the one applicable to yours</span><span id="2825" class="nl mf iq lw b gy nq nn l no np">ssl.truststore.password=changeit</span><span id="234d" class="nl mf iq lw b gy nq nn l no np">sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required username="kafka-scram-client-credentials" password="[replace with contents of user-scram.password file]";</span></pre><p id="2f3c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请参考上面的说明来运行控制台生产者和消费者</p><blockquote class="lx ly lz"><p id="5082" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><em class="iq">请确保你使用的是</em> <code class="fe lt lu lv lw b"><em class="iq">client-scram-auth.properties</em></code> <em class="iq">而不是</em> <code class="fe lt lu lv lw b"><em class="iq">client-tls-auth.properties</em></code> <em class="iq">文件</em></p></blockquote><p id="9e8b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在结束之前，让我们看一下Go客户端，看看它是如何处理<code class="fe lt lu lv lw b">SCRAM</code>认证的。和往常一样，我将只强调展示配置的部分:</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="d875" class="nl mf iq lw b gy nm nn l no np">bootstrapServers = os.Getenv("KAFKA_BOOTSTRAP_SERVERS")<br/>caLocation = os.Getenv("CA_CERT_LOCATION")<br/>topic = os.Getenv("KAFKA_TOPIC")</span><span id="cb3b" class="nl mf iq lw b gy nq nn l no np">kafkaScramUsername = os.Getenv("SCRAM_USERNAME")<br/>kafkaScramPassword = os.Getenv("SCRAM_PASSWORD")</span><span id="b08a" class="nl mf iq lw b gy nq nn l no np">producerConfig := &amp;kafka.ConfigMap{"bootstrap.servers": bootstrapServers, "security.protocol": "SASL_SSL", "ssl.ca.location": caLocation, "sasl.mechanism": "SCRAM-SHA-512", "sasl.username": kafkaScramUsername, "sasl.password": kafkaScramPassword}</span></pre><p id="7692" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lt lu lv lw b">security.protocol</code>和<code class="fe lt lu lv lw b">sasl.mechanism</code>分别更新为<code class="fe lt lu lv lw b">SASL_SSL</code>和<code class="fe lt lu lv lw b">SCRAM-SHA-512</code>。同时，我们使用<code class="fe lt lu lv lw b">sasl.username</code>和<code class="fe lt lu lv lw b">sasl.password</code>来指定客户端凭证</p><p id="f095" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行<code class="fe lt lu lv lw b">Go</code>客户端应用程序:</p><pre class="lb lc ld le gt nh lw ni nj aw nk bi"><span id="8900" class="nl mf iq lw b gy nm nn l no np">export KAFKA_BOOTSTRAP_SERVERS=[replace with public-ip:9094]<br/>export CA_CERT_LOCATION=[path to ca.crt file] f.g. /Users/code/kafka-kubernetes-strimzi/part-3/ca.crt<br/>export KAFKA_TOPIC=strimzi-test-topic</span><span id="eac5" class="nl mf iq lw b gy nq nn l no np">export SCRAM_USERNAME=kafka-scram-client-credentials<br/>export SCRAM_PASSWORD=[contents of user-scram.password file]</span><span id="7ed4" class="nl mf iq lw b gy nq nn l no np">go run kafka-scram-auth-client.go</span></pre></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><h1 id="916b" class="me mf iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">包裹..目前</h1><p id="a678" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">这篇文章覆盖了相当多的领域！我们学习了如何应用不同的身份验证类型，使用实体操作符来管理Kafka用户和主题，更重要的是，了解了如何配置客户端应用程序，以使用TLS加密和所选身份验证方案的组合来安全连接。</p><p id="618c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还远没有结束！与此同时，我们一直在创建没有持久性的<code class="fe lt lu lv lw b">ephemeral</code>集群——我们将在接下来的文章中修复这个问题。</p></div></div>    
</body>
</html>