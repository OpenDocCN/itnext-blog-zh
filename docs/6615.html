<html>
<head>
<title>Autoscale Gitlab Runners in AWS, GCP and Azure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS、GCP和Azure中的Autoscale Gitlab运行程序</h1>
<blockquote>原文：<a href="https://itnext.io/autoscale-gitlab-runners-in-aws-gcp-and-azure-b9b6f4d7e17?source=collection_archive---------1-----------------------#2022-01-05">https://itnext.io/autoscale-gitlab-runners-in-aws-gcp-and-azure-b9b6f4d7e17?source=collection_archive---------1-----------------------#2022-01-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/53fd23028b3ca29d3d4a85541a2d294d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b8V78VDwJUs4-CDsICI8JA.png"/></div></div></figure><p id="2aff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">依我拙见，我认为Gitlab是托管我们代码的优秀工具。免费和付费计划都包括大量功能，如git回购、问题管理、CI/CD管道代码、包注册、秘密管理等。</p><p id="e03f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不过，有一个问题(根据我的经验)，就是运行CI/CD管道的时间限制。</p><p id="ff6f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">幸运的是，Gitlab为我们提供了在我们自己的基础设施中运行管道的选择，这种管道被称为<a class="ae kw" href="https://docs.gitlab.com/runner/install/" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> Gitlab runner </strong> </a>。这意味着在我们自己的服务器/计算机上运行CI/CD作业没有限制，只要它们连接到互联网。</p><p id="f6b3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Gitlab跑步者可以这样跑步:</p><ul class=""><li id="bbb7" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">独立服务，带有Linux、Windows、macOS和FreeBSD客户端，</li><li id="19a1" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">码头集装箱，或</li><li id="ef05" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">Kubernetes部署</li></ul><p id="319f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本文中，我们将重点关注使用<a class="ae kw" href="https://gitlab.com/gitlab-org/ci-cd/docker-machine" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> Docker machine </strong> </a>将Gitlab runners作为Docker容器<strong class="ka ir"> </strong>运行:</p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ll"><img src="../Images/71348b40fc75326360daf7766f064879.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*_-zzQ2OX6_GaWeyrxBbSrA.gif"/></div></div></figure><p id="e600" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如<a class="ae kw" href="https://docs.gitlab.com/runner/configuration/autoscale.html" rel="noopener ugc nofollow" target="_blank">文档页面</a>和上图所述，Gitlab服务器(如gitlab.com)将持续与<em class="lq"> Bastion主机(</em>在我们自己的基础设施中准备)通信，以在新的CI/CD作业开始时创建新的虚拟机，然后在作业结束时销毁虚拟机。两个创建&amp;销毁事件都将由堡垒主机中的Docker机器执行。</p><p id="c0a1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">注意</strong>:这个节点可以是一个虚拟机，一个容器或者一个系统服务。为了简单起见，让我们在运行CI/CD作业虚拟机的同一个云中使用一个非常小的虚拟机。</p><p id="359c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我不会深入探究所有Gitlab runner选项，因为它们在<a class="ae kw" href="https://docs.gitlab.com/runner/configuration/advanced-configuration.html" rel="noopener ugc nofollow" target="_blank">官方页面</a>中有很好的记录。然而，docker machine文档并没有超越AWS ec2☹️，因此，我将基于AWS示例给出一些Google云和Azure的例子。</p><p id="6324" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，让我们开始查看<a class="ae kw" href="https://docs.gitlab.com/runner/configuration/runner_autoscale_aws/#getting-it-all-together" rel="noopener ugc nofollow" target="_blank"> AWS EC2示例</a>来配置Gitlab runner Bastion主机:</p><figure class="lm ln lo lp gt jr"><div class="bz fp l di"><div class="lr ls l"/></div></figure><p id="5cc1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这种配置将使Gitlab能够同时运行多达10个作业，使用支持docker-in-docker功能的docker容器。</p><p id="ddd0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们转到<strong class="ka ir"> runners.machine </strong>选项。给定官方页面中记录的AWS示例:</p><figure class="lm ln lo lp gt jr"><div class="bz fp l di"><div class="lr ls l"/></div></figure><p id="3630" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以看到，我们只需要按照Docker机器的名称(<em class="lq"> amazonec2 </em>、<em class="lq"> google </em>、<em class="lq"> azure </em>、…)来设置它们的驱动程序，然后定义它们所需的选项(比如访问键、机器大小、网络名称等等)。</p><p id="2272" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这意味着，如果我们看一看不同的<a class="ae kw" href="https://gitlab.com/gitlab-org/ci-cd/docker-machine/-/tree/main/drivers" rel="noopener ugc nofollow" target="_blank"> Docker机器驱动程序</a>选项，我们将能够在其他云中旋转虚拟机。这正是我们要做的😊让我们使用Google Cloud GCE探索一个类似的配置:</p><figure class="lm ln lo lp gt jr"><div class="bz fp l di"><div class="lr ls l"/></div></figure><p id="1f87" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者作为Azure虚拟机:</p><figure class="lm ln lo lp gt jr"><div class="bz fp l di"><div class="lr ls l"/></div></figure><p id="dc98" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如你所见，天空是无限的🚀从现在开始，Gitlab runner应该支持每个Docker机器驱动程序及其各自的选项，以按需旋转新的虚拟机来运行CI/CD作业。</p><p id="7e46" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">暂时就这样吧！如果您在使用这些示例时有任何问题，请<a class="ae kw" href="https://www.linkedin.com/in/nicosingh" rel="noopener ugc nofollow" target="_blank">告诉我</a>。根据我的经验，当Bastion主机拥有IAM权限在每个云上创建&amp;销毁虚拟机时，上面发布的GCP和Azure配置都能正常工作。</p><div class="lt lu gp gr lv lw"><a href="https://github.com/sponsors/nicosingh" rel="noopener  ugc nofollow" target="_blank"><div class="lx ab fo"><div class="ly ab lz cl cj ma"><h2 class="bd ir gy z fp mb fr fs mc fu fw ip bi translated">GitHub赞助商上的赞助商@nicosingh</h2><div class="md l"><h3 class="bd b gy z fp mb fr fs mc fu fw dk translated">非常感谢你的支持😊我感谢你对做开源软件和分享知识的认可…</h3></div><div class="me l"><p class="bd b dl z fp mb fr fs mc fu fw dk translated">github.com</p></div></div><div class="mf l"><div class="mg l mh mi mj mf mk jw lw"/></div></div></a></div></div></div>    
</body>
</html>