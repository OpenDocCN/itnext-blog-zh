<html>
<head>
<title>Getting started with Azure Data Explorer using the Go SDK</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Go SDK开始使用Azure Data Explorer</h1>
<blockquote>原文：<a href="https://itnext.io/getting-started-with-azure-data-explorer-using-the-go-sdk-807c50bc8105?source=collection_archive---------3-----------------------#2020-07-23">https://itnext.io/getting-started-with-azure-data-explorer-using-the-go-sdk-807c50bc8105?source=collection_archive---------3-----------------------#2020-07-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="a453" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在一个例子的帮助下，这篇博文将带你了解如何使用<a class="ae kl" href="https://docs.microsoft.com/azure/data-explorer/kusto/api/golang/kusto-golang-client-library?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure Data explorer Go SDK </a>从<a class="ae kl" href="https://docs.microsoft.com/azure/storage/blobs/storage-blobs-introduction?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure Blob storage </a>容器中获取数据，并使用SDK以编程方式查询数据。在快速概述了如何设置Azure Data Explorer集群(和一个数据库)之后，我们将研究代码以了解发生了什么(以及如何发生),并最终使用一个简单的CLI界面测试应用程序</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/3281168afb46ac0a08fcf96a0c90c417.png" data-original-src="https://miro.medium.com/v2/resize:fit:1314/format:webp/0*E34G1Seg3mucfSpB.jpg"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">使用Go SDK的Azure Data Explorer</figcaption></figure><p id="ccf2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">样本数据是一个CSV文件，可以从这里下载<a class="ae kl" href="https://kustosamplefiles.blob.core.windows.net/samplefiles/StormEvents.csv?st=2018-08-31T22:02:25Z&amp;se=2020-09-01T22:02:00Z&amp;sp=r&amp;sv=2018-03-28&amp;sr=b&amp;sig=LQIbomcKI8Ooz425hWtjeq6d61uEaq21UVX7YrM61N4=%22" rel="noopener ugc nofollow" target="_blank"/></p><blockquote class="ky kz la"><p id="6e28" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated"><em class="iq">代码在GitHub</em><a class="ae kl" href="https://github.com/abhirockzz/azure-dataexplorer-go" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://github.com/abhirockzz/azure-dataexplorer-go</em></a>上有</p></blockquote><h1 id="e47b" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">什么是Azure Data Explorer？</h1><p id="127b" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated"><a class="ae kl" href="https://docs.microsoft.com/azure/data-explorer/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure Data Explorer </a>(也称为<strong class="jp ir"> Kusto </strong>)是一种快速、可扩展的数据探索服务，用于分析来自任何数据源的大量不同数据，如网站、应用程序、物联网设备等。这些数据可用于诊断、监控、报告、机器学习和其他分析功能。</p><p id="cbe5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它支持<a class="ae kl" href="https://docs.microsoft.com/azure/data-explorer/ingest-data-overview?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">几种摄取方法</a>，包括到通用服务的连接器，如<a class="ae kl" href="https://docs.microsoft.com/azure/data-explorer/ingest-data-event-hub?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">事件中心</a>，使用SDK的编程摄取，如<a class="ae kl" href="https://docs.microsoft.com/azure/data-explorer/net-sdk-ingest-data?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">。NET </a>和<a class="ae kl" href="https://docs.microsoft.com/azure/data-explorer/python-ingest-data?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Python </a>，并直接访问引擎进行探索。它还集成了分析和建模服务，使用<a class="ae kl" href="https://docs.microsoft.com/azure/data-explorer/power-bi-best-practices?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Power BI </a>等工具进行额外的数据分析和可视化</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mi"><img src="../Images/6651c2e6f98d08324ba59405399db90e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*y1r03EoYvgczCNjZ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae kl" href="https://docs.microsoft.com/azure/data-explorer/data-explorer-overview?WT.mc_id=medium-blog-abhishgu#azure-data-explorer-flow" rel="noopener ugc nofollow" target="_blank"> Azure数据浏览器流程</a></figcaption></figure><h2 id="abd5" class="mn lg iq bd lh mo mp dn ll mq mr dp lp jy ms mt lt kc mu mv lx kg mw mx mb my bi translated">Go SDK for Azure Data Explorer</h2><p id="2845" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/Azure/azure-kusto-go" rel="noopener ugc nofollow" target="_blank">Go客户端SDK </a>允许您使用<a class="ae kl" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Go </a>查询、控制和接收Azure Data Explorer集群。请注意，这是为了与Azure Data Explorer集群(以及相关组件，如表等)进行交互。).创建Azure Data Explorer集群、数据库等。你应该使用<a class="ae kl" href="https://github.com/Azure/azure-sdk-for-go/tree/master/services/kusto/mgmt" rel="noopener ugc nofollow" target="_blank">管理组件(控制平面)SDK </a>，它是更大的<a class="ae kl" href="https://docs.microsoft.com/azure/developer/go/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure SDK for Go </a>的一部分</p><blockquote class="ky kz la"><p id="5094" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated"><em class="iq"> API文档—【https://godoc.org/github.com/Azure/azure-kusto-go】<a class="ae kl" href="https://godoc.org/github.com/Azure/azure-kusto-go" rel="noopener ugc nofollow" target="_blank"><em class="iq"/></a></em></p></blockquote><p id="c767" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在开始之前，下面是您试用示例应用程序所需的内容</p></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><h1 id="e6b4" class="lf lg iq bd lh li ng lk ll lm nh lo lp lq ni ls lt lu nj lw lx ly nk ma mb mc bi translated">先决条件</h1><p id="9bee" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated"><a class="ae kl" href="https://golang.org/dl/" rel="noopener ugc nofollow" target="_blank">安装Go 1.13或以上</a></p><p id="c4d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你需要一个<a class="ae kl" href="https://docs.microsoft.com/azure/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">微软Azure账户</a>。去吧<a class="ae kl" href="https://azure.microsoft.com/free/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">注册一个免费的！</a></p><p id="6461" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装Azure CLI 如果你还没有的话(应该很快！)</p></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><h1 id="12bf" class="lf lg iq bd lh li ng lk ll lm nh lo lp lq ni ls lt lu nj lw lx ly nk ma mb mc bi translated">设置Azure Data Explorer群集，创建数据库并配置安全性</h1><p id="e289" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">首先使用<a class="ae kl" href="https://docs.microsoft.com/cli/azure/kusto/cluster?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-kusto-cluster-create" rel="noopener ugc nofollow" target="_blank"> az kusto集群创建</a>创建一个集群。完成后，使用<a class="ae kl" href="https://docs.microsoft.com/cli/azure/kusto/database?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-kusto-database-create" rel="noopener ugc nofollow" target="_blank"> az kusto database create </a>创建一个数据库，例如</p><pre class="kn ko kp kq gt nl nm nn no aw np bi"><span id="db78" class="mn lg iq nm b gy nq nr l ns nt">az kusto cluster create -l "Central US" -n MyADXCluster -g MyADXResGrp --sku Standard_D11_v2 --capacity 2</span><span id="5672" class="mn lg iq nm b gy nu nr l ns nt">az kusto database create --cluster-name MyADXCluster -g MyADXResGrp -n MyADXdb</span><span id="a7c8" class="mn lg iq nm b gy nu nr l ns nt">az kusto database show --cluster-name MyADXCluster --name MyADXdb --resource-group MyADXResGrp</span></pre><p id="666c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<a class="ae kl" href="https://docs.microsoft.com/cli/azure/ad/sp?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-ad-sp-create-for-rbac" rel="noopener ugc nofollow" target="_blank"> az ad sp create-for-rbac </a>创建服务主体</p><pre class="kn ko kp kq gt nl nm nn no aw np bi"><span id="c699" class="mn lg iq nm b gy nq nr l ns nt">az ad sp create-for-rbac -n "test-datax-sp"</span></pre><p id="7e8b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将得到一个JSON响应——请记下<code class="fe nv nw nx nm b">appId</code>、<code class="fe nv nw nx nm b">password</code>和<code class="fe nv nw nx nm b">tenant</code>,因为您将在后续步骤中使用它们</p><pre class="kn ko kp kq gt nl nm nn no aw np bi"><span id="e907" class="mn lg iq nm b gy nq nr l ns nt">{<br/>  "appId": "fe7280c7-5705-4789-b17f-71a472340429",<br/>  "displayName": "test-datax-sp",<br/>  "name": "http://test-datax-sp",<br/>  "password": "29c719dd-f2b3-46de-b71c-4004fb6116ee",<br/>  "tenant": "42f988bf-86f1-42af-91ab-2d7cd011db42"<br/>}</span></pre><p id="9420" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您需要为<a class="ae kl" href="https://docs.microsoft.com/azure/active-directory/develop/app-objects-and-service-principals?WT.mc_id=medium-blog-abhishgu#service-principal-object" rel="noopener ugc nofollow" target="_blank">服务主体</a>分配角色，以便它可以访问您刚刚创建的数据库。要使用Azure门户实现这一点，请打开Azure Data Explorer集群，导航到<code class="fe nv nw nx nm b">Data &gt; Databases</code>并选择数据库。从左侧菜单中选择<code class="fe nv nw nx nm b">Permissions</code>并点击<code class="fe nv nw nx nm b">Add</code>继续。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi ny"><img src="../Images/9e4c7a158ae948dd18ead4e7c86ea6f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SySAQkQqXrRAgwRx.png"/></div></div></figure><blockquote class="ky kz la"><p id="bf95" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated"><em class="iq">更多信息，请参考</em> <a class="ae kl" href="https://docs.microsoft.com/azure/data-explorer/security?WT.mc_id=medium-blog-abhishgu#role-based-access-control" rel="noopener ugc nofollow" target="_blank"> <em class="iq">安全Azure中的Azure Data Explorer集群</em> </a></p></blockquote></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><h1 id="137a" class="lf lg iq bd lh li ng lk ll lm nh lo lp lq ni ls lt lu nj lw lx ly nk ma mb mc bi translated">代码遍历</h1><p id="08c3" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">概括地说，示例代码是这样做的:</p><ul class=""><li id="f8af" class="nz oa iq jp b jq jr ju jv jy ob kc oc kg od kk oe of og oh bi translated">连接到一个Azure Data Explorer集群(当然！)</li><li id="5702" class="nz oa iq jp b jq oi ju oj jy ok kc ol kg om kk oe of og oh bi translated">创建一个表格(并列出它们以确保万无一失)</li><li id="c7da" class="nz oa iq jp b jq oi ju oj jy ok kc ol kg om kk oe of og oh bi translated">创建数据映射</li><li id="c6f4" class="nz oa iq jp b jq oi ju oj jy ok kc ol kg om kk oe of og oh bi translated">从Azure Blob存储中的CSV文件接收/加载现有数据</li><li id="da46" class="nz oa iq jp b jq oi ju oj jy ok kc ol kg om kk oe of og oh bi translated">对您刚刚摄取的数据运行查询</li></ul><p id="7bce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们来看看每一个步骤</p><h2 id="8952" class="mn lg iq bd lh mo mp dn ll mq mr dp lp jy ms mt lt kc mu mv lx kg mw mx mb my bi translated">连接到Azure数据浏览器群集</h2><p id="4a1b" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">我们使用服务主体对Azure Data Explorer进行身份验证，并提供Azure租户ID、客户端ID和客户端机密(在使用<code class="fe nv nw nx nm b">az ad sp create-for-rbac</code>创建主体后获得)</p><pre class="kn ko kp kq gt nl nm nn no aw np bi"><span id="bf70" class="mn lg iq nm b gy nq nr l ns nt">auth := kusto.Authorization{Config: auth.NewClientCredentialsConfig(clientID, clientSecret, tenantID)}<br/>kc, err := kusto.New(kustoEndpoint, auth)<br/>if err != nil {<br/>    log.Fatal("failed to create kusto client", err)<br/>}</span></pre><blockquote class="ky kz la"><p id="62f8" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated"><em class="iq">你可以在这里</em> <a class="ae kl" href="https://github.com/abhirockzz/azure-dataexplorer-go/blob/master/cli/util/util.go#L12" rel="noopener ugc nofollow" target="_blank"> <em class="iq">查看代码</em> </a></p></blockquote><h2 id="b164" class="mn lg iq bd lh mo mp dn ll mq mr dp lp jy ms mt lt kc mu mv lx kg mw mx mb my bi translated">创建表和数据映射</h2><p id="1e4e" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">要创建一个表，我们只需执行<code class="fe nv nw nx nm b">create table</code></p><pre class="kn ko kp kq gt nl nm nn no aw np bi"><span id="3946" class="mn lg iq nm b gy nq nr l ns nt">func CreateTable(kc *kusto.Client, kustoDB string) {<br/>    _, err := kc.Mgmt(context.Background(), kustoDB, kusto.NewStmt(createTableCommand))<br/>    if err != nil {<br/>        log.Fatal("failed to create table", err)<br/>    }</span><span id="41b3" class="mn lg iq nm b gy nu nr l ns nt">    log.Printf("table %s created\n", kustoTable)<br/>}</span></pre><blockquote class="ky kz la"><p id="b8a9" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated"><em class="iq">您可以在这里</em> <a class="ae kl" href="https://github.com/abhirockzz/azure-dataexplorer-go/blob/master/setup/setup.go#L22" rel="noopener ugc nofollow" target="_blank"> <em class="iq">查看代码</em> </a></p></blockquote><p id="7737" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意我们如何使用<a class="ae kl" href="https://godoc.org/github.com/Azure/azure-kusto-go/kusto#Client.Mgmt" rel="noopener ugc nofollow" target="_blank">客户端。Mgmt </a>来执行这个操作，因为这是一个<code class="fe nv nw nx nm b">management</code>查询。稍后，您将看到如何执行查询从Azure Data Explorer读取数据。</p><p id="1c32" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了确认，我们运行一个查询来检查数据库中的表，即<code class="fe nv nw nx nm b">show tables</code></p><pre class="kn ko kp kq gt nl nm nn no aw np bi"><span id="50bf" class="mn lg iq nm b gy nq nr l ns nt">func FindTable(kc *kusto.Client, kustoDB string) []TableInfo {<br/>    var tables []TableInfo<br/>    ri, err := kc.Mgmt(context.Background(), kustoDB, kusto.NewStmt(testQuery))<br/>    if err != nil {<br/>        log.Fatalf("failed to execute query %s - %s", testQuery, err)<br/>    }<br/>    var t TableInfo<br/>    for {<br/>        row, err := ri.Next()<br/>        if err != nil {<br/>            if err == io.EOF {<br/>                break<br/>            } else {<br/>                log.Println("error", err)<br/>            }<br/>        }<br/>        row.ToStruct(&amp;t)<br/>        tables = append(tables, t)<br/>    }<br/>    return tables<br/>}<br/>...<br/>type TableInfo struct {<br/>    Name string `kusto:"TableName"`<br/>    DB   string `kusto:"DatabaseName"`<br/>}</span></pre><blockquote class="ky kz la"><p id="0458" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated"><em class="iq">你可以在这里</em> <a class="ae kl" href="https://github.com/abhirockzz/azure-dataexplorer-go/blob/master/setup/setup.go#L32" rel="noopener ugc nofollow" target="_blank"> <em class="iq">查看代码</em> </a></p></blockquote><p id="1a82" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">执行查询后，<code class="fe nv nw nx nm b"><a class="ae kl" href="https://github.com/Azure/azure-kusto-go/blob/master/kusto/data/table/table.go#L120" rel="noopener ugc nofollow" target="_blank">ToStruct</a></code>用于将结果保存到一个用户定义的<code class="fe nv nw nx nm b">TableInfo</code>结构的实例中</p><p id="1255" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦创建了表，我们就可以<a class="ae kl" href="https://docs.microsoft.com/azure/data-explorer/kusto/management/mappings?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">配置数据映射</a>,在摄取过程中使用这些映射将输入数据映射到Kusto表中的列</p><pre class="kn ko kp kq gt nl nm nn no aw np bi"><span id="1cfc" class="mn lg iq nm b gy nq nr l ns nt">func CreateMapping(kc *kusto.Client, kustoDB string) {<br/>    _, err := kc.Mgmt(context.Background(), kustoDB, kusto.NewStmt(createMappingCommand))<br/>    if err != nil {<br/>        log.Fatal("failed to create mapping", err)<br/>    }<br/>    log.Printf("mapping %s created\n", kustoMappingRefName)<br/>}</span></pre><blockquote class="ky kz la"><p id="0597" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated"><em class="iq">你可以在这里</em> <a class="ae kl" href="https://github.com/abhirockzz/azure-dataexplorer-go/blob/master/setup/setup.go#L61" rel="noopener ugc nofollow" target="_blank"> <em class="iq">查看代码</em> </a></p></blockquote><h2 id="6951" class="mn lg iq bd lh mo mp dn ll mq mr dp lp jy ms mt lt kc mu mv lx kg mw mx mb my bi translated">从Azure Blob存储中接收数据</h2><p id="c394" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">为了获取数据，我们使用了<code class="fe nv nw nx nm b"><a class="ae kl" href="https://godoc.org/github.com/Azure/azure-kusto-go/kusto/ingest#Ingestion" rel="noopener ugc nofollow" target="_blank">Ingestion</a></code>客户端</p><pre class="kn ko kp kq gt nl nm nn no aw np bi"><span id="23d2" class="mn lg iq nm b gy nq nr l ns nt">const blobStorePathFormat = "https://%s.blob.core.windows.net/%s/%s%s"</span><span id="4c4d" class="mn lg iq nm b gy nu nr l ns nt">func CSVFromBlob(kc *kusto.Client, blobStoreAccountName, blobStoreContainer, blobStoreToken, blobStoreFileName, kustoMappingRefName, kustoDB, kustoTable string) {<br/>    kIngest, err := ingest.New(kc, kustoDB, kustoTable)<br/>    if err != nil {<br/>        log.Fatal("failed to create ingestion client", err)<br/>    }<br/>    blobStorePath := fmt.Sprintf(blobStorePathFormat, blobStoreAccountName, blobStoreContainer, blobStoreFileName, blobStoreToken)<br/>    err = kIngest.FromFile(context.Background(), blobStorePath, ingest.FileFormat(ingest.CSV), ingest.IngestionMappingRef(kustoMappingRefName, ingest.CSV))</span><span id="833e" class="mn lg iq nm b gy nu nr l ns nt">    if err != nil {<br/>        log.Fatal("failed to ingest file", err)<br/>    }<br/>    log.Println("Ingested file from -", blobStorePath)<br/>}</span></pre><blockquote class="ky kz la"><p id="761b" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated"><em class="iq">你可以在这里</em> <a class="ae kl" href="https://github.com/abhirockzz/azure-dataexplorer-go/blob/master/load/ingest.go#L15" rel="noopener ugc nofollow" target="_blank"> <em class="iq">查看代码</em> </a></p></blockquote><p id="8ee7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在Azure Blob存储中有文件的路径，我们在<code class="fe nv nw nx nm b"><a class="ae kl" href="https://godoc.org/github.com/Azure/azure-kusto-go/kusto/ingest#Ingestion.FromFile" rel="noopener ugc nofollow" target="_blank">FromFile</a></code>函数中引用它以及文件类型(本例中为<code class="fe nv nw nx nm b">CSV</code>)和我们刚刚创建的数据映射(<code class="fe nv nw nx nm b">StormEvents_CSV_Mapping</code>)</p><h2 id="db0f" class="mn lg iq bd lh mo mp dn ll mq mr dp lp jy ms mt lt kc mu mv lx kg mw mx mb my bi translated">查询数据</h2><p id="e47e" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">我们使用以下查询从<code class="fe nv nw nx nm b">StormEvents</code>表中获取一些数据:</p><pre class="kn ko kp kq gt nl nm nn no aw np bi"><span id="c69f" class="mn lg iq nm b gy nq nr l ns nt">StormEvents | where EventType == 'Flood' and State == 'WASHINGTON' | sort by DamageProperty desc | project StartTime, EndTime, Source, DamageProperty</span></pre><p id="00de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这一次，我们使用<code class="fe nv nw nx nm b">client.Query</code>(不是<code class="fe nv nw nx nm b">Mgmt</code>)从表中读取数据。</p><pre class="kn ko kp kq gt nl nm nn no aw np bi"><span id="8069" class="mn lg iq nm b gy nq nr l ns nt">func Get(kc *kusto.Client, kustoDB string) []StormDetails {<br/>    var events []StormDetail<br/>    ri, err := kc.Query(context.Background(), kustoDB, kusto.NewStmt(query))</span><span id="30e3" class="mn lg iq nm b gy nu nr l ns nt">    if err != nil {<br/>        log.Fatalf("failed to execute query %s - %s", query, err)<br/>    }<br/>    for {<br/>        row, err := ri.Next()<br/>        if err != nil {<br/>            if err == io.EOF {<br/>                break<br/>            } else {<br/>                log.Println("error", err)<br/>            }<br/>        }<br/>        var event StormDetail<br/>        row.ToStruct(&amp;event)<br/>        events = append(events, event)<br/>    }<br/>    return events<br/>...<br/>type StormDetail struct {<br/>    Start  time.Time `kusto:"StartTime"`<br/>    End    time.Time `kusto:"EndTime"`<br/>    From   string    `kusto:"Source"`<br/>    Damage int32     `kusto:"DamageProperty"`<br/>}</span></pre><p id="dd29" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<code class="fe nv nw nx nm b">ToStruct</code>将结果中的每一行转换成一个<code class="fe nv nw nx nm b">StormDetail</code>结构</p><blockquote class="ky kz la"><p id="899e" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated"><em class="iq">您可以在这里</em> <a class="ae kl" href="https://github.com/abhirockzz/azure-dataexplorer-go/blob/master/query/query.go#L15" rel="noopener ugc nofollow" target="_blank"> <em class="iq">查看代码</em> </a></p></blockquote><p id="c7db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，列表以用户友好的表格格式显示到标准输出中</p><pre class="kn ko kp kq gt nl nm nn no aw np bi"><span id="9d63" class="mn lg iq nm b gy nq nr l ns nt">...<br/>data := [][]string{}<br/>for _, detail := range details {<br/>    data = append(data, []string{detail.Start.String(), detail.End.String(), detail.From, strconv.Itoa(int(detail.Damage))})<br/>}<br/>log.Println("StormEvents data....")<br/>table := tablewriter.NewWriter(os.Stdout)<br/>table.SetHeader([]string{"Start Time", "End Time", "From", "Damage"})</span><span id="b215" class="mn lg iq nm b gy nu nr l ns nt">for _, v := range data {<br/>    table.Append(v)<br/>}<br/>table.Render()<br/>...</span></pre><blockquote class="ky kz la"><p id="1e9a" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated"><em class="iq">您可以在这里</em> <a class="ae kl" href="https://github.com/abhirockzz/azure-dataexplorer-go/blob/master/cli/query.go#L23" rel="noopener ugc nofollow" target="_blank"> <em class="iq">查看代码</em> </a></p></blockquote><p id="837d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，为了删除表格，我们使用<code class="fe nv nw nx nm b">.drop table StormEvents</code></p><pre class="kn ko kp kq gt nl nm nn no aw np bi"><span id="04d9" class="mn lg iq nm b gy nq nr l ns nt">const dropTableQ = ".drop table StormEvents"</span><span id="c172" class="mn lg iq nm b gy nu nr l ns nt">func dropTable(kc *kusto.Client) {<br/>    _, err := kc.Mgmt(context.Background(), kustoDB, kusto.NewStmt(dropTableQ))<br/>    if err != nil {<br/>        log.Fatal("failed to drop table - ", err)<br/>    }<br/>}</span></pre><blockquote class="ky kz la"><p id="576e" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated"><em class="iq">您可以在</em> <a class="ae kl" href="https://github.com/abhirockzz/azure-dataexplorer-go/blob/master/setup/setup.go#L72" rel="noopener ugc nofollow" target="_blank"> <em class="iq">这里查看代码</em> </a></p></blockquote></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><h1 id="5d7f" class="lf lg iq bd lh li ng lk ll lm nh lo lp lq ni ls lt lu nj lw lx ly nk ma mb mc bi translated">运行示例</h1><p id="12de" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">现在您已经知道发生了什么，让我们使用CLI来尝试一下</p><p id="cab2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">设置所需的环境变量</p><pre class="kn ko kp kq gt nl nm nn no aw np bi"><span id="7153" class="mn lg iq nm b gy nq nr l ns nt">export AZURE_SP_CLIENT_ID="service principal client id"<br/>export AZURE_SP_CLIENT_SECRET="&lt;service principal client secret&gt;"<br/>export AZURE_SP_TENANT_ID="&lt;tenant ID&gt;"</span><span id="0ace" class="mn lg iq nm b gy nu nr l ns nt">#e.g. https://mykusto.southeastasia.kusto.windows.net<br/>export KUSTO_ENDPOINT="https://&lt;cluster name&gt;.&lt;azure region&gt;.kusto.windows.net"</span></pre><p id="5785" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">获取代码并构建它</p><pre class="kn ko kp kq gt nl nm nn no aw np bi"><span id="1252" class="mn lg iq nm b gy nq nr l ns nt">git clone https://github.com/abhirockzz/azure-dataexplorer-go<br/>cd azure-dataexplorer-go<br/>go build -o azdatax</span><span id="f2cc" class="mn lg iq nm b gy nu nr l ns nt">//to confirm<br/>chmod a+x azdatax &amp;&amp; ./azdatax</span><span id="75c6" class="mn lg iq nm b gy nu nr l ns nt">//output<br/>CLI to test sample program for Azure Data Explorer</span><span id="0151" class="mn lg iq nm b gy nu nr l ns nt">Usage:<br/>  azdatax [command]</span><span id="1ffa" class="mn lg iq nm b gy nu nr l ns nt">Available Commands:<br/>  create-mapping creates a mapping named StormEvents_CSV_Mapping<br/>  create-table   creates a table named StormEvents<br/>  drop-table     drops the StormEvents table<br/>  get            queries data from StormEvents<br/>  help           Help about any command<br/>  ingest         ingests CSV file from blob store<br/>  list-tables    lists tables</span><span id="a7f3" class="mn lg iq nm b gy nu nr l ns nt">Flags:<br/>  -h, --help   help for azdatax</span><span id="9a01" class="mn lg iq nm b gy nu nr l ns nt">Use "azdatax [command] --help" for more information about a command.</span></pre><p id="8860" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们首先创建一个表:</p><pre class="kn ko kp kq gt nl nm nn no aw np bi"><span id="2532" class="mn lg iq nm b gy nq nr l ns nt">./azdatax create-table --dbname &lt;name of the database you created initially&gt;</span><span id="ec32" class="mn lg iq nm b gy nu nr l ns nt">//output<br/>Connected to Azure Data Explorer<br/>table StormEvents created</span></pre><p id="8bf0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要列出表格:</p><pre class="kn ko kp kq gt nl nm nn no aw np bi"><span id="9957" class="mn lg iq nm b gy nq nr l ns nt">./azdatax list-tables --dbname &lt;name of the database you created initially&gt;</span><span id="476c" class="mn lg iq nm b gy nu nr l ns nt">//output<br/>Connected to Azure Data Explorer<br/>Table name: StormEvents, Database name: testkustodb</span></pre><p id="bae3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要创建数据映射:</p><pre class="kn ko kp kq gt nl nm nn no aw np bi"><span id="b8cf" class="mn lg iq nm b gy nq nr l ns nt">./azdatax create-mapping --dbname &lt;name of the database you created initially&gt;</span><span id="e846" class="mn lg iq nm b gy nu nr l ns nt">//output<br/>Connected to Azure Data Explorer<br/>mapping StormEvents_CSV_Mapping created</span></pre><p id="910c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要摄取数据:</p><pre class="kn ko kp kq gt nl nm nn no aw np bi"><span id="4918" class="mn lg iq nm b gy nq nr l ns nt">./azdatax ingest --dbname &lt;name of the database you created initially&gt;</span><span id="ae16" class="mn lg iq nm b gy nu nr l ns nt">//output</span><span id="37fe" class="mn lg iq nm b gy nu nr l ns nt">Connected to Azure Data Explorer<br/>Ingested file from - <a class="ae kl" href="https://kustosamplefiles.blob.core.windows.net/samplefiles/StormEvents.csv?st=2018-08-31T22%3A02%3A25Z&amp;se=2020-09-01T22%3A02%3A00Z&amp;sp=r&amp;sv=2018-03-28&amp;sr=b&amp;sig=LQIbomcKI8Ooz425hWtjeq6d61uEaq21UVX7YrM61N4%3D" rel="noopener ugc nofollow" target="_blank">https://kustosamplefiles.blob.core.windows.net/samplefiles/StormEvents.csv?st=2018-08-31T22%3A02%3A25Z&amp;se=2020-09-01T22%3A02%3A00Z&amp;sp=r&amp;sv=2018-03-28&amp;sr=b&amp;sig=LQIbomcKI8Ooz425hWtjeq6d61uEaq21UVX7YrM61N4%3D</a></span></pre><p id="2bb9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在尝试查询数据(下一步)之前，请等待一段时间，等待接收完成</p><p id="276c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要查询数据:</p><pre class="kn ko kp kq gt nl nm nn no aw np bi"><span id="46ad" class="mn lg iq nm b gy nq nr l ns nt">./azdatax get --dbname &lt;name of the database you created initially&gt;</span><span id="26f4" class="mn lg iq nm b gy nu nr l ns nt">//output<br/>Connected to Azure Data Explorer<br/>StormEvents data....<br/>+-------------------------------+-------------------------------+---------------------------+----------+<br/>|          START TIME           |           END TIME            |           FROM            |  DAMAGE  |<br/>+-------------------------------+-------------------------------+---------------------------+----------+<br/>| 2007-12-02 23:00:00 +0000 UTC | 2007-12-05 23:00:00 +0000 UTC | Official NWS Observations | 50000000 |<br/>| 2007-01-03 00:00:00 +0000 UTC | 2007-01-03 22:00:00 +0000 UTC | Newspaper                 |    20000 |<br/>| 2007-12-03 03:00:00 +0000 UTC | 2007-12-05 19:00:00 +0000 UTC | Official NWS Observations |    12000 |<br/>| 2007-01-03 00:00:00 +0000 UTC | 2007-01-03 22:00:00 +0000 UTC | Newspaper                 |     5000 |<br/>| 2007-03-12 00:00:00 +0000 UTC | 2007-03-13 23:00:00 +0000 UTC | Public                    |        0 |<br/>| 2007-03-12 00:00:00 +0000 UTC | 2007-03-14 23:00:00 +0000 UTC | Other Federal             |        0 |<br/>+-------------------------------+-------------------------------+---------------------------+----------+</span></pre><p id="deb8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，删除StormEvents表:</p><pre class="kn ko kp kq gt nl nm nn no aw np bi"><span id="cb24" class="mn lg iq nm b gy nq nr l ns nt">./azdatax drop-table --dbname &lt;name of the database you created initially&gt;</span><span id="4013" class="mn lg iq nm b gy nu nr l ns nt">//output<br/>Connected to Azure Data Explorer<br/>Table StormEvents dropped</span></pre></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><h1 id="c772" class="lf lg iq bd lh li ng lk ll lm nh lo lp lq ni ls lt lu nj lw lx ly nk ma mb mc bi translated">结论</h1><p id="fb66" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">希望这有助于演示如何使用Go SDK与Azure Data Explorer交互。这显然只是其中的一种方式！更多信息，请阅读文档，祝您探索愉快！</p></div></div>    
</body>
</html>