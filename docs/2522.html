<html>
<head>
<title>Enforcing code quality in Elixir</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Elixir中加强代码质量</h1>
<blockquote>原文：<a href="https://itnext.io/enforcing-code-quality-in-elixir-20f87efc7e66?source=collection_archive---------1-----------------------#2019-06-07">https://itnext.io/enforcing-code-quality-in-elixir-20f87efc7e66?source=collection_archive---------1-----------------------#2019-06-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b1f35d79d9075269a5a53cd79d609bfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EaXybdKQ8iNVaPH1"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://unsplash.com/@jeremythomasphoto?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">杰瑞米·托马斯</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><p id="5b13" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">强制你的仙丹代码格式良好，没有警告，希望没有错误。我说的是一个<em class="lb">混合别名</em>，它将检查代码的质量，可以在本地开发期间使用，也可以在CI/CD管道上使用，以强制团队(或您自己)保持一个干净的代码。但是请记住，没有魔法，您仍然有责任创建一个组织良好、高性能、没有安全问题、易于阅读的代码。</p><h2 id="659b" class="lc ld iq bd le lf lg dn lh li lj dp lk ko ll lm ln ks lo lp lq kw lr ls lt lu bi translated">目录</h2><ul class=""><li id="3ae8" class="lv lw iq kf b kg lx kk ly ko lz ks ma kw mb la mc md me mf bi translated"><a class="ae kc" href="https://medium.com/p/20f87efc7e66#ef9e" rel="noopener">工具</a></li><li id="744d" class="lv lw iq kf b kg mg kk mh ko mi ks mj kw mk la mc md me mf bi translated"><a class="ae kc" href="https://medium.com/p/20f87efc7e66#a4e5" rel="noopener">实施</a></li><li id="4cec" class="lv lw iq kf b kg mg kk mh ko mi ks mj kw mk la mc md me mf bi translated"><a class="ae kc" href="https://medium.com/p/20f87efc7e66#ebb2" rel="noopener">正在执行</a></li><li id="c75a" class="lv lw iq kf b kg mg kk mh ko mi ks mj kw mk la mc md me mf bi translated"><a class="ae kc" href="https://medium.com/p/20f87efc7e66#48a2" rel="noopener">完整的示例文件</a></li><li id="ea8c" class="lv lw iq kf b kg mg kk mh ko mi ks mj kw mk la mc md me mf bi translated"><a class="ae kc" href="https://medium.com/p/20f87efc7e66#e9c1" rel="noopener">参考文献</a></li></ul><h1 id="ea5b" class="ml ld iq bd le mm mn mo lh mp mq mr lk ms mt mu ln mv mw mx lq my mz na lt nb bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="e2e5" class="pw-post-body-paragraph kd ke iq kf b kg lx ki kj kk ly km kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated">完整的例子在文末的<a class="ae kc" href="https://medium.com/p/20f87efc7e66#48a2" rel="noopener">。</a></p><h1 id="ef9e" class="ml ld iq bd le mm mn mo lh mp mq mr lk ms mt mu ln mv mw mx lq my mz na lt nb bi translated">工具</h1><h2 id="5937" class="lc ld iq bd le lf lg dn lh li lj dp lk ko ll lm ln ks lo lp lq kw lr ls lt lu bi translated">信条和透析器</h2><p id="26cc" class="pw-post-body-paragraph kd ke iq kf b kg lx ki kj kk ly km kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated"><a class="ae kc" href="https://github.com/rrrene/credo" rel="noopener ugc nofollow" target="_blank"> Credo </a>负责检查代码是否符合由社区建立的通用良好代码实践。<a class="ae kc" href="http://erlang.org/doc/man/dialyzer.html" rel="noopener ugc nofollow" target="_blank">透析器</a>是一个静态分析工具，它可以识别软件差异，如明确的类型错误、由于编程错误而失效或无法访问的代码(解释官方文档)，但我们将使用<a class="ae kc" href="https://github.com/jeremyjh/dialyxir" rel="noopener ugc nofollow" target="_blank"> dialyxir </a>，它是用Elixir编写的透析器包装器，简化了透析器的使用。</p><h2 id="1c1e" class="lc ld iq bd le lf lg dn lh li lj dp lk ko ll lm ln ks lo lp lq kw lr ls lt lu bi translated">索贝洛</h2><p id="bcf6" class="pw-post-body-paragraph kd ke iq kf b kg lx ki kj kk ly km kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated">Sobelow是一个面向Phoenix框架的安全静态分析工具。如果您没有使用Phoenix，只需将它从本文描述的deps、configs和alias中删除即可。</p><h2 id="2781" class="lc ld iq bd le lf lg dn lh li lj dp lk ko ll lm ln ks lo lp lq kw lr ls lt lu bi translated">混合格式</h2><p id="b41c" class="pw-post-body-paragraph kd ke iq kf b kg lx ki kj kk ly km kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated"><a class="ae kc" href="https://hexdocs.pm/mix/Mix.Tasks.Format.html" rel="noopener ugc nofollow" target="_blank">混合格式</a>任务是<a class="ae kc" href="https://elixir-lang.org/blog/2018/01/17/elixir-v1-6-0-released/" rel="noopener ugc nofollow" target="_blank">在Elixir v1.6 </a>中引入的，它用于自动格式化您的代码。使用它的主要好处之一是避免无聊和无休止的讨论，如“我们应该如何格式化代码？”，“线路长度应该是多少？”，等等。<a class="ae kc" href="https://github.com/elixir-lang/elixir/blob/v1.8/Makefile#L215-L216" rel="noopener ugc nofollow" target="_blank"> Elixir也用它</a>来执行标准格式。</p><h2 id="d1f9" class="lc ld iq bd le lf lg dn lh li lj dp lk ko ll lm ln ks lo lp lq kw lr ls lt lu bi translated">警告为错误</h2><p id="e941" class="pw-post-body-paragraph kd ke iq kf b kg lx ki kj kk ly km kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated">这不是一个工具，实际上，这是一个<a class="ae kc" href="https://hexdocs.pm/mix/Mix.Tasks.Compile.Elixir.html" rel="noopener ugc nofollow" target="_blank"> Elixir编译属性</a>，它将当前项目中的警告视为错误，并返回一个非零退出代码，这意味着如果有任何警告，您的项目将不会编译。</p><h2 id="697f" class="lc ld iq bd le lf lg dn lh li lj dp lk ko ll lm ln ks lo lp lq kw lr ls lt lu bi translated">在我们继续之前，请注意</h2><p id="6f8c" class="pw-post-body-paragraph kd ke iq kf b kg lx ki kj kk ly km kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated">让所有这些工具和配置都打开<em class="lb">可能会让</em>很烦。一个没有doc的模块、一个错误的规范甚至一个未使用的变量都会阻止你编译和发布代码。实施的级别取决于您，因此您应该根据项目的需要(以及您的压力水平)来调整工具和配置。但是做长期计划是个好主意。</p><h1 id="a4e5" class="ml ld iq bd le mm mn mo lh mp mq mr lk ms mt mu ln mv mw mx lq my mz na lt nb bi translated">履行</h1><p id="a8ff" class="pw-post-body-paragraph kd ke iq kf b kg lx ki kj kk ly km kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated">好的，让我们更改文件以实施质量检查。让我们一点一点地做，或者更好地说，一个功能一个功能地做。</p><h2 id="a505" class="lc ld iq bd le lf lg dn lh li lj dp lk ko ll lm ln ks lo lp lq kw lr ls lt lu bi translated">mix.exs</h2><p id="54cc" class="pw-post-body-paragraph kd ke iq kf b kg lx ki kj kk ly km kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated">首先，让我们安装dep。在<em class="lb"> deps列表</em>中增加以下内容:</p><pre class="nf ng nh ni gt nj nk nl nm aw nn bi"><span id="3ebf" class="lc ld iq nk b gy no np l nq nr">{:credo, "~&gt; 1.0", only: [:dev, :test], runtime: false},<br/>{:dialyxir, "~&gt; 1.0.0-rc.6", only: [:dev, :test], runtime: false},<br/>{:sobelow, "~&gt; 0.7", only: [:dev, :test], runtime: false}</span></pre><p id="a740" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们更改项目的配置。将此添加到<em class="lb">项目功能</em>:</p><pre class="nf ng nh ni gt nj nk nl nm aw nn bi"><span id="537d" class="lc ld iq nk b gy no np l nq nr">elixirc_options: [warnings_as_errors: true],<br/>aliases: aliases(),<br/>dialyzer: [<br/>  plt_file: {:no_warn, "priv/plts/dialyzer.plt"},<br/>  ignore_warnings: ".dialyzer_ignore.exs"<br/>]</span></pre><p id="180a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就像是:</p><figure class="nf ng nh ni gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="dae6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我推荐阅读<a class="ae kc" href="https://hexdocs.pm/dialyxir/0.4.1/readme.html" rel="noopener ugc nofollow" target="_blank"> dialyxir文档</a>来了解更多关于它的配置，特别是<a class="ae kc" href="https://github.com/jeremyjh/dialyxir#continuous-integration" rel="noopener ugc nofollow" target="_blank">持续集成</a>如果你想在你的CI/CD管道上执行它。</p><p id="befa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，让我们在mix.exs文件中创建一个别名函数，<em class="lb">如果您还没有创建这个函数</em>，并添加两个别名:</p><figure class="nf ng nh ni gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="7fa1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我喜欢使用一个专用于本地开发的别名(quality)和一个专用于CI/CD的别名(quality.ci ),因为我在任务及其参数的顺序上有更多的自由。比如在本地开发上我不想检查代码是否格式化，我只是直接格式化代码；我喜欢在最后看到测试结果。想怎么适应就怎么适应。</p><h2 id="e996" class="lc ld iq bd le lf lg dn lh li lj dp lk ko ll lm ln ks lo lp lq kw lr ls lt lu bi translated"><em class="nu">。透析器_ignore.exs </em></h2><p id="0b86" class="pw-post-body-paragraph kd ke iq kf b kg lx ki kj kk ly km kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated">创建文件<em class="lb">。项目根目录下的透析器_ignore.exs </em>:</p><figure class="nf ng nh ni gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="a2b1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">还记得我说过那些工具可能很烦人吗？特别是透析器。不要误会，透析器是惊人的，我相信你应该使用它，但有时你需要忽略一两个警告，这是你可以这样做的文件。</p><p id="11c0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">关于这个文件的内容:我们将在测试环境中运行我们的别名(MIX_ENV=test ),透析器声明这些函数是错误的，但是这没什么大不了的，让我们忽略它。</p><h2 id="07a4" class="lc ld iq bd le lf lg dn lh li lj dp lk ko ll lm ln ks lo lp lq kw lr ls lt lu bi translated">克雷多</h2><p id="a6e6" class="pw-post-body-paragraph kd ke iq kf b kg lx ki kj kk ly km kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated">您不需要为了让credo工作而改变任何东西，但是默认的规则可能不适合您的项目。你可以使用一个<a class="ae kc" href="https://github.com/rrrene/credo#configuration-via-credoexs" rel="noopener ugc nofollow" target="_blank"> .credo.exs </a>文件或者使用特殊注释的<a class="ae kc" href="https://github.com/rrrene/credo#inline-configuration-via-config-comments" rel="noopener ugc nofollow" target="_blank">来改变它。</a></p><h2 id="5948" class="lc ld iq bd le lf lg dn lh li lj dp lk ko ll lm ln ks lo lp lq kw lr ls lt lu bi translated">。gitignore</h2><p id="96ec" class="pw-post-body-paragraph kd ke iq kf b kg lx ki kj kk ly km kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated">添加到。gitignore:</p><pre class="nf ng nh ni gt nj nk nl nm aw nn bi"><span id="67a8" class="lc ld iq nk b gy no np l nq nr"># Dialyzer<br/>/priv/plts/*.plt<br/>/priv/plts/*.plt.hash</span><span id="cf7f" class="lc ld iq nk b gy nv np l nq nr"># Sobelow<br/>.sobelow</span></pre><p id="7bad" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些文件是环境相关的。</p><h1 id="ebb2" class="ml ld iq bd le mm mn mo lh mp mq mr lk ms mt mu ln mv mw mx lq my mz na lt nb bi translated">执行</h1><p id="aaac" class="pw-post-body-paragraph kd ke iq kf b kg lx ki kj kk ly km kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated">终于，你准备好了！😅</p><p id="57ed" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，让我们创建透析器将存储plt文件的目录:</p><p id="b94b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe nw nx ny nk b">mkdir -p priv/plts</code></p><p id="64f4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后在您的终端中执行:</p><p id="25ea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe nw nx ny nk b">MIX_ENV=test mix quality</code></p><p id="a9cb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">休息一会儿，喝杯咖啡，第一次执行将需要一些时间来建立所有透析器人工制品，但这些文件将被缓存，不要担心。</p><p id="155a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并将CI/CD管道更改为执行:</p><p id="4865" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe nw nx ny nk b">MIX_ENV=test mix quality.ci</code></p><p id="0c87" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">每当该命令在您的代码中发现问题时，CI/CD管道将停止并返回一个失败。</p><h1 id="48a2" class="ml ld iq bd le mm mn mo lh mp mq mr lk ms mt mu ln mv mw mx lq my mz na lt nb bi translated">完整的示例文件</h1><p id="5e02" class="pw-post-body-paragraph kd ke iq kf b kg lx ki kj kk ly km kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated"><em class="lb"> mix.exs </em></p><figure class="nf ng nh ni gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="4829" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">。透析器_ignore.exs </em></p><figure class="nf ng nh ni gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="9a47" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">。gitignore</p><figure class="nf ng nh ni gt jr"><div class="bz fp l di"><div class="ns nt l"/></div></figure><h1 id="e9c1" class="ml ld iq bd le mm mn mo lh mp mq mr lk ms mt mu ln mv mw mx lq my mz na lt nb bi translated">参考</h1><ul class=""><li id="5518" class="lv lw iq kf b kg lx kk ly ko lz ks ma kw mb la mc md me mf bi translated"><a class="ae kc" href="https://pragprog.com/book/tvmelixir/adopting-elixir" rel="noopener ugc nofollow" target="_blank">采用灵丹妙药——从概念到生产</a></li><li id="44e3" class="lv lw iq kf b kg mg kk mh ko mi ks mj kw mk la mc md me mf bi translated"><a class="ae kc" href="https://blog.dnsimple.com/2018/10/elixir-dialyzer-in-ci/" rel="noopener ugc nofollow" target="_blank">https://blog.dnsimple.com/2018/10/elixir-dialyzer-in-ci/</a></li></ul></div><div class="ab cl nz oa hu ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="ij ik il im in"><p id="7e0d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">你正在寻找一家创意公司来实现你的下一个想法吗？退房</em> <a class="ae kc" href="https://lnasystems.com.br" rel="noopener ugc nofollow" target="_blank"> <em class="lb"> LNA系统</em> </a> <em class="lb">和我们聊聊。</em></p></div></div>    
</body>
</html>