<html>
<head>
<title>How to setup Kafka cluster for 15K events per second on AWS using Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Docker在AWS上设置每秒15K事件的Kafka集群</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-setup-kafka-cluster-for-15k-events-per-second-on-aws-using-docker-d34539873589?source=collection_archive---------0-----------------------#2021-02-10">https://itnext.io/how-to-setup-kafka-cluster-for-15k-events-per-second-on-aws-using-docker-d34539873589?source=collection_archive---------0-----------------------#2021-02-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/a2051318e5481eb3fa284e72e70a9ad8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9xVQ5fiHqjSwEYUq89iW1w.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">我们将在博客中设置的Grafana仪表板</figcaption></figure><p id="1494" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在这篇博文中，我们将按照以下要求设置Kafka和Zookeeper集群:</p><ul class=""><li id="b793" class="la lb iq ke b kf kg kj kk kn lc kr ld kv le kz lf lg lh li bi translated">系统每秒将处理15K个1 KB的事件</li><li id="8a98" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">系统将是可靠的，不会丢失数据</li><li id="5843" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">系统将支持Prometheus和Grafana的监控</li><li id="9f15" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">将使用JMeter对系统进行负载测试</li></ul><p id="2934" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们不会在博客中考虑的事情:</p><ul class=""><li id="5ac5" class="la lb iq ke b kf kg kj kk kn lc kr ld kv le kz lf lg lh li bi translated">没有主题被<a class="ae lo" href="https://kafka.apache.org/08/documentation.html#producerapi" rel="noopener ugc nofollow" target="_blank">消息键</a>分割。</li><li id="b3da" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">消费者及其吞吐量/分区需求</li><li id="b30e" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">与安全相关的更改</li></ul></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><h1 id="3108" class="lw lx iq bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated"><strong class="ak">卡夫卡系统需求:</strong></h1><ul class=""><li id="f374" class="la lb iq ke b kf mu kj mv kn mw kr mx kv my kz lf lg lh li bi translated"><strong class="ke ir"> CPU &amp;内存</strong>:由于Kafka在CPU上是<a class="ae lo" href="https://docs.confluent.io/platform/current/kafka/deployment.html" rel="noopener ugc nofollow" target="_blank">轻量级</a>，我们将为我们的代理使用<code class="fe mz na nb nc b">m5.xlarge</code>实例，它们很好地平衡了CPU内核和内存。</li><li id="0d13" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated"><strong class="ke ir"> Insync副本:</strong>由于数据对我们很重要，我们将使用2。</li><li id="ef06" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated"><strong class="ke ir">复制因子:</strong>我们将把它保持为3，以尽量减少数据丢失的可能性。</li><li id="3f69" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated"><strong class="ke ir">磁盘:</strong>我们将在每个代理上安装一个外部EBS卷。为了提高吞吐量，我们将使用<code class="fe mz na nb nc b">gp3</code>作为卷类型。</li><li id="2ae6" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated"><strong class="ke ir">经纪人数量:</strong>我们将保持在3个，都在同一个地区，但有不同的可用性区域。我们将在讨论AWS部署时讨论这一点</li><li id="b2f0" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">分区:选择分区的数量对生产者和消费者来说都是一个因素。由于我们没有考虑消费者吞吐量，我们的最大吞吐量将是<code class="fe mz na nb nc b">1KB*15000/s= 15MB/s</code>。这在我们的EBS卷的吞吐量限制之内。无论如何，我们将保持分区的数量为8。由于这对于非关键消息总是可以增加的，所以我们不会对此过于担心。</li></ul><p id="15e5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><em class="nd">提示:制作Kafka brokers时应该做的一些优化</em></p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><h1 id="66f6" class="lw lx iq bd ly lz nk mb mc md nl mf mg mh nm mj mk ml nn mn mo mp no mr ms mt bi translated">动物园管理员系统要求:</h1><ul class=""><li id="e139" class="la lb iq ke b kf mu kj mv kn mw kr mx kv my kz lf lg lh li bi translated">我们将建立一个由3个zookeeper节点组成的集群</li><li id="8e34" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">由于我们的集群很小，我们将使用<code class="fe mz na nb nc b">t2.medium</code>实例大小。来自<a class="ae lo" href="https://www.confluent.io/wp-content/uploads/apache-kafka-confluent-enterprise-ref-architecture.pdf" rel="noopener ugc nofollow" target="_blank">汇合文件</a></li></ul><blockquote class="np nq nr"><p id="5dee" class="kc kd nd ke b kf kg kh ki kj kk kl km ns ko kp kq nt ks kt ku nu kw kx ky kz ij bi translated">ZooKeeper使用JVM堆，4GB RAM通常就足够了。太小的堆将由于持续的垃圾收集而导致高CPU，而太大的堆可能导致长时间的垃圾收集暂停和ZooKeeper集群内的连接丢失。</p></blockquote><h1 id="3b17" class="lw lx iq bd ly lz nk mb mc md nl mf mg mh nm mj mk ml nn mn mo mp no mr ms mt bi translated">测试(JMeter)系统要求:</h1><ul class=""><li id="e5d9" class="la lb iq ke b kf mu kj mv kn mw kr mx kv my kz lf lg lh li bi translated">我们需要一个可以生成15K事件或以分布式模式运行JMeter的系统。为了简单起见，我们将使用<code class="fe mz na nb nc b">c5.9xlarge</code>实例在一台机器上运行它</li></ul><h1 id="fecd" class="lw lx iq bd ly lz nk mb mc md nl mf mg mh nm mj mk ml nn mn mo mp no mr ms mt bi translated">监控系统要求:</h1><ul class=""><li id="b65c" class="la lb iq ke b kf mu kj mv kn mw kr mx kv my kz lf lg lh li bi translated">我们将在同一个<code class="fe mz na nb nc b">c5.9xlarge</code>实例上设置Prometheus和Grafana。</li></ul></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><h1 id="5a73" class="lw lx iq bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">AWS部署概述:</h1><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/780c36317d43ac23f9b98ab6ddcdfb76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*dqJRHZSM9ORxS1sVow_7bQ.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Kafka部署概述</figcaption></figure><p id="f6a3" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">关于上述部署的一些要点:</p><ul class=""><li id="6016" class="la lb iq ke b kf kg kj kk kn lc kr ld kv le kz lf lg lh li bi translated">我们将在单个区域的三个不同的<a class="ae lo" href="https://aws.amazon.com/about-aws/global-infrastructure/regions_az/" rel="noopener ugc nofollow" target="_blank">可用性区域</a> (AZs)中的每一个上部署一个zookeeper实例，以实现高可用性</li><li id="2fac" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">类似地，我们将在一个区域的三个不同的az上部署一个Kafka实例。</li><li id="68b7" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">我们将使用<strong class="ke ir"> Ubuntu Server 20.04 LTS </strong></li><li id="d87a" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">测试和监控服务器可以在任何AZ。</li></ul><h1 id="1553" class="lw lx iq bd ly lz nk mb mc md nl mf mg mh nm mj mk ml nn mn mo mp no mr ms mt bi translated">AWS安全组:</h1><p id="0a33" class="pw-post-body-paragraph kc kd iq ke b kf mu kh ki kj mv kl km kn nw kp kq kr nx kt ku kv ny kx ky kz ij bi translated">我们需要打开几个端口，以便整个集群能够协同工作。这是安全组的快照。不用说，让它在操作生产集群时更加安全</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/c899ff492777d84db1adcf48414464d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eZdvZNhY31LkO4DD1YE8LQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">动物园管理员、卡夫卡、普罗米修斯和格拉法纳的AWS安全组</figcaption></figure></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><h1 id="e167" class="lw lx iq bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">Zookeeper设置:</h1><p id="8b88" class="pw-post-body-paragraph kc kd iq ke b kf mu kh ki kj mv kl km kn nw kp kq kr nx kt ku kv ny kx ky kz ij bi translated">在三个不同的az中启动3个EC2实例。我们可以在启动实例时选择这些区域</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/a937f0a90403bc6ba2cfb3950271d9eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mfxTQqMdM1PXrkRDq2yowg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">启动EC2实例时的可用性区域选择</figcaption></figure><p id="a2f7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">一旦选择了子网，就给zookeeper实例分配静态IP。当实例启动时，这些静态IP不会改变。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/c540835aa676731c2e025fc1094251ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K6pRK9xb44jxU4JLGXQ0bw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">分配静态私有IP</figcaption></figure><p id="ff8e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为实例选择正确的子网IP。例如，我设置了区域、IP和名称映射，如下所示</p><pre class="ne nf ng nh gt oc nc od oe aw of bi"><span id="15fc" class="og lx iq nc b gy oh oi l oj ok">us-east-1d -&gt; 172.31.9.1 -&gt; zookeeper1<br/>us-east-1a -&gt; 172.31.19.230 -&gt; zookeeper2<br/>us-east-1e -&gt; 172.31.35.20 -&gt; zookeeper3</span></pre><p id="5d2a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><em class="nd">提示:这里有一个小视频可以帮助划分子网</em></p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ol nj l"/></div></figure><p id="e6d8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">更新<code class="fe mz na nb nc b">/etc/hosts</code>文件，并在每个zookeeper服务器上添加以下条目。这将有助于使用名称而不是IP来连接实例</p><pre class="ne nf ng nh gt oc nc od oe aw of bi"><span id="a2cf" class="og lx iq nc b gy oh oi l oj ok">172.31.9.1 zookeeper1<br/>172.31.19.230 zookeeper2<br/>172.31.35.20 zookeeper3</span></pre><p id="76a1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">更新系统并安装docker和docker compose</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">更新主机并安装docker和docker compose的脚本</figcaption></figure><p id="811d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">容器将作为<code class="fe mz na nb nc b">non-root</code>用户运行，因为它们提供了额外的一层<a class="ae lo" href="https://engineering.bitnami.com/articles/why-non-root-containers-are-important-for-security.html" rel="noopener ugc nofollow" target="_blank">安全性</a>。创建一个zookeeper数据文件夹，并分配正确的所有权权限。</p><pre class="ne nf ng nh gt oc nc od oe aw of bi"><span id="0351" class="og lx iq nc b gy oh oi l oj ok">mkdir -p /data/zookeeper<br/>chown -R 1001:1001 /data/zookeeper</span></pre><p id="82ba" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">创建<code class="fe mz na nb nc b">/data/zookeeper/myid</code>文件，给<code class="fe mz na nb nc b">zookeeper1</code>赋值<code class="fe mz na nb nc b">1</code>，给<code class="fe mz na nb nc b">zookeeper2</code>赋值<code class="fe mz na nb nc b">2</code>，给<code class="fe mz na nb nc b">zookeeper3</code>赋值<code class="fe mz na nb nc b">3</code></p><p id="2926" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">使用以下数据在<code class="fe mz na nb nc b">/home/ubuntu/zoo/zoo.cfg</code>创建动物园管理员配置<code class="fe mz na nb nc b">zoo.cfg</code></p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="a669" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">注意它是如何使用像<code class="fe mz na nb nc b">zookeeper2</code>这样的服务器名称而不是IP地址的。这是可行的，因为我们在<code class="fe mz na nb nc b">/etc/hosts </code>文件中有条目。这只是为了方便。也可以使用IP地址。</p><p id="1c52" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">对于docker联网，我们将使用<a class="ae lo" href="https://docs.docker.com/network/host/" rel="noopener ugc nofollow" target="_blank">主机联网</a>。在所有三台服务器上启动zookeeper服务器</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">启动zookeeper的脚本</figcaption></figure><h1 id="3f6c" class="lw lx iq bd ly lz nk mb mc md nl mf mg mh nm mj mk ml nn mn mo mp no mr ms mt bi translated">Kafka设置:</h1><p id="fdd9" class="pw-post-body-paragraph kc kd iq ke b kf mu kh ki kj mv kl km kn nw kp kq kr nx kt ku kv ny kx ky kz ij bi translated">在匹配动物园管理员AZs的三个不同AZs中启动3个EC2实例。与<code class="fe mz na nb nc b">zookeeper1</code>、<code class="fe mz na nb nc b">zookeeper2</code>、<code class="fe mz na nb nc b">zookeeper3</code>对应同一区域的<code class="fe mz na nb nc b">Kafka1</code>、<code class="fe mz na nb nc b">Kafka2</code>、<code class="fe mz na nb nc b">Kafka3</code>姑且称之</p><p id="fdfb" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">用我们在zookeeper服务器中做的相同条目更新<code class="fe mz na nb nc b">/etc/hosts</code>文件</p><pre class="ne nf ng nh gt oc nc od oe aw of bi"><span id="fdff" class="og lx iq nc b gy oh oi l oj ok">172.31.9.1 zookeeper1<br/>172.31.19.230 zookeeper2<br/>172.31.35.20 zookeeper3</span></pre><p id="0a3d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">使用我们在Zookeeper设置中使用的相同脚本更新系统并安装docker</p><p id="cc9d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">创建Kafka数据文件夹，并分配正确的所有权权限。</p><pre class="ne nf ng nh gt oc nc od oe aw of bi"><span id="cb8e" class="og lx iq nc b gy oh oi l oj ok">mkdir -p /data/kafka<br/>sudo chown -R 1001:1001 /data/kafka</span></pre><p id="f86c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在每台服务器上的<code class="fe mz na nb nc b">/home/ubuntu/kafka/server.properties</code>处创建<code class="fe mz na nb nc b"> server.properties</code>。分别在每个服务器上将<code class="fe mz na nb nc b">broker.id</code>更改为<code class="fe mz na nb nc b">1</code>、<code class="fe mz na nb nc b">2</code>和<code class="fe mz na nb nc b">3</code>。确保<code class="fe mz na nb nc b">advertised.listeners</code>反映实例的公共IP。这使我们能够从外部连接到Kafka服务器。</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Kafka server.properties文件</figcaption></figure><p id="e81f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为了监控Kafka集群，下载<a class="ae lo" href="https://github.com/prometheus/jmx_exporter" rel="noopener ugc nofollow" target="_blank"> prometheus jmx exporter </a>和相应的<a class="ae lo" href="https://raw.githubusercontent.com/prometheus/jmx_exporter/master/example_configs/kafka-2_0_0.yml" rel="noopener ugc nofollow" target="_blank">配置文件</a></p><pre class="ne nf ng nh gt oc nc od oe aw of bi"><span id="c49c" class="og lx iq nc b gy oh oi l oj ok">mkdir -p kafka/config &amp;&amp; cd $_</span><span id="305d" class="og lx iq nc b gy om oi l oj ok">wget https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.15.0/jmx_prometheus_javaagent-0.15.0.jar</span><span id="77f6" class="og lx iq nc b gy om oi l oj ok">wget https://raw.githubusercontent.com/prometheus/jmx_exporter/master/example_configs/kafka-2_0_0.yml</span></pre><p id="b9ab" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">就像zookeeper一样，运行带有网络主机的容器，并添加<code class="fe mz na nb nc b">KAFKA_OPTS</code>用于度量收集和挂载Kafka配置</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">开始卡夫卡脚本</figcaption></figure><h1 id="0af8" class="lw lx iq bd ly lz nk mb mc md nl mf mg mh nm mj mk ml nn mn mo mp no mr ms mt bi translated">普罗米修斯设置:</h1><p id="c65e" class="pw-post-body-paragraph kc kd iq ke b kf mu kh ki kj mv kl km kn nw kp kq kr nx kt ku kv ny kx ky kz ij bi translated">在测试服务器中，创建一个<code class="fe mz na nb nc b">prometheus/prometheus.yml</code>文件。目标是卡夫卡经纪人的私人知识产权。</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">普罗米修斯. yml</figcaption></figure><p id="9356" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">由于Kafka broker公开了指标，我们可以启动prometheus容器</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">用码头图片启动普罗米修斯</figcaption></figure><p id="4dbd" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">前往<code class="fe mz na nb nc b">&lt;publicip&gt;:9090</code>验证Prometheus设置，应该可以看到类似这样的内容。检查所有主机是否都在列表中</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi on"><img src="../Images/2e86fc9585f82b0ad86850f7078cc5d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vT3gNqqJqHStzQsiV03Cxg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">连接到Kafka集群后的Prometheus UI</figcaption></figure><h1 id="8148" class="lw lx iq bd ly lz nk mb mc md nl mf mg mh nm mj mk ml nn mn mo mp no mr ms mt bi translated">Grafana设置:</h1><p id="36ac" class="pw-post-body-paragraph kc kd iq ke b kf mu kh ki kj mv kl km kn nw kp kq kr nx kt ku kv ny kx ky kz ij bi translated">以管理员身份启动Grafana，使用一个卷来保存仪表板。</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">用docker图像启动Grafana</figcaption></figure><p id="fca7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">选择<a class="ae lo" href="https://grafana.com/docs/grafana/latest/datasources/prometheus/" rel="noopener ugc nofollow" target="_blank">数据源为Prometheus </a>并选择Prometheus服务器的IP。创建适合您的仪表板。这个博客使用的json文件在这里是<a class="ae lo" href="https://github.com/abhinavdhasmana/kafka-aws-setup/blob/master/grafana/dashboard.json" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="e253" class="lw lx iq bd ly lz nk mb mc md nl mf mg mh nm mj mk ml nn mn mo mp no mr ms mt bi translated">JMeter设置:</h1><p id="27dc" class="pw-post-body-paragraph kc kd iq ke b kf mu kh ki kj mv kl km kn nw kp kq kr nx kt ku kv ny kx ky kz ij bi translated">我们将使用<a class="ae lo" href="https://github.com/GSLabDev/pepper-box/" rel="noopener ugc nofollow" target="_blank">胡椒盒</a>作为Kafka负载生成器。</p><p id="d413" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">安装Java(我们用的是亚马逊corretto 11)和JMeter</p><pre class="ne nf ng nh gt oc nc od oe aw of bi"><span id="d890" class="og lx iq nc b gy oh oi l oj ok">wget -O- <a class="ae lo" href="https://apt.corretto.aws/corretto.key" rel="noopener ugc nofollow" target="_blank">https://apt.corretto.aws/corretto.key</a> | sudo apt-key add - <br/>sudo add-apt-repository 'deb <a class="ae lo" href="https://apt.corretto.aws" rel="noopener ugc nofollow" target="_blank">https://apt.corretto.aws</a> stable main'</span><span id="3b2d" class="og lx iq nc b gy om oi l oj ok">sudo apt-get update; sudo apt-get install -y java-11-amazon-corretto-jdk</span><span id="e6f3" class="og lx iq nc b gy om oi l oj ok">wget <a class="ae lo" href="https://mirrors.estointernet.in/apache//jmeter/binaries/apache-jmeter-5.4.1.tgz" rel="noopener ugc nofollow" target="_blank">https://mirrors.estointernet.in/apache//jmeter/binaries/apache-jmeter-5.4.1.tgz</a><br/>tar -xvzf <!-- -->apache-jmeter-5.4.1.tgz<br/>mv apache-jmeter-5.4.1 jmeter<br/>rm -rf apache-jmeter-5.4.1.tgz</span></pre><p id="670e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">设置Pepper-Box:从<a class="ae lo" href="https://github.com/raladev/load/tree/master/JARs" rel="noopener ugc nofollow" target="_blank">这里</a>或者<a class="ae lo" href="https://github.com/abhinavdhasmana/kafka-aws-setup/blob/master/JMeter/pepper-box-1.0.jar" rel="noopener ugc nofollow" target="_blank">这里</a>复制JAR文件，放入JMeter插件文件夹。</p><pre class="ne nf ng nh gt oc nc od oe aw of bi"><span id="ab2f" class="og lx iq nc b gy oh oi l oj ok">cd /home/ubuntu/jmeter/lib/ext<br/>wget <a class="ae lo" href="https://github.com/raladev/load/raw/master/JARs/pepper-box-1.0.jar" rel="noopener ugc nofollow" target="_blank">https://github.com/raladev/load/raw/master/JARs/pepper-box-1.0.jar</a></span></pre><p id="eb19" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">从下面的文件创建Kafka有效载荷jar文件<code class="fe mz na nb nc b">Message.jar</code>，或者从<a class="ae lo" href="https://github.com/abhinavdhasmana/kafka-aws-setup/blob/master/JMeter/Message.jar" rel="noopener ugc nofollow" target="_blank">复制到这里</a>。将该文件复制到JMeter的<code class="fe mz na nb nc b">lib/ext</code>文件夹中</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="fb49" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们将在Mac中创建测试计划，然后在Ubuntu中复制jmx文件。在JMeter中创建一个线程组，并添加胡椒盒配置元素，即<code class="fe mz na nb nc b">Kafka PlainText Load Generation Config</code>和<code class="fe mz na nb nc b">Pepper-Box Serialized Config</code></p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/2f3007e5cb788fd597d0e70e5eb3f235.png" data-original-src="https://miro.medium.com/v2/resize:fit:1178/format:webp/1*Peu0v6P4mUsIm1PH2dPeSA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">如何添加胡椒盒为卡夫卡制作人</figcaption></figure><p id="4bd8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在<code class="fe mz na nb nc b">Kafka PlainText Load Generation Config</code>中，添加下面的模板。这允许我们生成大约1KB的有效载荷</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="cda9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">它应该是这样的</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi op"><img src="../Images/18ed3108c2839dd2222694a7a8f44aaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DbfHRWGti_2Sw8OI5M-mdA.png"/></div></div></figure><p id="b537" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在<code class="fe mz na nb nc b">Pepper-Box Serialized Config</code>中，点击<code class="fe mz na nb nc b">Load Class</code>并添加<code class="fe mz na nb nc b">Field Expression</code>，如下所示</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oq"><img src="../Images/16ae116e834cfef7382dfc3e0bb8c3fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ASpzUAMkALQgn3iP0cddlQ.png"/></div></div></figure><ul class=""><li id="f65e" class="la lb iq ke b kf kg kj kk kn lc kr ld kv le kz lf lg lh li bi translated">向测试计划添加一个<code class="fe mz na nb nc b">Java Request</code>并设置Zookeeper的IP地址。该插件将从Zookeeper获取代理地址</li></ul><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi or"><img src="../Images/e10f5c3750eb6e627ba6b45ee9ca73bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2te12nVWdQ5U5eGrZi1cAg.png"/></div></div></figure><p id="18db" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在螺纹组中，相应地设置<code class="fe mz na nb nc b">Thread Count</code>以测试负载。完整的jmx文件可从<a class="ae lo" href="https://github.com/abhinavdhasmana/kafka-aws-setup/blob/master/JMeter/kafka_loadtest.jmx" rel="noopener ugc nofollow" target="_blank">这里</a>获得。</p><p id="45fa" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在测试服务器上复制jmx文件。通过增加堆大小来运行jmeter</p><p id="101b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><code class="fe mz na nb nc b">bin/jmeter HEAP=”-Xms512m -Xmx24g” -n -t kafka_loadtest.jmx</code></p><p id="4338" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果一切正常，我们会看到一个漂亮的仪表盘，如下图所示</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/a2051318e5481eb3fa284e72e70a9ad8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9xVQ5fiHqjSwEYUq89iW1w.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">负载测试期间的Grafana仪表板</figcaption></figure><p id="ec0e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">完整代码可在<a class="ae lo" href="https://github.com/abhinavdhasmana/kafka-aws-setup" rel="noopener ugc nofollow" target="_blank">这里</a>获得</p></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><p id="22dd" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这里的很多信息来自于Udemy上的<a class="ae lo" href="https://www.udemy.com/course/kafka-cluster-setup/" rel="noopener ugc nofollow" target="_blank">这个</a>和<a class="ae lo" href="https://www.udemy.com/course/kafka-monitoring-and-operations/" rel="noopener ugc nofollow" target="_blank">这个</a>大课程。</p></div></div>    
</body>
</html>