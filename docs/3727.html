<html>
<head>
<title>Micro In Action, Part 3: Calling a Service</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Micro在行动，第3部分:调用服务</h1>
<blockquote>原文：<a href="https://itnext.io/micro-in-action-part-3-calling-a-service-55d865928f11?source=collection_archive---------3-----------------------#2020-02-11">https://itnext.io/micro-in-action-part-3-calling-a-service-55d865928f11?source=collection_archive---------3-----------------------#2020-02-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/1495f8e85f68309e06c34c3b159c0160.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rd03QzhBe8y6DibHpgmg_g.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">微在行动</figcaption></figure><p id="747a" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">这是“Micro in Action”系列文章的第3篇，讨论了<a class="ae ld" href="https://micro.mu/" rel="noopener ugc nofollow" target="_blank"> Micro </a>。我们将一步一步地构建微服务，并在此过程中解释Micro的特性。我们将从基本概念和主题开始，然后转向高级功能。</p><p id="3240" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">今天我们将讨论如何调用基于微处理器的gRPC服务。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="822c" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在<a class="ae ld" rel="noopener ugc nofollow" target="_blank" href="/micro-in-action-part-2-71230f01d6fb">上一篇文章</a>中，我们创建了一个服务，现在我们可以调用它了。最简单的方法是通过多功能命令行工具<code class="fe ll lm ln lo b">micro</code>。</p><h1 id="c769" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">使用命令行工具调用服务</h1><p id="e22c" class="pw-post-body-paragraph kf kg it kh b ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky mr la lb lc im bi translated">首先，我们使用命令<code class="fe ll lm ln lo b">list</code>列出所有可用的服务:</p><pre class="ms mt mu mv gt mw lo mx my aw mz bi"><span id="1b5f" class="na lq it lo b gy nb nc l nd ne">$ <strong class="lo iu">micro list services</strong></span><span id="04ed" class="na lq it lo b gy nf nc l nd ne">com.foo.service.hello<br/>go.micro.nats.broker</span></pre><p id="1fd2" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">名为<code class="fe ll lm ln lo b">com.foo.srv.hello</code>的服务是我们的目标服务，<code class="fe ll lm ln lo b">go.micro.http.broker</code>是消息代理服务的默认实现，现在不讨论这个。</p><p id="1d97" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在调用之前，我们可以使用<code class="fe ll lm ln lo b">get</code>命令查看该服务的详细信息，包括服务版本、端点定义、元数据和节点信息等。</p><pre class="ms mt mu mv gt mw lo mx my aw mz bi"><span id="bb29" class="na lq it lo b gy nb nc l nd ne">$ <strong class="lo iu">micro get service com.foo.service.hello</strong><br/>service  com.foo.service.hello</span><span id="c470" class="na lq it lo b gy nf nc l nd ne">version latest</span><span id="1698" class="na lq it lo b gy nf nc l nd ne">ID Address Metadata<br/>com.foo.service.hello-c992ec4e-7cf2-480e-881e-ff7371378b98 192.168.3.184:59610 transport=grpc,broker=eats,protocol=grpc,registry=mdns,server=grpc</span><span id="ff3f" class="na lq it lo b gy nf nc l nd ne">Endpoint: Hello.Call</span><span id="1333" class="na lq it lo b gy nf nc l nd ne">Request: {<br/>    name string<br/>}<br/>Response: {<br/>    msg string<br/>}</span><span id="8827" class="na lq it lo b gy nf nc l nd ne">...</span></pre><p id="1566" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">然后我们可以用命令<code class="fe ll lm ln lo b">call</code>调用服务:</p><pre class="ms mt mu mv gt mw lo mx my aw mz bi"><span id="70d5" class="na lq it lo b gy nb nc l nd ne">$ micro call com.foo.service.hello Hello.Call '{"name": "<strong class="lo iu">Bill</strong>"}'</span><span id="995d" class="na lq it lo b gy nf nc l nd ne">error calling com.foo.service.hello.Hello.Call: <br/>{"id":"go.micro.client","code":408,"detail":"context deadline exceeded","status":"Request Timeout"}</span></pre><p id="5402" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们用JSON字符串(用单引号括起来)构造请求并调用服务。不幸的是，我们有一个错误。这是Micro v2的一个<a class="ae ld" href="https://github.com/micro/micro/issues/392" rel="noopener ugc nofollow" target="_blank">已知bug </a>，希望能尽快解决。</p><p id="3d89" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">此外，micro还支持交互模式。</p><h1 id="46f7" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">交互模式下的呼叫服务</h1><p id="07fd" class="pw-post-body-paragraph kf kg it kh b ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky mr la lb lc im bi translated">调用<code class="fe ll lm ln lo b">cli</code>命令后，我们将进入交互模式:</p><pre class="ms mt mu mv gt mw lo mx my aw mz bi"><span id="11b8" class="na lq it lo b gy nb nc l nd ne">$ micro cli<br/>micro&gt;</span></pre><p id="9457" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><strong class="kh iu">注意</strong>:交互和非交互模式下的命令不一样。例如，列出所有服务的交互命令是<code class="fe ll lm ln lo b">list</code>而不是<code class="fe ll lm ln lo b">list services</code>。原因是在非交互模式下，micro需要支持更丰富的语义(比如可以用<code class="fe ll lm ln lo b">list nodes</code>列出网络中的所有节点)。IMO这是一个设计决策，它带来了一些概念上的不一致，不容易理解。</p><pre class="ms mt mu mv gt mw lo mx my aw mz bi"><span id="2884" class="na lq it lo b gy nb nc l nd ne">$ micro cli<br/>micro&gt; <strong class="lo iu">list<br/></strong>com.foo.service.hello<br/>go.micro.nats.broker</span><span id="1abe" class="na lq it lo b gy nf nc l nd ne">micro&gt;<br/>micro&gt; <strong class="lo iu">get</strong> com.foo.service.hello<br/>service  com.foo.service.hello</span><span id="25b5" class="na lq it lo b gy nf nc l nd ne">version latest</span><span id="9b20" class="na lq it lo b gy nf nc l nd ne">ID Address Metadata<br/>com.foo.service.hello-df4e5d69-9226-4c12-9b1e-1c06def9426e 192.168.3.184:49297 broker=eats,protocol=grpc,registry=mdns,server=grpc,transport=grpc<br/>...</span><span id="fbd8" class="na lq it lo b gy nf nc l nd ne">micro&gt;<br/>micro&gt; <strong class="lo iu">call</strong> com.foo.service.hello Hello.Call {"name": "Bill2"}</span><span id="6de7" class="na lq it lo b gy nf nc l nd ne">error calling com.foo.service.hello.Hello.Call: {"id":"go.micro.client","code":408,"detail":"context deadline exceeded","status":"Request Timeout"}</span><span id="9f64" class="na lq it lo b gy nf nc l nd ne">micro&gt;</span></pre><p id="dbd8" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">注意，在交互模式下构建请求时，我们不需要引用JSON字符串。由于前面提到的错误，<code class="fe ll lm ln lo b">call</code>命令也失败了。</p><h1 id="12bb" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">使用基于web的客户端调用服务</h1><p id="6439" class="pw-post-body-paragraph kf kg it kh b ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky mr la lb lc im bi translated">Micro还提供了一个基于web的客户端，支持用户在浏览器中调用服务。</p><p id="6362" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">运行<code class="fe ll lm ln lo b">micro web</code>后，你会在<a class="ae ld" href="http://127.0.0.1:8082/client" rel="noopener ugc nofollow" target="_blank">http://127 . 0 . 0 . 1:8082/client</a>找到如下界面。您可以通过点击“执行”按钮来调用所选择的服务/端点，然后响应内容将以JSON格式显示在右侧。</p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ng"><img src="../Images/f36df41a99966720050c04aa1aec8a8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TqigZx3AdiJ6Ilu_yWoC8g.png"/></div></div></figure><h1 id="b8bb" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">通过代码调用服务</h1><p id="56f4" class="pw-post-body-paragraph kf kg it kh b ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky mr la lb lc im bi translated">上面提到的方法只是为了方便运行时调试。一般来说，我们通过代码调用服务。</p><p id="d632" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">让我们创建一个客户端项目，布局如下:</p><pre class="ms mt mu mv gt mw lo mx my aw mz bi"><span id="4725" class="na lq it lo b gy nb nc l nd ne">.<br/>├── main.go<br/>├── plugin.go<br/>├── proto/hello<br/>│   └── hello.proto<br/>│   └── hello.pb.go<br/>│   └── hello.pb.micro.go<br/>├── go.mod<br/>├── go.sum</span></pre><p id="23af" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">除了<strong class="kh iu"> main.go </strong>之外，其他文件的内容与<a class="ae ld" rel="noopener ugc nofollow" target="_blank" href="/micro-in-action-part-2-71230f01d6fb">上一篇文章</a>中描述的相同，此处不再赘述。</p><p id="d299" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">以下是<strong class="kh iu"> main.go </strong>中的代码:</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="nh ni l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">客户端/main.go</figcaption></figure><ul class=""><li id="aa2a" class="nj nk it kh b ki kj km kn kq nl ku nm ky nn lc no np nq nr bi translated">首先，创建并初始化<code class="fe ll lm ln lo b">micro.Service</code>的一个实例，并将其命名为“<strong class="kh iu">com . foo . service . hello . client”</strong>。该名称没有特殊含义，在实际项目中可能会有所不同。</li><li id="3757" class="nj nk it kh b ki ns km nt kq nu ku nv ky nw lc no np nq nr bi translated">然后创建一个<code class="fe ll lm ln lo b">HelloSevice</code>的客户端实例。我们传递给方法<code class="fe ll lm ln lo b">hello.NewHelloService</code>的第一个参数是要调用的服务的名称。第二个参数是从服务实例中获得的<code class="fe ll lm ln lo b">github.com/micro/go-micro/v2/client.Client,</code>的实例。</li><li id="312c" class="nj nk it kh b ki ns km nt kq nu ku nv ky nw lc no np nq nr bi translated">下一步是调用服务方法。首先，传入<code class="fe ll lm ln lo b">context.Context</code>实例。这里，我们用<code class="fe ll lm ln lo b">context.TODO()</code>来简化例子。在真实的项目中，应该传入实际的上下文实例；然后我们传入请求对象。</li></ul><p id="f590" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">代码准备好后，您可以编译并运行:</p><pre class="ms mt mu mv gt mw lo mx my aw mz bi"><span id="455b" class="na lq it lo b gy nb nc l nd ne">$ go run main.go plugin.go<br/>Hello Bill 4<br/>$</span></pre><p id="1ce5" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">将显示预期的响应。</p><p id="a9fe" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">如果服务此时没有运行，将会报告一个错误:</p><pre class="ms mt mu mv gt mw lo mx my aw mz bi"><span id="6857" class="na lq it lo b gy nb nc l nd ne">$ go run main.go plugin.go <br/>{"id":"go.micro.client","code":500,"detail":"service com.foo.service.hello: not found","status":"Internal Server Error"}<br/>$</span></pre><p id="c95b" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">至此，您完成了任务。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h1 id="7225" class="lp lq it bd lr ls nx lu lv lw ny ly lz ma nz mc md me oa mg mh mi ob mk ml mm bi translated">总结</h1><p id="112c" class="pw-post-body-paragraph kf kg it kh b ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky mr la lb lc im bi translated">本文讨论了如何调用基于微处理器的gRPC服务。</p><p id="7d13" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">Micro提供了相当多的工具，用于在运行时检查服务状态和调用服务。这些工具支持命令行和浏览器。然而，有些命令现在无法工作，因为Micro v2中仍然存在一些严重的错误。</p><p id="ea7f" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">最后，我们创建了一个客户端项目，并用代码完成了服务调用。</p><p id="a3b9" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">未完待续。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="56bd" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">另请参见:</p><ul class=""><li id="a13f" class="nj nk it kh b ki kj km kn kq nl ku nm ky nn lc no np nq nr bi translated"><a class="ae ld" rel="noopener ugc nofollow" target="_blank" href="/micro-in-action-getting-started-a79916ae3cac"> Micro在行动，第1部分:入门</a></li><li id="d800" class="nj nk it kh b ki ns km nt kq nu ku nv ky nw lc no np nq nr bi translated"><a class="ae ld" rel="noopener ugc nofollow" target="_blank" href="/micro-in-action-part-2-71230f01d6fb"> Micro In Action，第2部分:Bootstrap终极指南</a></li><li id="6c7d" class="nj nk it kh b ki ns km nt kq nu ku nv ky nw lc no np nq nr bi translated"><a class="ae ld" href="https://medium.com/@dche423/micro-in-action-part4-pub-sub-564f3b054ecd" rel="noopener">微在行动，第四部分:发布/订阅</a></li><li id="c305" class="nj nk it kh b ki ns km nt kq nu ku nv ky nw lc no np nq nr bi translated"><a class="ae ld" rel="noopener ugc nofollow" target="_blank" href="/micro-in-action-part-5-message-broker-a3decf07f26a"> Micro在行动，第5部分:消息代理</a></li><li id="0157" class="nj nk it kh b ki ns km nt kq nu ku nv ky nw lc no np nq nr bi translated"><a class="ae ld" rel="noopener ugc nofollow" target="_blank" href="/micro-in-action-part6-service-discovery-f988988e5936">微在行动，第6部分:服务发现</a></li><li id="7fa5" class="nj nk it kh b ki ns km nt kq nu ku nv ky nw lc no np nq nr bi translated"><a class="ae ld" rel="noopener ugc nofollow" target="_blank" href="/micro-in-action-7-circuit-breaker-rate-limiter-431ccff6a120">微操作，第7部分:断路器&amp;限速器</a></li><li id="7eb9" class="nj nk it kh b ki ns km nt kq nu ku nv ky nw lc no np nq nr bi translated"><a class="ae ld" rel="noopener ugc nofollow" target="_blank" href="/micro-in-action-coda-distributed-cron-job-a2b577885b24#39d6-3ace13696421">微操作，Coda:分布式Cron作业</a></li><li id="b069" class="nj nk it kh b ki ns km nt kq nu ku nv ky nw lc no np nq nr bi translated"><a class="ae ld" href="https://medium.com/@dche423/micro-in-action-1be29b057f2d" rel="noopener">微在行动的索引页</a></li></ul></div></div>    
</body>
</html>