<html>
<head>
<title>Inline Data With a Content Security Policy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有内容安全策略的内联数据</h1>
<blockquote>原文：<a href="https://itnext.io/inline-data-with-a-content-security-policy-ab30dde2feb3?source=collection_archive---------3-----------------------#2018-02-22">https://itnext.io/inline-data-with-a-content-security-policy-ab30dde2feb3?source=collection_archive---------3-----------------------#2018-02-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="63f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">XSS安全，即使是“旧”的应用程序。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/dfba6990769ecf5c226b15e67285d1e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bEfsndLcLA0t9lwz65Sgiw.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">照片由<a class="ae lb" href="https://unsplash.com/photos/OnkbHtk_S58?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Ej Agumbay </a>在<a class="ae lb" href="https://unsplash.com/collections/945911/stock-photo?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="a9dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lb" href="https://www.linkedin.com/cws/share?url=https%3A%2F%2Fitnext.io%2Finline-data-with-a-content-security-policy-ab30dde2feb3" rel="noopener ugc nofollow" target="_blank"> <em class="lc">点击这里在LinkedIn上分享这篇文章</em> </a></p><h1 id="0f41" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">加强安保</h1><p id="044f" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">如果我告诉你一个简单的方法，可以让你的网站在跨站脚本(XSS)攻击中几乎不可战胜，你会使用它吗？</p><p id="038e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嗯，一个<a class="ae lb" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP" rel="noopener ugc nofollow" target="_blank">内容安全策略</a> (CSP)可以做到这一点！这就像从服务器提供html文件时添加一个额外的头一样简单。</p><p id="b2fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我会在这篇文章的底部链接到更多关于如何为你的站点设置这个的信息。现在，这里有一个强大的CSP的例子。</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="6d50" class="ml le iq mh b gy mm mn l mo mp">Content-Security-Policy: default-src 'self'; form-action 'self';</span></pre><p id="55aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">基于这个例子，标题浏览器阻止任何内联脚本或样式运行，只允许脚本、样式、字体等资源。从我们自己的领域加载。</p><p id="77e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是问题所在:<em class="lc">没有内联JavaScript </em></p><h1 id="d1ff" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">用例</h1><p id="9e6f" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">请允许我搭建舞台。我们正在构建一个web应用程序，我们需要来自服务器的一些数据。我们正在将现有的服务迁移到新世界的奇迹中。渐进式网络应用和所有的爵士乐。然而，我们需要的这些数据很难获得，因为它不能通过任何web API获得。</p><p id="4696" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的服务器使用模板向用户显示动态内容，例如他们的姓名、年龄以及他们的狗早餐吃了什么！🐶</p><p id="062d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了让页面在客户端脚本中使用来自服务器的数据，您可能以前见过这样的模式:</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="f766" class="ml le iq mh b gy mm mn l mo mp">&lt;!-- user-template.html - On the server --&gt;<br/>&lt;script type="text/javascript"&gt;<br/>  var firstName = "{{ user.firstName }}";<br/>  var age = {{ user.age }};<br/>  // the 'dump' filter calls JSON.stringify on the object<br/>  var pet = {{ user.pet | dump }};</span><span id="e7c4" class="ml le iq mh b gy mq mn l mo mp">  document.addEventListener("DOMContentLoaded", function() {<br/>    //do work with the variables once the page is ready...<br/>  });<br/>&lt;/script&gt;</span></pre><p id="f9ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是现在，如果我们在web应用程序中使用如上CSP头提供上述代码，我们将在浏览器控制台中看到一条错误消息，说明该脚本未被执行。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mr"><img src="../Images/4e703358e6fa1492c7b102a24a58ecec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wiUZqJ3AzCq6zuYIS6nDyg.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">被CSP阻止的脚本示例</figcaption></figure><blockquote class="ms mt mu"><p id="58d4" class="jn jo lc jp b jq jr js jt ju jv jw jx mv jz ka kb mw kd ke kf mx kh ki kj kk ij bi translated"><em class="iq">注意:大多数情况下，这些数据可以(也可能应该)来自API调用，但是有些情况下我们会遇到这种情况。</em></p></blockquote><h1 id="d42d" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">解决方案:内联JSON</h1><p id="91b6" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">幸运的是，还有另一个简单、安全的解决方案。</p><p id="4d3d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">代替内联JavaScript，我们可以创建一个类型为<code class="fe my mz na mh b">application/json</code>的<code class="fe my mz na mh b">&lt;script&gt;</code>标签。浏览器不会将其视为JavaScript，因此它会通过CSP。</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="c5e9" class="ml le iq mh b gy mm mn l mo mp">&lt;!-- user-template.html --&gt;<br/>&lt;script type="application/json" data-my-app-selector="user-data"&gt;<br/>{<br/>  "firstName": "{{ user.firstName }}",<br/>  "age": {{ user.age }},<br/>  "pet": {{ user.pet | dump }}<br/>}<br/>&lt;/script&gt;<br/>&lt;script src="main.js"&gt;&lt;/script&gt;</span></pre><p id="1621" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，在我们的主JavaScript文件中，我们将解析JSON并获取要在我们的应用程序中使用的值。</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="d1fa" class="ml le iq mh b gy mm mn l mo mp">// main.js<br/>function getData(dataSelect) {<br/>  try {<br/>    const inlineJsonElement = document.querySelector(<br/>      `script[type="application/json"][data-my-app-selector="${dataSelect}"]`<br/>    );<br/>    const data = JSON.parse(inlineJsonElement.textContent);<br/>    return data;<br/>  } catch (err) {<br/>    console.error(`Couldn't read JSON data from ${dataSelect}`, err);<br/>  }<br/>}</span><span id="f292" class="ml le iq mh b gy mq mn l mo mp">document.addEventListener("DOMContentLoaded", function() {<br/>  // do work with the variables once the page is ready<br/>  const user = getData("user-data");<br/>  console.log(user.name);<br/>  // ...<br/>});</span></pre><p id="504b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种模式允许我们有一个安全的CSP，并且仍然从服务器内联数据！任务完成！</p><p id="d72b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章中的所有代码都可以在<a class="ae lb" href="https://github.com/Graham42/sample-csp-with-inline-data" rel="noopener ugc nofollow" target="_blank">GitHub repo</a>中找到。您可以查看并尝试各种安全/不安全选项。</p></div><div class="ab cl nb nc hu nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="ij ik il im in"><h1 id="dd09" class="ld le iq bd lf lg ni li lj lk nj lm ln lo nk lq lr ls nl lu lv lw nm ly lz ma bi translated">一些替代方案及其缺点</h1><h1 id="2db3" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">数据属性</h1><p id="046f" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">我见过一些项目使用带有<code class="fe my mz na mh b">data-xyz</code>属性的html标签来存储值。这种方法的缺点是我们会丢失数据类型信息。例如，值应该是数字<code class="fe my mz na mh b">4</code>还是字符串<code class="fe my mz na mh b">"4"</code>？因此，我觉得JSON是更好的方法。</p><h1 id="c1ef" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">基于随机数的CSP</h1><p id="2ca0" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">“Nonce”是“使用过一次的数字”的一个别出心裁的名字。它应该是随机的，不可预测的。在网页的上下文中，我们必须为每个请求生成一个新的nonce <em class="lc">，否则绕过它是微不足道的。</em></p><p id="e229" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">CSP允许列出脚本标签可以指定的nonce，如果脚本标签的nonce与CSP中的nonce匹配，它就可以运行。</p><p id="f4c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有效使用随机数的关键是它们的不可猜测性。即使攻击者设法注入了脚本，他们也不知道CSP报头中的nonce是什么。浏览器将拒绝运行他们的脚本，因为nonce属性与标头中提供的属性不匹配。</p><p id="9d87" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这给我们带来了这种方法的主要问题。它被广泛误解，并且非常容易出错。我已经看到许多线程建议使用编译/构建/捆绑时生成的随机数。这比根本没有CSP更糟糕，因为人们认为他们得到了安全，但实际上他们是脆弱的。如果攻击者知道nonce是什么，他们可以将它作为一个有效属性提供给注入的脚本，浏览器会很高兴地运行它。</p><p id="3bbf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一个缺点是nonces需要一个应用服务器。虽然上面的JSON示例都使用了服务器，但是也有一些用例，我们有一个静态生成的站点，并且我们想要内联一些数据，例如一个webpack清单。对于静态网站，应用服务器是不必要的开销。</p><p id="224f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用nonces的一个更好的替代方法是使用SHA哈希。</p><h1 id="ca18" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">基于SHA哈希的CSP</h1><p id="f093" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">CSP的另一个选项是提供一个SHA散列列表，它与我们期望出现在页面中的内联脚本块的内容相匹配。浏览器根据提供的哈希验证脚本的内容。</p><p id="793e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这实际上是一个很好的选择。我看到的唯一缺点是，我们必须设置工具来为内联脚本块生成散列，并将这些散列提供给我们的服务器。消除所有内联JavaScript并对数据使用JSON更容易。</p></div><div class="ab cl nb nc hu nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="ij ik il im in"><p id="9538" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想了解更多关于内容安全政策(CSP)的信息，我建议你查看一下MDN文档。</p><p id="0ca3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以使用<a class="ae lb" href="https://report-uri.com/home/generate" rel="noopener ugc nofollow" target="_blank">这个来自<a class="ae lb" href="https://report-uri.com/" rel="noopener ugc nofollow" target="_blank">URI</a>的互动工具</a>来构建你自己的CSP</p><p id="6058" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本帖回购示例:<a class="ae lb" href="https://github.com/Graham42/sample-csp-with-inline-data" rel="noopener ugc nofollow" target="_blank">https://github.com/Graham42/sample-csp-with-inline-data</a></p></div><div class="ab cl nb nc hu nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="ij ik il im in"><p id="d3a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢阅读！如果你想以后看到更多我的帖子，在Twitter上关注我<a class="ae lb" href="https://twitter.com/Graham42x" rel="noopener ugc nofollow" target="_blank"> @graham42x </a>。</p></div></div>    
</body>
</html>