<html>
<head>
<title>Of Kubernetes unsafe sysctls &amp; performance optimization on EKS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">EKS Kubernetes不安全系统及性能优化</h1>
<blockquote>原文：<a href="https://itnext.io/of-kubernetes-unsafe-sysctls-performance-optimization-on-eks-d36cc0e3e894?source=collection_archive---------0-----------------------#2021-03-28">https://itnext.io/of-kubernetes-unsafe-sysctls-performance-optimization-on-eks-d36cc0e3e894?source=collection_archive---------0-----------------------#2021-03-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f15fc8b763c4128a8f5a01e684256587.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vyHNOedD-ZhapEX60Is93g.jpeg"/></div></div></figure><h1 id="ec3d" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">什么是不安全的系统？</h1><p id="ae2a" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在诸如Kubernetes之类的容器化工作负载编排环境中运行时，内核参数(参见运行<code class="fe lu lv lw lx b">sudo sysctl -a</code>的完整列表)可以分为“安全”和“不安全”两类。</p><p id="a58b" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">一个“安全”的sysctl仅仅意味着所述内核参数是“命名空间”的。即，一个内核名字空间(容器)内的值不一定反映另一个内核名字空间(容器)内的值，因此不会干扰底层容器化机器的操作方式。安全sysctl的一个例子是本地ip端口范围(<code class="fe lu lv lw lx b">net.ipv4.ip_local_port_range</code>)</p><p id="3946" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">相比之下,“不安全”的sysctl没有命名空间，如果从pod或容器中修改，可能会导致问题。在这种情况下，Kubernetes集群上所有不安全的sysctls都被默认禁用。</p><h1 id="5b76" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">为什么启用usafe sysctls？</h1><p id="8417" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">很棒的问题！答案很简单，并不是所有不安全的系统都是真正&amp;完全“不安全”的。事实上，随着新版内核和对命名空间的新支持，越来越多的sysctls从“不安全”过渡到“安全”类别。一些仍处于不安全类别的内核参数可以进行调整，以便在仔细考虑整个集群的整体视图时，实现整个应用程序的性能优势。</p><p id="375e" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">根据个人经验，一个这样的例子是一个名为<code class="fe lu lv lw lx b">net.ipv4.tcp_tw_reuse</code>的内核参数。这个参数允许内核重用处于<code class="fe lu lv lw lx b">TIME-WAIT</code>状态的TCP套接字。默认情况下，重用这样的套接字是禁用的。对于服务于大量流量的web服务器来说，在任何给定的时间点发现成千上万个套接字处于这种状态并不罕见:</p><pre class="md me mf mg gt mh lx mi mj aw mk bi"><span id="2f60" class="ml jz iq lx b gy mm mn l mo mp">$ <strong class="lx ir">ss -alnpt | grep TIME-WAIT</strong><br/>...<br/>...<br/>TIME-WAIT   0        0               127.0.0.1:45448           127.0.0.1:7142                                                                                   <br/>TIME-WAIT   0        0               127.0.0.1:42242           127.0.0.1:7142                                                                                   <br/>TIME-WAIT   0        0               127.0.0.1:42554           127.0.0.1:7142                                                                                   <br/>TIME-WAIT   0        0               127.0.0.1:44324           127.0.0.1:7142                                                                                   <br/>TIME-WAIT   0        0               127.0.0.1:41880           127.0.0.1:7142                                                                                   <br/>TIME-WAIT   0        0               127.0.0.1:43522           127.0.0.1:7142                                                                                   <br/>...<br/>...</span></pre><p id="0eeb" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">不重用这些套接字会导致网络服务器连接缓慢和性能下降。当您在内核的<code class="fe lu lv lw lx b">dmesg</code>输出中发现以下消息时，您可能会遇到性能问题:</p><pre class="md me mf mg gt mh lx mi mj aw mk bi"><span id="5826" class="ml jz iq lx b gy mm mn l mo mp">[250516.270111] TCP: request_sock_TCP: Possible SYN flooding on port 7142. Sending cookies.  Check SNMP counters.</span></pre><h1 id="b829" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">我们如何在EKS启用不安全的系统？</h1><p id="8179" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">虽然kubernetes的官方文档中有很多关于启用usafe sysctls的信息，但我在EKS上启用它们时还是遇到了一些细微差别(因此有了这篇博文！).</p><p id="8067" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">第一步是在EKS集群的特定节点组(或所有节点组)中允许一组(子)不安全系统。这必须在创建节点组时完成，因为这是在<code class="fe lu lv lw lx b">kubelet.</code>中的设置，如果您使用的是<a class="ae mq" href="https://docs.aws.amazon.com/eks/latest/userguide/managed-node-groups.html" rel="noopener ugc nofollow" target="_blank">管理的EKS节点组</a>，则没有直接的方法来完成此操作。因此，我必须在EKS创建一个新的<em class="mr">非托管</em>节点组。使用<a class="ae mq" href="https://eksctl.io" rel="noopener ugc nofollow" target="_blank"> eksctl </a>管理集群非常简单，我所要做的就是在yaml 的新<a class="ae mq" href="https://eksctl.io/usage/customizing-the-kubelet/" rel="noopener ugc nofollow" target="_blank">节点组部分下包含以下</a><a class="ae mq" href="https://eksctl.io/usage/schema/" rel="noopener ugc nofollow" target="_blank">配置</a>:</p><pre class="md me mf mg gt mh lx mi mj aw mk bi"><span id="2bce" class="ml jz iq lx b gy mm mn l mo mp"><strong class="lx ir">kubeletExtraConfig</strong>:<br/>  <strong class="lx ir">allowedUnsafeSysctls</strong>:<br/>    - "net.ipv4.tcp_tw_reuse"</span></pre><p id="1f47" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">解决了这个问题，下一步是允许相关<a class="ae mq" href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/" rel="noopener ugc nofollow" target="_blank"> pod安全策略</a>的规范中的不安全sysctl:</p><pre class="md me mf mg gt mh lx mi mj aw mk bi"><span id="ced8" class="ml jz iq lx b gy mm mn l mo mp"><strong class="lx ir">spec</strong>:<br/>  <strong class="lx ir">allowedUnsafeSysctls</strong>:<br/>  - net.<!-- -->ipv4.*</span></pre><p id="dbdd" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">(注意这里通配符的使用，它有点随意，但只是为了说明这是可能的。实际上，我们应该将这个列表限制在最少的必需系统中</p><p id="921d" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">一旦以上两项完成，您就可以在pod中自由地微调这些内核参数。只需设置您的<code class="fe lu lv lw lx b">deployment.spec.template.spec.<strong class="ky ir">securityContext</strong></code>(或者如果您直接使用pod，则<code class="fe lu lv lw lx b">pod.spec.<strong class="ky ir">securityContext</strong></code>为:</p><pre class="md me mf mg gt mh lx mi mj aw mk bi"><span id="9ced" class="ml jz iq lx b gy mm mn l mo mp"><strong class="lx ir">sysctls</strong>:<br/>  - <strong class="lx ir">name</strong>: net.ipv4.tcp_tw_reuse<br/>    <strong class="lx ir">value</strong>: "1"</span></pre><p id="f7db" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">如果你使用<a class="ae mq" href="https://helm.sh" rel="noopener ugc nofollow" target="_blank"> helm </a>来部署你的应用程序，你引导应用程序的默认helm图表应该在<code class="fe lu lv lw lx b">values.yaml</code>中有一个叫做<code class="fe lu lv lw lx b">podSecurityContext</code>的部分，你可以在那里插入相同的代码片段。</p><p id="590c" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">最后但并非最不重要的是，一旦你的应用程序部署了上述调整，你可以使用<code class="fe lu lv lw lx b">sudo sysctl -a</code>检查这些参数是否打开</p><p id="8d72" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">Et，瞧！您应该有一个重用tcp套接字的高性能web服务器！</p></div></div>    
</body>
</html>