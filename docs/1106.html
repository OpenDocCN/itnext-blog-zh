<html>
<head>
<title>Modular Game Worlds in Phaser 3 (Tilemaps #3) — Procedural Dungeon</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Phaser 3中的模块化游戏世界(tile maps # 3)——程序地牢</h1>
<blockquote>原文：<a href="https://itnext.io/modular-game-worlds-in-phaser-3-tilemaps-3-procedural-dungeon-3bc19b841cd?source=collection_archive---------1-----------------------#2018-07-23">https://itnext.io/modular-game-worlds-in-phaser-3-tilemaps-3-procedural-dungeon-3bc19b841cd?source=collection_archive---------1-----------------------#2018-07-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="ced1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一系列关于在<a class="ae kl" href="http://phaser.io/" rel="noopener ugc nofollow" target="_blank"> Phaser 3 </a>游戏引擎中使用tilemaps创建模块化世界的博客文章中的第三篇。在这个版本中，我们将创建一个无尽的，程序生成的地牢:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/69785bc193598aa60b4665c581d85f7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*1nS56OTyac1FG-RpDD0rNw.gif"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">Tileset和Character by<a class="ae kl" href="https://opengameart.org/users/buch" rel="noopener ugc nofollow" target="_blank">T3】Michele“Buch”BucelliT5】</a></figcaption></figure><p id="e173" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你还没有看过这个系列的前几篇文章，这里有一些链接:</p><ol class=""><li id="ef64" class="ld le iq jp b jq jr ju jv jy lf kc lg kg lh kk li lj lk ll bi translated"><a class="ae kl" href="https://medium.com/@michaelwesthadley/modular-game-worlds-in-phaser-3-tilemaps-1-958fc7e6bbd6" rel="noopener">静态磁贴地图&amp;一个神奇宝贝风格的世界</a></li><li id="0e93" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated"><a class="ae kl" href="https://medium.com/@michaelwesthadley/modular-game-worlds-in-phaser-3-tilemaps-2-dynamic-platformer-3d68e73d494a" rel="noopener">动态磁贴地图&amp;益智y平台</a></li></ol><p id="f5c4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本系列的下一篇文章中，我们将研究如何在tilemaps中使用<a class="ae kl" href="http://brm.io/matter-js/" rel="noopener ugc nofollow" target="_blank"> Matter.js </a>。</p><p id="a0d2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们开始之前，这篇文章附带的所有代码都在<a class="ae kl" href="https://github.com/mikewesthad/phaser-3-tilemap-blog-posts/tree/master/examples/post-1" rel="noopener ugc nofollow" target="_blank">这个库</a>中。这些教程使用截至21年8月13日的Phaser最新版本(v3.55.2)。</p><h1 id="cdc5" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">目标受众</h1><p id="30b8" class="pw-post-body-paragraph jn jo iq jp b jq mp js jt ju mq jw jx jy mr ka kb kc ms ke kf kg mt ki kj kk ij bi translated">如果你对JavaScript(类、箭头函数和模块)、Phaser和<a class="ae kl" href="https://www.mapeditor.org/" rel="noopener ugc nofollow" target="_blank">平铺</a>地图编辑器有一些经验，这篇文章将会很有意义。如果你不知道，你可能想从<a class="ae kl" href="https://medium.com/@michaelwesthadley/modular-game-worlds-in-phaser-3-tilemaps-1-958fc7e6bbd6" rel="noopener">系列</a>的开头开始，或者继续阅读并把Google、Phaser教程和Phaser <a class="ae kl" href="https://labs.phaser.io/" rel="noopener ugc nofollow" target="_blank">示例</a> &amp; <a class="ae kl" href="https://photonstorm.github.io/phaser3-docs/index.html" rel="noopener ugc nofollow" target="_blank">文档</a>放在手边。</p><p id="263b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好吧，让我们开始吧！</p><h1 id="fad9" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">概观</h1><p id="073a" class="pw-post-body-paragraph jn jo iq jp b jq mp js jt ju mq jw jx jy mr ka kb kc ms ke kf kg mt ki kj kk ij bi translated">这篇文章建立在我们上次<a class="ae kl" href="https://medium.com/@michaelwesthadley/modular-game-worlds-in-phaser-3-tilemaps-2-dynamic-platformer-3d68e73d494a" rel="noopener"/>谈到的静态和动态tilemap层的概念之上。这篇文章中我们将要构建的代码是基于我对<a class="ae kl" href="https://labs.phaser.io/" rel="noopener ugc nofollow" target="_blank"> Phaser Labs </a>的一个贡献。这绝对是我制作的最有趣的例子，它方便地涵盖了我们尚未涉及的动态tilemap layer API的许多附加部分——从随机平铺到使用每平铺透明来创建阴影。</p><p id="fa49" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将从熟悉使用普通HTML &amp; JS的地牢生成器库开始。从那里，我们将开始引入相位器，逐步构建我们无尽的地牢世界。</p><h1 id="659d" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">地牢</h1><p id="6101" class="pw-post-body-paragraph jn jo iq jp b jq mp js jt ju mq jw jx jy mr ka kb kc ms ke kf kg mt ki kj kk ij bi translated">我们将通过使用一个地下城生成器库<a class="ae kl" href="https://github.com/mikewesthad/dungeon" rel="noopener ugc nofollow" target="_blank"> mikewesthad/dungeon </a>来开始生成世界。这是我更新的<a class="ae kl" href="https://github.com/nickgravelyn/dungeon" rel="noopener ugc nofollow" target="_blank"> nickgravelyn/dungeon </a>的分支，它有一些新的功能，并在npm上发布。这是一个非常简单，蛮力地牢发电机。你给它一些配置信息，它会从地图的中心开始一个房间一个房间地随机建造一个地牢。</p><p id="4ad2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以通过CDN、下载脚本或通过npm ( <a class="ae kl" href="https://github.com/mikewesthad/dungeon#installation" rel="noopener ugc nofollow" target="_blank">安装说明</a>)来加载库。一旦你加载了这个库，你就有了一个<code class="fe mu mv mw mx b">Dungeon</code>类，你可以用它来构建一个地牢实例，如下所示:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="1f4f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以通过<code class="fe mu mv mw mx b">dungeon.drawToHtml</code>生成一些HTML来可视化随机地牢，它将地牢转换成一个<code class="fe mu mv mw mx b">&lt;pre&gt;&lt;table&gt; ... &lt;/table&gt;&lt;/pre&gt;</code> HTML元素。我们只需要指定地下城中每种类型的“牌”要使用哪些角色:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="97b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">瞧，表情符号——天哪:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi na"><img src="../Images/0f168b2f48524720f5b90ea7ca57023d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*ugI6RdJnFMI2v5vRG1Rv2Q.gif"/></div></div></figure><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="nb mz l"/></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated"><em class="lc">查看</em><a class="ae kl" href="https://codesandbox.io/s/xorr812k3p?hidenavigation=1&amp;module=%2Fjs%2Findex.js&amp;moduleview=1" rel="noopener ugc nofollow" target="_blank"><em class="lc">code sandbox</em></a><em class="lc"/><a class="ae kl" href="https://www.mikewesthad.com/phaser-3-tilemap-blog-posts/post-3/01-dungeon-html" rel="noopener ugc nofollow" target="_blank"><em class="lc">live示例</em> </a> <em class="lc">或者源代码</em> <a class="ae kl" href="https://github.com/mikewesthad/phaser-3-tilemap-blog-posts/blob/master/examples/post-3/01-dungeon-html" rel="noopener ugc nofollow" target="_blank"> <em class="lc">这里</em> </a> <em class="lc">。</em></figcaption></figure><p id="b0d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过这篇文章中的交互式例子，你可以点击“在CodeSandbox上编辑”按钮，全屏查看代码，在这里你可以很容易地看到所有的文件。</p><h1 id="100d" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">相位器和地牢</h1><p id="515b" class="pw-post-body-paragraph jn jo iq jp b jq mp js jt ju mq jw jx jy mr ka kb kc ms ke kf kg mt ki kj kk ij bi translated">现在我们可以引入Phaser，让玩家进入这些随机的世界。本系列的<a class="ae kl" href="https://medium.com/@michaelwesthadley/modular-game-worlds-in-phaser-3-tilemaps-2-dynamic-platformer-3d68e73d494a" rel="noopener">上一篇文章</a>介绍了使用模块来更好地构建代码的思想。由于模块在Phaser示例中并不常见，我将在这里再次分解结构，以帮助简化转换。</p><p id="6b57" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请记住，如果您只是跟随而不是使用CodeSandbox，您可以通过在HTML中使用<code class="fe mu mv mw mx b">&lt;script src="./js/index.js" type="module"&gt;&lt;/script&gt;</code>来访问代码中的模块(参见<a class="ae kl" href="https://github.com/mikewesthad/phaser-3-tilemap-blog-posts/blob/master/examples/post-3/02-dungeon-simple-mapping" rel="noopener ugc nofollow" target="_blank">示例</a>)。当然，您也可以使用Webpack、Parcel或任何其他JavaScript构建工具。查看<a class="ae kl" href="https://github.com/photonstorm/phaser3-project-template" rel="noopener ugc nofollow" target="_blank">phase 3-project-template</a>获取webpack起始模板。</p><p id="40c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">继续第一个例子。我们的目录结构如下所示:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/a0f107b5d122fad2cc65140860312490.png" data-original-src="https://miro.medium.com/v2/resize:fit:602/format:webp/1*_kJHba5S2Hh4Dl3VAcnLaA.png"/></div></figure><p id="6ed9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">“index.js”是我们代码的入口点。该文件通过创建启用了街机物理的Phaser游戏并加载我们的自定义场景来开始:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="46cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">“dungeon-scene.js”是一个模块，它导出一个名为<code class="fe mu mv mw mx b">DungeonScene</code>的单个<code class="fe mu mv mw mx b">class</code>。它扩展了<code class="fe mu mv mw mx b"><a class="ae kl" href="https://photonstorm.github.io/phaser3-docs/Phaser.Scene.html" rel="noopener ugc nofollow" target="_blank">Phaser.Scene</a></code>，这意味着它可以通过属性访问Phaser的一系列功能(例如用于访问游戏对象工厂的<code class="fe mu mv mw mx b">this.add</code>)。场景在<code class="fe mu mv mw mx b">preload</code>加载一些资源，在<code class="fe mu mv mw mx b">create</code>创建地牢和玩家，并在<code class="fe mu mv mw mx b">update</code>的每一帧更新玩家。</p><p id="eb9f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦我们像上一个例子那样创建了一个<code class="fe mu mv mw mx b">dungeon</code>，我们就可以使用<code class="fe mu mv mw mx b"><a class="ae kl" href="https://photonstorm.github.io/phaser3-docs/Phaser.Tilemaps.Tilemap.html#createBlankLayer__anchor" rel="noopener ugc nofollow" target="_blank">createBlankLayer</a></code>设置一个空白层的tilemap:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="619b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mu mv mw mx b">Dungeon</code>提供了一种通过<code class="fe mu mv mw mx b">dungeon.getMappedTiles</code>获得2D拼贴数组的简单方法，Phaser提供了一种通过<code class="fe mu mv mw mx b"><a class="ae kl" href="https://photonstorm.github.io/phaser3-docs/Phaser.Tilemaps.TilemapLayer.html#putTilesAt__anchor" rel="noopener ugc nofollow" target="_blank">putTilesAt</a></code>将拼贴数组插入图层的简单方法:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="71dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们把这一切和一个基于本系列第一篇文章中的代码的播放器模块放在一起，我们最终会得到:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="nb mz l"/></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated"><em class="lc">查看</em><a class="ae kl" href="https://codesandbox.io/s/52v0nz348p?hidenavigation=1&amp;module=%2Fjs%2Findex.js&amp;moduleview=1" rel="noopener ugc nofollow" target="_blank"><em class="lc">code sandbox</em></a><em class="lc"/><a class="ae kl" href="https://www.mikewesthad.com/phaser-3-tilemap-blog-posts/post-3/02-dungeon-simple-mapping" rel="noopener ugc nofollow" target="_blank"><em class="lc">live示例</em> </a> <em class="lc">或源代码</em> <a class="ae kl" href="https://github.com/mikewesthad/phaser-3-tilemap-blog-posts/blob/master/examples/post-3/02-dungeon-simple-mapping" rel="noopener ugc nofollow" target="_blank"> <em class="lc">此处</em> </a> <em class="lc">。</em></figcaption></figure><h1 id="1081" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">地牢瓷砖布景的近距离观察</h1><p id="a990" class="pw-post-body-paragraph jn jo iq jp b jq mp js jt ju mq jw jx jy mr ka kb kc ms ke kf kg mt ki kj kk ij bi translated">这是我们正在使用的tileset:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nd"><img src="../Images/7aaceb23ba5d524dbc653b2ab19c2526.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*to2RUPNgu4VM8PPSLeOHHA.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated"><em class="lc">未被挤出的影像，</em> <a class="ae kl" href="https://opengameart.org/content/top-down-dungeon-tileset" rel="noopener ugc nofollow" target="_blank"> <em class="lc">地牢tileset </em> </a> <em class="lc">由Michele“Buch”Bucelli(tileset艺术家)&amp; Abram Connelly (tileset赞助商)</em></figcaption></figure><p id="dc13" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们希望使用这些磁贴，而不是之前用表情符号绘制的地下城，看起来像是:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ne"><img src="../Images/f5762bf84e0038c36ff5fe0fddded20a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q-pW0AGMEAl9CjLD7yOrZA.png"/></div></div></figure><p id="9221" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要选择地板、墙壁和门用哪种瓷砖。因为这个瓷砖有透视和定向照明，我们还需要在角落和北、西、南、东四面墙上使用不同的瓷砖。</p><p id="538f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是我们将用来打造房间的特定瓷砖:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nf"><img src="../Images/a1ab4b169f1a3b36f66d947f5618cddc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2ei5rh7Zovzgyfi_SeOqBA.png"/></div></div></figure><p id="c97d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在开始编写代码之前，我通常会在<a class="ae kl" href="https://www.mapeditor.org/" rel="noopener ugc nofollow" target="_blank">平铺</a>中摆弄一下瓷砖，感受一下瓷砖以及它们是如何组合在一起创建一个房间的。制定一个好的计划至关重要。这是我计划两个房间如何相交的一小段时间:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ng"><img src="../Images/0d188fc5a8ece53081788f7b258d12a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*VOL4tNnh6qpvMPAvGRtWBA.gif"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated"><em class="lc">如果你想更紧密地跟随那个过程，这里有一个更慢的</em> <a class="ae kl" href="https://vimeo.com/281170034/f62b5d0dfe" rel="noopener ugc nofollow" target="_blank"> <em class="lc">视频版本</em> </a> <em class="lc">。</em></figcaption></figure><p id="050c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">需要注意的一点是，我在这里使用了两层。当我们使用Phaser时，我们至少需要两层——一层用于地面和墙壁，一层用于箱子/罐子等。—这样我们就可以使用透明背景的瓷砖。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nf"><img src="../Images/0f32588c34479aad759caed91968f407.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xsNas45jEaZ8Moqh7jwehw.png"/></div></div></figure><h1 id="bf1b" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">描绘我们的世界</h1><p id="200d" class="pw-post-body-paragraph jn jo iq jp b jq mp js jt ju mq jw jx jy mr ka kb kc ms ke kf kg mt ki kj kk ij bi translated">既然我们已经有了如何使用瓷砖的计划，我们可以开始绘制地图了。在本节结束时，我们将有这样的设置:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nh"><img src="../Images/b2f49d0605d89038c9f6ec8264929ef6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6geu9RnjZr3FZy3uej-EmA.png"/></div></div></figure><p id="e60d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将放弃<code class="fe mu mv mw mx b">dungeon.getMappedTiles</code>方法，转而使用<code class="fe mu mv mw mx b">dungeon.rooms</code>属性。<code class="fe mu mv mw mx b">rooms</code>是一个包含每个房间信息的对象数组。一个<code class="fe mu mv mw mx b">Room</code>实例具有以下属性:</p><ul class=""><li id="1975" class="ld le iq jp b jq jr ju jv jy lf kc lg kg lh kk ni lj lk ll bi translated"><code class="fe mu mv mw mx b">x</code>、<code class="fe mu mv mw mx b">y</code> -房间左上角的位置(网格单位)</li><li id="5e7b" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk ni lj lk ll bi translated"><code class="fe mu mv mw mx b">width</code> &amp; <code class="fe mu mv mw mx b">height</code></li><li id="5150" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk ni lj lk ll bi translated"><code class="fe mu mv mw mx b">top</code>、<code class="fe mu mv mw mx b">left</code>、<code class="fe mu mv mw mx b">bottom</code>、<code class="fe mu mv mw mx b">right</code></li><li id="0857" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk ni lj lk ll bi translated"><code class="fe mu mv mw mx b">centerX</code> &amp; <code class="fe mu mv mw mx b">centerY</code> -整数中心位置(对于偶数大小的房间向下舍入)</li></ul><p id="6b7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一种方法是:</p><ul class=""><li id="bca0" class="ld le iq jp b jq jr ju jv jy lf kc lg kg lh kk ni lj lk ll bi translated"><code class="fe mu mv mw mx b">getDoorLocations</code> -获取相对于房间左上角的坐标中的门位置数组(<code class="fe mu mv mw mx b">{x, y}</code>对象)</li></ul><p id="3428" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">考虑到这些，我们可以开始规划我们的房间:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="8159" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用动态层的<code class="fe mu mv mw mx b"><a class="ae kl" href="https://photonstorm.github.io/phaser3-docs/Phaser.Tilemaps.TilemapLayer.html#fill__anchor" rel="noopener ugc nofollow" target="_blank">fill</a></code>、<code class="fe mu mv mw mx b"><a class="ae kl" href="https://photonstorm.github.io/phaser3-docs/Phaser.Tilemaps.TilemapLayer.html#putTileAt__anchor" rel="noopener ugc nofollow" target="_blank">putTileAt</a></code>、<code class="fe mu mv mw mx b"><a class="ae kl" href="https://photonstorm.github.io/phaser3-docs/Phaser.Tilemaps.TilemapLayer.html#putTilesAt__anchor" rel="noopener ugc nofollow" target="_blank">putTilesAt</a></code>和<code class="fe mu mv mw mx b"><a class="ae kl" href="https://photonstorm.github.io/phaser3-docs/Phaser.Tilemaps.TilemapLayer.html#weightedRandomize__anchor" rel="noopener ugc nofollow" target="_blank">weightedRandomize</a></code>方法来构建我们的地图。让我们从<code class="fe mu mv mw mx b">fill</code>和<code class="fe mu mv mw mx b">weightedRandomize</code>开始，在放置地板和墙壁时进行初步检查:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="eaca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后我们会看到一个被困在没有门的世界里的角色:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nh"><img src="../Images/7e0dd6cd678444a0a78167642baf3042.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mG37fRAI9JPlABo3QhUdsQ.png"/></div></div></figure><p id="2be1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mu mv mw mx b">fill</code>直截了当。你可以只传入一个索引来填充整个图层，也可以传入<code class="fe mu mv mw mx b">x</code>、<code class="fe mu mv mw mx b">y</code>、<code class="fe mu mv mw mx b">width</code>、&amp;、<code class="fe mu mv mw mx b">height</code>参数来填充特定区域。</p><p id="fb01" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mu mv mw mx b">weightedRandomize</code>如果你没有使用过加权概率，它可能是新的。最后四个参数定义了我们想要随机化的区域(<code class="fe mu mv mw mx b">x</code>、<code class="fe mu mv mw mx b">y</code>、<code class="fe mu mv mw mx b">width</code>、<code class="fe mu mv mw mx b">height</code>)。第一个参数描述要放置哪些图块及其概率。它是一个包含一个索引(或一个索引数组)和一个权重的对象数组。任何给定索引被使用的概率为:<code class="fe mu mv mw mx b">(the index's weight) / (sum of all weights for all indices)</code>。</p><p id="d350" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们已经做了一些工作，但是代码有点难读。你必须在心里记住瓷砖指数的含义。相反，让我们创建一个<code class="fe mu mv mw mx b">tile-mapping.js</code>模块来完成这项工作:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="2a70" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后回到我们的场景中，我们可以做如下的事情:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="0043" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我开始省略代码，这样文章中就不会有大量重复的代码片段。如果你迷路了，跳到这一部分的底部，看看代码沙箱。现在，为了完成我们的映射，让我们添加一些门:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="31b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们可以添加回球员碰撞逻辑，类似于上一个例子:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="1ead" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后我们得到了:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="nb mz l"/></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated"><em class="lc">查看</em><a class="ae kl" href="https://codesandbox.io/s/l54pq7lq7z?hidenavigation=1&amp;module=%2Fjs%2Findex.js&amp;moduleview=1" rel="noopener ugc nofollow" target="_blank"><em class="lc">code sandbox</em></a><em class="lc"/><a class="ae kl" href="https://www.mikewesthad.com/phaser-3-tilemap-blog-posts/post-3/03-dungeon-better-mapping" rel="noopener ugc nofollow" target="_blank"><em class="lc">live示例</em> </a> <em class="lc">或者源代码</em> <a class="ae kl" href="https://github.com/mikewesthad/phaser-3-tilemap-blog-posts/blob/master/examples/post-3/03-dungeon-better-mapping" rel="noopener ugc nofollow" target="_blank"> <em class="lc">这里</em> </a> <em class="lc">。</em></figcaption></figure><h1 id="6d25" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">材料和可见性</h1><p id="2653" class="pw-post-body-paragraph jn jo iq jp b jq mp js jt ju mq jw jx jy mr ka kb kc ms ke kf kg mt ki kj kk ij bi translated">这开始感觉更完整了，所以让我们在房间里随机放置一些东西，然后添加一个可见性算法来创建一个战争迷雾效果:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/69785bc193598aa60b4665c581d85f7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*1nS56OTyac1FG-RpDD0rNw.gif"/></div></div></figure><p id="5765" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了添加内容，我们需要另一层:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="6088" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我们可以在房间里循环一遍，放一些东西。我们将跳过在第一个房间放置任何东西。我们还将指定一个随机选择的房间作为“目标”房间，它将有一个通往新地牢的楼梯。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="e443" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后一旦你在新的<code class="fe mu mv mw mx b">stuffLayer</code>上激活碰撞，你将会得到:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nj"><img src="../Images/ee026479f573231b3029edac19c73687.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*xazKLHt035zDtyfHwfhP5Q.gif"/></div></div></figure><p id="1650" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果没有某种灯光效果，一个类似罗格里的地牢会是什么样子？我们将用一些简单的东西来展示tilemap层API，但是你也可以自己实现一些有趣的东西，比如<a class="ae kl" href="https://www.redblobgames.com/articles/visibility/" rel="noopener ugc nofollow" target="_blank">光线投射方法</a>。</p><p id="191d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Tilemap图层可以具有每个图块的效果，如色调和alpha。我们将利用这一点，创建第三个tilemap层，它将到处都是空白的黑色瓷砖。它们一开始是完全不透明的，但是当玩家进入房间时，我们会让房间“上方”的瓷砖透明，这样玩家就可以看到了。当他们离开一个房间时，我们将通过使瓷砖的黑色覆盖物半透明来“模糊”旧房间。</p><p id="17a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们场景的<code class="fe mu mv mw mx b">create</code>中，我们将开始创建一个新的填充了黑色瓷砖的tilemap层，并将它交给一个尚未创建的新模块:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="16d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在“tilemap-visibility.js”中，我们将创建一个新的类来跟踪当前活动的房间，并根据需要使房间变暗/变亮:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="f317" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，在我们场景的<code class="fe mu mv mw mx b">update</code>中，我们只需要更新活动房间:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="0907" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">咻，我们最终得到了这样的结果:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="nb mz l"/></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated"><em class="lc">查看</em><a class="ae kl" href="https://codesandbox.io/s/3r0nvw2z2p?hidenavigation=1&amp;module=%2Fjs%2Findex.js&amp;moduleview=1" rel="noopener ugc nofollow" target="_blank"><em class="lc">code sandbox</em></a><em class="lc"/><a class="ae kl" href="https://www.mikewesthad.com/phaser-3-tilemap-blog-posts/post-3/04-dungeon-final" rel="noopener ugc nofollow" target="_blank"><em class="lc">live示例</em> </a> <em class="lc">或源代码</em> <a class="ae kl" href="https://github.com/mikewesthad/phaser-3-tilemap-blog-posts/blob/master/examples/post-3/04-dungeon-final" rel="noopener ugc nofollow" target="_blank"> <em class="lc">此处</em> </a> <em class="lc">。</em></figcaption></figure><h1 id="2973" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">临时演员:下楼梯</h1><p id="c0bf" class="pw-post-body-paragraph jn jo iq jp b jq mp js jt ju mq jw jx jy mr ka kb kc ms ke kf kg mt ki kj kk ij bi translated">在最后一个代码示例中，我添加了几个额外的位。使用瓷砖索引回调，我们可以检测玩家何时到达楼梯，并重新启动场景，让玩家进入一个新的地牢。<code class="fe mu mv mw mx b"><a class="ae kl" href="https://photonstorm.github.io/phaser3-docs/Phaser.Tilemaps.TilemapLayer.html#setTileIndexCallback__anchor" rel="noopener ugc nofollow" target="_blank">setTileIndexCallback</a></code>将设置一个回调函数，在街机主体与给定索引的方块相交时运行。这在我们的游戏中很有用，因为我们只有一个移动的身体(玩家)。<code class="fe mu mv mw mx b">create</code>里面的相关代码是这样的:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="0d9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我还在场景中添加了一个<code class="fe mu mv mw mx b">level</code>属性，这样我们就可以告诉玩家他们在哪个级别:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="my mz l"/></div></figure><h1 id="cb08" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">下一个</h1><p id="9a42" class="pw-post-body-paragraph jn jo iq jp b jq mp js jt ju mq jw jx jy mr ka kb kc ms ke kf kg mt ki kj kk ij bi translated">查看下一篇<a class="ae kl" href="https://medium.com/@michaelwesthadley/modular-game-worlds-in-phaser-3-tilemaps-4-meet-matter-js-abf4dfa65ca1" rel="noopener">帖子</a>，我们将使用更先进的物理引擎<a class="ae kl" href="http://brm.io/matter-js/" rel="noopener ugc nofollow" target="_blank"> Matter.js </a>和tilemaps进行研究:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nk"><img src="../Images/872297c63975d2fc9ae69604793f42ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*TMWo_mBNrA9StXQYj_T7FQ.gif"/></div></div></figure><p id="4227" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢您的阅读，如果您想在以后的帖子中看到什么，请告诉我！</p><h1 id="8886" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">关于我</h1><p id="c967" class="pw-post-body-paragraph jn jo iq jp b jq mp js jt ju mq jw jx jy mr ka kb kc ms ke kf kg mt ki kj kk ij bi translated">我是一名创意开发人员和教育家。我为Phaser 3编写了Tilemap API，并创建了大量有指导的示例，但我希望将所有这些信息收集成一种更有指导、更易理解的格式，以便人们可以更容易地进入Phaser 3。你可以看到更多我的作品，并在这里联系<a class="ae kl" href="https://www.mikewesthad.com/" rel="noopener ugc nofollow" target="_blank"/>。</p></div></div>    
</body>
</html>