<html>
<head>
<title>Enforcing policies in Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Kubernetes执行政策</h1>
<blockquote>原文：<a href="https://itnext.io/enforcing-policies-in-kubernetes-c0f6192bd5ca?source=collection_archive---------3-----------------------#2020-11-17">https://itnext.io/enforcing-policies-in-kubernetes-c0f6192bd5ca?source=collection_archive---------3-----------------------#2020-11-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="3484" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kubernetes(K8S)已经成为基于容器的工作负载的首选平台，许多公司已经开始或即将开始将其工作负载迁移到Kubernetes。</p><p id="cd6c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kubernetes提供了许多现成的功能，并且向开发人员公开了许多与基础设施相关的控件。不习惯处理这些基础设施级别问题的开发人员可能会努力掌握所有这些不受他们支配的新控件和抽象。培训(比如这里的<a class="ae kl" href="https://kube.academy/" rel="noopener ugc nofollow" target="_blank"/>)当然有助于开发人员快速掌握K8S，但是如果我们真的想确保我们的应用程序满足所有要求(比如可用性、安全性等)。)我们希望它们实现，我们最好做的不仅仅是在内部网维基页面上发布最佳实践，并期望开发人员虔诚地遵守这些最佳实践。</p><p id="f35b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是您如何执行您公司的K8S最佳实践呢？您如何创建涵盖安全性和高可用性问题的“策略”？如何管理软件服务的行为？</p><p id="1b72" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="km">的所有相关文件都可以在</em> <a class="ae kl" href="https://github.com/mcelep/blog/tree/master/opa-policies/conformance-testing" rel="noopener ugc nofollow" target="_blank"> <em class="km">这个git回购</em> </a> <em class="km">中找到。</em></p><h2 id="6bd8" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">输入开放策略代理(OPA)</h2><p id="3140" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated"><a class="ae kl" href="https://www.openpolicyagent.org/" rel="noopener ugc nofollow" target="_blank">开放策略代理(OPA) </a>是一个云本地计算基础项目，旨在解决跨云本地堆栈(Kubernetes、Docker、Envoy、Terraform等)的“策略执行”问题。).</p><p id="8f74" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">OPA附带了一种叫做<a class="ae kl" href="https://www.openpolicyagent.org/docs/latest/policy-language/" rel="noopener ugc nofollow" target="_blank">减压阀</a>的语言来高效地创作策略，除了减压阀，OPA中还有许多工具&amp;组件来使策略的使用更加简单&amp;高效。</p><h2 id="e2ba" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">实施策略和运行策略检查的不同选项</h2><p id="eb38" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">我们看到了几个选项来执行策略并通知用户与策略的一致性。</p><h2 id="68e9" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">准入控制器</h2><p id="83d2" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">最终级别的强制策略直接发生在K8S集群上。也就是说，可以挂钩到Kubernetes的<a class="ae kl" href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/" rel="noopener ugc nofollow" target="_blank">准入控制器</a>机制来拒绝策略不允许的K8S资源修改。</p><p id="47cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">OPA附带了一个名为<a class="ae kl" href="https://www.openpolicyagent.org/docs/latest/kubernetes-introduction/" rel="noopener ugc nofollow" target="_blank"> Gatekeeper </a>的组件，这个组件是一个准入控制器，它的目标是在K8S集群上轻松管理和实施策略。</p><p id="12da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">OPA网守可以(自2020年10月30日起)拒绝接纳请求(可选地提供一些关于接纳被拒绝的原因的解释)或不带任何解释地接受接纳请求。目前，没有办法接受许可，而是向用户返回一个<strong class="jp ir">警告</strong>(一个用例可能是这样的:一个请求可能在那个时间点被许可，但由于即将到来的策略更新，在稍后的日期将不再被许可)。Github上有一个<a class="ae kl" href="https://github.com/open-policy-agent/gatekeeper/issues/701" rel="noopener ugc nofollow" target="_blank">未解决的问题</a>是关于增加一个<em class="km">警告</em>动作。</p><p id="0eda" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<em class="km">准入控制器</em>带来了一种二进制方法来接受K8S集群上API资源的更改。这有助于确保没有不符合策略的工作负载在平台上运行，但是它没有区分推荐的和强制的实践。这就是基于“成绩单”的方法派上用场的地方。</p><h2 id="105e" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">可视化/报告卡</h2><p id="0c5c" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">为K8S集群上运行的工作负载创建一个“一致性”报告是一个很好的方法，可以提高应用程序团队对其应用程序如何满足需求的认识。在我们的专业服务项目中，包括将应用程序调试到生产环境中，我们通常会准备一份定制的“生产准备就绪清单”文档，其中包括强制项目和推荐项目。该列表中的某些点可能非常普遍，但由于高可用性、性能或法规要求(如金融服务法规)等需求，有些点是特定于客户的。</p><p id="3f39" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个按需(或定期)以编程方式生成的报告卡，并以一种视觉上令人愉悦的方式向用户显示该报告，对于许多拥有许多K8S应用程序的大型组织来说非常有用。</p><p id="7101" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/FairwindsOps/polaris" rel="noopener ugc nofollow" target="_blank">北极星OS项目</a>自带了这样一个开箱即用的功能，见下图:</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div class="ab gu cl lq"><img src="../Images/97488af7f4100021672b75edcca9c4c3.png" data-original-src="https://miro.medium.com/v2/0*f6a6L6ICKIHMHDSs"/></div></figure><p id="b0f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当创建这样的报告时，不仅显示失败的策略检查，而且提供关于为什么创建这样的策略规则以及如何修复该问题的一些解释(通常通过提供到内部wiki页面的链接)，将会被报告的读者非常欣赏。</p><h2 id="ff14" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">CI/CD</h2><p id="4179" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">您可以根据策略测试K8S资源的另一个点/阶段是CI/CD管道，更准确地说，是CI/CD的CD(连续交付)部分。在大多数CI/CD解决方案中，向部署管道添加一个“策略检查步骤”应该很容易。作为部署管道的一部分运行策略一致性检查的好处是，一致性检查结果不仅可以包括<strong class="jp ir"> Ok </strong>或<strong class="jp ir"> Nok </strong> s，还可以包括警告。CI/CD系统还可能允许您保存报告。此外，如果K8S集群(尤其是生产集群)只能通过CD管道访问(而不是像我们在许多企业中看到的那样由用户直接访问)，并且如果您可以在所有部署管道中强制执行这样的“策略检查步骤”，那么您最终会得到一个类似于“准入控制器”的解决方案。</p><h2 id="3677" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">外地加工措施政策实践</h2><p id="6e91" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">在这一节中，我们将编写一些策略来更好地理解这个过程。</p><h2 id="f44a" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">减压阀</h2><p id="5279" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated"><a class="ae kl" href="https://www.openpolicyagent.org/docs/latest/policy-language/" rel="noopener ugc nofollow" target="_blank">减压阀</a>是一种DSL，进入它并不困难，但据说需要一些时间来适应。</p><p id="4402" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://academy.styra.com/courses/opa-rego" rel="noopener ugc nofollow" target="_blank">如果您想从基于自定进度视频的培训开始，这个</a>免费课程会很有帮助。</p><p id="9f3c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">学习它的最好方法是使用它，在学习减压阀时，在交互式shell中练习会非常有帮助，下面是一些选项:</p><ul class=""><li id="f47e" class="lt lu iq jp b jq jr ju jv jy lv kc lw kg lx kk ly lz ma mb bi translated">Playground 可以方便地在线测试rego表达式。</li><li id="b13b" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">如果你想有一个本地环境来测试rego中的东西，可以使用rego的REPL环境。</li></ul><p id="7ce0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您使用Visual Studio代码作为编辑器，您可能还会发现<a class="ae kl" href="https://marketplace.visualstudio.com/items?itemName=tsandall.opa" rel="noopener ugc nofollow" target="_blank">这个</a>插件在开发减压阀策略时很有帮助。</p><h2 id="790f" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">Conftest</h2><p id="d0d5" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated"><a class="ae kl" href="https://www.conftest.dev/" rel="noopener ugc nofollow" target="_blank"> Conftest </a>是一个帮助编写/维护针对文件(结构化数据)的基于<a class="ae kl" href="https://www.openpolicyagent.org/docs/latest/policy-language/" rel="noopener ugc nofollow" target="_blank">减压阀</a>的策略的实用程序。</p><p id="331f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用conftest来运行单元测试。OPA cli和conftest都有运行单元测试的方法。随着我们创建的策略文件变得越来越复杂，单元测试会让我们安心一些。在编写那些单元测试时，我们应该注意测试正反两种情况。例如，如果我们测试一个应该“警告”我们的规则，我们需要编写单元测试来触发一个警告，但也是一个“快乐的路径”,因为没有警告被触发。</p><p id="7830" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们旨在编写的策略涵盖了部署方面的以下问题:</p><ul class=""><li id="0bd1" class="lt lu iq jp b jq jr ju jv jy lv kc lw kg lx kk ly lz ma mb bi translated">一个部署应该至少有2个副本(为了高可用性)</li><li id="67b0" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">部署中的容器应该有一个活动探测器</li><li id="206f" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">容器是一个部署，应该有一个准备就绪探测器</li><li id="198e" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">部署中的容器应该为<em class="km">限制</em>和<em class="km">请求</em>定义资源</li><li id="9776" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">部署应设置反关联性规则</li></ul><p id="2fd2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以上这些问题只是为了提供一组在K8S集群上运行生产应用程序的基本最佳实践。它们并不意味着是完整的，它们只是作为试验减压阀政策的输入。</p><p id="2f91" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<em class="km">策略</em>文件夹下有策略文件及其对应的单元测试文件(后缀:<em class="km"> _test </em>)。</p><p id="5f5a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Conftest为规则提供了3个级别:<em class="km">拒绝、违反和警告</em>。在我们的示例部署策略文件(Deployment.rego)中，我们决定使用<em class="km"> warn </em>级别，并在<em class="km"> warn_ </em>之后的部分包含一个描述性名称。比如<code class="fe mh mi mj mk b">warn_at_least_2_replicas[msg]</code>。本例中称为<em class="km"> msg </em>的变量用作输出变量。在我们的规则中，<em class="km">消息</em>的值是静态的，它不依赖于该规则接收的数据，但是您可能希望使<em class="km">消息</em>的值是动态的，以提供关于输入数据的哪一部分不符合规则的解释/提示。</p><p id="86b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在与策略文件<em class="km"> deployment.rego </em>相同的文件夹中提供了一个附带的单元测试<em class="km"> deployment_test.rego </em>。单元测试中使用的数据也嵌入到单元测试文件中。例如，对于以规则<em class="km">warn _ at _ least _ 2 _ replicas</em>为目标的测试，有两个名为<em class="km"> deployment_1_replica </em>和<em class="km"> deployment_2_replica </em>的变量包含相关数据。尽管将大量的测试数据嵌入到单元测试文件本身并不是一个理想的解决方案，但是这部分应该得到改进。在<em class="km">助手</em>中有一个python脚本，它被编写用来将yaml转换成json，同时删除空元素，因为它们被证明对rego编译器是有问题的。</p><h2 id="3366" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">运行单元测试</h2><p id="6034" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">Conftest附带了单元测试功能来检查规则的健全性，这被证明是一个非常有用的特性。减压阀，虽然它不是一种很难掌握的语言，但需要一些时间来适应，所以为每个规则编写快乐和不快乐路径的单元测试将有助于提高质量保证。</p><p id="71a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可以使用以下命令执行单元测试:</p><pre class="ll lm ln lo gt ml mk mm mn aw mo bi"><span id="1e53" class="kn ko iq mk b gy mp mq l mr ms">#Make sure you are in the folder that includes the folder policy<br/>conftest verify --trace</span></pre><h2 id="e352" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">执行策略检查</h2><p id="df3a" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">可以针对静态文件测试策略文件:</p><pre class="ll lm ln lo gt ml mk mm mn aw mo bi"><span id="ce64" class="kn ko iq mk b gy mp mq l mr ms">#Make sure you are in folder conftest<br/>cat helpers/deployment.yaml | conftest test -</span></pre><p id="00d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或实时Kubernetes资源:</p><pre class="ll lm ln lo gt ml mk mm mn aw mo bi"><span id="d330" class="kn ko iq mk b gy mp mq l mr ms">k get deployments nginx -n test -o yaml | conftest test -<br/>+ kubectl get deployments nginx -n test -o yaml<br/>WARN - There must be a readinessProbe for each container<br/>WARN - There must be at least 2 replicas for each deployment<br/>WARN - Pod affinity rules should have been set<br/><br/>8 tests, 5 passed, 3 warnings, 0 failures, 0 exceptions</span></pre></div></div>    
</body>
</html>