<html>
<head>
<title>Nuxt Express-Template &amp; Azure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">nuxt Express-模板和Azure</h1>
<blockquote>原文：<a href="https://itnext.io/nuxt-express-template-azure-e3fce9458de1?source=collection_archive---------3-----------------------#2018-05-28">https://itnext.io/nuxt-express-template-azure-e3fce9458de1?source=collection_archive---------3-----------------------#2018-05-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="2fec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">内容:<br/> - context <br/> -配置azure<br/>-env vars<br/>-web . config<br/>-kudu<br/>-整理笔记</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/6a75f051d5e66ae40795f82d1dc60b4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OD7bX9q-QYhChu0J."/></div></div></figure><h1 id="6710" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated"><strong class="ak">语境</strong></h1><p id="87ca" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">我想把这个故事放在这里，以帮助任何其他在Azure上遇到Nuxt Express生产部署问题的可怜人。</p><p id="4f5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">想象一下，你有一个有两个需求的项目:<br/> 1)你需要部署一个node.js应用程序——一个闪亮的新应用程序，可以满足你所有的API和MVVM需求，nuxt-community包‘express-nuxt’可以愉快而高效地完成这项工作。这个应用程序必须部署在Azure(微软云)基础设施中。</p><p id="6bb3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第二个要求是你将在哪里遇到一些困难，我将在下面给你答案！</p><p id="ba1a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意，这不是一个循序渐进的教程。</p></div><div class="ab cl ma mb hu mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ij ik il im in"><h1 id="c769" class="kx ky iq bd kz la mh lc ld le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu bi translated"><strong class="ak">azure的配置</strong></h1><p id="a300" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated"><strong class="jp ir">环境变量</strong></p><p id="aad5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Azure &gt;你的应用程序&gt;应用程序设置中的应用程序设置内定义你的节点和npm版本是非常值得的，而不是在package.json或iisnode.yml文件内。</p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="7b49" class="mr ky iq mn b gy ms mt l mu mv">WEBSITE_NODE_DEFAULT_VERSION : 8.11.1<br/>WEBSITE_NPM_DEFAULT_VERSION : 5.6.0</span></pre><p id="acda" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您决定在package.json中添加引擎版本:</p><p id="4578" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mw"> package.json </em></p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="065a" class="mr ky iq mn b gy ms mt l mu mv">"engines": {<br/>    "npm": "5.6.0",<br/>    "node": "8.11.1"<br/>}</span></pre><p id="411c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意，Azure对待所有这些定义引擎版本的方法是不同的。如果使用iisnode.yml文件定义引擎，它应该覆盖package.json和应用程序设置定义。</p><p id="18c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在应用程序设置中添加以下内容将打开调试</p><p id="4a47" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> web.config </strong></p><p id="e486" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">web配置文件是应用程序在Azure上运行所必需的，它允许您定义IISnode模块应该通过管道将请求发送到的入口点。这对于设置来说可能有点挑剔，基本前提是您希望将所有请求定向到nuxt应用程序的main.app。</p><p id="0cef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是我当前的web.config文件的例子，包括注释。</p><p id="dbb1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mw"> web.config </em></p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="ffd2" class="mr ky iq mn b gy ms mt l mu mv">&lt;configuration&gt;<br/>  &lt;system.webServer&gt;<br/>    &lt;webSocket enabled="false" /&gt;<br/>    &lt;handlers&gt;<br/>      &lt;!-- Indicates that the main.js file is a node.js site to be handled by the iisnode module --&gt;<br/>      &lt;add name="iisnode" path="main.js" verb="*" modules="iisnode"/&gt;<br/>    &lt;/handlers&gt;<br/>    &lt;rewrite&gt;<br/>      &lt;rules&gt;<br/>        &lt;!-- Do not interfere with requests for node-inspector debugging --&gt;<br/>        &lt;rule name="NodeInspector" patternSyntax="ECMAScript" stopProcessing="true"&gt;<br/>          &lt;match url="^main.js\/debug[\/]?" /&gt;<br/>        &lt;/rule&gt;<br/><br/>        &lt;!-- &lt;rule name="Redirect to https" stopProcessing="true"&gt;<br/>          &lt;match url="(.*)"/&gt;<br/>          &lt;conditions&gt;<br/>            &lt;add input="{HTTPS}" pattern="Off"/&gt;<br/>            &lt;add input="{REQUEST_METHOD}" pattern="^get$|^head$" /&gt;<br/>          &lt;/conditions&gt;<br/>          &lt;action type="Redirect" url="https://{HTTP_HOST}/{R:1}"/&gt;<br/>        &lt;/rule&gt; --&gt;<br/><br/>        &lt;!-- First we consider whether the incoming URL matches a physical file in the /public folder --&gt;<br/>        &lt;rule name="StaticContent"&gt;<br/>          &lt;action type="Rewrite" url="public{REQUEST_URI}"/&gt;<br/>        &lt;/rule&gt;<br/><br/>        &lt;!-- All other URLs are mapped to the node.js site entry point --&gt;<br/>        &lt;rule name="DynamicContent"&gt;<br/>          &lt;conditions&gt;<br/>            &lt;add input="{REQUEST_FILENAME}" matchType="IsFile" negate="True"/&gt;<br/>          &lt;/conditions&gt;<br/>          &lt;action type="Rewrite" url="main.js"/&gt;<br/>        &lt;/rule&gt;<br/><br/>      &lt;/rules&gt;<br/>    &lt;/rewrite&gt;<br/><br/>    &lt;!-- 'bin' directory has no special meaning in node.js and apps can be placed in it --&gt;<br/>    &lt;security&gt;<br/>      &lt;requestFiltering&gt;<br/>        &lt;hiddenSegments&gt;<br/>          &lt;remove segment="bin"/&gt;<br/>        &lt;/hiddenSegments&gt;<br/>      &lt;/requestFiltering&gt;<br/>    &lt;/security&gt;<br/><br/>    &lt;!-- Make sure error responses are left untouched --&gt;<br/>    &lt;httpErrors existingResponse="PassThrough" /&gt;<br/><br/>    &lt;!--<br/>      You can control how Node is hosted within IIS using the following options:<br/>        * watchedFiles: semi-colon separated list of files that will be watched for changes to restart the server<br/>        * node_env: will be propagated to node as NODE_ENV environment variable<br/>        * debuggingEnabled - controls whether the built-in debugger is enabled<br/>    --&gt;<br/>  &lt;/system.webServer&gt;<br/>&lt;/configuration&gt;</span></pre><p id="449b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">库杜</strong></p><p id="34e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于kudu的一个说明是完全公开的:微软支持技术人员强烈建议我不要运行定制部署或构建脚本，我忽略了他们。Microsoft的建议是预构建应用程序并提交所有/build和。nuxt到应用程序存储库。</p><p id="2adc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kudu为你的Azure应用程序执行预构建到后构建脚本，这很容易操作。添加一个. deployment文件，该文件只包含要运行的bash脚本的定义。</p><p id="a7ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mw">。部署</em></p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="9c97" class="mr ky iq mn b gy ms mt l mu mv">[config]<br/>command = bash deploy.sh</span></pre><p id="15bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这告诉kudu将deployment.sh文件作为自定义部署脚本运行，而不是Azure默认使用的标准脚本。</p><p id="fba6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">deploy.sh内容取决于您的具体构建，我的配置如下。</p><p id="2cbe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mw"> deploy.sh </em></p><pre class="km kn ko kp gt mm mn mo mp aw mq bi"><span id="83cc" class="mr ky iq mn b gy ms mt l mu mv">#!/bin/bash<br/><br/># ----------------------<br/># KUDU Deployment Script<br/># Version: 1.0.17<br/># ----------------------<br/><br/># Helpers<br/># -------<br/><br/>exitWithMessageOnError () {<br/>  if [ ! $? -eq 0 ]; then<br/>    echo "An error has occurred during web site deployment."<br/>    echo $1<br/>    exit 1<br/>  fi<br/>}<br/><br/># Prerequisites<br/># -------------<br/><br/># Verify node.js installed<br/>hash node 2&gt;/dev/null<br/>exitWithMessageOnError "Missing node.js executable, please install node.js, if already installed make sure it can be reached from current environment."<br/><br/># Setup<br/># -----<br/><br/>SCRIPT_DIR="${BASH_SOURCE[0]%\\*}"<br/>SCRIPT_DIR="${SCRIPT_DIR%/*}"<br/>ARTIFACTS=$SCRIPT_DIR/../artifacts<br/>KUDU_SYNC_CMD=${KUDU_SYNC_CMD//\"}<br/><br/>if [[ ! -n "$DEPLOYMENT_SOURCE" ]]; then<br/>  DEPLOYMENT_SOURCE=$SCRIPT_DIR<br/>fi<br/><br/>if [[ ! -n "$NEXT_MANIFEST_PATH" ]]; then<br/>  NEXT_MANIFEST_PATH=$ARTIFACTS/manifest<br/><br/>  if [[ ! -n "$PREVIOUS_MANIFEST_PATH" ]]; then<br/>    PREVIOUS_MANIFEST_PATH=$NEXT_MANIFEST_PATH<br/>  fi<br/>fi<br/><br/>if [[ ! -n "$DEPLOYMENT_TARGET" ]]; then<br/>  DEPLOYMENT_TARGET=$ARTIFACTS/wwwroot<br/>else<br/>  KUDU_SERVICE=true<br/>fi<br/><br/>if [[ ! -n "$KUDU_SYNC_CMD" ]]; then<br/>  # Install kudu sync<br/>  echo Installing Kudu Sync<br/>  npm install kudusync -g --silent<br/>  exitWithMessageOnError "npm failed"<br/><br/>  if [[ ! -n "$KUDU_SERVICE" ]]; then<br/>    # In case we are running locally this is the correct location of kuduSync<br/>    KUDU_SYNC_CMD=kuduSync<br/>  else<br/>    # In case we are running on kudu service this is the correct location of kuduSync<br/>    KUDU_SYNC_CMD=$APPDATA/npm/node_modules/kuduSync/bin/kuduSync<br/>  fi<br/>fi<br/><br/># Node Helpers<br/># ------------<br/><br/>selectNodeVersion () {<br/>  if [[ -n "$KUDU_SELECT_NODE_VERSION_CMD" ]]; then<br/>    SELECT_NODE_VERSION="$KUDU_SELECT_NODE_VERSION_CMD \"$DEPLOYMENT_SOURCE\" \"$DEPLOYMENT_TARGET\" \"$DEPLOYMENT_TEMP\""<br/>    eval $SELECT_NODE_VERSION<br/>    exitWithMessageOnError "select node version failed"<br/><br/>    if [[ -e "$DEPLOYMENT_TEMP/__nodeVersion.tmp" ]]; then<br/>      NODE_EXE=`cat "$DEPLOYMENT_TEMP/__nodeVersion.tmp"`<br/>      exitWithMessageOnError "getting node version failed"<br/>    fi<br/><br/>    if [[ -e "$DEPLOYMENT_TEMP/__npmVersion.tmp" ]]; then<br/>      NPM_JS_PATH=`cat "$DEPLOYMENT_TEMP/__npmVersion.tmp"`<br/>      exitWithMessageOnError "getting npm version failed"<br/>    fi<br/><br/>    if [[ ! -n "$NODE_EXE" ]]; then<br/>      NODE_EXE=node<br/>    fi<br/><br/>    NPM_CMD="\"$NODE_EXE\" \"$NPM_JS_PATH\""<br/>  else<br/>    NPM_CMD=npm<br/>    NODE_EXE=node<br/>  fi<br/>}<br/><br/>##################################################################################################################################<br/># Deployment<br/># ----------<br/><br/>echo Handling node.js deployment.<br/><br/># 1. KuduSync<br/>if [[ "$IN_PLACE_DEPLOYMENT" -ne "1" ]]; then<br/>  "$KUDU_SYNC_CMD" -v 50 -f "$DEPLOYMENT_SOURCE" -t "$DEPLOYMENT_TARGET" -n "$NEXT_MANIFEST_PATH" -p "$PREVIOUS_MANIFEST_PATH" -i ".git;.hg;.deployment;deploy.sh"<br/>  exitWithMessageOnError "Kudu Sync failed"<br/>fi<br/><br/># 2. Select node version<br/>selectNodeVersion<br/><br/># 3. Install npm packages and build<br/>if [ -e "$DEPLOYMENT_TARGET/package.json" ]; then<br/>  cd "$DEPLOYMENT_TARGET"<br/><br/>  echo "NPM_CMD is: $NPM_CMD"<br/>  echo "NODE_EXE is: $NODE_EXE"<br/><br/>  echo "Running $NPM_CMD install --production"<br/>  eval $NPM_CMD install --production<br/>  exitWithMessageOnError "npm install failed"<br/><br/>  echo "Running $NPM_CMD run build"<br/>  eval $NPM_CMD run build<br/>  exitWithMessageOnError "build failed"<br/><br/>  #Copy build back to root<br/>  eval cp build/* .<br/><br/>  # echo "Running $NPM_CMD run dev"<br/>  # eval $NPM_CMD run dev<br/>  # # eval npm run build<br/>  # exitWithMessageOnError "dev failed"<br/><br/>  cd - &gt; /dev/null<br/>fi<br/><br/><br/><br/>##################################################################################################################################<br/>echo "Finished successfully."</span></pre><p id="ceeb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还值得一提的是，在Azure中运行npm install和npm build非常慢——一个几乎没有依赖关系的小应用程序很容易就花了400多秒来部署。</p></div><div class="ab cl ma mb hu mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ij ik il im in"><h1 id="0855" class="kx ky iq bd kz la mh lc ld le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu bi translated">整理笔记</h1><p id="434e" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">根据提供的细节，你应该能够在Azure上启动并运行nuxt。老实说，虽然我自己也经历过这一旅程(没有任何其他选择)，但我还是强烈建议使用另一种云服务进行托管。还有许多其他供应商<strong class="jp ir"><em class="mw"/></strong><strong class="jp ir"><em class="mw">具有健壮和简化的流程，它们只需工作</em> </strong>，无需任何定制配置或hastle。如果Azure是你的项目的一个需求，至少你现在可以用这些知识来应对挑战了！</p></div></div>    
</body>
</html>