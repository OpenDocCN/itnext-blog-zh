<html>
<head>
<title>Multi-environment setup for your Angular app</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Angular应用程序的多环境设置</h1>
<blockquote>原文：<a href="https://itnext.io/multi-environment-setup-for-your-angular-app-a211d72f1ff1?source=collection_archive---------1-----------------------#2019-04-19">https://itnext.io/multi-environment-setup-for-your-angular-app-a211d72f1ff1?source=collection_archive---------1-----------------------#2019-04-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/06256b1e130701aed35a8d8b1686edfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Uf_LkjpQHAd4qDpAnqpwpQ.png"/></div></div></figure><p id="419f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">作为Angular开发人员，我们的工具中最受欢迎的新增功能之一当然是Angular CLI。CLI允许我们引导Angular应用程序，并在其整个生命周期中对其进行管理。</p><p id="ad79" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我喜欢使用的最好的特性之一是为我的项目设置多个环境。大多数应用程序可能至少使用两种环境:生产和开发。更大的应用程序很可能会运行几个环境，比如<em class="kw"> QA </em>、<em class="kw"> RC </em>、<em class="kw"> pre-prod </em>等等。</p><h2 id="dc20" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">配置</h2><p id="4d51" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">Angular CLI启动一个新项目，在文件夹<code class="fe lv lw lx ly b">environments</code> : <code class="fe lv lw lx ly b">environments.ts</code>和<code class="fe lv lw lx ly b">environments.prod.ts.</code>中有两个文件。</p><ul class=""><li id="1206" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv me mf mg mh bi translated">environment.prod.ts 是在使用生产配置构建应用程序时，CLI为我们注入的配置文件</li><li id="d160" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated"><em class="kw"> environment.ts </em>是我们在应用程序中引用的配置文件，CLI将在构建时负责获取正确的配置</li></ul><p id="de9e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这些文件看起来像什么？它们只是一个导出为“环境”的简单常量对象，最初看起来像这样:</p><pre class="mn mo mp mq gt mr ly ms mt aw mu bi"><span id="af32" class="kx ky iq ly b gy mv mw l mx my">// environment.ts<br/><em class="kw">export const </em>environment = {<br/>  production: <em class="kw">false<br/></em>};</span><span id="6f57" class="kx ky iq ly b gy mz mw l mx my">----------------------------</span><span id="81b2" class="kx ky iq ly b gy mz mw l mx my">// environment.prod.ts<br/><em class="kw">export const </em>environment = {<br/>  production: <em class="kw">true<br/></em>};</span></pre><blockquote class="na nb nc"><p id="899e" class="jy jz kw ka b kb kc kd ke kf kg kh ki nd kk kl km ne ko kp kq nf ks kt ku kv ij bi translated">⚠️你可能已经猜到了，这些值是在构建时注入到客户端的。所以请注意，不要将敏感值传递给这个对象。</p></blockquote><p id="1938" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">CLI允许我们定义多个自定义配置，这些配置将与我们的基础架构环境保持一致。因此，例如，我们可以定义另外两个环境— <em class="kw"> dev </em>和<em class="kw"> qa </em>。</p><p id="2407" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们继续在同一个文件夹中创建另外两个文件，我们将分别命名为<em class="kw"> environment.dev.ts </em>和<em class="kw"> environment.qa.ts. </em></p><p id="1ac6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了正确地设置环境，我们还需要通过将这些添加到配置文件<em class="kw"> angular.json. </em>来让Angular知道我们将通过扩展<em class="kw">配置</em>对象来做到这一点:</p><pre class="mn mo mp mq gt mr ly ms mt aw mu bi"><span id="a0c0" class="kx ky iq ly b gy mv mw l mx my">... // angular.json<br/>configurations": {<br/>    "production" {...} // leave as it is,</span><span id="f0d1" class="kx ky iq ly b gy mz mw l mx my">    "qa": {<br/>        "fileReplacements": [<br/>            {<br/>                "replace": "src/environments/environment.ts",<br/>                "with": "src/environments/environment.qa.ts"<br/>            }<br/>        ]<br/>    },<br/>    "dev": {<br/>        "fileReplacements": [<br/>            {<br/>                "replace": "src/environments/environment.ts",<br/>                "with": "src/environments/environment.dev.ts"<br/>            }<br/>        ]<br/>    }<br/>}</span></pre><p id="4ae6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，我们更新<em class="kw">服务</em>对象:</p><pre class="mn mo mp mq gt mr ly ms mt aw mu bi"><span id="2244" class="kx ky iq ly b gy mv mw l mx my">"serve": {<br/>    "builder": "@angular-devkit/build-angular:dev-server",<br/>    "options": {<br/>        "browserTarget": "&lt;appname&gt;:build"<br/>    },<br/>    "configurations": {<br/>        "production": ... // leave as it is<br/>        "dev": {<br/>            "browserTarget": "&lt;appname&gt;:build:dev"<br/>        },<br/>        "qa": {<br/>            "browserTarget": "&lt;appname&gt;:build:qa"<br/>        }<br/>    }<br/>},</span></pre><h2 id="3f3d" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">默认值</h2><p id="b67d" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">在处理多种环境时，一些环境通常具有相同的值。我通常会为所有环境设置默认值，为此我会创建一个名为<em class="kw">environment . defaults . ts</em>的文件，并在其中添加我希望环境默认设置的值:</p><pre class="mn mo mp mq gt mr ly ms mt aw mu bi"><span id="1633" class="kx ky iq ly b gy mv mw l mx my">// environment.defaults.ts<br/>export const environmment = {<br/>   production: false,<br/>   log: true,<br/>   flags: {<br/>      useNewHeader: true<br/>   }<br/>}</span></pre><p id="c268" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所有其他环境(除了e<em class="kw">n环境. ts </em>之外)将需要与对象<em class="kw">默认环境:</em>合并</p><pre class="mn mo mp mq gt mr ly ms mt aw mu bi"><span id="9b20" class="kx ky iq ly b gy mv mw l mx my">// environment.dev.ts<br/>import { environment as defaultEnvironment } from './environment.defaults.ts';</span><span id="7d8c" class="kx ky iq ly b gy mz mw l mx my">export const environment = {<br/>    ...defaultEnvironment,<br/>}</span><span id="83a0" class="kx ky iq ly b gy mz mw l mx my">// environment.qa.ts<br/>import { environment as defaultEnvironment } from './environment.defaults.ts';</span><span id="343b" class="kx ky iq ly b gy mz mw l mx my">export const environment = {<br/>    ...defaultEnvironment,<br/>    production: true<br/>}</span></pre><p id="f613" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">显然，我不希望日志记录或一个未经测试的组件出现在产品中！因此，我们覆盖了生产环境配置:</p><pre class="mn mo mp mq gt mr ly ms mt aw mu bi"><span id="e923" class="kx ky iq ly b gy mv mw l mx my">// environment.prod.ts<br/>import { environment as defaultEnvironment } from './environment.defaults.ts';</span><span id="c58d" class="kx ky iq ly b gy mz mw l mx my">export const environment = {<br/>    ...defaultEnvironment,</span><span id="2887" class="kx ky iq ly b gy mz mw l mx my">    production: true,<br/>    log: false,<br/>    flags: {<br/>      useNewHeader: false<br/>   }<br/>}</span></pre><blockquote class="na nb nc"><p id="a8a4" class="jy jz kw ka b kb kc kd ke kf kg kh ki nd kk kl km ne ko kp kq nf ks kt ku kv ij bi translated">💡由于这是一种简单的合并对象的方法，您可能希望使用一种更好的方法来合并深度嵌套的对象，这样您就不必重复相同的值。</p></blockquote><h2 id="f58a" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">为每个环境添加Npm脚本</h2><p id="0b94" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">既然我们已经定义了我们的自定义环境，现在是时候设置一个NPM脚本来为我们的应用程序提供自定义环境了。</p><p id="3a7e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们感兴趣的参数是<code class="fe lv lw lx ly b">-c</code>(或<code class="fe lv lw lx ly b">—-configuration</code>)。</p><p id="a00b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们用两个参数来扩展我们的npm脚本:</p><ul class=""><li id="aff5" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv me mf mg mh bi translated"><code class="fe lv lw lx ly b">-c</code>这将用来定义使用的环境</li><li id="f9c3" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated"><code class="fe lv lw lx ly b">—-port</code>这将用于为每个环境分配不同的端口，因此我们可以并行运行它们</li></ul><pre class="mn mo mp mq gt mr ly ms mt aw mu bi"><span id="03f9" class="kx ky iq ly b gy mv mw l mx my">// package.json</span><span id="03fc" class="kx ky iq ly b gy mz mw l mx my">{<br/>... // more stuff<br/>"scripts": {<br/>   "start:dev": "ng serve -c=dev --port=4201"<br/>   "start:qa": "ng serve -c=qa --port=4202"<br/>   ...<br/>   }<br/>}</span></pre><p id="b13b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要启动其中一个环境，只需运行它的相关命令:</p><pre class="mn mo mp mq gt mr ly ms mt aw mu bi"><span id="461b" class="kx ky iq ly b gy mv mw l mx my">npm run start:dev<br/>npm run start:qa --aot // will run qa configuration using AOT mode</span></pre><h2 id="36fe" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">使用别名导入🤓</h2><p id="9d90" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">由于环境文件位于根文件夹中，使用相对路径导入它会变得很麻烦。我建议使用感谢Typescript创建一个别名路径。</p><p id="e441" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为此，在根文件夹中找到并打开<em class="kw"> tsconfig.json </em>，并向对象<em class="kw"> compilerOptions </em>添加以下对象:</p><pre class="mn mo mp mq gt mr ly ms mt aw mu bi"><span id="1a16" class="kx ky iq ly b gy mv mw l mx my">"paths": {<br/>    "@environment": ["./src/environments/environment.ts"]<br/>}</span></pre><p id="1043" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们将通过简单地引用“@environment”作为路径来导入环境对象:</p><pre class="mn mo mp mq gt mr ly ms mt aw mu bi"><span id="9c6e" class="kx ky iq ly b gy mv mw l mx my"><em class="kw">import </em>{ Component } <em class="kw">from </em>'@angular/core';<br/><em class="kw">import </em>{ environment } <em class="kw">from </em>'@environment'; // nice!<br/><br/>@Component({<br/>    selector: 'app-root',<br/>    templateUrl: './app.component.html',<br/>})<br/><em class="kw">export class </em>AppComponent {<br/>    environment = environment;<br/>}</span></pre><blockquote class="na nb nc"><p id="ab24" class="jy jz kw ka b kb kc kd ke kf kg kh ki nd kk kl km ne ko kp kq nf ks kt ku kv ij bi translated">💡您的IDE可能会将“@environment”标记为未找到，这可能是因为IDE没有对该文件进行索引。如果你使用的是Webstorm，只需重启并使缓存失效</p></blockquote><h2 id="049b" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">对每个环境使用代理</h2><p id="2c17" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">最后但同样重要的是，我们需要考虑我们的远程环境将在不同的地址运行，这意味着我们要为每个环境定义正确的地址。CLI帮助我们在构建时传递正确的代理配置。</p><p id="af24" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我的建议是在根目录下创建一个名为<code class="fe lv lw lx ly b">proxy</code>的文件夹，然后添加名为<code class="fe lv lw lx ly b">&lt;env&gt;-proxy.conf.json</code>的文件，如下所示:</p><pre class="mn mo mp mq gt mr ly ms mt aw mu bi"><span id="2e8b" class="kx ky iq ly b gy mv mw l mx my">{<br/>  "/api": {<br/>    "target": "http://my.dev.env.com",<br/>    "secure": false,<br/>    "pathRewrite": {<br/>      "^/api": ""<br/>    }<br/>  }<br/>}</span></pre><p id="1a59" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在前一个文件中，我们告诉Angular将前缀为<code class="fe lv lw lx ly b">api</code>的调用重定向到配置中指定的目标。</p><p id="df64" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们继续将正确的代理配置添加到之前创建的配置中。</p><pre class="mn mo mp mq gt mr ly ms mt aw mu bi"><span id="ca3b" class="kx ky iq ly b gy mv mw l mx my">package.json</span><span id="202a" class="kx ky iq ly b gy mz mw l mx my">{<br/>... // more stuff<br/>"scripts": {<br/>   "start:dev": "ng serve -c=dev --port=4201 --proxy-config=proxy/dev-proxy.conf.json"<br/>   "start:qa": "ng serve -c=qa --port=4202 --proxy-config=proxy/qa-proxy.conf.json"<br/>   ...<br/>   }<br/>}</span></pre><blockquote class="na nb nc"><p id="0fb2" class="jy jz kw ka b kb kc kd ke kf kg kh ki nd kk kl km ne ko kp kq nf ks kt ku kv ij bi translated">💡您也可以通过在angular.json文件中更改它来实现同样的目的，但这取决于您自己。</p></blockquote><p id="cf9e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我发现这个解决方案特别重要，因为许多代码库仍然使用代码逻辑引用端点路径，在我看来，这并不安全和干净。</p><h1 id="e599" class="ng ky iq bd kz nh ni nj lc nk nl nm lf nn no np li nq nr ns ll nt nu nv lo nw bi translated">外卖⭐</h1><ul class=""><li id="bfc5" class="lz ma iq ka b kb lq kf lr kj nx kn ny kr nz kv me mf mg mh bi translated">使用Angular CLI设置多环境非常简单和强大，您可以根据需要添加任意数量的环境</li><li id="86f9" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">在构建时添加配置对象是强大的，但是不要添加敏感信息</li><li id="b9c3" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">向我们的环境中添加代理有助于我们避免代码中的逻辑，这也增加了安全性和简单性</li></ul><p id="ec8c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这篇文章最初发表在<a class="ae oa" href="https://frontend.consulting/multi-environment-setup-for-your-angular-app" rel="noopener ugc nofollow" target="_blank"> Frontend Consulting的博客</a></p></div></div>    
</body>
</html>