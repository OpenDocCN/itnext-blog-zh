<html>
<head>
<title>GitOpsify Cloud Infrastructure with Crossplane and Flux</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有交叉平面和通量的GitOpsify云基础架构</h1>
<blockquote>原文：<a href="https://itnext.io/gitopsify-cloud-infrastructure-with-crossplane-and-flux-d605d3043452?source=collection_archive---------1-----------------------#2022-02-21">https://itnext.io/gitopsify-cloud-infrastructure-with-crossplane-and-flux-d605d3043452?source=collection_archive---------1-----------------------#2022-02-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/17aeac344f717bf8a286b128dd4ad19f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hTDmgYZ5X2RDJ3Bt"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">在<a class="ae jd" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae jd" href="https://unsplash.com/@anagani_saikiran?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Sai Kiran Anagani </a>拍摄的照片</figcaption></figure><div class=""/><p id="151c" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将学习如何通过Crossplane自动配置云资源，并将其与GitOps实践相结合。</p><p id="5b97" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你是一名平台或开发工程师、基础设施架构师或运营专家，你将从这个博客中获益匪浅。</p><blockquote class="lb lc ld"><p id="4ff1" class="kd ke le kf b kg kh ki kj kk kl km kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated"><em class="jg">如果你是GitOps的新用户，请在我的博客</em><a class="ae jd" rel="noopener ugc nofollow" target="_blank" href="/gitops-with-kubernetes-740f37ea015b"><em class="jg">GitOps with Kubernetes</em></a>中阅读更多信息</p></blockquote><p id="9ed0" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们通过想象以下背景来搭建舞台。我们是一个大型组织中平台团队的一员。我们的目标是帮助开发团队快速使用我们的云基础设施。以下是一些基本要求:</p><ul class=""><li id="a739" class="li lj jg kf b kg kh kk kl ko lk ks ll kw lm la ln lo lp lq bi translated">平台团队没有资源来单独处理每个请求，所以必须有非常高的自动化程度</li><li id="93cb" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">公司政策是采用最小特权原则。我们应该只在需要时以最低的权限公开云资源。</li><li id="f534" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">开发人员对管理云不感兴趣，他们应该只<strong class="kf jh">消耗云资源</strong>，甚至不需要登录云控制台。</li><li id="ead4" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">新团队应该获得<strong class="kf jh">他们自己的</strong>云资源集，以便<strong class="kf jh">在加入平台时进行自我管理</strong>。</li><li id="de1c" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">按需提供新的云资源<strong class="kf jh"/>应该很容易。</li></ul><h2 id="3f20" class="lw lx jg bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">初始架构</h2><p id="c324" class="pw-post-body-paragraph kd ke jg kf b kg mp ki kj kk mq km kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">这些需求引导我们使用以下高级解决方案策略制定初始架构提案。</p><ul class=""><li id="3ec6" class="li lj jg kf b kg kh kk kl ko lk ks ll kw lm la ln lo lp lq bi translated">为各种类型的工作负载创建模板库(使用后台软件模板会有所帮助)</li><li id="79c5" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">一旦新团队加入并从模板创建了第一个存储库，它将触发CI管道，并通过将存储库作为源添加到Flux infrastructure repo来部署公共基础架构组件</li><li id="4074" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">一旦一个团队想要创建更多的云基础设施，他们可以将跨平面声明YAMLs放在其存储库中的指定文件夹中</li><li id="1bc1" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">使用交叉平面组合很容易实现对这一过程的调整</li></ul><blockquote class="lb lc ld"><p id="a350" class="kd ke le kf b kg kh ki kj kk kl km kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated"><em class="jg">在实际场景中，我们也可以使用Flux管理交叉平面，但出于演示目的，我们只关注应用程序级别。</em></p></blockquote><p id="a584" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">开发人员的体验应该与此类似:</p><figure class="mv mw mx my gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/d05cbd36bcbbbaf5076718660f700d19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ublaQjXAdDYU5awm.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">来源:作者</figcaption></figure><h1 id="5379" class="mz lx jg bd ly na nb nc mb nd ne nf me ng nh ni mh nj nk nl mk nm nn no mn np bi translated">工具和实施</h1><p id="77cf" class="pw-post-body-paragraph kd ke jg kf b kg mp ki kj kk mq km kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">了解了需求和初始架构，我们就可以开始选择工具了。对于我们的例子，我们将使用的工具是<a class="ae jd" href="https://fluxcd.io/" rel="noopener ugc nofollow" target="_blank">通量</a>和<a class="ae jd" href="https://crossplane.io/" rel="noopener ugc nofollow" target="_blank">交叉平面</a>。</p><blockquote class="lb lc ld"><p id="6be8" class="kd ke le kf b kg kh ki kj kk kl km kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated"><em class="jg">我们将使用Flux作为GitOps引擎，但同样可以用ArgoCD或Rancher Fleet实现。</em></p></blockquote><p id="af6d" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们看看这两种工具支持的架构和用例。</p><h2 id="472b" class="lw lx jg bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">Flux架构概述</h2><p id="0337" class="pw-post-body-paragraph kd ke jg kf b kg mp ki kj kk mq km kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">Flux以Kubernetes CRDs和控制器的形式公开了几个组件，这些组件有助于用GitOps模型表达工作流。3个主要组件的简短描述。所有这些组件都有相应的CRD。</p><figure class="mv mw mx my gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nq"><img src="../Images/963c0553bcf1067931f0988910834512.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7PKbiQT300FzAj1T.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">来源:<a class="ae jd" href="https://github.com/fluxcd/flux2" rel="noopener ugc nofollow" target="_blank">https://github.com/fluxcd/flux2</a></figcaption></figure><p id="4d26" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">源控制器的主要作用是提供一个标准化的API来管理Kubernetes部署的源；Git和Helm库。</p><pre class="mv mw mx my gt nr ns nt nu aw nv bi"><span id="ef58" class="lw lx jg ns b gy nw nx l ny nz">apiVersion: source.toolkit.fluxcd.io/v1beta1<br/>kind: GitRepository<br/>metadata:<br/>  name: podinfo<br/>  namespace: default<br/>spec:<br/>  interval: 1m<br/>  url: <a class="ae jd" href="https://github.com/stefanprodan/podinfo" rel="noopener ugc nofollow" target="_blank">https://github.com/stefanprodan/podinfo</a></span></pre><p id="d76d" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae jd" href="https://fluxcd.io/docs/components/kustomize/" rel="noopener ugc nofollow" target="_blank"> Kustomize控制器</a>这是工作流程中的CD部分。源控制器指定数据源，这个控制器指定从存储库中运行什么工件。</p><pre class="mv mw mx my gt nr ns nt nu aw nv bi"><span id="0b89" class="lw lx jg ns b gy nw nx l ny nz">apiVersion: kustomize.toolkit.fluxcd.io/v1beta2<br/>kind: Kustomization<br/>metadata:<br/>  name: webapp<br/>  namespace: apps<br/>spec:<br/>  interval: 5m<br/>  path: "./deploy"<br/>  sourceRef:<br/>    kind: GitRepository<br/>    name: webapp<br/>    namespace: shared</span></pre><blockquote class="lb lc ld"><p id="6a7d" class="kd ke le kf b kg kh ki kj kk kl km kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated">这个控制器可以处理kustomization文件，也可以处理普通的Kubernetes清单</p></blockquote><p id="1fd1" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae jd" href="https://fluxcd.io/docs/components/helm/" rel="noopener ugc nofollow" target="_blank"> Helm Controller </a>该操作员帮助管理包含Kubernetes清单的Helm chart发布，并将它们部署到集群上。</p><pre class="mv mw mx my gt nr ns nt nu aw nv bi"><span id="23c2" class="lw lx jg ns b gy nw nx l ny nz">apiVersion: helm.toolkit.fluxcd.io/v2beta1<br/>kind: HelmRelease<br/>metadata:<br/>  name: backend<br/>  namespace: default<br/>spec:<br/>  interval: 5m<br/>  chart:<br/>    spec:<br/>      chart: podinfo<br/>      version: "&gt;=4.0.0 &lt;5.0.0"<br/>      sourceRef:<br/>        kind: HelmRepository<br/>        name: podinfo<br/>        namespace: default<br/>      interval: 1m<br/>  upgrade:<br/>    remediation:<br/>      remediateLastFailure: true<br/>  test:<br/>    enable: true<br/>  values:<br/>    service:<br/>      grpcService: backend<br/>    resources:<br/>      requests:<br/>        cpu: 100m<br/>        memory: 64Mi</span></pre><h2 id="3941" class="lw lx jg bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">交叉平面架构概述</h2><p id="3a04" class="pw-post-body-paragraph kd ke jg kf b kg mp ki kj kk mq km kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">让我们看看交叉板组件模型是什么样子的。一句警告，如果你是Kubernetes的新手，这可能是压倒性的，但努力理解它是有价值的。下图显示了交叉面板组件模型及其基本交互。</p><figure class="mv mw mx my gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oa"><img src="../Images/41bd714de989d89c6567349b463d76e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*v0JADlCEUk6M-o7m.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">来源:作者基于Crossplane.io</figcaption></figure><blockquote class="lb lc ld"><p id="0803" class="kd ke le kf b kg kh ki kj kk kl km kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated"><em class="jg">在我的博客中了解更多关于Crossplane的信息</em> <a class="ae jd" rel="noopener ugc nofollow" target="_blank" href="/infrastructure-as-code-the-next-big-shift-is-here-9215f0bda7ce"> <em class="jg">基础设施即代码:下一个大转变就在这里</em></a><em class="jg"/></p></blockquote><h1 id="de7d" class="mz lx jg bd ly na nb nc mb nd ne nf me ng nh ni mh nj nk nl mk nm nn no mn np bi translated">演示</h1><p id="50a4" class="pw-post-body-paragraph kd ke jg kf b kg mp ki kj kk mq km kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">如果你想跟随演示，克隆这个库，它包含了运行演示代码的所有脚本。</p><h2 id="3310" class="lw lx jg bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">先决条件</h2><p id="67e8" class="pw-post-body-paragraph kd ke jg kf b kg mp ki kj kk mq km kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">在这个演示中，我们将展示如何使用Flux和Crossplane从一个新的GitHub存储库中直接提供一个EC2实例。这模拟了一个新团队加入我们的平台。</p><p id="a2cf" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要继续操作，您需要在本地机器上配置AWS CLI。</p><blockquote class="lb lc ld"><p id="2257" class="kd ke le kf b kg kh ki kj kk kl km kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated"><em class="jg">获得凭证后，按照本教程</em>  <em class="jg">中的</em> <a class="ae jd" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html#cli-configure-quickstart-config" rel="noopener ugc nofollow" target="_blank"> <em class="jg">为AWS CLI配置默认配置文件。</em></a></p></blockquote><p id="79b9" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本地安装您将需要:</p><ul class=""><li id="f841" class="li lj jg kf b kg kh kk kl ko lk ks ll kw lm la ln lo lp lq bi translated">Docker桌面或其他容器运行时</li><li id="64f9" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">使用Windows时的WSL2</li><li id="d970" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">库贝特尔</li></ul><p id="29e3" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在项目的根文件夹中运行<code class="fe ob oc od ns b">make</code>，这将:</p><blockquote class="lb lc ld"><p id="d122" class="kd ke le kf b kg kh ki kj kk kl km kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated"><em class="jg">如果你在Mac上运行，用</em> <code class="fe ob oc od ns b"><em class="jg">make setup_mac</em></code> <em class="jg">代替</em> <code class="fe ob oc od ns b"><em class="jg">make</em></code> <em class="jg">。</em></p></blockquote><ul class=""><li id="b229" class="li lj jg kf b kg kh kk kl ko lk ks ll kw lm la ln lo lp lq bi translated">如果尚未安装，安装<a class="ae jd" href="https://kind.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank">种类</a>(Docker中的Kubernetes)</li><li id="38d0" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">创建一种称为交叉平面集群集群，并向其交换上下文</li><li id="8165" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">使用舵安装交叉板</li><li id="5b7e" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">如果尚未安装，请安装交叉面板CLI</li><li id="be19" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">如果尚未安装flux CLI，请安装它</li><li id="995a" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">在群集上安装AWS提供程序</li><li id="3834" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">基于默认CLI配置文件创建一个带有AWS凭据的临时文件</li><li id="53ea" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">在交叉平面系统名称空间中使用AWS凭证创建一个秘密</li><li id="b509" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">将AWS提供程序配置为使用秘密来提供基础设施</li><li id="415b" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">删除带有凭证的临时文件，这样它就不会被意外签入存储库中</li></ul><p id="787e" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">以下工具需要手动安装</p><ul class=""><li id="b503" class="li lj jg kf b kg kh kk kl ko lk ks ll kw lm la ln lo lp lq bi translated"><a class="ae jd" href="https://github.com/cli/cli#installation" rel="noopener ugc nofollow" target="_blank"> GitHub CLI gh </a></li></ul><blockquote class="lb lc ld"><p id="4909" class="kd ke le kf b kg kh ki kj kk kl km kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated"><strong class="kf jh"> <em class="jg">重要提示:演示代码将在eu-centra-1地区创建一个小型EC2实例。作为演示的一部分，将删除实例和底层基础结构，但请确保所有资源都已成功删除，如果演示流程出现任何中断，请准备好手动删除资源。</em> </strong></p></blockquote><h2 id="fa03" class="lw lx jg bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">设置通量储存库</h2><ul class=""><li id="8f69" class="li lj jg kf b kg mp kk mq ko oe ks of kw og la ln lo lp lq bi translated">使用<code class="fe ob oc od ns b">make</code>创建一个新的集群，这将安装带有AWS提供者的交叉面板，并配置密码以访问选定的AWS帐户</li><li id="ae24" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">Flux CLI是作为Makefile脚本的put安装的，但是您也可以选择为CLI配置shell完成功能<code class="fe ob oc od ns b">. &lt;(flux completion zsh)</code></li><li id="6f62" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">更多安装选项参考<a class="ae jd" href="https://fluxcd.io/docs/installation/#install-the-flux-cli" rel="noopener ugc nofollow" target="_blank">焊剂文件</a>页</li><li id="7f27" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">在GitHub中创建一个拥有完全回购权限的<a class="ae jd" href="https://github.com/settings/tokens" rel="noopener ugc nofollow" target="_blank">访问令牌</a>。</li></ul><figure class="mv mw mx my gt is gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/807695538081d03d0d26e892d0574847.png" data-original-src="https://miro.medium.com/v2/resize:fit:1298/format:webp/0*w6VXu4g9tNfwzbXA.png"/></div></figure><ul class=""><li id="9273" class="li lj jg kf b kg kh kk kl ko lk ks ll kw lm la ln lo lp lq bi translated">为您的GitHub用户和新创建的令牌导出变量</li></ul><p id="951d" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od ns b">export GITHUB_TOKEN=&lt;token copied form GitHub&gt;</code></p><p id="05fe" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od ns b">export GITHUB_USER=&lt;your user name&gt;</code></p><ul class=""><li id="1378" class="li lj jg kf b kg kh kk kl ko lk ks ll kw lm la ln lo lp lq bi translated">使用flux引导一个新的GitHub库，这样flux可以管理自己和底层基础设施</li></ul><blockquote class="lb lc ld"><p id="0174" class="kd ke le kf b kg kh ki kj kk kl km kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated">Flux将寻找GITHUB_USER和GITHUB_TOKEN变量，一旦找到，将在GITHUB上创建一个私有存储库，Flux的基础设施将被跟踪。</p></blockquote><pre class="mv mw mx my gt nr ns nt nu aw nv bi"><span id="2279" class="lw lx jg ns b gy nw nx l ny nz">flux bootstrap github  \<br/>        --owner=${GITHUB_USER} \<br/>        --repository=flux-infra \<br/>        --path=clusters/crossplane-cluster  \<br/>        --personal</span></pre><h2 id="2df7" class="lw lx jg bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">设置交叉平面EC2组合</h2><p id="0560" class="pw-post-body-paragraph kd ke jg kf b kg mp ki kj kk mq km kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">现在，我们将安装一个<a class="ae jd" href="https://crossplane.io/docs/v1.6/concepts/composition.html#configuring-composition" rel="noopener ugc nofollow" target="_blank">交叉平面组合</a>,它定义当有人请求EC2声明时创建什么样的云资源。</p><ul class=""><li id="64d3" class="li lj jg kf b kg kh kk kl ko lk ks ll kw lm la ln lo lp lq bi translated">为创建EC2实例设置交叉平面组合和定义</li><li id="5553" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated"><code class="fe ob oc od ns b">kubectl crossplane install configuration piotrzan/crossplane-ec2-instance:v1</code></li><li id="514a" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">使用EC2声明<code class="fe ob oc od ns b">gh repo fork https://github.com/Piotr1215/crossplane-ec2</code>派生存储库，并在提示是否克隆存储库时回答YES</li></ul><h2 id="de13" class="lw lx jg bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">克隆Flux基础知识库</h2><ul class=""><li id="bb5c" class="li lj jg kf b kg mp kk mq ko oe ks of kw og la ln lo lp lq bi translated">克隆在您的个人存储库中创建的flux infra存储库</li><li id="07c1" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated"><code class="fe ob oc od ns b">git clone git@github.com:${GITHUB_USER}/flux-infra.git</code></li><li id="0faf" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated"><code class="fe ob oc od ns b">cd flux-infra</code></li></ul><h2 id="c4aa" class="lw lx jg bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">添加源</h2><ul class=""><li id="a7cb" class="li lj jg kf b kg mp kk mq ko oe ks of kw og la ln lo lp lq bi translated">添加源代码库来告诉Flux要观察和同步什么</li><li id="dec3" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">Flux将注册这个库，并每30秒检查一次变化。</li><li id="c420" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">在flux-infra存储库中执行下面的命令，它将添加一个Git源</li></ul><pre class="mv mw mx my gt nr ns nt nu aw nv bi"><span id="11b8" class="lw lx jg ns b gy nw nx l ny nz">flux create source git crossplane-demo \<br/>   --url=<a class="ae jd" href="https://github.com/${GITHUB_USER}/crossplane-ec2.git" rel="noopener ugc nofollow" target="_blank">https://github.com/${GITHUB_USER}/crossplane-ec2.git</a> \<br/>   --branch=master \<br/>   --interval=30s \<br/>   --export &gt; clusters/crossplane-cluster/demo-source.yaml</span></pre><ul class=""><li id="cd76" class="li lj jg kf b kg kh kk kl ko lk ks ll kw lm la ln lo lp lq bi translated">前面的命令在clusters/crossplane-cluster子文件夹中创建了一个文件，提交该文件</li></ul><p id="7373" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od ns b">git add .</code></p><p id="9804" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od ns b">git commit -m "Adding Source Repository"</code></p><p id="e85d" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od ns b">git push</code></p><ul class=""><li id="7813" class="li lj jg kf b kg kh kk kl ko lk ks ll kw lm la ln lo lp lq bi translated">执行<code class="fe ob oc od ns b">kubectl get gitrepositories.source.toolkit.fluxcd.io -A</code>查看动态的Git存储库源代码</li></ul><h2 id="324f" class="lw lx jg bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">创建通量库管理</h2><ul class=""><li id="fef8" class="li lj jg kf b kg mp kk mq ko oe ks of kw og la ln lo lp lq bi translated">AWS托管资源上的设置监视，目前应该没有</li><li id="2e4a" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated"><code class="fe ob oc od ns b">watch kubectl get managed</code></li><li id="464d" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">创建Flux Kustomization，通过交叉平面EC2声明监视存储库中的特定文件夹</li></ul><pre class="mv mw mx my gt nr ns nt nu aw nv bi"><span id="b856" class="lw lx jg ns b gy nw nx l ny nz">flux create kustomization crossplane-demo \<br/>  --target-namespace=default \<br/>  --source=crossplane-demo \<br/>  --path="./ec2-claim" \<br/>  --prune=true \<br/>  --interval=1m \<br/>  --export &gt; clusters/crossplane-cluster/crossplane-demo.yaml</span></pre><p id="dbd6" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od ns b">git add .</code></p><p id="86e4" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od ns b">git commit -m "Adding EC2 Instance"</code></p><p id="65a8" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od ns b">git push</code></p><ul class=""><li id="23fa" class="li lj jg kf b kg kh kk kl ko lk ks ll kw lm la ln lo lp lq bi translated">大约一分钟后，您应该会看到一个新的EC2实例与AWS中的Crossplane和resources同步</li></ul><figure class="mv mw mx my gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oi"><img src="../Images/896bb0bc92696f472d4e12b52c57b091.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lLLv64NwiX62tY59.png"/></div></div></figure><h2 id="c465" class="lw lx jg bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">概述</h2><p id="bd44" class="pw-post-body-paragraph kd ke jg kf b kg mp ki kj kk mq km kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">让我们后退一步，确保我们理解所有使用的资源和存储库。</p><figure class="mv mw mx my gt is gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/57cf517118e76e08176b1e1c5f0779f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:830/format:webp/0*G8VxP2T4SRhKGsri.png"/></div></figure><p id="b8e7" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们创建的第一个存储库是Flux用来在集群上管理自身以及其他存储库的。为了告诉Flux关于具有交叉平面EC2声明的存储库，我们创建了一个<code class="fe ob oc od ns b">GitSource</code> YAML文件，它指向具有EC2声明的存储库的HTTPS地址。</p><p id="32e8" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">EC2声明存储库包含一个文件夹，普通Kubernetes清单文件就位于其中。为了告诉Flux观察什么文件，我们创建了一个<code class="fe ob oc od ns b">Kustomization</code>，并通过它的名字将它与<code class="fe ob oc od ns b">GitSource</code>链接起来。<code class="fe ob oc od ns b">Kustomization</code>指向包含K8s清单的文件夹。</p><h2 id="ccc5" class="lw lx jg bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">清除</h2><ul class=""><li id="5a7a" class="li lj jg kf b kg mp kk mq ko oe ks of kw og la ln lo lp lq bi translated">要清理EC2实例和底层基础设施，请从crossplane-ec2存储库中删除claim-aws.yaml演示</li></ul><p id="8da5" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od ns b">rm ec2-claim/claim-aws.yaml</code></p><p id="4fc4" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od ns b">git add .</code></p><p id="179f" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od ns b">git commit -m "EC2 instance removed"</code></p><ul class=""><li id="5842" class="li lj jg kf b kg kh kk kl ko lk ks ll kw lm la ln lo lp lq bi translated">在提交或定时器失效后，Flux将同步，Crossplane将拾取移除的伪影并删除云资源</li></ul><blockquote class="lb lc ld"><p id="4f0b" class="kd ke le kf b kg kh ki kj kk kl km kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated">在索赔yaml被删除后，ec2-claim文件夹必须存在于repo中，否则Flux无法协调</p></blockquote><h2 id="d5d5" class="lw lx jg bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">手动清理</h2><blockquote class="lb lc ld"><p id="2d6c" class="kd ke le kf b kg kh ki kj kk kl km kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated"><em class="jg">如果您无法使用存储库，可以通过从flux中删除它们来清理资源。</em></p></blockquote><ul class=""><li id="cc5c" class="li lj jg kf b kg kh kk kl ko lk ks ll kw lm la ln lo lp lq bi translated">删除Flux kustomization <code class="fe ob oc od ns b">flux delete kustomization crossplane-demo</code>将从集群和AWS中删除所有资源</li><li id="6754" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">为了清理ec2实例和底层基础设施，从集群中删除EC2声明<code class="fe ob oc od ns b">kubectl delete VirtualMachineInstance sample-ec2</code></li></ul><h2 id="471e" class="lw lx jg bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">集群清理</h2><ul class=""><li id="51f3" class="li lj jg kf b kg mp kk mq ko oe ks of kw og la ln lo lp lq bi translated">等到<code class="fe ob oc od ns b">watch kubectl get managed</code>输出不包含任何AWS资源</li><li id="4f5b" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">用<code class="fe ob oc od ns b">make cleanup</code>删除集群</li><li id="c78d" class="li lj jg kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">选择性地移除<code class="fe ob oc od ns b">flux-infra</code>储存库</li></ul><h1 id="f85c" class="mz lx jg bd ly na nb nc mb nd ne nf me ng nh ni mh nj nk nl mk nm nn no mn np bi translated">摘要</h1><p id="3915" class="pw-post-body-paragraph kd ke jg kf b kg mp ki kj kk mq km kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">带有Flux或Argo CD和Crossplane的GitOps为平台构建者提供了一个非常强大和灵活的模型。在本演示中，我们将重点放在Kubernetes集群的应用程序方面，这些集群以其他方式部署，包括交叉平面、机群或集群API等。</p><p id="c9ac" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在使用Crossplane的资源模型的基础上，我们实现了这样一个事实，即我们不再直接与kubectl交互来管理资源，而是将此活动委托给Flux。交叉平面仍然在集群上运行，并协调所有资源。换句话说，我们已经将API表面从kubectl转移到Git。</p></div></div>    
</body>
</html>