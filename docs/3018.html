<html>
<head>
<title>How to run Kafka Streams applications on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Kubernetes上运行Kafka Streams应用程序</h1>
<blockquote>原文：<a href="https://itnext.io/learn-how-to-develop-a-kafka-streams-application-for-data-processing-and-deploy-it-to-kubernetes-231d4cbb0688?source=collection_archive---------2-----------------------#2019-09-16">https://itnext.io/learn-how-to-develop-a-kafka-streams-application-for-data-processing-and-deploy-it-to-kubernetes-231d4cbb0688?source=collection_archive---------2-----------------------#2019-09-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f17d" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">开发由Kafka和Kubernetes支持的无状态数据处理应用程序</h2></div><p id="75ec" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是一个由三部分组成的博客系列，涵盖了Kafka Streams在Kubernetes上的应用</p><ul class=""><li id="d69f" class="lb lc iq kh b ki kj kl km ko ld ks le kw lf la lg lh li lj bi translated">第1部分——这篇博文</li><li id="6e1b" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated">第2部分— <a class="ae lp" rel="noopener ugc nofollow" target="_blank" href="/how-to-use-kubernetes-to-deploy-stateful-kafka-streams-applications-872c77f03c3a">如何在Kubernetes上运行有状态的Kafka Streams应用程序</a></li><li id="a2a4" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated">第3部分— <a class="ae lp" rel="noopener ugc nofollow" target="_blank" href="/health-checks-for-kafka-streams-application-on-kubernetes-e9c5e8c21b0d">对Kubernetes上的Kafka Streams应用程序进行健康检查</a></li></ul></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="421a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本教程将指导您如何使用<a class="ae lp" href="https://kafka.apache.org/documentation/streams/" rel="noopener ugc nofollow" target="_blank"> Kafka Streams </a>库构建无状态流处理应用程序，并在Azure (AKS) 上的<a class="ae lp" href="https://docs.microsoft.com/azure/aks/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Kubernetes集群中运行它。</a></p><p id="487b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当您完成此操作时，您将了解以下内容:</p><ul class=""><li id="049c" class="lb lc iq kh b ki kj kl km ko ld ks le kw lf la lg lh li lj bi translated">什么是卡夫卡溪流？</li><li id="c4dd" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated">如何在Azure上设置和配置Docker容器注册表和Kubernetes集群</li><li id="4132" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated">使用Kafka流的流处理逻辑的Java代码中发生了什么</li><li id="6139" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated">如何在Kubernetes上构建和部署我们的应用程序，并最终使用Kafka CLI进行测试</li></ul><p id="a699" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">源代码在GitHub 上的<a class="ae lp" href="https://github.com/abhirockzz/kafka-streams-kubernetes" rel="noopener ugc nofollow" target="_blank"/></p><blockquote class="lx ly lz"><p id="ee8a" class="kf kg ma kh b ki kj jr kk kl km ju kn mb kp kq kr mc kt ku kv md kx ky kz la ij bi translated"><em class="iq">在这篇博客的最后有一个所有CLI命令的列表</em></p></blockquote><p id="cbe4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们开始之前，这里有一个最终状态的快照。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi me"><img src="../Images/e6190a8a3c3fe4630cb0b5863484cda4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LRuaKiaDsp0bqz-O.png"/></div></div></figure><h1 id="7aa3" class="mq mr iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">卡夫卡流概述</h1><p id="9bd4" class="pw-post-body-paragraph kf kg iq kh b ki ni jr kk kl nj ju kn ko nk kq kr ks nl ku kv kw nm ky kz la ij bi translated">它是一个简单的轻量级客户端库，可以很容易地嵌入到任何Java app或微服务中，其中的输入输出数据存储在<a class="ae lp" href="https://kafka.apache.org/" rel="noopener ugc nofollow" target="_blank"> Kafka clusters </a>中。除了Kafka本身和它的分区模型之外，它对其他系统没有外部依赖性，可以水平扩展处理，同时保持强大的排序保证。它支持容错本地状态，采用一次一条记录处理来实现毫秒级处理延迟，并提供必要的流处理原语，以及一个<a class="ae lp" href="https://kafka.apache.org/23/documentation/streams/developer-guide/dsl-api.html" rel="noopener ugc nofollow" target="_blank">高级流DSL </a>和一个<a class="ae lp" href="https://kafka.apache.org/23/documentation/streams/developer-guide/processor-api.html" rel="noopener ugc nofollow" target="_blank">低级处理器API </a>。“状态存储”和“交互式查询”的组合允许您从应用程序外部利用应用程序的状态。</p><h1 id="0c95" class="mq mr iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">先决条件:</h1><p id="2e40" class="pw-post-body-paragraph kf kg iq kh b ki ni jr kk kl nj ju kn ko nk kq kr ks nl ku kv kw nm ky kz la ij bi translated">如果你还没有，请<a class="ae lp" href="https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">安装Azure CLI </a>和<a class="ae lp" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank"> kubectl </a>。流处理应用程序是用Java编写的，使用<a class="ae lp" href="https://maven.apache.org/install.html" rel="noopener ugc nofollow" target="_blank"> Maven </a>，你还需要<a class="ae lp" href="https://docs.docker.com/install/" rel="noopener ugc nofollow" target="_blank"> Docker </a>来构建应用程序容器映像。</p><blockquote class="lx ly lz"><p id="c943" class="kf kg ma kh b ki kj jr kk kl km ju kn mb kp kq kr mc kt ku kv md kx ky kz la ij bi translated"><em class="iq">本教程假设您有一个Kafka集群，可以从Azure上的Kubernetes集群访问该集群</em></p></blockquote><h1 id="8125" class="mq mr iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">AKS集群设置</h1><p id="77df" class="pw-post-body-paragraph kf kg iq kh b ki ni jr kk kl nj ju kn ko nk kq kr ks nl ku kv kw nm ky kz la ij bi translated">你只需要一个命令就可以在Azure上建立一个Kubernetes集群。但是，在此之前，我们必须创建一个资源组</p><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="7204" class="ns mr iq no b gy nt nu l nv nw">export AZURE_SUBSCRIPTION_ID=[to be filled]<br/>export AZURE_RESOURCE_GROUP=[to be filled]<br/>export AZURE_REGION=[to be filled] (e.g. southeastasia)</span></pre><p id="d5ad" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">切换到您的套餐并调用<code class="fe nx ny nz no b">az group create</code></p><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="148d" class="ns mr iq no b gy nt nu l nv nw">az account set -s $AZURE_SUBSCRIPTION_ID<br/>az group create -l $AZURE_REGION -n $AZURE_RESOURCE_GROUP</span></pre><p id="6895" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您现在可以调用<code class="fe nx ny nz no b">az aks create</code>来创建新的集群</p><blockquote class="lx ly lz"><p id="4602" class="kf kg ma kh b ki kj jr kk kl km ju kn mb kp kq kr mc kt ku kv md kx ky kz la ij bi translated">为了简单起见，下面的命令创建了一个单节点集群。按照你的要求随意改变规格</p></blockquote><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="041a" class="ns mr iq no b gy nt nu l nv nw">export AKS_CLUSTER_NAME=[to be filled]</span><span id="a470" class="ns mr iq no b gy oa nu l nv nw">az aks create --resource-group $AZURE_RESOURCE_GROUP --name $AKS_CLUSTER_NAME --node-count 1 --node-vm-size Standard_B2s --node-osdisk-size 30 --generate-ssh-keys</span></pre><p id="8dd5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用<code class="fe nx ny nz no b">az aks get-credentials</code>获取AKS集群凭证——因此，<code class="fe nx ny nz no b">kubectl</code>现在将指向您的新集群。你可以证实这一点</p><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="fe7f" class="ns mr iq no b gy nt nu l nv nw">az aks get-credentials --resource-group $AZURE_RESOURCE_GROUP --name $AKS_CLUSTER_NAME<br/>kubectl get nodes</span></pre><blockquote class="lx ly lz"><p id="bca8" class="kf kg ma kh b ki kj jr kk kl km ju kn mb kp kq kr mc kt ku kv md kx ky kz la ij bi translated"><em class="iq">如果你有兴趣学习Kubernetes和Containers使用</em> <a class="ae lp" href="https://azure.microsoft.com/services/kubernetes-service/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> Azure </em> </a> <em class="iq">，只需</em> <a class="ae lp" href="https://azure.microsoft.com/en-us/free/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq">创建一个</em> <strong class="kh ir"> <em class="iq">免费</em> </strong> <em class="iq">账号</em> </a> <em class="iq">就可以开始了！一个好的起点是使用文档中的</em> <a class="ae lp" href="https://docs.microsoft.com/azure/aks/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq">快速入门、教程和代码示例</em> </a> <em class="iq">来熟悉该服务。我也强烈推荐查看一下</em> <a class="ae lp" href="https://azure.microsoft.com/resources/kubernetes-learning-path/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> 50天Kubernetes学习路径</em> </a> <em class="iq">。高级用户可能希望参考</em> <a class="ae lp" href="https://docs.microsoft.com/azure/aks/best-practices?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> Kubernetes最佳实践</em> </a> <em class="iq">或观看一些</em> <a class="ae lp" href="https://azure.microsoft.com/resources/videos/index/?services=kubernetes-service&amp;WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq">视频</em> </a> <em class="iq">以了解演示、主要功能和技术会议。</em></p></blockquote><h1 id="83c0" class="mq mr iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">设置Azure容器注册表</h1><p id="b359" class="pw-post-body-paragraph kf kg iq kh b ki ni jr kk kl nj ju kn ko nk kq kr ks nl ku kv kw nm ky kz la ij bi translated">简单地说，<a class="ae lp" href="https://azure.microsoft.com/services/container-registry/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure Container Registry </a>(简称<code class="fe nx ny nz no b">ACR</code>)是云中的一个托管私有Docker注册表，它允许您为所有类型的容器部署构建、存储和管理映像。</p><p id="ca74" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先创建一个ACR实例</p><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="dec4" class="ns mr iq no b gy nt nu l nv nw">export ACR_NAME=[to be filled]<br/>az acr create --resource-group $AZURE_RESOURCE_GROUP --name $ACR_NAME --sku Basic</span></pre><blockquote class="lx ly lz"><p id="3ced" class="kf kg ma kh b ki kj jr kk kl km ju kn mb kp kq kr mc kt ku kv md kx ky kz la ij bi translated"><em class="iq">有效的SKU值——</em><code class="fe nx ny nz no b"><em class="iq">Basic</em></code><em class="iq"/><code class="fe nx ny nz no b"><em class="iq">Classic</em></code><em class="iq"/><code class="fe nx ny nz no b"><em class="iq">Premium</em></code><em class="iq"/><code class="fe nx ny nz no b"><em class="iq">Standard</em></code><em class="iq">。参见</em> <a class="ae lp" href="https://docs.microsoft.com/cli/azure/acr?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-acr-create" rel="noopener ugc nofollow" target="_blank"> <em class="iq">命令文档</em> </a></p></blockquote><h1 id="d427" class="mq mr iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">配置ACR以使用AKS</h1><p id="c75e" class="pw-post-body-paragraph kf kg iq kh b ki ni jr kk kl nj ju kn ko nk kq kr ks nl ku kv kw nm ky kz la ij bi translated">要访问存储在ACR中的图像，您必须授予AKS服务主体从ACR提取图像的正确权限。</p><p id="764c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">获取与您的AKS集群相关联的服务主体的<code class="fe nx ny nz no b">appId</code></p><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="df83" class="ns mr iq no b gy nt nu l nv nw">AKS_SERVICE_PRINCIPAL_APPID=$(az aks show --name $AKS_CLUSTER_NAME --resource-group $AZURE_RESOURCE_GROUP --query servicePrincipalProfile.clientId -o tsv)</span></pre><p id="acfc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">查找ACR资源ID</p><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="9aef" class="ns mr iq no b gy nt nu l nv nw">ACR_RESOURCE_ID=$(az acr show --resource-group $AZURE_RESOURCE_GROUP --name $ACR_NAME --query "id" --output tsv)</span></pre><p id="c70b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">授予AKS服务主体<code class="fe nx ny nz no b">acrpull</code>权限</p><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="54db" class="ns mr iq no b gy nt nu l nv nw">az role assignment create --assignee $AKS_SERVICE_PRINCIPAL_APPID --scope $ACR_RESOURCE_ID --role acrpull</span></pre><p id="e089" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">关于这个话题的更多细节，请看我之前的一篇博客</p><p id="6cd8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好了，我们的AKS集群和ACR已经可以使用了！让我们换个话题，看看Kafka Streams代码——它很简洁，为了本教程的目的，它一直保持简单。</p><h1 id="a538" class="mq mr iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">流处理代码</h1><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/f2aa1ef2d50a748bc641e452daa9b81a.png" data-original-src="https://miro.medium.com/v2/resize:fit:840/0*RYANRBdkIpt6Lq3O.gif"/></div></figure><p id="e11b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">处理管道做的事情非常简单。它利用了<a class="ae lp" href="https://kafka.apache.org/23/documentation/streams/developer-guide/dsl-api.html" rel="noopener ugc nofollow" target="_blank">高级流DSL </a> API:</p><ul class=""><li id="59fe" class="lb lc iq kh b ki kj kl km ko ld ks le kw lf la lg lh li lj bi translated">从输入/源Kafka主题接收单词</li><li id="78e4" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated">将其转换为大写</li><li id="dfe1" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated">将记录存储在输出Kafka主题(接收器)中</li></ul><p id="645b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请不要忘记，在写这篇文章的时候，最新的Kafka Streams库版本是<code class="fe nx ny nz no b">2.3.0</code>，这就是这个应用程序所使用的</p><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="f838" class="ns mr iq no b gy nt nu l nv nw">    &lt;dependency&gt;<br/>        &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;<br/>        &lt;artifactId&gt;kafka-streams&lt;/artifactId&gt;<br/>        &lt;version&gt;2.3.0&lt;/version&gt;<br/>    &lt;/dependency&gt;</span></pre><p id="5d2b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们从<code class="fe nx ny nz no b">StreamsBuilder</code>的一个实例开始，调用它的<code class="fe nx ny nz no b">stream</code>方法来挂钩源主题(名称:<code class="fe nx ny nz no b">lower-case</code>)。我们得到的是一个<code class="fe nx ny nz no b"><a class="ae lp" href="https://kafka.apache.org/23/javadoc/org/apache/kafka/streams/kstream/KStream.html" rel="noopener ugc nofollow" target="_blank">KStream</a></code> <a class="ae lp" href="https://kafka.apache.org/23/javadoc/org/apache/kafka/streams/kstream/KStream.html" rel="noopener ugc nofollow" target="_blank">对象</a>，它表示发送到主题<code class="fe nx ny nz no b">lower-case</code>的连续记录流。请注意，输入记录只是键值对。</p><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="9e19" class="ns mr iq no b gy nt nu l nv nw">StreamsBuilder builder = new StreamsBuilder();<br/>    KStream&lt;String, String&gt; lowerCaseStrings = builder.stream(INPUT_TOPIC);</span></pre><p id="3497" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好了，我们有了对象形式的记录——我们该怎么处理它们呢？我们如何处理它们？在这种情况下，我们所做的就是应用一个简单的<code class="fe nx ny nz no b">transformation</code>，使用<code class="fe nx ny nz no b">mapValues</code>将记录(值，而不是键)转换成大写字母。这给了我们另一个<code class="fe nx ny nz no b">KStream</code>实例- <code class="fe nx ny nz no b">upperCaseStrings</code>，我们通过调用<code class="fe nx ny nz no b">to</code>方法将它的记录推送到一个名为<code class="fe nx ny nz no b">upper-case</code>的接收器主题。</p><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="f3a1" class="ns mr iq no b gy nt nu l nv nw">KStream&lt;String, String&gt; upperCaseStrings = lowerCaseStrings.mapValues(new ValueMapper&lt;String, String&gt;() {<br/>        @Override<br/>        public String apply(String str) {<br/>            return str.toUpperCase();<br/>        }<br/>    });<br/>    upperCaseStrings.to(OUTPUT_TOPIC);</span></pre><p id="0f83" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这就是建立流程和定义逻辑的全部内容。我们使用<code class="fe nx ny nz no b">StreamsBuilder</code>中的<code class="fe nx ny nz no b">build</code>方法创建一个<code class="fe nx ny nz no b">Topology</code>对象，并使用这个对象创建一个<code class="fe nx ny nz no b"><a class="ae lp" href="https://kafka.apache.org/23/javadoc/org/apache/kafka/streams/KafkaStreams.html" rel="noopener ugc nofollow" target="_blank">KafkaStreams</a></code>实例，它是我们的应用程序本身的表示。我们使用<code class="fe nx ny nz no b">start</code>方法开始流处理</p><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="88b3" class="ns mr iq no b gy nt nu l nv nw">Topology topology = builder.build();<br/>    KafkaStreams streamsApp = new KafkaStreams(topology, getKafkaStreamsConfig());<br/>    streamsApp.start();</span></pre><p id="d4e2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe nx ny nz no b">getKafkaStreamsConfig()</code>只是一个帮助器方法，它创建一个<code class="fe nx ny nz no b"><a class="ae lp" href="https://docs.oracle.com/javase/8/docs/api/java/util/Properties.html?is-external=true" rel="noopener ugc nofollow" target="_blank">Properties</a></code>对象，该对象包含Kafka Streams的特定配置，包括Kafka broker端点等。</p><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="fa17" class="ns mr iq no b gy nt nu l nv nw">static Properties getKafkaStreamsConfig() {<br/>    String kafkaBroker = System.getenv().get(KAFKA_BROKER_ENV_VAR);<br/>    Properties configurations = new Properties();<br/>    configurations.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, kafkaBroker + ":9092");<br/>    configurations.put(StreamsConfig.APPLICATION_ID_CONFIG, APP_ID);<br/>    configurations.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass().getName());<br/>    configurations.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass().getName());<br/>    configurations.put(StreamsConfig.REQUEST_TIMEOUT_MS_CONFIG, "20000");<br/>    configurations.put(StreamsConfig.RETRY_BACKOFF_MS_CONFIG, "500");</span><span id="2a8a" class="ns mr iq no b gy oa nu l nv nw">    return configurations;<br/>}</span></pre><p id="b773" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">代码到此为止。是时候部署了！</p><h1 id="ba0a" class="mq mr iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">从您的笔记本电脑到云中的Docker注册表</h1><p id="61d3" class="pw-post-body-paragraph kf kg iq kh b ki ni jr kk kl nj ju kn ko nk kq kr ks nl ku kv kw nm ky kz la ij bi translated">克隆GitHub repo，切换到正确的目录并构建应用程序JAR</p><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="5a1f" class="ns mr iq no b gy nt nu l nv nw">git clone https://github.com/abhirockzz/kafka-streams-kubernetes<br/>cd kafka-streams-kubernetes<br/>mvn clean isntall</span></pre><blockquote class="lx ly lz"><p id="9cd2" class="kf kg ma kh b ki kj jr kk kl km ju kn mb kp kq kr mc kt ku kv md kx ky kz la ij bi translated"><em class="iq">你应该看到</em> <code class="fe nx ny nz no b"><em class="iq">target</em></code> <em class="iq">目录下的</em> <code class="fe nx ny nz no b"><em class="iq">kstreams-lower-to-upper-1.0.jar</em></code> <em class="iq"/></p></blockquote><p id="4f87" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是我们的流处理应用程序的<code class="fe nx ny nz no b">Dockerfile</code></p><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="66c6" class="ns mr iq no b gy nt nu l nv nw">FROM openjdk:8-jre<br/>WORKDIR /<br/>COPY target/kstreams-lower-to-upper-1.0.jar /<br/>CMD ["java", "-jar","kstreams-lower-to-upper-1.0.jar"]</span></pre><p id="6d5d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们现在将构建一个Docker映像…</p><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="f825" class="ns mr iq no b gy nt nu l nv nw">export DOCKER_IMAGE=kstreams-lower-to-upper:v1<br/>export ACR_SERVER=$ACR_NAME.azurecr.io<br/>docker build -t $DOCKER_IMAGE .</span></pre><p id="7b7b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">…并将其推送到<a class="ae lp" href="https://azure.microsoft.com/services/container-registry/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure容器注册表</a></p><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="f983" class="ns mr iq no b gy nt nu l nv nw">az acr login --name $ACR_NAME<br/>docker tag $DOCKER_IMAGE $ACR_SERVER/$DOCKER_IMAGE<br/>docker push $ACR_SERVER/$DOCKER_IMAGE</span></pre><p id="b597" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">完成后，您可以使用<code class="fe nx ny nz no b">az acr repository list</code>进行确认</p><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="bbee" class="ns mr iq no b gy nt nu l nv nw">az acr repository list --name $ACR_NAME --output table</span></pre><h1 id="3a4b" class="mq mr iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">部署到Kubernetes</h1><p id="47b8" class="pw-post-body-paragraph kf kg iq kh b ki ni jr kk kl nj ju kn ko nk kq kr ks nl ku kv kw nm ky kz la ij bi translated">我们的应用程序是一个无状态处理器，我们将把它部署为一个具有两个实例(副本)的Kubernetes <code class="fe nx ny nz no b">Deployment</code>。</p><p id="3313" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您对管理无状态应用程序的原生Kubernetes原语感兴趣，请查看这个博客</p><p id="aded" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">文件<code class="fe nx ny nz no b">kstreams-deployment.yaml</code>包含规范<code class="fe nx ny nz no b">Deployment</code>，它将代表我们的流处理应用程序。您需要修改它，根据您的环境添加以下信息</p><ul class=""><li id="d726" class="lb lc iq kh b ki kj kl km ko ld ks le kw lf la lg lh li lj bi translated">Azure容器注册名(您之前使用<code class="fe nx ny nz no b">ACR_NAME</code>指定的)</li><li id="0457" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated">您的Kafka经纪人的端点，例如<code class="fe nx ny nz no b">my-kafka:9092</code></li></ul><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="ad4c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">部署和确认</p><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="e8dc" class="ns mr iq no b gy nt nu l nv nw">kubectl apply -f kstreams-deployment.yaml<br/>kubectl get pods -l=app=kstream-lower-to-upper</span></pre><p id="05c6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您应该会看到两个pod处于<code class="fe nx ny nz no b">Running</code>状态</p><h1 id="f99d" class="mq mr iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">关键时刻到了。</h1><p id="a4a0" class="pw-post-body-paragraph kf kg iq kh b ki ni jr kk kl nj ju kn ko nk kq kr ks nl ku kv kw nm ky kz la ij bi translated">是时候测试我们的端到端流程了。总结一下:</p><ul class=""><li id="f920" class="lb lc iq kh b ki kj kl km ko ld ks le kw lf la lg lh li lj bi translated">您将在本地使用Kafka CLI向输入Kafka主题(<code class="fe nx ny nz no b">lower-case</code>)生成数据</li><li id="363f" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated">AKS中的流处理应用程序将搅动数据，并将其放回另一个Kafka主题</li><li id="910a" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated">您的本地基于Kafka CLI的消费者进程将从输出主题(<code class="fe nx ny nz no b">upper-case</code>)中获取该数据</li></ul><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/b08767a9ef36c733e8b305daba9b6fdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/0*2R1YLU5N_ir6Cd2u.gif"/></div></figure><p id="339f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们先创造卡夫卡的主题</p><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="05c2" class="ns mr iq no b gy nt nu l nv nw">export KAFKA_HOME=[kafka installation directory]<br/>export INPUT_TOPIC=lower-case<br/>export OUTPUT_TOPIC=upper-case</span><span id="ed55" class="ns mr iq no b gy oa nu l nv nw">$KAFKA_HOME/bin/kafka-topics.sh --create --topic $INPUT_TOPIC --partitions 2 --replication-factor 1 --bootstrap-server $KAFKA_BROKER<br/>$KAFKA_HOME/bin/kafka-topics.sh --create --topic $OUTPUT_TOPIC --partitions 2 --replication-factor 1 --bootstrap-server $KAFKA_BROKER</span><span id="0b4a" class="ns mr iq no b gy oa nu l nv nw">$KAFKA_HOME/bin/kafka-topics.sh --list --bootstrap-server $KAFKA_BROKER</span></pre><h1 id="d207" class="mq mr iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">启动消费者流程</h1><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="4ad4" class="ns mr iq no b gy nt nu l nv nw">export KAFKA_HOME=[kafka installation directory]<br/>export KAFKA_BROKER=[kafka broker e.g. localhost:9092]<br/>export OUTPUT_TOPIC=upper-case</span><span id="2d59" class="ns mr iq no b gy oa nu l nv nw">$KAFKA_HOME/bin/kafka-console-consumer.sh --bootstrap-server <br/>$KAFKA_BROKER --topic $OUTPUT_TOPIC --from-beginning</span></pre><h1 id="ec08" class="mq mr iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">启动生产者进程(不同的终端)</h1><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="7e47" class="ns mr iq no b gy nt nu l nv nw">export KAFKA_HOME=[kafka installation directory]<br/>export KAFKA_BROKER=[kafka broker e.g. localhost:9092]<br/>export INPUT_TOPIC=lower-case</span><span id="753c" class="ns mr iq no b gy oa nu l nv nw">$KAFKA_HOME/bin/kafka-console-producer.sh --broker-list $KAFKA_BROKER --topic $INPUT_TOPIC</span></pre><p id="e685" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您将看到一个提示，然后您可以开始输入值，例如</p><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="9638" class="ns mr iq no b gy nt nu l nv nw">&gt; foo<br/>&gt; bar<br/>&gt; baz<br/>&gt; john<br/>&gt; doe</span></pre><p id="0ead" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">等待几秒钟，检查终端窗口。你应该看到以上记录的大写形式，即<code class="fe nx ny nz no b">FOO</code>、<code class="fe nx ny nz no b">BAR</code>等。</p><h1 id="5f49" class="mq mr iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">打扫</h1><p id="bd84" class="pw-post-body-paragraph kf kg iq kh b ki ni jr kk kl nj ju kn ko nk kq kr ks nl ku kv kw nm ky kz la ij bi translated">清理AKS集群、ACR实例和相关资源</p><pre class="mf mg mh mi gt nn no np nq aw nr bi"><span id="b626" class="ns mr iq no b gy nt nu l nv nw">az group delete --name $AZURE_RESOURCE_GROUP --yes --no-wait</span></pre><p id="eee9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">(如承诺的那样)</p><h1 id="1cf7" class="mq mr iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">方便的命令列表..</h1><p id="1d0e" class="pw-post-body-paragraph kf kg iq kh b ki ni jr kk kl nj ju kn ko nk kq kr ks nl ku kv kw nm ky kz la ij bi translated">..供您参考</p><h2 id="0390" class="ns mr iq bd ms of og dn mw oh oi dp na ko oj ok nc ks ol om ne kw on oo ng op bi translated">蓝色库伯内特服务</h2><ul class=""><li id="f93f" class="lb lc iq kh b ki ni kl nj ko oq ks or kw os la lg lh li lj bi translated"><code class="fe nx ny nz no b"><a class="ae lp" href="https://docs.microsoft.com/cli/azure/aks?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-aks-create" rel="noopener ugc nofollow" target="_blank">az aks create</a></code> -创建新的托管Kubernetes集群</li><li id="dbbc" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated"><code class="fe nx ny nz no b"><a class="ae lp" href="https://docs.microsoft.com/cli/azure/aks?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-aks-get-credentials" rel="noopener ugc nofollow" target="_blank">az aks get-credentials</a></code> -获取受管Kubernetes集群的访问凭证</li><li id="74be" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated"><code class="fe nx ny nz no b"><a class="ae lp" href="https://docs.microsoft.com/cli/azure/aks?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-aks-show" rel="noopener ugc nofollow" target="_blank">az aks show</a></code> -显示被管理的Kubernetes集群的详细信息</li></ul><h2 id="95cd" class="ns mr iq bd ms of og dn mw oh oi dp na ko oj ok nc ks ol om ne kw on oo ng op bi translated">Azure容器注册表</h2><ul class=""><li id="875e" class="lb lc iq kh b ki ni kl nj ko oq ks or kw os la lg lh li lj bi translated"><code class="fe nx ny nz no b"><a class="ae lp" href="https://docs.microsoft.com/cli/azure/acr?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-acr-create" rel="noopener ugc nofollow" target="_blank">az acr create</a></code> -创建Azure容器注册中心</li><li id="e885" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated"><code class="fe nx ny nz no b"><a class="ae lp" href="https://docs.microsoft.com/cli/azure/acr?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-acr-show" rel="noopener ugc nofollow" target="_blank">az acr show</a></code> -获取Azure容器注册表的详细信息</li><li id="769b" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated"><code class="fe nx ny nz no b"><a class="ae lp" href="https://docs.microsoft.com/cli/azure/acr?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-acr-login" rel="noopener ugc nofollow" target="_blank">az acr login</a></code> -通过Docker CLI登录Azure容器注册中心</li><li id="7f41" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated"><code class="fe nx ny nz no b"><a class="ae lp" href="https://docs.microsoft.com/cli/azure/acr/repository?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-acr-repository-list" rel="noopener ugc nofollow" target="_blank">az acr repository list</a></code> -在Azure容器注册表中列出存储库。</li></ul><h2 id="810a" class="ns mr iq bd ms of og dn mw oh oi dp na ko oj ok nc ks ol om ne kw on oo ng op bi translated">通用命令</h2><ul class=""><li id="de94" class="lb lc iq kh b ki ni kl nj ko oq ks or kw os la lg lh li lj bi translated"><code class="fe nx ny nz no b"><a class="ae lp" href="https://docs.microsoft.com/cli/azure/account?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-account-set" rel="noopener ugc nofollow" target="_blank">az account set</a></code> -将订阅设置为当前活动的订阅</li><li id="e6e7" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated"><code class="fe nx ny nz no b"><a class="ae lp" href="https://docs.microsoft.com/cli/azure/group?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-group-create" rel="noopener ugc nofollow" target="_blank">az group create</a></code> -创建新的资源组</li><li id="62b8" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated"><code class="fe nx ny nz no b"><a class="ae lp" href="https://docs.microsoft.com/cli/azure/role/assignment?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-role-assignment-create" rel="noopener ugc nofollow" target="_blank">az role assignment create</a></code> -为用户、组或服务主体创建新的角色分配</li></ul><p id="d91a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你觉得这篇文章有帮助，请喜欢并关注！很高兴通过<a class="ae lp" href="https://twitter.com/abhi_tweeter" rel="noopener ugc nofollow" target="_blank"> @abhi_tweeter </a>获得反馈，或者发表评论:-)</p><div class="ot ou gp gr ov ow"><a href="https://twitter.com/abhi_tweeter" rel="noopener  ugc nofollow" target="_blank"><div class="ox ab fo"><div class="oy ab oz cl cj pa"><h2 class="bd ir gy z fp pb fr fs pc fu fw ip bi translated">阿布舍克</h2><div class="pd l"><h3 class="bd b gy z fp pb fr fs pc fu fw dk translated">Abhishek的最新推文(@abhi_tweeter)。云开发者🥑@Microsoft @azureadvocates |…</h3></div><div class="pe l"><p class="bd b dl z fp pb fr fs pc fu fw dk translated">twitter.com</p></div></div><div class="pf l"><div class="pg l ph pi pj pf pk mo ow"/></div></div></a></div></div></div>    
</body>
</html>