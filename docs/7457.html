<html>
<head>
<title>Investigate actions on AKS using Auditing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用审计调查AK上的操作</h1>
<blockquote>原文：<a href="https://itnext.io/whodunit-investigate-actions-on-aks-using-auditing-1db3ccf9ae86?source=collection_archive---------1-----------------------#2022-09-29">https://itnext.io/whodunit-investigate-actions-on-aks-using-auditing-1db3ccf9ae86?source=collection_archive---------1-----------------------#2022-09-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5fc3" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">这个博客的背景故事</h2></div><p id="09ad" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那天，Oncaller醒来时听到一个寻呼机警告“应用程序网关的后端主机不健康”。我们的客户将应用网关作为<a class="ae lb" href="https://learn.microsoft.com/en-us/azure/aks/intro-kubernetes" rel="noopener ugc nofollow" target="_blank"> AKS集群</a>的入口控制器，因此AKS集群在这种情况下是后端。该警报实际上意味着AKS应用程序盒关闭、重启或缩减。因此，他查看了状态，并为12次部署中的每一次部署重新安排了时间。以下是团队slack频道上的留言。</p><pre class="lc ld le lf gt lg lh li lj aw lk bi"><span id="1555" class="ll lm iq lh b gy ln lo l lp lq">I see new pods were created but not sure who requested it since in events as well it just mentions creating replica set destroying and creating pod.</span></pre><p id="cbdd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以很明显，这不是一个问题，而是一个没有通知的部署。</p><p id="1bb7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">应用程序恢复正常，但出现了一些问题:</p><ul class=""><li id="1c7f" class="lr ls iq kh b ki kj kl km ko lt ks lu kw lv la lw lx ly lz bi translated">是谁做的，实际上是计划维修吗？</li><li id="593b" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la lw lx ly lz bi translated">是有人做错了还是故意的？</li><li id="5a20" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la lw lx ly lz bi translated">什么时候开始和结束的？</li><li id="3125" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la lw lx ly lz bi translated">行刑的地点是哪里？</li><li id="f013" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la lw lx ly lz bi translated">使用了什么工具来完成它？</li></ul><p id="3d67" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些问题你都是怎么回答的？您首先想到的是查看<strong class="kh ir">审计日志</strong>。</p><p id="71b7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尽管对于来自合法CD管道的请求，这很容易，因为您可以查看管道执行历史和由CD管道使用的SPN的Azure AD登录日志。由此，你可以知道是谁在何时执行的，这就是这里的情况。</p><p id="8af1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">管道执行的细节与客户端共享，并且<strong class="kh ir">发现这是一个有计划的部署，但是oncaller没有得到通知。所以它</strong></p><p id="c143" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这促使我思考，如果它不是来自一个CD管道，而有人使用<em class="mf"> kubectl </em>或<em class="mf"> helm </em>或直接API调用等手动执行它，会怎么样？？在这种情况下，审计日志非常有用。</p><h2 id="9bbc" class="ll lm iq bd mg mh mi dn mj mk ml dp mm ko mn mo mp ks mq mr ms kw mt mu mv mw bi translated"><a class="ae lb" href="https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/" rel="noopener ugc nofollow" target="_blank">Kubernetes中的审计</a></h2><p id="0beb" class="pw-post-body-paragraph kf kg iq kh b ki mx jr kk kl my ju kn ko mz kq kr ks na ku kv kw nb ky kz la ij bi translated">作为任何生产级软件的标准特性，您可以在Kubernetes中启用审计。由于审计记录在<a class="ae lb" href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/" rel="noopener ugc nofollow" target="_blank"> kube-apiserver </a>组件中开始其生命周期，您应该能够管理<a class="ae lb" href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/" rel="noopener ugc nofollow" target="_blank"> kube-apiserver </a>(在<a class="ae lb" href="https://azure.microsoft.com/en-us/products/kubernetes-service/" rel="noopener ugc nofollow" target="_blank"> AKS </a>、<a class="ae lb" href="https://aws.amazon.com/eks/" rel="noopener ugc nofollow" target="_blank"> EKS </a>和<a class="ae lb" href="https://cloud.google.com/kubernetes-engine" rel="noopener ugc nofollow" target="_blank"> GKE </a>中不可能)。这里有一个<a class="ae lb" href="https://www.youtube.com/watch?v=RVcj1nJwhY4&amp;t=1046s" rel="noopener ugc nofollow" target="_blank">不错的视频</a>解释了如何在Kubernetes集群(本地)中启用审计。</p><h2 id="1f27" class="ll lm iq bd mg mh mi dn mj mk ml dp mm ko mn mo mp ks mq mr ms kw mt mu mv mw bi translated">Azure Kubernetes服务中的审计</h2><p id="2df3" class="pw-post-body-paragraph kf kg iq kh b ki mx jr kk kl my ju kn ko mz kq kr ks na ku kv kw nb ky kz la ij bi translated"><a class="ae lb" href="https://learn.microsoft.com/en-us/azure/azure-monitor/containers/container-insights-log-query#resource-logs" rel="noopener ugc nofollow" target="_blank">使用AKS中的审计日志记录</a>来按时间顺序记录对Kubernetes API服务器的调用，调查可疑的API请求，收集统计数据，或者为不需要的API调用创建监控警报。AKS控制平面组件的日志在Azure中被实现为<a class="ae lb" href="https://learn.microsoft.com/en-us/azure/azure-monitor/essentials/resource-logs" rel="noopener ugc nofollow" target="_blank">资源日志</a>。您可以通过启用<a class="ae lb" href="https://learn.microsoft.com/en-us/azure/aks/monitor-aks#collect-resource-logs" rel="noopener ugc nofollow" target="_blank">收集资源日志</a>的“诊断设置”中的审计选项来启用AKS审计。您可以将日志发送到<a class="ae lb" href="https://learn.microsoft.com/en-us/azure/azure-monitor/logs/quick-create-workspace?tabs=azure-portal" rel="noopener ugc nofollow" target="_blank">日志分析工作区</a>，将它们归档到存储帐户，将它们流式传输到事件中心，或者将它们发送到合作伙伴解决方案。对于分析、查询或根据查询创建警报，最佳解决方案是使用<a class="ae lb" href="https://learn.microsoft.com/en-us/azure/azure-monitor/logs/quick-create-workspace?tabs=azure-portal" rel="noopener ugc nofollow" target="_blank">日志分析工作区</a>。</p><p id="e319" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你不需要装载容器的Azure Monitor来访问资源日志。是的，这有点令人困惑，因为门户上AKS集群左侧刀片的“监控”部分下的“日志”实际上指向Azure Monitor for containers。</p><h2 id="b24a" class="ll lm iq bd mg mh mi dn mj mk ml dp mm ko mn mo mp ks mq mr ms kw mt mu mv mw bi translated"><strong class="ak">启用资源日志收集</strong></h2><p id="3e33" class="pw-post-body-paragraph kf kg iq kh b ki mx jr kk kl my ju kn ko mz kq kr ks na ku kv kw nb ky kz la ij bi translated">导航到AKS实例，然后在门户上AKS群集左侧的刀片“监控”部分下导航到“诊断设置”。点击“添加诊断设置”,为<a class="ae lb" href="https://learn.microsoft.com/en-us/azure/aks/monitor-aks-reference" rel="noopener ugc nofollow" target="_blank">选择适当的类别</a>,并选择“发送至日志分析工作区”</p><figure class="lc ld le lf gt nd gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nc"><img src="../Images/a098471a5d3d5d39fa0e53b59a0d79f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1p0cdEuc_5Zd3RW1aTGoaA.png"/></div></div></figure><p id="ff58" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">保存并等待5分钟，然后日志开始传输到日志分析工作区。所选日志将被添加到“AzureDiagnostics”表中。</p><h2 id="f237" class="ll lm iq bd mg mh mi dn mj mk ml dp mm ko mn mo mp ks mq mr ms kw mt mu mv mw bi translated"><strong class="ak">查询审计日志</strong></h2><p id="50a1" class="pw-post-body-paragraph kf kg iq kh b ki mx jr kk kl my ju kn ko mz kq kr ks na ku kv kw nb ky kz la ij bi translated">在诸如“背景故事”中的情况下，您可以使用<a class="ae lb" href="https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/tutorial?source=recommendations&amp;pivots=azuredataexplorer" rel="noopener ugc nofollow" target="_blank"> KQL </a>来查询并找出是谁做的。</p><p id="5d7a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">导航到AKS实例，然后在门户上AKS群集左侧的刀片“监控”部分下导航到“诊断设置”。单击日志分析工作区链接。</p><figure class="lc ld le lf gt nd gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nk"><img src="../Images/1e6a98a166d3690ce8724415c6706a29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2aWMi5l_5wZXDcoHQTrhTg.png"/></div></div></figure><p id="589f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">单击门户上日志分析工作区实例左侧刀片“常规”部分下的“日志”。</p><p id="8c94" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">选择时间范围后，运行以下查询</p><figure class="lc ld le lf gt nd"><div class="bz fp l di"><div class="nl nm l"/></div></figure><ul class=""><li id="bd1d" class="lr ls iq kh b ki kj kl km ko lt ks lu kw lv la lw lx ly lz bi translated">您只选择了类别“kube-audit-admin ”,该类别从日志中排除了获取和列出审计事件。</li><li id="00d2" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la lw lx ly lz bi translated">您已经排除了userAgent为“kubelet”的记录。</li><li id="4538" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la lw lx ly lz bi translated">您已经排除了用户和组未被客户端实用程序使用的记录，如<em class="mf"> helm </em>和<em class="mf"> kubectl </em>。</li><li id="9473" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la lw lx ly lz bi translated">同样，您可以根据自己的需求编写查询。</li></ul><p id="590c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">特定时间范围内上述查询的示例结果。</p><figure class="lc ld le lf gt nd gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nn"><img src="../Images/b8072a35859ce380f39d3a7ee2b690d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*el2fhbnQBwWdMGi3Hzj33Q.png"/></div></div></figure><p id="a34f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">以上结果表明，有人用公共IP 72.140.51.82执行了“<em class="mf">头盔升级</em>”或“<em class="mf">头盔安装</em>”。它还显示了创建或更新了哪些资源，以及使用了哪些Kubernetes RBAC用户登录API服务器。您可以使用类似的KQL查询组合进行更多分析。您可以根据在“启用资源日志收集”中选择的类别过滤类别并查看它们。</p><p id="8170" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果它显示的是10.241.0.55这样的私有IP(而使用的私有地址空间是10.90.0.0/16，包括VPN地址空间)，跟踪真实用户就变得更加困难。<strong class="kh ir">我观察到，对于每个AKS实例，源IP来自私有地址空间10.241.0.0/24，并且IP对于每个实例都是唯一的</strong>。看起来这些IP要么是我们完全看不见的kube-apiserver主节点的某种网关，要么是原始源IP指向这些IP。这对跟踪活动没有帮助。如果这些IP是原始源IP，将会很有帮助。这里<strong class="kh ir">你既没有客户端的IP也没有用户名，因为你使用的是本地的Kubernetes账户。这使得审计变得毫无价值。</strong></p><p id="017a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">为了正确审计，必须禁用Kubernetes本地帐户，并且必须使用</strong> <a class="ae lb" href="https://learn.microsoft.com/en-us/azure/aks/managed-aad" rel="noopener ugc nofollow" target="_blank"> <strong class="kh ir"> AKS管理的Azure Active Directory集成</strong> </a> <strong class="kh ir">。</strong></p><p id="4f8b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面的例子显示了当AKS集成了AAD时，如何跟踪用户所做的操作。</p><figure class="lc ld le lf gt nd gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi no"><img src="../Images/dde28840f19bbfedc788929aaaa7b567.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ty9r6Tmx35DZxng6hjuISQ.png"/></div></div></figure><p id="040b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以将上述查询中的用户名映射到Azure AD中的用户</p><figure class="lc ld le lf gt nd gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi np"><img src="../Images/544ca36ff1a61255cc61b89695d2ca14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lUXrUK1gn0EbKWcidYkUdg.png"/></div></div></figure><h2 id="486e" class="ll lm iq bd mg mh mi dn mj mk ml dp mm ko mn mo mp ks mq mr ms kw mt mu mv mw bi translated">一些关键点</h2><ul class=""><li id="c3d5" class="lr ls iq kh b ki mx kl my ko nq ks nr kw ns la lw lx ly lz bi translated">我观察到<strong class="kh ir">一些不一致的行为，AKS资源日志有几天没有与日志分析工作区</strong>同步。</li><li id="d9a3" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la lw lx ly lz bi translated">你<strong class="kh ir">不需要板载</strong><a class="ae lb" href="https://learn.microsoft.com/en-us/azure/azure-monitor/containers/container-insights-overview" rel="noopener ugc nofollow" target="_blank"><strong class="kh ir">Azure Monitor for containers</strong></a><strong class="kh ir"/>(如果你使用的是Datadog或者Dynatrace等。用于监控)<strong class="kh ir">访问日志分析工作区中的资源日志(审计日志)</strong>。</li><li id="f0c9" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la lw lx ly lz bi translated">将资源日志发送到工作区是有成本的，因此您应该只收集那些您打算使用的日志类别。</li><li id="e793" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la lw lx ly lz bi translated">如果您需要保留信息，但不要求信息随时可用于分析，请将日志发送到Azure存储帐户以降低成本。</li><li id="0083" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la lw lx ly lz bi translated">设置警报以确保资源日志始终流向日志分析工作区或存储帐户。</li><li id="d9cd" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la lw lx ly lz bi translated"><strong class="kh ir">避免使用“Kubernetes本地账户”。对于AK，尝试使用至少Azure广告认证与Kubernetes RBAC。</strong></li></ul></div><div class="ab cl nt nu hu nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="ij ik il im in"><p id="da3d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请阅读我的其他文章，并分享您的反馈。如果你喜欢分享的内容，请点赞、评论并订阅新文章。</p></div></div>    
</body>
</html>