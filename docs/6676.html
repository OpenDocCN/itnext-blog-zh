<html>
<head>
<title>Using Cloudflare Tunnels to Securely Expose Kubernetes Services</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Cloudflare隧道安全地公开Kubernetes服务</h1>
<blockquote>原文：<a href="https://itnext.io/using-cloudflare-tunnels-to-securely-expose-kubernetes-services-26713fb5da0a?source=collection_archive---------0-----------------------#2022-01-25">https://itnext.io/using-cloudflare-tunnels-to-securely-expose-kubernetes-services-26713fb5da0a?source=collection_archive---------0-----------------------#2022-01-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/852ee9644b47012ddd9f56cf2f3e6a19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*sNHJxDzh_7g8s-3QPP9RHg.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">图片来源:<a class="ae jy" href="https://www.cloudflare.com/products/tunnel/" rel="noopener ugc nofollow" target="_blank">https://www.cloudflare.com/products/tunnel/</a></figcaption></figure><p id="521e" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">Cloudflare Tunnel(以前称为Argo Tunnel)是一种工具，允许在您的web服务器和Cloudflare基础架构之间建立安全的私有连接。如果你不熟悉Cloudflare，我建议你去看看<a class="ae jy" href="https://www.cloudflare.com/" rel="noopener ugc nofollow" target="_blank">他们的网站</a>，因为他们提供了大量的服务，其中最重要的是他们的CDN网络和web服务保护(DDoS保护等)。).要完成本教程，您需要使用Cloudflare作为您的DNS服务器。这将允许他们控制如何为您的域路由流量。</p><p id="1f17" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">在本教程中，我将向您展示如何建立一个<a class="ae jy" href="https://www.cloudflare.com/products/tunnel/" rel="noopener ugc nofollow" target="_blank"> Cloudflare隧道</a>来通过互联网安全地公开Kubernetes服务。如果我刚才提到的任何单词对你来说没有意义，请继续阅读，我保证我会尽力解释它们。我只是假设你知道Kubernetes是什么。如果你对Kubernetes不熟悉，可以在谷歌上快速搜索一下，然后使用我的教程在几分钟内在一个虚拟机上建立你的集群，你应该能跟上。</p><p id="6a7d" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">现在最大的问题是:你为什么要这么做？或者谁会从中受益？起初，它可能看起来不是很清楚，但它支持大量的功能，其中最重要的是安全性。我个人使用Cloudflare隧道有三个目的:1)从没有静态IP和/或位于NAT后面的集群中公开服务(我的家庭实验室)；2)保护正在运行的web服务器免受直接攻击；3)利用<a class="ae jy" href="https://www.cloudflare.com/teams/access/" rel="noopener ugc nofollow" target="_blank"> Cloudflare Access零信任</a>服务为敏感服务增加额外的安全层。</p><p id="a046" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">本教程是我个人成长的一部分，旨在提高我用来托管项目和自托管服务的基础设施的安全性。我现在在自己的基础设施上运行着大约20项服务，随着时间的推移，我越来越意识到这些服务的安全性。我还想指出的是，如果你正在运行一个托管的Kubernetes服务(例如，来自AWS或GCP ),你可能会在托管的负载平衡器和类似<a class="ae jy" href="https://cloud.google.com/armor" rel="noopener ugc nofollow" target="_blank"> Cloud Armor </a>的服务之后运行你的服务，这些用例中的大部分并不适用于你，但是欢迎你继续阅读。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="b5f5" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">问题是</h1><p id="8ecb" class="pw-post-body-paragraph jz ka iq kb b kc mc ke kf kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw ij bi translated">让我们更详细地分析一下我们在这里试图解决的问题。</p><h2 id="8421" class="mh lf iq bd lg mi mj dn lk mk ml dp lo kk mm mn ls ko mo mp lw ks mq mr ma ms bi translated">1.在NAT后运行的集群</h2><p id="b748" class="pw-post-body-paragraph jz ka iq kb b kc mc ke kf kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw ij bi translated">在疫情期间，我设法保持理智的一个方法是创建我的个人家庭实验室，在那里我托管像家庭助理这样的服务，以支持我家里的智能设备。在使用Cloudflare隧道之前，要允许远程访问这些服务，您必须设置一个动态DNS(使用像<a class="ae jy" href="https://www.duckdns.org/" rel="noopener ugc nofollow" target="_blank"> Duck DNS </a>这样的服务)，将一个域指向您的家庭IP，并在您的家庭防火墙上暴露特定端口(如果您的提供商允许，通常使用调制解调器的端口转发功能)。</p><p id="a1b8" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">现在，这带来了一些问题。首先，你已经在互联网上公开了你的家庭IP，从安全的角度来看，我们希望以任何可能的方式保护我们的隐私。第二，你在允许流量进入你的家庭网络，这让我很不舒服。此外，这对于许多互联网服务提供商来说甚至是不可能的，因为他们根本不允许你配置端口转发。Cloudflare Tunnel通过打通到Cloudflare服务器的隧道连接来解决这一问题。当对您的服务的请求到达他们的服务器时，他们将通过该隧道路由该流量并安全地进入您的基础设施。</p><h2 id="4362" class="mh lf iq bd lg mi mj dn lk mk ml dp lo kk mm mn ls ko mo mp lw ks mq mr ma ms bi translated">2.保护正在运行的web服务器免受直接攻击</h2><figure class="mu mv mw mx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi mt"><img src="../Images/5d0fb5e31dd62699f0ac17329285ddfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N5xEEU4GNXBuq2Ie7_w1BA.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">图片来源:【https://www.cloudflare.com/products/tunnel/ T4】</figcaption></figure><p id="cff9" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">让我们假设您正从您的虚拟机托管example.com，该虚拟机具有从云供应商处购买的IP <code class="fe nc nd ne nf b">1.2.3.4</code>。你可能有一个DNS A记录指向你的域名<code class="fe nc nd ne nf b">1.2.3.4</code>。然而，您的虚拟机上可能还运行着SSH和更多的服务。在一个完美的世界中，您在任何时候都有一个正确配置的SSH代理和防火墙，并且您使用的任何服务都没有安全缺陷。但是我们并不是生活在一个完美的世界中，如果您错误地公开了任何服务或者使用了糟糕的SSH配置，攻击者就会知道您的虚拟机的IP地址。</p><p id="9047" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">这可以通过将所有流量转发到Cloudflare服务器来解决，这些服务器会将流量路由到在您的虚拟机上运行的Cloudflare隧道代理。您不需要公开虚拟机的IP地址。事实上，您甚至不必允许任何流量通过您的防火墙。</p><h2 id="7524" class="mh lf iq bd lg mi mj dn lk mk ml dp lo kk mm mn ls ko mo mp lw ks mq mr ma ms bi translated">3.使用Cloudflare访问</h2><figure class="mu mv mw mx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi ng"><img src="../Images/2a687a026f4773d2f890fbd02c73b6b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iYTDrrspey6qLDuUjwHfzw.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">图片来源:<a class="ae jy" href="https://www.cloudflare.com/products/tunnel/" rel="noopener ugc nofollow" target="_blank">https://www.cloudflare.com/products/tunnel/</a></figcaption></figure><p id="e5e1" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">正如我提到的，我自己托管了许多web应用程序，其中一些包含相当敏感的数据。我最初使用Nginx基本认证(在负载平衡器中)和密码(在应用程序中)来公开这些服务。但是正如我们所知，<a class="ae jy" href="https://www.oreilly.com/library/view/http-the-definitive/1565925092/ch12s03.html" rel="noopener ugc nofollow" target="_blank">基本认证是不安全的</a>,我想用一个更好的替代方案来取代它，使用GitHub或Google这样的身份提供商来使用服务。这是我偶然发现<a class="ae jy" href="https://www.cloudflare.com/teams/access/" rel="noopener ugc nofollow" target="_blank"> Cloudflare Access </a>的时候，他们托管的零信任安全服务允许你添加几个规则来限制对你的基础设施中运行的服务的访问。您最初可以通过Cloudflare代理您的流量:</p><figure class="mu mv mw mx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi nh"><img src="../Images/aa367e0b343066321f6eca5ad4e84a01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wPyo0CplC5r6UGPVh742CQ.png"/></div></div></figure><p id="f56b" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">这将完美地工作，secret.nima-dev.com<a class="ae jy" href="http://www.nima-dev.com" rel="noopener ugc nofollow" target="_blank">的流量将被路由到Cloudflare，他们将应用安全规则并要求对受保护的端点进行身份验证。但是，要做到这一点，您需要在防火墙中允许HTTP/HTTPS流量，任何人都可以向您的服务器发送直接请求，并完全绕过Cloudflare身份验证。使用Cloudflare隧道时，您不需要为受保护的服务制定任何进入规则。流量安全地通过隧道传输到集群中运行的代理，然后路由到您的服务。这也使我能够安全地将不安全的应用程序(如Homer dashboard)暴露在互联网上，只需在我的Cloudflare Teams dashboard中点击几下鼠标。</a></p><p id="fa63" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">现在我们知道了为什么我们可能想要使用Cloudflare隧道，让我们看看如何为您自己的集群设置它。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="628d" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">安装过程</h1><p id="6832" class="pw-post-body-paragraph jz ka iq kb b kc mc ke kf kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw ij bi translated">在<a class="ae jy" href="https://bit.ly/3rLoBM2" rel="noopener ugc nofollow" target="_blank">之前的一篇文章</a>中，我回顾了在虚拟机上创建K3S集群的过程，您可以从任何云供应商那里购买(或者自己托管)。这里，我假设您有一个功能性的Kubernetes集群，并且对它的术语(部署、服务、入口等)有一个基本的了解。).现在我们已经准备好了，让我们创建一个隧道来安全地公开在<code class="fe nc nd ne nf b">default</code>名称空间中名为<code class="fe nc nd ne nf b">web</code>的服务。因此，在内部(从集群内部)，我们可以将该服务称为<code class="fe nc nd ne nf b">web.default.svc.cluster.local</code>(一般模式是<code class="fe nc nd ne nf b">my-service.my-namespace.svc.cluster.local</code>)。如果你不知道Kubernetes的DNS服务，请查看本页。我们现在将部署一个隧道来将流量路由到此服务。这个过程可以分两步完成:配置隧道并将其部署到Kubernetes。</p><h2 id="d892" class="mh lf iq bd lg mi mj dn lk mk ml dp lo kk mm mn ls ko mo mp lw ks mq mr ma ms bi translated">云耀斑隧道配置</h2><p id="8348" class="pw-post-body-paragraph jz ka iq kb b kc mc ke kf kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw ij bi translated">为了配置Kubernetes部署，我们需要将隧道代理的私钥存储在名为<code class="fe nc nd ne nf b">cert.pem</code>的文件中，将隧道的信息存储在名为<code class="fe nc nd ne nf b">tunnel.json</code>的文件中，并将配置文件存储在名为<code class="fe nc nd ne nf b">config.yml</code>的文件中。要获得这些，您需要ssh到您的虚拟机，并遵循<a class="ae jy" href="https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/tunnel-guide" rel="noopener ugc nofollow" target="_blank"> Cloudflare Tunnel入门</a>指南。这个过程相当简单，所以我不会在这里详细介绍，但这里有一个总结:</p><figure class="mu mv mw mx gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="834f" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">在这个过程之后，您已经登录(生成<code class="fe nc nd ne nf b">cert.pem</code>)并创建了隧道(生成隧道JSON文件)。您还创建了DNS规则来将流量转发到您的Cloudflare隧道，您可以通过访问您的Cloudflare控制面板来验证这一点。应该有一个新的DNS CNAME记录将您的主机名(例如<code class="fe nc nd ne nf b">secure.nima-dev.com</code>)路由到通过Cloudflare代理的<code class="fe nc nd ne nf b">TUNNEL_UUID.cfargotunnel.com</code>。现在您需要创建您的配置<code class="fe nc nd ne nf b">config.yml</code>文件。这个文件告诉隧道每个请求应该被路由到哪里，以及隧道JSON文件的位置。以下配置文件适用于我们的示例:</p><figure class="mu mv mw mx gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="54e3" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">对于更复杂的配置，您可以访问<a class="ae jy" href="https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/configuration/configuration-file" rel="noopener ugc nofollow" target="_blank"> Cloudflare文档</a>。现在我们已经有了所有需要的文件，是时候收集它们并创建Kubernetes部署了。如果你看一下虚拟机中的<code class="fe nc nd ne nf b">~/.cloudflared</code>文件夹，你应该已经准备好了<code class="fe nc nd ne nf b">cert.pem</code>和<code class="fe nc nd ne nf b">TUNNEL_UUID.json</code>文件。我们也创造了我们的<code class="fe nc nd ne nf b">config.yml</code>。</p><h2 id="b69e" class="mh lf iq bd lg mi mj dn lk mk ml dp lo kk mm mn ls ko mo mp lw ks mq mr ma ms bi translated">Kubernetes部署</h2><p id="cc8b" class="pw-post-body-paragraph jz ka iq kb b kc mc ke kf kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw ij bi translated">现在，我们已经做好了一切准备，让我们准备我们的Kubernetes部署。创建以下文件夹结构:</p><pre class="mu mv mw mx gt nk nf nl nm aw nn bi"><span id="6d9d" class="mh lf iq nf b gy no np l nq nr">.<br/>├── config<br/>│   ├── cert.pem<br/>│   └── tunnel.json<br/>├── configmap.yml<br/>└── deployment.yml</span></pre><p id="c507" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><code class="fe nc nd ne nf b">cert.pem</code>和<code class="fe nc nd ne nf b">tunnel.json</code>应该来自上一步。<code class="fe nc nd ne nf b">configmap.yml</code>包括配置，应该如下所示:</p><figure class="mu mv mw mx gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="df88" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><code class="fe nc nd ne nf b">deployment.yml</code>应该是下面这样的。只要确保用您使用的隧道名称替换<code class="fe nc nd ne nf b">$CLOUDFLARE_TUNNEL_NAME</code>即可:</p><figure class="mu mv mw mx gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="d49b" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">现在一切准备就绪，让我们将其部署到我们的Kubernetes集群:</p><figure class="mu mv mw mx gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="f9d3" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">几分钟后，您应该会在日志中看到类似这样的内容:</p><pre class="mu mv mw mx gt nk nf nl nm aw nn bi"><span id="fd1e" class="mh lf iq nf b gy no np l nq nr">2022-01-22T19:17:40Z INF Connection XXXXXXXXX registered connIndex=0 location=AMS<br/>2022-01-22T19:17:40Z INF Connection XXXXXXXXX registered connIndex=1 location=FRA<br/>2022-01-22T19:17:41Z INF Connection XXXXXXXXX registered connIndex=2 location=AMS<br/>2022-01-22T19:17:43Z INF Connection XXXXXXXXX registered connIndex=3 location=FRA</span></pre><p id="01e4" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">这意味着部署已经成功，一切都应该正常工作。您现在可以访问您指定的主机名来查看最终结果。</p><h2 id="684c" class="mh lf iq bd lg mi mj dn lk mk ml dp lo kk mm mn ls ko mo mp lw ks mq mr ma ms bi translated">Docker图像</h2><p id="9d8c" class="pw-post-body-paragraph jz ka iq kb b kc mc ke kf kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw ij bi translated">在我们的部署中，我为Cloudflare使用了自己的docker映像。尝试不时更新<code class="fe nc nd ne nf b">deployment.yml</code>中的图像标签，以使用最新版本。此外，我知道你可以使用<a class="ae jy" href="https://hub.docker.com/r/cloudflare/cloudflared" rel="noopener ugc nofollow" target="_blank"> cloudflared官方图像</a>稍加调整，但我创建了自己的图像，因为官方图像不支持ARM架构，我想在我的raspberry pi上运行它。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="0c18" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="50ab" class="pw-post-body-paragraph jz ka iq kb b kc mc ke kf kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw ij bi translated">在本教程中，您学习了如何使用Cloudflare隧道将您的Kubernetes服务安全地公开给互联网。从那里，你可以用Cloudfare服务做很多事情，其中大多数包括非常慷慨的免费层。就我个人而言，我非常享受Cloudflare为我的部署管理的轻松和简单的身份验证。如果你喜欢看像这样的关于Cloudflare Access为这些服务添加身份验证的教程，请在评论中告诉我。</p><h1 id="1c20" class="le lf iq bd lg lh ns lj lk ll nt ln lo lp nu lr ls lt nv lv lw lx nw lz ma mb bi translated">关于我</h1><p id="4e30" class="pw-post-body-paragraph jz ka iq kb b kc mc ke kf kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw ij bi translated">我是阿尔伯塔大学的博士候选人，也是约克大学的客座研究员和兼职讲师。我日复一日地研究无服务器计算平台，试图找到提高其性能、可靠性、能耗等的方法。，使用分析或数据驱动的方法(对“我要么使用数学要么使用机器学习来建模无服务器计算平台”的花哨说法)。我在这里写的是我在研究期间对一些无服务器计算平台的深入了解，以及它们的自动伸缩模式文档的简要汇编。</p><p id="62ac" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">如果你想知道更多关于我的事情，可以看看我的网站。</p></div></div>    
</body>
</html>