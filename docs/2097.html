<html>
<head>
<title>Node Engines: Helping Developers Everywhere Avoid Phantom Bugs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">节点引擎:帮助各地的开发人员避免幻像错误</h1>
<blockquote>原文：<a href="https://itnext.io/node-engines-helping-developers-everywhere-avoid-phantom-bugs-2eef519604b2?source=collection_archive---------0-----------------------#2019-03-31">https://itnext.io/node-engines-helping-developers-everywhere-avoid-phantom-bugs-2eef519604b2?source=collection_archive---------0-----------------------#2019-03-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="5971" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">特定的Node.js <code class="fe kl km kn ko b">Engines</code>应该是每个Package.json的必填字段</h1><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/e014079d617bf3ac8c66c31c366e8d32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0emt2DtmkH4_HBA3QN9R3A.png"/></div></div></figure><h1 id="a2cc" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">经典的开场白:“它在我的机器上工作。”</h1><p id="fca2" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi lz translated"><span class="l ma mb mc bm md me mf mg mh di"> L </span>让我来为你搭建舞台:你正在编写代码，关注自己的事业，为你的应用程序开发一个闪亮的新功能，突然红灯开始闪烁(或者#support Slack channel亮起，二者之一)，所有人都在甲板上；生产中有问题。🚨</p><p id="9e31" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">当开发团队放下一切来找出问题所在，并试图查明和重现问题时，经过20分钟毫无意义的调试，一个大胆的人耸了耸肩，说“在我的机器上工作。”😒</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/f91710983dd6503e6babaeb73010c9fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*SbyLoO83O3O8GH3Gy6J6zA.png"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">每个开发人员都至少听过(说过)170亿次了。</figcaption></figure><p id="6878" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">这句话对任何人都没有帮助，但准确地总结了我将要讨论的问题:</p><blockquote class="ms"><p id="5807" class="mt mu iq bd mv mw mx my mz na nb ly dk translated">像生产中不兼容的节点版本这样简单的事情可能会破坏您的应用程序，并且开发人员几乎不可能在本地找出问题所在。锁定节点引擎可以帮助您快速调试并避免这种情况。</p></blockquote><p id="3d7b" class="pw-post-body-paragraph lb lc iq ld b le nc lg lh li nd lk ll lm ne lo lp lq nf ls lt lu ng lw lx ly ij bi translated">您永远不会考虑您的机器在本地使用的是哪个版本的Node或NPM，而您的生产环境使用的是哪个版本的Node.js除非这很重要。</p><h2 id="85cc" class="nh jo iq bd jp ni nj dn jt nk nl dp jx lm nm nn kb lq no np kf lu nq nr kj ns bi translated">为什么这很重要的真实世界的例子</h2><p id="0a0e" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">当我说，我的团队支持的AngularJS 1.5应用程序只在Node版本9中工作时，我是根据个人经验说的，然而，当我们部署到我们的生产云环境时，与之一起部署的Node buildpack是在版本6中引入的。版本6？！？谁还会用这么老的节点版本来开发呢？？</p><p id="3592" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">不管怎样，我们的部署失败了，因为Node 6无法正确下载<code class="fe kl km kn ko b">node_modules</code>依赖项，应用程序无法启动，并且花费了几个小时来研究代码、构建日志和环境变量，以找出实际问题所在。这个部署在我的开发团队中被称为“黑暗星期四”。直到今天，如果你问当时在场的人，他们会给你一个惊恐的表情。😱</p><p id="24b8" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">类似地，我们的React应用程序需要节点版本10或更高版本，以利用它拥有的所有ES6和更高版本的节点依赖性。它需要<em class="nt">至少</em> v10或以上，没有如果，和，或但是。</p><p id="d034" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">所以现在你可以明白为什么不知道你的云构建包默认的节点版本是不好的了。这意味着您不知道您的节点模块会成功下载还是会失败。我们都同意这不是发展的方式。</p><p id="40bd" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">但是我们如何确保得到我们需要的构建包呢？当我们从本地开发环境部署到云生产环境时，我们如何保证Node.js运行时是相同的？它可以支持我们的项目运行所需的节点依赖关系？</p><p id="1f94" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">这实际上比你想象的要容易。请继续阅读我的解决方案。</p><h1 id="8213" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">我们如何防止错误版本的Node关闭我们的应用程序？</h1><h2 id="3f32" class="nh jo iq bd jp ni nj dn jt nk nl dp jx lm nm nn kb lq no np kf lu nq nr kj ns bi translated">简单:引擎</h2><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nu nv l"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">如果这是你最初的反应，我不怪你，这也是我的反应。</figcaption></figure><p id="c901" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">引擎？这到底是什么意思？？</p><h2 id="9fa9" class="nh jo iq bd jp ni nj dn jt nk nl dp jx lm nm nn kb lq no np kf lu nq nr kj ns bi translated">什么是节点引擎？</h2><p id="bea5" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated"><a class="ae nw" href="https://docs.npmjs.com/files/package.json#engines" rel="noopener ugc nofollow" target="_blank">节点引擎</a>是一个讨论不多(但我认为非常关键)的配置，它可以在你的<code class="fe kl km kn ko b">package.json</code>文件中指定，告诉任何运行JavaScript应用程序的人(或任何机器)代码需要哪个版本的节点才能工作。</p><p id="952f" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">NPM的<a class="ae nw" href="https://docs.npmjs.com/files/package.json#engines" rel="noopener ugc nofollow" target="_blank">自己的文件</a>在定义引擎时说:</p><blockquote class="nx ny nz"><p id="ed86" class="lb lc nt ld b le mi lg lh li mj lk ll oa mk lo lp ob ml ls lt oc mm lw lx ly ij bi translated">“你可以指定你的工作节点的版本”——NPM</p></blockquote><p id="718d" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">不言自明。</p><p id="4f6e" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">这实际上意味着:如果包含了<code class="fe kl km kn ko b">engines</code>，当JavaScript构建部署时(取决于如何指定引擎字段),它将寻找在<code class="fe kl km kn ko b">package.json</code>中配置的版本或更高版本的节点，然后下载它并使用该引擎安装所有的<code class="fe kl km kn ko b">node_module</code>依赖项。</p><p id="3bdf" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">如果一个引擎没有被指定，那么这个项目将受到buildpack神的支配，并且将假设任何旧版本的Node都可以，并下载一些随机版本的Node和NPM的依赖项。这就是我们如何结束像上述场景的消防演习。</p><p id="6d16" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">事实上，你可以在项目的<code class="fe kl km kn ko b">engines</code>配置中指定Node.js的版本、NPM的版本和Yarn的版本，这非常好。</p><p id="2cc1" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated"><strong class="ld ir">非常清楚:</strong><strong class="ld ir"/><code class="fe kl km kn ko b"><strong class="ld ir">engines</strong></code><strong class="ld ir">字段将在您安装软件包时验证，而不是在您运行应用程序时验证。</strong></p><p id="9d6a" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">既然您对节点引擎有了更好的了解，为什么它们有用以及它们是如何工作的，那么让我们着手建立一个项目来防止一个容易避免的部署失败。</p><h2 id="8530" class="nh jo iq bd jp ni nj dn jt nk nl dp jx lm nm nn kb lq no np kf lu nq nr kj ns bi translated">步骤1:找出您的本地开发运行时</h2><p id="ac34" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">第一步是弄清楚您正在使用哪个版本的Node进行本地开发。很简单。</p><p id="0454" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">只需打开一个终端窗口并键入:</p><pre class="kq kr ks kt gt od ko oe of aw og bi"><span id="2a61" class="nh jo iq ko b gy oh oi l oj ok">node -v</span></pre><p id="5829" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">然后，您应该在终端上看到您正在使用的节点的版本。见下面截图:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ol"><img src="../Images/6e4c8ef77fe24d046c53a8b2c980f711.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Y05maGac4yVV1m2GBue_w.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">如何查看在您的机器上运行的Node的本地版本？对我来说，目前是v11.10.0</figcaption></figure><p id="d0a4" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">如果你曾经需要为本地开发切换节点版本，我会强烈推荐<a class="ae nw" href="https://github.com/creationix/nvm" rel="noopener ugc nofollow" target="_blank"> NVM(节点版本管理器)</a>，在这里我也写过一篇关于<a class="ae nw" rel="noopener ugc nofollow" target="_blank" href="/nvm-the-easiest-way-to-switch-node-js-environments-on-your-machine-in-a-flash-17babb7d5f1b">的博文。</a></p><p id="fc71" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">但这是题外话。现在您所需要的是知道您当前正在哪个版本的节点上开发。让我们进入第二步。</p><h2 id="c5d4" class="nh jo iq bd jp ni nj dn jt nk nl dp jx lm nm nn kb lq no np kf lu nq nr kj ns bi translated">步骤2:在<code class="fe kl km kn ko b">Package</code>中指定您的节点引擎。json</h2><p id="5da9" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">现在您已经知道了Node的版本，您可以在项目的<code class="fe kl km kn ko b">package.json</code>文件中指定它。下面是几个关于<code class="fe kl km kn ko b">engines</code>配置的例子。</p><p id="477c" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">此示例包括高于或等于v11.10.2且低于v12.0.0的节点版本，以及正好为5.8.0的NPM版本。</p><pre class="kq kr ks kt gt od ko oe of aw og bi"><span id="66a8" class="nh jo iq ko b gy oh oi l oj ok">... // code above here like dependencies and other specs<br/>"engines": {    <br/>    "node": "&gt;=11.10.2 &lt;12.0.0",    <br/>    "npm": "5.8.0"  <br/>},<br/>... // more code below here</span></pre><p id="41f9" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">还是这个例子，包括10.15.0左右的节点版本。</p><pre class="kq kr ks kt gt od ko oe of aw og bi"><span id="f797" class="nh jo iq ko b gy oh oi l oj ok">... // more code <br/>"engines": {    <br/>    "node": "~10.15.0"  <br/>},<br/>... // more code</span></pre><p id="7708" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">指定节点、NPM和纱线版本类似于在您的<code class="fe kl km kn ko b">package.json</code>中为<code class="fe kl km kn ko b">dependencies</code>指定它们，您可以指定您想要的精确版本、提供下限、提供范围或近似值。这取决于你。</p><p id="d08b" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">在<code class="fe kl km kn ko b">package.json</code>中设置好节点引擎后，就该部署应用程序并验证是否下载和使用了正确的引擎了。</p><h2 id="82fa" class="nh jo iq bd jp ni nj dn jt nk nl dp jx lm nm nn kb lq no np kf lu nq nr kj ns bi translated">步骤3:运行您的部署构建脚本并验证构建包是否匹配</h2><p id="cdea" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">一旦您的构建管道部署了JavaScript应用程序，您应该能够在日志中验证指定的节点版本正在下载，以及正确的节点模块依赖关系。</p><p id="3d87" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">下面是来自Jenkins服务器的一些日志，该服务器运行我们AngularJS应用程序的所有构建，该应用程序需要Node 9版本。正如您在第一个屏幕截图中看到的，构建正在服务器上检查一个特定的节点版本，并找到了在<code class="fe kl km kn ko b">package.json</code>中指定的9.11.2，因此如果该版本不可用，它会将其安装到构建服务器上。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi om"><img src="../Images/e21d999c769bb4df58c0764b4f1f523a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y2KSEOHU9Ll6MtHK6Y2-PQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">这里验证了Node.js版本正在Jenkins构建服务器上运行。</figcaption></figure><p id="5924" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">这里还有一个截图的例子，这次是我们的React应用程序，需要10或以上的节点版本，下载节点v10.15.0，也是在React的<code class="fe kl km kn ko b">package.json</code> <code class="fe kl km kn ko b">engines</code>字段中指定的。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi on"><img src="../Images/cbf5d9c53abe395a5f23c94185c40811.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tnXdO-cTQCQrrjExq3hztw.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">另一个例子是下载指定的节点引擎，然后获取项目所需的节点模块依赖项。</figcaption></figure><p id="bbaf" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">在这之后，可以成功下载指定的节点依赖项，我们的应用程序应该能够顺利启动。</p><h2 id="6a48" class="nh jo iq bd jp ni nj dn jt nk nl dp jx lm nm nn kb lq no np kf lu nq nr kj ns bi translated">步骤4:享受压力较小的生产部署</h2><p id="a7e5" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">当您部署到生产环境时，突然少了一个需要担心的变量，您会感到如释重负。😄</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="oo nv l"/></div></figure><h1 id="b6ef" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">结论</h1><p id="2612" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">Node <code class="fe kl km kn ko b">engines</code>不会解决您的所有问题，但它们至少应该消除您的生产部署中的一些猜测(和意外的错误)。对于在您的<code class="fe kl km kn ko b">package.json</code>配置中指定这一点所需的少量工作，现在的投资可以节省您的时间。相信我，值得的。</p><p id="e6bf" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">过几周再来看看，我会写一些关于React或者其他与web开发相关的东西，所以请关注我，这样你就不会错过。</p><p id="90e5" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated">感谢阅读，我希望这能说服你在你的<code class="fe kl km kn ko b">package.json</code>配置中指定你的节点版本和NPM /纱线引擎。股份非常感谢！</p><p id="c4c1" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated"><strong class="ld ir">如果你喜欢读这篇文章，你可能也会喜欢我的其他博客:</strong></p><ul class=""><li id="e9b9" class="op oq iq ld b le mi li mj lm or lq os lu ot ly ou ov ow ox bi translated"><a class="ae nw" rel="noopener ugc nofollow" target="_blank" href="/nvm-the-easiest-way-to-switch-node-js-environments-on-your-machine-in-a-flash-17babb7d5f1b"> NVM，瞬间切换你机器上Node.js环境的最简单方法</a></li><li id="0216" class="op oq iq ld b le oy li oz lm pa lq pb lu pc ly ou ov ow ox bi translated"><a class="ae nw" rel="noopener ugc nofollow" target="_blank" href="/the-absolute-easiest-way-to-debug-node-js-with-vscode-2e02ef5b1bad">调试Node.js最简单的方法——使用VS代码</a></li><li id="5443" class="op oq iq ld b le oy li oz lm pa lq pb lu pc ly ou ov ow ox bi translated"><a class="ae nw" rel="noopener ugc nofollow" target="_blank" href="/using-node-js-to-read-really-really-large-files-pt-1-d2057fe76b33">使用Node.js读取非常非常大的文件(Pt 1) </a></li></ul><p id="4ed8" class="pw-post-body-paragraph lb lc iq ld b le mi lg lh li mj lk ll lm mk lo lp lq ml ls lt lu mm lw lx ly ij bi translated"><strong class="ld ir">参考资料和更多资源:</strong></p><ul class=""><li id="38ac" class="op oq iq ld b le mi li mj lm or lq os lu ot ly ou ov ow ox bi translated">发动机文档:<a class="ae nw" href="https://docs.npmjs.com/files/package.json#engines" rel="noopener ugc nofollow" target="_blank">https://docs.npmjs.com/files/package.json#engines</a></li><li id="05d6" class="op oq iq ld b le oy li oz lm pa lq pb lu pc ly ou ov ow ox bi translated">NVM，Github:<a class="ae nw" href="https://github.com/creationix/nvm" rel="noopener ugc nofollow" target="_blank">https://github.com/creationix/nvm</a></li></ul></div></div>    
</body>
</html>