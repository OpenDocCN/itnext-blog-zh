<html>
<head>
<title>Bootstrapping Kubernetes clusters on AWS with Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Terraform引导AWS上的Kubernetes集群</h1>
<blockquote>原文：<a href="https://itnext.io/bootstrapping-kubernetes-clusters-on-aws-with-terraform-b7c0371aaea0?source=collection_archive---------1-----------------------#2020-06-08">https://itnext.io/bootstrapping-kubernetes-clusters-on-aws-with-terraform-b7c0371aaea0?source=collection_archive---------1-----------------------#2020-06-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="4788" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">本文展示了一个Terraform模块，用于在AWS上使用kubeadm创建基本的Kubernetes集群。</p><h1 id="1bae" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">内容</h1><ol class=""><li id="fdb0" class="lm ln it js b jt lo jx lp kb lq kf lr kj ls kn lt lu lv lw bi translated"><a class="ae lx" href="#c72c" rel="noopener ugc nofollow"> <strong class="js iu">简介</strong> </a></li><li id="bb0e" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn lt lu lv lw bi translated"><a class="ae lx" href="#ba3b" rel="noopener ugc nofollow"> <strong class="js iu">托管Kubernetes服务</strong> </a></li><li id="e05a" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn lt lu lv lw bi translated"><a class="ae lx" href="#6761" rel="noopener ugc nofollow"> <strong class="js iu"> Kubernetes安装工具</strong> </a></li><li id="9008" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn lt lu lv lw bi translated"><a class="ae lx" href="#d283" rel="noopener ugc nofollow"><strong class="js iu">terra form kube ADM模块</strong> </a></li><li id="f016" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn lt lu lv lw bi translated"><a class="ae lx" href="#ce4c" rel="noopener ugc nofollow"> <strong class="js iu">什么是Terraform？</strong>T19】</a></li><li id="ec9f" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn lt lu lv lw bi translated"><a class="ae lx" href="#9403" rel="noopener ugc nofollow"> <strong class="js iu">使用Terraform模块的先决条件</strong> </a></li><li id="fe85" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn lt lu lv lw bi translated"><a class="ae lx" href="#9403" rel="noopener ugc nofollow"> <strong class="js iu">创建单个集群</strong> </a></li><li id="4fa7" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn lt lu lv lw bi translated"><a class="ae lx" href="#7af1" rel="noopener ugc nofollow"> <strong class="js iu">连接到节点</strong> </a></li><li id="bc15" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn lt lu lv lw bi translated"><a class="ae lx" href="#9689" rel="noopener ugc nofollow"> <strong class="js iu">使用专用VPC </strong> </a></li><li id="2df3" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn lt lu lv lw bi translated"><a class="ae lx" href="#c99a" rel="noopener ugc nofollow"> <strong class="js iu">创建多个集群</strong> </a></li><li id="38f5" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn lt lu lv lw bi translated"><a class="ae lx" href="#a66e" rel="noopener ugc nofollow"> <strong class="js iu">安装CNI插件</strong> </a></li><li id="ec3f" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn lt lu lv lw bi translated"><a class="ae lx" href="#9630" rel="noopener ugc nofollow"> <strong class="js iu">摧毁星团</strong> </a></li><li id="53c9" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn lt lu lv lw bi translated"><a class="ae lx" href="#4cbd" rel="noopener ugc nofollow"> <strong class="js iu">结论</strong> </a></li></ol><h1 id="c72c" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">介绍</h1><p id="af45" class="pw-post-body-paragraph jq jr it js b jt lo jv jw jx lp jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated">创建Kubernetes集群有许多方法——从简单的集群安装工具，如<a class="ae lx" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/" rel="noopener ugc nofollow" target="_blank"> kubeadm </a>到成熟的托管Kubernetes服务，如<a class="ae lx" href="https://cloud.google.com/kubernetes-engine" rel="noopener ugc nofollow" target="_blank"> GKE </a>、<a class="ae lx" href="https://aws.amazon.com/eks/" rel="noopener ugc nofollow" target="_blank"> EKS </a>或<a class="ae lx" href="https://docs.microsoft.com/azure/aks/" rel="noopener ugc nofollow" target="_blank"> AKS </a>。</p><p id="2359" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通常，可用选项在自动化和灵活性之间进行权衡:</p><ul class=""><li id="eab0" class="lm ln it js b jt ju jx jy kb mg kf mh kj mi kn mj lu lv lw bi translated">托管Kubernetes服务使得创建集群变得非常容易，但是它们通常会应用许多您无法配置的默认设置。</li><li id="77e6" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn mj lu lv lw bi translated">在另一个极端，在没有任何脚本和工具的情况下手动安装Kubernetes <a class="ae lx" href="https://github.com/kelseyhightower/kubernetes-the-hard-way" rel="noopener ugc nofollow" target="_blank">允许您配置您想要的每个设置，但是它需要许多手动和容易出错的步骤。</a></li></ul><p id="b4e8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通常，你想要的是这两个极端之间的中间地带。</p><p id="0f5b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">例如以简单的方式创建一个非自以为是的集群——最好使用一个命令。</p><p id="acc3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你想尝试某些低级的Kubernetes特性，比如<a class="ae lx" href="https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/" rel="noopener ugc nofollow" target="_blank"> CNI插件</a>——如果一个给定的集群安装方法默认安装了一个CNI插件，你就不能将它用于这个目的，因为你需要控制安装哪个CNI插件以及如何配置它。</p><p id="1f9a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mk">本文介绍了一种试图结合自动化和灵活性的方法。</em></p><p id="6ddd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是一个<a class="ae lx" href="https://registry.terraform.io/modules/weibeld/kubeadm/aws" rel="noopener ugc nofollow" target="_blank"> Terraform模块</a>，它使用<a class="ae lx" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/" rel="noopener ugc nofollow" target="_blank"> kubeadm </a>在AWS上创建一个简单的集群:</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi ml"><img src="../Images/844113795dd531c2709fe45a4ce4a4f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*u6ICOSU6I2z9MlmRfYjacQ.gif"/></div></div></figure><p id="80fd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建的集群是“最小可行集群”，因为它们是由kubeadm生成的，没有安装CNI插件，也没有应用自以为是的设置。</p><p id="38cf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这样做的目的是提供一个基础，在这个基础上你可以运行受控的Kubernetes实验(比如测试CNI插件或者实验其他Kubernetes特性)。</p><p id="8d71" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可以在GitHub 上找到Terraform模块<a class="ae lx" href="https://github.com/weibeld/terraform-aws-kubeadm" rel="noopener ugc nofollow" target="_blank">的代码。</a></p><p id="2c6b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mk">本文的剩余部分首先回顾创建Kubernetes集群的可用选项，然后介绍Terraform模块。</em></p><h1 id="ba3b" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">托管Kubernetes服务</h1><p id="5154" class="pw-post-body-paragraph jq jr it js b jt lo jv jw jx lp jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated">创建Kubernetes集群的选项可以分为两类:托管服务和安装工具。</p><p id="bfa8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">托管Kubernetes服务为您创建和操作集群，并允许您访问它。</p><p id="6df0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mk">他们允许你以软件即服务(SaaS)的方式使用Kubernetes。</em></p><p id="4d57" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">托管Kubernetes服务提供了最高程度的自动化(创建和操作完全由您完成)，但灵活性最低(您只能配置服务提供商通过其API公开的那些设置)。</p><p id="249b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最受欢迎的托管Kubernetes服务由主要的云提供商提供:</p><ul class=""><li id="45c4" class="lm ln it js b jt ju jx jy kb mg kf mh kj mi kn mj lu lv lw bi translated"><a class="ae lx" href="https://cloud.google.com/kubernetes-engine" rel="noopener ugc nofollow" target="_blank">谷歌Kubernetes引擎(GKE)</a>GCP</li><li id="9bb5" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn mj lu lv lw bi translated"><a class="ae lx" href="https://aws.amazon.com/eks/" rel="noopener ugc nofollow" target="_blank">亚马逊弹性库本内特服务(EKS) </a>由AWS提供</li><li id="5568" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn mj lu lv lw bi translated"><a class="ae lx" href="https://docs.microsoft.com/azure/aks/" rel="noopener ugc nofollow" target="_blank"> Azure Kubernetes服务(AKS) </a>由Azure</li></ul><h1 id="6761" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">Kubernetes安装工具</h1><p id="cca5" class="pw-post-body-paragraph jq jr it js b jt lo jv jw jx lp jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated">Kubernetes安装工具允许您自己安装和管理Kubernetes(无论是在内部还是在云中)。</p><p id="aba1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">它们允许你像使用传统的自我管理软件一样使用Kubernetes。</p><p id="1aed" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">安装工具提供了不同程度的自动化和灵活性，这取决于工具希望“让它适合您”的程度。</p><p id="4e10" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在撰写本文时，最流行的(也是官方支持的)Kubernetes安装工具是:</p><ul class=""><li id="d03c" class="lm ln it js b jt ju jx jy kb mg kf mh kj mi kn mj lu lv lw bi translated"><a class="ae lx" href="https://kops.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank">T3】kopsT5】</a></li><li id="446b" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn mj lu lv lw bi translated"><a class="ae lx" href="https://kubespray.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu"> kubespray </strong> </a></li><li id="b0bc" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn mj lu lv lw bi translated"><a class="ae lx" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu"> kubeadm </strong> </a></li></ul><p id="6d4d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们简单地看一下它们中的每一个。</p><h2 id="6b73" class="mx kp it bd kq my mz dn ku na nb dp ky kb nc nd lc kf ne nf lg kj ng nh lk ni bi translated">科普斯</h2><p id="70ab" class="pw-post-body-paragraph jq jr it js b jt lo jv jw jx lp jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated">在提供的三个工具中，<a class="ae lx" href="https://kops.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank"> kops </a>提供了最高程度的自动化，但也是最固执己见的一个。</p><p id="5a63" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">kops的特别之处在于，它不仅安装了Kubernetes，还提供了集群运行的云基础设施(目前支持AWS和GCP)。</p><p id="62ae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这意味着，只需一个命令，您就可以从零开始运行集群。</p><p id="2787" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另一方面，kops为您预测了许多决策，因此降低了您对集群外观的灵活性。</p><p id="99ac" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">例如，kops要求集群的名称是有效的DNS名称，并要求您设置解析该名称的DNS记录。</p><p id="56c5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，你必须为kops创建一个<a class="ae lx" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank">亚马逊S3桶</a>来存储它的状态。</p><h2 id="93e0" class="mx kp it bd kq my mz dn ku na nb dp ky kb nc nd lc kf ne nf lg kj ng nh lk ni bi translated">库贝斯普雷</h2><p id="10a7" class="pw-post-body-paragraph jq jr it js b jt lo jv jw jx lp jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated">kubespray是一个由ansi ble T21剧本组成的集合，可以在现有的基础设施上自动安装Kubernetes。</p><p id="710a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这意味着，与kops不同的是，在使用kubespray之前，您需要已经有一个合适的基础设施(内部或云中)。</p><p id="2034" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦有了基础设施，kubespray就为配置Kubernetes安装提供了大量选项。</p><p id="38cc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然而，并不是所有的选项都是可配置的——kube spray试图创建一个“生产就绪”的集群，这导致它应用某些默认设置和功能(比如默认安装一个CNI插件)。</p><p id="af03" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您真的想要一个生产就绪的集群，这是很好的，但是如果您想要的只是一个可以非常有选择地配置的“准系统”集群，那么kubespray善意的默认设置可能会妨碍您。</p><h2 id="ac9a" class="mx kp it bd kq my mz dn ku na nb dp ky kb nc nd lc kf ne nf lg kj ng nh lk ni bi translated">kubeadm</h2><p id="aaa6" class="pw-post-body-paragraph jq jr it js b jt lo jv jw jx lp jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated"><a class="ae lx" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/" rel="noopener ugc nofollow" target="_blank"> kubeadm </a>是所展示的三个集群安装工具中最基础、最底层的一个(实际上，kubespray在幕后使用了kubeadm)。</p><p id="e209" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，kubeadm提供的自动化程度最低，但灵活性最高。</p><p id="7586" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">kubeadm是一个可执行文件，直接在将要安装集群的基础设施上运行。</p><p id="58ec" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">与其他介绍的安装工具相比，kubeadm没有对集群的用途做出任何强有力的假设，例如它应该是生产就绪的，或者是高度可用的。</p><p id="38ca" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">具体来说，kubeadm执行以下任务:</p><ul class=""><li id="382a" class="lm ln it js b jt ju jx jy kb mg kf mh kj mi kn mj lu lv lw bi translated">为各个Kubernetes组件(API server、etcd、scheduler等)创建和分发客户端和服务器证书。)</li><li id="5f53" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn mj lu lv lw bi translated">为各个Kubernetes组件创建和分发kubeconfig文件(以便它们可以与API服务器对话)</li><li id="d07a" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn mj lu lv lw bi translated">将kubelet作为一个<a class="ae lx" href="https://systemd.io/" rel="noopener ugc nofollow" target="_blank">系统和</a>流程推出</li><li id="2335" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn mj lu lv lw bi translated">通过kubelet在<a class="ae lx" href="https://github.com/kubernetes/api/blob/master/core/v1/types.go#L2938" rel="noopener ugc nofollow" target="_blank">主机网络</a>中启动剩余的Kubernetes组件</li></ul><p id="c1ad" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">结果是一个“最小可行”的集群，您可以根据自己的需求自由定制。</p><p id="3cc7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，kubeadm允许对单个集群设置进行精细控制——例如，您可以使用<a class="ae lx" href="https://pkg.go.dev/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2" rel="noopener ugc nofollow" target="_blank"> kubeadm配置文件</a>直接为单个Kubernetes组件定义命令行参数。</p><p id="3cfa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mk">简而言之，如果您希望最大限度地控制集群的配置，kubeadm是一个最佳解决方案。</em></p><p id="cc29" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然而，另一方面，用kubeadm创建集群并不是一个单一命令的操作(kops和kubespray就是这种情况)。</p><p id="3a92" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">相反，它需要一系列手动步骤:</p><ul class=""><li id="1b15" class="lm ln it js b jt ju jx jy kb mg kf mh kj mi kn mj lu lv lw bi translated">调配要在其上创建集群的基础架构</li><li id="f015" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn mj lu lv lw bi translated">登录到每个节点，并在其上安装kubeadm和Docker</li><li id="562a" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn mj lu lv lw bi translated">在其中一个节点上运行<code class="fe nj nk nl nm b"><a class="ae lx" href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/" rel="noopener ugc nofollow" target="_blank">kubeadm init</a></code>命令</li><li id="6311" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn mj lu lv lw bi translated">在所有其他节点上运行<code class="fe nj nk nl nm b"><a class="ae lx" href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-join/" rel="noopener ugc nofollow" target="_blank">kubeadm join</a></code>命令</li></ul><p id="48b0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，这些步骤相互依赖——例如，<code class="fe nj nk nl nm b">kubeadm join</code>命令必须包含一个令牌和其他由初始<code class="fe nj nk nl nm b">kubeadm init</code>命令生成的标识符。</p><p id="2610" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">总的来说，用kubeadm创建Kubernetes集群是一个费时费力的手工过程。</p><p id="3410" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mk">这就是Terraform kubeadm模块的用武之地。</em></p><h1 id="d283" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">Terraform kubeadm模块</h1><p id="3735" class="pw-post-body-paragraph jq jr it js b jt lo jv jw jx lp jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated"><a class="ae lx" href="https://registry.terraform.io/modules/weibeld/kubeadm/aws" rel="noopener ugc nofollow" target="_blank"> Terraform kubeadm模块</a>自动操作kubeadm，目标是提供自动化和灵活性。</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi nn"><img src="../Images/c4ae20b59c5830a7e8386c64b48d3a5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a2inJhqkvmbGSOpUvxIJkA.png"/></div></div></figure><p id="ade6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然而，该模块不仅运行kubeadm，还为集群提供基础设施。</p><blockquote class="no np nq"><p id="371a" class="jq jr mk js b jt ju jv jw jx jy jz ka nr kc kd ke ns kg kh ki nt kk kl km kn im bi translated">目前，只有AWS作为基础设施提供商受到支持，但计划支持GCP和Azure。</p></blockquote><p id="6080" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这意味着，使用Terraform kubeadm模块，您可以在几分钟内通过一个命令从零到一个正在运行的集群。</p><p id="1085" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这为您带来了kops的便利，而不必处理您可能不需要的固执己见的特性。</p><p id="453a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用Terraform kubeadm模块，您可以获得与手动运行kubeadm时完全相同的“最小可行”集群。</p><p id="d4de" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mk">以下章节简要介绍了Terraform，然后展示了如何使用Terraform kubeadm模块。</em></p><h1 id="ce4c" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">什么是Terraform？</h1><p id="49b1" class="pw-post-body-paragraph jq jr it js b jt lo jv jw jx lp jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated"><a class="ae lx" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>是由Hashicorp创建的开源基础设施代码(IaC)工具。</p><p id="76ea" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">它允许以代码形式声明性地描述不同服务(例如AWS、GCP、Cloudflare)的一组基础架构(例如计算实例、网络),然后自动将这种描述变为现实。</p><p id="403d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Terraform代码用<a class="ae lx" href="https://www.terraform.io/docs/configuration/index.html" rel="noopener ugc nofollow" target="_blank"> Hashicorp配置语言(HCL) </a>编写，一组相关的Terraform代码文件称为<em class="mk"> Terraform配置</em>。</p><p id="75f3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了将Terraform配置变为现实，Terraform与相应服务的API进行对话(例如AWS、GCP、Cloudflare)。</p><p id="2996" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Terraform的力量和多功能性来自于<a class="ae lx" href="https://www.terraform.io/docs/providers/index.html" rel="noopener ugc nofollow" target="_blank"> Terraform供应商</a>。</p><p id="8eba" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Terraform提供者是插件式组件，封装了与特定服务(如AWS、GCP、Cloudflare)的API的交互，并将可通过该服务管理的资源作为<a class="ae lx" href="https://www.terraform.io/docs/configuration/resources.html" rel="noopener ugc nofollow" target="_blank"> Terraform资源</a>公开。</p><p id="9172" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">地形资源是地形配置的基本构件。</p><p id="4667" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">例如，AWS 有一个<a class="ae lx" href="https://www.terraform.io/docs/providers/aws/index.html" rel="noopener ugc nofollow" target="_blank"> Terraform提供者，这个提供者定义了一个名为<code class="fe nj nk nl nm b"><a class="ae lx" href="https://www.terraform.io/docs/providers/aws/r/instance.html" rel="noopener ugc nofollow" target="_blank">aws_instance</a></code>的Terraform资源，它对应于一个</a><a class="ae lx" href="https://aws.amazon.com/ec2/" rel="noopener ugc nofollow" target="_blank"> Amazon EC2实例</a>。</p><p id="fd20" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当您在Terraform配置中定义一个<code class="fe nj nk nl nm b">aws_instance</code> Terraform资源时，Terraform将为您创建一个EC2实例。</p><p id="0831" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，当您更改配置中的<code class="fe nj nk nl nm b">aws_instance</code>资源的定义时，Terraform会将相应的更改应用到您的AWS帐户中的实际EC2实例。</p><p id="adf8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">有超过一百个</strong> <a class="ae lx" href="https://www.terraform.io/docs/providers/index.html" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">官方支持的平台提供商</strong> </a> <strong class="js iu">和更多由社区</strong>  <strong class="js iu">提供的</strong> <a class="ae lx" href="https://www.terraform.io/docs/providers/type/community-index.html" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">。</strong></a></p><p id="4612" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">地形配置可以组织成一个<a class="ae lx" href="https://www.terraform.io/docs/modules/index.html" rel="noopener ugc nofollow" target="_blank">地形模块</a>。</p><p id="8491" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Terraform模块封装了一部分Terraform配置，以便可以重用和共享。</p><p id="ce7c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Terraform注册表是托管和共享Terraform模块的主要地方——你可以在那里浏览数百个免费的Terraform模块。</p><p id="9dc9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae lx" href="https://registry.terraform.io/modules/weibeld/kubeadm/aws" rel="noopener ugc nofollow" target="_blank"> Terraform kubeadm模块</a>也可以在Terraform注册表上免费获得，以下部分解释了如何使用它。</p><p id="fbcc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mk">下一节描述使用模块的先决条件。</em></p><h1 id="9403" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">使用Terraform模块的先决条件</h1><h2 id="5001" class="mx kp it bd kq my mz dn ku na nb dp ky kb nc nd lc kf ne nf lg kj ng nh lk ni bi translated">1.安装地形</h2><p id="6877" class="pw-post-body-paragraph jq jr it js b jt lo jv jw jx lp jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated">要在您的机器上使用Terraform，您首先必须安装它。</p><blockquote class="no np nq"><p id="afdf" class="jq jr mk js b jt ju jv jw jx jy jz ka nr kc kd ke ns kg kh ki nt kk kl km kn im bi translated">如果您已经安装了Terraform，请确保您至少安装了Terraform v0.12，因为这是模块所需的最低版本。</p></blockquote><p id="8e97" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Terraform以静态链接、预编译的二进制文件(用Go编写)的形式发布，要安装它，您只需下载它并将其移动到您的<code class="fe nj nk nl nm b">PATH</code>中的任何目录。</p><p id="3f2e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae lx" href="https://www.terraform.io/downloads.html" rel="noopener ugc nofollow" target="_blank"> Terraform网站</a>包含所有支持的目标平台的最新版本的Terraform二进制文件:</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi nu"><img src="../Images/2696d0a106a85a8dde3d7ebe9a9c7785.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3p7N-fMUzJqCH7sHRqzpUA.png"/></div></div></figure><p id="b3ff" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下载你的平台对应的包，解压，将包含的二进制文件移动到你的<code class="fe nj nk nl nm b">PATH</code>中的某个目录，比如<code class="fe nj nk nl nm b">/usr/bin</code>。</p><p id="b5fa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在macOS上，您也可以安装Terraform，带有:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="12cb" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ brew install terraform</strong></span></pre><p id="63b8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">安装Terraform后，您可以使用以下命令验证安装:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="c4ed" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ terraform version</strong></span></pre><blockquote class="no np nq"><p id="8d60" class="jq jr mk js b jt ju jv jw jx jy jz ka nr kc kd ke ns kg kh ki nt kk kl km kn im bi translated">请确保您的版本至少为0.12，因为这是Terraform kubeadm模块所需的最低版本。</p></blockquote><h2 id="06be" class="mx kp it bd kq my mz dn ku na nb dp ky kb nc nd lc kf ne nf lg kj ng nh lk ni bi translated">2.配置AWS凭据</h2><p id="b0c3" class="pw-post-body-paragraph jq jr it js b jt lo jv jw jx lp jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated">首先你需要一个<a class="ae lx" href="https://aws.amazon.com/" rel="noopener ugc nofollow" target="_blank"> AWS账号</a>。</p><p id="006d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于Terraform kubeadm模块将代表您创建AWS资源，因此它需要访问您的AWS帐户中的<a class="ae lx" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users.html" rel="noopener ugc nofollow" target="_blank"> IAM用户</a>的<a class="ae lx" href="https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html#access-keys-and-secret-access-keys" rel="noopener ugc nofollow" target="_blank">访问密钥ID和秘密访问密钥</a>。</p><p id="e53f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你已经在使用<a class="ae lx" href="https://aws.amazon.com/cli/" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a>并且在你的机器上有一个<code class="fe nj nk nl nm b">~/.aws/credentials</code>文件，那么你应该准备好了。</p><p id="5c84" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在所有其他情况下，您可以设置以下环境变量:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="e44b" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ export AWS_ACCESS_KEY_ID=&lt;AccessKeyID&gt;<br/>$ export AWS_SECRET_ACCESS_KEY=&lt;SecretAccessKey&gt;</strong></span></pre><p id="9a93" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以在<a class="ae lx" href="https://console.aws.amazon.com/iam/home" rel="noopener ugc nofollow" target="_blank"> AWS IAM控制台</a>中找到您的AWS账户中所有IAM用户的访问密钥ID和秘密访问密钥</p><blockquote class="no np nq"><p id="3afe" class="jq jr mk js b jt ju jv jw jx jy jz ka nr kc kd ke ns kg kh ki nt kk kl km kn im bi translated">在AWS IAM控制台中，如果无法检索现有的访问密钥ID和秘密访问密钥，还可以为任何IAM用户生成新的访问密钥ID和秘密访问密钥。</p></blockquote><p id="c047" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您使用的是具有有限权限的IAM用户，请确保至少附加了以下<a class="ae lx" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html" rel="noopener ugc nofollow" target="_blank"> IAM策略</a>:</p><ul class=""><li id="5af9" class="lm ln it js b jt ju jx jy kb mg kf mh kj mi kn mj lu lv lw bi translated"><code class="fe nj nk nl nm b">AmazonEC2FullAccess</code></li><li id="906f" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn mj lu lv lw bi translated"><code class="fe nj nk nl nm b">AmazonVPCFullAccess</code></li></ul><h2 id="bc87" class="mx kp it bd kq my mz dn ku na nb dp ky kb nc nd lc kf ne nf lg kj ng nh lk ni bi translated">3.确保默认的OpenSSH密钥</h2><p id="0314" class="pw-post-body-paragraph jq jr it js b jt lo jv jw jx lp jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated">Terraform kubeadm模块将通过使用OpenSSH的默认密钥对来设置对集群节点的SSH访问:</p><ul class=""><li id="b8df" class="lm ln it js b jt ju jx jy kb mg kf mh kj mi kn mj lu lv lw bi translated"><code class="fe nj nk nl nm b">~/.ssh/id_rsa</code>(私钥)</li><li id="47dd" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn mj lu lv lw bi translated"><code class="fe nj nk nl nm b">~/.ssh/id_rsa.pub</code>(公钥)</li></ul><p id="f383" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您的本地计算机上目前没有这些文件，您可以使用以下命令生成它们:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="7530" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ ssh-keygen</strong></span></pre><p id="579d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mk">你现在可以使用Terraform kubeadm模块了！</em></p><h1 id="b716" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">创建单个集群</h1><p id="fed7" class="pw-post-body-paragraph jq jr it js b jt lo jv jw jx lp jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated">在下面的内容中，您将在AWS上创建一个由一个主节点和两个工作节点组成的最小集群。</p><p id="ce29" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先创建一个新目录:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="b105" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ mkdir terraform-kubeadm<br/>$ cd terraform-kubeadm</strong></span></pre><p id="ca9d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个目录下，创建一个名为<code class="fe nj nk nl nm b">main.tf</code>的文件，内容如下:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="0c28" class="mx kp it nm b gy nz oa l ob oc">provider "aws" {<br/>  region = "eu-central-1"<br/>}</span><span id="f44a" class="mx kp it nm b gy od oa l ob oc">module "cluster" {<br/>  source  = "weibeld/kubeadm/aws"<br/>  version = "~&gt; 0.2"<br/>}</span></pre><blockquote class="no np nq"><p id="c05a" class="jq jr mk js b jt ju jv jw jx jy jz ka nr kc kd ke ns kg kh ki nt kk kl km kn im bi translated">注意<code class="fe nj nk nl nm b">eu-central-1</code>是将在其中创建集群的<a class="ae lx" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html" rel="noopener ugc nofollow" target="_blank"> AWS区域</a>。您可以将它替换为您喜欢的任何其他区域。</p></blockquote><p id="158f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">以上是调用<a class="ae lx" href="https://registry.terraform.io/modules/weibeld/kubeadm/aws" rel="noopener ugc nofollow" target="_blank"> Terraform kubeadm模块</a>的Terraform配置。</p><p id="cc69" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mk">这就是创建一个最小的Kubernetes集群需要编写的所有代码。</em></p><p id="7dc3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但在此之前，您必须在当前工作目录中初始化Terraform，如下所示:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="34dc" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ terraform init</strong></span></pre><p id="d5b4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe nj nk nl nm b"><a class="ae lx" href="https://www.terraform.io/docs/commands/init.html" rel="noopener ugc nofollow" target="_blank">terraform init</a></code>将AWS provider和Terraform kubeadm模块下载到当前工作目录中名为<code class="fe nj nk nl nm b">.terraform</code>的子目录中。</p><p id="a095" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，您可以开始将您的配置变为现实了:$</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="ce9b" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ terraform apply</strong></span></pre><p id="37e5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe nj nk nl nm b"><a class="ae lx" href="https://www.terraform.io/docs/commands/apply.html" rel="noopener ugc nofollow" target="_blank">terraform apply</a></code>命令首先向您显示一个所谓的<a class="ae lx" href="https://www.terraform.io/docs/commands/plan.html" rel="noopener ugc nofollow" target="_blank">执行计划</a>，它是Terraform将创建、修改或删除的资源的汇总。</p><p id="06c0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在您的情况下，因为您是从零开始，所以应该只创建资源。</p><p id="78db" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该命令会提示您是否要继续，您可以通过键入<code class="fe nj nk nl nm b">yes</code>来确认。</p><p id="b0c6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Terraform现在通过在您的AWS帐户中创建必要的AWS资源，将执行计划变为现实。</p><p id="1411" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可以往后靠，等待Terraform创建你的集群！</p><p id="7d94" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mk">不会超过3-4分钟。</em></p><p id="f4a9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当该命令完成时，您的集群应该已经启动并运行了！</p><p id="33c9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在您当前的工作目录中，您现在应该有一个带有随机昵称(比如<code class="fe nj nk nl nm b">real-hedgehog</code>)和<code class="fe nj nk nl nm b">.conf</code>扩展名的文件:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="4220" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ ls *.conf</strong><br/>real-hedgehog.conf</span></pre><p id="19c9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是用于连接到新创建的集群的<a class="ae lx" href="https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/" rel="noopener ugc nofollow" target="_blank"> kubeconfig </a>文件。</p><p id="e61e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以使用它通过kubectl访问集群，如下所示:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="8473" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ kubectl --kubeconfig real-hedgehog.conf get pods --all-namespaces</strong></span></pre><blockquote class="no np nq"><p id="668c" class="jq jr mk js b jt ju jv jw jx jy jz ka nr kc kd ke ns kg kh ki nt kk kl km kn im bi translated">请用您的kubeconfig文件的名称替换<code class="fe nj nk nl nm b">real-hedgehog.conf</code>。</p></blockquote><p id="d988" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您应该会看到集群的系统窗格。</p><p id="adf7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mk">祝贺您，您刚刚创建了您的第一个集群！</em></p><blockquote class="no np nq"><p id="f87d" class="jq jr mk js b jt ju jv jw jx jy jz ka nr kc kd ke ns kg kh ki nt kk kl km kn im bi translated">您可以在<a class="ae lx" href="https://console.aws.amazon.com/ec2/v2/home" rel="noopener ugc nofollow" target="_blank"> AWS EC2控制台</a>中看到Terraform在您的AWS帐户中创建的EC2实例(和其他资源)。</p></blockquote><p id="c033" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mk">因此，看起来您现在有了一个正在运行的集群。</em></p><p id="14db" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然而，如果您仔细观察上面的输出，您应该看到<code class="fe nj nk nl nm b">coredns</code>窗格是<code class="fe nj nk nl nm b">Pending</code>:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="554e" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ kubectl --kubeconfig real-hedgehog.conf get pods --all-namespaces</strong><br/>NAMESPACE    NAME                      READY  STATUS  RESTARTS AGE<br/>kube-system  coredns-66bff467f8-j2mmc  0/1    Pending  0       4m2s<br/>kube-system  coredns-66bff467f8-n265d  0/1    Pending  0       4m2s</span></pre><p id="8754" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果集群的节点应该是<code class="fe nj nk nl nm b">NotReady</code>:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="e89c" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ kubectl --kubeconfig real-hedgehog.conf get nodes<br/></strong>NAME       STATUS     ROLES    AGE     VERSION<br/>master     NotReady   master   8m57s   v1.18.2<br/>worker-0   NotReady   &lt;none&gt;   8m41s   v1.18.2<br/>worker-1   NotReady   &lt;none&gt;   8m41s   v1.18.2</span></pre><p id="db15" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mk">不用担心！</em></p><p id="62d4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这并不意味着有什么问题，这是意料之中的行为！</p><p id="b146" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">原因是您的集群还没有安装<a class="ae lx" href="https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/" rel="noopener ugc nofollow" target="_blank"> CNI插件</a>——这使节点保持在<code class="fe nj nk nl nm b">NotReady</code>状态，并阻止Pod网络中的任何Pod被调度。</p><blockquote class="no np nq"><p id="90d1" class="jq jr mk js b jt ju jv jw jx jy jz ka nr kc kd ke ns kg kh ki nt kk kl km kn im bi translated">如果你想知道为什么其他Pod都是<code class="fe nj nk nl nm b">Running</code>:那是因为这些Pod运行在<a class="ae lx" href="https://github.com/kubernetes/api/blob/master/core/v1/types.go#L2938" rel="noopener ugc nofollow" target="_blank">主机网络</a>(即它们将<code class="fe nj nk nl nm b">.spec.hostNetwork</code>设置为<code class="fe nj nk nl nm b">true</code>)而不是Pod网络，后者不依赖于CNI插件。</p></blockquote><p id="8ad4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您的集群没有安装CNI插件的原因是kubeadm没有默认安装CNI插件——而是让用户自己选择。</p><p id="8a5d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这篇文章将展示如何在你的集群中安装CNI插件。</p><p id="b1ea" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，让我们先多了解一下这个集群。</p><h1 id="7af1" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">连接到节点</h1><p id="8526" class="pw-post-body-paragraph jq jr it js b jt lo jv jw jx lp jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated">在下面的内容中，您将通过SSH进入集群的一个节点。</p><p id="680c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为此，您需要知道该节点的公共IP地址。</p><p id="2a7d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以通过转到<a class="ae lx" href="https://console.aws.amazon.com/ec2/v2/home" rel="noopener ugc nofollow" target="_blank"> AWS EC2控制台</a>并查找对应于该节点的EC2实例的公共IP地址来实现。</p><p id="052b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然而，Terraform kubeadm模块提供了一种更简单的方法来获取这些信息。</p><p id="6353" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该模块具有一组<a class="ae lx" href="https://registry.terraform.io/modules/weibeld/kubeadm/aws?tab=outputs" rel="noopener ugc nofollow" target="_blank">输出值</a>，用于向用户传达有关集群的内部信息。</p><p id="acb2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">其中一个输出名为<code class="fe nj nk nl nm b">cluster_nodes</code>，它包含集群中各个节点的信息，包括它们的公共IP地址。</p><p id="b274" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以将此输出包括在Terraform配置中，如下所示(添加的行将突出显示):</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="4dec" class="mx kp it nm b gy nz oa l ob oc">provider "aws" {<br/>  region = "eu-central-1"<br/>}</span><span id="119a" class="mx kp it nm b gy od oa l ob oc">module "cluster" {<br/>  source  = "weibeld/kubeadm/aws"<br/>  version = "~&gt; 0.2"<br/>}</span><span id="697e" class="mx kp it nm b gy od oa l ob oc"><strong class="nm iu">output "nodes" {<br/>  value = module.cluster.cluster_nodes<br/>}</strong></span></pre><p id="5420" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要显示这个输出，您必须再次运行<code class="fe nj nk nl nm b">terraform apply</code>:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="6698" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ terraform apply --auto-approve</strong></span></pre><blockquote class="no np nq"><p id="c92b" class="jq jr mk js b jt ju jv jw jx jy jz ka nr kc kd ke ns kg kh ki nt kk kl km kn im bi translated"><code class="fe nj nk nl nm b">--auto-approve</code>标志自动批准执行计划，因此您不需要键入<code class="fe nj nk nl nm b">yes</code>。</p></blockquote><p id="7d45" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该命令完成后，您应该会看到类似如下的输出:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="cb49" class="mx kp it nm b gy nz oa l ob oc">nodes = [<br/>  {<br/>    "name" = "master"<br/>    "private_ip" = "172.31.43.251"<br/>    "public_ip" = "3.127.72.79"<br/>    "subnet_id" = "subnet-a95feed4"<br/>  },<br/>  {<br/>    "name" = "worker-0"<br/>    "private_ip" = "172.31.41.249"<br/>    "public_ip" = "3.127.39.172"<br/>    "subnet_id" = "subnet-a95feed4"<br/>  },<br/>  {<br/>    "name" = "worker-1"<br/>    "private_ip" = "172.31.32.223"<br/>    "public_ip" = "18.197.147.253"<br/>    "subnet_id" = "subnet-a95feed4"<br/>  },<br/>]</span></pre><p id="fba6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">正如您所看到的，它包含了关于集群中每个节点的一些信息，包括它的公共IP地址。</p><p id="dd56" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有了这些信息，您现在可以SSH到集群的任何节点，如下所示:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="e271" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ ssh -i ~/.ssh/id_rsa ubuntu@&lt;NODE-PUBLIC-IP&gt;</strong></span></pre><blockquote class="no np nq"><p id="01d0" class="jq jr mk js b jt ju jv jw jx jy jz ka nr kc kd ke ns kg kh ki nt kk kl km kn im bi translated">注意<code class="fe nj nk nl nm b">~/.ssh/id_rsa</code>是默认的OpenSSH私有密钥，Terraform kubeadm模块默认使用它来设置对集群节点的SSH访问。它是允许您连接到集群的所有节点的凭证。</p></blockquote><p id="df0d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在您应该登录到节点，在这里您可以做各种有趣的事情，比如列出正在运行的容器:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="a829" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ sudo docker ps</strong></span></pre><p id="2686" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是现在，只要回到您的本地机器:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="64d9" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ exit</strong></span></pre><p id="8c02" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mk">有一种方法可以改善您的集群基础设施！</em></p><h1 id="9689" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">使用专用的VPC</h1><p id="fbfe" class="pw-post-body-paragraph jq jr it js b jt lo jv jw jx lp jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated">默认情况下，kubeadm模块在指定AWS区域的<a class="ae lx" href="https://docs.aws.amazon.com/vpc/latest/userguide/default-vpc.html" rel="noopener ugc nofollow" target="_blank">默认VPC </a>中创建集群。</p><p id="4734" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这意味着，该集群与该VPC中的其他AWS资源共存。</p><p id="6f4e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在某些情况下，这不是问题，但一般来说，将不相关的应用程序分离到单独的VPC中是个好主意。</p><p id="f38f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Terraform kubeadm模块允许您为集群动态创建专用的VPC。</p><p id="04e9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为此，按如下方式编辑Terraform配置(突出显示添加的行):</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="86ff" class="mx kp it nm b gy nz oa l ob oc">provider "aws" {<br/>  region = "eu-central-1"<br/>}</span><span id="2dd4" class="mx kp it nm b gy od oa l ob oc"><strong class="nm iu">module "network" {<br/>  source  = "weibeld/kubeadm/aws//modules/network"<br/>  version = "~&gt; 0.2"<br/>}</strong></span><span id="7735" class="mx kp it nm b gy od oa l ob oc">module "cluster" {<br/>  source    = "weibeld/kubeadm/aws"<br/>  version   = "~&gt; 0.2"<br/><strong class="nm iu">  vpc_id    = module.network.vpc_id<br/>  subnet_id = module.network.subnet_id</strong><br/>}</span><span id="6e87" class="mx kp it nm b gy od oa l ob oc">output "nodes" {<br/>  value = module.cluster.cluster_nodes<br/>}</span></pre><p id="40c9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上面的配置增加了对<a class="ae lx" href="https://github.com/weibeld/terraform-aws-kubeadm/tree/master/modules/network" rel="noopener ugc nofollow" target="_blank">网络子模块</a>的调用。</p><p id="0e8d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">网络子模块作为kubeadm模块的一部分进行分发，它创建了一个VPC，适合于托管由kubeadm模块创建的集群。</p><p id="b696" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该配置将创建的VPC及其子网的id传递给kubeadm模块的<code class="fe nj nk nl nm b">vpc_id</code>和<code class="fe nj nk nl nm b">subnet_id</code> <a class="ae lx" href="https://registry.terraform.io/modules/weibeld/kubeadm/aws?tab=inputs" rel="noopener ugc nofollow" target="_blank">输入变量</a>。</p><p id="bbb3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这将导致kubeadm模块在指定的VPC和子网中创建集群，这意味着您的集群将运行这个新的专用VPC。</p><p id="1811" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因为您添加了一个新的模块调用，所以在应用配置之前，您首先需要运行<code class="fe nj nk nl nm b">terraform init</code>:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="61d2" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ terraform init</strong></span></pre><p id="255f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这会将网络子模块下载到您的本地目录。</p><p id="f6d7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在您可以应用您的新配置了:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="3cec" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ terraform apply</strong></span></pre><p id="4ef3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Terraform现在计算出如何从当前状态进入新规范，并向您展示执行计划。</p><p id="4857" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您密切关注执行计划，您可以看到<code class="fe nj nk nl nm b">aws_instance</code>资源被销毁和重新创建——这意味着Terraform将有效地销毁现有集群，并在新的VPC中创建新集群。</p><p id="fb95" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要确认执行计划，请键入<code class="fe nj nk nl nm b">yes</code>。</p><p id="7364" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该命令完成后，您应该有一个新的VPC和一个新的集群在其中运行。</p><blockquote class="no np nq"><p id="95af" class="jq jr mk js b jt ju jv jw jx jy jz ka nr kc kd ke ns kg kh ki nt kk kl km kn im bi translated">你可以在<a class="ae lx" href="http://localhost:4000/https.//console.aws.amazon.com/vpc/home" rel="noopener ugc nofollow" target="_blank"> AWS VPC控制台</a>中看到Terraform创建的VPC。</p></blockquote><p id="9b6d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们测试一下您是否还能访问这个新集群:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="4b39" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ kubectl --kubeconfig real-hedgehog.conf get pods --all-namespaces</strong></span></pre><p id="e35a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mk">宾果！</em></p><p id="228b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您应该会像之前一样看到系统面板列表。</p><p id="ce02" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是现在您的集群运行在自己的VPC中，与任何其他AWS资源隔离开来！</p><h1 id="c99a" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">创建多个集群</h1><p id="3906" class="pw-post-body-paragraph jq jr it js b jt lo jv jw jx lp jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated">到目前为止，您只创建了一个集群，但是如果您想要多个集群呢？</p><p id="064d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mk">例如，如果你想在多个集群上并行运行一系列实验？</em></p><p id="a7d3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在下面的内容中，您将集群扩展到总共三个集群。</p><p id="16a3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为此，请按如下方式编辑您的配置(突出显示更改的行):</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="4f3c" class="mx kp it nm b gy nz oa l ob oc">provider "aws" {<br/>  region = "eu-central-1"<br/>}</span><span id="0197" class="mx kp it nm b gy od oa l ob oc">module "network" {<br/>  source  = "weibeld/kubeadm/aws//modules/network"<br/>  version = "~&gt; 0.2"<br/>}</span><span id="3076" class="mx kp it nm b gy od oa l ob oc">module "cluster" {<br/>  source    = "weibeld/kubeadm/aws"<br/>  version   = "~&gt; 0.2"<br/>  vpc_id    = module.network.vpc_id<br/>  subnet_id = module.network.subnet_id<br/>}</span><span id="0854" class="mx kp it nm b gy od oa l ob oc"><strong class="nm iu">module "cluster_2" {<br/>  source    = "weibeld/kubeadm/aws"<br/>  version   = "~&gt; 0.2"<br/>  vpc_id    = module.network.vpc_id<br/>  subnet_id = module.network.subnet_id<br/>}</strong></span><span id="037e" class="mx kp it nm b gy od oa l ob oc"><strong class="nm iu">module "cluster_3" {<br/>  source    = "weibeld/kubeadm/aws"<br/>  version   = "~&gt; 0.2"<br/>  vpc_id    = module.network.vpc_id<br/>  subnet_id = module.network.subnet_id<br/>}</strong></span><span id="4321" class="mx kp it nm b gy od oa l ob oc">output "nodes" {<br/><strong class="nm iu">  value = {<br/>    (module.cluster.cluster_name)   = module.cluster.cluster_nodes<br/>    (module.cluster_2.cluster_name) = module.cluster_2.cluster_nodes<br/>    (module.cluster_3.cluster_name) = module.cluster_3.cluster_nodes<br/>  }</strong><br/>}</span></pre><p id="d612" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上述配置的主要变化在于增加了两次对kubeadm模块的调用。</p><p id="0607" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个配置现在包含了三个对kubeadm模块的调用，这导致Terraform创建了三个集群。</p><p id="d4f7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在当前的配置中，所有集群使用相同的设置，但是您可以通过为kubeadm模块的单独调用指定不同的<a class="ae lx" href="https://registry.terraform.io/modules/weibeld/kubeadm/aws?tab=inputs" rel="noopener ugc nofollow" target="_blank">输入变量</a>来单独配置每个集群。</p><blockquote class="no np nq"><p id="da03" class="jq jr mk js b jt ju jv jw jx jy jz ka nr kc kd ke ns kg kh ki nt kk kl km kn im bi translated">您还可以通过添加网络子模块的额外调用，为每个集群创建一个专用的VPC。</p></blockquote><p id="46ce" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果这个配置有效，那么在应用它之后，您应该有三个正在运行的集群。</p><p id="1ebd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于您添加了额外的模块调用，您首先需要运行<code class="fe nj nk nl nm b">terraform init</code>:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="501e" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ terraform init</strong></span></pre><p id="697b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，您可以使用<code class="fe nj nk nl nm b">terraform apply</code>应用配置:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="792f" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ terraform apply</strong></span></pre><p id="d8dc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您注意Terraform呈现给您的执行计划，您应该看到它包括属于两个新集群的资源的创建。</p><p id="ae42" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这意味着Terraform将创建两个新集群，而保持现有集群不变，这是因为您只是在配置中添加了两个新集群规范，而没有修改现有的规范。</p><p id="5963" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mk">用</em> <code class="fe nj nk nl nm b">yes</code> <em class="mk">确认提示后，命令完成，现在应该有三个正在运行的集群了！</em></p><p id="a244" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，您的当前工作目录中应该还有三个kubeconfig文件，每个集群一个:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="2153" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ ls *.conf<br/></strong>growing-cattle.conf<br/>obliging-eft.conf<br/>real-hedgehog.conf</span></pre><p id="fa19" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们测试一下您是否可以访问每个集群:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="b6f4" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ kubectl get nodes --kubeconfig growing-cattle.conf<br/>$ kubectl get nodes --kubeconfig obliging-eft.conf<br/>$ kubectl get nodes --kubeconfig real-hedgehog.conf</strong></span></pre><p id="964f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">所有命令都应该成功！</p><p id="ca22" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这意味着三个集群都在运行。</p><p id="d679" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mk">恭喜你，你刚刚创建了一支由三个库伯内特星团组成的舰队！</em></p><h1 id="a66e" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">安装CNI插件</h1><p id="8339" class="pw-post-body-paragraph jq jr it js b jt lo jv jw jx lp jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated">您现在有三个集群，但是有些事情可能仍然会让您感到有些困扰。</p><p id="5e34" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">他们没有安装CNI插件，这导致节点被<code class="fe nj nk nl nm b">NotReady</code>并阻止任何pod被调度。</p><p id="f0c1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们来解决这个问题！</p><p id="76e7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">拥有三个新引导的集群实际上是在受控环境中比较不同CNI插件的好机会。</p><p id="0bc7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">三个最流行的CNI插件是:</p><ul class=""><li id="59de" class="lm ln it js b jt ju jx jy kb mg kf mh kj mi kn mj lu lv lw bi translated"><a class="ae lx" href="https://www.projectcalico.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">印花棉布</strong> </a></li><li id="0832" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn mj lu lv lw bi translated"><a class="ae lx" href="https://www.weave.works/docs/net/latest/overview/" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">织网</strong> </a></li><li id="d05f" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn mj lu lv lw bi translated"><a class="ae lx" href="https://cilium.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">纤毛</strong> </a></li></ul><p id="dddb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，让我们在每个集群上安装一个。</p><p id="b310" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae lx" href="https://docs.projectcalico.org/getting-started/kubernetes/quickstart" rel="noopener ugc nofollow" target="_blank">在第一个集群上安装印花棉布</a>:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="ca7d" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ kubectl apply \<br/>  -f https://docs.projectcalico.org/manifests/calico.yaml \<br/>  --kubeconfig growing-cattle.conf</strong></span></pre><p id="9183" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae lx" href="https://www.weave.works/docs/net/latest/kubernetes/kube-addon/" rel="noopener ugc nofollow" target="_blank">在第二组上安装编织网</a>:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="0fa9" class="mx kp it nm b gy nz oa l ob oc"><em class="mk"># Identify Kubernetes version<br/></em><strong class="nm iu">$ K8S_VERSION=$(kubectl version --kubeconfig obliging-eft.conf | base64 | tr -d '\n')<br/></strong><em class="mk"># Install CNI plugin<br/></em><strong class="nm iu">$ kubectl apply \<br/>  -f "https://cloud.weave.works/k8s/net?k8s-version=$K8S_VERSION" \<br/>  --kubeconfig obliging-eft.conf</strong></span></pre><p id="afaf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">并将<a class="ae lx" href="https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/" rel="noopener ugc nofollow" target="_blank">纤毛</a>安装在第三簇上:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="5a27" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ kubectl apply \<br/>  -f </strong><a class="ae lx" href="https://raw.githubusercontent.com/cilium/cilium/1.7.0/\" rel="noopener ugc nofollow" target="_blank"><strong class="nm iu">https://raw.githubusercontent.com/cilium/cilium/1.7.0/\</strong></a><strong class="nm iu"><br/>install/kubernetes/quick-install.yaml \<br/>  --kubeconfig real-hedgehog.conf</strong></span></pre><p id="c64a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，给CNI插件一些时间来初始化。</p><p id="c184" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后再次查询集群的节点:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="3b6f" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ kubectl get nodes --kubeconfig growing-cattle.conf<br/>$ kubectl get nodes --kubeconfig obliging-eft.conf<br/>$ kubectl get nodes --kubeconfig real-hedgehog.conf</strong></span></pre><p id="8e39" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mk">宾果！</em></p><p id="ef47" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在所有节点应该都是<code class="fe nj nk nl nm b">Ready</code>！</p><p id="f9d2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你列出吊舱，他们现在也应该都是<code class="fe nj nk nl nm b">Running</code>。</p><p id="30dd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mk">CNI插件确实完成了你的集群的设置，并使它们功能齐全。</em></p><p id="28c5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此时，您可以在集群中启动更多的pod并做更多的实验。</p><h1 id="9630" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">摧毁集群</h1><p id="f0de" class="pw-post-body-paragraph jq jr it js b jt lo jv jw jx lp jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated">当您试验完集群后，您应该删除它们，因为不幸的是，在AWS上运行集群是要花钱的。</p><p id="7cda" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">幸运的是，Terraform使这变得非常容易。</p><p id="e69f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您只需发出以下命令:</p><pre class="mm mn mo mp gt nv nm nw nx aw ny bi"><span id="91d1" class="mx kp it nm b gy nz oa l ob oc"><strong class="nm iu">$ terraform destroy</strong></span></pre><p id="b626" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe nj nk nl nm b"><a class="ae lx" href="https://www.terraform.io/docs/commands/destroy.html" rel="noopener ugc nofollow" target="_blank">terraform destroy</a></code>从您的配置中删除当前正在运行的所有资源。</p><p id="24a7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这意味着与您的集群对应的所有AWS资源都将被删除。</p><p id="8bf3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该命令还向您展示了一个执行计划，指定了将要删除的资源的确切集合，您可以使用<code class="fe nj nk nl nm b">yes</code>来确认。</p><p id="1e06" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当该命令完成时，您的AWS帐户将处于与您第一次运行<code class="fe nj nk nl nm b">terraform apply</code>之前完全相同的状态！</p><h1 id="4cbd" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">结论</h1><p id="1612" class="pw-post-body-paragraph jq jr it js b jt lo jv jw jx lp jz ka kb md kd ke kf me kh ki kj mf kl km kn im bi translated">本文介绍了<a class="ae lx" href="https://registry.terraform.io/modules/weibeld/kubeadm/aws" rel="noopener ugc nofollow" target="_blank"> Terraform kubeadm模块</a>，它允许在AWS上自动创建Kubernetes集群。</p><p id="e8c0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从这里你可以走向不同的方向:</p><ul class=""><li id="9ad1" class="lm ln it js b jt ju jx jy kb mg kf mh kj mi kn mj lu lv lw bi translated">本文只介绍了该模块最基本的用法。该模块有各种<a class="ae lx" href="https://registry.terraform.io/modules/weibeld/kubeadm/aws?tab=inputs" rel="noopener ugc nofollow" target="_blank">输入变量</a>，允许以不同的方式配置集群。</li><li id="8e11" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn mj lu lv lw bi translated">例如，您可以定义工作节点的数量和类型、Pod网络的CIDR块或可能访问您的群集的IP地址，以防止不必要的访问。</li><li id="f5e6" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn mj lu lv lw bi translated">该模块仍处于早期开发阶段，将来会添加新功能，如新的输入变量。</li><li id="2654" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn mj lu lv lw bi translated">GCP和Azure的等效模块的未来工作正在计划中。</li><li id="957b" class="lm ln it js b jt ly jx lz kb ma kf mb kj mc kn mj lu lv lw bi translated">您可以<a class="ae lx" href="https://github.com/weibeld/terraform-aws-kubeadm" rel="noopener ugc nofollow" target="_blank">在GitHub上提出问题并为模块</a>创建拉请求。</li></ul></div></div>    
</body>
</html>