<html>
<head>
<title>Push Notification with Angular &amp; .Net Core using Firebase</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用角度&amp;推送通知。使用Firebase的网络核心</h1>
<blockquote>原文：<a href="https://itnext.io/push-notification-with-angular-net-core-a2280d18eda1?source=collection_archive---------1-----------------------#2019-12-09">https://itnext.io/push-notification-with-angular-net-core-a2280d18eda1?source=collection_archive---------1-----------------------#2019-12-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="225d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以，你想在发生某些事情时引起用户的注意，或者你想提醒他们你的应用程序中有新的东西。下面是我使用Angular &amp;遵循的方法。Net Core通过FCM (Firebase Cloud Messaging)实现推送通知。</p></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><p id="2141" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我在Visual Studio 2019中创建了一个空白的解决方案，并使用最新的角度模板添加了一个ASP.NET项目。Net核心版(3.0)。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ks"><img src="../Images/66cd5194f1ee275cd215eb24e81e21a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hWOmZwdppPO1FDzJaQyGhQ.png"/></div></div></figure><p id="2a5a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">注意:</strong>确保您选择了“为HTTPS配置”以便能够在本地测试推送通知。</p><p id="b499" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该模板将处理rest，并用Angular 8初始化一个ASP.Net应用程序。如果您是非windows用户，可以使用Dotnet-CLI来使用相同的模板。</p><p id="2cb1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe le lf lg lh b">dotnet new angular</code></p><p id="d5b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">注意:</strong>如果要使用CLI，需要手动配置https。要做到这一点，只需运行下面的代码。<em class="li">可以多读读</em> <a class="ae lj" href="https://www.hanselman.com/blog/DevelopingLocallyWithASPNETCoreUnderHTTPSSSLAndSelfSignedCerts.aspx" rel="noopener ugc nofollow" target="_blank"> <em class="li">斯科特·汉瑟曼</em> </a> <em class="li">。</em></p><p id="000b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe le lf lg lh b">dotnet dev-certs https — trust</code></p><p id="e542" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在将屏幕切换到IDE之前，我们需要初始化我们的web推送提供程序。</p><h1 id="5a86" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">步骤1:为Web推送配置FCM</h1><p id="bbe7" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">转到<a class="ae lj" href="https://console.firebase.google.com" rel="noopener ugc nofollow" target="_blank"> firebase控制台</a>并使用您的Google帐户登录。点击<strong class="jp ir">“创建新项目”</strong>按钮，并按照说明进行操作。</p><p id="1c76" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建项目后，您将看到一个仪表板。点击左侧的菜单<strong class="jp ir">‘云消息’</strong>。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/27cbf5a5a2d6d590e03d6f312370b183.png" data-original-src="https://miro.medium.com/v2/resize:fit:702/format:webp/1*oVobUgBHMAAx3pVCN6zsmw.png"/></div></figure><p id="cfdd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击<code class="fe le lf lg lh b">&lt;/&gt;</code>图标。这将向您的firebase项目添加一个web应用程序。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/016135c1b777d9a63f75cee8be52c78a.png" data-original-src="https://miro.medium.com/v2/resize:fit:750/format:webp/1*OTlAgiXmzUYIFLegqzvFaw.png"/></div></figure><p id="6205" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该网站将要求您为您的应用程序命名，然后要求您将一个脚本添加到您的网站SDK。跳过这个。</p><p id="ae50" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，回到仪表板，按照左上角的菜单进入项目设置。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/beb865811724938a73cf82f1e2957af8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/format:webp/1*pdJjiyitxKs2roBlThz24A.png"/></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">项目设置菜单</figcaption></figure><p id="bf23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">我们需要的信息</strong>在<em class="li">云消息</em>页面。我们将在发送和接收通知时使用这些信息。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi mu"><img src="../Images/1310500594a6b3a80b133161a72e8df6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qSDCYa5RNeQnSR6f__Ai2w.png"/></div></div></figure><h1 id="80fe" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">第二步:角度</h1><p id="fdf6" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">接收消息和将它们显示为本机通知是两码事。推送API 将给我们捕捉消息的能力。并且，<strong class="jp ir">通知API </strong>会负责通知<strong class="jp ir"> </strong>的显示。而是因为我们用FCM它将为我们处理这些问题。<em class="li">(当站点不活动时将触发本机通知，当站点活动时将触发应用程序代码)</em></p><p id="b2e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们需要一个<strong class="jp ir">服务人员</strong>。</p><blockquote class="mv mw mx"><p id="c20d" class="jn jo li jp b jq jr js jt ju jv jw jx my jz ka kb mz kd ke kf na kh ki kj kk ij bi translated">服务人员是您的浏览器在后台运行的脚本，独立于网页，为不需要网页或用户交互的功能打开了大门。<a class="ae lj" href="https://developers.google.com/web/fundamentals/primers/service-workers#what_is_a_service_worker" rel="noopener ugc nofollow" target="_blank">继续阅读关于服务人员的文章</a>。</p></blockquote><p id="9d0c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为什么？因为当你的客户端应用不活跃时，服务人员会在那里处理你的推送消息。</p><p id="8d41" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">服务人员基本上是一个js文件。在angular应用程序的src文件夹中创建一个名为<code class="fe le lf lg lh b">firebase-messaging-sw.js</code>的js文件。然后，把这几行放进去:</p><figure class="kt ku kv kw gt kx"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">firebase-messaging-sw.js</figcaption></figure><p id="3071" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后创建一个名为<code class="fe le lf lg lh b">manifest.webmanifest</code>的文件，将您的messagingSenderId放入其中，如下所示:</p><figure class="kt ku kv kw gt kx"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">清单. web清单</figcaption></figure><p id="8dc6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">注意</strong>说明<strong class="jp ir"> </strong>其他属性可以给你PWA能力，不如保留。如果您想了解更多关于PWA的信息，我推荐您访问这篇伟大的文章:<a class="ae lj" rel="noopener ugc nofollow" target="_blank" href="/build-a-production-ready-pwa-with-angular-and-firebase-8f2a69824fcc">Onder cey LAN——用Angular和Firebase构建一个生产就绪的PWA</a></p><p id="c748" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们需要将<code class="fe le lf lg lh b">firebase-messaging-sw.js</code>和<code class="fe le lf lg lh b">manifest.webmanifest</code>注册到angular。</p><ul class=""><li id="d2df" class="nd ne iq jp b jq jr ju jv jy nf kc ng kg nh kk ni nj nk nl bi translated">angular.json</li></ul><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/7a3135d74e512a607460e6d964fb69d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:756/format:webp/1*gH7xw30sXAC4NrCLeIBA0w.png"/></div></figure><ul class=""><li id="6e31" class="nd ne iq jp b jq jr ju jv jy nf kc ng kg nh kk ni nj nk nl bi translated">index.html</li></ul><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/2bdcadfd37a1c174f5bbeb93a962cec9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*23t2Ist3cXuSvuNX-0q5ng.png"/></div></figure><p id="04ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="li">我们没有向angular注册service-worker，因为当我们调用service来获取令牌时，它会自动加载。</em></p><p id="c207" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们有必要的组件来捕捉推送消息。当您构建并运行您的应用程序时，您应该能够看到您的文件被正确加载，您的服务人员被正确注册。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="gh gi no"><img src="../Images/a9f5e33f4301a83e96717603187d008d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1134/format:webp/1*R15s0Up0UfcrndW5JZnwtw.png"/></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">Chrome开发工具—网络选项卡</figcaption></figure><p id="1d1b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要注册到FCM推送服务并创建通知，我们需要安装这两个软件包:</p><pre class="kt ku kv kw gt np lh nq nr aw ns bi"><span id="84ee" class="nt ll iq lh b gy nu nv l nw nx">npm install firebase @angular/fire --save</span></pre><p id="900c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">去<code class="fe le lf lg lh b">app.module.ts</code>注册这些模块</p><figure class="kt ku kv kw gt kx"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">应用程序模块</figcaption></figure><p id="8640" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在firebase控制台的Firebase项目设置中找到<strong class="jp ir"> apiKey、projectId、</strong>等东西(项目设置&gt; General选项卡&gt; Your apps部分)。</p><p id="0476" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，创建一个名为<code class="fe le lf lg lh b">push-notification.service.ts</code>的服务，并在这里导入和解析<code class="fe le lf lg lh b">AngularFireMessaging</code>。</p><figure class="kt ku kv kw gt kx"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">推送通知. service.ts</figcaption></figure><p id="dbc7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要做的第一件事是初始化消息传递部分。在构造函数中，我们告诉AngularFireMessaging如何处理push消息何时到来以及FCM何时撤销我们的令牌。</p><p id="1faf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe le lf lg lh b">requestPermission</code>请求FCM给我们一个令牌。这也将触发浏览器要求用户自动允许推送通知。当您获得令牌时，应该将其保存到数据库中以备后用。这样您就可以发送特定于用户的通知。最佳做法是，要求用户在网站上停留一段时间后，首先允许推送通知。否则，他们会阻止它。</p><p id="d35c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe le lf lg lh b">receiveMessage</code>当您的应用标签为<em class="li">未激活</em> <strong class="jp ir">时，将返回可观察到的消息。</strong>因此，您不会看到自动创建的系统通知，而是会看到一个推送消息对象，并决定要做什么。您可以播放自己的应用内声音，这样干扰会更小，或者您可以像这样触发自己的系统通知:</p><pre class="kt ku kv kw gt np lh nq nr aw ns bi"><span id="0b5e" class="nt ll iq lh b gy nu nv l nw nx">new Notification(message.notification.title, {<br/>            body: message.notification.body<br/>});</span></pre><p id="744f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="li">您可以在此</em>  <em class="li">处更多了解</em> <a class="ae lj" href="https://www.w3.org/TR/notifications/" rel="noopener ugc nofollow" target="_blank"> <em class="li">通知。</em></a></p><p id="3641" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">您</strong>应该知道您的<em class="li">推送信息的安全性</em>没有保证。您可以加密/解密消息，也可以使用push作为触发器来调用您的API以获取完整的消息。</p><h1 id="5947" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">第3步:DotNet Core</h1><p id="883c" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">在最后一步，我们将呼叫FCM，让我们的用户发送我们的信息。Firebase提供了一个API，您可以开发自己的实现，但是我使用了一个名为<code class="fe le lf lg lh b">CorePush</code>的库。使用包管理器浏览并安装:</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ny"><img src="../Images/26717d71390eb3b105f59bd583e4e137.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FkKLCgrikMvnuuMt5VtNng.png"/></div></div></figure><p id="256e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或运行以下命令:</p><pre class="kt ku kv kw gt np lh nq nr aw ns bi"><span id="278a" class="nt ll iq lh b gy nu nv l nw nx">install-package corepush</span></pre><p id="4866" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装软件包后，您需要的唯一代码是下面的代码。</p><figure class="kt ku kv kw gt kx"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="b7c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意第3到9行。这是有效载荷的结构。你需要留着它。此外，在通知对象中，您应该将名称保留为<code class="fe le lf lg lh b">title</code>和<code class="fe le lf lg lh b">body</code>(区分大小写)。否则，前端将无法正确读取，因此您将无法显示正确的通知。</p><p id="48f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">而且，我建议将<code class="fe le lf lg lh b">serverKey</code>保留在<code class="fe le lf lg lh b">appsettings.json</code>中。为每个用户保存令牌也很重要。(请记住，用户可以拥有多台设备)。然后，您可以发送用户特定的通知。</p></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><p id="3131" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我用来实现推送通知的堆栈，它已经运行了很长时间。我创建了一个GitHub存储库来查看全局。如果文章或代码有问题，请随意指出。我希望它能帮助你解决问题。</p><p id="25c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以看到 n <a class="ae lj" href="https://github.com/mehmetural/push-notification-demo" rel="noopener ugc nofollow" target="_blank"> GitHub </a>的一个基本实现<a class="ae lj" href="https://github.com/mehmetural/push-notification-demo" rel="noopener ugc nofollow" target="_blank">。</a></p></div></div>    
</body>
</html>