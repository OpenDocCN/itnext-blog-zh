<html>
<head>
<title>Azure Event Hubs “Role Based Access Control” in action</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure事件中心“基于角色的访问控制”在起作用</h1>
<blockquote>原文：<a href="https://itnext.io/azure-event-hubs-role-based-access-control-in-action-2addd2dc31a3?source=collection_archive---------5-----------------------#2020-06-26">https://itnext.io/azure-event-hubs-role-based-access-control-in-action-2addd2dc31a3?source=collection_archive---------5-----------------------#2020-06-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="0574" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://docs.microsoft.com/azure/event-hubs/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure Event Hubs </a>是流媒体平台和事件摄取服务，每秒可以接收和处理数百万个事件。在这篇博客中，我们将讨论与Azure事件中心相关的一个安全方面。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/1b3765d445d1f7f51449b0fbcf07035f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wbyc3dOMXec1GXNI"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">约翰·萨尔维诺在<a class="ae kl" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="526c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lc ld le lf b">Shared Access Signature (SAS)</code>是Azure Event Hubs的一种常用认证机制，可用于对您想要授予的访问类型实施粒度控制——它通过在事件中心资源(名称空间或主题)上配置规则来工作。然而，建议您尽可能使用Azure AD凭证(通过<code class="fe lc ld le lf b">SAS</code>)，因为它提供了类似的功能，无需管理<code class="fe lc ld le lf b">SAS</code>令牌或担心撤销受损的<code class="fe lc ld le lf b">SAS</code>。</p><blockquote class="lg lh li"><p id="54de" class="jn jo lj jp b jq jr js jt ju jv jw jx lk jz ka kb ll kd ke kf lm kh ki kj kk ij bi translated"><em class="iq">要了解有关此主题的更多信息，请查看“</em> <a class="ae kl" href="https://docs.microsoft.com/azure/event-hubs/authenticate-shared-access-signature?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq">使用共享访问签名(SAS)验证对事件中心资源的访问</em> </a> <em class="iq">”。</em></p></blockquote><p id="cb35" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有几种方法可以做到这一点:</p><ul class=""><li id="4295" class="ln lo iq jp b jq jr ju jv jy lp kc lq kg lr kk ls lt lu lv bi translated">使用<a class="ae kl" href="https://docs.microsoft.com/azure/event-hubs/authenticate-managed-identity?tabs=latest&amp;WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">托管身份</a>或</li><li id="9fd6" class="ln lo iq jp b jq lw ju lx jy ly kc lz kg ma kk ls lt lu lv bi translated">通过在您的客户端应用程序中使用<a class="ae kl" href="https://docs.microsoft.com/azure/event-hubs/authenticate-application?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">服务主体</a></li></ul><p id="d31a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将探讨第二个选项，即如何在您的Azure Event Hubs客户端应用程序中使用基于Azure Active Directory的身份验证。通过一个实例，您将了解到:</p><ul class=""><li id="723d" class="ln lo iq jp b jq jr ju jv jy lp kc lq kg lr kk ls lt lu lv bi translated">Azure事件中心角色概述</li><li id="45d7" class="ln lo iq jp b jq lw ju lx jy ly kc lz kg ma kk ls lt lu lv bi translated">如何使用Azure CLI为事件中心配置服务主体和RBAC策略</li><li id="909e" class="ln lo iq jp b jq lw ju lx jy ly kc lz kg ma kk ls lt lu lv bi translated">Event Hubs通过特定的SDK支持多种编程语言，我们将看到如何将RBAC用于T4和T5客户端</li></ul><blockquote class="lg lh li"><p id="0aa9" class="jn jo lj jp b jq jr js jt ju jv jw jx lk jz ka kb ll kd ke kf lm kh ki kj kk ij bi translated"><em class="iq">该代码在本次GitHub回购中可用—</em><a class="ae kl" href="https://github.com/abhirockzz/azure-eventhubs-rbac-example" rel="noopener ugc nofollow" target="_blank"><em class="iq"/></a></p></blockquote></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="e1d6" class="mi mj iq bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">概观</h1><p id="abe7" class="pw-post-body-paragraph jn jo iq jp b jq ng js jt ju nh jw jx jy ni ka kb kc nj ke kf kg nk ki kj kk ij bi translated">本节提供了一个高层次的概述，帮助您理解关键术语:角色、安全原则和基于角色的访问控制(<code class="fe lc ld le lf b">RBAC</code>)。</p><p id="694b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">角色</strong> : Azure Event Hubs定义了特定的角色，每个角色都允许你对其资源采取特定的动作——<code class="fe lc ld le lf b">Data Owner</code>、<code class="fe lc ld le lf b">Data Sender</code>、<code class="fe lc ld le lf b">Data Receiver</code>。它们是不言自明的——发送者和接收者角色<em class="lj">仅</em>分别允许发送和接收，而所有者角色就像一个管理员权限，允许您完成访问。</p><blockquote class="lg lh li"><p id="50d0" class="jn jo lj jp b jq jr js jt ju jv jw jx lk jz ka kb ll kd ke kf lm kh ki kj kk ij bi translated"><em class="iq">有关这些角色的详细信息，请参考其文档链接— </em> <a class="ae kl" href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles?WT.mc_id=medium-blog-abhishgu#azure-event-hubs-data-owner" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> Azure Event Hubs数据所有者</em> </a> <em class="iq">，</em> <a class="ae kl" href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles?WT.mc_id=medium-blog-abhishgu#azure-event-hubs-data-sender" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> Azure Event Hubs数据发送者</em> </a> <em class="iq">，</em> <a class="ae kl" href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles?WT.mc_id=medium-blog-abhishgu#azure-event-hubs-data-receiver" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> Azure Event Hubs数据接收者</em> </a></p></blockquote><p id="6a28" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> RBAC，服务主体</strong>:服务主体是被授予这些角色的实体——这是“基于角色的访问控制”,因为您授予服务主体的角色定义了<em class="lj">他们可以执行哪些操作</em>—在这种情况下，这些操作是:发送、接收或一切！</p><h2 id="c4cb" class="nl mj iq bd mk nm nn dn mo no np dp ms jy nq nr mw kc ns nt na kg nu nv ne nw bi translated">…场景</h2><p id="6a72" class="pw-post-body-paragraph jn jo iq jp b jq ng js jt ju nh jw jx jy ni ka kb kc nj ke kf kg nk ki kj kk ij bi translated">这是我们将用来学习的例子。有两个事件中心客户端应用程序——一个Java生产者和一个Go消费者。我们将配置细粒度的规则(即实施RBAC ),以便:</p><ul class=""><li id="dee7" class="ln lo iq jp b jq jr ju jv jy lp kc lq kg lr kk ls lt lu lv bi translated">Java应用程序只能向事件中心主题发送消息，</li><li id="ec6c" class="ln lo iq jp b jq lw ju lx jy ly kc lz kg ma kk ls lt lu lv bi translated">Go应用程序只能从事件中心主题接收消息</li></ul><p id="7dbf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是相关的代码片段:</p><p id="f6d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Java producer客户端中，使用了<code class="fe lc ld le lf b"><a class="ae kl" href="https://docs.microsoft.com/java/api/com.azure.identity.defaultazurecredentialbuilder.defaultazurecredentialbuilder?view=azure-java-stable&amp;WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">DefaultAzureCredentialBuilder</a></code>。</p><pre class="kn ko kp kq gt nx lf ny nz aw oa bi"><span id="4d17" class="nl mj iq lf b gy ob oc l od oe">String eventhubsNamespace = System.getenv("EVENTHUBS_NAMESPACE");<br/>String eventhubName = System.getenv("EVENTHUB_NAME");</span><span id="9234" class="nl mj iq lf b gy of oc l od oe">EventHubProducerClient producer = new EventHubClientBuilder().credential(eventhubsNamespace, eventhubName, <strong class="lf ir">new DefaultAzureCredentialBuilder()</strong>.build()).buildProducerClient();</span></pre><p id="04c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">按照惯例(默认)，Java SDK尝试读取服务主体信息的预定义环境变量，并基于此进行身份验证。如果这不起作用，它就退回到尝试<code class="fe lc ld le lf b">SAS</code> auth机制，并寻找另一组环境变量</p><p id="2b1d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">类似地，在Go consumer客户端中，事件中心客户端的创建过程也大大简化了</p><pre class="kn ko kp kq gt nx lf ny nz aw oa bi"><span id="ba7b" class="nl mj iq lf b gy ob oc l od oe">ehNamespace := os.Getenv("EVENTHUBS_NAMESPACE")<br/>ehName := os.Getenv("EVENTHUB_NAME")</span><span id="5521" class="nl mj iq lf b gy of oc l od oe">hub, err := eventhub.<strong class="lf ir">NewHubWithNamespaceNameAndEnvironment</strong>(ehNamespace, ehName)</span></pre><blockquote class="lg lh li"><p id="d87f" class="jn jo lj jp b jq jr js jt ju jv jw jx lk jz ka kb ll kd ke kf lm kh ki kj kk ij bi translated"><em class="iq">开发人员的体验在SDK之间是一致的，</em> <code class="fe lc ld le lf b"><a class="ae kl" href="https://godoc.org/github.com/Azure/azure-event-hubs-go#NewHubWithNamespaceNameAndEnvironment" rel="noopener ugc nofollow" target="_blank"><em class="iq">NewHubWithNamespaceNameAndEnvironment</em></a></code> <em class="iq">与</em> <code class="fe lc ld le lf b"><em class="iq">DefaultAzureCredentialBuilder</em></code> <em class="iq">在遵循固定惯例方面做了相同的事情，首先尝试使用Azure Active Directory (AAD)支持的服务主体进行身份验证，然后是SAS机制</em></p></blockquote><p id="1c52" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">也就是说，您确实需要一些东西来完成本教程:</p></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="d198" class="mi mj iq bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">先决条件</h1><p id="ebad" class="pw-post-body-paragraph jn jo iq jp b jq ng js jt ju nh jw jx jy ni ka kb kc nj ke kf kg nk ki kj kk ij bi translated">你需要一个<a class="ae kl" href="https://docs.microsoft.com/azure/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">微软Azure账户</a>。去报名参加一个免费的吧！</p><p id="aece" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lc ld le lf b">Azure CLI</code>或者<code class="fe lc ld le lf b">Azure Cloud Shell</code>——你可以选择安装<a class="ae kl" href="https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a>如果你还没有的话(应该很快！)或者直接从你的浏览器使用<a class="ae kl" href="https://azure.microsoft.com/features/cloud-shell/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure云壳</a>。</p><p id="f845" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们走吧..从建立Azure活动中心开始</p></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="dd65" class="mi mj iq bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">设置Azure事件中心</h1><p id="8b64" class="pw-post-body-paragraph jn jo iq jp b jq ng js jt ju nh jw jx jy ni ka kb kc nj ke kf kg nk ki kj kk ij bi translated">这些都是通过Azure CLI完成的，但是如果你愿意，你也可以使用Azure Portal。最终目标是拥有一个<a class="ae kl" href="https://docs.microsoft.com/azure/event-hubs/event-hubs-features?WT.mc_id=medium-blog-abhishgu#namespace" rel="noopener ugc nofollow" target="_blank"> Azure事件中心名称空间</a>以及一个事件中心(又名主题)</p><p id="670d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果还没有Azure资源组，请创建一个</p><pre class="kn ko kp kq gt nx lf ny nz aw oa bi"><span id="d1e9" class="nl mj iq lf b gy ob oc l od oe">AZURE_SUBSCRIPTION=[to be filled]<br/>AZURE_RESOURCE_GROUP=[to be filled]<br/>AZURE_LOCATION=[to be filled]</span><span id="baf9" class="nl mj iq lf b gy of oc l od oe">az account set --subscription $AZURE_SUBSCRIPTION<br/>az group create --name $AZURE_RESOURCE_GROUP --location $AZURE_LOCATION</span></pre><p id="99cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<code class="fe lc ld le lf b"><a class="ae kl" href="https://docs.microsoft.com/cli/azure/eventhubs/namespace?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-eventhubs-namespace-create" rel="noopener ugc nofollow" target="_blank">az eventhubs namespace create</a></code>创建一个活动中心名称空间</p><pre class="kn ko kp kq gt nx lf ny nz aw oa bi"><span id="5ad4" class="nl mj iq lf b gy ob oc l od oe">EVENT_HUBS_NAMESPACE=[to be filled]</span><span id="16bc" class="nl mj iq lf b gy of oc l od oe">az eventhubs namespace create --name $EVENT_HUBS_NAMESPACE --resource-group $AZURE_RESOURCE_GROUP --location $AZURE_LOCATION  --enable-auto-inflate false</span></pre><p id="1d2d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后使用<code class="fe lc ld le lf b"><a class="ae kl" href="https://docs.microsoft.com/cli/azure/eventhubs/eventhub?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-eventhubs-eventhub-create" rel="noopener ugc nofollow" target="_blank">az eventhubs eventhub create</a></code>创建一个活动中心</p><pre class="kn ko kp kq gt nx lf ny nz aw oa bi"><span id="0b87" class="nl mj iq lf b gy ob oc l od oe">EVENT_HUB_NAME=[to be filled]</span><span id="7c80" class="nl mj iq lf b gy of oc l od oe">az eventhubs eventhub create --name $EVENT_HUB_NAME --resource-group $AZURE_RESOURCE_GROUP --namespace-name $EVENT_HUBS_NAMESPACE --partition-count 3</span></pre><p id="2fed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">..现在是关键部分…</p></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="b7fc" class="mi mj iq bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">…安全配置</h1><p id="a0c4" class="pw-post-body-paragraph jn jo iq jp b jq ng js jt ju nh jw jx jy ni ka kb kc nj ke kf kg nk ki kj kk ij bi translated">我们将使用Azure CLI通过<code class="fe lc ld le lf b"><a class="ae kl" href="https://docs.microsoft.com/cli/azure/ad/sp?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-ad-sp-create-for-rbac" rel="noopener ugc nofollow" target="_blank">az ad sp create-for-rbac</a></code>创建服务主体</p><p id="2e52" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于发送者应用程序(我们将其命名为<code class="fe lc ld le lf b">eh-sender-sp</code>)</p><pre class="kn ko kp kq gt nx lf ny nz aw oa bi"><span id="5df5" class="nl mj iq lf b gy ob oc l od oe">az ad sp create-for-rbac -n "eh-sender-sp"</span></pre><p id="207b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将得到这样一个JSON响应——请记下<code class="fe lc ld le lf b">appId</code>、<code class="fe lc ld le lf b">password</code>和<code class="fe lc ld le lf b">tenant</code></p><pre class="kn ko kp kq gt nx lf ny nz aw oa bi"><span id="fb19" class="nl mj iq lf b gy ob oc l od oe">{<br/>  "appId": "fe7280c7-5705-4789-b17f-71a472340429",<br/>  "displayName": "eh-sender-sp",<br/>  "name": "http://eh-sender-sp",<br/>  "password": "29c719dd-f2b3-46de-b71c-4004fb6116ee",<br/>  "tenant": "42f988bf-86f1-42af-91ab-2d7cd011db42"<br/>}</span></pre><p id="2546" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于接收器应用程序(我们将其命名为<code class="fe lc ld le lf b">eh-receiver-sp</code>)</p><pre class="kn ko kp kq gt nx lf ny nz aw oa bi"><span id="b75a" class="nl mj iq lf b gy ob oc l od oe">az ad sp create-for-rbac -n "eh-receiver-sp"</span></pre><p id="0a1c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将得到一个JSON响应——请记下<code class="fe lc ld le lf b">appId</code>、<code class="fe lc ld le lf b">password</code>和<code class="fe lc ld le lf b">tenant</code></p><blockquote class="lg lh li"><p id="dc03" class="jn jo lj jp b jq jr js jt ju jv jw jx lk jz ka kb ll kd ke kf lm kh ki kj kk ij bi translated"><em class="iq">您也可以使用Azure Portal来</em> <a class="ae kl" href="https://docs.microsoft.com/azure/active-directory/develop/quickstart-register-app?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq">创建服务主体</em> </a> <em class="iq">和</em> <a class="ae kl" href="https://docs.microsoft.com/azure/active-directory/develop/howto-create-service-principal-portal?WT.mc_id=medium-blog-abhishgu#create-a-new-application-secret" rel="noopener ugc nofollow" target="_blank"> <em class="iq">生成客户端秘密</em> </a></p></blockquote><h2 id="3f4b" class="nl mj iq bd mk nm nn dn mo no np dp ms jy nq nr mw kc ns nt na kg nu nv ne nw bi translated">强制RBAC</h2><p id="2e64" class="pw-post-body-paragraph jn jo iq jp b jq ng js jt ju nh jw jx jy ni ka kb kc nj ke kf kg nk ki kj kk ij bi translated">使用CLI完成这一过程需要几个步骤，但从长远来看是有益的，例如对自动化而言。也可以使用Azure门户网站来执行<a class="ae kl" href="https://docs.microsoft.com/azure/role-based-access-control/role-assignments-portal?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"/></p><p id="c2ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<code class="fe lc ld le lf b"><a class="ae kl" href="https://docs.microsoft.com/cli/azure/role/definition?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-role-definition-list" rel="noopener ugc nofollow" target="_blank">az role definition list</a></code>获取两个角色的id</p><pre class="kn ko kp kq gt nx lf ny nz aw oa bi"><span id="37a4" class="nl mj iq lf b gy ob oc l od oe">EH_SENDER_ROLE_ID=$(az role definition list -n "Azure Event Hubs Data Sender" -o tsv --query '[0].id')</span><span id="8645" class="nl mj iq lf b gy of oc l od oe">EH_RECEIVER_ROLE_ID=$(az role definition list -n "Azure Event Hubs Data Receiver" -o tsv --query '[0].id')</span></pre><blockquote class="lg lh li"><p id="7180" class="jn jo lj jp b jq jr js jt ju jv jw jx lk jz ka kb ll kd ke kf lm kh ki kj kk ij bi translated"><code class="fe lc ld le lf b"><em class="iq">Azure Event Hubs Data Sender</em></code><em class="iq"/><code class="fe lc ld le lf b"><em class="iq">Azure Event Hubs Data Receiver</em></code><em class="iq">是角色名</em></p></blockquote><p id="d5bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<code class="fe lc ld le lf b"><a class="ae kl" href="https://docs.microsoft.com/cli/azure/eventhubs/namespace?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-eventhubs-namespace-show" rel="noopener ugc nofollow" target="_blank">az eventhubs namespace show</a></code>获取Azure Event Hubs名称空间的订阅ID</p><pre class="kn ko kp kq gt nx lf ny nz aw oa bi"><span id="f90a" class="nl mj iq lf b gy ob oc l od oe">export RESOURCE_GROUP=[replace with resource group name]<br/>export EVENTHUBS_NAMESPACE=[replace with namespace]</span><span id="7c03" class="nl mj iq lf b gy of oc l od oe">EVENTHUBS_ID=$(az eventhubs namespace show --resource-group $RESOURCE_GROUP --name $EVENTHUBS_NAMESPACE -o tsv --query 'id')</span></pre><p id="ca9a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<code class="fe lc ld le lf b"><a class="ae kl" href="https://docs.microsoft.com/cli/azure/role/assignment?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-role-assignment-create" rel="noopener ugc nofollow" target="_blank">az role assignment create</a></code>分配角色</p><pre class="kn ko kp kq gt nx lf ny nz aw oa bi"><span id="29ab" class="nl mj iq lf b gy ob oc l od oe">export SENDER_SP_ID=[replace with Service Principal "appId" for the sender SP]</span><span id="51d4" class="nl mj iq lf b gy of oc l od oe">export RECEIVER_SP_ID=[replace with Service Principal "appId" for the receiver SP]</span><span id="b76d" class="nl mj iq lf b gy of oc l od oe">az role assignment create --assignee $SENDER_SP_ID --role $EH_SENDER_ROLE_ID --scope $EVENTHUBS_ID</span><span id="1a7b" class="nl mj iq lf b gy of oc l od oe">az role assignment create --assignee $RECEIVER_SP_ID --role $EH_RECEIVER_ROLE_ID --scope $EVENTHUBS_ID</span></pre><p id="0f96" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，你都准备好了！</p></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="afbd" class="mi mj iq bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">让我们试一试</h1><p id="bec8" class="pw-post-body-paragraph jn jo iq jp b jq ng js jt ju nh jw jx jy ni ka kb kc nj ke kf kg nk ki kj kk ij bi translated">从GitHub克隆示例应用程序</p><pre class="kn ko kp kq gt nx lf ny nz aw oa bi"><span id="6863" class="nl mj iq lf b gy ob oc l od oe">git clone <a class="ae kl" href="https://github.com/abhirockzz/azure-eventhubs-rbac-example.git" rel="noopener ugc nofollow" target="_blank">https://github.com/abhirockzz/azure-eventhubs-rbac-example.git</a></span></pre><p id="9c92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动Go消费者应用程序:</p><pre class="kn ko kp kq gt nx lf ny nz aw oa bi"><span id="7361" class="nl mj iq lf b gy ob oc l od oe">export EVENTHUBS_NAMESPACE=[replace with namespace]<br/>export EVENTHUB_NAME=[replace with name of the Event Hub]</span><span id="4eda" class="nl mj iq lf b gy of oc l od oe">export AZURE_TENANT_ID=[replace with Service Principal "tenant" for the receiver SP]</span><span id="40d5" class="nl mj iq lf b gy of oc l od oe">export AZURE_CLIENT_ID=[replace with Service Principal "appId" for the receiver SP]</span><span id="fb87" class="nl mj iq lf b gy of oc l od oe">export AZURE_CLIENT_SECRET=[replace with Service Principal "password" for the receiver SP]</span><span id="5088" class="nl mj iq lf b gy of oc l od oe">cd azure-eventhubs-rbac-example/consumer-go</span><span id="58ec" class="nl mj iq lf b gy of oc l od oe">go run main.go</span></pre><p id="8e37" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">程序将阻塞，等待事件…</p><p id="9002" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在另一个终端中，启动producer应用程序—这将只发送10个事件，然后退出(如果您想发送更多事件，请重新运行)</p><pre class="kn ko kp kq gt nx lf ny nz aw oa bi"><span id="1650" class="nl mj iq lf b gy ob oc l od oe">cd azure-eventhubs-rbac-example/producer-java</span><span id="db7b" class="nl mj iq lf b gy of oc l od oe">//build the Java app - it uses Maven<br/>mvn clean install</span><span id="e778" class="nl mj iq lf b gy of oc l od oe">export EVENTHUBS_NAMESPACE=[replace with namespace]<br/>export EVENTHUB_NAME=[replace with name of the Event Hub]</span><span id="dde3" class="nl mj iq lf b gy of oc l od oe">export AZURE_TENANT_ID=[replace with Service Principal "tenant" for the producer SP]</span><span id="f652" class="nl mj iq lf b gy of oc l od oe">export AZURE_CLIENT_ID=[replace with Service Principal "appId" for the producer SP]</span><span id="71aa" class="nl mj iq lf b gy of oc l od oe">export AZURE_CLIENT_SECRET=[replace with Service Principal "password" for the producer SP]</span><span id="8d4e" class="nl mj iq lf b gy of oc l od oe">java -jar target/eventhubs-java-producer-jar-with-dependencies.jar</span></pre><p id="fc7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您应该会在消费者应用程序终端中看到收到的事件！</p><blockquote class="lg lh li"><p id="98dc" class="jn jo lj jp b jq jr js jt ju jv jw jx lk jz ka kb ll kd ke kf lm kh ki kj kk ij bi translated"><em class="iq">作为一个练习，为了模拟一个错误场景，您可以交换发送者和消费者应用程序的客户端详细信息，以查看它们的行为。</em></p></blockquote></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="7fb1" class="mi mj iq bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">结论</h1><p id="135a" class="pw-post-body-paragraph jn jo iq jp b jq ng js jt ju nh jw jx jy ni ka kb kc nj ke kf kg nk ki kj kk ij bi translated">希望这有助于演示如何使用Azure Active Directory将RBAC用于事件中心应用程序。在以后的博客文章中，我将尝试讨论托管身份。在那之前，敬请期待！</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="og oh l"/></div></figure></div></div>    
</body>
</html>