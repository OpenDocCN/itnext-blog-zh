<html>
<head>
<title>Using Azure Application Gateway for an Intranet Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为内部网应用程序使用Azure应用程序网关</h1>
<blockquote>原文：<a href="https://itnext.io/using-azure-application-gateway-for-an-intranet-application-9009a91621ac?source=collection_archive---------1-----------------------#2022-03-23">https://itnext.io/using-azure-application-gateway-for-an-intranet-application-9009a91621ac?source=collection_archive---------1-----------------------#2022-03-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="e874" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">作为负载平衡器的应用网关简介</h1><p id="a76e" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">应用程序网关是来自Azure的强大的PaaS负载平衡器。它基于<a class="ae lj" href="https://www.networkworld.com/article/3239677/the-osi-model-explained-and-how-to-easily-remember-its-7-layers.html" rel="noopener ugc nofollow" target="_blank"> OSI模型第7层</a> —应用层路由。应用网关可以根据HTTP请求的附加属性(例如，URI路径或主机头)做出路由决策。<a class="ae lj" href="https://docs.microsoft.com/en-us/azure/application-gateway/overview" rel="noopener ugc nofollow" target="_blank"> Azure应用网关</a>可以做基于URL的路由等等。</p><p id="6239" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">有很多博客和文章解释了这是如何工作的，我就不赘述了<a class="ae lj" href="https://docs.microsoft.com/en-us/azure/application-gateway/quick-create-portal" rel="noopener ugc nofollow" target="_blank"> Azure文档</a>已经涵盖的细节。我主要关注的是为需要具有HTTP负载平衡能力的LB的内部网应用程序使用应用程序网关(否则选择<a class="ae lj" href="https://www.networkworld.com/article/3239677/the-osi-model-explained-and-how-to-easily-remember-its-7-layers.html" rel="noopener ugc nofollow" target="_blank"> OSI第4层</a> -TCP <a class="ae lj" href="https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-overview" rel="noopener ugc nofollow" target="_blank">负载平衡器</a>)。</p><h2 id="afbf" class="lp jo iq bd jp lq lr dn jt ls lt dp jx kw lu lv kb la lw lx kf le ly lz kj ma bi translated">路由往来于应用网关的流量</h2><p id="f2b4" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这是促使我写这篇长文的一个原因。</p><ol class=""><li id="bb5a" class="mb mc iq kn b ko lk ks ll kw md la me le mf li mg mh mi mj bi translated">当我们在应用网关监听器配置中使用公共IP时，我们不需要手动路由流量。</li><li id="822a" class="mb mc iq kn b ko mk ks ml kw mm la mn le mo li mg mh mi mj bi translated">当我们在应用网关监听器中使用私有IP时，如果VPN网关和应用网关之间没有防火墙，我们不需要手动路由流量。</li><li id="0730" class="mb mc iq kn b ko mk ks ml kw mm la mn le mo li mg mh mi mj bi translated"><strong class="kn ir">当我们在应用网关监听器中使用私有IP时，如果VPN网关和应用网关之间有防火墙，我们需要手动路由流量。</strong></li></ol><p id="34e5" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">使用多个专用网络和应用网关进行路由有时会很棘手。在本帖中，我将带您了解一个这样的案例，在VPN网关和应用程序网关之间有一个防火墙，而应用程序网关正在为内部应用程序路由流量(与上面的案例3相同)。</p><h2 id="6f9c" class="lp jo iq bd jp lq lr dn jt ls lt dp jx kw lu lv kb la lw lx kf le ly lz kj ma bi translated">用例解释</h2><p id="f6a2" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">部署在Oracle Weblogic Server上的Java EE应用程序在虚拟机上运行，该应用程序监听HTTP端口7001。目标是在通过点对点VPN连接时使用应用网关访问应用。</p><p id="e929" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">以下图(一种非常常见的架构)为例:</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi mp"><img src="../Images/f40551e39d8725ebd04929fe8c29c650.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HphwNhMwnCxxJ_pQ6jr8mA.png"/></div></div></figure><p id="e586" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><strong class="kn ir">上图中的一些要点:</strong></p><ul class=""><li id="9815" class="mb mc iq kn b ko lk ks ll kw md la me le mf li nb mh mi mj bi translated">内部用户使用Azure点到站点VPN进行连接。</li><li id="3b7c" class="mb mc iq kn b ko mk ks ml kw mm la mn le mo li nb mh mi mj bi translated">集线器虚拟网络有网关子网和AzureFirewallSubnet，而分支虚拟网络包含应用程序网关子网、堡垒子网和后端虚拟机所属的虚拟机子网。</li><li id="0951" class="mb mc iq kn b ko mk ks ml kw mm la mn le mo li nb mh mi mj bi translated">中心和分支与作为网关中转的中心对等，因为它有VPN网关。</li><li id="d962" class="mb mc iq kn b ko mk ks ml kw mm la mn le mo li nb mh mi mj bi translated">虚拟网络网关(VPN w2 SKU)具有P2S VPN配置。</li><li id="1760" class="mb mc iq kn b ko mk ks ml kw mm la mn le mo li nb mh mi mj bi translated">可以使用堡垒服务访问虚拟机</li><li id="c5a6" class="mb mc iq kn b ko mk ks ml kw mm la mn le mo li nb mh mi mj bi translated">应用网关配置为将<a class="ae lj" href="http://10.1.2.10/console/*" rel="noopener ugc nofollow" target="_blank"> http://10.1.2.10/console </a>或https://<a class="ae lj" href="http://10.1.2.10/console/*" rel="noopener ugc nofollow" target="_blank">10 . 1 . 2 . 10/console</a>(app GW内部IP)路由到<a class="ae lj" href="http://10.1.0.4:7001/console" rel="noopener ugc nofollow" target="_blank">http://10 . 1 . 0 . 4:7001/console</a>(VM内部IP)。应用程序网关图表的文本框说明了组件的配置。侦听器使用私有前端IP。</li><li id="e139" class="mb mc iq kn b ko mk ks ml kw mm la mn le mo li nb mh mi mj bi translated">离开地址前缀为10.1.0.0/16(分支Vnet的CIDR)的网关子网的流量被路由到下一跳10.0.1.4处的azure防火墙</li></ul><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nc"><img src="../Images/2f96d656d2aa8bd28c8c3c4acc614167.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F6gXlGWZ_czGutsqJ_TJKw.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">快照1</figcaption></figure><ul class=""><li id="ef7b" class="mb mc iq kn b ko lk ks ll kw md la me le mf li nb mh mi mj bi translated">离开地址前缀为0.0.0.0/0(所有内容)的虚拟机子网的流量被路由到下一跳azure防火墙10.0.1.4</li></ul><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nc"><img src="../Images/ec5419e3dc4d3519284ea45ede3c2a59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oaIyJ6sLCGtEQ-eUABBwDw.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">快照2</figcaption></figure><ul class=""><li id="56fb" class="mb mc iq kn b ko lk ks ll kw md la me le mf li nb mh mi mj bi translated">防火墙有一个允许规则，允许所有端口和所有协议从源IP地址空间10.90.0.0/24到分支vnet地址空间10.1.0.0/16的流量。此外，防火墙规则是有状态的，因此从分支vnet到VPN地址空间不需要额外的规则。</li></ul><p id="dea8" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这类似于通常使用的非常常见的架构(在本文中不考虑安全措施，因为这不是本文的重点)</p><h1 id="6a22" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">选择哪个应用网关SKU？</h1><h2 id="7e26" class="lp jo iq bd jp lq lr dn jt ls lt dp jx kw lu lv kb la lw lx kf le ly lz kj ma bi translated"><strong class="ak">应用网关标准v1 SKU </strong></h2><p id="1cc3" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">对于内部应用程序，不需要公共IP。最有可能的是，人们会倾向于选择<strong class="kn ir">应用网关标准v1 SKU </strong>，除非需要标准V2 或WAF v2的<a class="ae lj" href="https://docs.microsoft.com/en-us/azure/application-gateway/overview-v2#feature-comparison-between-v1-sku-and-v2-sku" rel="noopener ugc nofollow" target="_blank">特性。参考</a><a class="ae lj" href="https://docs.microsoft.com/en-us/azure/application-gateway/features" rel="noopener ugc nofollow" target="_blank"> Azure文档</a>了解SKU在功能和定价方面的功能和比较。</p><p id="b383" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">因为标准v1更便宜，并且需要根据URL路径进行HTTP负载平衡。SSL/TLS在应用网关本身终止。</p><p id="142f" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">离开地址前缀为0.0.0.0/0 (everything)的应用网关子网的流量被路由到下一跳10.0.1.4处的azure防火墙。</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nh"><img src="../Images/dd18b6acc2f28c90e2030186836e43b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xGgvqEOH0S0sLK8ZTdHyZQ.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">快照3</figcaption></figure><p id="fd4b" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在应用网关被提供并配置了后端之后，我们能够使用<a class="ae lj" href="http://10.1.2.10/console/*" rel="noopener ugc nofollow" target="_blank"> http://10.1.2.10/console </a>或https://<a class="ae lj" href="http://10.1.2.10/console/*" rel="noopener ugc nofollow" target="_blank">10 . 1 . 2 . 10/console</a>来访问应用。</p><p id="a095" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在这种情况下，当SSL在负载平衡器处终止时，Weblogic管理控制台的身份验证步骤需要传递一个<a class="ae lj" href="https://www.ateam-oracle.com/post/ssl-offloading-and-weblogic-server" rel="noopener ugc nofollow" target="_blank"> <strong class="kn ir">请求头(WL-代理-SSL=ON </strong> </a> <strong class="kn ir"> ) </strong>，我们无法使用带有标准v1 SKU的App Gateway来完成此操作，因为标头重写在标准v1 SKU中不可用。</p><h2 id="724b" class="lp jo iq bd jp lq lr dn jt ls lt dp jx kw lu lv kb la lw lx kf le ly lz kj ma bi translated">标准v2 SKU</h2><p id="4032" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">因此，标准v1被支持报头重写的标准v2 SKU所取代。<a class="ae lj" href="https://docs.microsoft.com/en-us/azure/application-gateway/overview-v2#feature-comparison-between-v1-sku-and-v2-sku" rel="noopener ugc nofollow" target="_blank">标准v2 SKU具有附加功能</a>。<strong class="kn ir">必须为公共IP提供标准v2 </strong>(即使不需要)。<strong class="kn ir">因此</strong> <a class="ae lj" href="https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-faq#how-do-i-use-application-gateway-v2-with-only-private-frontend-ip-address" rel="noopener ugc nofollow" target="_blank"> <strong class="kn ir"> App网关监听器被配置为使用私有前端IP </strong> </a> <strong class="kn ir">，公共IP未被使用。</strong></p><p id="f53b" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在使用标准v2 SKU配置新的应用网关，并为路由基于URL的流量进行所有配置后，我测试了对应用的访问，结果<strong class="kn ir">它不起作用。我可以在防火墙日志中看到访问细节。当使用公共IP作为监听器的前端IP(只是作为一个测试)，访问工作，但它不能与私有IP。</strong></p><h1 id="fa46" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">错过了什么？</h1><p id="296b" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kn ir">如果入口流量通过Azure防火墙作为下一跳进行路由，那么出口流量也应该通过Azure防火墙作为下一跳进行路由</strong>。看来我们错过了离开应用网关子网的流量路由。</p><p id="d127" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">我尝试将离开地址前缀为0.0.0.0/0 (everything)的应用网关子网的流量路由到10.0.1.4的azure防火墙作为下一跳，当应用网关SKU为标准v1时，这种方法有效，因为我们只选择了私有IP。但是标准v2应用网关子网同时具有与之关联的私有和公共IP，因此该路由无效且不被允许。<strong class="kn ir">简而言之，我们不能拥有Snapshot3 </strong>中的路线(如上图)。</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/228dcdf5235286d197b118efa96a6ddd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/format:webp/1*kWrVkbA4k4tqYHbz3ExkHA.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">快照4:在UDR中将0.0.0.0/0作为appgw子网的地址前缀时出错</figcaption></figure><p id="8394" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">那么，我们要将离开应用程序网关子网的流量路由到哪个地址前缀，下一跳是Azure防火墙？<strong class="kn ir">它应该回到从客户机发起连接的地方，也就是点到站点VPN地址空间。</strong></p><p id="f1cf" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">因此，我们创建了一条路由，通过地址前缀10.90.0.0/24将流量发送到应用网关，下一跳是Azure防火墙，当通过点到站点<strong class="kn ir"> </strong> VPN连接时会访问URL。</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nj"><img src="../Images/cfd2dbe8c2ebb7e024aca9a2d09fca2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HJvchEIaX37aMkMUVXBE_w.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">快照5</figcaption></figure><h2 id="b558" class="lp jo iq bd jp lq lr dn jt ls lt dp jx kw lu lv kb la lw lx kf le ly lz kj ma bi translated"><strong class="ak">对某些用户还是不起作用？</strong></h2><p id="5ac5" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我们在虚拟网络网关中也有一个S2S连接(图中没有)。因此，本地用户连接到分支Vnet，但他们无法访问该应用程序。这是因为用户通过另一个地址空间不同的VPN连接到本地网络。因此，我们可以编辑之前创建的路由，并将本地点对点VPN地址空间添加到该路由规则中</p></div></div>    
</body>
</html>