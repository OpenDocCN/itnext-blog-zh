<html>
<head>
<title>Implementing Video Playback on Android Jetpack Compose</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Android Jetpack Compose上实现视频播放</h1>
<blockquote>原文：<a href="https://itnext.io/implementing-video-playback-on-android-jetpack-compose-f73b437560ea?source=collection_archive---------1-----------------------#2022-08-19">https://itnext.io/implementing-video-playback-on-android-jetpack-compose-f73b437560ea?source=collection_archive---------1-----------------------#2022-08-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="edae" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">ExoPlayer的实践教程</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/38e1346170d03e3ec8e62c45a8276289.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*v3P72OUXzRiI0zmF"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">梅森·金巴罗夫斯基在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="59eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作为一名Android开发人员，您可能会遇到必须在Jetpack Compose应用程序中实现视频播放的任务。我也有同样的情况，开始研究这个话题，并找到了一个很好的解决方案，我在本教程中介绍了这个方案。</p><p id="cdf5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在研究这个话题时，我遇到了两个解决方案:</p><ol class=""><li id="24cb" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><a class="ae ky" href="https://developer.android.com/guide/topics/media/mediaplayer" rel="noopener ugc nofollow" target="_blank"> MediaPlayer </a>和</li><li id="a451" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://developer.android.com/guide/topics/media/exoplayer" rel="noopener ugc nofollow" target="_blank"> ExoPlayer </a></li></ol><p id="2b95" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我决定使用ExoPlayer，因为对我来说，它似乎是更灵活、功能更丰富的框架。此外，我得到的印象是这个框架被更广泛地使用，因此我能够找到更多关于它的例子和讨论。</p><p id="8a11" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">已经有很多容易找到的教程了，但是即使是最新的教程也使用了已经被废弃的代码。我以此为起点，更新了不推荐的部分。然后，我像往常一样去掉了所有不必要的和令人分心的部分，提出了最简单的工作解决方案。</p><p id="6cbe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">结果是一个最新的、功能齐全的Android Jetpack Compose应用程序，它获取一个视频文件的URL，并在应用程序中显示该视频。</p><p id="1899" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们从在Android Studio中创建新项目开始，并选择“空撰写活动”。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl mj"><img src="../Images/30fcb201eb2e20fa6953273452a47613.png" data-original-src="https://miro.medium.com/v2/format:webp/1*q2mMsiMCT2wcVh7QM17Ydw.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">新项目</figcaption></figure><p id="a9d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">像往常一样，我们需要为新的应用程序填写所有必要的位。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl mj"><img src="../Images/224cb3a30c6f3b3e1327a639dbb1da62.png" data-original-src="https://miro.medium.com/v2/format:webp/1*YBO6QQ0e3u-Mky1ucMKE6Q.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">新项目</figcaption></figure><p id="c8cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作为第一步，我们需要在<code class="fe mk ml mm mn b">build.gradle</code>中添加对ExoPlayer的依赖:</p><pre class="kj kk kl km gt mo mn mp mq aw mr bi"><span id="1272" class="ms mt it mn b gy mu mv l mw mx">implementation 'com.google.android.exoplayer:exoplayer:2.18.1'</span></pre><p id="7674" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我创建了一个名为<code class="fe mk ml mm mn b">VideoView</code>的新的可组合组件。这个视图封装了所有与ExoPlayer相关的代码。</p><p id="4334" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，需要添加的内容非常少。考虑到您的特定用例，您可能需要在这里或那里添加一些东西。在本教程的后面会有更多的介绍。</p><pre class="kj kk kl km gt mo mn mp mq aw mr bi"><span id="b8f7" class="ms mt it mn b gy mu mv l mw mx">@Composable<br/>fun VideoView(videoUri: String) {<br/>    val context = LocalContext.current<br/><br/>    val exoPlayer = ExoPlayer.Builder(LocalContext.current)<br/>        .build()<br/>        .also { exoPlayer -&gt;<br/>            val mediaItem = MediaItem.Builder()<br/>                .setUri(videoUri)<br/>                .build()<br/>            exoPlayer.setMediaItem(mediaItem)<br/>            exoPlayer.prepare()<br/>        }<br/><br/>    DisposableEffect(<br/>        AndroidView(factory = {<br/>            StyledPlayerView(context).apply {<br/>                player = exoPlayer<br/>            }<br/>        })<br/>    ) {<br/>        onDispose { exoPlayer.release() }<br/>    }<br/>}</span></pre><p id="a829" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们在这里停留一会儿，看看这段代码。</p><p id="8630" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有四点需要提一下。</p><ol class=""><li id="287c" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">我们需要通过调用构建器<code class="fe mk ml mm mn b">ExoPlayer.Builder</code>并提供当前的<code class="fe mk ml mm mn b">LocalContext</code>来设置我们的ExoPlayer实例<code class="fe mk ml mm mn b">exoPlayer</code></li><li id="28cb" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">之后，我们通过使用带有<code class="fe mk ml mm mn b">MediaItem.Builder()</code>的构建器模式从URI的视频中创建<code class="fe mk ml mm mn b">mediaItem</code></li><li id="96b1" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">然后我们创建一个做两件事的<code class="fe mk ml mm mn b">DisposableEffect</code>。当我们的可组合组件显示出来时，它将从我们的<code class="fe mk ml mm mn b">exoPlayer</code>实例中创建<code class="fe mk ml mm mn b">StyledPlayerView</code>。然后，当视图被释放时，它将释放我们的<code class="fe mk ml mm mn b">exoPlayer</code>-实例。</li></ol><p id="23a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请查看本文末尾的参考资料部分，我在那里提供了一些关于Jetpack Compose副作用的链接，特别是关于DisposableEffect的链接。</p><p id="46d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们把我们的<code class="fe mk ml mm mn b">MainActivity</code>换成使用<code class="fe mk ml mm mn b">VideoView</code>。最终结果如下所示:</p><pre class="kj kk kl km gt mo mn mp mq aw mr bi"><span id="6b8c" class="ms mt it mn b gy mu mv l mw mx">class MainActivity : ComponentActivity() {<br/>    override fun onCreate(savedInstanceState: Bundle?) {<br/>        super.onCreate(savedInstanceState)<br/>        setContent {<br/>            VideoApplicationTheme {<br/>                Surface(<br/>                    modifier = Modifier.fillMaxSize(),<br/>                    color = MaterialTheme.colors.background<br/>                ) {<br/>                    VideoView(videoUri = "https://storage.googleapis.com/exoplayer-test-media-0/BigBuckBunny_320x180.mp4")<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</span></pre><p id="74c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您也可以使用预览，然后需要进行如下更改:</p><pre class="kj kk kl km gt mo mn mp mq aw mr bi"><span id="9342" class="ms mt it mn b gy mu mv l mw mx">@Preview(showBackground = true)<br/>@Composable<br/>fun DefaultPreview() {<br/>    VideoApplicationTheme {<br/>        VideoView(videoUri = "https://storage.googleapis.com/exoplayer-test-media-0/BigBuckBunny_320x180.mp4")<br/>    }<br/>}</span></pre><p id="d8b0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">启动应用程序的一切都已就绪。等等！</p><p id="4866" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">几乎所有你可能已经发现的事情。尝试像这样启动应用程序将导致异常:</p><pre class="kj kk kl km gt mo mn mp mq aw mr bi"><span id="001e" class="ms mt it mn b gy mu mv l mw mx">E/LoadTask: Unexpected exception loading stream<br/>      java.lang.SecurityException: Permission denied (missing INTERNET permission?)<br/>        at java.net.Inet6AddressImpl.lookupHostByName(Inet6AddressImpl.java:150)<br/>        at java.net.Inet6AddressImpl.lookupAllHostAddr(Inet6AddressImpl.java:103)<br/>        at java.net.InetAddress.getAllByName(InetAddress.java:1152)<br/>        at com.android.okhttp.Dns$1.lookup(Dns.java:41)</span></pre><p id="b53d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为我们试图从互联网访问视频，我们首先需要允许我们的应用程序访问互联网。</p><p id="5758" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面一行需要添加到文件<code class="fe mk ml mm mn b">AndroidManifest.xml</code>(在<code class="fe mk ml mm mn b">app/manifests</code>下)</p><pre class="kj kk kl km gt mo mn mp mq aw mr bi"><span id="a225" class="ms mt it mn b gy mu mv l mw mx">&lt;uses-permission android:name="android.permission.INTERNET"&gt;&lt;/uses-permission&gt;</span></pre><p id="a7da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该文件如下所示:</p><pre class="kj kk kl km gt mo mn mp mq aw mr bi"><span id="e378" class="ms mt it mn b gy mu mv l mw mx">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;manifest xmlns:android="http://schemas.android.com/apk/res/android"<br/>    package="com.mycompany.videoapplication"&gt;<br/><br/>    &lt;uses-permission android:name="android.permission.INTERNET"&gt;&lt;/uses-permission&gt;<br/><br/>    &lt;application<br/>        android:allowBackup="true"<br/>        android:icon="@mipmap/ic_launcher"<br/>        android:label="@string/app_name"<br/>        android:roundIcon="@mipmap/ic_launcher_round"<br/>        android:supportsRtl="true"<br/>        android:theme="@style/Theme.VideoApplication"&gt;<br/>        &lt;activity<br/>            android:name=".MainActivity"<br/>            android:exported="true"<br/>            android:label="@string/app_name"<br/>            android:theme="@style/Theme.VideoApplication"&gt;<br/>            &lt;intent-filter&gt;<br/>                &lt;action android:name="android.intent.action.MAIN" /&gt;<br/><br/>                &lt;category android:name="android.intent.category.LAUNCHER" /&gt;<br/>            &lt;/intent-filter&gt;<br/>        &lt;/activity&gt;<br/>    &lt;/application&gt;<br/><br/>&lt;/manifest&gt;</span></pre><p id="dc94" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们启动应用程序，你应该看到如下所示的视频播放。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl mj"><img src="../Images/b38a61a43cfa1cc75917b33447322257.png" data-original-src="https://miro.medium.com/v2/1*8wU0Omg0veCuXvmWa1XqRg.gif"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">视频回放</figcaption></figure><p id="a32e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">希望一切都如其所愿。如果没有，请在评论中告诉我。</p><p id="6617" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如我所承诺的，我将为您提供更多的信息，告诉您如何使用几个配置选项来定制代码以满足您的潜在需求。</p><p id="568b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是一些您可能会觉得有用的用例:</p><ol class=""><li id="a5de" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">自动启动视频</li><li id="e158" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">隐藏控件</li><li id="0448" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">重复视频</li><li id="b2a0" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">更改纵横比</li></ol><p id="ea46" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以在视图加载后立即自动启动视频</p><pre class="kj kk kl km gt mo mn mp mq aw mr bi"><span id="6839" class="ms mt it mn b gy mu mv l mw mx">exoPlayer.playWhenReady = true</span></pre><p id="a8ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样。没什么好说的了。继续下一个。</p><p id="cdd1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您不想显示播放器的控件，您可以通过在<code class="fe mk ml mm mn b">SyledPlayerView</code>的设置中添加两行来隐藏它们。</p><pre class="kj kk kl km gt mo mn mp mq aw mr bi"><span id="1d0d" class="ms mt it mn b gy mu mv l mw mx">StyledPlayerView(context).apply {<br/>        hideController()<br/>    useController = false<br/><br/>    player = exoPlayer<br/>}</span></pre><p id="cf8c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mk ml mm mn b">exoPlayer</code>-实例也可以配置为无限重复播放视频。</p><pre class="kj kk kl km gt mo mn mp mq aw mr bi"><span id="8bcb" class="ms mt it mn b gy mu mv l mw mx">exoPlayer.repeatMode = Player.REPEAT_MODE_ALL</span></pre><p id="d6d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作为最后一个提示，对我来说也是非常重要的一个提示，纵横比也可以通过在<code class="fe mk ml mm mn b">exoPlayer</code>-实例中设置它来更改。下面的代码将视频填充并裁剪到视图中。</p><pre class="kj kk kl km gt mo mn mp mq aw mr bi"><span id="c1ff" class="ms mt it mn b gy mu mv l mw mx">exoPlayer.videoScalingMode = C.VIDEO_SCALING_MODE_SCALE_TO_FIT_WITH_CROPPING</span></pre><p id="4211" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我真诚地希望这篇教程对你有所帮助。请在评论中让我知道你是如何喜欢它的，尤其是如果在你尝试它的时候有任何代码被否决。</p><p id="41a3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您的阅读！</p><ul class=""><li id="1111" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu my mb mc md bi translated">如果你喜欢这个，请<a class="ae ky" href="https://twissmueller.medium.com/" rel="noopener">在Medium </a>上跟随我</li><li id="cc98" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu my mb mc md bi translated">给我买杯咖啡让我继续前进</li><li id="45e6" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu my mb mc md bi translated">支持我和其他媒体作者<a class="ae ky" href="https://twissmueller.medium.com/membership" rel="noopener">在这里注册</a></li></ul><div class="mz na gp gr nb nc"><a href="https://twissmueller.medium.com/membership" rel="noopener follow" target="_blank"><div class="nd ab fo"><div class="ne ab nf cl cj ng"><h2 class="bd iu gy z fp nh fr fs ni fu fw is bi translated">通过我的推荐链接加入媒体</h2><div class="nj l"><h3 class="bd b gy z fp nh fr fs ni fu fw dk translated">阅读托拜厄斯·维斯缪勒(Tobias Wissmueller)的每一个故事(以及媒体上成千上万的其他作家)。您的会员费直接…</h3></div><div class="nk l"><p class="bd b dl z fp nh fr fs ni fu fw dk translated">twissmueller.medium.com</p></div></div><div class="nl l"><div class="nm l nn no np nl nq ks nc"/></div></div></a></div><h2 id="1567" class="ms mt it bd nr ns nt dn nu nv nw dp nx li ny nz oa lm ob oc od lq oe of og oh bi translated">资源</h2><ul class=""><li id="dc04" class="lv lw it lb b lc oi lf oj li ok lm ol lq om lu my mb mc md bi translated"><a class="ae ky" href="https://exoplayer.dev" rel="noopener ugc nofollow" target="_blank"> ExoPlayer </a></li><li id="2da3" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu my mb mc md bi translated"><a class="ae ky" href="https://github.com/google/ExoPlayer" rel="noopener ugc nofollow" target="_blank"> ExoPlayer GitHub </a></li><li id="929e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu my mb mc md bi translated"><a class="ae ky" href="https://medium.com/backyard-programmers/media3-exoplayer-in-jetpack-compose-to-make-snapchat-spotlight-75e384e2ef56" rel="noopener">Jetpack中的Media3 ExoPlayer作曲让Snapchat成为焦点</a></li><li id="a54f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu my mb mc md bi translated"><a class="ae ky" href="https://developer.android.com/codelabs/exoplayer-intro#0" rel="noopener ugc nofollow" target="_blank">使用ExoPlayer进行流媒体播放</a></li><li id="c071" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu my mb mc md bi translated"><a class="ae ky" href="https://developer.android.com/jetpack/compose/side-effects#disposableeffect" rel="noopener ugc nofollow" target="_blank">作曲中的副作用</a></li><li id="5371" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu my mb mc md bi translated"><a class="ae ky" href="https://developer.android.com/jetpack/compose/side-effects#disposableeffect" rel="noopener ugc nofollow" target="_blank">一次性效果:需要清理的效果</a></li></ul></div></div>    
</body>
</html>