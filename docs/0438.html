<html>
<head>
<title>Build and publish a v-drag directive to npm</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为npm构建并发布v-drag指令</h1>
<blockquote>原文：<a href="https://itnext.io/making-and-publishing-a-v-drag-directive-to-npm-6d20a80dedba?source=collection_archive---------4-----------------------#2018-03-10">https://itnext.io/making-and-publishing-a-v-drag-directive-to-npm-6d20a80dedba?source=collection_archive---------4-----------------------#2018-03-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/758e03389a6a9749b289617187d4a009.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*UOIVWWaqXiMjclHQOmKQRw.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">图片来自<a class="ae jy" href="http://vegibit.com/vue-js-directives/" rel="noopener ugc nofollow" target="_blank">http://vegibit.com/vue-js-directives/</a></figcaption></figure><p id="fb7d" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">自定义指令是Vue.js API的一个强大部分。让我们来看看如何构建一个定制的<code class="fe kx ky kz la b">v-drag</code>指令，并将其发布到NPM，以及一个测试套件。</p><p id="f675" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我们将构建一个简单的指令，允许任何元素成为<code class="fe kx ky kz la b">draggable</code>。下面是一个快速预览:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi lb"><img src="../Images/e0b235f0eca47edfca349e1b55297c19.png" data-original-src="https://miro.medium.com/v2/resize:fit:664/1*4frAAKNzdCvJ6INF4kGOTw.gif"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">v-drag，我们正在构建的指令。</figcaption></figure><p id="9975" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">使用这样的标记:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="9842" class="lk ll iq la b gy lm ln l lo lp">&lt;template&gt;<br/>  &lt;div v-drag&gt;<br/>  &lt;/div&gt;<br/>&lt;/template&gt; </span></pre><p id="3f5c" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">演示项目源代码在此处为<a class="ae jy" href="https://github.com/lmiller1990/vue-drag/tree/article" rel="noopener ugc nofollow" target="_blank"/>，最终指令代码在此处为<a class="ae jy" href="https://github.com/lmiller1990/vue-drag¥" rel="noopener ugc nofollow" target="_blank"/>。最后，发布的包是<a class="ae jy" href="https://www.npmjs.com/package/@branu-jp/v-drag" rel="noopener ugc nofollow" target="_blank">这里的</a>。</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><figure class="lc ld le lf gt jr gh gi paragraph-image"><a href="http://vuejs-course.com/"><div class="gh gi lx"><img src="../Images/8860e8ef1f39967845929ca6a9e3821a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g_RGGAoqizZjbVse93Z4TQ.png"/></div></a><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">来看看我的<a class="ae jy" href="https://vuejs-course.com/" rel="noopener ugc nofollow" target="_blank"> Vue.js 3课程</a>！我们涵盖了组合API、类型脚本、单元测试、Vuex和Vue路由器。</figcaption></figure></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><h2 id="70d3" class="lk ll iq bd ly lz ma dn mb mc md dp me kk mf mg mh ko mi mj mk ks ml mm mn mo bi translated">设置</h2><p id="3636" class="pw-post-body-paragraph jz ka iq kb b kc mp ke kf kg mq ki kj kk mr km kn ko ms kq kr ks mt ku kv kw ij bi translated">首先，我们将使用<code class="fe kx ky kz la b">vue-cli</code>搭建一个新项目。如果你还没有安装，运行<code class="fe kx ky kz la b">npm install vue-cli -g</code>。然后使用<code class="fe kx ky kz la b">vue init webpack-simple dragger</code>创建一个新项目。</p><p id="47c9" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">创建应用程序后，在<code class="fe kx ky kz la b">src/App.vue</code>中，删除现有标记并创建添加以下内容:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="daf0" class="lk ll iq la b gy lm ln l lo lp">&lt;template&gt;<br/>  &lt;div id="outer"&gt;<br/>    &lt;div id="dragger" v-drag&gt;&lt;/div&gt;<br/>  &lt;/div&gt;<br/>&lt;/template&gt;</span><span id="614f" class="lk ll iq la b gy mu ln l lo lp">&lt;script&gt;<br/>import drag from './drag'</span><span id="bde2" class="lk ll iq la b gy mu ln l lo lp">export default {<br/>  name: 'app'</span><span id="a7b1" class="lk ll iq la b gy mu ln l lo lp">directives: {<br/>    drag<br/>  }<br/>}<br/>&lt;/script&gt;</span><span id="caa1" class="lk ll iq la b gy mu ln l lo lp">&lt;style&gt;<br/>body {<br/>  height: 100vh;<br/>}</span><span id="9526" class="lk ll iq la b gy mu ln l lo lp">#outer {<br/>  height: 100%;<br/>}</span><span id="2012" class="lk ll iq la b gy mu ln l lo lp">#dragger {<br/>  position: absolute;<br/>  border: 1px solid red;<br/>  width: 100px;<br/>  height: 100px;<br/>}<br/>&lt;/style&gt;</span></pre><p id="a86a" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我们的指令将在<code class="fe kx ky kz la b">drag.js</code>中生效。继续在与<code class="fe kx ky kz la b">App.vue</code>相同的级别上创建它，并添加以下内容:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="ddb7" class="lk ll iq la b gy lm ln l lo lp">import Vue from 'vue'</span><span id="47b2" class="lk ll iq la b gy mu ln l lo lp">export default Vue.directive('drag', {<br/>  inserted: function (el, binding, vnode) {<br/>    console.log('Drag.js')<br/>  } <br/>})</span></pre><p id="65cf" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">运行<code class="fe kx ky kz la b">npm run dev</code>启动app，访问<code class="fe kx ky kz la b">localhost:8080</code>。您应该会在控制台中看到“Drag.js ”:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/112925135a7d64c6ebf4ead131a47edb.png" data-original-src="https://miro.medium.com/v2/resize:fit:968/format:webp/1*NbKYR0IapwO0ytdfwz-xXA.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">Drag.js指令。</figcaption></figure><p id="074a" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">注意上面的<code class="fe kx ky kz la b">inserted</code>功能。Vue指令有几个对开发人员公开的钩子。我们将使用<code class="fe kx ky kz la b">inserted</code>，它在元素被安装时被调用(就像<code class="fe kx ky kz la b">mounted</code>钩子组件暴露一样)。我们还将使用<code class="fe kx ky kz la b">unbind</code>，当指令被解除绑定时，当组件被从DOM中移除时，就会调用这个函数。</p><h2 id="f24d" class="lk ll iq bd ly lz ma dn mb mc md dp me kk mf mg mh ko mi mj mk ks ml mm mn mo bi translated">检测元素何时被单击</h2><p id="a108" class="pw-post-body-paragraph jz ka iq kb b kc mp ke kf kg mq ki kj kk mr km kn ko ms kq kr ks mt ku kv kw ij bi translated">下一步将是检测用户何时用<code class="fe kx ky kz la b">v-drag</code>点击元素。当用户点击该元素时，我们将设置一个<code class="fe kx ky kz la b">down</code>布尔值为<code class="fe kx ky kz la b">true</code>，当用户放开时则相反。我们还将保存x和y坐标，以便在移动时计算元素的位置。</p><p id="95a6" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">将以下内容添加到<code class="fe kx ky kz la b">drag.js</code>:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="97f3" class="lk ll iq la b gy lm ln l lo lp">const data = {<br/>  down: false,<br/>  initialX: 0,<br/>  initialY: 0<br/>}</span><span id="097c" class="lk ll iq la b gy mu ln l lo lp">export function mousedown (e, el, _data) {<br/>  _data.down = true<br/>  _data.initialX = e.clientX<br/>  _data.initialY = e.clientY<br/>}</span><span id="90ae" class="lk ll iq la b gy mu ln l lo lp">export function mouseup (e, el, _data) {<br/>  _data.down = false<br/>}</span><span id="8854" class="lk ll iq la b gy mu ln l lo lp">export default Vue.directive('drag', {<br/>  inserted: function (el, binding, vnode) {<br/>    el.addEventListener('mouseup', (e) =&gt; mouseup(e, el))<br/>    el.addEventListener('mousedown', (e) =&gt; mousedown(e, el))<br/>  } <br/>})</span></pre><p id="273b" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><code class="fe kx ky kz la b">inserted</code>接收三个参数:元素本身，一个<code class="fe kx ky kz la b">binding</code>对象和<code class="fe kx ky kz la b">vnode</code>，前者有一堆我们不会用到的属性，后者由Vue的编译器和虚拟dom使用。我们将把<code class="fe kx ky kz la b">mouseup</code>和<code class="fe kx ky kz la b">mousedown</code>事件绑定到元素上。<code class="fe kx ky kz la b">v-drag</code>将使用的数据将保存在<code class="fe kx ky kz la b">data</code>中。然后我们将<code class="fe kx ky kz la b">data</code>对象传递给任何需要它的函数——这将使测试函数变得更容易。</p><h2 id="84de" class="lk ll iq bd ly lz ma dn mb mc md dp me kk mf mg mh ko mi mj mk ks ml mm mn mo bi translated">开玩笑的测试</h2><p id="f704" class="pw-post-body-paragraph jz ka iq kb b kc mp ke kf kg mq ki kj kk mr km kn ko ms kq kr ks mt ku kv kw ij bi translated">在继续之前，让我们写一些测试。我们将使用令人敬畏的测试库..继续安装Jest和一些支持包。</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="e19e" class="lk ll iq la b gy lm ln l lo lp">npm install jest babel-preset-env babel-jest --save-dev</span></pre><p id="09d5" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">你还需要用新的<code class="fe kx ky kz la b">env</code>更新<code class="fe kx ky kz la b">.babelrc</code>，这是我从Jest <a class="ae jy" href="https://facebook.github.io/jest/docs/en/getting-started.html" rel="noopener ugc nofollow" target="_blank">文档</a>中了解到的。</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="97fb" class="lk ll iq la b gy lm ln l lo lp">{<br/>  "presets": [<br/>    ["env", { "modules": false }],<br/>    "stage-3"<br/>  ],<br/>  "env": {<br/>    "test": {<br/>      "presets": [["env"]]<br/>    }<br/>  }<br/>}</span></pre><p id="3d73" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">在<code class="fe kx ky kz la b">src</code>里面做一个<code class="fe kx ky kz la b">__tests__</code>文件夹，给它加一个<code class="fe kx ky kz la b">drag.test.js</code>。该项目现在看起来像这样:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi mw"><img src="../Images/cf44027325507ece41b6c1e13ceaf792.png" data-original-src="https://miro.medium.com/v2/resize:fit:626/format:webp/1*T4QzzCHbh2vIduglW1bNJw.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">项目层次结构</figcaption></figure><p id="2a36" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">让我们从测试<code class="fe kx ky kz la b">mouseup</code>和<code class="fe kx ky kz la b">mousedown</code>开始。将以下内容添加到<code class="fe kx ky kz la b">drag.test.js</code>。还要确保将<code class="fe kx ky kz la b">export</code>添加到<code class="fe kx ky kz la b">drag.js</code>中的两个函数中，以便它们能够被导入到测试中。</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="60a0" class="lk ll iq la b gy lm ln l lo lp">import { mouseup, mousedown } from '../drag.js'</span><span id="5d47" class="lk ll iq la b gy mu ln l lo lp">describe('drag', () =&gt; {  <br/>  describe('mouseup', () =&gt; {<br/>    it('sets down = false', () =&gt; {<br/>      const data = {<br/>        down: true<br/>      }</span><span id="a789" class="lk ll iq la b gy mu ln l lo lp">      mouseup(undefined, undefined, data)<br/>      expect(data.down).toBe(false)<br/>    })<br/>  })</span><span id="417e" class="lk ll iq la b gy mu ln l lo lp">  describe('mousedown', () =&gt; {<br/>    it('sets down = true and initial mouse position', () =&gt; {<br/>      const data = { <br/>        initialX: 0,<br/>        initialY: 0,<br/>        down: false<br/>      }</span><span id="92d4" class="lk ll iq la b gy mu ln l lo lp">      const evt = {<br/>        clientX: 1,<br/>        clientY: 1<br/>      }</span><span id="9301" class="lk ll iq la b gy mu ln l lo lp">      mousedown(evt, undefined, data) <br/>      expect(data.down).toBe(true)<br/>      expect(data.initialX).toBe(1)<br/>      expect(data.initialY).toBe(1)<br/>    })<br/>  })<br/>})</span></pre><p id="f4f0" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">向<code class="fe kx ky kz la b">package.json</code>添加新行:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="771f" class="lk ll iq la b gy lm ln l lo lp">"scripts": {<br/>  "test": "jest"<br/>}</span></pre><p id="d0a7" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">现在您可以使用<code class="fe kx ky kz la b">npm run test</code>运行测试套件。</p><p id="07df" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">当前out指令在被点击时仍然不“做”任何事情，但是随着测试套件的建立，我们已经准备好了。</p><h2 id="21ae" class="lk ll iq bd ly lz ma dn mb mc md dp me kk mf mg mh ko mi mj mk ks ml mm mn mo bi translated">计算移动和偏移</h2><p id="1ae7" class="pw-post-body-paragraph jz ka iq kb b kc mp ke kf kg mq ki kj kk mr km kn ko ms kq kr ks mt ku kv kw ij bi translated">为了计算元素被拖动时的位置，我们应该保存元素被单击时的初始位置。我们用一个<code class="fe kx ky kz la b">setInitialOffset</code>函数来做吧。</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="a994" class="lk ll iq la b gy lm ln l lo lp">const _data = {<br/>  /* other variables */  <br/>  draggerOffsetLeft: 0,<br/>  draggerOffsetTop: 0<br/>}</span><span id="b6f1" class="lk ll iq la b gy mu ln l lo lp">export function setDraggerOffset (el, _data) {<br/>  _data.draggerOffsetLeft = el.offsetLeft<br/>  _data.draggerOffsetTop = el.offsetTop<br/>}</span></pre><p id="a7a0" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">和一个快速测试来确保它的工作:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="36af" class="lk ll iq la b gy lm ln l lo lp">describe('setInitialOffset', () =&gt; {<br/>  it('sets the initial offset of the element', () =&gt; {<br/>    const data = {<br/>      draggerOffsetLeft: 0,<br/>      draggerOffsetTop: 0<br/>    }<br/>    const el = {<br/>      offsetLeft: 1,<br/>      offsetTop: 1<br/>    }</span><span id="7d59" class="lk ll iq la b gy mu ln l lo lp">    setDraggerOffset(el, data)<br/>    expect(data.draggerOffsetLeft).toBe(1)<br/>    expect(data.draggerOffsetTop).toBe(1)<br/>  })<br/>})</span></pre><p id="2b2f" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">太好了。让我们通过调用<code class="fe kx ky kz la b">inserted</code>中的<code class="fe kx ky kz la b">setInitialOffset</code>来设置安装元素时的初始偏移量。</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="c297" class="lk ll iq la b gy lm ln l lo lp">export default Vue.directive('drag', {<br/>  inserted: function (el, binding, vnode) {<br/>    el.addEventListener('mouseup', (e) =&gt; mouseup(e, el, _data))<br/>    el.addEventListener('mousedown', (e) =&gt; mousedown(e, el, _data))<br/>    setDraggerOffset(el, _data)<br/>  }<br/>})</span></pre><p id="289a" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">如果你把<code class="fe kx ky kz la b">console.log(_data)</code>加到<code class="fe kx ky kz la b">mousedown</code>中，仔细检查一切都正常。点击将记录<code class="fe kx ky kz la b">_data</code>物体。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/b71c935c7a90f4fccf32adde70f6cf44.png" data-original-src="https://miro.medium.com/v2/resize:fit:734/format:webp/1*ao9A32QbE3Wabyl46y8M0Q.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">保存元素的初始偏移量。</figcaption></figure><h2 id="c9e1" class="lk ll iq bd ly lz ma dn mb mc md dp me kk mf mg mh ko mi mj mk ks ml mm mn mo bi translated">移动元素</h2><p id="9cb2" class="pw-post-body-paragraph jz ka iq kb b kc mp ke kf kg mq ki kj kk mr km kn ko ms kq kr ks mt ku kv kw ij bi translated">我们再加一个<code class="fe kx ky kz la b">mousemove</code>功能。如果<code class="fe kx ky kz la b">_data.down</code>为真，我们将计算元素的新位置，并更新<code class="fe kx ky kz la b">style.top</code>和<code class="fe kx ky kz la b">style.left</code>值。</p><p id="ff5f" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">先说<code class="fe kx ky kz la b">_data.down</code>为<em class="nc">假</em>的情况。我们应该什么都不做。一个测试看起来像这样:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="3be4" class="lk ll iq la b gy lm ln l lo lp">describe('mousemove', () =&gt; {<br/>  it('does nothing is down === false', () =&gt; {<br/>    const data = {<br/>      down: false<br/>    }<br/>    const el = {<br/>      style: {<br/>        left: 0,<br/>        top: 0<br/>      }<br/>    }</span><span id="cc61" class="lk ll iq la b gy mu ln l lo lp">    mousemove(undefined, el, data)</span><span id="45bf" class="lk ll iq la b gy mu ln l lo lp">    expect(el.style.left).toBe(0)<br/>    expect(el.style.top).toBe(0)<br/>  })<br/>})</span></pre><p id="ef38" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我们断言元素的样式不会改变。现在是激动人心的部分，移动元素。该公式如下所示:</p><p id="d023" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">elementNewLeft = elementInitialLeft+(mouse newx-mouse initialx)</p><p id="9625" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">这些价值观我们都有！</p><ul class=""><li id="8e16" class="nd ne iq kb b kc kd kg kh kk nf ko ng ks nh kw ni nj nk nl bi translated">elementNewLeft: <code class="fe kx ky kz la b">el.style.left</code></li><li id="946c" class="nd ne iq kb b kc nm kg nn kk no ko np ks nq kw ni nj nk nl bi translated">elementInitialLeft: <code class="fe kx ky kz la b">_data.draggerOffsetLeft</code></li><li id="2673" class="nd ne iq kb b kc nm kg nn kk no ko np ks nq kw ni nj nk nl bi translated">mouseNewX: <code class="fe kx ky kz la b">e.clientX</code>。(我们将传入客户端事件)</li><li id="abb4" class="nd ne iq kb b kc nm kg nn kk no ko np ks nq kw ni nj nk nl bi translated">mouseInitialX: <code class="fe kx ky kz la b">_data.initialX</code></li></ul><p id="a040" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">因此，在代码中:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="4f1c" class="lk ll iq la b gy lm ln l lo lp">export function mousemove (e, el, _data) {<br/>  if (_data.down) {<br/>    el.style.left = _data.draggerOffsetLeft + (e.clientX - _data.initialX) + 'px'<br/>    el.style.top = _data.draggerOffsetTop + (e.clientY - _data.initialY) + 'px'<br/>  }<br/>}</span></pre><p id="e0ab" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">并在<code class="fe kx ky kz la b">inserted</code>中添加监听器:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="ffa3" class="lk ll iq la b gy lm ln l lo lp">export default Vue.directive('drag', {<br/>  inserted: function (el, binding, vnode) {<br/>    el.addEventListener('mouseup', (e) =&gt; mouseup(e, el, _data))<br/>    el.addEventListener('mousedown', (e) =&gt; mousedown(e, el, _data))<br/>    el.addEventListener('mousemove', (e) =&gt; mousemove(e, el, _data))<br/>    setDraggerOffset(el, _data)<br/>  }<br/>})</span></pre><p id="a3a1" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">这应该足够让箱子动起来了！</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi lb"><img src="../Images/e0b235f0eca47edfca349e1b55297c19.png" data-original-src="https://miro.medium.com/v2/resize:fit:664/1*4frAAKNzdCvJ6INF4kGOTw.gif"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">有用！</figcaption></figure><p id="f344" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">让我们添加一个测试:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="e870" class="lk ll iq la b gy lm ln l lo lp">describe('mousemove', () =&gt; {<br/>  it('updates the element style if down === true', () =&gt; {<br/>    const data = {<br/>      down: true,<br/>      initialX: 10,<br/>      initialY: 10,<br/>      draggerOffsetLeft: 0,<br/>      draggerOffsetTop: 0<br/>    }<br/>    const e = {<br/>      clientX: 20, // clientX - initialX. 20 - 10 = 10<br/>      clientY: 20<br/>    }<br/>    const el = {<br/>      style: {<br/>        left: 0,<br/>        top: 0<br/>      }<br/>    }</span><span id="31bd" class="lk ll iq la b gy mu ln l lo lp">    mousemove(e, el, data)</span><span id="1c44" class="lk ll iq la b gy mu ln l lo lp">    expect(el.style.left).toBe('10px')<br/>    expect(el.style.top).toBe('10px')<br/>  })<br/>})</span></pre><p id="0d5c" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">有一些小虫子。首先，你只能绘制元素一次——我们应该在<code class="fe kx ky kz la b">mouseup</code>中重置元素的初始偏移量。</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="f436" class="lk ll iq la b gy lm ln l lo lp">export function mouseup (e, el, _data) {<br/>  _data.down = false<br/>  setDraggerOffset(el, _data)<br/>}</span></pre><p id="1df9" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">现在测试失败了。使用模拟<code class="fe kx ky kz la b">el</code>更新测试。</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="86c0" class="lk ll iq la b gy lm ln l lo lp">describe('mouseup', () =&gt; {<br/>  it('sets down = false', () =&gt; {<br/>    const el = {}<br/>    const data = {<br/>      down: true<br/>    }<br/>  <br/>    mouseup(undefined, el, data)<br/>    expect(data.down).toBe(false)<br/>  })<br/>})</span></pre><p id="3283" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">测试套件又变绿了。还有更多改进——如果用户快速拖动鼠标，它离开了元素，<code class="fe kx ky kz la b">mouseup</code>就不会被调用，元素的行为就会不正确。为了简洁起见，让我们继续发布模块。</p><h2 id="d9b3" class="lk ll iq bd ly lz ma dn mb mc md dp me kk mf mg mh ko mi mj mk ks ml mm mn mo bi translated">发布到NPM</h2><p id="dd66" class="pw-post-body-paragraph jz ka iq kb b kc mp ke kf kg mq ki kj kk mr km kn ko ms kq kr ks mt ku kv kw ij bi translated">尽管我们使用了一个<code class="fe kx ky kz la b">vue-cli</code>项目来构建指令。当发布时，我们希望有一点不同的项目设置。我们希望默认导出是指令，并将代码编译成ES5，以确保在任何浏览器中的正确行为。创建一个新文件夹<code class="fe kx ky kz la b">v-drag</code>，并初始化一个新的节点项目:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="e1d0" class="lk ll iq la b gy lm ln l lo lp">npm init -y</span></pre><p id="38c9" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">并安装一些软件包:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="ec3d" class="lk ll iq la b gy lm ln l lo lp">npm install babel-cli  babel-preset-env rimraf --save-dev</span></pre><p id="de71" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我们需要babel来编译，每次发布时需要rimraf来清除编译好的<code class="fe kx ky kz la b">lib</code>文件。</p><p id="1023" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">更新<code class="fe kx ky kz la b">package.json</code>:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="ee63" class="lk ll iq la b gy lm ln l lo lp">{<br/>  "name": "<a class="ae jy" href="http://twitter.com/branu" rel="noopener ugc nofollow" target="_blank">@branu</a>-jp/v-drag",<br/>  "version": "0.0.1",<br/>  "description": "A Vue.js draggable directive",<br/>  "main": "index.js",<br/>  "dependencies": {},<br/>  "devDependencies": {<br/>    "babel-cli": "^6.26.0",<br/>    "babel-preset-env": "^1.6.1",<br/>    "rimraf": "^2.6.2"<br/>  },<br/>  "main": "lib/index.js",<br/>  "scripts": {<br/>    "start": "babel-node src",<br/>    "build": "rimraf lib &amp;&amp; babel src -d lib --ignore src/__tests__"<br/>  },<br/>  "repository": {<br/>    "type": "git",<br/>    "url": "<a class="ae jy" href="https://github.com/branu-ws/v-drag" rel="noopener ugc nofollow" target="_blank">https://github.com/branu-ws/v-drag</a>"<br/>  },<br/>  "keywords": [],<br/>  "author": "BRANU",<br/>  "license": "MIT"<br/>}</span></pre><p id="d3d1" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">确保更新了<code class="fe kx ky kz la b">name</code>属性。我正在发布一个有作用域的包，更多信息可以在<a class="ae jy" href="https://docs.npmjs.com/misc/scope" rel="noopener ugc nofollow" target="_blank"> npm文档</a>中找到。还要注意我们有一个<code class="fe kx ky kz la b">build</code>脚本，它将把<code class="fe kx ky kz la b">src</code>文件夹中的任何代码编译到<code class="fe kx ky kz la b">lib</code>文件夹中。</p><p id="8436" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">创建一个<code class="fe kx ky kz la b">src</code>文件夹，在里面添加一个<code class="fe kx ky kz la b">index.js</code>文件，指令代码来自<code class="fe kx ky kz la b">drag.js</code>。</p><p id="ec79" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我们还应该将<code class="fe kx ky kz la b">__tests__</code>添加到<code class="fe kx ky kz la b">src</code>文件夹，并将它们更新为从<code class="fe kx ky kz la b">index.js</code>导入，而不是从<code class="fe kx ky kz la b">drag.js</code>导入。最后，我们想安装Vue作为一个<code class="fe kx ky kz la b">peerDependency</code>，<code class="fe kx ky kz la b">v-drag</code>假设Vue安装在任何使用它的项目中。</p><p id="9405" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">为了发布，我们运行<code class="fe kx ky kz la b">npm run build</code>，它在<code class="fe kx ky kz la b">lib</code>文件夹中编译成ES5。</p><p id="8b1e" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">现在只需运行<code class="fe kx ky kz la b">npm publish</code>。如果您以前没有发布到npm，您将看到一个错误:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="7f68" class="lk ll iq la b gy lm ln l lo lp">npm ERR! code ENEEDAUTH<br/>npm ERR! need auth auth required for publishing<br/>npm ERR! need auth You need to authorize this machine using `npm adduser`</span></pre><p id="11f4" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">如果你还没有账户，在<a class="ae jy" href="https://www.npmjs.com/" rel="noopener ugc nofollow" target="_blank"> npm </a>上创建。然后继续运行<code class="fe kx ky kz la b">npm adduser</code>，并添加您的详细信息。然后<code class="fe kx ky kz la b">npm publish</code>，你的包就活了。你应该看看</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="9030" class="lk ll iq la b gy lm ln l lo lp">+ <a class="ae jy" href="http://twitter.com/branu" rel="noopener ugc nofollow" target="_blank">@branu</a>-jp/v-drag@0.0.2</span></pre><p id="b4bb" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">如果一切顺利。我的副本在这里直播<a class="ae jy" href="https://www.npmjs.com/package/@branu-jp/v-drag" rel="noopener ugc nofollow" target="_blank"/>。现在，它可以像任何其他软件包一样安装。以我为例，<code class="fe kx ky kz la b">npm install @branu-jp/v-drag</code>。</p><h2 id="64d4" class="lk ll iq bd ly lz ma dn mb mc md dp me kk mf mg mh ko mi mj mk ks ml mm mn mo bi translated">下一步？</h2><p id="564a" class="pw-post-body-paragraph jz ka iq kb b kc mp ke kf kg mq ki kj kk mr km kn ko ms kq kr ks mt ku kv kw ij bi translated">继续尝试发布一个包吧！我将做一些事情来改善我的套餐:</p><ul class=""><li id="d2fd" class="nd ne iq kb b kc kd kg kh kk nf ko ng ks nh kw ni nj nk nl bi translated">添加一个自述文件，解释如何安装和使用您的软件包</li><li id="80df" class="nd ne iq kb b kc nm kg nn kk no ko np ks nq kw ni nj nk nl bi translated">添加演示</li></ul><p id="5596" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">演示代码为<a class="ae jy" href="https://github.com/lmiller1990/vue-drag/tree/article" rel="noopener ugc nofollow" target="_blank">此处为</a>(文章分支)，发布的模块代码为<a class="ae jy" href="https://github.com/branu-ws/v-drag" rel="noopener ugc nofollow" target="_blank">此处为</a>。</p></div></div>    
</body>
</html>