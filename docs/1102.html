<html>
<head>
<title>Building an operator for Kubernetes with operator-sdk</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用operator-sdk为Kubernetes构建一个操作符</h1>
<blockquote>原文：<a href="https://itnext.io/building-an-operator-for-kubernetes-with-operator-sdk-40a029ea056?source=collection_archive---------4-----------------------#2018-07-22">https://itnext.io/building-an-operator-for-kubernetes-with-operator-sdk-40a029ea056?source=collection_archive---------4-----------------------#2018-07-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f63577133de729f6e05d3f5adf206ec1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1o45xV_PhnEqS8gS2moi4w.png"/></div></div></figure><ul class=""><li id="1641" class="jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated"><a class="ae kq" href="https://medium.com/p/b4204be9ad56" rel="noopener">本系列的第一篇文章</a>探索了样本控制器。</li><li id="1fd2" class="jy jz iq ka b kb kr kd ks kf kt kh ku kj kv kl km kn ko kp bi translated"><a class="ae kq" href="https://medium.com/p/17cbd3f07761" rel="noopener">该系列的第二篇文章</a>探索了kubebuilder。</li><li id="1a8a" class="jy jz iq ka b kb kr kd ks kf kt kh ku kj kv kl km kn ko kp bi translated">第三篇文章将探索operator-sdk</li></ul><p id="4eb4" class="pw-post-body-paragraph kw kx iq ka b kb kc ky kz kd ke la lb kf lc ld le kh lf lg lh kj li lj lk kl ij bi translated">你可以在我的新书中了解更多关于使用Kubernetes API和操作符的信息:<a class="ae kq" href="https://bit.ly/3vsuwI9" rel="noopener ugc nofollow" target="_blank">https://bit.ly/3vsuwI9</a></p><h1 id="cb96" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">操作员-sdk</h1><p id="8c96" class="pw-post-body-paragraph kw kx iq ka b kb mj ky kz kd mk la lb kf ml ld le kh mm lg lh kj mn lj lk kl ij bi translated">现在让我们探索operator-sdk套件，并创建相同的CRD和操作员。记住，我们想要编写一个操作符，它将在集群的节点上部署一个守护进程。它将使用<code class="fe mo mp mq mr b">DaemonSet</code>对象来部署这个守护进程，我们希望能够指定一个标签，以便只在标记有该标签的节点上部署守护进程。我们还希望能够指定要部署的Docker映像。</p><h2 id="ac37" class="ms lm iq bd ln mt mu dn lr mv mw dp lv kf mx my lz kh mz na md kj nb nc mh nd bi translated">装置</h2><p id="d048" class="pw-post-body-paragraph kw kx iq ka b kb mj ky kz kd mk la lb kf ml ld le kh mm lg lh kj mn lj lk kl ij bi translated">按照以下步骤安装operator-sdk:</p><pre class="ne nf ng nh gt ni mr nj nk aw nl bi"><span id="ac41" class="ms lm iq mr b gy nm nn l no np">go get github.com/operator-framework/operator-sdk<br/>cd $GOPATH/src/github.com/operator-framework/operator-sdk<br/>make dep<br/>make install</span></pre><h2 id="c3e4" class="ms lm iq bd ln mt mu dn lr mv mw dp lv kf mx my lz kh mz na md kj nb nc mh nd bi translated">开始一个项目</h2><p id="b36f" class="pw-post-body-paragraph kw kx iq ka b kb mj ky kz kd mk la lb kf ml ld le kh mm lg lh kj mn lj lk kl ij bi translated">让我们创建操作符。我们需要在GOPATH下创建我们的项目:</p><pre class="ne nf ng nh gt ni mr nj nk aw nl bi"><span id="c89d" class="ms lm iq mr b gy nm nn l no np">mkdir -p $GOPATH/src/mydomain.com/mygroup2 &amp;&amp; cd $_</span></pre><p id="658c" class="pw-post-body-paragraph kw kx iq ka b kb kc ky kz kd ke la lb kf lc ld le kh lf lg lh kj li lj lk kl ij bi translated">然后启动项目:</p><pre class="ne nf ng nh gt ni mr nj nk aw nl bi"><span id="04a5" class="ms lm iq mr b gy nm nn l no np">operator-sdk new app-operator --api-version=mygroup2.mydomain.com/v1beta1 --kind=GenericDaemon</span></pre><h2 id="9a6f" class="ms lm iq bd ln mt mu dn lr mv mw dp lv kf mx my lz kh mz na md kj nb nc mh nd bi translated">写一些代码</h2><p id="4e53" class="pw-post-body-paragraph kw kx iq ka b kb mj ky kz kd mk la lb kf ml ld le kh mm lg lh kj mn lj lk kl ij bi translated">我们需要修改我们的<code class="fe mo mp mq mr b">GenericDaemon</code>的结构，为我们的对象添加必要的字段。</p><pre class="ne nf ng nh gt ni mr nj nk aw nl bi"><span id="a8a4" class="ms lm iq mr b gy nm nn l no np">// pkg/apis/mygroup2/v1beta1/types.go<br/>[...]<br/>type GenericDaemonSpec struct {<br/> // Label is the value of the 'daemon=' label to set on a node that should run the daemon<br/> Label string `json:"label"`<br/> // Image is the Docker image to run for the daemon<br/> Image string `json:"image"`<br/>}<br/>type GenericDaemonStatus struct {<br/> // Count is the number of nodes the daemon is deployed to<br/> Count int32 `json:"count"`<br/>}</span></pre><p id="632c" class="pw-post-body-paragraph kw kx iq ka b kb kc ky kz kd ke la lb kf lc ld le kh lf lg lh kj li lj lk kl ij bi translated">然后创建协调处理程序:</p><pre class="ne nf ng nh gt ni mr nj nk aw nl bi"><span id="d4f4" class="ms lm iq mr b gy nm nn l no np">/// pkg/stub/handler.go<br/>func (h *Handler) Handle(ctx context.Context, event sdk.Event) error {<br/>  switch o := event.Object.(type) {<br/>  case *v1beta1.GenericDaemon:<br/>    genericdaemon := o<br/>    logrus.Info("handle GenericDaemon")<br/>    ds := newDaemonset(o)<br/>    err := sdk.Create(ds)<br/>    if err != nil &amp;&amp; !errors.IsAlreadyExists(err) {<br/>      logrus.Errorf("Failed to create daemonset : %v", err)<br/>      return err<br/>    }<br/>    err = sdk.Get(ds)<br/>    if err != nil {<br/>      logrus.Errorf("failed to get daemonset: %v", err)<br/>      return err<br/>    }<br/>    if genericdaemon.Status.Count != ds.Status.NumberReady {<br/>      genericdaemon.Status.Count = ds.Status.NumberReady<br/>      err = sdk.Update(genericdaemon)<br/>      if err != nil {<br/>        logrus.Errorf("failed to update genericdaemon status: %v", err)<br/>        return err<br/>      }<br/>    }<br/>  }<br/>  return nil<br/>}</span><span id="2a51" class="ms lm iq mr b gy nq nn l no np">func newDaemonset(cr *v1beta1.GenericDaemon) *appsv1.DaemonSet {<br/>  return &amp;appsv1.DaemonSet{<br/>    TypeMeta: metav1.TypeMeta{<br/>      Kind:       "DaemonSet",<br/>      APIVersion: "apps/v1",<br/>    },<br/>    ObjectMeta: metav1.ObjectMeta{<br/>      Name:      cr.Name + "-daemonset",<br/>      Namespace: cr.Namespace,<br/>      OwnerReferences: []metav1.OwnerReference{<br/>        *metav1.NewControllerRef(cr, schema.GroupVersionKind{<br/>          Group:   v1beta1.SchemeGroupVersion.Group,<br/>          Version: v1beta1.SchemeGroupVersion.Version,<br/>          Kind:    "GenericDaemon",<br/>        }),<br/>      },<br/>    },<br/>    Spec: appsv1.DaemonSetSpec{<br/>      Selector: &amp;metav1.LabelSelector{<br/>        MatchLabels: map[string]string{"daemonset": cr.Name + "-daemonset"},<br/>      },<br/>      Template: corev1.PodTemplateSpec{<br/>        ObjectMeta: metav1.ObjectMeta{<br/>          Labels: map[string]string{"daemonset": cr.Name + "-daemonset"},<br/>        },<br/>        Spec: corev1.PodSpec{<br/>          NodeSelector: map[string]string{"daemon": cr.Spec.Label},<br/>          Containers: []corev1.Container{<br/>            {<br/>              Name:  "genericdaemon",<br/>              Image: cr.Spec.Image,<br/>            },<br/>          },<br/>        },<br/>      },<br/>    },<br/>  }<br/>}</span></pre><h2 id="9db3" class="ms lm iq bd ln mt mu dn lr mv mw dp lv kf mx my lz kh mz na md kj nb nc mh nd bi translated">部署和播放</h2><p id="1626" class="pw-post-body-paragraph kw kx iq ka b kb mj ky kz kd mk la lb kf ml ld le kh mm lg lh kj mn lj lk kl ij bi translated">仅此而已！我们现在可以重新构建操作符和映像，并推送映像，最后部署我们的项目:</p><pre class="ne nf ng nh gt ni mr nj nk aw nl bi"><span id="f2df" class="ms lm iq mr b gy nm nn l no np">operator-sdk build mydockerid/genericdaemon2<br/>docker push mydockerid/genericdaemon2<br/>kubectl create -f deploy/rbac.yaml<br/>kubectl create -f deploy/crd.yaml<br/>kubectl create -f deploy/operator.yaml</span></pre><p id="983a" class="pw-post-body-paragraph kw kx iq ka b kb kc ky kz kd ke la lb kf lc ld le kh lf lg lh kj li lj lk kl ij bi translated">此时，操作员应该正在运行:</p><pre class="ne nf ng nh gt ni mr nj nk aw nl bi"><span id="8f6a" class="ms lm iq mr b gy nm nn l no np">$ kubectl get pods<br/>NAME                           READY     STATUS    RESTARTS   AGE<br/>app-operator-65bf4777f7-8lx9m   1/1       Running   0          4s<br/></span></pre><p id="53b8" class="pw-post-body-paragraph kw kx iq ka b kb kc ky kz kd ke la lb kf lc ld le kh lf lg lh kj li lj lk kl ij bi translated">我们现在可以个性化生成的<code class="fe mo mp mq mr b">GenericDaemon</code>样本:</p><pre class="ne nf ng nh gt ni mr nj nk aw nl bi"><span id="1c55" class="ms lm iq mr b gy nm nn l no np">// deploy/cr.yaml<br/>apiVersion: mygroup2.mydomain.com/v1beta1<br/>kind: GenericDaemon<br/>metadata:<br/>  name: example<br/>spec:<br/>  <strong class="mr ir">image: httpd<br/>  label: http</strong></span></pre><p id="65e6" class="pw-post-body-paragraph kw kx iq ka b kb kc ky kz kd ke la lb kf lc ld le kh lf lg lh kj li lj lk kl ij bi translated">并创建它:</p><pre class="ne nf ng nh gt ni mr nj nk aw nl bi"><span id="1060" class="ms lm iq mr b gy nm nn l no np">$ kubectl apply -f deploy/cr.yaml</span><span id="fcd7" class="ms lm iq mr b gy nq nn l no np">$ kubectl get genericdaemon<br/>NAME      AGE<br/><strong class="mr ir">example</strong>   5s</span><span id="9bc4" class="ms lm iq mr b gy nq nn l no np">$ kubectl get daemonset<br/>NAME                <strong class="mr ir">READY</strong> [...]  NODE SELECTOR<br/>example-daemonset   <strong class="mr ir">0</strong>     [...]  <strong class="mr ir">daemon=http</strong></span><span id="0988" class="ms lm iq mr b gy nq nn l no np">$ kubectl describe genericdaemons example<br/>[...]<br/>Spec:<br/>  Image:  httpd<br/>  Label:  http<br/><strong class="mr ir">Status:<br/>  Count:  0</strong></span><span id="6aaa" class="ms lm iq mr b gy nq nn l no np">$ kubectl label nodes mynode1 daemon=http</span><span id="fae5" class="ms lm iq mr b gy nq nn l no np">$ kubectl get daemonset<br/>NAME                <strong class="mr ir">READY</strong> [...]  NODE SELECTOR<br/>example-daemonset   <strong class="mr ir">1</strong>     [...]  <strong class="mr ir">daemon=http</strong></span><span id="af12" class="ms lm iq mr b gy nq nn l no np">$ kubectl describe genericdaemons example<br/>[...]<br/>Spec:<br/>  Image:  httpd<br/>  Label:  http<br/><strong class="mr ir">Status:<br/>  Count:  1</strong></span></pre><h2 id="d531" class="ms lm iq bd ln mt mu dn lr mv mw dp lv kf mx my lz kh mz na md kj nb nc mh nd bi translated">结论</h2><p id="bcb0" class="pw-post-body-paragraph kw kx iq ka b kb mj ky kz kd mk la lb kf ml ld le kh mm lg lh kj mn lj lk kl ij bi translated">operator-sdk的使用与kubebuilder相当。它在原生Kubernetes API的基础上引入了一个新的API，如果您习惯了这个API，可能会感到困惑，但是它简化了代码和概念。</p><p id="6309" class="pw-post-body-paragraph kw kx iq ka b kb kc ky kz kd ke la lb kf lc ld le kh lf lg lh kj li lj lk kl ij bi translated">这是一个预alpha版本，缺少一些为我们的操作代码生成的测试。</p></div></div>    
</body>
</html>