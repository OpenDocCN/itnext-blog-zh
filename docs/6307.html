<html>
<head>
<title>AWS: Lambda — copy EC2 tags to its EBS, part 1 — Python and boto3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS: Lambda —将EC2标签复制到它的EBS，第1部分— Python和boto3</h1>
<blockquote>原文：<a href="https://itnext.io/aws-lambda-copy-ec2-tags-to-its-ebs-part-1-python-and-boto3-73d7bf171aef?source=collection_archive---------4-----------------------#2021-10-13">https://itnext.io/aws-lambda-copy-ec2-tags-to-its-ebs-part-1-python-and-boto3-73d7bf171aef?source=collection_archive---------4-----------------------#2021-10-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/4116eb2906df88b0d6fcf1c7806264e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:730/format:webp/1*6dXEkU-sfm3IrnC9WoL1QA.png"/></div></figure><p id="f436" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们有一个AWS弹性Kubernetes服务集群，它有一些WorkerNode组，这些组是通过使用<code class="fe ks kt ku kv b">eksctl</code>作为AWS自动伸缩组创建的，请参见<a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/aws-lambda-copy-ec2-tags-to-its-ebs-part-2-create-a-lambda-function-7edf7945ab84?source=friends_link&amp;sk=0831333cb4f6b3301c5945bb6ac3cdb5"> AWS弹性Kubernetes服务:集群创建自动化，第2部分–ansi ble，eksctl </a>了解更多详细信息。</p><p id="6b11" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe ks kt ku kv b">eksctl</code>的WorkerNode组配置保留了一组标记，我们的团队使用这些标记来查看AWS清单:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="e0cf" class="lf lg iq kv b gy lh li l lj lk">---<br/>apiVersion: eksctl.io/v1alpha5<br/>kind: ClusterConfig<br/><br/>metadata:<br/>  name: "{{ eks_cluster_name }}"<br/>  region: "{{ region }}"<br/>  version: "{{ k8s_version }}"<br/><br/>nodeGroups:<br/><br/>### Common ###<br/><br/>  - name: "{{ k8s_common_nodegroup_name }}-{{ item }}-v2021-09"<br/>    instanceType: "{{ k8s_common_nodegroup_instance_type }}"<br/>    privateNetworking: true<br/>    labels:<br/>      role: common-workers<br/>    ...<br/>    tags:<br/>      Tier: "Devops"<br/>      Domain: "eks.devops.{{ region }}.{{ env | lower }}.bttrm.local"<br/>      ServiceType: "EC2"<br/>      Env: {{ env }}<br/>      Function: "Kubernetes WorkerNode"<br/>      NetworkType: "Private"<br/>      DataClass: "Public"<br/>      AssetOwner: "{{ asset_owner }}"<br/>      AssetCustodian: "{{ asset_custodian }}"<br/>      OperatingSystem: "Amazon Linux"<br/>      JiraTicket: "{{ jira_ticket }}"<br/>      ConfidentialityRequirement: "Med"<br/>      IntegrityRequirement: "Med"<br/>      AvailabilityRequirement: "Med"<br/>...</span></pre><p id="a0c7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这些标签应用于自动缩放组:</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="gh gi ll"><img src="../Images/25dfb7e9713dd16e0398d20de9e02ef4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/0*zMnvO2KyOjQzQewi.png"/></div></figure><p id="a96e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后应用于从该自动缩放组创建的EC2实例。</p><p id="7efc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里的问题是，这些标签没有被复制到附加到这个EC2的弹性块存储设备。</p><p id="f1af" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，除了Kubernetes WorkerNodes之外，在我们的AWS帐户中，我们有公共EC2实例，其中一些实例只能有一个根设备，而其他实例可以有一些额外的磁盘来备份数据。</p><p id="f44c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，我们不仅需要从它的EC2中复制标签，而且我还想添加一个专用标签，描述磁盘的功能— <em class="lm">根卷</em>、<em class="lm">数据卷</em> или <em class="lm"> Kubernetes PVC卷</em>。</p><p id="d994" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们如何做到这一点？嗯，就像AWS控制台没有覆盖的AWS中的几乎任何东西一样，通过使用AWS Lambda服务:让我们创建一个函数，它将在新EC2启动时被触发，并将此EC2的标记复制到所有EBS卷，连接到此实例。</p><p id="3878" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">那么，在这个AWS Lambda函数的逻辑中，我们需要输出什么:</p><ol class=""><li id="9a0c" class="ln lo iq jw b jx jy kb kc kf lp kj lq kn lr kr ls lt lu lv bi translated">创建新的EC2时—触发Lambda函数</li><li id="f399" class="ln lo iq jw b jx lw kb lx kf ly kj lz kn ma kr ls lt lu lv bi translated">该函数将获取EC2 ID，并将找到所有相关的EBS卷</li><li id="2018" class="ln lo iq jw b jx lw kb lx kf ly kj lz kn ma kr ls lt lu lv bi translated">会将AWS标签从该EC2复制到其所有EBS</li><li id="913b" class="ln lo iq jw b jx lw kb lx kf ly kj lz kn ma kr ls lt lu lv bi translated">将添加一个名为<em class="lm">角色</em>的新标签:</li><li id="2b0d" class="ln lo iq jw b jx lw kb lx kf ly kj lz kn ma kr ls lt lu lv bi translated">如果EBS是从Kubernetes PVC创建的，并且安装到EC2，从Kubernetes WorkerNode AWS自动缩放组启动，那么我们将设置标签<code class="fe ks kt ku kv b">Role: "PvcVolume"</code></li><li id="f35f" class="ln lo iq jw b jx lw kb lx kf ly kj lz kn ma kr ls lt lu lv bi translated">如果EBS是在通用EC2创建期间创建的，那么将检查其挂载点，并决定使用哪个值— <code class="fe ks kt ku kv b">Role: "RootVolume"</code>或<code class="fe ks kt ku kv b">Role: "DataVolume"</code></li></ol><p id="342c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们走吧。</p><h1 id="09f7" class="mb lg iq bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated"><strong class="ak">内容</strong></h1><ul class=""><li id="ae0a" class="ln lo iq jw b jx my kb mz kf na kj nb kn nc kr nd lt lu lv bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-lambda-copy-ec2-tags-to-its-ebs-part-1-python-and-boto3/#Python_script_copy_AWS_Tags" rel="noopener ugc nofollow" target="_blank"> Python脚本:复制AWS标签</a></li><li id="f2fe" class="ln lo iq jw b jx lw kb lx kf ly kj lz kn ma kr nd lt lu lv bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-lambda-copy-ec2-tags-to-its-ebs-part-1-python-and-boto3/#boto3_getting_a_list_of_EC2_instances_and_their_EBS_volumes" rel="noopener ugc nofollow" target="_blank"> boto3:获取EC2实例及其EBS卷的列表</a></li><li id="daeb" class="ln lo iq jw b jx lw kb lx kf ly kj lz kn ma kr nd lt lu lv bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-lambda-copy-ec2-tags-to-its-ebs-part-1-python-and-boto3/#boto3_adding_AWS_Tags_to_an_EBS" rel="noopener ugc nofollow" target="_blank"> boto3:向EBS添加AWS标签</a></li><li id="2df5" class="ln lo iq jw b jx lw kb lx kf ly kj lz kn ma kr nd lt lu lv bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-lambda-copy-ec2-tags-to-its-ebs-part-1-python-and-boto3/#boto3_copy_AWS_Tags_from_an_EC2_to_its_EBS" rel="noopener ugc nofollow" target="_blank"> boto3:将AWS标签从EC2复制到其EBS </a></li></ul><h1 id="f8db" class="mb lg iq bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">Python脚本:复制AWS标签</h1><p id="d129" class="pw-post-body-paragraph ju jv iq jw b jx my jz ka kb mz kd ke kf ne kh ki kj nf kl km kn ng kp kq kr ij bi translated">首先，让我们写一个Pythion脚本，测试它，然后在这篇文章的第二部分进入AWS Lambda。</p><p id="2930" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">当我们适应一个Lambda函数时，我们将对它进行快速更新，使它可以使用一个专用的EC2 ID。</p><h2 id="7ee0" class="lf lg iq bd mc nh ni dn mg nj nk dp mk kf nl nm mo kj nn no ms kn np nq mw nr bi translated"><code class="fe ks kt ku kv b">boto3</code>:获取EC2实例及其EBS卷的列表</h2><p id="103c" class="pw-post-body-paragraph ju jv iq jw b jx my jz ka kb mz kd ke kf ne kh ki kj nf kl km kn ng kp kq kr ij bi translated">第一件事是在AWS帐户中进行身份验证，获得特定区域中的所有EC2实例，然后获得附加到每个EC2的EBS卷的列表。</p><p id="2725" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后，有了这些信息，我们可以玩他们的标签。</p><p id="1fea" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">剧本:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="5d6b" class="lf lg iq kv b gy lh li l lj lk">#!/usr/bin/env python<br/><br/>import os   <br/>import boto3<br/>            <br/>ec2 = boto3.resource('ec2',<br/>        region_name=os.getenv("AWS_DEFAULT_REGION"),<br/>        aws_access_key_id=os.getenv("AWS_ACCESS_KEY_ID"),<br/>        aws_secret_access_key=os.getenv("AWS_SECRET_ACCESS_KEY")<br/>    )<br/>    <br/>def lambda_handler(event, context):<br/>            <br/>    base = ec2.instances.all()<br/>                <br/>    for instance in base:<br/>            <br/>        print("\n[DEBUG] EC2\n\t\tID: " + str(instance))<br/>        print("\tEBS")<br/><br/>        for vol in instance.volumes.all():<br/>    <br/>            vol_id = str(vol)<br/>            print("\t\tID: " + vol_id)<br/>        <br/>if __name__ == "__main__":<br/>    lambda_handler(0, 0)</span></pre><p id="07b8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里，在<code class="fe ks kt ku kv b">ec2</code>变量中，我们创建了一个类型为<em class="lm"> ec2 </em>的<code class="fe ks kt ku kv b"><a class="ae kw" href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/resources.html" rel="noopener ugc nofollow" target="_blank">boto3.resource</a></code>对象，并将通过使用<code class="fe ks kt ku kv b">$AWS_ACCESS_KEY_ID</code>和<code class="fe ks kt ku kv b">$AWS_SECRET_ACCESS_KEY</code>变量在AWS帐户中进行身份验证。稍后，在我们的Lambda中，身份验证和授权将由IAWS IAM角色完成。</p><p id="8d02" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在脚本的最后，我们调用了<code class="fe ks kt ku kv b">lambda_handler()</code>函数，如果脚本是作为专用程序执行的，参见<a class="ae kw" href="https://rtfm.co.ua/en/python-what-is-the-if-__name__-__main__/" rel="noopener ugc nofollow" target="_blank"> Python:什么是if __name__ == "__main__ "?</a>了解详情。</p><p id="9370" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<code class="fe ks kt ku kv b">lambda_handler()</code>中，我们调用<code class="fe ks kt ku kv b"><a class="ae kw" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/ec2.html#EC2.ServiceResource.instances" rel="noopener ugc nofollow" target="_blank">ec2.instances.all()</a></code>方法来获取一个区域中的所有实例，然后在<code class="fe ks kt ku kv b">for</code>循环中，通过调用<code class="fe ks kt ku kv b"><a class="ae kw" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/ec2.html#EC2.Instance.volumes" rel="noopener ugc nofollow" target="_blank">instance.volumes.all()</a></code>来获取每个EC2的EBS卷列表。</p><p id="dce6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，<code class="fe ks kt ku kv b">lambda_handler()</code>的参数作为“<em class="lm"> 0，0 </em>”传递，稍后，在Lambda中，我们将把<code class="fe ks kt ku kv b">event</code>和<code class="fe ks kt ku kv b">context</code>对象。</p><p id="95fd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">设置AWS验证变量:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="cd79" class="lf lg iq kv b gy lh li l lj lk">$ export AWS_ACCESS_KEY_ID=AKI***D4Q<br/>$ export AWS_SECRET_ACCESS_KEY=QUC***BTI<br/>$ export AWS_DEFAULT_REGION=eu-west-3</span></pre><p id="7cbb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行脚本:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="9501" class="lf lg iq kv b gy lh li l lj lk">$ ./ec2_tags.py<br/>[DEBUG] EC2<br/>ID: ec2.Instance(id=’i-0df2fe9ec4b5e1855')<br/>EBS<br/>ID: ec2.Volume(id=’vol-0d11fd27f3702a0fc’)<br/>[DEBUG] EC2<br/>ID: ec2.Instance(id=’i-023529a843d02f680')<br/>EBS<br/>ID: ec2.Volume(id=’vol-0f3548ae321cd040c’)<br/>[DEBUG] EC2<br/>ID: ec2.Instance(id=’i-02ab1438a79a3e475')<br/>EBS<br/>ID: ec2.Volume(id=’vol-09b6f60396e56c363')<br/>ID: ec2.Volume(id=’vol-0d75c44a594e312a1')<br/>…</span></pre><p id="abc8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">很好，起作用了！我们得到了<em class="lm"> eu-west-3 </em> AWS区域中的所有ес2，并为每个EC2附上了一个EBS列表。</p><p id="7912" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下一步是什么？下一步是确定一个卷是如何装入EC2的，知道了它的装入点，我们就能够知道这个磁盘是根卷还是其他数据卷。</p><p id="da5c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这可以通过获取为<code class="fe ks kt ku kv b">Device</code>键保存一个值的<code class="fe ks kt ku kv b"><a class="ae kw" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/ec2.html#EC2.Volume.attachments" rel="noopener ugc nofollow" target="_blank">attachments()</a></code>属性来实现。</p><p id="2a04" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在脚本中设置一个名为<code class="fe ks kt ku kv b">device_id</code>的新变量:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="aa74" class="lf lg iq kv b gy lh li l lj lk">...<br/>        for vol in instance.volumes.all():<br/>            <br/>            vol_id = str(vol)<br/>            device_id = "ec2.vol.Device('" + str(vol.attachments[0]['Device']) + "')"<br/>            <br/>            print("\t\tID:  " + vol_id + "\n\t\tDev: " + device_id + "\n")<br/>...</span></pre><p id="76fd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">再次运行脚本:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="c8c4" class="lf lg iq kv b gy lh li l lj lk">$ ./ec2_tags.py<br/>[DEBUG] EC2<br/>ID: ec2.Instance(id=’i-0df2fe9ec4b5e1855')<br/>EBS<br/>ID: ec2.Volume(id=’vol-0d11fd27f3702a0fc’)<br/>Dev: ec2.vol.Device(‘/dev/xvda’)<br/>[DEBUG] EC2<br/>ID: ec2.Instance(id=’i-023529a843d02f680')<br/>EBS<br/>ID: ec2.Volume(id=’vol-0f3548ae321cd040c’)<br/>Dev: ec2.vol.Device(‘/dev/xvda’)<br/>[DEBUG] EC2<br/>ID: ec2.Instance(id=’i-02ab1438a79a3e475')<br/>EBS<br/>ID: ec2.Volume(id=’vol-09b6f60396e56c363')<br/>Dev: ec2.vol.Device(‘/dev/xvda’)<br/>ID: ec2.Volume(id=’vol-0d75c44a594e312a1')<br/>Dev: ec2.vol.Device(‘/dev/xvdbm’)<br/>…</span></pre><p id="3f75" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里我们有一个ID为<em class="lm"> i-02ab1438a79a3e475 </em>的ес2，该EC2安装了两个EBS卷，即<em class="lm"> vol-09b6f60396e56c363 </em>作为<code class="fe ks kt ku kv b">/dev/xvda</code>，以及<em class="lm"> vol-0d75c44a594e312a1 </em>作为<code class="fe ks kt ku kv b">/dev/xvdbm</code>。</p><p id="7940" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe ks kt ku kv b">/dev/xvda</code>显然是根卷，还有<code class="fe ks kt ku kv b">/dev/xvdbm</code> -一些附加数据。</p><h2 id="e64e" class="lf lg iq bd mc nh ni dn mg nj nk dp mk kf nl nm mo kj nn no ms kn np nq mw nr bi translated"><code class="fe ks kt ku kv b">boto3</code>:向EBS添加AWS标签</h2><p id="0e08" class="pw-post-body-paragraph ju jv iq jw b jx my jz ka kb mz kd ke kf ne kh ki kj nf kl km kn ng kp kq kr ij bi translated">现在，让我们创建一个<code class="fe ks kt ku kv b">Role</code>标记，它将保留以下值中的一个:</p><ol class=""><li id="0e88" class="ln lo iq jw b jx jy kb kc kf lp kj lq kn lr kr ls lt lu lv bi translated">如果EBS有一个带<code class="fe ks kt ku kv b">kubernetes.io/created-for/pvc/name</code>键的标签，那么将设置<code class="fe ks kt ku kv b">Role: "PvcVolume"</code></li><li id="3318" class="ln lo iq jw b jx lw kb lx kf ly kj lz kn ma kr ls lt lu lv bi translated">如果不是PVC卷，那么需要检查它的挂载点，如果<code class="fe ks kt ku kv b">device</code> == " <em class="lm"> /dev/xvda </em>，那么设置<code class="fe ks kt ku kv b">Role: "RootVolume"</code></li><li id="875a" class="ln lo iq jw b jx lw kb lx kf ly kj lz kn ma kr ls lt lu lv bi translated">最后，如果<code class="fe ks kt ku kv b">device</code>变量有任何其他值，那么就用<code class="fe ks kt ku kv b">Role: "DataDisk"</code>标记EBS</li></ol><p id="a66c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为此，让我们添加另一个用于设置标签的函数，以及另一个名为<code class="fe ks kt ku kv b">is_pvc()</code>的小函数，它将检查EBS是否有<code class="fe ks kt ku kv b">kubernetes.io/created-for/pvc/name</code>标签:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="924e" class="lf lg iq kv b gy lh li l lj lk">...<br/>def is_pvc(vol):<br/><br/>    try:<br/>        for tag in vol.tags:<br/>            if tag['Key'] == 'kubernetes.io/created-for/pvc/name':<br/>                return True<br/>                break<br/>    except TypeError:<br/>            return False<br/><br/>def set_role_tag(vol):<br/><br/>    device = vol.attachments[0]['Device']<br/>    tags_list = []<br/>    values = {}<br/><br/>    if is_pvc(vol):<br/>        values['Key'] = "Role"<br/>        values['Value'] = "PvcDisk"<br/>        tags_list.append(values)<br/>    elif device == "/dev/xvda":<br/>        values['Key'] = "Role"<br/>        values['Value'] = "RootDisk"<br/>        tags_list.append(values)<br/>    else:<br/>        values['Key'] = "Role"<br/>        values['Value'] = "DataDisk"<br/>        tags_list.append(values)<br/><br/>    return tags_list<br/>...</span></pre><p id="d99c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里，在<code class="fe ks kt ku kv b">set_role_tag()</code>函数中，我们首先将<code class="fe ks kt ku kv b">vol</code>的值作为参数传递给<code class="fe ks kt ku kv b">is_pvc()</code>函数，该函数检查<em class="lm">‘kubernetes . io/created-for/PVC/name’</em>键的标签。这里的<code class="fe ks kt ku kv b">try/except</code>是用来知道一个EBS到底有没有标签。</p><p id="7177" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果找到了<em class="lm">' kubernetes . io/created-for/PVC/name '</em>标签，那么<code class="fe ks kt ku kv b">is_pvc()</code>将返回<code class="fe ks kt ku kv b">True</code>，如果没有找到，那么<code class="fe ks kt ku kv b">False</code>。</p><p id="a584" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后，在<code class="fe ks kt ku kv b">if/elif/else</code>条件中，我们检查EBS是否是PVC卷，如果是，那么它将被标记为<code class="fe ks kt ku kv b">Role: "PvcVolume"</code>，如果不是，将检查它的挂载点，如果它被挂载为"<em class="lm"> /dev/xvda </em>，那么设置<code class="fe ks kt ku kv b">Role: "RootVolume"</code>，如果是，将使用<code class="fe ks kt ku kv b">Role: "DataDisk".</code></p><p id="7e54" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加对<code class="fe ks kt ku kv b">lambda_handler()</code>的<code class="fe ks kt ku kv b">set_role_tag()</code>调用，作为<code class="fe ks kt ku kv b">vol.create_tags()</code>函数的参数:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="e175" class="lf lg iq kv b gy lh li l lj lk">...<br/>def lambda_handler(event, context):<br/>            <br/>    base = ec2.instances.all()<br/><br/>    for instance in base:<br/><br/>        print("\n[DEBUG] EC2\n\t\tID:  " + str(instance))<br/>        print("\tEBS")<br/>            <br/>        for vol in instance.volumes.all():<br/>                <br/>            vol_id = str(vol)<br/>            device_id = "ec2.vol.Device('" + str(vol.attachments[0]['Device']) + "')"<br/>            print("\t\tID:  " + vol_id + "\n\t\tDev: " + device_id)<br/><br/>            role_tag = vol.create_tags(Tags=set_role_tag(vol))<br/>            print("\t\tTags set:\n\t\t\t" + str(role_tag))<br/>...</span></pre><p id="3f72" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">再次运行脚本:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="c024" class="lf lg iq kv b gy lh li l lj lk">$ ./ec2_tags.py<br/>[DEBUG] EC2<br/>ID: ec2.Instance(id=’i-0df2fe9ec4b5e1855')<br/>EBS<br/>ID: ec2.Volume(id=’vol-0d11fd27f3702a0fc’)<br/>Dev: ec2.vol.Device(‘/dev/xvda’)<br/>Tags set:<br/>[ec2.Tag(resource_id=’vol-0d11fd27f3702a0fc’, key=’Role’, value=’RootDisk’)]<br/>…<br/>[DEBUG] EC2<br/>ID: ec2.Instance(id=’i-02ab1438a79a3e475')<br/>EBS<br/>ID: ec2.Volume(id=’vol-09b6f60396e56c363')<br/>Dev: ec2.vol.Device(‘/dev/xvda’)<br/>Tags set:<br/>[ec2.Tag(resource_id=’vol-09b6f60396e56c363', key=’Role’, value=’RootDisk’)]<br/>ID: ec2.Volume(id=’vol-0d75c44a594e312a1')<br/>Dev: ec2.vol.Device(‘/dev/xvdbm’)<br/>Tags set:<br/>[ec2.Tag(resource_id=’vol-0d75c44a594e312a1', key=’Role’, value=’PvcDisk’)]</span></pre><p id="c332" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们检查一下<em class="lm"> i-02ab1438a79a3e47 </em> EC2实例的容量。</p><p id="6978" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">其根卷<em class="lm"> vol-09b6f60396e56c363 </em>:</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nt nu di nv bf nw"><div class="gh gi ns"><img src="../Images/1e1c4b35f1fbda2fdb33c4bd0278267f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*UNJziuqM99X3Kteb.png"/></div></div></figure><p id="edc6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以及一款Kubernetes PVC—<em class="lm">vol-0 d75 c 44 a 594 e 312 a 1</em>:</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nt nu di nv bf nw"><div class="gh gi nx"><img src="../Images/d7fcc27a59d2a8e27d6ea4b38d2bc881.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jyklj6-9adpI3z1J.png"/></div></div></figure><p id="8dac" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">很好，我们已经添加了<code class="fe ks kt ku kv b">Role</code>标签创建，现在需要添加将AWS标签从EC2复制到EBS的功能。</p><h2 id="25f2" class="lf lg iq bd mc nh ni dn mg nj nk dp mk kf nl nm mo kj nn no ms kn np nq mw nr bi translated"><code class="fe ks kt ku kv b">boto3</code>:将AWS标签从EC2复制到其EBS</h2><p id="9e0f" class="pw-post-body-paragraph ju jv iq jw b jx my jz ka kb mz kd ke kf ne kh ki kj nf kl km kn ng kp kq kr ij bi translated">标签副本也可以移动到一个专用的函数中，让我们把它命名为<code class="fe ks kt ku kv b">copy_ec2_tags()</code>，它将接受一个参数，在这里我们将传递一个EC2 ID:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="7bcb" class="lf lg iq kv b gy lh li l lj lk">...<br/>def copy_ec2_tags(instance):<br/>            <br/>    tags_list = []<br/>    values = {} <br/>        <br/>    for instance_tag in instance.tags:<br/><br/>        if instance_tag['Key'] == 'Env':<br/>            tags_list.append(instance_tag)<br/>        elif instance_tag['Key'] == 'Tier':<br/>            tags_list.append(instance_tag)<br/>        elif instance_tag['Key'] == 'DataClass':<br/>            tags_list.append(instance_tag)<br/><br/>    return tags_list<br/>...</span></pre><p id="f91c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在函数中，在一个循环中，我们检查实例的所有标签，如果将找到在我们的函数中指定的三个标签中的任何一个，它们将被追加到列表<code class="fe ks kt ku kv b">tags_list[]</code>，该列表稍后将被传递到<code class="fe ks kt ku kv b">vol.create_tags()</code>。</p><p id="923c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<code class="fe ks kt ku kv b">lambda_handler()</code>中增加<code class="fe ks kt ku kv b">copy_ec2_tags()</code>执行:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="6c5b" class="lf lg iq kv b gy lh li l lj lk">...<br/>def lambda_handler(event, context):<br/><br/>    base = ec2.instances.all()<br/><br/>    for instance in base:<br/><br/>        print("\n[DEBUG] EC2\n\t\tID:  " + str(instance))<br/>        print("\tEBS")<br/><br/>        for vol in instance.volumes.all():<br/><br/>            vol_id = str(vol)<br/>            device_id = "ec2.vol.Device('" + str(vol.attachments[0]['Device']) + "')"<br/>            print("\t\tID:  " + vol_id + "\n\t\tDev: " + device_id)<br/><br/>            role_tag = vol.create_tags(Tags=set_role_tag(vol))<br/>            ec2_tags = vol.create_tags(Tags=copy_ec2_tags(instance))<br/>            print("\t\tTags set:\n\t\t\t" + str(role_tag) + "\n\t\t\t" + str(ec2_tags))<br/>...</span></pre><p id="7c6a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="9976" class="lf lg iq kv b gy lh li l lj lk">$ ./ec2_tags.py<br/>[DEBUG] EC2<br/>ID: ec2.Instance(id=’i-0df2fe9ec4b5e1855')<br/>EBS<br/>ID: ec2.Volume(id=’vol-0d11fd27f3702a0fc’)<br/>Dev: ec2.vol.Device(‘/dev/xvda’)<br/>Tags set:<br/>[ec2.Tag(resource_id=’vol-0d11fd27f3702a0fc’, key=’Role’, value=’RootDisk’)]<br/>[ec2.Tag(resource_id=’vol-0d11fd27f3702a0fc’, key=’DataClass’, value=’Public’), ec2.Tag(resource_id=’vol-0d11fd27f3702a0fc’, key=’Env’, value=’Dev’), ec2.Tag(resource_id=’vol-0d11fd27f3702a0fc’, key=’Tier’, value=’Devops’)]<br/>…<br/>[DEBUG] EC2<br/>ID: ec2.Instance(id=’i-02ab1438a79a3e475')<br/>EBS<br/>ID: ec2.Volume(id=’vol-09b6f60396e56c363')<br/>Dev: ec2.vol.Device(‘/dev/xvda’)<br/>Tags set:<br/>[ec2.Tag(resource_id=’vol-09b6f60396e56c363', key=’Role’, value=’RootDisk’)]<br/>[ec2.Tag(resource_id=’vol-09b6f60396e56c363', key=’Env’, value=’Dev’), ec2.Tag(resource_id=’vol-09b6f60396e56c363', key=’DataClass’, value=’Public’), ec2.Tag(resource_id=’vol-09b6f60396e56c363', key=’Tier’, value=’Devops’)]<br/>ID: ec2.Volume(id=’vol-0d75c44a594e312a1')<br/>Dev: ec2.vol.Device(‘/dev/xvdbm’)<br/>Tags set:<br/>[ec2.Tag(resource_id=’vol-0d75c44a594e312a1', key=’Role’, value=’PvcDisk’)]<br/>[ec2.Tag(resource_id=’vol-0d75c44a594e312a1', key=’Env’, value=’Dev’), ec2.Tag(resource_id=’vol-0d75c44a594e312a1', key=’DataClass’, value=’Public’), ec2.Tag(resource_id=’vol-0d75c44a594e312a1', key=’Tier’, value=’Devops’)]</span></pre><p id="d31d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi">…</p><p id="5686" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并检查:</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nt nu di nv bf nw"><div class="gh gi ny"><img src="../Images/f227e9cd73072a4220063d24254d6ce6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NhwsfA-XzghmlypC.png"/></div></div></figure><p id="7cac" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">整个脚本现在看起来如下所示:</p><pre class="kx ky kz la gt lb kv lc ld aw le bi"><span id="7549" class="lf lg iq kv b gy lh li l lj lk">#!/usr/bin/env python<br/><br/>import os<br/>import boto3<br/><br/>ec2 = boto3.resource('ec2',<br/>        region_name=os.getenv("AWS_DEFAULT_REGION"),<br/>        aws_access_key_id=os.getenv("AWS_ACCESS_KEY_ID"),<br/>        aws_secret_access_key=os.getenv("AWS_SECRET_ACCESS_KEY")<br/>    )<br/><br/>def lambda_handler(event, context):<br/><br/>    base = ec2.instances.all()<br/><br/>    for instance in base:<br/><br/>        print("[DEBUG] EC2\n\t\tID:  " + str(instance))<br/>        print("\tEBS")<br/><br/>        for vol in instance.volumes.all():<br/><br/>            vol_id = str(vol)<br/>            device_id = "ec2.vol.Device('" + str(vol.attachments[0]['Device']) + "')"<br/>            print("\t\tID:  " + vol_id + "\n\t\tDev: " + device_id)<br/><br/>            role_tag = vol.create_tags(Tags=set_role_tag(vol))<br/>            ec2_tags = vol.create_tags(Tags=copy_ec2_tags(instance))<br/>            print("\t\tTags set:\n\t\t\t" + str(role_tag) + "\n\t\t\t" + str(ec2_tags) + "\n")<br/><br/>def is_pvc(vol): <br/><br/>    try:<br/>        for tag in vol.tags:<br/>            if tag['Key'] == 'kubernetes.io/created-for/pvc/name':<br/>                return True<br/>                break<br/>    except TypeError:<br/>            return False<br/><br/>def set_role_tag(vol):<br/>    <br/>    device = vol.attachments[0]['Device']<br/>    tags_list = []<br/>    values = {}<br/>        <br/>    if is_pvc(vol):<br/>        values['Key'] = "Role"<br/>        values['Value'] = "PvcDisk"<br/>        tags_list.append(values)<br/>    elif device == "/dev/xvda":<br/>        values['Key'] = "Role"<br/>        values['Value'] = "RootDisk"<br/>        tags_list.append(values)<br/>    else:   <br/>        values['Key'] = "Role"<br/>        values['Value'] = "DataDisk"<br/>        tags_list.append(values)<br/><br/>    return tags_list<br/><br/>def copy_ec2_tags(instance):<br/>            <br/>    tags_list = []<br/>    values = {} <br/>        <br/>    for instance_tag in instance.tags:<br/><br/>        if instance_tag['Key'] == 'Env':<br/>            tags_list.append(instance_tag)<br/>        elif instance_tag['Key'] == 'Tier':<br/>            tags_list.append(instance_tag)<br/>        elif instance_tag['Key'] == 'DataClass':<br/>            tags_list.append(instance_tag)<br/>        elif instance_tag['Key'] == 'JiraTicket':<br/>            tags_list.append(instance_tag)<br/><br/>    return tags_list<br/><br/>if __name__ == "__main__":<br/>    lambda_handler(0, 0)</span></pre><p id="98d8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里我们已经完成了，现在可以继续使用AWS Lambda函数。参见<a class="ae kw" href="https://rtfm.co.ua/en/?p=27163" rel="noopener ugc nofollow" target="_blank"> AWS中的下一部分:Lambda —将EC2标签复制到其EBS，第2部分—创建Lambda函数</a>帖子。</p></div><div class="ab cl nz oa hu ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="ij ik il im in"><p id="f62e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="lm">最初发布于</em> <a class="ae kw" href="https://rtfm.co.ua/en/aws-lambda-copy-ec2-tags-to-its-ebs-part-1-python-and-boto3/" rel="noopener ugc nofollow" target="_blank"> <em class="lm"> RTFM: Linux、DevOps、系统管理</em> </a> <em class="lm">。</em></p></div></div>    
</body>
</html>