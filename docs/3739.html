<html>
<head>
<title>Kubernetes: ConfigMaps and Secrets on a Gorush server example</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">kubernetes:Gorush服务器上的配置图和秘密示例</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-configmaps-and-secrets-on-a-gorush-server-example-2a9539ac92e2?source=collection_archive---------3-----------------------#2020-02-14">https://itnext.io/kubernetes-configmaps-and-secrets-on-a-gorush-server-example-2a9539ac92e2?source=collection_archive---------3-----------------------#2020-02-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b507bdfa1910ba0d8b988a12cd2d2352.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sAiJ7eA5ub8jzlSKjKum6g.png"/></div></div></figure><p id="6e27" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们有一个来自<a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-running-a-push-server-with-gorush-behind-an-aws-loadbalancer/" rel="noopener ugc nofollow" target="_blank"> Kubernetes的Gorush服务器:在AWS LoadBalancer </a>帖子后面运行带有Gorush的推送服务器，我想添加一个通过Github存储库配置它的功能，并使用一组不同的设置运行它——用于暂存和生产环境。</p><p id="8553" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们使用Kubernetes <a class="ae kw" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/" rel="noopener ugc nofollow" target="_blank"> ConfigMap </a>来存储配置文件内容，使用Kubernetes <a class="ae kw" href="https://kubernetes.io/docs/concepts/configuration/secret/" rel="noopener ugc nofollow" target="_blank"> Secrets </a>来存储机密数据。</p><p id="dbd9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此时，在<code class="fe kx ky kz la b">gorush-configmap.yaml</code>中，我们有了Gorush与Redis连接设置的默认配置图:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="b5d1" class="lj lk iq la b gy ll lm l ln lo">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: gorush-config<br/>  namespace: gorush<br/>data:<br/>  # stat<br/>  stat.engine: redis<br/>  stat.redis.host: redis:6379</span></pre><p id="3799" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">同样，需要补充的是:</p><ul class=""><li id="cbf8" class="lp lq iq ka b kb kc kf kg kj lr kn ls kr lt kv lu lv lw lx bi translated">用于Apple推送服务鉴定的SSL证书</li><li id="f244" class="lp lq iq ka b kb ly kf lz kj ma kn mb kr mc kv lu lv lw lx bi translated">此证书的密码</li></ul><p id="b2fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将添加两个秘密——一个用于密码，一个用于密钥文件。</p><h2 id="7cf7" class="lj lk iq bd md me mf dn mg mh mi dp mj kj mk ml mm kn mn mo mp kr mq mr ms mt bi translated">库伯内特的秘密</h2><p id="363e" class="pw-post-body-paragraph jy jz iq ka b kb mu kd ke kf mv kh ki kj mw kl km kn mx kp kq kr my kt ku kv ij bi translated">创建一个新文件<code class="fe kx ky kz la b">gorush-secrets.yaml</code>并添加一个p12-key主体。</p><p id="d4f1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">由于这是p12 —使用<code class="fe kx ky kz la b">data</code>类型的密码，在<code class="fe kx ky kz la b">base64</code>中获取您的证书:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="2650" class="lj lk iq la b gy ll lm l ln lo">$ cat apns_wl.p12 | base64<br/>MIIM9QIBAzCCDLwGCSqGSIb3DQEHAaCCDK0EggypMIIMpTCCBycGCSqGSIb3DQEHBqCCBxgwggcU<br/>AgEAMIIHDQYJKoZIhvcNAQcBMBwGCiqGSIb3DQEMAQYwDgQI+BcNML0eE1oCAggAgIIG4KVvRBPp<br/>…</span></pre><p id="6853" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加一个名为<em class="mz"> ios-push-rsa-key </em>的<code class="fe kx ky kz la b">data</code>地图:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="1200" class="lj lk iq la b gy ll lm l ln lo">---<br/>apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  name: ios-push-secret<br/>  namespace: gorush<br/>type: Opaque<br/>data:<br/>  ios-push-rsa-key: |<br/>    MIIM9QIBAzCCDLwGCSqGSIb3DQEHAaCCDK0EggypMIIMpTCCBycGCSqGSIb3DQEHBqCCBxgwggcU<br/>    AgEAMIIHDQYJKoZIhvcNAQcBMBwGCiqGSIb3DQEMAQYwDgQI+BcNML0eE1oCAggAgIIG4KVvRBPp<br/>    ...</span></pre><p id="2e26" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者。如果它是一个PEM编码的密钥——您可以使用<code class="fe kx ky kz la b">stringData</code>而不使用<code class="fe kx ky kz la b">base64</code>,只是一个明文:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="3304" class="lj lk iq la b gy ll lm l ln lo">---<br/>apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  name: ios-push-secret<br/>  namespace: gorush<br/>type: Opaque<br/>stringData:<br/>  ios-push-rsa-key: |<br/>    -----BEGIN CERTIFICATE-----<br/>    MIIGJDCCBQygAwIBAgIIAtw7YRUahfYwDQYJKoZIhvcNAQELBQAwgZYxCzAJBgNV<br/>    BAYTAlVTMRMwEQYDVQQKDApBcHBsZSBJbmMuMSwwKgYDVQQLDCNBcHBsZSBXb3Js<br/>    ZHdpZGUgRGV2ZWxvcGVyIFJlbGF0aW9uczFEMEIGA1UEAww7QXBwbGUgV29ybGR3<br/>...</span></pre><p id="578a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创造秘密:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="a875" class="lj lk iq la b gy ll lm l ln lo">$ kubectl apply -f gorush-secrets.yaml<br/>secret/ios-push-secret created</span></pre><p id="6613" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查一下:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="31b9" class="lj lk iq la b gy ll lm l ln lo">$ kubectl -n gorush describe secret ios-push-secret<br/>Name: ios-push-secret<br/>Namespace: gorush<br/>Labels: &lt;none&gt;<br/>Annotations:<br/>Type: Opaque<br/>Data<br/>====<br/>ios-push-rsa-key: 4586 bytes</span></pre><p id="cde2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们需要将这个证书安装到pod和容器上。</p><h2 id="31aa" class="lj lk iq bd md me mf dn mg mh mi dp mj kj mk ml mm kn mn mo mp kr mq mr ms mt bi translated">Kubernetes秘密和<code class="fe kx ky kz la b">volumeMounts</code> -秘密，作为文件</h2><p id="b45e" class="pw-post-body-paragraph jy jz iq ka b kb mu kd ke kf mv kh ki kj mw kl km kn mx kp kq kr my kt ku kv ij bi translated">更新<code class="fe kx ky kz la b">gorush-deployment.yaml</code>文件-从章节添加<code class="fe kx ky kz la b"><a class="ae kw" href="https://kubernetes.io/docs/concepts/storage/volumes/" rel="noopener ugc nofollow" target="_blank">volumes</a></code>:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="9054" class="lj lk iq la b gy ll lm l ln lo">...<br/>      volumes:<br/>      - name: ios-push-secret-vol<br/>        secret:<br/>          secretName: ios-push-secret<br/>          items:<br/>          - key: ios-push-p12-key<br/>            path: apns-crt.p12</span></pre><p id="027b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并将其添加到pod的模板中:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="3185" class="lj lk iq la b gy ll lm l ln lo">...<br/>    spec:<br/>      containers:<br/>      - image: appleboy/gorush<br/>        name: gorush<br/>        imagePullPolicy: Always<br/>        ports:<br/>        - containerPort: 8088<br/>...<br/>        volumeMounts:<br/>        - name: ios-push-secret-vol<br/>          mountPath: /data/ssl/apns-crt.p12<br/>          subPath: apns-crt.p12<br/>          readOnly: true</span></pre><p id="6e18" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了说明它们是如何相互联系的:</p><ul class=""><li id="6fdd" class="lp lq iq ka b kb kc kf kg kj lr kn ls kr lt kv lu lv lw lx bi translated"><code class="fe kx ky kz la b">kind: Secret</code> : //只是一个秘密类型</li><li id="3cfe" class="lp lq iq ka b kb ly kf lz kj ma kn mb kr mc kv lu lv lw lx bi translated"><code class="fe kx ky kz la b">name: ios-push-secret</code> //一个秘密名称——将在<em class="mz">规格&gt;卷&gt;秘密&gt;中使用secretName </em></li><li id="afc6" class="lp lq iq ka b kb ly kf lz kj ma kn mb kr mc kv lu lv lw lx bi translated"><code class="fe kx ky kz la b">data</code>:</li><li id="ea0d" class="lp lq iq ka b kb ly kf lz kj ma kn mb kr mc kv lu lv lw lx bi translated"><code class="fe kx ky kz la b">ios-push-rsa-key</code> //证书主体</li><li id="a241" class="lp lq iq ka b kb ly kf lz kj ma kn mb kr mc kv lu lv lw lx bi translated"><code class="fe kx ky kz la b">volumes</code> : //在<em class="mz">规格</em>中设定，将添加卷</li><li id="1222" class="lp lq iq ka b kb ly kf lz kj ma kn mb kr mc kv lu lv lw lx bi translated"><code class="fe kx ky kz la b">name: ios-push-secret-vol</code> //一个创建的卷名，将在<em class="mz">规格&gt;容器&gt;卷装载&gt;名称</em>中使用</li><li id="390e" class="lp lq iq ka b kb ly kf lz kj ma kn mb kr mc kv lu lv lw lx bi translated"><code class="fe kx ky kz la b">secret</code> : //定义要使用的数据</li><li id="0804" class="lp lq iq ka b kb ly kf lz kj ma kn mb kr mc kv lu lv lw lx bi translated"><code class="fe kx ky kz la b">secretName: ios-push-secret</code> //查找名为<em class="mz">的秘密:ios-push-secret </em>名</li><li id="b475" class="lp lq iq ka b kb ly kf lz kj ma kn mb kr mc kv lu lv lw lx bi translated"><code class="fe kx ky kz la b">items</code>://andsideofthesecret</li><li id="d9db" class="lp lq iq ka b kb ly kf lz kj ma kn mb kr mc kv lu lv lw lx bi translated"><code class="fe kx ky kz la b">- key: ios-push-rsa-key</code> //寻找<em class="mz">秘密&gt;数据&gt; ios-push-rsa-key </em></li><li id="48bc" class="lp lq iq ka b kb ly kf lz kj ma kn mb kr mc kv lu lv lw lx bi translated"><code class="fe kx ky kz la b">path: apns-rsa.pem</code> //以及它必须如何安装</li><li id="2052" class="lp lq iq ka b kb ly kf lz kj ma kn mb kr mc kv lu lv lw lx bi translated"><code class="fe kx ky kz la b">volumeMounts</code> : //用于<em class="mz">规格&gt;容器</em></li><li id="9c15" class="lp lq iq ka b kb ly kf lz kj ma kn mb kr mc kv lu lv lw lx bi translated"><code class="fe kx ky kz la b">name: ios-push-secret-vol</code> //要挂载的卷名称- <em class="mz">规格&gt;卷&gt;名称:ios-push-secret-vol </em></li><li id="d033" class="lp lq iq ka b kb ly kf lz kj ma kn mb kr mc kv lu lv lw lx bi translated"><code class="fe kx ky kz la b">mountPath: /data/ssl/apns-rsa.pem</code> //完整的挂载路径</li><li id="bdb2" class="lp lq iq ka b kb ly kf lz kj ma kn mb kr mc kv lu lv lw lx bi translated"><code class="fe kx ky kz la b">subPath: apns-rsa.pem</code> //如果秘密作为专用文件安装，则目录中的文件名</li></ul><p id="35a7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署和检查:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="dca1" class="lj lk iq la b gy ll lm l ln lo">kubectl -n gorush exec -ti gorush-7ff8fd9f4c-gds8r -c bastion cat /data/ssl/apns-rsa.pem<br/>Bag Attributes<br/>friendlyName: Apple Push Services: ***<br/>localKeyID: C0 3A 96 69 CB C4 9E E6 14 EB 43 1F 31 30 97 4D 85 89 A0 8D<br/>subject=/UID=***/CN=Apple Push Services: ***/OU=7MF8BB6LXN/O=***/C=VG<br/>issuer=/C=US/O=Apple Inc./OU=Apple Worldwide Developer Relations/CN=Apple Worldwide Developer Relations Certification Authorit<br/> — — -BEGIN CERTIFICATE — — -<br/>MIIGJDCCBQygAwIBAgIIAtw7YRUahfYwDQYJKoZIhvcNAQELBQAwgZYxCzAJBgNV<br/>BAYTAlVTMRMwEQYDVQQKDApBcHBsZSBJbmMuMSwwKgYDVQQLDCNBcHBsZSBXb3Js<br/>…</span></pre><h2 id="e851" class="lj lk iq bd md me mf dn mg mh mi dp mj kj mk ml mm kn mn mo mp kr mq mr ms mt bi translated">Kubernetes秘密和<code class="fe kx ky kz la b">env</code> -秘密，作为环境变量</h2><p id="fca2" class="pw-post-body-paragraph jy jz iq ka b kb mu kd ke kf mv kh ki kj mw kl km kn mx kp kq kr my kt ku kv ij bi translated">下面的步骤是为该证书添加密码。</p><p id="f225" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有两种选择——使用配置文件或通过变量。</p><p id="4d61" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在配置文件中，Gorush有一个<code class="fe kx ky kz la b">ios.password</code>参数:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="3b23" class="lj lk iq la b gy ll lm l ln lo">...<br/>    ios:<br/>      enabled: true<br/>      key_path: "/data/ssl/apns-crt.p12"<br/>      password: "p@ssw0rd"<br/>      production: true<br/>...</span></pre><p id="f8e6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果使用变量——Gorush将添加一个<code class="fe kx ky kz la b"><a class="ae kw" href="https://github.com/appleboy/gorush/blob/master/config/config.go#L224" rel="noopener ugc nofollow" target="_blank">GORUSH</a></code>前缀:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="ff84" class="lj lk iq la b gy ll lm l ln lo">...<br/>  viper.SetEnvPrefix("gorush") // will be uppercased automatically<br/>...</span></pre><p id="6886" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，我们的变量名将是<code class="fe kx ky kz la b">GORUSH_IOS_PASSWORD</code>。</p><p id="75f1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">向<em class="mz"> ios-push-secret </em>添加新值。</p><p id="0c45" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加一个带有<code class="fe kx ky kz la b">stringData</code>类型的附加地图:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="2073" class="lj lk iq la b gy ll lm l ln lo">---<br/>apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  name: ios-push-secret<br/>  namespace: gorush-stage<br/>type: Opaque<br/>data:<br/>  ios-push-p12-key: |<br/>    MIIM9QIBAzCCDLwGCSqGSIb3DQEHAaCCDK0EggypMIIMpTCCBycGCSqGSIb3DQEHBqCCBxgwggcU<br/>    AgEAMIIHDQYJKoZIhvcNAQcBMBwGCiqGSIb3DQEMAQYwDgQI+BcNML0eE1oCAggAgIIG4KVvRBPp<br/>...<br/>stringData:<br/>  ios-push-p12-pass: p@ssw0rd</span></pre><p id="0c9c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查一下:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="220f" class="lj lk iq la b gy ll lm l ln lo">$ kubectl apply -f gorush-secrets.yaml<br/>secret/ios-push-secret configured</span></pre><p id="8aa8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在检查—秘密中必须有两个对象—使用<code class="fe kx ky kz la b">describe secret</code>查看它们:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="2ef7" class="lj lk iq la b gy ll lm l ln lo">$ kubectl -n gorush describe secret ios-push-secret<br/>Name: ios-push-secret<br/>Namespace: gorush<br/>Labels: &lt;none&gt;<br/>Annotations:<br/>Type: Opaque<br/>Data<br/>====<br/>ios-push-p12-key: 3321 bytes<br/>ios-push-p12-pass: 13 bytes</span></pre><p id="b993" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用<code class="fe kx ky kz la b">secretKeyRef</code>将<code class="fe kx ky kz la b">GORUSH_IOS_PASSWORD</code>变量添加到部署中:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="6dd7" class="lj lk iq la b gy ll lm l ln lo">...<br/>    spec:<br/>      containers:<br/>      - image: appleboy/gorush<br/>        name: gorush<br/>        imagePullPolicy: Always<br/>        ports:<br/>        - containerPort: 8088<br/>...<br/>        env:<br/>        - name: GORUSH_IOS_PASSWORD<br/>          valueFrom:<br/>            secretKeyRef:<br/>              name: ios-push-secret<br/>              key: ios-push-p12-pass<br/>        volumeMounts:<br/>        - name: ios-push-secret-vol<br/>          mountPath: /data/ssl/apns-crt.p12<br/>          subPath: apns-crt.p12<br/>          readOnly: true<br/>...</span></pre><p id="09a6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署和检查:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="0291" class="lj lk iq la b gy ll lm l ln lo">$ kubectl -n gorush exec -ti gorush-58bcd746c4–67b9n -c gorush env | grep GORUSH_IOS<br/>GORUSH_IOS_PASSWORD=p@ssw0rd</span></pre><p id="6f9c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它在这里。</p><h2 id="56e1" class="lj lk iq bd md me mf dn mg mh mi dp mj kj mk ml mm kn mn mo mp kr mq mr ms mt bi translated">配置图</h2><h2 id="d36b" class="lj lk iq bd md me mf dn mg mh mi dp mj kj mk ml mm kn mn mo mp kr mq mr ms mt bi translated">Kubernetes配置图—配置，作为文件</h2><p id="b241" class="pw-post-body-paragraph jy jz iq ka b kb mu kd ke kf mv kh ki kj mw kl km kn mx kp kq kr my kt ku kv ij bi translated">最后要做的是为Gorush本身添加一个专用的配置文件。</p><p id="afd2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该文件将是相同的生产和暂存，但密钥将从静脉曲张的秘密。</p><p id="3296" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">同样，使用变量和配置图，我们可以为不同的环境传递任何其他参数。</p><p id="8d7e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，让我们使用ConfigMap来保存<code class="fe kx ky kz la b">config.yml</code>文件的内容，以便稍后将其映射到pods。</p><p id="ab3c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Gorush已经有一个<code class="fe kx ky kz la b">gorush-configmap.yaml</code>文件-添加一个名为<em class="mz">的新配置gorush-config-file </em>:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="0731" class="lj lk iq la b gy ll lm l ln lo">---<br/>apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: gorush-config<br/>  namespace: gorush<br/>data:<br/>  # stat<br/>  stat.engine: redis<br/>  stat.redis.host: redis:6379<br/>---<br/>apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: gorush-config-file<br/>  namespace: gorush<br/>data:<br/>  gorush-config-file: |<br/>    core:<br/>      enabled: true<br/>      mode: "release"<br/>      port: "8088"<br/>      max_notification: 1000<br/>      sync: false<br/>...</span></pre><p id="03ca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将其添加到我们部署中的<code class="fe kx ky kz la b">volumes</code>:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="c340" class="lj lk iq la b gy ll lm l ln lo">...<br/>      volumes:<br/>      - name: ios-push-secret-vol<br/>        secret:<br/>          secretName: ios-push-secret<br/>          items:<br/>          - key: ios-push-p12-key<br/>            path: apns-crt.p12<br/>      - name: gorush-config-file-vol<br/>        configMap:<br/>          name: gorush-config-file<br/>          items:<br/>            - key: gorush-config-file<br/>              path: config.yml</span></pre><p id="870f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以及pods模板中<code class="fe kx ky kz la b">volumeMounts</code>上的:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="fba6" class="lj lk iq la b gy ll lm l ln lo">...<br/>    spec:<br/>      containers:<br/>      - image: appleboy/gorush<br/>        name: gorush<br/>        imagePullPolicy: Always<br/>        ports:<br/>        - containerPort: 8088<br/>        ...<br/>        env:<br/>        - name: GORUSH_IOS_PASSWORD<br/>          valueFrom:<br/>            secretKeyRef:<br/>              name: ios-push-secret<br/>              key: ios-push-p12-pass<br/>        volumeMounts:<br/>        - name: ios-push-secret-vol<br/>          mountPath: /data/ssl/apns-crt.p12<br/>          subPath: apns-crt.p12<br/>          readOnly: true<br/>        - name: gorush-config-file-vol<br/>          mountPath: /config.yml<br/>          readOnly: true<br/>          subPath: config.yml<br/>...</span></pre><p id="c328" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更新配置映射:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="a412" class="lj lk iq la b gy ll lm l ln lo">$ kubectl apply -f gorush-configmap.yaml<br/>configmap/gorush-config unchanged<br/>configmap/gorush-config-file created</span></pre><p id="a3fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查它们:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="9dc3" class="lj lk iq la b gy ll lm l ln lo">$ kubectl -n gorush get configmap<br/>NAME DATA AGE<br/>gorush-config 2 28h<br/>gorush-config-file 1 76s</span></pre><p id="25f1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在pod中应用部署并检查配置:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="d8a6" class="lj lk iq la b gy ll lm l ln lo">$ kubectl -n gorush-stage exec -ti gorush-6bc78df55d-9w9m8 -c gorush cat /config.yml<br/>core:<br/>enabled: true<br/>mode: “release”<br/>port: “8088”<br/>max_notification: 1000<br/>sync: false<br/>…<br/>ios:<br/>enabled: true<br/>key_path: “/data/ssl/apns-crt.p12”<br/>password: “”<br/>production: true</span></pre><p id="95d8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要自动应用来自配置图或机密的新值，您可以使用重新加载器控制器，请参见<a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-configmap-and-secrets-data-auto-reload-in-pods/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:配置图和机密pods中的数据自动重新加载</a>帖子。</p><p id="6e9d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成了。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><p id="46a1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="mz">最初发布于</em> <a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-configmaps-and-secrets-on-a-gorush-server-example/" rel="noopener ugc nofollow" target="_blank"> <em class="mz"> RTFM: Linux，devo PSисистемноеадмнииитииовваниованиде</em></a><em class="mz">。</em></p></div></div>    
</body>
</html>