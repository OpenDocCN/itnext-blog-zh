<html>
<head>
<title>Multi-Cloud and Multi-Cluster Declarative Kubernetes Cluster Creation and Management with Cluster API (CAPI — v1alpha3)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">多云和多集群声明式Kubernetes集群创建和集群API管理(CAPI-v1 alpha 3)</h1>
<blockquote>原文：<a href="https://itnext.io/multi-cloud-and-multi-cluster-declarative-kubernetes-cluster-creation-and-management-with-cluster-6df8efdc2a89?source=collection_archive---------0-----------------------#2020-07-24">https://itnext.io/multi-cloud-and-multi-cluster-declarative-kubernetes-cluster-creation-and-management-with-cluster-6df8efdc2a89?source=collection_archive---------0-----------------------#2020-07-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/fc2654b1053ac895bd3b02092c20db38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bWgWxQzsTy7T7bMdklDZzg.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">用于集群创建、配置和管理的声明式、Kubernetes风格的API</figcaption></figure><div class=""/><p id="3671" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">集群API  (CAPI)是一个Kubernetes项目，它为集群创建带来了声明式的、Kubernetes风格的API。CAPI通过使用自定义资源定义来扩展Kubernetes API服务器公开的API，允许用户创建新的资源，如集群(代表一个Kubernetes集群)和机器(代表组成集群的节点的机器)。然后，每个资源的控制器负责对这些资源的变化做出反应，以启动集群。API的设计方式使得不同的基础设施提供者可以与它集成，以提供他们特定于环境的逻辑。</p><p id="c5b7" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">用户与称为“管理集群”的Kubernetes集群通信，该集群包含集群API机制和其他支持组件。用户可以请求创建整个集群，并通过创建与他们想要使用的云提供商相关联的集群资源对象来管理其生命周期，所创建的集群被称为“工作负载集群”。管理集群也是一个或多个基础设施提供商(如AWS、CGP、Azure、vSphere、Openstack等)的地方。)和bootstrap provider(截至目前Kubeadm得到官方支持，用户可以使用operator framework实现自己定制的Bootstrap provider)运行。创建的所有云提供商对象的信息都保存在管理集群中。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi lb"><img src="../Images/755840f4a8efed569ac38b772f8812a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nlaTv3rDXdrKRy1f"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI —管理集群和工作负载集群</figcaption></figure><p id="f2da" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">该项目维护多个<a class="ae la" href="https://github.com/kubernetes-sigs?q=cluster-api-provider&amp;type=&amp;language=" rel="noopener ugc nofollow" target="_blank">基础设施提供商</a>，以便在众多云提供商上使用CAPI。用户可以通过使用Kubebuilder(操作者构建框架)创建控制器和协调来实现定制的提供者。群集控制器和机器控制器一起构成提供者控制器管理器。机器规范由集群API组件——机器控制器使用。该控制器调用负责创建/更新/删除机器的机器执行器。执行器(协调逻辑)是特定于供应商的。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi lg"><img src="../Images/98385d3ba238fffd628b895b74bb02fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hc0auS-MEx_F-vxT"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPi——集群控制器和机器控制器</figcaption></figure><p id="3003" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">一旦机器和其他组件由提供者创建，引导提供者用于引导(安装k8s)Kubernetes控制平面节点和工作者节点。到目前为止，Kubeadm是官方支持和维护的引导提供者。</p><p id="3f69" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">基本集群API是用于所有提供者的框架。它独立维护。集群API提供者为集群API框架实现不同基础设施的操作细节。借助provider，集群API从不同第三方基础设施供应商的操作细节中抽象出集群及其机器的整体管理功能。</p><h1 id="763c" class="lh li jf bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">架构和组件</h1><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mf"><img src="../Images/28045ad4cf478eca4aeba75ee10d330a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wlmeTRQRYUeHJaa-"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI——建筑</figcaption></figure><p id="0ea6" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Kubernetes通过对象和控制器管理不同的资源。控制器通常管理资源以使其对象的实际状态与规范提供的期望状态相匹配。</p><p id="4104" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">集群API由一组共享的控制器组成，以提供一致的用户体验。为了支持多个云环境，这些控制器中的一些(例如，集群、机器)调用提供商特定的致动器来实现控制器的预期行为。其他控制器(例如MachineSet)是通用的，通过与其他集群API(和Kubernetes)资源交互来操作。提供者实现者的任务是实现执行器方法，以便共享控制器在必须协调状态和更新状态时可以调用这些方法。当执行器函数返回一个错误时，如果它是RequeueAfterError，那么在给定的RequeueAfter时间过去后，对象将被重新排队以进行进一步处理。</p><p id="7eca" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">CAPI由多个控制器组成，核心组件如下:</p><h1 id="83e0" class="lh li jf bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">串</h1><p id="172b" class="pw-post-body-paragraph kc kd jf ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ij bi translated">集群提供了一种定义通用Kubernetes集群配置的方法，如pod网络CIDR和服务网络CIDR，以及共享集群基础设施的特定于提供商的管理。集群包含基础设施提供商创建Kubernetes集群所需的详细信息(例如，用于pod、服务的CIDR块)。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ml"><img src="../Images/a0dcfb9cee081f69a7a3f7b49b6bed09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sF2rcCjaCHFpAFQq"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI —集群</figcaption></figure><h1 id="b941" class="lh li jf bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">机器</h1><p id="e00f" class="pw-post-body-paragraph kc kd jf ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ij bi translated">机器负责描述单个Kubernetes节点。在公共配置级别只公开了最少的配置(主要是Kubernetes版本信息)，额外的配置通过嵌入式ProviderSpec公开。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/b0455b62eea15d9d2e54a6535afa0022.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DVgoEdzPyIKNaf-M"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI —机器</figcaption></figure><h1 id="27af" class="lh li jf bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">机器部署</h1><p id="ca95" class="pw-post-body-paragraph kc kd jf ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ij bi translated">MachineDeployments允许对机器组(节点组)的配置更改进行托管部署和展示，非常类似于传统k8s部署的工作方式。这允许以协调的方式对节点配置进行更新，甚至对集群中的工作节点进行版本升级。它还允许回滚到以前的配置。值得注意的是，MachineDeployment不应该用于管理构成给定托管集群的Kubernetes控制平面的机器，因为它们不能保证在machine deployment更新或扩展时控制平面保持健康。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mn"><img src="../Images/7f7abbc56bc77531acfdf5023937cde7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*N7WVIqwGkD52oOss"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI —机器部署</figcaption></figure><h1 id="ef66" class="lh li jf bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">机器健康检查</h1><p id="210f" class="pw-post-body-paragraph kc kd jf ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ij bi translated">MachineHealthCheck负责修复不正常的机器。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mo"><img src="../Images/d01b2f9f8544d5aab1b0b82816a035f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7DobE0bFjCB7Hbut"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI —健康检查</figcaption></figure><p id="1278" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">以上所有控制器都接受用户使用CRD(自定义资源定义)的声明性配置。集群API v1alpha3版本增加了许多重要功能，如声明式控制平面管理(基于Kubeadm的控制平面(KCP)提供声明式API来部署、管理和扩展Kubernetes控制平面，包括etcd)、跨域控制放置(控制器节点的多az/故障域放置)、实验性机器池(如自动扩展组)、使用机器健康检查自动替换不健康的节点等。和少数附加组件，如群集资源集。</p><p id="8555" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">除了上述核心组件之外，基础架构提供者特定控制器、引导提供者控制器、用于验证的webhook控制器、集群API使用cert-manager来管理其web hook所需的证书，这些证书作为部署CAPI的一部分部署在单独的名称空间中。</p><p id="891c" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><a class="ae la" href="https://cluster-api.sigs.k8s.io/clusterctl/overview.html" rel="noopener ugc nofollow" target="_blank"> clusterctl </a> CLI工具处理管理集群上的集群API的生命周期，并自动获取定义CAPI组件、提供商组件的YAML文件并进行安装。使用clusterctl，用户可以根据安装的基础架构提供程序和引导提供程序，搭建创建集群所需的配置模板(clusterctl config cluster命令返回用于创建工作负载集群的YAML模板)。此外，它编码了一组管理提供商的最佳实践，帮助用户避免错误配置或管理第2天的操作，如升级。</p><p id="07ce" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">以下是安装CAPI时在管理群集上创建的不同组件:</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/b9964e54773557ff9766402546b13ca4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BlwyEmH9fQWZlnTz"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI —名称空间</figcaption></figure><p id="c42b" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">各个组件的控制器管理器被部署在相关联的命名空间中:</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi lg"><img src="../Images/80ab36ada94a1ada8339d46018da39a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xJhULjjr3TdcSN8j"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI —组件</figcaption></figure><p id="2878" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">以下是应用于管理集群的一组CRD，包括核心CAPI CRD和引导提供商CRD。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi lg"><img src="../Images/957a1453e62acb33058ade79da8d008e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-NqOQBuonOhosKaf"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI —自定义资源定义</figcaption></figure><p id="5c17" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">capi-controller-manager部署在“capi-system”命名空间中，监视对象:集群、机器、机器部署、机器健康检查、机器集和机器池(实验)。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mq"><img src="../Images/c90c0dc3f457f2b4b8995bef592facbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kfnyeMwhOcJTsmiX"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">capi-系统-capi-控制器-管理器</figcaption></figure><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/9bf8eb7e9bb6d894fb3eeed51609c8ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WJ9ogFfVWcgjD2cd"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">capi-系统-capi-控制器-管理器</figcaption></figure><p id="894e" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">kubeadm-bootstrap-controller-manager部署在“capi-kubeadm-bootstrap-system”命名空间中，并监视对象KubeadmConfig和KubeadmConfigTemplates。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mr"><img src="../Images/a17e1cb250f7ac1a401a4c039c239f22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YBqhErNZX-G9-s2T"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">capi-kube ADM-bootstrap-system-capi-kube ADM-bot strap-controller-manager</figcaption></figure><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/6829d6836aff4091ae2bb276fd9355f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZDFNwZaC05MYxeTG"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">capi-kube ADM-bootstrap-system-capi-kube ADM-bot strap-controller-manager</figcaption></figure><p id="e67a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">kubeadm-control-plane-controller-manager部署在“capi-kube ADM-control-plane-system”命名空间中，监视集群中的kube ADM控制平面资源。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ms"><img src="../Images/f3dcd7ad4326fd6c67af6e69a410e0d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*c_aRHl7bXl2Ntuei"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">capi-kube ADM-控制平面-系统-capi-kube ADM-控制平面-控制器-管理器</figcaption></figure><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/38b40eba1366c49b122378f2903b71ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6_hbWbH95HNWhIJE"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">capi-kube ADM-控制平面-系统-capi-kube ADM-控制平面-控制器-管理器</figcaption></figure><h1 id="c8c6" class="lh li jf bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">使用CAPI和CAPA在AWS上部署集群(AWS的集群API提供程序)</h1><p id="eb89" class="pw-post-body-paragraph kc kd jf ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ij bi translated">一旦建立了管理集群，用户就可以通过管理集群使用CAPI来实例化一个或多个工作负载集群。所有受支持的提供程序都使用“clusterctl”提供引导，该模板返回用于部署提供程序特定的控制器和其他支持对象的YAML模板。用户可以使用CLI在支持CAPI的集群上安装提供程序(单个集群可以包含多个集群，因为每个提供程序都有不同的集群和机器规格)(例如:<em class="mt">cluster CTL init—infra structure AWS</em>—这会将所有CAP组件部署到集群)。</p><p id="84f2" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><a class="ae la" href="https://github.com/kubernetes-sigs/cluster-api-provider-aws" rel="noopener ugc nofollow" target="_blank"> CAPA </a>是AWS的集群api提供者，使用户能够使用AWS作为平台，通过CAPI创建Kubernetes集群，machine spec在这里创建EC2实例和所有其他对象，如VPC、子网、路由表等。也会被创造出来。用户可以参考<a class="ae la" href="https://github.com/kubernetes-sigs/cluster-api-provider-aws/tree/master/config/crd/bases" rel="noopener ugc nofollow" target="_blank"> CRD </a>规范来定制云提供商的大部分具体配置。</p><p id="3334" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">先决条件包括IAM实体，允许引导和管理集群在AWS上创建资源。诸如regions、ssh-key、machine-type等其他变量可以作为环境变量提供，这些变量将替换使用clusterctl创建的配置。管理员帐户凭证存储在一个秘密的。</p><p id="c36d" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">capa-controller-manager部署在“capa-system”命名空间中，监视对象:AWSCluster、AWSMachine、AWSMachineDeployments，当在管理集群上创建这些对象时，它们将被转换为AWS EC2实例。控制器协调并确保所有相关对象都已创建。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/3c2607a0daf271d3b669940695d5397b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6C8rfdTPc9KhwOca"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">capa-系统—capa-控制者-管理者</figcaption></figure><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/0a2963e5bb6bc24773ed2df45eef5014.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MtY7EDW9tLecbUEA"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">capa-系统—capa-控制者-管理者</figcaption></figure><p id="ee06" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">以下拓扑中的管理集群是部署了CAPI的本地集群，clusterctl用于安装CAPA组件。用户可以使用clusterctl创建具有预定义的群集API对象列表的基本配置模板；集群、机器、机器部署等。这是特定提供者所必需的。单个管理集群可以容纳多个提供者，并且在多提供者集群的情况下可以使用'<em class="mt"> —基础架构</em>'标志。所有对象都可以在一个名称空间中确定范围，这在管理集群大规模管理工作负载集群时非常方便。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi lg"><img src="../Images/401d4d22589cc443800693dc8ecd00d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OR194Qf_AccTRsGG"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">AWS的集群API提供程序</figcaption></figure><p id="8114" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">以下是提供商特定的CRD。以这样或那样的方式，其中一些映射到CAPI的核心组件，如集群和机器。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/6169912771d0e81c234f5a89ed1c20e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*i1wXuUas5bJBlzu4"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPA —自定义资源定义</figcaption></figure><p id="10f3" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">下面的清单用于在AWS上创建集群和相关的机器。所有对象的范围都在“aws-cluster”命名空间下。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mv"><img src="../Images/ebe93f35427ca984acf60a0c20f687da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cL5HzgYmJwVDKrjB"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPA —配置规格</figcaption></figure><p id="0872" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">对象引用其他对象(例如cluster包含对KubeadmContolPlane和AWSCluster的引用)，下面显示了一个示例映射:</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mw"><img src="../Images/ef8bb73ca12c72054d431fdfe76d57c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ekCcvUC10SCurxis"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPA —物件</figcaption></figure><p id="4887" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">CAPA控制器管理器创建对象:</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/463301c6af341dde38d8d1beac837f54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3yjqjEuYm2s4EG4m"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPA —主计长兼经理</figcaption></figure><p id="27a7" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">CAPA控制器管理器正在创建计算机(ec2实例):</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/e84bc8dcb083df4b45d103922a7d5cb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WGWpdg7u-8T_2gKP"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPA —主计长兼经理</figcaption></figure><p id="d0b3" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">CAPA使用户能够使用现有的VPC，或者默认情况下，它创建一个带有私有和公共子网的VPC。在多分区设置中，用户可以在AWSCluster中提供一个地图，提供每个分区的子网信息。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/b3aa5d8908feecefa7eea41e1c6aa32c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*21srG-HuGxao9pKw"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPA — VPC</figcaption></figure><p id="d03d" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">子网:</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/ddee23619dc12e0b78810ce7d7906fa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PShPKxZ6JyL7oFN_"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPA —子网</figcaption></figure><p id="4d10" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">路由表:</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/3a4934ca81a6cd96dbb2617147ccd4d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1qOarQsQqm1LlLkK"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPA —路由表</figcaption></figure><p id="0d49" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">安全组:</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/afde8072b86508ffca43c558c404f84c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xssBfYy_PP4MubzO"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPA —安全团体</figcaption></figure><p id="4002" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">连接到三个控制器的弹性IP:</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/070990b287c437ef4de4e9b5b152f22b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aIFDlOIPL2Q7Bppo"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPA——控制器的EIP</figcaption></figure><p id="3891" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">基于v1alpha3 Kubeadm控制平面(KCP)的HA控制平面提供了一个声明式API来部署和扩展Kubernetes控制平面，包括Kubernetes部署副本扩展中的etcd。这种方法消除了删除etcd成员时的手动干预。在缩减规模的同时，KCP自动化了部署、扩展和升级。如下所示，所有机器都是基于配置规范创建的。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/4a10a1e371cf92b24df2e08bb267992c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*obTT3bhDz5qAgzct"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPA-库伯内特斯星团</figcaption></figure><p id="f489" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">通过使用单独的AWSMachineTemplates并在KubeadmControlPlane规范中引用相同的模板，可以单独控制和配置控制平面。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/5086497b1267373990c7bbda122463c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jBhMvxsJ5wdRTy4w"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPA——控制平面机器</figcaption></figure><p id="e13e" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">跨故障域(可用性区域)放置的主节点:</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/d8817f0012564ade62e6b805d09be55d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*a9jpq08nOb-wyvGZ"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPA —控制平面机器—十字路口</figcaption></figure><p id="8374" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">通过拥有单独的AWSMachineTemplate并在MachineDeployment规范中引用相同的模板，可以单独控制和配置工作节点。MachineDeployment在一系列机器集(机器上不变的抽象)上编排部署。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/784050192df0f1c31dad854dc196d5ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0-r2qoMEEQIREXzk"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPA —节点机器</figcaption></figure><p id="9ec0" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">一旦所有的机器都启动了所需的网络，capi-kube ADM-控制平面控制器就启动主节点。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/0f74193c22854cb60b70809c8cc11d75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*arwUbD-AWb3j9Rv-"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPA-kube ADM控制面板引导程序</figcaption></figure><p id="4b42" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">capi-kube ADM-bootstrap-controller-manager负责将节点加入自举主节点。有功能请求和路线图里程碑，以支持云提供商特定的托管Kubernetes服务控制平面(EKS、AKS、GKE等)。)可以通过CAPI管理，用户可以通过CAPI管理托管的Kubernetes服务。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/22a20e13ad81aeaa42650474fb683b93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4t3mJ49j5NxCnB_w"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPA-kube ADM节点自举</figcaption></figure><p id="ad36" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">所有机密信息以及kubeconfig都存储为机密信息，可以使用'<em class="mt">cluster CTL move&lt;cluster _ name&gt;</em>'将其移动到工作负载集群。网络解决方案是一个类似于传统Kubeadm引导程序的附加程序。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/66537b6355fe9e01af0bca08483346ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AEOhtstxNLfoBI_Z"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPA——秘密和Kubeconfig</figcaption></figure><p id="2d54" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">所有状态信息都保存在管理集群中，集群规范状态字段存储信息(资源id、名称等。).由基础设施提供商创建的所有资源都被标记，这些资源在关联中使用，并且在删除集群时确保没有创建的资源被留下。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/62dd4fd9fa4fce9d2600f98739c4d2c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*argslswqQwPXm3MC"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPA —规格状态</figcaption></figure><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/991d5c318d9e4d02ff459c973585152b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*iaXrD9AdkOvYYy3T"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPA —规格状态</figcaption></figure><h1 id="d0fe" class="lh li jf bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">使用CAPZ(Azure集群API提供者)的CAPI在Azure上进行集群部署—从单个管理集群进行多云部署</h1><p id="2d07" class="pw-post-body-paragraph kc kd jf ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ij bi translated">单个管理集群可用于托管多个基础设施提供商。CAPZ部署在“capz-system”命名空间中。用户可以使用名称空间范围来根据基础设施提供商(或任何标准)轻松分离集群，例如在下面的场景中，所有基于azure集群的配置都部署在“azure-cluster”名称空间上。</p><p id="325d" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">部署capz控制器管理器，并监视Azure特定对象(AzureCluster、AzureMachine等)。)在集群中。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/d13c4adc377351aac07517af7f147a7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Y3GQpmWwA5BhOHHa"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPZ —控制器管理器</figcaption></figure><p id="0c52" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">引导凭证秘密包含所需的服务主体以及允许创建资源的相关角色(类似于ARM)。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mx"><img src="../Images/396b3c2921cf5b5fefdcef4712ccd5b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JkNBZaw9J9bP2XvZ"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPZ —控制器管理器</figcaption></figure><p id="65d0" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">群集中特定于Azure提供商的CRD:</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/63c8dfb63a8ed1264fe3551ba394c939.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lt9WkAQ6OZi3BjPs"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPZ —自定义资源定义</figcaption></figure><p id="874f" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">管理集群上的CAPZ在Azure上创建所需的基础架构:</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/a2f31a04a041c510041cd6c27852b71b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*r7uBXzy_xi7BKLoE"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPZ-Kubernetes星团</figcaption></figure><p id="4da3" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Azure上的虚拟机由CAPZ在管理集群上创建，一旦基础架构创建完成，KCP和KBP将引导一个成熟的HA Kubernetes集群。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/4685cf7a96c289cf220007e92954dd2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2AnyLctBJ77VQRzh"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPZ —机器</figcaption></figure><p id="fc27" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">有了上述配置，用户可以跨多个云提供商管理多个集群。下面是一个示例，列出了命名空间范围内的管理集群上的集群、机器和控制平面:</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/901154193d13b2b325f1bb816babe47a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HaCw2n712VCGXgw9"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI —多基础设施提供商</figcaption></figure><h1 id="2095" class="lh li jf bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">第二天运营—零停机升级和扩展</h1><p id="74b2" class="pw-post-body-paragraph kc kd jf ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ij bi translated">Kubernetes集群级第二天操作包括版本升级、机器映像升级、补丁等。ZDT是一个重要的方面，它对于实时环境始终可用至关重要。CAPA使用的策略是用户无需遵循蓝/绿方法(拥有两个完全相同的集群)。</p><p id="01b6" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">所有升级方案(控制平面和节点——Kubernetes版本升级、控制平面和节点映像升级/更改、规格更改)都遵循滚动更新策略，这与Kubernetes部署非常相似，在Kubernetes部署中，通过增量更新实例来实现零停机。到目前为止，唯一支持的模式是RollingUpdate。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi my"><img src="../Images/c71899b769a66097d391bf70e574258b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SlVJGxYQR2-tbtqL"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI —升级战略</figcaption></figure><p id="afdd" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">kubeadm-bootstrap提供商使用“kubeadm upgrade”实用程序来执行与Kubernetes相关的升级，而基础设施提供商支持云提供商端的滚动更新。Clusterctl也可用于使用相同的kubeadm CLI表示法(clusterctl upgrade plan/apply)执行升级。</p><p id="332e" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Kubeadm升级实用程序—步骤顺序:</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/487335e4ea0f2901056d6762924dadc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ixmU8XnBVWHdAl7x"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Kubeadm —升级</figcaption></figure><h1 id="d9b2" class="lh li jf bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">零停机升级</h1><p id="32b9" class="pw-post-body-paragraph kc kd jf ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ij bi translated">要升级Kubernetes控制平面版本，用户可以修改<em class="mt"> KubeadmControlPlane资源的规范。版本</em>字段。这将触发控制平面的滚动升级。</p><p id="9cc2" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">例如，在上面创建的AWS工作负载集群中，有三个版本为1.17.3的控制器副本:</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi na"><img src="../Images/1a705856bb81335713512a0d633d3ba4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4ullinlnWrkWjg7N"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI —控制平面升级</figcaption></figure><p id="c80e" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">将KubeadmControlPlane规范中的版本1.17.3修改为1.17.5:</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nb"><img src="../Images/c7093a8c519021362ddd3a5055d36922.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hMqJucCBOSkYakqs"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI —控制平面升级</figcaption></figure><p id="6b54" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">控制平面节点的滚动升级:</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/e6e3373138f83d8dc8a6e9baafc97610.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ufJgN6Iyyva2ZdoL"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI —控制平面升级—滚动更新</figcaption></figure><p id="235c" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">类似地，工作负载机器被分组到一个或多个机器部署下，机器部署将透明地管理机器集和机器，以允许无缝扩展体验。对MachineDeployments规范的修改将开始工作负载计算机的滚动更新。作为升级的一部分，所有节点都被封锁并排空。</p><p id="5790" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">节点的滚动升级:</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/72686e45d72dfda24db39381f54dfeb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dVerlxMy_nLq46xh"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI —节点升级—滚动更新</figcaption></figure><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/27221e0022d97633187bbf394425addf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ic748Y-OAovVL7_c"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI —节点升级—机器部署</figcaption></figure><p id="c4a4" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">滚动升级— Kubernetes版本:</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nd"><img src="../Images/f895c63d76a695a6524c09e5f564aec2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-iXljPTKf114VKPb"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI-Kubernetes版本升级</figcaption></figure><h1 id="300f" class="lh li jf bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">缩放节点</h1><p id="15f8" class="pw-post-body-paragraph kc kd jf ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ij bi translated">缩放工作与Kubernetes部署规范工作<em class="mt">中的<em class="mt"> replica_count </em>相同。</em>在v1alpha3中，试验性地增加了“machinepool ”,它作为自动扩展组在云提供商端实施，即使没有it，用户也可以更改KubeadmControlPlane(扩展主节点)或MachineDeployment(扩展节点)中的“<em class="mt">副本</em>”字段，以无缝扩展集群中的实例数量。</p><p id="12ec" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">例如，将MachineDeployment规范中的现有“副本:3”更改为“副本:4”将开始滚动群集中的新节点:</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/0369e952a1bfe6638255d94b86a7512d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_DXItvlTua-Zb8xM"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI—节点缩放</figcaption></figure><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/8cce5f93d7eca057f6998639c815f307.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZHTWCWcE4QX3UWCu"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI —节点扩展—机器部署</figcaption></figure><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/adeca5071c13381a8ddfca7af8aac401.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Qv342BevjXQxLKFQ"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI —节点缩放</figcaption></figure><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/d02106967add2a96fb400f7f3895751b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bfVopwwXywOh0A0i"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI —节点缩放</figcaption></figure><h1 id="c456" class="lh li jf bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">更改基础图像</h1><p id="8678" class="pw-post-body-paragraph kc kd jf ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ij bi translated">实例基础映像更改也遵循相同的滚动更新策略，其中将安装具有已更改映像的较新机器，并使用cordon and drain替换旧实例。</p><p id="c792" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">例如，在AWS场景中，可以修改机器规范中的“ami (Amazon机器映像)”字段，以更改主节点和节点上的基本映像。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ne"><img src="../Images/68d91f8ff30fd4a1da21a3b98bd9af32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lJdF72KRrmvmmq4j"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI —改变机器的基本形象</figcaption></figure><p id="6816" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这将触发具有上面指定的较新映像的节点的滚动更新:</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/f6fdfa2f3b9f9d41a0141a94507b680c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sQ93z23NCfeGtnMz"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI —改变机器的基本形象</figcaption></figure><h1 id="589d" class="lh li jf bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">用户数据/脚本</h1><p id="9e31" class="pw-post-body-paragraph kc kd jf ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ij bi translated">KubeadmConfigTemplate和KubeadmControlPlane使用户能够分两个阶段执行命令:“preKubeadmCommands”和“postKubeadmCommands”。这使得用户能够使用声明性规范提供云初始化类型的指令。例如，通过将VM镜像与所需的清单打包，并使用“postKubeadmCommands”调用它们，这可以用于自动部署任何附加组件。</p><figure class="lc ld le lf gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/0d745bcdee58ae571e99d6172d1edb26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KpjDaFhQAjt53Aid"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CAPI —命令</figcaption></figure></div><div class="ab cl nf ng hu nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="ij ik il im in"><p id="29ac" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">其目的是让集群API用户有一个统一的平台来管理Kubernetes集群及其跨多个云提供商的相关基础设施需求，希望也能在本地实现。用户无需管理具有不同云特定构造的复杂管道，就可以使用CAPI以简单的声明方式跨多个提供商提供和管理Kubernetes集群的整个生命周期，以一种或另一种方式提供零接触提供体验，并允许用户使用中央集群实体管理所有空间分布的Kubernetes集群。</p><p id="a77a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">集群API的采用应该提供跨不同基础设施的可移植性(具有特定于每个云提供商的一些配置细节)。对于用户来说，这意味着相对一致和可靠的用户体验，无论云提供商或内部环境如何。</p></div></div>    
</body>
</html>