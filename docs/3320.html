<html>
<head>
<title>Infrastructure as code: using Pulumi to provision and bootstrap a GCP instance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">代码形式的基础设施:使用Pulumi提供和引导GCP实例</h1>
<blockquote>原文：<a href="https://itnext.io/infrastructure-as-code-using-pulumi-to-provision-and-bootstrap-a-gcp-instance-318f06c61a03?source=collection_archive---------4-----------------------#2019-11-21">https://itnext.io/infrastructure-as-code-using-pulumi-to-provision-and-bootstrap-a-gcp-instance-318f06c61a03?source=collection_archive---------4-----------------------#2019-11-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/7b1305e7604ec5f48e973c107b1ce382.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vuQ4fs_zYLoqVoIw_YS3sA.png"/></div></div></figure><p id="d6a8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这篇文章将向您展示如何使用<a class="ae kz" href="https://www.pulumi.com/docs/index.html" rel="noopener ugc nofollow" target="_blank"> Pulumi </a>作为在Google云平台中提供实例的基础设施即代码工具。对于Pulumi代码示例，我将使用Python。我在MacOS上运行了下面的例子。</p><p id="0c5f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我使用<code class="fe la lb lc ld b">brew</code>来安装pulumi CLI:</p><pre class="le lf lg lh gt li ld lj lk aw ll bi"><span id="536e" class="lm ln it ld b gy lo lp l lq lr">$ brew install pulumi</span></pre><p id="ac22" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果已经安装了pulumi，可以将其升级到最新版本:</p><pre class="le lf lg lh gt li ld lj lk aw ll bi"><span id="81d2" class="lm ln it ld b gy lo lp l lq lr">$ brew upgrade pulumi</span></pre><p id="53b8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下一步是下载<a class="ae kz" href="https://cloud.google.com/sdk/" rel="noopener ugc nofollow" target="_blank"> gcloud SDK和CLI </a>，并按照此处的设置说明进行设置:</p><p id="8965" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae kz" href="https://www.pulumi.com/docs/intro/cloud-providers/gcp/setup/" rel="noopener ugc nofollow" target="_blank">https://www . pulumi . com/docs/intro/cloud-providers/GCP/setup/</a></p><pre class="le lf lg lh gt li ld lj lk aw ll bi"><span id="b30f" class="lm ln it ld b gy lo lp l lq lr"><strong class="ld iu">$ gcloud auth login<br/></strong>You are now logged in as [myuser@example.com].</span><span id="cc67" class="lm ln it ld b gy ls lp l lq lr">Your current project is [myproject]. You can change this setting by running:</span><span id="49c1" class="lm ln it ld b gy ls lp l lq lr">$ gcloud config set project PROJECT_ID</span><span id="968c" class="lm ln it ld b gy ls lp l lq lr"><strong class="ld iu">$ gcloud auth application-default login<br/></strong>Credentials saved to file: [/Users/ggheo/.config/gcloud/application_default_credentials.json]</span><span id="601c" class="lm ln it ld b gy ls lp l lq lr">These credentials will be used by any library that requests</span><span id="6e34" class="lm ln it ld b gy ls lp l lq lr">Application Default Credentials.</span><span id="7000" class="lm ln it ld b gy ls lp l lq lr">To generate an access token for other uses, run:</span><span id="5111" class="lm ln it ld b gy ls lp l lq lr">gcloud auth application-default print-access-token</span></pre><p id="b954" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后我在GCP为Python创建了一个新的Pulumi项目。我将这个项目命名为<code class="fe la lb lc ld b">gcpinfra</code>，并保留了默认的栈名<code class="fe la lb lc ld b">dev</code>。</p><pre class="le lf lg lh gt li ld lj lk aw ll bi"><span id="9819" class="lm ln it ld b gy lo lp l lq lr"><strong class="ld iu">$ pulumi new gcp-python<br/></strong>This command will walk you through creating a new Pulumi project.</span><span id="d12e" class="lm ln it ld b gy ls lp l lq lr">Enter a value or leave blank to accept the (default), and press &lt;ENTER&gt;.</span><span id="a126" class="lm ln it ld b gy ls lp l lq lr">Press ^C at any time to quit.</span><span id="90fe" class="lm ln it ld b gy ls lp l lq lr"><strong class="ld iu">project name</strong>: (<strong class="ld iu">gcpinfra</strong>)</span><span id="b368" class="lm ln it ld b gy ls lp l lq lr"><strong class="ld iu">project description</strong>: (A minimal Google Cloud Python Pulumi program) <strong class="ld iu">Provision GCP infrastructure resources</strong></span><span id="7492" class="lm ln it ld b gy ls lp l lq lr"><strong class="ld iu">Created project ‘gcpinfra’</strong></span><span id="04ba" class="lm ln it ld b gy ls lp l lq lr">Please enter your desired stack name.</span><span id="d721" class="lm ln it ld b gy ls lp l lq lr">To create a stack in an organization, use the format &lt;org-name&gt;/&lt;stack-name&gt; (e.g. `acmecorp/dev`).</span><span id="d878" class="lm ln it ld b gy ls lp l lq lr"><strong class="ld iu">stack name</strong>: (dev)<strong class="ld iu"> dev</strong></span><span id="0253" class="lm ln it ld b gy ls lp l lq lr"><strong class="ld iu">Created stack ‘dev’</strong></span><span id="03d0" class="lm ln it ld b gy ls lp l lq lr"><strong class="ld iu">project: The Google Cloud project to deploy into: myproject</strong></span><span id="cd67" class="lm ln it ld b gy ls lp l lq lr">Saved config</span><span id="5820" class="lm ln it ld b gy ls lp l lq lr">Your new project is ready to go! ✨</span><span id="4a11" class="lm ln it ld b gy ls lp l lq lr">To perform an initial deployment, run the following commands:</span><span id="989f" class="lm ln it ld b gy ls lp l lq lr">1. virtualenv -p python3 venv</span><span id="2951" class="lm ln it ld b gy ls lp l lq lr">2. source venv/bin/activate</span><span id="ed67" class="lm ln it ld b gy ls lp l lq lr">3. pip3 install -r requirements.txt</span><span id="0793" class="lm ln it ld b gy ls lp l lq lr">Then, run ‘pulumi up’</span></pre><p id="c4fd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我创建并激活了一个基于Python 3的虚拟环境，然后通过<code class="fe la lb lc ld b">pip3 install -r requirements.txt</code>安装了Pulumi需求:</p><pre class="le lf lg lh gt li ld lj lk aw ll bi"><span id="fed8" class="lm ln it ld b gy lo lp l lq lr"><strong class="ld iu">$ virtualenv -p /usr/local/bin/python3 venv<br/></strong>Running virtualenv with interpreter /usr/local/bin/python3</span><span id="80ac" class="lm ln it ld b gy ls lp l lq lr">Using base prefix ‘/usr/local/Cellar/python/3.7.4/Frameworks/Python.framework/Versions/3.7’<br/>New python executable in /Users/ggheo/code/mycode/codepraxis/mymooc/pulumi/gcpinfra/venv/bin/python3.7<br/>Also creating executable in /Users/ggheo/code/pulumi/gcpinfra/venv/bin/python<br/>Installing setuptools, pip, wheel…<br/>done.</span><span id="2805" class="lm ln it ld b gy ls lp l lq lr"><strong class="ld iu">$ source venv/bin/activate</strong></span><span id="7a21" class="lm ln it ld b gy ls lp l lq lr"><strong class="ld iu">$ pip3 install -r requirements.txt</strong></span></pre><p id="281b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">此时，我可以看到创建了以下文件:</p><pre class="le lf lg lh gt li ld lj lk aw ll bi"><span id="3bac" class="lm ln it ld b gy lo lp l lq lr"><strong class="ld iu">$ ls -la</strong>total 40</span><span id="e9db" class="lm ln it ld b gy ls lp l lq lr">drwxr-xr-x 8 ggheo staff 256 Nov 16 15:53 .</span><span id="a954" class="lm ln it ld b gy ls lp l lq lr">drwxr-xr-x 4 ggheo staff 128 Nov 16 15:51 ..<br/>-rw — — — — 1 ggheo staff 12 Nov 16 15:51 .gitignore<br/>-rw-r — r — 1 ggheo staff 35 Nov 16 15:52 Pulumi.dev.yaml<br/>-rw — — — — 1 ggheo staff 78 Nov 16 15:51 Pulumi.yaml<br/>-rw — — — — 1 ggheo staff 203 Nov 16 15:51 __main__.py<br/>-rw — — — — 1 ggheo staff 32 Nov 16 15:51 requirements.txt<br/>drwxr-xr-x 6 ggheo staff 192 Nov 16 15:53 venv</span></pre><p id="caf7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Pulumi中的gcp-python示例项目创建了以下Pulumi代码:</p><pre class="le lf lg lh gt li ld lj lk aw ll bi"><span id="f80e" class="lm ln it ld b gy lo lp l lq lr"><strong class="ld iu">$ cat __main__.py<br/></strong>import pulumi<br/>from pulumi_gcp import storage<br/># Create a GCP resource (Storage Bucket)<br/>bucket = storage.Bucket(‘my-bucket’)<br/># Export the DNS name of the bucket<br/>pulumi.export(‘bucket_name’, bucket.url)</span></pre><p id="ea97" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我的下一步是设置一系列<a class="ae kz" href="https://www.pulumi.com/docs/intro/concepts/config/" rel="noopener ugc nofollow" target="_blank"> Pulumi配置变量</a>，我将在我的代码中使用它们:</p><p id="8cde" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu"> GCP具体:</strong></p><pre class="le lf lg lh gt li ld lj lk aw ll bi"><span id="1a5a" class="lm ln it ld b gy lo lp l lq lr">$ pulumi config set gcp:project myproject<br/>$ pulumi config set gcp:region us-central1<br/>$ pulumi config set gcp:zone us-central1-a</span></pre><p id="9fa6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">特定应用:</strong></p><pre class="le lf lg lh gt li ld lj lk aw ll bi"><span id="e992" class="lm ln it ld b gy lo lp l lq lr">$ pulumi config set instance_name dev<br/>$ pulumi config set instance_type n1-highmem-2<br/>$ pulumi config set instance_image ubuntu-1604-xenial-v20191010<br/>$ pulumi config set instance_disk_size 50</span></pre><p id="fe06" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后，我修改了示例__main__。py代码，以便它创建一个GCP实例，并通过init/startup脚本引导它。我的代码基于另一个<a class="ae kz" href="https://github.com/pulumi/examples/blob/master/gcp-py-instance-nginx/__main__.py" rel="noopener ugc nofollow" target="_blank"> Pulumi例子</a>。</p><pre class="le lf lg lh gt li ld lj lk aw ll bi"><span id="11f8" class="lm ln it ld b gy lo lp l lq lr"><strong class="ld iu">$ cat __main__.py<br/></strong>import pulumi<br/>from pulumi_gcp import compute<br/>with open(‘init_script.txt’, ‘r’) as init_script:<br/>    data = init_script.read()<br/>script = data<br/>config = pulumi.Config()<br/>instance_name = config.require(‘instance_name’)<br/>instance_type = config.require(‘instance_type’)<br/>instance_image = config.require(‘instance_image’)<br/>instance_disk_size = config.require(‘instance_disk_size’)</span><span id="2573" class="lm ln it ld b gy ls lp l lq lr">addr = compute.address.Address(instance_name)</span><span id="6bd9" class="lm ln it ld b gy ls lp l lq lr">network = compute.Network(instance_name)<br/>firewall = compute.Firewall(<br/>  instance_name,<br/>  network=network.self_link,<br/>  allows=[<br/>    {<br/>      “protocol”: “tcp”,<br/>      “ports”: [“22”]<br/>    }<br/>  ]<br/>)</span><span id="b9c0" class="lm ln it ld b gy ls lp l lq lr">instance = compute.Instance(<br/>  instance_name,<br/>  name=instance_name,<br/>  machine_type=instance_type,<br/>  boot_disk={<br/>    “initializeParams”: {<br/>       “image”: instance_image,<br/>       “size”: instance_disk_size<br/>     }<br/>  },<br/>  network_interfaces=[<br/>    {<br/>      “network”: network.id,<br/>      “accessConfigs”: [{“nat_ip”: addr.address}]<br/>    }<br/>  ],<br/>  metadata_startup_script=script,<br/>)</span><span id="ab1b" class="lm ln it ld b gy ls lp l lq lr"># Export the DNS name of the bucket<br/>pulumi.export(“instance_name”, instance.name)<br/>pulumi.export(“instance_network”, instance.network_interfaces)<br/>pulumi.export(“external_ip”, addr.address)</span></pre><p id="917c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">注意，我将数据从一个名为init_script.txt的文件传递到计算机。实例构造函数，将其赋给变量metadata_startup_script。</p><p id="b20a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面是init脚本，我在远程实例上添加了我个人的ssh公钥，然后安装docker和docker-compose:</p><pre class="le lf lg lh gt li ld lj lk aw ll bi"><span id="701e" class="lm ln it ld b gy lo lp l lq lr"><strong class="ld iu">$ cat init_script.txt<br/></strong># add ssh pubkey</span><span id="4ba5" class="lm ln it ld b gy ls lp l lq lr">mkdir -p /home/ggheo/.ssh<br/>chmod 700 /home/ggheo/.ssh<br/>echo “ssh-rsa contents of my ssh public key” &gt;&gt; /home/ggheo/.ssh/authorized_keys<br/>chown -R ggheo:ggheo /home/ggheo/.ssh</span><span id="84df" class="lm ln it ld b gy ls lp l lq lr"># install docker</span><span id="0a6b" class="lm ln it ld b gy ls lp l lq lr">sudo apt update<br/>sudo apt install -y make apt-transport-https ca-certificates curl software-properties-common<br/>curl -fsSL <a class="ae kz" href="https://download.docker.com/linux/ubuntu/gpg" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/ubuntu/gpg</a> | sudo apt-key add -<br/>sudo add-apt-repository “deb [arch=amd64] <a class="ae kz" href="https://download.docker.com/linux/ubuntu" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/ubuntu</a> bionic stable”<br/>sudo apt update<br/>sudo apt-cache policy docker-ce<br/>sudo apt install -y docker-ce</span><span id="5e75" class="lm ln it ld b gy ls lp l lq lr"># download docker-compose</span><span id="7276" class="lm ln it ld b gy ls lp l lq lr">sudo curl -L <a class="ae kz" href="https://github.com/docker/compose/releases/download/1.21.2/docker-compose-`uname" rel="noopener ugc nofollow" target="_blank">https://github.com/docker/compose/releases/download/1.21.2/docker-compose-`uname</a> -s`-`uname -m` -o /usr/local/bin/docker-compose<br/>sudo chmod +x /usr/local/bin/docker-compose</span></pre><p id="ea84" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了提供<code class="fe la lb lc ld b">dev</code>堆栈，我运行了:</p><pre class="le lf lg lh gt li ld lj lk aw ll bi"><span id="ffe1" class="lm ln it ld b gy lo lp l lq lr"><strong class="ld iu">$ pulumi up<br/></strong>Previewing update (dev):</span><span id="fe82" class="lm ln it ld b gy ls lp l lq lr">Type Name Plan</span><span id="f621" class="lm ln it ld b gy ls lp l lq lr">+ pulumi:pulumi:Stack gcpinfra-dev create</span><span id="6c83" class="lm ln it ld b gy ls lp l lq lr">+ ├─ gcp:compute:Address dev create</span><span id="fad3" class="lm ln it ld b gy ls lp l lq lr">+ ├─ gcp:compute:Network dev create</span><span id="e158" class="lm ln it ld b gy ls lp l lq lr">+ ├─ gcp:compute:Firewall dev create</span><span id="c9a6" class="lm ln it ld b gy ls lp l lq lr">+ └─ gcp:compute:Instance dev create</span><span id="d58b" class="lm ln it ld b gy ls lp l lq lr">Resources:</span><span id="4421" class="lm ln it ld b gy ls lp l lq lr">+ 5 to create</span><span id="9858" class="lm ln it ld b gy ls lp l lq lr"><strong class="ld iu">Do you want to perform this update? yes</strong></span><span id="5547" class="lm ln it ld b gy ls lp l lq lr">Updating (dev):</span><span id="5051" class="lm ln it ld b gy ls lp l lq lr">Type Name Status</span><span id="5ece" class="lm ln it ld b gy ls lp l lq lr">+ pulumi:pulumi:Stack gcpinfra-dev created</span><span id="78a0" class="lm ln it ld b gy ls lp l lq lr">+ ├─ gcp:compute:Network dev created</span><span id="c2b5" class="lm ln it ld b gy ls lp l lq lr">+ ├─ gcp:compute:Address dev created</span><span id="6519" class="lm ln it ld b gy ls lp l lq lr">+ ├─ gcp:compute:Instance dev created</span><span id="2aef" class="lm ln it ld b gy ls lp l lq lr">+ └─ gcp:compute:Firewall dev created</span><span id="b98c" class="lm ln it ld b gy ls lp l lq lr">Outputs:</span><span id="28a2" class="lm ln it ld b gy ls lp l lq lr">external_ip : “35.223.75.5”</span><span id="ee2a" class="lm ln it ld b gy ls lp l lq lr">instance_name : “dev”</span><span id="e79a" class="lm ln it ld b gy ls lp l lq lr">instance_network: [</span><span id="360b" class="lm ln it ld b gy ls lp l lq lr">[0]: {</span><span id="fd63" class="lm ln it ld b gy ls lp l lq lr">accessConfigs : [</span><span id="7149" class="lm ln it ld b gy ls lp l lq lr">[0]: {</span><span id="8540" class="lm ln it ld b gy ls lp l lq lr">natIp : “35.223.75.5”</span><span id="e03f" class="lm ln it ld b gy ls lp l lq lr">network_tier : “PREMIUM”</span><span id="d27f" class="lm ln it ld b gy ls lp l lq lr">}</span><span id="2d6b" class="lm ln it ld b gy ls lp l lq lr">]</span><span id="9918" class="lm ln it ld b gy ls lp l lq lr">name : “nic0”</span><span id="3590" class="lm ln it ld b gy ls lp l lq lr">network : “https://www.googleapis.com/compute/v1/projects/myproject/global/networks/dev-6de02e1"</span><span id="326e" class="lm ln it ld b gy ls lp l lq lr">networkIp : “10.128.0.2”</span><span id="ff26" class="lm ln it ld b gy ls lp l lq lr">subnetwork : “https://www.googleapis.com/compute/v1/projects/myproject/regions/us-central1/subnetworks/dev-6de02e1"</span><span id="d868" class="lm ln it ld b gy ls lp l lq lr">subnetworkProject: “myproject”</span><span id="e53c" class="lm ln it ld b gy ls lp l lq lr">}</span><span id="c103" class="lm ln it ld b gy ls lp l lq lr">]</span><span id="7114" class="lm ln it ld b gy ls lp l lq lr">Resources:</span><span id="d4e5" class="lm ln it ld b gy ls lp l lq lr">+ 5 created</span><span id="dcf6" class="lm ln it ld b gy ls lp l lq lr">Duration: 58s</span><span id="1c30" class="lm ln it ld b gy ls lp l lq lr">Permalink: <a class="ae kz" href="https://app.pulumi.com/griggheo/gcpinfra/dev/updates/6" rel="noopener ugc nofollow" target="_blank">https://app.pulumi.com/griggheo/gcpinfra/dev/updates/6</a></span></pre><p id="de2b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我现在能够使用gcloud CLI列出新的GCP实例和ssh:</p><pre class="le lf lg lh gt li ld lj lk aw ll bi"><span id="3203" class="lm ln it ld b gy lo lp l lq lr"><strong class="ld iu">$ gcloud compute instances list<br/></strong>NAME ZONE MACHINE_TYPE PREEMPTIBLE INTERNAL_IP EXTERNAL_IP STATUS<br/>dev us-central1-a n1-highmem-2 10.128.0.2 35.223.75.5 RUNNING</span><span id="efab" class="lm ln it ld b gy ls lp l lq lr"><strong class="ld iu">$ gcloud compute ssh dev<br/></strong>Warning: Permanently added ‘compute.1672722981827980594’ (ECDSA) to the list of known hosts.<br/>Welcome to Ubuntu 16.04.6 LTS (GNU/Linux 4.15.0–1046-gcp x86_64)<br/>* Documentation: <a class="ae kz" href="https://help.ubuntu.com" rel="noopener ugc nofollow" target="_blank">https://help.ubuntu.com</a><br/>* Management: <a class="ae kz" href="https://landscape.canonical.com" rel="noopener ugc nofollow" target="_blank">https://landscape.canonical.com</a><br/>* Support: <a class="ae kz" href="https://ubuntu.com/advantage" rel="noopener ugc nofollow" target="_blank">https://ubuntu.com/advantage</a><br/>40 packages can be updated.<br/>18 updates are security updates.<br/>The programs included with the Ubuntu system are free software;<br/>the exact distribution terms for each program are described in the<br/>individual files in /usr/share/doc/*/copyright.<br/>Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by<br/>applicable law.<br/><strong class="ld iu">ggheo@dev:~$</strong></span></pre><p id="5fa7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">此时，我验证了docker、docker-compose和tutor安装正确。我可以在/var/log/auth.log中看到init脚本安装命令。</p><p id="bc2b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我还能够直接通过ssh访问远程GCP实例，因为我的ssh密钥被添加到authorized_files中。</p><p id="856c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">作为更新现有Pulumi堆栈的一个例子，让我们修改init脚本，将我们的用户添加到docker组中。我将这一行添加到init_script.txt的末尾:</p><pre class="le lf lg lh gt li ld lj lk aw ll bi"><span id="643f" class="lm ln it ld b gy lo lp l lq lr">usermod -a -G docker ggheo</span></pre><p id="65ba" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当运行<code class="fe la lb lc ld b">pulumi up</code>时，它将替换实例，因为它检测到启动脚本已经改变:</p><pre class="le lf lg lh gt li ld lj lk aw ll bi"><span id="3f3e" class="lm ln it ld b gy lo lp l lq lr"><strong class="ld iu">$ pulumi up<br/></strong>Previewing update (dev):</span><span id="b21a" class="lm ln it ld b gy ls lp l lq lr"><strong class="ld iu">Type Name Plan Info</strong></span><span id="656d" class="lm ln it ld b gy ls lp l lq lr"><strong class="ld iu">pulumi:pulumi:Stack gcpinfra-dev</strong></span><span id="1641" class="lm ln it ld b gy ls lp l lq lr"><strong class="ld iu">+- └─ gcp:compute:Instance dev replace [diff: ~metadataStartupScript]</strong></span><span id="96b5" class="lm ln it ld b gy ls lp l lq lr">Outputs:</span><span id="6af0" class="lm ln it ld b gy ls lp l lq lr">~ instance_name : “dev” =&gt; output&lt;string&gt;</span><span id="5791" class="lm ln it ld b gy ls lp l lq lr">- instance_network: [</span><span id="d90b" class="lm ln it ld b gy ls lp l lq lr">- [0]: {</span><span id="a0ca" class="lm ln it ld b gy ls lp l lq lr">- accessConfigs : [</span><span id="1b08" class="lm ln it ld b gy ls lp l lq lr">- [0]: {</span><span id="75c4" class="lm ln it ld b gy ls lp l lq lr">- natIp : “35.223.75.5”</span><span id="57ff" class="lm ln it ld b gy ls lp l lq lr">- network_tier : “PREMIUM”</span><span id="b034" class="lm ln it ld b gy ls lp l lq lr">}</span><span id="2e8d" class="lm ln it ld b gy ls lp l lq lr">]</span><span id="c758" class="lm ln it ld b gy ls lp l lq lr">- name : “nic0”</span><span id="1e45" class="lm ln it ld b gy ls lp l lq lr">- network : “https://www.googleapis.com/compute/v1/projects/myproject/global/networks/dev-6de02e1"</span><span id="fab3" class="lm ln it ld b gy ls lp l lq lr">- networkIp : “10.128.0.2”</span><span id="b298" class="lm ln it ld b gy ls lp l lq lr">- subnetwork : “https://www.googleapis.com/compute/v1/projects/myproject/regions/us-central1/subnetworks/dev-6de02e1"</span><span id="3602" class="lm ln it ld b gy ls lp l lq lr">- subnetworkProject: “myproject”</span><span id="d285" class="lm ln it ld b gy ls lp l lq lr">}</span><span id="1ad0" class="lm ln it ld b gy ls lp l lq lr">]</span><span id="c73b" class="lm ln it ld b gy ls lp l lq lr">+ instance_network: output&lt;string&gt;</span><span id="0ecf" class="lm ln it ld b gy ls lp l lq lr">Resources:</span><span id="c490" class="lm ln it ld b gy ls lp l lq lr">+-1 to replace</span><span id="4d3c" class="lm ln it ld b gy ls lp l lq lr">4 unchanged</span><span id="e1d7" class="lm ln it ld b gy ls lp l lq lr">Do you want to perform this update? yes</span><span id="c58b" class="lm ln it ld b gy ls lp l lq lr">Updating (dev):</span><span id="3372" class="lm ln it ld b gy ls lp l lq lr">Type Name Status Info</span><span id="20d2" class="lm ln it ld b gy ls lp l lq lr">pulumi:pulumi:Stack gcpinfra-dev</span><span id="94d6" class="lm ln it ld b gy ls lp l lq lr">+- └─ gcp:compute:Instance dev replaced [diff: ~metadataStartupScript]</span><span id="a8b7" class="lm ln it ld b gy ls lp l lq lr">Outputs:</span><span id="655c" class="lm ln it ld b gy ls lp l lq lr">external_ip : “35.223.75.5”</span><span id="f260" class="lm ln it ld b gy ls lp l lq lr">instance_name : “dev”</span><span id="f9b5" class="lm ln it ld b gy ls lp l lq lr">~ instance_network: [</span><span id="1ff0" class="lm ln it ld b gy ls lp l lq lr">~ [0]: {</span><span id="7ad1" class="lm ln it ld b gy ls lp l lq lr">accessConfigs : [</span><span id="35b4" class="lm ln it ld b gy ls lp l lq lr">[0]: {</span><span id="3bd5" class="lm ln it ld b gy ls lp l lq lr">natIp : “35.223.75.5”</span><span id="dc2d" class="lm ln it ld b gy ls lp l lq lr">network_tier : “PREMIUM”</span><span id="d922" class="lm ln it ld b gy ls lp l lq lr">}</span><span id="6d8c" class="lm ln it ld b gy ls lp l lq lr">]</span><span id="fb7d" class="lm ln it ld b gy ls lp l lq lr">name : “nic0”</span><span id="4256" class="lm ln it ld b gy ls lp l lq lr">network : “https://www.googleapis.com/compute/v1/projects/myproject/global/networks/dev-6de02e1"</span><span id="0d9a" class="lm ln it ld b gy ls lp l lq lr">~ networkIp : “10.128.0.2” =&gt; “10.128.0.3”</span><span id="0a5d" class="lm ln it ld b gy ls lp l lq lr">subnetwork : “https://www.googleapis.com/compute/v1/projects/myproject/regions/us-central1/subnetworks/dev-6de02e1"</span><span id="5ba2" class="lm ln it ld b gy ls lp l lq lr">subnetworkProject: “myproject”</span><span id="ebc0" class="lm ln it ld b gy ls lp l lq lr">}</span><span id="8a97" class="lm ln it ld b gy ls lp l lq lr">]</span><span id="54eb" class="lm ln it ld b gy ls lp l lq lr">Resources:</span><span id="ffc3" class="lm ln it ld b gy ls lp l lq lr">+-1 replaced</span><span id="986c" class="lm ln it ld b gy ls lp l lq lr">4 unchanged</span><span id="9fbf" class="lm ln it ld b gy ls lp l lq lr">Duration: 2m12s</span></pre><p id="4246" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我的最后一个例子将展示如何通过元数据将值传递给实例来定制远程实例上的环境。例如，当您希望在远程实例的引导过程中创建包含某些自定义值的文件时，这可能会很有用。</p><p id="d4f2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面举例说明如何根据作为元数据传递的自定义值，在远程实例上自定义“当日消息”(又名MOTD)问候语。</p><p id="6fe1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我首先在pulumi中设置了一个名为<code class="fe la lb lc ld b">motdgreeting</code>的配置变量:</p><pre class="le lf lg lh gt li ld lj lk aw ll bi"><span id="5d99" class="lm ln it ld b gy lo lp l lq lr"><strong class="ld iu">$ pulumi config set motdgreeting ‘Hello from dev instance’</strong></span></pre><p id="fcdb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我在__main__py中读取这个配置变量的值，并将其作为<code class="fe la lb lc ld b">metadata</code>字典中<code class="fe la lb lc ld b">motdgreeting</code>键的值传递给<code class="fe la lb lc ld b">compute.Instance</code>构造函数:</p><pre class="le lf lg lh gt li ld lj lk aw ll bi"><span id="8499" class="lm ln it ld b gy lo lp l lq lr"># example of metadata variable</span><span id="e586" class="lm ln it ld b gy ls lp l lq lr">motd_greeting = config.require(‘motdgreeting’)</span><span id="8185" class="lm ln it ld b gy ls lp l lq lr">instance = compute.Instance(<br/>  instance_name,<br/>  name=instance_name,<br/>  machine_type=instance_type,<br/>  boot_disk={<br/>    “initializeParams”: {<br/>       “image”: instance_image,<br/>       “size”: instance_disk_size<br/>     }<br/>  },<br/>  network_interfaces=[<br/>    {<br/>      “network”: network.id,<br/>      “accessConfigs”: [{“nat_ip”: addr.address}]<br/>    }<br/>  ],<br/>  metadata_startup_script=script,<br/>  metadata={<br/>    “motdgreeting”: motd_greeting,<br/>  },<br/>)</span></pre><p id="09c7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">最后，我在init脚本中检索了<code class="fe la lb lc ld b">motdgreeting</code>元数据变量的值，并使用它来设置MOTD消息:</p><pre class="le lf lg lh gt li ld lj lk aw ll bi"><span id="441d" class="lm ln it ld b gy lo lp l lq lr">MOTD_GREETING=$(curl <a class="ae kz" href="http://metadata.google.internal/computeMetadata/v1/instance/attributes/motdgreeting" rel="noopener ugc nofollow" target="_blank">http://metadata.google.internal/computeMetadata/v1/instance/attributes/motdgreeting</a> -H “Metadata-Flavor: Google”)<br/>echo “$MOTD_GREETING” &gt; /etc/motd</span></pre><p id="8417" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您一直在跟踪，现在您已经有了一个在GCP运行的实例，您可以ssh到它，它已经在运行docker，您知道如何根据您的需要定制它。如果你不打算使用这个实例，不要忘记删除它，这样你就不会为此付费。为此，您可以运行:</p><pre class="le lf lg lh gt li ld lj lk aw ll bi"><span id="71a4" class="lm ln it ld b gy lo lp l lq lr"><strong class="ld iu">$ pulumi destroy</strong></span></pre></div></div>    
</body>
</html>