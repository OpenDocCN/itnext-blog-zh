<html>
<head>
<title>Build a Referral System in Node-Express and Postgres</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Node-Express和Postgres中建立一个查询系统</h1>
<blockquote>原文：<a href="https://itnext.io/build-a-referral-system-in-node-express-and-postgres-da56fa4913d4?source=collection_archive---------3-----------------------#2018-03-20">https://itnext.io/build-a-referral-system-in-node-express-and-postgres-da56fa4913d4?source=collection_archive---------3-----------------------#2018-03-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/2b0668cbd6c736c35c95d71d15ae0e84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mnC2KfSvmfp3Nw3Tfz7mYA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://medium.com/buttercloud-labs/how-to-build-a-referral-program-to-encourage-word-of-mouth-marketing-b77ff30f07d9" rel="noopener">图像来源</a></figcaption></figure><p id="a22d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">口碑是当今最有效的营销策略之一。我们每天都看到许多公司利用推荐计划进行有针对性的促销和营销。但是这些推荐项目是如何建立的呢？背后的逻辑是什么？今天，我们将通过建立一个我们自己简单而完整的查询系统来回答这些问题。</p><p id="4395" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是让我们先看看这个应用程序吧！这就对了，伙计:点击那个-【https://invitation-system.herokuapp.com/ T2】</p><p id="b8fb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你可以在这里看到资源库:【https://github.com/akshar07/invitation-system】T4</p><p id="8b4a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">酷！这就是我们将要建造的:</p><p id="389e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将有2个应用程序:</p><ul class=""><li id="4662" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">应用程序接口</li><li id="9716" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">Web客户端</li></ul><p id="1a0e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Web客户端将有两个视图:</p><ul class=""><li id="1a46" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">一个<strong class="kf ir">仪表板</strong>认证用户能够发送邀请到一个电子邮件地址的消息，并列出所有邀请及其状态(可见或不可见)</li><li id="e1df" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><strong class="kf ir">收件人查看邀请的</strong>，他可以看到邀请消息和发件人信息</li></ul><p id="d2e7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该API将创建一个邀请发送者，接收者和每个邀请将通过唯一的网址访问。</p><p id="64c4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将使用以下组件来构建它:</p><ul class=""><li id="e342" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">节点快递服务器</li><li id="2e89" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">Postgres数据库</li><li id="18f6" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">用于发送电子邮件的节点电子邮件程序</li><li id="7ab0" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">用于社交认证的passportJS</li></ul><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi lp"><img src="../Images/9087719cbcd3dbfc925c0d39c1978947.png" data-original-src="https://miro.medium.com/v2/resize:fit:784/format:webp/1*28ODTcYuHJVlwsqTrZvGeg.png"/></div></figure><p id="be8e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">我们开始吧</strong></p><ol class=""><li id="8e1f" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lu lh li lj bi translated">初始化新项目:</li></ol><pre class="lq lr ls lt gt lv lw lx ly aw lz bi"><span id="48e6" class="ma mb iq lw b gy mc md l me mf">npm init --y</span></pre><p id="75a3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在package.json中添加以下依赖项:</p><figure class="lq lr ls lt gt jr"><div class="bz fp l di"><div class="mg mh l"/></div></figure><pre class="lq lr ls lt gt lv lw lx ly aw lz bi"><span id="5812" class="ma mb iq lw b gy mc md l me mf">npm install</span></pre><p id="9fcb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦安装，我们将开始在我们的后端工作。</p><p id="ef55" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">设置Postgres: </strong></p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mi"><img src="../Images/bf55c2dff4ba19b0266d139325d18aec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ry4fLo9dW_KN_teivGIMdw.jpeg"/></div></div></figure><figure class="lq lr ls lt gt jr"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="d542" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将有两个表——一个用于存储已验证的<strong class="kf ir">用户</strong>和所需信息，另一个用于存储用户发送的所有<strong class="kf ir">邀请</strong>。我们还将维护一个时间戳，让发件人知道他们的邀请是否被查看。</p><p id="555b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">脸书认证:</strong></p><p id="18e1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我假设你有facebook开发人员帐户和一个应用程序设置。如果没有，有大量的资源介绍如何设置fb应用程序进行开发。也就是说，让我们看看我们如何处理用户注册/用passport JS facebook策略登录。</p><figure class="lq lr ls lt gt jr"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="ee71" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们正在做一些重要的事情:</p><ol class=""><li id="bc63" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lu lh li lj bi translated">一旦我们从facebook取回数据，我们首先检查用户是否已经在我们的系统中。</li><li id="f136" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lu lh li lj bi translated">如果用户在那里，只需调用done方法就可以将用户导航到主页</li><li id="9033" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lu lh li lj bi translated">如果用户不存在，将他添加到我们的数据库中，并调用完成</li><li id="5bb0" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lu lh li lj bi translated">我们还检查我们的generateid函数是否没有生成带连字符的字符串，因为这将导致我们进一步的逻辑出现问题。</li></ol><p id="5b1e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">首页:</strong></p><figure class="lq lr ls lt gt jr"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="aa8f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">主页视图:</p><p id="0ae8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将保持用户仪表板非常简单:</p><figure class="lq lr ls lt gt jr"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="659d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好了，让我们在应用程序中添加邀请功能。我们将让用户输入任何电子邮件id来发送邀请，并附上一条消息。我们的Invite函数如下:</p><figure class="lq lr ls lt gt jr"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="fbea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这里，我们只是收集所有的数据，并将其发布到我们的服务器，在那里我们将实际上添加邀请到我们的数据库，并发送电子邮件给期望的人。</p><figure class="lq lr ls lt gt jr"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="a502" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们首先提取请求数据，并将其插入到数据库中。然后，我们使用send email功能向输入的电子邮件地址发送电子邮件，稍后我们将对此进行探讨。我们还将使用当前时间更新此邀请的created_at值。</p><figure class="lq lr ls lt gt jr"><div class="bz fp l di"><div class="mg mh l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">发送电子邮件功能</figcaption></figure><p id="6311" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里我们使用nodemailer一个发送电子邮件的npm模块。为了安全起见，将您的gmail电子邮件和密码作为环境变量添加到您的服务器中。我们将使用我们的邀请码和接收者邀请码来格式化邀请字符串，以便当用户点击链接时，我们可以很容易地从数据库中获取特定的邀请。</p><pre class="lq lr ls lt gt lv lw lx ly aw lz bi"><span id="9292" class="ma mb iq lw b gy mc md l me mf"><em class="mj">let</em> clientUrl = `https://invitation-system.herokuapp.com/invite/${_from}-${_link}`;</span></pre><p id="fd50" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">注意:更改您的gmail帐户设置以允许不太安全的应用程序，以便nodemailer可以代表您发送邮件。</strong></p><p id="0d12" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在在我们的主页视图中，我们有一个空列表来显示所有用户的邀请和他们的状态。让我们填充这个列表:</p><figure class="lq lr ls lt gt jr"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="ed20" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们只需将我们唯一的邀请码作为查询参数发送给服务器，就可以获得所有发送的邀请。在服务器端，我们用我们的邀请码查询邀请表，并传回结果。</p><figure class="lq lr ls lt gt jr"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="409e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">太好了！现在，我们只需点击一下，就可以看到我们所有的邀请及其状态。到目前为止一切顺利。</p><p id="9ca8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们必须创建收件人视图。我们将有一个不同的路线。如果您还记得，我们格式化了邀请url，以便在收件人点击它时从我们的数据库中获取特定的邀请。我们现在将分离两个邀请代码，并查询邀请表以获得准确的邀请数据。</p><figure class="lq lr ls lt gt jr"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="73a4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里我们还做了一件更重要的事情，那就是当接收者点击链接时，用当前时间戳更新邀请表中updated_at列的值。因此，我们可以在主主页面板上看到接收者是否看到我们的链接的状态。然后，我们将数据发送回我们的前端，并显示邀请的详细信息。</p><figure class="lq lr ls lt gt jr"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="0bfa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们做到了！做那只狼，在街上发出那些邀请…</p><figure class="lq lr ls lt gt jr"><div class="bz fp l di"><div class="mk mh l"/></div></figure><p id="6384" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我希望你喜欢这篇文章。请在评论区留下你的反馈，如果你喜欢，别忘了鼓掌。</p><p id="841e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">PS:点击下面的鼓掌按钮，其实你也可以像狮子座一样鼓掌。试试看！</p></div></div>    
</body>
</html>