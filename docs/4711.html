<html>
<head>
<title>How to Elastic SIEM (part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何弹性化SIEM(第二部分)</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-elastic-siem-part-2-bf0940f745e5?source=collection_archive---------0-----------------------#2020-08-29">https://itnext.io/how-to-elastic-siem-part-2-bf0940f745e5?source=collection_archive---------0-----------------------#2020-08-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/9221b594f6306a3e426a395af380e373.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*88hCyuonN53ipu4d.jpg"/></div></div></figure><div class=""/><p id="e50b" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这是上一个故事<a class="ae kz" rel="noopener ugc nofollow" target="_blank" href="/how-to-elastic-siem-part-1-a39167b8bd23">的延续。这一次，我们将查看弹性SIEM中的“检测”选项卡。我们的目标是使用成熟的规则自动检测IOC。提醒一下:我们在其中一个虚拟机上安装了Elasticsearch + Kibana。我们监控一个Ubuntu (Auditbeat，Filebeat，Packetbeat)和Windows 10 VM (Winlogbeat)，虽然在这个故事中我们将重点放在Windows上。</a></p><figure class="lb lc ld le gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi la"><img src="../Images/e8c37cc6e56a5fb30a5c2392da67ba0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Sk9TyMmeoU2TZeKX.png"/></div></div></figure><h1 id="e219" class="lf lg je bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">如何解锁弹性SIEM中的检测？</h1><p id="579a" class="pw-post-body-paragraph kb kc je kd b ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku mh kw kx ky im bi translated">我们必须:</p><ul class=""><li id="f18b" class="mi mj je kd b ke kf ki kj km mk kq ml ku mm ky mn mo mp mq bi translated">通过TLS提供elastic search-Kiban通信</li><li id="94cd" class="mi mj je kd b ke mr ki ms km mt kq mu ku mv ky mn mo mp mq bi translated">在Elasticsearch中启用xpack.security</li><li id="cec5" class="mi mj je kd b ke mr ki ms km mt kq mu ku mv ky mn mo mp mq bi translated">在Kibana中设置xpack . encryptedsavedobjects . encryption key</li></ul><h2 id="d97b" class="mw lg je bd lh mx my dn ll mz na dp lp km nb nc lt kq nd ne lx ku nf ng mb nh bi translated">保护弹性搜索</h2><p id="9d99" class="pw-post-body-paragraph kb kc je kd b ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku mh kw kx ky im bi translated">在本例中，我们有一个单节点的Elasticsearch集群，所以我们需要做的就是在<code class="fe ni nj nk nl b">/etc/elasticsearch/elasticsearch.yml</code>行的末尾添加一行</p><pre class="lb lc ld le gt nm nl nn no aw np bi"><span id="5e2d" class="mw lg je nl b gy nq nr l ns nt">xpack.security.enabled:<!-- --> <!-- -->true</span></pre><p id="c222" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">并重新启动Elasticsearch服务</p><pre class="lb lc ld le gt nm nl nn no aw np bi"><span id="e678" class="mw lg je nl b gy nq nr l ns nt">service elasticsearch restart</span></pre><blockquote class="nu nv nw"><p id="7296" class="kb kc nx kd b ke kf kg kh ki kj kk kl ny kn ko kp nz kr ks kt oa kv kw kx ky im bi translated"><strong class="kd jf">注意</strong>:对于普通集群来说，这并不容易。您需要保护节点之间的通信。<a class="ae kz" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/configuring-tls.html" rel="noopener ugc nofollow" target="_blank">在这里你可以找到详细信息。</a></p></blockquote><p id="983e" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们刚刚破坏了整个日志系统，因为从现在开始需要认证😉。</p><pre class="lb lc ld le gt nm nl nn no aw np bi"><span id="8662" class="mw lg je nl b gy nq nr l ns nt">root@ELK:/etc/elasticsearch# curl localhost:9200?pretty<br/>{<br/>  "error" : {<br/>    "root_cause" : [<br/>      {<br/>        "type" : "security_exception",<br/>        "reason" : "missing authentication credentials for REST request [/?pretty]",<br/>        "header" : {<br/>          "WWW-Authenticate" : "Basic realm=\"security\" charset=\"UTF-8\""<br/>        }<br/>      }<br/>    ],<br/>    "type" : "security_exception",<br/>    "reason" : "missing authentication credentials for REST request [/?pretty]",<br/>    "header" : {<br/>      "WWW-Authenticate" : "Basic realm=\"security\" charset=\"UTF-8\""<br/>    }<br/>  },<br/>  "status" : 401<br/>}</span></pre><p id="062b" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们需要生成默认帐户和密码。为此使用了一个特殊的<code class="fe ni nj nk nl b">elasticsearch-setup-passwords</code>工具，位于Elasticsearch目录下，即<code class="fe ni nj nk nl b">/usr/share/elasticsearch/bin/</code>。我在任何地方都使用相同的密码(<em class="nx">弹性</em>)。请不要重复那个😊。</p><pre class="lb lc ld le gt nm nl nn no aw np bi"><span id="ed6d" class="mw lg je nl b gy nq nr l ns nt">root@ELK:/etc/elasticsearch# cd /usr/share/elasticsearch/<br/>root@ELK:/usr/share/elasticsearch# bin/elasticsearch-setup-passwords interactive<br/>Initiating the setup of passwords for reserved users elastic,apm_system,kibana,kibana_system,logstash_system,beats_system,remote_monitoring_user.<br/>You will be prompted to enter passwords as the process progresses.<br/>Please confirm that you would like to continue [y/N]y<br/> <br/> <br/>Enter password for [elastic]:<br/>Reenter password for [elastic]:<br/>Enter password for [apm_system]:<br/>Reenter password for [apm_system]:<br/>Enter password for [kibana_system]:<br/>Reenter password for [kibana_system]:<br/>Enter password for [logstash_system]:<br/>Reenter password for [logstash_system]:<br/>Enter password for [beats_system]:<br/>Reenter password for [beats_system]:<br/>Enter password for [remote_monitoring_user]:<br/>Reenter password for [remote_monitoring_user]:<br/>Changed password for user [apm_system]<br/>Changed password for user [kibana_system]<br/>Changed password for user [kibana]<br/>Changed password for user [logstash_system]<br/>Changed password for user [beats_system]<br/>Changed password for user [remote_monitoring_user]<br/>Changed password for user [elastic]</span></pre><p id="bd87" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在Elasticsearch会在我们提供登录名和密码后回复。</p><pre class="lb lc ld le gt nm nl nn no aw np bi"><span id="4792" class="mw lg je nl b gy nq nr l ns nt">root@ELK:/usr/share/elasticsearch# curl -u elastic:elastic localhost:9200?pretty <br/>{                                                                                <br/>  "name" : "ELK",                                                                <br/>  "cluster_name" : "siem",                                                       <br/>  "cluster_uuid" : "u6FDeHNsTmWJcnf-jYUH7Q",                                     <br/>  "version" : {                                                                  <br/>    "number" : "7.8.1",                                                          <br/>    "build_flavor" : "default",                                                  <br/>    "build_type" : "deb",                                                        <br/>    "build_hash" : "b5ca9c58fb664ca8bf9e4057fc229b3396bf3a89",                   <br/>    "build_date" : "2020-07-21T16:40:44.668009Z",                                <br/>    "build_snapshot" : false,                                                    <br/>    "lucene_version" : "8.5.1",                                                  <br/>    "minimum_wire_compatibility_version" : "6.8.0",                              <br/>    "minimum_index_compatibility_version" : "6.0.0-beta1"                       <br/>  },                                                                             <br/>  "tagline" : "You Know, for Search"                                            <br/>}</span></pre><p id="938b" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们还需要通过将登录名和密码添加到<code class="fe ni nj nk nl b">/etc/kibana/kibana.yml</code>来“修复”Kibana</p><pre class="lb lc ld le gt nm nl nn no aw np bi"><span id="a38a" class="mw lg je nl b gy nq nr l ns nt">...<br/>elasticsearch.username: "kibana_system"<br/>elasticsearch.password: "elastic"<br/>...</span></pre><h2 id="8026" class="mw lg je bd lh mx my dn ll mz na dp lp km nb nc lt kq nd ne lx ku nf ng mb nh bi translated">Elasticsearch和Kibana之间的TLS</h2><p id="75d8" class="pw-post-body-paragraph kb kc je kd b ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku mh kw kx ky im bi translated">要配置TLS，我们需要CA和证书。如果你有PKI——很好——如果没有，你需要生成CA。Elasticsearch有一个叫做<code class="fe ni nj nk nl b">elasticsearch-certutil</code>的特殊工具，它会简化这个过程。</p><pre class="lb lc ld le gt nm nl nn no aw np bi"><span id="6001" class="mw lg je nl b gy nq nr l ns nt">root@ELK:/usr/share/elasticsearch# ./bin/elasticsearch-certutil ca<br/>This tool assists you in the generation of X.509 certificates and certificate<br/>signing requests for use with SSL/TLS in the Elastic stack.<br/> <br/>The 'ca' mode generates a new 'certificate authority'<br/>This will create a new X.509 certificate and private key that can be used<br/>to sign certificate when running in 'cert' mode.<br/> <br/>Use the 'ca-dn' option if you wish to configure the 'distinguished name'<br/>of the certificate authority<br/> <br/>By default the 'ca' mode produces a single PKCS#12 output file which holds:<br/>    * The CA certificate<br/>    * The CA's private key<br/> <br/>If you elect to generate PEM format certificates (the -pem option), then the output will<br/>be a zip file containing individual files for the CA certificate and private key<br/> <br/>Please enter the desired output file [elastic-stack-ca.p12]:<br/>Enter password for elastic-stack-ca.p12 :</span></pre><p id="6f07" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">生成CA ( <code class="fe ni nj nk nl b">elastic-stack-ca.p12</code>)后，我们可以创建一个证书。</p><pre class="lb lc ld le gt nm nl nn no aw np bi"><span id="ee44" class="mw lg je nl b gy nq nr l ns nt">./bin/elasticsearch-certutil cert --ca elastic-stack-ca.p./bin/elasticsearch-certutil cert \<br/>&gt; --ca elastic-stack-ca.p12 \<br/>&gt; --dns localhost \<br/>&gt; --ip 127.0.0.1 \<br/>&gt; --out http.p12</span></pre><p id="ed86" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">生成的http.12放在<code class="fe ni nj nk nl b">/etc/elasticsearch/certs/</code>中，并设置了对该文件夹的权限。</p><pre class="lb lc ld le gt nm nl nn no aw np bi"><span id="83b9" class="mw lg je nl b gy nq nr l ns nt">mkdir /etc/elasticsearch/certs<br/>cp elastic-stack-ca.p12 /etc/elasticsearch/certs/<br/>cp http.p12 /etc/elasticsearch/certs/<br/>chown -R elasticsearch:elasticsearch /etc/elasticsearch/certs/</span></pre><p id="7571" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，在<code class="fe ni nj nk nl b">/etc/elasticsearch/elasticsearch.yml</code>中，我们可以添加创建的证书。如果您不喜欢在配置文件中明确输入您的密码，还有一个带有密钥库的选项。</p><pre class="lb lc ld le gt nm nl nn no aw np bi"><span id="89f7" class="mw lg je nl b gy nq nr l ns nt">...<br/>xpack.security.http.ssl.enabled: true<br/>xpack.security.http.ssl.keystore.path: "./certs/http.p12"<br/>xpack.security.http.ssl.keystore.password: "elastic"</span></pre><p id="17cb" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">重新启动服务后，我们可以向集群发送请求。</p><pre class="lb lc ld le gt nm nl nn no aw np bi"><span id="1491" class="mw lg je nl b gy nq nr l ns nt">root@ELK:/etc/elasticsearch# curl -u elastic:elastic localhost:9200?pretty<br/>curl: (52) Empty reply from server</span></pre><p id="2d88" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们需要将url改为<code class="fe ni nj nk nl b"><a class="ae kz" href="https://" rel="noopener ugc nofollow" target="_blank">https://</a>...</code>，但是不可信的CA会有问题。</p><pre class="lb lc ld le gt nm nl nn no aw np bi"><span id="0e58" class="mw lg je nl b gy nq nr l ns nt">root@ELK:/etc/elasticsearch# curl -u elastic:elastic <a class="ae kz" href="https://localhost:9200?pretty" rel="noopener ugc nofollow" target="_blank">https://localhost:9200?pretty</a><br/>curl: (60) SSL certificate problem: self signed certificate in certificate chain<br/>More details here: <a class="ae kz" href="https://curl.haxx.se/docs/sslcerts.html" rel="noopener ugc nofollow" target="_blank">https://curl.haxx.se/docs/sslcerts.html</a><br/> <br/>curl failed to verify the legitimacy of the server and therefore could not<br/>establish a secure connection to it. To learn more about this situation and<br/>how to fix it, please visit the web page mentioned above.</span></pre><p id="9e10" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">…我们可以使用<code class="fe ni nj nk nl b">--insecure</code>忽略它😎。</p><pre class="lb lc ld le gt nm nl nn no aw np bi"><span id="87f8" class="mw lg je nl b gy nq nr l ns nt">root@ELK:/etc/elasticsearch# curl -u elastic:elastic --insecure <a class="ae kz" href="https://localhost:9200?pretty" rel="noopener ugc nofollow" target="_blank">https://localhost:9200?pretty</a> <br/>{                                   <br/>  "name" : "ELK",                   <br/>  "cluster_name" : "siem",          <br/>  "cluster_uuid" : "u6FDeHNsTmWJcnf-<br/>  "version" : {                     <br/>    "number" : "7.8.1",             <br/>    "build_flavor" : "default",     <br/>    "build_type" : "deb",           <br/>    "build_hash" : "b5ca9c58fb664ca8<br/>    "build_date" : "2020-07-21T16:40<br/>    "build_snapshot" : false,       <br/>    "lucene_version" : "8.5.1",     <br/>    "minimum_wire_compatibility_vers<br/>    "minimum_index_compatibility_ver<br/>  },                                <br/>  "tagline" : "You Know, for Search"<br/>}</span></pre><h2 id="097e" class="mw lg je bd lh mx my dn ll mz na dp lp km nb nc lt kq nd ne lx ku nf ng mb nh bi translated">基巴纳的修复——在我们信任的加州</h2><p id="4323" class="pw-post-body-paragraph kb kc je kd b ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku mh kw kx ky im bi translated">我们还得修理基巴纳。代替PKCS12，我们将以PEM文件的形式获取CA，并将其放入Kibana config目录。</p><pre class="lb lc ld le gt nm nl nn no aw np bi"><span id="814f" class="mw lg je nl b gy nq nr l ns nt">openssl pkcs12 -in elastic-stack-ca.p12 -out ca.pem -clcerts -noke ys<br/>cp cert.pem /etc/kibana<br/>chown kibana:kibana /etc/kibana/ca.pem</span></pre><p id="4d74" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在我们所要做的就是将条目添加到<code class="fe ni nj nk nl b">/etc/kibana/kibana.yml</code>并重启Kibana服务。</p><pre class="lb lc ld le gt nm nl nn no aw np bi"><span id="aba2" class="mw lg je nl b gy nq nr l ns nt">...<br/>elasticsearch.hosts: ["<a class="ae kz" href="https://localhost:9200" rel="noopener ugc nofollow" target="_blank">https://localhost:9200</a>"]<br/>elasticsearch.ssl.certificateAuthorities: ["/etc/kibana/ca.pem"]<br/>...<br/>xpack.encryptedSavedObjects.encryptionKey: 'fhjskloppd678ehkdfdlliverpoolfcr'</span></pre><figure class="lb lc ld le gt iv gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/6312afaf42b3a0a8d8117e7991144c56.png" data-original-src="https://miro.medium.com/v2/resize:fit:892/format:webp/0*Za9WbF0NeabPeOGG.png"/></div></figure><h2 id="6fa3" class="mw lg je bd lh mx my dn ll mz na dp lp km nb nc lt kq nd ne lx ku nf ng mb nh bi translated">Beats修复</h2><p id="585b" class="pw-post-body-paragraph kb kc je kd b ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku mh kw kx ky im bi translated">你可能以为一切都结束了。惊喜！😉Elasticsearch现在需要认证。我们将<strong class="kd jf">简化</strong>修复:使用超级用户帐号并忽略CA验证。<strong class="kd jf">不要在生产中这样做！</strong></p><p id="060a" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">修复包括正确配置输出。弹性搜索部分。</p><pre class="lb lc ld le gt nm nl nn no aw np bi"><span id="6443" class="mw lg je nl b gy nq nr l ns nt">...<br/>output.elasticsearch:<br/>  # Array of hosts to connect to.<br/>  hosts: ["10.0.0.4:9200"]<br/> <br/>  # Protocol - either `http` (default) or `https`.<br/>  protocol: "https"<br/>  ssl.verification_mode: "none"<br/> <br/>  # Authentication credentials - either API key or username/password.<br/>  #api_key: "id:api_key"<br/>  username: "elastic"<br/>  password: "elastic"</span></pre><p id="bfca" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Winlogbeat配置文件可以在这里找到:<code class="fe ni nj nk nl b"><em class="nx">C:\ProgramData\Elastic\Beats\winlogbeat\winlogbeat.yml</em></code> <em class="nx">。</em>您可以通过在PowerShell中键入以下命令来重新启动Winlogbeat服务。</p><pre class="lb lc ld le gt nm nl nn no aw np bi"><span id="8109" class="mw lg je nl b gy nq nr l ns nt">Restart-Service<!-- --> <!-- -->winlogbeat</span></pre><h1 id="664a" class="lf lg je bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">加载默认检测规则弹性SIEM</h1><p id="0612" class="pw-post-body-paragraph kb kc je kd b ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku mh kw kx ky im bi translated">最后，我们可以进入探测舱。我们可以加载预先构建的规则。</p><figure class="lb lc ld le gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oc"><img src="../Images/3bc58108c87720683fc66259109da599.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*D7-KqMt3HoBzincS.png"/></div></div></figure><figure class="lb lc ld le gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi od"><img src="../Images/1beb23f87c401c7d77a49933be5fafa3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8YLZtwAjMiOM5bNC.png"/></div></div></figure><p id="8712" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">默认规则的列表相当大。为了测试，我已经把它们都激活了。</p><figure class="lb lc ld le gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oe"><img src="../Images/6e7983322c4ba2cfe266285b197a0a54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wcoHvqx1R1ZPqIQD.png"/></div></div></figure><p id="bbc5" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">每个规则都有描述和依赖关系。其中一些需要机器学习功能(阅读:不是免费的)。</p><figure class="lb lc ld le gt iv gh gi paragraph-image"><div class="gh gi of"><img src="../Images/e894c39ade14c899b679b221ed845929.png" data-original-src="https://miro.medium.com/v2/resize:fit:980/format:webp/0*99PnAimRxl5KERhq.png"/></div></figure><p id="99fc" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在免费版本中，我们不能发送检测通知。</p><h1 id="e597" class="lf lg je bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">检测机制的验证</h1><h2 id="8b8d" class="mw lg je bd lh mx my dn ll mz na dp lp km nb nc lt kq nd ne lx ku nf ng mb nh bi translated">apt模拟器</h2><p id="d0e1" class="pw-post-body-paragraph kb kc je kd b ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku mh kw kx ky im bi translated">我们将使用装有Windows 10的机器。<a class="ae kz" href="https://github.com/NextronSystems/APTSimulator" rel="noopener ugc nofollow" target="_blank"> APTSimulator </a>将帮助我们做到这一点。下载后，只需解压并启动<code class="fe ni nj nk nl b">APTSimulator.bat</code>。</p><figure class="lb lc ld le gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi og"><img src="../Images/9098b10df6a2aac37442735e36654066.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*p2LqkSCSwM--zvAz.png"/></div></div><figcaption class="oh oi gj gh gi oj ok bd b be z dk translated">选择运行每个测试</figcaption></figure><p id="b6ec" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在是一个惊喜。未检测到生成的攻击。</p><figure class="lb lc ld le gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ol"><img src="../Images/035dbde2f0b38ff0c18fe560b470bc95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*X7CDr67iNlhhOMMi.png"/></div></div></figure><h2 id="6a27" class="mw lg je bd lh mx my dn ll mz na dp lp km nb nc lt kq nd ne lx ku nf ng mb nh bi translated">Sysmon配置</h2><p id="f4eb" class="pw-post-body-paragraph kb kc je kd b ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku mh kw kx ky im bi translated">Winlogbeat收集操作系统提供的尽可能多的数据。我们需要增加我们收集的事件类型。<a class="ae kz" href="https://technet.microsoft.com/en-us/sysinternals/sysmon" rel="noopener ugc nofollow" target="_blank"> Sysmon </a>是一个Windows内部活动监视器。它是一个系统服务，跟踪文件系统、注册表、网络和正在运行的应用程序的活动。</p><p id="56b5" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下载后，我们可以继续安装</p><pre class="lb lc ld le gt nm nl nn no aw np bi"><span id="1c5a" class="mw lg je nl b gy nq nr l ns nt">Sysmon64.exe<!-- --> <!-- -->-i<!-- --> <!-- -->-accepteula<!-- --> <!-- -->-h<!-- --> <!-- -->md5,sha256,imphash<!-- --> <!-- -->-l<!-- --> <!-- -->-n</span></pre><p id="4f59" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这种情况下，我们将希望收集一切。在实践中，我们应该思考哪些事件对我们来说是重要的。我们将使用来自<a class="ae kz" href="https://github.com/Cyb3rWard0g/HELK" rel="noopener ugc nofollow" target="_blank"> HELK </a>项目的配置。这里有一个<a class="ae kz" href="https://gist.github.com/Cyb3rWard0g/136481552d8845e52962534d1a4b8664#file-startlogging-xml" rel="noopener ugc nofollow" target="_blank">链接</a>到配置。</p><pre class="lb lc ld le gt nm nl nn no aw np bi"><span id="18de" class="mw lg je nl b gy nq nr l ns nt">Sysmon64.exe -c config.xml</span></pre><h1 id="41ad" class="lf lg je bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">威胁检测</h1><p id="fe1b" class="pw-post-body-paragraph kb kc je kd b ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku mh kw kx ky im bi translated">重新启动APTSimulator后，您已经可以看到效果了。除了事件本身，我们还可以看到风险水平和信息来源。</p><figure class="lb lc ld le gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi og"><img src="../Images/88c5378a890d3c5b58c2fc65737682fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*oOgJMRSeNGw9NDS6.png"/></div></div></figure><p id="4bfd" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">从检测到的规则视图中，我们可以创建一个新的时间表并开始调查。</p><h1 id="c08b" class="lf lg je bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">结论</h1><p id="1356" class="pw-post-body-paragraph kb kc je kd b ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku mh kw kx ky im bi translated">我们看到<strong class="kd jf"> SIEM </strong>在<strong class="kd jf">免费版</strong>中已经做得相当不错了<strong class="kd jf"> </strong>。有许多内置规则，我们可以添加自己的规则。不幸的是，我们将无法使用机器学习功能。缺少发送检测通知的可能性也是一个问题，尽管我觉得你可以用<strong class="kd jf"> ElastAlert </strong>来解决这个问题。我猜这些检测只是坐在一些内部索引的某个地方。</p><h1 id="be29" class="lf lg je bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">嘿！</h1><p id="4d9d" class="pw-post-body-paragraph kb kc je kd b ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku mh kw kx ky im bi translated">请记住，在本文中，我们没有保护节点之间的通信(因为这是一个单节点集群)，也没有保护Kibana与客户端的HTTP通信。你也应该避免使用超级用户账号在Beats中与Elasticsearch交流。</p><h1 id="9c3d" class="lf lg je bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">接下来呢？</h1><p id="8b87" class="pw-post-body-paragraph kb kc je kd b ke md kg kh ki me kk kl km mf ko kp kq mg ks kt ku mh kw kx ky im bi translated">我在想<a class="ae kz" href="https://github.com/Yelp/elastalert" rel="noopener ugc nofollow" target="_blank"><strong class="kd jf">ElastAlert</strong></a><strong class="kd jf">和</strong> <a class="ae kz" href="https://github.com/Neo23x0/sigma" rel="noopener ugc nofollow" target="_blank"> <strong class="kd jf">适马</strong> </a>。让我知道你对它的想法。也许你知道些什么？欢迎随时在Twitter或Linkedin上给我发短信。</p></div></div>    
</body>
</html>