<html>
<head>
<title>Writing a Web Socket Server with Embedded Jetty</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用嵌入式Jetty编写Web Socket服务器</h1>
<blockquote>原文：<a href="https://itnext.io/writing-a-web-socket-server-with-embedded-jetty-46fe9ab1c435?source=collection_archive---------0-----------------------#2018-04-01">https://itnext.io/writing-a-web-socket-server-with-embedded-jetty-46fe9ab1c435?source=collection_archive---------0-----------------------#2018-04-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/e96af51d3917fca1529920f2dff896c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:708/1*3gwiR2PRJq4HmIA88jXZYg.gif"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">我们使用web socket进行双向通信</figcaption></figure><p id="1917" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">也许第一个问题是“为什么我们需要web socket？”</p><p id="a304" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">原因可能因人而异。但我们可以总结为:</p><ol class=""><li id="32bb" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">我们需要双向交流</li><li id="006f" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">我们需要长期的联系，这样我们就可以传递更多的信息</li></ol><p id="15e6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我个人的原因是想了解它是如何工作的，因为<a class="ae lk" href="https://signal.org/" rel="noopener ugc nofollow" target="_blank">信号</a>使用它。因此，为了更好地理解它，我想写一个简单的基本的工作示例。我会用嵌入式Jetty写下来，就像(我猜)Signal做的那样。我会把它写下来，这样我的同事项目团队就可以遵循同样的理解过程。</p><blockquote class="ll lm ln"><p id="9f0b" class="jy jz lo ka b kb kc kd ke kf kg kh ki lp kk kl km lq ko kp kq lr ks kt ku kv ij bi translated">在继续之前，我想解释一下，我不会自己实现JSR-356，因为这将是另起炉灶。相反，我使用了Jetty中可用的特定API。</p></blockquote><h1 id="5f33" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">用例优先</h1><p id="bed9" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">我们希望拥有满足以下要求的基本消息服务:</p><ol class=""><li id="1d31" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">用户在做其他事情之前需要登录</li><li id="1fb3" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">用户将能够向其他人发送消息</li><li id="03ad" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">一旦接收者在线，消息服务器应该将消息传送给接收者</li></ol></div><div class="ab cl mv mw hu mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ij ik il im in"><h1 id="ada3" class="ls lt iq bd lu lv nc lx ly lz nd mb mc md ne mf mg mh nf mj mk ml ng mn mo mp bi translated">设置</h1><p id="f09d" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">首先，我们需要设置环境。这包括:创建maven项目，编辑pom.xml文件，第一次构建项目，只是为了下载库文件。</p><ol class=""><li id="3310" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">使用Netbeans创建新的Maven项目。在我的例子中，我将其命名为JettyWebSocket。</li><li id="2221" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">编辑pom.xml文件。放入<code class="fe nh ni nj nk b">jettyVersion</code>属性，然后添加web-socket-server和web-socket-api作为依赖项。pom.xml文件如下所示:</li></ol><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="c850" class="nt lt iq nk b gy nu nv l nw nx">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br/>&lt;project ae lk" href="http://maven.apache.org/POM/4.0.0" rel="noopener ugc nofollow" target="_blank"&gt;http://maven.apache.org/POM/4.0.0" xmlns:xsi="<a class="ae lk" href="http://www.w3.org/2001/XMLSchema-instance" rel="noopener ugc nofollow" target="_blank">http://www.w3.org/2001/XMLSchema-instance</a>" xsi:schemaLocation="<a class="ae lk" href="http://maven.apache.org/POM/4.0.0" rel="noopener ugc nofollow" target="_blank">http://maven.apache.org/POM/4.0.0</a> <a class="ae lk" href="http://maven.apache.org/xsd/maven-4.0.0.xsd" rel="noopener ugc nofollow" target="_blank">http://maven.apache.org/xsd/maven-4.0.0.xsd</a>"&gt;<br/>    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;<br/>    &lt;groupId&gt;id.amrishodiq&lt;/groupId&gt;<br/>    &lt;artifactId&gt;JettyWebSocket&lt;/artifactId&gt;<br/>    &lt;version&gt;1.0.1&lt;/version&gt;<br/>    &lt;packaging&gt;jar&lt;/packaging&gt;<br/>    &lt;properties&gt;<br/>        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;<br/>        &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;<br/>        &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;<br/>        &lt;jettyVersion&gt;<strong class="nk ir">9.4.9.v20180320</strong>&lt;/jettyVersion&gt;<br/>    &lt;/properties&gt;<br/>    &lt;dependencies&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;org.eclipse.jetty.websocket&lt;/groupId&gt;<br/>            &lt;artifactId&gt;<strong class="nk ir">websocket-api</strong>&lt;/artifactId&gt;<br/>            &lt;version&gt;${jettyVersion}&lt;/version&gt;<br/>        &lt;/dependency&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;org.eclipse.jetty.websocket&lt;/groupId&gt;<br/>            &lt;artifactId&gt;<strong class="nk ir">websocket-server</strong>&lt;/artifactId&gt;<br/>            &lt;version&gt;${jettyVersion}&lt;/version&gt;<br/>        &lt;/dependency&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;com.google.code.gson&lt;/groupId&gt;<br/>            &lt;artifactId&gt;<strong class="nk ir">gson</strong>&lt;/artifactId&gt;<br/>            &lt;version&gt;2.8.2&lt;/version&gt;<br/>        &lt;/dependency&gt;<br/>    &lt;/dependencies&gt;<br/>    <br/>    &lt;build&gt;<br/>    &lt;plugins&gt;<br/>        &lt;plugin&gt;<br/>            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br/>            &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;<br/>            &lt;version&gt;3.0&lt;/version&gt;<br/>            &lt;configuration&gt;<br/>              &lt;source&gt;1.7&lt;/source&gt;<br/>              &lt;target&gt;1.7&lt;/target&gt;<br/>            &lt;/configuration&gt;<br/>        &lt;/plugin&gt;<br/>    &lt;/plugins&gt;<br/>  &lt;/build&gt;<br/>&lt;/project&gt;</span></pre><p id="9f5b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.使用Netbeans构建。菜单运行|构建项目。</p><h1 id="626b" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">写代码</h1><p id="08cb" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">该计划将由以下主要部分组成:</p><ol class=""><li id="7092" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">将服务器作为主类应用程序</li><li id="a122" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">MessagingAdapter，它将在客户端打开连接、接收数据(无论是文本还是二进制)、关闭连接、每个客户端连接发生错误时捕获事件</li><li id="993f" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">跟踪每个用户会话的UserSession接口</li><li id="5217" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">消息传递逻辑我们放置消息传递逻辑的地方</li><li id="8dad" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">数据模型</li><li id="0984" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">将处理所有数据相关操作的存储库</li></ol><p id="bceb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将从独立的类开始，在这里是数据模型。希望你熟悉Java。如果我有<code class="fe nh ni nj nk b">User</code>类，并且包名为<code class="fe nh ni nj nk b">id.amrishodiq.jettywebsocket.data</code>，这意味着文件应该是<code class="fe nh ni nj nk b">&lt;project-directory&gt;/id/amrishodiq/jettywebsocket/data/User.java.</code></p><p id="361d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">类别用户</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="18af" class="nt lt iq nk b gy nu nv l nw nx">package id.amrishodiq.jettywebsocket.data;</span><span id="dae3" class="nt lt iq nk b gy ny nv l nw nx">/**<br/> * User representation of the messaging platform.<br/> * <a class="ae lk" href="http://twitter.com/author" rel="noopener ugc nofollow" target="_blank">@author</a> amrishodiq<br/> */<br/>public class User {<br/>    public String username;<br/>    public String password;</span><span id="2b4b" class="nt lt iq nk b gy ny nv l nw nx">public User(String username, String password) {<br/>        this.username = username;<br/>        this.password = password;<br/>    }<br/>}</span></pre><p id="2b35" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">班级信息</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="0606" class="nt lt iq nk b gy nu nv l nw nx">package id.amrishodiq.jettywebsocket.data;</span><span id="3789" class="nt lt iq nk b gy ny nv l nw nx">/**<br/> * Message representation.<br/> * <a class="ae lk" href="http://twitter.com/author" rel="noopener ugc nofollow" target="_blank">@author</a> amrishodiq<br/> */<br/>public class Message {<br/>    public String from;<br/>    public String to;<br/>    public String body;<br/>    public long sent;<br/>}</span></pre><p id="290d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">类别数据</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="d423" class="nt lt iq nk b gy nu nv l nw nx">package id.amrishodiq.jettywebsocket.data;</span><span id="d727" class="nt lt iq nk b gy ny nv l nw nx">/**<br/> * Data is a wrapper for transmittable object between client and server.<br/> * <a class="ae lk" href="http://twitter.com/author" rel="noopener ugc nofollow" target="_blank">@author</a> amrishodiq<br/> */<br/>public class Data {<br/>    public static final int AUTHENTICATION_LOGIN = 1;<br/>    <br/>    public static final int MESSAGING_SEND = 101;<br/>    <br/>    public int operation;<br/>    public User user;<br/>    public Message message;<br/>    public String session;<br/>}</span></pre><p id="1d2b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">类别库</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="cdad" class="nt lt iq nk b gy nu nv l nw nx">package id.amrishodiq.jettywebsocket.data;</span><span id="7b53" class="nt lt iq nk b gy ny nv l nw nx">import java.util.HashMap;</span><span id="4d34" class="nt lt iq nk b gy ny nv l nw nx">/**<br/> * Repository responsible for all operation related to data saving or retrieval.<br/> * <a class="ae lk" href="http://twitter.com/author" rel="noopener ugc nofollow" target="_blank">@author</a> amrishodiq<br/> */<br/>public class Repository {<br/>    private static Repository instance;<br/>    public static Repository getInstance() {<br/>        if (instance == null) {<br/>            instance = new Repository();<br/>        }<br/>        return instance;<br/>    }<br/>    <br/>    private final HashMap&lt;String, User&gt; users = new HashMap&lt;&gt;();<br/>    public final String DUMMY_SESSION = "SOMEVALIDSESSION";<br/>    <br/>    private Repository() {<br/>        initDummyUser();<br/>    }<br/>    <br/>    private void initDummyUser() {<br/>        User user = new User("alice", "123456");<br/>        users.put(user.username, user);<br/>        user = new User("bob", "654321");<br/>        users.put(user.username, user);<br/>        user = new User("charlie", "qwerty");<br/>        users.put(user.username, user);<br/>    }<br/>    <br/>    public boolean isValid(User user) {<br/>        User item = users.get(user.username);<br/>        if (item != null &amp;&amp; item.password.equals(user.password)) {<br/>            return true;<br/>        }<br/>        <br/>        return false;<br/>    }<br/>    <br/>    public boolean isValid(String session) {<br/>        if (DUMMY_SESSION.equals(session)) {<br/>            return true;<br/>        }<br/>        return false;<br/>    }<br/>}</span></pre><p id="e155" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于数据相关类来说足够了。现在，我们来看主要部分。</p><p id="5088" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">界面用户会话</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="3436" class="nt lt iq nk b gy nu nv l nw nx">package id.amrishodiq.jettywebsocket;</span><span id="981e" class="nt lt iq nk b gy ny nv l nw nx">import id.amrishodiq.jettywebsocket.data.User;</span><span id="b6bb" class="nt lt iq nk b gy ny nv l nw nx">/**<br/> * UserSession is an interface to track every client connection.<br/> * <a class="ae lk" href="http://twitter.com/author" rel="noopener ugc nofollow" target="_blank">@author</a> amrishodiq<br/> */<br/>public interface UserSession {<br/>    void receiveText(String text) throws Exception;<br/>    void setCurrentUser(User user);<br/>    void disconnect(int status, String reason);<br/>}</span></pre><p id="3e68" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">消息逻辑类</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="d1a6" class="nt lt iq nk b gy nu nv l nw nx">package id.amrishodiq.jettywebsocket;</span><span id="34e4" class="nt lt iq nk b gy ny nv l nw nx">import id.amrishodiq.jettywebsocket.data.Repository;<br/>import com.google.gson.Gson;<br/>import id.amrishodiq.jettywebsocket.data.Data;<br/>import id.amrishodiq.jettywebsocket.data.Message;<br/>import id.amrishodiq.jettywebsocket.data.User;<br/>import java.util.HashMap;</span><span id="3318" class="nt lt iq nk b gy ny nv l nw nx">/**<br/> * MessagingLogic will be responsible for parsing received data, do <br/> * authentication and forward the messages between users.<br/> * <a class="ae lk" href="http://twitter.com/author" rel="noopener ugc nofollow" target="_blank">@author</a> amrishodiq<br/> */<br/>public class MessagingLogic {<br/>    <br/>    private static MessagingLogic instance;<br/>    public static MessagingLogic getInstance() {<br/>        if (instance == null) {<br/>            instance = new MessagingLogic();<br/>        }<br/>        return instance;<br/>    }<br/>    <br/>    private HashMap&lt;String, UserSession&gt; userSessions = new HashMap&lt;&gt;();<br/>    private Gson gson = new Gson();<br/>    <br/>    private MessagingLogic() {<br/>    }<br/>    <br/>    public void receiveText(UserSession session, String text) {<br/>        try {<br/>            receiveData(session, gson.fromJson(text, Data.class));<br/>        } catch (Throwable t) {<br/>        }<br/>    }<br/>    <br/>    private void receiveData(UserSession session, Data data) {<br/>        if (data == null) return;<br/>        <br/>        // for all operation except login, do session checking<br/>        if (data.operation != Data.AUTHENTICATION_LOGIN) {<br/>            if (!validateSession(data.session)) {<br/>                session.disconnect(401, "Invalid session");<br/>            }<br/>        }<br/>        <br/>        switch (data.operation) {<br/>            case Data.AUTHENTICATION_LOGIN:<br/>                login(session, data.user);<br/>                break;<br/>            case Data.MESSAGING_SEND:<br/>                send(data.message);<br/>                break;<br/>            default:<br/>                session.disconnect(404, "Wrong operation");<br/>        }<br/>    }<br/>    <br/>    private void login(UserSession session, User user) {<br/>        if (user == null) {<br/>            session.disconnect(401, "Give username and password!");<br/>        }<br/>                <br/>        if (Repository.getInstance().isValid(user)) {<br/>            userSessions.put(user.username, session);<br/>            <br/>            session.setCurrentUser(user);<br/>            <br/>            Data data = new Data();<br/>            data.operation = Data.AUTHENTICATION_LOGIN;<br/>            data.session = Repository.getInstance().DUMMY_SESSION;<br/>            <br/>            try {<br/>                session.receiveText(gson.toJson(data));<br/>            } catch (Exception ex) {<br/>                ex.printStackTrace();<br/>            }<br/>            <br/>        } else {<br/>            session.disconnect(401, "Wrong username or password!");<br/>        }<br/>    }<br/>    <br/>    private boolean validateSession(String session) {<br/>        return Repository.getInstance().isValid(session);<br/>    }<br/>    <br/>    private void send(Message message) {<br/>        if (isUserOnline(message.to)) {<br/>            System.out.println("User is online, try to send message");<br/>            UserSession userSession = userSessions.get(message.to);<br/>            try {<br/>                userSession.receiveText(gson.toJson(message));<br/>            } catch (Exception ex) {<br/>                // put to offline message<br/>                System.out.println("User is offline");<br/>            }<br/>        } else {<br/>            // todo put to offline message<br/>            System.out.println("User is offline");<br/>        }<br/>    }<br/>    <br/>    private boolean isUserOnline(String username) {<br/>        return userSessions.containsKey(username);<br/>    }<br/>    <br/>    public void setOffline(String username) {<br/>        userSessions.remove(username);<br/>        System.err.println("Set "+username+" offline.");<br/>    }<br/>    <br/>}</span></pre><p id="cdf7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">类别消息适配器</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="2dfc" class="nt lt iq nk b gy nu nv l nw nx">package id.amrishodiq.jettywebsocket;</span><span id="f4b5" class="nt lt iq nk b gy ny nv l nw nx">import id.amrishodiq.jettywebsocket.data.User;<br/>import org.eclipse.jetty.websocket.api.Session;<br/>import org.eclipse.jetty.websocket.api.WebSocketAdapter;</span><span id="9440" class="nt lt iq nk b gy ny nv l nw nx">/**<br/> * MessagingAdapter responsible to handle connection, receiving data, forward <br/> * the data to <a class="ae lk" href="http://twitter.com/see" rel="noopener ugc nofollow" target="_blank">@see</a> id.amrishodiq.jettywebsocket.MessagingLogic and receive <br/> * data from <a class="ae lk" href="http://twitter.com/see" rel="noopener ugc nofollow" target="_blank">@see</a> id.amrishodiq.jettywebsocket.MessagingLogic to be <br/> * delivered to recipient.<br/> * <a class="ae lk" href="http://twitter.com/author" rel="noopener ugc nofollow" target="_blank">@author</a> amrishodiq<br/> */<br/>public class MessagingAdapter extends WebSocketAdapter implements UserSession {<br/>    <br/>    private Session session;<br/>    private User currentUser;<br/>    <br/>    <a class="ae lk" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>    public void onWebSocketConnect(Session session) {<br/>        super.onWebSocketConnect(session); <br/>        <br/>        this.session = session;<br/>    }</span><span id="cedf" class="nt lt iq nk b gy ny nv l nw nx">    @Override<br/>    public void onWebSocketClose(int statusCode, String reason) {<br/>        MessagingLogic.getInstance().setOffline(currentUser.username);<br/>        <br/>        this.session = null;<br/>        <br/>        System.err.println("Close connection "+statusCode+", "+reason);<br/>        <br/>        super.onWebSocketClose(statusCode, reason); <br/>    }</span><span id="f86b" class="nt lt iq nk b gy ny nv l nw nx">    @Override<br/>    public void onWebSocketText(String message) {<br/>        super.onWebSocketText(message); <br/>        <br/>        MessagingLogic.getInstance().receiveText(this, message);<br/>    }</span><span id="870b" class="nt lt iq nk b gy ny nv l nw nx">    @Override<br/>    public void receiveText(String text) throws Exception {<br/>        if (session != null &amp;&amp; session.isOpen()) {<br/>            session.getRemote().sendString(text);<br/>        }<br/>    }</span><span id="ee35" class="nt lt iq nk b gy ny nv l nw nx">    @Override<br/>    public void setCurrentUser(User user) {<br/>        this.currentUser = user;<br/>    }</span><span id="d346" class="nt lt iq nk b gy ny nv l nw nx">    @Override<br/>    public void disconnect(int status, String reason) {<br/>        <br/>        session.close(status, reason);<br/>        disconnect(status, reason);<br/>    }<br/>    <br/>}</span></pre><p id="5fe7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">类消息服务</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="13ae" class="nt lt iq nk b gy nu nv l nw nx">package id.amrishodiq.jettywebsocket;</span><span id="044f" class="nt lt iq nk b gy ny nv l nw nx">import org.eclipse.jetty.websocket.servlet.WebSocketServlet;<br/>import org.eclipse.jetty.websocket.servlet.WebSocketServletFactory;</span><span id="2659" class="nt lt iq nk b gy ny nv l nw nx">/**<br/> * Well, it's just a servlet declaration.<br/> * <a class="ae lk" href="http://twitter.com/author" rel="noopener ugc nofollow" target="_blank">@author</a> amrishodiq<br/> */<br/>public class MessagingServlet extends WebSocketServlet {</span><span id="5b96" class="nt lt iq nk b gy ny nv l nw nx">    @Override<br/>    public void configure(WebSocketServletFactory factory) {<br/>        factory.register(MessagingAdapter.class);<br/>    }<br/>    <br/>}</span></pre><p id="2630" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">类别消息服务器</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="3e86" class="nt lt iq nk b gy nu nv l nw nx">package id.amrishodiq.jettywebsocket;</span><span id="7b55" class="nt lt iq nk b gy ny nv l nw nx">import org.eclipse.jetty.server.Server;<br/>import org.eclipse.jetty.server.ServerConnector;<br/>import org.eclipse.jetty.servlet.ServletContextHandler;</span><span id="9205" class="nt lt iq nk b gy ny nv l nw nx">/**<br/> * The executable main class.<br/> * <a class="ae lk" href="http://twitter.com/author" rel="noopener ugc nofollow" target="_blank">@author</a> amrishodiq<br/> */<br/>public class MessagingServer {<br/>    <br/>    private Server server;<br/>    <br/>    public void setup() {<br/>        server = new Server();<br/>        ServerConnector connector = new ServerConnector(server);<br/>        connector.setPort(8080);<br/>        server.addConnector(connector);<br/>        <br/>        ServletContextHandler handler = new ServletContextHandler(ServletContextHandler.SESSIONS);<br/>        handler.setContextPath("/");<br/>        server.setHandler(handler);<br/>        <br/>        handler.addServlet(MessagingServlet.class, "/messaging");<br/>    }<br/>    <br/>    public void start() throws Exception {<br/>        server.start();<br/>        server.dump(System.err);<br/>        server.join();<br/>    }<br/>    <br/>    public static void main(String args[]) throws Exception {<br/>        MessagingServer theServer = new MessagingServer();<br/>        theServer.setup();<br/>        theServer.start();<br/>    }<br/>}</span></pre><p id="7a23" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">MessagingServer是可执行类(参见main方法)。我们可以使用Netbeans的右键单击并运行来运行该类。然而，我们需要一个可执行文件。jar文件。目前，我们没有。的。我们拥有的jar文件还不可执行。</p><p id="8b9b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们需要修改pom.xml以生成deliverable .jar。</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="bf4d" class="nt lt iq nk b gy nu nv l nw nx">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br/>&lt;project ae lk" href="http://maven.apache.org/POM/4.0.0" rel="noopener ugc nofollow" target="_blank"&gt;http://maven.apache.org/POM/4.0.0" xmlns:xsi="<a class="ae lk" href="http://www.w3.org/2001/XMLSchema-instance" rel="noopener ugc nofollow" target="_blank">http://www.w3.org/2001/XMLSchema-instance</a>" xsi:schemaLocation="<a class="ae lk" href="http://maven.apache.org/POM/4.0.0" rel="noopener ugc nofollow" target="_blank">http://maven.apache.org/POM/4.0.0</a> <a class="ae lk" href="http://maven.apache.org/xsd/maven-4.0.0.xsd" rel="noopener ugc nofollow" target="_blank">http://maven.apache.org/xsd/maven-4.0.0.xsd</a>"&gt;<br/>    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;<br/>    &lt;groupId&gt;id.amrishodiq&lt;/groupId&gt;<br/>    &lt;artifactId&gt;JettyWebSocket&lt;/artifactId&gt;<br/>    &lt;version&gt;1.0.1&lt;/version&gt;<br/>    &lt;packaging&gt;jar&lt;/packaging&gt;<br/>    &lt;properties&gt;<br/>        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;<br/>        &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;<br/>        &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;<br/>        <strong class="nk ir">&lt;jettyVersion&gt;9.4.9.v20180320&lt;/jettyVersion&gt;</strong><br/>    &lt;/properties&gt;<br/>    &lt;dependencies&gt;<br/>        <strong class="nk ir">&lt;dependency&gt;<br/>            &lt;groupId&gt;org.eclipse.jetty.websocket&lt;/groupId&gt;<br/>            &lt;artifactId&gt;websocket-api&lt;/artifactId&gt;<br/>            &lt;version&gt;${jettyVersion}&lt;/version&gt;<br/>        &lt;/dependency&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;org.eclipse.jetty.websocket&lt;/groupId&gt;<br/>            &lt;artifactId&gt;websocket-server&lt;/artifactId&gt;<br/>            &lt;version&gt;${jettyVersion}&lt;/version&gt;<br/>        &lt;/dependency&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;com.google.code.gson&lt;/groupId&gt;<br/>            &lt;artifactId&gt;gson&lt;/artifactId&gt;<br/>            &lt;version&gt;2.8.2&lt;/version&gt;<br/>        &lt;/dependency&gt;</strong><br/>    &lt;/dependencies&gt;<br/>    <br/>    &lt;build&gt;<br/>    &lt;plugins&gt;<br/>        &lt;plugin&gt;<br/>            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br/>                &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;<br/>                &lt;version&gt;2.3&lt;/version&gt;<br/>                &lt;configuration&gt;<br/>                    &lt;createDependencyReducedPom&gt;true&lt;/createDependencyReducedPom&gt;<br/>                    &lt;filters&gt;<br/>                        &lt;filter&gt;<br/>                            &lt;artifact&gt;*:*&lt;/artifact&gt;<br/>                            &lt;excludes&gt;<br/>                                &lt;exclude&gt;META-INF/*.SF&lt;/exclude&gt;<br/>                                &lt;exclude&gt;META-INF/*.DSA&lt;/exclude&gt;<br/>                                &lt;exclude&gt;META-INF/*.RSA&lt;/exclude&gt;<br/>                            &lt;/excludes&gt;<br/>                        &lt;/filter&gt;<br/>                    &lt;/filters&gt;<br/>                &lt;/configuration&gt;<br/>                &lt;executions&gt;<br/>                    &lt;execution&gt;<br/>                        &lt;phase&gt;package&lt;/phase&gt;<br/>                        &lt;goals&gt;<br/>                            &lt;goal&gt;shade&lt;/goal&gt;<br/>                        &lt;/goals&gt;<br/>                        &lt;configuration&gt;<br/>                            &lt;transformers&gt;<br/>                                &lt;transformer implementation="org.apache.maven.plugins.shade.resource.ServicesResourceTransformer"/&gt;<br/>                                &lt;transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer"&gt;<br/>                                    <strong class="nk ir">&lt;mainClass&gt;id.amrishodiq.jettywebsocket.MessagingServer&lt;/mainClass&gt;</strong><br/>                                &lt;/transformer&gt;<br/>                            &lt;/transformers&gt;<br/>                        &lt;/configuration&gt;<br/>                    &lt;/execution&gt;<br/>                &lt;/executions&gt;<br/>        &lt;/plugin&gt;<br/>    &lt;/plugins&gt;<br/>  &lt;/build&gt;<br/>&lt;/project&gt;</span></pre><p id="e97c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">再次构建项目，然后您将有一个可执行文件。<code class="fe nh ni nj nk b">&lt;project-directory&gt;/target</code>里面的jar文件。我的名字是<code class="fe nh ni nj nk b">JettyWebSocket-1.0.1.jar</code>。</p><h1 id="6ecd" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">功能测试</h1><p id="ea5e" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">从<code class="fe nh ni nj nk b">&lt;project-directory&gt;/target</code>运行<code class="fe nh ni nj nk b">java -jar JettyWebSocket-1.0.1.jar</code>，您将在端口8080上拥有一个正在运行的web socket服务器。</p><p id="8185" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用一些Web Socket客户端测试它，比如<a class="ae lk" href="https://chrome.google.com/webstore/detail/simple-websocket-client/pfdhoblngboilpfeibdedpjgfnlcodoo?hl=en" rel="noopener ugc nofollow" target="_blank">简单Web Socket客户端</a>，它是谷歌Chrome的扩展。连接到<code class="fe nh ni nj nk b">ws://localhost:8080/messaging</code>。发送此文本:</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="5f07" class="nt lt iq nk b gy nu nv l nw nx">{<br/>  "operation": 1,<br/>  "user": {<br/>    "username": "alice",<br/>    "password": "123456"<br/>  }<br/>}</span></pre><p id="b245" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">服务器将响应:</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="9355" class="nt lt iq nk b gy nu nv l nw nx">{"operation":1,"session":"SOMEVALIDSESSION"}</span></pre><p id="a3ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这些步骤用于验证消息服务器。一旦你有了会话字符串，就用它来发送消息。发送以下消息:</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="fd20" class="nt lt iq nk b gy nu nv l nw nx">{<br/>  "operation": 101,<br/>  "session": "SOMEVALIDSESSION", <br/>  "message": {"from":"alice","to":"bob","body":"sembarang aja nih biar seru","sent":1234567}<br/>}</span></pre><p id="03f4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">MessagingLogic会发现bob是否在线。如果他是，那么这个消息将被转发给bob。但遗憾的是不在线。</p><p id="e06c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了测试bob何时在线，您需要另一个web socket客户机实例。你需要打开新的谷歌浏览器窗口，然后再次打开简单的网络插座插件。打开相同的地址，但使用以下数据登录:</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="0be3" class="nt lt iq nk b gy nu nv l nw nx">{<br/>  "operation": 1,<br/>  "user": {<br/>    "username": "bob",<br/>    "password": "654321"<br/>  }<br/>}</span></pre><p id="38bb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，使用以下数据向爱丽丝发送消息</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="5e8d" class="nt lt iq nk b gy nu nv l nw nx">{<br/>  "operation": 101,<br/>  "session": "SOMEVALIDSESSION",<br/>  "message": {<br/>    "from": "bob",<br/>    "to": "alice",<br/>    "body": "sembarang aja",<br/>    "sent": 1234567<br/>  }<br/>}</span></pre><p id="4851" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">看，在之前的简单Web Socket插件alice登录时，她会收到:</p><pre class="nl nm nn no gt np nk nq nr aw ns bi"><span id="b193" class="nt lt iq nk b gy nu nv l nw nx">{"from":"bob","to":"alice","body":"sembarang aja","sent":1234567}</span></pre><p id="0c47" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尝试愉快。如果你发现任何问题，就告诉我。我们可以讨论一下。</p></div></div>    
</body>
</html>