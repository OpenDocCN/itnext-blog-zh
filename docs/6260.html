<html>
<head>
<title>Use Named Templates Like Functions in Helm Charts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用命名模板，如舵图中的函数</h1>
<blockquote>原文：<a href="https://itnext.io/use-named-templates-like-functions-in-helm-charts-641fbcec38da?source=collection_archive---------0-----------------------#2021-10-03">https://itnext.io/use-named-templates-like-functions-in-helm-charts-641fbcec38da?source=collection_archive---------0-----------------------#2021-10-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/980ad0a681047158f715138f88f6379a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GDEZcIY7tJV4h4CH"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@glencarrie?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">格伦·凯莉</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h1 id="e613" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">像函数一样调用舵模板</h1><p id="64d9" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated"><a class="ae kc" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank"> Helm </a>提供了<a class="ae kc" href="https://helm.sh/docs/chart_template_guide/named_templates/" rel="noopener ugc nofollow" target="_blank">命名模板</a>特性，允许用户共享和重用模板片段和部署逻辑。但是仅仅封装&amp;共享复杂的逻辑是不够的。有时，您可能想知道是否有可能像调用函数一样调用命名模板。即:</p><ul class=""><li id="9c6f" class="lz ma iq ld b le mb li mc lm md lq me lu mf ly mg mh mi mj bi translated">传递具有复杂数据结构的值</li><li id="a990" class="lz ma iq ld b le mk li ml lm mm lq mn lu mo ly mg mh mi mj bi translated">具有复杂数据结构的返回值</li></ul><p id="b12d" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">这篇博客将从命名模板的常见用法开始，探索如何用命名模板构造复杂的函数调用。</p><h1 id="2a77" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">` template '指令与` include '函数</h1><p id="81d5" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">使用命名模板的默认方式是使用<code class="fe ms mt mu mv b"><a class="ae kc" href="https://helm.sh/docs/chart_template_guide/named_templates/" rel="noopener ugc nofollow" target="_blank">template</a></code> <a class="ae kc" href="https://helm.sh/docs/chart_template_guide/named_templates/" rel="noopener ugc nofollow" target="_blank">指令</a>:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="ecf8" class="ne ke iq mv b gy nf ng l nh ni">{{- template "<!-- -->mychart.labels<!-- -->" }}</span></pre><p id="d523" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">您也可以选择提供一个输入值:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="aed4" class="ne ke iq mv b gy nf ng l nh ni">{{- template "<!-- -->mychart.labels<!-- -->" $var }}</span></pre><p id="d55f" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated"><code class="fe ms mt mu mv b">template</code>指令的一个缺点是你不能将模板执行/渲染结果捕获到一个变量中或者传递给另一个函数。幸运的是，Helm提供了一个类似于<code class="fe ms mt mu mv b">template</code>指令的<a class="ae kc" href="https://helm.sh/docs/howto/charts_tips_and_tricks/#using-the-include-function" rel="noopener ugc nofollow" target="_blank"> include函数</a>，同时捕获指定模板的输出。例如</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="e0b0" class="ne ke iq mv b gy nf ng l nh ni">{{- $myVar := include "<!-- -->mychart.labels<!-- -->" $var }}</span></pre><p id="f58a" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">因此，<code class="fe ms mt mu mv b">include</code>函数是调用已定义的命名模板的首选方式。</p><p id="8971" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated"><em class="nj">请注意:与</em> <code class="fe ms mt mu mv b"><em class="nj">template</em></code> <em class="nj">指令不同，在调用</em> <code class="fe ms mt mu mv b"><em class="nj">include</em></code> <em class="nj">功能时，输入值是强制的。</em></p><h1 id="9175" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">常见用法</h1><p id="d569" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">通常，您会定义自己的命名模板</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="f29f" class="ne ke iq mv b gy nf ng l nh ni">{{- define "mychart.labels" -}}<br/>  <strong class="mv ir">labels</strong>:<br/>    <strong class="mv ir">myLabel</strong>: {{ .Values.myLabel }}<br/>{{- end -}}</span></pre><p id="a3c0" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">然后，您可以调用您的模板并将当前范围<code class="fe ms mt mu mv b">.</code>传递给它:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="a551" class="ne ke iq mv b gy nf ng l nh ni">{{- include "mychart.labels" . }}</span></pre><p id="cb44" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">但是，如果您需要向模板传递多个参数，该怎么办呢？</p><h1 id="9cbd" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">使用多个参数调用模板</h1><p id="3935" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">虽然<code class="fe ms mt mu mv b">include</code>函数只接受一个输入值，但这并不妨碍您将所有参数组合到一个<a class="ae kc" href="https://helm.sh/docs/chart_template_guide/function_list/#dictionaries-and-dict-functions" rel="noopener ugc nofollow" target="_blank">字典</a>中，并将其作为单个输入值传递给<code class="fe ms mt mu mv b">include</code>函数。</p><p id="9c53" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">例如，假设我们想要定义一个计算两个参数<code class="fe ms mt mu mv b">a</code> &amp; <code class="fe ms mt mu mv b">b</code>之和的模板:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="67d6" class="ne ke iq mv b gy nf ng l nh ni">{{- define "mychart.add" -}}<br/>{{- $r := <!-- -->add .a .b <!-- -->}}<br/>{{- $r }}<br/>{{- end -}}</span></pre><p id="77f2" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">要使用模板，我们可以按如下方式调用它:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="0157" class="ne ke iq mv b gy nf ng l nh ni">{{- $result := include "mychart.add" (dict "a" 3 "b" 4) }}</span></pre><p id="7b48" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">如果你使用<a class="ae kc" href="https://medium.com/itnext/dump-variables-in-helm-charts-c4da458b0227" rel="noopener">我之前的博客介绍的var_dump命名模板</a>来验证结果，它将打印<code class="fe ms mt mu mv b">"7"</code>。</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="9520" class="ne ke iq mv b gy nf ng l nh ni">{{- $result := include "mychart.add" (dict "a" 3 "b" 4) }}<br/>{{- include "magda.var_dump" $result }}</span></pre><h1 id="67d1" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">返回复杂的数据结构</h1><p id="f045" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">您可能会注意到，命名模板输出只能是一个字符串。如果试图输出非字符串值，它将被转换为字符串。</p><p id="c682" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">一个简单的解决方法是使用<a class="ae kc" href="https://helm.sh/docs/chart_template_guide/function_list/#type-conversion-functions" rel="noopener ugc nofollow" target="_blank"> mustToJson </a>函数将返回值转换成Json字符串，让template输出JSON字符串，然后使用<a class="ae kc" href="http://masterminds.github.io/sprig/defaults.html" rel="noopener ugc nofollow" target="_blank"> mustFromJson </a>函数恢复原来的值。</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="b6fb" class="ne ke iq mv b gy nf ng l nh ni">{{- define "mychart.getNumbers" }}<br/>{{- $r := regexFindAll "[\\d\\.]+" . -1 }}<br/>{{- mustToJson $r }}<br/>{{- end -}}</span></pre><p id="6a25" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">上面的模板接受一个字符串作为输入值，并返回一个表示数字的子字符串列表。</p><p id="0bde" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">例如，输入字符串“3.1加5.4的结果是8.5”:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="28f1" class="ne ke iq mv b gy nf ng l nh ni">{{- $result := include "mychart.getNumbers" "The result of 3.1 plus 5.4 is 8.5!" | mustFromJson }}<br/>{{- include "magda.var_dump" $result }}</span></pre><p id="50c3" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">var_dump的结果将是一个列表:<code class="fe ms mt mu mv b">["3.1", "5.4", "8.5"]</code>。</p><h1 id="5274" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">递归函数-斐波那契数</h1><p id="91ad" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">也可以用Helm命名的模板构造递归函数。以<a class="ae kc" href="https://en.wikipedia.org/wiki/Fibonacci_number" rel="noopener ugc nofollow" target="_blank">斐波那契数</a>问题为例。在给定位置生成斐波那契数的函数的递归实现在javascript中如下所示:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="c5a7" class="ne ke iq mv b gy nf ng l nh ni">function fibonacci(num) {<br/>    if(num &lt; 2) {<br/>        return num;<br/>    }<br/>    else {<br/>        return fibonacci(num-1) + fibonacci(num - 2);<br/>    }<br/>}</span></pre><p id="11fb" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">我们可以如下实现Helm命名模板:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="f403" class="ne ke iq mv b gy nf ng l nh ni">{{- define "mychart.fibonacci" -}}<br/>{{- /* For ease of reading, assign input value to variable $num */}}<br/>{{- $num := . }}<br/>{{- /* test if $num is lower than 2 */}}<br/>{{- if lt $num 2 }}<br/>  {{- $num | mustToJson }}<br/>{{- else }}<br/>  {{- add (include "mychart.fibonacci" (sub $num 1) | mustFromJson) (include "mychart.fibonacci" (sub $num 2) | mustFromJson) }}<br/>{{- end }}<br/>{{- end -}}</span></pre><p id="02d9" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">我们可以使用我们的实现来输出斐波那契数列的列表:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="7833" class="ne ke iq mv b gy nf ng l nh ni">{{ $result := list }}<br/>{{- range $num := until 10 }}<br/>  {{- /* here we need to use `=` for assignment only.  */}}<br/>  {{- /* Use `:=` will delcare a local variable and won't update $result.  */}}<br/>  {{- $result = append $result (include "mychart.fibonacci" . | mustFromJson) }}<br/>{{- end }}<br/>{{- /* dump the result  */}}<br/>{{- include "magda.var_dump" $result }}</span></pre><p id="4eb4" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">上面的模板会将<code class="fe ms mt mu mv b">[0,1,1,2,3,5,8,13,21,34]</code>输出到控制台。</p><h1 id="c394" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">尝试一下</h1><p id="db6a" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">要尝试一下，您可以:</p><ul class=""><li id="cb91" class="lz ma iq ld b le mb li mc lm md lq me lu mf ly mg mh mi mj bi translated">用<code class="fe ms mt mu mv b">helm create</code>创建一个虚拟舵图表</li><li id="545d" class="lz ma iq ld b le mk li ml lm mm lq mn lu mo ly mg mh mi mj bi translated">将任何示例复制并粘贴到模板文件中</li><li id="1049" class="lz ma iq ld b le mk li ml lm mm lq mn lu mo ly mg mh mi mj bi translated">使用<code class="fe ms mt mu mv b">helm template</code>运行示例</li></ul><p id="d40d" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">你可能注意到了<code class="fe ms mt mu mv b">"magda.var_dump"</code>的用法。它是一个名为template的助手，可以暂停模板渲染，并将给定的变量转储到控制台。更多细节，请看看<a class="ae kc" href="https://medium.com/itnext/dump-variables-in-helm-charts-c4da458b0227" rel="noopener">我之前的关于舵图</a>中变量转储的博客。</p></div></div>    
</body>
</html>