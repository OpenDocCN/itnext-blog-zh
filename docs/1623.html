<html>
<head>
<title>Managing Ingress Controllers on Kubernetes: Part 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">管理Kubernetes上的入口控制器:第3部分</h1>
<blockquote>原文：<a href="https://itnext.io/managing-ingress-controllers-on-kubernetes-part-3-2984b3616249?source=collection_archive---------2-----------------------#2018-12-13">https://itnext.io/managing-ingress-controllers-on-kubernetes-part-3-2984b3616249?source=collection_archive---------2-----------------------#2018-12-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f0f4" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">管理SSL/TLS的选项</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/1c824515f1a0105dc3485bc9d2e61af4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*S5SJLJS5tGFEwaYb"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@vorosbenisop?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">本杰明·沃罗斯</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="083a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当我们谈论到达我们集群的流量时，安全性是一个重要的考虑因素。幸运的是，入口API支持为服务配置传输层安全性(TLS)。这样做可以避免以明文形式与服务进行通信。客户也更加确信他们实际上是在与预期的服务进行对话。让我们看看如何在入口资源中配置TLS。</p><h2 id="e3c6" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">基本配置</h2><p id="9f91" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">主机的TLS工件(X.509证书和私钥)需要存储在一个秘密中，然后在入口对象的定义中引用该秘密:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="c01e" class="ls lt iq mr b gy mv mw l mx my">apiVersion: v1</span><span id="dd3d" class="ls lt iq mr b gy mz mw l mx my">data:</span><span id="e5ed" class="ls lt iq mr b gy mz mw l mx my">  tls.crt: &lt;base64 encoded string&gt;</span><span id="5a91" class="ls lt iq mr b gy mz mw l mx my">  tls.key: &lt;base64 encoded string&gt;</span><span id="f059" class="ls lt iq mr b gy mz mw l mx my">kind: Secret</span><span id="193b" class="ls lt iq mr b gy mz mw l mx my">metadata:</span><span id="8a69" class="ls lt iq mr b gy mz mw l mx my">  name: acme.com.tls</span><span id="0d58" class="ls lt iq mr b gy mz mw l mx my">  namespace: default</span><span id="b8ed" class="ls lt iq mr b gy mz mw l mx my">type: kubernetes.io/tls</span><span id="2b32" class="ls lt iq mr b gy mz mw l mx my">---</span><span id="3a5b" class="ls lt iq mr b gy mz mw l mx my">apiVersion: extensions/v1beta1</span><span id="8fa3" class="ls lt iq mr b gy mz mw l mx my">kind: Ingress</span><span id="b0f1" class="ls lt iq mr b gy mz mw l mx my">metadata:</span><span id="17f0" class="ls lt iq mr b gy mz mw l mx my">  name: acme-app-ingress</span><span id="f39c" class="ls lt iq mr b gy mz mw l mx my">spec:</span><span id="3fe6" class="ls lt iq mr b gy mz mw l mx my">  tls:</span><span id="76ed" class="ls lt iq mr b gy mz mw l mx my"> — hosts:</span><span id="0a33" class="ls lt iq mr b gy mz mw l mx my">    - acme.com</span><span id="a113" class="ls lt iq mr b gy mz mw l mx my">    secretName: acme.com.tls</span><span id="6818" class="ls lt iq mr b gy mz mw l mx my">rules:</span><span id="efa6" class="ls lt iq mr b gy mz mw l mx my">- host: acme.com</span><span id="10a4" class="ls lt iq mr b gy mz mw l mx my">  http:</span><span id="c6c2" class="ls lt iq mr b gy mz mw l mx my">    paths:</span><span id="b1b5" class="ls lt iq mr b gy mz mw l mx my">    - path: /foo</span><span id="ab58" class="ls lt iq mr b gy mz mw l mx my">      backend:</span><span id="98aa" class="ls lt iq mr b gy mz mw l mx my">        serviceName: svc1</span><span id="a3f8" class="ls lt iq mr b gy mz mw l mx my">        servicePort: 80</span></pre><p id="5fec" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于TLS的简单默认配置，有几件事情需要考虑。首先，入口实现假设TLS在入口点终止，流量使用普通HTTP路由到服务后端。稍后会有更多的介绍。第二，入口API仅支持端口443上的TLS，并且如果在入口定义的TLS组件中指定了多个主机，则借助于用服务器名称指示(SNI) TLS扩展指定的主机名，流量在同一端口上被多路复用，这必须由所讨论的特定入口控制器支持。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><a href="https://info.giantswarm.io/guide-to-managing-ingress-controllers"><div class="gh gi na"><img src="../Images/c46c9bc5c32531dc4b9e02fbc12fd9f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*VVAGMXjltR6ssPFbThUjFg.png"/></div></a></figure><h2 id="3a82" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">SSL/TLS直通</h2><p id="369c" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">上面的例子表明，TLS在入口点终止。在入口点终止TLS将后端服务单元从解密流量的高成本任务和证书管理负担中解放出来。但是，如果需要的话，可以将通信一直加密到服务单元。并不是所有的入口控制器都支持这个特性，它们以不同的方式处理它。</p><p id="5a89" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，Traefik入口控制器检查入口定义中的服务端口，如果端口是443，它将尝试使用TLS与每个pod端点通信。k8s-ingress-nginx控制器使用<code class="fe nb nc nd mr b">nginx.ingress.kubernetes.io/ssl-passthrough</code>(必须设置为“真”)和它的<code class="fe nb nc nd mr b">— enable-ssl-passthrough</code>命令行标志。</p><p id="dd44" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果不是必需的，那么采用入口API的默认行为并在入口点终止TLS会更方便，也更少麻烦。</p><h2 id="f6b4" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">其他SSL/TLS注意事项。小心HSTS的头球！</h2><p id="5a98" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">默认情况下，k8s-ingress-nginx控制器在相关入口对象上配置了TLS的响应中自动应用HTTP严格传输安全(HSTS)报头。这指示客户端在六个月的默认时间段内仅使用HTTPS与后端服务通信。</p><p id="138a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">应特别小心，确保不要求客户端使用普通HTTP访问相关域的资源，否则客户端可能在六个月内无法访问这些资源！</p><p id="6227" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里有一个例子:网站可能会利用由第三方托管的资产或服务。自定义子域可以与指向托管资产的DNS CNAME记录结合使用，但是如果子域没有TLS证书，则资产将使用普通HTTP提供服务。当HSTS作为入口定义的一部分启用时，所有HTTP请求都将被客户端升级到HTTPS，导致内容无法按预期呈现。在HSTS最大年龄参数持续期间，修复服务器端的问题对有问题的客户端没有影响。明智的预防措施可能是首先禁用此功能(这是Traefik入口控制器的默认行为)，直到与任何后端服务相关的通信要求都已完全测试完毕。</p><p id="0aa0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，手动管理与入口对象相关联的TLS证书意味着巨大的操作开销。<a class="ae kv" href="https://github.com/jetstack/cert-manager" rel="noopener ugc nofollow" target="_blank"> Jetstack的cert-manager </a>控制器可用于从外部认证机构(如<a class="ae kv" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank"> Let's Encrypt </a>)自动获取和更新TLS证书。</p><blockquote class="ne nf ng"><p id="96df" class="kw kx nh ky b kz la jr lb lc ld ju le ni lg lh li nj lk ll lm nk lo lp lq lr ij bi translated"><a class="ae kv" href="https://medium.com/@GiantSwarm/managing-ingress-controllers-on-kubernetes-part-4-9f201296db28" rel="noopener"> <strong class="ky ir">阅读第4部分:<em class="iq"> D </em>部署多个入口控制器</strong> </a></p></blockquote><p id="cba2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由<a class="ae kv" href="https://twitter.com/puja108" rel="noopener ugc nofollow" target="_blank"> Puja Abbassi </a>撰写——开发者倡导者@ <a class="ae kv" href="https://giantswarm.io/" rel="noopener ugc nofollow" target="_blank">巨型群体</a></p><div class="nl nm gp gr nn no"><a href="https://twitter.com/puja108" rel="noopener  ugc nofollow" target="_blank"><div class="np ab fo"><div class="nq ab nr cl cj ns"><h2 class="bd ir gy z fp nt fr fs nu fu fw ip bi translated">puja Abbas si @ # kube con # kube Khan(@ puja 108)| Twitter</h2><div class="nv l"><h3 class="bd b gy z fp nt fr fs nu fu fw dk translated">Puja Abbassi的最新推文@ #KubeCon #KubeKhan (@puja108)。开发者倡导者@ GiantSwarm &amp; Researcher</h3></div><div class="nw l"><p class="bd b dl z fp nt fr fs nu fu fw dk translated">twitter.com</p></div></div><div class="nx l"><div class="ny l nz oa ob nx oc kp no"/></div></div></a></div><p id="8ab1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">准备好将您的云原生项目投入生产了吗？只需在https://giantswarm.io/<a class="ae kv" href="https://giantswarm.io/" rel="noopener ugc nofollow" target="_blank">申请免费试用</a></p></div></div>    
</body>
</html>