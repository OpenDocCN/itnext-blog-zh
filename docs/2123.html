<html>
<head>
<title>ServiceLoader: The Built in DI Framework You’ve Probably Never Heard Of</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ServiceLoader:您可能从未听说过的内置DI框架</h1>
<blockquote>原文：<a href="https://itnext.io/serviceloader-the-built-in-di-framework-youve-probably-never-heard-of-1fa68a911f9b?source=collection_archive---------0-----------------------#2019-04-04">https://itnext.io/serviceloader-the-built-in-di-framework-youve-probably-never-heard-of-1fa68a911f9b?source=collection_archive---------0-----------------------#2019-04-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/fc8c0f89303c8c9114d425164587d3c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cUOknyEHrQ6wGqynmp__Eg.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://www.pexels.com/@negativespace?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">负空间</a>发自<a class="ae kf" href="https://www.pexels.com/photo/grayscale-photo-of-computer-laptop-near-white-notebook-and-ceramic-mug-on-table-169573/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">像素</a></figcaption></figure><p id="ea12" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">大多数java开发人员已经使用<a class="ae kf" href="https://spring.io" rel="noopener ugc nofollow" target="_blank"> Spring </a>进行依赖注入(DI)。有些人甚至使用了谷歌Guice或者OSGi服务。但是很多人不知道Java其实有一个内置的DI系统。这是Java 11或12的新特性吗？不，它从Java 6开始就存在了。</p><p id="47ab" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://docs.oracle.com/javase/7/docs/api/java/util/ServiceLoader.html" rel="noopener ugc nofollow" target="_blank"> ServiceLoader </a>提供了查找和实例化接口或抽象类的注册实例的能力。对于那些熟悉Spring的人来说，它非常类似于<a class="ae kf" href="https://www.baeldung.com/spring-bean-annotations" rel="noopener ugc nofollow" target="_blank"> Bean </a>和<a class="ae kf" href="https://www.baeldung.com/spring-autowire" rel="noopener ugc nofollow" target="_blank">自动连线</a>注释。让我们看一个使用Spring的例子和一个使用ServiceLoader的例子。我们将讨论相同点和不同点。</p><figure class="lf lg lh li gt ju gh gi paragraph-image"><div class="gh gi le"><img src="../Images/c2a938e137c8c3f4cd4bbf9089a8f700.png" data-original-src="https://miro.medium.com/v2/resize:fit:980/format:webp/1*BbwAtaGZ7fcdXiPMTyz4tA.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://spring.io" rel="noopener ugc nofollow" target="_blank"> spring.io </a></figcaption></figure><h1 id="7df5" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">弹簧依赖注入</h1><p id="93a8" class="pw-post-body-paragraph kg kh it ki b kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ml lb lc ld im bi translated">首先，让我们回顾一下用Spring做简单DI的方法。</p><p id="e5ab" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将创建一个简单的界面:</p><pre class="lf lg lh li gt mm mn mo mp aw mq bi"><span id="bc8a" class="mr lk it mn b gy ms mt l mu mv"><strong class="mn iu">public interface </strong>SimpleService {<br/><br/>    String echo(String value);<br/><br/>}</span></pre><p id="6f16" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后是接口的实现:</p><pre class="lf lg lh li gt mm mn mo mp aw mq bi"><span id="2181" class="mr lk it mn b gy ms mt l mu mv"><strong class="mn iu">import </strong>org.springframework.stereotype.Component;<br/><br/>@Component<br/><strong class="mn iu">public class </strong>SimpleServiceImpl <strong class="mn iu">implements </strong>SimpleService {<br/>    <strong class="mn iu">public </strong>String echo(<strong class="mn iu">final </strong>String value) {<br/>        <strong class="mn iu">return </strong>value;<br/>    }<br/>}</span></pre><p id="e1fc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意<strong class="ki iu">@组件</strong>。这将把类作为bean添加到应用程序上下文中。</p><p id="b149" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，我们的主类:</p><pre class="lf lg lh li gt mm mn mo mp aw mq bi"><span id="fd74" class="mr lk it mn b gy ms mt l mu mv">@SpringBootApplication<br/><strong class="mn iu">public class </strong>SpringExample <strong class="mn iu">implements </strong>CommandLineRunner {<br/><br/>    @Autowired<br/>    List&lt;SimpleService&gt; <strong class="mn iu">simpleServices</strong>;<br/><br/>    <strong class="mn iu">public static void </strong>main(String[] args) {<br/>        SpringApplication.<em class="mw">run</em>(SpringExample.<strong class="mn iu">class</strong>, args);<br/><br/>    }<br/><br/>    <strong class="mn iu">public void </strong>run(<strong class="mn iu">final </strong>String... strings) <strong class="mn iu">throws </strong>Exception {<br/>        <strong class="mn iu">for </strong>(SimpleService simpleService : <strong class="mn iu">simpleServices</strong>) {<br/>            <strong class="mn iu"><em class="mw">log</em></strong>.info(<strong class="mn iu">"Echo: " </strong>+ simpleService.echo(strings[0]));<br/>        }<br/>    }<br/>}</span></pre><p id="aed5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意@ <strong class="ki iu">自动连线的</strong>简单服务列表。@<strong class="ki iu">spring boot应用程序</strong>将自动扫描组件包。然后在运行时，这些被连接到<em class="mw"> SpringExample </em>类中。</p><h1 id="d9aa" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">ServiceLoader依赖注入</h1><p id="83c3" class="pw-post-body-paragraph kg kh it ki b kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ml lb lc ld im bi translated">我们将使用与Spring示例相同的接口，因此这里不再重复。让我们转而关注服务的实现:</p><pre class="lf lg lh li gt mm mn mo mp aw mq bi"><span id="cbf7" class="mr lk it mn b gy ms mt l mu mv"><strong class="mn iu">import </strong>com.google.auto.service.AutoService;<br/><br/>@AutoService(SimpleService.<strong class="mn iu">class</strong>)<br/><strong class="mn iu">public class </strong>SimpleServiceImpl <strong class="mn iu">implements </strong>SimpleService {<br/>    <strong class="mn iu">public </strong>String echo(<strong class="mn iu">final </strong>String value) {<br/>        <strong class="mn iu">return </strong>value;<br/>    }<br/>}</span></pre><p id="6d53" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在实现中，我们用注释@ <strong class="ki iu"> AutoService </strong>来“注册”服务的一个实例。这只在编译时需要，因为javac注释处理器使用注释来自动生成服务注册文件:</p><blockquote class="mx my mz"><p id="0e26" class="kg kh mw ki b kj kk kl km kn ko kp kq na ks kt ku nb kw kx ky nc la lb lc ld im bi translated">META-INF/services/io . github . efenglu . service loader . example . simple service</p></blockquote><p id="ffc7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该文件包含实现该服务的类的列表:</p><pre class="lf lg lh li gt mm mn mo mp aw mq bi"><span id="e13b" class="mr lk it mn b gy ms mt l mu mv">io.github.efenglu.serviceLoader.example.SimpleServiceImpl</span></pre><p id="34ef" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">文件名必须与服务的完全限定名匹配。内容可以有任意数量的实现，每个实现在单独的一行上。</p><p id="6a6c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">实现类<strong class="ki iu">必须</strong>有一个无参数的构造函数。</p><p id="6cfe" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以手动生成该文件，但是使用该注释要容易得多。</p><p id="92ca" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">和主类:</p><pre class="lf lg lh li gt mm mn mo mp aw mq bi"><span id="bb17" class="mr lk it mn b gy ms mt l mu mv"><strong class="mn iu">public class </strong>ServiceLoaderExample {<br/><br/>    <strong class="mn iu">public static void </strong>main(String [] args) {<br/>        <strong class="mn iu">final </strong>ServiceLoader&lt;SimpleService&gt; services = ServiceLoader.<em class="mw">load</em>(SimpleService.<strong class="mn iu">class</strong>);<br/>        <strong class="mn iu">for </strong>(SimpleService service : services) {<br/>            System.<strong class="mn iu"><em class="mw">out</em></strong>.println(<strong class="mn iu">"Echo: " </strong>+ service.echo(args[0]));<br/>        }<br/>    }<br/>}</span></pre><p id="7c35" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu"> ServiceLoader.load </strong>被调用，加载一个<strong class="ki iu"> ServiceLoader </strong>，可以用来获取所有服务的实例。ServiceLoader实例是服务类型的iterable，因此服务变量上的每个循环都有<em class="mw">。</em></p><figure class="lf lg lh li gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nd"><img src="../Images/47952f2e3db0b692d6420fbf2587ff3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PHFYEJqWpf-nKjmr7vbXIw.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://www.pexels.com/photo/view-ape-thinking-primate-33535/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">像素</a>的<a class="ae kf" href="https://www.pexels.com/@pixabay?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>拍摄</figcaption></figure><h1 id="6b66" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">那又怎样？</h1><p id="5b85" class="pw-post-body-paragraph kg kh it ki b kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ml lb lc ld im bi translated">这两种实现都相对较小。两者都可以主要基于注释，因此使用起来相当简单。那么，你为什么要使用ServiceLoader而不是Spring呢？</p><h2 id="b166" class="mr lk it bd ll ne nf dn lp ng nh dp lt kr ni nj lx kv nk nl mb kz nm nn mf no bi translated">属国</h2><p id="ca63" class="pw-post-body-paragraph kg kh it ki b kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ml lb lc ld im bi translated">让我们看一下非常简单的Spring服务加载器的依赖树:</p><pre class="lf lg lh li gt mm mn mo mp aw mq bi"><span id="3a2f" class="mr lk it mn b gy ms mt l mu mv">[INFO] -----------&lt; io.github.efenglu.serviceLoader:spring-example &gt;-----------<br/>[INFO] Building spring-example 1.0.X-SNAPSHOT<br/>[INFO] --------------------------------[ jar ]---------------------------------<br/>[INFO] <br/>[INFO] --- maven-dependency-plugin:3.1.1:tree (default-cli) @ spring-example ---<br/>[INFO] io.github.efenglu.serviceLoader:spring-example:jar:1.0.X-SNAPSHOT<br/>[INFO] +- org.slf4j:slf4j-api:jar:1.7.25:compile<br/>[INFO] +- org.springframework:spring-context:jar:4.3.22.RELEASE:compile<br/>[INFO] |  +- org.springframework:spring-aop:jar:4.3.22.RELEASE:compile<br/>[INFO] |  +- org.springframework:spring-core:jar:4.3.22.RELEASE:compile<br/>[INFO] |  |  \- commons-logging:commons-logging:jar:1.2:compile<br/>[INFO] |  \- org.springframework:spring-expression:jar:4.3.22.RELEASE:compile<br/>[INFO] +- org.springframework.boot:spring-boot-autoconfigure:jar:1.5.19.RELEASE:compile<br/>[INFO] +- org.springframework.boot:spring-boot:jar:1.5.19.RELEASE:compile<br/>[INFO] \- org.springframework:spring-beans:jar:4.3.22.RELEASE:compile</span></pre><p id="abb3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">与我们的服务加载器相比:</p><pre class="lf lg lh li gt mm mn mo mp aw mq bi"><span id="889b" class="mr lk it mn b gy ms mt l mu mv">[INFO] io.github.efenglu.serviceLoader:serviceLoader-example:jar:1.0.X-SNAPSHOT</span><span id="08a4" class="mr lk it mn b gy np mt l mu mv">## Only provided dependencies for the auto service annotation<br/>[INFO] \- com.google.auto.service:auto-service:jar:1.0-rc4:provided<br/>[INFO]    +- com.google.auto:auto-common:jar:0.8:provided<br/>[INFO]    \- com.google.guava:guava:jar:23.5-jre:provided<br/>[INFO]       +- com.google.code.findbugs:jsr305:jar:1.3.9:provided<br/>[INFO]       +- org.checkerframework:checker-qual:jar:2.0.0:provided<br/>[INFO]       +- com.google.errorprone:error_prone_annotations:jar:2.0.18:provided<br/>[INFO]       +- com.google.j2objc:j2objc-annotations:jar:1.1:provided<br/>[INFO]       \- org.codehaus.mojo:animal-sniffer-annotations:jar:1.14:provided</span></pre><p id="0e7d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果我们忽略所提供的依赖项，则ServiceLoader示例没有依赖项。没错，它只需要Java。</p><p id="5dfe" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，如果你是一个Spring商店，这并不是什么大不了的事情，但是如果你正在写一些可以在多种不同框架中使用的东西，或者想要一个小的命令行应用程序，这将会有很大的不同。</p><h2 id="15b4" class="mr lk it bd ll ne nf dn lp ng nh dp lt kr ni nj lx kv nk nl mb kz nm nn mf no bi translated">速度</h2><p id="962f" class="pw-post-body-paragraph kg kh it ki b kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ml lb lc ld im bi translated">说到命令行应用，ServiceLoader的启动时间比Spring Boot应用要快得多。这要归功于加载的代码更少，没有扫描，没有反射，没有大框架。</p><h2 id="1b37" class="mr lk it bd ll ne nf dn lp ng nh dp lt kr ni nj lx kv nk nl mb kz nm nn mf no bi translated">记忆</h2><p id="441f" class="pw-post-body-paragraph kg kh it ki b kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ml lb lc ld im bi translated">春天并不因为记忆力好而出名。如果内存对您的应用程序至关重要，并且您需要某种DI功能，那么您应该考虑使用ServiceLoader。</p><figure class="lf lg lh li gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nq"><img src="../Images/6988aaef84c909f8c00d5a94c0223fcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f6KktO5fgxspdHt73dR4qg.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://www.pexels.com/@pixabay?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>从<a class="ae kf" href="https://www.pexels.com/photo/blue-white-orange-and-brown-container-van-163726/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">像素</a>拍摄</figcaption></figure><h1 id="5920" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">Java模块</h1><p id="9634" class="pw-post-body-paragraph kg kh it ki b kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ml lb lc ld im bi translated">java模块的一个关键方面是将类与模块外的代码完全隔离的能力。ServiceLoader是允许外部代码“访问”内部实现的机制。Java模块允许您为内部实现注册服务，同时仍然维护防火墙。</p><p id="03cf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">事实上，这是唯一官方认可的支持Java模块依赖注入的机制。Spring和大多数现有的DI框架依靠反射来发现和连接它们的组件。但是这在Java模块中是行不通的。甚至反射也不能看到模块内部(除非你允许，但是你为什么要这么做)。</p><h1 id="e965" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">结论</h1><p id="4459" class="pw-post-body-paragraph kg kh it ki b kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ml lb lc ld im bi translated">春天很棒。它比ServiceLoader做得更多。但是有些时候ServiceLoader是正确的选择。它简单、小巧、快速且随时可用。</p><p id="2514" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要查看示例的完整源代码，请查看我的Git Repo:</p><div class="nr ns gp gr nt nu"><a href="https://github.com/efenglu/serviceLoaderExample" rel="noopener  ugc nofollow" target="_blank"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd iu gy z fp nz fr fs oa fu fw is bi translated">efenglu/serviceLoaderExample</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">ServiceLoader使用指南。在…上创建帐户，为efenglu/serviceLoaderExample开发做出贡献</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">github.com</p></div></div><div class="od l"><div class="oe l of og oh od oi jz nu"/></div></div></a></div></div></div>    
</body>
</html>