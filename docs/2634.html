<html>
<head>
<title>Deploying a Node.js app to the Google Kubernetes Engine (GKE)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Node.js应用程序部署到Google Kubernetes引擎(GKE)</h1>
<blockquote>原文：<a href="https://itnext.io/deploying-a-node-js-app-to-the-google-kubernetes-engine-gke-d6af1f3a954c?source=collection_archive---------1-----------------------#2019-06-29">https://itnext.io/deploying-a-node-js-app-to-the-google-kubernetes-engine-gke-d6af1f3a954c?source=collection_archive---------1-----------------------#2019-06-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b07996e299db3ac827bb8234fa3d9672.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0H_XuoRSInNqzP14loJuPg.png"/></div></div></figure><p id="dc1d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我想向您展示如何快速轻松地将您的应用程序部署到谷歌Kubernetes引擎(GKE)上的Kubernetes。</p><h1 id="7489" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">创建新的Kubernetes集群</h1><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/f807c9ee4069026f4d75b1aca2f4bdbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:880/format:webp/1*ARmNlow2g-aRV3T1eicpDA.png"/></div></figure><p id="f826" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">输入群集的名称、位置、节点数量和机器类型。然后点击<strong class="ka ir">更多选项</strong>。</p><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lz"><img src="../Images/ca04962559e3c21c30e8f364133e8bc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TEZk_XIZQx6ikjYuGIxN7w.png"/></div></div></figure><p id="846d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果需要自动添加新节点到集群中，那么点击<strong class="ka ir">启用自动扩展</strong>。</p><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/c64de6778dbd360ad5c9b7b59f1e6ca3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1028/format:webp/1*vwzY1cFG_NVrpf0YHSF2UA.png"/></div></figure><p id="daea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以允许从集群访问一些API。例如，我允许访问谷歌云存储(GCS)。</p><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div class="gh gi mb"><img src="../Images/9b2fab488dbe1a2d6c237b76a6942352.png" data-original-src="https://miro.medium.com/v2/resize:fit:1038/format:webp/1*Dd1E4gijeqsBGsClTUK7hw.png"/></div></figure><p id="a12b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建好集群后，点击<strong class="ka ir">连接</strong>。</p><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mc"><img src="../Images/4ea77a34b46d3034dafaa883e3d08758.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*64OZtw8uJl9HZLqC4nFqeg.png"/></div></div></figure><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi md"><img src="../Images/007d4138039c98a61d42cff54875a24a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y1ILYx9xWjD53ljLAUCTLw.png"/></div></div></figure><p id="bf94" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，您将看到一个带有命令的云Shell，按Enter键执行它并获取GKE凭据。之后就可以用<strong class="ka ir"> kubectl </strong>执行任何命令了。</p><p id="7e93" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，让我们检查一个集群的节点。</p><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi me"><img src="../Images/afd2c3f8ae927d4a86f0ffc9d25a77bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ncrqEYHH9hqUi6_9lwMOOA.png"/></div></div></figure><h1 id="3f12" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">将docker图像推送到Google容器注册表</h1><p id="a621" class="pw-post-body-paragraph jy jz iq ka b kb mf kd ke kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv ij bi translated">我将使用我的GitHub repo，它包括一个简单的Node.js应用程序、Dockerfile和deployment.yaml。</p><pre class="lv lw lx ly gt mk ml mm mn aw mo bi"><span id="5e77" class="mp kx iq ml b gy mq mr l ms mt">git clone <a class="ae mu" href="https://github.com/sonufrienko/gke-simple-app" rel="noopener ugc nofollow" target="_blank">https://github.com/sonufrienko/gke-simple-app</a></span><span id="11cf" class="mp kx iq ml b gy mv mr l ms mt">cd gke-simple-app</span></pre><p id="b21b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将<strong class="ka ir"> deployment.yaml </strong>中的【PROJECT_ID】替换为您的GCP项目ID。</p><p id="1320" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">获取Google容器注册表的凭据</p><pre class="lv lw lx ly gt mk ml mm mn aw mo bi"><span id="5d4c" class="mp kx iq ml b gy mq mr l ms mt">gcloud auth configure-docker</span></pre><p id="e747" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">构建docker映像并将其推送到Google容器注册中心</p><pre class="lv lw lx ly gt mk ml mm mn aw mo bi"><span id="9e42" class="mp kx iq ml b gy mq mr l ms mt">docker build -t gcr.io/[PROJECT_ID]/app:v1 .<br/>docker push gcr.io/[PROJECT_ID]/app:v1</span></pre><h1 id="8cd4" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">将docker映像部署到Kubernetes</h1><p id="c66b" class="pw-post-body-paragraph jy jz iq ka b kb mf kd ke kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv ij bi translated">部署YAML文件包含两部分:</p><ul class=""><li id="7775" class="mw mx iq ka b kb kc kf kg kj my kn mz kr na kv nb nc nd ne bi translated">部署-描述要部署的容器</li><li id="9cae" class="mw mx iq ka b kb nf kf ng kj nh kn ni kr nj kv nb nc nd ne bi translated">服务——将创建一个负载平衡器，将我们的容器暴露给互联网</li></ul><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/c4bf53ae85cf100901773913ecec5373.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LV8pcGsPKIlmNbqpZEvaJg.png"/></div></div></figure><p id="d8a3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建部署和服务。</p><pre class="lv lw lx ly gt mk ml mm mn aw mo bi"><span id="4fdb" class="mp kx iq ml b gy mq mr l ms mt">kubectl apply -f deployment.yaml --record</span></pre><p id="2edb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查部署流程</p><pre class="lv lw lx ly gt mk ml mm mn aw mo bi"><span id="3d94" class="mp kx iq ml b gy mq mr l ms mt">kubectl get deployments</span></pre><p id="ea38" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查舱(集装箱)</p><pre class="lv lw lx ly gt mk ml mm mn aw mo bi"><span id="87b9" class="mp kx iq ml b gy mq mr l ms mt">kubectl get pods</span></pre><p id="6d41" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查服务并复制外部IP地址(负载平衡器)</p><pre class="lv lw lx ly gt mk ml mm mn aw mo bi"><span id="7cc7" class="mp kx iq ml b gy mq mr l ms mt">kubectl get services</span></pre><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/2efa7d3315498feccbc7d13801d287de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fFD_c3tTOLc0QDk7DRh3bg.png"/></div></div></figure><p id="db99" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，您可以在浏览器中打开这个URL</p><pre class="lv lw lx ly gt mk ml mm mn aw mo bi"><span id="8dc6" class="mp kx iq ml b gy mq mr l ms mt">http://&lt;EXTERNAL-IP&gt;/encrypt?secret=abc&amp;message=i-love-you</span></pre><h1 id="d466" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">如何发布新版本？</h1><p id="bafa" class="pw-post-body-paragraph jy jz iq ka b kb mf kd ke kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv ij bi translated">将新版本的docker映像推送到容器注册表中，在<strong class="ka ir"> deployment.yaml </strong>中更改docker映像版本，然后运行此命令来设置所需的部署状态。</p><pre class="lv lw lx ly gt mk ml mm mn aw mo bi"><span id="a864" class="mp kx iq ml b gy mq mr l ms mt">kubectl apply -f deployment.yaml --record</span></pre><h1 id="7a0f" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">如何回滚新版本？</h1><pre class="lv lw lx ly gt mk ml mm mn aw mo bi"><span id="5f11" class="mp kx iq ml b gy mq mr l ms mt">kubectl rollout undo deployment/my-app-deployment</span></pre><h1 id="aee0" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">有用的提示</h1><p id="3b08" class="pw-post-body-paragraph jy jz iq ka b kb mf kd ke kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv ij bi translated">检查集装箱日志</p><pre class="lv lw lx ly gt mk ml mm mn aw mo bi"><span id="8007" class="mp kx iq ml b gy mq mr l ms mt">kubectl logs &lt;POD NAME&gt;</span></pre><p id="f7a6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">进入容器内部</p><pre class="lv lw lx ly gt mk ml mm mn aw mo bi"><span id="3b1f" class="mp kx iq ml b gy mq mr l ms mt">kubectl exec -it &lt;POD NAME&gt; bash</span></pre><p id="ba5e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">删除整个部署</p><pre class="lv lw lx ly gt mk ml mm mn aw mo bi"><span id="e64c" class="mp kx iq ml b gy mq mr l ms mt">kubectl delete deployment my-app-deployment</span></pre><p id="c0d5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为部署设置水平窗格自动缩放策略</p><pre class="lv lw lx ly gt mk ml mm mn aw mo bi"><span id="01af" class="mp kx iq ml b gy mq mr l ms mt">kubectl autoscale deployment &lt;DEPLOYMENT_NAME&gt; --max 6 --min 1 --cpu-percent 60</span></pre><p id="783f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查水平窗格自动缩放策略(HorizontalPodAutoscaler对象)</p><pre class="lv lw lx ly gt mk ml mm mn aw mo bi"><span id="f535" class="mp kx iq ml b gy mq mr l ms mt">kubectl get hpa</span></pre><p id="08d7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查pod事件以调查pod部署、轮询docker映像等问题。</p><pre class="lv lw lx ly gt mk ml mm mn aw mo bi"><span id="560d" class="mp kx iq ml b gy mq mr l ms mt">kubectl get pods<br/>kubectl describe pods/&lt;POD_NAME&gt;</span></pre><h1 id="ac3b" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">下一步是什么？</h1><p id="474c" class="pw-post-body-paragraph jy jz iq ka b kb mf kd ke kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv ij bi translated">现在，您已经了解了如何创建GKE集群、部署容器、发布新版本和回滚、设置自动伸缩策略以及如何调查问题。</p><p id="b3fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您还可以阅读有关这些主题的更多信息:</p><ol class=""><li id="b05b" class="mw mx iq ka b kb kc kf kg kj my kn mz kr na kv nm nc nd ne bi translated">管理秘密</li><li id="3c21" class="mw mx iq ka b kb nf kf ng kj nh kn ni kr nj kv nm nc nd ne bi translated">标签</li><li id="e24b" class="mw mx iq ka b kb nf kf ng kj nh kn ni kr nj kv nm nc nd ne bi translated">命名空间</li><li id="a2d9" class="mw mx iq ka b kb nf kf ng kj nh kn ni kr nj kv nm nc nd ne bi translated">应用程序运行状况检查</li><li id="5dc7" class="mw mx iq ka b kb nf kf ng kj nh kn ni kr nj kv nm nc nd ne bi translated">其他服务类型(集群IP、节点端口、外部名称)</li><li id="78f1" class="mw mx iq ka b kb nf kf ng kj nh kn ni kr nj kv nm nc nd ne bi translated">进入</li></ol></div></div>    
</body>
</html>