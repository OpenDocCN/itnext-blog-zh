<html>
<head>
<title>Journey Of A Microservice Application In The Kubernetes World</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes世界的微服务应用之旅</h1>
<blockquote>原文：<a href="https://itnext.io/journey-of-a-microservice-application-in-the-kubernetes-world-e800579f0be3?source=collection_archive---------0-----------------------#2022-09-13">https://itnext.io/journey-of-a-microservice-application-in-the-kubernetes-world-e800579f0be3?source=collection_archive---------0-----------------------#2022-09-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9e45" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在Civo Kubernetes上运行应用程序</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7d3991f4692eed8668333a487af24bdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aU0SWEmhQKH6Onu_wC6eMQ.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@grstocks?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> GR Stocks </a>在<a class="ae ky" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h2 id="734b" class="lg lh it bd li lj lk dn ll lm ln dp lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">TL；速度三角形定位法(dead reckoning)</h2><p id="701f" class="pw-post-body-paragraph mc md it me b mf mg ju mh mi mj jx mk lp ml mm mn lt mo mp mq lx mr ms mt mu im bi translated">在之前的文章中，我们介绍了<a class="ae ky" href="https://webhooks.app/" rel="noopener ugc nofollow" target="_blank"> webhooks </a>应用程序，用Docker Compose运行它，并将其部署到本地Kubernetes集群中(基于k3s)。现在是时候给这个应用程序一个新的房子，并在真正的生产集群上运行它了。我们将在<a class="ae ky" href="https://civo.com" rel="noopener ugc nofollow" target="_blank"> Civo </a>创建这个集群。</p><p id="5ed9" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">澄清一点:在本文之前<a class="ae ky" href="https://webhooks.app" rel="noopener ugc nofollow" target="_blank"> webhooks.app </a>被部署在一个运行单节点k3s集群的虚拟机上(是的……我知道)，在本文结束时，它将运行在一个由<a class="ae ky" href="https://civo.com" rel="noopener ugc nofollow" target="_blank"> Civo </a>管理的全新k3s集群上。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h2 id="e59e" class="lg lh it bd li lj lk dn ll lm ln dp lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">本系列文章</h2><ul class=""><li id="5ba0" class="na nb it me b mf mg mi mj lp nc lt nd lx ne mu nf ng nh ni bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/journey-of-a-microservice-application-in-the-kubernetes-world-bdfe795532ef">web hooks . app展示</a></li><li id="a9d2" class="na nb it me b mf nj mi nk lp nl lt nm lx nn mu nf ng nh ni bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/journey-of-a-microservice-application-in-the-kubernetes-world-3c2a9e701e9f">使用Helm在Kubernetes上运行应用</a></li><li id="18d4" class="na nb it me b mf nj mi nk lp nl lt nm lx nn mu nf ng nh ni bi translated">在Civo Kubernetes集群上运行应用程序(本文)</li><li id="3ed3" class="na nb it me b mf nj mi nk lp nl lt nm lx nn mu nf ng nh ni bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/journey-of-a-microservice-application-in-the-kubernetes-world-d9493b19edff">使用GitOps和ArgoCD进行连续部署</a></li><li id="cf28" class="na nb it me b mf nj mi nk lp nl lt nm lx nn mu nf ng nh ni bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/journey-of-a-microservice-application-in-the-kubernetes-world-876f72ce1681">使用Loki堆栈的可观察性</a></li><li id="4a4d" class="na nb it me b mf nj mi nk lp nl lt nm lx nn mu nf ng nh ni bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/journey-of-a-microservice-application-in-the-kubernetes-world-e2f6475ddde1">使用Acorn定义应用</a></li><li id="f51b" class="na nb it me b mf nj mi nk lp nl lt nm lx nn mu nf ng nh ni bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/journey-of-a-microservice-application-in-the-kubernetes-world-6abd625c60fe">安全注意事项:安全相关工具</a></li><li id="7bea" class="na nb it me b mf nj mi nk lp nl lt nm lx nn mu nf ng nh ni bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/journey-of-a-microservice-application-in-the-kubernetes-world-eb0fb52e1bf0">安全考虑:修复错误配置</a></li><li id="3c61" class="na nb it me b mf nj mi nk lp nl lt nm lx nn mu nf ng nh ni bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/journey-of-a-microservice-application-in-the-kubernetes-world-f760cba7600f">安全考虑:策略实施</a></li><li id="24c3" class="na nb it me b mf nj mi nk lp nl lt nm lx nn mu nf ng nh ni bi translated">安全考虑:漏洞扫描(即将推出)</li></ul></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h2 id="1cfa" class="lg lh it bd li lj lk dn ll lm ln dp lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">关于Civo</h2><p id="16c9" class="pw-post-body-paragraph mc md it me b mf mg ju mh mi mj jx mk lp ml mm mn lt mo mp mq lx mr ms mt mu im bi translated"><a class="ae ky" href="http://civo.com" rel="noopener ugc nofollow" target="_blank"> Civo </a>是一家云提供商，提供独特的基于k3s的托管Kubernetes集群。他们提供全面的产品，如下图所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/bb5982869f54a5c69ca9744a2b21649e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o3FIsFPWaRq_OTVxTFdamw.png"/></div></div></figure><p id="4792" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">在Civo中，我们可以创建</p><ul class=""><li id="54ea" class="na nb it me b mf mv mi mw lp np lt nq lx nr mu nf ng nh ni bi translated">库伯内特星团</li><li id="16b4" class="na nb it me b mf nj mi nk lp nl lt nm lx nn mu nf ng nh ni bi translated">虚拟机</li><li id="26f6" class="na nb it me b mf nj mi nk lp nl lt nm lx nn mu nf ng nh ni bi translated">要放在这些虚拟机前面的负载平衡器</li><li id="11ca" class="na nb it me b mf nj mi nk lp nl lt nm lx nn mu nf ng nh ni bi translated">托管数据库应该在不久的将来可用</li></ul><p id="3571" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">我知道Civo已经有一段时间了，因为几年前我是#KUBE100计划的一部分，当时该公司正在构建其k3s集群产品。</p><p id="8eda" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">在上一篇文章中，我们已经看到了如何将webhooks应用程序部署到本地k3s集群，Civo Kubernetes是在生产环境中继续使用k3s的理想选择。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h2 id="f0a1" class="lg lh it bd li lj lk dn ll lm ln dp lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">创建k3s集群</h2><p id="a733" class="pw-post-body-paragraph mc md it me b mf mg ju mh mi mj jx mk lp ml mm mn lt mo mp mq lx mr ms mt mu im bi translated">在Civo上创建Kubernetes集群有几种方法:</p><ul class=""><li id="b218" class="na nb it me b mf mv mi mw lp np lt nq lx nr mu nf ng nh ni bi translated">使用web仪表板</li><li id="2b15" class="na nb it me b mf nj mi nk lp nl lt nm lx nn mu nf ng nh ni bi translated">使用<a class="ae ky" href="https://github.com/civo/cli" rel="noopener ugc nofollow" target="_blank"> Civo cli </a></li><li id="7ba7" class="na nb it me b mf nj mi nk lp nl lt nm lx nn mu nf ng nh ni bi translated">使用基础设施作为代码工具，如<a class="ae ky" href="https://registry.terraform.io/providers/civo/civo/latest/docs" rel="noopener ugc nofollow" target="_blank"> Terraform </a>或<a class="ae ky" href="https://www.pulumi.com/registry/packages/civo/" rel="noopener ugc nofollow" target="_blank"> Pulumi </a></li></ul><p id="ebbf" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">当我们使用控制面板创建集群时，我们需要提供一些信息，例如:</p><ul class=""><li id="3de3" class="na nb it me b mf mv mi mw lp np lt nq lx nr mu nf ng nh ni bi translated">我们全新集群的名称(<em class="ns"> webhooks </em>)</li><li id="694d" class="na nb it me b mf nj mi nk lp nl lt nm lx nn mu nf ng nh ni bi translated">它将包含的节点数(<em class="ns"> 2 </em>)</li><li id="2f32" class="na nb it me b mf nj mi nk lp nl lt nm lx nn mu nf ng nh ni bi translated">网络(网络是用来隔离虚拟机的)，我们坚持这里的默认网络</li><li id="5d6e" class="na nb it me b mf nj mi nk lp nl lt nm lx nn mu nf ng nh ni bi translated">这些节点的类型(<em class="ns">中</em>)</li><li id="5999" class="na nb it me b mf nj mi nk lp nl lt nm lx nn mu nf ng nh ni bi translated">一种防火墙，可用于防止从整个互联网访问API服务器</li><li id="7d38" class="na nb it me b mf nj mi nk lp nl lt nm lx nn mu nf ng nh ni bi translated">要安装的网络插件(默认为<em class="ns">法兰绒</em>，但我们在这里选择<em class="ns">纤毛</em></li><li id="e22e" class="na nb it me b mf nj mi nk lp nl lt nm lx nn mu nf ng nh ni bi translated">将要安装的来自市场的组件(<em class="ns">度量-服务器</em>)。我明确取消选择Traefik入口控制器(默认情况下安装),因为稍后我将使用特定选项安装它。</li></ul><div class="kj kk kl km gt ab cb"><figure class="nt kn nu nv nw nx ny paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/52136cd71576f1380175ed5e93c986d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*mGH9vaey6qL4elNqEBw1BA.png"/></div></figure><figure class="nt kn nu nv nw nx ny paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/6960ab0e6e0b3406f775be7b32894079.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*Fs0v-cBl312dcejtBLpySw.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk nz di oa ob translated">集群配置选项</figcaption></figure></div><p id="aa75" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">集群启动并运行只需不到2分钟的时间(真的那么快！)</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/4fd6f07579d7d8f3fea6275ca2bc9161.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nCgvA_T5fVvjJ2aa0zNaaQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">集群创建非常快</figcaption></figure><p id="097e" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">从仪表板中，我们可以检索admin <em class="ns"> kubeconfig </em>文件。一旦我们配置了我们的本地库，我们就可以与我们新创建的集群通信，并列出它包含的节点和当前正在运行的Pods:</p><pre class="kj kk kl km gt od oe of og aw oh bi"><span id="7691" class="lg lh it oe b gy oi oj l ok ol">$ kubectl get no<br/>NAME                         STATUS   ROLES    AGE     VERSION<br/>k3s-webhooks-...-d0b7-rwon6  Ready    &lt;none&gt;   4m12s   v1.22.11+k3s1<br/>k3s-webhooks-...-d0b7-4pz4a  Ready    &lt;none&gt;   3m56s   v1.22.11+k3s1</span><span id="1c44" class="lg lh it oe b gy om oj l ok ol">$ kubectl get po -A<br/>NAMESPACE   NAME                        READY STATUS  RESTARTS   AGE<br/>kube-system cilium-operator-865ff-q6cq8 1/1   Running 0          3m<br/>kube-system cilium-52k9h                1/1   Running 0          3m<br/>kube-system civo-ccm-7cb9c4b58f-x5pth   1/1   Running 0          3m<br/>kube-system cilium-operator-865ff-6q2c  1/1   Running 0          3m<br/>kube-system coredns-7796b77cd4-5t2f7    1/1   Running 0          3m<br/>kube-system metrics-server-ff96c-kx79z  1/1   Running 0          3m<br/>kube-system civo-csi-node-frrmh         2/2   Running 0          2m<br/>kube-system civo-csi-controller-0       4/4   Running 0          3m<br/>kube-system cilium-m8rd9                1/1   Running 0          2m<br/>kube-system civo-csi-node-7knf4         2/2   Running 0          2m</span></pre><p id="f7f1" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">注意:Civo集群还附带了一个StorageClass，我们将在下一篇文章中使用它向应用程序的数据库添加持久存储。</p><p id="b2cf" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">我们直接从仪表板创建了集群，但是Civo也提供了一个<em class="ns"> civo </em>二进制文件来从命令行管理底层基础设施。按照<a class="ae ky" href="https://github.com/civo/cli#set-up" rel="noopener ugc nofollow" target="_blank">的安装说明</a>，它可以安装在MacOS、Linux和Windows上。</p><p id="fd3f" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">不带任何参数运行这个二进制文件会提供所有可用命令的列表:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/bfbaaeb58c01343eb45eb3420ff7d7ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G0Go5IpKYuyoT8zHpIUOxw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Civo的cli选项</figcaption></figure><p id="d7c8" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">要使用这个二进制文件，我们首先需要添加一个API密钥，这可以按照<a class="ae ky" href="https://github.com/civo/cli#api-keys" rel="noopener ugc nofollow" target="_blank">这些指令</a>来完成。</p><p id="7631" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">一旦配置了API密钥，<em class="ns"> civo </em>二进制文件就可以用于从命令行轻松管理基础设施。例如，以下命令使用Cilium作为CNI插件创建一个2节点集群:</p><pre class="kj kk kl km gt od oe of og aw oh bi"><span id="b001" class="lg lh it oe b gy oi oj l ok ol">$ civo kubernetes create webhooks \<br/>  --size=g4s.kube.medium \<br/>  --nodes=2 \<br/>  <!-- -->--cni-plugin=cilium</span></pre></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h2 id="cb97" class="lg lh it bd li lj lk dn ll lm ln dp lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">入口控制器的安装</h2><p id="ea2e" class="pw-post-body-paragraph mc md it me b mf mg ju mh mi mj jx mk lp ml mm mn lt mo mp mq lx mr ms mt mu im bi translated">群集已启动并运行，我们现在将安装入口控制器。这将用于(向外界)公开我们将要在集群上部署的应用程序。</p><p id="fc68" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated"><em class="ns">配置</em>库的<em class="ns"> apps/traefik </em>文件夹包含使用以下<em class="ns"> helmfile.yaml </em>将traefik入口控制器部署为舵图的规范:</p><pre class="kj kk kl km gt od oe of og aw oh bi"><span id="50ef" class="lg lh it oe b gy oi oj l ok ol"># config/apps/traefik/helmfile.yaml</span><span id="342d" class="lg lh it oe b gy om oj l ok ol">repositories:<br/>- name: traefik<br/>  url: https://helm.traefik.io/traefik</span><span id="c74f" class="lg lh it oe b gy om oj l ok ol">releases:<br/>- name: traefik<br/>  namespace: traefik<br/>  labels:<br/>    app: traefik<br/>  chart: traefik/traefik<br/>  version: ~10.24.2<br/>  values:<br/>  - ./values.yaml.gotmpl</span></pre><p id="dce5" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">注意:如果你不知道<a class="ae ky" href="https://github.com/helmfile/helmfile" rel="noopener ugc nofollow" target="_blank"> Helmfile </a>，我真的建议你看看这个伟大的项目，它允许以一种更声明性的方式安装Helm chart</p><p id="ebd2" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">因为我们希望Traefik处理TLS，所以这个Helmfile引用了一个名为<em class="ns"> values.yaml.gotmpl. </em>的值文件，它有一个时髦的扩展名，因为它包含Go模板，需要该模板来获取当前shell中设置的以下环境变量的内容:</p><ul class=""><li id="3ae0" class="na nb it me b mf mv mi mw lp np lt nq lx nr mu nf ng nh ni bi translated">ACME_EMAIL_ADDRESS:提供给Let's Encrypt的电子邮件地址</li><li id="c9ad" class="na nb it me b mf nj mi nk lp nl lt nm lx nn mu nf ng nh ni bi translated">CF_DNS_API_TOKEN:请求TLS证书时用于检查DNS01质询的CloudFlare API令牌</li></ul><pre class="kj kk kl km gt od oe of og aw oh bi"><span id="7143" class="lg lh it oe b gy oi oj l ok ol"># config/apps/traefik/values.yaml.gotmpl</span><span id="8cf8" class="lg lh it oe b gy om oj l ok ol"># Configuration options<br/>additionalArguments:<br/>- --accesslog<br/>- --certificatesresolvers.le.acme.email={{ requiredEnv "ACME_EMAIL_ADDRESS" }}<br/>- --certificatesresolvers.le.acme.storage=/data/acme.json<br/>- --certificatesresolvers.le.acme.dnschallenge=true<br/>- --certificatesresolvers.le.acme.dnschallenge.provider=cloudflare<br/>- --certificatesresolvers.le.acme.dnschallenge.delaybeforecheck=0<br/>- --log.level=INFO</span><span id="b6ba" class="lg lh it oe b gy om oj l ok ol"># Environment variables to be passed to Traefik<br/>env:<br/>- name: CF_DNS_API_TOKEN<br/>  value: {{ requiredEnv "CF_DNS_API_TOKEN" }}</span></pre><p id="f3fc" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">从<em class="ns"> config/apps/traefik </em>中，我们安装traefik入口控制器:</p><pre class="kj kk kl km gt od oe of og aw oh bi"><span id="122c" class="lg lh it oe b gy oi oj l ok ol">$ helmfile apply</span></pre><p id="2c7e" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">接下来，我们验证Traefik Pod是否运行正常:</p><pre class="kj kk kl km gt od oe of og aw oh bi"><span id="991a" class="lg lh it oe b gy oi oj l ok ol"><strong class="oe iu">$ kubectl get po -n traefik<br/></strong>NAME                          READY   STATUS    RESTARTS   AGE<br/>pod/traefik-b56cb5bf6-mz8rm   1/1     Running   0          13s</span></pre><p id="b3d4" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">Traefik公开了一个负载平衡器服务，它提供了一个外部IP，可用于访问将在集群中运行的应用程序。</p><pre class="kj kk kl km gt od oe of og aw oh bi"><span id="63db" class="lg lh it oe b gy oi oj l ok ol"><strong class="oe iu">$ kubectl -n traefik get svc<br/></strong>NAME              TYPE           CLUSTER-IP     EXTERNAL-IP    PORT(S)                      AGE<br/>service/traefik   LoadBalancer   10.43.138.18   74.220.24.13   80:31190/TCP,443:30636/TCP   13s</span></pre><p id="902b" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">从Civo的仪表板上，我们也可以看到这个负载平衡器的特征。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/a568c37f4e9f413121ca5431011ca3a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pFICu9pRL7e7PAf_3BlfDA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Traefik通过LoadBalancer类型的服务公开</figcaption></figure><p id="e8dd" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">现在Traefik Ingress控制器正在运行，我们可以在新创建的集群上部署webhooks应用程序了。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h2 id="15c7" class="lg lh it bd li lj lk dn ll lm ln dp lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">运行应用程序</h2><p id="8c95" class="pw-post-body-paragraph mc md it me b mf mg ju mh mi mj jx mk lp ml mm mn lt mo mp mq lx mr ms mt mu im bi translated">配置库<em class="ns">中的<em class="ns"> apps/webhooks </em>文件夹包含了定义webhooks应用程序的导航图。正如我们之前所做的，我们使用Helmfile来定义图表需要如何部署:</em></p><pre class="kj kk kl km gt od oe of og aw oh bi"><span id="2f62" class="lg lh it oe b gy oi oj l ok ol"># config/app/webhooks/helmfile.yaml</span><span id="456c" class="lg lh it oe b gy om oj l ok ol">releases:<br/>- name: webhooks<br/>  namespace: webhooks<br/>  labels:<br/>    app: webhooks<br/>  chart: .<br/>  values:<br/>  - values.yaml</span></pre><p id="5d48" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated"><em class="ns"> values.yaml </em>定义了图像标签以及应用程序将暴露的域。Traefik还将使用该域名向Let's Encrypt请求TLS证书。</p><pre class="kj kk kl km gt od oe of og aw oh bi"><span id="b012" class="lg lh it oe b gy oi oj l ok ol"># config/app/webhooks/values.yaml</span><span id="86dc" class="lg lh it oe b gy om oj l ok ol">tls: true<br/>domain: webhooks.app<br/>api:<br/>  tag: v1.0.33<br/>mongo:<br/>  tag: 4.4<br/>nats:<br/>  tag: 2.8.4-alpine3.15<br/>ws:<br/>  tag: v1.0.7<br/>www:<br/>  tag: v1.0.34</span></pre><p id="ccc1" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">从<em class="ns"> config/apps/webhooks </em>中，我们安装webhooks应用程序:</p><pre class="kj kk kl km gt od oe of og aw oh bi"><span id="09f0" class="lg lh it oe b gy oi oj l ok ol">$ helmfile apply</span></pre><p id="116a" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">接下来，我们验证pod是否运行正常</p><pre class="kj kk kl km gt od oe of og aw oh bi"><span id="1a1c" class="lg lh it oe b gy oi oj l ok ol"><strong class="oe iu">$ kubectl get po -n webhooks<br/></strong>NAME                       READY   STATUS    RESTARTS   AGE<br/>nats-594ff94b94-42jxx      1/1     Running   0          21s<br/>ws-c7ff94f45-45wx8         1/1     Running   0          21s<br/>api-54c78799d4-qbhjz       1/1     Running   0          21s<br/>www-6dbb6d848f-ffrcf       1/1     Running   0          21s<br/>mongo-85dfbcbf58-5qqp9     1/1     Running   0          21s</span></pre></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h2 id="07d1" class="lg lh it bd li lj lk dn ll lm ln dp lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">测试整个事情</h2><p id="0f50" class="pw-post-body-paragraph mc md it me b mf mg ju mh mi mj jx mk lp ml mm mn lt mo mp mq lx mr ms mt mu im bi translated">当我们将应用从运行k3s的单个虚拟机迁移到Civo Kubernetes集群时，我们需要确保DNS条目(该项目使用CloudFlare作为DNS提供商)得到更新，以便域名<em class="ns"> webhooks.app </em>现在指向暴露Traefik入口控制器的负载平衡器的IP地址。</p><p id="d16d" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">一旦DNS更改完成(这可能需要几分钟才能传播)，我们将能够访问运行在Civo上的webhooks应用程序。</p><div class="kj kk kl km gt ab cb"><figure class="nt kn op nv nw nx ny paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/79c5dc0a8a6d50d88701e401d7f0280a.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*FVcMoGlFAflErXkh4UcmEQ.png"/></div></figure><figure class="nt kn op nv nw nx ny paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/74ab4a245b405778957abe546e0d59bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*e7HrTFQb2bmNEdbsFW07gA.png"/></div></figure><figure class="nt kn op nv nw nx ny paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/89d1e9790b5ebdf0e842137330e09b14.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*WI7pDZ9Ox6-YE3D8Gjon7g.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk oq di or ob translated">webhooks.app现在在Civo Kubernetes上运行</figcaption></figure></div><p id="9b27" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">应用程序现在运行在由<a class="ae ky" href="https://civo.com" rel="noopener ugc nofollow" target="_blank"> Civo </a>管理的生产集群上。这是否意味着应用程序本身已经可以生产了？不…不是的！在以后的文章中，我们将考察几个方面，并做出可以显著增强应用程序的更改。</p><p id="ab8e" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">在基础设施方面，我们目前使用一个2中型节点集群和一个额外的负载平衡器来展示我们的Traefik入口控制器。这总共花费50美元/月，对于所提供的服务来说并不算贵。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="d518" class="pw-post-body-paragraph mc md it me b mf mv ju mh mi mw jx mk lp mx mm mn lt my mp mq lx mz ms mt mu im bi translated">在本系列的下一篇文章<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/journey-of-a-microservice-application-in-the-kubernetes-world-d9493b19edff">中，我们将解释如何在我们的CICD管道中使用GitOps方法。</a></p></div></div>    
</body>
</html>