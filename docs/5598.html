<html>
<head>
<title>Cypress browser testing on BitBucket CI pipeline using parallel steps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用并行步骤在BitBucket CI管道上测试Cypress浏览器</h1>
<blockquote>原文：<a href="https://itnext.io/cypress-browser-testing-on-bitbucket-ci-pipeline-using-parallel-steps-41655dd1935c?source=collection_archive---------2-----------------------#2021-04-13">https://itnext.io/cypress-browser-testing-on-bitbucket-ci-pipeline-using-parallel-steps-41655dd1935c?source=collection_archive---------2-----------------------#2021-04-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="a38f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您是否使用BitBucket管道作为CI服务器？你在赛普拉斯的缓慢的E2E测试中挣扎吗？您知道BitBucket管道可以运行并行步骤吗？您可以使用它将您的浏览器测试分布到几个并行的步骤中，以便在短时间内执行端到端的Cypress测试。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/802d2d2b56a101598892a9807c40120d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9oW0rdRjKcLbosbD.jpeg"/></div></div></figure><h1 id="7d75" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">如何并行运行测试</h1><p id="1509" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">跨并行步骤分布测试以分散工作负载并更快地运行测试可能比您想象的更具挑战性。问题是如何在并行作业中划分Cypress测试文件，以确保工作均匀分布？但是…平均分配工作是你真正想要的吗？</p><p id="8fe2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要获得最短的CI构建时间，您需要充分利用可用的CI资源。你想避免浪费时间。这意味着您希望确保并行步骤在相似的时间完成工作，因为这意味着CI机器利用率没有瓶颈。</p><p id="77d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">很多事情都是未知的，不可预测的。这可能会影响在BitBucket管道上执行测试所需的时间。有这样的事情:</p><ul class=""><li id="1e68" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mf mg mh mi bi translated">启动时间—加载CI docker容器所花费的时间</li><li id="c8be" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">从缓存加载npm/yarn依赖关系</li><li id="11b5" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">运行Cypress测试</li><li id="924c" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">测试可以在不同的浏览器上运行，这会影响测试的执行时间</li><li id="311f" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">有时测试会失败，它们的执行时间是不同的</li><li id="f37a" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">其他时候，您可能有随机失败的的<a class="ae mo" href="https://docs.knapsackpro.com/2021/fix-intermittently-failing-ci-builds-flaky-tests-rspec" rel="noopener ugc nofollow" target="_blank">脆弱测试，您可以使用Cypress中的测试重试来自动重新运行失败的测试用例。这导致运行测试文件的时间更长。</a></li></ul><p id="5e02" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所有这些都增加了执行时间的不确定性。很难知道如何最好地将测试文件划分到并行的步骤中，以确保这些步骤在相似的时间完成工作。但是有一个解决方案——在运行时拆分动态测试套件。</p><h1 id="44c5" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">队列模式—动态测试分割</h1><p id="67e4" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">要跨BitBucket管道并行步骤分布测试工作，您可以使用带有队列模式的<a class="ae mo" href="https://knapsackpro.com/?utm_source=docs_knapsackpro&amp;utm_medium=blog_post&amp;utm_campaign=how-bitbucket-pipeline-with-parallel-cypress-tests-can-speed-up-ci-build" rel="noopener ugc nofollow" target="_blank">背包Pro </a>。您可以使用<code class="fe mp mq mr ms b"><a class="ae mo" href="https://github.com/KnapsackPro/knapsack-pro-cypress#knapsack-procypress" rel="noopener ugc nofollow" target="_blank">@knapsack-pro/cypress</a></code> <a class="ae mo" href="https://github.com/KnapsackPro/knapsack-pro-cypress#knapsack-procypress" rel="noopener ugc nofollow" target="_blank"> npm包</a>，它将在backpack Pro API端生成一个包含测试文件列表的队列，然后所有并行步骤都可以连接到该队列来使用测试文件并执行它们。这样，并行步骤只有在执行完之前从backpack Pro API获取的一组测试之后，才会要求更多的测试。你可以从文章中了解到队列模式的<a class="ae mo" href="https://docs.knapsackpro.com/2020/how-to-speed-up-ruby-and-javascript-tests-with-ci-parallelisation" rel="noopener ugc nofollow" target="_blank">细节。</a></p><h1 id="383f" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">位桶管道YML配置</h1><p id="050a" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">下面是一个YML中的位桶管道配置的例子。如你所见，通过<a class="ae mo" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=medium-how-bitbucket-pipeline-with-parallel-cypress-tests-can-speed-up-ci-build" rel="noopener ugc nofollow" target="_blank">backpack Pro</a>运行Cypress测试有3个并行步骤。如果您想在更多的并行任务上运行您的测试，您只需要添加更多的步骤。</p><pre class="km kn ko kp gt mt ms mu mv aw mw bi"><span id="aa11" class="mx ky iq ms b gy my mz l na nb">image: cypress/base:10<br/>options:<br/>  max-time: 30<br/><br/><em class="nc"># job definition for running E2E tests in parallel with </em><a class="ae mo" href="http://knapsackpro.com/" rel="noopener ugc nofollow" target="_blank"><em class="nc">KnapsackPro.com</em></a><br/>e2e: &amp;e2e<br/>  name: Run E2E tests with @knapsack-pro/cypress<br/>  caches:<br/>    - node<br/>    - cypress<br/>  script:<br/>    <em class="nc"># run web application in the background</em><br/>    - npm run start:ci &amp;<br/>    <em class="nc"># env vars from </em><a class="ae mo" href="https://support.atlassian.com/bitbucket-cloud/docs/variables-and-secrets/" rel="noopener ugc nofollow" target="_blank"><em class="nc">https://support.atlassian.com/bitbucket-cloud/docs/variables-and-secrets/</em></a><br/>    - export KNAPSACK_PRO_CI_NODE_BUILD_ID=$BITBUCKET_BUILD_NUMBER<br/>    - export KNAPSACK_PRO_COMMIT_HASH=$BITBUCKET_COMMIT<br/>    - export KNAPSACK_PRO_BRANCH=$BITBUCKET_BRANCH<br/>    - export KNAPSACK_PRO_CI_NODE_TOTAL=$BITBUCKET_PARALLEL_STEP<br/>    - export KNAPSACK_PRO_CI_NODE_INDEX=$BITBUCKET_PARALLEL_STEP_COUNT<br/>    <em class="nc"># </em><a class="ae mo" href="https://github.com/KnapsackPro/knapsack-pro-cypress#configuration-steps" rel="noopener ugc nofollow" target="_blank"><em class="nc">https://github.com/KnapsackPro/knapsack-pro-cypress#configuration-steps</em></a><br/>    - export KNAPSACK_PRO_FIXED_QUEUE_SPLIT=true<br/>    - $(npm bin)/knapsack-pro-cypress<br/>  artifacts:<br/>    <em class="nc"># store any generated images and videos as artifacts</em><br/>    - cypress/screenshots/**<br/>    - cypress/videos/**<br/><br/>pipelines:<br/>  default:<br/>  - step:<br/>      name: Install dependencies<br/>      caches:<br/>        - npm<br/>        - cypress<br/>        - node<br/>      script:<br/>        - npm ci<br/>  - parallel:<br/>    <em class="nc"># run N steps in parallel</em><br/>    - step:<br/>        &lt;&lt;: *e2e<br/>    - step:<br/>        &lt;&lt;: *e2e<br/>    - step:<br/>        &lt;&lt;: *e2e<br/><br/>definitions:<br/>  caches:<br/>    npm: $HOME/.npm<br/>    cypress: $HOME/.cache/Cypress</span></pre><p id="27c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你正在寻找一个并行步骤的定制docker容器的例子，请参见<a class="ae mo" href="https://gist.github.com/ArturT/90b7ec869e3827b580664beb086a8cd6" rel="noopener ugc nofollow" target="_blank">这个</a>。</p><p id="0748" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请记住在<code class="fe mp mq mr ms b">KNAPSACK_PRO_TEST_SUITE_TOKEN_CYPRESS</code>环境变量中添加您的API令牌作为<a class="ae mo" href="https://support.atlassian.com/bitbucket-cloud/docs/variables-and-secrets/" rel="noopener ugc nofollow" target="_blank">安全变量</a>。</p><h1 id="7245" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">摘要</h1><p id="d822" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">BitBucket Pipeline是一个CI服务器，它允许并行运行脚本。您可以使用并行步骤，通过<a class="ae mo" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=medium-how-bitbucket-pipeline-with-parallel-cypress-tests-can-speed-up-ci-build" rel="noopener ugc nofollow" target="_blank">backpack Pro</a>分发您的Cypress测试，以节省时间并尽可能快地运行CI构建。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/7fc9f0837af680ca0a9a92529b6fc620.png" data-original-src="https://miro.medium.com/v2/resize:fit:160/format:webp/0*WMDeU56jo3EVjpuc.png"/></div></figure></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><p id="24b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nc">原载于2021年4月13日</em><a class="ae mo" href="https://docs.knapsackpro.com/2021/how-bitbucket-pipeline-with-parallel-cypress-tests-can-speed-up-ci-build" rel="noopener ugc nofollow" target="_blank"><em class="nc">【https://docs.knapsackpro.com】</em></a><em class="nc">。</em></p></div></div>    
</body>
</html>