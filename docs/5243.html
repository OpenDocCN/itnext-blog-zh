<html>
<head>
<title>Multicloud IPv6 with Terraform — Azure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">采用terra form-Azure的多云IPv6</h1>
<blockquote>原文：<a href="https://itnext.io/multicloud-ipv6-with-terraform-azure-231f9ffe35d0?source=collection_archive---------1-----------------------#2021-01-21">https://itnext.io/multicloud-ipv6-with-terraform-azure-231f9ffe35d0?source=collection_archive---------1-----------------------#2021-01-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c18a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我最近有机会在一个POC上工作，在那里我必须使用Terraform测试IPv6功能AWS和Azure。在这个旅程的早期，我很快意识到完成这个任务的文档很少来自云提供商和HashiCorp。此外，云与云之间还有许多细微的差别，除了不得不去研究、测试和从错误中学习之外，这些差别并不为人所知。因此，我发布了我的工作，为这个过程提供一些文档和指导。这个版本是给Azure的，AWS和GCP正在路上。GitHub 中的完整源代码</p><p id="ba08" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">部署概述</strong></p><p id="7a7c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该部署的目标是使用Terraform在AWS和Azure中实现IPv4/IPv6可伸缩、弹性NGNIX部署。</p><p id="84b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此部署的要求如下:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/d6259aebe133bc6a746fbd0612447e8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:818/format:webp/1*Iv9M2u89_zXcO3bxTAQTNA.png"/></div></figure><ol class=""><li id="1450" class="ku kv iq jp b jq jr ju jv jy kw kc kx kg ky kk kz la lb lc bi translated">客户需要通过IPv4和IPv6实现这种部署</li><li id="8125" class="ku kv iq jp b jq ld ju le jy lf kc lg kg lh kk kz la lb lc bi translated">单区域多AZ部署</li><li id="1fde" class="ku kv iq jp b jq ld ju le jy lf kc lg kg lh kk kz la lb lc bi translated">使用本地L4负载平衡器</li><li id="b16a" class="ku kv iq jp b jq ld ju le jy lf kc lg kg lh kk kz la lb lc bi translated">将NGINX用于代理/L7</li><li id="bda5" class="ku kv iq jp b jq ld ju le jy lf kc lg kg lh kk kz la lb lc bi translated">NGINX实例需要自动伸缩</li></ol><p id="9014" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> Azure部署</strong></p><p id="ed84" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Azure支持在所有基础设施组件(VNET、子网、LB、VM等)上进行完整的双栈部署。)这使得IPv6部署实质上是Terraform中IPv4部署的副本。通过IPv6传输数据的费用与IPv4相同。快速概述我们将要创建的内容:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi li"><img src="../Images/99cb850ae4be2b8eac1aa36c12dda4cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/format:webp/1*VMs5_1keJsBgdfRiIC_PTA.png"/></div></figure><p id="357c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">需要注意的一点是，我假设有三个区域可用，因为这是项目的一个要求。并非所有Azure地区都符合这一要求，请查看Azure<a class="ae kl" href="https://azure.microsoft.com/en-us/global-infrastructure/geographies/" rel="noopener ugc nofollow" target="_blank">geographics</a>页面，了解有关该主题的更多信息。</p><p id="80f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> Azure IPv6网络</strong></p><p id="2d0c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除了设置资源组和订阅之外，首先要做的是创建vnet:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="lj lk l"/></div></figure><p id="9af3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建虚拟网络时唯一真正不同的细节是<code class="fe ll lm ln lo b">address_space</code>的分配，它包括我们想要使用的IPv4和IPv6数据块，我们可以更好地查看变量文件:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="lj lk l"/></div></figure><p id="8cff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于空间分配的重要注意事项，对于IPv4块，我们使用RFC 1918空间“10.0.0.0/16 ”,对于IPv6块，我们使用ULA(唯一本地地址)或RFC 1884空间“fd00:db8:deca:daed::/64”ULA地址空间定义为“地址范围<em class="lp"> fc00::/7中的IPv6地址”。</em>它在IPv6中的用途类似于IPv4专用网络寻址。唯一的本地地址可以在单个站点或组织内自由使用，无需集中注册，也可以跨有限数量的站点或组织使用。它们只能在这种专用网络的范围内进行路由，而不能在全球IPv6互联网中进行路由。使用ULA空间时要认识到，在希望通过对等在虚拟网络之间进行路由的组织内，可能会发生重叠，因此需要IPv6地址管理策略。</p><p id="fe19" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步是定义将要使用的子网。与AWS不同，Azure中的子网没有固定到特定的区域，而是跨区域延伸，考虑到这一点，我们将只定义一个子网，以最大限度地利用VM规模集。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="lj lk l"/></div></figure><p id="cd20" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">变量文件再次显示了IPv6的附加内容:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="lj lk l"/></div></figure><p id="2d3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们来看看将要创建的NSG(网络安全组):</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="lj lk l"/></div></figure><p id="7004" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此NSG将适用于IPv4和IPv6，并将允许所有入站流量通过TCP访问端口80。我们现在将定义负载平衡器要使用的前端公共IP:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="lj lk l"/></div></figure><p id="96a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">需要指定<code class="fe ll lm ln lo b">ip_version</code>以确定Azure要分配的地址类型，并且<code class="fe ll lm ln lo b">domain_name_label</code>用于组成FQDN并在Microsoft Azure DNS系统中创建A和AAAA DNS记录。</p><p id="21a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们来看看负载平衡器的创建过程，首先创建一个标准负载平衡器，并将两个公共IP作为前端地址连接起来:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="lj lk l"/></div></figure><p id="9343" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完成后，负载平衡器设置的其余部分就可以完成了，这包括添加后端地址池、创建运行状况探测，以及最终为IPv4和IPv6创建负载平衡规则:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="lj lk l"/></div></figure><p id="29a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个相当大的代码块，但是展示了Azure中的双栈IPv6实现是如何简单地从IPv4复制、粘贴和替换到IPv6的。</p><p id="506a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> Azure IPv6计算</strong></p><p id="8681" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此时，是时候通过创建区域平衡的Linux虚拟机规模集来定义计算了:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="lj lk l"/></div></figure><p id="309b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过使用<code class="fe ll lm ln lo b">zones</code>参数为Scaleset定义区域，我还将<code class="fe ll lm ln lo b">zone_balance</code>参数设置为“真”</p><p id="59b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">值得看一下网络接口部分，其中连接了NSG，使用<code class="fe ll lm ln lo b">version</code>参数定义了IPv4和IPv6的IP配置，并将其连接到IPv4和IPv6负载平衡器池。请注意，需要将其中一个配置设置为主配置。</p><p id="8217" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Terraform脚本部分到此结束，剩下的就是做一些测试了。</p><p id="9f9f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">验证</strong></p><p id="62e7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于这个简单的例子，我首先检查Azure Load Balancer Insights部分，以确保所有部分都在工作:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi lq"><img src="../Images/fc39afdbb7520c7d12c21e086e9c70b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vrwk7IMPegCJaZ-D-hchvA.png"/></div></div></figure><p id="6bd3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此时，可以使用任何连通性测试来检查IPv4:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/0913a8f79e2d380a380a340e3edfd51e.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/format:webp/1*GVyrDoo4h8rVThFZ8FDF6g.png"/></div></figure><p id="8fb6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">检查IPv6连接稍微复杂一点，这取决于您的提供商等。为了简单起见，我只使用https://ipv6-test.com/validate.php的<a class="ae kl" href="https://ipv6-test.com/validate.php" rel="noopener ugc nofollow" target="_blank"/></p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi lw"><img src="../Images/26113561f53777643a2ec8525c00e6d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gb4INIuBkLp-1z8hxsBwtA.png"/></div></div></figure></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><p id="266c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">[1]:维基百科。<em class="lp">唯一本地地址</em><a class="ae kl" href="https://en.wikipedia.org/wiki/Unique_local_address#cite_note-rfc1884-2" rel="noopener ugc nofollow" target="_blank">https://en . Wikipedia . org/wiki/Unique _ local _ address # cite _ note-RFC 1884-2</a></p></div></div>    
</body>
</html>