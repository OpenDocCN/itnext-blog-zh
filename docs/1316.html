<html>
<head>
<title>Build a RESTful API using AWS Lambda, API Gateway, DynamoDB and the Serverless Framework</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS Lambda、API Gateway、DynamoDB和无服务器框架构建RESTful API</h1>
<blockquote>原文：<a href="https://itnext.io/build-a-restful-api-using-aws-lambda-api-gateway-dynamodb-and-the-serverless-framework-30fc68e08a42?source=collection_archive---------0-----------------------#2018-09-10">https://itnext.io/build-a-restful-api-using-aws-lambda-api-gateway-dynamodb-and-the-serverless-framework-30fc68e08a42?source=collection_archive---------0-----------------------#2018-09-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/fa9d70bd30bc4e1202dd468c7108161c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BuC09znymokMKgGupe2bPg.jpeg"/></div></div></figure></div><div class="ab cl jy jz hu ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="ij ik il im in"><p id="269b" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated"><strong class="kh ir">更新:2019年11月16日。</strong></p><p id="6623" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">AWS Node 10.16.x上的无服务器源<a class="ae ld" href="https://github.com/vanister/contacts_api" rel="noopener ugc nofollow" target="_blank">库</a>已更新。</p></div><div class="ab cl jy jz hu ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="ij ik il im in"><p id="361c" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated"><strong class="kh ir">更新时间:2019年1月8日。</strong></p><p id="3fbe" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">一些读者指出，如果您继续将代码样本复制到您的项目中，您可能会在构建或运行时出错。</p><p id="beb9" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">大多数情况下，错误与<code class="fe le lf lg lh b">.env</code>和<code class="fe le lf lg lh b">package.json</code>文件中的引号有关。只需删除一个报价，添加它回来，并保存文件。</p><p id="3ca7" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">感谢reggie smith和Javish Kathuria指出了这一点。</p></div><div class="ab cl jy jz hu ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="ij ik il im in"><p id="cd27" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated"><strong class="kh ir">更新:2018年10月17日。</strong></p><p id="9872" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">我决定用<a class="ae ld" href="https://www.docker.com/products/docker-desktop" rel="noopener ugc nofollow" target="_blank"> Docker </a>和<a class="ae ld" href="https://github.com/localstack/localstack" rel="noopener ugc nofollow" target="_blank"> LocalStack </a>替换Java和DynamoDB本地jar依赖项。</p><p id="38c3" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">这使得开发设置更加灵活，并为在AWS之外运行整个应用程序堆栈提供了一个平台。</p><p id="18ec" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">现在，我们将只从LocalStack容器中运行DynamoDB服务。</p><pre class="lk ll lm ln gt lo lh lp lq aw lr bi"><span id="421d" class="ls lt iq lh b gy lu lv l lw lx"># This will start the container in detached mode and map the dynamodb service to port 8000, which is the port we are using in this article; port 8080 is the localhost management portal for LocalStack.</span><span id="cff8" class="ls lt iq lh b gy ly lv l lw lx"># The <strong class="lh ir">DATA_DIR </strong>environment variable is to persist the data when you start/stop the container.</span><span id="44fe" class="ls lt iq lh b gy ly lv l lw lx"><strong class="lh ir">docker run --name 'dynamodb_localstack' -d -p 8000:8000 -p 8080:8080 -e SERVICES=dynamodb:8000 -e DATA_DIR='/tmp/localstack/data' localstack/localstack</strong></span><span id="624a" class="ls lt iq lh b gy ly lv l lw lx"># NOTE: There is also a docker-compose.yml file in the GitHub repo to create and start this container as well. <br/># Run with <strong class="lh ir">docker-compose up -d</strong></span><span id="58fe" class="ls lt iq lh b gy ly lv l lw lx"># To stop/start the container, run:<br/># Check if the container is running</span><span id="5a6f" class="ls lt iq lh b gy ly lv l lw lx"><strong class="lh ir">docker ps</strong> # should NOT see 'dynamodb_localstack' in the list<br/><strong class="lh ir">docker start dynamodb_localstack<br/>...<br/>docker stop dynamodb_localstack </strong># this will stop the container</span></pre><p id="a778" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">测试以确保<code class="fe le lf lg lh b">seed</code>和<code class="fe le lf lg lh b">start</code>脚本在容器运行后仍然工作。</p><pre class="lk ll lm ln gt lo lh lp lq aw lr bi"><span id="b603" class="ls lt iq lh b gy lu lv l lw lx"># From the the project folder, where the package.json file is, run:</span><span id="a51d" class="ls lt iq lh b gy ly lv l lw lx"><strong class="lh ir">npm run seed<br/>...<br/>...<br/>npm start</strong></span><span id="52c6" class="ls lt iq lh b gy ly lv l lw lx"># Check postman or browser to see if they still return data.</span></pre><p id="6c94" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated"><strong class="kh ir">结束更新。</strong></p></div><div class="ab cl jy jz hu ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="ij ik il im in"><p id="2eeb" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">我们将使用Amazon Web Services (AWS)构建一个无服务器RESTful API来获取联系信息！</p><p id="758e" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">值得注意的是，本文主要关注的是让一切都在本地工作，这样您就可以开发和测试API，而不需要依赖互联网和AWS。本文还将使用Node 8.10.x支持的纯ES6，没有传输文件。</p><p id="4102" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">本文的原始源代码可以在这里找到:<a class="ae ld" href="https://github.com/vanister/contacts_api/tree/medium-article-source" rel="noopener ugc nofollow" target="_blank">https://github . com/vanister/contacts _ API/tree/medium-article-source</a></p><h2 id="886f" class="ls lt iq bd lz ma mb dn mc md me dp mf kq mg mh mi ku mj mk ml ky mm mn mo mp bi translated"><strong class="ak">项目设置</strong></h2><p id="097b" class="pw-post-body-paragraph kf kg iq kh b ki mq kk kl km mr ko kp kq ms ks kt ku mt kw kx ky mu la lb lc ij bi translated">安装以下工具和框架:</p><ul class=""><li id="1ffa" class="mv mw iq kh b ki kj km kn kq mx ku my ky mz lc na nb nc nd bi translated"><a class="ae ld" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>，8.10.x</li><li id="1e04" class="mv mw iq kh b ki ne km nf kq ng ku nh ky ni lc na nb nc nd bi translated"><a class="ae ld" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank"> Visual Studio代码</a></li><li id="9e66" class="mv mw iq kh b ki ne km nf kq ng ku nh ky ni lc na nb nc nd bi translated"><a class="ae ld" href="https://www.java.com/en/download/" rel="noopener ugc nofollow" target="_blank"> Java </a></li><li id="f3b7" class="mv mw iq kh b ki ne km nf kq ng ku nh ky ni lc na nb nc nd bi translated"><a class="ae ld" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DynamoDBLocal.DownloadingAndRunning.html" rel="noopener ugc nofollow" target="_blank"> DynamoDB本地</a></li><li id="7df2" class="mv mw iq kh b ki ne km nf kq ng ku nh ky ni lc na nb nc nd bi translated"><a class="ae ld" href="https://www.getpostman.com/" rel="noopener ugc nofollow" target="_blank">邮递员</a></li></ul><p id="2c9f" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">接下来，创建项目文件夹，并使用<code class="fe le lf lg lh b">npm</code>初始化它。</p><pre class="lk ll lm ln gt lo lh lp lq aw lr bi"><span id="dbb2" class="ls lt iq lh b gy lu lv l lw lx"><strong class="lh ir">$ mkdir contacts_api<br/>$ cd contacts_api/<br/>$ npm init -y</strong></span></pre><h2 id="1f6f" class="ls lt iq bd lz ma mb dn mc md me dp mf kq mg mh mi ku mj mk ml ky mm mn mo mp bi translated"><strong class="ak">依赖关系</strong></h2><p id="dd89" class="pw-post-body-paragraph kf kg iq kh b ki mq kk kl km mr ko kp kq ms ks kt ku mt kw kx ky mu la lb lc ij bi translated">安装以下软件包以使用无服务器和AWS:</p><ul class=""><li id="d0a7" class="mv mw iq kh b ki kj km kn kq mx ku my ky mz lc na nb nc nd bi translated"><a class="ae ld" href="https://www.npmjs.com/package/aws-sdk" rel="noopener ugc nofollow" target="_blank">aws-SDK</a>—Amazon Web Services SDK用于对各种AWS服务的编程访问。</li><li id="b46b" class="mv mw iq kh b ki ne km nf kq ng ku nh ky ni lc na nb nc nd bi translated"><a class="ae ld" href="https://www.npmjs.com/package/dotenv" rel="noopener ugc nofollow" target="_blank"> dotenv </a> —用于存储和设置环境变量的模块。</li><li id="1686" class="mv mw iq kh b ki ne km nf kq ng ku nh ky ni lc na nb nc nd bi translated"><a class="ae ld" href="https://www.npmjs.com/package/jest" rel="noopener ugc nofollow" target="_blank"> jest </a> —一体化JavaScript单元测试框架。</li><li id="c16d" class="mv mw iq kh b ki ne km nf kq ng ku nh ky ni lc na nb nc nd bi translated"><a class="ae ld" href="https://www.npmjs.com/package/serverless" rel="noopener ugc nofollow" target="_blank">无服务器</a> —用于管理AWS上的部署的框架。</li><li id="b138" class="mv mw iq kh b ki ne km nf kq ng ku nh ky ni lc na nb nc nd bi translated"><a class="ae ld" href="https://www.npmjs.com/package/serverless-offline" rel="noopener ugc nofollow" target="_blank">无服务器离线</a> —模拟AWS API Gateway和Lambdas进行本地开发的插件。</li></ul><pre class="lk ll lm ln gt lo lh lp lq aw lr bi"><span id="e5bb" class="ls lt iq lh b gy lu lv l lw lx"><strong class="lh ir">$ npm install -g serverless<br/>$ npm install --save-dev serverless-offline aws-sdk jest dotenv</strong></span></pre><p id="ffd2" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">如果你想使用无服务器来本地管理dynamodb，你可以选择安装<a class="ae ld" href="https://www.npmjs.com/package/serverless-dynamodb-local" rel="noopener ugc nofollow" target="_blank">无服务器-dynamodb-local </a>插件。</p><h2 id="3976" class="ls lt iq bd lz ma mb dn mc md me dp mf kq mg mh mi ku mj mk ml ky mm mn mo mp bi translated"><strong class="ak">项目结构</strong></h2><p id="07a2" class="pw-post-body-paragraph kf kg iq kh b ki mq kk kl km mr ko kp kq ms ks kt ku mt kw kx ky mu la lb lc ij bi translated">在我们开始编写处理程序代码之前，我们将构建项目文件夹并配置我们的工具。</p><p id="6434" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">在根级别创建以下结构:</p><pre class="lk ll lm ln gt lo lh lp lq aw lr bi"><span id="dffc" class="ls lt iq lh b gy lu lv l lw lx">/contacts_api<br/>|--/src<br/>|----/handlers<br/>|------/contacts<br/>|--------contacts.serverless.yml<br/>|--.env<br/>|--.gitignore<br/>|--jest.config.js<br/>|--serverless.yml<br/>| …<br/>| …<br/>|--package.json</span></pre><p id="c788" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">用这些设置更新以下配置文件:</p><p id="ad33" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated"><code class="fe le lf lg lh b">.env</code>文件将存储我们的环境变量。如果您选择使用真正的AWS密钥，确保在<code class="fe le lf lg lh b">.gitignore</code>文件中列出它，这样您就不会意外地提交一些您的私有环境值。</p><pre class="lk ll lm ln gt lo lh lp lq aw lr bi"><span id="3701" class="ls lt iq lh b gy lu lv l lw lx"><strong class="lh ir"># file: .gitignore</strong></span><span id="03f6" class="ls lt iq lh b gy ly lv l lw lx"># package directories<br/>node_modules/</span><span id="16d3" class="ls lt iq lh b gy ly lv l lw lx"># Serverless directories<br/>.serverless/<br/>.dynamodb</span><span id="b242" class="ls lt iq lh b gy ly lv l lw lx"># files<br/>.DS_Store<br/>.env</span><span id="c501" class="ls lt iq lh b gy ly lv l lw lx"># tests<br/>coverage/</span><span id="89ab" class="ls lt iq lh b gy ly lv l lw lx"><strong class="lh ir"># file: .env</strong></span><span id="bc7d" class="ls lt iq lh b gy ly lv l lw lx">AWS_ENDPOINT=’http://localhost:8000'<br/>AWS_REGION=’localhost’<br/>AWS_ACCESS_KEY_ID=’fake-access-key’<br/>AWS_SECRET_ACCESS_KEY=’fake-secret-key’</span></pre><p id="7e17" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated"><code class="fe le lf lg lh b">jest.config.js</code>文件用于在cli之外配置Jest。</p><pre class="lk ll lm ln gt lo lh lp lq aw lr bi"><span id="4b62" class="ls lt iq lh b gy lu lv l lw lx">// file: jest.config.js</span><span id="362d" class="ls lt iq lh b gy ly lv l lw lx">module.exports = {<br/>  // per issue: <a class="ae ld" href="https://github.com/jsdom/jsdom/issues/2304" rel="noopener ugc nofollow" target="_blank">https://github.com/jsdom/jsdom/issues/2304</a><br/>  testURL: ‘http://localhost/'<br/>};</span></pre><p id="9028" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated"><code class="fe le lf lg lh b">serverless.yml</code>和<code class="fe le lf lg lh b">contacts.serverless.yml</code>文件是无服务器框架在本地部署和运行我们的lambdas的配置。</p><figure class="lk ll lm ln gt jr"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">无服务器. yml</figcaption></figure><figure class="lk ll lm ln gt jr"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">contacts.serverless.yml</figcaption></figure><h2 id="659e" class="ls lt iq bd lz ma mb dn mc md me dp mf kq mg mh mi ku mj mk ml ky mm mn mo mp bi translated"><strong class="ak">存储库和实用程序</strong></h2><p id="8448" class="pw-post-body-paragraph kf kg iq kh b ki mq kk kl km mr ko kp kq ms ks kt ku mt kw kx ky mu la lb lc ij bi translated">在实现处理程序之前，我们需要编写一个存储库和一些实用程序来帮助抽象处理程序的逻辑，使它们可测试。</p><p id="3249" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">我们将使用存储库模式在DynamoDB和我们的联系实体之间创建一个抽象层。我们从存储库中获取的数据需要进行格式化，我们将创建一些辅助工具来帮助进行格式化。</p><p id="12f2" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">为我们的联系人存储库类创建一个名为<code class="fe le lf lg lh b">src/repositories/contact.repository.js</code>的文件。</p><p id="baf6" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">我们将设置我们的存储库来接受DynamoDB的DocumentClient作为一个依赖项，它将充当UnitOfWork。</p><figure class="lk ll lm ln gt jr"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">联系人.储存库. js</figcaption></figure><p id="a431" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">我们使用DocumentClient及其承诺，使DynamoDB的工作更简单，并利用es6和Node对async/await的支持。</p><p id="9fdd" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">存储库简单地返回一个承诺和从DocumentClient返回的数据。</p><p id="b87c" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">接下来，让我们创建请求和响应实用程序，以便我们可以使用它们来提取、解析和格式化lambda函数要使用的数据。</p><p id="f2b6" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">为我们的请求实用程序创建一个名为<code class="fe le lf lg lh b">src/utils/request.util.js</code>的文件。</p><p id="8bd4" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">现在，请求实用程序将包含一个函数，该函数将接受一些解析器函数并返回一个新函数，该函数使用它来解析我们传递给它的一些文本。</p><figure class="lk ll lm ln gt jr"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">请求. util.js</figcaption></figure><p id="dcca" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">为我们的响应工具创建一个名为<code class="fe le lf lg lh b">src/utils/response.util.js</code>的文件。</p><figure class="lk ll lm ln gt jr"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">response.util.js</figcaption></figure><p id="0519" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated"><code class="fe le lf lg lh b">withStatusCode</code>响应实用程序函数类似于请求实用程序，但是它不是解析文本，而是将数据格式化成文本。它还包含额外的检查，以确保我们的状态代码在允许的状态代码范围内。</p><p id="c8d9" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">最后，我们将创建一个工厂模块来创建<code class="fe le lf lg lh b">DynamoDB.DocumentClient</code>的实例，这样我们就可以保持我们的Lambda函数干燥。</p><p id="bf43" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">为我们的DynamoDB工厂创建一个名为<code class="fe le lf lg lh b">src/dynamodb.factory.js</code>的文件。</p><figure class="lk ll lm ln gt jr"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">dynamodb.factory.js</figcaption></figure><h2 id="7481" class="ls lt iq bd lz ma mb dn mc md me dp mf kq mg mh mi ku mj mk ml ky mm mn mo mp bi translated"><strong class="ak">λ函数</strong></h2><p id="cdd6" class="pw-post-body-paragraph kf kg iq kh b ki mq kk kl km mr ko kp kq ms ks kt ku mt kw kx ky mu la lb lc ij bi translated">思考这些功能的方法是将它们视为相互独立的。我们需要<code class="fe le lf lg lh b">require</code>一个函数需要的所有依赖关系，这样它才能独立执行。</p><p id="404e" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">由于我们将逻辑和AWS依赖项抽象成了一个存储库和实用程序，我们的Lambda函数将简单地调用存储库和实用程序并返回数据。</p><p id="9052" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">从<code class="fe le lf lg lh b">src/handlers/contacts</code>文件夹中，创建以下Lambda函数文件:</p><pre class="lk ll lm ln gt lo lh lp lq aw lr bi"><span id="a01a" class="ls lt iq lh b gy lu lv l lw lx">add.js<br/>delete.js<br/>get.js<br/>list.js<br/>update.js</span></pre><p id="cb5c" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">打开每个文件，并向其中添加以下代码:</p><figure class="lk ll lm ln gt jr"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">add.js</figcaption></figure><figure class="lk ll lm ln gt jr"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">删除. js</figcaption></figure><figure class="lk ll lm ln gt jr"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">get.js</figcaption></figure><figure class="lk ll lm ln gt jr"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">list.js</figcaption></figure><figure class="lk ll lm ln gt jr"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">update.js</figcaption></figure><p id="f002" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">注意，我们首先需要<code class="fe le lf lg lh b">dotenv/config</code>模块，因此我们可以设置正确的环境变量，以便在DynamoDB工厂模块中使用。</p><h2 id="734c" class="ls lt iq bd lz ma mb dn mc md me dp mf kq mg mh mi ku mj mk ml ky mm mn mo mp bi translated"><strong class="ak"> DynamoDB </strong></h2><p id="4a01" class="pw-post-body-paragraph kf kg iq kh b ki mq kk kl km mr ko kp kq ms ks kt ku mt kw kx ky mu la lb lc ij bi translated">为了在本地设置DynamoDB进行开发，我们需要在项目文件夹旁边创建一个新文件夹来保存DynamoDB jar和sharedDB文件。</p><p id="cb47" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">在<code class="fe le lf lg lh b">contacts_api</code>项目文件夹的父文件夹中打开一个终端，并运行以下命令:</p><pre class="lk ll lm ln gt lo lh lp lq aw lr bi"><span id="a434" class="ls lt iq lh b gy lu lv l lw lx"><strong class="lh ir">$ mkdir dynamodb<br/>$ cd dynamodb<br/>$ nano start-dynamodb.sh</strong></span></pre><p id="a8b9" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">在nano编辑器中，添加以下行:</p><pre class="lk ll lm ln gt lo lh lp lq aw lr bi"><span id="464b" class="ls lt iq lh b gy lu lv l lw lx">#!/bin/sh</span><span id="95d1" class="ls lt iq lh b gy ly lv l lw lx">jar=DynamoDBLocal.jar<br/>lib=DynamoDBLocal_lib<br/>dynamodir=./dynamodb-local</span><span id="9f1a" class="ls lt iq lh b gy ly lv l lw lx">java -Djava.library.path=$dynamodir/$lib -jar $dynamodir/$jar -sharedDb</span></pre><p id="3be0" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">点击<code class="fe le lf lg lh b">control + x</code>，然后点击<code class="fe le lf lg lh b">Y</code>，选择“是”，保存并退出。</p><p id="b4d3" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">通过运行以下命令在本地启动DynamoDB:</p><pre class="lk ll lm ln gt lo lh lp lq aw lr bi"><span id="2b63" class="ls lt iq lh b gy lu lv l lw lx"># from the dynamodb folder</span><span id="2c53" class="ls lt iq lh b gy ly lv l lw lx"><strong class="lh ir">$ sh start-dynamodb.sh</strong></span></pre><h2 id="3e01" class="ls lt iq bd lz ma mb dn mc md me dp mf kq mg mh mi ku mj mk ml ky mm mn mo mp bi translated"><strong class="ak">播种联系人表</strong></h2><p id="171d" class="pw-post-body-paragraph kf kg iq kh b ki mq kk kl km mr ko kp kq ms ks kt ku mt kw kx ky mu la lb lc ij bi translated">回到<code class="fe le lf lg lh b">contacts_api</code>项目文件夹，添加一个名为<code class="fe le lf lg lh b">seed</code>的新文件夹，然后将以下文件添加到<code class="fe le lf lg lh b">seed</code>文件夹:</p><pre class="lk ll lm ln gt lo lh lp lq aw lr bi"><span id="2443" class="ls lt iq lh b gy lu lv l lw lx">contact.seeder.js<br/>contacts-test-json<br/>runner.js</span></pre><p id="fa09" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">打开<code class="fe le lf lg lh b">contact.seeder.js</code>文件，添加以下代码:</p><figure class="lk ll lm ln gt jr"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">contact.seeder.js</figcaption></figure><p id="c307" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">这个<code class="fe le lf lg lh b">ContactSeeder</code>类获取一个<code class="fe le lf lg lh b">DynamoDB</code>和<code class="fe le lf lg lh b">DocumentClient</code>并使用它们创建一个新的<code class="fe le lf lg lh b">contacts</code>表并将数据植入其中。</p><p id="1bd2" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">您可以在AWS文档门户上找到更多关于<a class="ae ld" href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/DynamoDB.html" rel="noopener ugc nofollow" target="_blank"> DynamoDB </a>和<a class="ae ld" href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/DynamoDB/DocumentClient.html" rel="noopener ugc nofollow" target="_blank">document client</a>API的信息。</p><p id="77ae" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">打开<code class="fe le lf lg lh b">contacts-test-data.json</code>文件，添加一些条目作为<code class="fe le lf lg lh b">contacts</code>表的种子。</p><figure class="lk ll lm ln gt jr"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">联系人-测试-数据. json</figcaption></figure><p id="4c5f" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">最后，打开<code class="fe le lf lg lh b">runner.js</code>文件并添加代码来执行播种器。</p><figure class="lk ll lm ln gt jr"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">亚军. js</figcaption></figure><p id="fa92" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">确保DynamoDB正在本地运行(参见上面的DynamoDB部分),并在项目文件夹的根目录下打开一个新的终端，运行<code class="fe le lf lg lh b">runner.js</code>文件以创建<code class="fe le lf lg lh b">contacts</code>表并为其植入数据。</p><pre class="lk ll lm ln gt lo lh lp lq aw lr bi"><span id="d196" class="ls lt iq lh b gy lu lv l lw lx"><strong class="lh ir">$ node ./seed/runner.js</strong></span><span id="8c53" class="ls lt iq lh b gy ly lv l lw lx"># output from runner:</span><span id="1c14" class="ls lt iq lh b gy ly lv l lw lx">&gt;&gt; Checking if ‘contacts’ table exists<br/>&gt;&gt; Table ‘contacts’ exists, deleting<br/>&gt;&gt; Creating ‘contacts’ table<br/>&gt;&gt; Seeding data<br/>&gt;&gt; Done!</span></pre><h2 id="25f8" class="ls lt iq bd lz ma mb dn mc md me dp mf kq mg mh mi ku mj mk ml ky mm mn mo mp bi translated"><strong class="ak">把所有的放在一起</strong></h2><p id="7f3f" class="pw-post-body-paragraph kf kg iq kh b ki mq kk kl km mr ko kp kq ms ks kt ku mt kw kx ky mu la lb lc ij bi translated">现在我们已经设置好了一切，我们可以把它们放在一起，通过无服务器框架的<code class="fe le lf lg lh b">serverless-offline</code>插件在本地运行API。</p><p id="eaff" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">打开<code class="fe le lf lg lh b">package.json</code>文件，添加一些<code class="fe le lf lg lh b">npm</code>脚本，这样我们就可以使用<code class="fe le lf lg lh b">npm run &lt;command&gt;</code>运行我们的API，而不是输入完整的命令。</p><pre class="lk ll lm ln gt lo lh lp lq aw lr bi"><span id="4608" class="ls lt iq lh b gy lu lv l lw lx">{<br/>  “name”: “contacts-api”<br/>  “scripts” : {<br/>    “sls”: “serverless”,<br/>    “seed”: “node ./seed/runner.js”,<br/>    “start”: “sls offline start”,<br/>  }<br/>}</span></pre><p id="d7ad" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated"><code class="fe le lf lg lh b">sls</code>脚本是一种调用<code class="fe le lf lg lh b">serverless</code> cli的快捷方式，无需在运行命令前键入<code class="fe le lf lg lh b">./node_modules/.bin/sls</code>的完整路径，这仅适用于您没有全局安装无服务器的情况。</p><p id="3d8d" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">为了全面测试一切，我们需要让DynamoDB在一个终端本地运行，API在另一个终端运行。</p><pre class="lk ll lm ln gt lo lh lp lq aw lr bi"><span id="10d3" class="ls lt iq lh b gy lu lv l lw lx"># from first terminal in the ./dynamodb folder where the jar file is<br/># start DynamoDB locally</span><span id="2ca2" class="ls lt iq lh b gy ly lv l lw lx"><strong class="lh ir">$ sh start-dynamodb.sh</strong></span><span id="b7aa" class="ls lt iq lh b gy ly lv l lw lx"># from second terminal in the project root (where package.json is)<br/># start the api in offline mode</span><span id="343f" class="ls lt iq lh b gy ly lv l lw lx"><strong class="lh ir">$ npm run start</strong></span><span id="66e7" class="ls lt iq lh b gy ly lv l lw lx"># output from npm run start</span><span id="0a8a" class="ls lt iq lh b gy ly lv l lw lx">&gt; contacts-api@1.0.0 start ./contact_list/contacts_api<br/>&gt; sls offline start</span><span id="d615" class="ls lt iq lh b gy ly lv l lw lx">Serverless: Starting Offline: dev/us-west-2.</span><span id="c755" class="ls lt iq lh b gy ly lv l lw lx">Serverless: Routes for list:<br/>Serverless: GET /contacts</span><span id="4272" class="ls lt iq lh b gy ly lv l lw lx">Serverless: Routes for get:<br/>Serverless: GET /contact/{id}</span><span id="43ae" class="ls lt iq lh b gy ly lv l lw lx">Serverless: Routes for add:<br/>Serverless: POST /contact</span><span id="54f4" class="ls lt iq lh b gy ly lv l lw lx">Serverless: Routes for update:<br/>Serverless: PUT /contact/{id}</span><span id="ff0c" class="ls lt iq lh b gy ly lv l lw lx">Serverless: Routes for delete:<br/>Serverless: DELETE /contact/{id}</span><span id="e702" class="ls lt iq lh b gy ly lv l lw lx"><strong class="lh ir">Serverless: Offline listening on </strong><a class="ae ld" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank"><strong class="lh ir">http://localhost:3000</strong></a></span></pre><p id="e97b" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">启动Postman并点击列出所有联系人的端点(http://localhost:3000/contacts/)，您应该得到我们在数据库中播种的两个项目。</p><figure class="lk ll lm ln gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi np"><img src="../Images/65638fcd317cf9d99a0fa8f5a2480013.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DtYXm1_OEN-ayAfnsxmt2Q.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">邮递员/联系人端点</figcaption></figure><h2 id="948f" class="ls lt iq bd lz ma mb dn mc md me dp mf kq mg mh mi ku mj mk ml ky mm mn mo mp bi translated"><strong class="ak">结论</strong></h2><p id="af25" class="pw-post-body-paragraph kf kg iq kh b ki mq kk kl km mr ko kp kq ms ks kt ku mt kw kx ky mu la lb lc ij bi translated">我选择将Jest测试排除在文章之外，但是当我编写这个示例时，我使用了测试驱动的开发方法来规范功能代码，这确保了我所编写的内容是解耦的和可测试的。这有助于快速验证我的存储库、实用程序和Lambda函数是否如我预期的那样运行。这种方法使得集成一切和运行API变得更加简单，并减少了对调试器的依赖。</p><p id="a8a5" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">后来，集成一切和运行API变得简单，不需要大量的调试。</p><p id="b7af" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">关于调试的话题，我在GitHub项目中包含了我的<code class="fe le lf lg lh b">launch.json</code>文件，这样你就可以用它来调试代码或单元测试，看看它们是如何一起工作的。</p><p id="be6b" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">要将它部署到AWS，您需要遵循关于<a class="ae ld" href="https://serverless.com/framework/docs/providers/aws/guide/deploying/" rel="noopener ugc nofollow" target="_blank">无服务器</a>的文档，并使用api/secret密钥的必要设置、DynamoDB定义和从AWS中运行所需的权限来更新项目中的<code class="fe le lf lg lh b">.yml</code>文件。</p><h2 id="464d" class="ls lt iq bd lz ma mb dn mc md me dp mf kq mg mh mi ku mj mk ml ky mm mn mo mp bi translated">后续步骤</h2><p id="8b26" class="pw-post-body-paragraph kf kg iq kh b ki mq kk kl km mr ko kp kq ms ks kt ku mt kw kx ky mu la lb lc ij bi translated">部署到Docker容器进行本地测试或开发，而无需运行多个项目:</p><div class="nq nr gp gr ns nt"><a rel="noopener  ugc nofollow" target="_blank" href="/containerizing-serverless-apis-d69fa3e6b9c2"><div class="nu ab fo"><div class="nv ab nw cl cj nx"><h2 class="bd ir gy z fp ny fr fs nz fu fw ip bi translated">容器化无服务器API</h2><div class="oa l"><h3 class="bd b gy z fp ny fr fs nz fu fw dk translated">使用Docker、LocalStack和无服务器框架进行本地开发</h3></div><div class="ob l"><p class="bd b dl z fp ny fr fs nz fu fw dk translated">itnext.io</p></div></div><div class="oc l"><div class="od l oe of og oc oh jw nt"/></div></div></a></div><p id="087a" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">将API部署到AWS:</p><div class="nq nr gp gr ns nt"><a rel="noopener  ugc nofollow" target="_blank" href="/deploy-a-serverless-api-to-amazon-web-services-aws-106c996cded9"><div class="nu ab fo"><div class="nv ab nw cl cj nx"><h2 class="bd ir gy z fp ny fr fs nz fu fw ip bi translated">将无服务器API部署到Amazon Web Services (AWS)</h2><div class="oa l"><h3 class="bd b gy z fp ny fr fs nz fu fw dk translated">在上一篇文章中，我写了关于构建一个本地运行的无服务器API。在这里，我将向您展示如何部署它…</h3></div><div class="ob l"><p class="bd b dl z fp ny fr fs nz fu fw dk translated">itnext.io</p></div></div><div class="oc l"><div class="oi l oe of og oc oh jw nt"/></div></div></a></div></div></div>    
</body>
</html>