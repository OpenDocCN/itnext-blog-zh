<html>
<head>
<title>Kubernetes: part 3 — AWS EKS overview and manual EKS cluster set up</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes:第3部分— AWS EKS概述和手动EKS集群设置</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-part-3-aws-eks-overview-and-manual-eks-cluster-set-up-f35b6eca2763?source=collection_archive---------6-----------------------#2019-08-15">https://itnext.io/kubernetes-part-3-aws-eks-overview-and-manual-eks-cluster-set-up-f35b6eca2763?source=collection_archive---------6-----------------------#2019-08-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/661b4110ee4351469b87b71655df5c0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:260/format:webp/0*uibW-32l0FPmz8sd.png"/></div></figure><p id="7cc1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们继续我们的库伯内特之旅。</p><p id="ec42" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以前的零件:</p><ul class=""><li id="0a81" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/kubernetes-part-1-architecture-and-main-components-overview/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:第1部分—架构和主要组件概述</a></li><li id="6c2b" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/en/kubernetes-part-2-a-cluster-set-up-on-aws-with-aws-cloud-provider-and-aws-loadbalancer/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:第2部分——在AWS上建立一个集群，使用AWS云提供商和AWS负载均衡器</a></li></ul><p id="bdba" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这一部分中，我们将开始与AWS Elastic Kuberneters Service(EKS)合作，这是它的简短概述，然后将创建Kubernetes控制平面、带有工作节点的CloudFormation堆栈，将启动一个简单的web服务，并将添加一个负载平衡器。</p><ul class=""><li id="ac7f" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated"><a class="ae lb" href="#f368" rel="noopener ugc nofollow">弹性Kubernetes服务—概述</a></li><li id="c6cd" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="#1907" rel="noopener ugc nofollow">准备AWS环境</a></li><li id="80b1" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="#2377" rel="noopener ugc nofollow">我的角色</a></li><li id="5043" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="#c7be" rel="noopener ugc nofollow"> VPC </a></li><li id="0e7c" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="#6d78" rel="noopener ugc nofollow">安全组</a></li><li id="6505" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="#17c5" rel="noopener ugc nofollow">互联网网关</a></li><li id="7213" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="#b1e8" rel="noopener ugc nofollow">子网</a></li><li id="4637" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="#e13f" rel="noopener ugc nofollow"> NAT网关</a></li><li id="8d53" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="#d93e" rel="noopener ugc nofollow">路由表</a></li><li id="d661" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="#ca27" rel="noopener ugc nofollow">弹性Kubernetes服务</a></li><li id="9622" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="#3803" rel="noopener ugc nofollow">创建一个控制平面</a></li><li id="238d" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="#fcfe" rel="noopener ugc nofollow">创建工人节点</a></li><li id="63fd" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="#03c0" rel="noopener ugc nofollow"> kubectl安装</a></li><li id="94cd" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="#7273" rel="noopener ugc nofollow"> AWS认证器</a></li><li id="c831" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="#2ffe" rel="noopener ugc nofollow"> Web-app &amp; &amp;负载平衡器</a></li></ul><h2 id="f368" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">弹性Kubernetes服务—概述</h2><p id="c5a8" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">AWS EKS是一个Kubernetes集群，其核心<a class="ae lb" href="https://rtfm.co.ua/kubernetes-znakomstvo-chast-1-arxitektura-i-osnovnye-komponenty-obzor/#Kubernetes_core_services_aka_Kubernetes_Control_Plane" rel="noopener ugc nofollow" target="_blank">控制平面</a>将由AWS自己管理，从而将用户从不必要的麻烦中解放出来。</p><ul class=""><li id="ca30" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/kubernetes-znakomstvo-chast-1-arxitektura-i-osnovnye-komponenty-obzor/#Kubernetes_core_services_aka_Kubernetes_Control_Plane" rel="noopener ugc nofollow" target="_blank">控制平面</a>:由AWS管理，由不同可用性区域中的三个EC2组成</li><li id="0ce5" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://rtfm.co.ua/kubernetes-znakomstvo-chast-1-arxitektura-i-osnovnye-komponenty-obzor/#Worker_Node" rel="noopener ugc nofollow" target="_blank"> Worker Nodes </a>:自动缩放组中的一个普通ес2，在客户的VPC中，由用户管理</li></ul><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mf"><img src="../Images/e3a862bb10f48d70c9d49e98e95ea9e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5hmT1IZtGA8cgCUT.png"/></div></div></figure><p id="50a5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">网络概述:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mo"><img src="../Images/64be2b2bb61357d45152e93da1b9c871.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*362kkf4e_Qi3FMUT.png"/></div></div></figure><p id="1ea3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于网络——使用了<a class="ae lb" href="https://github.com/aws/amazon-vpc-cni-k8s" rel="noopener ugc nofollow" target="_blank"> amazon-vpc-cni-k8s </a>插件，该插件允许在集群内使用AWS ENI(弹性网络接口)和vpc的网络空间。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mp"><img src="../Images/1cea452ac13760602f0b4ff91228205c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WlgKKq2QgaUehmIY.png"/></div></div></figure><p id="09f1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于授权，使用了<a class="ae lb" href="https://docs.aws.amazon.com/eks/latest/userguide/install-aws-iam-authenticator.html" rel="noopener ugc nofollow" target="_blank"> aws-iam-authenticator </a>，它允许根据AWS iam角色和策略对Kubernetes对象进行身份验证(参见<a class="ae lb" href="https://docs.aws.amazon.com/en_us/eks/latest/userguide/add-user-role.html" rel="noopener ugc nofollow" target="_blank">管理集群的用户或IAM角色</a></p><p id="e000" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，AWS将管理Kubernetes的小升级，即1.11.5到1.11.8，但大升级仍然必须由用户完成。</p><h2 id="1907" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">准备AWS环境</h2><p id="6c5c" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">要创建EKS集群firt，我们需要创建一个带有子网的专用VPC，配置路由，并为集群授权添加一个IAM角色。</p><h2 id="2377" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">IAM角色</h2><p id="e3e5" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">转到<em class="mq"> IAM </em>，用<em class="mq"> EKS </em>类型创建一个新角色:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mr"><img src="../Images/f915860535dd451e89c108459bf41a5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4NRf8Hx3-RojJTKY.png"/></div></div></figure><p id="62a1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="mq">权限</em>将由AWS自己填写:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mr"><img src="../Images/34240d1b207b89ab738b98893ca5db03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lXWF6LfBbzxricSK.png"/></div></div></figure><p id="24bd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">保存它:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mr"><img src="../Images/509b926bc2fcaa466aeae144c831cb71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*k523aZ1_t__f0TTd.png"/></div></div></figure><h2 id="c7be" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">VPC</h2><p id="8f84" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">接下来，必须创建具有4个子网的VPC，其中两个公共子网用于LoadBalacner，两个私有子网用于工作节点。</p><p id="c48a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建VPC:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi ms"><img src="../Images/e45aeb3dc7ee878196070b53e97eb465.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SZwa70eBZnrGAws9.png"/></div></div></figure><p id="6d78" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">安全组</strong></p><p id="8cc7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">转到<em class="mq">安全组</em>，为集群创建一个新组:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mt"><img src="../Images/615a5acd953d714e414f9461667dc233.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zRrST7n-xgBwwYYB.png"/></div></div></figure><p id="7cb1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加所需的规则，这里只是一个<em class="mq"> Allow All to All </em>的例子:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mu"><img src="../Images/ee991b77213ceaf1a8744087524c39a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VOEjIGt5xfBicmf4.png"/></div></div></figure><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mt"><img src="../Images/18cb32421e81d9132f5a4363ec711fe5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JPICpOVii7ttWYjr.png"/></div></div></figure><p id="17c5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">互联网网关</strong></p><p id="4ae3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建将用于路由来自公共子网的流量的IGW:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mv"><img src="../Images/17dd559c0b45b96810acf5083a86c285.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EB1AHYdMhms3A-o4.png"/></div></div></figure><p id="198d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将它连接到VPC:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mw"><img src="../Images/f775e4be0dea15502a65220ef41f25e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fxjj1bsz1IZxlLTx.png"/></div></div></figure><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mx"><img src="../Images/7913603cd7eeaf26b498a912b8b63e59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*y2jhCp67kg135X7L.png"/></div></div></figure><p id="b1e8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">子网</strong></p><p id="bb51" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Pods将使用分配的子网中的IP(参见<a class="ae lb" href="https://github.com/aws/amazon-vpc-cni-k8s" rel="noopener ugc nofollow" target="_blank"> amazon-vpc-cni-k8s </a>)，因此这些子网必须有足够的地址空间。</p><p id="0dc8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用<em class="mq"> 10.0.0.0/18块</em> (16384个地址)创建第一个公共子网:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi my"><img src="../Images/372de7ae5171eb03162d376da70aa84a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*g6heSxTpIqv0_elS.png"/></div></div></figure><p id="7ea9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用<em class="mq"> 10.0.64.0/18 </em>块的第二个公共子网:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mz"><img src="../Images/2599e44ebda2be667bc2c780e1507e14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NMAjX-OB-U_IEnrX.png"/></div></div></figure><p id="3fc3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在公共子网中—启用将公共IP自动分配给ec2:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mo"><img src="../Images/573778098acbb1c762f58d83b56fe104.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*N6t17SMU__YujyCy.png"/></div></div></figure><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mo"><img src="../Images/d55ea203ce240aa223d652e627dfcfb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fm8DKHH8WFysR-bj.png"/></div></div></figure><p id="83f0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">同样，添加两个专用子网:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mz"><img src="../Images/49b9e24100276dc95b4bf45080667821.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*FVZjTL9xfuFovrkT.png"/></div></div></figure><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mz"><img src="../Images/f3ca3c656237ed2b16cad02b16338ec8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*apLaPHHlLHq4zrTk.png"/></div></div></figure><p id="e13f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> NAT网关</strong></p><p id="3ec3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在公共子网中创建一个NAT网关，它将用于路由来自私有子网的流量:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi na"><img src="../Images/fa273a47293a4ca3eee13ce21894c869.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*G9xt8V27gHnGGlk8.png"/></div></div></figure><p id="c45d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并在此配置路由:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nb"><img src="../Images/126118d6a70a2d7c6648b44fd73b04fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fjfYQuxKZNTWSluP.png"/></div></div></figure><p id="d93e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">路由表</strong></p><p id="5a07" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，需要为公共子网和私有子网创建两个路由表。</p><p id="6776" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">公共路由表</p><p id="78a5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建公共子网路由表:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nc"><img src="../Images/4418a52913d0500383e338d7dcc9da86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PoklUbZUjQw5Z9pF.png"/></div></div></figure><p id="9ca9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">编辑路线—通过上面创建的IGW将路线设置为<em class="mq"> 0.0.0.0/0 </em>:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nd"><img src="../Images/84592759ea28f9df949e1f6d887cf2f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7bd1o5aeYhLWS1vF.png"/></div></div></figure><p id="fe45" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">切换到<em class="mq">子网关联</em> —将两个公共子网连接到此RTB:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi ne"><img src="../Images/82d6d560e9dc2b0db9d21db811d17585.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LnIOogVDl9MRfMDj.png"/></div></div></figure><p id="1ef4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">私有路由表</p><p id="9412" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">同样，为专用子网创建RTB:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nf"><img src="../Images/a1df40b0b662b9d36f85cc88aad742d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Y6BGmjUgFJmLtk35.png"/></div></div></figure><p id="2518" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">向<em class="mq"> 0.0.0.0/0 </em>添加另一条路线，但通过NAT GW而不是IGW:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi ng"><img src="../Images/d71c135913ff7320df49e5e8b1e588a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MpHjuFRbI8qj6jUK.png"/></div></div></figure><p id="685f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">回到您的子网— <em class="mq">编辑路由表关联</em>:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nh"><img src="../Images/73b5f4e6e873da877f733f307b0b6f2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*e1x4cli_r9rvmnJA.png"/></div></div></figure><p id="7775" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将我们的专用RTB连接到专用子网，以便它们使用NAT GW:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mo"><img src="../Images/eedc2a2b1f06b90704591d630b1013aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*RbuIUaD1_CENZFUe.png"/></div></div></figure><p id="0202" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将我们的公共RTB连接到专用子网，以便它们使用互联网网关:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mo"><img src="../Images/83373432a602696531bf978da156345f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9cvD6zVpS459wJIw.png"/></div></div></figure><h2 id="1399" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">支票</h2><p id="d4bd" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">要测试这个VPC是否工作，请运行两个EC2实例。</p><p id="4bd4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">公共子网中的第一个:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mo"><img src="../Images/109b83f1f5e0487f714d234448d60b4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kGOfDwE-Si42zodh.png"/></div></div></figure><p id="87ad" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">设置安全组:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi ni"><img src="../Images/02e2685e3436c2129afa51adb89f52e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4dWtHF93PlvnMnZd.png"/></div></div></figure><p id="606b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查网络:</p><pre class="mg mh mi mj gt nj nk nl nm aw nn bi"><span id="e245" class="lh li iq nk b gy no np l nq nr">[setevoy@setevoy-arch-work ~] $ ssh -i setevoy-testing-eu-west-2.pem ubuntu@35.178.171.252 ‘ping -c 1 8.8.8.8’<br/>PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.<br/>64 bytes from 8.8.8.8: icmp_seq=1 ttl=51 time=1.33 ms<br/> — — 8.8.8.8 ping statistics — -<br/>1 packets transmitted, 1 received, 0% packet loss, time 0ms<br/>rtt min/avg/max/mdev = 1.331/1.331/1.331/0.000 ms</span></pre><p id="6c8f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在专用子网中添加另一个EC2:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mo"><img src="../Images/e8e191465ea7b8a009cc794ba4832cd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*y7o1ySh0q8lA4-2z.png"/></div></div></figure><p id="a657" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">不要忘记SG。</p><p id="bbb8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并尝试从第一个实例ping它(因为我们不能从互联网ping私有网络中的实例):</p><pre class="mg mh mi mj gt nj nk nl nm aw nn bi"><span id="9115" class="lh li iq nk b gy no np l nq nr">[setevoy@setevoy-arch-work ~] $ ssh -i setevoy-testing-eu-west-2.pem ubuntu@35.178.171.252 ‘ping -c 1 10.0.184.21’<br/>PING 10.0.184.21 (10.0.184.21) 56(84) bytes of data.<br/>64 bytes from 10.0.184.21: icmp_seq=1 ttl=64 time=0.357 ms<br/> — — 10.0.184.21 ping statistics — -<br/>1 packets transmitted, 1 received, 0% packet loss, time 0ms<br/>rtt min/avg/max/mdev = 0.357/0.357/0.357/0.000 ms</span></pre><p id="1f7e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果没有对ping的回复—首先检查您的安全组和路由表。</p><p id="8f36" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们到此为止——是时候从EKS本身开始了。</p><h2 id="ca27" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">弹性Kubernetes服务</h2><h2 id="3803" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">创建一个控制平面</h2><p id="569a" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">转到EKS并创建主节点—单击<em class="mq">创建集群</em>:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi ns"><img src="../Images/c55bd062ea4ec7384abe00742c182367.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JYbRgMha45Kv2Uad.png"/></div></div></figure><p id="3b23" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">设置名称，选择在最开始创建的IAM角色:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nt"><img src="../Images/159f31f4ba6f9e15f76ec533a83da12f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2cXzEWbrrfG-zAFo.png"/></div></div></figure><p id="ee82" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在子网中，选择仅专用子网并设置上面创建的安全性组:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nt"><img src="../Images/5b23a8a175b50e43ae24bed85af4366d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*oeFwmeBYyGnbRMOo.png"/></div></div></figure><p id="8687" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果需要，启用日志:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nu"><img src="../Images/ddd02ed91790a0b51140a1587d5972df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*61WLjhjNjWsmmejX.png"/></div></div></figure><p id="d2bf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并创建集群:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nv"><img src="../Images/e5a4436e154ce47f9d893db35e58b55a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hIi85VMcRiLuc5zK.png"/></div></div></figure><h2 id="fcfe" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">创建工作节点</h2><p id="0468" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">当控制平面处于调配状态时，让我们为工作节点创建一个云形成堆栈。</p><p id="c67e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">可以从AWS中取一个已有的模板—<a class="ae lb" href="https://amazon-eks.s3-us-west-2.amazonaws.com/cloudformation/2019-02-11/amazon-eks-nodegroup.yaml" rel="noopener ugc nofollow" target="_blank">https://Amazon-eks . S3-us-west-2 . Amazon AWS . com/cloud formation/2019-02-11/Amazon-eks-node group . YAML</a>。</p><p id="0a56" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">转到<em class="mq">云形成&gt;创建堆栈</em>:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nw"><img src="../Images/5a8fdf9a9e26ab51ccdee1e3c1f062cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WO6GnYdXijbVg8bF.png"/></div></div></figure><p id="75b9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">由于我们的工作节点将放置在专用子网中，因此在设计器中打开此模板:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nx"><img src="../Images/8a02934a2ed9961e27904ae2ab3f0fbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*y8yMBU4nuQanf2OH.png"/></div></div></figure><p id="71e1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">找到<code class="fe ny nz oa nk b">AssociatePublicIpAddress</code>参数，将其值从<em class="mq">真</em>更改为<em class="mq">假</em>:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi ob"><img src="../Images/f2c6533c3c28e6abe08b2907b090d26b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DTlS5hV8Aq1YZf6W.png"/></div></div></figure><p id="d96c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">点击<em class="mq">创建堆栈</em>:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi oc"><img src="../Images/380c8bb3efceba22eeefe8390b649849.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jhNpuaxWD1_8mHJN.png"/></div></div></figure><p id="49f7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">设置堆栈的名称(可以是任意名称)和群集名称—与我们创建主节点时所做的相同，例如<em class="mq"> eks-cluster-manual </em>在本例中，选择安全组，填充自动缩放设置:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi od"><img src="../Images/8ff3c58af904d0545ca75883976aee44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*99Q0WnCOh7YgevLY.png"/></div></div></figure><p id="e057" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">根据地区查找<code class="fe ny nz oa nk b">NodeImageId</code>—查看<a class="ae lb" href="https://docs.aws.amazon.com/en_us/eks/latest/userguide/getting-started-console.html#eks-launch-workers" rel="noopener ugc nofollow" target="_blank">文档</a>获取最新列表。</p><p id="72cd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">目前栈是在London/eu-west-2创建，不需要在GPU，于是——<em class="mq">ami-0147919 D2 ff 9 a6 ad 5</em>(亚马逊Linux)。</p><p id="d8cf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">设置这个AMI ID，选择VPC和两个子网:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi od"><img src="../Images/2bc0a6ef1fddf75c13c009e176f62f59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-BS8GVxa5a-mcLnG.png"/></div></div></figure><p id="8933" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">点击<em class="mq">下一页</em>，跳过下一页，点击<em class="mq">创建堆栈</em>:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi od"><img src="../Images/91346d8e3d8c71467da2b7e8aa22dbe1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CfErJQP7CCttPct6.png"/></div></div></figure><p id="8e99" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">堆栈创建完成后—检查自动缩放组:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi oe"><img src="../Images/f498ce0970b499308d8d267433cea629.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vlSZvSo1LcWc95Re.png"/></div></div></figure><h2 id="03c0" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated"><code class="fe ny nz oa nk b">kubectl</code>安装</h2><p id="bb43" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">当我们使用工作节点时——我们的EKS集群被供应，我们可以在一台工作机器上安装<code class="fe ny nz oa nk b">kubectl</code>。</p><p id="b24c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下载可执行文件:</p><pre class="mg mh mi mj gt nj nk nl nm aw nn bi"><span id="ed1c" class="lh li iq nk b gy no np l nq nr">[setevoy@setevoy-arch-work ~] $ curl -o kubectl <a class="ae lb" href="https://amazon-eks.s3-us-west-2.amazonaws.com/1.13.7/2019-06-11/bin/linux/amd64/kubectl" rel="noopener ugc nofollow" target="_blank">https://amazon-eks.s3-us-west-2.amazonaws.com/1.13.7/2019-06-11/bin/linux/amd64/kubectl</a><br/>[setevoy@setevoy-arch-work ~] $ chmod +x kubectl<br/>[setevoy@setevoy-arch-work ~] $ sudo mv kubectl /usr/local/bin/</span></pre><p id="88a5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查:</p><pre class="mg mh mi mj gt nj nk nl nm aw nn bi"><span id="ed47" class="lh li iq nk b gy no np l nq nr">[setevoy@setevoy-arch-work ~] $ kubectl version — short — client<br/>Client Version: v1.13.7-eks-fa4c70</span></pre><p id="ef41" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要创建其配置文件，请使用AWS CLI:</p><pre class="mg mh mi mj gt nj nk nl nm aw nn bi"><span id="43bf" class="lh li iq nk b gy no np l nq nr">[setevoy@setevoy-arch-work ~] $ aws eks — region eu-west-2 — profile arseniy update-kubeconfig — name eks-cluster-manual<br/>Added new context arn:aws:eks:eu-west-2:534***385:cluster/eks-cluster-manual to /home/setevoy/.kube/config</span></pre><p id="dc57" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加别名只是为了简化工作:</p><pre class="mg mh mi mj gt nj nk nl nm aw nn bi"><span id="fad9" class="lh li iq nk b gy no np l nq nr">[setevoy@setevoy-arch-work ~] $ echo “alias kk=\”kubectl\”” &gt;&gt; ~/.bashrc<br/>[setevoy@setevoy-arch-work ~] $ bash</span></pre><p id="f749" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><pre class="mg mh mi mj gt nj nk nl nm aw nn bi"><span id="2d61" class="lh li iq nk b gy no np l nq nr">[setevoy@setevoy-arch-work ~] $ kk get svc<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br/>kubernetes ClusterIP 172.20.0.1 &lt;none&gt; 443/TCP 20m</span></pre><h2 id="7273" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">AWS验证器</h2><p id="b5ca" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">尽管工作者节点的云形成已经准备好，并且EC2实例已经启动并运行——但是我们仍然不能将它们视为Kubernetes集群中的节点:</p><pre class="mg mh mi mj gt nj nk nl nm aw nn bi"><span id="fb06" class="lh li iq nk b gy no np l nq nr">[setevoy@setevoy-arch-work ~] $ kk get node</span></pre><p id="f249" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">找不到资源。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi of"><img src="../Images/4e5730000c109e05210f05cb38d66f92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uugb0Xe3kvXplYSq.png"/></div></div></figure><p id="f283" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下载AWS验证器:</p><pre class="mg mh mi mj gt nj nk nl nm aw nn bi"><span id="b96a" class="lh li iq nk b gy no np l nq nr">[setevoy@setevoy-arch-work ~] $ cd Temp/<br/>[setevoy@setevoy-arch-work ~] $ curl -so aws-auth-cm.yaml <a class="ae lb" href="https://amazon-eks.s3-us-west-2.amazonaws.com/cloudformation/2019-02-11/aws-auth-cm.yaml" rel="noopener ugc nofollow" target="_blank">https://amazon-eks.s3-us-west-2.amazonaws.com/cloudformation/2019-02-11/aws-auth-cm.yaml</a></span></pre><p id="2f24" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">转到в <em class="mq"> IAM &gt;角色</em>，找到角色(<em class="mq"> NodeInstanceRole </em>)的ARN(亚马逊资源名):</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi og"><img src="../Images/796a13e9ee0cdec98a5a14a0df8266a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*L2YC5SHHdH0u1fD7.png"/></div></div></figure><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi oh"><img src="../Images/d1f61591ee07777d3cee4321d286a427.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Kp5hAGp4TM9R6ut0.png"/></div></div></figure><p id="d8be" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">编辑文件<code class="fe ny nz oa nk b">aws-auth-cm.yaml</code>，设置<code class="fe ny nz oa nk b">rolearn</code>:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi oi"><img src="../Images/88133f94f3bf03708dd0e8c4a0a3977e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rRDDzwu95qVl_46H.png"/></div></div></figure><p id="de67" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创造一个<code class="fe ny nz oa nk b">ConfigMap</code>:</p><pre class="mg mh mi mj gt nj nk nl nm aw nn bi"><span id="fe0f" class="lh li iq nk b gy no np l nq nr">[setevoy@setevoy-arch-work ~/Temp] $ kk apply -f aws-auth-cm.yaml<br/>configmap/aws-auth created</span></pre><p id="5ff4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查:</p><pre class="mg mh mi mj gt nj nk nl nm aw nn bi"><span id="0f62" class="lh li iq nk b gy no np l nq nr">[setevoy@setevoy-arch-work ~/Temp] $ kubectl get nodes -o wide<br/>NAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIME<br/>ip-10–0–153–7.eu-west-2.compute.internal Ready &lt;none&gt; 47s v1.13.7-eks-c57ff8 10.0.153.7 &lt;none&gt; Amazon Linux 2 4.14.128–112.105.amzn2.x86_64 docker://18.6.1<br/>ip-10–0–196–123.eu-west-2.compute.internal Ready &lt;none&gt; 50s v1.13.7-eks-c57ff8 10.0.196.123 &lt;none&gt; Amazon Linux 2 4.14.128–112.105.amzn2.x86_64 docker://18.6.1<br/>ip-10–0–204–190.eu-west-2.compute.internal Ready &lt;none&gt; 52s v1.13.7-eks-c57ff8 10.0.204.190 &lt;none&gt; Amazon Linux 2 4.14.128–112.105.amzn2.x86_64 docker://18.6.1</span></pre><p id="7efc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">节点被添加到集群中—太好了。</p><h2 id="2ffe" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">网络应用和负载平衡器</h2><p id="59cd" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">出于测试目的，让我们创建一个简单的web服务，例如，一个普通的NGINX，就像在<a class="ae lb" href="https://rtfm.co.ua/en/kubernetes-part-2-a-cluster-set-up-on-aws-with-aws-cloud-provider-and-aws-loadbalancer/" rel="noopener ugc nofollow" target="_blank">上一章</a>中一样。</p><p id="cd59" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要访问NGINX——让我们也在Kubernetes和AWS中创建一个负载平衡器，它将请求代理到工作节点:</p><pre class="mg mh mi mj gt nj nk nl nm aw nn bi"><span id="823d" class="lh li iq nk b gy no np l nq nr">kind: Service<br/>apiVersion: v1<br/>metadata:<br/>  name: eks-cluster-manual-elb<br/>spec:<br/>  type: LoadBalancer<br/>  selector:<br/>    app: eks-cluster-manual-pod<br/>  ports:<br/>    - name: http<br/>      protocol: TCP<br/>      # ELB's port<br/>      port: 80<br/>      # container's port<br/>      targetPort: 80<br/>---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: eks-cluster-manual-deploy<br/>spec:<br/>  # ReplicaSet pods config<br/>  replicas: 1<br/>  # pods selector<br/>  selector:<br/>    matchLabels:<br/>      app: eks-cluster-manual-pod<br/>  # Pod template<br/>  template:<br/>    metadata:<br/>      # a pod's labeles<br/>      labels:<br/>        app: eks-cluster-manual-pod<br/>    spec:<br/>      containers:<br/>        - name: eks-cluster-manual-app<br/>          image: nginx</span></pre><p id="dfae" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">部署它们:</p><pre class="mg mh mi mj gt nj nk nl nm aw nn bi"><span id="17d5" class="lh li iq nk b gy no np l nq nr">[setevoy@setevoy-arch-work ~/Temp] $ kk apply -f eks-cluster-manual-elb-nginx.yml<br/>service/eks-cluster-manual-elb created<br/>deployment.apps/eks-cluster-manual-deploy created</span></pre><p id="de52" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查服务:</p><pre class="mg mh mi mj gt nj nk nl nm aw nn bi"><span id="ede3" class="lh li iq nk b gy no np l nq nr">[setevoy@setevoy-arch-work ~/Temp] $ kk get svc<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br/>eks-cluster-manual-elb LoadBalancer 172.20.17.42 a05***405.eu-west-2.elb.amazonaws.com 80:32680/TCP 5m23s</span></pre><p id="8b13" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一个豆荚:</p><pre class="mg mh mi mj gt nj nk nl nm aw nn bi"><span id="b906" class="lh li iq nk b gy no np l nq nr">[setevoy@setevoy-arch-work ~/Temp] kk get po -o wide -l app=eks-cluster-manual-pod<br/>NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES<br/>eks-cluster-manual-deploy-698b8f6df7-jg55x 1/1 Running 0 6m17s 10.0.130.54 ip-10–0–153–7.eu-west-2.compute.internal &lt;none&gt; &lt;none&gt;</span></pre><p id="127d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">而<code class="fe ny nz oa nk b">ConfigMap</code>本身:</p><pre class="mg mh mi mj gt nj nk nl nm aw nn bi"><span id="d890" class="lh li iq nk b gy no np l nq nr">[setevoy@setevoy-arch-work ~/Temp]kubectl describe configmap -n kube-system aws-auth<br/>Name: aws-auth<br/>Namespace: kube-system<br/>Labels: &lt;none&gt;<br/>Annotations: kubectl.kubernetes.io/last-applied-configuration:<br/>{“apiVersion”:”v1",”data”:{“mapRoles”:”- rolearn: arn:aws:iam::534***385:role/eks-cluster-manual-workers-stack-NodeInstanceRole-12DRN98…<br/>Data<br/>====<br/>mapRoles:<br/> — — <br/>- rolearn: arn:aws:iam::534***385:role/eks-cluster-manual-workers-stack-NodeInstanceRole-12DRN987QYB34<br/>username: system:node:{{EC2PrivateDNSName}}<br/>groups:<br/>- system:bootstrappers<br/>- system:nodes<br/>Events: &lt;none&gt;</span></pre><p id="1a31" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">AWS中的负载平衡器(需要等待大约5分钟来启动pod并将节点连接到ELB):</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi oj"><img src="../Images/d87bee5eb39ad65f6a8f3df2b9b4ed99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_2CChwHEPTSe_pCa.png"/></div></div></figure><p id="aaed" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">它的标签:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi ok"><img src="../Images/59517a9684ac42325ec509419fae5ee8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2s-2BNOlLKGy30eC.png"/></div></div></figure><p id="281d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并测试AWS或<code class="fe ny nz oa nk b">kubectl get svc</code>命令提供的URL:</p><pre class="mg mh mi mj gt nj nk nl nm aw nn bi"><span id="62e8" class="lh li iq nk b gy no np l nq nr">[setevoy@setevoy-arch-work ~/Temp] $ curl a05***405.eu-west-2.elb.amazonaws.com<br/>&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>&lt;title&gt;Welcome to nginx!&lt;/title&gt;<br/>…</span></pre><p id="29b5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">完成了。</p><h2 id="306b" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">有用的链接</h2><ul class=""><li id="7c7f" class="ks kt iq jw b jx ma kb mb kf ol kj om kn on kr kx ky kz la bi translated"><a class="ae lb" href="https://docs.aws.amazon.com/en_us/eks/latest/userguide/what-is-eks.html" rel="noopener ugc nofollow" target="_blank">什么是亚马逊EKS？</a></li><li id="f7bc" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://docs.aws.amazon.com/en_us/eks/latest/userguide/getting-started-console.html" rel="noopener ugc nofollow" target="_blank">亚马逊EKS入门</a></li><li id="c649" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://docs.aws.amazon.com/en_us/eks/latest/userguide/add-user-role.html" rel="noopener ugc nofollow" target="_blank">管理集群的用户或IAM角色</a></li><li id="ccaa" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://unofficial-kubernetes.readthedocs.io/en/latest/tasks/configure-pod-container/configmap/" rel="noopener ugc nofollow" target="_blank"> Kubernetes配置图</a></li><li id="37fa" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://eksworkshop.com/introduction/" rel="noopener ugc nofollow" target="_blank">亚马逊EKS工作室</a></li><li id="7cb6" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://cloudgeometry.io/blog/amazon-eks/" rel="noopener ugc nofollow" target="_blank">关于亚马逊(EKS)上的Kubernetes要知道的十件事</a></li><li id="4609" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://medium.com/@andrewhibbert/eks-review-b4ee523083dc" rel="noopener"> EKS评论</a></li><li id="c2ad" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated">我的第一个Kubernetes集群:亚马逊EKS评论</li><li id="0e1f" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated">【Kubernetes部署故障排除</li><li id="f223" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated">为初学者详细解释的匹配标签、标记和选择器</li></ul></div><div class="ab cl oo op hu oq" role="separator"><span class="or bw bk os ot ou"/><span class="or bw bk os ot ou"/><span class="or bw bk os ot"/></div><div class="ij ik il im in"><p id="beb6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="mq">最初发布于</em> <a class="ae lb" href="https://rtfm.co.ua/en/kubernetes-part-3-aws-eks-overview-and-manual-eks-cluster-set-up/" rel="noopener ugc nofollow" target="_blank"> <em class="mq"> RTFM: Linux、DevOps和系统管理</em> </a> <em class="mq">。</em></p></div></div>    
</body>
</html>