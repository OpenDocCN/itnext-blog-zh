<html>
<head>
<title>Helm 3 — Updating Consul, the GitOps way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">头盔3-更新执政官，吉托普斯之路</h1>
<blockquote>原文：<a href="https://itnext.io/helm-3-updating-consul-the-gitops-way-1ee45af8fe4d?source=collection_archive---------4-----------------------#2020-08-23">https://itnext.io/helm-3-updating-consul-the-gitops-way-1ee45af8fe4d?source=collection_archive---------4-----------------------#2020-08-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/aa0cde89b779f091bda119d2e175867f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/format:webp/0*uxFJ20n_RfkY_vYX.png"/></div></figure><p id="92d6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果你读过我以前的文章，你就会知道我是赫尔姆的忠实粉丝。Kubernetes的“包管理器”通常被称为是一个强大的工具，它可以做的远不止是生产Kubernetes元数据。因为Helm是将您的工作负载打包交付给Kubernetes的引擎，为什么不将其他运营流程作为Helm升级的一部分加入其中呢？</p><p id="ee50" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从GitOps的角度考虑CI/CD流程，通常会采用多个阶段。以下是作为mill GitOps CI/CD管道运行的一部分完成的操作的一般列表(给出或采取一些步骤):</p><h2 id="3648" class="ks kt iq bd ku kv kw dn kx ky kz dp la kf lb lc ld kj le lf lg kn lh li lj lk bi translated">海峡群岛</h2><ul class=""><li id="0d05" class="ll lm iq jw b jx ln kb lo kf lp kj lq kn lr kr ls lt lu lv bi translated">将代码/数据库更改脚本/配置更改签入源代码控制。</li><li id="4506" class="ll lm iq jw b jx lw kb lx kf ly kj lz kn ma kr ls lt lu lv bi translated">构建代码</li><li id="adf2" class="ll lm iq jw b jx lw kb lx kf ly kj lz kn ma kr ls lt lu lv bi translated">打包代码</li></ul><h2 id="dd09" class="ks kt iq bd ku kv kw dn kx ky kz dp la kf lb lc ld kj le lf lg kn lh li lj lk bi translated">激光唱片</h2><ul class=""><li id="f511" class="ll lm iq jw b jx ln kb lo kf lp kj lq kn lr kr ls lt lu lv bi translated">进行环境变量或配置更新</li><li id="78c0" class="ll lm iq jw b jx lw kb lx kf ly kj lz kn ma kr ls lt lu lv bi translated">应用一些数据库更改</li><li id="a437" class="ll lm iq jw b jx lw kb lx kf ly kj lz kn ma kr ls lt lu lv bi translated">将打包的代码部署到环境X中</li></ul><p id="c9f6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">环境变量和配置更改通常(但不总是)与新功能的发布相关联，数据库更改也是如此。当然，有时例行的密码更新和/或数据库更改是独立于软件发布进行的，但现在让我们保持简单。</p><p id="7555" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，您的代码和配置<em class="mb">应该</em>存储在一个源代码控制系统中，比如Git、Subversion或Mercurial。有很多原因可以解释为什么这被认为是最佳实践，但是这是另一篇文章的主题。请记住不要在Git中存储用户名、密码或其他敏感信息，这是另一篇文章的主题。由于Helm图表通常也存储在Git中，通常带有针对不同环境配置的特定分支或文件夹，因此我们可以利用Helm的强大功能将所有这些配置更改应用到我们的环境中。</p><h1 id="907a" class="mc kt iq bd ku md me mf kx mg mh mi la mj mk ml ld mm mn mo lg mp mq mr lj ms bi translated">领事是什么？</h1><p id="20c6" class="pw-post-body-paragraph ju jv iq jw b jx ln jz ka kb lo kd ke kf mt kh ki kj mu kl km kn mv kp kq kr ij bi translated">关于<a class="ae mw" href="https://www.consul.io/" rel="noopener ugc nofollow" target="_blank">领事</a>，我就不赘述了，不过，领事是Hashicorp这样描述的:</p><blockquote class="mx my mz"><p id="fa74" class="ju jv mb jw b jx jy jz ka kb kc kd ke na kg kh ki nb kk kl km nc ko kp kq kr ij bi translated">Consul是一个服务网格解决方案，提供具有服务发现、配置和分段功能的全功能控制平面。这些功能可以根据需要单独使用，也可以一起使用来构建一个完整的服务网格。</p></blockquote><p id="d42d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了集成到Helm 3中，我们将重点介绍Consul的配置特性，称为Consul KV store，Hashicorp对它的描述如下:</p><blockquote class="mx my mz"><p id="70ba" class="ju jv mb jw b jx jy jz ka kb kc kd ke na kg kh ki nb kk kl km nc ko kp kq kr ij bi translated"><strong class="jw ir"> KV Store </strong>:应用程序可以将Consul的层次化键/值存储用于任何目的，包括动态配置、特性标记、协调、领导者选举等等。简单的HTTP API使其易于使用。</p></blockquote><p id="9ab2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，Consul的KV store是一个允许我们通过REST API改变配置的工具。这是我们所有应用程序获取配置数据的中心位置。通过这样做，我们的应用程序代码保持通用，我们在每个环境中都有一个中心位置来查看配置参数，并且我们可以在构建管道中更新我们的配置，因为我们将它存储在源代码控制中。</p><h1 id="ba36" class="mc kt iq bd ku md me mf kx mg mh mi la mj mk ml ld mm mn mo lg mp mq mr lj ms bi translated">我们如何更新领事？</h1><p id="232f" class="pw-post-body-paragraph ju jv iq jw b jx ln jz ka kb lo kd ke kf mt kh ki kj mu kl km kn mv kp kq kr ij bi translated">如前所述，Consul有一个REST API，允许我们通过许多工具更新它的配置。为了这篇文章的目的，也为了保持内容的简洁，我们将使用<a class="ae mw" href="https://github.com/miniclip/gonsul" rel="noopener ugc nofollow" target="_blank">gon sul</a>by<em class="mb">99</em>。</p><p id="66f9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Gonsul是一个实用程序，它从源代码控制系统(在本例中是Git)中获取任意文件夹，并对存储在Git中的配置和指定的Consul KV存储路径中的配置进行区分。任何新添加的条目被添加，现有条目被变异，删除的条目可选地通过Gonsul二进制的标志被删除(见- <em class="mb">允许-删除</em>)。</p><p id="b4d4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Gonsul的伟大之处在于，它既可以从Git repo中检查配置文件，也可以向它提供文件列表，它将对目录进行操作。</p><p id="3e6b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在我与Consul的真实用例中，我选择在我的Helm chart Git存储库中保留每个环境的Consul配置，并将这些配置文件提供给Gonsul，而不需要it检查它们</p><h1 id="3747" class="mc kt iq bd ku md me mf kx mg mh mi la mj mk ml ld mm mn mo lg mp mq mr lj ms bi translated">头盔3——把所有的东西放在一起</h1><p id="cded" class="pw-post-body-paragraph ju jv iq jw b jx ln jz ka kb lo kd ke kf mt kh ki kj mu kl km kn mv kp kq kr ij bi translated">总而言之，我们需要以下设置:</p><ul class=""><li id="6bb1" class="ll lm iq jw b jx jy kb kc kf nd kj ne kn nf kr ls lt lu lv bi translated">一个Git存储库，包含我们的舵图，以及每个环境的配置文件夹。下面我们看到两个图表，一个用于生产，一个用于暂存。这些图表目录中的每一个都包含配置文件的子目录，这些配置文件包含为Consul设置的KV store条目。请注意，您的存储库不必看起来像这样，并且根据您的项目，可能会呈现完全不同的结构。我们也有一个<em class="mb">咨询-更新-配置图</em>。这个ConfigMap只是将config文件夹中的文件映射到我们的作业对象稍后将使用的ConfigMap中。关于如何创建这样的配置图的更多细节，请参见本文。</li></ul><pre class="ng nh ni nj gt nk nl nm nn aw no bi"><span id="a067" class="ks kt iq nl b gy np nq l nr ns"><strong class="nl ir">+--helmcharts<br/>   |<br/>   +--config_charts<br/>      |<br/>      +--staging<br/>         |<br/>         +--templates<br/>            |<br/>            +--consul-updater-configmap.yaml<br/>            +--...<br/>         +--config<br/>            |     <br/>            +--config1.yaml<br/>            +--config2.json<br/>            +--config3.yaml<br/>         +--values.yaml<br/>         +--Chart.yaml   <br/>      +--production<br/>         |<br/>         +--templates<br/>            |<br/>            +--consul-updater-configmap.yaml<br/>            +--...<br/>         +--config<br/>            |     <br/>            +--config1.yaml<br/>            +--config2.json<br/>            +--config3.yaml<br/>         +--values.yaml<br/>         +--Chart.yaml</strong></span></pre><p id="61d3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">上面我们看到两个图表，一个用于生产，一个用于暂存。这些图表目录中的每一个都包含配置文件的子目录，这些配置文件包含为Consul设置的KV store条目。请注意，您的存储库不必看起来像这样，并且根据您的项目，可能会呈现完全不同的结构。</p><ul class=""><li id="6efc" class="ll lm iq jw b jx jy kb kc kf nd kj ne kn nf kr ls lt lu lv bi translated">安装了Gonsul二进制文件的容器。我选择构建自己的容器，因为我通常这样做是为了保持环境的一致性，但是您可以只使用<em class="mb"> mincliposs </em>图像:</li></ul><pre class="ng nh ni nj gt nk nl nm nn aw no bi"><span id="ee9d" class="ks kt iq nl b gy np nq l nr ns"><strong class="nl ir">docker pull minicliposs/gonsul:latest</strong></span></pre><ul class=""><li id="6a7c" class="ll lm iq jw b jx jy kb kc kf nd kj ne kn nf kr ls lt lu lv bi translated">将所有配置文件映射到Gonsul容器的配置映射。</li><li id="13bd" class="ll lm iq jw b jx lw kb lx kf ly kj lz kn ma kr ls lt lu lv bi translated">最后，我们将利用Kubernetes作业来运行Gonsul作业:</li></ul><pre class="ng nh ni nj gt nk nl nm nn aw no bi"><span id="30b5" class="ks kt iq nl b gy np nq l nr ns"><strong class="nl ir">apiVersion: v1<br/>kind: Job<br/>metadata:<br/>  name: consul-updater<br/>  annotations:<br/>    # This is what defines this resource as a hook. Without this line, the<br/>    # job is considered part of the release.<br/>    "helm.sh/hook": post-install, post-upgrade, post-rollback<br/>    "helm.sh/hook-delete-policy": hook-succeeded, hook-failed, before-hook-creation<br/>  labels:<br/>    app: consul-updater    <br/>spec:<br/>  template:<br/>    metadata:<br/>      name: consul-updater<br/>    spec:<br/>      restartPolicy: Never<br/>      volumes:<br/>        - name: consul-config<br/>          configMap:<br/>            name: consul-updater-configmap<br/>      containers:<br/>        - name: gonsul<br/>          image: minicliposs/gonsul:latest<br/>          volumeMounts:<br/>            {{ range $path, $bytes := .Files.Glob ( printf "config/**" ) }}<br/>            {{ $name := base $path }}<br/>            - name: consul-config<br/>              mountPath: {{ printf "/path/to/files/%s/%s" (index (regexSplit "config" (dir $path) -1) 1) $name | indent 2 }}<br/>              subPath: {{- sha256sum (printf "%s/%s" (index (regexSplit "config" (dir $path) -1) 1 ) $name ) | indent 2 }}<br/>            {{ end }}<br/>          command:<br/>            - /bin/bash<br/>            - -c<br/>            - /usr/local/bin/gonsul --repo-root=/path/to/files/ --consul-url=</strong><a class="ae mw" href="http://consul:8500" rel="noopener ugc nofollow" target="_blank"><strong class="nl ir">http://consul:8500</strong></a><strong class="nl ir"> --allow-deletes=skip --input-ext=json,txt,yaml</strong></span></pre><p id="8080" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这份工作有一些需要注意的地方。让我们来分解一下:</p><ol class=""><li id="c908" class="ll lm iq jw b jx jy kb kc kf nd kj ne kn nf kr nt lt lu lv bi translated">这项工作使用了舵钩。这些挂钩将在升级或安装过程的不同阶段运行。这些阶段是使用<em class="mb">helm.sh/hook</em>注释定义的</li><li id="483f" class="ll lm iq jw b jx lw kb lx kf ly kj lz kn ma kr nt lt lu lv bi translated">我们定义一个删除策略。赫尔姆离开后，我们不希望这份工作继续存在</li><li id="671b" class="ll lm iq jw b jx lw kb lx kf ly kj lz kn ma kr nt lt lu lv bi translated">在VolumeMounts部分有一些复杂的逻辑。这允许我们将文件目录映射到容器中。关于这方面的更多细节，我有<a class="ae mw" rel="noopener ugc nofollow" target="_blank" href="/helm-3-mapping-a-directory-of-files-into-a-container-ed6c54372df8">一篇文章解释为什么你会想这么做。</a></li><li id="e53d" class="ll lm iq jw b jx lw kb lx kf ly kj lz kn ma kr nt lt lu lv bi translated">最后，我们有命令。这是运行Gonsul工具的入口点。你也可以选择将它添加到docker文件中，但是我喜欢将它添加到舵图中，因为在这里进行微调通常比构建另一个图像来测试旗帜变化更简单。通过指定一个<em class="mb"> repo-root </em>，Gonsul将不会尝试获取Git存储库，但是如果它在您的管道中工作得更好，您也可以选择这样做。</li></ol><h1 id="5968" class="mc kt iq bd ku md me mf kx mg mh mi la mj mk ml ld mm mn mo lg mp mq mr lj ms bi translated">优势和总结</h1><p id="73d7" class="pw-post-body-paragraph ju jv iq jw b jx ln jz ka kb lo kd ke kf mt kh ki kj mu kl km kn mv kp kq kr ij bi translated">使用Helm更新Consul有一些显著的优势，即:</p><ol class=""><li id="887a" class="ll lm iq jw b jx jy kb kc kf nd kj ne kn nf kr nt lt lu lv bi translated">Helm管理您的整个升级操作，包括配置更新。</li><li id="1289" class="ll lm iq jw b jx lw kb lx kf ly kj lz kn ma kr nt lt lu lv bi translated">由于Helm管理升级，如果您使用海图博物馆，配置将被捆绑到Helm海图中并被加工。这支持下面的3和4。</li><li id="33dd" class="ll lm iq jw b jx lw kb lx kf ly kj lz kn ma kr nt lt lu lv bi translated">如果在配置升级过程中出现问题，Helm可以设置为将您的部署回滚到上一个稳定状态</li><li id="7d45" class="ll lm iq jw b jx lw kb lx kf ly kj lz kn ma kr nt lt lu lv bi translated"><strong class="jw ir">如果升级成功，但在生产中出现问题，Helm回滚操作也将回滚您的配置(如果已经用<em class="mb">后回滚</em> Helm hook) </strong></li></ol><p id="f9bb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">第四点可能是选择这条路线的首要原因。试图找出哪一组配置参数与以前的版本相关联是一件非常浪费时间的事情，尤其是当您面临恢复一个损坏的环境(比如生产环境)的压力时。通过将配置及其发布和回滚过程联系在一起，可以获得回滚到已知状态的信心和自动化程度。</p><p id="2c88" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">通过使用Helm来实现基本Kubernetes部署以外的自动化，可以将更多的责任转移到Helm升级过程中，并且在CI管道中需要的定制脚本更少。总而言之，这有助于我晚上睡得更好，希望其他人也能从这种方法中受益。</p></div></div>    
</body>
</html>