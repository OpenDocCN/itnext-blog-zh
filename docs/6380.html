<html>
<head>
<title>Creating an API Gateway using Emissary-Ingress and Linkerd on K3s</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在K3s上使用使者入口和链接器创建API网关</h1>
<blockquote>原文：<a href="https://itnext.io/creating-an-api-gateway-using-emissary-ingress-and-linkerd-on-k3s-612c1772d48a?source=collection_archive---------1-----------------------#2021-11-02">https://itnext.io/creating-an-api-gateway-using-emissary-ingress-and-linkerd-on-k3s-612c1772d48a?source=collection_archive---------1-----------------------#2021-11-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d50c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">了解如何使用大使使者入口和链接器在K3s上创建API网关。</p><h1 id="bb15" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">项目架构和核心组件</h1><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi lj"><img src="../Images/f80b7d5420ad5fe048ad84393c05091c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_xC_G4ECfQlMqfEJF0Gp6w.png"/></div></div></figure><p id="dd4e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们项目的目标是创建一个轻量级API网关，将来自客户端的请求路由到各种服务。这些服务包括从定制设计的内部API到我们的应用程序所需的第三方API。此外，我们需要网关具有相互TLS加密以及可观察性组件，以查看通过网关的流量。</p><p id="a60f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是创建我们的API网关所需的组件和应用程序列表:</p><h2 id="36ac" class="lv km iq bd kn lw lx dn kr ly lz dp kv jy ma mb kz kc mc md ld kg me mf lh mg bi translated"><a class="ae mh" href="https://k3s.io/" rel="noopener ugc nofollow" target="_blank"> K3s </a></h2><p id="49bc" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">K3s是一个轻量级的Kubernetes发行版，设计用于需要Kubernetes的好处而不需要大的安装规模的情况。K3s可用于生产，易于安装，并且是小于100MB的二进制文件。对于我们的用例，我们需要一个对我们的客户来说尽可能轻量级的Kubernetes发行版，使K3s成为理想的选择。</p><h2 id="d45e" class="lv km iq bd kn lw lx dn kr ly lz dp kv jy ma mb kz kc mc md ld kg me mf lh mg bi translated"><a class="ae mh" href="https://github.com/lima-vm/lima" rel="noopener ugc nofollow" target="_blank"> LimaVM </a></h2><p id="503a" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">LimaVM是一个主要用于运行MacOS的Linux虚拟机。我们的开发工作流程完全集中在使用装有MacOS的机器上，但是考虑到需要运行K3s，我们需要一种运行Linux的方法。鉴于Lima的功能性和易用性，我们决定将LimaVM实现到我们的工具集中。</p><h2 id="3f98" class="lv km iq bd kn lw lx dn kr ly lz dp kv jy ma mb kz kc mc md ld kg me mf lh mg bi translated"><a class="ae mh" href="https://www.getambassador.io/docs/emissary/" rel="noopener ugc nofollow" target="_blank">大使使者入境</a></h2><p id="8d55" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">使者入口是一个开源的Kubernetes-native API网关+第7层负载平衡器，Kubernetes入口建立在<a class="ae mh" href="https://www.envoyproxy.io/" rel="noopener ugc nofollow" target="_blank">特使代理</a>之上。借助使者入口，我们可以通过大使的映射CRDs管理流量和路由，并通过TLS加密以及服务器和客户端证书验证来保护微服务。</p><h2 id="94be" class="lv km iq bd kn lw lx dn kr ly lz dp kv jy ma mb kz kc mc md ld kg me mf lh mg bi translated"><a class="ae mh" href="https://linkerd.io/" rel="noopener ugc nofollow" target="_blank"> Linkerd </a></h2><p id="a75d" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">Linkerd是Kubernetes的一个服务网。Linkerd的工作原理是为每个服务实例安装sidecar代理，然后代理处理所有进出服务的流量。Linkerd自动将相互TLS添加到任何集群上的TCP通信中，无需额外的配置，并且使用<em class="mn"> linkerd-viz </em>扩展，用户可以看到从一个服务到另一个服务的实时指标和调用。</p><h2 id="ad57" class="lv km iq bd kn lw lx dn kr ly lz dp kv jy ma mb kz kc mc md ld kg me mf lh mg bi translated">【可选】<a class="ae mh" href="https://external-secrets.io/" rel="noopener ugc nofollow" target="_blank">外部机密操作员</a></h2><p id="80ff" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">外部秘密运营商是一个Kubernetes运营商，允许集成外部秘密管理系统，如谷歌云平台(GCP)和亚马逊网络服务(AWS)。它用于将来自外部API的秘密同步到本地Kubernetes秘密中，然后可以在部署或其他Kubernetes资源中用作环境变量。</p><h1 id="edbf" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">我们开始吧</h1><h2 id="9e89" class="lv km iq bd kn lw lx dn kr ly lz dp kv jy ma mb kz kc mc md ld kg me mf lh mg bi translated">[可选]设置LimaVM实例</h2><p id="2712" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">对于使用Mac操作系统的用户，我们建议使用LimaVM作为项目的虚拟机。</p><p id="96bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，使用<a class="ae mh" href="https://brew.sh/" rel="noopener ugc nofollow" target="_blank">自制软件</a>安装Lima并启动默认实例:</p><pre class="lk ll lm ln gt mo mp mq mr aw ms bi"><span id="3024" class="lv km iq mp b gy mt mu l mv mw">brew install lima</span><span id="bde4" class="lv km iq mp b gy mx mu l mv mw">limactl start default --tty=false</span></pre><p id="16f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，使用命令:<em class="mn"> lima打开shell。</em></p><h2 id="4955" class="lv km iq bd kn lw lx dn kr ly lz dp kv jy ma mb kz kc mc md ld kg me mf lh mg bi translated"><em class="my">创建K3s集群</em></h2><p id="0e92" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">要设置我们的K3s集群，我们将在禁用默认Traefik入口控制器的情况下安装K3s，以便我们的使者入口负载平衡器可以使用外部IP地址。</p><pre class="lk ll lm ln gt mo mp mq mr aw ms bi"><span id="63f0" class="lv km iq mp b gy mt mu l mv mw">curl -sfL <a class="ae mh" href="https://get.k3s.io" rel="noopener ugc nofollow" target="_blank">https://get.k3s.io</a> | sh -s — — disable=traefik</span></pre><p id="35f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要检查一切都已启动并运行，请运行:</p><pre class="lk ll lm ln gt mo mp mq mr aw ms bi"><span id="2156" class="lv km iq mp b gy mt mu l mv mw">k3s kubectl get node</span></pre><p id="2887" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该命令应该输出如下内容:</p><pre class="lk ll lm ln gt mo mp mq mr aw ms bi"><span id="ee0f" class="lv km iq mp b gy mt mu l mv mw">NAME        STATUS   ROLES                  AGE   VERSION<br/>lima        Ready    control-plane,master   9s    v1.21.5+k3s2</span></pre><h2 id="d99a" class="lv km iq bd kn lw lx dn kr ly lz dp kv jy ma mb kz kc mc md ld kg me mf lh mg bi translated"><strong class="ak">安装大使使者入口</strong></h2><p id="c7e7" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">我们首先将<a class="ae mh" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank">舵</a>安装到我们的集群上:</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">安装舵</figcaption></figure><p id="cd76" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后使用头盔，安装使者入口:</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">安装使者-入口</figcaption></figure><p id="4819" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">注意:</strong>对于我们的用例，我们已经决定用我们自己预先存在的名称空间“api-gateway”覆盖默认的“使者”名称空间。要创建自己的命名空间，请运行:</p><pre class="lk ll lm ln gt mo mp mq mr aw ms bi"><span id="0276" class="lv km iq mp b gy mt mu l mv mw">kubectl create namespace &lt;namespace name&gt;</span></pre><h2 id="bad8" class="lv km iq bd kn lw lx dn kr ly lz dp kv jy ma mb kz kc mc md ld kg me mf lh mg bi translated">安装Linkerd</h2><p id="2185" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">对于安全性和可观察性组件，我们将安装Linkerd:</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">安装链接器</figcaption></figure><h2 id="4dd7" class="lv km iq bd kn lw lx dn kr ly lz dp kv jy ma mb kz kc mc md ld kg me mf lh mg bi translated">[可选]安装外部机密</h2><p id="ab10" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">我们的一项服务需要存储在谷歌云平台的秘密管理器中的秘密。为了访问这些机密，我们需要使用外部机密操作符，它是通过以下方式安装的:</p><pre class="lk ll lm ln gt mo mp mq mr aw ms bi"><span id="591f" class="lv km iq mp b gy mt mu l mv mw">helm repo add external-secrets <a class="ae mh" href="https://charts.external-secrets.io" rel="noopener ugc nofollow" target="_blank">https://charts.external-secrets.io</a></span></pre><h1 id="e6de" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">创建网关</h1><p id="5be6" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">现在一切都已经安装好了，让我们创建我们的网关！</p><p id="1197" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装后，我们应该看到我们的网关服务已经启动，并且在我们的<em class="mn"> api-gateway </em>名称空间中使用外部IP地址运行。使用这个外部IP地址，我们将能够接受请求，并通过映射自定义资源定义(CRD)将它们路由到特定的服务。映射告诉使者入口如何通过主机和URL路径将传入请求从集群边缘路由到Kubernetes服务。</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">获得我们的网关服务</figcaption></figure><p id="b061" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在创建映射之前，我们首先需要监听器和主机CRD来告诉使者入口监听哪个端口，并需要TLSContext来配置高级TLS选项，如客户端证书验证。</p><p id="7289" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面的代码片段是我们的监听器，它监听端口8443上的HTTPS。这个侦听器将只与我们的名称空间中的主机相关联。要收听集群中的所有人，请将<em class="mn">从:SELF </em>更改为<em class="mn">从:ALL </em></p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">listener.yaml</figcaption></figure><p id="36da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，让我们创建我们的主机。</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">host.yaml</figcaption></figure><p id="1e06" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的主机是一个通配符主机，由主机名中的*表示。这意味着在您的主机名之前输入的任何内容都将被解析为您的IP地址。</p><p id="cf84" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于我们的用例，我们需要相互的TLS。为此，我们需要创建一个TLS上下文、一个自签名证书和一个客户端CA证书。要创建您的证书，请参阅创建您的<a class="ae mh" href="https://www.getambassador.io/docs/emissary/latest/howtos/tls-termination/#create-a-self-signed-certificate" rel="noopener ugc nofollow" target="_blank"> tls-cert </a>和<a class="ae mh" href="https://www.getambassador.io/docs/emissary/latest/howtos/client-cert-validation/" rel="noopener ugc nofollow" target="_blank"> client-cacert </a>的使者入口文档。创建后，这些可以放在我们的Host和TLSContext资源中。</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">tls-context.yaml</figcaption></figure><p id="b1c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">注意:</strong>对于我们的项目，我们已经决定配置messenger-ingress，如果客户端没有通过<em class="mn"> cert-required: true提供证书，就拒绝请求。</em></p><p id="0799" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，在我们的主机资源中，我们可以通过以下方式连接TLSContext:</p><pre class="lk ll lm ln gt mo mp mq mr aw ms bi"><span id="d142" class="lv km iq mp b gy mt mu l mv mw">tlsContext:<br/>    name: tls-context</span></pre><p id="e190" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建之后，通过<em class="mn"> kubectl apply: </em>应用这些资源</p><pre class="lk ll lm ln gt mo mp mq mr aw ms bi"><span id="4660" class="lv km iq mp b gy mt mu l mv mw">kubectl apply -f listener.yaml<br/>kubectl apply -f host.yaml<br/>kubectl apply -f tls-context.yaml</span></pre><h2 id="130f" class="lv km iq bd kn lw lx dn kr ly lz dp kv jy ma mb kz kc mc md ld kg me mf lh mg bi translated">路由到服务</h2><p id="fbdf" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">让我们从创建映射开始。</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">报价映射</figcaption></figure><p id="88d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个映射将把来自客户端的请求通过网关路由到服务<em class="mn"> quote-service </em>。我们的服务将通过前缀:<em class="mn"> /quote进行访问。</em></p><p id="8bca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是我们的quote.yaml文件中相应的报价服务和部署。</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">报价服务和部署</figcaption></figure><p id="d9a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用您的报价映射、部署和服务:</p><pre class="lk ll lm ln gt mo mp mq mr aw ms bi"><span id="265e" class="lv km iq mp b gy mt mu l mv mw">kubectl apply -f mapping.yaml<br/>kubectl apply -f quote.yaml</span></pre><p id="6788" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们通过将请求路由到报价服务来测试您的API网关:</p><pre class="lk ll lm ln gt mo mp mq mr aw ms bi"><span id="7370" class="lv km iq mp b gy mt mu l mv mw">curl -lkv --cert [your client cert] --key [your client key] --pass [your password] https://[external IP]/quote</span></pre><p id="c53f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">curl应该输出如下所示的内容:</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="2950" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">恭喜你。您已经用mTLS创建了一个API网关！接下来，让我们进一步保护我们的服务，并通过Linkerd增加可观察性。</p><h1 id="6f88" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">合并Linkerd</h1><p id="270a" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">可以通过<em class="mn"> Linkerd注入</em>命令手动注入linkerd，也可以通过注释自动注入。</p><h2 id="2d23" class="lv km iq bd kn lw lx dn kr ly lz dp kv jy ma mb kz kc mc md ld kg me mf lh mg bi translated">自注入</h2><p id="192b" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">要自动注入，请将Linkerd注释添加到您的名称空间中。应用名称空间后，在此名称空间下创建的任何内容都将被自动注入。</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">自动注入链接器的命名空间</figcaption></figure><pre class="lk ll lm ln gt mo mp mq mr aw ms bi"><span id="6c58" class="lv km iq mp b gy mt mu l mv mw">kubectl apply -f namespace.yaml</span></pre><h2 id="d542" class="lv km iq bd kn lw lx dn kr ly lz dp kv jy ma mb kz kc mc md ld kg me mf lh mg bi translated">手动注射</h2><p id="27ca" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">要直接注入使者入口:</p><pre class="lk ll lm ln gt mo mp mq mr aw ms bi"><span id="bf71" class="lv km iq mp b gy mt mu l mv mw">kubectl get deploy emissary-ingress -o yaml \<br/>  | linkerd inject - \<br/>  | kubectl apply -f -</span></pre><p id="fc45" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者，在名称空间中注入所有部署:</p><pre class="lk ll lm ln gt mo mp mq mr aw ms bi"><span id="1c3d" class="lv km iq mp b gy mt mu l mv mw">kubectl get -n [your namespace] deploy -o yaml \<br/>  | linkerd inject - \<br/>  | kubectl apply -f -</span></pre><h2 id="a947" class="lv km iq bd kn lw lx dn kr ly lz dp kv jy ma mb kz kc mc md ld kg me mf lh mg bi translated">形象化</h2><p id="78cc" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">要查看Linkerd仪表板，请运行以下命令:</p><pre class="lk ll lm ln gt mo mp mq mr aw ms bi"><span id="4894" class="lv km iq mp b gy mt mu l mv mw">linkerd viz dashboard</span></pre><p id="b54d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将告诉您在哪里查看您的仪表板。</p><pre class="lk ll lm ln gt mo mp mq mr aw ms bi"><span id="7d6e" class="lv km iq mp b gy mt mu l mv mw">Linkerd dashboard available at:<br/><a class="ae mh" href="http://localhost:50750" rel="noopener ugc nofollow" target="_blank">http://localhost:50750</a><br/>Grafana dashboard available at:<br/><a class="ae mh" href="http://localhost:50750/grafana" rel="noopener ugc nofollow" target="_blank">http://localhost:50750/grafana</a><br/>Opening Linkerd dashboard in the default browser<br/>Failed to open Linkerd dashboard automatically<br/>Visit <a class="ae mh" href="http://localhost:50750" rel="noopener ugc nofollow" target="_blank">http://localhost:50750</a> in your browser to view the dashboard</span></pre><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi nf"><img src="../Images/b1b18fa47654800fce2ca60b64003492.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2iKV7_ltkaW8uDERc07QTQ.png"/></div></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">Linkerd Viz仪表板</figcaption></figure><p id="7dbc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上图显示了api-gateway名称空间中的所有部署都注入了Linkerd。</p><p id="2035" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">注意:</strong>部署“大使”是使者-入口，只是改名了。</p><p id="c563" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就结束了使用Linkerd和大使使者入口创建API网关的工作！</p><p id="866b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于高级机密配置，我们将使用外部机密运算符。</p><h1 id="4975" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">[可选]外部机密运算符</h1><p id="2d12" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">对于那些将秘密存储在外部存储系统中的人，如谷歌云平台(GCP)的秘密管理器，我们可以使用<a class="ae mh" href="https://external-secrets.io/" rel="noopener ugc nofollow" target="_blank">外部秘密操作符</a>来抓取存储在GCP的秘密，并将其重新创建为Kubernetes秘密。在那里，它们可以被用作Kubernetes资源中的环境变量。</p><p id="b98b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们需要创建一个gcpsm-secret，它存储我们GCP项目的服务帐户凭证。要创建服务帐户凭证，请参见<a class="ae mh" href="https://cloud.google.com/iam/docs/creating-managing-service-accounts" rel="noopener ugc nofollow" target="_blank"> GCP服务帐户文档</a>。</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">正在创建gcpsm-secret</figcaption></figure><p id="2d0b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们将创建一个使用gcpsm-secret的秘密存储。秘密存储指定如何访问外部秘密。</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">外部秘密秘密存储</figcaption></figure><p id="5e0a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我们可以创建需要复制为Kubernetes秘密的秘密。在下面的例子中，我们从GCP秘密经理那里得到了秘密组织的密钥。<em class="mn">目标</em>指定我们想要创建的Kubernetes秘密的名称，在GCP秘密管理器中保存指定秘密的数据。</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">外部秘密设置</figcaption></figure><p id="b372" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦应用，为了确认创建，运行:<em class="mn">ku bectl get secrets-n[namespace]</em></p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">查看秘密</figcaption></figure><p id="ff0e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这些秘密可以作为环境变量在您的项目中访问。一个例子是在部署中需要来自GCP秘密管理器的秘密。下面的代码片段显示了一个部署的一部分，该部署使用Kubernetes的秘密，这些秘密是用外部Secret操作符创建的，用于访问一个组织。</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="e590" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">恭喜你。现在，您已经将部署配置为利用来自第三方外部存储系统的机密。现在，结合上面创建的API-Gateway，您可以创建一个映射来将相应的服务路由到这个部署。玩得开心！</p><h1 id="b50f" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">关于作者</h1><p id="c942" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">摩根·戈麦斯是NCR公司的一名软件工程师。她是亚特兰大人，2021年毕业于佐治亚理工学院，获得了计算媒体学士学位。</p><p id="918f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kevin O'Brien 是NCR公司负责零售创新的软件工程师。他于2021年毕业于佐治亚理工学院，获得了计算机科学学士学位。</p><p id="ee35" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Alex Breazu是NCR公司的一名软件工程师实习生。他是佐治亚大学机械工程专业的学生。</p></div></div>    
</body>
</html>