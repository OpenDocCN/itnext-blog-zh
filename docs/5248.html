<html>
<head>
<title>Scaling a Kubernetes Cluster: One of the Best Practices for Using KubeKey</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">扩展Kubernetes集群:使用KubeKey的最佳实践之一</h1>
<blockquote>原文：<a href="https://itnext.io/scaling-a-kubernetes-cluster-one-of-the-best-practices-for-using-kubekey-960fea2a7b24?source=collection_archive---------3-----------------------#2021-01-22">https://itnext.io/scaling-a-kubernetes-cluster-one-of-the-best-practices-for-using-kubekey-960fea2a7b24?source=collection_archive---------3-----------------------#2021-01-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="4e01" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我的<a class="ae kl" href="https://kubesphere.io/blogs/install-kubernetes-using-kubekey/" rel="noopener ugc nofollow" target="_blank">上一篇文章</a>中，我展示了如何使用<a class="ae kl" href="https://github.com/kubesphere/kubekey" rel="noopener ugc nofollow" target="_blank"> KubeKey </a>建立一个三节点Kubernetes集群。正如我在文章中提到的，KubeKey是一个轻量级的、功能强大的安装程序，它能够以一种快捷方便的方式安装Kubernetes及其相关的附加组件。事实上，KubeKey能做的远不止这些，因为它也是扩展Kubernetes集群的有效工具。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/df4757610a6cd993bd6d603078eb1926.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*egu8E37NIZOzrfX6Jye5cw.png"/></div></div></figure><p id="97d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在一些云平台上，您可以通过增加或减少节点数量来直接扩展集群。通常，这不需要复杂的操作，因为这些平台会为你做几乎所有的事情，你只需要点击几个按钮。但是，在某些本地环境中，您可能需要手动更改节点数量。在本文中，我将演示如何使用KubeKey在您的集群中进行横向扩展和纵向扩展。这些步骤如下所示:</p><ol class=""><li id="9038" class="ky kz iq jp b jq jr ju jv jy la kc lb kg lc kk ld le lf lg bi translated">下载KubeKey。</li><li id="0b0e" class="ky kz iq jp b jq lh ju li jy lj kc lk kg ll kk ld le lf lg bi translated">使用KubeKey通过自动创建的配置文件来检索集群信息。</li><li id="6300" class="ky kz iq jp b jq lh ju li jy lj kc lk kg ll kk ld le lf lg bi translated">验证群集信息，并应用配置来扩展群集。</li><li id="f166" class="ky kz iq jp b jq lh ju li jy lj kc lk kg ll kk ld le lf lg bi translated">在集群中扩展。</li></ol><h1 id="4fd3" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">准备主机</h1><p id="e328" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">这是我的现有Kubernetes集群的节点信息。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mp"><img src="../Images/2e452080689517bb4ce5205610ac3893.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I_a6A6VVPKcjTiouCINlPw.png"/></div></div></figure><pre class="kn ko kp kq gt mq mr ms mt aw mu bi"><span id="7447" class="mv ln iq mr b gy mw mx l my mz">$ kubectl get nodes<br/>NAME      STATUS   ROLES    AGE     VERSION<br/>master    Ready    master   9m50s   v1.17.9<br/>worker1   Ready    worker   9m19s   v1.17.9<br/>worker2   Ready    worker   9m20s   v1.17.9</span></pre><p id="d8fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是将首先添加到群集，然后从群集中删除的节点。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi na"><img src="../Images/2ee83220f1799fa032074cfda7bc5a57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zceOJl79cH5SlZMOTrGeMg.png"/></div></div></figure><p id="e02b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于节点、网络和依赖关系需求的更多信息，请参见我的上一篇文章。</p><h1 id="159b" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">下载KubeKey</h1><ol class=""><li id="73b6" class="ky kz iq jp b jq mk ju ml jy nb kc nc kg nd kk ld le lf lg bi translated">从其<a class="ae kl" href="https://github.com/kubesphere/kubekey/releases" rel="noopener ugc nofollow" target="_blank"> GitHub发布页面</a>下载KubeKey，或者使用以下命令下载KubeKey版本1.0.1。你只需要将KubeKey下载到你的一台机器上，作为<strong class="jp ir">任务盒</strong>进行伸缩，比如主节点。</li></ol><p id="22ba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ne nf ng mr b">curl -sfL https://get-kk.kubesphere.io | VERSION=v1.0.1 sh -</code></p><p id="fa34" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nh">注</em></p><p id="ccdf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nh">您可以在命令中更改版本号，以下载特定版本。</em></p><p id="0fad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.上面的命令下载KubeKey并解压文件。您的文件夹现在包含一个名为<code class="fe ne nf ng mr b">kk</code>的文件。使其可执行:</p><p id="bcc3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ne nf ng mr b">chmod +x kk</code></p><h1 id="379f" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">横向扩展集群</h1><ol class=""><li id="587f" class="ky kz iq jp b jq mk ju ml jy nb kc nc kg nd kk ld le lf lg bi translated">现在我已经准备好了KubeKey，我需要创建一个包含所有节点信息的配置文件，这与通过KubeKey设置Kubernetes集群是一样的。如果您的集群是通过KubeKey安装的，那么您的机器上可能仍然有那个配置文件。这种情况下可以直接编辑。否则，执行以下命令来检索集群信息。</li></ol><p id="19b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ne nf ng mr b">./kk create config --from-cluster</code></p><p id="c2d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">标志<code class="fe ne nf ng mr b">--from-cluster</code>用于获取退出集群的信息。</p><p id="e06f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.上面的命令创建了一个配置文件，默认情况下是<code class="fe ne nf ng mr b">sample.yaml</code>。打开文件，您可以看到一些字段已经预先填充了值。添加新节点的信息，并验证其他字段是否设置正确。</p><p id="59d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ne nf ng mr b">vi sample.yaml</code></p><pre class="kn ko kp kq gt mq mr ms mt aw mu bi"><span id="2f62" class="mv ln iq mr b gy mw mx l my mz">apiVersion: kubekey.kubesphere.io/v1alpha1<br/>kind: Cluster<br/>metadata:<br/>  name: sample<br/>spec:<br/>  hosts:<br/>  # You should complete the ssh information of the hosts<br/>  - {name: master, address: 192.168.0.2, internalAddress: 192.168.0.2, user: root, password: Testing123}<br/>  - {name: worker1, address: 192.168.0.3, internalAddress: 192.168.0.3, user: root, password: Testing123}<br/>  - {name: worker2, address: 192.168.0.4, internalAddress: 192.168.0.4, user: root, password: Testing123}<br/>  - {name: worker3, address: 192.168.0.5, internalAddress: 192.168.0.5, user: root, password: Testing123}<br/>  roleGroups:<br/>    etcd:<br/>    - master<br/>    master:<br/>    - master<br/>    worker:<br/>    - worker1<br/>    - worker2<br/>    - worker3<br/>  controlPlaneEndpoint:<br/>    # If loadbalancer was used, 'address' should be set to loadbalancer's ip.<br/>    domain: lb.kubesphere.local<br/>    address: ""<br/>    port: 6443<br/>  kubernetes:<br/>    version: v1.17.9<br/>    imageRepo: kubesphere<br/>    clusterName: cluster.local<br/>    proxyMode: ipvs<br/>    masqueradeAll: false<br/>    maxPods: 110<br/>    nodeCidrMaskSize: 24<br/>  network:<br/>    plugin: calico<br/>    kubePodsCIDR: 10.233.64.0/18<br/>    kubeServiceCIDR: 10.233.0.0/18<br/>  registry:<br/>    privateRegistry: ""</span></pre><p id="4088" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nh">注</em></p><p id="7192" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nh">添加新节点时，不允许修改现有节点(如master)的主机名。</em></p><p id="0e00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于配置文件中不同参数的更多信息，请参阅我的上一篇文章。</p><p id="65f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.保存文件并执行以下命令来应用配置:</p><p id="c39f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ne nf ng mr b">./kk add nodes -f sample.yaml</code></p><p id="38c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.缩放完成后，您可以看到如下输出。</p><p id="8761" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ne nf ng mr b">Congratulations! Scaling cluster is successful.</code></p><p id="16c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.执行以下命令来检查名称空间的状态。</p><p id="bc0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ne nf ng mr b">kubectl get pod --all-namespaces</code></p><pre class="kn ko kp kq gt mq mr ms mt aw mu bi"><span id="197f" class="mv ln iq mr b gy mw mx l my mz">NAMESPACE     NAME               READY   STATUS    RESTARTS   AGE<br/>kube-system   calico-kube<br/>             -controllers<br/>             -59d85c5c84-48dbg   1/1     Running   0          50m<br/>kube-system   calico<br/>             -node-8f9tr         1/1     Running   0          50m<br/>kube-system   calico<br/>             -node-ttl4c         1/1     Running   0          3m56s<br/>kube-system   calico<br/>             -node-wkfld         1/1     Running   0          50m<br/>kube-system   calico<br/>             -node-x9ks2         1/1     Running   0          50m<br/>kube-system   coredns<br/>             -74d59cc5c6<br/>             -6jszk              1/1     Running   0          50m<br/>kube-system   coredns<br/>              -74d59cc5c6<br/>              -mzcxp             1/1     Running   0          50m<br/>kube-system   kube-apiserver<br/>              -master            1/1     Running   0          50m<br/>kube-system   kube-controller<br/>              -manager-master    1/1     Running   0          50m<br/>kube-system   kube-proxy<br/>              -fw5cf             1/1     Running   0          50m<br/>kube-system   kube-proxy<br/>              -qrv5p             1/1     Running   0          50m<br/>kube-system   kube-proxy<br/>              -r82sh             1/1     Running   0          3m56s<br/>kube-system   kube-proxy<br/>              -v4rnf             1/1     Running   0          50m<br/>kube-system   kube-scheduler<br/>              -master            1/1     Running   0          50m<br/>kube-system   nodelocaldns<br/>              -4wfsv             1/1     Running   0          3m56s<br/>kube-system   nodelocaldns<br/>              -fbsbl             1/1     Running   0          50m<br/>kube-system   nodelocaldns<br/>              -mzpvt             1/1     Running   0          50m<br/>kube-system   nodelocaldns<br/>              -zj5jz             1/1     Running   0          50m</span></pre><p id="1a15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">6.执行以下命令检查您的节点。</p><p id="9e92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ne nf ng mr b">kubectl get nodes</code></p><pre class="kn ko kp kq gt mq mr ms mt aw mu bi"><span id="7643" class="mv ln iq mr b gy mw mx l my mz">NAME      STATUS   ROLES    AGE     VERSION<br/>master    Ready    master   52m     v1.17.9<br/>worker1   Ready    worker   51m     v1.17.9<br/>worker2   Ready    worker   51m     v1.17.9<br/>worker3   Ready    worker   5m12s   v1.17.9</span></pre><p id="5fe9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如您在上面看到的，所有节点都已启动并运行。</p><h1 id="8c08" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">在集群中扩展</h1><ol class=""><li id="6b49" class="ky kz iq jp b jq mk ju ml jy nb kc nc kg nd kk ld le lf lg bi translated">要删除一个节点，还需要提前准备一个配置文件。如果你直接跳到这一步，或者你还没有下载KubeKey，参考上面的内容下载KubeKey，检索你的集群信息。之后，编辑配置文件。</li></ol><p id="5ee3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ne nf ng mr b">vi sample.yaml</code></p><p id="e8f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.仔细检查是否所有字段都设置正确，如有必要进行更改，然后保存文件。</p><pre class="kn ko kp kq gt mq mr ms mt aw mu bi"><span id="d76e" class="mv ln iq mr b gy mw mx l my mz">apiVersion: kubekey.kubesphere.io/v1alpha1<br/>kind: Cluster<br/>metadata:<br/>  name: sample<br/>spec:<br/>  hosts:<br/>  # You should complete the ssh information of the hosts<br/>  - {name: master, address: 192.168.0.2, internalAddress: 192.168.0.2, user: root, password: Testing123}<br/>  - {name: worker1, address: 192.168.0.3, internalAddress: 192.168.0.3, user: root, password: Testing123}<br/>  - {name: worker2, address: 192.168.0.4, internalAddress: 192.168.0.4, user: root, password: Testing123}<br/>  - {name: worker3, address: 192.168.0.5, internalAddress: 192.168.0.5, user: root, password: Testing123}<br/>  roleGroups:<br/>    etcd:<br/>    - master<br/>    master:<br/>    - master<br/>    worker:<br/>    - worker1<br/>    - worker2<br/>    - worker3<br/>  controlPlaneEndpoint:<br/>    # If loadbalancer was used, 'address' should be set to loadbalancer's ip.<br/>    domain: lb.kubesphere.local<br/>    address: ""<br/>    port: 6443<br/>  kubernetes:<br/>    version: v1.17.9<br/>    imageRepo: kubesphere<br/>    clusterName: cluster.local<br/>    proxyMode: ipvs<br/>    masqueradeAll: false<br/>    maxPods: 110<br/>    nodeCidrMaskSize: 24<br/>  network:<br/>    plugin: calico<br/>    kubePodsCIDR: 10.233.64.0/18<br/>    kubeServiceCIDR: 10.233.0.0/18<br/>  registry:<br/>    privateRegistry: ""</span></pre><p id="dbb5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.执行以下命令在集群中进行扩展(在本例中删除了<code class="fe ne nf ng mr b">worker3</code>)。</p><p id="e189" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ne nf ng mr b">./kk delete node &lt;nodeName&gt; -f sample.yaml</code></p><p id="f0f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nh">注</em></p><p id="9cf8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nh">用自己的节点名替换</em> <code class="fe ne nf ng mr b"><em class="nh">&lt;nodeName&gt;</em></code> <em class="nh">。</em></p><p id="fe99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.执行以下命令来验证结果。</p><p id="01f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ne nf ng mr b">kubectl get nodes</code></p><pre class="kn ko kp kq gt mq mr ms mt aw mu bi"><span id="4309" class="mv ln iq mr b gy mw mx l my mz">NAME      STATUS   ROLES    AGE    VERSION<br/>master    Ready    master   3h7m   v1.17.9<br/>worker1   Ready    worker   3h6m   v1.17.9<br/>worker2   Ready    worker   3h7m   v1.17.9</span></pre><p id="4a84" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.您可以看到节点(<code class="fe ne nf ng mr b">worker3</code>)已被成功移除。</p><h1 id="9914" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">摘要</h1><p id="11bc" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">添加和删除节点仍然是集群维护的重要部分。实际上，您需要根据集群上运行的实际工作负载来调整节点数量，以获得最佳的资源利用率。幸运的是，KubeKey是这方面最有效的工具之一。</p><h1 id="a6ef" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">参考</h1><p id="c0c4" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">库伯基</p><p id="2fa5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://kubesphere.io/docs/installing-on-linux/introduction/multioverview/" rel="noopener ugc nofollow" target="_blank">多节点安装</a></p><p id="2993" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://kubesphere.io/blogs/install-kubernetes-using-kubekey/" rel="noopener ugc nofollow" target="_blank">kube key:Kubernetes和云原生插件的轻量级安装程序</a></p></div></div>    
</body>
</html>