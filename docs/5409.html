<html>
<head>
<title>Flutter Web: OAuth authentication through external window</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Flutter Web:通过外部窗口进行OAuth认证</h1>
<blockquote>原文：<a href="https://itnext.io/flutter-web-oauth-authentication-through-external-window-d890a7ff6463?source=collection_archive---------2-----------------------#2021-02-27">https://itnext.io/flutter-web-oauth-authentication-through-external-window-d890a7ff6463?source=collection_archive---------2-----------------------#2021-02-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="dd5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">几天前我发表了这篇文章:</p><div class="kl km gp gr kn ko"><a href="https://rouxguillaume.medium.com/flutter-web-twitch-oauth2-authentication-flow-implementation-77d239c72be5" rel="noopener follow" target="_blank"><div class="kp ab fo"><div class="kq ab kr cl cj ks"><h2 class="bd ir gy z fp kt fr fs ku fu fw ip bi translated">Flutter Web: Twitch OAuth2认证流程实现</h2><div class="kv l"><h3 class="bd b gy z fp kt fr fs ku fu fw dk translated">目前在Flutter Web上很难实现OAuth2这样的认证流程。困难之一是…</h3></div><div class="kw l"><p class="bd b dl z fp kt fr fs ku fu fw dk translated">rouxguillaume.medium.com</p></div></div><div class="kx l"><div class="ky l kz la lb kx lc ld ko"/></div></div></a></div><p id="80a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然它可能对一些读者有所帮助，但我发现了一种更好的方法来管理Flutter Web上的身份验证。感谢我的朋友兼同事<a class="le lf ep" href="https://medium.com/u/60b78a4555bb?source=post_page-----d890a7ff6463--------------------------------" rel="noopener" target="_blank">mem .</a>的帮助。</p><p id="7bdd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通常，当您使用第三方服务在网站或web应用程序上进行身份验证时，您会通过外部窗口连接您的帐户。这个过程避免了在重定向后重新加载你所在的网站。这是我在上一篇文章中描述的方法所隐含的主要问题。</p><p id="c044" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，今天让我们解决这个问题，并使用外部身份验证窗口实现OAuth2流。仍然是通过使用Twitch的API，这样跟随前一篇文章的人就不会太迷茫。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/4995fea60520d12bd3fab7221446e98b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KynSC42Wrt_T_MdkYbxYfA.png"/></div></div></figure><h1 id="907a" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">先决条件</h1><ul class=""><li id="cff8" class="mp mq iq jp b jq mr ju ms jy mt kc mu kg mv kk mw mx my mz bi translated">创建您的初始颤振应用程序</li><li id="18d9" class="mp mq iq jp b jq na ju nb jy nc kc nd kg ne kk mw mx my mz bi translated">一个有效的Twitch和Twitch开发者账户</li><li id="9692" class="mp mq iq jp b jq na ju nb jy nc kc nd kg ne kk mw mx my mz bi translated">一些基本的HTML和JS知识</li></ul><h1 id="2747" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">建立</h1><p id="2579" class="pw-post-body-paragraph jn jo iq jp b jq mr js jt ju ms jw jx jy nf ka kb kc ng ke kf kg nh ki kj kk ij bi translated">在我们开始编码之前，让我解释一下我们的认证流程。我们将在一个新窗口中打开Twitch认证URL，方法是将我们的<code class="fe ni nj nk nl b">client_id</code>和<code class="fe ni nj nk nl b">redirect_uri</code>作为参数传入URL。与前一篇文章相比，主要的区别是我们的<code class="fe ni nj nk nl b">redirect_uri</code>不会在认证过程之后重定向到我们的应用程序，而是重定向到一个静态的HTML页面，这个页面的唯一目的是将我们正在寻找的数据发送到我们的主应用程序窗口。在这种情况下，它将是我们的URL中包含的OAuth令牌。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi nm"><img src="../Images/0737406510e43e1f147acbeba03ef8b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sva8efiAVXYCmW-NM1BQ8w.png"/></div></div></figure><p id="2192" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就代码而言，我们想要完成的操作有:</p><ul class=""><li id="5e91" class="mp mq iq jp b jq jr ju jv jy nn kc no kg np kk mw mx my mz bi translated">在<strong class="jp ir">外部窗口</strong>中打开<strong class="jp ir"> Twitch认证页面</strong></li><li id="b73d" class="mp mq iq jp b jq na ju nb jy nc kc nd kg ne kk mw mx my mz bi translated">认证后<strong class="jp ir">重定向到</strong>我们的<strong class="jp ir">静态页面</strong></li><li id="8670" class="mp mq iq jp b jq na ju nb jy nc kc nd kg ne kk mw mx my mz bi translated"><strong class="jp ir">将包含认证令牌的URL从我们的<strong class="jp ir">静态页面</strong>发送到<strong class="jp ir">主页面</strong></strong></li><li id="8f55" class="mp mq iq jp b jq na ju nb jy nc kc nd kg ne kk mw mx my mz bi translated">在我们的<strong class="jp ir">主页</strong>中捕捉令牌</li><li id="02cc" class="mp mq iq jp b jq na ju nb jy nc kc nd kg ne kk mw mx my mz bi translated">关闭<strong class="jp ir">外部窗口</strong></li></ul><h1 id="f84e" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">创建我们的静态页面</h1><p id="d232" class="pw-post-body-paragraph jn jo iq jp b jq mr js jt ju ms jw jx jy nf ka kb kc ng ke kf kg nh ki kj kk ij bi translated">在尝试打开外部窗口之前，首先要做的是创建我们将要重定向到的静态HTML页面。</p><p id="5ca8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是您必须在<code class="fe ni nj nk nl b">web/</code>文件夹中创建的<code class="fe ni nj nk nl b">static.html</code>页面的代码:</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nq nr l"/></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated">static.html</figcaption></figure><p id="c707" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它基本上是一个空的HTML页面，重要的部分在<code class="fe ni nj nk nl b">&lt;script&gt;</code>里面。为了能够发送包含认证令牌的页面URL，我们使用了方法<code class="fe ni nj nk nl b">postMessage()</code>，它允许我们通过<code class="fe ni nj nk nl b">window.opener</code>引用(<a class="ae nw" href="https://developer.mozilla.org/fr/docs/Web/API/Window/postMessage" rel="noopener ugc nofollow" target="_blank"> Window.postMessage doc </a>)与主窗口进行通信。我们正在发送包含令牌的URL<code class="fe ni nj nk nl b">window.location.href</code>。</p><h1 id="aa13" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">打开外部窗口</h1><p id="8f2a" class="pw-post-body-paragraph jn jo iq jp b jq mr js jt ju ms jw jx jy nf ka kb kc ng ke kf kg nh ki kj kk ij bi translated">现在你可能会问，如何打开外部窗口？这其实很简单，因为我们在<code class="fe ni nj nk nl b">dart:html</code>库中有一个抽象:</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="0f5f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，要打开我们的外部窗口，我们调用方法<code class="fe ni nj nk nl b">window.open</code>并添加<code class="fe ni nj nk nl b">width</code>和<code class="fe ni nj nk nl b">height</code>选项，这样它将打开一个新窗口，而不是一个标签。我们将窗口的引用保存在我们的<code class="fe ni nj nk nl b">_popupWin</code>变量中，这样我们将能够在收到访问令牌后通过编程关闭它。</p><p id="fc64" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">剩下唯一要做的就是添加一个监听器来获取我们的外部窗口发送的消息。</p><h1 id="daa0" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">听留言</h1><p id="4520" class="pw-post-body-paragraph jn jo iq jp b jq mr js jt ju ms jw jx jy nf ka kb kc ng ke kf kg nh ki kj kk ij bi translated">Dart又一次做得很好，因为我们对消息侦听进行了抽象:</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="0ea0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如你在这里看到的，我们依靠<code class="fe ni nj nk nl b">window.onMessage</code>从静态页面中监听<code class="fe ni nj nk nl b">postMessage</code>。重要的是要事先检查收到的事件是否包含<code class="fe ni nj nk nl b">access_token</code>，因为Twitch登录本身会发送一条消息来确认身份验证成功。你只需要解析你的URL，这里有一个工作示例，但是你可以按照你想要的方式来做。</p><p id="dac5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了结束我们的认证流程，我们使用之前保存的参考<code class="fe ni nj nk nl b">_popupWin</code>关闭窗口。</p><h1 id="52fd" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">结论</h1><p id="afd4" class="pw-post-body-paragraph jn jo iq jp b jq mr js jt ju ms jw jx jy nf ka kb kc ng ke kf kg nh ki kj kk ij bi translated">这就是了！我希望这些步骤是清楚的，并且你已经全部理解了。对于前一篇文章，这应该适用于任何OAuth2流。这以一种更“web”的方式工作，不需要完全重新加载应用程序。这是我最后一次就Flutter Web中的认证问题打扰你，因为我认为这个解决方案更加最终和可用。</p><p id="b373" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果这篇文章对你有帮助，请不要犹豫留下评论，分享它或鼓掌，这样它可能会帮助更多的人。</p><p id="7d26" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一如既往，这里是我的文章所基于的源代码:</p><div class="kl km gp gr kn ko"><a href="https://github.com/TesteurManiak/flutter_web_twitch_auth/tree/use-external-win" rel="noopener  ugc nofollow" target="_blank"><div class="kp ab fo"><div class="kq ab kr cl cj ks"><h2 class="bd ir gy z fp kt fr fs ku fu fw ip bi translated">TesteurManiak/flutter _ web _ twitch _ auth</h2><div class="kv l"><h3 class="bd b gy z fp kt fr fs ku fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="kw l"><p class="bd b dl z fp kt fr fs ku fu fw dk translated">github.com</p></div></div><div class="kx l"><div class="nx l kz la lb kx lc ld ko"/></div></div></a></div></div></div>    
</body>
</html>