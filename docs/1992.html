<html>
<head>
<title>Create a Highly Scalable Image Processing Service on AWS Lambda and API Gateway in 10 Minutes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">10分钟内在AWS Lambda和API Gateway上创建高度可扩展的图像处理服务</h1>
<blockquote>原文：<a href="https://itnext.io/create-a-highly-scalable-image-processing-service-on-aws-lambda-and-api-gateway-in-10-minutes-7cbb2893a479?source=collection_archive---------0-----------------------#2019-03-10">https://itnext.io/create-a-highly-scalable-image-processing-service-on-aws-lambda-and-api-gateway-in-10-minutes-7cbb2893a479?source=collection_archive---------0-----------------------#2019-03-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/88a6baaf33ed5485fdaf51c4ef949cb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MaPZpZaz0vo4XcRtIb0WNg.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">由<a class="ae kc" href="https://unsplash.com/photos/wh-RPfR_3_M?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">阿里安·达尔维什</a>在<a class="ae kc" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="6732" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">如今，我正在写</em> <a class="ae kc" href="https://themirrorworld.substack.com" rel="noopener ugc nofollow" target="_blank"> <em class="lb">子栈</em> </a> <em class="lb">。</em></p><p id="b2d6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像所有的无服务器文章一样，我需要从解释什么是无服务器开始这篇文章。</p><blockquote class="lc ld le"><p id="3f46" class="kd ke lb kf b kg kh ki kj kk kl km kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated">无服务器不是无服务器，只是在想服务器，少一些。</p></blockquote><p id="59d8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，让我们来看看如何让一个简单的Python 3.6应用程序运行它</p><ul class=""><li id="2263" class="li lj iq kf b kg kh kk kl ko lk ks ll kw lm la ln lo lp lq bi translated">将输入照片转换为黑白照片</li><li id="6d12" class="li lj iq kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">具有OpenCV Python依赖性</li></ul><p id="b364" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">可通过API访问，该API</em></p><ul class=""><li id="9a59" class="li lj iq kf b kg kh kk kl ko lk ks ll kw lm la ln lo lp lq bi translated">接受二进制数据负载(jpeg)</li><li id="b8ff" class="li lj iq kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">返回二进制数据负载(jpeg)</li></ul><p id="a00d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">全无</em></p><ul class=""><li id="cdf7" class="li lj iq kf b kg kh kk kl ko lk ks ll kw lm la ln lo lp lq bi translated">设置服务器</li><li id="3d45" class="li lj iq kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">支付费用*</li></ul><p id="fb52" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">*除非你的流量超过</em> <a class="ae kc" href="https://aws.amazon.com/lambda/pricing/" rel="noopener ugc nofollow" target="_blank"> <em class="lb">慷慨λ免费定价tier </em> </a> <em class="lb">。</em></p><p id="c1c1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先确保你已经安装了<a class="ae kc" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker </a>。</p><p id="cb25" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于这个例子，我们将使用AWS的一个名为<a class="ae kc" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> Lambda </a>的服务，它允许我们部署我们的功能及其依赖项，并轻松地将其连接到API。为了创建API，我们将使用<a class="ae kc" href="https://aws.amazon.com/api-gateway/" rel="noopener ugc nofollow" target="_blank"> API网关</a>——也是由AWS提供的服务。</p><p id="9a7b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了简化本教程，我们将通过AWS Web控制台将代码上传到Lambda来部署代码。为了简单起见，我们还将在AWS控制台中编写函数代码。在任何严重的情况下，您都可以通过<a class="ae kc" href="https://aws.amazon.com/cli/" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a>进行部署。</p><ol class=""><li id="85b7" class="li lj iq kf b kg kh kk kl ko lk ks ll kw lm la lw lo lp lq bi translated">首先登录AWS控制台，搜索<strong class="kf ir"> Lambda。</strong></li></ol><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lx"><img src="../Images/8f5bf0976e163c27cedf69aaabd668bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pUeIwh6R3hF6fevkbPhcDA.jpeg"/></div></div></figure><p id="31bf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">2.点击<strong class="kf ir">创建功能</strong>。</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lx"><img src="../Images/56be3a88c36d9a1b6b5106534d231b40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LNv10D4yh4_K5uVVIA3c1g.jpeg"/></div></div></figure><p id="00cc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">3.设置功能参数。我们将我们的函数命名为<code class="fe mc md me mf b">lambda-demo</code>。确保选择<code class="fe mc md me mf b">Python 3.6</code>作为运行时，并从AWS策略模板创建一个新角色。</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/d027aa9c2684f9ce6c5d168ebead161b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W9shEIExX1OkB9ArI2fFZg.jpeg"/></div></div></figure><p id="effc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">4.创建函数后，Lambda控制台会给你一些模板代码。</p><pre class="ly lz ma mb gt mh mf mi mj aw mk bi"><span id="4623" class="ml mm iq mf b gy mn mo l mp mq">import json</span><span id="6edf" class="ml mm iq mf b gy mr mo l mp mq">def lambda_handler(event, context):<br/>    # TODO implement<br/>    return {<br/>        'statusCode': 200,<br/>        'body': json.dumps('Hello from Lambda!')<br/>    }</span></pre><p id="e1bb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以通过配置一个测试事件来立即调用这个函数。点击<strong class="kf ir">测试</strong>并配置第一个测试事件。出于本文的目的，默认模板工作良好。</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/aaad48a0897e9628b2afe3ccdd86a9c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OmWg7w-Z13wt0tAx4u3hOQ.jpeg"/></div></div></figure><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/6caf1a05166c779492670e599323bf2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s0wapJ9pN6_hvFvOFgnd7A.jpeg"/></div></div></figure><p id="6a72" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建测试事件后，点击<strong class="kf ir">测试</strong>。您应该会在函数日志中收到以下内容:</p><pre class="ly lz ma mb gt mh mf mi mj aw mk bi"><span id="26c3" class="ml mm iq mf b gy mn mo l mp mq">{<br/>  "statusCode": 200,<br/>  "body": "\"Hello from Lambda!\""<br/>}</span></pre><p id="6aae" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">太棒了。</p></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><p id="3bef" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们创建一些比这更有用的东西。</p><p id="647c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们构建一个将图像作为输入并将其转换为灰度的函数。为此，我们将使用<a class="ae kc" href="https://opencv.org/" rel="noopener ugc nofollow" target="_blank"> OpenCV </a>，特别是它的Python绑定。虽然使用OpenCV对于这样一个任务来说可能有些过头了，但是它演示了如何相对容易地将这样一个有用的库包含到您的Lambda环境中。</p><p id="f4aa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们现在会的</p><ol class=""><li id="6aea" class="li lj iq kf b kg kh kk kl ko lk ks ll kw lm la lw lo lp lq bi translated">为OpenCV生成一个Lambda就绪的Python包。</li><li id="a3ed" class="li lj iq kf b kg lr kk ls ko lt ks lu kw lv la lw lo lp lq bi translated">将这个包上传到Lambda层，这样它就可以用在你构建的任何函数中。</li><li id="77a2" class="li lj iq kf b kg lr kk ls ko lt ks lu kw lv la lw lo lp lq bi translated">将OpenCV导入我们的Lambda函数。</li></ol><h2 id="0157" class="ml mm iq bd mz na nb dn nc nd ne dp nf ko ng nh ni ks nj nk nl kw nm nn no np bi translated">1.为OpenCV生成Lambda就绪的Python包</h2><p id="e30b" class="pw-post-body-paragraph kd ke iq kf b kg nq ki kj kk nr km kn ko ns kq kr ks nt ku kv kw nu ky kz la ij bi translated">我组装了一个非常简单的工具——一个Docker镜像，它可以收集任何<code class="fe mc md me mf b">pip</code>包并生成一个. ZIP文件，我们可以上传到Lambda层。如果你想探索这个工具，你可以从<a class="ae kc" href="https://github.com/tiivik/LambdaZipper" rel="noopener ugc nofollow" target="_blank"> LambdaZipper </a>中找到它。</p><p id="dbcc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你安装了Docker，你可以打开你的终端并运行</p><pre class="ly lz ma mb gt mh mf mi mj aw mk bi"><span id="3793" class="ml mm iq mf b gy mn mo l mp mq">docker run --rm -v $(pwd):/package tiivik/lambdazipper opencv-python</span></pre><p id="6934" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就是这样！在您当前的工作目录中，您会找到<code class="fe mc md me mf b">opencv-python.zip</code></p><p id="5897" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">最有用的无服务器工具包之一是</em> <a class="ae kc" href="http://serverless.com" rel="noopener ugc nofollow" target="_blank"> <em class="lb">无服务器</em> </a> <em class="lb">。然而，我们不打算在这个例子中使用它。重新发明轮子很少是一个好主意，除非你想知道引擎盖下的东西是如何工作的。虽然成熟的框架如</em> <a class="ae kc" href="http://serverless.com" rel="noopener ugc nofollow" target="_blank"> <em class="lb">无服务器</em> </a> <em class="lb">已经存在，但是深入研究这些框架抽象的一些核心功能是一个好主意。</em></p><p id="cb49" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们探索一下这个工具从我们身上抽象出了什么。</p><p id="0621" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你看一下<a class="ae kc" href="https://github.com/tiivik/LambdaZipper/blob/master/package.sh" rel="noopener ugc nofollow" target="_blank"> package.sh </a>，那么你可以看到它执行了一个带有<code class="fe mc md me mf b">opencv-python</code>参数的<code class="fe mc md me mf b">pip install</code>命令。所有这些都是在<code class="fe mc md me mf b">amazonlinux:2017.03</code>环境中执行的，这在某种程度上模仿了AWS Lambda环境。您可以在<a class="ae kc" href="https://github.com/tiivik/LambdaZipper/blob/master/Dockerfile" rel="noopener ugc nofollow" target="_blank">docker文件</a>中探索执行环境。</p><h2 id="4c12" class="ml mm iq bd mz na nb dn nc nd ne dp nf ko ng nh ni ks nj nk nl kw nm nn no np bi translated">2.将包上传到Lambda层，这样它就可以用在你构建的任何函数中</h2><p id="e0fc" class="pw-post-body-paragraph kd ke iq kf b kg nq ki kj kk nr km kn ko ns kq kr ks nt ku kv kw nu ky kz la ij bi translated">让我们把<code class="fe mc md me mf b">opencv-python.zip</code>上传到Lambda层，这样我们就可以从现在开始在我们所有的函数中使用这个包了。将层视为可以在您编写的任何函数中使用的数据。这可以是Python模块、代码片段、二进制文件或任何东西。</p><p id="e472" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">导航到AWS Lambda中的<strong class="kf ir">层</strong>面板，并按<strong class="kf ir">创建层</strong>。</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/e59057a29ffecb2f240062df25590640.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rIMPNm10C6MISBHXCWw6CQ.jpeg"/></div></div></figure><p id="8983" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">设置图层名称、描述并上传zip文件。确保选择正确的运行时，在我们的例子中是Python 3.6。按下<strong class="kf ir">创建图层</strong>。</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/b34526860434be970cb0c0292b71c884.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gO3R73_-QiXSRKywDnQhvw.jpeg"/></div></div></figure><p id="b598" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在撰写本文时，从web界面上传ZIP文件被限制在50MB以内。幸运的是我们的<code class="fe mc md me mf b">opencv-python</code>套餐比那个少。如果你的包超过了，你可以提供一个S3桶的链接包。请记住，Lambda将部署包限制设置为250MB。</p><p id="5493" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建函数后，您应该会看到一条消息</p><p id="45b6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mc md me mf b">Successfully created layer opencv-python version 1.</code></p><p id="8f44" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">耶！</p><p id="f035" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们回到我们的<code class="fe mc md me mf b">lambda-demo</code>函数，并将<code class="fe mc md me mf b">opencv-python</code>层添加到我们的函数执行环境中。点击<strong class="kf ir">图层</strong> &gt; <strong class="kf ir">添加一个图层</strong>并选择你的<code class="fe mc md me mf b">opencv-python</code>图层。</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/b25fc5172bbc6f5273360a8694c54e55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*scXsBGEP-aVElqQ6oHoKbA.jpeg"/></div></div></figure><h2 id="b919" class="ml mm iq bd mz na nb dn nc nd ne dp nf ko ng nh ni ks nj nk nl kw nm nn no np bi translated">3.导入OpenCV</h2><p id="61ee" class="pw-post-body-paragraph kd ke iq kf b kg nq ki kj kk nr km kn ko ns kq kr ks nt ku kv kw nu ky kz la ij bi translated">让我们像往常一样尝试导入库:</p><pre class="ly lz ma mb gt mh mf mi mj aw mk bi"><span id="b55a" class="ml mm iq mf b gy mn mo l mp mq">import json<br/><strong class="mf ir">import cv2</strong></span><span id="3f10" class="ml mm iq mf b gy mr mo l mp mq">def lambda_handler(event, context):<br/>    # TODO implement<br/>    return {<br/>        'statusCode': 200,<br/>        'body': json.dumps('Hello from Lambda!')<br/>    }</span></pre><p id="3c68" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们点击<strong class="kf ir">测试</strong>。我们得到的回应是:</p><pre class="ly lz ma mb gt mh mf mi mj aw mk bi"><span id="ac8a" class="ml mm iq mf b gy mn mo l mp mq">Response:<br/>{<br/>  "errorMessage": "Unable to import module 'lambda_function'"<br/>}</span></pre><p id="c926" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">出于某种原因，Lambda无法找到我们的Python包。我们来探索一下。</p><p id="87aa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">默认情况下，所有Lambda层都安装在<code class="fe mc md me mf b">/opt</code>上。让我们注释掉我们的<code class="fe mc md me mf b">cv2</code>导入，看看<code class="fe mc md me mf b">/opt</code>里面有什么。</p><pre class="ly lz ma mb gt mh mf mi mj aw mk bi"><span id="3098" class="ml mm iq mf b gy mn mo l mp mq">import json<br/><strong class="mf ir">#import cv2</strong><br/><strong class="mf ir">from os import listdir</strong></span><span id="8ee6" class="ml mm iq mf b gy mr mo l mp mq">def lambda_handler(event, context):<br/>    # TODO implement<br/>    <strong class="mf ir">print(listdir("/opt"))</strong><br/>    return {<br/>        'statusCode': 200,<br/>        'body': json.dumps('Hello from Lambda!')<br/>    }</span></pre><p id="3854" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在功能日志中，我们可以看到<code class="fe mc md me mf b">/opt</code>中的<code class="fe mc md me mf b">cv2</code>模块。</p><pre class="ly lz ma mb gt mh mf mi mj aw mk bi"><span id="3454" class="ml mm iq mf b gy mn mo l mp mq">[‘bin’, ‘cv2’, ‘numpy’, ‘numpy-1.16.2.dist-info’, ‘opencv_python-4.0.0.21.dist-info’]</span></pre><p id="342d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">默认情况下<code class="fe mc md me mf b">/opt/bin</code> <strong class="kf ir"> </strong>被添加到<code class="fe mc md me mf b">$PATH</code> <strong class="kf ir"> </strong>环境变量中。你可以参考<a class="ae kc" href="https://docs.aws.amazon.com/lambda/latest/dg/current-supported-versions.html" rel="noopener ugc nofollow" target="_blank"> AWS文档</a>。然而我们的层模块存在于<code class="fe mc md me mf b">/opt/</code> <strong class="kf ir"> </strong>而不存在于<strong class="kf ir"> </strong> <code class="fe mc md me mf b">/opt/bin</code>。因此，让我们将<code class="fe mc md me mf b">/opt</code>也包含到<code class="fe mc md me mf b">$PATH</code>中，这样Lambda就可以看到我们的包。</p><p id="ea63" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在环境变量部分，添加以下环境变量。键:<code class="fe mc md me mf b">PYTHONPATH</code>值:<code class="fe mc md me mf b">/opt/</code></p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/8bce1733b35cf991be9e4e044ba4418a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gx34NrfTVms9UvyBFVb8bA.jpeg"/></div></div></figure><p id="d8e0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通常你可以直接导入包而不改变路径，但是在这种情况下，Lambda环境需要检测我们的包。</p><p id="2019" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们修改我们的代码:</p><pre class="ly lz ma mb gt mh mf mi mj aw mk bi"><span id="b07c" class="ml mm iq mf b gy mn mo l mp mq">import json<br/><strong class="mf ir">import cv2</strong></span><span id="38bf" class="ml mm iq mf b gy mr mo l mp mq">def lambda_handler(event, context):<br/>    # TODO implement<br/>    <strong class="mf ir">print(cv2.__version__)</strong><br/>    return {<br/>        'statusCode': 200,<br/>        'body': json.dumps('Hello from Lambda!')<br/>    }</span></pre><p id="1343" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">保存您的更改并点击<strong class="kf ir">测试</strong>。控制台中出现了<code class="fe mc md me mf b">4.0.0</code>，通知我们使用的OpenCV版本。</p><p id="0325" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">太棒了，Python OpenCV在Lambda中运行！</p></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><p id="32d7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们继续实现核心应用程序逻辑——将图像转换成灰度。让我们修改我们的Lambda函数代码:</p><pre class="ly lz ma mb gt mh mf mi mj aw mk bi"><span id="17ef" class="ml mm iq mf b gy mn mo l mp mq">import json<br/>import cv2<br/>import base64</span><span id="4dec" class="ml mm iq mf b gy mr mo l mp mq">def write_to_file(save_path, data):<br/>  with open(save_path, "wb") as f:<br/>    f.write(base64.b64decode(data))</span><span id="3432" class="ml mm iq mf b gy mr mo l mp mq">def lambda_handler(event, context):<br/>    # Write request body data into file<br/>    write_to_file("/tmp/photo.jpg", event["body"])<br/>    <br/>    # Read the image<br/>    image = cv2.imread("/tmp/photo.jpg")<br/>    <br/>    # Convert to grayscale<br/>    gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)<br/>    <br/>    # Write grayscale image to /tmp<br/>    cv2.imwrite("/tmp/gray.jpg", gray)<br/>    <br/>    # Convert grayscale image into utf-8 encoded base64<br/>    with open("/tmp/gray.jpg", "rb") as imageFile:<br/>      str = base64.b64encode(imageFile.read())<br/>      encoded_img = str.decode("utf-8")<br/>    <br/>    # Return the data to API Gateway in base64.<br/>    # API Gateway will handle the conversion back to binary.<br/>    # Set content-type header as image/jpeg.<br/>    <br/>    return {<br/>      "isBase64Encoded": True,<br/>      "statusCode": 200,<br/>      "headers": { "content-type": "image/jpeg"},<br/>      "body":  encoded_img<br/>    }</span></pre><p id="f5f3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们马上要设置的API将接受来自客户端的二进制图像。然后，AWS API Gateway将二进制图像转换为base64格式，并传递给Lambda。</p><p id="60c8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当然，API网关还没有设置，所以用我们当前的测试来测试这段代码将会失败。然而，在我们开始设置调用这个Lambda的API之前，我们可以在Lambda控制台中测试它，方法是在事件体中提供一个base64编码的图像。</p><p id="0486" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">用该机体重新配置<strong class="kf ir">测试</strong>。如果你想知道，这是一张base64编码的猫照片😺<a class="ae kc" href="https://imgur.com/a/0NpkzzL" rel="noopener ugc nofollow" target="_blank">https://imgur.com/a/0NpkzzL</a></p><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="nw nx l"/></div></figure><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/7182583157f4b2dca602fe967379537c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JqpIPxFdGviyOoTYdMzsUw.png"/></div></div></figure><p id="654c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">调用这个测试现在应该成功了:</p><pre class="ly lz ma mb gt mh mf mi mj aw mk bi"><span id="62ef" class="ml mm iq mf b gy mn mo l mp mq">Response:<br/>{<br/>  "isBase64Encoded": true,<br/>  "statusCode": 200,<br/>  "headers": {<br/>    "content-type": "image/jpeg"<br/>  },<br/>  "body": "/9j/4AJRgAB.....P+WqHNf//Z" <strong class="mf ir">&lt;- long base64 string of black and white image here</strong><br/>}</span></pre><p id="460e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们现在准备设置一个调用这个Lambda函数的API。</p><h2 id="dd7f" class="ml mm iq bd mz na nb dn nc nd ne dp nf ko ng nh ni ks nj nk nl kw nm nn no np bi translated">设置API</h2><p id="ddb1" class="pw-post-body-paragraph kd ke iq kf b kg nq ki kj kk nr km kn ko ns kq kr ks nt ku kv kw nu ky kz la ij bi translated">打开AWS API网关控制台。按下<strong class="kf ir">创建API </strong>。</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/10d8565b7e39c8cfd56091ed6379bcb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G6_SjSLSvM_t08rLV13w2A.jpeg"/></div></div></figure><p id="1f8c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建一个新的<strong class="kf ir"> REST </strong> API，提供API名称和描述。在本例中，我们调用我们的API <code class="fe mc md me mf b">lambda-demo</code>。</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/12006ff7324c6d5bfc850b89f8210c68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ajG0hfH1Go3RiTuDYwKj_Q.jpeg"/></div></div></figure><p id="5e65" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从<strong class="kf ir">资源</strong> &gt; <strong class="kf ir">动作</strong>中选择<strong class="kf ir">创建方法</strong>并定义一个<strong class="kf ir">发布</strong>方法。</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/05ba79818b1fca3cd9084446b9504006.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2NaNrGpIIdm1Ji7UC-q6zg.jpeg"/></div></div></figure><p id="2b36" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于<strong class="kf ir">集成类型</strong>，选择<strong class="kf ir"> Lambda函数</strong>并从下拉菜单中选择您的Lambda函数。启用<strong class="kf ir">使用Lambda代理集成</strong>并点击<strong class="kf ir">保存</strong>。</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/1bafce3ccb9201f802b2ffedb213d672.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R-Q5aK09p-bkiQw48DFULg.jpeg"/></div></div></figure><p id="6872" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们希望我们的API能够处理二进制数据。</p><p id="7070" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从<strong class="kf ir">设置</strong> &gt; <strong class="kf ir">二进制媒体类型</strong>点击<strong class="kf ir">添加二进制媒体类型</strong>并将二进制媒体类型定义为:</p><pre class="ly lz ma mb gt mh mf mi mj aw mk bi"><span id="d4bf" class="ml mm iq mf b gy mn mo l mp mq">image/jpeg<br/>image/png<br/>*/*</span></pre><p id="fe7e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">按下<strong class="kf ir">保存更改</strong>。</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/1963ee4822ac796040a0ddab73ed4f89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HJVp3_K8wiWIlVAJrG75Bw.jpeg"/></div></div></figure><p id="558e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">导航回我们的POST方法。</p><p id="1843" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在方法响应下添加一个<code class="fe mc md me mf b">Content-Type</code>响应头，并将类型设置为<code class="fe mc md me mf b">image/jpeg</code>:</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/6606e87a9fc63f4bc3b48cc4bddb4bb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cwWblLt5hdabRZvr44ocpw.jpeg"/></div></div></figure><p id="9433" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在发布API之前，您可以点击<strong class="kf ir">客户端</strong>T42【测试】按钮进行测试:</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/009dba782532a91bb525d0b5d515c0c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ejrMFyi87bFJgqIm8ODp2g.jpeg"/></div></div></figure><p id="c268" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这种情况下，我们提供的是base64图像主体本身，而不是json对象。为了方便起见，您可以尝试将以下链接中的原始base64字符串粘贴到请求正文字段<a class="ae kc" href="https://gist.githubusercontent.com/tiivik/4c6bae4b3dc21c6a3c340eef9c254e2b/raw/37d660b229d462cf00d2cdfaa966ca54ee89b809/cat_base64_body" rel="noopener ugc nofollow" target="_blank"> cat_base64_body </a>中。</p><p id="1134" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">响应是黑白照片的base64字符串。</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/cc7213de43d213fb3dc5eeb3880b79ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4_pAQZH-ORmZpHUEKAzZ3A.jpeg"/></div></div></figure><p id="b4d7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">点击<strong class="kf ir">动作</strong> &gt; <strong class="kf ir">部署API </strong>。</p><p id="88e8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建一个新的部署阶段，给它一个描述性的名称，例如<code class="fe mc md me mf b">development</code>，然后按<strong class="kf ir"> Deploy </strong>。</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/ff782a081f5addaac01f60d542302978.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*esYoh3bGPw3umHNOi9Gb9g.jpeg"/></div></div></figure><p id="271d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该API现在已经上线并开始运行了！您将收到一个部署API的url:</p><p id="6dde" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mc md me mf b"><a class="ae kc" href="https://XXXXX.execute-api.eu-central-1.amazonaws.com/development" rel="noopener ugc nofollow" target="_blank">https://XXXXX.execute-api.XXXX.amazonaws.com/development</a></code></p><p id="f3ab" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们来试试吧！</p><ol class=""><li id="75b0" class="li lj iq kf b kg kh kk kl ko lk ks ll kw lm la lw lo lp lq bi translated">让我们将同一张照片下载到我们的本地环境中</li></ol><pre class="ly lz ma mb gt mh mf mi mj aw mk bi"><span id="e0ad" class="ml mm iq mf b gy mn mo l mp mq">curl https://i.imgur.com/offvirS.jpg -o kitty.jpg</span></pre><p id="83bb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">2.将图像作为二进制数据发布到我们的API。结果是你当前工作目录中的黑白图像。🎉</p><pre class="ly lz ma mb gt mh mf mi mj aw mk bi"><span id="ff33" class="ml mm iq mf b gy mn mo l mp mq">curl -X POST --data-binary @kitty.jpg https://XXXXX.execute-api.eu-central-1.amazonaws.com/development -o kitty_bw.jpg</span></pre><p id="0cf9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">记住，为了简单起见，本教程没有错误处理、请求验证或授权设置。对于生产应用程序，这些应该在API Gateway和Lambda函数代码中设置。</em></p><p id="8f79" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就这些，希望你觉得这个指南有用！如果你有，你可以在这里<a class="ae kc" href="https://medium.com/@tiivik" rel="noopener">订阅未来的文章</a>或者在<a class="ae kc" href="https://twitter.com/tiivik" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上找到我。👏</p></div></div>    
</body>
</html>