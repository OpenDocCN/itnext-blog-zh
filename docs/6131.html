<html>
<head>
<title>Building a Location Tracker in Swift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Swift中构建位置跟踪器</h1>
<blockquote>原文：<a href="https://itnext.io/building-a-location-tracker-in-swift-aab99b6267db?source=collection_archive---------1-----------------------#2021-08-30">https://itnext.io/building-a-location-tracker-in-swift-aab99b6267db?source=collection_archive---------1-----------------------#2021-08-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7799" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用SwiftUI、核心位置、联合收割机和核心数据的实践教程</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/00629e5b4c52507dc6a31a453b3dc7a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*ZEbQIzT64cElkHOk7rGzvg.jpeg"/></div><figcaption class="kq kr gj gh gi ks kt bd b be z dk translated">示例应用程序的屏幕截图</figcaption></figure><p id="54ac" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这篇文章是在我之前的文章<a class="ae lq" href="https://twissmueller.medium.com/where-is-my-iphone-fb75e5bd380" rel="noopener">“我的iPhone在哪里”</a>的基础上，通过使用更多的苹果框架来构建一个适用于iPhone和iPad的应用程序。</p><p id="36ec" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">除了“仅仅”确定设备的位置，我还将设计一个完整的数据流管道，从数据源开始，经过持久化到可视化。</p><p id="2b36" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">本文将涵盖四个Apple框架:</p><ul class=""><li id="e500" class="lr ls it kw b kx ky la lb ld lt lh lu ll lv lp lw lx ly lz bi translated">核心位置</li><li id="af90" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">结合</li><li id="eab2" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">核心数据</li><li id="8f09" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">斯威夫特伊</li></ul><p id="2fd9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我浏览框架的顺序类似于数据流的顺序。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl mf"><img src="../Images/aaa45b0f8dcd9d3082089447dfbefd39.png" data-original-src="https://miro.medium.com/v2/format:webp/1*fuJeIb-VllX66SU7mDkNOg.png"/></div><figcaption class="kq kr gj gh gi ks kt bd b be z dk translated">数据流</figcaption></figure><p id="01ab" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">位置坐标源自核心位置框架，并将存储在核心数据数据库中。</p><p id="6ad1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这两者之间的链接是一个联合发布器，它将从核心位置接收坐标，并将它们发送到核心数据。</p><p id="863a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">最后，连接到核心数据的SwiftUI-view将把数据库中的所有坐标显示为地图上的蓝点。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl mf"><img src="../Images/6908c1f82b436820c03041c15749ac98.png" data-original-src="https://miro.medium.com/v2/format:webp/1*06pwp_Ez5fxtnQAqrW3vUA.jpeg"/></div><figcaption class="kq kr gj gh gi ks kt bd b be z dk translated">示例应用程序的屏幕截图</figcaption></figure><p id="3cc5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">可以从这里</strong>  <strong class="kw iu">下载带有全功能应用的完整Xcode-Workspace。</strong></p><h2 id="0c1d" class="mg mh it bd mi mj mk dn ml mm mn dp mo ld mp mq mr lh ms mt mu ll mv mw mx my bi translated">核心位置</h2><p id="9aa3" class="pw-post-body-paragraph ku kv it kw b kx mz ju kz la na jx lc ld nb lf lg lh nc lj lk ll nd ln lo lp im bi translated">一切都从在类<code class="fe ne nf ng nh b">LocationPublisher</code>中被实例化的<code class="fe ne nf ng nh b">CLLocationManager</code>的实例开始。</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="8e08" class="mg mh it nh b gy nm nn l no np">private let locationManager = CLLocationManager()</span></pre><p id="f2ca" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">它需要一个指派给它的代表，这个代表就是<code class="fe ne nf ng nh b">LocationPublisher</code>。</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="1a78" class="mg mh it nh b gy nm nn l no np">self.locationManager.delegate = self</span></pre><p id="52bc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了获得位置更新，需要实现一个委托方法:</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="23f1" class="mg mh it nh b gy nm nn l no np">extension LocationPublisher: CLLocationManagerDelegate {<br/>    func locationManager(_ manager: CLLocationManager, didUpdateLocations locations: [CLLocation]) {<br/>        guard let location = locations.last else { return }<br/><br/>        wrapped.send((longitude: location.coordinate.longitude, latitude: location.coordinate.latitude))<br/>    }<br/>}</span></pre><p id="04a3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">位置坐标将被发送给我们的联合收割机发布者，这将在下一节中描述。</p><p id="5902" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在我们启动应用程序之前，需要在<code class="fe ne nf ng nh b">Info.plist</code>中设置几个键，否则无法跟踪。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl mf"><img src="../Images/52677309d72ff04892157f67688de7c9.png" data-original-src="https://miro.medium.com/v2/format:webp/1*cq9I7YqFZZTGbmb-oPWqWQ.png"/></div></figure><p id="de8d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在应用程序第一次启动时，你会被要求确认是否允许<code class="fe ne nf ng nh b">Location Tracker</code>确定用户的位置。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl mf"><img src="../Images/8d30ba2c6fc5eae1f428123eb6ada833.png" data-original-src="https://miro.medium.com/v2/format:webp/1*_YlLDvvWggKXq8rZ_A3oug.png"/></div></figure><p id="12ee" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">是时候将坐标“推入”数据库了。我们通过使用一个组合器<code class="fe ne nf ng nh b">Publisher</code>来做到这一点，它将“自动地”链接<code class="fe ne nf ng nh b">CLLocationManager</code>和<code class="fe ne nf ng nh b">CoreData</code>。</p><h2 id="fec4" class="mg mh it bd mi mj mk dn ml mm mn dp mo ld mp mq mr lh ms mt mu ll mv mw mx my bi translated">结合</h2><p id="0d98" class="pw-post-body-paragraph ku kv it kw b kx mz ju kz la na jx lc ld nb lf lg lh nc lj lk ll nd ln lo lp im bi translated"><code class="fe ne nf ng nh b">LocationPublisher</code>有一个接受元组的<code class="fe ne nf ng nh b">PassthroughSubject</code>。元组的第一个值是经度，第二个值是接收到的坐标的纬度。</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="3ee3" class="mg mh it nh b gy nm nn l no np">typealias Output = (longitude: Double, latitude: Double)<br/>typealias Failure = Never<br/>    <br/>private let wrapped = PassthroughSubject&lt;(Output), Failure&gt;()</span></pre><p id="ce9e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">正如我们在“核心位置”一节中看到的，每当在委托方法<code class="fe ne nf ng nh b">locationManager(_ manager: CLLocationManager, didUpdateLocations locations: [CLLocation])</code>中接收到一个坐标时，它将被发送到<code class="fe ne nf ng nh b">PassthroughSubject</code>。</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="2a09" class="mg mh it nh b gy nm nn l no np">wrapped.send((longitude: location.coordinate.longitude, latitude: location.coordinate.latitude))</span></pre><p id="c7ea" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">是时候让<code class="fe ne nf ng nh b">LocationPublisher</code>行动起来，真正成为一家联合出版商了。这是需要的，以便其他类作为数据接收器(核心数据，有人吗？)订阅我们的出版商。</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="380c" class="mg mh it nh b gy nm nn l no np">extension LocationPublisher: Publisher {<br/>    func receive&lt;Downstream: Subscriber&gt;(subscriber: Downstream) where Failure == Downstream.Failure, Output == Downstream.Input {<br/>        wrapped.subscribe(subscriber)<br/>    }<br/>}</span></pre><p id="5a1c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这段代码是提供一个接收已经发送给<code class="fe ne nf ng nh b">PassthroughSubject</code>的坐标的方法所需要的一切。</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="1e6e" class="mg mh it nh b gy nm nn l no np">locationPublisher.sink(receiveValue:)</span></pre><p id="937d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这在下一步中很重要，当我们将<code class="fe ne nf ng nh b">LocationPublisher</code>的输出与我们的CoreData-database连接起来时。</p><h2 id="a3d5" class="mg mh it bd mi mj mk dn ml mm mn dp mo ld mp mq mr lh ms mt mu ll mv mw mx my bi translated">核心数据</h2><p id="97a7" class="pw-post-body-paragraph ku kv it kw b kx mz ju kz la na jx lc ld nb lf lg lh nc lj lk ll nd ln lo lp im bi translated">为了将位置数据“推入”数据库，需要连接<code class="fe ne nf ng nh b">LocataionPublisher</code>和CoreData。</p><p id="8d6c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe ne nf ng nh b">PersistenceController</code>是处理所有数据库相关代码的类。</p><p id="de8b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">它有一个名为<code class="fe ne nf ng nh b">add</code>的方法，该方法获取经度和纬度的元组并将其保存到数据库中。</p><p id="fc14" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这个元组将被转换成一个名为<code class="fe ne nf ng nh b">Location</code>的实体，该实体已经在<code class="fe ne nf ng nh b">LocationTracker.xcdatamodel</code>中定义</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl mf"><img src="../Images/b58315cff8a5e102e23574966017efe2.png" data-original-src="https://miro.medium.com/v2/format:webp/1*2KHNPZvjKhNtXVcmjIPzIA.png"/></div></figure><p id="e69f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">多亏了Combine，将两者、<code class="fe ne nf ng nh b">LocationPublisher</code>和<code class="fe ne nf ng nh b">PersistenceController</code>连接起来只需要一行代码。</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="263a" class="mg mh it nh b gy nm nn l no np">locationPublisher.sink(receiveValue: PersistenceController.shared.add)</span></pre><p id="f845" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这发生在应用程序在<code class="fe ne nf ng nh b">LocationTrackerApp.init</code>中初始化的开始。</p><p id="93fe" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在，位置数据被放入我们的数据库，它是如何在地图上可视化的呢？</p><p id="cbbe" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">进入下一章…</p><h2 id="51cf" class="mg mh it bd mi mj mk dn ml mm mn dp mo ld mp mq mr lh ms mt mu ll mv mw mx my bi translated">斯威夫特伊</h2><p id="d4e4" class="pw-post-body-paragraph ku kv it kw b kx mz ju kz la na jx lc ld nb lf lg lh nc lj lk ll nd ln lo lp im bi translated">用户界面由地图和按钮组成。</p><p id="a467" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">该地图应显示已存储在CoreData中的所有坐标。</p><p id="70fb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">按下按钮后，数据库中的所有数据都将被删除，地图自动从标记中清除。</p><p id="f3e6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在<code class="fe ne nf ng nh b">ContentView</code>中，位置将通过使用<code class="fe ne nf ng nh b">@FetchRequest</code>自动更新。</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="769c" class="mg mh it nh b gy nm nn l no np">@FetchRequest(<br/>        sortDescriptors: [NSSortDescriptor(keyPath: \Location.timestamp, ascending: true)],<br/>        animation: .default)<br/>private var locations: FetchedResults&lt;Location&gt;</span></pre><p id="cf9a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">唯一剩下的，就是告诉地图使用<code class="fe ne nf ng nh b">locations</code>。</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="e3fa" class="mg mh it nh b gy nm nn l no np">Map(coordinateRegion: $region,<br/>    interactionModes: .all,<br/>    showsUserLocation: false,<br/>    userTrackingMode: .constant(.follow),<br/>    annotationItems: locations) { location in<br/>            <br/>    MapAnnotation(coordinate: CLLocationCoordinate2D(latitude: location.latitude, longitude: location.longitude)) {<br/>        Circle().fill(Color.blue).frame(width: 10, height: 10)<br/>    }<br/>}</span></pre><p id="47c0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">因此，每个位置都显示为一个蓝点，并且地图始终与数据库保持同步。不需要更多代码。说真的。</p><h2 id="ec58" class="mg mh it bd mi mj mk dn ml mm mn dp mo ld mp mq mr lh ms mt mu ll mv mw mx my bi translated">结论</h2><p id="e3e3" class="pw-post-body-paragraph ku kv it kw b kx mz ju kz la na jx lc ld nb lf lg lh nc lj lk ll nd ln lo lp im bi translated">这就是关于如何用苹果的最新框架建立一个位置跟踪器。</p><p id="6029" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我希望你喜欢这个教程，并得到一些对你的项目有帮助的想法。</p><p id="b62c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">如果您喜欢现成的解决方案，可以从这里</strong>  <strong class="kw iu">下载带有全功能应用程序的完整Xcode-Workspace</strong><a class="ae lq" href="https://www.buymeacoffee.com/twissmueller/e/41970" rel="noopener ugc nofollow" target="_blank"><strong class="kw iu">。</strong></a></p><p id="8cfb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">感谢您的阅读！</p><ul class=""><li id="d47d" class="lr ls it kw b kx ky la lb ld lt lh lu ll lv lp lw lx ly lz bi translated">如果你喜欢这个，请跟随我</li><li id="4b44" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">给我买杯咖啡让我继续前进</li><li id="6ae2" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">支持我和其他媒体作者<a class="ae lq" href="https://twissmueller.medium.com/membership" rel="noopener">在这里注册</a></li></ul><p id="29a6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><a class="ae lq" href="https://twissmueller.medium.com/membership" rel="noopener">https://twissmueller.medium.com/membership</a></p><h2 id="dabb" class="mg mh it bd mi mj mk dn ml mm mn dp mo ld mp mq mr lh ms mt mu ll mv mw mx my bi translated">资源</h2><ul class=""><li id="0acc" class="lr ls it kw b kx mz la na ld nq lh nr ll ns lp lw lx ly lz bi translated"><a class="ae lq" href="https://developer.apple.com/documentation/corelocation" rel="noopener ugc nofollow" target="_blank">核心位置</a></li><li id="6100" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated"><a class="ae lq" href="https://developer.apple.com/documentation/combine" rel="noopener ugc nofollow" target="_blank">联合收割机</a></li><li id="3a7a" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated"><a class="ae lq" href="https://developer.apple.com/documentation/coredata" rel="noopener ugc nofollow" target="_blank">核心数据</a></li><li id="78cd" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated"><a class="ae lq" href="https://developer.apple.com/documentation/swiftui/" rel="noopener ugc nofollow" target="_blank"> SwiftUI </a></li></ul></div></div>    
</body>
</html>