<html>
<head>
<title>Kubernetes Service Type LB for On Prem Deployments</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于内部部署的Kubernetes服务类型LB</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-service-type-lb-for-on-prem-deployments-89e9b2a73a0c?source=collection_archive---------0-----------------------#2022-03-21">https://itnext.io/kubernetes-service-type-lb-for-on-prem-deployments-89e9b2a73a0c?source=collection_archive---------0-----------------------#2022-03-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e86b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章的灵感来自于<a class="ae kl" href="https://projectcalico.docs.tigera.io/networking/advertise-service-ips" rel="noopener ugc nofollow" target="_blank">这篇博文</a>。</p><h1 id="93ea" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">介绍</h1><p id="8e94" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">在公共云环境中部署负载平衡器类型的Kubernetes服务非常简单。类似下面的清单被应用到一个集群，然后“神奇地发生了”,服务前面有一个负载平衡器设置。</p><figure class="lp lq lr ls gt lt"><div class="bz fp l di"><div class="lu lv l"/></div><figcaption class="lw lx gj gh gi ly lz bd b be z dk translated">云环境中的应用服务</figcaption></figure><p id="3c35" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用这个清单后，云提供商异步配置一个负载平衡器，然后将有关它的信息发布回服务定义(文档<a class="ae kl" href="https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer" rel="noopener ugc nofollow" target="_blank">这里是</a>)。配置负载均衡器后，<em class="ma">ku bectl get SVC my-service-o YAML</em>的输出可能如下所示:</p><figure class="lp lq lr ls gt lt"><div class="bz fp l di"><div class="lu lv l"/></div><figcaption class="lw lx gj gh gi ly lz bd b be z dk translated">在云环境中配置LB后的服务</figcaption></figure><p id="cae7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，负载平衡器的地址是服务my-service的前端192.0.2.127。云提供商将该值写回到服务中。</p><h1 id="92a1" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">内部部署— Calico + MetalLB</h1><p id="4746" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">由于Kubernetes是一个大部分云原生开发都围绕其进行的项目，因此这一过程在公共云环境中是无缝的也就不足为奇了。对于本地集群又如何呢？有一些解决方案可以与负载平衡器供应商集成，其中之一是<a class="ae kl" href="https://www.citrix.com/blogs/2019/09/16/citrix-adc-for-kubernetes-service-of-type-loadbalancer/" rel="noopener ugc nofollow" target="_blank"> Citrix </a>。</p><p id="ee29" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于开源选项，还可以使用Calico和MetalLB的组合，以便为本地集群提供服务类型的负载平衡器功能，这将是本文剩余部分的重点。</p><h2 id="af84" class="mb kn iq bd ko mc md dn ks me mf dp kw jy mg mh la kc mi mj le kg mk ml li mm bi translated">白棉布</h2><p id="a2db" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated"><a class="ae kl" href="https://www.tigera.io/tigera-products/calico/" rel="noopener ugc nofollow" target="_blank"> Calico </a>是Kubernetes生态系统中最流行的CNI解决方案之一。更一般地说，它是一个针对基于容器、虚拟机或主机的工作负载的网络和安全解决方案。</p><p id="ebb3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Calico在Kubernetes环境中使用BGP对该解决方案至关重要，因此，该解决方案仅在本地集群北部的网络运行BGP且架顶式(TOR)交换机是Kubernetes节点的网关时有效。这些TOR交换机还必须启用动态对等。原因是能够支持集群中节点的水平扩展。本文的其余部分假设这些项目已经就绪，但不会提供任何交换机配置。网络侧必须支持的最后一项是<a class="ae kl" href="https://en.wikipedia.org/wiki/Equal-cost_multi-path_routing" rel="noopener ugc nofollow" target="_blank">等价多径(ECMP)路由</a>。网络将从潜在的数十个节点接收相同的路由。</p><h2 id="c318" class="mb kn iq bd ko mc md dn ks me mf dp kw jy mg mh la kc mi mj le kg mk ml li mm bi translated">金属LB</h2><p id="58e8" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated"><a class="ae kl" href="https://metallb.universe.tf/" rel="noopener ugc nofollow" target="_blank"> MetalLB </a>是一个用于裸机Kubernetes集群的负载均衡器实现，它本身可以为本地集群提供服务类型的负载均衡器功能…那么为什么不完全使用它呢？对于生产级部署，有一些严重的限制，记录在<a class="ae kl" href="https://metallb.universe.tf/concepts/layer2/" rel="noopener ugc nofollow" target="_blank">这里</a>。简而言之，缓慢的故障转移，L2模式下的流量瓶颈，以及L3模式下与CNI BGP发言人的潜在冲突。</p><p id="38f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么MetalLB在这个解决方案中起什么作用呢？MetalLB控制器可以独立于扬声器使用。控制器可以为负载平衡器类型的服务执行地址分配，因此将只使用该组件。</p><h1 id="993f" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">解决方案</h1><p id="64ea" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">本节将介绍除TOR交换机配置之外的整个解决方案的各个部分。</p><h2 id="1b82" class="mb kn iq bd ko mc md dn ks me mf dp kw jy mg mh la kc mi mj le kg mk ml li mm bi translated">逻辑拓扑</h2><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/fcf603ff80a1fadbd9bb0212bd2c973b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1112/format:webp/1*g4BcPEKj9H-pOzn5Zt4dGw.jpeg"/></div><figcaption class="lw lx gj gh gi ly lz bd b be z dk translated">逻辑拓扑</figcaption></figure><p id="7e51" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kubernetes工作节点北面的TOR交换机位于BGP自治系统65116中，而工作节点本身位于64700中。这使得它们成为eBGP对等体，这意味着TOR交换机将自动告诉它们的邻居关于工作节点通告的任何路由。这些节点与VLAN10中的TOR交换机对等。交换机是该网络的默认网关，这是Kubernetes节点上的唯一接口。</p><p id="ff38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然可以让TOR交换机向工作节点通告路由，但这种拓扑结构非常简单，节点使用静态默认路由来转发节点外的流量。同时，节点会公布一个192.168.5.0/24的范围，用于在集群内分配负载平衡器IP。</p><p id="ad64" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">集群中的每个节点都将通告此范围，无论它是否托管负载平衡器类型的服务后面的pod，TOR交换机上的ECMP路由将获取到节点的流量。这是一个可以优化的领域，但是这篇文章主要关注的是如何让流量先流动起来。</p><h2 id="1398" class="mb kn iq bd ko mc md dn ks me mf dp kw jy mg mh la kc mi mj le kg mk ml li mm bi translated">印花布结构</h2><p id="9a85" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">假设TOR交换机启用了对等方身份验证，第一步是为Calico对等方设置一个秘密。根据<a class="ae kl" href="https://projectcalico.docs.tigera.io/reference/resources/bgppeer" rel="noopener ugc nofollow" target="_blank"> Calico文档</a>，该密码必须作为Kubernetes秘密创建在与Calico/node pod相同的名称空间中，并在对等配置中引用。</p><pre class="lp lq lr ls gt mq mr ms mt aw mu bi"><span id="4e5c" class="mb kn iq mr b gy mv mw l mx my">$ kubectl create -n kube-system secret generic tor-peer --from-literal=tor-pw=&lt;&lt;PASSWORD&gt;&gt;</span></pre><p id="b904" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步是配置BGP对等体，必须使用<a class="ae kl" href="https://projectcalico.docs.tigera.io/maintenance/clis/calicoctl/install" rel="noopener ugc nofollow" target="_blank"> calicoctl实用程序</a>来完成。</p><figure class="lp lq lr ls gt lt"><div class="bz fp l di"><div class="lu lv l"/></div><figcaption class="lw lx gj gh gi ly lz bd b be z dk translated">Calico BGP对等配置</figcaption></figure><p id="f841" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">nodeSelector参数确保BGP对等体仅在工作节点上形成，而不在ETCD或主节点上形成。为了应用此配置，请使用如下所示的calicoctl实用程序:</p><pre class="lp lq lr ls gt mq mr ms mt aw mu bi"><span id="f687" class="mb kn iq mr b gy mv mw l mx my">$ ./calicoctl create -f bgppeer.yaml <br/>Successfully created 1 'BGPPeer' resource(s)<br/>$</span></pre><p id="bde3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步是更新Calico的BGP配置。具体来说，集群需要配置更新的BGP策略，以便向TOR交换机通告负载平衡器IP范围。这是必需的，以便通知网络的其余部分如何到达该空间。</p><pre class="lp lq lr ls gt mq mr ms mt aw mu bi"><span id="5d45" class="mb kn iq mr b gy mv mw l mx my">apiVersion:<!-- --> <!-- -->projectcalico.org/v3<br/>kind:<!-- --> <!-- -->BGPConfiguration<br/>metadata:<br/>  name:<!-- --> <!-- -->default<br/>spec:<br/>  logSeverityScreen:<!-- --> <!-- -->Info<br/>  nodeToNodeMeshEnabled:<!-- --> <!-- -->false<br/>  asNumber:<!-- --> <strong class="mr ir">64700<br/>  </strong>serviceClusterIPs:<br/>  <strong class="mr ir">-</strong> <!-- -->cidr:<!-- --> <!-- -->10.43.0.0/16<br/>  serviceLoadBalancerIPs:<br/>  <strong class="mr ir">-</strong> <!-- -->cidr:<!-- --> 192.168.5<!-- -->.0/24<br/>  listenPort:<!-- --> <strong class="mr ir">179<br/>  </strong>communities:<br/>  <strong class="mr ir">-</strong> <!-- -->name:<!-- --> <!-- -->bgp-service-community<br/>  value:<!-- --> <!-- -->64700:300:100<br/>  prefixAdvertisements:<br/>  <strong class="mr ir">-</strong> <!-- -->cidr:<!-- --> 192.168.5<!-- -->.0/24<br/>  communities:<br/>  <strong class="mr ir">-</strong> <!-- -->bgp-service-community<br/>  <strong class="mr ir">-</strong> <!-- -->64700:120</span></pre><p id="d679" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用calicoctl实用程序再次应用该配置。应用后，192.168.5.0/24子网应该出现在TOR交换机的路由表中。</p><h2 id="d1eb" class="mb kn iq bd ko mc md dn ks me mf dp kw jy mg mh la kc mi mj le kg mk ml li mm bi translated">MetalLB配置</h2><p id="f14a" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">尽管Calico处理BGP部分，但当集群中请求负载平衡器地址时，仍然需要分发这些地址。MetalLB控制器可以执行此功能。同样，不要安装MetalLB的扬声器组件，这一点很重要。这可能会与Calico发生冲突，因为它们都是BGP流程。</p><p id="64e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于这个演示集群，<a class="ae kl" href="https://metallb.universe.tf/installation/" rel="noopener ugc nofollow" target="_blank">使用了清单</a>中的安装选项(原始清单<a class="ae kl" href="https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/metallb.yaml" rel="noopener ugc nofollow" target="_blank">这里是</a>),所有的扬声器组件都被注释掉了。</p><p id="1b9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">唯一需要的额外配置是一个配置图，MetalLB将读取该配置图以了解它应该在群集中执行什么操作。</p><figure class="lp lq lr ls gt lt"><div class="bz fp l di"><div class="lu lv l"/></div></figure><p id="62b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">负载平衡器子网192.168.5.0/24位于addresses参数下。控制器将读入该配置并分发地址。</p><h1 id="d24f" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">测试解决方案</h1><p id="1a75" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">部署好这个配置后，下一步是测试它。一个简单的<a class="ae kl" href="https://code.mendhak.com/docker-http-https-echo/" rel="noopener ugc nofollow" target="_blank"> HTTP echo server </a>将与负载平衡器类型的服务配置一起用于部署，以在集群外部公开部署。</p><h2 id="a269" class="mb kn iq bd ko mc md dn ks me mf dp kw jy mg mh la kc mi mj le kg mk ml li mm bi translated">部署</h2><figure class="lp lq lr ls gt lt"><div class="bz fp l di"><div class="lu lv l"/></div></figure><p id="f002" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意，容器公开了80和443，因此部署和服务也将这样做。测试将只关注HTTP。</p><h2 id="c70a" class="mb kn iq bd ko mc md dn ks me mf dp kw jy mg mh la kc mi mj le kg mk ml li mm bi translated">服务</h2><figure class="lp lq lr ls gt lt"><div class="bz fp l di"><div class="lu lv l"/></div></figure><p id="0b43" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦部署了服务，MetalLB应该向服务分发一个地址。通过查看集群默认名称空间中的服务，可以很容易地确认这一点。</p><pre class="lp lq lr ls gt mq mr ms mt aw mu bi"><span id="5aa9" class="mb kn iq mr b gy mv mw l mx my">$ kubectl get svc -n default<br/>NAME               TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE<br/>http-server-svc    LoadBalancer   10.43.236.6     192.168.5.0     80:32761/TCP     11d<br/>kubernetes         ClusterIP      10.43.0.1       &lt;none&gt;        443/TCP          63d<br/>$</span></pre><p id="9727" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">果然，192.168.5.0已被分配给此负载平衡器地址(注意，这是用于此目的的完全有效的地址，如果192.168.5.0/24范围改为用于提供对主机的网络访问，则192.168.5.0地址将是子网的网络地址)。</p><p id="edc9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步是测试echo服务器。</p><pre class="lp lq lr ls gt mq mr ms mt aw mu bi"><span id="599f" class="mb kn iq mr b gy mv mw l mx my">$ curl -X PUT -H "Arbitrary:Header" -H "Host:test.example.com" -d aaa=bbb http://192.168.5.0<br/>{<br/>  "path": "/",<br/>  "headers": {<br/>    "user-agent": "curl/7.29.0",<br/>    "host": "test.example.com",<br/>    "accept": "*/*",<br/>    "arbitrary": "Header",<br/>    "content-length": "7",<br/>    "content-type": "application/x-www-form-urlencoded"<br/>  },<br/>  "method": "PUT",<br/>  "body": "aaa=bbb",<br/>  "fresh": false,<br/>  "hostname": "test.example.com",<br/>  "ip": "::ffff:10.42.61.64",<br/>  "ips": [],<br/>  "protocol": "http",<br/>  "query": {},<br/>  "subdomains": [<br/>  ],<br/>  "xhr": false,<br/>  "os": {<br/>    "hostname": "http-echo-server-5c5877dfbb-8k7fs"<br/>  },<br/>  "connection": {}<br/>}<br/>$ </span></pre><p id="75a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">成功！从现在开始，仍有工作要做，以使生产级部署正常工作。显然，需要为负载平衡器IP设置DNS记录。如果集群中公开的应用程序仅基于HTTP(S ),则可以为入口控制器提供额外的负载平衡器服务。</p><h1 id="21e5" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">感谢访问媒体</h1><p id="c71f" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">我希望这篇文章对你有用。感谢访问媒体。</p></div></div>    
</body>
</html>