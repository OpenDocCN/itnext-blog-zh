<html>
<head>
<title>Stay safe with Docker and firewall</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">借助Docker和防火墙保持安全</h1>
<blockquote>原文：<a href="https://itnext.io/stay-safe-with-docker-and-firewall-9190d2c0fde8?source=collection_archive---------0-----------------------#2022-04-20">https://itnext.io/stay-safe-with-docker-and-firewall-9190d2c0fde8?source=collection_archive---------0-----------------------#2022-04-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/907987832247273ae5c0b1e67d460ca8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pLSCNAswwoDG9HNgYxv0DQ.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">防火墙(取自unsplash.com)</figcaption></figure><p id="df8a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这篇文章只是对数百万其他问题中的一个问题的解决方案。我试图尽可能详细地描述每件事，并给出例子。</p><p id="e05a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果这对某人有用，我会很高兴。</p><p id="d902" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">简介</strong></p><p id="9797" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在公共服务器上设置docker的时候会怎么做？你如何设置防火墙？有用吗？这种情况并不常见，尤其是在方便的云接口时代。</p><p id="54be" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我将提前回答以上问题:Docker与UFW的合作不尽如人意。这意味着，如果您通过公开某个端口来部署某个服务，那么即使该端口被UFW关闭，它也是可用的。</p><p id="8f7f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">让我们开始吧</strong></p><p id="e3ef" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为了清楚起见，让我们准备PostgreSQL容器。让我们下载图片:</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="04fd" class="lj lk iq lf b gy ll lm l ln lo">docker pull postgres</span></pre><p id="e0a5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后，我们用经典命令启动容器:</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="1089" class="lj lk iq lf b gy ll lm l ln lo">docker run --name postgresql -e POSTGRES_USER=user -e POSTGRES_PASSWORD=strong_password -p 5432:5432 -v /data:/var/lib/postgresql/data -d postgres</span></pre><p id="bc07" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">其中:</p><ul class=""><li id="ff49" class="lp lq iq ke b kf kg kj kk kn lr kr ls kv lt kz lu lv lw lx bi translated"><strong class="ke ir">T5【PostgreSQL】是Docker容器的名称； </strong></li><li id="8fec" class="lp lq iq ke b kf lz kj ma kn mb kr mc kv md kz lu lv lw lx bi translated"><strong class="ke ir"> <em class="ly"> -e POSTGRES_USER是为POSTGRES数据库设置唯一用户名的选项；</em>T11】</strong></li><li id="97d4" class="lp lq iq ke b kf lz kj ma kn mb kr mc kv md kz lu lv lw lx bi translated"><strong class="ke ir"> <em class="ly"> -e POSTGRES_PASSWORD是设置POSTGRES数据库密码的选项；</em>T15】</strong></li><li id="538a" class="lp lq iq ke b kf lz kj ma kn mb kr mc kv md kz lu lv lw lx bi translated"><strong class="ke ir"> <em class="ly"> -p 5432:5432是建立主机端口和Docker容器端口之间连接的参数。在这种情况下，两个端口都是5432，表明发送到主机端口的请求将被自动转发到Docker容器端口。另外，5432是PostgreSQL用来接受来自客户端的请求的同一个端口；</em>T19】</strong></li><li id="7f22" class="lp lq iq ke b kf lz kj ma kn mb kr mc kv md kz lu lv lw lx bi translated"><strong class="ke ir"> <em class="ly"> -v是一个将Postgres数据与本地文件夹同步的选项。这确保了Postgres数据安全地存在于主目录中，即使Docker容器是关闭的；</em> </strong></li><li id="6046" class="lp lq iq ke b kf lz kj ma kn mb kr mc kv md kz lu lv lw lx bi translated"><strong class="ke ir"> <em class="ly"> -d是离线启动Docker容器的选项，即在后台启动。如果不小心关闭或结束了命令提示符，Docker容器仍然会在后台运行；</em> </strong></li><li id="acb7" class="lp lq iq ke b kf lz kj ma kn mb kr mc kv md kz lu lv lw lx bi translated"><strong class="ke ir"> <em class="ly"> postgres是之前下载来运行Docker容器的Docker映像的名称。</em> </strong></li></ul><p id="9876" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">检查端口</strong></p><p id="1da6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在本节中，我们将使用<em class="ly"> netstat </em>和Nmap来检查侦听TCP连接的本地进程，并执行端口扫描:</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="83c3" class="lj lk iq lf b gy ll lm l ln lo">sudo netstat -tlpn</span></pre><figure class="la lb lc ld gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi me"><img src="../Images/78dd8d17d1dde3eaa612a7360ad04f42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sscmQpHftACCOwQnbdm5OA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">netstat输出示例</figcaption></figure><p id="de2d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">从上面的结果中，我们可以看到有4个服务在侦听TCP连接。“本地地址”是指服务侦听的主机(IP地址和端口号)。例如，对“127.0.0.1:45713”的请求将由该服务处理。</p><p id="1f39" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">“127.0.0.1”是环回地址。无法远程访问绑定到环回地址的服务。<br/>“0 . 0 . 0 . 0”指所有接口。绑定到此地址的服务可以远程访问，除非防火墙阻止这些请求。</p><p id="1266" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">让我们通过使用Nmap扫描开放端口来测试这一假设:</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="a049" class="lj lk iq lf b gy ll lm l ln lo">nmap -p 0-65535 0.0.0.0</span></pre><figure class="la lb lc ld gt jr gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/98c15827e926bc89f4f3e7f79e0433ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1174/format:webp/1*g0GGLCSZWahzQvAZu7mHYA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">nmap输出示例</figcaption></figure><p id="5f02" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">要回答这个问题，我们需要系统在本地网络上的IP地址。您可以使用ifconfig:</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="0fb3" class="lj lk iq lf b gy ll lm l ln lo">ifconfig | grep -Po "inet 192.168.[^ ]+" | grep -Po "192.168.[^ ]+"</span></pre><p id="a077" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">或者你可以只在界面上看你的IP地址(只需运行"<em class="ly"> sudo ifconfig" </em>)，比如eth0，粘贴到下面的命令中。</p><p id="c2c4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果您的系统是运行在云中的VPS，那么它在本地网络上的IP地址可以以“10”开头。而不是192.168。。检查完整的ifconfig输出，查看系统上的所有网络接口。</p><p id="ac45" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在，让我们使用本地网络上的IP地址重复扫描:</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="7d95" class="lj lk iq lf b gy ll lm l ln lo">nmap -p 0-65535  XXX.XXX.XXX.XXX</span></pre><figure class="la lb lc ld gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/6d447453825e025a12e17d63a6fef5a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hkFEXK8r_7_KWzXM6jrk_Q.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">nmap输出示例</figcaption></figure><p id="6c27" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><em class="ly">从上面可以看到，系统为远程TCP流量开放了两个端口。第一个是端口22，用于SSH访问。如果我们需要通过SSH远程访问机器，这个端口必须保持打开。</em></p><p id="6923" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><em class="ly">第二个是端口3000，使用Grafana监控，也位于此服务器上，在本例中，我们对此不感兴趣。</em></p><p id="1e7b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">第三个端口5432是用于PostgreSQL的，可能不应该远程打开。在这个服务器示例中，我们在docker容器中运行PostgreSQL。</p><p id="900c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为了解决这个问题——不要远程打开docker服务<br/>我们最初像大多数Docker用户一样运行容器，但没有意识到他们在发布端口时远程公开了他们的服务。p参数告诉docker“发布”端口3000，即创建一个侦听器，并将端口3000上的请求转发到新容器。但这并不安全，因为docker的默认主机必然是“0.0.0.0”！</p><p id="f6c0" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">文章的主要部分</strong></p><p id="8904" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在我们使用Postgres的情况下，使用以下命令启动PostgreSQL是正确的:</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="750e" class="lj lk iq lf b gy ll lm l ln lo">docker run --name postgresql -e POSTGRES_USER=myusername -e POSTGRES_PASSWORD=mypassword -p <strong class="lf ir">127.0.0.1:5432:5432</strong> -v /data:/var/lib/postgresql/data -d postgres</span></pre><p id="a1c1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">也就是说，我们简单地替换了<strong class="ke ir">本地主机IP </strong>，替换了默认主机。<br/>上面的命令看起来太麻烦了，为了清楚起见，我们简化一下:</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="e4fc" class="lj lk iq lf b gy ll lm l ln lo">docker run -p <strong class="lf ir">127.0.0.1:5432:5432</strong> -d postgres</span></pre><p id="e2b8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在，该服务将无法远程使用。</p><p id="9b95" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">您可以在官方的<a class="ae mh" href="https://docs.docker.com/engine/reference/commandline/run/#publish-or-expose-port--p---expose" rel="noopener ugc nofollow" target="_blank">文档</a>中找到更多关于使用-p，— publish参数的信息。</p><p id="b484" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">而不是结论</strong></p><p id="1711" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">继续使用<strong class="ke ir"> ufw </strong>来保护您的系统。但是你不应该依靠单一的防线来保护你的服务。如果ufw 是你的服务和公共互联网之间唯一的障碍，那么这可能是一个错误。</p><p id="4e4d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">使用上面的网络工具检查系统上是否有打开的服务。</p><p id="816e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果你使用的是云提供商，使用AWS中的VPC等工具来设置额外的保护通常会更好。</p><p id="1a96" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">回头见。注意安全！</p></div></div>    
</body>
</html>