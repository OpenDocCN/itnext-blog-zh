<html>
<head>
<title>Speedup FFmpeg without compiling from source code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">加速FFmpeg，无需从源代码编译</h1>
<blockquote>原文：<a href="https://itnext.io/speedup-ffmpeg-without-compiling-from-source-code-c1f34d4ec544?source=collection_archive---------3-----------------------#2019-11-17">https://itnext.io/speedup-ffmpeg-without-compiling-from-source-code-c1f34d4ec544?source=collection_archive---------3-----------------------#2019-11-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/483b8c1a4aa79d37b5836ab6dc376a5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mgCxTQSqrTvKsmDRmuRa7w.jpeg"/></div></div></figure><p id="d947" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当涉及到多媒体操作时，FFmpeg是一个很好的工具，默认情况下，它使用CPU和多线程来完成任务，这会给你的PC带来很高的负载，并且大部分时间都很慢。</p><p id="74c7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你在谷歌上搜索如何提高FFmpeg的速度，你可能会发现关于使用<code class="fe kz la lb lc b">-preset</code>来降低压缩率以获得更高速度(文件大小和速度之间的权衡)的讨论，另一种有趣的方法是利用nVidia GPU (nvenc、nvdec和cuvid)，但这并不容易，因为:</p><ol class=""><li id="ac22" class="ld le it kd b ke kf ki kj km lf kq lg ku lh ky li lj lk ll bi translated">你没有兼容的nVidia GPU卡</li><li id="1f07" class="ld le it kd b ke lm ki ln km lo kq lp ku lq ky li lj lk ll bi translated">需要安装nVidia GPU驱动和CUDA(在Linux环境下很痛苦)</li><li id="96b4" class="ld le it kd b ke lm ki ln km lo kq lp ku lq ky li lj lk ll bi translated">如果找不到现成的版本，就需要从源代码编译FFmpeg</li></ol><p id="08fd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">以我自己的经验，我花了几个小时研究如何安装和编译FFmpeg，但最终失败了，因为我的GPU无法支持大多数功能，这是可悲的。</p><p id="54a2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">那么有没有其他方法可以让FFmpeg更快呢？是的，你可以使用<code class="fe kz la lb lc b">VAAPI</code>在几秒钟内完成。让我们做一个实验来看看不同之处。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="4f17" class="ly lz it bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">基线:不带任何选项缩放视频</h1><p id="4c7e" class="pw-post-body-paragraph kb kc it kd b ke mw kg kh ki mx kk kl km my ko kp kq mz ks kt ku na kw kx ky im bi translated">假设您正在创建一个服务来提供不同质量的视频流(720p、1080p等)。)，所以你需要把上传的视频缩小到不同的分辨率。</p><p id="6d9c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们从<a class="ae nb" href="https://www.h264info.com/clips.html" rel="noopener ugc nofollow" target="_blank"> h264info </a>下载一个样本视频，然后不加任何选项按比例缩小:</p><pre class="nc nd ne nf gt ng lc nh ni aw nj bi"><span id="318a" class="nk lz it lc b gy nl nm l nn no">$ ffmpeg -i gravity.mp4 \<br/>    -c:v libx264 \<br/>    -s 1024x428 \<br/>    -b:v 1M \<br/>    out.mp4</span></pre><p id="26bd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">对于21 MB的文件大小，大约需要42秒(速度=3.5x)。(原始大小为355 MB)</p><h1 id="c433" class="ly lz it bd ma mb np md me mf nq mh mi mj nr ml mm mn ns mp mq mr nt mt mu mv bi translated">使用-preset可加速更大的文件大小</h1><blockquote class="nu nv nw"><p id="53a0" class="kb kc nx kd b ke kf kg kh ki kj kk kl ny kn ko kp nz kr ks kt oa kv kw kx ky im bi translated">查看<a class="ae nb" href="https://trac.ffmpeg.org/wiki/Encode/H.264" rel="noopener ugc nofollow" target="_blank">此处</a>了解更多关于预置的细节</p></blockquote><p id="387d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">使用预设，你可以很容易地加快FFmpeg与更大的文件大小，这是可以接受的，当你有足够的空间留在你的硬盘。</p><pre class="nc nd ne nf gt ng lc nh ni aw nj bi"><span id="7d2d" class="nk lz it lc b gy nl nm l nn no">$ ffmpeg -i gravity.mp4 \<br/>    -c:v libx264 \<br/>    -preset ultrafast \<br/>    -s 1024x428 \<br/>    -b:v 1M \<br/>    out.mp4</span></pre><p id="eef5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">它需要大约22秒(速度=6x)，文件大小为20 MB。(有意思，它比<code class="fe kz la lb lc b">-preset default</code>还小😎)</p><h1 id="6af1" class="ly lz it bd ma mb np md me mf nq mh mi mj nr ml mm mn ns mp mq mr nt mt mu mv bi translated">使用VAAPI通过集成/英特尔GPU卡加速</h1><p id="18bd" class="pw-post-body-paragraph kb kc it kd b ke mw kg kh ki mx kk kl km my ko kp kq mz ks kt ku na kw kx ky im bi translated">视频加速API (VAAPI)在FFmpeg中不是秘密，但是很难注意到它是如何轻松地帮助你加速FFmpeg的。使用VAAPI的好处是:</p><ol class=""><li id="2cf8" class="ld le it kd b ke kf ki kj km lf kq lg ku lh ky li lj lk ll bi translated">集成的GPU卡很便宜(而且你现在已经有一张了)</li><li id="8e04" class="ld le it kd b ke lm ki ln km lo kq lp ku lq ky li lj lk ll bi translated">你只需要安装<code class="fe kz la lb lc b">i965-va-driver</code>就能让它工作</li><li id="c6c6" class="ld le it kd b ke lm ki ln km lo kq lp ku lq ky li lj lk ll bi translated">您不必编译FFmpeg，因为默认情况下这个标志是启用的</li></ol><p id="7974" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要在Ubuntu中使用VAAPI，首先你需要安装驱动程序并用<code class="fe kz la lb lc b">vainfo</code>命令检查状态:</p><pre class="nc nd ne nf gt ng lc nh ni aw nj bi"><span id="afcc" class="nk lz it lc b gy nl nm l nn no">$ sudo apt-get install i965-va-driver<br/>$ vainfo<br/>libva info: VA-API version 1.1.0<br/>libva info: va_getDriverName() returns 0<br/>libva info: Trying to open /usr/lib/x86_64-linux-gnu/dri/i965_drv_video.so<br/>libva info: Found init function __vaDriverInit_1_1<br/>libva info: va_openDriver() returns 0<br/>vainfo: VA-API version: 1.1 (libva 2.1.0)<br/>vainfo: Driver version: Intel i965 driver for Intel(R) Ivybridge Mobile - 2.1.0<br/>vainfo: Supported profile and entrypoints<br/>      VAProfileMPEG2Simple            : VAEntrypointVLD<br/>      VAProfileMPEG2Simple            : VAEntrypointEncSlice<br/>      VAProfileMPEG2Main              : VAEntrypointVLD<br/>      VAProfileMPEG2Main              : VAEntrypointEncSlice<br/>      VAProfileH264ConstrainedBaseline: VAEntrypointVLD<br/>      VAProfileH264ConstrainedBaseline: VAEntrypointEncSlice<br/>      VAProfileH264Main               : VAEntrypointVLD<br/>      VAProfileH264Main               : VAEntrypointEncSlice<br/>      VAProfileH264High               : VAEntrypointVLD<br/>      VAProfileH264High               : VAEntrypointEncSlice<br/>      VAProfileH264StereoHigh         : VAEntrypointVLD<br/>      VAProfileVC1Simple              : VAEntrypointVLD<br/>      VAProfileVC1Main                : VAEntrypointVLD<br/>      VAProfileVC1Advanced            : VAEntrypointVLD<br/>      VAProfileNone                   : VAEntrypointVideoProc<br/>      VAProfileJPEGBaseline           : VAEntrypointVLD</span></pre><p id="86d5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您看到类似上面的输出，这意味着您的英特尔GPU卡支持VAAPI，那么您可以使用以下命令进行扩展:</p><pre class="nc nd ne nf gt ng lc nh ni aw nj bi"><span id="c0a5" class="nk lz it lc b gy nl nm l nn no">$ ffmpeg -hwaccel vaapi \<br/>    -hwaccel_device /dev/dri/renderD129 \<br/>    -hwaccel_output_format vaapi \<br/>    -i gravity.mp4 \<br/>    -vf "scale_vaapi=w=1024:h=428" \<br/>    -c:v h264_vaapi \<br/>    -b:v 1M \<br/>    out.mp4</span></pre><p id="5895" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">大约需要10秒钟(速度= 14.3倍)，文件大小为19 MB。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><p id="7567" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">将它们放在一个图表中，使用VAAPI可以获得比本机快4倍的速度，并且文件大小也略小。</p><figure class="nc nd ne nf gt ju gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/bd82305d9e52d89e5d8e79c8124efa75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*6bdWCS44VQFfA_R322Ntbg.png"/></div></figure><p id="1a04" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">事实上，如果你投入时间和精力去调查nVidia GPU选项，你甚至可以有更多的加速，但没有太多的努力和成本的加速仍然很棒，不是吗？😄</p><p id="90a3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">希望你觉得这个故事有用，不要犹豫留下任何回应或掌声，谢谢！</p></div></div>    
</body>
</html>