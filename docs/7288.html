<html>
<head>
<title>Debugging Syntax Error Unexpected Reserved Word in Mocha on Modern Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">调试语法错误Modern Node.js上Mocha中意外的保留字</h1>
<blockquote>原文：<a href="https://itnext.io/debugging-syntax-error-unexpected-reserved-word-in-mocha-on-modern-node-js-e33bf824a884?source=collection_archive---------6-----------------------#2022-08-10">https://itnext.io/debugging-syntax-error-unexpected-reserved-word-in-mocha-on-modern-node-js-e33bf824a884?source=collection_archive---------6-----------------------#2022-08-10</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="de95" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">Mocha是一个优秀的单元测试框架，我们可以在Node.js应用程序中使用。但是，它的不可理解的错误信息会导致事倍功半。</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/633de66a364553ba54547896e0f7963e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fbUfh2JuX3uH1Deo.png"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">作者图片</figcaption></figure><p id="b017" class="pw-post-body-paragraph kz la iu lb b lc ld jv le lf lg jy lh li lj lk ll lm ln lo lp lq lr ls lt lu in bi translated"><strong class="lb iv">错误<em class="lv">意外保留字</em>通常意味着您在非异步函数中使用了<em class="lv"> await </em>。但是如果Mocha抛出这个错误，引用一个没有此类问题的测试套件文件，该怎么办呢？为了节省毫无结果的时间，请阅读这篇短文。</strong></p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><p id="c1d5" class="pw-post-body-paragraph kz la iu lb b lc ld jv le lf lg jy lh li lj lk ll lm ln lo lp lq lr ls lt lu in bi translated">错误<em class="lv">意外保留字</em>意味着JavaScript编译器看到了一个<em class="lv">保留字</em>，这意味着一个对编译器来说特殊的关键字，而它并不是预期的。典型的情况是在一个没有被标记为<code class="fe md me mf mg b">async</code>的函数中使用<code class="fe md me mf mg b">await</code>。</p><p id="b023" class="pw-post-body-paragraph kz la iu lb b lc ld jv le lf lg jy lh li lj lk ll lm ln lo lp lq lr ls lt lu in bi translated">在这种情况下，我发现Mocha——一个编写单元测试的流行框架——错误地报告了哪个源文件包含了意外的保留字。我的测试套件抛出了那个错误消息，但是Mocha识别出了不正确的源文件。</p><p id="85a9" class="pw-post-body-paragraph kz la iu lb b lc ld jv le lf lg jy lh li lj lk ll lm ln lo lp lq lr ls lt lu in bi translated">通常一个编译器，或者一个测试框架，报告一个语法错误，会告诉我们实际的代码行，以及有问题的代码。但是，在这种情况下，Mocha既不报告行号，也不报告受影响的代码，更糟糕的是，它报告错误发生在与实际位置不同的源文件中。</p><p id="f600" class="pw-post-body-paragraph kz la iu lb b lc ld jv le lf lg jy lh li lj lk ll lm ln lo lp lq lr ls lt lu in bi translated">因为Mocha错误地报告了意外保留字错误的位置，所以我花了几个小时一遍又一遍地检查不包含这种错误的源文件的语法，但毫无结果。</p><p id="625a" class="pw-post-body-paragraph kz la iu lb b lc ld jv le lf lg jy lh li lj lk ll lm ln lo lp lq lr ls lt lu in bi translated">让我们从通常的情况开始:</p><pre class="kk kl km kn gu mh mg mi mj aw mk bi"><span id="0aa5" class="ml mm iu mg b gz mn mo l mp mq">$ cat unreserved.mjs </span><span id="94c9" class="ml mm iu mg b gz mr mo l mp mq">function a() {<br/>   await console.log(`This will throw an error`); <br/>} </span><span id="562a" class="ml mm iu mg b gz mr mo l mp mq">$ node unreserved.mjs <br/>file:// /home/david/Projects/akasharender/akasharender/test/unreserved.mjs:3<br/>   await console.log(`This will throw an error`);<br/>   ^^^^^ </span><span id="94fb" class="ml mm iu mg b gz mr mo l mp mq">SyntaxError: Unexpected reserved word<br/>    at ESMLoader.moduleStrategy (node:internal/modules/esm/translators:119:18)<br/>    at ESMLoader.moduleProvider (node:internal/modules/esm/loader:483:14)<br/>    at async link (node:internal/modules/esm/module_job:67:21)</span></pre><p id="6cdd" class="pw-post-body-paragraph kz la iu lb b lc ld jv le lf lg jy lh li lj lk ll lm ln lo lp lq lr ls lt lu in bi translated">这是我们通常看到的。我们已经创建了一个ES6模块，<code class="fe md me mf mg b">unreserved.mjs</code>，包含一个非异步函数。在这个函数中有一个关键字<code class="fe md me mf mg b">await</code>。这是在错误的上下文中使用了保留字<code class="fe md me mf mg b">await</code>。在这种情况下，错误报告很好地让我们知道了问题是什么，以及问题发生在哪里。</p><p id="fbbc" class="pw-post-body-paragraph kz la iu lb b lc ld jv le lf lg jy lh li lj lk ll lm ln lo lp lq lr ls lt lu in bi translated">这是期望的行为，编译器很好地让我们知道发生了什么。我们可以直接到受影响的源代码行，在呻吟了“<em class="lv"> Doh </em>”之后，立刻知道该怎么做。</p><p id="0ff5" class="pw-post-body-paragraph kz la iu lb b lc ld jv le lf lg jy lh li lj lk ll lm ln lo lp lq lr ls lt lu in bi translated">考虑一个真实的包，其中已经编写了一个实际的(并且有用的)模块，它包含了那个问题。然后，您要为这个模块编写一个测试套件，因为您遵循了良好的测试优先开发实践。</p><pre class="kk kl km kn gu mh mg mi mj aw mk bi"><span id="89d4" class="ml mm iu mg b gz mn mo l mp mq">$ cat test-unreserved.mjs </span><span id="331e" class="ml mm iu mg b gz mr mo l mp mq">import * as unreserved from './unreserved.mjs'; </span><span id="d055" class="ml mm iu mg b gz mr mo l mp mq">$ npx mocha test-unreserved.mjs <br/>SyntaxError[ @/home/david/Projects/akasharender/akasharender/test/test-unreserved.mjs ]: Unexpected reserved word<br/>    at ESMLoader.moduleStrategy (node:internal/modules/esm/translators:119:18)<br/>    at ESMLoader.moduleProvider (node:internal/modules/esm/loader:483:14)</span></pre><p id="1101" class="pw-post-body-paragraph kz la iu lb b lc ld jv le lf lg jy lh li lj lk ll lm ln lo lp lq lr ls lt lu in bi translated">当然，您的测试套件必须导入应用程序代码来执行测试用例。这意味着导入<code class="fe md me mf mg b">unreserved.mjs</code>模块。因为我们刚刚创建了那个文件，所以我们很容易记住这个错误。在这种情况下，Mocha并没有给我们一个明确的错误信息。它只是说<em class="lv">意外的保留字</em>，并且进一步地，它将<code class="fe md me mf mg b">test-unreserved.mjs</code>标识为包含问题。</p><p id="b222" class="pw-post-body-paragraph kz la iu lb b lc ld jv le lf lg jy lh li lj lk ll lm ln lo lp lq lr ls lt lu in bi translated">再一次，相反，考虑这发生在一个真实的包中。测试套件可能有1500行代码，被测试的模块也有类似数量的代码。</p><p id="652f" class="pw-post-body-paragraph kz la iu lb b lc ld jv le lf lg jy lh li lj lk ll lm ln lo lp lq lr ls lt lu in bi translated">因为Mocha明确地将测试套件识别为包含意外的保留字，所以很容易花几个小时梳理测试套件。你检查了<code class="fe md me mf mg b">await</code>的每一个用法，都是正确的。您仔细检查每个循环、每个函数和每个测试用例。您使用VS代码并折叠每个块，因为编辑器正确地折叠了每个块，所以似乎编辑器认为这是正确构造的JavaScript。然后，您尝试注释掉所有代码，但错误仍然出现。最后，你试着逐个注释掉<code class="fe md me mf mg b">import</code>语句，瞧，错误随着一个特定的<code class="fe md me mf mg b">import</code>语句消失了。</p><p id="e763" class="pw-post-body-paragraph kz la iu lb b lc ld jv le lf lg jy lh li lj lk ll lm ln lo lp lq lr ls lt lu in bi translated">检查该文件，您可能会发现一个使用了<code class="fe md me mf mg b">async</code>关键字的非异步函数。这很容易解决，而且这个错误会消失。可能还有其他问题，您会知道原来的问题已经解决了，因为错误消息发生了变化。</p><pre class="kk kl km kn gu mh mg mi mj aw mk bi"><span id="c4ce" class="ml mm iu mg b gz mn mo l mp mq">$ npx mocha test-cache.mjs </span><span id="15a0" class="ml mm iu mg b gz mr mo l mp mq">SyntaxError[ @/home/david/Projects/akasharender/akasharender/test/test-cache.mjs ]: Unexpected reserved word<br/>    at ESMLoader.moduleStrategy (node:internal/modules/esm/translators:119:18)<br/>    at ESMLoader.moduleProvider (node:internal/modules/esm/loader:483:14) </span><span id="e011" class="ml mm iu mg b gz mr mo l mp mq">##### The error changes to this:</span><span id="d919" class="ml mm iu mg b gz mr mo l mp mq">$ npx mocha test-cache.mjs <br/>SyntaxError[ @/home/david/Projects/akasharender/akasharender/test/test-cache.mjs ]: Identifier 'setup' has already been declared<br/>    at ESMLoader.moduleStrategy (node:internal/modules/esm/translators:119:18)<br/>    at ESMLoader.moduleProvider (node:internal/modules/esm/loader:483:14)</span></pre><p id="53a2" class="pw-post-body-paragraph kz la iu lb b lc ld jv le lf lg jy lh li lj lk ll lm ln lo lp lq lr ls lt lu in bi translated">这是发生问题的真实实例。我已经修复了<em class="lv">意外的保留字</em>问题，却发现了另一个问题——我创建了两个名为<code class="fe md me mf mg b">setup</code>的函数。请注意，Mocha仍然报告了错误的源文件。但是，很明显问题会出现在另一个源文件中，而不是测试套件中。</p><h1 id="8754" class="ms mm iu bd mt mu mv mw mx my mz na nb ka nc kb nd kd ne ke nf kg ng kh nh ni bi translated">结论</h1><p id="f54f" class="pw-post-body-paragraph kz la iu lb b lc nj jv le lf nk jy lh li nl lk ll lm nm lo lp lq nn ls lt lu in bi translated">Mocha错误地报告了包含代码问题的源文件。</p><p id="3e83" class="pw-post-body-paragraph kz la iu lb b lc ld jv le lf lg jy lh li lj lk ll lm ln lo lp lq lr ls lt lu in bi translated">它正确地识别了问题——一些代码错误地使用了保留字。但是错误被报告在错误的文件中，这很容易导致花费数小时仔细检查没有此类错误的代码而毫无结果。</p><p id="7162" class="pw-post-body-paragraph kz la iu lb b lc ld jv le lf lg jy lh li lj lk ll lm ln lo lp lq lr ls lt lu in bi translated">我们的时间是宝贵的，花这么多时间清理一个没有问题的文件是令人沮丧的。</p><p id="2489" class="pw-post-body-paragraph kz la iu lb b lc ld jv le lf lg jy lh li lj lk ll lm ln lo lp lq lr ls lt lu in bi translated">糟糕的摩卡。没有汤给你。</p><h1 id="bfb9" class="ms mm iu bd mt mu mv mw mx my mz na nb ka nc kb nd kd ne ke nf kg ng kh nh ni bi translated">关于作者</h1><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj no"><img src="../Images/638062765439ef21fcd5cec68fdc4507.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*fQGG6YbhzDm6Sflr.jpg"/></div></figure><p id="d00f" class="pw-post-body-paragraph kz la iu lb b lc ld jv le lf lg jy lh li lj lk ll lm ln lo lp lq lr ls lt lu in bi translated"><a class="ae np" href="https://davidherron.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iv">大卫·赫伦</strong> </a> <strong class="lb iv"> </strong>:大卫·赫伦是一名作家和软件工程师，专注于技术的明智使用。他对太阳能、风能和电动汽车等清洁能源技术特别感兴趣。David在硅谷从事了近30年的软件工作，从电子邮件系统到视频流，再到Java编程语言，他已经出版了几本关于Node.js编程和电动汽车的书籍。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><p id="8a45" class="pw-post-body-paragraph kz la iu lb b lc ld jv le lf lg jy lh li lj lk ll lm ln lo lp lq lr ls lt lu in bi translated"><em class="lv">原载于</em><a class="ae np" href="https://techsparx.com/nodejs/esnext/mocha-reserved-word.html" rel="noopener ugc nofollow" target="_blank"><em class="lv">https://techsparx.com</em></a><em class="lv">。</em></p></div></div>    
</body>
</html>