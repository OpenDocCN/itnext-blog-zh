<html>
<head>
<title>Implementing a Secure-First Pod Security Policy Architecture</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">实施安全第一的Pod安全策略架构</h1>
<blockquote>原文：<a href="https://itnext.io/implementing-a-restricted-first-pod-security-policyarchitecture-af4e906593b0?source=collection_archive---------7-----------------------#2020-11-02">https://itnext.io/implementing-a-restricted-first-pod-security-policyarchitecture-af4e906593b0?source=collection_archive---------7-----------------------#2020-11-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ab105b563cf8911e2ab2d706b73d72c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9DiXE0WQz-pzGpGx"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">miosz klin owski在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><h1 id="883f" class="kk kl iq bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">Pod安全策略</h1><p id="c9a1" class="pw-post-body-paragraph li lj iq lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf ij bi translated">保护Kubernetes集群的方法有很多，无论是通过实施网络策略来控制入口/出口流量、基于角色的访问控制，还是多租户。管理在您的集群上运行的内容的最有效方法之一是通过创建Pod安全策略。</p><p id="90b3" class="pw-post-body-paragraph li lj iq lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf ij bi translated">pod安全策略定义了一组条件，Pod必须在这些条件下运行才能在群集上运行。这些条件包括主机级访问、容器可以运行的uid范围，甚至是pod可以使用的卷。</p><p id="b529" class="pw-post-body-paragraph li lj iq lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf ij bi translated">在本文中，我将展示一个蓝图，通过实现Pod安全策略，为您的集群应用安全第一的思想。按照安全或受限优先的思维方式，默认情况下，您将锁定您的集群以运行安全的工作负载，并通过审查，为那些需要特权访问的工作负载设置例外。</p></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><h1 id="60a0" class="kk kl iq bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">默认为受限</h1><p id="7163" class="pw-post-body-paragraph li lj iq lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf ij bi translated">由于我们是从安全第一的心态来对待我们的集群的，所以我们需要定义一个默认的Pod安全策略，该策略扩展到所有经过身份验证的用户和服务帐户。下面提供了一个示例限制PSP，您可以使用它来开始，然后根据您的需要进行调整:</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="691a" class="pw-post-body-paragraph li lj iq lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf ij bi translated">执行以下命令创建新的Pod安全策略:</p><pre class="ml mm mn mo gt mr ms mt mu aw mv bi"><span id="ed42" class="mw kl iq ms b gy mx my l mz na">kubectl create -f restricted-psp.yaml</span></pre><p id="c39f" class="pw-post-body-paragraph li lj iq lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf ij bi translated">接下来，我们要确保此Pod安全策略适用于所有服务帐户，因为我们是从安全第一的理念出发的。使用下面的RBAC资源来实现这一点:</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><pre class="ml mm mn mo gt mr ms mt mu aw mv bi"><span id="e169" class="mw kl iq ms b gy mx my l mz na">kubectl create -f restricted-psp-rbac.yaml</span></pre><blockquote class="nb nc nd"><p id="b07b" class="li lj ne lk b ll mg ln lo lp mh lr ls nf mi lv lw ng mj lz ma nh mk md me mf ij bi translated">上述资源将首先创建一个<strong class="lk ir"> ClusterRole </strong>资源，该资源被授权使用<strong class="lk ir"> restricted-psp </strong> Pod安全策略。然后我们创建一个<strong class="lk ir"> ClusterRoleBinding </strong>，它将我们的<strong class="lk ir"> ClusterRole </strong>绑定到集群中的所有服务帐户。这实际上意味着，当您在集群上部署任何pod时，它必须受限于我们的<strong class="lk ir"> restricted-psp </strong> Pod安全策略所规定的条件。</p></blockquote><h1 id="9cdb" class="kk kl iq bd km kn ni kp kq kr nj kt ku kv nk kx ky kz nl lb lc ld nm lf lg lh bi translated">特权访问是例外</h1><p id="fcf1" class="pw-post-body-paragraph li lj iq lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf ij bi translated">既然我们已经应用了一个默认的限制性Pod安全策略，我们现在准备创建我们的特权PSP，以允许需要提升访问级别的工作负载运行。这些工作负载的一些示例包括kube-proxy等控制平面单元，以及nginx等入口单元。</p><p id="9438" class="pw-post-body-paragraph li lj iq lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf ij bi translated">使用下面的模板创建下面的特权PSP，你可以根据你的需要调整它:</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><pre class="ml mm mn mo gt mr ms mt mu aw mv bi"><span id="dae7" class="mw kl iq ms b gy mx my l mz na">kubectl create -f privileged-psp.yaml</span></pre><blockquote class="nb nc nd"><p id="90ac" class="li lj ne lk b ll mg ln lo lp mh lr ls nf mi lv lw ng mj lz ma nh mk md me mf ij bi translated">这个PSP有效地允许特权访问和升级，允许容器作为任何用户运行，允许容器使用任何种类的卷，允许主机访问(文件系统和网络)，并允许任何linux功能。在确定您的工作负载需要多少特权时，您必须有很强的判断力。您应该首先了解这些工作负载运行所需的最小权限集，然后相应地改进PSP。</p></blockquote><p id="de9b" class="pw-post-body-paragraph li lj iq lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf ij bi translated">接下来，我们需要定义一个被授权使用我们的特权PSP的ClusterRole:</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><pre class="ml mm mn mo gt mr ms mt mu aw mv bi"><span id="0e47" class="mw kl iq ms b gy mx my l mz na">kubectl create -f privileged-cluster-role.yaml</span></pre><p id="3995" class="pw-post-body-paragraph li lj iq lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf ij bi translated">现在，我们需要能够确定哪些工作负载需要特权访问，然后将这些工作负载绑定到我们的特权PSP。这应该根据您的集群的具体情况来进行，以免向特权访问开放整个集群。</p><p id="325f" class="pw-post-body-paragraph li lj iq lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf ij bi translated">为此，我会提出两个问题:</p><ol class=""><li id="20cc" class="nn no iq lk b ll mg lp mh lt np lx nq mb nr mf ns nt nu nv bi translated">您的集群上是否有一个命名空间(例如kube-system ),其中所有工作负载都以类似方式运行，并且需要特权访问？</li><li id="9379" class="nn no iq lk b ll nw lp nx lt ny lx nz mb oa mf ns nt nu nv bi translated">命名空间中是否只有特定的工作负载需要特权访问？</li></ol><p id="5d28" class="pw-post-body-paragraph li lj iq lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf ij bi translated">对于场景1，使用以下RBAC资源模板允许特定命名空间中的所有服务帐户使用特权pod安全策略:</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><pre class="ml mm mn mo gt mr ms mt mu aw mv bi"><span id="0da4" class="mw kl iq ms b gy mx my l mz na">kubectl create -f namespaced-privileged-access.yaml</span></pre><p id="7e18" class="pw-post-body-paragraph li lj iq lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf ij bi translated">对于场景2，使用以下RBAC资源模板允许命名空间中的特定服务帐户使用特权pod安全策略:</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><pre class="ml mm mn mo gt mr ms mt mu aw mv bi"><span id="c532" class="mw kl iq ms b gy mx my l mz na">kubectl create -f workload-specific-binding.yaml</span></pre><h1 id="ba87" class="kk kl iq bd km kn ni kp kq kr nj kt ku kv nk kx ky kz nl lb lc ld nm lf lg lh bi translated">启用Pod安全策略准入控制器</h1><p id="d2c3" class="pw-post-body-paragraph li lj iq lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf ij bi translated">现在我们已经创建了pod安全策略和RBAC资源，我们需要在Kubernetes API服务器上启用Pod安全策略准入控制器。确保已经创建了所有这些资源，否则，一旦启用了准入控制器，将无法运行任何工作负载(它要求至少存在1个Pod安全策略)。</p><p id="56d2" class="pw-post-body-paragraph li lj iq lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf ij bi translated">这是通过更新Kubernetes API服务器上的<strong class="lk ir"> enable-admission-plugins </strong>标志来完成的，以便在列表中包含<strong class="lk ir"> PodSecurityPolicy </strong>。如果您使用的是托管Kubernetes提供商(EKS、AKS等)，您的提供商有责任确保启用该功能，否则，您可以使用上述步骤。</p><p id="4ab1" class="pw-post-body-paragraph li lj iq lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf ij bi translated">要查看当前可用的准入插件，请运行:</p><pre class="ml mm mn mo gt mr ms mt mu aw mv bi"><span id="0951" class="mw kl iq ms b gy mx my l mz na">kube-apiserver -h | grep enable-admission-plugins</span></pre><h1 id="0715" class="kk kl iq bd km kn ni kp kq kr nj kt ku kv nk kx ky kz nl lb lc ld nm lf lg lh bi translated">确认</h1><p id="cb3f" class="pw-post-body-paragraph li lj iq lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf ij bi translated">要查看您的pod正在使用的PodSecurityPolicy，请执行以下命令:</p><pre class="ml mm mn mo gt mr ms mt mu aw mv bi"><span id="7aa3" class="mw kl iq ms b gy mx my l mz na">kubectl describe &lt;pod-name&gt; -n &lt;your-namespace&gt;</span></pre><h1 id="b1c3" class="kk kl iq bd km kn ni kp kq kr nj kt ku kv nk kx ky kz nl lb lc ld nm lf lg lh bi translated">结论</h1><p id="e804" class="pw-post-body-paragraph li lj iq lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf ij bi translated">总之，pod安全策略允许您定义一组条件，工作负载必须限制在这些条件下才能运行。您可以访问您可以为策略定义的大量条件，从而为实施安全架构提供了极大的灵活性:</p><ul class=""><li id="02b9" class="nn no iq lk b ll mg lp mh lt np lx nq mb nr mf ob nt nu nv bi translated">卷类型</li><li id="323b" class="nn no iq lk b ll nw lp nx lt ny lx nz mb oa mf ob nt nu nv bi translated">主机文件系统和网络访问</li><li id="cf59" class="nn no iq lk b ll nw lp nx lt ny lx nz mb oa mf ob nt nu nv bi translated">特许访问和升级</li><li id="3e62" class="nn no iq lk b ll nw lp nx lt ny lx nz mb oa mf ob nt nu nv bi translated">Linux功能</li><li id="9a93" class="nn no iq lk b ll nw lp nx lt ny lx nz mb oa mf ob nt nu nv bi translated">容器运行用户</li></ul><p id="7acb" class="pw-post-body-paragraph li lj iq lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf ij bi translated">还有更多…</p><p id="15dc" class="pw-post-body-paragraph li lj iq lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf ij bi translated">有了上面的蓝图，您将能够以安全第一的心态操作您的Kubernetes集群，同时仍然可以在需要的地方进行特权访问。</p><h1 id="45f2" class="kk kl iq bd km kn ni kp kq kr nj kt ku kv nk kx ky kz nl lb lc ld nm lf lg lh bi translated">资源</h1><p id="4912" class="pw-post-body-paragraph li lj iq lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf ij bi translated"><a class="ae kc" href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/" rel="noopener ugc nofollow" target="_blank"> Pod安全策略:Kubernetes文档</a></p></div></div>    
</body>
</html>