<html>
<head>
<title>Rancher 2.x Cert-Manager Upgrade</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Rancher 2.x证书管理器升级</h1>
<blockquote>原文：<a href="https://itnext.io/rancher-cert-manager-upgrade-bd15468bac9c?source=collection_archive---------10-----------------------#2019-11-26">https://itnext.io/rancher-cert-manager-upgrade-bd15468bac9c?source=collection_archive---------10-----------------------#2019-11-26</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="e156" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">如何在为时已晚之前升级您的Kubernetes集群</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/c5c116d2d03fa140e3ab000bbac39635.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ufwx5V5aoT6KNS29"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">照片由<a class="ae kz" href="https://unsplash.com/@priscilladupreez?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">普里西拉·杜·普里兹</a>在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="06d4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果您选择使用Rancher管理的<a class="ae kz" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank"> Helm </a>图表在您的Rancher管理的Kubernetes集群中安装<code class="fe lw lx ly lz b">cert-manager</code>, Let ' s Encrypt的好心人可能会很快向您发送以下通知:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ma"><img src="../Images/e7f438f00f8f2b70fda2b4640caa2998.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T-Ph9Fg8RFRd9cJgC22hxg.png"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">“你的ACME客户太老了。请升级到较新的版本。—现在怎么办？</figcaption></figure><p id="5067" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">检查集群中<code class="fe lw lx ly lz b">cert-manager</code>的日志，您可以看到Let Encrypt拒绝了更新您的证书的请求，因为“您的ACME客户端太旧了”。请升级到新版本”。是时候卷起袖子开始了。</p></div><div class="ab cl mb mc hy md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="in io ip iq ir"><h1 id="2a1c" class="mi mj iu bd mk ml mm mn mo mp mq mr ms ka mt kb mu kd mv ke mw kg mx kh my mz bi translated">使用牧场主策划的头盔图升级</h1><p id="2e3a" class="pw-post-body-paragraph la lb iu lc b ld na jv lf lg nb jy li lj nc ll lm ln nd lp lq lr ne lt lu lv in bi translated">我猜你的第一个想法可能和我的相似:让我们用相应的舵图的最新版本升级<code class="fe lw lx ly lz b">cert-manager</code>。让我告诉你这不是一个选项，以节省你的时间。不幸的是，牧场主为<code class="fe lw lx ly lz b">cert-manager</code>策划的头盔图表似乎<a class="ae kz" href="https://github.com/rancher/charts/tree/master/charts/cert-manager" rel="noopener ugc nofollow" target="_blank">仍然在v0.5.2 </a>上，所以没有<em class="nf">一键、</em>无痛升级可用。</p><p id="3949" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">那么，还有什么其他的选择呢？官方舵轮图。</p><h1 id="a721" class="mi mj iu bd mk ml ng mn mo mp nh mr ms ka ni kb mu kd nj ke mw kg nk kh my mz bi translated">升级官方舵轮图</h1><p id="2f75" class="pw-post-body-paragraph la lb iu lc b ld na jv lf lg nb jy li lj nc ll lm ln nd lp lq lr ne lt lu lv in bi translated">计划很简单:牧场主为<code class="fe lw lx ly lz b">cert-manager</code>策划的头盔图将被移除，取而代之的是头盔中由<a class="ae kz" href="https://www.jetstack.io/" rel="noopener ugc nofollow" target="_blank"> Jetstack </a>维护的<a class="ae kz" href="https://hub.helm.sh/charts/jetstack/cert-manager" rel="noopener ugc nofollow" target="_blank">图。</a></p><p id="3de1" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在我们开始警告之前。从v0.5.2到现在稳定的v0.11.0很多东西<a class="ae kz" href="https://docs.cert-manager.io/en/latest/tasks/upgrading/index.html" rel="noopener ugc nofollow" target="_blank">都变了</a>。<strong class="lc iv">将</strong>影响您的部署的最深刻的变化是新引入的CRDs和各自的配置格式。因此，一旦执行了升级，您需要将您的资源定义更新为新的格式。幸运的是，<code class="fe lw lx ly lz b">cert-manager</code>为我们提供了一个升级脚本，我们将在这篇文章的结尾使用它。</p><h2 id="0170" class="nl mj iu bd mk nm nn dn mo no np dp ms lj nq nr mu ln ns nt mw lr nu nv my nw bi translated">移除牧场主策划的舵图</h2><ol class=""><li id="0aa6" class="nx ny iu lc b ld na lg nb lj nz ln oa lr ob lv oc od oe of bi translated">登录到你的牧场主界面。</li><li id="7ed9" class="nx ny iu lc b ld og lg oh lj oi ln oj lr ok lv oc od oe of bi translated">切换到最初安装<code class="fe lw lx ly lz b">cert-manager</code>的项目(很可能是System)。</li><li id="d1dc" class="nx ny iu lc b ld og lg oh lj oi ln oj lr ok lv oc od oe of bi translated">点击“应用程序”。</li><li id="6eef" class="nx ny iu lc b ld og lg oh lj oi ln oj lr ok lv oc od oe of bi translated">单击垂直省略号按钮，然后选择“删除”。</li></ol><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ol"><img src="../Images/1b2d7352436fb22ee7bbc225ac5f8820.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kQGFcT_oToR8w_8IuOPg1g.png"/></div></div></figure><p id="91f5" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">您现在已经删除了最初安装的<code class="fe lw lx ly lz b">cert-manager</code>。请注意，此删除不会影响过去已经创建的证书，此时您的入口配置应该会像以前一样继续工作。</p><h2 id="8d20" class="nl mj iu bd mk nm nn dn mo no np dp ms lj nq nr mu ln ns nt mw lr nu nv my nw bi translated">安装舵杆</h2><p id="7c99" class="pw-post-body-paragraph la lb iu lc b ld na jv lf lg nb jy li lj nc ll lm ln nd lp lq lr ne lt lu lv in bi translated">Tiller是Helm的服务器端小兄弟，所以要在我们的CLI中使用Helm，我们需要在我们的Kubernetes集群中安装Tiller。您可以通过发出以下命令来验证是否已经安装了Tiller:</p><pre class="kk kl km kn gu om lz on oo aw op bi"><span id="6204" class="nl mj iu lz b gz oq or l os ot">helm version</span></pre><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ou"><img src="../Images/9ef0f1e33a99b36e5ff70d6e6d44c38c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cvTPBVCsPD46wfmGyxxE1w.png"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">验证分蘖是否存在</figcaption></figure><p id="ca29" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果您的输出与上面类似，Tiller不存在，您需要安装它。如果您已经安装了它，您可以跳过这一部分。</p><p id="77cc" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">所以，你没有提勒？没问题，我们来装吧。首先，我们需要创建一个服务帐户，授予我们远程安装Tiller和安装图表的权限。</p><pre class="kk kl km kn gu om lz on oo aw op bi"><span id="9279" class="nl mj iu lz b gz oq or l os ot">kubectl -n kube-system create serviceaccount tiller</span><span id="886a" class="nl mj iu lz b gz ov or l os ot">kubectl create clusterrolebinding tiller \<br/>  --clusterrole=cluster-admin \<br/>  --serviceaccount=kube-system:tiller</span></pre><p id="f7be" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">启动舵杆安装问题:</p><pre class="kk kl km kn gu om lz on oo aw op bi"><span id="ed3e" class="nl mj iu lz b gz oq or l os ot">helm init --service-account tiller</span></pre><p id="b2fc" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">几秒钟后，您可以通过重新发布<code class="fe lw lx ly lz b">helm version</code>来验证Tiller已安装，或者通过以下方式验证您的Kubernetes Tiller部署</p><pre class="kk kl km kn gu om lz on oo aw op bi"><span id="8c5a" class="nl mj iu lz b gz oq or l os ot">kubectl -n kube-system rollout status deploy/tiller-deploy<!-- -->:</span></pre><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ow"><img src="../Images/b00c2be534e129bb990c9108ed699d0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YtorK0DARb_dIWcXS5pAuA.png"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">Helm(客户端)和Tiller(服务器)都可用，并且它们的版本匹配</figcaption></figure><h2 id="69af" class="nl mj iu bd mk nm nn dn mo no np dp ms lj nq nr mu ln ns nt mw lr nu nv my nw bi translated">正在安装证书管理器</h2><p id="8725" class="pw-post-body-paragraph la lb iu lc b ld na jv lf lg nb jy li lj nc ll lm ln nd lp lq lr ne lt lu lv in bi translated">在继续安装<code class="fe lw lx ly lz b">cert-manager</code>之前，我们需要先准备一些东西。</p><ol class=""><li id="58ba" class="nx ny iu lc b ld le lg lh lj ox ln oy lr oz lv oc od oe of bi translated">禁用资源验证以允许<code class="fe lw lx ly lz b">cert-manager</code>的webhook组件正常工作(<a class="ae kz" href="http://kubectl -n kube-system  rollout status deploy/tiller-deploy" rel="noopener ugc nofollow" target="_blank">见原因</a>)。</li><li id="f966" class="nx ny iu lc b ld og lg oh lj oi ln oj lr ok lv oc od oe of bi translated">安装新的(v0.11.1) CRDs</li><li id="a386" class="nx ny iu lc b ld og lg oh lj oi ln oj lr ok lv oc od oe of bi translated">正在添加Jetstack repos。</li></ol><pre class="kk kl km kn gu om lz on oo aw op bi"><span id="be88" class="nl mj iu lz b gz oq or l os ot">kubectl label namespace cert-manager certmanager.k8s.io/disable-validation=true</span><span id="e346" class="nl mj iu lz b gz ov or l os ot">kubectl apply --validate=false -f <a class="ae kz" href="https://raw.githubusercontent.com/jetstack/cert-manager/release-0.11/deploy/manifests/00-crds.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/jetstack/cert-manager/release-0.11/deploy/manifests/00-crds.yaml</a></span><span id="90bd" class="nl mj iu lz b gz ov or l os ot">helm repo add jetstack <a class="ae kz" href="https://charts.jetstack.io" rel="noopener ugc nofollow" target="_blank">https://charts.jetstack.io</a> &amp;&amp; helm update</span></pre><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj pa"><img src="../Images/f3feff9ee5073d1bfe524f6b14468b5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cWx3F4LJ8hKePqAuvdkIeA.png"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">正在准备证书管理器安装</figcaption></figure><p id="370f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">至此，我们已经为<code class="fe lw lx ly lz b">cert-manager</code>的实际安装和验证做好准备:</p><pre class="kk kl km kn gu om lz on oo aw op bi"><span id="3259" class="nl mj iu lz b gz oq or l os ot">helm install \<br/>  --name cert-manager \<br/>  --namespace cert-manager \<br/>  --version v0.11.0 \<br/>  jetstack/cert-manager</span><span id="73f1" class="nl mj iu lz b gz ov or l os ot">kubectl get pods --namespace cert-manager</span></pre><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj pb"><img src="../Images/9541baf1b2f86d9e4a1221bd5f445328.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gQJNhq40z99umfp3HxHtbA.png"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">cert-manager v.0.11.0安装成功</figcaption></figure><h2 id="55f5" class="nl mj iu bd mk nm nn dn mo no np dp ms lj nq nr mu ln ns nt mw lr nu nv my nw bi translated">升级旧的资源引用和配置</h2><p id="7a4e" class="pw-post-body-paragraph la lb iu lc b ld na jv lf lg nb jy li lj nc ll lm ln nd lp lq lr ne lt lu lv in bi translated">如果你去检查你的入境证明，你会发现什么都没有改变。这是意料之中的，因为过去在v0.5.2中使用的入口定义不包含v0.11.0的适当配置。<code class="fe lw lx ly lz b">cert-manager</code>为我们提供了一个方便的“一行程序”,通过以下方式找出哪个集群资源仍然引用旧值:</p><pre class="kk kl km kn gu om lz on oo aw op bi"><span id="dd93" class="nl mj iu lz b gz oq or l os ot">kubectl get ingress \<br/>      --all-namespaces \<br/>      -o json | \<br/>      jq '.items[] | select(.metadata.annotations| to_entries | map(.key)[] | test("certmanager")) | "Ingress resource \(.metadata.namespace)/\(.metadata.name) contains old annotations: (\( .metadata.annotations | to_entries | map(.key)[] | select( . | test("certmanager") )  ))"'</span></pre><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj pc"><img src="../Images/d69a6d53a77b55757a59cdb87e8fc2bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FfVWYdDcKR8USti6-IfbHw.png"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">找出不兼容的v0.5.2配置</figcaption></figure><p id="0a4c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">根据Kubernetes集群的部署数量，上面的列表可能更短或更长，手动编辑所有部署可能需要相当长的时间。以下是来自<code class="fe lw lx ly lz b">cert-admin</code>文档的指令，用于自动执行该过程:</p><blockquote class="pd pe pf"><p id="7088" class="la lb nf lc b ld le jv lf lg lh jy li pg lk ll lm ph lo lp lq pi ls lt lu lv in bi translated"><em class="iu"> #首先，为您的给定平台下载二进制文件</em> <br/> <code class="fe lw lx ly lz b">wget -O api-migration https://github.com/jetstack/cert-manager/releases/download/v0.11.0/api-migration-linux</code> <br/> <em class="iu"> #或者为Darwin</em><br/><code class="fe lw lx ly lz b">wget -O api-migration https://github.com/jetstack/cert-manager/releases/download/v0.11.0/api-migration-darwin</code><br/><br/><em class="iu">#将二进制文件标记为可执行文件，并针对您的集群运行该二进制文件</em> <br/> <code class="fe lw lx ly lz b">chmod +x api-migration &amp;&amp; ./api-migration --kubeconfig /path/to/my/kubeconfig.yaml</code> <br/> <br/> <em class="iu"> #按照命令行输出并检查文件</em> <br/> <code class="fe lw lx ly lz b">diff ingress.yaml ingress-migrated.yaml</code> <br/> <br/> <em class="iu"> #最后，检查完新的入口资源后</em></p></blockquote><h2 id="d3e5" class="nl mj iu bd mk nm nn dn mo no np dp ms lj nq nr mu ln ns nt mw lr nu nv my nw bi translated">重新引入集群发行者</h2><p id="719a" class="pw-post-body-paragraph la lb iu lc b ld na jv lf lg nb jy li lj nc ll lm ln nd lp lq lr ne lt lu lv in bi translated">好了，我们快完成了。我们完成迁移需要做的最后一件事是重新引入集群发布者(如果您喜欢将<code class="fe lw lx ly lz b">kind</code>注释改为<code class="fe lw lx ly lz b">Issuer</code>，也可以选择每个名称空间发布者)。</p><p id="de78" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">下面的摘录使用HTTP01流创建了两个使用加密阶段和生产的集群发布者。</p><pre class="kk kl km kn gu om lz on oo aw op bi"><span id="54ea" class="nl mj iu lz b gz oq or l os ot">---<br/>apiVersion: cert-manager.io/v1alpha2<br/>kind: ClusterIssuer<br/>metadata:<br/>  name: letsencrypt-staging<br/>spec:<br/>  acme:<br/>    email: <a class="ae kz" href="mailto:esthesis@eurodyn.com" rel="noopener ugc nofollow" target="_blank">e</a>xample@example.com<br/>    server: <a class="ae kz" href="https://acme-staging-v02.api.letsencrypt.org/directory" rel="noopener ugc nofollow" target="_blank">https://acme-staging-v02.api.letsencrypt.org/directory</a><br/>    privateKeySecretRef:<br/>      name: letsencrypt-staging-account-key<br/>    solvers:<br/>    - http01:<br/>        ingress:<br/>          class: nginx</span><span id="4995" class="nl mj iu lz b gz ov or l os ot">---<br/>apiVersion: cert-manager.io/v1alpha2<br/>kind: ClusterIssuer<br/>metadata:<br/>  name: letsencrypt-prod<br/>spec:<br/>  acme:<br/>    email: <a class="ae kz" href="mailto:esthesis@eurodyn.com" rel="noopener ugc nofollow" target="_blank">e</a>xample@example.com<br/>    server: <a class="ae kz" href="https://acme-v02.api.letsencrypt.org/directory" rel="noopener ugc nofollow" target="_blank">https://acme-v02.api.letsencrypt.org/directory</a><br/>    privateKeySecretRef:<br/>      name: letsencrypt-prod-account-key<br/>    solvers:<br/>    - http01:<br/>        ingress:<br/>          class: nginx</span></pre><p id="0d85" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">一两分钟后，您的所有入口都将更新为指向新颁发的证书。请记住，如果您以前的证书不在续订窗口内(目前是到期前30天)，您将不会注意到任何差异。</p></div></div>    
</body>
</html>