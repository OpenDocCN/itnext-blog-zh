<html>
<head>
<title>React Hooks — designing a simple forms API — part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">React钩子——设计简单的表单API——第2部分</h1>
<blockquote>原文：<a href="https://itnext.io/react-hooks-designing-a-simple-forms-api-part-2-1fe5d12f23d9?source=collection_archive---------3-----------------------#2019-03-27">https://itnext.io/react-hooks-designing-a-simple-forms-api-part-2-1fe5d12f23d9?source=collection_archive---------3-----------------------#2019-03-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="8164" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本系列的第1部分<a class="ae ko" href="https://medium.com/@shanplourde/react-hooks-designing-a-simple-forms-api-part-1-307b04bc6007" rel="noopener">中，我们研究了如何使用React钩子来设计一个<code class="fe kp kq kr ks b">useForm</code> React表单库。第1部分介绍了这个库的动机和一些总体设计目标。</a></p><p id="b83f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在第2部分中，我们将创建一个<code class="fe kp kq kr ks b">useInput</code>钩子，回顾状态管理，合并一些额外的测试，更详细地回顾测试策略，并扩展我们从第1部分开始的解决方案。让我们开始吧！</p><p id="46ce" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对了，<a class="ae ko" rel="noopener ugc nofollow" target="_blank" href="/react-hooks-designing-a-simple-forms-api-part-3-validation-and-a-running-example-18b835a3b817"> part 3 </a>和<a class="ae ko" rel="noopener ugc nofollow" target="_blank" href="/react-hooks-designing-a-simple-forms-api-part-4-scaling-to-other-input-types-e738db0a3fc3"> part 4 </a>上线了💪。</p><h1 id="6f6f" class="kt ku it bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">为<code class="fe kp kq kr ks b">useInput</code>设计公共API</h1><p id="9537" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated">我发现设计hooks APIs的最佳起点是首先理解你希望它做什么，然后你将如何使用它。在第1部分中，我们创建了<code class="fe kp kq kr ks b">useForm</code>钩子，但是它本身是没有用的。输入控件也需要得到支持，以便消费者能够连接一个完整的HTML表单。</p><h2 id="0d75" class="lw ku it bd kv lx ly dn kz lz ma dp ld kb mb mc lh kf md me ll kj mf mg lp mh bi translated">我们希望useInput做什么</h2><ul class=""><li id="c50b" class="mi mj it js b jt lr jx ls kb mk kf ml kj mm kn mn mo mp mq bi translated"><code class="fe kp kq kr ks b">useInput</code>钩子将是HTML输入的状态管理钩子。它将跟踪输入到输入中的值，并将跟踪关于给定输入的一些附加状态属性</li><li id="b74c" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated"><code class="fe kp kq kr ks b">useInput</code>钩子应该跟踪用户是否已经“访问”了输入字段</li><li id="5ebd" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated"><code class="fe kp kq kr ks b">useInput</code>钩子应该跟踪输入的值是否不同于它的原始值</li></ul><h2 id="3288" class="lw ku it bd kv lx ly dn kz lz ma dp ld kb mb mc lh kf md me ll kj mf mg lp mh bi translated">我们希望消费者如何使用useInput？</h2><p id="f909" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated">对于我们的新<code class="fe kp kq kr ks b">useInput</code>钩子，我们需要考虑如何管理这个新钩子。我们希望表单库的最终用户直接使用<code class="fe kp kq kr ks b">useInput</code>钩子吗？还是应该与最终用户隔离开来？对我来说，要回答这个问题，我们应该考虑如何管理表单上所有输入的状态。</p><figure class="mx my mz na gt nb gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi mw"><img src="../Images/f701d14ea5d1aec735df0adcb13d0801.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ikxCEPA5SK2whp02FBYcIw.png"/></div></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">图1-使用表单和使用输入状态管理和API使用</figcaption></figure><p id="6afa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如图1所示，我希望表单消费者直接使用<code class="fe kp kq kr ks b">useForm</code>钩子，让<code class="fe kp kq kr ks b">useForm</code>直接管理所有的<code class="fe kp kq kr ks b">useInput</code>钩子。我更希望消费者不必自己处理管理所有的<code class="fe kp kq kr ks b">useInput</code>挂钩。原因是:</p><ul class=""><li id="f106" class="mi mj it js b jt ju jx jy kb nm kf nn kj no kn mn mo mp mq bi translated"><code class="fe kp kq kr ks b">useForm</code>作为整体窗体的钩子应该对一个窗体的整体状态负责。否则，如果消费者直接使用<code class="fe kp kq kr ks b">useInput</code>钩子，表单的状态管理可能会令人困惑</li><li id="700a" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated">我想保持使用模式简单和一致</li><li id="bc6f" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated">如果需要的话，通过扩展<code class="fe kp kq kr ks b">useForm</code>钩子API，将来可以很容易地扩展<code class="fe kp kq kr ks b">useForm</code>以支持定制输入</li></ul><h2 id="4a68" class="lw ku it bd kv lx ly dn kz lz ma dp ld kb mb mc lh kf md me ll kj mf mg lp mh bi translated">状态管理</h2><p id="8916" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated">如图1所示，<code class="fe kp kq kr ks b">useForm</code>和<code class="fe kp kq kr ks b">useInput</code>都管理自己的状态。<code class="fe kp kq kr ks b">useInput</code>将保持代表输入值的内部状态，以及输入是否被访问过，以及输入值是否已经改变。<code class="fe kp kq kr ks b">useForm</code>将冗余地存储它正在跟踪的所有输入。从这个意义上说，<code class="fe kp kq kr ks b">useForm</code>将是跟踪表单上所有输入值的主要位置。这将使API的最终消费者更容易处理表单值，因为<code class="fe kp kq kr ks b">useForm</code>将能够以一种易于消费者使用的方式呈现表单值。</p><p id="8eae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">输入表单将通过<code class="fe kp kq kr ks b">useForm</code>钩子接收所有的表单状态。</p><h2 id="ea80" class="lw ku it bd kv lx ly dn kz lz ma dp ld kb mb mc lh kf md me ll kj mf mg lp mh bi translated">使用输入挂钩源代码和说明</h2><p id="8927" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated">在我们的<code class="fe kp kq kr ks b">useInput</code>钩子的第一次迭代中，我们跟踪状态中的3个事物。当前输入值— <code class="fe kp kq kr ks b">inputValue</code>、<code class="fe kp kq kr ks b">originalValue</code>跟踪输入是否被更新，最后<code class="fe kp kq kr ks b">visited</code>跟踪用户是否访问了输入字段。</p><p id="3d19" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">钩子返回一个对象，该对象具有表示输入状态的属性和一些API函数，钩子的使用者可以使用这些函数来改变输入的状态。</p><p id="5628" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们向从钩子返回的对象添加一个<code class="fe kp kq kr ks b">pristine</code>派生属性，它将原始值与输入值进行比较。</p><pre class="mx my mz na gt np ks nq nr aw ns bi"><span id="3ad2" class="lw ku it ks b gy nt nu l nv nw">import { useState } from "react";</span><span id="a987" class="lw ku it ks b gy nx nu l nv nw">export const useInput = ({ name, value, props = {} }) =&gt; {<br/>  const [inputValue, setInputValue] = useState(value);<br/>  const [originalValue] = useState(value);<br/>  const [visited, setVisited] = useState(false);</span><span id="82a1" class="lw ku it ks b gy nx nu l nv nw">const getInputProps = () =&gt; ({<br/>    id: name,<br/>    value: inputValue,<br/>    ...props,<br/>    onChange: event =&gt; {<br/>      const val = event.target.value;<br/>      setInputValue(val);<br/>      props.onChange &amp;&amp; props.onChange(name, val);<br/>    },<br/>    onFocus: evt =&gt; {<br/>      setVisited(true);<br/>    }<br/>  });</span><span id="b3e5" class="lw ku it ks b gy nx nu l nv nw">return {<br/>    id: name,<br/>    value: inputValue,<br/>    api: {<br/>      setValue: val =&gt; {<br/>        setInputValue(val);<br/>      }<br/>    },<br/>    uiState: {<br/>      visited,<br/>      pristine: inputValue === originalValue<br/>    },<br/>    getInputProps<br/>  };<br/>};</span></pre><h2 id="872c" class="lw ku it bd kv lx ly dn kz lz ma dp ld kb mb mc lh kf md me ll kj mf mg lp mh bi translated">添加到<code class="fe kp kq kr ks b">useForm</code>以支持向表单添加新输入</h2><p id="cec6" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated">由于<code class="fe kp kq kr ks b">useForm</code>将是使用<code class="fe kp kq kr ks b">useInput</code>钩子的主要入口点，我们需要添加入口点，并更新<code class="fe kp kq kr ks b">useForm</code>钩子来跟踪输入状态。下面显示了<code class="fe kp kq kr ks b">useForm</code>钩子的源代码，与<code class="fe kp kq kr ks b">useInput</code>相关的代码以粗体显示。</p><p id="c864" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe kp kq kr ks b">useForm</code>通过<code class="fe kp kq kr ks b">onInputChange</code>功能跟踪输入的变化。这个函数设置<code class="fe kp kq kr ks b">formValues</code>属性，这是一个简单的键值对对象，其中键是输入名称，值是输入值。例如，如果一个表单有输入字段<code class="fe kp kq kr ks b">firstName</code>和<code class="fe kp kq kr ks b">lastName</code>，<code class="fe kp kq kr ks b">formValues</code>将如下所示:</p><pre class="mx my mz na gt np ks nq nr aw ns bi"><span id="eaf1" class="lw ku it ks b gy nt nu l nv nw">{ firstName: 'firstNameValue', lastName: 'lastNameValue' } </span></pre><p id="120b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe kp kq kr ks b">formValues</code>被<code class="fe kp kq kr ks b">useForm</code>的消费者用来轻松接收表单值的键/值对列表。</p><p id="cb58" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您会注意到我们没有为<code class="fe kp kq kr ks b">formValues</code>使用useState的set属性。如果我们这样做，React将会遇到一个循环更新问题，所以我们改变了<code class="fe kp kq kr ks b">formValues</code>的值。我更倾向于解决这个问题，这样就不需要突变，如果你们中的任何人对此有任何建议，我将不胜感激。</p><p id="686d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe kp kq kr ks b">addInput</code>是消费者用来向表单添加输入的API。<code class="fe kp kq kr ks b">addInput</code>函数的初始版本接收输入名称和值。在内部，<code class="fe kp kq kr ks b">useForm</code>钩子调用<code class="fe kp kq kr ks b">useInput</code>钩子初始化输入。此外，<code class="fe kp kq kr ks b">useForm</code>然后更新它的内部输入集合和表单值。</p><pre class="mx my mz na gt np ks nq nr aw ns bi"><span id="b07c" class="lw ku it ks b gy nt nu l nv nw">import { useState } from "react";<br/>import { useInput } from "./use-input";</span><span id="6bc2" class="lw ku it ks b gy nx nu l nv nw">export const defaultFormProps = {<br/>  autoComplete: "on"<br/>};<br/>export const useForm = (name, initialState = {}) =&gt; {<br/>  const [formValues] = useState({<br/>    ...initialState<br/>  });<br/>  const [uiState, setUiState] = useState({<br/>    isSubmitting: false<br/>  });<br/><strong class="ks iu">  const [inputs] = useState({});</strong></span><span id="a193" class="lw ku it ks b gy nx nu l nv nw">const getFormProps = (props = {}) =&gt; ({<br/>    ...defaultFormProps,<br/>    ...props,<br/>    onSubmit: async evt =&gt; {<br/>      evt.preventDefault();<br/>      try {<br/>        setUiState({ isSubmitting: true });<br/>        props.onSubmit &amp;&amp; (await props.onSubmit({ evt, formValues }));<br/>      } finally {<br/>        setUiState({ isSubmitting: false });<br/>      }<br/>    }<br/>  });</span><span id="74a7" class="lw ku it ks b gy nx nu l nv nw"><strong class="ks iu">const onInputChange = (name, value) =&gt; {<br/>    formValues[name] = value;<br/>  };</strong></span><span id="4265" class="lw ku it ks b gy nx nu l nv nw"><strong class="ks iu">const addInput = ({ name, value }) =&gt; {<br/>    const input = useInput({<br/>      name,<br/>      value,<br/>      props: { onChange: onInputChange }<br/>    });<br/>    inputs[name] = input;<br/>    formValues[name] = value;<br/>    return input;<br/>  };</strong></span><span id="33f1" class="lw ku it ks b gy nx nu l nv nw">return {<br/>    getFormProps,<br/>    formValues,<br/>    uiState,<br/>    inputs,<br/><strong class="ks iu">    api: {<br/>      addInput<br/>    }<br/></strong>  };<br/>};</span></pre><h1 id="2f11" class="kt ku it bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">测试策略</h1><p id="f99a" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated">在开发的这个阶段，我们的库本质上仍然是React hooks。出于这个原因，我们将继续使用Jest和<a class="ae ko" href="https://www.npmjs.com/package/react-hooks-testing-library" rel="noopener ugc nofollow" target="_blank">react-hooks-testing-library</a>。库是用来测试钩子的。它为单元测试挂钩提供了一个简单的组件包装器和实用工具。</p><p id="a052" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然而，我们也应该用样本表单测试钩子。在API的开发过程中，我创建了一个简单的表单来验证钩子。不过，我们可能希望尽快开始测试样本表单，以便对<code class="fe kp kq kr ks b">useForm</code>构建的输入表单进行端到端验证。对于这种测试，我可能会选择<a class="ae ko" href="https://github.com/kentcdodds/react-testing-library" rel="noopener ugc nofollow" target="_blank">反应测试库</a>。</p><p id="ee21" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，我们可以为<code class="fe kp kq kr ks b">useInput</code>钩子添加测试，并更新<code class="fe kp kq kr ks b">useForm</code>测试。</p><h2 id="d475" class="lw ku it bd kv lx ly dn kz lz ma dp ld kb mb mc lh kf md me ll kj mf mg lp mh bi translated">使用输入单元测试</h2><p id="980a" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated">我测试<code class="fe kp kq kr ks b">useInput</code>的目标是试图从黑盒的角度测试API的所有方面，以及它跟踪的状态。测试也很好地解读了<code class="fe kp kq kr ks b">useInput</code>打算提供的特性。</p><pre class="mx my mz na gt np ks nq nr aw ns bi"><span id="8441" class="lw ku it ks b gy nt nu l nv nw">import { renderHook, cleanup, act } from "react-hooks-testing-library";<br/>import { useInput } from "./use-input";</span><span id="195c" class="lw ku it ks b gy nx nu l nv nw">describe("useInput tests", () =&gt; {<br/>  afterEach(cleanup);</span><span id="2a86" class="lw ku it ks b gy nx nu l nv nw">it("should initialize an input", () =&gt; {<br/>    const { result } = renderHook(() =&gt;<br/>      useInput({ name: "test", value: "123" })<br/>    );<br/>    const { id, value, api, uiState, getInputProps } = result.current;<br/>    expect(id).toEqual("test");<br/>    expect(value).toEqual("123");<br/>    expect(api).toBeDefined();<br/>    expect(uiState).toBeDefined();<br/>    expect(getInputProps).toBeDefined();<br/>  });</span><span id="f1b0" class="lw ku it ks b gy nx nu l nv nw">it("should support reset", () =&gt; {<br/>    const { result } = renderHook(() =&gt;<br/>      useInput({ name: "test", value: "123" })<br/>    );<br/>    expect(result.current.value).toEqual("123");<br/>    act(() =&gt; {<br/>      result.current.api.setValue("");<br/>    });<br/>    expect(result.current.value).toEqual("");<br/>  });</span><span id="6b94" class="lw ku it ks b gy nx nu l nv nw">it("should support custom input props", () =&gt; {<br/>    const { result } = renderHook(() =&gt;<br/>      useInput({ name: "test", value: "123" })<br/>    );<br/>    expect(result.current.value).toEqual("123");<br/>    act(() =&gt; {<br/>      result.current.api.setValue("");<br/>    });<br/>    expect(result.current.value).toEqual("");<br/>  });</span><span id="4678" class="lw ku it ks b gy nx nu l nv nw">it("should change visited state on focus", () =&gt; {<br/>    const { result } = renderHook(() =&gt;<br/>      useInput({ name: "test", value: "123" })<br/>    );<br/>    expect(result.current.uiState.visited).toEqual(false);<br/>    act(() =&gt; {<br/>      result.current.getInputProps().onFocus();<br/>    });<br/>    expect(result.current.uiState.visited).toEqual(true);<br/>  });</span><span id="c312" class="lw ku it ks b gy nx nu l nv nw">it("should change pristine after API setValue", () =&gt; {<br/>    const { result } = renderHook(() =&gt;<br/>      useInput({ name: "test", value: "123" })<br/>    );<br/>    expect(result.current.uiState.pristine).toEqual(true);<br/>    act(() =&gt; {<br/>      result.current.api.setValue("234");<br/>    });<br/>    expect(result.current.uiState.pristine).toEqual(false);<br/>    act(() =&gt; {<br/>      result.current.api.setValue("123");<br/>    });<br/>    expect(result.current.uiState.pristine).toEqual(true);<br/>  });</span><span id="d11c" class="lw ku it ks b gy nx nu l nv nw">it("should change pristine and value when onChange event is triggered", () =&gt; {<br/>    const { result } = renderHook(() =&gt;<br/>      useInput({ name: "test", value: "123" })<br/>    );<br/>    act(() =&gt; {<br/>      result.current.getInputProps().onChange({<br/>        target: { value: "234" }<br/>      });<br/>    });<br/>    expect(result.current.uiState.pristine).toEqual(false);<br/>    expect(result.current.value).toEqual("234");</span><span id="24dd" class="lw ku it ks b gy nx nu l nv nw">act(() =&gt; {<br/>      result.current.getInputProps().onChange({<br/>        target: { value: "123" }<br/>      });<br/>    });<br/>    expect(result.current.uiState.pristine).toEqual(true);<br/>    expect(result.current.value).toEqual("123");<br/>  });<br/>});</span></pre><h2 id="6b42" class="lw ku it bd kv lx ly dn kz lz ma dp ld kb mb mc lh kf md me ll kj mf mg lp mh bi translated">使用表单单元测试更新</h2><p id="7d6d" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated"><code class="fe kp kq kr ks b">useForm</code>现在有了用于输入的API，useForm的API与第1部分相比略有变化，只是稍微清理了一下API。因此，此时的全套测试如下:</p><pre class="mx my mz na gt np ks nq nr aw ns bi"><span id="108e" class="lw ku it ks b gy nt nu l nv nw">import { renderHook, cleanup, act } from "react-hooks-testing-library";<br/>import { useForm } from "./use-form";</span><span id="1728" class="lw ku it ks b gy nx nu l nv nw">const noop = () =&gt; {};</span><span id="9a80" class="lw ku it ks b gy nx nu l nv nw">jest.useFakeTimers();</span><span id="eb82" class="lw ku it ks b gy nx nu l nv nw">describe("useForm tests", () =&gt; {<br/>  afterEach(cleanup);</span><span id="7042" class="lw ku it ks b gy nx nu l nv nw">it("should return empty form props and form state", () =&gt; {<br/>    const { result } = renderHook(() =&gt; useForm());<br/>    const { getFormProps, formValues } = result.current;<br/>    expect(getFormProps).toBeDefined();<br/>    expect(formValues).toEqual({});<br/>  });</span><span id="8c31" class="lw ku it ks b gy nx nu l nv nw">it("should return an initial uiState", () =&gt; {<br/>    const { result } = renderHook(() =&gt; useForm());<br/>    const { uiState } = result.current;<br/>    expect(uiState).toEqual({<br/>      isSubmitting: false<br/>    });<br/>  });</span><span id="7de7" class="lw ku it ks b gy nx nu l nv nw">it("should support custom form props", () =&gt; {<br/>    const { result } = renderHook(() =&gt; useForm());<br/>    const { getFormProps } = result.current;<br/>    const formProps = getFormProps({ foo: "bar" });<br/>    expect(formProps.foo).toEqual("bar");<br/>  });</span><span id="6852" class="lw ku it ks b gy nx nu l nv nw">it("should support custom onSubmit", async () =&gt; {<br/>    const { result } = renderHook(() =&gt; useForm());<br/>    const { getFormProps, uiState } = result.current;</span><span id="66d9" class="lw ku it ks b gy nx nu l nv nw">const onSubmit = jest.fn();</span><span id="4afc" class="lw ku it ks b gy nx nu l nv nw">const formProps = getFormProps({ onSubmit });<br/>    expect(formProps.onSubmit).toBeDefined();</span><span id="5a9d" class="lw ku it ks b gy nx nu l nv nw">// Could be some weirdness right now due to<br/>    // <a class="ae ko" href="https://github.com/facebook/react/issues/14769" rel="noopener ugc nofollow" target="_blank">https://github.com/facebook/react/issues/14769</a><br/>    act(() =&gt; {<br/>      formProps.onSubmit({ preventDefault: noop });<br/>    });<br/>    expect(uiState).toEqual({<br/>      isSubmitting: false<br/>    });<br/>    expect(onSubmit).toHaveBeenCalledTimes(1);<br/>  });</span><span id="e697" class="lw ku it ks b gy nx nu l nv nw">it("should support async onSubmit", async () =&gt; {<br/>    const { waitForNextUpdate, result } = renderHook(() =&gt; useForm());<br/>    const { getFormProps, uiState } = result.current;</span><span id="14d8" class="lw ku it ks b gy nx nu l nv nw">const onSubmit = evt =&gt;<br/>      new Promise(r =&gt; {<br/>        setTimeout(() =&gt; {<br/>          r();<br/>        }, 1000);<br/>      });</span><span id="fdda" class="lw ku it ks b gy nx nu l nv nw">const formProps = getFormProps({ onSubmit });<br/>    expect(formProps.onSubmit).toBeDefined();</span><span id="ebf3" class="lw ku it ks b gy nx nu l nv nw">// Could be some weirdness right now due to<br/>    // <a class="ae ko" href="https://github.com/facebook/react/issues/14769" rel="noopener ugc nofollow" target="_blank">https://github.com/facebook/react/issues/14769</a><br/>    act(() =&gt; {<br/>      formProps.onSubmit({ preventDefault: noop });<br/>    });<br/>    jest.runAllTimers();<br/>    expect(result.current.uiState).toEqual({<br/>      isSubmitting: true<br/>    });<br/>    await waitForNextUpdate();<br/>    expect(uiState).toEqual({<br/>      isSubmitting: false<br/>    });<br/>  });</span><span id="47e9" class="lw ku it ks b gy nx nu l nv nw">it("should gracefully handle onSubmit errors", async () =&gt; {<br/>    const { result } = renderHook(() =&gt; useForm());<br/>    const { getFormProps, uiState } = result.current;</span><span id="7d85" class="lw ku it ks b gy nx nu l nv nw">const onSubmit = evt =&gt; new Error();</span><span id="ea90" class="lw ku it ks b gy nx nu l nv nw">const formProps = getFormProps({ onSubmit });<br/>    expect(formProps.onSubmit).toBeDefined();</span><span id="c478" class="lw ku it ks b gy nx nu l nv nw">// Could be some weirdness right now due to<br/>    // <a class="ae ko" href="https://github.com/facebook/react/issues/14769" rel="noopener ugc nofollow" target="_blank">https://github.com/facebook/react/issues/14769</a><br/>    act(() =&gt; {<br/>      formProps.onSubmit({ preventDefault: noop });<br/>    });<br/>    expect(uiState).toEqual({<br/>      isSubmitting: false<br/>    });<br/>  });</span><span id="35dc" class="lw ku it ks b gy nx nu l nv nw">it("should gracefully handle async onSubmit errors", async () =&gt; {<br/>    const { waitForNextUpdate, result } = renderHook(() =&gt; useForm());<br/>    const { getFormProps, uiState } = result.current;</span><span id="c348" class="lw ku it ks b gy nx nu l nv nw">const onSubmit = evt =&gt;<br/>      new Promise((resolve, reject) =&gt; {<br/>        setTimeout(() =&gt; {<br/>          reject();<br/>        }, 1000);<br/>      });</span><span id="8214" class="lw ku it ks b gy nx nu l nv nw">const formProps = getFormProps({ onSubmit });<br/>    expect(formProps.onSubmit).toBeDefined();</span><span id="95f3" class="lw ku it ks b gy nx nu l nv nw">// Could be some weirdness right now due to<br/>    // <a class="ae ko" href="https://github.com/facebook/react/issues/14769" rel="noopener ugc nofollow" target="_blank">https://github.com/facebook/react/issues/14769</a><br/>    act(() =&gt; {<br/>      formProps.onSubmit({ preventDefault: noop });<br/>    });<br/>    jest.runAllTimers();<br/>    expect(result.current.uiState).toEqual({<br/>      isSubmitting: true<br/>    });<br/>    await waitForNextUpdate();<br/>    expect(uiState).toEqual({<br/>      isSubmitting: false<br/>    });<br/>  });</span><span id="e646" class="lw ku it ks b gy nx nu l nv nw">it("should be able to add inputs", () =&gt; {<br/>    const { result } = renderHook(() =&gt; useForm());<br/>    const { api } = result.current;<br/>    expect(api).toBeDefined();</span><span id="09fa" class="lw ku it ks b gy nx nu l nv nw">renderHook(() =&gt; api.addInput({ name: "test", value: "123" }));<br/>    expect(result.current.formValues).toEqual({ test: "123" });<br/>    expect(result.current.inputs.test).toBeDefined();<br/>    let inputProps = result.current.inputs.test.getInputProps();<br/>    expect(inputProps.id).toEqual("test");<br/>    expect(inputProps.value).toEqual("123");</span><span id="f0dc" class="lw ku it ks b gy nx nu l nv nw">renderHook(() =&gt; api.addInput({ name: "secondtest", value: "234" }));<br/>    expect(result.current.formValues).toEqual({<br/>      test: "123",<br/>      secondtest: "234"<br/>    });<br/>    expect(result.current.inputs.test).toBeDefined();<br/>    inputProps = result.current.inputs.secondtest.getInputProps();<br/>    expect(inputProps.id).toEqual("secondtest");<br/>    expect(inputProps.value).toEqual("234");<br/>  });<br/>});</span></pre><h2 id="7ede" class="lw ku it bd kv lx ly dn kz lz ma dp ld kb mb mc lh kf md me ll kj mf mg lp mh bi translated">使用示例表单进行测试</h2><p id="ac51" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated">最后，这是使用示例表单进行测试的当前代码。</p><pre class="mx my mz na gt np ks nq nr aw ns bi"><span id="daab" class="lw ku it ks b gy nt nu l nv nw">import React from "react";<br/>import { useForm } from "../../components/form/use-form";<br/>import { sleep } from "../../utils/async";</span><span id="7ab4" class="lw ku it ks b gy nx nu l nv nw">function SampleForm(props) {<br/>  const { getFormProps, formValues, uiState, api } = useForm("settingsForm", {<br/>    firstName: "George",<br/>    lastName: "OfTheJungle",<br/>    email: "<a class="ae ko" href="mailto:george@thejungle.com" rel="noopener ugc nofollow" target="_blank">george@thejungle.com</a>"<br/>  });<br/>  const firstName = api.addInput({<br/>    name: "firstName",<br/>    value: formValues.firstName<br/>  });<br/>  const lastName = api.addInput({<br/>    name: "lastName",<br/>    value: formValues.lastName<br/>  });<br/>  const email = api.addInput({<br/>    name: "email",<br/>    value: formValues.email<br/>  });</span><span id="1339" class="lw ku it ks b gy nx nu l nv nw">const onSubmit = async ({ evt, formValues }) =&gt; {<br/>    evt.preventDefault();<br/>    await sleep(2000);<br/>    console.log("sample-form onSubmit", formValues);<br/>  };</span><span id="e515" class="lw ku it ks b gy nx nu l nv nw">return (<br/>    &lt;div&gt;<br/>      &lt;h2&gt;Settings&lt;/h2&gt;<br/>      {uiState.isSubmitting &amp;&amp; &lt;div&gt;Submitting&lt;/div&gt;}<br/>      &lt;form {...getFormProps({ onSubmit })}&gt;<br/>        &lt;div&gt;<br/>          &lt;label htmlFor={firstName.id}&gt;<br/>            First name {JSON.stringify(firstName.uiState)} *<br/>          &lt;/label&gt;<br/>          &lt;input type="text" {...firstName.getInputProps()} /&gt;<br/>        &lt;/div&gt;</span><span id="731c" class="lw ku it ks b gy nx nu l nv nw">&lt;div&gt;<br/>          &lt;label htmlFor={lastName.id}&gt;<br/>            Last name {JSON.stringify(lastName.uiState)} *<br/>          &lt;/label&gt;<br/>          &lt;input type="text" {...lastName.getInputProps()} /&gt;<br/>        &lt;/div&gt;</span><span id="5141" class="lw ku it ks b gy nx nu l nv nw">&lt;div&gt;<br/>          &lt;label htmlFor={email.id}&gt;<br/>            Email address {JSON.stringify(email.uiState)}*<br/>          &lt;/label&gt;<br/>          &lt;input type="text" {...email.getInputProps()} /&gt;<br/>        &lt;/div&gt;</span><span id="ce69" class="lw ku it ks b gy nx nu l nv nw">&lt;div&gt;* - Indicates required field&lt;/div&gt;</span><span id="6c7e" class="lw ku it ks b gy nx nu l nv nw">&lt;div&gt;<br/>          &lt;button type="submit"&gt;Save&lt;/button&gt;<br/>        &lt;/div&gt;<br/>      &lt;/form&gt;<br/>    &lt;/div&gt;<br/>  );<br/>}</span><span id="fd87" class="lw ku it ks b gy nx nu l nv nw">export { SampleForm };</span></pre><h1 id="88dd" class="kt ku it bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">摘要</h1><p id="f5bb" class="pw-post-body-paragraph jq jr it js b jt lr jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn im bi translated">在这篇文章中，我们设计了<code class="fe kp kq kr ks b">useInput</code>钩子，修改了<code class="fe kp kq kr ks b">useForm</code>钩子来支持它，在useForm中创建了一个API供表单创建者使用，并决定了在解决方案中管理的状态。我们还编写了几个单元测试，以确保在开发过程中尽可能多地进行测试，并且更新了示例页面。</p><p id="0a2b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在第3部分中，我们将讨论验证、异步验证和异步表单提交。在后面的部分中，我计划深入研究React解决方案的性能含义，以及设计优化等。</p><p id="6d3b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您有任何问题、反馈或建议，或者您希望我介绍本系列中的其他内容，请告诉我。</p></div></div>    
</body>
</html>