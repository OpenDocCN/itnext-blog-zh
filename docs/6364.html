<html>
<head>
<title>Leader election in Kubernetes using client-go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用client-go在Kubernetes进行领导人选举</h1>
<blockquote>原文：<a href="https://itnext.io/leader-election-in-kubernetes-using-client-go-a19cbe7a9a85?source=collection_archive---------0-----------------------#2021-10-27">https://itnext.io/leader-election-in-kubernetes-using-client-go-a19cbe7a9a85?source=collection_archive---------0-----------------------#2021-10-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="14be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">如果你想了解领导人选举以及Kubernetes的工作方式，那么我希望这篇文章对你有用。在这篇文章中，我们将讨论高可用性系统中领导者选举背后的思想，并探索kubernetes/client-go</em><em class="kl">库的</em> <a class="ae km" href="https://github.com/kubernetes/client-go" rel="noopener ugc nofollow" target="_blank"> <em class="kl">以在Kubernetes控制器的上下文中理解它。</em></a></p><h1 id="2347" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">介绍</h1><p id="d351" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">随着对可靠系统和基础设施需求的增加，术语“高可用性”近年来越来越流行。在分布式系统中，高可用性通常处理最大化正常运行时间和使系统容错。高可用性中一个常见的实践是使用冗余来最大限度地减少单点故障。为冗余准备您的系统和服务可能就像在负载平衡器后面部署更多的it副本一样简单。虽然这种配置可以用于许多应用程序，但有些用例需要跨副本仔细协调，才能使系统正常工作。</p><p id="81be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个很好的例子就是将Kubernetes控制器部署为多个实例。为了防止任何意外行为，领导者选举过程必须确保领导者在副本中被选出，并且是唯一主动协调集群的领导者。其他实例应该保持非活动状态，但准备好在主实例失败时接管。</p><h1 id="4136" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">Kubernetes的领导人选举</h1><p id="96e5" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">Kubernetes的领导人选举过程很简单。它从创建一个锁对象开始，其中的领导者定期更新当前的时间戳，作为通知其他复制品关于其领导地位的一种方式。这个锁对象可能是一个<code class="fe lq lr ls lt b">Lease</code>、<code class="fe lq lr ls lt b">ConfigMap</code>或一个<code class="fe lq lr ls lt b">Endpoint</code>，它也持有当前领导者的身份。如果领导者未能在给定的时间间隔内更新时间戳，则认为它已经崩溃，此时非活动副本通过用它们的身份更新锁来竞争获得领导权。成功获得锁的pod将成为新的领导者。</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi lu"><img src="../Images/132c2b4e895b40541918e6251419cb2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ea0yTtafuGKug1JdcN1YGg.png"/></div></div></figure><p id="5831" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们处理任何代码之前，让我们先看看这个过程的运行情况！</p><p id="f25e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一步是建立一个当地的Kubernetes集群。我将使用<a class="ae km" href="https://kind.sigs.k8s.io/docs/user/quick-start/" rel="noopener ugc nofollow" target="_blank">类型的</a>，但是你可以随意选择一个你喜欢的本地k8s发行版。</p><pre class="lv lw lx ly gt mg lt mh mi aw mj bi"><span id="d0a0" class="mk ko iq lt b gy ml mm l mn mo">$ kind create cluster<br/>Creating cluster "kind" ...<br/> ✓ Ensuring node image (kindest/node:v1.21.1) 🖼<br/> ✓ Preparing nodes 📦<br/> ✓ Writing configuration 📜<br/> ✓ Starting control-plane 🕹️<br/> ✓ Installing CNI 🔌<br/> ✓ Installing StorageClass 💾<br/>Set kubectl context to "kind-kind"<br/>You can now use your cluster with:</span><span id="e593" class="mk ko iq lt b gy mp mm l mn mo">kubectl cluster-info --context kind-kind</span><span id="a81b" class="mk ko iq lt b gy mp mm l mn mo">Not sure what to do next? 😅  Check out <a class="ae km" href="https://kind.sigs.k8s.io/docs/user/quick-start/" rel="noopener ugc nofollow" target="_blank">https://kind.sigs.k8s.io/docs/user/quick-start/</a></span></pre><p id="4f3b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用的示例应用程序可以在<a class="ae km" href="https://github.com/mayankshah1607/k8s-leader-election" rel="noopener ugc nofollow" target="_blank">这里</a>找到。它使用<a class="ae km" href="https://github.com/kubernetes/client-go" rel="noopener ugc nofollow" target="_blank"> kubernetes/client-go </a>来执行领导者选举。让我们在集群上安装应用程序:</p><pre class="lv lw lx ly gt mg lt mh mi aw mj bi"><span id="238c" class="mk ko iq lt b gy ml mm l mn mo"># Setup required permissions for creating/getting Lease objects<br/>$ kubectl apply -f rbac.yaml<br/>serviceaccount/leaderelection-sa created<br/>role.rbac.authorization.k8s.io/leaderelection-role created<br/>rolebinding.rbac.authorization.k8s.io/leaderelection-rolebinding created</span><span id="cd3a" class="mk ko iq lt b gy mp mm l mn mo"># Create deployment<br/>$ kubectl apply -f deploy.yaml<br/>deployment.apps/leaderelection created</span></pre><p id="6ca1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将创建一个包含3个单元(副本)的部署。如果您等待几秒钟，您应该会看到它们处于<code class="fe lq lr ls lt b">Running</code>状态。</p><pre class="lv lw lx ly gt mg lt mh mi aw mj bi"><span id="31c0" class="mk ko iq lt b gy ml mm l mn mo">❯ kubectl get pods<br/>NAME                              READY   STATUS    RESTARTS   AGE<br/>leaderelection-6d5b456c9d-cfd2l   1/1     Running   0          19s<br/>leaderelection-6d5b456c9d-n2kx2   1/1     Running   0          19s<br/>leaderelection-6d5b456c9d-ph8nj   1/1     Running   0          19s</span></pre><p id="4d5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦您运行了您的pod，让我们尝试查看他们作为领导者选举过程的一部分创建的<code class="fe lq lr ls lt b">Lease</code>锁对象。</p><pre class="lv lw lx ly gt mg lt mh mi aw mj bi"><span id="cb25" class="mk ko iq lt b gy ml mm l mn mo">$ kubectl describe lease my-lease</span><span id="ba09" class="mk ko iq lt b gy mp mm l mn mo">Name:         my-lease<br/>Namespace:    default<br/>Labels:       &lt;none&gt;<br/>Annotations:  &lt;none&gt;<br/>API Version:  coordination.k8s.io/v1<br/>Kind:         Lease<br/>Metadata:<br/>...<br/>Spec:<br/>  Acquire Time:            2021-10-23T06:51:50.605570Z<br/>  Holder Identity:         leaderelection-56457b6c5c-fn725<br/>  Lease Duration Seconds:  15<br/>  Lease Transitions:       0<br/>  Renew Time:              2021-10-23T06:52:45.309478Z<br/></span></pre><p id="3924" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据这一点，我们目前的领袖吊舱是<code class="fe lq lr ls lt b">leaderelection-56457bc5c-fn725</code>。让我们通过查看pod日志来验证这一点。</p><pre class="lv lw lx ly gt mg lt mh mi aw mj bi"><span id="8260" class="mk ko iq lt b gy ml mm l mn mo"># leader pod<br/>$ kubectl logs leaderelection-56457b6c5c-fn725</span><span id="ce4a" class="mk ko iq lt b gy mp mm l mn mo">I1023 06:51:50.605439       1 leaderelection.go:248] attempting to acquire leader lease default/my-lease...<br/>I1023 06:51:50.630111       1 leaderelection.go:258] successfully acquired lease default/my-lease<br/>I1023 06:51:50.630141       1 main.go:57] still the leader!<br/>I1023 06:51:50.630245       1 main.go:36] doing stuff...</span><span id="4b1c" class="mk ko iq lt b gy mp mm l mn mo"># inactive pods<br/>$ kubectl logs leaderelection-56457b6c5c-n857k<br/>I1023 06:51:55.400797       1 leaderelection.go:248] attempting to acquire leader lease default/my-lease...<br/>I1023 06:51:55.412780       1 main.go:60] new leader is %sleaderelection-56457b6c5c-fn725</span><span id="02b1" class="mk ko iq lt b gy mp mm l mn mo"># inactive pod<br/>$ kubectl logs leaderelection-56457b6c5c-s48kx<br/>I1023 06:51:52.905451       1 leaderelection.go:248] attempting to acquire leader lease default/my-lease...<br/>I1023 06:51:52.915618       1 main.go:60] new leader is %sleaderelection-56457b6c5c-fn725</span></pre><p id="8147" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">尝试删除leader pod来模拟坠机，如果选出了新的leader，则检查<code class="fe lq lr ls lt b">Lease</code>对象；)</p><h1 id="24b4" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">深潜代码</h1><blockquote class="mq mr ms"><p id="f2f4" class="jn jo kl jp b jq jr js jt ju jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj kk ij bi translated">这个项目的代码可以在<a class="ae km" href="https://github.com/mayankshah1607/k8s-leader-election" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p></blockquote><p id="a43c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里的基本思想是使用分布式锁定机制来决定哪个进程成为领导者。获得锁的进程开始执行所需的任务。<code class="fe lq lr ls lt b">main</code>函数是我们应用程序的入口。这里，我们创建一个对lock对象的引用，并开始一个领导者选举循环。</p><figure class="lv lw lx ly gt lz"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated"><a class="ae km" href="https://github.com/mayankshah1607/k8s-leader-election/blob/master/main.go#L66-L95" rel="noopener ugc nofollow" target="_blank">https://github . com/mayankshah 1607/k8s-leader-election/blob/master/main . go # L66-L95</a></figcaption></figure><p id="a368" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们首先解析<code class="fe lq lr ls lt b">lease-name</code>和<code class="fe lq lr ls lt b">lease-namespace</code>标志来获取副本必须使用的锁对象的名称和命名空间。环境变量<code class="fe lq lr ls lt b">POD_NAME</code>的值(填充在<a class="ae km" href="https://github.com/mayankshah1607/k8s-leader-election/blob/master/deploy.yaml#L26" rel="noopener ugc nofollow" target="_blank"> deploy.yaml </a>清单中)将用于识别<code class="fe lq lr ls lt b">Lease</code>对象中的领导者。最后，我们使用这些参数创建一个锁对象来启动领导者选举过程。</p><p id="52c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe lq lr ls lt b">runLeaderElection</code>函数中，我们通过调用<code class="fe lq lr ls lt b">RunOrDie</code>来启动领导者选举循环。我们传递一个<code class="fe lq lr ls lt b">LeaderElectionConfig</code>给它:</p><figure class="lv lw lx ly gt lz"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated"><a class="ae km" href="https://github.com/mayankshah1607/k8s-leader-election/blob/master/main.go#L41-L64" rel="noopener ugc nofollow" target="_blank">https://github . com/mayankshah 1607/k8s-leader-election/blob/master/main . go # L41-L64</a></figcaption></figure><p id="a8b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们来看看<code class="fe lq lr ls lt b">RunOrDie</code>在client-go中的实现。</p><figure class="lv lw lx ly gt lz"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated"><a class="ae km" href="https://github.com/kubernetes/client-go/blob/master/tools/leaderelection/leaderelection.go#L218-L227" rel="noopener ugc nofollow" target="_blank">https://github . com/kubernetes/client-go/blob/master/tools/leader election/leader election . go # L218-L227</a></figcaption></figure><p id="214d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它使用我们传递给它的<code class="fe lq lr ls lt b">LeaderElectorConfig</code>创建一个<code class="fe lq lr ls lt b">*LeaderElector</code>,并调用它的<code class="fe lq lr ls lt b">Run</code>方法:</p><figure class="lv lw lx ly gt lz"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated"><a class="ae km" href="https://github.com/kubernetes/client-go/blob/56656ba0e04ff501549162385908f5b7d14f5dc8/tools/leaderelection/leaderelection.go#L200-L213" rel="noopener ugc nofollow" target="_blank">https://github . com/kubernetes/client-go/blob/56656 ba 0 e 04 ff 501549162385908 F5 b 7d 14 F5 DC 8/tools/leader election/leader election . go # L200-L213</a></figcaption></figure><p id="80ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此方法负责运行领导者选举循环。它首先试图获取锁(使用<code class="fe lq lr ls lt b">le.acquire</code>)。成功后，它运行我们之前配置的<code class="fe lq lr ls lt b">OnStartedLeading</code>回调，并定期更新租约。在获取锁失败时，它简单地运行<code class="fe lq lr ls lt b">OnStoppedLeading</code>回调并返回。</p><p id="e1e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">实现<code class="fe lq lr ls lt b"><a class="ae km" href="https://github.com/kubernetes/client-go/blob/56656ba0e04ff501549162385908f5b7d14f5dc8/tools/leaderelection/leaderelection.go#L243" rel="noopener ugc nofollow" target="_blank">acquire</a></code>和<code class="fe lq lr ls lt b"><a class="ae km" href="https://github.com/kubernetes/client-go/blob/56656ba0e04ff501549162385908f5b7d14f5dc8/tools/leaderelection/leaderelection.go#L265" rel="noopener ugc nofollow" target="_blank">renew</a> </code>方法最重要的部分是对<code class="fe lq lr ls lt b"><a class="ae km" href="https://github.com/kubernetes/client-go/blob/56656ba0e04ff501549162385908f5b7d14f5dc8/tools/leaderelection/leaderelection.go#L317" rel="noopener ugc nofollow" target="_blank">tryAcquireOrRenew</a></code>的调用，它持有锁定机制的核心逻辑。</p><h2 id="dead" class="mk ko iq bd kp nc nd dn kt ne nf dp kx jy ng nh lb kc ni nj lf kg nk nl lj nm bi translated">乐观锁定(并发控制)</h2><p id="834e" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">领导者选举过程利用了Kubernetes操作的原子性质，以确保没有两个副本可以同时获得<code class="fe lq lr ls lt b">Lease</code>(否则会导致竞态条件和其他意外行为！).每当<code class="fe lq lr ls lt b">Lease</code>被更新(更新或收购)时，上面的<code class="fe lq lr ls lt b">resourceVersion</code>字段也会被Kubernetes更新。当另一个进程试图同时更新<code class="fe lq lr ls lt b">Lease</code>时，Kubernetes检查被更新对象的<code class="fe lq lr ls lt b">resourceVersion</code>字段是否与当前对象匹配——如果不匹配，更新就会失败，从而防止并发问题！</p><h1 id="3943" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">摘要</h1><p id="e6dd" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">在这篇文章中，我们讨论了领导者选举的概念，以及为什么它对于分布式系统的高可用性至关重要。我们看了一下这是如何在Kubernetes中使用<code class="fe lq lr ls lt b">Lease</code>锁实现的，并尝试使用<a class="ae km" href="https://github.com/kubernetes/client-go/blob/master/tools/leaderelection/leaderelection.go" rel="noopener ugc nofollow" target="_blank"> kubernetes/client-go </a>库自己实现它。此外，我们还试图理解Kubernetes如何使用原子操作和乐观锁定方法来防止并发性引起的问题。</p><blockquote class="mq mr ms"><p id="9486" class="jn jo kl jp b jq jr js jt ju jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj kk ij bi translated">还请注意，这篇文章中使用的代码不是一个生产就绪的解决方案，它是为了以一种简单的方式演示领导者选举而编写的！</p></blockquote><p id="c3f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你觉得这篇文章有帮助，请考虑鼓掌并与你的朋友和同事分享。您可以在以下网址找到我:</p><ul class=""><li id="3cb6" class="nn no iq jp b jq jr ju jv jy np kc nq kg nr kk ns nt nu nv bi translated">推特—<a class="ae km" href="https://twitter.com/mayankshah__" rel="noopener ugc nofollow" target="_blank">https://twitter.com/mayankshah__</a></li><li id="146e" class="nn no iq jp b jq nw ju nx jy ny kc nz kg oa kk ns nt nu nv bi translated">LinkedIn—<a class="ae km" href="https://www.linkedin.com/in/mayankshah1607/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/mayankshah1607/</a></li><li id="be9d" class="nn no iq jp b jq nw ju nx jy ny kc nz kg oa kk ns nt nu nv bi translated">GitHub—<a class="ae km" href="https://github.com/mayankshah1607" rel="noopener ugc nofollow" target="_blank">https://github.com/mayankshah1607</a></li></ul><p id="0b2b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">感谢您花时间阅读本文！</em></p><h1 id="859b" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">参考</h1><ul class=""><li id="b9ad" class="nn no iq jp b jq ll ju lm jy ob kc oc kg od kk ns nt nu nv bi translated"><a class="ae km" href="https://kubernetes.io/blog/2016/01/simple-leader-election-with-kubernetes/" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/blog/2016/01/simple-leader-election-with-kubernetes/</a></li><li id="929d" class="nn no iq jp b jq nw ju nx jy ny kc nz kg oa kk ns nt nu nv bi translated"><a class="ae km" href="https://medium.com/hybrid-cloud-hobbyist/leader-election-architecture-kubernetes-32600da81e3c" rel="noopener">https://medium . com/hybrid-cloud-hobbist/leader-election-architecture-kubernetes-32600 da 81 e3c</a></li><li id="b087" class="nn no iq jp b jq nw ju nx jy ny kc nz kg oa kk ns nt nu nv bi translated"><a class="ae km" href="https://carlosbecker.com/posts/k8s-leader-election/" rel="noopener ugc nofollow" target="_blank">https://carlosbecker.com/posts/k8s-leader-election/</a></li><li id="969c" class="nn no iq jp b jq nw ju nx jy ny kc nz kg oa kk ns nt nu nv bi translated"><a class="ae km" href="https://taesunny.github.io/kubernetes/kubernetes-controllers-leader-election-with-go-library/" rel="noopener ugc nofollow" target="_blank">https://tae sunny . github . io/kubernetes/kubernetes-controllers-leader-election-with-go-library/</a></li></ul></div></div>    
</body>
</html>