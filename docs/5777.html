<html>
<head>
<title>How We Serve Millions of Pageviews using a NodeJS Airtable Proxy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我们如何使用NodeJS Airtable代理服务数百万的页面浏览量</h1>
<blockquote>原文：<a href="https://itnext.io/how-we-serve-millions-of-pageviews-using-a-nodejs-airtable-proxy-fdb4ec693720?source=collection_archive---------2-----------------------#2021-05-23">https://itnext.io/how-we-serve-millions-of-pageviews-using-a-nodejs-airtable-proxy-fdb4ec693720?source=collection_archive---------2-----------------------#2021-05-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d7fc" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">我们寻求一个无头CMS来取悦内容团队和开发团队</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e5a75d5e2eb0efc46aa66523bf01894b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*euBK8SPIOYxYb81LpccOvA.png"/></div></div></figure><h1 id="25a9" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">为什么是Airtable</h1><p id="df8b" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">Airtable是一个类似Google Sheet的在线服务，它拥有数据库的能力和熟悉的电子表格。它具有灵活的关系数据模型的所有功能，我们可以添加附件、长文本注释、复选框、下拉列表和链接等字段。</p><p id="7f21" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">Airtable附带了一个易于使用的图形界面和REST APIs，允许我们以图形和编程方式创建、读取、更新和销毁记录。这就是为什么对于小规模项目来说，Airtable通常是一个很好的无头CMS。</p><h1 id="ac97" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">问题</h1><h2 id="f975" class="mn kv it bd kw mo mp dn la mq mr dp le lv ms mt lg lz mu mv li md mw mx lk my bi translated">不是真正的数据库</h2><p id="7bd7" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">很明显，Airtable并不是一个我们无法编写SQL来查询数据和连接表的“真正的数据库”。它有一个简单的备份功能，但远不及数据库复制和事务日志功能。</p><h2 id="4287" class="mn kv it bd kw mo mp dn la mq mr dp le lv ms mt lg lz mu mv li md mw mx lk my bi translated">限速</h2><p id="3dde" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">它的REST API也有每秒5个请求的限制，这在高流量时很容易达到。</p><p id="623b" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">我们使用Airtable作为一个每天有40，000次页面浏览量的居家活动策划内容网站的CMS /数据库。现在假设每个页面视图需要5个对Airtable的请求，我们总共需要对Airtable发出200，000个请求！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/6e745f496f98b9ecc6beb58012a0b7bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pC1NfW44Vot2ooa1VP9hsg.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">对于香港本地的小型定向初创企业来说，每天4万的页面浏览量已经不错了</figcaption></figure><h2 id="5169" class="mn kv it bd kw mo mp dn la mq mr dp le lv ms mt lg lz mu mv li md mw mx lk my bi translated">访问权限有点麻烦</h2><p id="367e" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">在Airtable中，每个用户只能有一个API访问键。它可以访问你所有的空军基地和记录。为了获得更好和有限的权限，您需要创建一个新用户(这意味着如果您选择付费计划，您还需要支付额外的席位，我们就是这样做的)，并为其分配特殊权限。</p><p id="282a" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">为了避免潜在的安全问题，我们从不在客户端使用API访问密钥。我们只在服务器上做。</p><h1 id="3267" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">解决办法</h1><p id="48bc" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">为了解决我们所面临的问题，我们想到了用代理服务来代理我们对Airtable的所有请求。</p><h2 id="c8dc" class="mn kv it bd kw mo mp dn la mq mr dp le lv ms mt lg lz mu mv li md mw mx lk my bi translated">Nginx的首次尝试</h2><p id="026f" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">我们的第一个尝试是用Nginx开发代理。我们编写了一个简单的Dockerfile，添加了一个定制的Nginx代理和限速配置。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/f46ca7b27cc96f38107d2f0009dc79b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x38HViimEc8412u-Pr96aA.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">我们的Nginx配置如下所示</figcaption></figure><p id="c14a" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">它有点工作，它可以缓存来自Airtable的数据，但我们最终限制了自己的速率，而不是Airtable的。</p><h2 id="2261" class="mn kv it bd kw mo mp dn la mq mr dp le lv ms mt lg lz mu mv li md mw mx lk my bi translated">NodeJS的第二次尝试</h2><p id="f0e0" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">这一次，我们使用ExpressJS和Airtable的NodeJS库。Airtable的JS库带有内置逻辑来处理速率限制，这是一个解决的问题。</p><p id="21a4" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">对于缓存，我们实现了一个非常简单的内存缓存服务。显然，这里不需要库，只需要一个简单的30行代码的类。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="d6a1" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">为了配置的灵活性和方便性，它使用一个配置文件来确定路由、Airtable的基础、表和视图表、过滤器、要获取的字段、字段，甚至是可定制的字段映射函数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="bbd4" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">下面是使用Airtable的NodeJS库从Airtable获取数据的实际代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="cd19" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">存储库位于此处:</p><div class="nh ni gp gr nj nk"><a href="https://github.com/mkhmylife/airtable-proxy" rel="noopener  ugc nofollow" target="_blank"><div class="nl ab fo"><div class="nm ab nn cl cj no"><h2 class="bd iu gy z fp np fr fs nq fu fw is bi translated">mkhmylife/airtable-proxy</h2><div class="nr l"><h3 class="bd b gy z fp np fr fs nq fu fw dk translated">在GitHub上创建一个帐户，为mkhmylife/airtable-proxy开发做贡献。</h3></div><div class="ns l"><p class="bd b dl z fp np fr fs nq fu fw dk translated">github.com</p></div></div><div class="nt l"><div class="nu l nv nw nx nt ny ks nk"/></div></div></a></div><h1 id="c306" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">我们的使用案例</h1><p id="e832" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">运行一个精选的内容网站，我们对我们的Airtable数据进行大量的内容过滤和排序。我们不是在客户端进行获取和过滤，而是在服务器端进行并缓存。为了便于配置，我们在我们的<code class="fe nz oa ob oc b">airtableConfig.ts</code>配置文件中定义它们。</p><p id="ae01" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">假设我们想要从Airtable中获取特色酒店，我们将创建以下配置:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="33cd" class="mn kv it oc b gy oh oi l oj ok">export const <strong class="oc iu"><em class="ol">airtableConfigs</em></strong>: Array&lt;AirtableConfig&gt; = [<br/>    {<br/>        route: "hotels-featured",<br/>        base: "app123456",<br/>        table: "Hotels",<br/>        filter: "Status = 'Featured'",<br/>        fields: [<br/>            'ID',            <br/>            'Name',        <br/>        ],        <br/>    },<br/>];</span></pre><p id="334c" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">要获得经过过滤和代理的数据，只需向<code class="fe nz oa ob oc b">/hotels-featured</code>发送一个<code class="fe nz oa ob oc b">GET</code>请求。</p><p id="ed17" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">更复杂的逻辑也可以通过利用<code class="fe nz oa ob oc b">filter</code>和<code class="fe nz oa ob oc b">fieldMappings</code>来完成。例如，我们可以这样做:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="95f5" class="mn kv it oc b gy oh oi l oj ok">export const airtableConfigs: Array&lt;AirtableConfig&gt; = [    <br/>    {        <br/>        route: "users",        <br/>        base: "app123456",        <br/>        table: "Table Name",        <br/>        filter: "Status = 'Approved'",        <br/>        fields: [            <br/>            'ID',            <br/>            'First Name',<br/>            'Last Name',            <br/>            'Age',        <br/>        ],        <br/>        fieldMappings: ((records: any[]) =&gt; {            <br/>            return records.map( (record: any) =&gt; {                  <br/>                 return {                    <br/>                     id: record.ID,                    <br/>                     name: `${record['First Name']} ${record['Last Name']}`,                    <br/>                     gea: record.Age,                <br/>                 }            <br/>             })        <br/>         }),    <br/>      },<br/>]</span></pre></div><div class="ab cl om on hx oo" role="separator"><span class="op bw bk oq or os"/><span class="op bw bk oq or os"/><span class="op bw bk oq or"/></div><div class="im in io ip iq"><p id="05f1" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">我们还希望我们的代理尽可能快地返回数据，因此即使缓存过期，它仍然会首先服务过期的缓存，然后尝试在后台从Airtable和缓存中获取数据。</p><h1 id="4cac" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">两全其美</h1><p id="0bd5" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">在切换到Airtable之前，我们探索了像Laravel Nova这样的选项，以缩短构建CMS的开发时间，该CMS易于我们的内容团队使用，同时功能强大，速度足够快，可以为我们的网站提供API。</p><p id="1db7" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">是的，从开发者的角度来看，Laravel + Nova是强大的，但对于内容团队来说，批量管理数据是一场噩梦。对于他们来说，以“关系”的方式思考和处理数据也是没有意义的，默认的用户界面对他们来说太难管理了。</p><p id="6fe3" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">改用Airtable，化乱为安，我们内容团队开心，我们也开心，双赢！</p></div><div class="ab cl om on hx oo" role="separator"><span class="op bw bk oq or os"/><span class="op bw bk oq or os"/><span class="op bw bk oq or"/></div><div class="im in io ip iq"><figure class="kj kk kl km gt kn gh gi paragraph-image"><a href="https://www.buymeacoffee.com/edwardmok"><div class="gh gi ot"><img src="../Images/4bc5de35955c00939383a18fb66b41d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:340/format:webp/1*9vg3-OY14aZN1UpKwIxxZg.png"/></div></a></figure></div></div>    
</body>
</html>