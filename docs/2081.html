<html>
<head>
<title>Routing from Kubernetes to External VMs using the Ambassador API gateway: A Terraformed Playground</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Ambassador API网关从Kubernetes路由到外部虚拟机:一个地形改造的游乐场</h1>
<blockquote>原文：<a href="https://itnext.io/routing-from-kubernetes-to-external-vms-using-the-ambassador-api-gateway-a-terraformed-playground-4faead9b021d?source=collection_archive---------5-----------------------#2019-03-27">https://itnext.io/routing-from-kubernetes-to-external-vms-using-the-ambassador-api-gateway-a-terraformed-playground-4faead9b021d?source=collection_archive---------5-----------------------#2019-03-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c848" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<a class="ae kl" href="https://www.datawire.io" rel="noopener ugc nofollow" target="_blank"> Datawire </a>，我们看到越来越多的组织迁移到围绕Docker和Kubernetes构建的“下一代”云原生平台。然而，这种迁移不会在一夜之间发生。相反，我们看到多平台数据中心和云环境的激增，其中应用程序跨越虚拟机和容器。在这些数据中心中，<a class="ae kl" href="https://www.getambassador.io/" rel="noopener ugc nofollow" target="_blank">大使API网关</a>被用作中心入口点，整合<a class="ae kl" href="https://www.getambassador.io/concepts/auth-overview" rel="noopener ugc nofollow" target="_blank">认证</a>、<a class="ae kl" href="https://www.getambassador.io/user-guide/rate-limiting" rel="noopener ugc nofollow" target="_blank">速率限制</a>以及其他跨领域的运营问题。</p><p id="3008" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本文是关于如何在将应用程序增量迁移到Kubernetes时使用Ambassador作为多平台入口解决方案的系列文章的第一篇。我们已经向<a class="ae kl" href="https://github.com/datawire/pro-ref-arch" rel="noopener ugc nofollow" target="_blank"> Ambassador Pro参考架构</a> GitHub repo添加了示例Terraform代码，该架构支持在谷歌云平台上创建多平台“沙盒”基础设施。这将允许您启动一个Kubernetes集群和几个虚拟机，并练习将流量从Ambassador路由到现有应用程序。</p><h1 id="3c5d" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">多平台世界中的边缘路由</h1><p id="f844" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">我以前写过关于使用<a class="ae kl" rel="noopener ugc nofollow" target="_blank" href="/using-api-gateways-to-facilitate-your-transition-from-monolith-to-microservices-c08fe3489237">边缘代理或网关</a>来帮助从整体到微服务的迁移，或者从内部到云的迁移。Ambassador可以作为所有类型平台的API网关或边缘路由器，虽然它是专门为Kubernetes设计和构建的，但配置从集群到外部网络目标的流量路由是很简单的，例如VPN或虚拟专用云(VPCs)内的端点、云服务、云负载平衡器或单个虚拟机。如果您可以通过网络访问端点，那么Ambassador可以路由到它。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/a824b832e74e4ad33b65366082c1816d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CRlxIsBNuAdz9Dfv"/></div></div></figure><p id="a350" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的<a class="ae kl" href="https://github.com/datawire/pro-ref-arch" rel="noopener ugc nofollow" target="_blank">Ambassador Pro Reference Architecture</a>GitHub repo包含几个文件夹，提供文档和示例，帮助您了解如何最好地使用Ambassador支持的所有功能，如速率限制和分布式跟踪。还有一个“云基础设施”文件夹，其中包含必要的Terraform代码和脚本，以使用谷歌云平台(GCP)构建一个示例多平台VM / Kubernetes基础设施。生成的基础架构堆栈如下所示:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mb"><img src="../Images/25c4f33e9476a6d6bd994a181ad98fa0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*N3rzMF2wZJqHPzeP"/></div></div></figure><h1 id="f2cf" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">构建一个示例VM / Kubernetes平台</h1><p id="2d20" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">大使参考架构报告中提供的地形改造基础设施示例将在GCP创建一个简单的区域网络，在(可公开寻址的)负载平衡器后部署一个<a class="ae kl" href="https://cloud.google.com/kubernetes-engine/" rel="noopener ugc nofollow" target="_blank"> Kubernetes (GKE) </a>集群和几个基于虚拟机的服务。部署在虚拟机上的应用程序取自我的“<a class="ae kl" href="https://github.com/danielbryantuk/oreilly-docker-java-shopping" rel="noopener ugc nofollow" target="_blank"> Docker Java Shopping </a>”示例<strong class="jp ir">一个非常简单的</strong>电子商务商店，它由两个使用Spring Boot的Java服务和一个使用Dropwizard的Java服务组成。</p><p id="02b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Kubernetes集群中部署Ambassador可以简化整个网络的入口，还允许工程团队集中和标准化该网关的管理。网关和网络边缘的集中运营提供了许多好处，例如减少“认证蔓延”和标准化交叉问题的能力，例如<a class="ae kl" href="https://www.getambassador.io/user-guide/tls-termination/" rel="noopener ugc nofollow" target="_blank"> TLS终止</a>或基于上下文的传递路由(例如使用<a class="ae kl" href="https://www.getambassador.io/reference/filter-reference/" rel="noopener ugc nofollow" target="_blank">过滤器</a>基于HTTP报头进行路由)和<a class="ae kl" href="https://www.getambassador.io/user-guide/advanced-rate-limiting" rel="noopener ugc nofollow" target="_blank">速率限制</a>。</p><p id="c8c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">克隆参考架构报告后，导航到包含GCP Terraform代码的文件夹，您将找到一个<a class="ae kl" href="https://github.com/datawire/pro-ref-arch/blob/master/cloud-infrastructure/google-cloud-platform/README.md" rel="noopener ugc nofollow" target="_blank">自述文件</a>，其中包含复制我们的配置所需的分步说明。请注意，如果您不在GCP免费试用信用范围内，构建这一基础设施将会耗费您的资金:</p><pre class="lq lr ls lt gt mc md me mf aw mg bi"><span id="4569" class="mh kn iq md b gy mi mj l mk ml">$ git clone <a class="ae kl" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>:datawire/pro-ref-arch.git<br/>$ cd pro-ref-arch/cloud-infrastructure/google-cloud-platform</span></pre><p id="c8bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦您配置好一切并成功运行<code class="fe mm mn mo md b">terraform apply</code>(可能需要几分钟才能完成)，上图所示的基础设施将在您的GCP帐户中创建完成。你还会看到一些来自Terraform的<code class="fe mm mn mo md b">outputs</code>，可以用来配置你的本地<code class="fe mm mn mo md b">kubectl</code>工具，也可以设置大使。</p><pre class="lq lr ls lt gt mc md me mf aw mg bi"><span id="0cd8" class="mh kn iq md b gy mi mj l mk ml">...<br/>Apply complete! Resources: 15 added, 0 changed, 0 destroyed.</span><span id="1f52" class="mh kn iq md b gy mp mj l mk ml">Outputs:</span><span id="e73a" class="mh kn iq md b gy mp mj l mk ml">gcloud_get_creds = gcloud container clusters get-credentials ambassador-demo --project nodal-flagstaff-XXXX --zone us-central1-f<br/>shop_loadbalancer_ip_port = 35.192.25.31:80<br/>shopfront_ambassador_config =<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: shopfront<br/>  annotations:<br/>    getambassador.io/config: |<br/>      ---<br/>      apiVersion: ambassador/v1<br/>      kind:  Mapping<br/>      name:  shopfront_mapping<br/>      prefix: /shopfront/<br/>      service: 35.192.25.31:80<br/>spec:<br/>  ports:<br/>  - name: shopfront<br/>    port: 80</span></pre><p id="bbb2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一个输出名为<code class="fe mm mn mo md b">gcloud_get_creds</code>，可以运行它来配置您的本地<code class="fe mm mn mo md b">kubectl</code>以指向新改造的Kubernetes集群，例如，从上面的输出中，我将在我的本地终端上运行:</p><pre class="lq lr ls lt gt mc md me mf aw mg bi"><span id="761d" class="mh kn iq md b gy mi mj l mk ml">$ gcloud container clusters get-credentials ambassador-demo --project nodal-flagstaff-XXXX --zone us-central1-f</span><span id="c98b" class="mh kn iq md b gy mp mj l mk ml">$ kubectl get svc<br/>NAME         TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE<br/>kubernetes   ClusterIP   10.59.240.1   &lt;none&gt;        443/TCP   28m</span></pre><p id="188a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您可以按照<a class="ae kl" href="https://www.getambassador.io/user-guide/getting-started/" rel="noopener ugc nofollow" target="_blank">入门</a>说明，或者按照自述文件中的快速入门，将Ambassador安装到集群中。一旦网关启动并运行，并且您获得了Ambassador Kubernetes服务的外部GCP负载平衡器IP，您现在可以部署一个Ambassador映射，该映射路由到位于Kubernetes集群外部的GCP负载平衡器。对于当前的基础设施，我有意保持<a class="ae kl" href="https://cloud.google.com/vpc/docs/routes" rel="noopener ugc nofollow" target="_blank">网络路由</a>和<a class="ae kl" href="https://cloud.google.com/vpc/docs/firewalls" rel="noopener ugc nofollow" target="_blank">防火墙规则</a>简单，但是本教程的未来迭代将引入更具挑战性的配置。</p><p id="1218" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">名为<code class="fe mm mn mo md b">shopfront_ambassador_config</code>的Terraform输出提供了Kubernetes配置，可以复制粘贴到YAML文件中并应用到集群中。然后，您应该能够通过大使IP和相关映射(例如:<code class="fe mm mn mo md b">http://{AMBASSADOR_LB_IP}/shopfront/</code>)访问虚拟机上运行的店面服务(并与虚拟机上运行的其他上游服务通信)</p><p id="485f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果一切顺利，您应该能够在浏览器中看到以下内容:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mq"><img src="../Images/2684b3aa4d3dd09de66ad9f10b64769f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zXNkGwXyJyVHvFGS"/></div></div></figure><p id="3f0e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这仅仅是我们将在未来几个月中展示的一系列教程的开始。我们渴望增加更多的复杂性，例如，创建具有对等VPC和更复杂的防火墙规则的网段，并且我们还希望演示如何使用Kubernetes<a class="ae kl" href="https://kubernetes.io/docs/concepts/services-networking/service/#externalname" rel="noopener ugc nofollow" target="_blank">external name</a>服务和Consul Connect来实现多集群服务网格，以实现完整的端到端TLS。</p><p id="54a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当你完成了地形改造基础设施的实验后，不要忘记删除它并清理干净，否则你可能会面临意想不到的GCP发票！</p><pre class="lq lr ls lt gt mc md me mf aw mg bi"><span id="e7c0" class="mh kn iq md b gy mi mj l mk ml">$ terraform destroy -force</span></pre><h1 id="85f5" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">包扎</h1><p id="d6a4" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">本文和相关的多平台数据中心示例旨在帮助工程师将应用程序从虚拟机迁移到Kubernetes集群。大使通常被用作整个庄园的中心入口点，这允许整合<a class="ae kl" href="https://www.getambassador.io/concepts/auth-overview" rel="noopener ugc nofollow" target="_blank">认证</a>、<a class="ae kl" href="https://www.getambassador.io/user-guide/rate-limiting" rel="noopener ugc nofollow" target="_blank">速率限制</a>以及其他跨领域的运营问题。</p><p id="d14f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将继续迭代示例基础架构代码，并计划支持其他云平台，如Digital Ocean和AWS。如果您对云供应商或复杂的路由场景有任何特殊要求，请联系我。</p><p id="7106" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">像往常一样，你也可以通过Twitter(<a class="ae kl" href="https://twitter.com/getambassadorio" rel="noopener ugc nofollow" target="_blank">@ getambassadorio</a>)、<a class="ae kl" href="https://d6e.co/slack" rel="noopener ugc nofollow" target="_blank"> Slack </a>提出任何问题，或者通过<a class="ae kl" href="https://github.com/datawire/ambassador" rel="noopener ugc nofollow" target="_blank"> GitHub </a>提出问题。</p><p id="b10c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mr">本文原载于</em> <a class="ae kl" href="https://blog.getambassador.io/routing-in-a-multi-platform-data-center-from-vms-to-kubernetes-via-ambassador-47bbe658683c" rel="noopener ugc nofollow" target="_blank"> <em class="mr"> getambassador.io博客</em> </a> <em class="mr">。</em></p></div></div>    
</body>
</html>