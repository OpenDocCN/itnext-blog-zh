<html>
<head>
<title>How to connect Azure Event Hubs and Blob Storage with the Dapr framework</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Dapr框架连接Azure事件中心和Blob存储</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-connect-azure-event-hubs-and-blob-storage-with-the-dapr-framework-3c3ce9374100?source=collection_archive---------0-----------------------#2019-11-16">https://itnext.io/how-to-connect-azure-event-hubs-and-blob-storage-with-the-dapr-framework-3c3ce9374100?source=collection_archive---------0-----------------------#2019-11-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="02ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" rel="noopener ugc nofollow" target="_blank" href="/tutorial-using-azure-event-hubs-with-the-dapr-framework-81c749b66dcf">之前的博客</a>展示了一个如何使用<a class="ae kl" href="https://azure.microsoft.com/services/event-hubs/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> Azure Event Hubs </strong> </a>与<a class="ae kl" href="https://dapr.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> Dapr </strong> </a>集成的例子。Azure Event Hubs被用作<code class="fe km kn ko kp b">Dapr</code>运行时内的“绑定”,以允许应用程序与Azure Event Hubs通信，而无需实际了解它或直接与之耦合(通过SDK、库等)。)，使用由<code class="fe km kn ko kp b">Dapr</code>运行时定义的简单模型。</p><p id="4c57" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇博文将展示如何将多个<code class="fe km kn ko kp b">Dapr</code>绑定缝合在一起。尽管这适用于任何受支持的绑定，但该示例将组合<a class="ae kl" href="https://azure.microsoft.com/services/event-hubs/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure事件中心</a>和<a class="ae kl" href="https://azure.microsoft.com/services/storage/blobs/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure Blob存储</a>，它们将分别用作输入和输出绑定。由于基于绑定的集成，所有这些都以简化的方式完成，无需在应用程序代码中直接引用事件中心或Blob存储。</p><p id="ed6d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将涵盖:</p><ul class=""><li id="bc35" class="kq kr iq jp b jq jr ju jv jy ks kc kt kg ku kk kv kw kx ky bi translated"><code class="fe km kn ko kp b">Dapr</code>和相关Azure服务的设置</li><li id="28de" class="kq kr iq jp b jq kz ju la jy lb kc lc kg ld kk kv kw kx ky bi translated">运行我们的应用程序并观察它的运行，将数据从Azure事件中心发送到Azure博客存储</li><li id="4cc9" class="kq kr iq jp b jq kz ju la jy lb kc lc kg ld kk kv kw kx ky bi translated">它如何在幕后工作的演练</li></ul><blockquote class="le lf lg"><p id="1905" class="jn jo lh jp b jq jr js jt ju jv jw jx li jz ka kb lj kd ke kf lk kh ki kj kk ij bi translated"><strong class="jp ir"><em class="iq">Azure Event Hubs</em></strong><em class="iq">是一个完全托管的平台即服务(PaaS)，用于流式传输和事件摄取，而</em> <strong class="jp ir"> <em class="iq"> Azure Blob存储</em> </strong> <em class="iq">是一个面向云的对象存储解决方案，针对存储大量非结构化数据进行了优化。</em></p></blockquote><h1 id="db53" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">你好Dapr！</h1><p id="4a5e" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated"><strong class="jp ir"> Dapr </strong>代表<em class="lh">分布式应用运行时</em>。它是一个开源、可移植的运行时，通过将构建这类应用程序的最佳实践编入独立的组件，来帮助开发人员构建有弹性的、微服务无状态和有状态的应用程序。</p><p id="6c79" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你是Dapr的新手，我建议你从<a class="ae kl" href="https://github.com/dapr/docs/blob/master/overview.md" rel="noopener ugc nofollow" target="_blank">概述</a>和<a class="ae kl" href="https://github.com/dapr/docs/tree/master/concepts" rel="noopener ugc nofollow" target="_blank">概念</a>开始。尝试使用<a class="ae kl" href="https://github.com/dapr/docs/tree/master/getting-started" rel="noopener ugc nofollow" target="_blank">入门指南</a>，然后继续使用<a class="ae kl" href="https://github.com/dapr/samples/blob/master/README.md" rel="noopener ugc nofollow" target="_blank">样品</a>和<a class="ae kl" href="https://github.com/dapr/docs/tree/master/howto" rel="noopener ugc nofollow" target="_blank">操作指南</a>。随着进一步深入，您可以深入了解<a class="ae kl" href="https://github.com/dapr/docs/tree/master/reference/api" rel="noopener ugc nofollow" target="_blank"> Dapr运行时API参考</a>和<a class="ae kl" href="https://github.com/dapr/components-contrib" rel="noopener ugc nofollow" target="_blank">单个组件</a></p><h1 id="718a" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">Dapr绑定</h1><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi mo"><img src="../Images/83efc916ee2b490aedd65ed8b79952ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3bULO0vBHIV2DKX6"/></div></div></figure><p id="811d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在撰写本文时，<code class="fe km kn ko kp b">Dapr</code>处于alpha状态，支持以下分布式系统构建模块，您可以将这些模块插入到您的应用程序中——服务调用、状态管理、发布/订阅消息、资源绑定、分布式跟踪和Actor模式。绑定提供了一种通用的方法，通过来自外部系统的事件来触发应用程序，或者通过可选的数据负载来调用外部系统。这些“外部系统”可以是任何东西:队列、消息传递管道、云服务、文件系统等等。</p><blockquote class="le lf lg"><p id="5850" class="jn jo lh jp b jq jr js jt ju jv jw jx li jz ka kb lj kd ke kf lk kh ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/dapr/components-contrib/blob/master/bindings/Readme.md" rel="noopener ugc nofollow" target="_blank"> <em class="iq">目前支持的绑定</em> </a> <em class="iq">包括Kafka、Rabbit MQ、Azure Event Hubs等。</em></p></blockquote><p id="7b1c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">简而言之，<code class="fe km kn ko kp b">Dapr</code>绑定允许您专注于业务逻辑，而不是与诸如数据库、发布/订阅系统、blob存储等个别服务集成。</p><p id="8eb4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们开始吧…</p><h1 id="1a1d" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">设置:Dapr、Azure事件中心和Blob存储</h1><p id="44a9" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">本节将指导您完成Dapr、Azure Event Hubs和Blob存储的设置过程。</p><p id="162f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，你需要一个微软Azure账户。如果你还没有，请去注册一个免费的！</p><h1 id="7288" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">设置Dapr</h1><p id="661d" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">对于<code class="fe km kn ko kp b">Dapr</code>，您需要:</p><ul class=""><li id="3831" class="kq kr iq jp b jq jr ju jv jy ks kc kt kg ku kk kv kw kx ky bi translated"><a class="ae kl" href="https://docs.docker.com/install/" rel="noopener ugc nofollow" target="_blank">码头工人</a></li><li id="1f73" class="kq kr iq jp b jq kz ju la jy lb kc lc kg ld kk kv kw kx ky bi translated"><a class="ae kl" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Go 1.12以上</a></li></ul><p id="de65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了简单起见，我们将把<code class="fe km kn ko kp b">Dapr</code>作为一个独立的组件在本地运行。</p><blockquote class="le lf lg"><p id="4373" class="jn jo lh jp b jq jr js jt ju jv jw jx li jz ka kb lj kd ke kf lk kh ki kj kk ij bi translated"><em class="iq">如果你渴望在Kubernetes上运行</em> <code class="fe km kn ko kp b"><em class="iq">Dapr</em></code> <em class="iq">，请查看</em> <a class="ae kl" href="https://github.com/dapr/docs/blob/master/getting-started/environment-setup.md#installing-dapr-on-a-kubernetes-cluster" rel="noopener ugc nofollow" target="_blank"> <em class="iq">本入门指南</em> </a> <em class="iq">！</em></p></blockquote><p id="d483" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先安装<a class="ae kl" href="https://github.com/dapr/cli" rel="noopener ugc nofollow" target="_blank"> Dapr CLI </a>，它允许您在本地开发机器或Kubernetes集群上设置Dapr，提供调试支持，启动和管理Dapr实例。</p><p id="fb0b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，在你的Mac上，你可以简单地用它来安装<code class="fe km kn ko kp b">Dapr</code>到<code class="fe km kn ko kp b">/usr/local/bin</code></p><pre class="mp mq mr ms gt na kp nb nc aw nd bi"><span id="3332" class="ne lm iq kp b gy nf ng l nh ni">curl -fsSL https://raw.githubusercontent.com/dapr/cli/master/install/install.sh | /bin/bash</span></pre><blockquote class="le lf lg"><p id="ffc9" class="jn jo lh jp b jq jr js jt ju jv jw jx li jz ka kb lj kd ke kf lk kh ki kj kk ij bi translated"><em class="iq">详见</em> <a class="ae kl" href="https://github.com/dapr/docs/blob/master/getting-started/environment-setup.md#installing-dapr-cli" rel="noopener ugc nofollow" target="_blank"> <em class="iq">文档</em> </a></p></blockquote><p id="34a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以使用CLI在独立模式下安装Dapr。你所需要的只是一个简单的命令</p><pre class="mp mq mr ms gt na kp nb nc aw nd bi"><span id="96c5" class="ne lm iq kp b gy nf ng l nh ni">dapr init</span></pre><p id="04cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">..就是这样！</p><h1 id="50cb" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">设置Azure事件中心</h1><p id="047a" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">您可以使用以下快速入门工具之一快速设置Azure事件中心:</p><ul class=""><li id="ee62" class="kq kr iq jp b jq jr ju jv jy ks kc kt kg ku kk kv kw kx ky bi translated">使用Azure portal — <a class="ae kl" href="https://docs.microsoft.com/azure/event-hubs/event-hubs-create?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">这里是一个分步指南</a></li><li id="0989" class="kq kr iq jp b jq kz ju la jy lb kc lc kg ld kk kv kw kx ky bi translated">使用Azure CLI或Azure Cloud shell(在您的浏览器中！)— <a class="ae kl" href="https://docs.microsoft.com/azure/event-hubs/event-hubs-quickstart-cli?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">这里有一个逐步的指南</a></li></ul><p id="1792" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您应该有一个带有名称空间<a class="ae kl" href="https://docs.microsoft.com/azure/event-hubs/event-hubs-features?WT.mc_id=medium-blog-abhishgu#namespace" rel="noopener ugc nofollow" target="_blank">和相关事件中枢(主题)的事件中枢实例。最后一步，您需要获取连接字符串，以便</a><a class="ae kl" href="https://docs.microsoft.com/azure/event-hubs/authenticate-shared-access-signature?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">向事件中心</a> — <a class="ae kl" href="https://docs.microsoft.com/azure/event-hubs/event-hubs-get-connection-string?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">验证。使用本指南</a>完成此步骤。</p><h1 id="6276" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">设置Azure Blob存储</h1><p id="a84f" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">如果你想使用Azure门户网站:</p><ul class=""><li id="a303" class="kq kr iq jp b jq jr ju jv jy ks kc kt kg ku kk kv kw kx ky bi translated"><a class="ae kl" href="https://docs.microsoft.com/azure/storage/common/storage-quickstart-create-account?tabs=azure-portal&amp;WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">创建存储帐户</a>，以及</li><li id="372e" class="kq kr iq jp b jq kz ju la jy lb kc lc kg ld kk kv kw kx ky bi translated"><a class="ae kl" href="https://docs.microsoft.com/azure/storage/blobs/storage-quickstart-blobs-portal?WT.mc_id=medium-blog-abhishgu#create-a-container" rel="noopener ugc nofollow" target="_blank">创建一个容器</a></li></ul><p id="e671" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想使用Azure CLI或Azure Cloud shell，<a class="ae kl" href="https://docs.microsoft.com/azure/storage/blobs/storage-quickstart-blobs-cli?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">使用这个分步指南</a></p><p id="1a61" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在您已经设置好了所有的东西，让我们继续尝试这个应用程序</p><h1 id="3a77" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">使用Dapr运行应用程序</h1><p id="20b4" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">从克隆repo开始，并切换到正确的目录</p><pre class="mp mq mr ms gt na kp nb nc aw nd bi"><span id="7837" class="ne lm iq kp b gy nf ng l nh ni">git clone <a class="ae kl" href="https://github.com/abhirockzz/dapr-eventhubs-blobstore" rel="noopener ugc nofollow" target="_blank">https://github.com/abhirockzz/dapr-eventhubs-blobstore</a></span></pre><p id="b020" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">更新<code class="fe km kn ko kp b">components/eventhubs_binding.yaml</code>以在<code class="fe km kn ko kp b">spec.metadata.value</code>部分包含Azure Event Hubs连接字符串。</p><blockquote class="le lf lg"><p id="2fac" class="jn jo lh jp b jq jr js jt ju jv jw jx li jz ka kb lj kd ke kf lk kh ki kj kk ij bi translated"><em class="iq">请注意，您必须在连接字符串末尾添加事件中心的名称，即</em> <code class="fe km kn ko kp b"><em class="iq">;EntityPath=&lt;EVENT_HUBS_NAME&gt;</em></code> <em class="iq">。</em></p></blockquote><p id="807f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe km kn ko kp b">connectionString</code>属性的值应该是这样的:</p><pre class="mp mq mr ms gt na kp nb nc aw nd bi"><span id="d540" class="ne lm iq kp b gy nf ng l nh ni">Endpoint=sb://&lt;EVENT_HUBS_NAMESPACE&gt;.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=&lt;EVENT_HUBS_KEY&gt;;EntityPath=&lt;EVENT_HUBS_NAME&gt;</span></pre><p id="baa3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">更新<code class="fe km kn ko kp b">components/blobstorage.yaml</code>以包括Azure Blob存储细节- <code class="fe km kn ko kp b">storageAccount</code>、<code class="fe km kn ko kp b">storageAccessKey</code>和<code class="fe km kn ko kp b">container</code></p><p id="c96d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动Go应用程序</p><pre class="mp mq mr ms gt na kp nb nc aw nd bi"><span id="af63" class="ne lm iq kp b gy nf ng l nh ni">export APP_PORT=8080<br/>dapr run --app-port $APP_PORT go run app.go</span></pre><p id="87fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您应该会看到日志:</p><pre class="mp mq mr ms gt na kp nb nc aw nd bi"><span id="0e4e" class="ne lm iq kp b gy nf ng l nh ni">== DAPR == time="2019-11-14T15:33:14+05:30" level=info msg="STARTING Dapr Runtime -- version edge -- commit ff7815d-dirty"<br/>	== DAPR == time="2019-11-14T15:33:14+05:30" level=info msg="log level set to: info"<br/>	== DAPR == time="2019-11-14T15:33:14+05:30" level=info msg="standalone mode configured"<br/>	== DAPR == time="2019-11-14T15:33:14+05:30" level=info msg="dapr id: Seekergrass-Shaker"<br/>	== DAPR == time="2019-11-14T15:33:14+05:30" level=info msg="loaded component messagebus (pubsub.redis)"<br/>	== DAPR == time="2019-11-14T15:33:14+05:30" level=info msg="loaded component statestore (state.redis)"<br/>	== DAPR == time="2019-11-14T15:33:14+05:30" level=info msg="loaded component eventhubs-input (bindings.azure.eventhubs)"<br/>	== DAPR == time="2019-11-14T15:33:14+05:30" level=info msg="loaded component storage (bindings.azure.blobstorage)"<br/>	......</span></pre><h1 id="e796" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">运行Azure事件中心生成器应用程序</h1><p id="fbc2" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">这个应用使用Azure Event Hubs native Go client来发送消息。</p><p id="7a83" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">设置所需的环境变量:</p><pre class="mp mq mr ms gt na kp nb nc aw nd bi"><span id="0946" class="ne lm iq kp b gy nf ng l nh ni">export EVENT_HUBS_NAMESPACE="&lt;EVENT_HUBS_NAMESPACE&gt;"<br/>export EVENT_HUBS_KEY="&lt;EVENT_HUBS_KEY&gt;"<br/>export EVENT_HUB_NAME="&lt;EVENT_HUB_NAME&gt;"</span></pre><blockquote class="le lf lg"><p id="6b16" class="jn jo lh jp b jq jr js jt ju jv jw jx li jz ka kb lj kd ke kf lk kh ki kj kk ij bi translated"><em class="iq">请确保事件中心的名称与您在输入绑定配置中为连接字符串配置的名称相同</em></p></blockquote><p id="c126" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行生成器应用程序</p><pre class="mp mq mr ms gt na kp nb nc aw nd bi"><span id="622f" class="ne lm iq kp b gy nf ng l nh ni">export GO111MODULE=on<br/>go run eventhubs-producer/producer.go</span></pre><p id="a0c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它将向事件中心发送五条消息并退出。您应该会看到如下日志:</p><pre class="mp mq mr ms gt na kp nb nc aw nd bi"><span id="60db" class="ne lm iq kp b gy nf ng l nh ni">Sent message {"time":"Thu Nov 14 15:35:13 2019"}<br/>Sent message {"time":"Thu Nov 14 15:35:18 2019"}<br/>Sent message {"time":"Thu Nov 14 15:35:20 2019"}<br/>Sent message {"time":"Thu Nov 14 15:35:23 2019"}<br/>Sent message {"time":"Thu Nov 14 15:35:25 2019"}</span></pre><h1 id="5ef3" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">确认</h1><p id="c1cb" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">检查Dapr应用程序日志，您应该看到从事件中心收到的消息。</p><pre class="mp mq mr ms gt na kp nb nc aw nd bi"><span id="196c" class="ne lm iq kp b gy nf ng l nh ni">== APP == time from Event Hubs 'Thu Nov 14 15:35:13 2019'<br/>== APP == time from Event Hubs 'Thu Nov 14 15:35:18 2019'<br/>== APP == time from Event Hubs 'Thu Nov 14 15:35:20 2019'<br/>== APP == time from Event Hubs 'Thu Nov 14 15:35:23 2019'<br/>== APP == time from Event Hubs 'Thu Nov 14 15:35:25 2019'</span></pre><p id="ad9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">检查Azure Blob存储。首先，Azure CLI需要您的存储帐户凭据。使用<code class="fe km kn ko kp b">az storage account keys list</code>命令获取您的存储帐户密钥</p><pre class="mp mq mr ms gt na kp nb nc aw nd bi"><span id="1a53" class="ne lm iq kp b gy nf ng l nh ni">export AZURE_SUBSCRIPTION_ID=&lt;to be filled&gt;<br/>export AZURE_STORAGE_ACCOUNT=&lt;to be filled&gt;<br/>export AZURE_STORAGE_ACCOUNT_RESOURCE_GROUP=&lt;to be filled&gt;</span><span id="37b8" class="ne lm iq kp b gy nj ng l nh ni">az storage account keys list --account-name $AZURE_STORAGE_ACCOUNT --resource-group $AZURE_STORAGE_ACCOUNT_RESOURCE_GROUP --subscription $AZURE_SUBSCRIPTION_ID --output table</span></pre><p id="eac3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用这两个键中的任何一个，并以环境变量的形式导出它</p><pre class="mp mq mr ms gt na kp nb nc aw nd bi"><span id="06ed" class="ne lm iq kp b gy nf ng l nh ni">export AZURE_STORAGE_KEY=&lt;to be filled&gt;</span></pre><p id="6818" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">列出容器中的Blob(使用您在上一节设置Azure Blob存储时创建的容器的名称)</p><pre class="mp mq mr ms gt na kp nb nc aw nd bi"><span id="a695" class="ne lm iq kp b gy nf ng l nh ni">export CONTAINER_NAME=&lt;to be filled&gt;<br/>az storage blob list --container-name $CONTAINER_NAME --subscription $AZURE_SUBSCRIPTION_ID --output table</span></pre><p id="6ec4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你应该在容器里放五滴。这是因为五条消息被推送到事件中心，然后由Dapr保存到Azure Blob存储。您也可以通过下载blob来确认它们的内容</p><pre class="mp mq mr ms gt na kp nb nc aw nd bi"><span id="5086" class="ne lm iq kp b gy nf ng l nh ni">export BLOB_NAME=&lt;to be filled&gt;</span><span id="e04b" class="ne lm iq kp b gy nj ng l nh ni">az storage blob download --container-name $CONTAINER_NAME --subscription $AZURE_SUBSCRIPTION_ID --name $BLOB_NAME --file $BLOB_NAME</span></pre><p id="44ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这会将内容下载到当前目录下的一个文件(与blob同名)中。要窥视里面，很简单</p><pre class="mp mq mr ms gt na kp nb nc aw nd bi"><span id="da44" class="ne lm iq kp b gy nf ng l nh ni">cat $BLOB_NAME</span></pre><p id="045d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您应该会看到消息被发送到Azure事件中心</p><pre class="mp mq mr ms gt na kp nb nc aw nd bi"><span id="d9e6" class="ne lm iq kp b gy nf ng l nh ni">{"time":"Thu Nov 14 15:35:20 2019"}</span></pre><blockquote class="le lf lg"><p id="3f55" class="jn jo lh jp b jq jr js jt ju jv jw jx li jz ka kb lj kd ke kf lk kh ki kj kk ij bi translated"><em class="iq">对其他斑点重复同样的操作</em></p></blockquote><h1 id="ba67" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">在幕后</h1><p id="d107" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">下面是其工作原理的总结:</p><h2 id="6824" class="ne lm iq bd ln nk nl dn lr nm nn dp lv jy no np lz kc nq nr md kg ns nt mh nu bi translated">输入绑定</h2><p id="ca93" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">配置文件<code class="fe km kn ko kp b">eventhub_binding.yaml</code>捕获Azure事件中心的连接字符串。</p><pre class="mp mq mr ms gt na kp nb nc aw nd bi"><span id="0690" class="ne lm iq kp b gy nf ng l nh ni">apiVersion: dapr.io/v1alpha1<br/>kind: Component<br/>metadata:<br/>  name: eventhubs-input<br/>spec:<br/>  type: bindings.azure.eventhubs<br/>  metadata:<br/>  - name: connectionString<br/>    value: Endpoint=sb://&lt;EVENT_HUBS_NAMESPACE&gt;.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=&lt;KEY&gt;;EntityPath=&lt;EVENT_HUBS_NAME&gt;</span></pre><p id="6002" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关键属性包括:</p><ul class=""><li id="3fc2" class="kq kr iq jp b jq jr ju jv jy ks kc kt kg ku kk kv kw kx ky bi translated"><code class="fe km kn ko kp b">metadata.name</code> -输入绑定组件的名称</li><li id="7f04" class="kq kr iq jp b jq kz ju la jy lb kc lc kg ld kk kv kw kx ky bi translated"><code class="fe km kn ko kp b">spec.metadata.name</code> -事件集线器连接字符串</li></ul><blockquote class="le lf lg"><p id="f332" class="jn jo lh jp b jq jr js jt ju jv jw jx li jz ka kb lj kd ke kf lk kh ki kj kk ij bi translated"><em class="iq">请注意，连接字符串包含代理URL ( </em> <code class="fe km kn ko kp b"><em class="iq">&lt;EVENT_HUBS_NAMESPACE&gt;.servicebus.windows.net</em></code> <em class="iq">)、主键(用于身份验证)的信息，还包含主题或事件中心的名称，您的应用程序将绑定到该主题或事件中心并从其接收事件。</em></p></blockquote><h2 id="365e" class="ne lm iq bd ln nk nl dn lr nm nn dp lv jy no np lz kc nq nr md kg ns nt mh nu bi translated">输出绑定</h2><p id="9bce" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated"><code class="fe km kn ko kp b">blobstorage.yaml</code>配置文件捕获Azure Blob存储的连接字符串</p><pre class="mp mq mr ms gt na kp nb nc aw nd bi"><span id="3b2c" class="ne lm iq kp b gy nf ng l nh ni">apiVersion: dapr.io/v1alpha1<br/>kind: Component<br/>metadata:<br/>  name: storage<br/>spec:<br/>  type: bindings.azure.blobstorage<br/>  metadata:<br/>  - name: storageAccount<br/>    value: [BLOB_STORAGE_ACCOUNT]<br/>  - name: storageAccessKey<br/>    value: [BLOB_STORAGE_ACCESS_KEY]<br/>  - name: container<br/>    value: [BLOB_STORAGE_CONTAINER_NAME]</span></pre><h2 id="7fdf" class="ne lm iq bd ln nk nl dn lr nm nn dp lv jy no np lz kc nq nr md kg ns nt mh nu bi translated">使用应用程序中的绑定</h2><p id="3d2e" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/abhirockzz/dapr-eventhubs-blobstore/blob/master/app.go" rel="noopener ugc nofollow" target="_blank">Go应用</a>在<code class="fe km kn ko kp b">/eventhubs-input</code>公开了一个REST端点——这与输入绑定组件的名称相同(不是巧合！)</p><p id="83a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Dapr运行时负责从事件中心进行消费，并确保它在带有事件有效负载的<code class="fe km kn ko kp b">/eventhubs-input</code>端点使用<code class="fe km kn ko kp b">POST</code>请求调用Go应用程序。</p><p id="90db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用程序通过返回一个JSON输出进行响应，该输出包含从Event Hub接收到的有效负载和输出绑定的名称(在本例中为<code class="fe km kn ko kp b">storage</code>)。它由下面的<code class="fe km kn ko kp b">struct</code>表示</p><pre class="mp mq mr ms gt na kp nb nc aw nd bi"><span id="cf37" class="ne lm iq kp b gy nf ng l nh ni">type Response struct {<br/>	To   []string    `json:"to"`<br/>	Data interface{} `json:"data"`<br/>}</span></pre><p id="8684" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是奇迹发生的地方！Dapr收集这个响应，并将有效负载发送到输出绑定，在本例中是Azure Blob存储。</p><h1 id="7816" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">摘要</h1><p id="31f3" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">在这篇博文中，您看到了如何将不同的服务作为Dapr绑定来缝合(或组合)在一起。您的应用程序所做的就是使用Dapr HTTP API与Dapr运行时(只是一个sidecar)进行交互！</p><blockquote class="le lf lg"><p id="94c6" class="jn jo lh jp b jq jr js jt ju jv jw jx li jz ka kb lj kd ke kf lk kh ki kj kk ij bi translated"><em class="iq">也可以使用gRPC或特定语言的SDK</em></p></blockquote><p id="6f19" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在撰写本文时，<code class="fe km kn ko kp b">Dapr</code>处于alpha状态(<code class="fe km kn ko kp b">v0.1.0</code>)，并乐于接受社区贡献😃游览https://github.com/dapr/dapr<a class="ae kl" href="https://github.com/dapr/dapr" rel="noopener ugc nofollow" target="_blank"/>尽情潜水吧！</p><p id="7410" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你觉得这篇文章有帮助，请喜欢并关注🙌很高兴通过<a class="ae kl" href="https://twitter.com/abhi_tweeter" rel="noopener ugc nofollow" target="_blank"> Twitter </a>获得反馈，或者发表评论。</p></div></div>    
</body>
</html>