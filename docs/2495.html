<html>
<head>
<title>Running Arbitrary Executables in AWS Lambda — Encrypting a PDF</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS Lambda中运行任意可执行文件—加密PDF</h1>
<blockquote>原文：<a href="https://itnext.io/running-arbitrary-executables-in-aws-lambda-encrypting-a-pdf-afea47e3c345?source=collection_archive---------1-----------------------#2019-06-03">https://itnext.io/running-arbitrary-executables-in-aws-lambda-encrypting-a-pdf-afea47e3c345?source=collection_archive---------1-----------------------#2019-06-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/9bbb609fc80a7887959d3af04e9a98fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dAu-ZOZ0qkursD4VeoQr5Q.jpeg"/></div></div></figure><p id="0514" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我的<a class="ae kw" href="https://medium.com/@keith.coughtrey/html-to-pdf-using-a-chrome-puppet-in-the-cloud-de6e6a0dc6d7?source=friends_link&amp;sk=de0cbdf69ae1cfd52ecd8ba457c2ded7" rel="noopener">上一篇文章</a>中，我使用headless chrome和puppeteer创建了一个pdf服务。今天，我将获取该服务的输出，并对其进行密码保护。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="b855" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://github.com/qpdf/qpdf" rel="noopener ugc nofollow" target="_blank"> Qpdf </a>是一个开源的命令行工具，支持加密pdf文件。它可用于设置所有者密码(可用于限制修改和打印等功能)和用户密码(仅用于限制打开文件)。</p><p id="9ef8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从Lambda函数运行命令行工具需要我们深入构建和打包相关二进制文件的复杂过程。理解如何做到这一点的起点是这篇文章:</p><div class="le lf gp gr lg lh"><a href="https://aws.amazon.com/blogs/compute/running-executables-in-aws-lambda/" rel="noopener  ugc nofollow" target="_blank"><div class="li ab fo"><div class="lj ab lk cl cj ll"><h2 class="bd ir gy z fp lm fr fs ln fu fw ip bi translated">在AWS Lambda | Amazon Web Services中运行任意可执行文件</h2><div class="lo l"><h3 class="bd b gy z fp lm fr fs ln fu fw dk translated">在这篇博客的前几篇文章中，我们已经讨论了Lambda如何管理容器生命周期，以及如何使用自定义的…</h3></div><div class="lp l"><p class="bd b dl z fp lm fr fs ln fu fw dk translated">aws.amazon.com</p></div></div><div class="lq l"><div class="lr l ls lt lu lq lv jw lh"/></div></div></a></div><blockquote class="lw lx ly"><p id="d702" class="jy jz lz ka b kb kc kd ke kf kg kh ki ma kk kl km mb ko kp kq mc ks kt ku kv ij bi translated">互联网上有大量的开源软件，这些软件没有经过预编译，也不能从包存储库中下载。你可能最终会发现一个你需要自己编译的软件包，从它的源代码。</p></blockquote><p id="df47" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不幸的是，qpdf是一个我们需要自己编译的包。我们需要在我们的函数最终运行的那种类型的linux机器上这样做。</p><blockquote class="lw lx ly"><p id="a9ba" class="jy jz lz ka b kb kc kd ke kf kg kh ki ma kk kl km mb ko kp kq mc ks kt ku kv ij bi translated">Lambda执行环境基于一个特定的<a class="ae kw" href="https://aws.amazon.com/amazon-linux-ami/" rel="noopener ugc nofollow" target="_blank"> Amazon Linux AMI </a>和内核版本。Lambda部署包中使用的任何本机二进制文件都必须在这个环境中编译，并且只支持64位二进制文件。</p></blockquote><p id="8f43" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以通过旋转EC2实例来访问这样的机器。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="db22" class="md me iq bd mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na bi translated">连接到EC2实例</h1><p id="171f" class="pw-post-body-paragraph jy jz iq ka b kb nb kd ke kf nc kh ki kj nd kl km kn ne kp kq kr nf kt ku kv ij bi translated">目前，AWS免费层包括每月750小时的Linux t2.micro实例，为期一年。要保持在空闲层内，请仅使用EC2微实例。目前的定价是<a class="ae kw" href="https://aws.amazon.com/ec2/pricing/" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="ef57" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要启动一个实例，请遵循这些指令。当出现提示时，选择生成一个新的密钥对，给它一个名称(例如<code class="fe ng nh ni nj b">ec2instancekeypair.pem</code>)并下载它并将其移动到一个适当的目录(例如<code class="fe ng nh ni nj b">~/Dev/ec2</code>)。</p><p id="a606" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">实例运行后，按connect，您将看到如下对话框</p><figure class="nl nm nn no gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/36d09a622d83161903e5ea7ef3c0b094.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U7hh1e7zxQDMViqsFHvLQA.png"/></div></div></figure><p id="f52f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在您选择的目录中打开一个终端，运行chmod命令(防止您的密钥被任何人读取)，然后运行ssh命令。现在我们已经连接到EC2实例，我们需要从源代码构建qpdf。</p><p id="be8d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在qpdf自述文件中，我们发现:</p><blockquote class="lw lx ly"><p id="bfad" class="jy jz lz ka b kb kc kd ke kf kg kh ki ma kk kl km mb ko kp kq mc ks kt ku kv ij bi translated">从UNIX/Linux上的源代码发行版构建对于UNIX和类似UNIX的系统，您通常只需要</p><p id="1f85" class="jy jz lz ka b kb kc kd ke kf kg kh ki ma kk kl km mb ko kp kq mc ks kt ku kv ij bi translated">。/配置<br/>制作<br/>制作安装</p></blockquote><p id="1391" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了能够运行这些命令，我们首先需要用一些开发工具来设置我们的实例。</p><div class="le lf gp gr lg lh"><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/compile-software.html" rel="noopener  ugc nofollow" target="_blank"><div class="li ab fo"><div class="lj ab lk cl cj ll"><h2 class="bd ir gy z fp lm fr fs ln fu fw ip bi translated">准备编译软件-亚马逊弹性计算云</h2><div class="lo l"><h3 class="bd b gy z fp lm fr fs ln fu fw dk translated">安装开发工具来编译软件。</h3></div><div class="lp l"><p class="bd b dl z fp lm fr fs ln fu fw dk translated">docs.aws.amazon.com</p></div></div><div class="lq l"><div class="np l ls lt lu lq lv jw lh"/></div></div></a></div><blockquote class="lw lx ly"><p id="8c7d" class="jy jz lz ka b kb kc kd ke kf kg kh ki ma kk kl km mb ko kp kq mc ks kt ku kv ij bi translated">因为软件编译不是每个Amazon EC2实例都需要的任务，所以默认情况下不会安装这些工具，但是它们在一个名为“开发工具”的包组中是可用的，该包组可以通过<strong class="ka ir"> yum groupinstall </strong>命令轻松添加到实例中。</p></blockquote><pre class="nl nm nn no gt nq nj nr ns aw nt bi"><span id="c4a2" class="nu me iq nj b gy nv nw l nx ny">[ec2-user ~]$ <strong class="nj ir">sudo yum groupinstall "Development Tools"</strong></span></pre><p id="f922" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们获取代码，从tar中提取代码，然后进入代码目录。</p><pre class="nl nm nn no gt nq nj nr ns aw nt bi"><span id="2a1a" class="nu me iq nj b gy nv nw l nx ny">wget "https://github.com/qpdf/qpdf/archive/release-qpdf-8.4.0.tar.gz"</span><span id="feda" class="nu me iq nj b gy nz nw l nx ny">tar -zxvf release-qpdf-8.4.0.tar.gz</span><span id="a3e9" class="nu me iq nj b gy nz nw l nx ny">cd qpdf-release-qpdf-8.4.0/</span></pre><p id="bbd4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们第一次运行configure的尝试以这些警告结束:</p><pre class="nl nm nn no gt nq nj nr ns aw nt bi"><span id="b871" class="nu me iq nj b gy nv nw l nx ny">./configure</span><span id="0623" class="nu me iq nj b gy nz nw l nx ny">configure: WARNING: unable to find required header jpeglib.h</span><span id="bd29" class="nu me iq nj b gy nz nw l nx ny">configure: WARNING: unable to find required library jpeg</span></pre><blockquote class="lw lx ly"><p id="f805" class="jy jz lz ka b kb kc kd ke kf kg kh ki ma kk kl km mb ko kp kq mc ks kt ku kv ij bi translated">QPDF依赖于外部库<a class="ae kw" href="http://www.zlib.net/" rel="noopener ugc nofollow" target="_blank"> zlib </a>和<a class="ae kw" href="http://www.ijg.org/files/" rel="noopener ugc nofollow" target="_blank"> jpeg </a>。<a class="ae kw" href="https://libjpeg-turbo.org/" rel="noopener ugc nofollow" target="_blank"> libjpeg-turbo </a>库也可以工作，因为它与常规jpeg库兼容，QPDF不使用任何在直接jpeg8 API中不存在的接口。这些都是每个Linux发行版的一部分，并且很容易获得。下载信息出现在文档中。</p></blockquote><p id="dbf1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以现在我们需要建立一个jpeg库。这里我们可以采用不同的方法，因为libjpeg-turbo可以由yum安装。为了使它可用，我们获取yum repo并将其放在<code class="fe ng nh ni nj b">/etc/yum.repos.d</code>文件夹中，当我们运行install命令时，yum将在那里找到它。</p><pre class="nl nm nn no gt nq nj nr ns aw nt bi"><span id="b04a" class="nu me iq nj b gy nv nw l nx ny">cd /etc/yum.repos.d/<br/>sudo wget "https://libjpeg-turbo.org/pmwiki/uploads/Downloads/libjpeg-turbo.repo"<br/>sudo yum install libjpeg-turbo-official</span></pre><p id="3e6a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们需要在构建pdf时使库可用</p><pre class="nl nm nn no gt nq nj nr ns aw nt bi"><span id="9c9b" class="nu me iq nj b gy nv nw l nx ny">export LIBRARY_PATH=/usr/local/lib:/opt/libjpeg-turbo/lib64:$LIBRARY_PATH<br/>export CPATH=/usr/local/include:/opt/libjpeg-turbo/include:$CPATH</span></pre><p id="9356" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们可以返回到qpdf代码所在的目录，并尝试再次构建。</p><pre class="nl nm nn no gt nq nj nr ns aw nt bi"><span id="ba1b" class="nu me iq nj b gy nv nw l nx ny">cd ~/qpdf-release-qpdf-8.4.0/<br/>./configure<br/>make<br/>sudo make install</span></pre><p id="fb05" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这次我们成功了:)</p><h1 id="41f2" class="md me iq bd mf mg oa mi mj mk ob mm mn mo oc mq mr ms od mu mv mw oe my mz na bi translated">使我们的库对lambda函数可用</h1><p id="612f" class="pw-post-body-paragraph jy jz iq ka b kb nb kd ke kf nc kh ki kj nd kl km kn ne kp kq kr nf kt ku kv ij bi translated">基本上，我们需要:</p><ul class=""><li id="d585" class="of og iq ka b kb kc kf kg kj oh kn oi kr oj kv ok ol om on bi translated">将EC2中的相关文件复制到我们的项目中</li><li id="4e1f" class="of og iq ka b kb oo kf op kj oq kn or kr os kv ok ol om on bi translated">上传带有aws lambda部署包的可执行二进制文件。</li><li id="cf08" class="of og iq ka b kb oo kf op kj oq kn or kr os kv ok ol om on bi translated">确保我们的可执行二进制文件保持正确的可执行权限。</li><li id="9cf3" class="of og iq ka b kb oo kf op kj oq kn or kr os kv ok ol om on bi translated">更改<code class="fe ng nh ni nj b">$PATH</code> env变量以包含我们的可执行文件的位置。</li></ul><p id="b615" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后我们应该可以运行<code class="fe ng nh ni nj b">qpdf</code>命令。</p><h2 id="a9d3" class="nu me iq bd mf ot ou dn mj ov ow dp mn kj ox oy mr kn oz pa mv kr pb pc mz pd bi translated">复制文件</h2><p id="70bb" class="pw-post-body-paragraph jy jz iq ka b kb nb kd ke kf nc kh ki kj nd kl km kn ne kp kq kr nf kt ku kv ij bi translated">当我们将qpdf安装在可执行文件之上时，我们将它放在了<code class="fe ng nh ni nj b">/usr/local/bin</code>目录中，该目录位于EC2实例的路径上。</p><pre class="nl nm nn no gt nq nj nr ns aw nt bi"><span id="017b" class="nu me iq nj b gy nv nw l nx ny">[ec2-user@ip-172-31-11-145 bin]$ cd /usr/local/bin</span><span id="40ab" class="nu me iq nj b gy nz nw l nx ny">[ec2-user@ip-172-31-11-145 bin]$ ls -l</span><span id="4f34" class="nu me iq nj b gy nz nw l nx ny">total 3716</span><span id="a14a" class="nu me iq nj b gy nz nw l nx ny">-rwxr-xr-x 1 root root    8369 Jun  3 02:40 fix-qdf</span><span id="2f61" class="nu me iq nj b gy nz nw l nx ny">-rwxr-xr-x 1 root root 3612336 Jun  3 02:40 qpdf</span><span id="4e43" class="nu me iq nj b gy nz nw l nx ny">-rwxr-xr-x 1 root root   40808 Jun  3 02:40 zlib-flate</span></pre><p id="e385" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们看到有3个可执行文件放在那里。为了将它们压缩并复制到我们的开发机器上，我们使用以下命令:</p><pre class="nl nm nn no gt nq nj nr ns aw nt bi"><span id="a949" class="nu me iq nj b gy nv nw l nx ny">zip -r9 /tmp/QpdfBinaries.zip /usr/local/bin/*</span><span id="93a9" class="nu me iq nj b gy nz nw l nx ny">exit</span><span id="d734" class="nu me iq nj b gy nz nw l nx ny">scp -i "ec2instancekeypair.pem" ec2-user@ec2-13-210-163-112.ap-southeast-2.compute.amazonaws.com:/tmp/QpdfBinaries.zip QpdfBinaries.zip</span></pre><p id="a779" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意您必须更改<code class="fe ng nh ni nj b">ec2-user@ec2–13–210–163–112.ap-southeast-2.compute.amazonaws.com</code>来引用您的ec2实例。</p><h2 id="3ac6" class="nu me iq bd mf ot ou dn mj ov ow dp mn kj ox oy mr kn oz pa mv kr pb pc mz pd bi translated">使用无服务器部署上传</h2><p id="0d69" class="pw-post-body-paragraph jy jz iq ka b kb nb kd ke kf nc kh ki kj nd kl km kn ne kp kq kr nf kt ku kv ij bi translated">在部署中包含二进制文件实际上非常容易。</p><p id="0383" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在您的项目中创建一个名为<code class="fe ng nh ni nj b">bin</code>的文件夹，并将所有文件放入其中。然后，把这个加到你的<code class="fe ng nh ni nj b">serverless.yml</code></p><pre class="nl nm nn no gt nq nj nr ns aw nt bi"><span id="822a" class="nu me iq nj b gy nv nw l nx ny">package:<br/>  include:<br/>    - bin/*<br/>    - sharedlib/*</span></pre><h2 id="33d2" class="nu me iq bd mf ot ou dn mj ov ow dp mn kj ox oy mr kn oz pa mv kr pb pc mz pd bi translated">了解Linux上的共享库</h2><p id="a6c6" class="pw-post-body-paragraph jy jz iq ka b kb nb kd ke kf nc kh ki kj nd kl km kn ne kp kq kr nf kt ku kv ij bi translated">每当执行ELF二进制程序时，程序加载程序(<code class="fe ng nh ni nj b">/lib/ld-linux.so.X</code>)就会运行。加载器查找并加载程序使用的所有共享库。要了解<code class="fe ng nh ni nj b">qpdf</code>使用了哪些共享库，可以使用<code class="fe ng nh ni nj b">ldd</code>:</p><pre class="nl nm nn no gt nq nj nr ns aw nt bi"><span id="c47f" class="nu me iq nj b gy nv nw l nx ny">[ec2-user@ip-172-31-11-145 ~]$ ldd /usr/local/bin/qpdf</span><span id="f7a1" class="nu me iq nj b gy nz nw l nx ny">linux-vdso.so.1 =&gt;  (0x00007ffe061f5000)</span><span id="d405" class="nu me iq nj b gy nz nw l nx ny">libqpdf.so.21 =&gt; /usr/local/lib/libqpdf.so.21 (0x00007fcda1028000)</span><span id="551b" class="nu me iq nj b gy nz nw l nx ny">libjpeg.so.62 =&gt; /usr/lib64/libjpeg.so.62 (0x00007fcda0dcd000)</span><span id="79b0" class="nu me iq nj b gy nz nw l nx ny">libz.so.1 =&gt; /lib64/libz.so.1 (0x00007fcda0bb7000)</span><span id="2a48" class="nu me iq nj b gy nz nw l nx ny">libstdc++.so.6 =&gt; /usr/lib64/libstdc++.so.6 (0x00007fcda08b3000)</span><span id="ae0c" class="nu me iq nj b gy nz nw l nx ny">libm.so.6 =&gt; /lib64/libm.so.6 (0x00007fcda05b0000)</span><span id="953c" class="nu me iq nj b gy nz nw l nx ny">libgcc_s.so.1 =&gt; /lib64/libgcc_s.so.1 (0x00007fcda039a000)</span><span id="8376" class="nu me iq nj b gy nz nw l nx ny">libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fcd9ffcd000)</span><span id="6166" class="nu me iq nj b gy nz nw l nx ny">/lib64/ld-linux-x86-64.so.2 (0x00005560ffe20000)</span></pre><p id="279d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将所需的共享库与Lambda部署包捆绑在一起。在项目中创建一个名为<code class="fe ng nh ni nj b">sharedlib</code>的文件夹，并将所有必需的共享库文件放在那里。稍后我们将把环境变量<code class="fe ng nh ni nj b">LD_LIBRARY_PATH</code>设置到适当的位置。</p><pre class="nl nm nn no gt nq nj nr ns aw nt bi"><span id="6090" class="nu me iq nj b gy nv nw l nx ny">scp -i "ec2instancekeypair.pem" <a class="ae kw" href="mailto:ec2-user@ec2-13-210-163-112.ap-southeast-2.compute.amazonaws.com" rel="noopener ugc nofollow" target="_blank">ec2-user@ec2-13-210-163-112.ap-southeast-2.compute.amazonaws.com</a>:/usr/local/lib/libqpdf.so.21.4.0 libqpdf.so.21<br/>scp -i "ec2instancekeypair.pem" <a class="ae kw" href="mailto:ec2-user@ec2-13-210-163-112.ap-southeast-2.compute.amazonaws.com" rel="noopener ugc nofollow" target="_blank">ec2-user@ec2-13-210-163-112.ap-southeast-2.compute.amazonaws.com</a>:/usr/lib64/libjpeg.so.62 libjpeg.so.62</span></pre><p id="7a5c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">事实证明，只有libqpdf.so.21和libjpeg.so.62需要添加到lambda已经可用的共享库中。</p><p id="7a89" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您的项目现在应该看起来像这样:</p><figure class="nl nm nn no gt jr gh gi paragraph-image"><div class="gh gi pe"><img src="../Images/66a3d089806ac1281a73a294062ff001.png" data-original-src="https://miro.medium.com/v2/resize:fit:370/format:webp/1*FRnsUZ60AHIhKTxvkxpV6Q.png"/></div></figure><h2 id="3385" class="nu me iq bd mf ot ou dn mj ov ow dp mn kj ox oy mr kn oz pa mv kr pb pc mz pd bi translated">许可</h2><p id="2d5c" class="pw-post-body-paragraph jy jz iq ka b kb nb kd ke kf nc kh ki kj nd kl km kn ne kp kq kr nf kt ku kv ij bi translated">你的文件在lambda机器上解包时应该保持它们的权限。在您的开发机器上使用<code class="fe ng nh ni nj b">chmod</code>赋予文件执行权限，如果他们还没有的话。</p><h2 id="f6a0" class="nu me iq bd mf ot ou dn mj ov ow dp mn kj ox oy mr kn oz pa mv kr pb pc mz pd bi translated">改变路径</h2><p id="1136" class="pw-post-body-paragraph jy jz iq ka b kb nb kd ke kf nc kh ki kj nd kl km kn ne kp kq kr nf kt ku kv ij bi translated">我们需要确保在函数代码的开头包含以下内容:</p><pre class="nl nm nn no gt nq nj nr ns aw nt bi"><span id="0f0d" class="nu me iq nj b gy nv nw l nx ny">process.env.PATH = `${process.env.PATH}:${process.env.LAMBDA_TASK_ROOT}/bin`;</span><span id="39ce" class="nu me iq nj b gy nz nw l nx ny">process.env.LD_LIBRARY_PATH = `${process.env.LAMBDA_TASK_ROOT}/sharedlib`;</span></pre></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="a8b9" class="md me iq bd mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na bi translated">运行qpdf</h1><blockquote class="lw lx ly"><p id="e74f" class="jy jz lz ka b kb kc kd ke kf kg kh ki ma kk kl km mb ko kp kq mc ks kt ku kv ij bi translated">要启动一个后台进程，您可以使用Node.js中的<a class="ae kw" href="https://nodejs.org/api/child_process.html" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> child_process </em>命令</a>来执行一个随您的函数上传的二进制文件或任何对您的函数可见的可执行文件，比如<em class="iq"> /bin/bash </em>或<em class="iq"> /usr/bin/python </em>。Node.js既支持<em class="iq"> child_process.spawn </em>，它通过接受回调或返回EventEmitter来遵循常见的异步编程模式，也支持<em class="iq"> child_process.spawnSync，</em>，它在将控制权返回给代码之前等待衍生的进程退出。</p></blockquote><p id="8a15" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面是异步生成<code class="fe ng nh ni nj b">qpdf</code>命令的代码，向它传递必要的参数。</p><figure class="nl nm nn no gt jr"><div class="bz fp l di"><div class="pf pg l"/></div></figure><p id="4dfc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完整的加密选项在这里<a class="ae kw" href="http://qpdf.sourceforge.net/files/qpdf-manual.html#ref.encryption-options" rel="noopener ugc nofollow" target="_blank">列出。与我们的目的相关的部分是:</a></p><pre class="nl nm nn no gt nq nj nr ns aw nt bi"><span id="590d" class="nu me iq nj b gy nv nw l nx ny">--encrypt <em class="lz">user-password</em> <em class="lz">owner-password</em> <em class="lz">key-length</em> [ <em class="lz">restrictions</em> ] --</span></pre><p id="6086" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过指定<code class="fe ng nh ni nj b">modify=none</code>，我们使得pdf对于任何只知道用户密码的人来说都是不可变的。您还可以添加对打印、文本和图像提取、注释等的限制。</p><p id="c1bd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果<code class="fe ng nh ni nj b"><em class="lz">key-length</em></code>设置为256，则最低PDF版本为1.7，扩展级别为8，使用的基于AES的加密格式为Acrobat X支持的PDF 2.0加密方法。</p><h1 id="b4fb" class="md me iq bd mf mg oa mi mj mk ob mm mn mo oc mq mr ms od mu mv mw oe my mz na bi translated">实现加密服务</h1><p id="8e98" class="pw-post-body-paragraph jy jz iq ka b kb nb kd ke kf nc kh ki kj nd kl km kn ne kp kq kr nf kt ku kv ij bi translated">由于qpdf需要对文件进行加密，存储在文件系统中，并将结果文件写出到文件系统中，因此我们需要创建一个服务来读取和写入文件。</p><p id="0dc1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们定义一个我们的文件系统服务必须实现的简单接口:</p><pre class="nl nm nn no gt nq nj nr ns aw nt bi"><span id="daaa" class="nu me iq nj b gy nv nw l nx ny">export interface FileSystemService {</span><span id="1079" class="nu me iq nj b gy nz nw l nx ny">  read(path: string): Promise&lt;Buffer&gt;;</span><span id="7939" class="nu me iq nj b gy nz nw l nx ny">  save(data: Buffer, path: string): Promise&lt;any&gt;;<br/>}</span></pre><p id="2e8d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该接口的一个可能实现是:</p><figure class="nl nm nn no gt jr"><div class="bz fp l di"><div class="pf pg l"/></div></figure><p id="34e3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">幸运的是，每个Lambda函数在其自己的/tmp目录中接收500MB的非持久磁盘空间，因此我们可以用它来存储我们的文件。</p><p id="b536" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里我们完成了加密服务。注意，private encrypt方法的代码已经被省略，因为它在本文前面已经显示过。</p><figure class="nl nm nn no gt jr"><div class="bz fp l di"><div class="pf pg l"/></div></figure><p id="d0a8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后一步是修改我之前文章中的<code class="fe ng nh ni nj b">handler</code>代码，在返回之前对pdf进行加密:</p><figure class="nl nm nn no gt jr"><div class="bz fp l di"><div class="pf pg l"/></div></figure><p id="042e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，当我们尝试打开由服务创建的pdf时，我们看到:</p><figure class="nl nm nn no gt jr gh gi paragraph-image"><div class="gh gi ph"><img src="../Images/f3c5048c74a3e78920892d1fb6d5b123.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*ssFi8n_gEg9iDpEjtJe6Aw.png"/></div></figure><p id="a274" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意，用户密码和所有者密码都可以是空字符串。如果将空字符串指定为用户密码，则打开pdf时不需要密码，但会施加应用于文档的任何限制，例如不允许修改。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="59e8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">今天的帖子到此结束。记得停止EC2实例，以确保不会产生意外的费用。</p><p id="632d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">显然<code class="fe ng nh ni nj b">qpdf</code>只是你可能想在Lambda函数中使用的命令行工具的一个例子。运行另一个工具的步骤应该与上面列出的非常相似。</p><p id="1e3e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我的下一篇<a class="ae kw" href="https://medium.com/@keith.coughtrey/aws-step-functions-why-you-should-use-them-eb40cc359f2a?source=friends_link&amp;sk=dd791418db0db9861f1ac580627617eb" rel="noopener">文章</a>中，我将介绍从AWS step函数调用PDF服务。</p><p id="babe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该系列的所有代码都可以在<a class="ae kw" href="https://github.com/keithcoughtrey/LambdaPuppeteer" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p></div></div>    
</body>
</html>