<html>
<head>
<title>Logz.io: collection logs from Kubernetes — fluentd vs filebeat</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Logz.io:来自Kubernetes的收集日志— fluentd与filebeat</h1>
<blockquote>原文：<a href="https://itnext.io/logz-io-collection-logs-from-kubernetes-fluentd-vs-filebeat-7d3b06708cfe?source=collection_archive---------1-----------------------#2021-02-01">https://itnext.io/logz-io-collection-logs-from-kubernetes-fluentd-vs-filebeat-7d3b06708cfe?source=collection_archive---------1-----------------------#2021-02-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/9c7bb3368df63c18bc9c642030aecfcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P8PaFnT6TshOzcjBylRo_g.png"/></div></div></figure><p id="cc71" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们使用<a class="ae kw" href="https://logz.io/" rel="noopener ugc nofollow" target="_blank"> Logz.io </a>来收集我们的Kubernetes集群日志(还有一个本地<a class="ae kw" href="https://rtfm.co.ua/en/grafana-labs-loki-logs-collector-and-monitoring-system/" rel="noopener ugc nofollow" target="_blank"> Loki </a>实例)。</p><p id="8edd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">日志由每个WorkerNode上的<a class="ae kw" href="https://www.fluentd.org/" rel="noopener ugc nofollow" target="_blank"> Fluentd </a> pod收集和处理，worker node从默认配置中的<a class="ae kw" href="https://raw.githubusercontent.com/logzio/logzio-k8s/master/logzio-daemonset-rbac.yaml" rel="noopener ugc nofollow" target="_blank"> DaemonSet </a>部署，请参见此处的文档— <a class="ae kw" href="https://github.com/logzio/logzio-k8s" rel="noopener ugc nofollow" target="_blank"> logzio-k8s </a>。</p><p id="9a9e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们面临的问题是这些pod消耗了太多的cpu，高达3000毫cpu，而我们的WorkerNodes只有4个核心，例如4000毫CPU。</p><p id="1dbd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，为了解决这个问题，我决定搜索类似的日志收集器，第二件要做的事情是能够通过Helm chart用Ansible部署它们，但Fluentd还没有现成的图表。</p><p id="5eea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">找到的解决方案是一个Filebeat收集器，参见<a class="ae kw" href="https://docs.logz.io/shipping/log-sources/k8s-over-helm.html" rel="noopener ugc nofollow" target="_blank">通过Filebeat </a>用Helm运送k8s日志—让我们试试。</p><p id="8a40" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，我们将手动将其部署到一个开发集群，然后我们将添加一个可评估的任务，将其部署到我们的生产中。</p><h1 id="668b" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Logz.io Filebeat舵图</h1><p id="648f" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">添加存储库:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="0546" class="mj ky iq mf b gy mk ml l mm mn">$ helm repo add logzio-helm <a class="ae kw" href="https://logzio.github.io/logzio-helm/filebeat" rel="noopener ugc nofollow" target="_blank">https://logzio.github.io/logzio-helm/filebeat</a><br/>“logzio-helm” has been added to your repositories</span></pre><p id="d9f1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们需要找到我们的令牌和地区—转到帐户的常规设置:</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/8cb1e0cf8b1d01db9dc0fabd11c57ec1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1310/format:webp/0*SRB0C7oof0k8matG.png"/></div></figure><p id="8fde" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">由于我们有默认的地区-us-east-1，请参见<a class="ae kw" href="https://docs.logz.io/user-guide/accounts/account-region.html" rel="noopener ugc nofollow" target="_blank">如何查找您的帐户地区</a>，然后我们可以从舵图的参数中删除<code class="fe mp mq mr mf b">secrets.logzioRegion</code>。</p><p id="934e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，默认情况下，Logz.io客户端将被安装到<code class="fe mp mq mr mf b">kube-system</code>名称空间，但我想把它放在一个专用的NS中，以便更容易地监控它所使用的资源。</p><p id="f443" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">名称空间是在<a class="ae kw" href="https://github.com/logzio/logzio-helm/blob/master/filebeat/values.yaml#L14" rel="noopener ugc nofollow" target="_blank">值</a>文件中配置的，所以让我们用<code class="fe mp mq mr mf b">--set</code>覆盖它，再加上添加<code class="fe mp mq mr mf b">--create-namespace</code>和<code class="fe mp mq mr mf b">--debug</code>选项:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="6ab4" class="mj ky iq mf b gy mk ml l mm mn">$ helm install — namespace=dev-1–18-devops-logzio-ns \<br/> --create-namespace — debug \<br/> --set secrets.logzioShippingToken='AVG***Onq' \<br/> --set secrets.clusterName='bttrm-eks-dev-1–18' \<br/> --set namespace=dev-1–18-devops-logzio-ns \<br/>logzio-k8s-logs logzio-helm/logzio-k8s-logs</span></pre><p id="1f03" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查舱:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="f2f7" class="mj ky iq mf b gy mk ml l mm mn">$ kubectl -n dev-1–18-devops-logzio-ns get pod<br/>NAME READY STATUS RESTARTS AGE<br/>filebeat-2qt5s 1/1 Running 0 96s<br/>filebeat-4xb44 1/1 Running 0 96s<br/>filebeat-9prr9 1/1 Running 0 96s<br/>filebeat-cth47 1/1 Running 0 96s<br/>filebeat-fgmgx 1/1 Running 0 96s<br/>filebeat-gb5ts 1/1 Running 0 96s<br/>filebeat-hs9tr 1/1 Running 0 96s<br/>filebeat-nskvg 1/1 Running 0 96s<br/>filebeat-wfgbg 1/1 Running 0 96s</span></pre><p id="112a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并在<a class="ae kw" href="https://app.logz.io/" rel="noopener ugc nofollow" target="_blank"> app.logs.io </a>页面登录基巴纳:</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/685d836ea620797f60d64f76282b9ca7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xdqsDKaFybGudO7d.png"/></div></div></figure><h1 id="138c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Ansible</h1><p id="e158" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">有一个关于用Ansible部署舵图的帖子——<a class="ae kw" href="https://rtfm.co.ua/ansible-modul-community-kubernetes-i-ustanovka-helm-charta-s-externaldns/" rel="noopener ugc nofollow" target="_blank">ansi ble:модуль社区. kubernetesиустановкаhelm-чартасexternaldns</a>(<em class="mt">RUS</em>)，此时只是一个快速的例子。</p><p id="0fb2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加一个<code class="fe mp mq mr mf b">when</code>条件，因为我们将只把Logz.io部署到生产集群:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="b477" class="mj ky iq mf b gy mk ml l mm mn">- name: "Add Logzio chart repo"<br/>  when: "eks_env.startswith('prod')"<br/>  community.kubernetes.helm_repository:<br/>    name: "logzio-helm"<br/>    repo_url: "https://logzio.github.io/logzio-helm/filebeat"<br/><br/>- name: "Deploy Logzio Filebit chart to the {{ eks_env }}-devops-logzio-ns namespace"<br/>  when: "eks_env.startswith('prod')"<br/>  community.kubernetes.helm:<br/>    kubeconfig: "{{ kube_config_path }}"<br/>    name: "logzio-k8s-logs"<br/>    chart_ref: "logzio-helm/logzio-k8s-logs"<br/>    release_namespace: "{{ eks_env }}-devops-logzio-ns"<br/>    create_namespace: true<br/>    values:<br/>      secrets:<br/>        logzioShippingToken: "{{ logzio_token }}"<br/>        clusterName: "{{ eks_cluster_name }}"<br/>      namespace: "{{ eks_env }}-devops-logzio-ns"</span></pre><p id="b63f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Ansible变量中指定<code class="fe mp mq mr mf b">logzio_token</code>，并用<code class="fe mp mq mr mf b"><a class="ae kw" href="https://rtfm.co.ua/ansible-ispolzovanie-vault-zashifrovannogo-xranilishha/" rel="noopener ugc nofollow" target="_blank">ansible-vault</a></code>对其加密，因为我们在Github存储库中存储了我们的Ansible角色。</p><h1 id="cf82" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Fluentd与Filebeat — CPU和性能</h1><p id="92ef" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">最后是CPU使用率:左边是旧的<code class="fe mp mq mr mf b">fluentd</code> (Ruby + C)右边是新的<code class="fe mp mq mr mf b">filebeat</code> (Golang):</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/6abbf1affa5bf296bb621f5d46218068.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ETbJU7SNO0_lKEek.png"/></div></div></figure></div><div class="ab cl mv mw hu mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ij ik il im in"><p id="bf98" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="mt">最初发布于</em> <a class="ae kw" href="https://rtfm.co.ua/en/logz-io-collection-logs-from-kubernetes-fluentd-vs-filebeat/" rel="noopener ugc nofollow" target="_blank"> <em class="mt"> RTFM: Linux、DevOps和系统管理</em> </a> <em class="mt">。</em></p></div></div>    
</body>
</html>