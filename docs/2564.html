<html>
<head>
<title>Creating a simple Cloud Dataflow with Kotlin</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Kotlin创建简单的云数据流</h1>
<blockquote>原文：<a href="https://itnext.io/creating-a-simple-cloud-dataflow-with-kotlin-cc9f76f47bc5?source=collection_archive---------3-----------------------#2019-06-15">https://itnext.io/creating-a-simple-cloud-dataflow-with-kotlin-cc9f76f47bc5?source=collection_archive---------3-----------------------#2019-06-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/74ef964167fd7b2f70c4ea77ccce11c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WMbfoYqGhvAYNumaNv42TQ.png"/></div></div></figure><h1 id="0684" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">介绍</h1><p id="d73b" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">长期以来，MapReduce一直被用来处理大数据。不久前，谷歌推出了云数据流，这使得批处理和流处理的新模式成为可能。在本文中，我将展示一个使用Apache Beam、云发布/订阅和云数据存储的最小项目。</p><h1 id="dbb2" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">为什么是科特林？</h1><p id="77fb" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">虽然来自Google 的<a class="ae lu" href="https://cloud.google.com/dataflow/docs/quickstarts/quickstart-java-maven" rel="noopener ugc nofollow" target="_blank">文档仍然是Java和Maven，但是Apache Beam项目最近得到了</a><a class="ae lu" href="https://beam.apache.org/blog/2019/04/25/beam-kotlin.html" rel="noopener ugc nofollow" target="_blank"> Kotlin示例</a>。我认为用Kotlin编写射束管道会使它们更加易读、直观和熟悉:)</p><h1 id="d77b" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">我们创造了什么？</h1><p id="e618" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">让我们创建一个简单的管道，它订阅一个发布/订阅主题，并为每条消息创建数据存储实体。可能这是数据流的一个最原始的用例。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lv"><img src="../Images/e967b22cc42a5014ab58b66c078501c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MyKpVWjMLFfSaytf3QFXQA.png"/></div></div></figure><h1 id="12c6" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">创建项目</h1><p id="6964" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">首先，创建一个gradle项目。您可以通过传递<code class="fe ma mb mc md b">type</code>参数将其指定为Kotlin项目。</p><pre class="lw lx ly lz gt me md mf mg aw mh bi"><span id="e48e" class="mi jz iq md b gy mj mk l ml mm">mkdir &lt;your-proj-dir&gt;<br/>cd &lt;your-proj-dir&gt;<br/>gradle init --type kotlin-application</span></pre><h1 id="882e" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">设置梯度构建</h1><p id="51fc" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">因为我们在这个项目中使用Apache Beam，所以将这些行放在<code class="fe ma mb mc md b">build.gradle</code>文件的<code class="fe ma mb mc md b">dependencies</code>块中。</p><pre class="lw lx ly lz gt me md mf mg aw mh bi"><span id="82de" class="mi jz iq md b gy mj mk l ml mm">    implementation 'org.slf4j:slf4j-simple:1.7.26'<br/>    implementation 'org.apache.beam:beam-sdks-java-core:2.13.0'<br/>    implementation 'org.apache.beam:beam-runners-direct-java:2.13.0'<br/>    implementation 'org.apache.beam:beam-runners-google-cloud-dataflow-java:2.13.0'</span></pre><p id="3b6a" class="pw-post-body-paragraph kw kx iq ky b kz mn lb lc ld mo lf lg lh mp lj lk ll mq ln lo lp mr lr ls lt ij bi translated">另外，在<code class="fe ma mb mc md b">build.gradle</code>的顶层添加这个块。当我们运行这个程序时，这对于传递命令行参数是必要的。</p><pre class="lw lx ly lz gt me md mf mg aw mh bi"><span id="f81c" class="mi jz iq md b gy mj mk l ml mm">run {<br/>    if (project.hasProperty('args')) {<br/>        args project.args.split('\\s+')<br/>    }<br/>}</span></pre><p id="5039" class="pw-post-body-paragraph kw kx iq ky b kz mn lb lc ld mo lf lg lh mp lj lk ll mq ln lo lp mr lr ls lt ij bi translated">感谢<a class="ae lu" href="https://i101330.hatenablog.com/entry/2018/04/25/124127" rel="noopener ugc nofollow" target="_blank">这篇文章</a>！</p><h1 id="620a" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">配置您的环境</h1><p id="b75b" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">准备一个具有发布/订阅、数据存储和数据流范围的服务帐户。<br/>从谷歌云控制台获取账户的凭证<code class="fe ma mb mc md b">json</code>文件，并将其放在你的PC上的某个地方。</p><p id="e9b4" class="pw-post-body-paragraph kw kx iq ky b kz mn lb lc ld mo lf lg lh mp lj lk ll mq ln lo lp mr lr ls lt ij bi translated">在Linux或Mac上，</p><pre class="lw lx ly lz gt me md mf mg aw mh bi"><span id="105f" class="mi jz iq md b gy mj mk l ml mm">export GOOGLE_APPLICATION_CREDENTIALS=&lt;full-path-to-your-json&gt;</span></pre><p id="c848" class="pw-post-body-paragraph kw kx iq ky b kz mn lb lc ld mo lf lg lh mp lj lk ll mq ln lo lp mr lr ls lt ij bi translated">在Windows上，在你的外壳上使用<code class="fe ma mb mc md b">set</code>之类的东西。</p><p id="3da1" class="pw-post-body-paragraph kw kx iq ky b kz mn lb lc ld mo lf lg lh mp lj lk ll mq ln lo lp mr lr ls lt ij bi translated">注意:Apache Beam有<code class="fe ma mb mc md b">GcpOptions#setGcpCredential</code>但是对我没用。</p><h1 id="e494" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">制作管道代码</h1><p id="ffc1" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">打开<code class="fe ma mb mc md b">src/main/kotlin/&lt;your-proj-name&gt;/App.kt</code>，用下面的代码替换它的内容。请随意更改包名和其他常量。</p><pre class="lw lx ly lz gt me md mf mg aw mh bi"><span id="3f53" class="mi jz iq md b gy mj mk l ml mm">package org.yourproj</span><span id="d0dd" class="mi jz iq md b gy ms mk l ml mm">import org.apache.beam.sdk.Pipeline<br/>import org.apache.beam.sdk.io.gcp.pubsub.PubsubIO<br/>import org.apache.beam.sdk.io.gcp.pubsub.PubsubOptions<br/>import org.apache.beam.sdk.io.gcp.datastore.DatastoreIO<br/>import org.apache.beam.sdk.options.PipelineOptionsFactory<br/>import org.apache.beam.sdk.transforms.*<br/>import org.apache.beam.sdk.values.PCollection</span><span id="7ae1" class="mi jz iq md b gy ms mk l ml mm">import com.google.datastore.v1.client.DatastoreHelper.makeKey<br/>import com.google.datastore.v1.client.DatastoreHelper.makeValue<br/>import com.google.datastore.v1.Entity<br/>import org.slf4j.LoggerFactory;</span><span id="fc10" class="mi jz iq md b gy ms mk l ml mm">interface MyOptions : PubsubOptions {<br/>    var topic: String<br/>}</span><span id="ac49" class="mi jz iq md b gy ms mk l ml mm">fun main(args: Array&lt;String&gt;) {<br/>    val LOGGER = LoggerFactory.getLogger("org.yourproj.AppKt")</span><span id="c574" class="mi jz iq md b gy ms mk l ml mm">    val options = PipelineOptionsFactory<br/>        .fromArgs(*args)<br/>        .withValidation()<br/>        .`as`(MyOptions::class.java)</span><span id="e9dc" class="mi jz iq md b gy ms mk l ml mm">    val p = Pipeline.create(options)<br/>    p.apply&lt;PCollection&lt;String&gt;&gt;(PubsubIO.readStrings().fromTopic(options.topic))<br/>        .apply(ParDo.of(object: DoFn&lt;String, Entity&gt;() {<br/>            <a class="ae lu" href="http://twitter.com/DoFn" rel="noopener ugc nofollow" target="_blank">@DoFn</a>.ProcessElement<br/>            fun processElement(<a class="ae lu" href="http://twitter.com/DoFn" rel="noopener ugc nofollow" target="_blank">@DoFn</a>.Element input: String, output: DoFn.OutputReceiver&lt;Entity&gt;) {<br/>                LOGGER.info("input " + input)</span><span id="3ada" class="mi jz iq md b gy ms mk l ml mm">                val key = String.format("%s-%s", "data", input.replace(' ', '-').toLowerCase())<br/>                <br/>                val entityBuilder = Entity.newBuilder()<br/>                entityBuilder.setKey(makeKey("beam-test", key).build())<br/>                entityBuilder.putProperties("message", makeValue(input).build())</span><span id="0d64" class="mi jz iq md b gy ms mk l ml mm">output.output(entityBuilder.build())<br/>            }<br/>        }))<br/>         .apply(DatastoreIO.v1().write().withProjectId(options.project))</span><span id="bc98" class="mi jz iq md b gy ms mk l ml mm">    p.run()<br/>}</span></pre><p id="da9c" class="pw-post-body-paragraph kw kx iq ky b kz mn lb lc ld mo lf lg lh mp lj lk ll mq ln lo lp mr lr ls lt ij bi translated">注意，像项目id和主题名称这样的GCP参数是通过继承的options对象通过实参传递的。</p><p id="132e" class="pw-post-body-paragraph kw kx iq ky b kz mn lb lc ld mo lf lg lh mp lj lk ll mq ln lo lp mr lr ls lt ij bi translated">现在，您可以通过运行此命令来构建您的项目。</p><pre class="lw lx ly lz gt me md mf mg aw mh bi"><span id="d2f7" class="mi jz iq md b gy mj mk l ml mm">gradle build</span></pre><p id="7e96" class="pw-post-body-paragraph kw kx iq ky b kz mn lb lc ld mo lf lg lh mp lj lk ll mq ln lo lp mr lr ls lt ij bi translated">如果构建投诉，删除<code class="fe ma mb mc md b">AppTest.kt</code>中的单元测试。</p><h1 id="4b24" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">在本地运行</h1><p id="bf38" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">现在，您可以使用这个命令在本地运行管道。</p><pre class="lw lx ly lz gt me md mf mg aw mh bi"><span id="95f5" class="mi jz iq md b gy mj mk l ml mm">gradle run -Pargs="--runner=DirectRunner --project=&lt;your-project-name&gt; --topic=&lt;your-pubsub-topic-name&gt;”</span></pre><p id="d8d7" class="pw-post-body-paragraph kw kx iq ky b kz mn lb lc ld mo lf lg lh mp lj lk ll mq ln lo lp mr lr ls lt ij bi translated">如果成功建立了发布/订阅连接，您将在控制台上看到这样的日志。</p><pre class="lw lx ly lz gt me md mf mg aw mh bi"><span id="476c" class="mi jz iq md b gy mj mk l ml mm">[main] WARN org.apache.beam.sdk.io.gcp.pubsub.PubsubUnboundedSource - Created subscription projects/&lt;your-project&gt;/subscriptions/&lt;random-subscription&gt; to topic projects/&lt;your-project&gt;/topics/&lt;your-topic&gt;. Note this subscription WILL NOT be deleted when the pipeline terminates</span></pre><h1 id="0475" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">测试</h1><p id="355a" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我们在这里不使用发布/订阅仿真器，但是来自<a class="ae lu" href="https://cloud.google.com/pubsub/docs/emulator" rel="noopener ugc nofollow" target="_blank">的<code class="fe ma mb mc md b">publisher.py</code>这个文档</a>对于测试是有用的。打开一个新的shell，设置环境变量并运行此命令来发布关于某个主题的一些消息。</p><pre class="lw lx ly lz gt me md mf mg aw mh bi"><span id="de45" class="mi jz iq md b gy mj mk l ml mm">python publisher.py PUBSUB_PROJECT_ID publish TOPIC_ID</span></pre><p id="07e9" class="pw-post-body-paragraph kw kx iq ky b kz mn lb lc ld mo lf lg lh mp lj lk ll mq ln lo lp mr lr ls lt ij bi translated">如果成功，您将看到每条消息的日志行。此外，检查云数据存储中的实体。</p><h1 id="15da" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">在云数据流上部署它</h1><p id="f53c" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">只需将命令行参数改为<code class="fe ma mb mc md b">--runner=DataflowRunner --tempLocation=gs://&lt;your-bucket&gt;</code>，就可以在云数据流上部署管道。</p><p id="7b26" class="pw-post-body-paragraph kw kx iq ky b kz mn lb lc ld mo lf lg lh mp lj lk ll mq ln lo lp mr lr ls lt ij bi translated">一旦您的管道成功部署，它就会出现在数据流控制台上，并看到它正在运行。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mt"><img src="../Images/3509dc7ff235ffc8710eff487886dd9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xzQvHsK3XE7UDewEw1Rc9Q.png"/></div></div></figure><p id="8219" class="pw-post-body-paragraph kw kx iq ky b kz mn lb lc ld mo lf lg lh mp lj lk ll mq ln lo lp mr lr ls lt ij bi translated">注意:要在数据流上部署，您可能需要启用一些API，并为服务帐户分配额外的作用域。仔细阅读错误信息。</p><h1 id="6fe0" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">结论</h1><p id="9aae" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">处理大数据一直是一项艰巨的工作，但云发布/订阅和数据流允许我们通过结合多种存储和管道来采取循序渐进的方法。因为管道很容易开发，所以我们可以专注于模型和架构设计。</p></div></div>    
</body>
</html>