<html>
<head>
<title>How to integrate k3s with a cloud controller</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将k3s与云控制器集成</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-integrate-k3s-with-the-cloud-controller-36bd5020b8f7?source=collection_archive---------5-----------------------#2020-01-21">https://itnext.io/how-to-integrate-k3s-with-the-cloud-controller-36bd5020b8f7?source=collection_archive---------5-----------------------#2020-01-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/aec76ef96f77a4c561b68fce96c09537.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*33KWBeuJYLftuDAb"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@dallasreedy?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">达拉斯里德</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="7d83" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">k3s太棒了！我已经写了一篇关于如何在60秒内创建一个4节点k3s集群的文章(包括虚拟机配置——这里是<a class="ae kc" href="https://medium.com/@dawid.ziolkowski/how-to-create-a-kubernetes-cluster-in-under-60-seconds-7320a58f5b0" rel="noopener"/>)。唯一的问题是它没有云提供商的支持，这意味着你不能像在托管的Kubernetes上一样容易地使用负载平衡器、存储等。但是有一种方法可以做到这一点，这就是这篇文章的内容。所以让我们开始吧</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><p id="4110" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将CCM(云控制器管理器)与k3s集成意味着k3s集群将能够与云提供商API对话，以请求和配置负载平衡器(用于入口)、为节点应用适当的标签等。云提供商之间的流程有所不同(这取决于云提供商是否首先提供CCM)。在这篇文章中，我们将在DigitalOcean上安装k3s(如果你想看不同云的文章，请在评论中告诉我)。</p><p id="9e2a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">整个过程并不复杂，但是你需要仔细地按照步骤来。首先，主节点。安装k3s主节点时，我们需要传递以下参数:</p><ul class=""><li id="cfd5" class="li lj iq kf b kg kh kk kl ko lk ks ll kw lm la ln lo lp lq bi translated">—禁用云控制器</li><li id="a47c" class="li lj iq kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">—不部署服务lb</li><li id="bfb3" class="li lj iq kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">— kubelet-arg= "云提供商=外部"</li><li id="876b" class="li lj iq kf b kg lr kk ls ko lt ks lu kw lv la ln lo lp lq bi translated">—kube let-arg = " provider-id = digital ocean://{ master _ node _ id } "</li></ul><p id="4225" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那么，它们是什么意思呢？首先，顾名思义禁用默认的k3s云控制器。我们需要这样做，否则k3s将使用自己内置的“虚拟”云控制器。第二—我们要求k3s不要部署servicelb，因为它会弄乱IP地址(servicelb会用节点IP覆盖入口IP—我们希望将DigitalOcean LoadBalancer IPs用于服务类型LoadBalancer)。第三，这是几乎所有CCM的要求。我们只需要告诉kubelet我们将使用外部云提供商。最后一个——这是DigitalOcean CCM的特定要求——如果您检查DO CCM GitHub <a class="ae kc" href="https://github.com/digitalocean/digitalocean-cloud-controller-manager" rel="noopener ugc nofollow" target="_blank"> repo </a>,您会看到他们只是要求您将此参数传递给kubelet。[master_node_id]是droplet id，您可以在DO Dashboard中找到它，也可以从droplet本身调用GET来找到它:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="a05c" class="mf mg iq mb b gy mh mi l mj mk">curl <a class="ae kc" href="http://169.254.169.254/metadata/v1/id" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/metadata/v1/id</a></span></pre><p id="82b0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，为了安装为CCM准备的k3s服务器，我们需要这样做:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="9a05" class="mf mg iq mb b gy mh mi l mj mk">curl -sfL <a class="ae kc" href="https://get.k3s.io" rel="noopener ugc nofollow" target="_blank">https://get.k3s.io</a> | sh -s — server \<br/>  --disable-cloud-controller \<br/>  --no-deploy servicelb \<br/>  --kubelet-arg=”cloud-provider=external” \<br/>  --kubelet-arg=”provider-id=digitalocean://$master_id”</span></pre><p id="0e2f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是第一部分——准备。现在k3s服务器启动后，我们需要安装CCM本身。为此，首先克隆git存储库:</p><div class="ml mm gp gr mn mo"><a href="https://github.com/digitalocean/digitalocean-cloud-controller-manager" rel="noopener  ugc nofollow" target="_blank"><div class="mp ab fo"><div class="mq ab mr cl cj ms"><h2 class="bd ir gy z fp mt fr fs mu fu fw ip bi translated">数字海洋/数字海洋-云-控制器-管理器</h2><div class="mv l"><h3 class="bd b gy z fp mt fr fs mu fu fw dk translated">digitalocean-cloud-controller-manager是用于digital ocean的Kubernetes云控制器管理器实现。阅读…</h3></div><div class="mw l"><p class="bd b dl z fp mt fr fs mu fu fw dk translated">github.com</p></div></div><div class="mx l"><div class="my l mz na nb mx nc jw mo"/></div></div></a></div><p id="7138" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们需要创建包含DigitalOcean API令牌的k8s secret。要做到这一点，您可以使用repo中的秘密生成器(只需遵循说明)或使用下面的一行程序:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="96db" class="mf mg iq mb b gy mh mi l mj mk">kubectl -n kube-system create secret generic digitalocean --from-literal=access-token=[YOUR_DO_API_TOKEN]</span></pre><p id="c030" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果保存了机密，那么只需应用存储库中的yaml清单:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="7a27" class="mf mg iq mb b gy mh mi l mj mk">kubectl apply -f releases/v0.1.21.yml</span></pre><p id="918d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就是这样！现在，每当您启动类型为:LoadBalancer的服务时，DigitalOcean LoadBalancer将被创建并配置为将流量路由到它。此外——因为默认情况下k3s带有Traefik——也会自动为它创建DO LB。</p><p id="d88e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">还有一件事。到目前为止，我们只创建了k3s主节点，对于任何工作节点，您只需使用以下参数安装k3s:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="5e15" class="mf mg iq mb b gy mh mi l mj mk">curl -sfL https://get.k3s.io | K3S_TOKEN=${token} sh -s - agent \<br/>  --server https://${master_node_ip}:6443 \<br/>  --kubelet-arg="cloud-provider=external" \<br/>  --kubelet-arg="provider-id=digitalocean://$worker_id"</span></pre><p id="bf90" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">仅此而已。所有节点都将具有适当的标签集(公共/私有ip、DO区域等),并且通过DO LB的路由也将无缝地发生。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><p id="c006" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后但同样重要的是，我创建了一个简单的bash脚本来自动化这个过程。该解决方案允许您在大约2分钟内使用DO CCM在DigitalOcean上创建k3s集群(1个主节点+ x个工作节点):</p><div class="ml mm gp gr mn mo"><a href="https://github.com/DavidZisky/kloud3s" rel="noopener  ugc nofollow" target="_blank"><div class="mp ab fo"><div class="mq ab mr cl cj ms"><h2 class="bd ir gy z fp mt fr fs mu fu fw ip bi translated">GitHub - DavidZisky/kloud3s:部署虚拟机+ k3s集群+云控制器</h2><div class="mv l"><h3 class="bd b gy z fp mt fr fs mu fu fw dk translated">60秒内Kubernetes部署者。简单的bash脚本，在GCP/数字海洋中启动虚拟机，在其上安装k3s，然后…</h3></div><div class="mw l"><p class="bd b dl z fp mt fr fs mu fu fw dk translated">github.com</p></div></div><div class="mx l"><div class="nd l mz na nb mx nc jw mo"/></div></div></a></div></div></div>    
</body>
</html>