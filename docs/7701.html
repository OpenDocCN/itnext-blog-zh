<html>
<head>
<title>Hive-Data-Import with NebulaGraph Exchange in Practice</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在实践中用云图交换导入Hive数据</h1>
<blockquote>原文：<a href="https://itnext.io/hive-data-import-with-nebulagraph-exchange-in-practice-c21ff373d2ad?source=collection_archive---------0-----------------------#2022-12-22">https://itnext.io/hive-data-import-with-nebulagraph-exchange-in-practice-c21ff373d2ad?source=collection_archive---------0-----------------------#2022-12-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ea622c012cb3a8a2f95ed0c1df537ca0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jv0K-BFz3dSQpvGy.png"/></div></div></figure><p id="d728" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">StoneWise公司内部需要使用图形数据库，通过技术选择确定使用NebulaGraph数据库。我们仍然需要在真实的业务场景中验证NebulaGraph数据库的查询性能。因此，我们迫切需要将数据导入NebulaGraph并验证性能。我们发现需要完成将数据从Hive用Exchange导入NebulaGraph的文档，所以我决定记录我们在这个过程中遇到的陷阱，以避免走弯路和陷阱。</p><p id="811b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本文是基于NebulaGraph文档编写的:<a class="ae kw" href="https://docs.nebula-graph.io/3.3.0/nebula-exchange/use-exchange/ex-ug-import-from-hive/" rel="noopener ugc nofollow" target="_blank">从Hive导入数据</a></p><h1 id="9f79" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">环境</h1><ul class=""><li id="c239" class="lv lw iq ka b kb lx kf ly kj lz kn ma kr mb kv mc md me mf bi translated">星云图:每夜</li><li id="5ecf" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">部署:Mac上的Docker</li><li id="deaa" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">硬件:</li><li id="7573" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">磁盘:固态硬盘</li><li id="9360" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">CPU、内存:16 G</li><li id="21f5" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">数据仓库环境(Mac上的本地数据仓库)</li><li id="3e21" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">蜂巢3.1.2</li><li id="2456" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">Hadoop 3.2.1</li><li id="c74d" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">交换:<a class="ae kw" href="https://github.com/vesoft-inc/nebula-java/tree/v1.0/tools/exchange" rel="noopener ugc nofollow" target="_blank">https://github . com/ve soft-Inc/nebula-Java/tree/v 1.0/tools/exchange</a>(编译生成一个JAR包)</li><li id="ec60" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">spark:spark-2 . 4 . 7-bin-Hadoop 2.7(在<code class="fe ml mm mn mo b">$HADOOP_HOME/etc/hadoop</code>目录配置<code class="fe ml mm mn mo b">core-site.xml</code>、<code class="fe ml mm mn mo b">hdfs-site.xml</code>、<code class="fe ml mm mn mo b">hive-site.xml</code>，在<code class="fe ml mm mn mo b">$SPARK_HOME/conf</code>目录配置<code class="fe ml mm mn mo b">spark-env.sh</code>。)</li><li id="51d3" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">Scala code runner版本2.13.3 —版权所有2002–2020，LAMP/EPFL和Lightbend，Inc .</li></ul><h1 id="ed65" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">配置</h1><ol class=""><li id="7ce3" class="lv lw iq ka b kb lx kf ly kj lz kn ma kr mb kv mp md me mf bi translated">星云图DDL</li></ol><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mq"><img src="../Images/021d6e3e61cc6906c5b2cb895e18dc02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*72_ePF20ecL-J1r8.png"/></div></div></figure><p id="df57" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.配置单元DDL</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/70b0e304c18c8732f9ecc96a5048dd93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LXe146ho07jq8387.png"/></div></div></figure><p id="a44c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.最新的<code class="fe ml mm mn mo b">nebula_application.conf</code>文件。注意这些字段映射:<code class="fe ml mm mn mo b">exec</code>、<code class="fe ml mm mn mo b">fields</code>、<code class="fe ml mm mn mo b">nebula.fields</code>、<code class="fe ml mm mn mo b">vertex</code>、<code class="fe ml mm mn mo b">source</code>和<code class="fe ml mm mn mo b">target</code>。</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/87c2cd2422dcd5237a6859e988504682.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uDmdCXicDf2TVxGf.png"/></div></div></figure><h1 id="e6e4" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">开始导入</h1><ol class=""><li id="25bb" class="lv lw iq ka b kb lx kf ly kj lz kn ma kr mb kv mp md me mf bi translated">确保NebulaGraph服务已启动。</li><li id="0b2a" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mp md me mf bi translated">确保配置单元表和数据准备就绪。</li><li id="5ae8" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mp md me mf bi translated">运行<code class="fe ml mm mn mo b">spark-sql cli</code>查看配置单元表和数据是否准备好，以确保Spark环境正常。</li></ol><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/cc6e5fe6dc49ded3c5efa8e8e876e9e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:868/format:webp/0*uARLPY_mDR4VyT0S.jpeg"/></div></figure><p id="ae6e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">4.配置就绪后，执行Spark命令。</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div class="gh gi my"><img src="../Images/94506543b2fcc242ac586047f365ee58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/0*4EACT8rUPFocjuKz.png"/></div></figure><p id="a3e3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">5.成功导入后，您可以使用db_dump工具检查导入的数据量。</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/f0e028bea1836363d6196f84cf0e8991.png" data-original-src="https://miro.medium.com/v2/resize:fit:1368/format:webp/0*hx2sBEOXXkx9arAC.png"/></div></figure><h1 id="2bd6" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">陷阱和注意事项</h1><ul class=""><li id="a5ff" class="lv lw iq ka b kb lx kf ly kj lz kn ma kr mb kv mc md me mf bi translated">第一个缺陷是spark-submit命令没有添加<code class="fe ml mm mn mo b">-h</code>选项。</li><li id="d480" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">NebulaGraph中的标记名区分大小写。标签配置中的名称应该是NebulaGraph的标签名称。</li><li id="f603" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">Hive数据类型<code class="fe ml mm mn mo b">int</code>和NebulaGraph <code class="fe ml mm mn mo b">int</code>不一致。蜂巢<code class="fe ml mm mn mo b">bigint</code>对应于星云图<code class="fe ml mm mn mo b">int</code>。</li></ul><h1 id="d1e9" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">其他注释</h1><ul class=""><li id="2185" class="lv lw iq ka b kb lx kf ly kj lz kn ma kr mb kv mc md me mf bi translated">INSERT操作比UPDATE有更好的性能，因为NebulaGraph的底层存储是KV Store。重复插入会覆盖数据。</li><li id="a220" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">除了文档中的信息，我还阅读了源代码并在论坛上发表了帖子。</li></ul><p id="e62d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我验证了以下两个场景:</p><ul class=""><li id="c9c7" class="lv lw iq ka b kb kc kf kg kj na kn nb kr nc kv mc md me mf bi translated">使用Spark 2.4将数据从Hive 2 (Hadoop 2)导入NebulaGraph</li><li id="eb28" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">使用Spark 2.4将数据从Hive 3 (Hadoop 3)导入NebulaGraph</li></ul><p id="f9b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意:Exchange还不支持Spark 3，编译后报错，所以很难验证Spark 3的环境。</p><p id="feaf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">还有一些疑问。</p><ul class=""><li id="0482" class="lv lw iq ka b kb kc kf kg kj na kn nb kr nc kv mc md me mf bi translated">如何设置<code class="fe ml mm mn mo b">nebula_application.conf</code>文件中的参数<code class="fe ml mm mn mo b">batch</code>和<code class="fe ml mm mn mo b">rate.limit</code>？</li><li id="7a42" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">使用Exchange从Hive导入数据的原理(最近开始学Spark。)</li></ul><h1 id="30fb" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Exchange源代码调试</h1><p id="f408" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj nd kl km kn ne kp kq kr nf kt ku kv ij bi translated">有关Spark调试的信息，请参见<a class="ae kw" href="https://dzone.com/articles/how-to-attach-a-debugger-to-apache-spark" rel="noopener ugc nofollow" target="_blank">https://dzone . com/articles/how-to-attach-a-debugger-to-Apache-Spark</a>。</p><p id="9d63" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过Exchange源代码学习和调试，我发现只有结合源代码才能理解文档中关于导入SST文件和下载摄取的描述。</p><p id="f6dc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">调试源代码也帮我发现了一些配置问题。</p><p id="91b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第一步:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/47beb65313be6ca0f0a2abc90809b9ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*T_4CXCXW5Fb2ffZ2.png"/></div></div></figure><p id="3c26" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第二步:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/968411e6dc18958d3e16740804cf6265.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QaN-XQ0akIC_pXuJ.png"/></div></div></figure><p id="d0bc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第三步:创意配置</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/61ac7018188a371c3438bb9f116b69ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/format:webp/0*9Et7AONn6cpuCwFb.png"/></div></figure><p id="c4c0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第四步:点击创意中的<code class="fe ml mm mn mo b">Debug</code></p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/80b8ff33a6a822383f3769200f5d4710.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/format:webp/0*tF0J57KYYKyk1fNf.png"/></div></figure></div><div class="ab cl nj nk hu nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ij ik il im in"><blockquote class="nq nr ns"><p id="b278" class="jy jz nt ka b kb kc kd ke kf kg kh ki nu kk kl km nv ko kp kq nw ks kt ku kv ij bi translated">你对图形数据库和图形技术有热情吗？加入NebulaGraph开源社区，与专家交流思想，学习实用技能。<a class="ae kw" href="https://bit.ly/3SmvFu2" rel="noopener ugc nofollow" target="_blank">加入松弛度</a></p><p id="303b" class="jy jz nt ka b kb kc kd ke kf kg kh ki nu kk kl km nv ko kp kq nw ks kt ku kv ij bi translated"><em class="iq"> NebulaGraph开源:</em><a class="ae kw" href="https://github.com/vesoft-inc/nebula" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://github.com/vesoft-inc/nebula</em></a><em class="iq">我们高度赞赏每一位观星者，如果你喜欢NebulaGraph数据库，请告诉我们。</em></p></blockquote></div></div>    
</body>
</html>