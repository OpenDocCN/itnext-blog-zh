<html>
<head>
<title>Cloud Bursting with Virtual Kubelet and KIP (Kloud Instance Provider)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">虚拟Kubelet和KIP (Kloud实例提供商)带来的云爆发</h1>
<blockquote>原文：<a href="https://itnext.io/cloud-bursting-with-virtual-kubelet-and-kip-kloud-instance-provider-4b86a479ce38?source=collection_archive---------4-----------------------#2020-05-26">https://itnext.io/cloud-bursting-with-virtual-kubelet-and-kip-kloud-instance-provider-4b86a479ce38?source=collection_archive---------4-----------------------#2020-05-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/55cbded2142ed7e4fa9dd393c243135b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rmyZ0HdWzF7n4lhsydGoxQ.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Kubernetes —弹性云爆发—无节点Kubernetes</figcaption></figure><div class=""/><p id="82fa" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">云爆发是一种应用部署模式，其中应用运行在私有云或数据中心，当计算能力需求激增时，它会爆发到公共云中。这是一种衡量组织使用内部资源托管对其业务至关重要的服务的能力的模型，在需求高峰期间，以按需购买的方式消耗公共云中的资源。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi la"><img src="../Images/3a03f2ce2069d3fe8d97c7a0195bf0d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CwQ8IZP_AYMOp8sI"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">云爆炸—私有云和公共云</figcaption></figure><p id="09e0" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">对于在混合云环境中运行应用的现代企业来说，云爆发是一个强大的概念。通过完全自动化这一过程，公司可以节省资金，同时提高他们的SLA。实现成本节约是因为基础架构可以得到充分利用，允许IT部门在内部承载更保守数量的服务器，同时仍然有一个适当的策略，在峰值性能期间，应用程序可以扩展或完全迁移到外部公共云，如Amazon的EC2。</p><p id="6bbe" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Kubernetes 在突发计算中提供了一个独特的角色，因为它是管理容器的最常见机制，除了减轻工作负载管理的痛苦，Kubernetes还使用户能够以当代计算所需的规模部署容器。来自eltol的<a class="ae lf" href="https://github.com/elotl/kip" rel="noopener ugc nofollow" target="_blank"> Kip </a>是一家<a class="ae lf" href="https://github.com/virtual-kubelet/virtual-kubelet" rel="noopener ugc nofollow" target="_blank">虚拟Kubelet </a>提供商，它允许Kubernetes集群透明地将pods发布到它们自己的云实例cells上。Kip的virtual-kubelet pod在集群上运行，并在集群中注册为虚拟Kubernetes节点。当一个pod被调度到虚拟Kubelet上时，Kip为pod的工作负载启动一个大小合适的云实例(单元),并将pod分派到该实例上。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi lg"><img src="../Images/d47d741576bea35a50f635621b7126ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Bcnl4Xu11h9taCFK"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">库伯内特云爆发—基普</figcaption></figure><p id="d326" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">上面显示的公共云中的pod是单独的EC2实例(每个pod都在自己的EC2实例中运行),称为cells。单元(云实例)是只有准系统内核+ initrd的映像，不运行kubelet或任何容器运行时(如docker ), Kip系统的其他组件负责容器生命周期管理。容器映像被提取到一个平面目录中，并作为流程在云实例(单元)上运行，这里不需要成熟的容器引擎。</p><ul class=""><li id="78ef" class="lh li jf ke b kf kg kj kk kn lj kr lk kv ll kz lm ln lo lp bi translated">Itzo执行kubelet的许多任务，比如设置名称空间、运行和重启进程、运行探测器、挂载卷、捕获日志等。Itzo包含细胞代理和构建细胞图像的代码。</li><li id="f2de" class="lh li jf ke b kf lq kj lr kn ls kr lt kv lu kz lm ln lo lp bi translated"><a class="ae lf" href="https://github.com/elotl/tosi" rel="noopener ugc nofollow" target="_blank"> Tosi </a> : Tosi将图像从图像注册表中提取到单元中，并将它们提取到一个平面目录中，或者创建一个<a class="ae lf" href="https://www.kernel.org/doc/Documentation/filesystems/overlayfs.txt" rel="noopener ugc nofollow" target="_blank"> overlayfs </a>挂载点，将层作为下层。</li><li id="1c66" class="lh li jf ke b kf lq kj lr kn ls kr lt kv lu kz lm ln lo lp bi translated">一个最小的云初始化实现，允许用户为单元提供用户数据。</li></ul><h1 id="215e" class="lv lw jf bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">试用</h1><p id="5067" class="pw-post-body-paragraph kc kd jf ke b kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv mx kx ky kz ij bi translated">下面显示的本地Kubernetes集群是一个一体化集群(主+工作)，其中一个虚拟kubelet pod注册为虚拟工作节点。任何支持的CNI都可以用于本地部署，建议使用与公共云提供商上的云提供商集成的原生CNI插件，其中虚拟kubelet pods和常规pod将从相同的网络(如VPC)地址空间获取其IP地址。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi my"><img src="../Images/37a0e9965ded681f76262a82b4c2baba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IADv_04T5QXj7qp5"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Kubernetes云爆发—本地和AWS</figcaption></figure><p id="65ef" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Virtual-Kubelet配置是通过configmap提供的。该配置包含kip-provider配置和可选的cloud-init配置(该cloud-init作为EC2用户数据提供给在AWS上创建的单元)。</p><p id="a695" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Cloud-init配置允许用户为Kip创建的单元(EC2或云实例)提供用户数据。用户可以在provider.yaml中指定一个cloud-init文件，当Kip引导单元时，将应用cloud-init文件。cloud-init文件可用于提供用户、ssh密钥、设置主机名、编写任意文件、使用“runcmd”运行命令等。或者在该单元上设置额外的包。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/d88381aad80f695a136cfa8d2dea2e5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KXvhOIaEzdYJxd3F"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Kip —虚拟Kubelet配置— cloudinit</figcaption></figure><p id="105e" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">提供商配置包括云提供商凭证、单元的网络信息(将在其中创建实例的网络)、单元特定信息，如:默认实例类型(单元的默认实例类型，Kip支持基于Kubernetes资源请求动态选择实例)、引导映像信息(用户可以构建自己的AMI或使用eltol提供/拥有的默认AMI)、配置路由的CIDR信息、名称标签(用于标识属于该控制器的云资源的名称标签)、默认卷大小(单元的根卷的默认大小)、itzo配置(要使用的itzo代理版本)等</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/54e5d2832a7c3b95c5fdf810a8b0fd07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VIJPx0mZrydglz1t"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Kip —虚拟Kubelet配置—提供商配置</figcaption></figure><p id="a9a0" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Kip provider在virtual-kubelet上的实现从指定的配置中获取VPC和其他AMI(单元图像)信息:</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/d3117089f0a2187a2e5e25da0b169bf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*U1v4P77qfoMBtawJ"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">kip——虚拟Kubelet提供商</figcaption></figure><p id="6b62" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">由于在集群上部署了带有Kip提供者的虚拟Kubelet，因此控制平面daemonset pods，如kube-proxy、node-local-dns等。被安排在virtual-kubelet节点上(因为pod向kube-api注册为节点)。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/28c35636bd57236990b54b3625395f87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*my2oOa-PbQaLJTxM"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">kip——虚拟Kubelet上的Kubernetes控制平面吊舱</figcaption></figure><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/7aac7848dfb97b3a23efc7b01c8305b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Lr2FtwvJmD8GX7MZ"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">kip——虚拟Kubelet上的Kubernetes控制平面吊舱</figcaption></figure><p id="35f1" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Kip将上述pod安排为指定子网内已配置用户帐户上的单个EC2实例(单元)。如下所示，kube-proxy pods被创建为t3.nano类型的EC2实例</p><p id="a632" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">用户可以通过在pod上设置以下注释来强制公共子网中的单元仅具有私有地址:` pod . elotl . co/private-IP-only:" true " `。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/f50c1b2e6504e437146faba65ed51afe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ubtg5rMwvyFywlsl"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Kip —作为EC2的自动气象站上的Kubernetes控制面板吊舱</figcaption></figure><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/2e5b18829c1147a6d9854a34a12a41ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_lq3h8kpZfM7lPR2"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Kip —作为EC2的自动气象站上的Kubernetes控制面板吊舱</figcaption></figure><p id="6b87" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">virtual-kubelet pod与云提供商创建的所有单元建立出站连接。安装在virtual-kubelet上的kipctl(类似于kubectl)可用于交互和获取部署在单元上的节点和单元的信息。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi na"><img src="../Images/7df5dda836e7cafaf89486867e6838f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dj2kE9fwukB2c7WE"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">kip——虚拟库伯勒</figcaption></figure><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/d8d0894c5ee090ee655089ef42db8897.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JKZjwqFUjHUauN9a"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">kipctl —虚拟库伯勒</figcaption></figure><h1 id="afa3" class="lv lw jf bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">将示例Busybox Pod分解到AWS</h1><p id="fd68" class="pw-post-body-paragraph kc kd jf ke b kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv mx kx ky kz ij bi translated">一个示例busybox pod部署在本地集群上，使用nodeSelector在virtual-kubelet节点上对其进行调度，专门针对virtual-kubelet节点。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nb"><img src="../Images/584d814856dd24b9272204b2f86f834a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9199mH9uxvYfRM15"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">虚拟Kubelet上安排的样本pod</figcaption></figure><p id="ebf2" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">上面的pod在virtual-kubelet节点上调度，如下所示:</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/4eea3fee219c462eb6a7a2610c98e101.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*N8o13WZm4ac6cayD"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">虚拟Kubelet上安排的样本pod</figcaption></figure><p id="7c3a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">virtual-kubelet中的Kip提供者实现开始在AWS上创建单元，以获取已配置的(提供者配置)AMI。因为上面的busybox pod没有配置任何资源请求，所以实例类型被选择为“t3.nano”(默认实例类型)。动态实例类型选择将在下一节讨论。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/ddb84c1509b0bf0d6af680a3e2509d57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7ndaHXC9vU4Z6n70"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">在虚拟kube let-AWS EC2-T3 . nano上安排的样本pod</figcaption></figure><p id="faa1" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如下所示，使用提供者配置中提供的AMI创建了一个类型为“t3.nano”的单元(EC2实例)(这里使用的AMI是一个轻量级的基于Alpine的映像)。Kip自动配置所需的安全组以启用连接。为该单元提供了来自提供商配置中提供的子网的两个IP。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/59baa9702a2f612c3e2aa5a111c2e6d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JanUp8aOBrO4F_Rq"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">虚拟Kubelet上安排的样本pod—AWS EC2</figcaption></figure><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/0726d437b97cab02c37f9c563a6c6c7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*y8tjZcyMS8F5sIzJ"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">在虚拟kube let-AWS安全组上安排的样本pod</figcaption></figure><p id="91b3" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如下所示，Kip无缝地添加了标签:名称空间、名称、节点名称。应用程序标签等。来识别资源。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/3b31a3ffce7461f2df81e062fbefa6cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AubExJ7Y4CM_27LB"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">虚拟kube let-AWS标签上安排的样本pod</figcaption></figure><p id="b952" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">itzo客户机安装在单元上，itzo开始向单元部署所需的包，以启用busybox应用程序。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/ced6894871b075279de80acb69f19615.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*E_tEIU3nx_KD9ePl"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">虚拟Kubelet上安排的样本pod—AWS EC2</figcaption></figure><p id="d913" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">上面的cloud-init配置包括设置用户和SSH-Keys，使用户能够访问创建的单元。</p><p id="5e68" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如下所示，busybox容器作为一个运行在基于瘦alpine的实例(单元)中的进程被分派:</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/3c8a19a46e35c058141cacecb0ad80bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JgKvXWrNqjFxnTwk"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">在虚拟Kubelet上安排的样本pod—AWS EC2上的Pod流程</figcaption></figure><p id="ccd0" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Kip为每个单元分配两个ip地址，除非pod有hostNetwork:一个用于管理通信(在提供者和实例上运行的小代理之间)，另一个用于pod。除非pod启用了主机网络，否则将为具有第二个IP的pod创建一个新的Linux网络命名空间。两个IP地址都来自VPC地址空间。如下所示，实例的eth0接口为“10.10.22.13”，网络命名空间“pod”的veth接口为“10.10.25.96”。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/d752b30edfe352163c9a4d8eb5a68e1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3YYJ-7yGfvYQY7Tt"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">kip —蜂窝网络—云实例ip寻址</figcaption></figure><h1 id="0978" class="lv lw jf bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">基于Kubernetes资源请求的单元动态调整大小</h1><p id="9f65" class="pw-post-body-paragraph kc kd jf ke b kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv mx kx ky kz ij bi translated">除非实例类型注释(pod.elotl.co/instance-type:<c5.large>)出现在pod中，否则kip将选择满足资源需求的最便宜的实例类型。如果在pod的规范中配置了特定的资源(使用Kubernetes资源请求),那么kip会根据资源需求无缝地选择大小合适的实例。如果没有指定注释或资源，那么它将返回到provider.yaml中的defaultInstanceType。</c5.large></p><p id="c0f5" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">实例选择器使用如下所示的各种解析器/参数，试图找到满足资源规范中所有约束的最小成本实例:</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/0e812cf9a5a533eac17fe5ef7937a1c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Zf1LmfEQtaZwFrSL"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">kip —实例选择—属性和模式</figcaption></figure><p id="fc0b" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Kip还可以在按需spot实例上运行单元，同样可以使用注释进行配置:“pod.elotl.co/launch-type: spot”。</p><p id="22f7" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在下面的示例中，名为“busybox-resources”的示例busybox pod配置了内存(15Gi)和cpu (8个vcpu)请求，这创建了一个c5.xlarge单元。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nd"><img src="../Images/e155d89297b43c83bb6d31bdc65365da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9UOhkDOcx6CGIE6l"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">kip—动态实例选择/规模调整</figcaption></figure><p id="bf7a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如下所示，pod配置了资源请求，并使用nodeSelector在virtual-kubelet节点上进行调度:</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ne"><img src="../Images/f9409dd8a72af0edd002db1efeed1365.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dnzjRS7xEin2tvZ-"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">kip —动态实例选择/规模调整—包含资源请求的pod</figcaption></figure><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/e001b56bfa239a3c0d491c8c8d406f5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IAJMJXwu6zTjG1TH"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">虚拟Kubelet上安排的样本pod</figcaption></figure><p id="c169" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如下所示，kip提供程序识别资源需求并生成c5.xlarge单元(云实例),而不选择提供程序配置中指定的默认映像。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/85e5aa795c1aa128a8a6f3967175f30a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kpZ78_qYwUb8YKnu"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">虚拟Kubelet上安排的样本pod实例类型:c5.xlarge</figcaption></figure><p id="a8ae" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在AWS上创建c5.xlarge实例以适应资源请求:</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/cad7a4260af9cb851a7205247f32303c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*U-M7D3Qt3VxZH0AK"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">实例类型:c5.xlarge，用于带有资源请求的示例buybox pod</figcaption></figure><h1 id="b304" class="lv lw jf bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">本地和云之间的VPN连接</h1><p id="e231" class="pw-post-body-paragraph kc kd jf ke b kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv mx kx ky kz ij bi translated">Kip部署在Kubernetes云服务上，如EKS、AKS、GCE等。由于pod和kip-cell共享由云提供商提供的相同网络空间，因此不需要pod之间的任何额外连接层。为了在本地集群上的pod和由kip部署为单元的pod之间实现联网，需要一个到云提供商网络的传统VPN连接(本例中为AWS-VPC)。客户网络(专用/内部网络)到VPC之间的传统站点到站点VPN拓扑包括客户网关和虚拟专用网关。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/e9674acad9473375dd107f84d4df57da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/0*np-EIQ8HLEfYJu9H"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">AWS — VPN网关—拓扑</figcaption></figure><p id="669a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Kip和一个<a class="ae lf" href="https://github.com/elotl/kip/tree/master/deploy/terraform-vpn/aws-vpn-client" rel="noopener ugc nofollow" target="_blank"> VPN客户端</a> (Strongswan)部署在本地Kubernetes集群中。VPN网关部署在AWS上，并与配置用于kip-cell的VPC相关联。一个VPN连接将把本地集群连接到VPC，允许pod和服务在双方之间互相访问。基普被配置为在VPC创建吊舱。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ng"><img src="../Images/9ed785931c271144ca7d9a37062fd7c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wrdET4TtSMT-MM-I"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">kip — aws_vpn_client —内部数据中心和AWS VPC之间的站点到站点vpn</figcaption></figure><p id="f0f6" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">vpn-client pod包括一个运行Strongswan的ipsec容器和一个使用通过configmap提供的配置来配置Strongswan参数的init容器。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nh"><img src="../Images/4babb1578a391f1c7d8e98d5f03df735.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Hqpz-u4Hp60TTpSk"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">kip — aws_vpn_client —作为pod部署在Kubernetes上</figcaption></figure><p id="a51e" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">运行“ipsec-init”和“ipsec”容器的aws-vpn-client pod:</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/2e76686464da82c37c49db7b4d77c511.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GdTQEqv8Xr5SEEXD"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">kip — aws_vpn_client —容器</figcaption></figure><p id="1a5b" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Strongswan配置以配置图的形式提供，其中包括公共隧道端点PSK和CIDR VPC。用户可以使用静态路由或BGP来通告路由。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/64efbd5192c5ccc271abdeca3b60ac63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rdhrJSc5Y_WV7IV5"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">kip — aws_vpn_client —配置</figcaption></figure><p id="b0fc" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">提供商配置中提供的VPC与互联网网关相关联:</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/259099bdc98cb1354fe7e094192efae2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gophOk6FHMgz7xkj"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">AWS-VPC</figcaption></figure><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/4083db0de4944017422edfa27b982685.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*T6nBO9hZHJq_Y73V"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">AWS-IGW</figcaption></figure><p id="f0e3" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">VGW和CGW与上面的VPC相关联，CGW IP是在本地Kubernetes集群的主机网络上运行的vpn客户端pod的公共IP:</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/5d9e88f5b88fe66737a2cfa6a87ca457.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Q_IoaeR6cRnqMGXe"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">虚拟专用网关</figcaption></figure><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/d2a6bd71f9a1ca435fd4fa8f3569d462.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*p2yLQ2moO5wc80V3"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">AWS-客户网关</figcaption></figure><p id="0911" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">VGW和CGW之间创建了VPN连接:</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/91306780fd2d96df6e0a61f63d4e6491.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-2CcXEirAsGnYTTn"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">AWS-VPN连接</figcaption></figure><p id="96f4" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在本地Kubernetes集群上运行的vpn-client pod具有所需的配置，可与VPC建立隧道:</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/fae152ad2d08eb66310beb9a807a3121.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Og5k7L_8xtycFOI_"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">kip — aws_vpn_client —隧道建立</figcaption></figure><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/6298c11100e8b61d3faf133408cee08e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DeH51rqma-nW8Yp7"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">kip — aws_vpn_client —隧道建立</figcaption></figure><p id="e847" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">AWS上的隧道状态:</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/6111b236fd37c3db4eb366d1e6fcd7f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Zbwv9dgUQ49VL-oa"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">AWS — VPN连接—隧道状态</figcaption></figure><p id="9107" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">vpn客户端pod上的隧道状态:</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ni"><img src="../Images/3e0c585a61a185187a7a48b56e5fef47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HbA2wjxMbCVabYCD"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">kip — aws_vpn_client —隧道状态</figcaption></figure><p id="2118" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">隧道建立后，本地集群上的pod CIDR和创建单元的VPC子网将通过VPN连接建立隧道，从而实现基于IPSEC的双向通信。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/a2415b9330f1244e2ce4ed23508e2ad6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JtDo0q0WkcxEXop4"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">基普—通过VPN的VPC Pod子网CIDR路由</figcaption></figure><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/0afdb695fcc8c22460db5b3b40c4b023.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LePJ1VHBMHzB7JEd"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">基普—通过VPN的VPC Pod子网CIDR路由</figcaption></figure><p id="49c9" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在本地集群上创建了一个“busybox-on prem”pod(主集群被污染，以允许创建工作负载)，如下所示:</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nj"><img src="../Images/a092f53b2777003e410b0ce69e41015b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*R4kce10tWjRYaQDT"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">在实际节点上计划的本地Kubernetes集群上的示例pod</figcaption></figure><p id="8833" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在本地集群上运行的法兰绒提供了Pod IP (10.244.0.6):</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/e37a2e1a45c7cdf4cc61767c6d008220.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wK7obKztl_o8O7XN"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">在实际节点上计划的本地Kubernetes集群上的示例pod</figcaption></figure><p id="f9c9" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">VPC子网为在AWS上作为单元(云实例)运行的Pod“busybox-cloudburst”提供了Pod IP (10.10.25.96 ):</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/1047eac55c601efd12514ba5fa86af7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mrmWMLAuCIrLBbeE"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">虚拟Kubelet上安排的样本pod</figcaption></figure><p id="c05e" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如下所示，从运行在AWS上的kip创建的pod可以访问不同子网中具有pod_ip的本地pod:</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/90a8405a711a8ed070c2da569ba1762b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SKfOtpO3DWG53Lc6"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">本地和云之间的Pod-Pod连接(kip创建的单元)</figcaption></figure><p id="bc8f" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi">*******************************************************************</p><p id="05eb" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">除了传统的云爆发，kip在其他场景中也很有用，如<em class="nk">云计算扩展</em>:在多个云提供商之间部署工作负载子集，这些云提供商从一个中央集群运行，无需在各个提供商上部署单独的控制平面，<em class="nk">高可用性/灾难恢复</em>:具有严格SLA的业务关键型应用程序可以在多个云提供商上运行，而不必担心创建成熟的集群或基础架构， <em class="nk">简化应用程序迁移</em>:由于同一应用程序的子集可以在不同的提供商上运行，因此不会有供应商锁定的机会，因为工作负载可以在不同的云提供商上轻松安排，<em class="nk">多租户安全</em>:无节点为每个单元提供单独的计算启动类型。 这导致了pod等之间更强的(虚拟机级别)隔离。</p><p id="c340" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">带有kip的虚拟Kubelet以“容器即服务”的方式运行Kubernetes pods。用户可以根据工作负载和规模要求，利用kip动态创建实例，而不是调配未使用的额外容量。Kip提供了一种智能实例过滤方案，能够选择最具成本效益的实例类型，并且能够准确满足工作负载资源请求—想象一下这样一个场景，我们在一个具有32gb RAM的节点上部署10个需要10gb RAM的pod，其中该节点上的22gb RAM是理想的，会产生每月为理想资源支付的费用。Kip还可以在具有单个控制平面的高级混合云使用案例中加以利用。</p></div></div>    
</body>
</html>