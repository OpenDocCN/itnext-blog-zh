<html>
<head>
<title>Rebel with a CORS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用CORS反叛</h1>
<blockquote>原文：<a href="https://itnext.io/rebel-with-a-cors-1ea5d723d52c?source=collection_archive---------4-----------------------#2018-02-14">https://itnext.io/rebel-with-a-cors-1ea5d723d52c?source=collection_archive---------4-----------------------#2018-02-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0b22" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何从一个禁用了CORS的API中创建自己的简单的支持CORS的API</h2></div><p id="00e7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" href="https://www.linkedin.com/cws/share?url=https%3A%2F%2Fitnext.io%2Frebel-with-a-cors-1ea5d723d52c" rel="noopener ugc nofollow" target="_blank"> <em class="lc">点击这里在LinkedIn上分享这篇文章</em> </a></p><p id="97c3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">作为一名前端开发人员，我在开发时经常使用各种第三方API。这些API可以用于天气、加密货币价格或最新的XKCD漫画。</p><p id="5b07" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">其中一些服务的问题是它们不支持跨来源请求(CORS)，这意味着客户端AJAX调用这些服务不起作用。这是令人沮丧的，但可以很容易地在你自己的微服务中的几行代码的帮助下修复。</p><h1 id="2883" class="ld le iq bd lf lg lh li lj lk ll lm ln jw lo jx lp jz lq ka lr kc ls kd lt lu bi translated">创建微服务</h1><p id="bded" class="pw-post-body-paragraph kf kg iq kh b ki lv jr kk kl lw ju kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">创建一个简单的微服务只需要一个名为<a class="ae lb" href="https://github.com/zeit/micro" rel="noopener ugc nofollow" target="_blank"> <em class="lc"> micro </em> </a>的包。这是一个非常简单的包，支持创建异步微服务，如果您阅读了该项目的自述文件，您会发现只需几行代码就可以创建一个简单的服务:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="3160" class="mj le iq mf b gy mk ml l mm mn">module.exports = (req, res) =&gt; {<br/>  res.end(‘Hello world’)<br/>}</span></pre><p id="79fe" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">显然上面的完全没用，但是让我展示一下使用micro消费几乎任何API是多么容易，至少是任何不需要认证的API。</p><figure class="ma mb mc md gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mo"><img src="../Images/ee830aa699e19a3e8362128d33da6950.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TdoKOtUpXC7uhBftqvMNRA.png"/></div></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">来自<a class="ae lb" href="https://xkcd.com/1810/" rel="noopener ugc nofollow" target="_blank">漫画#1810 </a></figcaption></figure><p id="3e40" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于这个例子，我将使用来自<a class="ae lb" href="https://xkcd.com/" rel="noopener ugc nofollow" target="_blank"> XKCD漫画</a>的免费API，它不能用于客户端的AJAX调用，因为CORS被禁用了。调用网址<a class="ae lb" href="https://xkcd.com/info.0.json" rel="noopener ugc nofollow" target="_blank">https://xkcd.com/info.0.json</a>返回最新漫画，像这样:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="2410" class="mj le iq mf b gy mk ml l mm mn">{<br/>  "month": "2",<br/>  "num": 1954,<br/>  "link": "",<br/>  "year": "2018",<br/>  "news": "",<br/>  "safe_title": "Impostor Syndrome",<br/>  "transcript": "",<br/>  "alt": "It's actually worst in people who study the DunningâKruger effect. We tried to organize a conference on it, but the only people who would agree to give the keynote were random undergrads.",<br/>  "img": "https://imgs.xkcd.com/comics/impostor_syndrome.png",<br/>  "title": "Impostor Syndrome",<br/>  "day": "12"<br/>}</span></pre><p id="47eb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果通过了正确的漫画ID(<a class="ae lb" href="https://xkcd.com/1500/info.0.json" rel="noopener ugc nofollow" target="_blank">https://xkcd.com/1500/info.0.json</a>)，它可以返回一个特定的漫画:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="27e5" class="mj le iq mf b gy mk ml l mm mn">{<br/>  "month": "3",<br/>  "num": 1500,<br/>  "link": "",<br/>  "year": "2015",<br/>  "news": "",<br/>  "safe_title": "Upside-Down Map",<br/>  "transcript": "((A mercator projection of the world map is shown. All the continents have been rotated one hundred eighty degrees.))\n\n((Cuba  is next to alaska, and alaska is touching the tip of south america, which is all near the equator. Mexico is now friends with greenland.\n\n((Iceland, the UK, and asia are all close together. Japan and Taiwan haven't moved with the asian continent, and are technically European.))\n\n((Siberia is now equatorial. Africa is pretty temperate, except for the north bits which are somewhat antarctic.))\n\nCaption: This upside-down map will change your perspective on the world!\n\n{{Title text: Due to their proximity across the channel, there's long been tension between North Korea and the United Kingdom of Great Britain and Southern Ireland.}}",<br/>  "alt": "Due to their proximity across the channel, there's long been tension between North Korea and the United Kingdom of Great Britain and Southern Ireland.",<br/>  "img": "https://imgs.xkcd.com/comics/upside_down_map.png",<br/>  "title": "Upside-Down Map",<br/>  "day": "18"<br/>}</span></pre><p id="4a8d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">微服务需要做的只是将任何请求传递给原始API，并设置一些头以允许跨源请求，这样它们就可以在客户端的AJAX调用中使用，如下所示:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="35ce" class="mj le iq mf b gy mk ml l mm mn">const axios = require('axios')<br/>const { send } = require('micro')<br/>const microCors = require('micro-cors')<br/>const cors = microCors({ allowMethods: ['GET'] })<br/>const DOMAIN = '<a class="ae lb" href="https://xkcd.com/'" rel="noopener ugc nofollow" target="_blank">https://xkcd.com/'</a></span><span id="11d9" class="mj le iq mf b gy na ml l mm mn">const handler = async function(req, res) {<br/>  const params = req.url<br/>  const path = `${DOMAIN}${params}`<br/>  const response = await axios(path)<br/>  send(res, 200, response.data)<br/>}</span><span id="5957" class="mj le iq mf b gy na ml l mm mn">module.exports = cors(handler)</span></pre><p id="47c5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那是14行代码！</p><p id="68e3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">上面的例子将任何slug信息传递给API(例如<code class="fe nb nc nd mf b">1000/0.json</code>)，因此调用<code class="fe nb nc nd mf b">https://xkcd.now.sh/1000/0.json</code>(我的API版本)，将映射到<code class="fe nb nc nd mf b">https://xkcd.com/1000/0.json</code>。这可能是我们旅程的终点，但我想通过改变端点来改进API UX:</p><ul class=""><li id="3d95" class="ne nf iq kh b ki kj kl km ko ng ks nh kw ni la nj nk nl nm bi translated">xkcd.now.sh 应该还最新漫画</li><li id="31c8" class="ne nf iq kh b ki nn kl no ko np ks nq kw nr la nj nk nl nm bi translated">【xkcd.now.sh/1000】应回漫画ID 1000</li></ul><p id="3791" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请参见下文，了解如何实现这一目标:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="d1a6" class="mj le iq mf b gy mk ml l mm mn">const axios = require('axios')<br/>const { send } = require('micro')<br/>const microCors = require('micro-cors')<br/>const cors = microCors({ allowMethods: ['GET'] })<br/>const DOMAIN = 'https://xkcd.com/'<br/>const PATH = 'info.0.json'</span><span id="c74d" class="mj le iq mf b gy na ml l mm mn">const handler = async function(<em class="lc">req</em>, <em class="lc">res</em>) {<br/>  let id = req.url.replace('/', '')<br/>  const comicId = id ? `${id}/` : ''<br/>  const path = `${DOMAIN}${comicId}${PATH}`<br/>  const response = await axios(path)<br/>  id = response.data.num<br/>  let newResponse<br/>  if (id &gt;= 1084) {<br/>    newResponse = {<br/>        ...response.data,<br/>        imgRetina: `${response.data.img.replace('.png', '')}_2x.png`,<br/>      }<br/>    } else {<br/>      newResponse = {<br/>      ...response.data,<br/>    }<br/>  }<br/>  send(res, 200, newResponse)<br/>}</span><span id="0a28" class="mj le iq mf b gy na ml l mm mn"><em class="lc">module.exports</em> = cors(handler)</span></pre><p id="bee1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那是29行代码！看到了吗<a class="ae lb" href="https://github.com/mrmartineau/xkcd-api/blob/master/index.js" rel="noopener ugc nofollow" target="_blank">这里</a>👀</p><p id="858a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你可以在上面看到，除了<em class="lc"> micro </em>，该服务还依赖另外两个包:</p><ul class=""><li id="ac39" class="ne nf iq kh b ki kj kl km ko ng ks nh kw ni la nj nk nl nm bi translated"><a class="ae lb" href="https://github.com/axios/axios" rel="noopener ugc nofollow" target="_blank"> <em class="lc"> axios </em> </a>为HTTP请求</li><li id="3367" class="ne nf iq kh b ki nn kl no ko np ks nq kw nr la nj nk nl nm bi translated"><a class="ae lb" href="https://github.com/possibilities/micro-cors" rel="noopener ugc nofollow" target="_blank"> <em class="lc">微cors </em> </a>是对微的简单cors</li></ul><p id="8fdf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我的XKCD API示例返回所有原始数据，实际上稍微改变了响应数据以及API的使用方式。我决定添加retina图像路径(如果有)并简化对API的调用。所以你可以调用<code class="fe nb nc nd mf b">xkcd.now.sh/1894</code>而不是调用<code class="fe nb nc nd mf b">xkcd.com/1894/info.0.json</code>。</p><p id="2069" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，举例来说:调用<a class="ae lb" href="https://xkcd.now.sh/1894" rel="noopener ugc nofollow" target="_blank">https://xkcd.now.sh/1894</a>将从最初的XKCD API:<a class="ae lb" href="https://xkcd.com/1894/info.0.json" rel="noopener ugc nofollow" target="_blank">https://xkcd.com/1894/info.0.json</a>请求这个URL。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="60a2" class="mj le iq mf b gy mk ml l mm mn">{<br/>  "month": "9",<br/>  "num": 1894,<br/>  "link": "",<br/>  "year": "2017",<br/>  "news": "",<br/>  "safe_title": "Real Estate",<br/>  "transcript": "",<br/>  "alt": "I tried converting the prices into pizzas, to put it in more familiar terms, and it just became a hard-to-think-about number of pizzas.",<br/>  "img": "https://imgs.xkcd.com/comics/real_estate.png",<br/>  "title": "Real Estate",<br/>  "day": "25",<br/>  "imgRetina": "https://imgs.xkcd.com/comics/real_estate_2x.png"<br/>}</span></pre><p id="e671" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">💪这项服务的代码托管在https://github.com/mrmartineau/xkcd-api的GitHub上，可以在T21使用Postman进行测试。</p><h1 id="fb35" class="ld le iq bd lf lg lh li lj lk ll lm ln jw lo jx lp jz lq ka lr kc ls kd lt lu bi translated">托管您的新API</h1><p id="4220" class="pw-post-body-paragraph kf kg iq kh b ki lv jr kk kl lw ju kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">我现在使用<a class="ae lb" href="https://zeit.co/now" rel="noopener ugc nofollow" target="_blank"><em class="lc"/></a>by<a class="ae lb" href="https://zeit.co" rel="noopener ugc nofollow" target="_blank"><em class="lc">zeit</em></a>来托管我的各种app和API。<em class="lc">现在</em>支持这个微服务需要的JavaScript语言特性(async/await)以及开箱即用的HTTPS。如果你的主机不支持这些特性，你需要将代码转换回它支持的版本。</p><figure class="ma mb mc md gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi ns"><img src="../Images/84a9f4d88fe7efbfd6678b5d284b1524.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RHbmuBKmpjh1JBwV1-gmtQ.png"/></div></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">来自<a class="ae lb" href="https://xkcd.com/1700/" rel="noopener ugc nofollow" target="_blank">漫画#1700 </a></figcaption></figure><h1 id="127e" class="ld le iq bd lf lg lh li lj lk ll lm ln jw lo jx lp jz lq ka lr kc ls kd lt lu bi translated">其他示例</h1><p id="6aeb" class="pw-post-body-paragraph kf kg iq kh b ki lv jr kk kl lw ju kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">作为一个更简单的传递API的例子，您可以看到我的CORS版本的插接板feeds API。代码托管在https://github.com/mrmartineau/pinboard-api<a class="ae lb" href="https://github.com/mrmartineau/pinboard-api" rel="noopener ugc nofollow" target="_blank">的GitHub上</a></p></div><div class="ab cl nt nu hu nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="ij ik il im in"><p id="8b61" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我感谢<a class="oa ob ep" href="https://medium.com/u/bc0058830195?source=post_page-----1ea5d723d52c--------------------------------" rel="noopener" target="_blank">安德鲁·威廉姆斯</a>、<a class="oa ob ep" href="https://medium.com/u/f2a3cc045295?source=post_page-----1ea5d723d52c--------------------------------" rel="noopener" target="_blank">阿什利·诺兰</a> &amp; <a class="oa ob ep" href="https://medium.com/u/a6cf81c6fa33?source=post_page-----1ea5d723d52c--------------------------------" rel="noopener" target="_blank">恰兰·帕克</a>对这篇文章标题的帮助。他们的其他建议包括:</p><ul class=""><li id="4874" class="ne nf iq kh b ki kj kl km ko ng ks nh kw ni la nj nk nl nm bi translated">不用担心CORS:获取API</li><li id="a3ff" class="ne nf iq kh b ki nn kl no ko np ks nq kw nr la nj nk nl nm bi translated">CORS，你值得拥有</li><li id="169d" class="ne nf iq kh b ki nn kl no ko np ks nq kw nr la nj nk nl nm bi translated">上帝保佑</li><li id="01c1" class="ne nf iq kh b ki nn kl no ko np ks nq kw nr la nj nk nl nm bi translated">CORS，呃，这有什么好处</li><li id="25d8" class="ne nf iq kh b ki nn kl no ko np ks nq kw nr la nj nk nl nm bi translated">只有CORS</li></ul><p id="4f63" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi">🤦‍♂️</p></div></div>    
</body>
</html>