# Angular ft 中动态 UI 听页面滚动的 4 种方法。RXJS

> 原文：<https://itnext.io/4-ways-to-listen-to-page-scrolling-for-dynamic-ui-in-angular-ft-rxjs-5a83f91ee487?source=collection_archive---------0----------------------->

## 一个解释，演示了 4 种监听窗口滚动事件的方法，以实现无限滚动、滚动动画或动态模块加载等功能

![](img/ea7577691e6d27b44186453d6e8a8874.png)

一些活力

# 动态用户界面和流畅的用户体验

创建动态的、反应灵敏的、智能的 web 应用程序需要变得**反应灵敏**。但是对用户事件的反应，比如滚动，可以改善应用程序的 T4，而不仅仅是外观。

例如，使用窗口滚动，您可以根据需要动态呈现组件或延迟加载代码块。这远远超出了应用程序的美学范畴。通过**节省主包大小的能力，它可以**改善页面加载时间**；**这是在页面加载时立即加载的代码块。

> Angular 编译器提供了分割代码块的能力，通过使用 es6 动态**导入**将该代码从包的其余部分中分离出来。

## 窗口滚动用在哪里？

想想您每天使用的现代 web 应用程序。你认为这些网站拥有**高质量的用户界面和用户体验**。

你会发现它们中的大多数要么在 scroll 上有 [**动画，以无限滚动为特色来帮助他们的搜索功能，要么会在你需要的时候动态加载资源。你会注意到隐藏在视图之外的内容，**显示动画或过渡，**滑入或淡出视图。**](https://github.com/michalsnik/aos)

> Angular 使用**内置的主机装饰器**使得监听用户事件更加容易，比如滚动。另外，RXJS 提供了使用 observables 来更新和存储我们从听众那里收集的计算结果的**能力。**

## 用例

**动态用户界面** —也许你有一个**博客，你想在一篇文章的顶部显示一个进度条**来指示**这篇文章已经被阅读了多少**(或者更准确地说，是被滚动了)。

**性能** —您可能有一个对性能产生负面影响的**大模块。**您可能已经注意到页面加载时间的增加，并且您想要按需加载该模块。您可以使用窗口滚动来预测用户何时需要访问该模块中提供的功能。

如果你知道多种方法来监听窗口滚动事件和**跟踪沿 X 或 Y 轴(水平或垂直)的滚动位置**，那么实现这些例子将会简单 10 倍。

**在本文中，我们将关注 Y 轴**(垂直方向)。

> 值得注意的是，使用窗口并不是实现这种功能的唯一方式。还有 [IntersectionObserver](https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API) 和 [MutationObserver](https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver) ，这取决于你是想只在到达一个**交叉点**(页面上的位置)时才知道**，还是你**不想**听滚动，而是你想听 DOM 的变化( **Mutation** )。**

## 基于窗口滚动的一些想法

*   **动画**/转场
*   UI 组件— **滚动百分比/阅读进度，**相对于全部可用内容。
*   **无限滚动**——到达视口末端时渲染/加载更多数据。
*   **异步模块加载**与**导入**。

# 为什么我需要不止一种方法来滚动窗口？

## 简短的回答

浏览器兼容性/差异和您的 CSS 的组合

## 冗长的回答

根据浏览器的不同，**默认可滚动元素引用 DOM 中不同的元素**。您的 CSS 可能会导致默认的可滚动元素被覆盖或冗余，这意味着您不能再滚动它，或者有一个 z 索引更高的新滚动容器。

因此，您必须**确保您将监听器连接到适当的元素**(正在滚动的那个)。不注意这些复杂性将导致您的滚动功能中断**、**，导致无法正确确定哪个元素正在触发滚动事件。

# 影响默认滚动行为的方法

在我们实现我们的窗口滚动功能之前，我们需要知道**你可以有意地，有时是无意地，影响你需要听的元素的方式。**

这包括详细说明实际的浏览器差异，以确保 CSS 和 JavaScript/TypeScript 代码的组合在不同的浏览器之间是兼容的。这些细节将通知我们的窗口滚动决策。

我们将关注 3 种最常见的浏览器: **Chrome、Safari 和 Firefox** 。

## 铬

*   默认的滚动元素指的是`<html>`元素。

## 旅行队

*   默认的滚动元素指的是`<body>`元素。

## 火狐浏览器

*   `<html>`元素(和 Chrome 一样)

了解这些可以在调试与滚动事件相关的问题时提供一些见解。例如，它可以指出您可以在一个浏览器中正确侦听滚动事件，但在另一个浏览器中却不能的原因。

原因可能是应用于默认滚动元素`<html>`或`<body>`的 **CSS，或者您通过在子元素上使用`overflow-y: scroll`、`position: absolute`或`position: relative`(仅举几个例子)覆盖了默认滚动容器。**

> 所以本质上，确保你没有任何阻止垂直滚动的样式(CSS)，比如那些应用于`<html>`或`<body>`元素的样式

## 在现代浏览器中获得正确的滚动元素

如上所述，返回的元素将指向相对于浏览器的默认可滚动元素。

函数来获取正确的默认滚动元素

# 使用角度服务单例

我们将通过创建和使用角度服务来实现我们的窗口滚动功能。这个服务将是一个**单例**，意味着应用程序范围的，让它**干**(不要重复自己)。我们将使用 [RXJS](https://www.learnrxjs.io/) 来创建一个[行为主体](https://www.learnrxjs.io/learn-rxjs/subjects/behaviorsubject)和一个可观察对象，该可观察对象将**发出包含更新后的 Y 轴滚动位置**的值，我们可以对这些值做出异步反应。

# 获得沿 Y 轴的精确滚动位置

创建精确的动画和动态用户体验**需要获得正确的测量值**。我们将关注的度量是用户从页面顶部开始滚动的**距离，**被称为`scrollY`或`scrollTop`位置，这是沿着 Y 轴的度量。

例如，**如果 scrollY 为 0，则表明用户在文件夹上方，在页面顶部**。这可能意味着用户已经滚动到那里，或者他们刚刚导航到该页面，还没有开始滚动。

> 如果您的动画或过渡是基于可用内容的滚动百分比，那么获得精确的度量就特别重要。

> 例如:如果你想显示用户在一篇文章上滚动了多远。

## 获取当前沿 Y 轴的滚动位置

使用随着滚动事件触发而发出的`[Event](https://developer.mozilla.org/en-US/docs/Web/API/Event/target)`对象，我们可以获得滚动位置来更新 scrollY 值。**我们将在每次触发滚动事件时使用这个函数。**

如您所见，我们访问`.target`属性来查询`[scrollTop](https://developer.mozilla.org/en-US/docs/Web/API/Element/scrollTop)`值。

获取当前滚动 Y 轴位置

# 方法 1:使用渲染 2

**Renderer2** ，Renderer 的继任者是 Angular 标准库的一部分，可通过依赖注入注入到组件中。它提供了与 DOM 交互和更新 DOM 的 API。**这是**与 DOM **交互的首选方式，也是 SSR(服务器端渲染)兼容的**。

使用 **Renderer2** 是监听窗口事件的简单方法。只需给它传递一个`string`(‘window’)作为第一个参数。然后你可以通过**回调函数**来更新 Y 位置，这个函数会在用户滚动时被调用。然后你会想要调用我们的`getYPosition()`函数来获得正确的`scrollY`值。

> **稍后，我们将使用计算出的`scrollY`值更新我们(将要创建的)`*WindowScrollService*`中的行为主题**，但是现在，我们将**登录到控制台**来检查我们的代码是否按预期工作。

渲染 2 窗口滚动

然而，使用这种方法，您会希望**将监听函数的返回值**存储在组件范围的变量`listener`中。这确保了**当不再需要事件监听器时，通过最终销毁事件监听器来防止内存泄漏。你可以通过调用上面`ngOnDestroy()`生命周期钩子中`this.listener();`的 listen 函数的结果来做到这一点。**

# 方法 2:主机监听器

在我们所有的方法中，这可以说是最' **Angular 的方式**来监听滚动事件，也就是说这是一个**独享**给 Angular 的方法。除了监听 host 元素， **HostListener** 可以监听`**window**` **。**

所以这里我们可以将`window:scroll`传递给`HostListener`函数装饰器，然后以通常的方式调用`getYPosition`函数来更新`scrollY`值。

主机监听器窗口滚动

## 使用 HostListener 的替代方法

> 如果您的默认滚动元素上有 CSS 阻止您使用该窗口

**找到替代的可滚动元素并监听滚动事件**

与上面的方法几乎相同，只是**用字符串`scroll`替换**host listener decorator 参数中的`window:scroll`标记。

这是使用 HostListener 的**更常见的**方法，尽管如果您必须使用此方法来实现任何类型的窗口滚动功能，那么这将表明您已经编写了一些难以调试的**CSS，并且可能已经花了整整 30 分钟**来尝试找到您正在滚动的正确元素。****

HostListener 根元素滚动

# 方法 3:使用 RXJS

**在角度应用中，使用 RXJS 进行异步操作应该是一个熟悉的过程**。使用 observables if 我最喜欢的方式，因为与`OnPush`变更检测策略结合使用会带来性能优势。当在整个应用程序中转换和使用 observable 时，我们可以确保通过 observable 进行的**更改总是通过异步管道**反映在 DOM 中，一直到 Angular 模板。

我们将使用从`rxjs`导入的可观察值`fromEvent`。我们路过`window`。从这里，你可以通过`subscribe`回调来更新滚动的 Y 位置，或者你可以存储可观察值来转换并最终在模板中使用，但是**因为我们试图保持干燥，我们选择使用 subscribe 函数。**

和往常一样，**记住退订可观察订阅**很重要。所以当组件被破坏时，一定要打电话给`unsubscribe`。

RXJS 窗口滚动

当包含组件被销毁时，我最喜欢的销毁可观察对象的方法是通过一个在 `**NgOnDestroy**` **生命周期钩子**中发出一个值的主题**。所以要破坏可观测的，我们就叫`next()`。**

# 方法 4:监听 HTML 元素滚动事件

## 监听 HTML 事件

也许**监听滚动事件最简单的方法**:绑定到实际的 HTML 元素。更简单的是，**你可以使用`window:scroll`事件发射器从 DOM** 中的任何 HTML 元素开始滚动窗口。使用这种方法，您只需**传递一个函数**在滚动事件触发时调用，就像您使用任何其他事件监听器(如`mouseenter`或`click`)一样。**简单！**

HTML 事件侦听器

# 创建窗口滚动服务

**角度服务单件鼓励代码重用**并确保你不重复自己(DRY)，这在涉及到事件监听器和频繁更新 DOM 时尤为重要。

**这些都是 CPU 密集型任务**，应该仔细监控以防止出现性能瓶颈。这主要是由于浏览器不得不花费大量精力来重画和检测变化，这最终会影响最终用户的体验。

**因此，我们将通过一个服务** `WindowScrollService` **专门处理窗口滚动。**

## 让我们创建服务

对于那些使用 angular CLI 的人(我想是大多数)，你需要…

```
$ ng g s services/window-scroll
```

这将在`/services`目录中生成`WindowScrollService`。

## 设置服务

首先，我们创建一个`**BehaviourSubject**`来存储**滚动**位置。此外，我们从`scrollY` BehaviorSubject 创建一个可观察对象，以监听变化。**可观察的** `**scroll$**` **将是在整个应用**中被监听的值，无论在哪里需要读取`scrollY`位置。

## 使用窗口滚动服务

更新行为主体`scrollY`就像**用** `**scrollY**` **值作为参数**调用 `**.next()**` **一样简单。这取代了之前用于演示目的的`console.log`。然后，我们可以尽可能多地使用`scrollY$` observable，而不需要附加任何更多的窗口滚动监听器。**

正在更新 WindowScrollService 中的 BehaviourSubject

我选择了 **HostListener(方法 2)** 来演示我们的`WindowScrollService`的用法，没有任何真正的原因，除了它是**最不冗长的**。

## 有用:获得最大滚动高度

这对于依赖于**已滚动内容的计算百分比**的功能非常有用。例如上面提到的那些。这里，我们需要从这些值中取最大值，以获得可滚动高度的最精确值。

## 倾听 scrollY 更新并对其做出反应

对滚动位置更新的反应就像**监听** `**scrollY$**` **可观察到的**并根据发出的值执行代码一样简单。例如，计算滚动内容的百分比，这将是..

```
scrollY - scrollHeight / 100
```

你可能想用…来取整这个值

```
Math.round(scrollY - scrollHeight / 100)
```

## 就是这样，你永远不应该被听窗口滚动的方法所束缚！

> 有任何问题，请在评论中告诉我！

# 使用窗口滚动的项目

[](https://www.npmjs.com/package/window-scroll-manager) [## 窗口滚动管理器

### 一个小的库，广播更多高性能的窗口滚动事件。听 window onscroll 事件非常…

www.npmjs.com](https://www.npmjs.com/package/window-scroll-manager)  [## 无限卷轴

### 参见 infinite-scroll.com 的完整文档和演示。直接链接到 unpkg 上的无限滚动文件。npm: npm 安装…

www.npmjs.com](https://www.npmjs.com/package/infinite-scroll) [](https://www.npmjs.com/package/ng-scroll-progress) [## ng-滚动-进度

### 角度进度条的页面数量滚动 bower bower 安装-保存 ng-滚动-进度 npm 安装 npm 安装…

www.npmjs.com](https://www.npmjs.com/package/ng-scroll-progress)