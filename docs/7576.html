<html>
<head>
<title>Kubernetes OWASP Top 10: Secrets Management</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes OWASP十大:秘密管理</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-owasp-top-10-secrets-management-c996faa87b47?source=collection_archive---------1-----------------------#2022-11-12">https://itnext.io/kubernetes-owasp-top-10-secrets-management-c996faa87b47?source=collection_archive---------1-----------------------#2022-11-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c2b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我的<a class="ae kl" href="https://owasp.org/www-project-kubernetes-top-ten/" rel="noopener ugc nofollow" target="_blank"> Kubernetes OWASP前10名</a>摘要的最新条目中，我将重点介绍秘密管理。可以说，秘密管理，不仅在Kubernetes的环境中，而且在整个行业中，都是正确处理安全问题的最重要的方面之一。无论是用于证明身份的API密钥，还是用于确保传输中或静态加密的证书和密钥，如果管理不当，机密都会对任何给定服务的整体机密性、完整性和可用性造成灾难性后果。</p><p id="19c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我深入Kubernetes中秘密的技术细节之前，有一些秘密管理的基础知识应该有助于将秘密泄露的风险保持在尽可能低的水平。</p><ul class=""><li id="428b" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">机密应该允许对相关系统进行足够的访问。这确保了不会出现一个秘密暴露整个庄园的“王国之钥”场景。</li><li id="4704" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">秘密的范围应该是有限的。</li><li id="d64f" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">RBAC对秘密商店的严格控制。</li><li id="e649" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">职责分离，例如，管理密钥存储控制平面的人不应该使用同一组凭证来访问数据平面(即秘密本身)</li><li id="a35c" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">PKI(<strong class="jp ir">Private</strong>Key infra structure)应该就是那个，Private。限制私钥的任何移动和共享。</li></ul><h2 id="c2f8" class="la lb iq bd lc ld le dn lf lg lh dp li jy lj lk ll kc lm ln lo kg lp lq lr ls bi translated">库伯内特的秘密</h2><p id="548b" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy lv ka kb kc lw ke kf kg lx ki kj kk ij bi translated">Kubernetes有一个本地秘密类型，这允许识别和分离应该是秘密的配置。它只是一种类型，为了便于识别而被分开，并且要求存储在其中的数据是base64编码的。注意它们是经过编码的<strong class="jp ir">而不是</strong>加密的。</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi ly"><img src="../Images/7d86cea5d4fb98dfe636c1ecef64377a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qAqfdKzj47IV4ZQrBr5fDg.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">查看etcd Kubernetes数据存储，默认情况下，这些是不加密的。</figcaption></figure><p id="3cba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kubernetes需要配置为加密所有秘密。这可以通过使用一个<em class="mo">encryption configuration</em>Kubernetes对象来实现，API可以在与etcd数据存储通信时使用该对象。</p><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="mp mq l"/></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">Kubernetes加密配置示例</figcaption></figure><p id="70cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kubernetes支持多个加密提供商，其强度和速度因需求而异。</p><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="mp mq l"/></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">加密提供商</figcaption></figure><ul class=""><li id="c371" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">身份—默认提供者，不加密静态对象，但仅限于允许的用户(即非匿名、公共访问)</li><li id="e4fd" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">secretbox —利用XSalsa20和Poly1305的新型加密标准</li><li id="8d2d" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">AES GCM—AES-GCM—建议每20万次写入进行一次密钥轮换</li><li id="48eb" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">aescbc — AES-CBC —由于已知的缺点，不再推荐使用。</li><li id="a872" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">KMS——外部密钥管理服务，具有利用HSM能力的额外好处。<br/>—<a class="ae kl" href="https://learn.microsoft.com/en-us/azure/aks/use-kms-etcd-encryption" rel="noopener ugc nofollow" target="_blank">Azure key vault</a><br/>—<a class="ae kl" href="https://docs.aws.amazon.com/eks/latest/userguide/enable-kms.html" rel="noopener ugc nofollow" target="_blank">AWS KMS</a><br/>—<a class="ae kl" href="https://cloud.google.com/kubernetes-engine/docs/how-to/encrypting-secrets#existing-cluster" rel="noopener ugc nofollow" target="_blank">GCP云KMS </a></li></ul><p id="4902" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦创建了加密配置，就需要配置Kubernetes API服务器来使用它。</p><ul class=""><li id="fc02" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">向API服务器添加encryption-provider-config开关。</li><li id="3daa" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">创建一个包含加密配置清单的卷</li><li id="9632" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">在API pod中挂载卷，确保它以只读方式挂载在为传递给API的encryption-provider-config开关提供的路径中。</li><li id="e241" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">重新启动API服务器。</li></ul><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="781a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">重要提示:现有机密不会被加密，只有添加配置后的新机密才会被加密。为了能够在加密之前加密机密，必须删除并重新创建它们。</strong></p></div><div class="ab cl mr ms hu mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="ij ik il im in"><h1 id="242e" class="my lb iq bd lc mz na nb lf nc nd ne li nf ng nh ll ni nj nk lo nl nm nn lr no bi translated">管理Kubernetes的秘密</h1><p id="c5b6" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy lv ka kb kc lw ke kf kg lx ki kj kk ij bi translated">有几种方法可以让秘密进入Kubernetes，最少的人类互动的方法是首选，减少社会工程或泄漏的风险。</p><ul class=""><li id="7e01" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">通过CLI输入密码。</li><li id="bf21" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">使用CI/CD管道。</li><li id="6436" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">Kubernetes Secrets Store容器存储接口(CSI)</li></ul><h2 id="802e" class="la lb iq bd lc ld le dn lf lg lh dp li jy lj lk ll kc lm ln lo kg lp lq lr ls bi translated">手动秘密创建</h2><p id="e1d7" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy lv ka kb kc lw ke kf kg lx ki kj kk ij bi translated">通常通过kubectl CLI接口使用Kubernetes REST API是获取Kubernetes秘密的常见方式。</p><p id="2741" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用kubectl可以创建3种类型的秘密</p><ul class=""><li id="9f54" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">通用/不透明—标准密钥/值成对机密</li><li id="1f72" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">docker-registry —提取容器图像的凭证</li><li id="12cc" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">TLS —证书和相关密钥</li></ul><p id="dd9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除了使用kubectl的不同类型的秘密之外，还有不同的方法来获取API服务器的秘密。</p><p id="c240" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> kubectl创建秘密类属</strong></p><ul class=""><li id="cfce" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">— from-literal:逐字键入密钥</li></ul><pre class="lz ma mb mc gt np nq nr bn ns nt bi"><span id="ffe2" class="nu lb iq nq b be nv nw l nx ny">kubectl create secret generic secretname --from-literal=password=password1 --from-literal=username=user1</span></pre><ul class=""><li id="9d56" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">— from-file(或— from-env-file):使用一个存储文件，其中的凭据以明文形式存储</li></ul><pre class="lz ma mb mc gt np nq nr bn ns nt bi"><span id="a44b" class="nu lb iq nq b be nv nw l nx ny">kubectl create secret generic secretname --from-file=password=./password.txt --from-file=username=./user.txt</span></pre><p id="827c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">使用清单</strong></p><ul class=""><li id="732b" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">在yaml或json清单中创建一个Kubernetes秘密对象</li><li id="3325" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">用base64编码秘密</li></ul><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="mp mq l"/></div></figure><ul class=""><li id="b78c" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">将清单应用到API服务器</li></ul><pre class="lz ma mb mc gt np nq nr bn ns nt bi"><span id="1076" class="nu lb iq nq b be nv nw l nx ny">kubectl apply -f ./secret.yaml</span></pre><p id="1174" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，所有手动创建的机密是如何向创建或更新机密的操作员/开发人员公开的。这增加了一个风险，即每个开发人员都可以访问这个秘密以便能够使用它。更好的方法是安全地存储秘密，并自动创建秘密。</p><h2 id="017e" class="la lb iq bd lc ld le dn lf lg lh dp li jy lj lk ll kc lm ln lo kg lp lq lr ls bi translated">CI/CD管道中的秘密</h2><p id="682c" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy lv ka kb kc lw ke kf kg lx ki kj kk ij bi translated">自动化是帮助确保秘密保密的关键。手动交互引入了不必要地知道秘密的风险。</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi nz"><img src="../Images/a969471b80cb0a2789b51dbde004a9ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BmTxt65CLU9bcWXGR6KMdw.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">CI/CD管道流程示例</figcaption></figure><p id="e948" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过使用自动化过程，允许秘密保护的附加方法</p><ul class=""><li id="d4d8" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">开发者不必要求获得生产系统的秘密。在秘密创建/管理和开发者之间分离角色。</li><li id="ae10" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">可以将对秘密存储的访问限制为管道帐户。</li><li id="c9e7" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">减少签入源代码库的秘密的发生率。</li></ul><p id="be7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用自动化管道时的注意事项。</p><ul class=""><li id="9b23" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">确保秘密不被记录在日志中，大多数管道软件能够标记秘密以在日志中排除或屏蔽。</li><li id="f817" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">确保在生成代理上清除缓存，并且在运行后无法检索缓存。</li></ul><h2 id="3acb" class="la lb iq bd lc ld le dn lf lg lh dp li jy lj lk ll kc lm ln lo kg lp lq lr ls bi translated">Kubernetes Secrets Store容器存储接口(CSI)</h2><p id="65f6" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy lv ka kb kc lw ke kf kg lx ki kj kk ij bi translated">Secrets Store CSI是Kubernetes API的一个扩展，它将第三方secret store/vault直接连接到需要秘密并作为存储安装的pod。</p><p id="7d57" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种方法允许需要访问机密的工作负载直接访问机密。这样做的好处是，Kubernetes的秘密将只在使用时生成，因此只在需要它的工作负载期间存在。</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi oa"><img src="../Images/e4a20bc3e574a1ce09454d0f28be5711.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DMnYDwNY5obd1HsP7xYIUA.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">秘密存储CSI直接连接到保险库，为pod提供秘密</figcaption></figure><p id="9ce4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">支持的机密存储</p><ul class=""><li id="5951" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">自动警报系统</li><li id="ca2a" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">蔚蓝的</li><li id="ddff" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">GCP</li><li id="3990" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">哈希公司金库</li></ul><h1 id="1f69" class="my lb iq bd lc mz ob nb lf nc oc ne li nf od nh ll ni oe nk lo nl of nn lr no bi translated">摘要</h1><p id="aefc" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy lv ka kb kc lw ke kf kg lx ki kj kk ij bi translated">正如您所看到的，秘密管理是一个广泛的主题，值得进一步的文章来深入探讨。应该在开发生命周期的设计阶段考虑机密管理，确保机密被正确传递，并降低泄露敏感数据的风险。</p><h2 id="9727" class="la lb iq bd lc ld le dn lf lg lh dp li jy lj lk ll kc lm ln lo kg lp lq lr ls bi translated">参考</h2><p id="6652" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy lv ka kb kc lw ke kf kg lx ki kj kk ij bi translated"><a class="ae kl" href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/" rel="noopener ugc nofollow" target="_blank"> Kubernetes —加密静态秘密</a></p><p id="e01d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://secrets-store-csi-driver.sigs.k8s.io/introduction.html" rel="noopener ugc nofollow" target="_blank">秘密商店老何司机</a></p><p id="bae5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://kubernetes.io/docs/concepts/configuration/secret/" rel="noopener ugc nofollow" target="_blank">库伯内特的秘密</a></p></div></div>    
</body>
</html>