<html>
<head>
<title>Drastically Improve your Kubernetes Deployments with Helm</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">借助Helm显著改善您的Kubernetes部署</h1>
<blockquote>原文：<a href="https://itnext.io/drastically-improve-your-kubernetes-deployments-with-helm-5323e7f11ef8?source=collection_archive---------0-----------------------#2019-04-02">https://itnext.io/drastically-improve-your-kubernetes-deployments-with-helm-5323e7f11ef8?source=collection_archive---------0-----------------------#2019-04-02</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="0569" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">走出清单丛林，轻松部署、升级和维护最复杂的部署。</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/0e3840c5be7e5c216e575e67e1999605.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gwlwyF1wugm-Rmt5"/></div></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">马克西米利安·魏斯贝克尔在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="8d0e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><a class="ae kz" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>正在迅速成为运行容器化工作负载的事实标准。虽然Kubernetes有很多现成的东西，但应用程序发布不一定是其中之一。</p><p id="8de6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">通常情况下，普通的Kubernetes清单用于展示应用程序及其资源。这一开始工作得很好，它允许你将<a class="ae kz" href="https://docs.microsoft.com/en-us/azure/devops/learn/what-is-infrastructure-as-code" rel="noopener ugc nofollow" target="_blank">基础设施作为代码</a>——有点像。虽然将您的YAML文件保存在Git存储库中是完全可行的，但是没有真正的方法来正确地对它们进行版本控制。当然，您可以使用Git修订版，但是理想情况下，您会有更合适的版本，比如<a class="ae kz" href="https://semver.org/" rel="noopener ugc nofollow" target="_blank">语义版本</a>。</p><p id="a83e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这就是赫尔姆的用武之地。Helm是Kubernetes的包装经理，没错。但它也是您在Kubernetes集群上实现更好的应用程序和发布管理的门户。Helm允许您将应用程序定义为集群上的一组组件，并提供从头到尾管理这些组件的机制。</p><p id="23dd" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">官网给出了非常简短的描述:</p><blockquote class="lw"><p id="784a" class="lx ly iu bd lz ma mb mc md me mf lv dk translated">" Helm允许您定义、安装和升级甚至最复杂的部署."</p></blockquote><p id="2d7a" class="pw-post-body-paragraph la lb iu lc b ld mg jv lf lg mh jy li lj mi ll lm ln mj lp lq lr mk lt lu lv in bi translated">但平心而论，我认为这不公平。除了作为一个“包管理者”之外，Helm还是一个真正实现可靠的开发和发布工作流的基础组件。</p><p id="989a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在本文中，我们将走过一个版本的完整生命周期。我们将从Helm及其各种组件的介绍开始。之后，我们将从Kubernetes集群中部署、升级、回滚并最终删除一个应用程序。</p><h2 id="26e0" class="ml mm iu bd mn mo mp dn mq mr ms dp mt lj mu mv mw ln mx my mz lr na nb nc nd bi translated">是什么让Helm与众不同？</h2><p id="2992" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">Helm在所谓的<a class="ae kz" href="https://helm.sh/docs/developing_charts/#charts" rel="noopener ugc nofollow" target="_blank">图表</a>中定义了应用程序及其逻辑组件。您可以将图表视为一个或多个应用程序的集合，它们共同构成一个版本。</p><p id="ea00" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">例如，让我们假设我们正在我们的集群上做一个Wordpress发布。为了让它正常运行，我们需要:</p><ul class=""><li id="66db" class="nj nk iu lc b ld le lg lh lj nl ln nm lr nn lv no np nq nr bi translated">MySQL实例来存储我们的数据</li><li id="23ce" class="nj nk iu lc b ld ns lg nt lj nu ln nv lr nw lv no np nq nr bi translated">存储数据库数据的持久卷</li><li id="fc48" class="nj nk iu lc b ld ns lg nt lj nu ln nv lr nw lv no np nq nr bi translated">WordPress本身，不管有没有反向代理</li></ul><p id="f0ae" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Helm将这些分组到一个图表中，然后您可以在一段较长的时间内部署和维护该图表。每当您将图表部署到您的集群时，Helm的服务器端组件——名为<em class="nx">Tiller</em>——将创建一个<em class="nx">版本</em>。这个版本会随着时间的推移跟踪您的应用程序部署。我们稍后再讨论。</p><p id="3367" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">使用Helm，你几乎可以部署任何东西；从简单的Redis缓存，到您能想象到的最复杂的web应用程序。部署模型大致如下:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj ny"><img src="../Images/fc12a395310ee10e1349555037148874.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*UDX2xoqwrOT9qqj4OaFLUA.png"/></div><figcaption class="kv kw gk gi gj kx ky bd b be z dk translated">舵部署模型</figcaption></figure><p id="dea4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如前所述，每当Helm部署一个图表时，都会创建一个版本来跟踪它。这允许您随着时间的推移控制部署，并对其执行升级。</p><p id="378a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">与常规的Kubernetes部署清单不同，Helm图表是有版本的。Tiller会在图表部署到集群时跟踪图表的版本，您可以随时升级或降级图表。</p><p id="4588" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这种部署模型使得Helm变得非常强大，无论是对于发布自己软件的团队，还是希望改进集群管理的DevOps团队。</p><p id="3c7b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在本文中，我们将回顾组成Helm的核心概念，以及如何使用它们来更有效地部署和管理Kubernetes应用程序。</p><h2 id="636b" class="ml mm iu bd mn mo mp dn mq mr ms dp mt lj mu mv mw ln mx my mz lr na nb nc nd bi translated">先决条件</h2><p id="ec4f" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">如果您希望在自己的集群上遵循本指南中的步骤，您将需要以下内容:</p><ul class=""><li id="b52c" class="nj nk iu lc b ld le lg lh lj nl ln nm lr nn lv no np nq nr bi translated">运行Kubernetes集群*</li><li id="cf16" class="nj nk iu lc b ld ns lg nt lj nu ln nv lr nw lv no np nq nr bi translated"><code class="fe nz oa ob oc b">kubectl</code>已安装并配置为与您的集群交互</li></ul><p id="438a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><em class="nx">如果您还没有集群，Digital Ocean将以极具竞争力的价格为您提供。您可以使用</em> <a class="ae kz" href="https://m.do.co/c/e7b342e45008" rel="noopener ugc nofollow" target="_blank"> <em class="nx">我的推荐链接获得前两个月的100美元信用点数</em> </a> <em class="nx">免费试用。</em></p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj od"><img src="../Images/f512ff58d7e626458d3c77d0534fe870.png" data-original-src="https://miro.medium.com/v2/resize:fit:400/format:webp/1*ZYG7ZBoRcrau0gtavbK42Q.png"/></div></figure><h1 id="1df9" class="oe mm iu bd mn of og oh mq oi oj ok mt ka ol kb mw kd om ke mz kg on kh nc oo bi translated">舵柄和舵柄</h1><p id="ee0d" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">舵由两部分组成:舵和舵杆。Helm本身是您在命令行中运行的客户端组件，而tiller则生活在您的集群中，完成所有繁重的工作。</p><h2 id="8b12" class="ml mm iu bd mn mo mp dn mq mr ms dp mt lj mu mv mw ln mx my mz lr na nb nc nd bi translated">安装舵</h2><p id="e9f2" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">在我们继续之前，您需要下载并安装<em class="nx"> Helm。</em>前往<a class="ae kz" href="https://github.com/helm/helm/releases" rel="noopener ugc nofollow" target="_blank">官方发布页面</a>获取针对您的特定操作系统和架构的最新Helm版本。出于本教程的目的，我们使用Linux版本。首先，打开包装:</p><pre class="kk kl km kn gu op oc oq or aw os bi"><span id="3781" class="ml mm iu oc b gz ot ou l ov ow">$ tar -zxvf helm-v2.0.0-linux-amd64.tgz</span></pre><p id="3f5a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">之后，找到<code class="fe nz oa ob oc b">helm</code>二进制文件，并将其移动到<code class="fe nz oa ob oc b">/usr/local/bin</code>。要验证舵是否正确安装，运行<code class="fe nz oa ob oc b">helm version</code>。输出应该大致如下:</p><pre class="kk kl km kn gu op oc oq or aw os bi"><span id="a18f" class="ml mm iu oc b gz ot ou l ov ow">&gt; Client: &amp;version.Version{SemVer:"v2.13.0", GitCommit:"79d07943b03aea2b76c12644b4b54733bc5958d6", GitTreeState:"clean"}</span></pre><p id="e3aa" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">你也可以使用软件包管理器，比如aptitude或者homebrew，但是他们可能不会总是安装最新的版本。</p><h2 id="c2ac" class="ml mm iu bd mn mo mp dn mq mr ms dp mt lj mu mv mw ln mx my mz lr na nb nc nd bi translated">安装舵杆</h2><p id="7581" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">现在你的机器上已经有了舵，你可以在集群上部署舵了。默认情况下，Tiller将被安装到您的<code class="fe nz oa ob oc b">.kubeconfig</code>中指定的当前上下文中。如果您想要部署到不同的集群，确保您指定了<code class="fe nz oa ob oc b">--kube-context</code>标志来指定您的上下文。</p><p id="8dad" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Tiller是处理集群资源的实际操作以安装和升级工作负载的组件。授予Tiller访问权限有多种方式——但出于本指南的目的，我们将为其分配一个<code class="fe nz oa ob oc b">cluster-admin</code>角色:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ox oy l"/></div></figure><p id="f415" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">通过将集群角色部署到集群来创建集群角色:</p><pre class="kk kl km kn gu op oc oq or aw os bi"><span id="b0cb" class="ml mm iu oc b gz ot ou l ov ow">$ kubectl create -f tiller-sa.yaml</span></pre><p id="5857" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">创建服务帐户后，将Tiller部署到您的集群，并为其分配您刚刚创建的服务帐户:</p><pre class="kk kl km kn gu op oc oq or aw os bi"><span id="3e10" class="ml mm iu oc b gz ot ou l ov ow">$ helm init --service-account tiller <!-- -->--history-max 200</span></pre><p id="ca28" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe nz oa ob oc b">--service-account</code>标志指定Tiller应该在之前创建的<code class="fe nz oa ob oc b">tiller</code>账户下运行。如果没有它，它将没有足够的权限来部署或维护图表。</p><p id="59d0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe nz oa ob oc b">--history-max</code>标志指定Helm在其历史中保存的对象的最大数量。如果没有指定这个标志，历史对象永远不会被删除。从长远来看，这可能会在集群中构建大量的对象。</p><p id="4073" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">完成该步骤后，再次运行<code class="fe nz oa ob oc b">helm version</code>。现在，您应该可以看到客户机和服务器的版本信息:</p><pre class="kk kl km kn gu op oc oq or aw os bi"><span id="8d0d" class="ml mm iu oc b gz ot ou l ov ow">&gt; Client: &amp;version.Version{SemVer:"v2.13.0", GitCommit:"79d07943b03aea2b76c12644b4b54733bc5958d6", GitTreeState:"clean"}</span><span id="8fa9" class="ml mm iu oc b gz oz ou l ov ow">&gt; Server: &amp;version.Version{SemVer:"v2.13.0", GitCommit:"79d07943b03aea2b76c12644b4b54733bc5958d6", GitTreeState:"clean"}</span></pre><h1 id="6f12" class="oe mm iu bd mn of og oh mq oi oj ok mt ka ol kb mw kd om ke mz kg on kh nc oo bi translated">舵图</h1><p id="80e3" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">图表是掌舵人可部署的工件。图表总是使用语义版本化进行版本化，或者打包在版本化的<code class="fe nz oa ob oc b">.tgz</code>文件中，或者在平面目录结构中。</p><p id="7719" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">图表总是遵循特定的目录结构:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ox oy l"/></div></figure><p id="85ef" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe nz oa ob oc b">Chart.yaml</code>文件包含有关图表的信息；名称、版本、描述、图标等。</p><p id="059d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe nz oa ob oc b">charts</code>文件夹包含安装图表所需的所有图表。这包括正确版本的所有依赖项。例如，如果一个<em class="nx"> Wordpress </em>图表需要<em class="nx"> nginx </em>和<em class="nx"> MySQL </em>图表，这些图表也会包含在<code class="fe nz oa ob oc b">charts</code>文件夹中。</p><p id="4dbd" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果我们看一下官方Wordpress图表的<code class="fe nz oa ob oc b">Chart.yaml</code>文件:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ox oy l"/></div></figure><p id="eb0b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">您可以看到有一个<code class="fe nz oa ob oc b">version</code>和一个<code class="fe nz oa ob oc b">appVersion</code>字段。前者指示图表的版本，并且允许我们将版本化应用到我们的图表发布中。后者仅仅代表了图表所代表的主要应用程序的版本，在这个例子中，是Wordpress 5.1.1。</p><p id="edf7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这是舵图和普通库伯内特清单的主要区别之一。每当使用<code class="fe nz oa ob oc b">helm package</code>创建图表时，图表中的版本将在安装该图表时使用。安装后，将在跟踪该实例的集群上创建一个安装，随后允许更新、回滚或删除该实例。</p><p id="3da9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">拥有这些机制来版本化、安装和更新可能跨越多个工作负载的应用程序是非常重要的。它允许您推出集中发布的版本，并确保您的应用程序及其依赖项始终运行正确的版本。</p><p id="bc59" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">接下来，我们将看看部署和更新上面显示的Wordpress图表。</p><h1 id="5258" class="oe mm iu bd mn of og oh mq oi oj ok mt ka ol kb mw kd om ke mz kg on kh nc oo bi translated">安装和管理图表</h1><p id="b01e" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">继续之前，请确保头盔已正确初始化。如果您遵循了本指南的安装步骤，这已经完成了。如果您还没有，您可以使用以下两个命令之一初始化Tiller:</p><ul class=""><li id="faa0" class="nj nk iu lc b ld le lg lh lj nl ln nm lr nn lv no np nq nr bi translated">如果你的集群<strong class="lc iv">已经运行舵柄</strong>，运行<code class="fe nz oa ob oc b">helm init --client-only</code>来本地初始化舵柄</li><li id="09dd" class="nj nk iu lc b ld ns lg nt lj nu ln nv lr nw lv no np nq nr bi translated">如果您的集群没有运行Tiller，请参考本文的<strong class="lc iv">舵和舵</strong>部分</li></ul><h2 id="32b1" class="ml mm iu bd mn mo mp dn mq mr ms dp mt lj mu mv mw ln mx my mz lr na nb nc nd bi translated">仓库</h2><p id="8719" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">Helm使用存储库来提供图表服务。默认存储库包含各种各样的应用程序，但是您也可以添加第三方存储库，或者托管您自己的存储库。与图表版本控制相结合，托管您自己的存储库是管理您的软件版本的一种非常有效的方式。</p><p id="fa38" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在我们将使用默认存储库中的Wordpress图表。继续运行<code class="fe nz oa ob oc b">helm repo update</code>来更新存储库。输出应该大致如下:</p><pre class="kk kl km kn gu op oc oq or aw os bi"><span id="5917" class="ml mm iu oc b gz ot ou l ov ow">&gt; Hang tight while we grab the latest from your chart repositories...</span><span id="0e2b" class="ml mm iu oc b gz oz ou l ov ow">&gt; ...Skip local chart repository</span><span id="8c47" class="ml mm iu oc b gz oz ou l ov ow">&gt; ...Successfully got an update from the "stable" chart repository</span><span id="6c74" class="ml mm iu oc b gz oz ou l ov ow">&gt; Update Complete. ⎈ Happy Helming!⎈</span></pre><p id="0d4c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">您可以通过运行以下命令来验证更新是否成功:</p><pre class="kk kl km kn gu op oc oq or aw os bi"><span id="ca00" class="ml mm iu oc b gz ot ou l ov ow">$ helm search stable/wordpress --versions</span></pre><p id="fbdf" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这会给你一个相当长的列表，显示所有的Wordpress图表。注意，每个图表都有一个图表版本和一个应用程序版本。这些图表不一定是绑定的——对于每个应用程序版本，可能存在多个图表。</p><p id="9ab4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">对于稳定分支中所有可用的图表，请参见官方图表存储库:</p><div class="pa pb gq gs pc pd"><a href="https://github.com/helm/charts/tree/master/stable" rel="noopener  ugc nofollow" target="_blank"><div class="pe ab fp"><div class="pf ab pg cl cj ph"><h2 class="bd iv gz z fq pi fs ft pj fv fx it bi translated">舵/海图</h2><div class="pk l"><h3 class="bd b gz z fq pi fs ft pj fv fx dk translated">为Kubernetes策划应用。在GitHub上创建一个帐户，为头盔/海图开发做出贡献。</h3></div><div class="pl l"><p class="bd b dl z fq pi fs ft pj fv fx dk translated">github.com</p></div></div><div class="pm l"><div class="pn l po pp pq pm pr kt pd"/></div></div></a></div><h2 id="bbce" class="ml mm iu bd mn mo mp dn mq mr ms dp mt lj mu mv mw ln mx my mz lr na nb nc nd bi translated">装置</h2><p id="e46c" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">在撰写本文时，Wordpress版本<code class="fe nz oa ob oc b">5.1.1</code>是稳定库中的最新版本。因为我们稍后将升级我们的安装，我们将从安装一个旧的图表开始。我们将从版本<code class="fe nz oa ob oc b">5.0.1</code>开始:</p><pre class="kk kl km kn gu op oc oq or aw os bi"><span id="0635" class="ml mm iu oc b gz ot ou l ov ow">$ helm install stable/wordpress --name my-wordpress --version 5.0.1</span></pre><p id="1b28" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这个图表使用MariaDB作为数据库，运行上面的命令将自动在集群上提供所需的资源。</p><p id="81b4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">根据您的云提供商，输出应该大致如下:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ox oy l"/></div></figure><p id="6a9b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">以上是图表的<em class="nx">状态</em>。因为Helm跟踪已命名的发布，所以您总是可以通过运行<code class="fe nz oa ob oc b">helm status my-wordpress</code>来检索这些信息。</p><p id="bc6c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Helm部署和常规Kubernetes部署之间的一个关键区别是，使用Helm，发布会被跟踪<strong class="lc iv">，即使它们已经被删除</strong>。在本文的后面，我们将进一步探讨发布状态。</p><p id="801e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">接下来，我们将进入Helm提供的升级和回滚功能，将我们的Wordpress图表升级到最新版本。</p><h2 id="732b" class="ml mm iu bd mn mo mp dn mq mr ms dp mt lj mu mv mw ln mx my mz lr na nb nc nd bi translated">升级和回滚</h2><p id="34cd" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">Helm提供的强大机制之一是通过执行升级和回滚来控制版本的能力。在上一步中，我们已经部署了一个旧版本的Wordpress图表。在这一步中，我们将把它升级到最新版本。</p><p id="727c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe nz oa ob oc b">helm upgrade</code>接受两个参数:版本名和升级到的图表。如果你想升级到一个特定的图表版本，你可以像我们之前做的那样通过指定<code class="fe nz oa ob oc b">--version</code>来完成。现在，我们将升级到最新版本的Wordpress图表。在撰写本文时，最新的版本是<code class="fe nz oa ob oc b">5.1.1</code>。</p><p id="94ff" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">要将你的Wordpress版本升级到最新版本，运行:</p><pre class="kk kl km kn gu op oc oq or aw os bi"><span id="142b" class="ml mm iu oc b gz ot ou l ov ow">$ helm upgrade my-wordpress stable/wordpress</span></pre><p id="447c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果一切顺利，您的版本应该升级:</p><pre class="kk kl km kn gu op oc oq or aw os bi"><span id="1ff4" class="ml mm iu oc b gz ot ou l ov ow">&gt; Release "my-wordpress" has been upgraded. Happy Helming!</span><span id="e2b9" class="ml mm iu oc b gz oz ou l ov ow">&gt; LAST DEPLOYED: Mon Mar 25 11:57:47 2019</span><span id="cd5d" class="ml mm iu oc b gz oz ou l ov ow">&gt; NAMESPACE: default</span><span id="23ef" class="ml mm iu oc b gz oz ou l ov ow">&gt; STATUS: DEPLOYED</span></pre><p id="e74b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在那下面，你会看到你的版本的新<code class="fe nz oa ob oc b">helm status</code>，反映了升级。就这些了。</p><p id="26f7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果升级导致不良副作用，您可以随时使用<code class="fe nz oa ob oc b"><a class="ae kz" href="https://github.com/helm/helm/blob/master/docs/helm/helm_rollback.md" rel="noopener ugc nofollow" target="_blank">helm rollback</a></code>执行回滚。如果您想尝试执行回滚，您可以执行一次预演，这将不会影响实际的发布。</p><p id="84f8" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">要执行到先前版本的试运行回滚，只需运行:</p><pre class="kk kl km kn gu op oc oq or aw os bi"><span id="b3e6" class="ml mm iu oc b gz ot ou l ov ow">$ helm rollback my-wordpress 0 --dry-run</span></pre><p id="88db" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这将模拟回滚，而不会实际改变任何集群对象。因此，如果你<code class="fe nz oa ob oc b">helm ls</code>，你的Wordpress图表应该仍然运行在最新版本。</p><p id="f1bf" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">接下来，我们将深入探讨如何正确清理您的资源。</p><h1 id="022a" class="oe mm iu bd mn of og oh mq oi oj ok mt ka ol kb mw kd om ke mz kg on kh nc oo bi translated">清理</h1><p id="505c" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">当然，我们不希望这些资源停留在我们的集群上。与常规的Kubernetes部署不同，Helm版本在其生命周期中包含删除状态。也就是说，当你删除一个舵图时，它会过渡到一个<code class="fe nz oa ob oc b">deleted</code>状态，而不是直接消失。</p><p id="56eb" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们将深入探讨图表被删除后可能存在的各种状态。首先，我们将简单地从集群中删除我们的Wordpress版本:</p><pre class="kk kl km kn gu op oc oq or aw os bi"><span id="21e7" class="ml mm iu oc b gz ot ou l ov ow">$ helm delete my-wordpress</span></pre><p id="2082" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这应该给你一个简单的:</p><pre class="kk kl km kn gu op oc oq or aw os bi"><span id="7919" class="ml mm iu oc b gz ot ou l ov ow">&gt; release "my-wordpress" deleted</span></pre><p id="0ebc" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">很好。此操作已经清理了与发布相关的所有窗格，您可以通过运行<code class="fe nz oa ob oc b">kubectl get pods</code>来验证。</p><p id="8d9e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">尽管与该版本相关的集群资源被删除，Tiller仍然跟踪该版本的历史。然而，你不能“复活”这个版本，或者重新使用它的名字。</p><h2 id="a654" class="ml mm iu bd mn mo mp dn mq mr ms dp mt lj mu mv mw ln mx my mz lr na nb nc nd bi translated">清除释放</h2><p id="c9b0" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">如果您想在将来重用某个版本的名称，或者您对跟踪某个版本的历史不感兴趣，您可以清除某个版本。</p><p id="52e2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">为此，只需在调用<code class="fe nz oa ob oc b">helm delete</code>时传递<code class="fe nz oa ob oc b">--purge</code>标志。因为我们希望将集群恢复到本文开始时的状态，所以我们将清除之前创建的Wordpress版本:</p><pre class="kk kl km kn gu op oc oq or aw os bi"><span id="2862" class="ml mm iu oc b gz ot ou l ov ow">$ helm delete my-wordpress --purge</span></pre><p id="69b7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">之后，您可以运行一个<code class="fe nz oa ob oc b">helm ls</code>来验证Tiller不再跟踪释放。</p><h1 id="144e" class="oe mm iu bd mn of og oh mq oi oj ok mt ka ol kb mw kd om ke mz kg on kh nc oo bi translated">结论</h1><p id="ea7f" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">在本文中，您已经学习了如何使用Helm来安装、升级、回滚和删除应用程序版本。这些只是在一个版本的生命周期中使用Helm的基础，但是它们可以带你管理Kubernetes集群。</p><p id="3ee9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果您希望继续Helm之旅，并使用它来发布和管理您自己的应用程序，您的下一步可能是:</p><ul class=""><li id="c82c" class="nj nk iu lc b ld le lg lh lj nl ln nm lr nn lv no np nq nr bi translated">为您的应用程序创建并发布舵图</li><li id="02fa" class="nj nk iu lc b ld ns lg nt lj nu ln nv lr nw lv no np nq nr bi translated">深入阅读<code class="fe nz oa ob oc b"><a class="ae kz" href="https://helm.sh/docs/chart_best_practices/#values" rel="noopener ugc nofollow" target="_blank">values.yaml</a></code>上的文档，了解如何将环境变量和其他特定于环境的变量传递到您的版本中</li><li id="f0f7" class="nj nk iu lc b ld ns lg nt lj nu ln nv lr nw lv no np nq nr bi translated">将值传递到您的Helm chart与作为代码的<a class="ae kz" href="https://docs.microsoft.com/en-us/azure/devops/learn/what-is-infrastructure-as-code" rel="noopener ugc nofollow" target="_blank">基础设施相结合，为您的应用程序自动创建、部署和更新各种环境</a></li></ul><p id="c83a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">根据这篇文章如何被接受，我将在后续文章中进一步阐述以上观点，并将其变成一个系列。</p><p id="4d29" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">希望这篇文章对你有用。感谢您的阅读。</p></div></div>    
</body>
</html>