<html>
<head>
<title>The Everything Guide to Lambda Throttling, Reserved Concurrency, and Execution Limits</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Lambda节流、保留并发和执行限制的全面指南</h1>
<blockquote>原文：<a href="https://itnext.io/the-everything-guide-to-lambda-throttling-reserved-concurrency-and-execution-limits-d64f144129e5?source=collection_archive---------1-----------------------#2019-03-28">https://itnext.io/the-everything-guide-to-lambda-throttling-reserved-concurrency-and-execution-limits-d64f144129e5?source=collection_archive---------1-----------------------#2019-03-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="da38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">你需要知道什么，知道什么，你知道一点点什么……</em></p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/9212099df96b87acaf849559f6b71085.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jwsFFgi9nkoz2LLm.png"/></div></div></figure><h1 id="41a4" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">定义:</h1><p id="57f3" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated"><em class="kl">并发执行</em> —同时被AWS Lambda函数<strong class="jp ir">执行的进程</strong>。</p><p id="0d73" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">请求</em> — <strong class="jp ir">触发</strong>AWS Lambda启动并开始处理的事件。</p><h1 id="f3e4" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated"><strong class="ak">有哪些限制？</strong></h1><p id="689f" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">对于每个AWS帐户，您从1000个并发执行的池开始。该帐户的所有lambdas将共享该池中的执行。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mb"><img src="../Images/524bbadfc7b283fdb8b334d9d6f8cc28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xqXhaiw9t9-1A0UE3RvaCA.png"/></div></div></figure><p id="c561" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果一个lambda收到大量请求(比如1000个)，AWS将从公共池中运行这1000个请求。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mc"><img src="../Images/64285b8970542b4fe4d155644ae7e3a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1188/format:webp/1*jB7GPDDDRzuAgzgtiW-SEQ.png"/></div></div></figure><p id="939d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果第二个lambda在同一时刻也接收请求(例如150个),那么它就有被完全或部分拒绝的风险，因为并发执行的总数超过了1000的限制。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi md"><img src="../Images/f56f1f2f4859cc5a3067bb3ded1625be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/format:webp/1*vrYi3vKdUP9lqbIJS555wg.png"/></div></figure><p id="51a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于某些应用，这种拒绝风险是不可接受的。在这些情况下，工程师可以使用<em class="kl"> Reserved Concurrency </em>参数为任何给定的lambda保留一定数量的执行，保证它们总是可用的。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi me"><img src="../Images/447df56317222902cd0817193116111d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1226/format:webp/1*ohJCYxRkQFUxsR9fS1Vwjg.png"/></div></figure><p id="aad8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可以在任意组合的任意或所有lambdas上设置保留并发。然而，<strong class="jp ir"> AWS总是向公共池</strong>保留100个执行。因此，如果帐户的限制是1000，那么组合的<em class="kl">保留并发</em>的最大数量将是900。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/5d6c33c7a7865eae21b8cb47e0eb400e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1266/format:webp/1*SkZDXoSs6toRBJ1a-xHshg.png"/></div></figure><p id="4a81" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当<em class="kl">并发</em>参数返回到“<em class="kl">使用未保留的帐户并发</em>”时，执行被返回到公共池。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/bc84f7699c1801308de83e2af6b7ec21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/1*NgwwfdCiYTvYbD6Do_taXg.png"/></div></figure><p id="f856" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过这种设置，保留的执行将<strong class="jp ir">始终保持不受其他lambda</strong>的影响，即使它们被保留的lambda没有使用它们。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/d5808e176765d5577e4924103101b1d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1310/format:webp/1*wM8uEO1wJuFU5iXeXOoEmw.png"/></div></figure><p id="48ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">反方向也是如此。一旦为lambda函数设置了<em class="kl">保留并发</em>参数，该函数的并发执行总数<strong class="jp ir">就不能超过该数目</strong>。充当该功能的并发限制。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/3bf44036510b8d0baa5156485112013a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1312/format:webp/1*dHXMkp_y5ItpFXD-LQbL1g.png"/></div></figure><p id="fab7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于某些系统，即使在优化之后，并发执行的总数也一直超过1000的限制。在这种情况下，账户所有者可以通过<strong class="jp ir">联系AWS支持中心</strong>请求增加系统限额。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mj"><img src="../Images/56cd8e20add548929cf15f85995e89df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Id8B5Tsj4eHC1mspm3cj5Q.png"/></div></div></figure><h1 id="2e9d" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">我们为什么要限制死刑？</h1><p id="4d7e" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">有很多理由抑制或限制你的lambda函数。</p><ol class=""><li id="7ee3" class="mk ml iq jp b jq jr ju jv jy mm kc mn kg mo kk mp mq mr ms bi translated">成本或安全性，您可能不希望有人意外或恶意地向您的系统发出大量请求。</li><li id="8fdb" class="mk ml iq jp b jq mt ju mu jy mv kc mw kg mx kk mp mq mr ms bi translated">性能，以强制合理的批量大小。</li><li id="0e4e" class="mk ml iq jp b jq mt ju mu jy mv kc mw kg mx kk mp mq mr ms bi translated">可扩展性，使吞吐量与下游资源相匹配。</li><li id="767b" class="mk ml iq jp b jq mt ju mu jy mv kc mw kg mx kk mp mq mr ms bi translated">关闭开关，将<em class="kl">保留并发</em>减少到零实际上意味着没有流量会流过您的进程。</li></ol><h1 id="4ebf" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">这在实践中是什么样子的？</h1><p id="d0c6" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">要修改任何lambda的保留并发性，有几个选项。</p><h2 id="feca" class="my kz iq bd la mz na dn le nb nc dp li jy nd ne lm kc nf ng lq kg nh ni lu nj bi translated">控制台</h2><p id="7b8b" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">在AWS控制台中导航到您的lambda，在配置页面中向下滚动到<em class="kl">并发</em>框，并选择<em class="kl">保留并发。</em></p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nk"><img src="../Images/cabe0c15e26a6d98b74451cb8b6e517e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZWASuAwdHoJz1-uG.png"/></div></div></figure><h2 id="082c" class="my kz iq bd la mz na dn le nb nc dp li jy nd ne lm kc nf ng lq kg nh ni lu nj bi translated">命令行</h2><p id="4594" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">要通过命令行修改<em class="kl">保留并发</em>，请使用下面的<a class="ae nl" href="https://docs.aws.amazon.com/lambda/latest/dg/concurrent-executions.html" rel="noopener ugc nofollow" target="_blank">命令</a>:</p><pre class="kn ko kp kq gt nm nn no np aw nq bi"><span id="cda1" class="my kz iq nn b gy nr ns l nt nu">aws lambda put-function-concurrency --function-name YOUR_FUNCTION_NAME_HERE --reserved-concurrent-executions 50</span></pre><h2 id="6491" class="my kz iq bd la mz na dn le nb nc dp li jy nd ne lm kc nf ng lq kg nh ni lu nj bi translated">无服务器框架文件</h2><p id="64a1" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">如果你用无服务器框架部署你的函数，你可以为文件的<code class="fe nv nw nx nn b">function</code>部分中的任何lambda修改<em class="kl">保留并发性</em>。</p><pre class="kn ko kp kq gt nm nn no np aw nq bi"><span id="011a" class="my kz iq nn b gy nr ns l nt nu">service: MediumConcurrency </span><span id="e13f" class="my kz iq nn b gy ny ns l nt nu">provider:<br/>  name: aws<br/>  runtime: python3.7<br/>  stage: ${opt:stage, 'dev'}<br/>  region: ${opt:region, 'us-east-1'}<br/>  profile: ${opt:profile, 'default'}<br/>  environment:<br/>    region: ${self:provider.region}<br/>    stage: ${self:provider.stage}<br/>  stackTags:<br/>    Owner : krapes<br/>    Project : concurrencyLimits<br/>    Service : concurrencyLimits<br/>    Team : brokenLeg<br/>  stackPolicy: # This policy allows updates to all resources<br/>    - Effect: Allow<br/>      Principal: "*"<br/>      Action: "Update:*"<br/>      Resource: "*"</span><span id="218b" class="my kz iq nn b gy ny ns l nt nu">  iamRoleStatements:</span><span id="4921" class="my kz iq nn b gy ny ns l nt nu">functions:<br/>  dummy:<br/>    handler: dummy.main<br/>    timeout: 10<br/>    ## This parameter sets the reserved concurrency for the lambda 'dummy'<br/>    reservedConcurrency: 25<br/>#    events:<br/>#      - http:<br/>#          method: GET<br/>#          path: /dummy<br/>#          resp: json</span><span id="df13" class="my kz iq nn b gy ny ns l nt nu">#plugins:<br/>#  - serverless-python-requirements<br/></span><span id="137b" class="my kz iq nn b gy ny ns l nt nu">custom:<br/>  pythonRequirements:<br/>     dockerizePip: non-linux</span></pre><p id="4c89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，当<a class="ae nl" href="https://aws.amazon.com/blogs/compute/managing-aws-lambda-function-concurrency/" rel="noopener ugc nofollow" target="_blank">测试</a>您的lambda时，您将看到<em class="kl">与</em><em class="kl">保留并发</em>设置的超额请求被返回一个错误500代码，从而限制了系统。</p><p id="2233" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面的输出是使用<a class="ae nl" href="https://github.com/krapes/lambdaLoadTesting" rel="noopener ugc nofollow" target="_blank"> Lambda负载测试</a>工具生成的，没有<em class="kl"> reservedConcurrency </em>，并且设置为25。</p><p id="a848" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">无<em class="kl">预留并发</em>限制:</p><pre class="kn ko kp kq gt nm nn no np aw nq bi"><span id="27a8" class="my kz iq nn b gy nr ns l nt nu">bash run.sh -n 5000 -c 50</span><span id="f60b" class="my kz iq nn b gy ny ns l nt nu">-----------------------------------------------------------</span><span id="6a0e" class="my kz iq nn b gy ny ns l nt nu">Details (average, fastest, slowest):<br/>  DNS+dialup:   0.0009 secs, 2.0200 secs, 6.0415 secs<br/>  DNS-lookup:   0.0002 secs, 0.0000 secs, 0.0185 secs<br/>  req write:    0.0000 secs, 0.0000 secs, 0.0030 secs<br/>  resp wait:    3.5561 secs, 2.0199 secs, 6.0414 secs<br/>  resp read:    0.0001 secs, 0.0000 secs, 0.0032 secs</span><span id="1a9b" class="my kz iq nn b gy ny ns l nt nu">Status code distribution:<br/>  [200] 5000 responses</span></pre><p id="026d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">同<em class="kl">预留并发</em>限制:</p><pre class="kn ko kp kq gt nm nn no np aw nq bi"><span id="00cf" class="my kz iq nn b gy nr ns l nt nu">bash run.sh -n 5000 -c 50</span><span id="0c71" class="my kz iq nn b gy ny ns l nt nu">-------------------------------------------------------------</span><span id="19cc" class="my kz iq nn b gy ny ns l nt nu">Details (average, fastest, slowest):<br/>  DNS+dialup:   0.0007 secs, 0.0094 secs, 5.6580 secs<br/>  DNS-lookup:   0.0000 secs, 0.0000 secs, 0.0119 secs<br/>  req write:    0.0000 secs, 0.0000 secs, 0.0033 secs<br/>  resp wait:    1.1845 secs, 0.0093 secs, 5.5826 secs<br/>  resp read:    0.0000 secs, 0.0000 secs, 0.0032 secs</span><span id="8f7d" class="my kz iq nn b gy ny ns l nt nu">Status code distribution:<br/>  [200] 1638 responses<br/>  [500] 3362 responses</span></pre><h1 id="ab0f" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">结论</h1><p id="6719" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">总之，lambda函数的并发供应和节流都可以通过<em class="kl">保留并发</em>参数来管理。如果帐户仅仅需要超过标准的1000个并发执行，Amazon很乐意在讨论其他优化技术后提高限制。</p><p id="e735" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然并发限制是服务吞吐量的一个很好的指标，但它仍然不能说明全部情况。平均运行时间长度对一个服务在给定时间段内可以处理的请求数量有很大的影响。与速度较慢的函数相比，能够以两倍的速度完成一个进程的lambda或服务需要较少的并发执行来处理相同数量的请求。</p><p id="63ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了更好地了解您的服务将如何响应，最好自己进行压力测试。λ负载测试库是一个很好的起点。</p></div></div>    
</body>
</html>