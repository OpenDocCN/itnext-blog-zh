<html>
<head>
<title>Consuming GraphQL APIs with Quarkus</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Quarkus使用GraphQL APIs</h1>
<blockquote>原文：<a href="https://itnext.io/consuming-graphql-apis-with-quarkus-a2f482b6169d?source=collection_archive---------2-----------------------#2021-06-04">https://itnext.io/consuming-graphql-apis-with-quarkus-a2f482b6169d?source=collection_archive---------2-----------------------#2021-06-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="cc26" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<a class="ae kl" href="https://hantsy.medium.com/building-graphql-apis-with-quarkus-dbbf23f897df" rel="noopener">上一篇文章</a>中，我们已经构建了一个简单的GraphQL API示例，现在让我们讨论如何使用GraphQL客户端与后端graph QL API进行交互。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/6357465393cb0b31ffb7a85f29b4d364.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ooWBcjq6RawM_2U54kWWxA.jpeg"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">图片来自<a class="ae kl" href="https://unsplash.com/photos/6NzHYsK_-Ow" rel="noopener ugc nofollow" target="_blank">https://unsplash.com/photos/6NzHYsK_-Ow</a></figcaption></figure><h1 id="99f2" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">生成项目框架</h1><p id="ef16" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">就像我们在过去的帖子中所做的那样，你应该首先准备一个项目框架。</p><p id="0f24" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<a class="ae kl" href="https://code.quarkus.io" rel="noopener ugc nofollow" target="_blank"> Quarkus代码生成器</a>创建一个Quarkus项目，将源代码导入你的IDE。</p><p id="a05c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">打开<em class="mf"> pom.xml </em>文件，添加以下依赖项。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="c6de" class="ml ld iq mh b gy mm mn l mo mp">&lt;dependency&gt;<br/>    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;<br/>    &lt;artifactId&gt;quarkus-smallrye-graphql-client&lt;/artifactId&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;<br/>    &lt;artifactId&gt;quarkus-rest-client&lt;/artifactId&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;<br/>    &lt;artifactId&gt;quarkus-rest-client-jsonb&lt;/artifactId&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br/>    &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br/>    &lt;version&gt;1.18.20&lt;/version&gt;<br/>&lt;/dependency&gt;</span></pre><p id="9017" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Lombok用于擦除setters、getters、hashCode、equals、toString等。让它看起来干净点。</p><h1 id="2d2e" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">声明GraphQL客户端API</h1><p id="dd15" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">与MicroProfile RestClient规范类似，SmallRye GraphQL提供了从接口声明GraphQL客户端的相同方法。</p><blockquote class="mq mr ms"><p id="8665" class="jn jo mf jp b jq jr js jt ju jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj kk ij bi translated"><em class="iq">注意，这个客户端API不是MicroProfile GraphQL规范的一部分。</em></p></blockquote><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="3fd1" class="ml ld iq mh b gy mm mn l mo mp">@GraphQLClientApi<br/>public interface PostGraphQLClient {<br/>    @Query()<br/>    public List&lt;Post&gt; getAllPosts() ;</span><span id="a86d" class="ml ld iq mh b gy mw mn l mo mp">    @Query<br/>    @Description("Get a specific post by providing an id")<br/>    public Post getPostById(@Name("postId") String id);</span><span id="1d27" class="ml ld iq mh b gy mw mn l mo mp">    @Mutation<br/>    @Description("Create a new post")<br/>    public Post createPost(@Valid CreatePost createPostInput);<br/>}</span></pre><p id="e3c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上述代码中使用的POJO类，如<code class="fe mx my mz mh b">Post</code>、<code class="fe mx my mz mh b">Coment</code>和<code class="fe mx my mz mh b">CreatePost</code>都是从我们在上一篇文章中创建的<a class="ae kl" href="https://github.com/hantsy/quarkus-sandbox/blob/master/graphql" rel="noopener ugc nofollow" target="_blank">后台GraphQL API项目</a>中复制过来的。</p><p id="cae2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要定位将要连接的远程GraphQL API，类似于MP RestClient API，请配置远程GraphQL API的基本URI。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="4958" class="ml ld iq mh b gy mm mn l mo mp">com.example.demo.PostGraphQLClient/mp-graphql/url=http://localhost:8080/graphql</span></pre><p id="8d5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们试着调用<code class="fe mx my mz mh b">PostGraphQLClient</code>的<code class="fe mx my mz mh b">getAllPosts</code>并打印出所有帖子。</p><p id="dedc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个实现<code class="fe mx my mz mh b">QuarkusApplication</code>的类并用<code class="fe mx my mz mh b">@QuarkusMain</code>对其进行注释，它将像普通Java应用程序中的主类一样工作。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="f110" class="ml ld iq mh b gy mm mn l mo mp">@QuarkusMain<br/>public class Main implements QuarkusApplication {<br/>    public static final Logger LOGGER = Logger.getLogger(Main.class.getName());</span><span id="2d0d" class="ml ld iq mh b gy mw mn l mo mp">    @Inject<br/>    PostGraphQLClient clientApi;</span><span id="4bb7" class="ml ld iq mh b gy mw mn l mo mp">    @Override<br/>    public int run(String... args) throws Exception {<br/>        this.clientApi.getAllPosts().forEach(<br/>            p -&gt; LOGGER.log(Level.INFO, "post: {0}", p)<br/>        );<br/>        return 0;<br/>    }<br/>}</span></pre><p id="c2e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">打开您的终端并切换到项目根文件夹。运行<code class="fe mx my mz mh b">mvn quarkus:dev</code>以开发模式启动应用程序。启动后，您将在控制台日志中看到以下信息。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="72fe" class="ml ld iq mh b gy mm mn l mo mp">2021-06-03 20:21:00,505 INFO  [io.sma.gra.cli.typ.jax.JaxRsTypesafeGraphQLClientProxy] (Quarkus Main Thread) request graphql: query allPosts { allPosts {id title content countOfComment<br/>s comments {id content}} }<br/>2021-06-03 20:21:00,517 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post: Post(id=9ef6d49f-50bf-4973-a122-3ac56a1b8d41, title=title #1, content=test content of #1, countOfComments=2<br/>, comments=[Comment(id=e261e9cb-f06c-4989-bbb5-00319087496d, content=comment #1), Comment(id=7664a80f-0963-46c1-8955-c096d7609c1b, content=comment #2)])<br/>2021-06-03 20:21:00,517 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post: Post(id=0c5501eb-cb7e-42e2-9078-040af89e6310, title=title #2, content=test content of #2, countOfComments=2<br/>, comments=[Comment(id=bf4e2553-cb59-4e87-bc8f-36360732a919, content=comment #1), Comment(id=165d6743-fd74-4ad5-8997-3853fb076403, content=comment #2)])<br/>2021-06-03 20:21:00,517 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post: Post(id=c61c6b62-584b-455f-a2a8-1a4253f832b7, title=title #3, content=test content of #3, countOfComments=0<br/>, comments=[])<br/>2021-06-03 20:21:00,517 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post: Post(id=37e28b7d-11fc-4587-920f-9415da1d93a3, title=title #4, content=test content of #4, countOfComments=2<br/>, comments=[Comment(id=5963588f-fbe0-4c82-88f6-1011bb7538fe, content=comment #1), Comment(id=feaf4d21-e78b-4701-91bb-ea665a9a034c, content=comment #2)])</span></pre><p id="d0f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与REST APIs相比，GraphQL最吸引人的特性是它只返回客户端请求的必需字段。在上面的代码中，它返回一个<code class="fe mx my mz mh b">Post</code>的所有字段。</p><p id="f1c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设您只想在执行<code class="fe mx my mz mh b">allPosts</code>查询时检索结果中的<em class="mf"> title </em>字段，尝试创建一个新的POJO类，该类只包含一个<em class="mf"> title </em>属性。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="a573" class="ml ld iq mh b gy mm mn l mo mp">@Getter<br/>@Setter<br/>@NoArgsConstructor<br/>@AllArgsConstructor<br/>@ToString<br/>public class PostSummary {<br/>    String title;<br/>}</span></pre><p id="7d29" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的<code class="fe mx my mz mh b">PostGraphQLClient</code>类中添加一个新方法。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="59eb" class="ml ld iq mh b gy mm mn l mo mp">@Query("allPosts")<br/>public List&lt;PostSummary&gt; getAllPostSummaries() ;</span></pre><p id="00a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们调用它并打印出结果。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="2f9b" class="ml ld iq mh b gy mm mn l mo mp">this.clientApi.getAllPostSummaries().forEach(<br/>    p -&gt; LOGGER.log(Level.INFO, "post summary: {0}", p)<br/>);</span></pre><p id="a23a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以从应用程序日志中看到以下信息。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="c67e" class="ml ld iq mh b gy mm mn l mo mp">2021-06-03 20:21:00,533 INFO  [io.sma.gra.cli.typ.jax.JaxRsTypesafeGraphQLClientProxy] (Quarkus Main Thread) request graphql: query allPosts { allPosts {title} }<br/>2021-06-03 20:21:00,533 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post summary: PostSummary(title=title #1)<br/>2021-06-03 20:21:00,533 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post summary: PostSummary(title=title #2)<br/>2021-06-03 20:21:00,533 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post summary: PostSummary(title=title #3)<br/>2021-06-03 20:21:00,533 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post summary: PostSummary(title=title #4)</span></pre><p id="cd3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所料，它只请求GraphQL查询中的<em class="mf"> title </em>字段，并在响应中返回确切的字段。</p><h1 id="198b" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">处理客户端异常</h1><p id="6887" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">目前，在调用客户端API时，Quarkus没有像MP RestClient API那样提供处理异常的注册表，但是有一些可能的方法来实现这个目的。</p><p id="8c9f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">困难的方法是使用try/catch来处理<code class="fe mx my mz mh b">GraphQLClientException</code>，例如。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="7bbf" class="ml ld iq mh b gy mm mn l mo mp">String id = UUID.randomUUID().toString();<br/>// catch a GraphQLClientException.<br/>try {<br/>    var p = this.clientApi.getPostById(id);<br/>    LOGGER.log(Level.INFO, "post: {0}", p);<br/>} catch (GraphQLClientException e) {<br/>    if (e.getErrors().stream().anyMatch(error -&gt; error.getErrorCode().equals("POST_NOT_FOUND"))) {<br/>        throw new PostNotFoundException(id);<br/>    }<br/>}</span></pre><p id="a3cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的代码中，如果postId不存在，就会抛出一个<code class="fe mx my mz mh b">GraphQLClientException</code>。</p><p id="7964" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除此之外，用<code class="fe mx my mz mh b">ErrorOr</code>类包装您的响应是一个替代解决方案。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="19a6" class="ml ld iq mh b gy mm mn l mo mp">@Query<br/>@Description("Get a specific post by providing an id")<br/>public ErrorOr&lt;Post&gt; getPostById(@Name("postId") String id);</span></pre><p id="8fd1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mx my mz mh b">ErrorOr</code>非常类似于Java的<code class="fe mx my mz mh b">Optional</code>，你可以导航两部分中的一部分，<strong class="jp ir">数据</strong>和<strong class="jp ir">错误</strong>。当错误存在时，<code class="fe mx my mz mh b">getErrors</code>方法将以静默的方式从后端GraphQL API收集所有错误(与try/catch方法相比)。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="f861" class="ml ld iq mh b gy mm mn l mo mp">String id = UUID.randomUUID().toString();</span><span id="99c6" class="ml ld iq mh b gy mw mn l mo mp">// return a `ErrorOr` instead.<br/>var post = this.clientApi.getPostById(id);<br/>if (post.isPresent()) {<br/>    LOGGER.log(Level.INFO, "found: {0}", post.get());<br/>}<br/>if (post.isError()) {<br/>    post.getErrors().forEach(<br/>        error -&gt; LOGGER.log(Level.INFO, "error: code={0}, message={1}", new Object[]{error.getErrorCode(), error.getMessage()})<br/>    );<br/>}</span></pre><p id="733f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行应用程序时，您可以看到以下日志。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="0baf" class="ml ld iq mh b gy mm mn l mo mp">2021-06-03 20:21:00,423 INFO  [io.sma.gra.cli.typ.jax.JaxRsTypesafeGraphQLClientProxy] (Quarkus Main Thread) request graphql: query postById($arg0: String) { postById(postId: $arg0) {i<br/>d title content countOfComments comments {id content}} }<br/>2021-06-03 20:21:00,505 INFO  [com.exa.dem.Main] (Quarkus Main Thread) error: code=POST_NOT_FOUND, message=Post: 8c46ca01-530e-47c1-a257-e86333bcb69b was not found.</span></pre><h1 id="7d9e" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">动态客户端</h1><p id="4fc1" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">我们已经讨论了客户端使用<code class="fe mx my mz mh b">@GraphQLClientApi</code>，Quarkus也提供了一个<strong class="jp ir">动态客户端</strong>。它更像是GraphQL请求表单的Java翻译。</p><p id="d5ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，在<a class="ae kl" href="http://localhost:8080/q/graphql-ui/" rel="noopener ugc nofollow" target="_blank"> GraphQL UI </a>中执行以下查询来检索所有帖子。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="496a" class="ml ld iq mh b gy mm mn l mo mp">query {<br/>  allPosts {<br/>    id<br/>    title<br/>    content<br/>    comments {<br/>      id<br/>      content<br/>    }<br/>  }<br/>}</span></pre><p id="0cb8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个新的bean来做同样的工作。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="cb18" class="ml ld iq mh b gy mm mn l mo mp">@ApplicationScoped<br/>public class PostDynamicClient {</span><span id="ae29" class="ml ld iq mh b gy mw mn l mo mp">    @Inject<br/>    @NamedClient("post-dynamic-client")<br/>    DynamicGraphQLClient dynamicClient;</span><span id="a590" class="ml ld iq mh b gy mw mn l mo mp">    public List&lt;Post&gt; getAllPosts() throws ExecutionException, InterruptedException {<br/>        Document query = document(<br/>                operation(<br/>                        field("allPosts",<br/>                                field("id"),<br/>                                field("title"),<br/>                                field("content"),<br/>                                field("comments",<br/>                                        field("id"),<br/>                                        field("content")<br/>                                )<br/>                        )<br/>                )<br/>        );<br/>        Response response = dynamicClient.executeSync(query);<br/>        return response.getList(Post.class, "allPosts");<br/>    }<br/>}</span></pre><p id="7ce3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过<code class="fe mx my mz mh b">document</code>、<code class="fe mx my mz mh b">operation</code>和<code class="fe mx my mz mh b">field</code>静态方法，我们用Java <em class="mf">方言</em>构建了相同的查询结构。</p><p id="6762" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用于标识不同客户端的<code class="fe mx my mz mh b">NamedClient</code>的值，也用作<em class="mf"> application.properties </em>中的配置键。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="a528" class="ml ld iq mh b gy mm mn l mo mp">post-dynamic-client/mp-graphql/url=http://localhost:8080/graphql</span></pre><p id="9ddb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在尝试调用这个客户端的<code class="fe mx my mz mh b">getAllPosts</code>并打印出所有帖子。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="7d35" class="ml ld iq mh b gy mm mn l mo mp">@Inject<br/>PostDynamicClient dynamicClient;</span><span id="1c22" class="ml ld iq mh b gy mw mn l mo mp">this.dynamicClient.getAllPosts().forEach(<br/>    p -&gt; LOGGER.log(Level.INFO, "post from dynamic client: {0}", p)<br/>);</span></pre><p id="304f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行应用程序，您可以看到以下信息。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="f990" class="ml ld iq mh b gy mm mn l mo mp">1, countOfComments=0, comments=[Comment(id=e261e9cb-f06c-4989-bbb5-00319087496d, content=comment #1), Comment(id=7664a80f-0963-46c1-8955-c096d7609c1b, content=comment #2)])<br/>2021-06-03 20:21:01,507 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post from dynamic client: Post(id=0c5501eb-cb7e-42e2-9078-040af89e6310, title=title #2, content=test content of #<br/>2, countOfComments=0, comments=[Comment(id=bf4e2553-cb59-4e87-bc8f-36360732a919, content=comment #1), Comment(id=165d6743-fd74-4ad5-8997-3853fb076403, content=comment #2)])<br/>2021-06-03 20:21:01,507 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post from dynamic client: Post(id=c61c6b62-584b-455f-a2a8-1a4253f832b7, title=title #3, content=test content of #<br/>3, countOfComments=0, comments=[])<br/>2021-06-03 20:21:01,507 INFO  [com.exa.dem.Main] (Quarkus Main Thread) post from dynamic client: Post(id=37e28b7d-11fc-4587-920f-9415da1d93a3, title=title #4, content=test content of #<br/>4, countOfComments=0, comments=[Comment(id=5963588f-fbe0-4c82-88f6-1011bb7538fe, content=comment #1), Comment(id=feaf4d21-e78b-4701-91bb-ea665a9a034c, content=comment #2)])</span></pre><h1 id="0ef8" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">HttpClient</h1><p id="03b4" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">在Quarkus中，GraphQL客户端通过HTTP协议与后端GraphQL API握手。理想情况下，如果您熟悉GraphQL interexchange format(JSON)，您可以使用任何HttpClient发送一个<em class="mf"> POST </em>请求来执行graph QL查询，包括cURL、Resteasy Client/JAXRS Client或简单的Java 11 HttpClient。</p><p id="fba7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是使用<code class="fe mx my mz mh b">cUrl</code>命令的例子。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="b0b3" class="ml ld iq mh b gy mm mn l mo mp">curl <a class="ae kl" href="http://localhost:8080/graphql" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/graphql</a> -H "Accept: application/json" -H "Content-Type: application/json" -d "{\"query\": \"query {  allPosts {  id title content comments { id  content } } }\" }"<br/>{"data":{"allPosts":[{"id":"5049edc2-58a0-4a0a-9204-753fc4541fa0","title":"title #1","content":"test content of #1","comments":[{"id":"1124e65f-bf4b-41a1-9f34-4daab83b3a31","content":"comment #1"},{"id":"cc68bc61-3769-4a9c-a572-fdd66f6ebffe","content":"comment #2"},{"id":"3d9164d1-9da9-4483-abcb-6d29ffc3b938","content":"comment #3"},{"id":"fbba10b4-9309-442b-8b25-c2ef6e25023c","content":"comment #4"}]},{"id":"d3c130ea-f537-4b77-8125-70b620469c9f","title":"title #2","content":"test content of #2","comments":[{"id":"a28d8b31-65fe-4058-a9bc-739731f5b7d6","content":"comment #1"},{"id":"855b6773-305d-488a-932e-5cc12eb51c93","content":"comment #2"},{"id":"74b1e329-2b85-4e3e-82e8-2b49cc3d387b","content":"comment #3"}]},{"id":"2325744b-46ef-4061-bc03-8f0ca5d7c955","title":"title #3","content":"test content of #3","comments":[{"id":"54217aae-9db1-4403-bbd5-f341e4a53d84","content":"comment #1"}]},{"id":"407dd60c-966c-4d82-b260-f58edba7db14","title":"title #4","content":"test content of #4","comments":[{"id":"f46c8c3e-ddbc-48eb-8a0f-952081bf6d35","content":"comment #1"},{"id":"394a8bec-5e0c-4a69-8b82-a71a4f856778","content":"comment #2"}]}]}}</span></pre><p id="d419" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Java 11中，增加了一个新的<code class="fe mx my mz mh b">HttpClient</code>，下面是一个使用这个HttpClient的例子。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="7224" class="ml ld iq mh b gy mm mn l mo mp">@ApplicationScoped<br/>public class JvmClient {<br/>    private final ExecutorService executorService = Executors.newFixedThreadPool(5);</span><span id="1b26" class="ml ld iq mh b gy mw mn l mo mp">    private final HttpClient httpClient = HttpClient.newBuilder()<br/>            .executor(executorService)<br/>            .version(HttpClient.Version.HTTP_2)<br/>            .build();<br/></span><span id="4e84" class="ml ld iq mh b gy mw mn l mo mp">    @Inject<br/>    Jsonb jsonb;</span><span id="bc7e" class="ml ld iq mh b gy mw mn l mo mp">    CompletionStage&lt;List&lt;Post&gt;&gt; getAllPosts() {</span><span id="98c6" class="ml ld iq mh b gy mw mn l mo mp">        // Have to erase the new line chars in the GraphQL schema to avoid the parsing exception.<br/>        // see: <a class="ae kl" href="https://github.com/quarkusio/quarkus/issues/17667" rel="noopener ugc nofollow" target="_blank">https://github.com/quarkusio/quarkus/issues/17667</a><br/>        var queryString = """<br/>                {"query": "query {<br/>                            allPosts {<br/>                              id<br/>                              title<br/>                              content<br/>                              comments {<br/>                                id<br/>                                content<br/>                              }<br/>                            }<br/>                          }"<br/>                }<br/>                """.replaceAll("\\n", " ");<br/>        var request = HttpRequest.newBuilder()<br/>                .POST(HttpRequest.BodyPublishers.ofString(queryString))<br/>                .uri(URI.create("http://localhost:8080/graphql"))<br/>                .header("Accept", "application/json")<br/>                .header("Content-Type", "application/json")<br/>                .build();<br/>        HttpResponse.BodyHandler&lt;String&gt; handler = HttpResponse.BodyHandlers.ofString();<br/>        return this.httpClient<br/>                .sendAsync(request, handler)<br/>                .thenApply(HttpResponse::body)<br/>                .thenApply(this::extractPosts);</span><span id="c2da" class="ml ld iq mh b gy mw mn l mo mp">    }</span><span id="88ee" class="ml ld iq mh b gy mw mn l mo mp">    /**<br/>     * @param s the GraphQL response, eg.<br/>     * @formatter:off<br/>     *          {<br/>     *              data:{<br/>     *                  allPosts: [<br/>     *                      {<br/>     *                      id:"xxxx",<br/>     *                      title:"test title",<br/>     *                      content:"content"<br/>     *                      }<br/>     *                  ]<br/>     *              }<br/>     *          }<br/>     * @formatter:on<br/>     * @return The parsed the list of post data.<br/>     */<br/>    List&lt;Post&gt; extractPosts(String s) {<br/>        var reader = new StringReader(s);<br/>        var json = Json.createReader(reader).read();<br/>        var pointer = Json.createPointer("/data/allPosts");<br/>        var jsonArray = (JsonArray) pointer.getValue(json);<br/>        //@formatter:off<br/>        return jsonb.fromJson(jsonArray.toString(), new TypeLiteral&lt;List&lt;Post&gt;&gt;() {}.getRawType());<br/>        //@formatter:on<br/>    }<br/>}</span></pre><p id="af3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了从GraphQL客户端响应中提取posts数据，我使用JSONP指针来定位<em class="mf"> posts </em> JSON数组，并通过JsonB将其转换为<code class="fe mx my mz mh b">List&lt;Post&gt;</code>。将<code class="fe mx my mz mh b">jsonp</code>扩展名添加到项目deps。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="2244" class="ml ld iq mh b gy mm mn l mo mp">mvn quarkus:add-extension -Dextensions="jsonp"</span></pre><blockquote class="mq mr ms"><p id="b5f7" class="jn jo mf jp b jq jr js jt ju jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj kk ij bi translated"><em class="iq"/>文本块<em class="iq">很适合构成多行字符串，但是有一个</em> <a class="ae kl" href="https://github.com/quarkusio/quarkus/issues/17667" rel="noopener ugc nofollow" target="_blank"> <em class="iq">问题</em> </a> <em class="iq">导致GraphQL模式解析失败。最后我添加了一个</em> <code class="fe mx my mz mh b"><em class="iq">replaceAll</em></code> <em class="iq">的方法来删除换行符来暂时克服这个问题。</em></p></blockquote><p id="1de9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">尝试调用该客户端的<code class="fe mx my mz mh b">getAllPosts</code>。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="2448" class="ml ld iq mh b gy mm mn l mo mp">@Inject<br/>JvmClient jvmClient;</span><span id="78a0" class="ml ld iq mh b gy mw mn l mo mp">this.jvmClient.getAllPosts()<br/>    .thenAccept(<br/>    	p -&gt; LOGGER.log(Level.INFO, "post from jvm client: {0}", p)<br/>	)<br/>    .whenComplete((d, e) -&gt; LOGGER.info("The request is done in the jvm client."))<br/>    .toCompletableFuture()<br/>    .join();</span></pre><p id="8e11" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行应用程序，您将在应用程序日志中看到以下内容。</p><pre class="kn ko kp kq gt mg mh mi mj aw mk bi"><span id="8502" class="ml ld iq mh b gy mm mn l mo mp">2021-06-03 20:21:01,662 INFO  [com.exa.dem.Main] (ForkJoinPool.commonPool-worker-7) post from jvm client: [{comments=[{id=e261e9cb-f06c-4989-bbb5-00319087496d, content=comment #1}, {id<br/>=7664a80f-0963-46c1-8955-c096d7609c1b, content=comment #2}], id=9ef6d49f-50bf-4973-a122-3ac56a1b8d41, title=title #1, content=test content of #1}, {comments=[{id=bf4e2553-cb59-4e87-bc8<br/>f-36360732a919, content=comment #1}, {id=165d6743-fd74-4ad5-8997-3853fb076403, content=comment #2}], id=0c5501eb-cb7e-42e2-9078-040af89e6310, title=title #2, content=test content of #2<br/>}, {comments=[], id=c61c6b62-584b-455f-a2a8-1a4253f832b7, title=title #3, content=test content of #3}, {comments=[{id=5963588f-fbe0-4c82-88f6-1011bb7538fe, content=comment #1}, {id=fea<br/>f4d21-e78b-4701-91bb-ea665a9a034c, content=comment #2}], id=37e28b7d-11fc-4587-920f-9415da1d93a3, title=title #4, content=test content of #4}]<br/>2021-06-03 20:21:01,662 INFO  [com.exa.dem.Main] (ForkJoinPool.commonPool-worker-7) The request is done in the jvm client.</span></pre><p id="a60f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">源代码中包含了由Jaxrs客户端实现的另一个版本。如果您对此感兴趣，可以亲自探索一下<a class="ae kl" href="https://github.com/hantsy/quarkus-sandbox/blob/master/graphql-client/src/main/java/com/example/demo/JaxrsClient.java" rel="noopener ugc nofollow" target="_blank"> JaxrsClient示例</a>。</p><h2 id="abc1" class="ml ld iq bd le na nb dn li nc nd dp lm jy ne nf lq kc ng nh lu kg ni nj ly nk bi translated">从我的Github 获得完整的源代码。</h2></div></div>    
</body>
</html>