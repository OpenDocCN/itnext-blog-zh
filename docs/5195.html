<html>
<head>
<title>Overcoming Terratest validation on complex outputs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">克服复杂输出的Terratest验证</h1>
<blockquote>原文：<a href="https://itnext.io/overcoming-terratest-validation-on-complex-outputs-be11fd586a69?source=collection_archive---------3-----------------------#2021-01-08">https://itnext.io/overcoming-terratest-validation-on-complex-outputs-be11fd586a69?source=collection_archive---------3-----------------------#2021-01-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c8f1d1a06cf919f665c7728ac5828bed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JMeezVtIS32DA8zf.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Gabs图书馆</figcaption></figure><p id="d6d1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为Terraform模块开发单元测试对于验证行为和进行回归测试至关重要。</p><p id="2b12" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">最近，我不得不在Terraform 0.14迁移期间对大约15个模块进行回归测试，这些测试是我的救命稻草。然而，我发现使用Terratest来验证模块的输出变得过于单调乏味，因为我们要公开完整的对象，并对各种属性、数组、映射、嵌套对象等进行验证。</p><p id="c72a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Terratest是一个golang库，允许您调用terraform模块(init/apply)，验证输出，然后拆除临时基础设施。terraform模块提供了许多<em class="la"> OutputXXXX </em>函数来从模块输出中提取数据，以便您可以执行断言。总的来说，它对于只有一个值或者只有一层深度的输出非常有效。一旦您开始输出完整的对象，所有的地狱打破松散试图铸造的数据。项目所有者<a class="ae lb" href="https://github.com/gruntwork-io/terratest/issues/709" rel="noopener ugc nofollow" target="_blank">也承认</a>对库嵌套的支持有限。</p><p id="0e63" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">沮丧之余，我做了一些研究，发现了一个JSON库，它可以很容易地定位属性，然后访问子结构。因为terratest允许以JSON格式输出数据…我找到匹配的了！</p><p id="2d00" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><a class="ae lb" href="https://github.com/Jeffail/gabs" rel="noopener ugc nofollow" target="_blank"> Gabs </a>库在寻找我想要验证的子属性、遍历地图和列表、以及大大简化和减少我必须做的转换数量方面一直是救命稻草。</p><p id="7543" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">作为一个例子，我有一个terraform模块，我在其中部署了一个Azure防火墙和一些预烘焙的防火墙规则，并且消费者还可以添加应用程序规则。从验证的角度来看，我想确保我嵌入的观点是经过检查的，并且在未来的变更中保持不变。</p><p id="142b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">感兴趣的项目:</p><ul class=""><li id="3100" class="lc ld iq ke b kf kg kj kk kn le kr lf kv lg kz lh li lj lk bi translated">公共IP —我允许创建多个公共IP并连接到防火墙(以增加吞吐量)。验证标记是否级联，确保SKU设置为标准，验证命名</li><li id="3da6" class="lc ld iq ke b kf ll kj lm kn ln kr lo kv lp kz lh li lj lk bi translated">防火墙—确保所有公共IP都连接到防火墙，确保威胁英特尔模式设置为拒绝。</li><li id="4394" class="lc ld iq ke b kf ll kj lm kn ln kr lo kv lp kz lh li lj lk bi translated">应用程序规则—确保终端用户定义的规则得到部署，验证可选属性</li></ul><p id="52b4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为了完成上面的验证，下面是展示许多Gabs功能的terratest代码示例。</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="a2e4" class="lz ma iq lv b gy mb mc l md me">package tests</span><span id="4edf" class="lz ma iq lv b gy mf mc l md me">import (<br/> "regexp"<br/> "testing"</span><span id="bf9a" class="lz ma iq lv b gy mf mc l md me">"github.com/Jeffail/gabs"<br/> "github.com/gruntwork-io/terratest/modules/terraform"<br/> "github.com/stretchr/testify/assert"<br/>)</span><span id="a9a4" class="lz ma iq lv b gy mf mc l md me">func TestModuleDeployment(t *testing.T) {<br/> t.Parallel()<br/> terraformOptions := &amp;terraform.Options{<br/>  TerraformDir: "../examples/",<br/> }</span><span id="fc28" class="lz ma iq lv b gy mf mc l md me">defer terraform.Destroy(t, terraformOptions)<br/> terraform.InitAndApply(t, terraformOptions)<br/> validateOutputs(t, terraformOptions)<br/>}</span><span id="cfbe" class="lz ma iq lv b gy mf mc l md me">func validateOutputs(t *testing.T, opts *terraform.Options) {<br/> jsonParsed, err := gabs.ParseJSON([]byte(terraform.OutputJson(t, opts, "")))<br/> if err != nil {<br/>  panic(err)<br/> }</span><span id="2657" class="lz ma iq lv b gy mf mc l md me">//Firewall Validation<br/> fw, _ := jsonParsed.JSONPointer("/firewall/value")<br/> assert.Equal(t, 4, len(fw.Search("ip_configuration").Children())) //Validate 4 IP Configurations are present<br/> for _, child := range fw.Search("ip_configuration").Children() {<br/>  assert.Regexp(t, regexp.MustCompile(`configuration-\d`), child.Search("name").Data().(string))<br/> }</span><span id="1dee" class="lz ma iq lv b gy mf mc l md me">assert.Equal(t, "ScPcFWL-egress_fw-azfw", fw.Search("name").Data().(string)) //FW naming convention based on input<br/> assert.Equal(t, "Deny", fw.Search("threat_intel_mode").Data().(string))      //Threat intelligence set to Deny<br/> assert.Equal(t, 2, len(fw.Search("zones").Children()))                       //Must have 2 zones in CanadaCentral</span><span id="0dfe" class="lz ma iq lv b gy mf mc l md me">//Public IP Validation<br/> pip, _ := jsonParsed.JSONPointer("/public_ip/value")<br/> assert.Equal(t, 4, len(pip.Children()))</span><span id="66b2" class="lz ma iq lv b gy mf mc l md me">for _, child := range pip.Children() {<br/>  assert.Equal(t, "Standard", child.Search("sku").Data().(string))                                      //Ensure the SKU is set to standard<br/>  assert.Equal(t, "true", child.Search("tags", "test").Data().(string))                                 //Ensure tags are cascaded to PIP<br/>  assert.Regexp(t, regexp.MustCompile(`ScPcFWL-egress_fw-pip\d`), child.Search("name").Data().(string)) //PIP naming<br/> }</span><span id="6ba1" class="lz ma iq lv b gy mf mc l md me">//Application Rules<br/> appRules, _ := jsonParsed.JSONPointer("/application_rules/value")<br/> assert.True(t, appRules.Exists("aks"))<br/> assert.True(t, appRules.Exists("packages"))<br/> assert.Equal(t, 2, len(appRules.Children())) //2 Rules passed in .. 2 rules created</span><span id="aa7b" class="lz ma iq lv b gy mf mc l md me">//All Passed in values should have priority greater than 200. Right now the priorities are not being enforced in the module<br/> for _, child := range appRules.Children() {<br/>  intValue, _ := child.S("priority").Data().(float64)<br/>  assert.GreaterOrEqual(t, intValue, float64(200))<br/> }</span><span id="678a" class="lz ma iq lv b gy mf mc l md me">//Description is an optional attribute. Ensuring it is populated when passed in<br/> descriptionPtr, _ := jsonParsed.JSONPointer("/application_rules/value/aks/rule/0/description")<br/> assert.Equal(t, "Sample Description", descriptionPtr.Data().(string))</span><span id="f4bd" class="lz ma iq lv b gy mf mc l md me">packageRules, _ := jsonParsed.JSONPointer("/application_rules/value/packages/rule")<br/> assert.Equal(t, 2, len(packageRules.Children())) // 2 rules for this application rule (docker &amp; ubuntu)<br/>}</span></pre><p id="da59" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我希望这对于通过使用Gabs库用Terratest扩展您的单元测试是有用的。</p></div></div>    
</body>
</html>