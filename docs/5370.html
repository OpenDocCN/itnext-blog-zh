<html>
<head>
<title>Firewall for Applications in Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes中应用程序的防火墙</h1>
<blockquote>原文：<a href="https://itnext.io/firewall-for-applications-in-kubernetes-af0acbe337da?source=collection_archive---------2-----------------------#2021-02-19">https://itnext.io/firewall-for-applications-in-kubernetes-af0acbe337da?source=collection_archive---------2-----------------------#2021-02-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="3d76" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇博客中，我们将探讨kubernetes的一个特性，它旨在提高集群中运行的应用程序的安全性</p><p id="ae3c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在kubernetes集群中，我们可以运行许多应用程序，每个应用程序都有多个副本。默认情况下，任何pod都可以与同一集群中运行的任何其他pod进行通信。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/fb8ac7ff068bcdfff46e22ccc8a2c21a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1022/format:webp/1*2dcI61BNhb5Ctyz8ZUCZrA.jpeg"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">集群中不同pod之间的通信</figcaption></figure><p id="72e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是不建议允许这样的特征存在。如果一个入侵者进入了一个容器，那么他/她就可以从被入侵容器内部进入所有的容器。因此，我们需要一个针对应用程序的防火墙，通过它可以决定是允许还是拒绝集群内部的流量(包括入站和出站流量)。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/4553c572b7321adcc6ae3c49953a1c98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1022/format:webp/1*RxZ9_Mp7o0iu1enmes8Clw.jpeg"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">k8s集群中的受限pod通信</figcaption></figure><p id="e070" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">拯救者来了，<strong class="jp ir"> <em class="kx">网络策略</em> </strong>帮助为运行在kubernetes集群中的应用程序创建防火墙。</p><p id="ac5f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们通过一些例子来了解对这种防火墙的需求以及网络策略如何帮助实现这一点。</p><h1 id="9022" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated"><strong class="ak">留言簿</strong></h1><p id="4848" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">考虑一个应用程序<strong class="jp ir"> <em class="kx">留言簿</em> </strong>具有如下3个不同的组件:</p><ul class=""><li id="4936" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mg mh mi mj bi translated">留言簿-用户界面(前端)</li><li id="e8aa" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">留言簿-api(后端)</li><li id="bdeb" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">留言簿-数据库(数据库)</li></ul><p id="92b1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这些组件之间的预期通信就像ui与api通信，api与db通信。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/0c7acf717a62758ee16069a2d9e5c3af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1088/format:webp/1*cIZzqGd4dqYBcQe2DJsiBA.jpeg"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">留言簿单元之间的预期通信</figcaption></figure><p id="7c3e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，当留言簿应用程序的所有这些组件都运行在kubernetes集群中时，从技术上讲，ui组件在默认情况下可以与db通信。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/01e46704dcb80505908ff9d04130b3fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1088/format:webp/1*0gXVU5ssiIx6FkYMJQE8Dw.jpeg"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">guestbook-ui pod可以访问db pod，这是不期望的</figcaption></figure><h1 id="9c1c" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated"><strong class="ak">使用网络策略为集群中的应用程序设置防火墙</strong></h1><blockquote class="mq mr ms"><p id="cbd5" class="jn jo kx jp b jq jr js jt ju jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj kk ij bi translated">由于网络策略是应该由网络插件实现的功能，请确保您的网络插件支持网络策略资源。创建没有此类插件的网络策略资源将不起作用。Calico、Cilium、Kube-router、Romana和Weave Net是一些支持网络策略的网络插件</p></blockquote><p id="47f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，通过在所有名称空间中创建如下网络策略，禁用允许kubernetes集群中运行的所有pods之间进行所有通信的默认行为。</p><pre class="km kn ko kp gt mw mx my mz aw na bi"><span id="6fb7" class="nb kz iq mx b gy nc nd l ne nf">apiVersion: networking.k8s.io/v1</span><span id="e3dc" class="nb kz iq mx b gy ng nd l ne nf">kind: NetworkPolicy</span><span id="e149" class="nb kz iq mx b gy ng nd l ne nf">metadata:</span><span id="2968" class="nb kz iq mx b gy ng nd l ne nf">  name: deny-all</span><span id="5ace" class="nb kz iq mx b gy ng nd l ne nf">spec:</span><span id="2299" class="nb kz iq mx b gy ng nd l ne nf">  podSelector: {}</span><span id="7fa7" class="nb kz iq mx b gy ng nd l ne nf">  ingress: {}</span></pre><p id="087a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，没有一个pod可以与kubernetes集群中运行的任何其他pod通信。现在，根据要求，允许集群中的pod的入站/出站流量。</p><p id="9b4c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于留言簿应用程序，要允许流量进入<strong class="jp ir"> <em class="kx">留言簿-api </em> </strong>窗格，但只能从<strong class="jp ir"> <em class="kx">留言簿-ui </em> </strong>窗格进入，请创建如下网络策略。</p><pre class="km kn ko kp gt mw mx my mz aw na bi"><span id="a52c" class="nb kz iq mx b gy nc nd l ne nf">apiVersion: networking.k8s.io/v1</span><span id="ccc9" class="nb kz iq mx b gy ng nd l ne nf">kind: NetworkPolicy</span><span id="8563" class="nb kz iq mx b gy ng nd l ne nf">metadata:</span><span id="dc3e" class="nb kz iq mx b gy ng nd l ne nf">  name: allow-ui-to-api</span><span id="5c8a" class="nb kz iq mx b gy ng nd l ne nf">spec:</span><span id="a67b" class="nb kz iq mx b gy ng nd l ne nf">  podSelector:</span><span id="71b1" class="nb kz iq mx b gy ng nd l ne nf">    matchLabels:</span><span id="a30f" class="nb kz iq mx b gy ng nd l ne nf">      app: guestbook-api</span><span id="ce43" class="nb kz iq mx b gy ng nd l ne nf">      tier: backend</span><span id="0dd1" class="nb kz iq mx b gy ng nd l ne nf">  ingress:</span><span id="f5cd" class="nb kz iq mx b gy ng nd l ne nf">  - from:</span><span id="52e0" class="nb kz iq mx b gy ng nd l ne nf">      podSelector:</span><span id="f754" class="nb kz iq mx b gy ng nd l ne nf">        matchLabels:</span><span id="ab79" class="nb kz iq mx b gy ng nd l ne nf">          app: guestbook-ui</span><span id="d05a" class="nb kz iq mx b gy ng nd l ne nf">          tier: frontend</span></pre><p id="dab4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">并且允许进入流量到<strong class="jp ir"> <em class="kx">留言簿-db</em></strong>pod，但是只允许来自<strong class="jp ir"> <em class="kx">留言簿-API</em></strong>pod的流量，创建如下网络策略。</p><pre class="km kn ko kp gt mw mx my mz aw na bi"><span id="536d" class="nb kz iq mx b gy nc nd l ne nf">apiVersion: networking.k8s.io/v1</span><span id="8104" class="nb kz iq mx b gy ng nd l ne nf">kind: NetworkPolicy</span><span id="f471" class="nb kz iq mx b gy ng nd l ne nf">metadata:</span><span id="d436" class="nb kz iq mx b gy ng nd l ne nf">  name: allow-api-to-db</span><span id="fb6c" class="nb kz iq mx b gy ng nd l ne nf">spec:</span><span id="826d" class="nb kz iq mx b gy ng nd l ne nf">  podSelector:</span><span id="2df1" class="nb kz iq mx b gy ng nd l ne nf">    matchLabels:</span><span id="2193" class="nb kz iq mx b gy ng nd l ne nf">      app: guestbook-db</span><span id="3bf8" class="nb kz iq mx b gy ng nd l ne nf">      tier: db</span><span id="3625" class="nb kz iq mx b gy ng nd l ne nf">  ingress:</span><span id="1ca7" class="nb kz iq mx b gy ng nd l ne nf">  - from:</span><span id="72e0" class="nb kz iq mx b gy ng nd l ne nf">      podSelector:</span><span id="07db" class="nb kz iq mx b gy ng nd l ne nf">        matchLabels:</span><span id="1bf0" class="nb kz iq mx b gy ng nd l ne nf">          app: guestbook-api</span><span id="5746" class="nb kz iq mx b gy ng nd l ne nf">          tier: backend</span></pre><p id="a0f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用这些网络策略的最终设置只允许pod之间的有效通信</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/daaf28f9120b0e353766415b056a6a66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1088/format:webp/1*Me7UP1ZQqQsIScE6S3m8gQ.jpeg"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">留言簿-ui窗格无法按预期访问数据库窗格</figcaption></figure><h1 id="8175" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated"><strong class="ak">关于网络政策的更多信息</strong></h1><h2 id="e4a1" class="nb kz iq bd la nh ni dn le nj nk dp li jy nl nm lm kc nn no lq kg np nq lu nr bi translated"><strong class="ak">命名空间选择者</strong></h2><p id="2326" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">在某些情况下，我们必须允许从名称空间中的任何pod进入。例如，所有应用程序单元都应该允许来自<strong class="jp ir"> <em class="kx">监控</em> </strong>名称空间中所有单元的进入。可以使用名称空间选择器轻松实现这种设置，如下所示。</p><pre class="km kn ko kp gt mw mx my mz aw na bi"><span id="897e" class="nb kz iq mx b gy nc nd l ne nf">apiVersion: networking.k8s.io/v1</span><span id="2700" class="nb kz iq mx b gy ng nd l ne nf">kind: NetworkPolicy</span><span id="2eea" class="nb kz iq mx b gy ng nd l ne nf">metadata:</span><span id="63e4" class="nb kz iq mx b gy ng nd l ne nf">  name: allow-monitoring-namespace</span><span id="16b4" class="nb kz iq mx b gy ng nd l ne nf">spec:</span><span id="647d" class="nb kz iq mx b gy ng nd l ne nf">  podSelector: {} ## applies to all pods in the namespace</span><span id="389f" class="nb kz iq mx b gy ng nd l ne nf">    ingress:</span><span id="e7dd" class="nb kz iq mx b gy ng nd l ne nf">    - from:</span><span id="165a" class="nb kz iq mx b gy ng nd l ne nf">        namespaceSelector:</span><span id="03a8" class="nb kz iq mx b gy ng nd l ne nf">          matchLabels:</span><span id="ea04" class="nb kz iq mx b gy ng nd l ne nf">            team: monitoring ## labels of the monitoring namespace</span></pre><h2 id="4c66" class="nb kz iq bd la nh ni dn le nj nk dp li jy nl nm lm kc nn no lq kg np nq lu nr bi translated"><strong class="ak"> IP块</strong></h2><p id="2f90" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">不仅仅是标签，网络策略还允许使用IP块进行配置。以下网络策略允许来自10.72.X.X的进入，但阻止来自10.72.10.X的流量</p><pre class="km kn ko kp gt mw mx my mz aw na bi"><span id="21d2" class="nb kz iq mx b gy nc nd l ne nf">apiVersion: networking.k8s.io/v1</span><span id="1bdb" class="nb kz iq mx b gy ng nd l ne nf">kind: NetworkPolicy</span><span id="9c72" class="nb kz iq mx b gy ng nd l ne nf">metadata:</span><span id="b09d" class="nb kz iq mx b gy ng nd l ne nf">  name: allow-using-ip</span><span id="ab6d" class="nb kz iq mx b gy ng nd l ne nf">spec:</span><span id="fe23" class="nb kz iq mx b gy ng nd l ne nf">  podSelector: {}</span><span id="b8da" class="nb kz iq mx b gy ng nd l ne nf">    ingress:</span><span id="b030" class="nb kz iq mx b gy ng nd l ne nf">    - from:</span><span id="225e" class="nb kz iq mx b gy ng nd l ne nf">        ipBlock:</span><span id="595b" class="nb kz iq mx b gy ng nd l ne nf">          cidr: 10.72.0.0/16</span><span id="2714" class="nb kz iq mx b gy ng nd l ne nf">          except: 10.72.10.0/8</span></pre><h1 id="21d1" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated"><strong class="ak">结论</strong></h1><p id="54cc" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">k8s集群各个级别都有安全就好。为kubernetes集群中的应用程序单元添加防火墙可以减少攻击面，从而提高安全性，因此强烈建议这样做。</p></div><div class="ab cl ns nt hu nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ij ik il im in"><p id="f3d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kx">最初发布于</em><a class="ae nz" href="https://www.prabhujayakumar.dev/blog/save-your-k8s-cluster-from-dos/" rel="noopener ugc nofollow" target="_blank"><em class="kx">https://www . prabhujayakumar . dev</em></a><em class="kx">。</em></p></div></div>    
</body>
</html>