<html>
<head>
<title>BOX API Integration With RubyOnRails (OAuth 2.0)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BOX API与RubyOnRails的集成(OAuth 2.0)</h1>
<blockquote>原文：<a href="https://itnext.io/box-api-integration-with-rubyonrails-oauth-2-0-6d6626432491?source=collection_archive---------0-----------------------#2017-12-08">https://itnext.io/box-api-integration-with-rubyonrails-oauth-2-0-6d6626432491?source=collection_archive---------0-----------------------#2017-12-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f57eb66db2f6eca46cbee11a33afd49a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BmHCkATT0tGIg8f4RXd5Cw.jpeg"/></div></div></figure><p id="3504" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">使用OAuth 2.0登录</strong></p><div class="kw kx gp gr ky kz"><a href="https://www.box.com/" rel="noopener  ugc nofollow" target="_blank"><div class="la ab fo"><div class="lb ab lc cl cj ld"><h2 class="bd ir gy z fp le fr fs lf fu fw ip bi translated">安全的文件共享、存储和协作|盒子</h2><div class="lg l"><h3 class="bd b gy z fp le fr fs lf fu fw dk translated">从简单的文件共享到构建定制应用，Box正在改变您管理整个企业内容的方式。</h3></div><div class="lh l"><p class="bd b dl z fp le fr fs lf fu fw dk translated">www.box.com</p></div></div><div class="li l"><div class="lj l lk ll lm li ln jw kz"/></div></div></a></div><p id="e500" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">框|为企业提供安全的内容和在线文件共享</p><p id="08c5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae lo" href="https://www.linkedin.com/cws/share?url=https%3A%2F%2Fitnext.io%2Fbox-api-integration-with-rubyonrails-oauth-2–0–6d6626432491" rel="noopener ugc nofollow" target="_blank"> <em class="lp">点击这里在LinkedIn </em> </a>上分享这篇文章</p><p id="6f04" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Box为个人、团队和企业提供安全的内容管理和协作，实现安全的文件共享和在线文件访问。</p><p id="0ca8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">OAuth2.0请参考以下链接:<br/><a class="ae lo" href="http://www.bubblecode.net/en/2016/01/22/understanding-oauth2/" rel="noopener ugc nofollow" target="_blank">http://www . bubble code . net/en/2016/01/22/understanding-oauth 2/</a></p><p id="3ce3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要配置BOX中的应用程序，请按照下列步骤操作:</p><p id="4ff2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">第一步:</strong>创建开发者账户</p><p id="52ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae lo" href="https://app.box.com/signup/o/default_developer_offer" rel="noopener ugc nofollow" target="_blank">https://app.box.com/signup/o/default_developer_offer</a></p><p id="694b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你忽视了。</p><p id="e941" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">步骤2: </strong>遵循以下链接中的步骤:</p><p id="6d7e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae lo" href="https://box-content.readme.io/docs/oauth-20" rel="noopener ugc nofollow" target="_blank">https://box-content.readme.io/docs/oauth-20</a></p><p id="c0fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">第三步:</strong>完成BOX中的app设置后，创建一个rails应用。让我们假设，控制器名是box_api_controller.rb</p><p id="9d1d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在box_api_controller.rb文件中，</p><h1 id="1060" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">登录时创建请求按钮</h1><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="065a" class="mx lr iq mt b gy my mz l na nb">def make_request<br/>    #Check access token expire or not.<br/>    check_access_token_expire = check_access_token_expire_dt<br/>    if check_access_token_expire.split("-")[0] == "access_token"<br/>        #Create client by passing Token<br/>        @box_client = Boxr::Client.new(check_access_token_expire.split("-")[1])<br/>        cookies[:token] = check_access_token_expire.split("-")[1]<br/>    else<br/>        if check_access_token_expire.split("-")[0] == "refresh_token"<br/>            #Call method<br/>            create_post_req_url("refresh_token","refresh_token",check_access_token_expire.split("-")[1])<br/>        else<br/>            # kick off authorization flow<br/>            parameters = "response_type=code&amp;client_id=&lt;your client id&gt;&amp;redirect_uri=&lt;your application url&gt;/handle_user_decision/&amp;state=security_token"<br/>            url = "https://account.box.com/api/oauth2/authorize?#{parameters}"<br/>            redirect_to url<br/>        end<br/>    end end<br/><br/>##After authorized the client id, get code in response<br/>    def handle_user_decision<br/>    # kick off authorization flow<br/>    #Get authorization code<br/>    code_url = Rack::Utils.parse_query URI(request.original_url).query<br/>    code = code_url["code"] <br/>    #Call method<br/>    create_post_req_url("authorization_code","code", code) <br/>end</span></pre><h1 id="1c39" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">创建帖子URL</h1><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="a2fe" class="mx lr iq mt b gy my mz l na nb">def create_post_req_url(grant_type,header, code)<br/>    #Set oauth2 url<br/>    uri = URI.parse("https://api.box.com//oauth2//token")<br/>    #Passing parameter<br/>    data = "grant_type=#{grant_type}&amp;#{header}=#{code}&amp;client_id=&lt;your client id&gt;&amp;client_secret=&lt;your client secret key&gt;"<br/>    #Set header<br/>    headers = {"Content-Type" =&gt; "application/x-www-form-urlencoded"}<br/>    #Get http request<br/>    http = Net::HTTP.new(uri.host,uri.port)<br/>    http.use_ssl = true<br/>    http.verify_mode = OpenSSL::SSL::VERIFY_NONE<br/>    #Do post the URL<br/>    response = http.post(uri.path,data.to_s,headers)<br/>    #Check response<br/>    if response.code != "200"<br/>        flash[:alert] ="エラーが発生しました。管理者に連絡してください。エラーの内容：#{response.code}  #{JSON.parse(response.body)}"<br/>    else<br/>        #flash[:alert] ="#{response.body.to_json}"<br/>        parsed = JSON.parse(response.body) # returns a hash<br/>        token = parsed["access_token"]<br/>        cookies[:token] = nil<br/>        cookies[:token] = token      <br/>        if grant_type == "authorization_code"<br/>            #Insert BOX access token details<br/>            user = "&lt;your drive user name&gt;"<br/>            insert_access_token(user, token, parsed["refresh_token"], Time.now)<br/>        else<br/>            if grant_type == "refresh_token"<br/>                #Update BOX access token <br/>                updt_access_token(user, token, code, parsed["refresh_token"], Time.now)<br/>            end  <br/>        end<br/>        redirect_to box_api_index_path<br/>    end<br/>end</span></pre><p id="ea42" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">其他辅助方法:-</p><h1 id="f244" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">检查访问令牌是否过期。</h1><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="fc27" class="mx lr iq mt b gy my mz l na nb">def check_access_token_expire_dt<br/>    @access_token_time = BoxApiAccessToken.getaccesstokentime<br/>    if !@access_token_time.blank?<br/>        @access_token_time.each do |token_details |<br/>            if token_details.access_token_dt != nil<br/>                if token_details.new_access_token_dt.to_datetime.new_offset(Rational(9, 24)).strftime('%Y/%m/%d %H:%M') &lt; Time.now.to_datetime.new_offset(Rational(9, 24)).strftime('%Y/%m/%d %H:%M')<br/>                    check_access_token_expire_dt = "refresh_token-#{token_details.refresh_access_token}"<br/>                    return check_access_token_expire_dt<br/>                else<br/>                    check_access_token_expire_dt = "access_token-#{token_details.access_token}"<br/>                    return check_access_token_expire_dt<br/>                end<br/>            else<br/>                check_access_token_expire_dt = "new_token-req_new_token"<br/>                return check_access_token_expire_dt<br/>            end<br/>        end<br/>    else<br/>        check_access_token_expire_dt = "new_token-req_new_token"<br/>        return check_access_token_expire_dt<br/>    end<br/>end</span></pre><h1 id="d877" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">在数据库中插入访问令牌详细信息</h1><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="7d29" class="mx lr iq mt b gy my mz l na nb">def insert_access_token(user,access_token,refresh_access_token,access_token_dt)<br/>    @box_access_token = BoxApiAccessToken.new(<br/>            :user =&gt; user,<br/>            :access_token =&gt; access_token,<br/>            :refresh_access_token =&gt; refresh_access_token,<br/>            :access_token_dt =&gt; access_token_dt)<br/><br/>            #Save User Device Data<br/>            @box_access_token.save<br/>end<br/><br/>#Update access_token,refresh_access_token,access_token_dt details in DB<br/>    def updt_access_token(user,access_token, refresh_access_token,new_refresh_access_token,access_token_dt)<br/>    #@box_access_token_updt = BoxApiAccessToken.find_refresh_access_token(refresh_access_token)<br/>    @box_access_token_updt = BoxApiAccessToken.find_by_refresh_access_token(refresh_access_token)<br/>    attributes = {:access_token =&gt; access_token,:access_token_dt =&gt; access_token_dt, :refresh_access_token =&gt; new_refresh_access_token, :updated_at =&gt; access_token_dt}<br/>    #Update the object<br/>    @box_access_token_updt.update_attributes(attributes)<br/>end</span></pre><p id="9f5b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在模型中，</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="0f16" class="mx lr iq mt b gy my mz l na nb">class BoxApiAccessToken &lt; ActiveRecord::Base<br/>    scope :getaccesstokentime, lambda { <br/>select("id,access_token,refresh_access_token,substring(cast(access_token_dt as varchar),0,17) as access_token_dt,substring(cast(access_token_dt + interval '60 minute' as varchar),0,17) as new_access_token_dt ").order(:id =&gt; "desc").limit(1)<br/>    }   <br/>end</span></pre><h1 id="c181" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">在index.html.erb文件中</h1><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="2dc7" class="mx lr iq mt b gy my mz l na nb">&lt;%= form_tag(:controller =&gt; "box_api", :action =&gt; 'make_request') do |f| %&gt;<br/>&lt;div class="form-group"&gt;&lt;%= submit_tag("Box Login", class: "btn btn-primary") %&gt;&lt;/div&gt;&lt;% end %&gt;</span></pre></div><div class="ab cl nc nd hu ne" role="separator"><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh"/></div><div class="ij ik il im in"><h1 id="6b47" class="lq lr iq bd ls lt nj lv lw lx nk lz ma mb nl md me mf nm mh mi mj nn ml mm mn bi translated">这是我的迁移文件</h1><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="ec73" class="mx lr iq mt b gy my mz l na nb">class CreateBoxApiAccessTokens &lt; ActiveRecord::Migration<br/>    def change<br/>        create_table :box_api_access_tokens do |t|<br/>            t.string :user, :limit =&gt; 100, :null =&gt; false<br/>            t.string :access_token, :limit =&gt; 500<br/>            t.string :refresh_access_token, :limit =&gt; 500<br/>            t.datetime :access_token_dt, :limit =&gt; 50<br/>            t.datetime :created_at, :null =&gt; false<br/>            t.string :created_by, :limit =&gt; 50<br/>            t.datetime :updated_at<br/>            t.string :updated_by, :limit =&gt; 50<br/>            t.boolean :del_flag, :default =&gt; false      <br/>            end<br/>        execute 'alter table box_api_access_tokens alter column created_at set default now()'<br/>    end<br/>end</span></pre><p id="bd67" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意，使用访问和刷新令牌时，access_token是发出API请求所需的实际字符串。每个access_token的有效期为1小时。为了获得新的有效令牌，您可以使用附带的refresh_token。每个refresh_token在60天内只能使用一次。每次您使用refresh_token获得新的access_token时，我们都会将您的计时器重置为60天，并发给您一个新的refresh_token。</p><p id="805b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这意味着只要您的用户每60天使用一次您的应用程序，他们的登录就永远有效。</p><p id="1356" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有关更多详细信息，请参考BOX API文档。</p><p id="b6f5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">享受编码。</p><h2 id="3f08" class="mx lr iq bd ls no np dn lw nq nr dp ma kj ns nt me kn nu nv mi kr nw nx mm ny bi translated">感谢并致以最诚挚的问候</h2></div><div class="ab cl nc nd hu ne" role="separator"><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh"/></div><div class="ij ik il im in"><p id="e5e2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="lp">原载于【qiita.com】<a class="ae lo" href="https://qiita.com/alokrawat050/items/3028c89b9e449a6f614e" rel="noopener ugc nofollow" target="_blank"><em class="lp"/></a><em class="lp">。</em></em></p></div></div>    
</body>
</html>