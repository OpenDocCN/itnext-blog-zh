<html>
<head>
<title>Protecting Kubernetes insecure endpoints with Gitlab and OAauth2 proxy.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Gitlab和OAauth2代理保护Kubernetes不安全的端点。</h1>
<blockquote>原文：<a href="https://itnext.io/protecting-kubernetes-insecure-endpoints-with-gitlab-and-oaauth2-proxy-64c1b73996ef?source=collection_archive---------3-----------------------#2021-08-31">https://itnext.io/protecting-kubernetes-insecure-endpoints-with-gitlab-and-oaauth2-proxy-64c1b73996ef?source=collection_archive---------3-----------------------#2021-08-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/a3dc3b11437812025f164d9b00e332b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1yB21N3v75qpKVynzJ73fQ.png"/></div></div></figure><p id="68cb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最近，我一直致力于OAuth流的实现。我有点惊讶/恼火，这样一个相对简单的任务怎么能轻易地花去一整天。有相当模糊的文档和一些OAauth 2代理的docker图像“不工作”。不应该这么费时间。这就是为什么，对于可能面临同样情况的人，我将提供一个明确的实现指南。我会尽量缩短它。:)</p><p id="3f8e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">警告！不要用这个例子<a class="ae kw" href="https://kubernetes.github.io/ingress-nginx/examples/auth/oauth-external-auth/" rel="noopener ugc nofollow" target="_blank">https://kubernetes . github . io/ingress-nginx/examples/auth/oauth-external-auth/</a>。</p><p id="594c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该流描述了一个服务使用两个入口对象。我们不需要这个。</p><p id="6797" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这种方法只会将您绑定到一个服务。同时，我们希望为任何服务构建一个集中部署。</p><p id="8dfa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们有什么？</p><ul class=""><li id="0e3a" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">K8s默认情况下不支持oauth的不安全端点。(在我的情况下，kibana的k8s入口)</li><li id="a620" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">Gitlab作为oauth提供者</li><li id="d469" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">oauth 2-代理https://github.com/oauth2-proxy/oauth2-proxy(一个反向代理和静态文件服务器，为众多提供者提供身份验证)</li></ul><p id="068c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">流量:</strong></p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ll"><img src="../Images/5997ec283fdf0e14d6acac28ba0d46ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eBBRFXvXpBMba5Mb"/></div></div></figure><p id="d43b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">第一步。)为oauth代理创建Gitlab应用程序</strong></p><p id="8195" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Gitlab中创建应用程序。(管理部分— -&gt;应用程序)</p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lq"><img src="../Images/a9b7613e67d8483ec67ba845f0e6145e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KQOAvSAkCM-Al89q"/></div></div></figure><p id="fbc1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Gitlab将为您提供ClientID和一个我们稍后会用到的秘密。</p><p id="f4d4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">生成cookie密码:</p><blockquote class="lr ls lt"><p id="c216" class="jy jz lu ka b kb kc kd ke kf kg kh ki lv kk kl km lw ko kp kq lx ks kt ku kv ij bi translated">python -c '导入os，base64' print base64 . b 64 encode(OS . urandom(16))'</p></blockquote><p id="3264" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">第二步。)配置舵图。</strong></p><figure class="lm ln lo lp gt jr"><div class="bz fp l di"><div class="ly lz l"/></div></figure><pre class="lm ln lo lp gt ma mb mc md aw me bi"><span id="a036" class="mf mg iq mb b gy mh mi l mj mk"><strong class="mb ir">Step 3.) Deploy</strong></span><span id="2b6b" class="mf mg iq mb b gy ml mi l mj mk">helm repo add oauth2-proxy https://oauth2-proxy.github.io/manifests</span><span id="5534" class="mf mg iq mb b gy ml mi l mj mk">helm repo update</span><span id="a401" class="mf mg iq mb b gy ml mi l mj mk">helm install oauth2-proxy oauth2-proxy/oauth2-proxy -f oauth2-values.yaml </span></pre><p id="c105" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">第四步。)保护您的服务。</strong></p><p id="b32a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">kibana-ingress.yaml:</p><figure class="lm ln lo lp gt jr"><div class="bz fp l di"><div class="ly lz l"/></div></figure><pre class="lm ln lo lp gt ma mb mc md aw me bi"><span id="dea1" class="mf mg iq mb b gy mh mi l mj mk">kubectl create -f kibana-ingress.yaml</span></pre><p id="1be5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">第五步。享受吧。</strong></p><p id="8e07" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尝试在浏览器中输入kibana.yourdomain.com。你应该看到Gitlab认证页面。</p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lq"><img src="../Images/fcb5cc6fc73e94d13f4266f1a4e4207a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9c3_dxBDe1BafuHD"/></div></div></figure><p id="bc93" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">警告:</strong></p><p id="2448" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有时，您会得到一个与OAuth2代理无法创建或加载cookie会话相关的错误。不要惊慌。只需尝试另一个quay.io/oauth2-proxy/oauth2-proxy"图像标签。那是一个内部错误。有一个golang补丁修复了这个东西，但这是一个不同的仙女尾巴:)</p></div></div>    
</body>
</html>