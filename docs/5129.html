<html>
<head>
<title>GKE managed SSL certificates — in action</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GKE管理的SSL证书——实际应用</h1>
<blockquote>原文：<a href="https://itnext.io/gke-managed-ssl-certificates-in-action-4b533fb3ca22?source=collection_archive---------5-----------------------#2020-12-17">https://itnext.io/gke-managed-ssl-certificates-in-action-4b533fb3ca22?source=collection_archive---------5-----------------------#2020-12-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="gh gi ju"><img src="../Images/da533a779009593b297abae843757e84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IAgY_VnwrnhFhUrM"/></div></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk translated">由<a class="ae kk" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae kk" href="https://unsplash.com/@loicleray?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Loic Leray </a>拍摄的照片</figcaption></figure><p id="032d" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果你正在编写一个api网关，你需要TLS终止(https请求)，你可能不想自己管理SSL证书(由所有互联网信任的人签名的公钥)。如果你用GKE。一个简单的解决方案是使用一个k8s入口一个名为<strong class="kn ir"><em class="lj">managed certificate</em></strong><em class="lj"/>的CRD和几个注释，所有<a class="ae kk" href="https://cloud.google.com/kubernetes-engine/docs/how-to/managed-certs" rel="noopener ugc nofollow" target="_blank">你需要做的就是按照文档</a>做，我就是这么做的，并且偶然发现了如此多的问题，这变得非常痛苦。谷歌在实现这个功能方面做得很好，但是在记录方面做得很差。在这篇文章中，我将尝试走一遍设置过程。</p><blockquote class="lk ll lm"><p id="90b1" class="kl km lj kn b ko kp kq kr ks kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh li ij bi translated">TL；dr — <a class="ae kk" href="https://github.com/viggin543/gke_managed_ssl_ingress_chart" rel="noopener ugc nofollow" target="_blank">这是这篇文章描述的所有内容的导航图。</a>——(可与<a class="ae kk" href="https://argoproj.github.io/argo-cd/" rel="noopener ugc nofollow" target="_blank"> argocd </a>一起使用，可视化游戏中的实体)</p></blockquote><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="gh gi lq"><img src="../Images/8b7bd4d9e094d01d089b09dc6acc6d82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qgL87saH7pY3z-pov9yfMw.png"/></div></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk translated">argocd在集群上应用舵图</figcaption></figure><h2 id="9992" class="lr ls iq bd lt lu lv dn lw lx ly dp lz kw ma mb mc la md me mf le mg mh mi mj bi translated">静态ip</h2><p id="6028" class="pw-post-body-paragraph kl km iq kn b ko mk kq kr ks ml ku kv kw mm ky kz la mn lc ld le mo lg lh li ij bi translated">简单的部分，保留一个IP在GCP，并分配给它一个DNS记录。</p><pre class="jv jw jx jy gt mp mq mr ms aw mt bi"><span id="f39c" class="lr ls iq mq b gy mu mv l mw mx"><em class="lj">gcloud </em>compute addresses create reserved-ip-name<em class="lj"> </em>--global<br/><em class="lj">gcloud </em>compute addresses describe reserved-ip-name<em class="lj"> </em>--global<br/><br/><em class="lj">gcloud </em>dns record-sets transaction start --zone=<em class="lj">&lt;</em>ZONE NAME<em class="lj">&gt;<br/>gcloud </em>dns record-sets transaction add 79.179.75.123 --name=<em class="lj">bannana.com </em>--ttl=300  --type=A --zone=<em class="lj">&lt;</em>ZONE NAME<em class="lj">&gt;<br/>gcloud </em>dns record-sets transaction execute --zone=<em class="lj">&lt;</em>ZONE NAME<em class="lj">&gt;</em></span></pre><p id="e7f4" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><em class="lj"> ZONE_NAME </em>是GCP dns托管区域的名称，这里唯一值得一提的是，GCP DNS托管区域应该连接到某个公共DNS服务器。(托管区域应连接到互联网……)</p><h2 id="8849" class="lr ls iq bd lt lu lv dn lw lx ly dp lz kw ma mb mc la md me mf le mg mh mi mj bi translated">托管证书资源</h2><p id="171b" class="pw-post-body-paragraph kl km iq kn b ko mk kq kr ks ml ku kv kw mm ky kz la mn lc ld le mo lg lh li ij bi translated">如果你正在使用GKE，谷歌在你不知情的情况下在你的集群中安装了一个名为<strong class="kn ir"><em class="lj">managed certificate</em></strong><em class="lj"/>的CRD。这个资源真的很简单。</p><pre class="jv jw jx jy gt mp mq mr ms aw mt bi"><span id="e6f0" class="lr ls iq mq b gy mu mv l mw mx"><em class="lj">apiVersion</em>: networking.gke.io/v1<br/><em class="lj">kind</em>: ManagedCertificate<br/><em class="lj">metadata</em>:<br/>  <em class="lj">name</em>: banana-cert<br/><em class="lj">spec</em>:<br/>  <em class="lj">domains</em>:<br/>    - banana.com</span></pre><p id="7ac8" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">当您将它应用到集群时，它应该立即反映以下事件。</p><pre class="jv jw jx jy gt mp mq mr ms aw mt bi"><span id="3d92" class="lr ls iq mq b gy mu mv l mw mx">kubectl apply -f managedCert.yaml</span><span id="6297" class="lr ls iq mq b gy my mv l mw mx">kubectl describe ManagedCertificate some-valid-dns-name</span><span id="3dd1" class="lr ls iq mq b gy my mv l mw mx">API Version:  networking.gke.io/v1<br/>Kind:         ManagedCertificate<br/>Metadata:<br/>  Creation Timestamp:  2020-12-16T10:13:12Z<br/>  Generation:          2<br/>  Resource Version:    57704800<br/>  Self Link:           /apis/networking.gke.io/v1/namespaces/******/managedcertificates/adika-storefront-prod<br/>  UID:                 *****<br/>Spec:<br/>  Domains:<br/>    banana.com<br/>Status:<br/>  Certificate Name:    mcrt-*******************<br/>  Certificate Status:  Provisioning<br/>  Domain Status:<br/>    Domain:  banana.com<br/>    Status:  Provisioning<br/>Events:<br/>  Type    Reason  Age   From                            Message<br/>  ----    ------  ----  ----                            -------<br/>  Normal  Create  32s   managed-certificate-controller  Create SslCertificate mcrt-some-uuid-here</span></pre><p id="d397" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kn ir">“创建”</strong>事件，通知<strong class="kn ir"> <em class="lj">状态:准备</em> </strong>。这意味着<strong class="kn ir"> <em class="lj">托管证书控制器、</em></strong>k8s控制器<a class="ae kk" href="https://github.com/GoogleCloudPlatform/gke-managed-certs" rel="noopener ugc nofollow" target="_blank">(链接到回购)</a>。那就是管理<strong class="kn ir"><em class="lj">managed certificate</em></strong>资源。开始工作。如果在<strong class="kn ir"><em class="lj">kubectl describe</em></strong>命令的events部分看不到任何东西，这意味着有问题。要么您的集群版本不是最新的，要么您今天运气不好，您需要以某种方式唤醒这个控制器，例如通过升级您的集群版本(这是我必须做的)。</p><p id="7334" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在应用k8s资源之后，应该立即在GCP创建一个托管证书实体。你可以通过跑步得到它</p><pre class="jv jw jx jy gt mp mq mr ms aw mt bi"><span id="7aca" class="lr ls iq mq b gy mu mv l mw mx">gcloud beta compute ssl-certificates list</span></pre><p id="5cf9" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这应该会打印出您的kubectl describe命令中列出的证书名称<strong class="kn ir"><em class="lj">mcrt-some-uuid-here</em></strong>。此外，证书名称应该是一个有效的dns名称，除了[a-z][A-z]之外不能有其他字符。-[0–9].如果这不起作用，并且在应用了<strong class="kn ir"><em class="lj">managed certificate</em></strong>之后，GCP负载平衡器证书未被创建。不要继续。</p><h2 id="bb43" class="lr ls iq bd lt lu lv dn lw lx ly dp lz kw ma mb mc la md me mf le mg mh mi mj bi translated">入口</h2><p id="467c" class="pw-post-body-paragraph kl km iq kn b ko mk kq kr ks ml ku kv kw mm ky kz la mn lc ld le mo lg lh li ij bi translated">接下来您需要的是一个<strong class="kn ir"> <em class="lj"> K8S入口</em> </strong>，它将通过一个注释链接到<strong class="kn ir"><em class="lj">managed certificate</em></strong>，并链接到一个节点端口服务(不要尝试其他服务类型..)将在端口80上侦听，并在“/”路径上用200来回答GET请求。(你希望他们把它写在文件里……)</p><pre class="jv jw jx jy gt mp mq mr ms aw mt bi"><span id="0bd5" class="lr ls iq mq b gy mu mv l mw mx"><em class="lj">apiVersion</em>: networking.k8s.io/v1beta1<br/><em class="lj">kind</em>: Ingress<br/><em class="lj">metadata</em>:<br/>  <em class="lj">name</em>: ingress-name<br/>  <em class="lj">annotations</em>:<br/>    <em class="lj">kubernetes.io/ingress.global-static-ip-name</em>: reserved-ip-name<br/>    <em class="lj">networking.gke.io/managed-certificates</em>: banana-cert<br/>    <em class="lj">kubernetes.io/ingress.allow-http</em>: "false" <br/># a bonus, disablles http on the load balancer<br/><em class="lj">spec</em>:<br/>  <em class="lj">rules</em>:<br/>  - <em class="lj">host</em>: banana.com<br/>    <em class="lj">http</em>:<br/>      <em class="lj">paths</em>:<br/>        - <em class="lj">path</em>: /*<br/>          <em class="lj">backend</em>:<br/>            <em class="lj">serviceName</em>: banan-service<br/>            <em class="lj">servicePort</em>: 80</span></pre><p id="22d3" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">现在，这里发生了一些事情。</p><p id="2cec" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kn ir">证书可以被激活(记住<em class="lj">状态:供应..)</em></strong></p><p id="3e6c" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">此外，配置托管证书的dns应该指向我们示例中的【kubernetes.io/ingress.global-static-ip-name.】<strong class="kn ir"><em class="lj">dig bannana.com，</em> </strong>应该解析为您预先创建的保留静态ip。</p><p id="7ad3" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">最后，入口指向<strong class="kn ir"> <em class="lj"> </em> </strong>的服务应该是<strong class="kn ir"> <em class="lj">节点端口</em> </strong>服务，它应该监听端口80。将创建一个GCP负载平衡器，它将通过在“/”路径上调用该服务来检查该服务的运行状况。所以确保它返回200。</p><p id="c807" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果一切正常，您创建的入口应该会收到GKE魔术的两个附加注释。</p><pre class="jv jw jx jy gt mp mq mr ms aw mt bi"><span id="1bc6" class="lr ls iq mq b gy mu mv l mw mx">ingress.gcp.kubernetes.io/pre-shared-cert: mcrt-some-uuid-here<br/>      ingress.kubernetes.io/backends:'{"k8sbe-":"HEALTHY","k8sbe":"HEALTHY"}'</span></pre><p id="4a52" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">第一个注释将入口与GCP负载平衡器证书链接起来，第二个注释描述了与其连接的健康后端。</p><p id="69e2" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果你幸存了这么久。恭喜，您已经有了一个连接到k8s集群中所有节点的GCP负载平衡器，它执行ssl终止和自动证书供应和轮换。</p><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="gh gi mz"><img src="../Images/c9a90d97c6d27d3c4cde6cdeea45b362.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q8JSU-r3TGe5wXuqoQy7pQ.png"/></div></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk translated">ssl终端负载平衡器</figcaption></figure><p id="490f" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">干杯！</p></div></div>    
</body>
</html>