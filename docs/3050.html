<html>
<head>
<title>How to add persistent storage to your Kubernetes apps using Azure Disk</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Azure Disk向您的Kubernetes应用添加持久存储</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-add-persistent-storage-to-your-kubernetes-apps-using-azure-disk-5eb081c1a31?source=collection_archive---------2-----------------------#2019-09-23">https://itnext.io/how-to-add-persistent-storage-to-your-kubernetes-apps-using-azure-disk-5eb081c1a31?source=collection_archive---------2-----------------------#2019-09-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/9cd931e2b34723530f2732b9162fdeab.png" data-original-src="https://miro.medium.com/v2/resize:fit:256/format:webp/1*1Cc99RF4vtCSKaHDgz_iyQ.png"/></div></figure><p id="3257" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这篇博文中，我们将看一个例子，如何使用<a class="ae ks" href="https://azure.microsoft.com/services/storage/disks/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure Disk </a>作为部署到<a class="ae ks" href="https://azure.microsoft.com/services/kubernetes-service/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure Kubernetes服务</a>的应用的存储介质。</p><p id="bb59" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您将:</p><ul class=""><li id="37ee" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ky kz la lb bi translated">在Azure上设置Kubernetes集群</li><li id="6f64" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">创建一个Azure磁盘和相应的<code class="fe lh li lj lk b">PersistentVolume</code></li><li id="41ef" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">为应用程序<code class="fe lh li lj lk b">Deployment</code>创建一个<code class="fe lh li lj lk b">PersistentVolumeClaim</code></li><li id="e9a7" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">测试一下，看看它是如何端到端工作的</li></ul><h1 id="0614" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">概观</h1><p id="5f02" class="pw-post-body-paragraph ju jv iq jw b jx mj jz ka kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr ij bi translated">您可以使用Kubernetes <code class="fe lh li lj lk b">Volume</code> s为您的应用程序提供存储。Kubernetes支持多种类型的卷。将它们分类的一种方法如下</p><ul class=""><li id="a7d2" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ky kz la lb bi translated"><strong class="jw ir">短暂的</strong> — <code class="fe lh li lj lk b">Volume</code>与<code class="fe lh li lj lk b">Pod</code>寿命紧密相关(如<code class="fe lh li lj lk b">emptyDir</code>卷)，即如果<code class="fe lh li lj lk b">Pod</code>被移除(出于任何原因)，它们将被删除。</li><li id="eaef" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><strong class="jw ir">持久性</strong> — <code class="fe lh li lj lk b">Volume</code>用于长期存储，独立于<code class="fe lh li lj lk b">Pod</code>或<code class="fe lh li lj lk b">Node</code>生命周期。在托管Kubernetes产品的情况下，这可能是<code class="fe lh li lj lk b">NFS</code>或基于云的存储，如Azure Kubernetes服务、Google Kubernetes引擎等。</li></ul><p id="221b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Kubernetes可以通过<code class="fe lh li lj lk b">static</code>或<code class="fe lh li lj lk b">dynamic</code>方式进行配置。在“静态”模式下，手动创建存储介质，例如Azure磁盘，然后使用如下的<code class="fe lh li lj lk b">Pod</code>规范进行引用:</p><pre class="mo mp mq mr gt ms lk mt mu aw mv bi"><span id="1218" class="mw lm iq lk b gy mx my l mz na">volumes:<br/>        - name: azure<br/>            azureDisk:<br/>            kind: Managed<br/>            diskName: myAKSDisk<br/>            diskURI: /subscriptions/&lt;subscriptionID&gt;/resourceGroups/MC_myAKSCluster_myAKSCluster_eastus/providers/Microsoft.Compute/disks/myAKSDisk</span></pre><blockquote class="nb nc nd"><p id="2ddd" class="ju jv ne jw b jx jy jz ka kb kc kd ke nf kg kh ki ng kk kl km nh ko kp kq kr ij bi translated"><em class="iq">我强烈推荐阅读关于如何</em> <a class="ae ks" href="https://docs.microsoft.com/azure/aks/azure-disk-volume?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq">“在Azure Kubernetes服务(AKS)中手动创建和使用带有Azure磁盘的卷”的优秀教程</em> </a></p></blockquote><h1 id="ff19" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">有没有更好的办法？</h1><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/bb1365afa141f04bd81a1306c3221c58.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/0*C3sS7kBW19Q_Setj.gif"/></div></figure><p id="fb34" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在上面的<code class="fe lh li lj lk b">Pod</code>清单中，存储信息直接在<code class="fe lh li lj lk b">Pod</code>中指定(使用<code class="fe lh li lj lk b">volumes</code>部分)。这意味着开发人员需要知道存储介质的所有细节，例如在Azure Disk的情况下——<code class="fe lh li lj lk b">diskName</code>、<code class="fe lh li lj lk b">diskURI</code>(磁盘资源URI)，它是<code class="fe lh li lj lk b">kind</code>(类型)。这里肯定有改进的余地，就像软件中的大多数事情一样，可以使用持久卷和持久卷声明的概念，通过另一个层次的间接或抽象来实现。</p><p id="d8d8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">关键思想围绕着“职责分离”以及将存储创建/管理与其使用分离开来:</p><ul class=""><li id="688e" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ky kz la lb bi translated">当一个应用程序需要持久存储时，开发者可以通过在pod规范中“声明”来请求——这是通过使用<code class="fe lh li lj lk b">PersistentVolumeClaim</code>来完成的</li><li id="a16a" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">实际的存储配置，例如创建Azure磁盘(使用azure CLI、门户等)。)并在Kubernetes集群中表示它(使用<code class="fe lh li lj lk b">PersistentVolume</code>)可以由另一个实体来完成，比如管理员</li></ul><p id="f66d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们看看这是怎么回事！</p><h1 id="ee25" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">先决条件:</h1><p id="f93e" class="pw-post-body-paragraph ju jv iq jw b jx mj jz ka kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr ij bi translated">您将需要以下内容:</p><ul class=""><li id="e300" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ky kz la lb bi translated"><a class="ae ks" href="https://docs.microsoft.com/azure/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">微软Azure账户</a>—<a class="ae ks" href="https://azure.microsoft.com/free/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">注册一个免费账户吧！</a></li><li id="c1da" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><a class="ae ks" href="https://azure.microsoft.com/services/kubernetes-service/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure Kubernetes服务(AKS)集群</a>——本博客将指导您创建一个集群</li><li id="d2c4" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">Azure CLI或Azure Cloud Shell——如果你还没有安装Azure CLI ，你可以选择安装它(应该很快！)或者直接从你的浏览器使用<a class="ae ks" href="https://azure.microsoft.com/features/cloud-shell/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure云壳</a>。</li><li id="5135" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><code class="fe lh li lj lk b"><a class="ae ks" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank">kubectl</a></code>与你的AKS集群进行交互</li></ul><blockquote class="nb nc nd"><p id="fb9f" class="ju jv ne jw b jx jy jz ka kb kc kd ke nf kg kh ki ng kk kl km nh ko kp kq kr ij bi translated"><em class="iq">在你的Mac上，你可以安装</em> <code class="fe lh li lj lk b"><em class="iq">kubectl</em></code> <em class="iq">如下:</em></p></blockquote><pre class="mo mp mq mr gt ms lk mt mu aw mv bi"><span id="5f35" class="mw lm iq lk b gy mx my l mz na">curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s <a class="ae ks" href="https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/darwin/amd64/kubectl" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/darwin/amd64/kubectl</a></span><span id="9d1b" class="mw lm iq lk b gy nj my l mz na">chmod +x ./kubectl</span><span id="a67f" class="mw lm iq lk b gy nj my l mz na">sudo mv ./kubectl /usr/local/bin/kubectl</span></pre><p id="1016" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">代码可以在GitHub 的<a class="ae ks" href="https://github.com/abhirockzz/aks-azuredisk-static-pv" rel="noopener ugc nofollow" target="_blank">上找到。请在继续之前克隆该存储库</a></p><pre class="mo mp mq mr gt ms lk mt mu aw mv bi"><span id="ff66" class="mw lm iq lk b gy mx my l mz na">git clone https://github.com/abhirockzz/aks-azuredisk-static-pv<br/>cd aks-azuredisk-static-pv</span></pre><h1 id="3d78" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">Kubernetes集群设置</h1><p id="3ae7" class="pw-post-body-paragraph ju jv iq jw b jx mj jz ka kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr ij bi translated">你只需要一个命令就可以在Azure上建立一个Kubernetes集群。但是，在此之前，我们必须创建一个资源组</p><pre class="mo mp mq mr gt ms lk mt mu aw mv bi"><span id="124b" class="mw lm iq lk b gy mx my l mz na">export AZURE_SUBSCRIPTION_ID=[to be filled]<br/>export AZURE_RESOURCE_GROUP=[to be filled]<br/>export AZURE_REGION=[to be filled] (e.g. southeastasia)</span></pre><p id="52d9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">切换到您的套餐并调用<code class="fe lh li lj lk b">az group create</code></p><pre class="mo mp mq mr gt ms lk mt mu aw mv bi"><span id="8a49" class="mw lm iq lk b gy mx my l mz na">az account set -s $AZURE_SUBSCRIPTION_ID<br/>az group create -l $AZURE_REGION -n $AZURE_RESOURCE_GROUP</span></pre><p id="5a74" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您现在可以调用<code class="fe lh li lj lk b">az aks create</code>来创建新的集群</p><blockquote class="nb nc nd"><p id="89ca" class="ju jv ne jw b jx jy jz ka kb kc kd ke nf kg kh ki ng kk kl km nh ko kp kq kr ij bi translated">为了简单起见，下面的命令创建了一个单节点集群。根据您的要求随意更改规格</p></blockquote><pre class="mo mp mq mr gt ms lk mt mu aw mv bi"><span id="68f8" class="mw lm iq lk b gy mx my l mz na">export AKS_CLUSTER_NAME=[to be filled]</span><span id="c5e1" class="mw lm iq lk b gy nj my l mz na">az aks create --resource-group $AZURE_RESOURCE_GROUP --name $AKS_CLUSTER_NAME --node-count 1 --node-vm-size Standard_B2s --node-osdisk-size 30 --generate-ssh-keys</span></pre><p id="cd1d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用<code class="fe lh li lj lk b">az aks get-credentials</code>获取AKS集群凭证——因此，<code class="fe lh li lj lk b">kubectl</code>现在将指向您的新集群。你可以证实这一点</p><pre class="mo mp mq mr gt ms lk mt mu aw mv bi"><span id="221f" class="mw lm iq lk b gy mx my l mz na">az aks get-credentials --resource-group $AZURE_RESOURCE_GROUP --name $AKS_CLUSTER_NAME</span><span id="a4d5" class="mw lm iq lk b gy nj my l mz na">kubectl get nodes</span></pre><blockquote class="nb nc nd"><p id="c179" class="ju jv ne jw b jx jy jz ka kb kc kd ke nf kg kh ki ng kk kl km nh ko kp kq kr ij bi translated"><em class="iq">如果您对使用</em><a class="ae ks" href="https://azure.microsoft.com/services/kubernetes-service/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"><em class="iq">Azure</em></a><em class="iq">学习Kubernetes和Containers感兴趣，一个好的起点是使用文档中的</em> <a class="ae ks" href="https://docs.microsoft.com/azure/aks/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq">快速入门、教程和代码示例</em> </a> <em class="iq">来熟悉该服务。我也强烈推荐查看一下</em> <a class="ae ks" href="https://azure.microsoft.com/resources/kubernetes-learning-path/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> 50天Kubernetes学习路径</em> </a> <em class="iq">。高级用户可能希望参考</em> <a class="ae ks" href="https://docs.microsoft.com/azure/aks/best-practices?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> Kubernetes最佳实践</em> </a> <em class="iq">或观看一些</em> <a class="ae ks" href="https://azure.microsoft.com/resources/videos/index/?services=kubernetes-service&amp;WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq">视频</em> </a> <em class="iq">以了解演示、主要特性和技术会议。</em></p></blockquote><h1 id="7843" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">为持久存储创建Azure磁盘</h1><p id="f632" class="pw-post-body-paragraph ju jv iq jw b jx mj jz ka kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr ij bi translated">Azure Kubernetes集群可以使用Azure磁盘或Azure文件作为数据卷。在这个例子中，我们将探索Azure磁盘。你可以选择由标准硬盘或<a class="ae ks" href="https://docs.microsoft.com/azure/virtual-machines/windows/disks-types?WT.mc_id=medium-blog-abhishgu#premium-ssd" rel="noopener ugc nofollow" target="_blank">高级固态硬盘</a>支持的<a class="ae ks" href="https://docs.microsoft.com/azure/virtual-machines/windows/disks-types?WT.mc_id=medium-blog-abhishgu#standard-hdd" rel="noopener ugc nofollow" target="_blank"> Azure硬盘</a></p><p id="cc6c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">获取AKS节点资源组</p><pre class="mo mp mq mr gt ms lk mt mu aw mv bi"><span id="724c" class="mw lm iq lk b gy mx my l mz na">AKS_NODE_RESOURCE_GROUP=$(az aks show --resource-group $AZURE_RESOURCE_GROUP --name $AKS_CLUSTER_NAME --query nodeResourceGroup -o tsv)</span></pre><p id="498e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在节点资源组中创建Azure磁盘</p><pre class="mo mp mq mr gt ms lk mt mu aw mv bi"><span id="4d15" class="mw lm iq lk b gy mx my l mz na">export AZURE_DISK_NAME=&lt;enter-azure-disk-name&gt;</span><span id="4b2d" class="mw lm iq lk b gy nj my l mz na">az disk create --resource-group $AKS_NODE_RESOURCE_GROUP --name $AZURE_DISK_NAME --size-gb 2 --query id --output tsv</span></pre><blockquote class="nb nc nd"><p id="4035" class="ju jv ne jw b jx jy jz ka kb kc kd ke nf kg kh ki ng kk kl km nh ko kp kq kr ij bi translated"><em class="iq">我们正在创建一个容量为2 GB的磁盘</em></p></blockquote><p id="8131" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您将获得Azure磁盘的资源ID作为响应，这将在下一步使用</p><pre class="mo mp mq mr gt ms lk mt mu aw mv bi"><span id="ab56" class="mw lm iq lk b gy mx my l mz na">/subscriptions/3a06a10f-ae29-4242-b6a7-dda0ea91d342/resourceGroups/MC_testaks_foo-aks_southeastasia/providers/Microsoft.Compute/disks/my-test-disk</span></pre><h1 id="e159" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">将应用程序部署到Kubernetes</h1><p id="f593" class="pw-post-body-paragraph ju jv iq jw b jx mj jz ka kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr ij bi translated"><code class="fe lh li lj lk b">azure-disk-persistent-volume.yaml</code>文件包含了<code class="fe lh li lj lk b">PersistentVolume</code>的详细信息。我们创建它是为了在AKS集群中映射Azure磁盘。</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><blockquote class="nb nc nd"><p id="0e79" class="ju jv ne jw b jx jy jz ka kb kc kd ke nf kg kh ki ng kk kl km nh ko kp kq kr ij bi translated"><em class="iq">注意，容量(</em> <code class="fe lh li lj lk b"><em class="iq">spec.capacity.storage</em></code> <em class="iq">)是2 GB，与我们刚刚创建的Azure磁盘的容量相同</em></p></blockquote><p id="81f7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">用Azure磁盘信息更新<code class="fe lh li lj lk b">azure-disk-persistent-volume.yaml</code></p><ul class=""><li id="8c3f" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ky kz la lb bi translated"><code class="fe lh li lj lk b">diskName</code> -您之前选择的Azure磁盘的名称</li><li id="a7fa" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><code class="fe lh li lj lk b">diskURI</code>-Azure磁盘的资源ID</li></ul><p id="b756" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建<code class="fe lh li lj lk b">PersistentVolume</code></p><pre class="mo mp mq mr gt ms lk mt mu aw mv bi"><span id="46f8" class="mw lm iq lk b gy mx my l mz na">kubectl apply -f azure-disk-persistent-volume.yaml</span><span id="dcf6" class="mw lm iq lk b gy nj my l mz na">persistentvolume/azure-disk-pv created</span></pre><p id="015d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来，我们需要创建<code class="fe lh li lj lk b">PersistentVolumeClaim</code>，我们将在<code class="fe lh li lj lk b">Pod</code>规范中使用它作为参考</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><blockquote class="nb nc nd"><p id="de9c" class="ju jv ne jw b jx jy jz ka kb kc kd ke nf kg kh ki ng kk kl km nh ko kp kq kr ij bi translated"><em class="iq">我们请求2 GB的存储空间(使用</em> <code class="fe lh li lj lk b"><em class="iq">resources.request.storage</em></code> <em class="iq"> ) </em></p></blockquote><p id="a839" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要创建它:</p><pre class="mo mp mq mr gt ms lk mt mu aw mv bi"><span id="e1a5" class="mw lm iq lk b gy mx my l mz na">kubectl apply -f azure-disk-persistent-volume-claim.yaml</span><span id="f503" class="mw lm iq lk b gy nj my l mz na">persistentvolumeclaim/azure-disk-pvc created</span></pre><p id="1cdb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查<code class="fe lh li lj lk b">PersistentVolume</code></p><pre class="mo mp mq mr gt ms lk mt mu aw mv bi"><span id="3e21" class="mw lm iq lk b gy mx my l mz na">kubectl get pv/azure-disk-pv<br/></span><span id="c16e" class="mw lm iq lk b gy nj my l mz na">NAME  CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM    STORAGECLASS   REASON   AGE<br/>azure-disk-pv   2Gi        RWO            Retain           Bound    default/azure-disk-pvc            8m35s</span></pre><p id="e8ec" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查<code class="fe lh li lj lk b">PersistentVolumeClaim</code></p><pre class="mo mp mq mr gt ms lk mt mu aw mv bi"><span id="c45d" class="mw lm iq lk b gy mx my l mz na">kubectl get pvc/azure-disk-pvc</span><span id="05a5" class="mw lm iq lk b gy nj my l mz na">NAME             STATUS   VOLUME          CAPACITY   ACCESS MODES   STORAGECLASS   AGE<br/>azure-disk-pvc   Bound    azure-disk-pv   2Gi        RWO                           9m55s</span></pre><blockquote class="nb nc nd"><p id="f776" class="ju jv ne jw b jx jy jz ka kb kc kd ke nf kg kh ki ng kk kl km nh ko kp kq kr ij bi translated"><em class="iq">注意(在上述输出的</em> <code class="fe lh li lj lk b"><em class="iq">STATUS</em></code> <em class="iq">部分)的</em> <code class="fe lh li lj lk b"><em class="iq">PersistentVolume</em></code> <em class="iq">和</em> <code class="fe lh li lj lk b"><em class="iq">PersistentVolumeClaim</em></code> <em class="iq">是相互</em> <code class="fe lh li lj lk b"><em class="iq">Bound</em></code> <em class="iq"/></p></blockquote><h1 id="2d56" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">试验</h1><p id="1e70" class="pw-post-body-paragraph ju jv iq jw b jx mj jz ka kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr ij bi translated">为了进行测试，我们将使用一个简单的Go应用程序。它所做的只是将日志语句推送到<code class="fe lh li lj lk b">/mnt/logs</code>中的一个文件<code class="fe lh li lj lk b">logz.out</code>——这是挂载到<code class="fe lh li lj lk b">Pod</code>中的路径</p><pre class="mo mp mq mr gt ms lk mt mu aw mv bi"><span id="ef90" class="mw lm iq lk b gy mx my l mz na">func main() {<br/>    ticker := time.NewTicker(3 * time.Second)<br/>    exit := make(chan os.Signal, 1)<br/>    signal.Notify(exit, syscall.SIGTERM, syscall.SIGINT)<br/>    for {<br/>        select {<br/>        case t := &lt;-ticker.C:<br/>            logToFile(t.String())<br/>        case &lt;-exit:<br/>            err := os.Remove(fileLoc + fileName)<br/>            if err != nil {<br/>                log.Println("unable to delete log file")<br/>            }<br/>            os.Exit(1)<br/>        }<br/>    }<br/>}</span></pre><p id="485b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将我们的应用程序创建为<code class="fe lh li lj lk b">Deployment</code></p><pre class="mo mp mq mr gt ms lk mt mu aw mv bi"><span id="3e42" class="mw lm iq lk b gy mx my l mz na">kubectl apply -f app-deployment.yaml</span></pre><p id="64e0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">等待一段时间，使部署处于<code class="fe lh li lj lk b">Running</code>状态</p><pre class="mo mp mq mr gt ms lk mt mu aw mv bi"><span id="feb2" class="mw lm iq lk b gy mx my l mz na">kubectl get pods -l=app=logz</span><span id="e001" class="mw lm iq lk b gy nj my l mz na">NAME                               READY   STATUS    RESTARTS   AGE<br/>logz-deployment-59b75bc786-wt98d   1/1     Running   0          15s</span></pre><p id="6f32" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了确认，检查<code class="fe lh li lj lk b">Pod</code>中的<code class="fe lh li lj lk b">/mnt/logs/logz.out</code></p><pre class="mo mp mq mr gt ms lk mt mu aw mv bi"><span id="531b" class="mw lm iq lk b gy mx my l mz na">kubectl exec -it $(kubectl get pods -l=app=logz --output=jsonpath={.items..metadata.name}) -- tail -f /mnt/logs/logz.out</span></pre><p id="fd29" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您将每3秒钟看到一次日志(只有时间戳)。这是因为Azure磁盘存储已经安装在您的<code class="fe lh li lj lk b">Pod</code>中</p><pre class="mo mp mq mr gt ms lk mt mu aw mv bi"><span id="4ef3" class="mw lm iq lk b gy mx my l mz na">2019-09-23 10:00:18.308746334 +0000 UTC m=+3.002071866<br/>2019-09-23 10:00:21.308779348 +0000 UTC m=+6.002104880<br/>2019-09-23 10:00:24.308771261 +0000 UTC m=+9.002096693<br/>2019-09-23 10:00:27.308778874 +0000 UTC m=+12.002104406<br/>2019-09-23 10:00:30.308804587 +0000 UTC m=+15.002130219</span></pre><p id="18ac" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一旦你完成了测试，你可以删除资源以节省成本。</p><h1 id="a574" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">打扫卫生</h1><pre class="mo mp mq mr gt ms lk mt mu aw mv bi"><span id="b6d9" class="mw lm iq lk b gy mx my l mz na">az group delete --name $AZURE_RESOURCE_GROUP --yes --no-wait</span></pre><blockquote class="nb nc nd"><p id="2c90" class="ju jv ne jw b jx jy jz ka kb kc kd ke nf kg kh ki ng kk kl km nh ko kp kq kr ij bi translated"><em class="iq">这将删除资源组</em>下的所有资源</p></blockquote><p id="53d1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这个博客到此为止！您看到了如何使用标准的Kubernetes原语(如<code class="fe lh li lj lk b">PersistentVolume</code>和<code class="fe lh li lj lk b">PersistentVolume</code>)将Azure Disk实例附加和安装到在AKS中运行的应用程序。敬请关注更多内容😃😃</p><p id="4f23" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我真的希望你喜欢这篇文章，并从中学到了一些东西！如果你做了，请喜欢并跟随。很高兴通过<a class="ae ks" href="https://twitter.com/abhi_tweeter" rel="noopener ugc nofollow" target="_blank"> Twitter </a>获得反馈，或者发表评论👇👇</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure></div></div>    
</body>
</html>