<html>
<head>
<title>Processing Time-Series Data with Redis and Apache Kafka</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Redis和Apache Kafka处理时间序列数据</h1>
<blockquote>原文：<a href="https://itnext.io/processing-time-series-data-with-redis-and-apache-kafka-4272db0768dc?source=collection_archive---------2-----------------------#2021-06-23">https://itnext.io/processing-time-series-data-with-redis-and-apache-kafka-4272db0768dc?source=collection_archive---------2-----------------------#2021-06-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="6daf" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何在Azure上使用Kafka、Redis和Spring处理时间序列数据的实例</h2></div><p id="874e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" href="https://oss.redislabs.com/redistimeseries/" rel="noopener ugc nofollow" target="_blank"> RedisTimeSeries </a>是一个Redis模块，它将原生时间序列数据结构引入Redis。早先构建在有序集合(或Redis流)之上的时间序列解决方案可以受益于<code class="fe lc ld le lf b">RedisTimeSeries</code>的特性，例如大容量插入、低延迟读取、灵活的查询语言、下采样等等！</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi lg"><img src="../Images/91d8015c048ef224d53fa44be3b384a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:540/format:webp/0*8Caj4M6yRAEhyPNJ.jpeg"/></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated"><a class="ae lb" href="https://oss.redislabs.com/redistimeseries/" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><p id="61dd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一般来说，时间序列数据(相对)简单。话虽如此，我们还需要考虑其他特征:</p><ul class=""><li id="87c4" class="ls lt iq kh b ki kj kl km ko lu ks lv kw lw la lx ly lz ma bi translated">数据速度:例如，想想每秒来自数千台设备的数百个指标</li><li id="0d4f" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated">量(大数据):想想几个月(甚至几年)的数据积累</li></ul><p id="5209" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，像<code class="fe lc ld le lf b">RedisTimeSeries</code>这样的时间序列数据库只是整个解决方案的一部分。你还需要考虑如何<em class="mg">收集</em>(摄取)<em class="mg">处理</em><em class="mg">发送</em>你所有的数据给<code class="fe lc ld le lf b">RedisTimeSeries</code>。您真正需要的是一个可伸缩的数据管道，它可以作为一个缓冲区来分离生产者和消费者。</p><p id="d3dc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这就是阿帕奇卡夫卡的用武之地！除了核心代理，它还有一个丰富的组件生态系统，包括<a class="ae lb" href="https://kafka.apache.org/documentation/#connect" rel="noopener ugc nofollow" target="_blank"> Kafka Connect </a>(这是这篇博客文章中介绍的解决方案架构的一部分)、多种语言的客户端库、<a class="ae lb" href="https://kafka.apache.org/documentation/streams/" rel="noopener ugc nofollow" target="_blank"> Kafka Streams </a>、Mirror Maker等。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mh"><img src="../Images/cd9d6f2f9d13049db07b3bd474d1614f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uMe05RkVXBFGfOrW.png"/></div></div></figure><p id="be0b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这篇博客文章提供了一个实例，展示了如何使用Apache Kafka的<code class="fe lc ld le lf b">RedisTimeSeries</code>来分析时间序列数据。</p><blockquote class="mm mn mo"><p id="e37e" class="kf kg mg kh b ki kj jr kk kl km ju kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated"><em class="iq"> GitHub回购—</em><a class="ae lb" href="https://github.com/abhirockzz/redis-timeseries-kafka" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://github.com/abhirockzz/redis-timeseries-kafka</em></a></p></blockquote><p id="0dc7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们首先从探索用例开始——请注意，为了这篇博文的目的，它已经保持简单，但是后续部分</p><h1 id="8771" class="ms mt iq bd mu mv mw mx my mz na nb nc jw nd jx ne jz nf ka ng kc nh kd ni nj bi translated">设备监控</h1><p id="0b56" class="pw-post-body-paragraph kf kg iq kh b ki nk jr kk kl nl ju kn ko nm kq kr ks nn ku kv kw no ky kz la ij bi translated">假设有许多位置，每个位置都有多台设备，您负责监控设备指标，现在我们将考虑<code class="fe lc ld le lf b">temperature</code>和<code class="fe lc ld le lf b">pressure</code>。我们将把这些指标存储在<code class="fe lc ld le lf b">RedisTimeSeries</code>(当然！)并对键使用以下命名约定- <code class="fe lc ld le lf b">&lt;metric name&gt;:&lt;location&gt;:&lt;device&gt;</code>。例如，位置<code class="fe lc ld le lf b">5</code>的设备<code class="fe lc ld le lf b">1</code>的温度将表示为<code class="fe lc ld le lf b">temp:5:1</code>。每个时间序列数据点还会有以下标签(元数据)- <code class="fe lc ld le lf b">metric</code>，<code class="fe lc ld le lf b">location</code>，<code class="fe lc ld le lf b">device</code>。这是为了实现灵活的查询，您将在接下来的章节中看到这一点。</p><p id="da8a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里有几个例子，让你知道如何使用<code class="fe lc ld le lf b">TS.ADD</code>命令添加数据点:</p><pre class="lh li lj lk gt np lf nq nr aw ns bi"><span id="98f7" class="nt mt iq lf b gy nu nv l nw nx"># temperature for device 2 in location 3 along with labels<br/>TS.ADD temp:3:2 * 20 LABELS metric temp location 3 device 2</span><span id="9e9c" class="nt mt iq lf b gy ny nv l nw nx"># pressure for device 2 in location 3<br/>TS.ADD pressure:3:2 * 60 LABELS metric pressure location 3 device 2`</span></pre><h1 id="71fc" class="ms mt iq bd mu mv mw mx my mz na nb nc jw nd jx ne jz nf ka ng kc nh kd ni nj bi translated">解决方案架构</h1><p id="78c2" class="pw-post-body-paragraph kf kg iq kh b ki nk jr kk kl nl ju kn ko nm kq kr ks nn ku kv kw no ky kz la ij bi translated">以下是该解决方案的概要:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mh"><img src="../Images/099e2e01f28097e48f6eef422a1da4bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*D6Kkf6Z9POisdqbk.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">高层建筑</figcaption></figure><p id="6e1a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">总结端到端流程:</p><p id="8940" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">模拟设备数据被发送到本地MQTT代理。这个数据由MQTT Kafka connect source连接器拾取，并发送到Azure中的融合云Kafka集群。它由Azure spring Cloud中的Spring应用程序处理，最终被发送到Azure中的Redis数据库。</p></div><div class="ab cl nz oa hu ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="ij ik il im in"><p id="e361" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">是时候投入进去了！在此之前，请确保您具备以下条件:</p><h1 id="b662" class="ms mt iq bd mu mv mw mx my mz na nb nc jw nd jx ne jz nf ka ng kc nh kd ni nj bi translated">先决条件</h1><ul class=""><li id="c4b0" class="ls lt iq kh b ki nk kl nl ko og ks oh kw oi la lx ly lz ma bi translated">Azure帐户— <a class="ae lb" href="https://azure.microsoft.com/free/?WT.mc_id=data-17927-abhishgu" rel="noopener ugc nofollow" target="_blank">你可以在这里免费获得一个</a></li><li id="9242" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated">安装<a class="ae lb" href="https://docs.microsoft.com/cli/azure/install-azure-cli?WT.mc_id=data-17927-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a></li><li id="17de" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated">JDK 11例如用于<a class="ae lb" href="https://openjdk.java.net/projects/jdk/11/%5D" rel="noopener ugc nofollow" target="_blank"> OpenJDK </a></li><li id="ab95" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated">最近版本的<a class="ae lb" href="https://maven.apache.org/download.cgi" rel="noopener ugc nofollow" target="_blank"> Maven </a>和<a class="ae lb" href="https://git-scm.com/downloads" rel="noopener ugc nofollow" target="_blank"> Git </a></li></ul><h1 id="2f42" class="ms mt iq bd mu mv mw mx my mz na nb nc jw nd jx ne jz nf ka ng kc nh kd ni nj bi translated">设置基础设施组件</h1><p id="76c1" class="pw-post-body-paragraph kf kg iq kh b ki nk jr kk kl nl ju kn ko nm kq kr ks nn ku kv kw no ky kz la ij bi translated">按照文档<a class="ae lb" href="https://docs.microsoft.com/azure/azure-cache-for-redis/quickstart-create-redis-enterprise?WT.mc_id=data-17927-abhishgu" rel="noopener ugc nofollow" target="_blank">为Redis(企业级)提供Azure缓存</a>，它与<code class="fe lc ld le lf b">RedisTimeSeries</code>模块一起提供。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mh"><img src="../Images/4c10b7a628fceb263dde9ce15bff54d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fULnj4g7FnnqPaW0.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">Redis的Azure缓存</figcaption></figure><p id="ce23" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Azure Marketplace上提供<a class="ae lb" href="https://docs.microsoft.com/azure/partner-solutions/apache-kafka-confluent-cloud/create?WT.mc_id=data-17927-abhishgu" rel="noopener ugc nofollow" target="_blank">融合云集群</a>并创建一个Kafka主题(例如<code class="fe lc ld le lf b">mqtt.device-stats</code>)</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mh"><img src="../Images/350af35c741e353a9cf6922802bd2899.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GccPrqikwL6u0KDP.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">Azure中的融合组织</figcaption></figure><p id="a3d7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以使用Azure门户或使用Azure CLI 来提供Azure Spring Cloud <a class="ae lb" href="https://docs.microsoft.com/azure/spring-cloud/quickstart-provision-service-instance?tabs=Azure-portal&amp;pivots=programming-language-java&amp;WT.mc_id=data-17927-abhishgu#provision-an-instance-of-azure-spring-cloud-1" rel="noopener ugc nofollow" target="_blank">的实例</a></p><pre class="lh li lj lk gt np lf nq nr aw ns bi"><span id="889a" class="nt mt iq lf b gy nu nv l nw nx">az spring-cloud create -n &lt;name of Azure Spring Cloud service&gt; -g &lt;resource group name&gt; -l &lt;enter location e.g southeastasia&gt;</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mh"><img src="../Images/875358d9a92a6c2b21250424c0c1832c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*e6os0XKqVdUC_x0t.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">蔚蓝色的春云</figcaption></figure><p id="1553" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在继续之前，确保克隆GitHub repo:</p><pre class="lh li lj lk gt np lf nq nr aw ns bi"><span id="54a9" class="nt mt iq lf b gy nu nv l nw nx">git clone https://github.com/abhirockzz/redis-timeseries-kafka<br/>cd redis-timeseries-kafka</span></pre><h1 id="c015" class="ms mt iq bd mu mv mw mx my mz na nb nc jw nd jx ne jz nf ka ng kc nh kd ni nj bi translated">设置本地服务</h1><p id="064b" class="pw-post-body-paragraph kf kg iq kh b ki nk jr kk kl nl ju kn ko nm kq kr ks nn ku kv kw no ky kz la ij bi translated">这些组件包括:</p><ul class=""><li id="028d" class="ls lt iq kh b ki kj kl km ko lu ks lv kw lw la lx ly lz ma bi translated"><a class="ae lb" href="https://mosquitto.org/" rel="noopener ugc nofollow" target="_blank">mosquito</a>MQTT经纪人</li><li id="840c" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated"><a class="ae lb" href="https://grafana.com/" rel="noopener ugc nofollow" target="_blank"> Grafana </a>用于跟踪仪表板中的时间序列数据</li><li id="00ec" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated">Kafka与<a class="ae lb" href="https://docs.confluent.io/kafka-connect-mqtt/current/mqtt-source-connector/index.html" rel="noopener ugc nofollow" target="_blank"> MQTT源连接器</a>连接</li></ul><h2 id="12eb" class="nt mt iq bd mu oj ok dn my ol om dp nc ko on oo ne ks op oq ng kw or os ni ot bi translated">MQTT代理</h2><p id="cb7c" class="pw-post-body-paragraph kf kg iq kh b ki nk jr kk kl nl ju kn ko nm kq kr ks nn ku kv kw no ky kz la ij bi translated">我在Mac上本地安装并启动了<code class="fe lc ld le lf b">mosquitto</code>代理。</p><pre class="lh li lj lk gt np lf nq nr aw ns bi"><span id="fd09" class="nt mt iq lf b gy nu nv l nw nx">brew install mosquitto<br/>brew services start mosquitto</span></pre><p id="3f3c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以<a class="ae lb" href="https://mosquitto.org/download/%5D" rel="noopener ugc nofollow" target="_blank">遵循与您的操作系统</a>相对应的步骤，或者随意使用<a class="ae lb" href="https://hub.docker.com/_/eclipse-mosquitto" rel="noopener ugc nofollow" target="_blank">这个Docker映像</a>。</p><h2 id="cd6f" class="nt mt iq bd mu oj ok dn my ol om dp nc ko on oo ne ks op oq ng kw or os ni ot bi translated">格拉夫纳</h2><p id="7ddb" class="pw-post-body-paragraph kf kg iq kh b ki nk jr kk kl nl ju kn ko nm kq kr ks nn ku kv kw no ky kz la ij bi translated">我在Mac上本地安装并启动了Grafana。</p><pre class="lh li lj lk gt np lf nq nr aw ns bi"><span id="86aa" class="nt mt iq lf b gy nu nv l nw nx">brew install grafana<br/>brew services start grafana</span></pre><p id="4f53" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你可以为你的操作系统做同样的事情，或者随意使用这个<a class="ae lb" href="https://hub.docker.com/r/grafana/grafana" rel="noopener ugc nofollow" target="_blank"> Docker镜像</a>。</p><pre class="lh li lj lk gt np lf nq nr aw ns bi"><span id="79d0" class="nt mt iq lf b gy nu nv l nw nx">docker run -d -p 3000:3000 --name=grafana -e "GF_INSTALL_PLUGINS=redis-datasource" grafana/grafana</span></pre><h2 id="26f3" class="nt mt iq bd mu oj ok dn my ol om dp nc ko on oo ne ks op oq ng kw or os ni ot bi translated">卡夫卡连接</h2><blockquote class="mm mn mo"><p id="72eb" class="kf kg mg kh b ki kj jr kk kl km ju kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated"><em class="iq">你应该可以在刚刚克隆的repo中找到</em> <code class="fe lc ld le lf b"><em class="iq">connect-distributed.properties</em></code> <em class="iq">文件。替换</em><code class="fe lc ld le lf b"><em class="iq">bootstrap.servers</em></code><em class="iq"/><code class="fe lc ld le lf b"><em class="iq">sasl.jaas.config</em></code><em class="iq">等属性的值。</em></p></blockquote><p id="5f34" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，<a class="ae lb" href="https://kafka.apache.org/downloads" rel="noopener ugc nofollow" target="_blank">本地下载并解压Apache Kafka </a>。</p><p id="2f7b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">启动本地Kafka Connect集群</strong></p><pre class="lh li lj lk gt np lf nq nr aw ns bi"><span id="3e98" class="nt mt iq lf b gy nu nv l nw nx">export KAFKA_INSTALL_DIR=&lt;kafka installation directory e.g. /home/foo/kafka_2.12-2.5.0&gt;</span><span id="cf64" class="nt mt iq lf b gy ny nv l nw nx">$KAFKA_INSTALL_DIR/bin/connect-distributed.sh connect-distributed.properties</span></pre><p id="8b07" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">手动安装MQTT源连接器:</p><ul class=""><li id="ea5b" class="ls lt iq kh b ki kj kl km ko lu ks lv kw lw la lx ly lz ma bi translated">从这个链接下载连接器/插件ZIP文件<a class="ae lb" href="https://www.confluent.io/hub/confluentinc/kafka-connect-mqtt" rel="noopener ugc nofollow" target="_blank">，并且，</a></li><li id="c22b" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated">将其提取到Connect worker的<code class="fe lc ld le lf b">plugin.path</code>配置属性中列出的一个目录中</li></ul><blockquote class="mm mn mo"><p id="7014" class="kf kg mg kh b ki kj jr kk kl km ju kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated"><em class="iq">如果您在本地使用融合平台，只需使用CLI: </em> <code class="fe lc ld le lf b"><em class="iq">confluent-hub install confluentinc/kafka-connect-mqtt:latest</em></code></p></blockquote><p id="e1d4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">创建MQTT源连接器实例</strong></p><p id="f7fa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">确保检查<code class="fe lc ld le lf b">mqtt-source-config.json</code>文件:确保为<code class="fe lc ld le lf b">kafka.topic</code>输入了正确的主题名称，并保持<code class="fe lc ld le lf b">mqtt.topics</code>不变。</p><pre class="lh li lj lk gt np lf nq nr aw ns bi"><span id="2940" class="nt mt iq lf b gy nu nv l nw nx">curl -X POST -H 'Content-Type: application/json' http://localhost:8083/connectors -d @mqtt-source-config.json</span><span id="a7cd" class="nt mt iq lf b gy ny nv l nw nx"># wait for a minute before checking the connector status<br/>curl <a class="ae lb" href="http://localhost:8083/connectors/mqtt-source/status" rel="noopener ugc nofollow" target="_blank">http://localhost:8083/connectors/mqtt-source/status</a></span></pre><h1 id="1ab5" class="ms mt iq bd mu mv mw mx my mz na nb nc jw nd jx ne jz nf ka ng kc nh kd ni nj bi translated">部署设备数据处理器应用程序</h1><p id="dd43" class="pw-post-body-paragraph kf kg iq kh b ki nk jr kk kl nl ju kn ko nm kq kr ks nn ku kv kw no ky kz la ij bi translated">构建应用程序JAR文件:</p><pre class="lh li lj lk gt np lf nq nr aw ns bi"><span id="f82a" class="nt mt iq lf b gy nu nv l nw nx">cd consumer</span><span id="bf2e" class="nt mt iq lf b gy ny nv l nw nx">export JAVA_HOME=/Library/Java/JavaVirtualMachines/zulu-11.jdk/Contents/Home</span><span id="cca9" class="nt mt iq lf b gy ny nv l nw nx">mvn clean package</span></pre><p id="3af5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建Azure Spring云应用程序并部署JAR文件:</p><pre class="lh li lj lk gt np lf nq nr aw ns bi"><span id="450a" class="nt mt iq lf b gy nu nv l nw nx">az spring-cloud app create -n device-data-processor -s &lt;name of Azure Spring Cloud instance&gt; -g &lt;name of resource group&gt; --runtime-version Java_11</span><span id="c335" class="nt mt iq lf b gy ny nv l nw nx">az spring-cloud app deploy -n device-data-processor -s &lt;name of Azure Spring Cloud instance&gt; -g &lt;name of resource group&gt; --jar-path target/device-data-processor-0.0.1-SNAPSHOT.jar</span></pre><h1 id="24c0" class="ms mt iq bd mu mv mw mx my mz na nb nc jw nd jx ne jz nf ka ng kc nh kd ni nj bi translated">启动模拟设备数据生成器</h1><p id="ffc1" class="pw-post-body-paragraph kf kg iq kh b ki nk jr kk kl nl ju kn ko nm kq kr ks nn ku kv kw no ky kz la ij bi translated">使用脚本将数据发送到本地MQTT代理。您可以在刚刚克隆的GitHub repo中使用该脚本:</p><pre class="lh li lj lk gt np lf nq nr aw ns bi"><span id="ebe8" class="nt mt iq lf b gy nu nv l nw nx">./gen-timeseries-data.sh</span></pre><blockquote class="mm mn mo"><p id="0c58" class="kf kg mg kh b ki kj jr kk kl km ju kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated"><em class="iq">它所做的就是使用</em> <code class="fe lc ld le lf b"><em class="iq">mosquitto_pub</em></code> <em class="iq"> CLI命令发送数据</em></p></blockquote><p id="c353" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">数据被发送到<code class="fe lc ld le lf b">device-stats</code> MQTT主题(这是<em class="mg">而不是</em>Kafka主题)。您可以使用CLI订户进行双重检查:</p><pre class="lh li lj lk gt np lf nq nr aw ns bi"><span id="7361" class="nt mt iq lf b gy nu nv l nw nx">mosquitto_sub -h localhost -t device-stats</span></pre><p id="3838" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">验证端到端管道</strong></p><p id="35a2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在合流云门户查看卡夫卡专题。您还应该检查Azure Spring Cloud中设备数据处理器应用程序的日志:</p><pre class="lh li lj lk gt np lf nq nr aw ns bi"><span id="8b51" class="nt mt iq lf b gy nu nv l nw nx">az spring-cloud app logs -f -n device-data-processor -s &lt;name of Azure Spring Cloud instance&gt; -g &lt;name of resource group&gt;</span></pre></div><div class="ab cl nz oa hu ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="ij ik il im in"><h1 id="7972" class="ms mt iq bd mu mv ou mx my mz ov nb nc jw ow jx ne jz ox ka ng kc oy kd ni nj bi translated">享受Grafana仪表盘！</h1><p id="f557" class="pw-post-body-paragraph kf kg iq kh b ki nk jr kk kl nl ju kn ko nm kq kr ks nn ku kv kw no ky kz la ij bi translated">在<code class="fe lc ld le lf b">localhost:3000</code>浏览Grafana UI。</p><p id="eb4f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Grafana的Redis数据源插件可以与任何Redis数据库一起工作，包括Redis的Azure Cache。按照这篇博文中的<a class="ae lb" href="https://abhishek1987.medium.com/an-easy-to-use-monitoring-solution-for-redis-5a8a73d56129" rel="noopener">说明来配置数据源。</a></p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mh"><img src="../Images/bd562632ae31d4e073adc8bf7555bc88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gzen_rO93UJ14_vg.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">Redis数据源</figcaption></figure><p id="6820" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将仪表板导入到您克隆的GitHub repo的<code class="fe lc ld le lf b">grafana_dashboards</code>文件夹中。</p><blockquote class="mm mn mo"><p id="e381" class="kf kg mg kh b ki kj jr kk kl km ju kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated"><em class="iq">如果您需要有关如何导入仪表板的帮助，请参考</em> <a class="ae lb" href="https://grafana.com/docs/grafana/latest/dashboards/export-import/#importing-a-dashboard" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> Grafana文档</em> </a> <em class="iq">。</em></p></blockquote><p id="9a59" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，这里有一个仪表板，显示位置1(使用<code class="fe lc ld le lf b">TS.MRANGE</code>)中设备5的平均压力(超过30秒)</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mh"><img src="../Images/753a4d70c266bbdbe4ad3b194513a998.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*s-bFe1vtxGAGHKhN.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">跟踪特定位置的特定设备的平均压力</figcaption></figure><p id="7198" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是另一个仪表板，显示了位置3的多个设备的最高温度(超过15秒)(再次感谢<code class="fe lc ld le lf b">TS.MRANGE</code>)。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mh"><img src="../Images/9064c0c788bf6069e15536e5b029a1e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*aqkEbM2X6RuO6QXR.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">用TS。m获取一个位置多个设备的最高温度</figcaption></figure><h1 id="7529" class="ms mt iq bd mu mv mw mx my mz na nb nc jw nd jx ne jz nf ka ng kc nh kd ni nj bi translated">所以，您想要运行一些RedisTimeSeries命令！</h1><p id="90dd" class="pw-post-body-paragraph kf kg iq kh b ki nk jr kk kl nl ju kn ko nm kq kr ks nn ku kv kw no ky kz la ij bi translated">启动<code class="fe lc ld le lf b">redis-cli</code>并连接到Redis实例的Azure缓存:</p><pre class="lh li lj lk gt np lf nq nr aw ns bi"><span id="f423" class="nt mt iq lf b gy nu nv l nw nx">redis-cli -h &lt;azure redis hostname e.g. redisdb.southeastasia.redisenterprise.cache.azure.net&gt; -p 10000 -a &lt;azure redis access key&gt; --tls</span></pre><p id="0e79" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从简单的查询开始:</p><pre class="lh li lj lk gt np lf nq nr aw ns bi"><span id="258d" class="nt mt iq lf b gy nu nv l nw nx"># pressure in device 5 for location 1<br/>TS.GET pressure:1:5</span><span id="07c4" class="nt mt iq lf b gy ny nv l nw nx"># temperature in device 5 for location 4<br/>TS.GET temp:4:5</span></pre><p id="d859" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">按位置过滤并获取所有<em class="mg">装置的温度和压力:</em></p><pre class="lh li lj lk gt np lf nq nr aw ns bi"><span id="5b6b" class="nt mt iq lf b gy nu nv l nw nx">TS.MGET WITHLABELS FILTER location=3</span></pre><p id="8bfd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">提取特定时间范围内一个或多个位置的所有设备的温度和压力:</p><pre class="lh li lj lk gt np lf nq nr aw ns bi"><span id="8b70" class="nt mt iq lf b gy nu nv l nw nx">TS.MRANGE - + WITHLABELS FILTER location=3<br/>TS.MRANGE - + WITHLABELS FILTER location=(3,5)</span></pre><blockquote class="mm mn mo"><p id="0c46" class="kf kg mg kh b ki kj jr kk kl km ju kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated"><code class="fe lc ld le lf b"><em class="iq">- +</em></code> <em class="iq">指的是从开始到最近的时间戳的所有内容，但是您可以更具体一些</em></p></blockquote><p id="6077" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lc ld le lf b">MRANGE</code>正是我们所需要的！我们可以得到多个时间序列并使用过滤器。</p><p id="2836" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还可以通过某个位置的特定设备进行过滤，并根据温度或压力进一步深入研究:</p><pre class="lh li lj lk gt np lf nq nr aw ns bi"><span id="d5a0" class="nt mt iq lf b gy nu nv l nw nx">TS.MRANGE - + WITHLABELS FILTER location=3 device=2<br/>TS.MRANGE - + WITHLABELS FILTER location=3 device=2 metric=temp</span></pre><p id="3ecb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所有这些都可以与聚合相结合。</p><pre class="lh li lj lk gt np lf nq nr aw ns bi"><span id="4157" class="nt mt iq lf b gy nu nv l nw nx">TS.MRANGE - + WITHLABELS FILTER location=3 metric=temp</span><span id="3378" class="nt mt iq lf b gy ny nv l nw nx"># all the temp data points are not useful. how about an average (or max) instead of every temp data points?</span><span id="a1d1" class="nt mt iq lf b gy ny nv l nw nx">TS.MRANGE - + WITHLABELS AGGREGATION avg 10000 FILTER location=3 metric=temp</span><span id="57d2" class="nt mt iq lf b gy ny nv l nw nx">TS.MRANGE - + WITHLABELS AGGREGATION max 10000 FILTER location=3 metric=temp</span></pre><blockquote class="mm mn mo"><p id="fd9f" class="kf kg mg kh b ki kj jr kk kl km ju kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated"><em class="iq">也可以创建一个规则来进行这种聚合，并存储在不同的时间序列中</em></p></blockquote><p id="a13d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦完成，不要忘记删除资源，以避免不必要的成本。</p><h1 id="1042" class="ms mt iq bd mu mv mw mx my mz na nb nc jw nd jx ne jz nf ka ng kc nh kd ni nj bi translated">删除资源</h1><p id="d7e7" class="pw-post-body-paragraph kf kg iq kh b ki nk jr kk kl nl ju kn ko nm kq kr ks nn ku kv kw no ky kz la ij bi translated">删除资源:</p><ul class=""><li id="df20" class="ls lt iq kh b ki kj kl km ko lu ks lv kw lw la lx ly lz ma bi translated"><a class="ae lb" href="https://docs.microsoft.com/azure/partner-solutions/apache-kafka-confluent-cloud/manage?WT.mc_id=data-17927-abhishgu#delete-confluent-organization" rel="noopener ugc nofollow" target="_blank">按照文档中的步骤</a>删除融合云团——你需要做的就是删除融合组织。</li><li id="8987" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated">类似地，您也应该<a class="ae lb" href="https://docs.microsoft.com/azure/azure-cache-for-redis/cache-go-get-started?WT.mc_id=data-17927-abhishgu#clean-up-resources" rel="noopener ugc nofollow" target="_blank">删除Redis实例</a>的Azure缓存。</li></ul><p id="ae85" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在您的本地计算机上:</p><ul class=""><li id="1064" class="ls lt iq kh b ki kj kl km ko lu ks lv kw lw la lx ly lz ma bi translated">停止Kafka连接集群</li><li id="a072" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated">阻止莫斯基托经纪人(例如<code class="fe lc ld le lf b">brew services stop mosquitto</code>)</li><li id="2c1b" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated">停止Grafana服务(例如<code class="fe lc ld le lf b">brew services stop grafana</code>)</li></ul><p id="56e4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用Redis和Kafka开发了一个数据管道来接收、处理和查询时间序列数据。当您考虑下一步并转向生产级解决方案时，您应该考虑更多的事情。</p></div><div class="ab cl nz oa hu ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="ij ik il im in"><h1 id="cbbd" class="ms mt iq bd mu mv ou mx my mz ov nb nc jw ow jx ne jz ox ka ng kc oy kd ni nj bi translated">其他注意事项</h1><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mh"><img src="../Images/69cb289cc7dbeb4849d1348abe519c5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cExFZiw49HPrwfqG.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">来源:<a class="ae lb" href="https://docs.redislabs.com/latest/images/rs/TimeSeries-downsampling1.png" rel="noopener ugc nofollow" target="_blank"> RedisLabs文档</a></figcaption></figure><p id="2496" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">优化</strong> <code class="fe lc ld le lf b"><strong class="kh ir">RedisTimeSeries</strong></code></p><ul class=""><li id="46a1" class="ls lt iq kh b ki kj kl km ko lu ks lv kw lw la lx ly lz ma bi translated"><a class="ae lb" href="https://oss.redislabs.com/redistimeseries/configuration/#retention_policy" rel="noopener ugc nofollow" target="_blank">保留策略</a>:考虑一下这个问题，因为你的时间序列数据点<em class="mg">在默认情况下不会</em>被修剪/删除。</li><li id="1269" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated">下采样/聚合<a class="ae lb" href="https://oss.redislabs.com/redistimeseries/commands/#aggregation-compaction-downsampling" rel="noopener ugc nofollow" target="_blank">规则</a>:你不想永远存储数据，对吧？确保配置适当的规则来解决这个问题(例如<code class="fe lc ld le lf b">TS.CREATERULE temp:1:2 temp:avg:30 AGGREGATION avg 30000</code>)</li><li id="41c4" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated">重复数据政策:您希望如何处理重复样本？确保默认策略(<code class="fe lc ld le lf b">BLOCK</code>)确实是您需要的。如果没有，考虑<a class="ae lb" href="https://oss.redislabs.com/redistimeseries/configuration/#duplicate_policy" rel="noopener ugc nofollow" target="_blank">其他选项</a>。</li></ul><blockquote class="mm mn mo"><p id="e29f" class="kf kg mg kh b ki kj jr kk kl km ju kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">这不是一份详尽的清单。对于其他配置选项，请参考 <code class="fe lc ld le lf b"><a class="ae lb" href="https://oss.redislabs.com/redistimeseries/configuration/" rel="noopener ugc nofollow" target="_blank"><em class="iq">RedisTimeSeries</em></a></code> <a class="ae lb" href="https://oss.redislabs.com/redistimeseries/configuration/" rel="noopener ugc nofollow" target="_blank"> <em class="iq">文档</em> </a></p></blockquote><p id="d159" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">长期数据保留怎么样？</strong></p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi oz"><img src="../Images/a7739ca685a78dea6e219fd4486fcd17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5Q0UJCV3Fi9aiVQQ.png"/></div></div></figure><p id="4a62" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">数据是宝贵的，包括时间序列！您可能希望对其进行进一步处理，例如，运行机器学习以提取洞察力、预测性维护等。为了实现这一点，您需要将这些数据保留更长的时间，并且为了经济高效，您需要使用可扩展的对象存储服务，如第二代Azure数据湖存储(ADLS第二代)。</p><p id="e18b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这有一个连接器！你可以通过使用完全托管的<a class="ae lb" href="https://docs.confluent.io/cloud/current/connectors/cc-azure-datalakeGen2-storage-sink.html" rel="noopener ugc nofollow" target="_blank">Azure Data Lake Storage gen 2 Sink Connector for Confluent Cloud</a>在ADLS处理和存储数据，然后使用<a class="ae lb" href="https://docs.microsoft.com/azure/synapse-analytics/spark/apache-spark-machine-learning-mllib-notebook?WT.mc_id=data-17927-abhishgu#predictive-analysis-example-on-nyc-taxi-data" rel="noopener ugc nofollow" target="_blank"> Azure Synapse Analytics </a>或<a class="ae lb" href="https://docs.microsoft.com/azure/databricks/applications/machine-learning/?WT.mc_id=data-17927-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure Databricks </a>运行机器学习，来增强现有的数据管道。</p><p id="ec4e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">可扩展性</strong></p><p id="e2b0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您的时间序列数据量只能向一个方向移动—向上！您的解决方案必须能够从多个角度进行扩展，这一点至关重要:</p><ul class=""><li id="f42b" class="ls lt iq kh b ki kj kl km ko lu ks lv kw lw la lx ly lz ma bi translated">核心基础设施:托管服务允许团队专注于解决方案，而不是建立和维护基础设施，特别是在涉及复杂的分布式系统(如数据库)和流媒体平台(如Redis和Kafka)时。</li><li id="91f8" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated">Kafka Connect:就数据管道而言，由于Kafka Connect平台本质上是无状态的和可水平扩展的，因此您可以放心使用。就如何设计和调整Kafka Connect worker集群而言，您有很多选择。</li><li id="7808" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated">定制应用程序:和这个解决方案一样，我们构建了一个定制应用程序来处理Kafka主题中的数据。幸运的是，同样的可伸缩性特征也适用于它们。就水平比例而言——它只受您拥有的Kafka主题分区数量的限制。</li></ul><blockquote class="mm mn mo"><p id="69a1" class="kf kg mg kh b ki kj jr kk kl km ju kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated"><em class="iq">整合:不只是Grafana！</em> <code class="fe lc ld le lf b"><em class="iq">RedisTimeSeries</em></code> <em class="iq">还集成了</em> <a class="ae lb" href="https://github.com/RedisTimeSeries/prometheus-redistimeseries-adapter" rel="noopener ugc nofollow" target="_blank"> <em class="iq">普罗米修斯</em> </a> <em class="iq">和</em><a class="ae lb" href="https://github.com/RedisTimeSeries/telegraf" rel="noopener ugc nofollow" target="_blank"><em class="iq">Telegraf</em></a><em class="iq">。然而，在写这篇博文的时候还没有Kafka连接器——这将是一个很好的附件！</em></p></blockquote></div><div class="ab cl nz oa hu ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="ij ik il im in"><h1 id="e761" class="ms mt iq bd mu mv ou mx my mz ov nb nc jw ow jx ne jz ox ka ng kc oy kd ni nj bi translated">结论</h1><p id="7dfa" class="pw-post-body-paragraph kf kg iq kh b ki nk jr kk kl nl ju kn ko nm kq kr ks nn ku kv kw no ky kz la ij bi translated">当然，您可以使用Redis做(几乎)任何事情，包括时间序列工作负载！一定要考虑数据管道的端到端架构，以及从时间序列数据源到Redis和其他数据源的集成。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi pa"><img src="../Images/7eef0f7348b412c52224aa3428142d46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WxDcnoWED_wJ9dzku5BttQ.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">Redis所有的东西！</figcaption></figure></div></div>    
</body>
</html>