<html>
<head>
<title>An ALBatross Around the Neck</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">脖子上的负担</h1>
<blockquote>原文：<a href="https://itnext.io/an-albatross-around-the-neck-a8894edde21?source=collection_archive---------3-----------------------#2022-02-16">https://itnext.io/an-albatross-around-the-neck-a8894edde21?source=collection_archive---------3-----------------------#2022-02-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9db9" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated"><strong class="ak">克服与AWS ALB和WAF的集成挑战，确保符合NIST 800–53标准的环境</strong></h2></div><p id="57d6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi lb translated"><span class="l lc ld le bm lf lg lh li lj di">B</span>ack 2021年9月，AWS宣布了网络负载平衡器的一项新功能——能够添加应用负载平衡器作为网络负载平衡器的直接目标。从表面上看，这对客户来说是一个巨大的胜利:NLBs和ALBs有两个完全不同的用例及特性集，这使得应用程序可以同时利用这两者。我不会一一列举比较它们，因为互联网上已经有数百篇这样的文章了(链接到<a class="ae lk" href="https://aws.amazon.com/elasticloadbalancing/features/?nc=sn&amp;loc=2&amp;dn=1" rel="noopener ugc nofollow" target="_blank"> AWS比较</a>)。这一新特性的主要原因是为了适应ALB没有静态IP地址的事实——它们是随机变化的；而NLB具有静态IP。</p><p id="82cf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这导致了许多与安全服务的集成问题——主要是防火墙和网络地址转换。常见的模式是:</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi ll"><img src="../Images/872cde7749e0e28e9de734dddce43056.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OzCDszY-87ce3sU6RXmrkg.jpeg"/></div></div><figcaption class="lx ly gj gh gi lz ma bd b be z dk translated">有时，防火墙前面会有一个应用程序负载平衡器，奇怪地称为ALB三明治，带有一个公共ALB和一个内部ALB(这将有助于限制防火墙上所需的接口和IP数量，因为您可以基于第7层路由将流量转发到防火墙上的不同端口，并将流量发送到其最终目的地)。我从来没有真正理解为什么这个架构模式被命名为ALB三明治。火鸡三明治外面没有火鸡...</figcaption></figure><ol class=""><li id="6806" class="mb mc iq kh b ki kj kl km ko md ks me kw mf la mg mh mi mj bi translated">发往app1.domain.com的流量将被转发到某个基于DNS循环的防火墙上的公共接口(在防火墙术语中有时称为“不可信”接口)。</li><li id="fdfe" class="mb mc iq kh b ki mk kl ml ko mm ks mn kw mo la mg mh mi mj bi translated">防火墙将根据其规则检查数据包。</li><li id="6fee" class="mb mc iq kh b ki mk kl ml ko mm ks mn kw mo la mg mh mi mj bi translated">防火墙会以NAT为目标，即将目标IP地址从防火墙的公共接口更改为应用VPC中内部应用负载平衡器的IP地址，然后相应地对其进行路由。</li></ol><p id="e792" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是，正如我们已经确定的那样，ALB IPs将在某个时候发生变化。这将始终破坏NAT，从而破坏您的应用程序—防火墙不是反向代理—您不能NAT到FQDN，只能NAT到IP地址。</p><p id="61cd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这给客户留下了三个选择:</p><ol class=""><li id="1c36" class="mb mc iq kh b ki kj kl km ko md ks me kw mf la mg mh mi mj bi translated">AWS发布了一个解决方案(如果AWS在这个新的ALB目标类型下使用这样的东西，我不会感到震惊)。</li></ol><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi mp"><img src="../Images/e296cbb628657833297ca218cf1ddeb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jNythbo1IjRtiOuRrGeZhQ.jpeg"/></div></div><figcaption class="lx ly gj gh gi lz ma bd b be z dk translated"><a class="ae lk" href="https://aws.amazon.com/blogs/networking-and-content-delivery/using-aws-lambda-to-enable-static-ip-addresses-for-application-load-balancers/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/networking-and-content-delivery/using-AWS-lambda-to-enable-static-IP-addresses-for-application-load-balancers/</a></figcaption></figure><ol class=""><li id="0efc" class="mb mc iq kh b ki kj kl km ko md ks me kw mf la mg mh mi mj bi translated">向DNS查询ALB使用的IP地址。将结果(新IP列表)上传到S3存储桶。</li><li id="0896" class="mb mc iq kh b ki mk kl ml ko mm ks mn kw mo la mg mh mi mj bi translated">调用<a class="ae lk" href="https://docs.aws.amazon.com/cli/latest/reference/elbv2/describe-target-health.html" rel="noopener ugc nofollow" target="_blank">describe-target-health</a>API操作来获取当前注册到NLB的IP地址列表(注册列表)。</li><li id="a946" class="mb mc iq kh b ki mk kl ml ko mm ks mn kw mo la mg mh mi mj bi translated">下载以前的IP地址列表(旧列表)。如果这是Lambda函数的第一次调用，那么这个IP地址列表是空的。</li><li id="8283" class="mb mc iq kh b ki mk kl ml ko mm ks mn kw mo la mg mh mi mj bi translated">将新列表发布到Lambda函数的CloudWatch Logs日志流。这可以在以后用于搜索ALB使用的IP地址。</li><li id="642d" class="mb mc iq kh b ki mk kl ml ko mm ks mn kw mo la mg mh mi mj bi translated">更新跟踪内部ALB IP地址数量的CloudWatch指标(在第一次调用时创建)。此指标显示自上次运行以来更改了多少IP地址。如果您想跟踪一段时间内您的负载平衡器拥有多少个IP地址，这很有用。您可以通过将CW_METRIC_FLAG_IP_COUNT设置为“false”来禁用它。这是一个CloudWatch指标的示例，显示ALB的IP地址数量从20个变成了24个，然后又变成了28个。</li><li id="356a" class="mb mc iq kh b ki mk kl ml ko mm ks mn kw mo la mg mh mi mj bi translated">向NLB注册在新列表中但在旧列表或注册列表中缺失的IP地址。</li><li id="aeea" class="mb mc iq kh b ki mk kl ml ko mm ks mn kw mo la mg mh mi mj bi translated">注销旧列表中新列表中没有的IP地址。</li></ol><p id="755a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 2。许多防火墙供应商了解了ALB的这一“特性”,并在他们的防火墙中内置了类似的功能。您将提供ALB的FQDN，防火墙将按计划(例如，每30秒)查询DNS，然后将DNS查询返回的IP地址存储为在NAT中使用的实际值。我们已经在几十个AWS环境中无缝地实现了这一点。</strong></p><p id="b6d3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 3。使用一个运行cron的自定义脚本来完成以上任务——仅在您的防火墙不支持“FQDN NAT”或者您不想引入AWS出于任何原因提供的NLB和Lambda cron作业时使用。</strong></p><h1 id="9b27" class="mq mr iq bd ms mt mu mv mw mx my mz na jw nb jx nc jz nd ka ne kc nf kd ng nh bi translated">下面是我的抱怨:</h1><p id="bceb" class="pw-post-body-paragraph kf kg iq kh b ki ni jr kk kl nj ju kn ko nk kq kr ks nl ku kv kw nm ky kz la ij bi translated">如果这个额外的NLB的唯一目的是为我的ALB提供一个静态IP，为什么我必须支付全价？我不要求它是免费的—我完全理解NLB正在使用资源并向客户提供功能。我本人非常感谢AWS能够推荐客户在实施本<a class="ae lk" href="https://aws.amazon.com/blogs/networking-and-content-delivery/deployment-models-for-aws-network-firewall/" rel="noopener ugc nofollow" target="_blank">链接</a>的图11中概述的类似架构时使用这一新的NLB-ALB目标集成。我们的计划是使用应用了AWS WAF的中央入口ALB，并使用IP目标模式将流量转发到另一个VPC的内部NLB后面的资源。(无耻之徒，我们还利用了我在博客中写的关于的<a class="ae lk" rel="noopener ugc nofollow" target="_blank" href="/cdk-once-more-unto-the-breach-f2673cf219a6?source=your_stories_page"> cdk-nwfirewall CDK构造来简化AWS网络防火墙)。</a></p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi nn"><img src="../Images/cc16b9e2c7a8e1afca7fdf4f579b201f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qWL5WgmixuS-pME_.png"/></div></div><figcaption class="lx ly gj gh gi lz ma bd b be z dk translated">这是图11的副本，因此您不必单击链接——尽管在我的架构中，我将VPC检查和VPC中央出口结合在一起。</figcaption></figure><p id="cf93" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是我跑题了。对于大型工作负载而言，网络负载平衡器的成本可能是一笔不小的费用，我们估计，在客户的ALB前安装这种NLB每年会额外花费300-500美元，这样我们就可以获得静态IP。这不是一个令人望而却步的巨大成本，但向客户解释他们的成本只是上涨了，这一点也不好玩。</p><p id="0f95" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">我想看到的:</strong></p><p id="a7d0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我希望NLB能以折扣价出售，如果它只是用来展示ALB的话——比方说50%的折扣。显然，如果NLB也有标准的EC2目标，我不指望有折扣。然而，对于客户来说，支付全价来绕过AWS引入的设计限制似乎是一种惩罚，并且会给环境带来额外的复杂性。即使在我上面提到的架构中，仅使用AWS本地服务，如果您的应用程序中需要第7层路由并希望将其托管在中央WAF之后，也需要这一额外的层。我知道还有其他体系结构可以消除对NLB的需求，但它们并不总是一个选项，例如，如果您通过防火墙管理器部署WAF，以集中管理应用于组织中所有应用程序负载平衡器的Web ACLs，则托管应用程序负载平衡器的帐户必须由组织来管理。</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div class="gh gi no"><img src="../Images/0da18adf59733d8d756f48393d99aefa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1302/format:webp/1*ob3jeC3wxCO1nSAUaM2opQ.jpeg"/></div><figcaption class="lx ly gj gh gi lz ma bd b be z dk translated">在这种架构中，我们不需要通过单个ALB集中控制流量并转发到静态IP目标，但所有应用程序帐户都必须在AWS组织中。</figcaption></figure><p id="db97" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们的情况并非如此，我们本质上是向我们的客户提供防火墙即服务，他们仍然拥有自己的应用程序帐户，他们只是希望有人来配置和管理符合NIST标准的边界保护。</p><p id="18ee" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我要补充的是，该功能确实与Global Accelerator有一些重叠，因为它们都向ALBs提供静态IP——尽管Global Accelerator仅适用于公共IP。由于引擎盖下发生的路由魔术，我可以调和全球加速器的成本。支持这一点所需的资源当然值得额外的成本。</p><p id="d64c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">警告:请不要使用公共NLB来代替使用全局加速器。Global accelerator使用边缘位置将您的应用流量传送到AWS的主干网络(世界第八大奇迹？？)更快，而不是让流量穿过整个互联网到达您的公共IP。</p></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><p id="0591" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Matthew是领先的AWS网络安全合作伙伴stackArmor的高级解决方案总监，该公司为希望满足合规框架安全要求的客户设计定制解决方案:FedRAMP、NIST 800系列、PCI-DSS、国防部SRG、HIPAA、FISMA、FIPS 140–2(和3)等。StackArmor提供了一个经过AWS审核的解决方案，可以加速FedRAMP ATO的运行并降低40%以上的成本。</p></div></div>    
</body>
</html>