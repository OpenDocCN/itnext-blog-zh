<html>
<head>
<title>How to Run Databases in Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Kubernetes中运行数据库</h1>
<blockquote>原文：<a href="https://itnext.io/stateful-workloads-in-kubernetes-e49b56a5959?source=collection_archive---------0-----------------------#2022-09-03">https://itnext.io/stateful-workloads-in-kubernetes-e49b56a5959?source=collection_archive---------0-----------------------#2022-09-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><h1 id="d581" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">介绍</h1><p id="a0c1" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">如果你对<a class="ae lm" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq iu"> Kubernetes </strong> </a>不陌生，你可能已经听过无数次了:“<strong class="kq iu"> <em class="ln">不要在Kubernetes上运行数据库！</em></strong>”；如果你在2016年，这可能是真的，但现在不是了；事实上，我甚至可以说,<strong class="kq iu"> Kubernetes现在是运行有状态工作负载的最佳平台。</strong></p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi lo"><img src="../Images/c1fc0def6b8ab95cebc67ce3eba2bd12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*309-pDZ2bqZQDRHr"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">照片由<a class="ae lm" href="https://unsplash.com/@ventiviews?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">通风视图</a>在<a class="ae lm" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">防溅罩</a>上拍摄</figcaption></figure><p id="9159" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">在本文中，我将尝试<strong class="kq iu">改变您对在</strong><a class="ae lm" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kq iu">Kubernetes</strong></a><strong class="kq iu"/>中运行有状态工作负载的想法，并尝试说服您，在许多情况下，这是您可以采取的最佳方法。我还将讨论不同的选择以及何时不在Kubernetes中运行数据库。</p><p id="29d0" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">这篇文章分为两部分，第一部分关注如何在Kubernetes中运行数据库，第二部分关注何时应该在Kubernetes中运行数据库。</p><p id="3a66" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">让我们从一堂快速的历史课开始，然后我们将深入到用例中。</p><h1 id="f72c" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">简史</h1><p id="1d42" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">虽然很多招聘者有时会要求有10年以上经验的工程师；Kubernetes 1.0发布于<strong class="kq iu"> 2015 </strong>。它是由谷歌创建的，并作为开源在云本地计算基金会下发布。</p><p id="25ba" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">由于云计算和云原生应用的兴起，它变得流行起来。它的采用在过去几年中呈指数增长，现在Kubernetes是运行容器最流行的方式。</p><p id="ee10" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">在我看来，它成功的关键是<strong class="kq iu">拥有正确的抽象层次</strong>；不要太低，这样就不可能管理，也不要太高或固执己见。许多工程师抱怨复杂性，许多框架和工具是在Kubernetes之上开发的，以解决特定的问题或用例，使其更加固执己见。事实是，Kubernetes正在成为在任何环境中运行工作负载的事实上的标准，无论是在云上还是在本地。<strong class="kq iu">关键是它的API </strong>，可以扩展以创建更高级别的抽象，这将允许我们使用相同的标准和熟悉的<strong class="kq iu"> YAML </strong>文件部署任何工作负载。</p><p id="2ad3" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">多亏了可扩展的Kubernetes API，随着时间的推移，新的特性不断增加，公司开发了针对特定工作负载的定制API。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mj"><img src="../Images/fb3b5bf78bc028f853f796218bc4e48f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9WsPjvATZDcXxEK3.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">库伯内特建筑</figcaption></figure><p id="1589" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">Kubernetes早期版本的一个问题是，部署复杂的应用程序非常麻烦，因为你需要编写和维护许多行YAML文件。为了简化部署，<a class="ae lm" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq iu"> Helm </strong> </a>于2016年推出，如今是Kubernetes中打包和部署工作负载的事实上的方法，尽管Helm有几个<a class="ae lm" href="https://github.com/kubernetes-sigs/kustomize" rel="noopener ugc nofollow" target="_blank">替代方案</a>。</p><p id="4752" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">多亏了<strong class="kq iu"> Helm </strong>，可以非常容易的打包复杂的应用，可以包含微服务、PVC、服务、秘密等。变成一张图表。这就是为什么Kubernetes是以高效和安全的方式运行<a class="ae lm" href="https://en.wikipedia.org/wiki/Microservices" rel="noopener ugc nofollow" target="_blank"> <strong class="kq iu">微服务</strong> </a>的最佳平台。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mk"><img src="../Images/02516ef05b23a8a8b238d5c8392c3b86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XSNM92M44vmdyrJm"/></div></div></figure><p id="f12c" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated"><a class="ae lm" href="https://microservices.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq iu">微服务</strong> </a>是<strong class="kq iu">无状态</strong>服务，因此它们是在Kubernetes上运行的完美工作负载，这允许它们快速扩展或缩减。如果出现任何故障，Kubernetes控制回路将重启吊舱。然而，当我们谈到数据库等有状态工作负载时，事情变得更加复杂。当您想要扩展时，不能只添加更多的副本。一些数据库只支持只读副本，其他的需要重新平衡。其他数据库不能重启，需要正常关闭。此外，操作数据库更加复杂，我们需要执行许多操作任务，如备份、恢复、监控、警报等。</p><p id="88cc" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">由于运行数据库的复杂性，许多公司决定<strong class="kq iu">在虚拟机</strong>中运行他们的数据库，或者使用第三方管理的数据库。这些服务将负责运行数据库的所有操作开销。这是Kubernetes中最常见的方法，其中<strong class="kq iu">应用程序运行在Kubernetes集群上，并连接到运行在其他地方的数据库</strong>。这种方法有很多缺点，我们将在后面讨论可扩展性。一旦事情清楚了，我们不能假设应用程序是无状态的，它们需要状态，问题是状态在哪里，在Kubernetes内还是在Kubernetes外。</p><p id="f5b8" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">但是在我们讨论这个之前，让我们更深入地了解如何在Kubernetes上运行数据库…</p><h1 id="6888" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">状态集</h1><p id="be81" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在Kubernetes中运行有状态工作负载的第一步是引入<a class="ae lm" href="https://en.wikipedia.org/wiki/Kubernetes#StatefulSets" rel="noopener ugc nofollow" target="_blank"><strong class="kq iu">stateful sets</strong></a><strong class="kq iu"/>，它提供了允许在Kubernetes中运行有状态应用程序的基本功能。</p><p id="86ed" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated"><a class="ae lm" href="https://en.wikipedia.org/wiki/Kubernetes#StatefulSets" rel="noopener ugc nofollow" target="_blank"><strong class="kq iu">stateful sets</strong></a><strong class="kq iu"/>为数据库等有状态工作负载提供可预测的<strong class="kq iu">顺序</strong>和<strong class="kq iu">状态</strong>。它们以可预测顺序按比例放大或缩小。这对数据库非常重要:</p><ul class=""><li id="1457" class="ml mm it kq b kr me kv mf kz mn ld mo lh mp ll mq mr ms mt bi translated">对于主从架构，这允许有一个可预测的主节点(第一个)和许多次节点。</li><li id="d457" class="ml mm it kq b kr mu kv mv kz mw ld mx lh my ll mq mr ms mt bi translated">对于环形架构，这允许自我发现和数据再平衡。</li></ul><p id="6542" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated"><strong class="kq iu"> StatefulSets </strong>也有一个基于此顺序的唯一DNS名称，这对工作负载很重要，如<a class="ae lm" href="https://en.wikipedia.org/wiki/Apache_Kafka" rel="noopener ugc nofollow" target="_blank"> Apache Kafka </a>在它们的代理之间分发数据；因此，一个经纪人不同于另一个经纪人。在这种情况下，实例唯一性的概念很重要。</p><p id="d206" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">简而言之，StatefulSets是在pod的实例中强制执行<strong class="kq iu">唯一性</strong>和<strong class="kq iu">排序</strong>属性的控制器，可用于运行有状态应用程序。它们还允许客户端负载平衡，因为客户端可以通过带有顺序后缀的固定名称来发现和复制副本。</p><p id="0eca" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">作为一个例子，假设我们想要部署一个带有一个主节点和两个只读节点的<a class="ae lm" href="https://www.postgresql.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq iu"> PostgreSQL </strong> </a>数据库。如果我们使用常规Kubernetes部署，pod将获得一个随机名称，Kubernetes服务会将流量重定向到任何副本，客户端将连接到服务，并且不知道谁是主只写pod，谁是副本。这样不行。我们需要一种方法来识别主节点和次节点。对于StatefulSets，pod有一个由名称+后缀组成的可预测名称。例如，<code class="fe mz na nb nc b">postgres-0</code>将是第一个pod，在我们的例子中是主节点。辅助节点将是<code class="fe mz na nb nc b">postgres-1, postgres-2.</code>,这样客户端就有办法识别主节点。</p><p id="e254" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">此外，持久卷声明(<a class="ae lm" href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq iu"> PVCs </strong> </a>)对于<strong class="kq iu">statefullsets</strong>是稳定的，因此，如果一个pod终止并在另一个节点中获得重新调度，则相同的卷会装载到新节点中，并具有相同的数据。</p><blockquote class="nd ne nf"><p id="ae13" class="ko kp ln kq b kr me kt ku kv mf kx ky ng mg lb lc nh mh lf lg ni mi lj lk ll im bi translated">StatefulSets对于需要下列一项或多项的应用程序很有价值。</p><p id="d8dd" class="ko kp ln kq b kr me kt ku kv mf kx ky ng mg lb lc nh mh lf lg ni mi lj lk ll im bi translated">-稳定、唯一的网络标识符。</p><p id="b5bc" class="ko kp ln kq b kr me kt ku kv mf kx ky ng mg lb lc nh mh lf lg ni mi lj lk ll im bi translated">-稳定、持久的存储。</p><p id="1b7d" class="ko kp ln kq b kr me kt ku kv mf kx ky ng mg lb lc nh mh lf lg ni mi lj lk ll im bi translated">-有序、优雅的部署和扩展。</p><p id="5547" class="ko kp ln kq b kr me kt ku kv mf kx ky ng mg lb lc nh mh lf lg ni mi lj lk ll im bi translated">-有序的自动滚动更新。</p></blockquote><p id="2a32" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">虽然<strong class="kq iu"> StatefulSets </strong>的特性对于运行数据库极其重要，但是它们<strong class="kq iu">不足以运行生产级数据库</strong>，然而它们是所有有状态应用程序共有的最佳抽象。</p><p id="014e" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">有状态工作负载需要日常操作，如备份、压缩等。此外，纵向扩展可能需要拷贝数据或自我发现。这通常是通过安装某种“代理”来实现的，该代理监视集群并在发现新节点时执行操作。</p><p id="8302" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">所有这些操作都依赖于每个数据库及其架构(环、主-辅等)，它们是非常特定于应用程序的；我们不能为每个数据库构建一个Statefulset，以便在添加或删除节点时让代理或操作员执行操作。</p><p id="38bc" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">然而，正如我们之前提到的，Kubernetes API是高度可扩展的，允许开发人员扩展它来创建新的对象。Kubernetes连续控制循环可以监视这些对象，并且可以实现特定于给定数据库的操作符。</p><h1 id="7eb0" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">如何在Kubernetes中运行有状态工作负载</h1><p id="d7a1" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们已经看到，随着<strong class="kq iu"> StatefulSets </strong>的引入，我们获得了运行数据库的构建模块，但是您需要额外的功能来运行生产就绪数据库。这就是人们说我们不应该在Kubernetes上运行数据库的原因吗？嗯，不完全是…</p><h2 id="5e6c" class="nj jr it bd js nk nl dn jw nm nn dp ka kz no np ke ld nq nr ki lh ns nt km nu bi translated">我可以在Kubernetes中运行有状态的工作负载吗？</h2><p id="3e9e" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">答案是:<strong class="kq iu">是的！</strong></p><p id="219a" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">根据来自Kubernetes 的<a class="ae lm" href="https://dok.community/" rel="noopener ugc nofollow" target="_blank">数据的最新报告:</a></p><blockquote class="nv"><p id="dcba" class="nw nx it bd ny nz oa ob oc od oe ll dk translated"><strong class="ak"> <em class="of"> 90%的客户认为it已经为有状态工作负载做好了准备，绝大多数(70%)客户在生产环境中运行这些工作负载，其中数据库居于首位。</em> </strong> <em class="of">公司报告称，标准化、一致性和管理是重要的驱动因素。</em></p></blockquote><p id="61ce" class="pw-post-body-paragraph ko kp it kq b kr og kt ku kv oh kx ky kz oi lb lc ld oj lf lg lh ok lj lk ll im bi translated">在Kubernetes中运行数据库在管理和成本方面有很多优势，虽然复杂，但利大于弊。Kubernetes提供了一个大家都熟悉的统一框架。它还提供了正确的抽象级别来运行任何工作负载。<a class="ae lm" href="https://azure.microsoft.com/en-us/resources/cloud-computing-dictionary/what-is-devops/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq iu"> DevOps </strong> </a>熟悉Kubernetes的工程师更喜欢使用同样熟悉的数据库API，而不是学习和维护数据库的并行部署。这实现了真正的<strong class="kq iu"> DevOps </strong>原则，即每个人都使用相同的语言，使用相同的工具来部署任何工作负载，无论是微服务、批处理作业还是数据库。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/108b3c0e22de367eef9bed6b4fa7cf81.png" data-original-src="https://miro.medium.com/v2/resize:fit:866/format:webp/1*TJiw-nr374vzO69kLA5rOQ.png"/></div></figure><p id="954c" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">关键是<strong class="kq iu">自动化</strong>，对于云原生应用程序，我们希望减少所需的手动工作量。我们不想进行手动备份，甚至不想进行手动恢复。</p><p id="4195" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">我们希望在Kubernetes API中创建新的对象，并构建依赖于奇妙的<strong class="kq iu"> Kubernetes控制循环</strong>的操作符来监听关于这些对象的事件并采取相应的行动。例如，我们可以创建一个名为<code class="fe mz na nb nc b">PostgresDB</code>的新Kubernetes API，它可以在YAML定义并像部署一样应用。缺少的部分是监视部署的操作员，当它被更新以添加新的副本时，它将调用其他pod来应用适当的更改。</p><h2 id="9932" class="nj jr it bd js nk nl dn jw nm nn dp ka kz no np ke ld nq nr ki lh ns nt km nu bi translated">在Kubernetes上运行有状态工作负载的最佳方式是什么？</h2><p id="65d0" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">答案是:<strong class="kq iu">使用一个</strong> <a class="ae lm" href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq iu">运算符</strong></a><strong class="kq iu">+</strong><a class="ae lm" href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/" rel="noopener ugc nofollow" target="_blank"><strong class="kq iu">CRDs</strong></a><strong class="kq iu">。</strong></p><p id="4078" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated"><a class="ae lm" href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq iu">有状态集</strong> </a>是有状态工作负载的构建块，但是它们太基础了。对于数据库，您需要创建备份、复制数据、扩展集群、创建备用集群、灾难恢复、监控等等。</p><p id="d765" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated"><strong class="kq iu">CRD</strong>用于使用新对象扩展Kubernetes API，在我们的示例中，将定义一个CRD来描述使用新的<code class="fe mz na nb nc b">PostgresDB</code> API的PostgreSQL集群。</p><p id="1a32" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">创建<a class="ae lm" href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq iu">操作符</strong> </a>模式是为了允许集群管理员创建应用程序，这些应用程序可以使用现有的Kubernetes控制循环和API来监视集群中的资源并采取行动。</p><p id="b3af" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">使用<a class="ae lm" href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq iu">操作符</strong></a><strong class="kq iu">+</strong><a class="ae lm" href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/" rel="noopener ugc nofollow" target="_blank"><strong class="kq iu">CRDs</strong></a>我们可以创建Kubernetes对象来表示可以作为任何其他资源来管理的数据库集群，而<strong class="kq iu">操作符</strong>将监视Kubernetes API的任何变化并采取行动。例如，如果我们增加副本，它将处理数据复制和备份，如果我们添加注释，它将触发恢复，等等。这个解决方案非常强大，它使用了Kubernetes最擅长的技术，即监视资源并采取实时行动。并针对特定的数据库或技术对其进行定制。</p><p id="2094" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">数据库的所有者/贡献者只需要写一个<strong class="kq iu"> CRD </strong>来描述数据库和一个操作者来管理新的CRD。CRD将基于StatefulSet对象，但将具有额外的属性，如备份时间表、连接池、内存设置等。这些属性将对<strong class="kq iu">操作者</strong>可用，操作者只需监听发生在CRD对象上的事件。因此，如果我们更改YAML文件以添加新节点，操作员可以触发数据重新平衡。</p><p id="59cd" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated"><strong class="kq iu"> StatefulSets </strong>提供所有类型的有状态工作负载所需的构建块，然后每个数据库必须创建自己的操作符；但是我在哪里可以找到这些操作员呢？答案是<a class="ae lm" href="https://operatorhub.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq iu">运营商枢纽</strong> </a>，在这里你可以找到数以千计的运营商几乎任何数据库。</p><p id="184d" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">操作符<strong class="kq iu">的一大好处</strong>是因为它们扩展了Kubernetes API，它们<strong class="kq iu">与许多Kubernetes工具</strong>兼容。例如，<a class="ae lm" href="https://www.gitops.tech/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq iu"> GitOps </strong> </a>工具如<a class="ae lm" href="https://argo-cd.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq iu"> ArgoCD </strong> </a>可用于部署数据库，就像它们用于部署微服务一样。<a class="ae lm" href="https://argo-cd.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq iu"> ArgoCD </strong> </a>将对待新的CRDs和其他资源一样。</p><h2 id="3877" class="nj jr it bd js nk nl dn jw nm nn dp ka kz no np ke ld nq nr ki lh ns nt km nu bi translated">示例:PostgreSQL运算符</h2><p id="5a7d" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><strong class="kq iu"> PostgreSQL </strong>是一个流行的数据库，并且<a class="ae lm" href="https://operatorhub.io/?keyword=postgresql" rel="noopener ugc nofollow" target="_blank">操作中心</a>有许多<a class="ae lm" href="https://operatorhub.io/?keyword=postgresql" rel="noopener ugc nofollow" target="_blank">操作符</a>准备用于生产工作负载。最受欢迎的操作符是<a class="ae lm" href="https://access.crunchydata.com/documentation/postgres-operator/v5/" rel="noopener ugc nofollow" target="_blank"><strong class="kq iu">crunchy data</strong></a><strong class="kq iu">PostgreSQL</strong>操作符，它是所有操作符中功能最丰富的，在生产中被许多公司使用。</p><p id="e8cc" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">我们需要一个操作员来为我们处理常见的数据库操作，同时仍然利用<strong class="kq iu"> Kubernetes </strong>对象，以便以相同的方式管理有状态和无状态工作负载。我们还想要一款与<a class="ae lm" href="https://www.gitops.tech/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq iu"> GitOps </strong> </a>工具兼容的产品，比如<a class="ae lm" href="https://argo-cd.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank"> <strong class="kq iu"> ArgoCD </strong> </a>以声明的方式管理和监控我们的工作负载。</p><p id="9404" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated"><a class="ae lm" href="https://access.crunchydata.com/documentation/postgres-operator/v5/" rel="noopener ugc nofollow" target="_blank"><strong class="kq iu">crunchy data</strong></a><strong class="kq iu">PostgreSQL</strong>操作员创建一个自定义的<strong class="kq iu"> CRD </strong>来表示由操作员管理的数据库，允许它自己停止和启动实例。ArgoCD可以管理操作符，而操作符管理DB实例，从而创建另一个抽象级别。集群管理人员只需要维护操作员，开发人员可以管理数据库，实现真正的<strong class="kq iu"> DevOps </strong>体验。</p><p id="ef9d" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated"><a class="ae lm" href="https://access.crunchydata.com/documentation/postgres-operator/v5/" rel="noopener ugc nofollow" target="_blank"><strong class="kq iu">crunchy data</strong></a><strong class="kq iu">PostgreSQL运算符特性</strong></p><p id="de9b" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">Crunchy Data的<a class="ae lm" href="https://access.crunchydata.com/documentation/postgres-operator/v5/quickstart/" rel="noopener ugc nofollow" target="_blank"> Postgres操作符</a>为企业级PostgreSQL编制了一个商业分布式工具集，开箱即用，具有以下特性:</p><ul class=""><li id="3611" class="ml mm it kq b kr me kv mf kz mn ld mo lh mp ll mq mr ms mt bi translated">Crunchy认证PostgreSQL</li><li id="e201" class="ml mm it kq b kr mu kv mv kz mw ld mx lh my ll mq mr ms mt bi translated">备份</li><li id="e4c2" class="ml mm it kq b kr mu kv mv kz mw ld mx lh my ll mq mr ms mt bi translated">监控和仪表板工具</li><li id="f216" class="ml mm it kq b kr mu kv mv kz mw ld mx lh my ll mq mr ms mt bi translated">坦克激光瞄准镜（Tank Laser-Sight的缩写）</li><li id="504e" class="ml mm it kq b kr mu kv mv kz mw ld mx lh my ll mq mr ms mt bi translated">连接池</li><li id="5965" class="ml mm it kq b kr mu kv mv kz mw ld mx lh my ll mq mr ms mt bi translated">自动自我修复高可用性</li><li id="733f" class="ml mm it kq b kr mu kv mv kz mw ld mx lh my ll mq mr ms mt bi translated">轻松的集群部署和管理</li><li id="6254" class="ml mm it kq b kr mu kv mv kz mw ld mx lh my ll mq mr ms mt bi translated">零停机更新</li></ul><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi om"><img src="../Images/dc2f2709bd281d2a53540e0d23100f15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_zp5lBCUj1l5NsiSDSZz_A.png"/></div></div></figure><p id="3bdd" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated"><a class="ae lm" href="https://access.crunchydata.com/documentation/postgres-operator/v5/(https://github.com/CrunchyData/postgres-operator)" rel="noopener ugc nofollow" target="_blank"> PostgreSQL操作符</a>，给你一个<strong class="kq iu">声明性PostgreSQL </strong>解决方案，自动管理你的<a class="ae lm" href="https://www.postgresql.org/" rel="noopener ugc nofollow" target="_blank"> PostgreSQL </a>集群。</p><p id="f334" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">专为您的<strong class="kq iu"> GitOps </strong>工作流而设计，使用PGO在Kubernetes上使用PostgreSQL非常容易。</p><p id="fc50" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">有了像克隆PostgreSQL集群到使用滚动更新以最短的停机时间推出破坏性更改这样的便利，<strong class="kq iu">PGO</strong>(<a class="ae lm" href="https://access.crunchydata.com/documentation/postgres-operator/v5/quickstart/" rel="noopener ugc nofollow" target="_blank">Postgres Operator</a>)随时准备在发布管道的每个阶段支持您的PostgreSQL数据。PGO是为弹性和正常运行时间而构建的，它会将您想要的PostgreSQL保持在一个理想的状态，因此您不必担心它。</p><p id="9edb" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">简而言之，<a class="ae lm" href="https://access.crunchydata.com/documentation/postgres-operator/v5/(https://github.com/CrunchyData/postgres-operator)" rel="noopener ugc nofollow" target="_blank"> Postgres操作符</a>支持ArgoCD、Helm、任何版本的Kubernetes、<strong class="kq iu">任何云</strong>，并提供运行和维护PostgreSQL集群所需的所有需求，尤其是零宕机更新和轻松备份。</p><p id="f082" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">这是一个完美的例子，展示了<strong class="kq iu"> Kubernetes </strong>的强大功能及其强大的<strong class="kq iu">可扩展性</strong>，允许我们在任何环境中部署任何工作负载。</p><h1 id="cf6c" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">可供选择的事物</h1><p id="9b6b" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">您需要做出的关键决定是在Kubernetes内部还是外部运行您的数据库。我们认为在Kubernetes中运行所有的工作负载是可能的，而且有很多优点。它<strong class="kq iu">统一了您的运营平台，降低了成本，并提供了完全不受云影响的唯一现实方法。</strong></p><p id="da2b" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">同时，许多数据库在开发时并没有考虑到Kubernetes，在Kubernetes上运行可能会有问题。大多数现代数据库现在都支持Kubernetes，但是您应该首先进行研究，确保您的目标数据库有一个针对Kubernetes的成熟操作符。尽管如此，数据库需要数据库特定的技能，这是普通开发工程师所不具备的，这就是为什么我们有专门从事数据库管理的数据库管理员(<strong class="kq iu">DBA</strong>)。通常，一个DBA会专注于一个数据库，比如PostgreSQL admin或Cassandra admin。这些专家通常不具备Kubernetes的技能。但是，这个问题在Kubernetes中得到了缓解，因为操作员自动执行过去DBA会执行的任务，如监控和备份。</p><p id="b470" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">但是在我们继续之前，让我们回顾一下，如果您不使用Kubernetes来运行您的数据库，您有什么选择。</p><h2 id="f74a" class="nj jr it bd js nk nl dn jw nm nn dp ka kz no np ke ld nq nr ki lh ns nt km nu bi translated">虚拟机</h2><p id="5d21" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这可能是最常见的选择。您可以在云中或内部使用它。所有数据库都支持该选项。</p><p id="64f2" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">这种选择具有成本效益和便携性。您只需要确保数据库二进制文件可用于您的目标平台。</p><p id="d3ab" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">如果您在虚拟机中运行工作负载，并且没有使用Kubernetes，那么请继续使用虚拟机。最好先迁移无状态工作负载，然后再决定如何处理数据库。</p><p id="333d" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">这个选项的问题是<strong class="kq iu">不是云友好的</strong>，<strong class="kq iu">抽象级别太低</strong>。你需要操作系统技能，网络技能，监控技能等。您需要了解如何为给定的操作系统安装和修补不同的库。</p><h2 id="e46c" class="nj jr it bd js nk nl dn jw nm nn dp ka kz no np ke ld nq nr ki lh ns nt km nu bi translated">云管理的数据库</h2><p id="7c60" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">主要的云提供商如<strong class="kq iu"> AWS </strong>或<a class="ae lm" href="https://cloud.google.com/gcp/?hl=en" rel="noopener ugc nofollow" target="_blank">T3】GCPT5】，有数据库服务如</a><a class="ae lm" href="https://www.mysql.com/" rel="noopener ugc nofollow" target="_blank"> MySQL </a>，PostgreSQL或<a class="ae lm" href="https://cassandra.apache.org/_/index.html" rel="noopener ugc nofollow" target="_blank"> Cassandra </a>。这些服务易于使用，因为它们是SaaS服务。</p><p id="da2d" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">云提供商提供自动化和配置来轻松备份和恢复数据。这是在云中部署数据库的最简单的方法。</p><p id="a916" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">然而，您将需要使用<a class="ae lm" href="https://en.wikipedia.org/wiki/Terraform_(software)" rel="noopener ugc nofollow" target="_blank"> <strong class="kq iu"> Terraform </strong> </a>或另一个<a class="ae lm" href="https://en.wikipedia.org/wiki/Infrastructure_as_code" rel="noopener ugc nofollow" target="_blank"> IaC </a>工具来构建自动化，以供应数据库并设置配置。请注意，如果您在一个多云环境中，您将需要为每个提供者编写不同的IaC，这非常耗时。</p><p id="57b4" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">这种方法的主要优点是非常容易安装和使用。<strong class="kq iu">缺点</strong>是<strong class="kq iu">缺乏跨云提供商的可移植性</strong>，成本以及缺乏控制和定制选项。</p><h2 id="8b9a" class="nj jr it bd js nk nl dn jw nm nn dp ka kz no np ke ld nq nr ki lh ns nt km nu bi translated">第三方管理的数据库</h2><p id="9d32" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">该选项类似于前一个选项，不同之处在于管理数据库运营方面的不是云提供商，而是第三方公司。</p><p id="b164" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">这种方法的主要优点是，理论上，这家公司将解决多云问题，允许你在任何云中运行数据库。如果您需要在多个云中部署您的应用程序，并且您没有使用PostgreSQL或MySQL，那么如果您不想管理数据库，您将需要走这条路。</p><p id="67b5" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">大多数数据库供应商都会提供可以在任何云中使用的云产品，尽管每个云提供商的支持和选项可能会有所不同。一些供应商还将提供托管服务，他们可以在您的帐户内部署和操作数据库，而不是在他们的帐户上。</p><p id="0790" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">这种方法的缺点是其成本、让第三方管理数据的法律影响以及每个云提供商的不同支持/定制级别。</p><h2 id="c694" class="nj jr it bd js nk nl dn jw nm nn dp ka kz no np ke ld nq nr ki lh ns nt km nu bi translated">利弊</h2><p id="50ff" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">下表总结了每个选项的优缺点:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi on"><img src="../Images/f7b3810975a72fe433f796f41af11b2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uEEXCrbj5EYgmBg_n7i1Jw.png"/></div></div></figure><p id="0752" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated"><strong class="kq iu">第三方托管数据库</strong>最容易上手，它是一款完全SaaS产品。一些例子是<a class="ae lm" href="https://www.elastic.co/cloud/" rel="noopener ugc nofollow" target="_blank">弹性云</a>、<a class="ae lm" href="https://www.mongodb.com/cloud" rel="noopener ugc nofollow" target="_blank"> MongoDB云</a>或<a class="ae lm" href="https://www.scylladb.com/product/scylla-cloud/" rel="noopener ugc nofollow" target="_blank"> ScyllaDB云</a>。这些服务为您管理<strong class="kq iu">多云</strong>部署，并提供最佳支持。如果您不想自己运行数据库，这可能是最简单的选择；毫无疑问，如果数据库不是MySQL或PostgreSQL，这将是唯一的选择，因为这些是主要云提供商中唯一可用的数据库。这种方法的问题是非常<strong class="kq iu">昂贵</strong>，往往<strong class="kq iu">难以定制</strong>，而且由于数据安全和国家法律的原因，对于许多组织来说这可能是不可行的。一些公司提供了一种方法来将数据保留在您的云帐户中，并仍然为您管理它，因此您仍然是数据的所有者，但这也有法律影响，因为将有另一家公司管理和访问数据。如果这不是一个关心你，你有预算，这将阿格很好的选择。</p><p id="2ffe" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated"><strong class="kq iu">云供应商数据库</strong>是运行有状态服务的一种简单方式，云供应商提供了不错的支持和一些定制选项。对于多云部署来说，这不是一个好的选择。即使您使用MySQL或PostgreSQL，它们是主要云提供商中唯一可用的数据库，它们支持的版本、定制选项、安全性或网络也因云提供商而异；使得在多云环境中维护非常困难。例如，对于PostgreSQL，您只有一个可用的扩展子集，并且在撰写本文时Azure仅支持版本11。这种云服务也很昂贵，可能会有许多隐性成本，如出口费、备份费等。您仍然需要编写<a class="ae lm" href="https://en.wikipedia.org/wiki/Infrastructure_as_code" rel="noopener ugc nofollow" target="_blank"> <strong class="kq iu"> IaC </strong> </a>来提供数据库并管理备份和恢复。支持不如第三方供应商，但他们更便宜。</p><p id="88a5" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">使用运营商在Kubernetes中运行数据库非常便宜，因为你可以使用Kubernetes共享基础设施。由于Kubernetes和操作者的强大功能，部署和维护都很容易；可能没有之前的选项那么简单，但是<strong class="kq iu"> DevOps </strong>工程师将会使用熟悉的Kubernetes语法。这个选项非常容易部署和开始；只需安装操作器并开始提供数据库。主要的缺点是，这是“自己动手”的方法，你将得不到支持。</p><p id="aa02" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">最后一个选项是在<strong class="kq iu">虚拟机</strong>中运行。这与在<strong class="kq iu"> VM vs Kubernetes </strong>中运行任何工作负载的想法是一样的，我们可能需要另一篇文章来讨论利弊。</p><p id="233a" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">简而言之，如果您已经在使用Kubernetes，那么也在Kubernetes中部署有状态服务，而不是在有操作者的数据库中部署虚拟机。如果数据库不是Kubernetes友好的，或者您不使用Kubernetes，请继续使用VMs。</p><h1 id="f16e" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">用例</h1><p id="562e" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">让我们看一下根据您在哪里运行工作负载，您有哪些不同的选项。让我们假设您已经有了一个Kubernetes集群，并且您正在那里运行一些工作负载。</p><h2 id="3d64" class="nj jr it bd js nk nl dn jw nm nn dp ka kz no np ke ld nq nr ki lh ns nt km nu bi translated">酒店内</h2><p id="b868" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">如果您在本地或私有云中运行<strong class="kq iu">，Kubernetes通常是最佳选择之一，因为它统一了工作负载管理和监控。</strong></p><p id="3d79" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">在这种情况下，对于数据库来说，如果数据库有一个操作符并且对Kubernetes友好的话，<strong class="kq iu"> Kubernetes </strong>将是最好的选择。如果没有，请在虚拟机中部署数据库并单独管理它。</p><p id="ce45" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">在Kubernetes中运行数据库将更加容易，因为操作员将负责更新、备份、监控等工作。与<strong class="kq iu">虚拟机</strong>相比，自动化运营开销。</p><h2 id="1034" class="nj jr it bd js nk nl dn jw nm nn dp ka kz no np ke ld nq nr ki lh ns nt km nu bi translated">单朵云</h2><p id="961a" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">如果您致力于单一云提供商(供应商锁定)，那么您可以利用云托管服务来实现<strong class="kq iu">轻松采用和低运营开销</strong>。您需要考虑成本，特别是隐性成本，如备份存储、网络出口等。</p><p id="225d" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated"><strong class="kq iu">始终使用符合您需求的数据库，而不是试图将您的需求放入特定的数据库</strong>。例如，如果您有一个层次/图形模型，不要试图使用关系数据库。在这种情况下，如果云提供商有针对所需数据库的托管解决方案，并且您负担得起，请选择它；这会节省你很多时间。</p><p id="d725" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">如果数据库在云提供商处不可用，您有3种选择:</p><ul class=""><li id="000d" class="ml mm it kq b kr me kv mf kz mn ld mo lh mp ll mq mr ms mt bi translated">使用<strong class="kq iu">第三方托管服务</strong>:这很贵，但与云托管服务具有相同的优势。也检查一下法律含义。我个人更喜欢使用第三方管理的数据库，以防我需要支持许多云，因为这些公司会为您解决多云问题。</li><li id="81e8" class="ml mm it kq b kr mu kv mv kz mw ld mx lh my ll mq mr ms mt bi translated">使用<strong class="kq iu"> Kubernetes </strong>，如果数据库有一个操作符并且对Kubernetes友好，这是最好的选择。</li><li id="dee4" class="ml mm it kq b kr mu kv mv kz mw ld mx lh my ll mq mr ms mt bi translated">使用<strong class="kq iu">虚拟机</strong>:如果DB不是Kubernetes友好的，并且托管选项不可用或太贵，请使用此选项。</li></ul><p id="ceb4" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">如果你在一个单独的云中，并且你致力于它，那么尽可能使用托管数据库，但是要注意成本，因为它们可能很昂贵，如果你想更有成本意识，可以考虑使用Kubernetes。</p><h2 id="9088" class="nj jr it bd js nk nl dn jw nm nn dp ka kz no np ke ld nq nr ki lh ns nt km nu bi translated">多重云</h2><p id="892b" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这是最复杂的场景。您需要部署和支持所有主要的云提供商，甚至可能是本地的。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi oo"><img src="../Images/3f45550de469e18eac2881df22ce3bf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ph9cVotPK2gWUGpI"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">插入很酷的图片，这样你就不会累了，你可以继续阅读，你就快完成了！</figcaption></figure><p id="e9ee" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">在这种情况下，<strong class="kq iu">云管理的数据库会有问题</strong>。第一，3大云提供商中只支持<strong class="kq iu"> MySQL </strong>和<strong class="kq iu"> PostgreSQL </strong>，所以你会非常受限。甚至，如果您使用这两个数据库中的一个，每个云提供商的设置、自动化、成本结构和网络都不同；这意味着您通过使用托管解决方案节省的时间将用于支持跨云提供商的数据库自动化和配置。令人惊讶的是，我已经见过这个选项几次了，但我不推荐它，它在纸上看起来不错，但由于云提供商之间的差异，你很快就会遇到问题。</p><p id="1ef0" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated"><strong class="kq iu">第三方托管服务</strong>旨在解决这一问题，通常提供多种云支持。请注意，它们可能不支持所有地区，因此请提前检查。此外，定制选项可能非常有限，您可能无法调整数据库或底层硬件。如果您有第三方处理您的数据，您还需要检查安全性和法律含义，特别是关于数据保护的当地法律。对许多公司来说，这可能是行不通的。最后，这将是一个<strong class="kq iu">昂贵的</strong>解决方案。</p><p id="340f" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">在我看来，如果您需要支持多云环境，<strong class="kq iu"> Kubernetes </strong>将是最佳解决方案，因为它提供了跨所有云提供商和本地的统一解决方案。此外，越来越多的云提供商进入市场，在未来几年，我们将看到更多的云提供商，支持他们的唯一方式将是使用Kubernetes。</p><p id="6480" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">同样，如果数据库不支持Kubernetes，您将需要使用VMs。</p><h1 id="703c" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">结论</h1><p id="5555" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在本文中，我们似乎有不同的选择来部署数据库，现在已经清楚的是<strong class="kq iu"> Kubernetes提供了最可移植和最有效的平台来运行有状态工作负载</strong>。这是您必须支持多个云提供商和本地的唯一方法。多亏了操作人员，您可以轻松地部署和管理数据库。不要使用<em class="ln">舵图</em>运行<strong class="kq iu">生产</strong>中的数据库，确保目标数据库存在<strong class="kq iu">操作员</strong>。</p><p id="66fd" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">如果你在<strong class="kq iu"> Kubernetes </strong>中运行<strong class="kq iu">微服务</strong>，那么<a class="ae lm" href="https://en.wikipedia.org/wiki/Domain-driven_design" rel="noopener ugc nofollow" target="_blank">域驱动设计</a>规定每个微服务都应该有自己的数据存储。这一直是个问题，因为过去在Kubernetes中部署数据库很困难，所以许多公司最终都使用托管数据库，由于成本和复杂性，这些托管服务由另一个团队运行，该团队只支持非常少量的数据库。这意味着开发者经常在不同的微服务之间共享数据库，这是一种反模式。Kubernetes解决了这个问题<strong class="kq iu">,允许每个跨职能团队以统一的方式在数据库旁部署微服务</strong>,团队拥有并管理数据库，而不会违反<strong class="kq iu"> DevOps </strong>最佳实践。</p><p id="a491" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">Kubernetes仍在呈指数级增长，如今大多数数据库都提供定制的CRDs和<strong class="kq iu">操作员</strong>在Kubernetes中运行它们。如果您已经在使用Kubernetes，运行数据库将是您的最佳选择，因为您将使用熟悉的API和语法。</p><p id="b7b2" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">Kubernetes面向未来，拥有庞大的用户群，并为任何类型的工作负载提供统一的管理层，为每个人提供真正的体验。您将在<em class="ln"> YAML </em>中定义您的资源，并部署它们，而不管资源的类型，它可以是数据库、微服务或批处理作业。这使得管理和监控更加容易。</p><p id="8eae" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated"><strong class="kq iu"> Kubernetes </strong>也极其<strong class="kq iu">成本</strong> <strong class="kq iu">有效</strong>并且提供了许多不同的选项来节省成本，比如共享资源、<strong class="kq iu"> spot实例</strong>支持和自动缩放。</p><p id="bb3e" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">我要提出两项重要建议:</p><ul class=""><li id="a954" class="ml mm it kq b kr me kv mf kz mn ld mo lh mp ll mq mr ms mt bi translated">对于问题域，始终使用正确的数据库。不要试图让你的模型适合数据库，而是相反。我见过一些公司试图在关系数据库中对图形数据建模，因为这是他们可以得到的。这是一个坏主意，Kubernetes解决了这个问题，因为你可以运行任何数据库，这打开了无限可能的大门。</li><li id="6327" class="ml mm it kq b kr mu kv mv kz mw ld mx lh my ll mq mr ms mt bi translated">采用一致统一的方式部署工作负载。如果可能，不要混合溶液。不要让一些数据库在云提供商中运行，其他数据库由第三方托管服务运行，其他数据库在虚拟机中运行，等等。维护不同解决方案的运营开销是巨大的，应该避免。如今，您的公司使用不同的数据库是很正常的，您的云提供商很难支持所有这些数据库，并且让几家第三方公司管理您的数据会非常昂贵或复杂。<strong class="kq iu">这就是为什么我认为Kubernetes是需要支持许多环境和不同工作负载类型的现代云原生SaaS公司的唯一解决方案。</strong></li></ul><p id="7480" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">总的来说，由于Kubernetes的快速发展，它似乎已经成为以高效且经济的方式部署任何工作负载的事实标准。多亏了新的<strong class="kq iu">操作员模式</strong>，这现在包括数据库和其他复杂系统。<strong class="kq iu"> Kubernetes提供了在任何环境下运行数据库的最便携、最安全、最值得信赖、最经得起未来考验、最具成本效益和最可靠的方式。</strong></p></div><div class="ab cl op oq hx or" role="separator"><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou"/></div><div class="im in io ip iq"><p id="2569" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated"><strong class="kq iu">更新</strong>:我目前在坦桑尼亚帮助当地的一所学校，我创建了一个<a class="ae lm" href="https://www.gofundme.com/f/help-the-mango-school-children-in-tanzania" rel="noopener ugc nofollow" target="_blank"> <strong class="kq iu"> GoFundMe活动</strong> </a>来帮助孩子们，通过这个<a class="ae lm" href="https://www.gofundme.com/f/help-the-mango-school-children-in-tanzania" rel="noopener ugc nofollow" target="_blank">链接</a>来捐款，每一点帮助！</p><p id="37c9" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated"><em class="ln">记得来</em> <strong class="kq iu"> <em class="ln">拍拍</em> </strong> <em class="ln">如果你喜欢这篇文章还有</em> <a class="ae lm" href="https://javier-ramos.medium.com/subscribe" rel="noopener"> <em class="ln"> </em> <strong class="kq iu"> <em class="ln">关注</em></strong><em class="ln"/><strong class="kq iu"><em class="ln">me</em></strong></a><em class="ln">或者</em> <a class="ae lm" href="https://javier-ramos.medium.com/membership" rel="noopener"> <strong class="kq iu"> <em class="ln">订阅</em> </strong> </a> <em class="ln">获取更多更新！</em></p><p id="5549" class="pw-post-body-paragraph ko kp it kq b kr me kt ku kv mf kx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated"><a class="ae lm" href="https://javier-ramos.medium.com/subscribe" rel="noopener"> <strong class="kq iu">订阅</strong> </a>获得<strong class="kq iu">通知</strong>当我发表一篇文章和<a class="ae lm" href="https://javier-ramos.medium.com/membership" rel="noopener"> <strong class="kq iu">加入Medium.com</strong></a>访问数百万或文章！</p></div></div>    
</body>
</html>