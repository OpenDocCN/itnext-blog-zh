<html>
<head>
<title>Terraform: don’t use kubernetes provider with your cluster resource!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terraform:不要在集群资源中使用kubernetes provider！</h1>
<blockquote>原文：<a href="https://itnext.io/terraform-dont-use-kubernetes-provider-with-your-cluster-resource-d8ec5319d14a?source=collection_archive---------1-----------------------#2021-02-02">https://itnext.io/terraform-dont-use-kubernetes-provider-with-your-cluster-resource-d8ec5319d14a?source=collection_archive---------1-----------------------#2021-02-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/393fabf0abf6fadc985f9e01d3681356.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uTu054LBzLIGCVg8"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">由<a class="ae kc" href="https://unsplash.com/@officestock?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">塞巴斯蒂安·赫尔曼</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="8251" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">不要担心，您仍然可以在集群中部署名称空间，但是要小心。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><p id="f5d9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以你使用terraform来创建一个kubernetes集群。在集群中创建一些资源并不少见。像一些名称空间、RBAC、网络策略，甚至可能部署入口控制器。你决定这一切都属于基础设施，terraform是你的IaC工具。</p><p id="4a2b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">幸运的是，terraform有kubernetes提供者可以做到这一点。</p><p id="7a21" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们举一个简单的例子。它在其中创建了一个Azure Kubernetes服务集群和一个名称空间:</p><figure class="li lj lk ll gt jr"><div class="bz fp l di"><div class="lm ln l"/></div></figure><p id="e319" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您应用此脚本，3个资源将按正确的顺序创建，您将看到terraform的<em class="lo">绿色结果</em>。到目前为止一切顺利。</p><figure class="li lj lk ll gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lp"><img src="../Images/67d8d386a5ca90353e964f76f74d14ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HJpZcbROQld39xVBkl7IPw.png"/></div></div></figure><p id="62d0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这一点上，您可能会继续向项目添加基础设施，并且永远不会回头。</p><p id="1c0f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是，一旦您对集群配置进行了导致集群重新创建的更改，您就会惊讶地发现运行<code class="fe lq lr ls lt b">terraform refresh</code>时会发生什么。</p><p id="ad05" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你将开始得到奇怪的错误。</p><p id="8c41" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它可能是这样的:</p><pre class="li lj lk ll gt lu lt lv lw aw lx bi"><span id="8ddc" class="ly lz iq lt b gy ma mb l mc md">Error: Get “<a class="ae kc" href="http://localhost/api/v1/namespaces/demo" rel="noopener ugc nofollow" target="_blank">http://localhost/api/v1/namespaces/demo</a>": dial tcp 127.0.0.1:80: connect: connection refused</span></pre><p id="352a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者我还看到了这样的东西:</p><pre class="li lj lk ll gt lu lt lv lw aw lx bi"><span id="9b60" class="ly lz iq lt b gy ma mb l mc md">Error: Kubernetes cluster unreachable: invalid configuration: no configuration has been provided, try setting KUBERNETES_MASTER environment variable</span></pre><p id="fe9d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">kubernetes提供者的配置好像被重置了？但为什么是在refresh？</p><p id="6f80" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">不，它无助于设置资源之间的显式依赖关系。图表看起来相当不错:</p><figure class="li lj lk ll gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi me"><img src="../Images/34c560aa4baf147bd417bf7d0507d56a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cd_CwakpubxiZ8YAYdt7JA.png"/></div></div></figure><p id="9978" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像往常一样，只有在四处玩耍、摸索、搜索互联网之后，你才会最终仔细阅读官方的kubernetes提供者文档:</p><blockquote class="mf mg mh"><p id="0fc0" class="kd ke lo kf b kg kh ki kj kk kl km kn mi kp kq kr mj kt ku kv mk kx ky kz la ij bi translated">警告</p><p id="a3be" class="kd ke lo kf b kg kh ki kj kk kl km kn mi kp kq kr mj kt ku kv mk kx ky kz la ij bi translated">当使用插值将凭证从其他资源传递给Kubernetes提供者时，<strong class="kf ir">这些资源不应在使用Kubernetes提供者资源的同一个Terraform模块中创建</strong>。<strong class="kf ir">这将导致难以调试和诊断的间歇性和不可预测的错误。</strong>根本问题在于Terraform本身评估提供商区块与实际资源的顺序。更多说明请参考<a class="ae kc" href="https://www.terraform.io/docs/configuration/providers.html#provider-configuration" rel="noopener ugc nofollow" target="_blank">本节地形文件</a>。</p></blockquote><p id="172c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lo">粗体文字由我标注。</em></p><p id="3ae1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此这篇文章的标题。您需要将集群创建和资源创建分成两个不同的脚本。并且最好使用<a class="ae kc" href="https://www.terraform.io/docs/language/state/remote-state-data.html" rel="noopener ugc nofollow" target="_blank"> terraform远程状态</a>数据源为kubernetes提供者获取所需的集群信息。</p></div></div>    
</body>
</html>