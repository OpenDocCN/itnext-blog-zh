<html>
<head>
<title>Upgrading to Helm 3 with Flux CD</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Flux CD升级到Helm 3</h1>
<blockquote>原文：<a href="https://itnext.io/upgrading-to-helm-3-with-flux-cd-6b7014223a51?source=collection_archive---------3-----------------------#2020-04-15">https://itnext.io/upgrading-to-helm-3-with-flux-cd-6b7014223a51?source=collection_archive---------3-----------------------#2020-04-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/df459cefbbc98e5dfa2c1c28253ab3db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5HWAQE5wr8UvWatt.jpg"/></div></div></figure><figure class="kb kc kd ke gt ju"><div class="bz fp l di"><div class="kf kg l"/></div></figure><p id="28ae" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">即使上述内容在本周公开，Mettle的平台团队总是希望走在曲线的前面。因此，这篇博文的剩余部分将谈论我们将集群升级到v3的旅程。</p><h1 id="8523" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">准备</h1><p id="39b7" class="pw-post-body-paragraph kh ki it kj b kk md km kn ko me kq kr ks mf ku kv kw mg ky kz la mh lc ld le im bi translated">以下部分详细介绍了开始升级前所需的准备工作。</p><h2 id="95e1" class="mi lg it bd lh mj mk dn ll ml mm dp lp ks mn mo lt kw mp mq lx la mr ms mb mt bi translated">HelmRelease:全部默认为v2</h2><p id="91d6" class="pw-post-body-paragraph kh ki it kj b kk md km kn ko me kq kr ks mf ku kv kw mg ky kz la mh lc ld le im bi translated">作为准备，我们确保我们所有的头盔版本都指定了他们使用的头盔版本，这是通过添加以下内容来完成的:</p><pre class="kb kc kd ke gt mu mv mw mx aw my bi"><span id="43f7" class="mi lg it mv b gy mz na l nb nc">spec:<br/>  chart:<br/>    name: backend<br/>    repository: https://example.storage.googleapis.com<br/>  releaseName: account-balance<br/>  helmVersion: v2</span></pre><h2 id="29b7" class="mi lg it bd lh mj mk dn ll ml mm dp lp ks mn mo lt kw mp mq lx la mr ms mb mt bi translated">舵操作员:允许v2和v3图表</h2><p id="413a" class="pw-post-body-paragraph kh ki it kj b kk md km kn ko me kq kr ks mf ku kv kw mg ky kz la mh lc ld le im bi translated">我们需要在helm operator实例上设置以下选项，以便它可以支持Helm v2和v3:</p><pre class="kb kc kd ke gt mu mv mw mx aw my bi"><span id="732a" class="mi lg it mv b gy mz na l nb nc">- --enabled-helm-versions=v2,v3</span></pre><h2 id="e4c9" class="mi lg it bd lh mj mk dn ll ml mm dp lp ks mn mo lt kw mp mq lx la mr ms mb mt bi translated">赫尔姆:在本地安装v2和v3</h2><p id="fe70" class="pw-post-body-paragraph kh ki it kj b kk md km kn ko me kq kr ks mf ku kv kw mg ky kz la mh lc ld le im bi translated">为此，我们需要头盔2和头盔3，所以最好两个都安装，你可以通过执行以下命令来完成:</p><pre class="kb kc kd ke gt mu mv mw mx aw my bi"><span id="7421" class="mi lg it mv b gy mz na l nb nc"><strong class="mv iu">brew</strong> install helm@2<br/><strong class="mv iu">brew</strong> install helm<br/><strong class="mv iu">cd</strong> /usr/local/bin<br/><strong class="mv iu">ln -s</strong> /usr/local/opt/helm@2/bin/tiller tiller<br/><strong class="mv iu">ln -s</strong> /usr/local/opt/helm@2/bin/helm helm2<br/><strong class="mv iu">ln -s</strong> helm helm3</span></pre><p id="ccf0" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated"><strong class="kj iu">从现在开始你需要用</strong> <code class="fe nd ne nf mv b"><strong class="kj iu">helm3</strong></code> <strong class="kj iu">来控制第三代头盔，用</strong> <code class="fe nd ne nf mv b"><strong class="kj iu">helm2</strong></code> <strong class="kj iu">来控制第二代头盔。</strong></p><h1 id="39ef" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">升级工作流</h1><p id="2ae8" class="pw-post-body-paragraph kh ki it kj b kk md km kn ko me kq kr ks mf ku kv kw mg ky kz la mh lc ld le im bi translated">这篇博文的剩余部分描述了升级的工作流程。</p><h2 id="14bd" class="mi lg it bd lh mj mk dn ll ml mm dp lp ks mn mo lt kw mp mq lx la mr ms mb mt bi translated">停止舵操作员</h2><p id="00a2" class="pw-post-body-paragraph kh ki it kj b kk md km kn ko me kq kr ks mf ku kv kw mg ky kz la mh lc ld le im bi translated">我们需要停止集群中的helm操作符，以允许集群中现有的Helm版本进行升级。我们通过在部署中将副本数量扩展到零来实现这一点。</p><h2 id="6916" class="mi lg it bd lh mj mk dn ll ml mm dp lp ks mn mo lt kw mp mq lx la mr ms mb mt bi translated">在集群中升级helm版本</h2><p id="7149" class="pw-post-body-paragraph kh ki it kj b kk md km kn ko me kq kr ks mf ku kv kw mg ky kz la mh lc ld le im bi translated">为了升级集群中已经存在的helm版本，我们需要使用<a class="ae ng" href="https://github.com/helm/helm-2to3" rel="noopener ugc nofollow" target="_blank">https://github.com/helm/helm-2to3</a>。</p><p id="9099" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">首先，我们需要使用以下命令列出集群中所有现有的helm版本:</p><figure class="kb kc kd ke gt ju"><div class="bz fp l di"><div class="nh kg l"/></div></figure><h2 id="5273" class="mi lg it bd lh mj mk dn ll ml mm dp lp ks mn mo lt kw mp mq lx la mr ms mb mt bi translated">移除分蘖</h2><p id="a2a7" class="pw-post-body-paragraph kh ki it kj b kk md km kn ko me kq kr ks mf ku kv kw mg ky kz la mh lc ld le im bi translated">一旦我们将集群中现有的版本升级到v3，Tiller就不再需要运行了。我们通过在部署中将副本数量扩展到零来实现这一点。</p><h2 id="4f6c" class="mi lg it bd lh mj mk dn ll ml mm dp lp ks mn mo lt kw mp mq lx la mr ms mb mt bi translated">将HelmReleases升级到v3</h2><p id="7e1e" class="pw-post-body-paragraph kh ki it kj b kk md km kn ko me kq kr ks mf ku kv kw mg ky kz la mh lc ld le im bi translated">然后我们更新了我们所有的头盔版本，指定<code class="fe nd ne nf mv b">v3</code>为头盔版本，这是通过添加以下内容完成的:</p><pre class="kb kc kd ke gt mu mv mw mx aw my bi"><span id="3857" class="mi lg it mv b gy mz na l nb nc">spec:<br/>  chart:<br/>    name: backend<br/>    repository: <a class="ae ng" href="https://example.storage.googleapis.com" rel="noopener ugc nofollow" target="_blank">https://example.storage.googleapis.com</a><br/>  releaseName: account-balance<br/>  helmVersion: v3</span></pre><p id="ee73" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">将这些更改合并到您的集群中，并在启动Helm操作器之前等待集群中的所有<code class="fe nd ne nf mv b">HelmRelease</code>清单都使用v3。</p><p id="e286" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">你可以使用<code class="fe nd ne nf mv b">kubectl get hr -A -o yaml | grep ‘helmVersion: v2’</code>来确保所有的v2引用已经被完全移除。</p><h2 id="7612" class="mi lg it bd lh mj mk dn ll ml mm dp lp ks mn mo lt kw mp mq lx la mr ms mb mt bi translated">启动舵操作器</h2><p id="52aa" class="pw-post-body-paragraph kh ki it kj b kk md km kn ko me kq kr ks mf ku kv kw mg ky kz la mh lc ld le im bi translated">最后一步是将helm operator部署扩大到1个副本，并且只有<strong class="kj iu">允许发布版本3，这是通过添加以下内容完成的:</strong></p><pre class="kb kc kd ke gt mu mv mw mx aw my bi"><span id="eeb8" class="mi lg it mv b gy mz na l nb nc">- --enabled-helm-versions=v3</span></pre><p id="0a3a" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated"><strong class="kj iu">只允许</strong> <code class="fe nd ne nf mv b"><strong class="kj iu">v3</strong></code> <strong class="kj iu">这里是关键，因为集群不再有舵柄，所以</strong> <code class="fe nd ne nf mv b"><strong class="kj iu">v2</strong></code> <strong class="kj iu">不再是有效选项！</strong></p><h2 id="7290" class="mi lg it bd lh mj mk dn ll ml mm dp lp ks mn mo lt kw mp mq lx la mr ms mb mt bi translated">合并舵操作员变更</h2><p id="2aa3" class="pw-post-body-paragraph kh ki it kj b kk md km kn ko me kq kr ks mf ku kv kw mg ky kz la mh lc ld le im bi translated">建议首先合并舵操作员PR，并确保pod成功运行。</p><h2 id="ffb3" class="mi lg it bd lh mj mk dn ll ml mm dp lp ks mn mo lt kw mp mq lx la mr ms mb mt bi translated">合并HelmRelease更改</h2><p id="4ef5" class="pw-post-body-paragraph kh ki it kj b kk md km kn ko me kq kr ks mf ku kv kw mg ky kz la mh lc ld le im bi translated">现在将HelmRelease的更改合并到<code class="fe nd ne nf mv b">helmVersion:v3</code>中，现在是时候验证迁移工作了</p><h1 id="c1b5" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">健全性检查</h1><p id="8fcc" class="pw-post-body-paragraph kh ki it kj b kk md km kn ko me kq kr ks mf ku kv kw mg ky kz la mh lc ld le im bi translated">一旦重新打开头盔操作器，它就开始升级头盔释放装置。当描述一个<code class="fe nd ne nf mv b">HelmRelease</code>时，您将看到如下输出:</p><pre class="kb kc kd ke gt mu mv mw mx aw my bi"><span id="92b2" class="mi lg it mv b gy mz na l nb nc">Running upgrade for Helm release 'platinum-docs' in 'web'.</span></pre><p id="e109" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">你要等到所有的<code class="fe nd ne nf mv b">HelmRelease</code>资源都说:</p><pre class="kb kc kd ke gt mu mv mw mx aw my bi"><span id="c965" class="mi lg it mv b gy mz na l nb nc">Release was successful for Helm release ... </span></pre><p id="e80c" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">您可以通过运行以下命令来验证这一点:</p><pre class="kb kc kd ke gt mu mv mw mx aw my bi"><span id="64e7" class="mi lg it mv b gy mz na l nb nc">watch "kubectl get hr -A | grep -v 'Release was successful for Helm release'"</span></pre><p id="9b67" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">您希望上面的命令最终是一个空列表，一旦您看到这个，迁移就成功了。</p><h1 id="ce73" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">摘要</h1><p id="3c6b" class="pw-post-body-paragraph kh ki it kj b kk md km kn ko me kq kr ks mf ku kv kw mg ky kz la mh lc ld le im bi translated">总的来说，这是一个相当轻松的过程，从开始到结束需要大约一个小时来执行升级(每个环境)。我想再次感谢斯蒂芬·普罗丹(<a class="ae ng" href="https://twitter.com/stefanprodan" rel="noopener ugc nofollow" target="_blank">https://twitter.com/stefanprodan</a>)为我提出的升级战略提供咨询。</p></div></div>    
</body>
</html>