<html>
<head>
<title>Linux: gnome-keyring setup as Freedesktop SecretService</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Linux: gnome-keyring设置为Freedesktop SecretService</h1>
<blockquote>原文：<a href="https://itnext.io/linux-gnome-keyring-setup-as-freedesktop-secretservice-99521a20e9c4?source=collection_archive---------2-----------------------#2020-02-26">https://itnext.io/linux-gnome-keyring-setup-as-freedesktop-secretservice-99521a20e9c4?source=collection_archive---------2-----------------------#2020-02-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/deb75c286e41ceb103e9942038e4173e.png" data-original-src="https://miro.medium.com/v2/resize:fit:260/format:webp/0*sjoMw6nf7VjZunhd.png"/></div></figure><p id="7b71" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">目前，我使用KeePass作为密码，RSA-keys，并作为免费桌面SecretService，见<a class="ae ks" href="https://rtfm.co.ua/en/keepass-an-mfa-totp-codes-a-browsers-passwords-ssh-keys-passwords-storage-configuration-and-secret-service-integration/" rel="noopener ugc nofollow" target="_blank"> KeePass:一个MFA TOTP代码，一个浏览器的密码，SSH密钥密码存储配置和特勤局集成</a>职位。</p><p id="4b5c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这样的设置过程中，我面临的第一个问题是，KeePass的数据库在我的计算机之间同步(它的数据库只是存储在Dropbox文件夹中)，例如，KeePass重写了一些密码——Chromium为其本地SQLite数据库加密创建了自己的名为“<em class="kt"> Chromium Safe Storage </em>的密钥，它在每台PC上必须是不同的，但随着数据库的同步——我在这里遇到了一个问题。</p><p id="9f3e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">第二个不便之处是KeePass是用一个锁定的数据库启动的，在我不解锁它之前，应用程序不能开始使用它。</p><p id="2360" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，这可以通过使用<code class="fe ku kv kw kx b">-pw</code>选项(参见<a class="ae ks" href="https://keepass.info/help/base/cmdline.html" rel="noopener ugc nofollow" target="_blank"> KeePass选项</a>)或通过使用GPG密钥来实现自动化，但是这样我就失去了整个数据加密的想法，因为所有的访问凭证将以明文形式存储在同一个文件系统中。</p><p id="d412" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此——让我们尝试使用本地应用程序的<code class="fe ku kv kw kx b">gnome-keyring</code>作为SecretService，并将其他所有事情留给KeePass。</p><h2 id="541a" class="ky kz iq bd la lb lc dn ld le lf dp lg kf lh li lj kj lk ll lm kn ln lo lp lq bi translated">GNOME钥匙圈安装</h2><p id="794a" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">现在检查D-Bus <code class="fe ku kv kw kx b">org.freedesktop.secrets</code>服务:</p><pre class="lw lx ly lz gt ma kx mb mc aw md bi"><span id="74c8" class="ky kz iq kx b gy me mf l mg mh">$ ps aux |grep $(qdbus — session org.freedesktop.DBus / org.freedesktop.DBus.GetConnectionUnixProcessID org.freedesktop.secrets)<br/>setevoy 1534 0.0 0.6 705436 102524 tty1 SLl Jan09 0:03 keepassxc</span></pre><p id="4781" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">禁用KeePass中的SecretService支持，安装<code class="fe ku kv kw kx b">gnome-keyring</code>:</p><pre class="lw lx ly lz gt ma kx mb mc aw md bi"><span id="656b" class="ky kz iq kx b gy me mf l mg mh">$ sudo pacman -S gnome-keyring</span></pre><p id="220c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">再次检查SecretService:</p><pre class="lw lx ly lz gt ma kx mb mc aw md bi"><span id="1510" class="ky kz iq kx b gy me mf l mg mh">$ ps aux |grep $(qdbus — session org.freedesktop.DBus / org.freedesktop.DBus.GetConnectionUnixProcessID org.freedesktop.secrets)<br/>setevoy 829496 0.0 0.0 236292 8528 ? SLl 13:19 0:00 /usr/bin/gnome-keyring-daemon — start — foreground — components=secrets</span></pre><p id="2a36" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">开始，工作，选项- <code class="fe ku kv kw kx b"><em class="kt"> --start --foreground --components=secrets</em></code> -正确，一切就绪。</p><h2 id="ff76" class="ky kz iq bd la lb lc dn ld le lf dp lg kf lh li lj kj lk ll lm kn ln lo lp lq bi translated">GNOME钥匙圈在登录时解锁</h2><p id="217c" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">现在，需要在登录到操作系统期间添加存储解密，参见<a class="ae ks" href="https://wiki.archlinux.org/index.php/GNOME/Keyring#PAM_method" rel="noopener ugc nofollow" target="_blank"> Arch Wiki </a>和<a class="ae ks" href="https://wiki.gnome.org/Projects/GnomeKeyring/Pam/Manual" rel="noopener ugc nofollow" target="_blank"> GNOME手册</a>文档。</p><p id="1f37" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查库:</p><pre class="lw lx ly lz gt ma kx mb mc aw md bi"><span id="7fd4" class="ky kz iq kx b gy me mf l mg mh">$ ll /usr/lib/security/ | grep gnome<br/>-rwxr-xr-x 1 root root 46768 Oct 29 11:38 pam_gnome_keyring.so</span></pre><p id="1a04" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">编辑<code class="fe ku kv kw kx b">/etc/pam.d/login</code>，向<em class="kt">授权</em>和<em class="kt">会话</em>添加以下字符串:</p><pre class="lw lx ly lz gt ma kx mb mc aw md bi"><span id="ecdb" class="ky kz iq kx b gy me mf l mg mh">...<br/>auth       optional     pam_gnome_keyring.so<br/>...<br/>session    optional     pam_gnome_keyring.so auto_start<br/>...</span></pre><p id="c9db" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要在系统中更改用户密码时更新密匙环的密码，请在<code class="fe ku kv kw kx b">/etc/pam.d/passwd</code>中添加以下行:</p><pre class="lw lx ly lz gt ma kx mb mc aw md bi"><span id="2021" class="ky kz iq kx b gy me mf l mg mh">...<br/>password  optional     pam_gnome_keyring.so</span></pre><p id="8e00" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">文档说有必要将<code class="fe ku kv kw kx b">eval $(/usr/bin/gnome-keyring-daemon --start --components=secrets)</code>执行添加到<code class="fe ku kv kw kx b">~/.xinitrc</code>(或者，例如，<code class="fe ku kv kw kx b">~/.config/openbox/environment</code>)，但是在我的例子中，一切都已经在工作了(Arch Linux + Openbox DE，通过<code class="fe ku kv kw kx b">startx</code>手动启动X-server)。</p><p id="e205" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">重启电脑并再次检查D-Bus:</p><pre class="lw lx ly lz gt ma kx mb mc aw md bi"><span id="8e05" class="ky kz iq kx b gy me mf l mg mh">$ ps aux |grep $(qdbus — session org.freedesktop.DBus / org.freedesktop.DBus.GetConnectionUnixProcessID org.freedesktop.secrets)<br/>setevoy 1338 0.0 0.0 236376 6932 ? Sl 14:35 0:00 /usr/bin/gnome-keyring-daemon — daemonize — login</span></pre><p id="3095" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe ku kv kw kx b">gnome-keyring</code>流程:</p><pre class="lw lx ly lz gt ma kx mb mc aw md bi"><span id="e0cf" class="ky kz iq kx b gy me mf l mg mh">$ ps aux | grep gnome<br/>setevoy 1351 0.1 0.0 236288 6776 ? Sl 16:32 0:00 /usr/bin/gnome-keyring-daemon — daemonize — login<br/>setevoy 1874 0.0 0.0 235988 7244 ? Sl 16:33 0:00 /usr/bin/gnome-keyring-daemon — start — foreground — components=secrets</span></pre><h2 id="390e" class="ky kz iq bd la lb lc dn ld le lf dp lg kf lh li lj kj lk ll lm kn ln lo lp lq bi translated">登录和默认密钥环</h2><p id="c166" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">安装完成后，我们检查了服务，结果如下:</p><pre class="lw lx ly lz gt ma kx mb mc aw md bi"><span id="81d9" class="ky kz iq kx b gy me mf l mg mh">$ ps aux |grep $(qdbus — session org.freedesktop.DBus / org.freedesktop.DBus.GetConnectionUnixProcessID org.freedesktop.secrets)</span><span id="1a7d" class="ky kz iq kx b gy mi mf l mg mh">setevoy 829496 0.0 0.0 236292 8528 ? SLl 13:19 0:00 /usr/bin/gnome-keyring-daemon — start — foreground — components=secrets</span></pre><p id="51dd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是在我的家用笔记本电脑上“出了点问题”,只有<code class="fe ku kv kw kx b"><em class="kt">--daemonize --login</em></code> <em class="kt"> </em>启动了<code class="fe ku kv kw kx b">gnome-keyring-daemon</code>服务，没有<code class="fe ku kv kw kx b"><em class="kt">--components=secrets</em></code>:</p><pre class="lw lx ly lz gt ma kx mb mc aw md bi"><span id="4590" class="ky kz iq kx b gy me mf l mg mh">$ ps aux |grep $(qdbus — session org.freedesktop.DBus / org.freedesktop.DBus.GetConnectionUnixProcessID org.freedesktop.secrets)</span><span id="52dc" class="ky kz iq kx b gy mi mf l mg mh">setevoy 666 0.0 0.0 380756 7280 ? Sl 21:19 0:00 /usr/bin/gnome-keyring-daemon — daemonize — login</span></pre><p id="1155" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在Seahorse中(参见下面的gnome-keyring 部分的<a class="ae ks" href="https://rtfm.co.ua/?p=23147#Seahorse_GUI_gnome-keyring" rel="noopener ugc nofollow" target="_blank">Seahorse-GUI ),我有一个空的<em class="kt">登录</em> keyring和<em class="kt">默认</em>——它甚至无法解锁:</a></p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/d94cccdb011fd15b07058863ec086737.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/0*eqz6LLIHFMojtyfv.png"/></div></figure><p id="3542" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查钥匙圈文件:</p><pre class="lw lx ly lz gt ma kx mb mc aw md bi"><span id="9bea" class="ky kz iq kx b gy me mf l mg mh">$ ll .local/share/keyrings/.<br/>total 16<br/>-rw — — — — 1 setevoy setevoy 2689 Dec 8 09:38 Default_keyring.keyring<br/>-rw-r — r — 1 setevoy setevoy 15 Dec 6 08:51 default</span></pre><p id="12e1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">移除<em class="kt">Default _ keyring . keyring</em>和<em class="kt"> default </em>文件，重新登录——它现在工作了。</p><h2 id="377b" class="ky kz iq bd la lb lc dn ld le lf dp lg kf lh li lj kj lk ll lm kn ln lo lp lq bi translated">海马——用于<code class="fe ku kv kw kx b">gnome-keyring</code>的图形用户界面</h2><p id="5e99" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">安装海马:</p><pre class="lw lx ly lz gt ma kx mb mc aw md bi"><span id="dd9f" class="ky kz iq kx b gy me mf l mg mh">$ sudo pacman -S seahorse</span></pre><p id="ddce" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，运行浏览器Brave，并检查<em class="kt">登录</em>钥匙圈(必须由<code class="fe ku kv kw kx b">gnome-keyring</code>在首次登录系统后创建):</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi mk"><img src="../Images/a76fc9733b9e03c9e4eed75f7b65c689.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*THDx59E1ypKIC34q.png"/></div></div></figure><p id="4ae3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">出现了<em class="kt"> Brave安全存储</em>记录，因此— Brave正在使用<code class="fe ku kv kw kx b">gnome-keyring</code>，SecretService工作正常，一切正常。</p><p id="04a7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">数据库文件:</p><pre class="lw lx ly lz gt ma kx mb mc aw md bi"><span id="4d3f" class="ky kz iq kx b gy me mf l mg mh">$ ll .local/share/keyrings/<br/>total 8<br/>-rw — — — — 1 setevoy setevoy 2480 Jan 10 14:38 login.keyring<br/>-rw — — — — 1 setevoy setevoy 207 Jan 10 13:41 user.keystore</span></pre><h2 id="a06f" class="ky kz iq bd la lb lc dn ld le lf dp lg kf lh li lj kj lk ll lm kn ln lo lp lq bi translated">路径中没有这样的秘密集合:/</h2><p id="ae9b" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">有时，在创建新的密匙环时，海马可能会返回一个错误，显示“<strong class="jw ir"> <em class="kt">在path: / </em> </strong>中没有这样的秘密集合”消息:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/7447577a7e467aa582957372e11f95bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/0*zYBSAoxmtE0kph_K.png"/></div></figure><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/3423915d5c2b3d6a862a5b3f8dde208c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*tAJbgx8atEoXPhXo.png"/></div></figure><p id="e011" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">解决方案是更新D-Bus的环境变量:</p><pre class="lw lx ly lz gt ma kx mb mc aw md bi"><span id="7247" class="ky kz iq kx b gy me mf l mg mh">$ source /etc/X11/xinit/xinitrc.d/50-systemd-user.sh</span></pre><p id="4ec4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">完成了。</p></div><div class="ab cl mr ms hu mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="ij ik il im in"><p id="4a00" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="kt">最初发布于</em> <a class="ae ks" href="https://rtfm.co.ua/en/linux-gnome-keyring-setup-as-freedesktop-secretservice/" rel="noopener ugc nofollow" target="_blank"> <em class="kt"> RTFM: Linux、DevOps和系统管理</em> </a>。</p></div></div>    
</body>
</html>