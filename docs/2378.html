<html>
<head>
<title>Monitoring Kubernetes workloads with Prometheus and Thanos</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用普罗米修斯和灭霸监控Kubernetes的工作负载</h1>
<blockquote>原文：<a href="https://itnext.io/monitoring-kubernetes-workloads-with-prometheus-and-thanos-4ddb394b32c?source=collection_archive---------1-----------------------#2019-05-15">https://itnext.io/monitoring-kubernetes-workloads-with-prometheus-and-thanos-4ddb394b32c?source=collection_archive---------1-----------------------#2019-05-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><h1 id="2553" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">介绍</h1><p id="2520" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">恭喜你！你已经成功地说服了你的工程经理、副总裁R&amp;D或首席技术官，使用基于Kubernetes的容器将公司的工作负载迁移到微服务上。</p><p id="b0e0" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">你非常高兴，一切都在按计划进行，你创建了你的第一个<em class="lm"> Kubernetes </em>集群(所有三个主要的云提供商，<em class="lm"> Azure，AWS </em>和<em class="lm"> GCP </em>，有一个简单的方法来提供一个受管或不受管的Kubernetes平台)，开发了你的第一个容器化的应用程序，并将其部署到集群。那很容易，不是吗？:)</p><p id="c522" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">一段时间后，您意识到事情变得有点复杂，您有多个应用程序要部署到集群，因此您需要一个<em class="lm">入口控制器</em>，然后，在投入生产之前，您想要了解您的工作负载是如何执行的，因此您开始寻找一个监控解决方案，幸运的是，您找到了<a class="ae ls" href="https://prometheus.io" rel="noopener ugc nofollow" target="_blank"> <em class="lm"> Prometheus </em> </a>，部署它，添加<a class="ae ls" href="http://grafana.com" rel="noopener ugc nofollow" target="_blank"> <em class="lm"> Grafana </em> </a>，您就大功告成了！</p><p id="fe26" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">稍后，你开始疑惑——为什么普罗米修斯只带着一个副本运行？如果容器重启会发生什么？还是只是版本更新？普罗米修斯公司能保存我的数据多长时间？当集群关闭时会发生什么？我是否需要另一个集群用于高可用性和灾难恢复？我将如何与<em class="lm">普罗米修斯</em>进行集中查看？</p><p id="d94a" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">嗯，继续看，聪明人早就想通了。</p><h1 id="8e70" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">典型的Kubernetes集群</h1><p id="ab95" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">下图展示了一个基于Kubernetes的典型部署</p><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi lt"><img src="../Images/2305502585a2d0aa3e469b42eadc4555.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mIIRlptU4NG22N-bvITVIA.jpeg"/></div></div><figcaption class="mf mg gj gh gi mh mi bd b be z dk translated">典型的Kubernetes集群</figcaption></figure><p id="3d19" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">部署由三层组成:</p><ol class=""><li id="3f3f" class="mj mk it kq b kr ln kv lo kz ml ld mm lh mn ll mo mp mq mr bi translated">底层虚拟机—主节点和工作节点</li><li id="46dc" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mo mp mq mr bi translated">Kubernetes基础设施应用</li><li id="8b9e" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mo mp mq mr bi translated">用户应用程序</li></ol><p id="3414" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">不同的组件在内部相互通信，通常使用HTTP(s) (REST或gRPC)，其中一些组件向集群外部公开API(Ingress)，这些API主要用于</p><ol class=""><li id="0ae6" class="mj mk it kq b kr ln kv lo kz ml ld mm lh mn ll mo mp mq mr bi translated">通过Kubernetes API服务器进行集群管理</li><li id="2fc2" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mo mp mq mr bi translated">通过入口控制器暴露的用户应用交互</li></ol><p id="9a3d" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">在某些情况下，应用程序可能会将流量发送到群集外部(出口)以使用其他服务，如Azure SQL、Azure Blob或任何第三方服务。</p><h1 id="5275" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">监控什么？</h1><p id="2b9e" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">监控Kubernetes应考虑上述所有三个层面。</p><p id="dd08" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated"><strong class="kq iu">底层虚拟机:</strong>为确保底层虚拟机运行正常，应收集以下指标</p><ul class=""><li id="c8e2" class="mj mk it kq b kr ln kv lo kz ml ld mm lh mn ll mx mp mq mr bi translated">节点数量</li><li id="b12e" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mx mp mq mr bi translated">每个节点的资源利用率(CPU、内存、磁盘、网络带宽)</li><li id="28d9" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mx mp mq mr bi translated">节点状态(就绪、未就绪等。)</li><li id="5ee5" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mx mp mq mr bi translated">每个节点上运行的单元数量</li></ul><p id="1da2" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated"><strong class="kq iu"> Kubernetes基础设施:t </strong>为了确保Kubernetes基础设施的健康，应该收集以下指标</p><ul class=""><li id="aad3" class="mj mk it kq b kr ln kv lo kz ml ld mm lh mn ll mx mp mq mr bi translated">Pods运行状况—实例就绪、状态、重启、年龄</li><li id="6c7e" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mx mp mq mr bi translated">部署状态—期望的、当前的、最新的、可用的、年龄</li><li id="8eca" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mx mp mq mr bi translated">状态设置状态</li><li id="1ccf" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mx mp mq mr bi translated">CronJobs执行统计</li><li id="05e6" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mx mp mq mr bi translated">Pod资源利用率(CPU和内存)</li><li id="f131" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mx mp mq mr bi translated">健康检查</li><li id="256d" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mx mp mq mr bi translated">Kubernetes事件</li><li id="d1b2" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mx mp mq mr bi translated">API服务器请求</li><li id="e364" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mx mp mq mr bi translated">Etcd统计</li><li id="bd46" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mx mp mq mr bi translated">装载的卷统计信息</li></ul><p id="12e2" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated"><strong class="kq iu">用户应用程序:e </strong>每个应用程序都应该根据其核心功能公开自己的指标，但是，有些指标是大多数应用程序共有的，例如:</p><ul class=""><li id="933a" class="mj mk it kq b kr ln kv lo kz ml ld mm lh mn ll mx mp mq mr bi translated">HTTP请求(总数、延迟、响应代码等。)</li><li id="2caa" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mx mp mq mr bi translated">传出连接数(如数据库连接)</li><li id="ff9c" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mx mp mq mr bi translated">螺纹扣数</li></ul><p id="8ff1" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">收集上述指标，将允许您构建有意义的<strong class="kq iu">警报</strong>和<strong class="kq iu">仪表板</strong>，我们将在下面简要介绍。</p><h1 id="dc56" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">灭霸</h1><p id="9cdc" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><a class="ae ls" href="https://github.com/improbable-eng/thanos" rel="noopener ugc nofollow" target="_blank"> <em class="lm">灭霸</em> </a> <em class="lm"> </em>是一个开源项目，构建为一组组件，可以组成一个具有<strong class="kq iu">无限存储</strong>容量的<strong class="kq iu">高度可用的</strong>公制系统，可以无缝地添加到现有的<em class="lm">普罗米修斯</em>部署之上。</p><p id="50c6" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated"><em class="lm">灭霸</em>利用<em class="lm">普罗米修斯</em>存储格式在任何对象存储中经济高效地存储历史指标数据，同时保持快速查询延迟。此外，它提供了一个跨越所有<em class="lm"> Prometheus </em>安装的<strong class="kq iu">全局查询视图</strong>。</p><p id="b9b2" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated"><em class="lm">灭霸</em>的主要部件有:</p><ul class=""><li id="e1bd" class="mj mk it kq b kr ln kv lo kz ml ld mm lh mn ll mx mp mq mr bi translated"><strong class="kq iu">边车</strong>:连接到<em class="lm"> Prometheus </em>，并通过<em class="lm">查询网关</em>暴露它以进行实时查询，和/或将其数据上传到云存储以供长期使用</li><li id="417f" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mx mp mq mr bi translated"><strong class="kq iu">查询网关</strong>:实现<em class="lm">普罗米修斯</em>API从底层组件(如<em class="lm">边车</em>或<em class="lm">商店网关</em>)聚合数据</li><li id="4128" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mx mp mq mr bi translated"><strong class="kq iu">商店网关</strong>:公开云存储的内容</li><li id="76f5" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mx mp mq mr bi translated"><strong class="kq iu">压缩器</strong>:对云存储中存储的数据进行压缩和降采样</li><li id="d01b" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mx mp mq mr bi translated"><strong class="kq iu">接收器</strong>:接收来自<em class="lm">普罗米修斯</em>远程写墙的数据，将其公开和/或上传至云存储</li><li id="053e" class="mj mk it kq b kr ms kv mt kz mu ld mv lh mw ll mx mp mq mr bi translated"><strong class="kq iu">标尺</strong>:针对<em class="lm">灭霸</em>中的数据评估记录和警报规则，以供展示和/或上传</li></ul><p id="7b14" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">在本文中，我们将重点关注前三个组件。</p><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi my"><img src="../Images/916471bed015565d1a129b28d3535efa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*91Z_5MTvj0BmMMFwMam0pQ.jpeg"/></div></div><figcaption class="mf mg gj gh gi mh mi bd b be z dk translated">灭霸部署图</figcaption></figure><h1 id="489a" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">部署灭霸</h1><p id="7b30" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们将从将<em class="lm">灭霸Sidecar </em>部署到我们的<em class="lm"> Kubernetes </em>集群开始，我们使用相同的集群来运行我们的工作负载和<em class="lm">普罗米修斯</em>和<em class="lm"> Grafana </em>部署。</p><p id="f82d" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">虽然安装<em class="lm"> Prometheus </em>的方法有很多，但我更喜欢使用<a class="ae ls" href="https://github.com/coreos/prometheus-operator" rel="noopener ugc nofollow" target="_blank"><em class="lm">Prometheus-Operator</em></a>，这样可以轻松监控<em class="lm"> Kubernetes </em>服务的定义以及<em class="lm"> Prometheus </em>实例的部署和管理。</p><p id="4055" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">安装<em class="lm"> Prometheus-Operator </em>最简单的方法是使用其<a class="ae ls" href="https://github.com/helm/charts/tree/master/stable/prometheus-operator" rel="noopener ugc nofollow" target="_blank"> <em class="lm">掌舵图</em> </a> <em class="lm"> </em>，该图内置了对高可用性的支持、<em class="lm">灭霸边车</em>注入和大量预配置的<em class="lm">警报</em>，用于监控集群虚拟机、<em class="lm"> Kubernetes </em>基础设施和您的应用程序。</p><p id="d17d" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">在我们部署灭霸边车之前，我们需要有一个关于如何连接到云存储细节的Kubernetes秘密，对于这个演示，我将使用<em class="lm">微软Azure </em>。</p><p id="5b83" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">创建一个blob存储帐户—</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="724b" class="ne jr it na b gy nf ng l nh ni">az storage account create --name &lt;storage_name&gt; --resource-group &lt;resource_group&gt; --location &lt;location&gt; --sku Standard_LRS --encryption blob</span></pre><p id="03ea" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">然后，为指标创建一个文件夹(又名容器)</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="f19c" class="ne jr it na b gy nf ng l nh ni">az storage container create --account-name &lt;storage_name&gt; --name thanos</span></pre><p id="7a69" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">拿着存储钥匙—</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="166b" class="ne jr it na b gy nf ng l nh ni">az storage account keys list -g &lt;resource_group&gt; -n &lt;storage_name&gt;</span></pre><p id="eb74" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">为存储设置创建一个文件(<em class="lm">than OS-storage-config . YAML</em>)—</p><figure class="lu lv lw lx gt ly"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="d30c" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">创造一个<em class="lm"> Kubernetes的秘密</em>——</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="076a" class="ne jr it na b gy nf ng l nh ni">kubectl -n monitoring create secret generic thanos-objstore-config --from-file=thanos.yaml=thanos-storage-config.yaml</span></pre><p id="849c" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">创建一个值文件(<em class="lm">prometheus-operator-values . YAML</em>)来覆盖默认的Prometheus-Operator设置</p><figure class="lu lv lw lx gt ly"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="7195" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">然后部署:</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="f1bf" class="ne jr it na b gy nf ng l nh ni">helm install --namespace monitoring --name prometheus-operator stable/prometheus-operator -f prometheus-operator-values.yaml</span></pre><p id="60b6" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">现在，您应该有一个<strong class="kq iu">高可用的</strong> <em class="lm">普罗米修斯</em>在您的集群中运行，还有一个<em class="lm">灭霸边车</em>将您的指标上传到Azure Blob存储，并无限保留。</p><p id="2ef2" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">为了允许<em class="lm">灭霸商店网关</em>访问那些<em class="lm">灭霸边车</em>，我们将需要通过<em class="lm">入口</em>来暴露它们，我使用的是<a class="ae ls" href="https://github.com/kubernetes/ingress-nginx" rel="noopener ugc nofollow" target="_blank"> <em class="lm"> Nginx入口控制器</em> </a>，但是您可以使用任何其他支持gRPC的<em class="lm">入口控制器</em>(<a class="ae ls" href="https://www.envoyproxy.io/" rel="noopener ugc nofollow" target="_blank"><em class="lm">Envoy</em></a><em class="lm"/>可能是最好的选择)。</p><p id="495f" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">对于<em class="lm">灭霸商店网关</em>和<em class="lm">灭霸边车</em>之间的安全通信，我们将使用mutual-TLS，这意味着客户端将验证服务器，反之亦然。</p><p id="f549" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">假设你有<em class="lm">。pfx </em>文件你可以使用<em class="lm">OpenSSL</em>——提取它的<em class="lm">私钥、公钥</em>和<em class="lm"> CA </em></p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="06b9" class="ne jr it na b gy nf ng l nh ni"># public key<br/>openssl pkcs12 -in cert.pfx -nocerts -nodes | sed -ne '/-BEGIN PRIVATE KEY-/,/-END PRIVATE KEY-/p' &gt; cert.key</span><span id="ca33" class="ne jr it na b gy nl ng l nh ni"># private key<br/>openssl pkcs12 -in cert.pfx -clcerts -nokeys | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' &gt; cert.cer</span><span id="5b06" class="ne jr it na b gy nl ng l nh ni"># certificate authority (CA)<br/>openssl pkcs12 -in cert.pfx -cacerts -nokeys -chain | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' &gt; cacerts.cer</span></pre><p id="965f" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">用这个创造两个库伯内特的秘密</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="f117" class="ne jr it na b gy nf ng l nh ni"># a secret to be used for TLS termination<br/>kubectl create secret tls -n monitoring thanos-ingress-secret --key ./cert.key --cert ./cert.cer</span><span id="79c7" class="ne jr it na b gy nl ng l nh ni"># a secret to be used for client authenticating using the same CA<br/>kubectl create secret generic -n monitoring thanos-ca-secret --from-file=ca.crt=./cacerts.cer</span></pre><p id="c431" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">确保您有一个解析到您的<em class="lm"> Kubernetes </em>集群的域，并创建两个子域用于路由到每个<em class="lm"> Thaos SideCar </em>:</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="2bd6" class="ne jr it na b gy nf ng l nh ni">thanos-0.your.domain<br/>thanos-1.your.domain</span></pre><p id="8581" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">现在我们可以创建<em class="lm">入口</em>规则(替换主机值)—</p><figure class="lu lv lw lx gt ly"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="4406" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">现在我们有了一个从集群外部访问<em class="lm">灭霸边车</em>的<strong class="kq iu">安全</strong>方法！</p><p id="e215" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated"><strong class="kq iu">灭霸集群</strong></p><p id="d0bc" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">在上面的<em class="lm">灭霸</em>图中，你可以看到我选择将<em class="lm">灭霸</em>部署在一个单独的集群中，这是因为我想要一个专用的集群，如果需要的话，可以轻松地重新创建，并允许工程师访问它，而不需要他们访问真正的生产集群。</p><p id="3c86" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">为了部署<em class="lm">灭霸</em>组件我选择了使用这个<a class="ae ls" href="https://github.com/arthur-c/thanos-helm-chart" rel="noopener ugc nofollow" target="_blank"> <em class="lm">掌舵图</em> </a>(尚未正式发布，敬请期待，等我的<a class="ae ls" href="https://github.com/arthur-c/thanos-helm-chart/pull/2" rel="noopener ugc nofollow" target="_blank"> <em class="lm"> PR </em> </a>合并)。</p><p id="8d7e" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">创建一个<em class="lm"> thanos-values.yaml </em>文件来覆盖默认的图表设置—</p><figure class="lu lv lw lx gt ly"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="d2b0" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">由于<em class="lm">灭霸商店网关</em>需要从blob存储中读取数据，因此我们也在该集群中重新创建了存储机密—</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="ac52" class="ne jr it na b gy nf ng l nh ni">kubectl -n thanos create secret generic thanos-objstore-config --from-file=thanos.yaml=thanos-storage-config.yaml</span></pre><p id="ac65" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">为了部署此图表，我们将使用之前创建的相同证书，并在过程中将它们作为值注入—</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="11c1" class="ne jr it na b gy nf ng l nh ni">helm install --name thanos --namespace thanos ./thanos -f thanos-values.yaml --set-file query.tlsClient.cert=cert.cer --set-file query.tlsClient.key=cert.key --set-file query.tlsClient.ca=cacerts.cer --set-file store.tlsServer.cert=cert.cer --set-file store.tlsServer.key=cert.key --set-file store.tlsServer.ca=cacerts.cer</span></pre><p id="7602" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">这将安装<em class="lm">灭霸查询网关</em>和<em class="lm">灭霸存储网关</em>，将它们配置为使用安全通道。</p><p id="be35" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated"><strong class="kq iu">验证</strong></p><p id="d2b4" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">为了验证一切工作正常，您可以使用以下命令将端口转发到<em class="lm">灭霸查询网关</em> HTTP服务</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="2d53" class="ne jr it na b gy nf ng l nh ni">kubectl -n thanos port-forward svc/thanos-query-http 8080:10902</span></pre><p id="70d9" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">然后在<a class="ae ls" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080 </a>打开你的浏览器，你应该会看到灭霸界面！—</p><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi nm"><img src="../Images/28c53a2ea55863b8a6a549087fa4d935.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_KqrWX2hzL7yJ7LPjEZv8Q.png"/></div></div></figure><p id="bcb5" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated"><strong class="kq iu">格拉夫纳</strong></p><p id="cb59" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">要添加仪表板，您可以简单地安装Grafana使用其舵图表。</p><p id="2467" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">用以下内容创建一个<em class="lm"> grafana-values.yaml </em></p><figure class="lu lv lw lx gt ly"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="e733" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">请注意，我添加了三个默认仪表板，您也可以添加自己的仪表板(最简单的方法是使用<em class="lm"> ConfigMap </em>)</p><p id="1b88" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">然后部署—</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="2a69" class="ne jr it na b gy nf ng l nh ni">helm install --name grafana --namespace thanos stable/grafana -f grafana-values.yaml</span></pre><p id="638d" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">再一次，左舷向前—</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="f59c" class="ne jr it na b gy nf ng l nh ni">kubectl -n thanos port-forward svc/grafana 8080:80</span></pre><p id="934f" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">还有… <strong class="kq iu">中提琴</strong>！您已经完成了基于<strong class="kq iu"> <em class="lm">【普罗米修斯</em></strong><strong class="kq iu">长期存储</strong>和跨多个集群的<strong class="kq iu">集中视图</strong>的<strong class="kq iu">高可用性</strong>监控解决方案的部署！</p><h1 id="bc68" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">其他选项</h1><p id="33b7" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">本文主要关注的是<em class="lm">普罗米修斯</em>和<em class="lm">灭霸</em>，但是如果你不需要多集群全局视图，你仍然可以只定义一个持久存储的普罗米修斯。</p><p id="81b2" class="pw-post-body-paragraph ko kp it kq b kr ln kt ku kv lo kx ky kz lp lb lc ld lq lf lg lh lr lj lk ll im bi translated">另一个选择是部署<a class="ae ls" href="https://github.com/cortexproject/cortex" rel="noopener ugc nofollow" target="_blank"> <em class="lm"> Cortex </em> </a>，这是另一个开源平台，比灭霸稍微复杂一点，并且采用了不同的方法。</p></div></div>    
</body>
</html>