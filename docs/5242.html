<html>
<head>
<title>Helm Chart Install: Advanced Usage of the “Set” Argument</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">舵图安装:“Set”参数的高级用法</h1>
<blockquote>原文：<a href="https://itnext.io/helm-chart-install-advanced-usage-of-the-set-argument-3e214b69c87a?source=collection_archive---------0-----------------------#2021-01-21">https://itnext.io/helm-chart-install-advanced-usage-of-the-set-argument-3e214b69c87a?source=collection_archive---------0-----------------------#2021-01-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/bc0f8845d8dd4e13b276ea256482ef60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tcCgCtJxKZcMhris"/></div></div></figure><p id="5cd3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当使用<code class="fe kw kx ky kz b">helm install</code>命令安装舵图表时，<code class="fe kw kx ky kz b">--set</code>参数允许您定义图表模板中使用的值。</p><p id="cbee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kw kx ky kz b">--set</code>参数是在<code class="fe kw kx ky kz b">values.yaml</code>文件中定义值的替代方法。</p><p id="fa89" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kw kx ky kz b">--set</code>的一个简单用法如下:</p><pre class="la lb lc ld gt le kz lf lg aw lh bi"><span id="becb" class="li lj iq kz b gy lk ll l lm ln">$ helm install codecentric/keycloak --set keycloak.replicas=2</span></pre><p id="4775" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">相反，要用一个<code class="fe kw kx ky kz b">values.yaml</code>文件设置相同的值，您可以将该值添加到文件中，然后使用<code class="fe kw kx ky kz b">-f</code>参数指定文件的路径。</p><pre class="la lb lc ld gt le kz lf lg aw lh bi"><span id="531b" class="li lj iq kz b gy lk ll l lm ln"># values.yaml<br/>keycloak:<br/>  replicas: 2</span></pre><h1 id="3d4a" class="lo lj iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">使用<code class="fe kw kx ky kz b">--set</code>的挑战</h1><p id="b377" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">在一些特殊情况下，很难在命令行上指定YAML属性/值。</p><p id="a537" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这些特殊情况涉及包含与YAML语法冲突的字符的属性和值或未记录的行为。</p><h1 id="6b05" class="lo lj iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">为什么不用values.yaml？</h1><p id="83b8" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">处理这些特殊值的常见解决方法是恢复使用一个<code class="fe kw kx ky kz b">values.yaml</code>文件。但是，在某些情况下使用<code class="fe kw kx ky kz b">values.yaml</code>是不可行的。</p><p id="e6ec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用<code class="fe kw kx ky kz b">values.yaml</code>文件不可行的一种常见情况是当值或属性被期望在运行时作为动态值提供时。</p><h1 id="37b7" class="lo lj iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">为舵安装提供动态值</h1><p id="51c3" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">不能在<code class="fe kw kx ky kz b">values.yaml</code>中注入或使用动态值。外壳脚本可以提供动态值功能。</p><p id="5420" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本例中，shell脚本提示用户输入，然后通过<code class="fe kw kx ky kz b">--set</code>参数将用户的输入注入到舵图中。</p><pre class="la lb lc ld gt le kz lf lg aw lh bi"><span id="c031" class="li lj iq kz b gy lk ll l lm ln">#!/bin/bash</span><span id="0e1e" class="li lj iq kz b gy mq ll l lm ln"># read dynamic value<br/>read -p "Keycloak replicas: " replicas</span><span id="9944" class="li lj iq kz b gy mq ll l lm ln"># set dynamic value<br/>helm install codecentric/keycloak --set keycloak.replicas=$replicas</span></pre><p id="6fc5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用<code class="fe kw kx ky kz b">values.yaml</code>文件无法实现前面的示例。</p><h1 id="7bdb" class="lo lj iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">数组</h1><p id="2380" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">数组在<code class="fe kw kx ky kz b">values.yaml</code>文件中是这样定义的:</p><pre class="la lb lc ld gt le kz lf lg aw lh bi"><span id="e0b1" class="li lj iq kz b gy lk ll l lm ln"># values.yaml<br/>keycloak:<br/>  ingress:<br/>    hosts:<br/>    - "auth1"<br/>    - "auth2"</span></pre><p id="10e6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Helm提供了两种在命令行定义数组值的方法。</p><p id="384f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第一种方法是用<code class="fe kw kx ky kz b">{}</code>包装值列表。数组中的元素用逗号分隔。</p><pre class="la lb lc ld gt le kz lf lg aw lh bi"><span id="0920" class="li lj iq kz b gy lk ll l lm ln">$ helm install codecentric/keycloak \<br/>  --set 'keycloak.ingress.hosts={auth1,auth2}'</span></pre><p id="0e70" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在命令行上定义数组值的第二种方法是通过索引指定单个数组元素。</p><pre class="la lb lc ld gt le kz lf lg aw lh bi"><span id="4395" class="li lj iq kz b gy lk ll l lm ln">$ helm install codecentric/keycloak \<br/>  --set 'keycloak.ingress.hosts[0]=auth1' \<br/>  --set 'keycloak.ingress.hosts[1]=auth2'</span></pre><h1 id="f231" class="lo lj iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">带有特殊字符的属性名</h1><p id="707d" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">当属性名包含特殊字符时，它们在<code class="fe kw kx ky kz b">values.yaml</code>文件中不需要任何特殊语法。</p><pre class="la lb lc ld gt le kz lf lg aw lh bi"><span id="afde" class="li lj iq kz b gy lk ll l lm ln"># values.yaml<br/>keycloak:<br/>  podLabels:<br/>    app.kubernetes.io/part-of: security</span></pre><p id="b1d4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是，在命令行上，必须使用<code class="fe kw kx ky kz b">\</code>对属性名中的特殊字符进行转义。</p><pre class="la lb lc ld gt le kz lf lg aw lh bi"><span id="c3c9" class="li lj iq kz b gy lk ll l lm ln">$ helm install codecentric/keycloak \<br/>  --set 'keycloak.podLabels.app\.kubernetes\.io/part-of=security'</span></pre><p id="dcd5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">需要转义的特殊字符在<a class="ae mr" href="https://github.com/helm/helm/blob/v3.4.2/pkg/strvals/parser.go#L159" rel="noopener ugc nofollow" target="_blank">Helm源代码</a>中定义。他们是<code class="fe kw kx ky kz b">.</code>、<code class="fe kw kx ky kz b">[</code>、<code class="fe kw kx ky kz b">,</code>和<code class="fe kw kx ky kz b">=</code>。</p><h1 id="8d95" class="lo lj iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">多行字符串</h1><p id="deb4" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">在一个<code class="fe kw kx ky kz b">values.yaml</code>文件中，使用标准的YAML语法定义多行字符串:</p><pre class="la lb lc ld gt le kz lf lg aw lh bi"><span id="5edc" class="li lj iq kz b gy lk ll l lm ln"># values.yaml<br/>keycloak:<br/>  extraEnv: |<br/>      - name: KEYCLOAK_HTTP_PORT<br/>        value: "80"<br/>      - name: KEYCLOAK_HOSTNAME<br/>        value: auth.k8salliance.com</span></pre><p id="9856" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ms">注意</em> <code class="fe kw kx ky kz b"><em class="ms">extraEnv</em></code> <em class="ms">值实际上是一个字符串，尽管它包含YAML语法。Keycloak舵图将值作为字符串读取，然后将该字符串作为舵模板进行处理。</em></p><p id="fce5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不幸的是，在带有转义符的命令行上，值字符串中不可能包含换行符(例如<code class="fe kw kx ky kz b">\n</code>),就像您所期望的那样。</p><p id="bc0b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以在命令行上通过用引号将整个属性键/值括起来来设置相同的值。</p><pre class="la lb lc ld gt le kz lf lg aw lh bi"><span id="51bb" class="li lj iq kz b gy lk ll l lm ln">$ helm install codecentric/keycloak \<br/>--set "keycloak.extraEnv=- name: KEYCLOAK_HTTP_PORT<br/>  value: \"80\"<br/>- name: KEYCLOAK_HOSTNAME<br/>  value: auth.k8salliance.com"</span></pre><p id="988b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">前面的命令行语法将产生与<code class="fe kw kx ky kz b">values.yaml</code>相同的值。</p></div></div>    
</body>
</html>