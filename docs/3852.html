<html>
<head>
<title>ExpressJS &amp; GraphQL — Authentication &amp; Access Control</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ExpressJS &amp; GraphQL —认证和访问控制</h1>
<blockquote>原文：<a href="https://itnext.io/expressjs-graphql-authentication-access-control-c5c8fe360b07?source=collection_archive---------2-----------------------#2020-03-11">https://itnext.io/expressjs-graphql-authentication-access-control-c5c8fe360b07?source=collection_archive---------2-----------------------#2020-03-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/6660dbd20085a5d24e9473885ca1ccc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z6KGBIxGxXpzcS7AKlDT_A.jpeg"/></div></div></figure></div><div class="ab cl jy jz hu ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="ij ik il im in"><h1 id="cbee" class="kf kg iq bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">介绍</h1><p id="b7c6" class="pw-post-body-paragraph ld le iq lf b lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在本文中，我将向您展示一个如何在模式生成级别、中间件和访问控制上实现身份验证的示例。如果您已经熟悉GraphQL和Express，并且有一些API开发经验，那么这篇文章就是为您准备的。</p><h1 id="c676" class="kf kg iq bd kh ki mb kk kl km mc ko kp kq md ks kt ku me kw kx ky mf la lb lc bi translated">应用规格</h1><p id="be95" class="pw-post-body-paragraph ld le iq lf b lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我将创建一个小的库应用程序。<br/>这个应用程序将有两种类型的数据:用户和书籍。<br/>为了获得图书列表或单本图书，用户应该被认证并具有“查看”角色。<br/>如果用户想从系统中删除图书，他需要通过身份验证，并拥有“查看”和“删除”角色。</p><h1 id="e7a8" class="kf kg iq bd kh ki mb kk kl km mc ko kp kq md ks kt ku me kw kx ky mf la lb lc bi translated">用户认证</h1><blockquote class="mg mh mi"><p id="32b9" class="ld le mj lf b lg mk li lj lk ml lm ln mm mn lq lr mo mp lu lv mq mr ly lz ma ij bi translated">用户身份验证策略是一个过程，用于验证试图访问服务和应用程序的人是否是他们所声称的人。</p></blockquote><h1 id="6c55" class="kf kg iq bd kh ki mb kk kl km mc ko kp kq md ks kt ku me kw kx ky mf la lb lc bi translated">授权(用户访问控制)</h1><blockquote class="mg mh mi"><p id="c4a6" class="ld le mj lf b lg mk li lj lk ml lm ln mm mn lq lr mo mp lu lv mq mr ly lz ma ij bi translated">授权是一种安全机制，用于确定与系统资源(包括文件、服务、计算机程序、数据和应用程序功能)相关的访问级别或用户/客户端权限。这是授予或拒绝访问网络资源的过程，允许用户根据其身份访问各种资源。</p></blockquote></div><div class="ab cl jy jz hu ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="ij ik il im in"><h1 id="0aab" class="kf kg iq bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">项目设置</h1><p id="c633" class="pw-post-body-paragraph ld le iq lf b lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我不会描述和展示配置Typescript、Nodemon和编写接口之类的东西的过程。你将能够在Github库上看到整个应用程序代码。<br/>回购的链接将在本文末尾。</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">项目结构</figcaption></figure><p id="9020" class="pw-post-body-paragraph ld le iq lf b lg mk li lj lk ml lm ln lo mn lq lr ls mp lu lv lw mr ly lz ma ij bi translated">如果你看一下<strong class="lf ir"> graphql </strong>文件夹，你会注意到两个文件夹:<strong class="lf ir">授权</strong> &amp; <strong class="lf ir">未授权。</strong>我对授权和未授权模式的解析器、查询、类型和变异进行了物理拆分。<br/>根据用户身份验证状态，我们的应用程序将知道应该为最终用户提供哪种模式。</p><p id="12ea" class="pw-post-body-paragraph ld le iq lf b lg mk li lj lk ml lm ln lo mn lq lr ls mp lu lv lw mr ly lz ma ij bi translated">通过这种拆分，我们又多了一个安全级别。<br/>当未经认证的用户从服务器获取GraphQL模式时，他将无法看到需要认证的查询和变异列表。</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">类型定义生成器- src/graphql/type.generator.ts</figcaption></figure><p id="9c7a" class="pw-post-body-paragraph ld le iq lf b lg mk li lj lk ml lm ln lo mn lq lr ls mp lu lv lw mr ly lz ma ij bi translated">我将创建解析器寄存器，在这里我们将能够控制哪些解析器应该包含在授权和未授权的模式中。</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">解析器寄存器—src/graph QL/resolver . register . ts</figcaption></figure><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">基于用户身份验证状态的模式生成器—src/graph QL/schema . generator . ts</figcaption></figure><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">生成GraphQL Express中间件—src/middleware/graph QL-Express/graph QL-Express . middleware . ts</figcaption></figure><p id="27dc" class="pw-post-body-paragraph ld le iq lf b lg mk li lj lk ml lm ln lo mn lq lr ls mp lu lv lw mr ly lz ma ij bi translated">现在我将设置认证和访问控制中间件。<br/>认证中间件将在整个GraphQL端点上运行。<br/>访问控制中间件将在解析器级别运行。</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">认证中间件—src/middleware/auth/auth . middleware . ts</figcaption></figure><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">访问控制中间件—src/middleware/access-control/access-control . middleware . ts</figcaption></figure><p id="fc83" class="pw-post-body-paragraph ld le iq lf b lg mk li lj lk ml lm ln lo mn lq lr ls mp lu lv lw mr ly lz ma ij bi translated">现在我将在解析器级别设置运行中间件的助手。</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">中间件检查助手—src/middleware/middleware . check . ts</figcaption></figure><p id="d2d5" class="pw-post-body-paragraph ld le iq lf b lg mk li lj lk ml lm ln lo mn lq lr ls mp lu lv lw mr ly lz ma ij bi translated"><strong class="lf ir">注意</strong>:在真实世界的场景中，我会使用真实的数据库和真实的认证标准，比如JWT。但是在这篇文章中，我伪造了数据库和认证系统。</p><p id="10bd" class="pw-post-body-paragraph ld le iq lf b lg mk li lj lk ml lm ln lo mn lq lr ls mp lu lv lw mr ly lz ma ij bi translated">在这个假数据库中，用户对象被分配了不同的角色和令牌，这些角色和令牌将用于身份验证和授权。<br/>代币将模拟不记名代币。</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">fake DB—src/helpers/fake-DB . helper . ts</figcaption></figure><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">身份验证查询服务—src/graph QL/unauthorized/auth/auth . query . service . ts</figcaption></figure><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">身份验证解析程序—src/graph QL/unauthorized/auth/auth . resolver . ts</figcaption></figure><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">身份验证查询类型—src/graph QL/unauthorized/query . graph QL</figcaption></figure><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">图书突变服务—src/graph QL/authorized/book/book . mutation . service . ts</figcaption></figure><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">图书查询服务—src/graph QL/authorized/book/book . query . service . ts</figcaption></figure><p id="e6f9" class="pw-post-body-paragraph ld le iq lf b lg mk li lj lk ml lm ln lo mn lq lr ls mp lu lv lw mr ly lz ma ij bi translated">下面你可以在《解析器》一书中看到如何在解析器层面使用中间件:</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">图书解析器—src/graph QL/authorized/book/book . resolver . ts</figcaption></figure><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">授权突变—src/graph QL/authorized/mutation . graph QL</figcaption></figure><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">授权查询—src/graph QL/authorized/query . graph QL</figcaption></figure><p id="cae2" class="pw-post-body-paragraph ld le iq lf b lg mk li lj lk ml lm ln lo mn lq lr ls mp lu lv lw mr ly lz ma ij bi translated">现在让我们总结一下:</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">服务器— src/server.ts</figcaption></figure><p id="85d8" class="pw-post-body-paragraph ld le iq lf b lg mk li lj lk ml lm ln lo mn lq lr ls mp lu lv lw mr ly lz ma ij bi translated">让我们用<strong class="lf ir"> npm start </strong>命令运行服务器</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/beb0c9bfda59d7d20b56f44426f4e990.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UGydESlEtRwo9fhuABc-Bg.png"/></div></div></figure><p id="87d0" class="pw-post-body-paragraph ld le iq lf b lg mk li lj lk ml lm ln lo mn lq lr ls mp lu lv lw mr ly lz ma ij bi translated">当服务器启动时，让我们尝试以未经身份验证的用户身份从失眠症患者那里获取模式。</p><div class="ms mt mu mv gt ab cb"><figure class="nd jr ne nf ng nh ni paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><img src="../Images/70667d761a6e32f61fc850d86030a6e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1096/format:webp/1*tfiia7VzgyFq8FDlDs9RyQ.png"/></div></figure><figure class="nd jr nj nf ng nh ni paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><img src="../Images/6feea1b288cc22f3cc9c61a088bf99ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:906/format:webp/1*dAAoXws_GRZvhhonxsIUlQ.png"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk nk di nl nm translated">以未经验证的用户身份获取了架构。</figcaption></figure></div><p id="7e1f" class="pw-post-body-paragraph ld le iq lf b lg mk li lj lk ml lm ln lo mn lq lr ls mp lu lv lw mr ly lz ma ij bi translated">正如您在上面看到的，作为未经验证的用户，我们只能使用登录查询。<br/>让我们以认证用户的身份登录并尝试获取模式。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nn"><img src="../Images/000dde4eab1e222f3f56968fdbe26fd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Li9gF0FUR-TGzPNQw0kAnA.png"/></div></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">成功登录</figcaption></figure><p id="382a" class="pw-post-body-paragraph ld le iq lf b lg mk li lj lk ml lm ln lo mn lq lr ls mp lu lv lw mr ly lz ma ij bi translated">成功登录后，我们得到了应该作为<strong class="lf ir">授权</strong>头值的值在请求中发送的散列。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/5baabec444937c5ba9f00e5d5e146fce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5OV_DCKkvBl3pFGcUl2chA.png"/></div></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">以授权用户身份获取模式</figcaption></figure><div class="ms mt mu mv gt ab cb"><figure class="nd jr np nf ng nh ni paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><img src="../Images/4d4fadc5637a6dee60d0a22f94d616e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:938/format:webp/1*s6jGNzT3a9Vepgr4R37D9A.png"/></div></figure><figure class="nd jr nq nf ng nh ni paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><img src="../Images/772c004ca6f0f7e8e8d2bff03f56e0a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1064/format:webp/1*Pp8P_1zTQg31T3AIGkMVuw.png"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk nr di ns nm translated">授权用户的模式</figcaption></figure></div><p id="c222" class="pw-post-body-paragraph ld le iq lf b lg mk li lj lk ml lm ln lo mn lq lr ls mp lu lv lw mr ly lz ma ij bi translated">由于当前登录的用户只有“查看”角色，让我们尝试获取所有书籍的列表。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/788e6fa6e66ecd4861794525e10165d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N0kSg9i7izI-e9afbhBoeQ.png"/></div></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">获得所有书籍</figcaption></figure><p id="bcb1" class="pw-post-body-paragraph ld le iq lf b lg mk li lj lk ml lm ln lo mn lq lr ls mp lu lv lw mr ly lz ma ij bi translated">现在，让我们以一个不具备该操作所需权限的用户身份尝试删除图书。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/8b6c18ec26b50ee08bc189ad9078dfc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*szl51qWmEWPRZmf0-OTjLA.png"/></div></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">删除操作失败，因为用户不被允许</figcaption></figure><p id="5589" class="pw-post-body-paragraph ld le iq lf b lg mk li lj lk ml lm ln lo mn lq lr ls mp lu lv lw mr ly lz ma ij bi translated">正如预期的那样，服务器不允许我们在没有所需权限的情况下执行删除操作。<br/>我将以被允许的第二用户(jane@doe.com的身份登录，替换授权头哈希，并尝试删除图书。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/f8942a4b5756266c6d20b1955d2a4164.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wrOjRG5kD4NME2OkU3qm8g.png"/></div></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">作为许可用户成功删除操作</figcaption></figure><p id="fd28" class="pw-post-body-paragraph ld le iq lf b lg mk li lj lk ml lm ln lo mn lq lr ls mp lu lv lw mr ly lz ma ij bi translated">应用程序正在工作。我们成功删除了一本书作为许可用户！</p><p id="951d" class="pw-post-body-paragraph ld le iq lf b lg mk li lj lk ml lm ln lo mn lq lr ls mp lu lv lw mr ly lz ma ij bi translated">感谢阅读！</p><p id="9a31" class="pw-post-body-paragraph ld le iq lf b lg mk li lj lk ml lm ln lo mn lq lr ls mp lu lv lw mr ly lz ma ij bi translated"><a class="ae nw" href="https://github.com/nenadb97/graphql-express-authentication-and-access-control" rel="noopener ugc nofollow" target="_blank"> Github资源库。</a></p></div></div>    
</body>
</html>