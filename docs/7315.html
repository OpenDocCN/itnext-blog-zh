<html>
<head>
<title>Lakehouse Data Modeling using dbt, Amazon Redshift, Redshift Spectrum, and AWS Glue</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用dbt、Amazon红移、红移光谱和AWS Glue的Lakehouse数据建模</h1>
<blockquote>原文：<a href="https://itnext.io/lakehouse-data-modeling-using-dbt-amazon-redshift-redshift-spectrum-and-aws-glue-fdc5629c3df8?source=collection_archive---------0-----------------------#2022-08-19">https://itnext.io/lakehouse-data-modeling-using-dbt-amazon-redshift-redshift-spectrum-and-aws-glue-fdc5629c3df8?source=collection_archive---------0-----------------------#2022-08-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3c49" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解dbt如何在基于AWS构建的现代云数据湖中简化数据转换和模型具体化</h2></div><p id="3b11" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le">【帖子更新于2022年12月30日，以反映dbt的最新版本】</em></p><p id="3c0b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">由于风投支持的分析初创公司和营销资金过多，数据湖近年来吸引了分析界的大量注意力。尽管如此，数据仓库，特别是现代云数据仓库，继续获得市场份额，由<a class="ae lf" href="https://www.snowflake.com/" rel="noopener ugc nofollow" target="_blank">雪花</a>、<a class="ae lf" href="https://aws.amazon.com/redshift" rel="noopener ugc nofollow" target="_blank">亚马逊红移</a>、<a class="ae lf" href="https://cloud.google.com/bigquery" rel="noopener ugc nofollow" target="_blank">谷歌云BigQuery </a>和微软的<a class="ae lf" href="https://azure.microsoft.com/en-us/services/synapse-analytics/#overview" rel="noopener ugc nofollow" target="_blank"> Azure Synapse Analytics </a>引领。</p><p id="7331" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有几个因素引起了人们对数据仓库的兴趣和兴趣，包括数据仓库体系结构。根据<a class="ae lf" href="https://www.databricks.com/blog/2020/01/30/what-is-a-data-lakehouse.html" rel="noopener ugc nofollow" target="_blank"> Databricks </a>，“<em class="le">lake house是一种新的开放架构，结合了数据湖和数据仓库的最佳元素。Lakehouses是通过一种新的系统设计实现的:在开放格式的低成本云存储上直接实现与数据仓库中类似的数据结构和数据管理功能。</em>"类似地，<a class="ae lf" href="https://www.snowflake.com/guides/what-data-lakehouse" rel="noopener ugc nofollow" target="_blank"> Snowflake </a>将lakehouse描述为"<em class="le">一种将数据仓库的元素与数据湖的元素相结合的数据解决方案概念。数据湖库实现了数据仓库的数据结构和数据湖的管理特性，这对于数据存储来说通常更具成本效益。</em></p><p id="c872" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在下面的帖子中，我们将探索使用dbt实验室开发的dbt(数据构建工具)来转换基于AWS的数据湖库的数据，该数据湖库由Amazon Redshift(预配或无服务器)、Amazon Redshift Spectrum、AWS Glue Data Catalog和Amazon S3构建。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/87483328def385797338af41cfce10e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qjWOK2GH6R_iKJFAh7DOhA.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">这篇博文演示了高级架构</figcaption></figure><h1 id="3a5d" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">dbt</h1><p id="0b3a" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">根据<a class="ae lf" href="https://docs.getdbt.com/docs/introduction" rel="noopener ugc nofollow" target="_blank"> dbt Labs </a>的说法，“<em class="le"> dbt使分析工程师能够通过简单地编写select语句来转换他们仓库中的数据。dbt负责将这些select语句转换成表和视图。</em>【更进一步】<em class="le"> dbt执行</em> <strong class="kk iu"> <em class="le"> T </em> </strong> <em class="le">中的</em><a class="ae lf" href="https://docs.getdbt.com/terms/elt" rel="noopener ugc nofollow" target="_blank"><em class="le">ELT</em></a><em class="le">(提取、加载、转换)过程——它不提取或加载数据，但是它非常擅长转换已经加载到您的仓库中的数据。</em></p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mt"><img src="../Images/c00fb589e6db161b241d703c9899b3f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8PUSIkyvixhaC8PvW5gOXg.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">这个帖子的项目，显示在dbt云</figcaption></figure><h1 id="6e61" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">亚马逊红移</h1><p id="2b57" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">据<a class="ae lf" href="https://aws.amazon.com/redshift/" rel="noopener ugc nofollow" target="_blank"> AWS </a>，“<em class="le">亚马逊红移使用SQL来分析数据仓库、运营数据库和数据湖中的结构化和半结构化数据，使用AWS设计的硬件和机器学习来提供任何规模的最佳性价比。</em>“AWS宣称亚马逊红移是应用最广泛的云数据仓库。</p><h1 id="7135" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">亚马逊红移光谱</h1><p id="9358" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">根据<a class="ae lf" href="https://docs.aws.amazon.com/redshift/latest/dg/c-using-spectrum.html" rel="noopener ugc nofollow" target="_blank"> AWS </a>，“<em class="le"> Redshift Spectrum允许你从亚马逊S3的文件中高效地查询和检索结构化和半结构化数据，而不必将数据加载到亚马逊红移表中。</em>“红移光谱表定义了亚马逊S3中文件的数据结构。外部表存在于一个外部数据目录中，它可以是<a class="ae lf" href="https://aws.amazon.com/glue/" rel="noopener ugc nofollow" target="_blank"> AWS Glue </a>，Amazon Athena 附带的数据目录，或者Apache Hive metastore。</p><p id="2192" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">dbt可以与Amazon Redshift Spectrum交互来创建外部表，刷新外部表分区，并从数据仓库访问基于Amazon S3的数据湖中的原始数据。我们将使用dbt和dbt包<code class="fe mu mv mw mx b"><a class="ae lf" href="https://hub.getdbt.com/dbt-labs/dbt_external_tables/0.8.0/" rel="noopener ugc nofollow" target="_blank">dbt_external_tables</a></code>，在AWS粘合数据目录中创建外部表。</p><h1 id="2f37" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">先决条件</h1><p id="a0b7" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">本文演示的先决条件包括:</p><ul class=""><li id="97d0" class="my mz it kk b kl km ko kp kr na kv nb kz nc ld nd ne nf ng bi translated">亚马逊S3桶存储原始数据；</li><li id="359f" class="my mz it kk b kl nh ko ni kr nj kv nk kz nl ld nd ne nf ng bi translated">Amazon Redshift配置集群或Amazon Redshift无服务器；</li><li id="00e0" class="my mz it kk b kl nh ko ni kr nj kv nk kz nl ld nd ne nf ng bi translated">拥有亚马逊红移、亚马逊S3和AWS Glue权限的AWS IAM角色；</li><li id="bc38" class="my mz it kk b kl nh ko ni kr nj kv nk kz nl ld nd ne nf ng bi translated"><a class="ae lf" href="https://www.getdbt.com/" rel="noopener ugc nofollow" target="_blank"> dbt云</a>账号；</li><li id="a4a2" class="my mz it kk b kl nh ko ni kr nj kv nk kz nl ld nd ne nf ng bi translated"><a class="ae lf" href="https://docs.getdbt.com/dbt-cli/cli-overview" rel="noopener ugc nofollow" target="_blank">本地安装的dbt CLI </a> (dbt Core)和dbt Amazon红移适配器；</li><li id="3b4d" class="my mz it kk b kl nh ko ni kr nj kv nk kz nl ld nd ne nf ng bi translated"><a class="ae lf" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank">安装了<a class="ae lf" href="https://marketplace.visualstudio.com/items?itemName=innoverio.vscode-dbt-power-user" rel="noopener ugc nofollow" target="_blank"> dbt Power User </a>扩展的微软Visual Studio代码</a> (VS代码)；</li></ul><p id="b819" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这篇文章的演示使用了dbt Cloud、VS Code和dbt CLI，并把项目的GitHub库作为源代码。使用这三个dbt选项中的任意一个或所有选项进行演示。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mt"><img src="../Images/bc8216b63cb991eb1d546fbe437fd10d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BmEp3emFlatm-higraSTyw.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">安装了dbt超级用户扩展的VS代码中的项目</figcaption></figure><h2 id="e5fc" class="nm lx it bd ly nn no dn mc np nq dp mg kr nr ns mi kv nt nu mk kz nv nw mm nx bi translated">成本预警！</h2><p id="c7dd" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">在为本演示创建一个新的、已调配的Amazon Redshift集群时要小心。建议的默认生产集群启用了两个<code class="fe mu mv mw mx b">ra3.4xlarge</code>按需计算节点和<a class="ae lf" href="https://aws.amazon.com/redshift/features/aqua/" rel="noopener ugc nofollow" target="_blank"> AQUA </a> (Redshift的高级查询加速器)，估计价格为4694美元/月(3.26美元/节点/小时)。对于本演示，选择一个<code class="fe mu mv mw mx b">dc2.large</code>按需计算节点的最小配置红移群集配置，估计成本为180美元/月(0.25美元/节点/小时)。演示完成后，请务必删除群集。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ny"><img src="../Images/eed6a075c4bc98e34aa2e6e9d7d7847a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1YkgsjE_2FG2hpRbBucDDg.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">创建一个新的亚马逊红移星团</figcaption></figure><h2 id="1594" class="nm lx it bd ly nn no dn mc np nq dp mg kr nr ns mi kv nt nu mk kz nv nw mm nx bi translated">亚马逊红移无服务器选项</h2><p id="e5b2" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">AWS最近<a class="ae lf" href="https://aws.amazon.com/about-aws/whats-new/2022/07/amazon-redshift-serverless-generally-available/" rel="noopener ugc nofollow" target="_blank">宣布</a>亚马逊红移无服务器将于2022年7月12日全面上市(GA)。Amazon Redshift Serverless允许数据分析师、开发人员和数据科学家运行和扩展分析，而无需供应和管理数据仓库集群。dbt与Amazon Redshift Serverless完全兼容，是本次演示中调配的Redshift的替代产品。根据<a class="ae lf" href="https://aws.amazon.com/redshift/pricing/#Amazon_Redshift_Serverless" rel="noopener ugc nofollow" target="_blank"> AWS </a>的说法，亚马逊红移无服务器以红移处理单元(rpu)来衡量数据仓库容量。您需要为在RPU运行的工作负载支付费用，这些工作负载以每秒小时为单位(最低收费为60秒)，包括在亚马逊S3以开放文件格式访问数据的查询。</p><h1 id="b313" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">源代码</h1><p id="0b09" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">这篇文章中展示的所有源代码都是开源的，可以在<a class="ae lf" href="https://github.com/garystafford/emr-msk-serverless-demo/tree/main" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上获得。</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nz oa l"/></div></figure><h1 id="714e" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">抽样资料</h1><p id="5da1" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">这个演示使用了AWS提供的<a class="ae lf" href="https://docs.aws.amazon.com/redshift/latest/dg/c_sampledb.html" rel="noopener ugc nofollow" target="_blank"> TICKIT样本数据库</a>，它是为配合Amazon Redshift使用而设计的。这个示例数据库应用程序跟踪虚构的在线ticket网站的销售活动，用户在这个网站上买卖体育赛事、演出和音乐会的门票。该数据库由星型模式中的七个表组成:五个维度表和两个事实表。这个<a class="ae lf" href="https://github.com/garystafford/dbt-redshift-demo/tree/main/raw_tickit_data" rel="noopener ugc nofollow" target="_blank"> GitHub项目</a>中包含原始TICKIT数据的一个干净的压缩副本，格式为管道分隔的文本文件。使用项目中包含的以下shell命令将原始数据复制到亚马逊S3:</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nz oa l"/></div></figure><h1 id="a33e" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">为dbt准备亚马逊红移</h1><p id="7d9d" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">下面所有的SQL命令也可以在GitHub项目库中找到，<a class="ae lf" href="https://github.com/garystafford/dbt-redshift-demo/blob/main/setup_redshift.sql" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><h2 id="a378" class="nm lx it bd ly nn no dn mc np nq dp mg kr nr ns mi kv nt nu mk kz nv nw mm nx bi translated">创建新数据库</h2><p id="9181" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">创建一个新的红移数据库用于演示，<code class="fe mu mv mw mx b">demo</code>。</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nz oa l"/></div></figure><h2 id="aaf3" class="nm lx it bd ly nn no dn mc np nq dp mg kr nr ns mi kv nt nu mk kz nv nw mm nx bi translated">创建数据库模式</h2><p id="0ec8" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">在新的红移数据库<code class="fe mu mv mw mx b">demo</code>中，使用<code class="fe mu mv mw mx b"><a class="ae lf" href="https://docs.aws.amazon.com/redshift/latest/dg/r_CREATE_EXTERNAL_SCHEMA.html" rel="noopener ugc nofollow" target="_blank">CREATE EXTERNAL SCHEMA</a></code>红移SQL命令创建外部模式<code class="fe mu mv mw mx b">tickit_external</code>，以及相应的外部<a class="ae lf" href="https://docs.aws.amazon.com/glue/latest/dg/components-overview.html#data-catalog-intro" rel="noopener ugc nofollow" target="_blank"> AWS粘合数据目录</a>、<code class="fe mu mv mw mx b">tickit_dbt</code>。确保更新命令以反映您的IAM角色的ARN。接下来，创建保存我们的dbt模型的模式，<code class="fe mu mv mw mx b">tickit_dbt</code>。最后，作为安全最佳实践，放弃默认的<code class="fe mu mv mw mx b">public</code>模式。</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="665f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从AWS Glue控制台，我们应该观察到一个新的<code class="fe mu mv mw mx b">tickit_dbt</code> AWS Glue数据目录。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mt"><img src="../Images/d22efbb137cb6d2979e04bb11d60a159.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HpKTf1v0rpVisCEc2yulXQ.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">新创建的AWS粘合数据目录</figcaption></figure><h2 id="3b86" class="nm lx it bd ly nn no dn mc np nq dp mg kr nr ns mi kv nt nu mk kz nv nw mm nx bi translated">创建dbt数据库用户和组</h2><p id="ae60" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">作为安全最佳实践，创建一个单独的数据库<code class="fe mu mv mw mx b">dbt</code>用户和<code class="fe mu mv mw mx b">dbt</code>组。我们指定了一个完全任意的连接限制10。然后，应用授权来允许<code class="fe mu mv mw mx b">dbt</code>组访问新的数据库和模式。最后，将两个模式的所有者更改为<code class="fe mu mv mw mx b">dbt</code>。</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="26ca" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae lf" href="https://docs.aws.amazon.com/redshift/latest/mgmt/generating-iam-credentials-overview.html" rel="noopener ugc nofollow" target="_blank">或者</a>，我们可以使用符合SAML 2.0的IdP的IAM角色。</p><h1 id="7dee" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">为红移初始化和配置dbt</h1><p id="e167" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">接下来，<a class="ae lf" href="https://docs.getdbt.com/reference/warehouse-profiles/redshift-profile" rel="noopener ugc nofollow" target="_blank">使用<code class="fe mu mv mw mx b"><a class="ae lf" href="https://docs.getdbt.com/reference/commands/init" rel="noopener ugc nofollow" target="_blank">dbt init</a></code>命令使用您的Amazon Redshift连接信息在本地配置</a>您的dbt云帐户和dbt。在Mac上，该配置存储在<code class="fe mu mv mw mx b">~/.dbt/profiles.yml</code>文件中。您将需要您的红移集群主机URL、端口、数据库、用户名和密码。</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nz oa l"/></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">示例dbt <code class="fe mu mv mw mx b">profiles.yml file</code></figcaption></figure><p id="359d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于本地安装的dbt，我们可以使用<code class="fe mu mv mw mx b"><a class="ae lf" href="https://docs.getdbt.com/reference/commands/debug" rel="noopener ugc nofollow" target="_blank">dbt debug</a></code>命令来确认新的配置。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ob"><img src="../Images/339ee8182e2e3f0e2d3e04cb02e793e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yJJaTjzVkGN8XzIMExNdDg.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">使用<code class="fe mu mv mw mx b"><a class="ae lf" href="https://docs.getdbt.com/reference/commands/debug" rel="noopener ugc nofollow" target="_blank">dbt debug</a></code>确认新配置</figcaption></figure><h1 id="f007" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">项目结构</h1><p id="6a2d" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">GitHub项目结构遵循dbt实验室的<a class="ae lf" href="https://docs.getdbt.com/guides/best-practices" rel="noopener ugc nofollow" target="_blank">最佳实践指南</a>中概述的许多最佳实践。<code class="fe mu mv mw mx b">models</code>目录中的数据模型被组织成推荐的<code class="fe mu mv mw mx b">staging</code>、<code class="fe mu mv mw mx b">intermediate</code>和<code class="fe mu mv mw mx b">marts</code>子目录(也称为层)。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ob"><img src="../Images/47011ea6f63e6801459cabdb11bbb26d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p_bSKrINfnazDdf4gVpivA.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">数据模型的项目结构</figcaption></figure><p id="ad79" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从数据沿袭的角度来看，暂存层的七个数据模型依赖于AWS粘合数据目录中定义的七个外部表。中间层的两个数据模型依赖于分段模型。marts层的四个数据模型依赖于阶段模型和中间模型。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi oc"><img src="../Images/76dd5ef73aaaf054b5735f66a4869054.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u_iVMRZNX8ZO0ry43tpOhQ.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">dbt云的谱系图显示了数据模型关系的示例</figcaption></figure><h2 id="4643" class="nm lx it bd ly nn no dn mc np nq dp mg kr nr ns mi kv nt nu mk kz nv nw mm nx bi translated">安装dbt包</h2><p id="0ab6" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">GitHub项目的<code class="fe mu mv mw mx b">packages.yml</code>包含了一些常用的推荐包。这个职位唯一需要的是<code class="fe mu mv mw mx b"><a class="ae lf" href="https://hub.getdbt.com/dbt-labs/dbt_external_tables/0.8.0/" rel="noopener ugc nofollow" target="_blank">dbt-labs/dbt_external_tables</a></code>包。确保您的项目引用了最新版本的包。</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="a1dc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用<code class="fe mu mv mw mx b"><a class="ae lf" href="https://docs.getdbt.com/reference/commands/deps" rel="noopener ugc nofollow" target="_blank">dbt deps</a></code>命令在本地安装软件包。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ob"><img src="../Images/9e5eac916b8066dd3616e23907a47d73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4JpJeidfY3b2PHcl3CE9dg.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">安装dbt包</figcaption></figure><h1 id="3021" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">外部表格</h1><p id="2e81" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated"><code class="fe mu mv mw mx b">models/staging/tickit/</code>模型子目录中的<code class="fe mu mv mw mx b">_tickit__sources.yml</code>文件定义了七个外部TICKIT数据库表的模式和S3位置:类别、日期、事件、列表、销售、用户和地点。您需要更新该文件，以在七个地方反映您的亚马逊S3存储桶的名称。</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="2232" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">执行命令<code class="fe mu mv mw mx b">dbt run-operation stage_external_sources</code>，在AWS粘合数据目录中创建七个外部表。这个命令是我们之前安装的<code class="fe mu mv mw mx b"><a class="ae lf" href="https://hub.getdbt.com/dbt-labs/dbt_external_tables/latest/" rel="noopener ugc nofollow" target="_blank">dbt_external_tables</a></code>包的一部分。它遍历所有源节点，创建缺失的表，并刷新元数据。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ob"><img src="../Images/fb95210521ba3b0decb1669a052ac099.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-44X4ngQi8JExkmwcqwAIQ.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">在AWS粘附数据目录中创建外部表</figcaption></figure><p id="c518" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果出现类似如下所示的错误，当您运行上面的dbt命令时，请确保您正确地将<code class="fe mu mv mw mx b">external_table</code>模式所有权设置为<code class="fe mu mv mw mx b">dbt</code>用户。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ob"><img src="../Images/f644d95f56a971cfced74311a426da4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TeY8pN_vlPFefTeySweKBA.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">由external_table模式的不正确所有权导致的典型错误</figcaption></figure><p id="e009" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦命令完成，我们应该在AWS粘合数据目录中观察到七个新表。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mt"><img src="../Images/00a89bc9a134a63a02d7c1145cddf905.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RmG5kMae9JKGo5SMg7_4Eg.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">AWS粘合数据目录中的七个新表</figcaption></figure><p id="a188" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">检查其中一个AWS粘合数据目录表，我们可以观察到<code class="fe mu mv mw mx b">_tickit__sources.yml</code>文件中的配置是如何用于定义表的属性和模式的。注意<code class="fe mu mv mw mx b">Location</code>字段指示底层数据在我们的亚马逊S3存储桶中的位置。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mt"><img src="../Images/283284ccfeb274110f3913e32299932b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UxSg5D6haBNym8OUqB94Mw.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">AWS粘合数据目录中的“类别”表</figcaption></figure><h1 id="e01f" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">后期绑定视图</h1><p id="0a90" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">本演示使用<a class="ae lf" href="https://docs.getdbt.com/reference/resource-configs/redshift-configs#late-binding-views" rel="noopener ugc nofollow" target="_blank">后期绑定视图</a>用于暂存和中间层模型。根据dbt的说法，“<em class="le">在dbt的生产部署中使用后期绑定视图可以极大地提高仓库中数据的可用性，特别是对于具体化为后期绑定视图并由最终用户查询的模型，因为它们不会在上游模型更新时被删除。此外，后期绑定视图可以通过红移谱与</em> <a class="ae lf" href="https://docs.aws.amazon.com/redshift/latest/dg/r_CREATE_EXTERNAL_TABLE.html" rel="noopener ugc nofollow" target="_blank"> <em class="le">外部表</em> </a> <em class="le">一起使用。</em></p><p id="0a47" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">或者，我们可以将七个阶段模型定义为表，而不是后期绑定视图。一旦创建为表，依赖的中间视图和marts视图将不再需要后期绑定引用，就像它们当前在这个项目中所做的那样。</p><h1 id="fe11" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">暂存层</h1><p id="32b1" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">在他们的最佳实践指南中，dbt以如下方式描述了<a class="ae lf" href="https://docs.getdbt.com/guides/best-practices/how-we-structure/2-staging" rel="noopener ugc nofollow" target="_blank">暂存层</a>:“<em class="le">你可以认为暂存层是将这种材料浓缩和提炼为单个原子，我们稍后将使用这些原子构建更复杂和有用的结构。</em>“暂存数据模型是基础表和视图，我们将使用它们在Redshift中构建更复杂的聚合和分析查询。<code class="fe mu mv mw mx b">schema.yml</code>文件也在<code class="fe mu mv mw mx b">models/staging/tickit/</code>模型的子目录中，它定义了七个<a class="ae lf" href="https://docs.getdbt.com/reference/resource-configs/redshift-configs#late-binding-views" rel="noopener ugc nofollow" target="_blank">后期绑定视图</a>，由dbt建模，将在Amazon Redshift中创建。</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="c801" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">暂存模型的SQL语句也遵循了许多dbt的<a class="ae lf" href="https://docs.getdbt.com/guides/best-practices/how-we-structure/2-staging#staging-models" rel="noopener ugc nofollow" target="_blank">最佳实践</a>。下面，我们来看一个<code class="fe mu mv mw mx b">stg_tickit__sales</code>模型的例子(<code class="fe mu mv mw mx b">stg_tickit__sales.sql</code>)。这个模型从<code class="fe mu mv mw mx b">external_table</code>模式中的外部<code class="fe mu mv mw mx b">sale</code>表执行一个<code class="fe mu mv mw mx b">SELECT</code>。该模型执行列重命名和基本计算。</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="4e2a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe mu mv mw mx b"><a class="ae lf" href="https://docs.getdbt.com/reference/commands/run" rel="noopener ugc nofollow" target="_blank">dbt run</a></code>命令，根据<a class="ae lf" href="https://docs.getdbt.com/reference/commands/run" rel="noopener ugc nofollow" target="_blank"> dbt </a>，<em class="le">对当前</em> <code class="fe mu mv mw mx b"><em class="le">target</em></code> <em class="le">数据库执行编译后的SQL模型文件。dbt连接到目标数据库并运行相关的SQL，需要使用指定的</em> <a class="ae lf" href="https://docs.getdbt.com/terms/materialization" rel="noopener ugc nofollow" target="_blank"> <em class="le">物化</em> </a> <em class="le">策略来物化所有的数据模型。</em>“现在，我们没有使用<code class="fe mu mv mw mx b">dbt run</code>命令一次创建所有项目的表和视图，而是使用<code class="fe mu mv mw mx b">--select</code>可选参数将命令限制在<code class="fe mu mv mw mx b">./models/staging/tickit/</code>目录中的模型。执行<code class="fe mu mv mw mx b">dbt run --select staging</code>命令，在Amazon Redshift中物化七个对应的staging视图。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ob"><img src="../Images/53a0627ef0746854caaf33c24eb21d37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IhM4tddVnILHL69x9eQPBg.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">临时层的数据模型在Redshift中成功实现</figcaption></figure><p id="64e7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦该命令完成，我们应该在Amazon Redshift <code class="fe mu mv mw mx b">demo</code>数据库的<code class="fe mu mv mw mx b">tickit_dbt</code>模式中观察到带有<code class="fe mu mv mw mx b">stg_</code>前缀的七个新视图。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ny"><img src="../Images/12fc4638f7cdfc17582ecdb677f8bc95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rpSK6zuGGZI9lQaq5iNNeQ.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">亚马逊红移查询编辑器v2控制台</figcaption></figure><p id="c4fc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从任何视图中进行选择都应该会返回数据。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi od"><img src="../Images/699f2d25ebbd918c1e6df3110ea9d7a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yMWQ24hwJmulWItwDrPeDA.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">亚马逊红移查询编辑器v2控制台</figcaption></figure><h1 id="b6c8" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">中间层</h1><p id="88be" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">在他们的最佳实践指南中，dbt将<a class="ae lf" href="https://docs.getdbt.com/guides/best-practices/how-we-structure/3-intermediate" rel="noopener ugc nofollow" target="_blank">中间层</a>描述为<em class="le">专门构建的转换步骤。</em>【更进一步】<em class="le">最好的指导原则是思考动词(如</em><code class="fe mu mv mw mx b"><em class="le">pivoted</em></code><em class="le"/><code class="fe mu mv mw mx b"><em class="le">aggregated_to_user</em></code><em class="le"/><code class="fe mu mv mw mx b"><em class="le">joined</em></code><em class="le"/><code class="fe mu mv mw mx b"><em class="le">fanned_out_by_quanity</em></code><em class="le"/><code class="fe mu mv mw mx b"><em class="le">funnel_created</em></code><em class="le">等)。)在中间层。</em></p><p id="f070" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">项目的中间层由两个与用户相关的模型组成。示例TICKIT数据库将所有用户集中到一个表中。然而，出于分析的目的，不同的用户角色可能会引起营销团队的兴趣，例如购买者、销售者、也购买的销售者和非购买者(从未购买过门票的用户)。项目中间层的两个模型过滤了买家和卖家，产生了用户角色的不同视图。</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="9bf2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要将中间层的两个数据模型具体化为视图，请执行命令<code class="fe mu mv mw mx b">dbt run --select intermediate</code>。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ob"><img src="../Images/718917920b67be5db7f15f80c4b4c7e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*33GVjVpAV9Z2h47RGJEeBA.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">中间层的数据模型成功地在红移中具体化了</figcaption></figure><p id="14af" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦命令完成，我们应该在Amazon Redshift <code class="fe mu mv mw mx b">demo</code>数据库的<code class="fe mu mv mw mx b">tickit_dbt</code>模式中观察到总共9个视图，7个staging用<code class="fe mu mv mw mx b">stg_</code>前缀标识，2个intermediate用<code class="fe mu mv mw mx b">int_</code>前缀标识。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ny"><img src="../Images/f698094bafccc07b7e3056d6186e77c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o4Yu5VR96Stomf7fxxGpng.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">亚马逊红移查询编辑器v2控制台</figcaption></figure><h1 id="5748" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">超市层</h1><p id="3513" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">在他们的最佳实践指南中，dbt将<a class="ae lf" href="https://docs.getdbt.com/guides/best-practices/how-we-structure/4-marts" rel="noopener ugc nofollow" target="_blank">集市层</a>描述为"<em class="le">业务定义的实体。</em>【进一步】<em class="le">在这一层，一切都汇集在一起，我们开始将我们所有的原子(分级模型)和分子(中间模型)排列成具有身份和目的的成熟细胞。我们有时喜欢称之为实体层或概念层，以强调我们所有的集市都是为了以其独特的粒度来表示特定的实体或概念。</em></p><p id="8e4f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该项目的marts层由跨市场营销和销售的四个数据模型组成。这些模型被具体化为两个维度表和两个事实表。通常将这些表描述和标记为传统的星型模式维度(<code class="fe mu mv mw mx b">dim_</code>)或事实(<code class="fe mu mv mw mx b">fct_</code>)表。实际上，本演示中的事实表是扁平的、非规范化的宽表。根据<a class="ae lf" href="https://www.fivetran.com/blog/star-schema-vs-obt" rel="noopener ugc nofollow" target="_blank"> Fivetran </a>和<a class="ae lf" href="https://hightouch.com/blog/data-warehouse-modelling-part-2/" rel="noopener ugc nofollow" target="_blank"> others </a>的说法，宽表在现代数据仓库中通常具有更好的分析性能。</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nz oa l"/></div></figure><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mt"><img src="../Images/f71eac4d37be58a1d8fcfa79fc3d80d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fAna2qBgNR5IUcjblwkF_A.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">在Amazon Redshift中执行的已编译分析SQL</figcaption></figure><p id="b771" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">marts层的模型通过连接阶段模型和中间模型来获取各种依赖关系。上面的数据模型<code class="fe mu mv mw mx b">fct_sales</code>依赖于多个阶段模型和中间模型。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mt"><img src="../Images/c00fb589e6db161b241d703c9899b3f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8PUSIkyvixhaC8PvW5gOXg.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">数据模型的沿袭图(依赖图)，显示在dbt云中</figcaption></figure><p id="0f08" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要将marts层的四个数据模型具体化为表，请执行命令<code class="fe mu mv mw mx b">dbt run --select marts</code>。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ob"><img src="../Images/2f32f85a99fa9f811eb83fe4ea3c93b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9qV-sHik58Zn0UwPiF-izg.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">Marts层的数据模型成功地在Redshift中具体化为表</figcaption></figure><p id="9013" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦命令完成，我们应该在红移数据库的<code class="fe mu mv mw mx b">tickit_dbt</code>模式中观察到四个表和九个视图。请注意<code class="fe mu mv mw mx b">fct_sales</code>(如上图所示的<em class="le">)的dbt模型及其Jinja模板和多个公共表表达式(CTE)是如何被编译成Redshift中的结果表的；这才是dbt真正的魔力！</em></p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mt"><img src="../Images/93d3b99aaf7315d1c08370afe060c1ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BQ5_C5H_Z4yycqRYEmiaZg.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">显示fct_sales表的Amazon Redshift查询编辑器v2控制台</figcaption></figure><p id="ecf2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此时，dbt已经在红移<code class="fe mu mv mw mx b">demo</code>数据库中编译并创建了该项目的所有模型。</p><h1 id="d961" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">分析</h1><p id="cc2b" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">本演示的GitHub项目也包含示例分析。dbt允许我们使用dbt的<code class="fe mu mv mw mx b"><a class="ae lf" href="https://docs.getdbt.com/docs/building-a-dbt-project/analyses" rel="noopener ugc nofollow" target="_blank">analyses</a></code>功能在dbt项目中对更多面向分析的SQL文件进行版本控制。这些分析不符合相当固执己见的dbt模型定义。我们可以使用<code class="fe mu mv mw mx b">dbt compile</code>命令编译分析SQL文件，然后将结果SQL语句从<code class="fe mu mv mw mx b">target/compiled/</code>子目录中复制并粘贴到我们选择的数据仓库查询工具中。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mt"><img src="../Images/77e0f0b1d7c770861ebc0a210a49e287.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pk_6TphTH2no8UkpjmzwRw.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">dbt云界面中显示的分析</figcaption></figure><h1 id="a7f1" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">项目文件</h1><p id="6df5" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">使用<code class="fe mu mv mw mx b"><a class="ae lf" href="https://docs.getdbt.com/reference/commands/cmd-docs" rel="noopener ugc nofollow" target="_blank">dbt docs generate</a></code>命令将从SQL和YAML文件自动生成项目的文档网站。文档可以从您的dbt云帐户生成和显示，或者使用<code class="fe mu mv mw mx b">dbt docs serve</code>命令在本地托管。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mt"><img src="../Images/dc9f61f68adf15b9045e259e59921675.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2DIjH7-8C-IM2HlAMlJKsA.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">项目的文档网站</figcaption></figure><h1 id="6dbf" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">测试</h1><p id="19af" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">根据dbt，“<em class="le">测试是你对你的模型和你的dbt项目中的其他资源(例如，源代码、种子和快照)做出的断言。当您运行</em> <code class="fe mu mv mw mx b"><em class="le">dbt test</em></code> <em class="le">时，dbt会告诉您项目中的每个测试是通过还是失败。</em>“该项目包含50多个测试，在<code class="fe mu mv mw mx b">_tickit__sources.yml</code>文件和<code class="fe mu mv mw mx b">test/</code>目录中的单个测试之间进行划分。典型的dbt测试检查非空值和唯一值、预期数值范围内的值以及已知字符串列表中的值。任何用SQL写的<code class="fe mu mv mw mx b">SELECT</code>语句都可以测试。</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nz oa l"/></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated"><code class="fe mu mv mw mx b">_tickit__sources.sql file</code>中的测试片段</figcaption></figure><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="870a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用<code class="fe mu mv mw mx b">dbt test</code>命令执行项目的测试。我们可以使用<code class="fe mu mv mw mx b">--select</code>可选参数(例如<code class="fe mu mv mw mx b">dbt test --select assert_all_sale_amounts_are_positive</code>)来执行单独的测试。我们还可以在大多数dbt命令中使用<code class="fe mu mv mw mx b">--threads</code>可选参数，包括<code class="fe mu mv mw mx b">dbt test</code>，增加并行性并减少执行时间。下面的例子使用了十个线程，这是为Amazon Redshift <code class="fe mu mv mw mx b">dbt</code>用户配置的任意最大值。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ob"><img src="../Images/8be89c3f2357c37826c2dfcf8d771a48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B40qOZUn1blvc3jJKObjGg.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">运行dbt测试</figcaption></figure><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ob"><img src="../Images/80e270c1407e5a0707a694cc626c7685.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AfHtdCnlm6gYjAqX516qJQ.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">成功的测试运行</figcaption></figure><h1 id="6c2f" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">乔布斯</h1><p id="faff" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">根据<a class="ae lf" href="https://docs.getdbt.com/guides/getting-started/building-your-first-project/schedule-a-job" rel="noopener ugc nofollow" target="_blank"> dbt </a>的说法，作业是您想要按计划运行的一组dbt命令。比如<code class="fe mu mv mw mx b">dbt run</code>和<code class="fe mu mv mw mx b">dbt test</code>。作业可以加载包、运行测试、具体化模型、检查<a class="ae lf" href="https://docs.getdbt.com/docs/dbt-cloud/using-dbt-cloud/cloud-snapshotting-source-freshness" rel="noopener ugc nofollow" target="_blank">源代码的新鲜度</a> ( <code class="fe mu mv mw mx b">dbt source freshness</code>)以及重新生成文档。下面，我们创建了一个日常工作，随着数据湖中数据的更新，测试、刷新和记录我们的项目。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mt"><img src="../Images/ea23cf639cd81bfe5b13f97e694b2499.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ogD4BWzYaWY21-xkAYgwVg.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">dbt云的作业运行概述</figcaption></figure><h1 id="3e4f" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">通知</h1><p id="5c90" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">根据<a class="ae lf" href="https://docs.getdbt.com/docs/dbt-cloud/using-dbt-cloud/cloud-notifications" rel="noopener ugc nofollow" target="_blank"> dbt </a>的说法，在dbt Cloud中设置通知将允许您在作业运行成功、失败或取消时通过电子邮件或所选的空闲通道接收警报。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mt"><img src="../Images/05d7a1ba48aa5bd4f58a6067daa65050.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0jgVMXIEM_G7_eK7g2dPPA.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">用于配置电子邮件和Slack的dbt Cloud通知界面</figcaption></figure><p id="3ba8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Slack通知包括运行状态、计时和在dbt Cloud中打开作业的链接。下面，我们看到一个关于我们项目日常工作运行的通知。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mt"><img src="../Images/6a1e372205a13b071fc7b5091561c4d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hYkmhHcDh2x0LUk5LvzTmA.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">从dbt Cloud通知取消在空闲时间运行的作业</figcaption></figure><h1 id="aa58" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">暴露</h1><p id="e30e" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">风险敞口是dbt的新增内容。<a class="ae lf" href="https://docs.getdbt.com/docs/building-a-dbt-project/exposures" rel="noopener ugc nofollow" target="_blank">暴露</a>使得定义和描述我们的dbt项目的下游使用成为可能，例如在仪表板、应用程序或数据科学管道中。下面是一个曝光的例子，描述了在<a class="ae lf" href="https://aws.amazon.com/quicksight" rel="noopener ugc nofollow" target="_blank"> Amazon QuickSight </a>中创建的销售仪表板。</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="1625" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上面显示的曝光YAML文件描述了下面显示的Amazon QuickSight仪表盘。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi oe"><img src="../Images/84cb6c21e1db59c3e5391772d7cb9d6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vfEXa5Zez_Qj3fdP5bv5Hw.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">亚马逊QuickSight仪表盘</figcaption></figure><p id="5515" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">曝光与dbt的自动记录功能一起工作。dbt用与数据消费者相关的上下文填充自动生成的文档站点中的专用页面。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mt"><img src="../Images/88fd8047b6a60afa97dbc05834fa040e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wuPpGq4DW6Ke-qLCN9N43A.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">项目的文档网站，显示仪表板曝光</figcaption></figure><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi of"><img src="../Images/e92e7df2b88b0634212886a3f975d350.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ued_VkoHkNuvH3tC_Mzf2g.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">项目的文档网站，显示仪表板曝光的谱系图</figcaption></figure><h1 id="1885" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">结论</h1><p id="eb16" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">在本文中，我们介绍了dbt的一些基本功能。我们了解了dbt如何使分析师更像软件工程师一样工作。我们还了解了dbt如何简化SQL中数据模型的编码，如何使用git将数据模型作为代码进行版本控制和管理，以及如何与其他数据团队成员就数据模型进行协作。</p><p id="9e4a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">本文没有探讨但对大多数大规模<a class="ae lf" href="https://docs.getdbt.com/docs/running-a-dbt-project/running-dbt-in-production" rel="noopener ugc nofollow" target="_blank"> dbt管理的生产环境</a>至关重要的主题包括<a class="ae lf" href="https://docs.getdbt.com/guides/getting-started/learning-more/using-jinja" rel="noopener ugc nofollow" target="_blank">高级Jinja模板和宏</a>、<a class="ae lf" href="https://docs.getdbt.com/reference/resource-properties/freshness" rel="noopener ugc nofollow" target="_blank">模型新鲜度</a>、<a class="ae lf" href="https://docs.getdbt.com/guides/orchestration/airflow-and-dbt-cloud/1-airflow-and-dbt-cloud" rel="noopener ugc nofollow" target="_blank">编排</a>、<a class="ae lf" href="https://docs.getdbt.com/guides/getting-started/building-your-first-project/schedule-a-job" rel="noopener ugc nofollow" target="_blank">作业调度</a>、<a class="ae lf" href="https://docs.getdbt.com/guides/orchestration/custom-cicd-pipelines/1-cicd-background" rel="noopener ugc nofollow" target="_blank">持续集成</a>、<a class="ae lf" href="https://docs.getdbt.com/guides/orchestration/custom-cicd-pipelines/1-cicd-background" rel="noopener ugc nofollow" target="_blank">和GitOps </a>、<a class="ae lf" href="https://docs.getdbt.com/docs/dbt-cloud/using-dbt-cloud/cloud-notifications" rel="noopener ugc nofollow" target="_blank">通知</a>、<a class="ae lf" href="https://docs.getdbt.com/docs/dbt-cloud/using-dbt-cloud/cloud-environment-variables" rel="noopener ugc nofollow" target="_blank">环境变量</a>和<a class="ae lf" href="https://docs.getdbt.com/docs/building-a-dbt-project/building-models/configuring-incremental-models" rel="noopener ugc nofollow" target="_blank">增量模型</a>。我们将在以后的文章中探索这些额外的dbt功能。</p></div><div class="ab cl og oh hx oi" role="separator"><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol"/></div><div class="im in io ip iq"><p id="bf96" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这篇博客代表我的观点，而不是我的雇主亚马逊网络服务公司的观点。所有产品名称、徽标和品牌都是其各自所有者的财产。除非另有说明，所有图表和插图都是作者的财产。</p></div></div>    
</body>
</html>