<html>
<head>
<title>First Interaction with Kubernetes on DC/OS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">与Kubernetes在DC操作系统上的首次互动</h1>
<blockquote>原文：<a href="https://itnext.io/first-interaction-with-kubernetes-on-dc-os-2c2749da1266?source=collection_archive---------4-----------------------#2018-06-03">https://itnext.io/first-interaction-with-kubernetes-on-dc-os-2c2749da1266?source=collection_archive---------4-----------------------#2018-06-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/9b451d2cc9b0148183f31f253712a9a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bnQRfWVMYRovGje3eVZ9rA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">资料来源:mesosphere.com</figcaption></figure><p id="be12" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">自从1.11发布以来，DC/OS已经支持他们所说的“Kubernetes-as-a-Service”(做得好，营销！).它被定位为运行托管Kubernetes集群的一种方式，提供额外的开箱即用功能，如HA、安全性以及部署和升级的方便性。减轻运行和管理Kubernetes集群的复杂性，同时利用在DC/OS上运行Kubernetes和其他框架(如Kafka、Elasticsearch等)的优势。这对我很有吸引力，因为它增加了另一项服务，我可以向用户提供这项服务，同时将所有内容都放在一个DC/操作系统集群中；更多产品，让所有微服务和谐共处。非常酷！</p><p id="5c80" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在过去的几天里，我终于有了几分钟的时间开始尝试这个新产品，并阅读了相关的文档。在这篇文章中，我想分享我在DC操作系统上开始使用Kubernetes的最初几个小时的经历。我将分享和讨论我的经验，解释一些组件，提供提示，并希望展示您也可以开始使用。</p><p id="ad42" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Github资源，如果你想尝试或跟随:</p><div class="lb lc gp gr ld le"><a href="https://github.com/geekbass/kubernetes-dcos" rel="noopener  ugc nofollow" target="_blank"><div class="lf ab fo"><div class="lg ab lh cl cj li"><h2 class="bd ir gy z fp lj fr fs lk fu fw ip bi translated">geekbass/kubernetes-dcos</h2><div class="ll l"><h3 class="bd b gy z fp lj fr fs lk fu fw dk translated">kubernetes-dcos -在DC操作系统上运行kubernetes</h3></div><div class="lm l"><p class="bd b dl z fp lj fr fs lk fu fw dk translated">github.com</p></div></div><div class="ln l"><div class="lo l lp lq lr ln ls jw le"/></div></div></a></div></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><p id="2a5a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">部署</strong></p><p id="3519" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">重要的事情先来。我们需要让Kubernetes在我们的DC/操作系统集群上运行。将包和服务部署到DC操作系统非常简单。你可以从<a class="ae la" href="https://docs.mesosphere.com/1.11/gui/catalog/" rel="noopener ugc nofollow" target="_blank">DC/操作系统目录</a>或者从<a class="ae la" href="https://docs.mesosphere.com/1.11/cli/" rel="noopener ugc nofollow" target="_blank">命令行界面</a>安装软件包。Kubernetes也不例外，支持这两种选项。在这篇文章中，我们将使用CLI，因为我们需要安装“kubernetes cli”包，以便我们可以在以后轻松地配置“kubectl”。</p><p id="3395" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我做的第一个部署是<a class="ae la" href="https://docs.mesosphere.com/services/kubernetes/1.0.3-1.9.7/quick-start/" rel="noopener ugc nofollow" target="_blank">快速入门示例</a>(接受所有默认设置)，只是为了看看当我部署它时会发生什么，并感受一下会发生什么。它真的会像预期的那样起作用吗？</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="c738" class="mj mk iq mf b gy ml mm l mn mo">dcos package install kubernetes</span></pre><p id="14ff" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">成功了！在不到10分钟的时间内，它在集群中安装了所有必要的组件(参见先决条件部分)。但是，快速启动并不比在本地运行<a class="ae la" href="https://kubernetes.io/docs/tasks/tools/install-minikube/" rel="noopener ugc nofollow" target="_blank"> minikube </a>好多少。不过，它确实证明了部署时不会出现任何问题。我真的打算看到一个真正的托管HA K8s集群，我有可能在某一天将其投入生产。</p><p id="2c20" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我删除了当前的部署，并阅读了关于<a class="ae la" href="https://docs.mesosphere.com/services/kubernetes/1.0.3-1.9.7/advanced-install/" rel="noopener ugc nofollow" target="_blank">高级安装</a>的文档，大约5分钟后，我想出了下面的JSON来满足我当前对一个好的“生产”风格测试平台的需求(参见上面git repo中的options.json)</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="27db" class="mj mk iq mf b gy ml mm l mn mo">{<br/>    "service": {<br/>       "service_account": "kubernetes",<br/>       "service_account_secret": "kubernetes/sa"<br/>  },<br/>    "kubernetes": {<br/>    "high_availability": true,<br/>    "node_count": 4,<br/>    "reserved_resources": {<br/>      "kube_cpus": 20,<br/>      "kube_mem": 20000,<br/>      "kube_disk": 10500<br/>       }<br/>    }<br/>}</span></pre><p id="a3cc" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">请注意，我使用的是DC操作系统的企业版，因此我使用的是服务帐户选项。你可以在上面的Kubernetes服务账户中看到更多信息的<a class="ae la" href="https://docs.mesosphere.com/services/kubernetes/1.0.3-1.9.7/advanced-install/" rel="noopener ugc nofollow" target="_blank">高级安装</a>文档和git repo。</p><p id="4d57" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">从上面的JSON中，您可以看到Mesosphere为我们提供了一个“高可用性”密钥，它将在h a中部署K8s组件。然后指定“node_count”，这是K8s工作节点的数量，以及您希望在DC/OS集群上为每个工作节点保留多少cpu、内存和磁盘来运行K8s服务。部署完成后，我们应该最终得到一个HA K8s集群，其中有4个工作节点，每个节点有20个CPU、20 GB内存和100 GB磁盘。注意:我们还没有为ingress做任何事情，因为它不是默认安装的一部分。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="7e24" class="mj mk iq mf b gy ml mm l mn mo">dcos package install kubernetes --options=options.json</span></pre><p id="2ee8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">万岁。一切顺利，仅用了大约12分钟就完全安装了HA所需的所有组件！</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mp"><img src="../Images/d52bc97c7c9a96265ad45044855571cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z6dBy3FmKIgopr0PH1YEaw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">高可用性部署—来源:docs.mesosphere.com</figcaption></figure><p id="0adf" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我不得不说，Kubernetes在DC操作系统上的部署是我在该平台上看到的最令人印象深刻的事情之一。这简直是再简单不过了。我不是最有经验的Kubernetes用户，但是我已经使用过它很多次了，并且理解了它的许多组件和复杂性。中间层在这方面做得很好。</p><p id="5f83" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">仪表板</strong></p><p id="9ec9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Kubernetes部署提供的一个很好的特性是Kubernetes仪表板。我不打算在这上面花太多时间，但这绝对是应该提到的，因为它是任何Kubernetes环境中的必备组件。K8s集群启动并运行后，您可以通过浏览器中的以下URL访问控制面板:</p><p id="80c6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><a class="ae la" href="http://${DCOS_URL}/service/kubernetes-proxy/" rel="noopener ugc nofollow" target="_blank"> http://${DCOS网址}/service/kubernetes-proxy/ </a></p><p id="ab65" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">访问通过DC/操作系统用户界面和管理路由器服务进行管理，其外观和行为与您预期的一样。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mq"><img src="../Images/c97c8182ba77ba7932c337a6e375041a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9d93YgE7Ifj30DjO9E-J1A.png"/></div></div></figure><p id="3467" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">你可以看到我下面有4个woker节点。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mq"><img src="../Images/9de81508d075f15686235a511e8fd775.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NYM7CPOdZWl2L7N4KBHrtg.png"/></div></div></figure><p id="3ddd" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这没什么特别的，但是我想我应该提到它是安装的一部分，以及如何访问它。大多数情况下，这是您在建立自己的K8s集群时必须自己设置的另一个组件。到目前为止很开心！</p><p id="4d21" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> Kubetctl </strong></p><p id="73f9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">“库贝拥抱”工具(我发音为“库贝-C-T-L”)。如果你曾经玩过K8s集群或者安装过minikube，那么你可能已经安装了这个命令行工具。我真的很喜欢使用这个工具，并且已经在我的机器上安装了它，但是你肯定需要安装它来继续和/或做我们已经讨论过的任何事情。您可以根据您的操作系统需求从这里获得<a class="ae la" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank">安装</a>。您还需要安装<a class="ae la" href="https://docs.mesosphere.com/1.11/cli/" rel="noopener ugc nofollow" target="_blank">DC/操作系统命令行界面</a>来简化kubectl环境的配置。</p><p id="3d2e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">一旦安装了kubectl并安装了DC/OS CLI，就可以配置kubectl来访问您的集群了。</p><p id="a514" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">安装DC/操作系统Kuberenetes CLI:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="e750" class="mj mk iq mf b gy ml mm l mn mo">dcos package install kubernetes --cli</span></pre><p id="dfbf" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">执行以下操作，以允许DC/操作系统CLI自动设置对群集的访问:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="d2c2" class="mj mk iq mf b gy ml mm l mn mo">dcos kubernetes kubeconfig<br/>kubeconfig context 'dcos-ops' created successfully</span></pre><p id="44fa" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">通过运行几个命令进行验证:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="40a5" class="mj mk iq mf b gy ml mm l mn mo">kubectl get nodes<br/>NAME                                   STATUS    ROLES     AGE       VERSION<br/>kube-node-0-kubelet.kubernetes.mesos   Ready     &lt;none&gt;    5d       v1.9.7<br/>kube-node-1-kubelet.kubernetes.mesos   Ready     &lt;none&gt;    5d       v1.9.7<br/>kube-node-2-kubelet.kubernetes.mesos   Ready     &lt;none&gt;    5d       v1.9.7<br/>kube-node-3-kubelet.kubernetes.mesos   Ready     &lt;none&gt;    5d       v1.9.7</span><span id="6a05" class="mj mk iq mf b gy mr mm l mn mo">kubectl cluster-info<br/>Kubernetes master is running at <a class="ae la" href="https://10.32.88.197/service/kubernetes-proxy" rel="noopener ugc nofollow" target="_blank">https://${DCOS_URL}/service/kubernetes-proxy</a><br/>KubeDNS is running at <a class="ae la" href="https://10.32.88.197/service/kubernetes-proxy/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy" rel="noopener ugc nofollow" target="_blank">https://</a><a class="ae la" href="https://10.32.88.197/service/kubernetes-proxy" rel="noopener ugc nofollow" target="_blank">${DCOS_URL}</a><a class="ae la" href="https://10.32.88.197/service/kubernetes-proxy/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy" rel="noopener ugc nofollow" target="_blank">/service/kubernetes-proxy/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</a></span><span id="83d2" class="mj mk iq mf b gy mr mm l mn mo">To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</span></pre><p id="32f5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">真的很简单，我不需要做太多。请注意，您可以设置多个环境和上下文。在某些时候，您可能需要重新运行kubeconfig来重新获得访问权限，因为默认情况下，您将失去dcos身份验证，需要重新登录。</p><p id="89bf" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在我们已经可以与我们的Kubernetes集群进行交互了，让我们开始在那里进行一些部署并开始试验。这应该就像任何K8s集群一样。</p><p id="c17f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">启动一个简单的部署:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="816c" class="mj mk iq mf b gy ml mm l mn mo">kubectl run nginx --image=nginx --port 8080<br/>deployment.apps "nginx" created</span><span id="fcf3" class="mj mk iq mf b gy mr mm l mn mo">kubectl get pods<br/>NAME                    READY     STATUS    RESTARTS   AGE<br/>nginx-b87c99f86-9lfnn   1/1       Running   0          14s</span></pre><p id="970e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">让我们删除当前窗格，并确保它会重新出现:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="c863" class="mj mk iq mf b gy ml mm l mn mo">kubectl delete pods nginx-b87c99f86-9lfnn<br/>pod "nginx-b87c99f86-9lfnn" deleted<br/><br/>kubectl get pods<br/>NAME                    READY     STATUS              RESTARTS   AGE<br/>nginx-b87c99f86-9lfnn   0/1       Terminating         0          1m<br/>nginx-b87c99f86-zpjg6   0/1       ContainerCreating   0          2s</span><span id="327f" class="mj mk iq mf b gy mr mm l mn mo">kubectl get pods<br/>NAME                    READY     STATUS        RESTARTS   AGE<br/>nginx-b87c99f86-9lfnn   0/1       Terminating   0          1m<br/>nginx-b87c99f86-zpjg6   1/1       Running       0          10s</span><span id="138e" class="mj mk iq mf b gy mr mm l mn mo">kubectl get pods<br/>NAME                    READY     STATUS    RESTARTS   AGE<br/>nginx-b87c99f86-zpjg6   1/1       Running   0          14s</span></pre><p id="4232" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">酷！没什么特别的，不过就是在按预期做事。</p><p id="6d61" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">缩放怎么样？</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="3024" class="mj mk iq mf b gy ml mm l mn mo">kubectl get deployment<br/>NAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE<br/>nginx     1         1         1            1           3m</span><span id="b386" class="mj mk iq mf b gy mr mm l mn mo">kubectl scale --replicas=20 deployment/nginx<br/>deployment.extensions "nginx" scaled</span><span id="65e3" class="mj mk iq mf b gy mr mm l mn mo">kubectl get deployment<br/>NAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE<br/>nginx     20        20        20           1           4m</span><span id="12f1" class="mj mk iq mf b gy mr mm l mn mo">kubectl get pods<br/>NAME                    READY     STATUS    RESTARTS   AGE<br/>nginx-b87c99f86-2rqbp   1/1       Running   0          9s<br/>nginx-b87c99f86-5zqmx   1/1       Running   0          8s<br/>nginx-b87c99f86-6ncqg   1/1       Running   0          9s<br/>nginx-b87c99f86-8dhfb   1/1       Running   0          8s<br/>nginx-b87c99f86-9596z   1/1       Running   0          8s<br/>nginx-b87c99f86-bs96v   1/1       Running   0          9s<br/>nginx-b87c99f86-cqlmf   1/1       Running   0          8s<br/>nginx-b87c99f86-crdnx   1/1       Running   0          8s<br/>nginx-b87c99f86-fc6ph   1/1       Running   0          8s<br/>nginx-b87c99f86-fzszg   1/1       Running   0          8s<br/>nginx-b87c99f86-kbqmz   1/1       Running   0          9s<br/>nginx-b87c99f86-lk669   1/1       Running   0          8s<br/>nginx-b87c99f86-m4kgz   1/1       Running   0          9s<br/>nginx-b87c99f86-mfgns   1/1       Running   0          8s<br/>nginx-b87c99f86-nph4v   1/1       Running   0          9s<br/>nginx-b87c99f86-pthd5   1/1       Running   0          8s<br/>nginx-b87c99f86-qfr86   1/1       Running   0          9s<br/>nginx-b87c99f86-rkpzr   1/1       Running   0          8s<br/>nginx-b87c99f86-z9n6g   1/1       Running   0          8s<br/>nginx-b87c99f86-zpjg6   1/1       Running   0          3m</span><span id="0099" class="mj mk iq mf b gy mr mm l mn mo"><br/>kubectl delete deployment nginx<br/>deployment.extensions "nginx" deleted</span><span id="98e1" class="mj mk iq mf b gy mr mm l mn mo">kubectl get pods<br/>NAME                    READY     STATUS        RESTARTS   AGE<br/>nginx-b87c99f86-5zqmx   0/1       Terminating   0          4m<br/>nginx-b87c99f86-9596z   0/1       Terminating   0          4m<br/>nginx-b87c99f86-bs96v   0/1       Terminating   0          4m<br/>nginx-b87c99f86-kbqmz   0/1       Terminating   0          4m<br/>nginx-b87c99f86-lk669   0/1       Terminating   0          4m<br/>nginx-b87c99f86-pthd5   0/1       Terminating   0          4m<br/>nginx-b87c99f86-qfr86   0/1       Terminating   0          4m<br/>nginx-b87c99f86-z9n6g   0/1       Terminating   0          4m<br/>nginx-b87c99f86-zpjg6   0/1       Terminating   0          7m<br/></span></pre><p id="784d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">同样，这里绝对没有发生什么特别的事情，但是你可以看到它正在做一些事情。这是工作，因为它应该没有真正的任何汗水，血液或眼泪在这一点上。我真的很喜欢只需发出几个命令就可以设置与K8s集群的交互的简单性。到目前为止非常简单。</p><p id="afa3" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我认为在这里看到一件事真的很好，特别是作为DC/操作系统集群的运营或管理员，这是一种从DC/操作系统UI中查看Kubernetes服务运行的方式。我可能会发现，试图在不同的编排者(Marathon和Kubernetes)之间追踪不同的服务会变得令人困惑。当然，这并不是一个巨大的损失，但是试着把所有的事情都放在一个罩下会很好。</p><p id="e623" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">与DC/OS上所有东西的通信</strong></p><p id="8a95" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">对我来说，这是在DC操作系统上运行Kubernetes最有趣的特性。能够为我的用户提供更多选择来管理他们的微服务。共享集群中的所有微服务和大数据服务和谐共存，能够轻松地相互交互和利用。示例:运行在Kubernetes上的服务可以利用运行在DC/OS上的Kafka集群，反之亦然。我所说的容易是指在用户端只需很少的定制和努力。DC操作系统已经通过其处理服务发现、DNS和具有VIP和覆盖等功能的网络的方式使这成为可能。</p><p id="f166" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">让我们看看如何与运行在Kubernetes中的服务和运行在DC/OS中的其他服务进行交互。让我们创建另一个部署，使用一个公开的端口作为备用，因为我们知道可以将NodePort用于持久URL:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="163a" class="mj mk iq mf b gy ml mm l mn mo">kubectl run nginx --image=nginx --port=80<br/>deployment.apps "nginx" created<br/><br/>kubectl expose deployment nginx --port=80 --target-port=80 --type=NodePort<br/>service "nginx" exposed<br/><br/>kubectl describe services nginx<br/>Name:                     nginx<br/>Namespace:                default<br/>Labels:                   run=nginx<br/>Annotations:              &lt;none&gt;<br/>Selector:                 run=nginx<br/>Type:                     NodePort<br/>IP:                       10.100.124.239<br/>Port:                     &lt;unset&gt;  80/TCP<br/>TargetPort:               80/TCP<br/>NodePort:                 &lt;unset&gt;  30291/TCP<br/>Endpoints:                9.0.1.79:80<br/>Session Affinity:         None<br/>External Traffic Policy:  Cluster<br/>Events:                   &lt;none&gt;</span></pre><p id="a82c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">所以有几件事我很想知道:</p><ul class=""><li id="e57d" class="ms mt iq ke b kf kg kj kk kn mu kr mv kv mw kz mx my mz na bi translated">DC/OS中运行的其他服务如何与Kubernetes中的服务交互？其他DC/操作系统服务→ Kubernetes服务</li><li id="f61b" class="ms mt iq ke b kf nb kj nc kn nd kr ne kv nf kz mx my mz na bi translated">Kubernetes服务如何与DC/OS集群上运行的其他服务进行通信？Kubernetes服务→DC/操作系统服务</li></ul><p id="0418" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">开箱即用的DC/操作系统为其所有服务提供了基于DNS的服务发现机制。这允许容易的服务通信和负载平衡。我不会详细介绍这是如何工作的，也不会解释所提供的不同选项，但重要的是要知道，您可以根据以下命名约定解析运行在DC/操作系统上的服务:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="6bd9" class="mj mk iq mf b gy ml mm l mn mo">&lt;service-name&gt;.&lt;group-name&gt;.&lt;framework-name&gt;.mesos</span></pre><p id="0a43" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">有更好的方法可以做到这一点，比如通过VIP，但我们必须明确指定这一点，因为它不是默认的。但是这也适用于运行在DC操作系统上的Kubernetes服务吗？</p><p id="ce1a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">不幸的是，它不会，除非我错过了什么(绝对有可能)。我尝试了所有我能想到的命名约定，但都无法解决。我甚至点击<a class="ae la" href="https://docs.mesosphere.com/1.11/networking/DNS/mesos-dns/mesos-dns-api/" rel="noopener ugc nofollow" target="_blank"> MesosDNS api </a>在我的集群中搜索任何名为“nginx”的东西，但没有任何结果。这告诉我，要么是我遗漏了什么，要么是Kubernetes中运行的服务没有进入MesosDNS和/或它正在使用自己的服务。</p><p id="3cb1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">但是，上面“describe”输出中的端点(9.0.1.79:80)和容器IP (10.100.124.239)又如何呢？我们在DC操作系统上的其他服务能与之交互和通信吗？答案是肯定的。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="5d32" class="mj mk iq mf b gy ml mm l mn mo">curl 9.0.1.79:80<br/>&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>&lt;title&gt;Welcome to nginx!&lt;/title&gt;<br/>&lt;style&gt;<br/>    body {<br/>        width: 35em;<br/>        margin: 0 auto;<br/>        font-family: Tahoma, Verdana, Arial, sans-serif;<br/>    }<br/>&lt;/style&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;<br/>&lt;p&gt;If you see this page, the nginx web server is successfully installed and<br/>working. Further configuration is required.&lt;/p&gt;</span><span id="aa0b" class="mj mk iq mf b gy mr mm l mn mo">&lt;p&gt;For online documentation and support please refer to<br/>&lt;a href="<a class="ae la" href="http://nginx.org/" rel="noopener ugc nofollow" target="_blank">http://nginx.org/</a>"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;<br/>Commercial support is available at<br/>&lt;a href="<a class="ae la" href="http://nginx.com/" rel="noopener ugc nofollow" target="_blank">http://nginx.com/</a>"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><span id="df47" class="mj mk iq mf b gy mr mm l mn mo">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span><span id="ece7" class="mj mk iq mf b gy mr mm l mn mo">curl 10.100.124.239:80<br/>&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>&lt;title&gt;Welcome to nginx!&lt;/title&gt;<br/>&lt;style&gt;<br/>    body {<br/>        width: 35em;<br/>        margin: 0 auto;<br/>        font-family: Tahoma, Verdana, Arial, sans-serif;<br/>    }<br/>&lt;/style&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;<br/>&lt;p&gt;If you see this page, the nginx web server is successfully installed and<br/>working. Further configuration is required.&lt;/p&gt;</span><span id="44ad" class="mj mk iq mf b gy mr mm l mn mo">&lt;p&gt;For online documentation and support please refer to<br/>&lt;a href="<a class="ae la" href="http://nginx.org/" rel="noopener ugc nofollow" target="_blank">http://nginx.org/</a>"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;<br/>Commercial support is available at<br/>&lt;a href="<a class="ae la" href="http://nginx.com/" rel="noopener ugc nofollow" target="_blank">http://nginx.com/</a>"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><span id="8637" class="mj mk iq mf b gy mr mm l mn mo">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="05f3" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">以上输出来自使用Marathon在DC/OS上运行的容器中附加和执行curl。这里需要注意几点:所使用的端点地址实际上来自我们在配置集群时创建的<a class="ae la" href="https://docs.mesosphere.com/1.11/networking/SDN/dcos-overlay/" rel="noopener ugc nofollow" target="_blank">DC/操作系统覆盖</a>网络，并在我们指定的端口公开。所使用的IP是K8s默认IP，它是从K8s使用的网络中分配的，因为在K8s集群上，所有容器都默认获得IP地址。我们可以用这些来交流，但它们可能会在某个时候改变。</p><p id="f1ac" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">因此，如果端点来自DC/操作系统Overylay，我应该能够从DC/操作系统用户界面的“网络”选项卡下看到它，并能够解析FQDN？让我们看看。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/1522e488ed837c10b3b535b030ec2b9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VX_C7wT1rqONj_UM4O4ygA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">覆盖概述</figcaption></figure><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/20f6d5c1ba0aad3dff37b85c26cbdacb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*494oKjp2yHrdIkjcLefzhQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">“dcos”覆盖IP</figcaption></figure><p id="108c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">嗯……我在DC/操作系统覆盖界面中看不到运行在Kubernetes中的“nginx”服务，但是我可以使用来自覆盖网络(端点)的IP从运行在Kubernetes之外的服务点击它。我将不得不在这方面做更多的研究，但至少目前我知道在DC操作系统上运行的其他服务可以使用在Kubernetes上运行的服务。只是不知道如何使用FQDN或任何可以持久的东西。</p><p id="45bb" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">反之亦然怎么样？K8s中运行的服务如何与DC/OS中运行的其他服务通信？这被证明是非常简单的，和你可能已经在做的事情没有什么不同。我们选择使用<a class="ae la" href="https://docs.mesosphere.com/1.11/networking/load-balancing-vips/virtual-ip-addresses/" rel="noopener ugc nofollow" target="_blank">贵宾</a>为我们服务。</p><p id="f4af" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">因此，让我们连接到运行在Kubernetes上的nginx容器，并尝试访问运行在Kubernetes之外的DC/OS上的一个服务:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="f737" class="mj mk iq mf b gy ml mm l mn mo">kubectl exec -it nginx-7587c6fdb6-vzlqp /bin/sh</span><span id="15d7" class="mj mk iq mf b gy mr mm l mn mo">### Omitting installation of some packages here ####</span><span id="64a5" class="mj mk iq mf b gy mr mm l mn mo"># curl dotnet.marathon.l4lb.thisdcos.directory:8000<br/>&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>    &lt;meta charset="utf-8" /&gt;<br/>    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0" /&gt;<br/>    &lt;title&gt;Home Page - aspnetapp&lt;/title&gt;<br/></span><span id="35ab" class="mj mk iq mf b gy mr mm l mn mo">...<br/>...<br/>...<br/></span><span id="d45d" class="mj mk iq mf b gy mr mm l mn mo">&lt;/body&gt;<br/>&lt;/html&gt;</span><span id="803f" class="mj mk iq mf b gy mr mm l mn mo"># nslookup dotnet.marathon.l4lb.thisdcos.directory<br/>Server:  198.51.100.4<br/>Address: 198.51.100.4#53</span><span id="8955" class="mj mk iq mf b gy mr mm l mn mo">Name: dotnet.marathon.l4lb.thisdcos.directory<br/>Address: 11.220.254.231</span></pre><p id="a1a2" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">所以从上面的输出可以看出，对于运行在K8s中的服务来说，与运行在DC/OS中的其他服务进行解析和通信是极其简单的。厉害！</p><p id="692a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">因此，对于服务发现和联网，Kubernetes服务似乎很容易与DC/OS中的其他服务发生碰撞，但反之则不太容易。正如我之前提到的，我可能遗漏了一个关键部分，因为我不是Kubernetes专家。也许这是目前与Kubernetes中运行的服务进行交互的一个限制？无论哪种方式，目前都有简单的方法来解决这个问题，如利用<a class="ae la" href="https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport" rel="noopener ugc nofollow" target="_blank">节点端口</a>，但如果能看到所有使用DC/OS Overylay网络的服务在DC/OS UI中可见和/或可解析，那就更好了。我会回到文档和社区，看看是否有人能帮我解决这个问题！</p><p id="44b1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">做</strong></p><p id="e2f9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">头几个小时还不错！仍然有许多事情要做，许多事情要弄清楚。我给自己列了一个“要做”的清单，列出了我需要弄清楚的事情，当我有时间的时候，我可能会在某个时候写下来。</p><ul class=""><li id="8a90" class="ms mt iq ke b kf kg kj kk kn mu kr mv kv mw kz mx my mz na bi translated">升级—发布新版本时如何升级K8s集群。</li><li id="48e1" class="ms mt iq ke b kf nb kj nc kn nd kr ne kv nf kz mx my mz na bi translated">多K8s集群——这应该会出现在DC操作系统的后续版本中。在DC/操作系统中管理多个K8s集群。不确定这是否有意义，但我可以看到一个用例，允许每个开发团队有一个单独的K8s集群。</li><li id="4cab" class="ms mt iq ke b kf nb kj nc kn nd kr ne kv nf kz mx my mz na bi translated">入口—设置外部DC/操作系统群集通信到K8s的入口。这里有很多不同的选择。</li><li id="0310" class="ms mt iq ke b kf nb kj nc kn nd kr ne kv nf kz mx my mz na bi translated">监控和记录Kubernetes及其服务—我们已经为当前的DC/操作系统服务设置了日志记录和监控，但是我们还需要为K8s设置什么吗？</li><li id="a447" class="ms mt iq ke b kf nb kj nc kn nd kr ne kv nf kz mx my mz na bi translated">深入了解Kubernetes如何在DC/操作系统上运行——需要了解它在DC/操作系统上实际上是如何运行的。我想就像其他框架一样。它在用UCR吗？我不能移交没有一个更好的全面了解它如何运行在DC/OS第一。</li></ul></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><p id="28ac" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">总之，到目前为止，我对在DC/OS上运行和配置K8s集群(HA'd)是如此容易感到非常满意。虽然还有很多事情要做，而且到目前为止只花了几个小时的时间，但我真的不需要付出太多努力。只需一点点读取和执行几个命令就可以完成很多工作。我对一切都运行良好印象深刻，就像一个独立的Kubernetes集群一样。到目前为止，我唯一的抱怨是弄清楚如何从DC/OS上的其他服务持久地与运行在Kubernetes上的服务交互(可能是我的疏忽)。除此之外，我的第一次互动非常顺利，总体来说我非常满意。希望我能很快有机会浏览我的“待办事项”清单，并开始分享我的发现。</p></div></div>    
</body>
</html>