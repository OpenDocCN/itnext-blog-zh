<html>
<head>
<title>Task scheduling with node-cron</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于节点克隆的任务调度</h1>
<blockquote>原文：<a href="https://itnext.io/task-scheduling-with-node-cron-fe4acde2eb9c?source=collection_archive---------4-----------------------#2020-06-09">https://itnext.io/task-scheduling-with-node-cron-fe4acde2eb9c?source=collection_archive---------4-----------------------#2020-06-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="2fcb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">作为开发人员，我们发现自己处于需要在给定的频率或时间执行动作的情况下。如果我们想要定期触发数据库备份，或者如果我们想要在每周日的游戏中触发大型事件。有一个工具对此并不陌生:cron(来自希腊语单词“时间”,χρόνος (Chronos )),由AT &amp; T贝尔实验室于1975年5月发布，用于类似Unix的计算机操作系统。</p><h2 id="8319" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">Cron是什么？</h2><figure class="li lj lk ll gt lm gh gi paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="gh gi lh"><img src="../Images/145f08333794e97ad8f3d093be48d39b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g_xsKOzf_UF_uNJuJPFgag.png"/></div></div><figcaption class="lt lu gj gh gi lv lw bd b be z dk translated">Cron是什么？宝贝不要安排我…不要安排我..不再有…</figcaption></figure><p id="e345" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Cron是一个基于时间的作业调度器，这意味着它可以调度作业在固定的时间、日期或间隔自动定期运行。由于Cron最适合调度重复性的任务，我们可以想到前面的例子(备份数据库或者触发游戏中的群体事件)。</p><p id="814a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于第一种情况，假设我们有一个类似Google Drive或Dropbox的服务。用户将他们的文件上传到我们的云服务器，这些文件在用户需要的时候都是可用的。为了避免丢失数据，我实现了一个备份系统，每小时触发一个功能，将云服务器数据备份到备份服务器。我会使用一个cron作业，配置为每个系统小时调用一次备份函数。</p><p id="2dae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于第二种情况，我们有一个在线游戏，成千上万的玩家同时玩。要在每周的某个时间实现一次事件，我们可以使用cronjob来说明“在UTC时间每周六下午6点调用initiateCastleSiege”。</p><h2 id="40a4" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">它是如何工作的？</h2><p id="6133" class="pw-post-body-paragraph jq jr it js b jt lx jv jw jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn im bi translated">cron作业的操作由crontab (cron表)配置定义，如下所示:</p><pre class="li lj lk ll gt mc md me mf aw mg bi"><span id="d7a8" class="ko kp it md b gy mh mi l mj mk"># ┌───────────── minute (0 - 59)<br/># │ ┌───────────── hour (0 - 23)<br/># │ │ ┌───────────── day of the month (1 - 31)<br/># │ │ │ ┌───────────── month (1 - 12)<br/># │ │ │ │ ┌───────────── day of the week (0 - 6) (Sunday to Saturday;<br/># │ │ │ │ │                                   7 is also Sunday on some systems)<br/># │ │ │ │ │<br/># │ │ │ │ │<br/># * * * * * &lt;command to execute&gt;</span></pre><p id="b634" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">每一行的语法都需要一个由五个字段组成的cron表达式，这五个字段代表执行函数的时间，后面跟一个要执行的函数。</p><h2 id="f28d" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">使用Express.js的现代解决方案</h2><p id="4851" class="pw-post-body-paragraph jq jr it js b jt lx jv jw jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn im bi translated">根据对人力资源专业人士和开发人员的<a class="ae ml" href="https://www.codingame.com/work/codingame-developer-survey-2020/" rel="noopener ugc nofollow" target="_blank"> 2020 CodinGame年度调查</a>，十大热门编程语言将JavaScript排在第一位。71%的调查对象投票支持JavaScript，它是目前最受欢迎的编程语言。它被广泛用于web和后端开发。<br/>作为最流行的JavaScript语言，Express是最流行和最广泛采用的JavaScript框架(Github stars也是如此):</p><figure class="li lj lk ll gt lm gh gi paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="gh gi mm"><img src="../Images/acea442ee764429322fea6233cd3f3d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TesGiKbOB9tv-FcLKkYl4Q.png"/></div></div><figcaption class="lt lu gj gh gi lv lw bd b be z dk translated">stars的Github服务器端JavaScript框架</figcaption></figure><h2 id="43f1" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">node-cron [ <a class="ae ml" href="https://github.com/node-cron/node-cron" rel="noopener ugc nofollow" target="_blank"> Github </a></h2><p id="6384" class="pw-post-body-paragraph jq jr it js b jt lx jv jw jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn im bi translated">node-cron模块是一个基于GNU crontab的Node.js纯JavaScript的小型任务调度器。</p><p id="b7c3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们将构建一个简单的Express服务器，每10秒显示一条消息，然后我们将讨论node-cron具有的特性。</p><h2 id="ad81" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">例子</h2><p id="6daa" class="pw-post-body-paragraph jq jr it js b jt lx jv jw jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn im bi translated">要下载Node.js，请遵循官方网站(<a class="ae ml" href="https://nodejs.org/en/download/" rel="noopener ugc nofollow" target="_blank">https://nodejs.org/en/download/</a>)中的说明。它适用于Windows、macOS和Linux。我用的是谷歌Pixelbook，配有ChromeOS和Linux操作系统，效果很好。<br/>第一步，我们将创建一个存放文件的文件夹，里面有一个index.js。我们将使用以下命令安装express和node-cron的NPM库:</p><blockquote class="mn"><p id="055e" class="mo mp it bd mq mr ms mt mu mv mw kn dk translated">npm安装—保存快速节点-cron</p></blockquote><p id="8b0d" class="pw-post-body-paragraph jq jr it js b jt mx jv jw jx my jz ka kb mz kd ke kf na kh ki kj nb kl km kn im bi translated">我们在index.js文件中添加:</p><blockquote class="mn"><p id="4f39" class="mo mp it bd mq mr ms mt mu mv mw kn dk translated">const express = require(' express ')；<br/>const cron = require(" node-cron ")；<br/>const app = express()；</p><p id="57a0" class="mo mp it bd mq mr ms mt mu mv mw kn dk translated">cron.schedule("*/10 * * * * * "，function(){<br/>console . log(" Hello World！");<br/> }) <br/> app.listen(3000，function() { console.log('服务器在线')；});</p></blockquote><p id="edd5" class="pw-post-body-paragraph jq jr it js b jt mx jv jw jx my jz ka kb mz kd ke kf na kh ki kj nb kl km kn im bi translated">在我们运行执行“node index.js”的程序后，我们将看到“Hello World！”每10秒发一条消息。</p><h2 id="5e98" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">其他节点cron功能</h2><p id="4fd0" class="pw-post-body-paragraph jq jr it js b jt lx jv jw jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn im bi translated">您可以使用由逗号分隔多个值:</p><pre class="li lj lk ll gt mc md me mf aw mg bi"><span id="dbc4" class="ko kp it md b gy mh mi l mj mk">cron.schedule('1,2,4,5 * * * *', () =&gt; {<br/>  console.log('running every minute 1, 2, 4 and 5');<br/>});</span></pre><p id="952a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">定义值的范围:</p><pre class="li lj lk ll gt mc md me mf aw mg bi"><span id="d4d7" class="ko kp it md b gy mh mi l mj mk">cron.schedule('1-5 * * * *', () =&gt; {<br/>  console.log('running every minute to 1 from 5');<br/>});</span></pre><p id="9d2f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">以步长值为例:</p><pre class="li lj lk ll gt mc md me mf aw mg bi"><span id="a1df" class="ko kp it md b gy mh mi l mj mk">cron.schedule('*/2 * * * *', () =&gt; {<br/>  console.log('running a task every two minutes');<br/>});</span></pre><p id="b879" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">甚至使用名字:</p><pre class="li lj lk ll gt mc md me mf aw mg bi"><span id="260b" class="ko kp it md b gy mh mi l mj mk">cron.schedule('* * * January,September Sunday', () =&gt; {<br/>  console.log('running on Sundays of January and September');<br/>});</span></pre><p id="b454" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用时区:</p><pre class="li lj lk ll gt mc md me mf aw mg bi"><span id="49f9" class="ko kp it md b gy mh mi l mj mk">cron.schedule('0 1 * * *', () =&gt; {<br/>   console.log('Running a job at 01:00 at America/Sao_Paulo timezone');<br/> }, {<br/>   scheduled: true,<br/>   timezone: "America/Sao_Paulo"<br/> });</span></pre><p id="33fd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，可以使用以下生命周期来声明和触发任务，使其不是在程序启动时开始，而是在某个操作时开始:</p><pre class="li lj lk ll gt mc md me mf aw mg bi"><span id="9e1e" class="ko kp it md b gy mh mi l mj mk">var cron = require('node-cron');</span><span id="4a27" class="ko kp it md b gy nc mi l mj mk">var task = cron.schedule('* * * * *', () =&gt;  {<br/>  console.log('stopped task');<br/>}, {<br/>  scheduled: false<br/>});</span><span id="422f" class="ko kp it md b gy nc mi l mj mk">//Start: Start the scheduled task<br/>task.start();</span><span id="9706" class="ko kp it md b gy nc mi l mj mk">//Stop: The task won't be executed unless re-started<br/>task.stop();</span><span id="41e8" class="ko kp it md b gy nc mi l mj mk">//Destroy: The task will be stopped and completely destroyed<br/>task.destroy();</span></pre><p id="841f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，为了验证cron表达式:</p><pre class="li lj lk ll gt mc md me mf aw mg bi"><span id="f0bf" class="ko kp it md b gy mh mi l mj mk">var cron = require('node-cron');<br/><br/>var valid = cron.validate('59 * * * *');<br/>var invalid = cron.validate('60 * * * *');</span></pre></div></div>    
</body>
</html>