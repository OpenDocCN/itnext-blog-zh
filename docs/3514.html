<html>
<head>
<title>How to use mock’s and stubs for testing in the project.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在项目中使用mock和stubs进行测试。</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-use-mocks-and-stubs-for-testing-in-the-project-51d8c5c55e69?source=collection_archive---------0-----------------------#2020-01-01">https://itnext.io/how-to-use-mocks-and-stubs-for-testing-in-the-project-51d8c5c55e69?source=collection_archive---------0-----------------------#2020-01-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/7592ea95678a75bc23bf6ac88ed7858e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pRm3Xa4P66fIahdUTpy5Og.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Zan在<a class="ae kc" href="https://unsplash.com/photos/yBEUD8SWABc" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="be18" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了方便起见，现有测试用例的自动化测试覆盖和结构测试脚本应该类似于测试用例的结构——前提条件、步骤和后置条件。</p><p id="5abc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">得到每个自动化脚本应该有3个步骤的规则:</p><ol class=""><li id="6531" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">前提条件(应用程序的初始化，准备数据，初始化测试数据)。</li><li id="cfe8" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">步骤(测试)(立即测试)。</li><li id="beda" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">后置条件(检查你想要的，删除的，在脚本执行期间创建的测试数据)。</li></ol><p id="a49c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本质上，这无非是<strong class="kf ir">给了</strong>，<strong class="kf ir">当了</strong>，<strong class="kf ir">然后</strong>的BDD</p><p id="6019" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">目前，大多数工程师在自动化项目步骤(测试)上没有问题。所有人都学会了编写简单的自动化脚本。使用Selenium WebDriver来使用click()和sendKeys()方法。</p><p id="0f57" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">类似于step步骤，大多数自动化工程师学会了执行检查(步骤后置条件)、assertEquals、assertTrue、assertThat等。学习了如何检查哪些元素是可见的、可访问的、可点击的，以及包含正确的文本。如果有必要，我甚至学会了期待一段时间。</p><p id="ed3a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但不幸的是，大多数工程师在自动化的大问题上是以步骤为前提条件的。许多自动化工程师根本不知道如何在运行自动化脚本之前准备数据。</p><p id="fb61" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你在解决这些问题上没有答案，可以有把握地说这篇文章就是为你写的:</p><ul class=""><li id="c204" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lp lh li lj bi translated">如何使用自动化脚本阅读电子邮件？</li><li id="f016" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lp lh li lj bi translated">如何使用自动化脚本获取或发送短信。</li><li id="2ed3" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lp lh li lj bi translated">如何传递无效的SSL证书？</li><li id="a921" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lp lh li lj bi translated">如何关闭弹出窗口？</li></ul><p id="7191" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们深入了解仿真器之前，我可以说一件事。上面列表中描述的使用自动化脚本完成的所有操作都是不好的。因为自动化脚本和外部服务非常慢而且不稳定。</p><p id="c309" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于我自己，我制定了一些规则:</p><ul class=""><li id="8cbc" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lp lh li lj bi translated">总是模拟外部服务。</li><li id="9237" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lp lh li lj bi translated">仿真那么慢。</li><li id="482d" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lp lh li lj bi translated">仿真一切不受控制的事物。</li></ul><p id="0417" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在自动化中，脚本不应该使用外部依赖或服务。因为它们不在你的控制之下，所以速度慢，不稳定。</p><p id="f9d3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在自动化脚本中正确地使用模拟器。因为它们速度快，稳定，可控。</p><p id="797b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">平时和同事交流仿真器的话题，听到的都是不同的意见和分歧。</p><p id="2114" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最受欢迎的模拟器是一个模拟器，它是不一样的。因为模拟器只是模拟。然而，在我们的生活中，有许多不断使用仿真器的例子。别介意它们不是真的。而在某些领域没有模拟器就不行。</p><p id="004c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如:</p><ul class=""><li id="9bce" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lp lh li lj bi translated">仿真芯片。</li><li id="9b6a" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lp lh li lj bi translated">拿着出气筒的拳击手。</li><li id="d21a" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lp lh li lj bi translated">代表测试汽车引擎。</li><li id="3c96" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lp lh li lj bi translated">飞机风洞</li></ul><p id="123c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为什么这些模拟器的例子看起来并不奇怪？</p><p id="275e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">答案只有一个。许多人习惯于做错事。</p><p id="7d85" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因为所有人都是如此。似乎唯一正确的方法。</p><p id="23f5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们这样做，没有什么是正确的:</p><ul class=""><li id="5627" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lp lh li lj bi translated">夺了生产基地。</li><li id="cef9" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lp lh li lj bi translated">寻找我们需要的数据。如果数据完全存在于数据库中，他们就运行我们的自动化脚本。看起来没问题。</li><li id="05d4" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lp lh li lj bi translated">如果我们需要的数据不在数据库里怎么办？或者数据是。但它们与我们需要的略有不同。我们将无法执行我们的测试用例？</li></ul><p id="ea1c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者:</p><ul class=""><li id="5c30" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lp lh li lj bi translated">我们用的是真正的服务。</li><li id="def3" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lp lh li lj bi translated">我们试图理解弹出窗口出现的逻辑。</li><li id="cd9a" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lp lh li lj bi translated">我们试着猜测。在我们的自动化脚本中，我们插入循环，if或wait。相应的，这一切都是恐怖的，不稳定的。</li></ul><p id="3011" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">熟悉的情况？</p><p id="a842" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">试着猜测和匹配数据是不正确的。以及使用模拟器的权利。</p><p id="7a4c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我会给你示例代码:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="e3bd" class="lz ma iq lv b gy mb mc l md me"><strong class="lv ir">public class </strong>UseMock {</span><span id="5ea4" class="lz ma iq lv b gy mf mc l md me"><strong class="lv ir">public static void </strong>doSomething() {<br/>        <strong class="lv ir">try </strong>{</span><span id="298f" class="lz ma iq lv b gy mf mc l md me">someList = restClient.loadData();</span><span id="0540" class="lz ma iq lv b gy mf mc l md me">} <strong class="lv ir">catch </strong>(IOException ex) {</span><span id="9b7b" class="lz ma iq lv b gy mf mc l md me">logger.error(<strong class="lv ir">"Failed to load"</strong>, ex);<br/>            someList = <em class="mg">emptyList</em>();<br/>        }</span><span id="3523" class="lz ma iq lv b gy mf mc l md me">}<br/>}</span></pre><p id="5add" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">试着回答这个问题:如何在一个真实的后端系统上测试这段代码？</p><p id="3a09" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我想答案是显而易见的。这段代码不可能在实时后端上测试。</p><p id="67b9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这段代码中有一个错误:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="2a88" class="lz ma iq lv b gy mb mc l md me">} <strong class="lv ir">catch </strong>(IOException ex) {</span><span id="89ac" class="lz ma iq lv b gy mf mc l md me">logger.error(<strong class="lv ir">"Failed to load"</strong>, ex);<br/>            someList = <em class="mg">emptyList</em>();<br/>        }</span></pre><p id="387e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果应用程序无法加载列表，例如，发生了TimeOutException，或者服务器此时无法访问，列表返回为空。没有给出错误，只是返回一个空列表。</p><p id="9455" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">测试此类代码的问题是，要在我们需要的任何时候恢复活跃的后端超时异常，这是不可能的。</p><p id="3006" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">只有模拟器可以在任何给定的时间向我们返回我们需要的事件。</p><p id="12d3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">一种你不能完全控制你的系统的情况，后端被称为非托管或托管测试环境。</strong></p><p id="296d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，我将举例说明如何使用仿真器处理这些代码:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="38c2" class="lz ma iq lv b gy mb mc l md me">RestClient <strong class="lv ir">restClient </strong>= mock(RestClient.<strong class="lv ir">class</strong>);</span><span id="842b" class="lz ma iq lv b gy mf mc l md me">when(<strong class="lv ir">restClient</strong>.get(anyString())).thenReturn(<strong class="lv ir">new </strong>IOException(<strong class="lv ir">"Could not connect"</strong>));</span></pre><p id="d009" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">模仿者的本质是他们必须模仿所有我们需要的东西，并且在你需要的时候。</p><p id="a873" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们提前为考试做好准备。</p><p id="6eee" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi mh translated"><span class="l mi mj mk bm ml mm mn mo mp di"> W </span> eb服务。</p><p id="c081" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">每个应用程序都需要一个测试环境。自动化工程师必须能够在测试和生产环境中运行应用程序。</p><p id="c837" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，带有key prod的launch应用程序将在实时生产系统上运行自动化脚本。并在测试环境中运行带有关键测试的应用程序。更多关于如何在本文<a class="ae kc" rel="noopener ugc nofollow" target="_blank" href="/how-to-run-automation-scripts-in-multiple-environments-abc39d11aa20">中分析的框架中实现这一功能的信息。</a></p><p id="f389" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了实现web服务的模拟，有几个库用于:</p><ol class=""><li id="6451" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">码头</li><li id="0abd" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">游戏框架</li><li id="6b09" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">弹簧靴。</li></ol><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="3ed8" class="lz ma iq lv b gy mb mc l md me"><strong class="lv ir">public class </strong>UseMock {</span><span id="dc39" class="lz ma iq lv b gy mf mc l md me">@BeforeClass<br/>    <strong class="lv ir">public static void </strong>startServer() {</span><span id="72a2" class="lz ma iq lv b gy mf mc l md me">Server server = <strong class="lv ir">new </strong>Server(8080);</span><span id="3965" class="lz ma iq lv b gy mf mc l md me">WebAppContext shop = <strong class="lv ir">new </strong>WebAppContext(<strong class="lv ir">"webapp"</strong>, <strong class="lv ir">"/shop"</strong>);<br/>        server.setHandlers(shop);</span><span id="3612" class="lz ma iq lv b gy mf mc l md me">server.start();<br/>        server.join();<br/>    }</span><span id="3cab" class="lz ma iq lv b gy mf mc l md me">@Test<br/>    <strong class="lv ir">public void </strong>loginTest() {<br/>        open(<strong class="lv ir">"http://localhost:8080/shop"</strong>);<br/>    }</span><span id="9951" class="lz ma iq lv b gy mf mc l md me">}</span></pre><p id="5499" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi mh translated">TTP服务。</p><p id="d594" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一些库允许你为HTTP服务创建一个模拟器。<br/> <br/>其中最流行的是WireMock<a class="ae kc" href="http://wiremock.org/docs/getting-started/" rel="noopener ugc nofollow" target="_blank">http://wiremock.org/docs/getting-started/</a></p><p id="873f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">实现代码如下所示:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="3d50" class="lz ma iq lv b gy mb mc l md me"><em class="mg">/**<br/> * Method Start mock service.<br/> */<br/></em><strong class="lv ir">public void </strong>startMockService() {<br/>    configureFor(<strong class="lv ir">"localhost"</strong>, HTTP_PORT);<br/>    stubFor(get(urlPathMatching(<strong class="lv ir">"/login"</strong>))<br/>            .willReturn(aResponse()<br/>                    .withStatus(200)<br/>                    .withHeader(<strong class="lv ir">"Content-Type"</strong>, <strong class="lv ir">"application/json"</strong>)<br/>                    .withBody(<strong class="lv ir">"Success login."</strong>)));</span><span id="5f08" class="lz ma iq lv b gy mf mc l md me">}</span><span id="f839" class="lz ma iq lv b gy mf mc l md me"><strong class="lv ir">private static final </strong>String <strong class="lv ir"><em class="mg">LOGIN </em></strong>= <strong class="lv ir">"/login"</strong>;</span><span id="9d77" class="lz ma iq lv b gy mf mc l md me">@Test<br/><strong class="lv ir">public void </strong>testRequestInMinions() {<br/>    <strong class="lv ir">final </strong>String resultApiJson = getResponseFromMock(<strong class="lv ir"><em class="mg">LOGIN</em></strong>);<br/>    <em class="mg">assertEquals</em>(resultApiJson, <strong class="lv ir">"Success login."</strong>);<br/>}</span><span id="f0d3" class="lz ma iq lv b gy mf mc l md me"><em class="mg">/**<br/> * Get login data from mock.<br/> *<br/> * </em><strong class="lv ir"><em class="mg">@param url </em></strong><em class="mg">the url.<br/> * </em><strong class="lv ir"><em class="mg">@return </em></strong><em class="mg">the login from mock.<br/> */<br/></em><strong class="lv ir">public static </strong>String getResponseFromMock(<strong class="lv ir">final </strong>String url) {<br/>    <strong class="lv ir">final </strong>String json =<br/>            given()<br/>                    .then()<br/>                    .statusCode(200)<br/>                    .log()<br/>                    .all()<br/>                    .when()<br/>                    .get(url)<br/>                    .getBody()<br/>                    .asString();<br/>    <strong class="lv ir">return </strong>json;<br/>}</span></pre><p id="8449" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi mh translated">电子邮件。</p><p id="cee0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">绿色邮件【http://www.icegreen.com/greenmail/】T2<br/>T5】苏贝塔SMTP<a class="ae kc" href="https://github.com/voodoodyne/subethasmtp" rel="noopener ugc nofollow" target="_blank">https://github.com/voodoodyne/subethasmtp</a></p><p id="bf59" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些库允许您在本地环境SMTP服务器上运行并管理它。</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="7c51" class="lz ma iq lv b gy mb mc l md me">#Mail configuration<br/> mail.smtp = mock<br/> mail.smtp.host=localhost<br/> mail.smtp.port = 9010<br/> mail.smtp.user = admin<br/> mail.smtp.password = admin</span></pre><p id="03d1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">实现代码如下所示:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="b1c5" class="lz ma iq lv b gy mb mc l md me"><strong class="lv ir">private </strong>MailServerEmulator <strong class="lv ir">mailServer </strong>= <strong class="lv ir">new </strong>MailServerEmulator();</span><span id="2281" class="lz ma iq lv b gy mf mc l md me">@Test<br/><strong class="lv ir">public void </strong>loginWithEmail() {</span><span id="14cc" class="lz ma iq lv b gy mf mc l md me">open();</span><span id="9215" class="lz ma iq lv b gy mf mc l md me"><em class="mg">// Find filed OTP code</em></span><span id="9e33" class="lz ma iq lv b gy mf mc l md me">String email = <strong class="lv ir">mailServer</strong>.getMessage().get(0);<br/>    String otpCode = email.replaceFirst(<strong class="lv ir">"Code: (.*)"</strong>, <strong class="lv ir">"$1"</strong>);<br/>}</span></pre><p id="bea4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从上面的示例代码可以看出，这是SMTP服务器的完整实现:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="8aa0" class="lz ma iq lv b gy mb mc l md me"><strong class="lv ir">public class </strong>MailServerEmulator {<br/>    <strong class="lv ir">private </strong>SMTPServer <strong class="lv ir">smtpServer</strong>;<br/>    <strong class="lv ir">private final </strong>List&lt;String&gt; <strong class="lv ir">messages </strong>= <strong class="lv ir">new </strong>ArrayList&lt;&gt;();</span><span id="c473" class="lz ma iq lv b gy mf mc l md me"><strong class="lv ir">public void </strong>startMailServer() {</span><span id="90cb" class="lz ma iq lv b gy mf mc l md me"><strong class="lv ir">int </strong>port = 9010;</span><span id="707d" class="lz ma iq lv b gy mf mc l md me"><strong class="lv ir">smtpServer </strong>= <strong class="lv ir">new </strong>SMTPServer(<strong class="lv ir">new </strong>SimpleMessageListenerAdapter(<strong class="lv ir">new </strong>SimpleMessageListener() {</span><span id="e2eb" class="lz ma iq lv b gy mf mc l md me">@Override<br/>            <strong class="lv ir">public boolean </strong>accept(String from, String recipient) {<br/>                <strong class="lv ir">return true</strong>;<br/>            }</span><span id="33af" class="lz ma iq lv b gy mf mc l md me">@Override<br/>            <strong class="lv ir">public void </strong>deliver(String from, String recipient, InputStream data) <strong class="lv ir">throws </strong>IOException {</span><span id="a3a3" class="lz ma iq lv b gy mf mc l md me"><strong class="lv ir">try </strong>{<br/>                    MimeMessage mimeMessage = <strong class="lv ir">new </strong>MimeMessage(Session.getDefaultInstance(<strong class="lv ir">new </strong>Properties()), data);<br/>                    <strong class="lv ir">messages</strong>.add((String) mimeMessage.getContent());<br/>                } <strong class="lv ir">catch </strong>(MessagingException ex) {<br/>                    <strong class="lv ir">throw new </strong>RuntimeException(<strong class="lv ir">"Filed to read message from"</strong>, +from + <strong class="lv ir">" to " </strong>+ recipient, ex);<br/>                }</span><span id="4f65" class="lz ma iq lv b gy mf mc l md me">}</span><span id="0867" class="lz ma iq lv b gy mf mc l md me">}));</span><span id="79ed" class="lz ma iq lv b gy mf mc l md me"><strong class="lv ir">smtpServer</strong>.setPort(port);<br/>        <strong class="lv ir">smtpServer</strong>.start();<br/>    }</span><span id="b34e" class="lz ma iq lv b gy mf mc l md me"><strong class="lv ir">public void </strong>shutDownMailServer() {<br/>        <strong class="lv ir">if </strong>(<strong class="lv ir">smtpServer </strong>!= <strong class="lv ir">null</strong>) {<br/>            <strong class="lv ir">smtpServer</strong>.stop();<br/>        }<br/>    }<br/>}</span></pre><p id="aac1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi mh translated">数据库。</p><p id="445a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所有自动化脚本必须在由您控制的数据库中运行。理想情况下，这个数据库应该在内存中。当您在测试或生产数据库中运行自动化脚本时，您可能会得到不正确的结果。数据数据库中充满了各种你所知甚少的数据。该数据库必须填充某一数据集，这是必要的，只有你。你对数据有完全的控制权。</p><p id="5a12" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了在内存中处理数据库，https://www.h2database.com/html/main.html有一个很棒的库H2 <a class="ae kc" href="https://www.h2database.com/html/main.html" rel="noopener ugc nofollow" target="_blank"/></p><p id="30c8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">实现代码如下所示:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="f6c8" class="lz ma iq lv b gy mb mc l md me"><em class="mg">/**<br/> * The constant BASE_DRIVER.<br/> */<br/></em><strong class="lv ir">private static final </strong>String <strong class="lv ir"><em class="mg">BASE_DRIVER </em></strong>= <strong class="lv ir">"org.h2.Driver"</strong>;</span><span id="94dd" class="lz ma iq lv b gy mf mc l md me"><em class="mg">/**<br/> * The constant BASE_CONN.<br/> */<br/></em><strong class="lv ir">private static final </strong>String <strong class="lv ir"><em class="mg">BASE_CONN </em></strong>= <strong class="lv ir">"jdbc:h2:tcp://localhost/~/test"</strong>;</span><span id="bb3f" class="lz ma iq lv b gy mf mc l md me"><em class="mg">/**<br/> * The constant BASE_USER.<br/> */<br/></em><strong class="lv ir">private static final </strong>String <strong class="lv ir"><em class="mg">BASE_USER </em></strong>= <strong class="lv ir">"sa"</strong>;</span><span id="90ca" class="lz ma iq lv b gy mf mc l md me"><em class="mg">/**<br/> * The constant BASE_PASS.<br/> */<br/></em><strong class="lv ir">private static final </strong>String <strong class="lv ir"><em class="mg">BASE_PASS </em></strong>= <strong class="lv ir">"your password"</strong>;</span><span id="7149" class="lz ma iq lv b gy mf mc l md me"><em class="mg">/**<br/> * Get db connection.<br/> *<br/> * </em><strong class="lv ir"><em class="mg">@return </em></strong><em class="mg">the db connection<br/> */<br/></em><strong class="lv ir">private static </strong>Connection getDBConnection() {</span><span id="66a8" class="lz ma iq lv b gy mf mc l md me">Connection h2DBConnection = <strong class="lv ir">null</strong>;</span><span id="020b" class="lz ma iq lv b gy mf mc l md me"><strong class="lv ir">try </strong>{<br/>        Class.<em class="mg">forName</em>(<strong class="lv ir"><em class="mg">BASE_DRIVER</em></strong>);<br/>    } <strong class="lv ir">catch </strong>(ClassNotFoundException ex) {<br/>        <strong class="lv ir"><em class="mg">LOG</em></strong>.info(ex.toString());<br/>    }<br/>    <strong class="lv ir">try </strong>{<br/>        h2DBConnection = DriverManager.<em class="mg">getConnection</em>(<strong class="lv ir"><em class="mg">BASE_CONN</em></strong>, <strong class="lv ir"><em class="mg">BASE_USER</em></strong>, <strong class="lv ir"><em class="mg">BASE_PASS</em></strong>);</span><span id="f433" class="lz ma iq lv b gy mf mc l md me"><strong class="lv ir">return </strong>h2DBConnection;<br/>    } <strong class="lv ir">catch </strong>(SQLException ex) {<br/>        <strong class="lv ir"><em class="mg">LOG</em></strong>.info(ex.toString());<br/>    }</span><span id="563f" class="lz ma iq lv b gy mf mc l md me"><strong class="lv ir">return </strong>h2DBConnection;<br/>}</span></pre><p id="ee57" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建该表的代码如下:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="306d" class="lz ma iq lv b gy mb mc l md me"><em class="mg">/**<br/> * Create table.<br/> *<br/> * </em><strong class="lv ir"><em class="mg">@throws </em></strong><em class="mg">SQLException for method.<br/> */<br/></em><strong class="lv ir">public static void </strong>createTable() <strong class="lv ir">throws </strong>SQLException {</span><span id="dc1d" class="lz ma iq lv b gy mf mc l md me"><strong class="lv ir">final </strong>String absPath = <strong class="lv ir">new </strong>File(<strong class="lv ir">"src/main/resources/createData.sql"</strong>).getAbsolutePath();</span><span id="3cb9" class="lz ma iq lv b gy mf mc l md me"><strong class="lv ir">final </strong>Connection connection = <em class="mg">getDBConnection</em>();</span><span id="aa43" class="lz ma iq lv b gy mf mc l md me"><strong class="lv ir">try </strong>{<br/>        connection.setAutoCommit(<strong class="lv ir">false</strong>);</span><span id="1f0e" class="lz ma iq lv b gy mf mc l md me">RunScript.<em class="mg">execute</em>(connection, <strong class="lv ir">new </strong>FileReader(absPath));</span><span id="ab1a" class="lz ma iq lv b gy mf mc l md me">connection.commit();</span><span id="7e47" class="lz ma iq lv b gy mf mc l md me">} <strong class="lv ir">catch </strong>(SQLException | IOException ex) {<br/>        <strong class="lv ir"><em class="mg">LOG</em></strong>.info(ex.toString());<br/>    } <strong class="lv ir">finally </strong>{<br/>        connection.close();<br/>    }</span><span id="8cb3" class="lz ma iq lv b gy mf mc l md me"><strong class="lv ir"><em class="mg">LOG</em></strong>.info(<strong class="lv ir">"Successfully Created table."</strong>);<br/>}</span></pre><p id="cb86" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">和createTable.sql</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="20bc" class="lz ma iq lv b gy mb mc l md me"><strong class="lv ir">drop table </strong>IF <strong class="lv ir">EXISTS </strong>`WORKERS`;<br/><strong class="lv ir">create TABLE </strong>WORKERS(employeeid <strong class="lv ir"><em class="mg">int </em></strong>auto_increment <strong class="lv ir">primary key</strong>,<br/>              firstname <strong class="lv ir"><em class="mg">varchar</em></strong>(100), <br/>              lastname <strong class="lv ir"><em class="mg">varchar</em></strong>(100), <br/>              department <strong class="lv ir"><em class="mg">varchar</em></strong>(100),<br/>              location <strong class="lv ir"><em class="mg">varchar</em></strong>(10));</span></pre><p id="9ba5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">成功完成测试需要一个非常重要的因素，即在每次测试前重置状态。</p><p id="cf19" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">实现可能如下所示:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="851d" class="lz ma iq lv b gy mb mc l md me">@Before<br/><strong class="lv ir">public void </strong>resetDatabase(){<br/>    <strong class="lv ir">if </strong>(firstRun)<br/>        api.executeSql(<strong class="lv ir">"script drop to 'src/main/resources/createData.sql'"</strong>);</span><span id="b22f" class="lz ma iq lv b gy mf mc l md me"><strong class="lv ir">else<br/>        </strong>api.executeSql(<strong class="lv ir">"runscript from 'src/main/resources/createData.sql'"</strong>);<br/>}</span></pre><p id="a0ca" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">启动测试容器中的数据库有一个库test containers<a class="ae kc" href="https://github.com/testcontainers/testcontainers-java" rel="noopener ugc nofollow" target="_blank">https://github.com/testcontainers/testcontainers-java</a></p><p id="af0e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Test containers是一个支持JUnit测试的Java库，提供了通用数据库、Selenium web浏览器或其他任何可以在Docker容器中运行的轻量级、一次性实例。<a class="ae kc" href="https://testcontainers.org" rel="noopener ugc nofollow" target="_blank">https://testcontainers.org</a></p><p id="36fe" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个容器你可以添加任何类型的基地，你需要的。</p><p id="2a25" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如Oracle:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="fb50" class="lz ma iq lv b gy mb mc l md me">&lt;dependency&gt;<br/>    &lt;groupId&gt;org.testcontainers&lt;/groupId&gt;<br/>    &lt;artifactId&gt;oracle-xe&lt;/artifactId&gt;<br/>    &lt;version&gt;1.12.1&lt;/version&gt;<br/>&lt;/dependency&gt;</span></pre><p id="94f4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">实现代码如下所示:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="f5fa" class="lz ma iq lv b gy mb mc l md me">@Testcontainers<br/><strong class="lv ir">class </strong>MyTestcontainersTests {</span><span id="1a69" class="lz ma iq lv b gy mf mc l md me">@Container<br/>    <strong class="lv ir">public </strong>OracleContainer <strong class="lv ir">oracleContainer </strong>= <strong class="lv ir">new </strong>OracleContainer()<br/>            .withDatabaseName(<strong class="lv ir">"foo"</strong>)<br/>            .withUsername(<strong class="lv ir">"foo"</strong>)<br/>            .withPassword(<strong class="lv ir">"secret"</strong>);</span><span id="0ca4" class="lz ma iq lv b gy mf mc l md me">@Test<br/>    <strong class="lv ir">public void </strong>someTestMethod() {<br/>        String url = <strong class="lv ir">oracleContainer</strong>.getJdbcUrl();<br/>    }<br/>}</span></pre><p id="2e86" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我希望读完这篇文章后，我的关于模拟器的规则将成为你的规则。我想再次提醒你:</p><ul class=""><li id="23cd" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lp lh li lj bi translated">总是模拟外部服务。</li><li id="20e4" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lp lh li lj bi translated">仿真那么慢。</li><li id="747f" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lp lh li lj bi translated">仿真一切不受控制的事物。</li></ul></div></div>    
</body>
</html>