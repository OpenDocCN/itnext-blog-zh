<html>
<head>
<title>Adding Master Nodes to Achieve HA: One of the Best Practices for Using KubeKey</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">添加主节点实现HA:使用KubeKey的最佳实践之一</h1>
<blockquote>原文：<a href="https://itnext.io/adding-master-nodes-to-achieve-ha-one-of-the-best-practices-for-using-kubekey-6207e94b0bdd?source=collection_archive---------2-----------------------#2021-01-29">https://itnext.io/adding-master-nodes-to-achieve-ha-one-of-the-best-practices-for-using-kubekey-6207e94b0bdd?source=collection_archive---------2-----------------------#2021-01-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="1a4f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如在我的上一篇文章中所展示的，您可以使用KubeKey轻松地伸缩您的集群。因为在示例中我只有一个主节点，所以集群不具备高可用性。在本文中，我将继续演示如何向外扩展您的集群，同时通过添加主节点来实现高可用性。</p><p id="f651" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这些步骤如下所示:</p><ol class=""><li id="7dbe" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">下载KubeKey。</li><li id="4299" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">使用KubeKey通过自动创建的配置文件来检索集群信息。</li><li id="901e" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">在文件中添加节点和负载平衡器信息，并应用配置。</li></ol><h1 id="7c4c" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">准备主机</h1><p id="5b89" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">这是我的现有Kubernetes集群的节点信息。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi md"><img src="../Images/c057a2a4f3b29c6589f444acc657b339.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IJEd9mOjqw2fuYwVivczMg.png"/></div></div></figure><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="a8d7" class="mu lb iq mq b gy mv mw l mx my">$ kubectl get nodes<br/>NAME      STATUS   ROLES    AGE     VERSION<br/>master1   Ready    master   2m15s   v1.17.9<br/>worker1   Ready    worker   86s     v1.17.9<br/>worker2   Ready    worker   86s     v1.17.9</span></pre><p id="9af3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是将添加到群集以实现高可用性的节点。请注意，您的etcd节点总数必须是奇数。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mz"><img src="../Images/277eeeed87f151e8700eec994166f2cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jjqxBhaoctEmQ6UVWObRSA.png"/></div></div></figure><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi na"><img src="../Images/85302b2c3deecc722e779dbf63c18575.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SiDhnlQYwBqkdPSZ.jpg"/></div></div></figure><p id="c68d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于节点、网络和依赖项需求的更多信息，请参见本文。</p><h1 id="46c8" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">准备负载平衡器</h1><p id="7672" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">您可以使用任何云负载平衡器或硬件负载平衡器(例如F5)。此外，Keepalived和<a class="ae kl" href="https://www.haproxy.com/" rel="noopener ugc nofollow" target="_blank"> HAproxy </a>或Nginx也是创建高可用性集群的一个备选方案。在这个例子中，我有一个内部负载平衡器和一个外部负载平衡器，前者带有一个监听端口<code class="fe nb nc nd mq b">6443</code> ( <code class="fe nb nc nd mq b">api-server</code>)的监听器，后者带有一个监听Kubernetes仪表板端口的监听器。</p><h1 id="509e" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">下载KubeKey</h1><ol class=""><li id="d71b" class="km kn iq jp b jq ly ju lz jy ne kc nf kg ng kk kr ks kt ku bi translated">从其<a class="ae kl" href="https://github.com/kubesphere/kubekey/releases" rel="noopener ugc nofollow" target="_blank"> GitHub发布页面</a>下载KubeKey，或者使用以下命令下载KubeKey版本1.0.1。你只需要将KubeKey下载到你的一台机器上，作为<strong class="jp ir">任务盒</strong>进行缩放。</li></ol><p id="7a48" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe nb nc nd mq b">curl -sfL https://get-kk.kubesphere.io | VERSION=v1.0.1 sh -</code></p><p id="c49e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.上面的命令下载KubeKey并解压文件。您的文件夹现在包含一个名为<code class="fe nb nc nd mq b">kk</code>的文件。使其可执行:</p><p id="8f30" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe nb nc nd mq b">chmod +x kk</code></p><h1 id="eb63" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">添加主节点</h1><ol class=""><li id="d91e" class="km kn iq jp b jq ly ju lz jy ne kc nf kg ng kk kr ks kt ku bi translated">使用KubeKey创建一个配置文件。如果您的集群是通过KubeKey安装的，那么您的机器上可能仍然有那个配置文件。这种情况下可以直接编辑。否则，执行以下命令来检索集群信息。</li></ol><p id="3933" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe nb nc nd mq b">./kk create config --from-cluster</code></p><p id="72c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.上面的命令创建了一个配置文件，默认为<code class="fe nb nc nd mq b">sample.yaml</code>。打开文件，您可以看到一些字段已经预先填充了值。将新节点和负载平衡器的信息添加到文件中。</p><p id="fadf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe nb nc nd mq b">vi sample.yaml</code></p><p id="47e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我的配置，供你参考:</p><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="e372" class="mu lb iq mq b gy mv mw l mx my">apiVersion: kubekey.kubesphere.io/v1alpha1<br/>kind: Cluster<br/>metadata:<br/>  name: sample<br/>spec:<br/>  hosts:<br/>  # You should complete the ssh information of the hosts<br/>  - {name: master1, address: 172.16.0.2, internalAddress: 172.16.0.2, user: root, password: Testing123}<br/>  - {name: master2, address: 172.16.0.5, internalAddress: 172.16.0.5, user: root, password: Testing123}<br/>  - {name: master3, address: 172.16.0.6, internalAddress: 172.16.0.6, user: root, password: Testing123}<br/>  - {name: worker1, address: 172.16.0.3, internalAddress: 172.16.0.3, user: root, password: Testing123}<br/>  - {name: worker2, address: 172.16.0.4, internalAddress: 172.16.0.4, user: root, password: Testing123}<br/>  - {name: worker3, address: 172.16.0.7, internalAddress: 172.16.0.7, user: root, password: Testing123}<br/>  roleGroups:<br/>    etcd:<br/>    - master1<br/>    - master2<br/>    - master3<br/>    master:<br/>    - master1<br/>    - master2<br/>    - master3<br/>    worker:<br/>    - worker1<br/>    - worker2<br/>    - worker3<br/>  controlPlaneEndpoint:<br/>    # If loadbalancer is used, 'address' should be set to loadbalancer's ip.<br/>    domain: lb.kubesphere.local<br/>    address: 172.16.0.253<br/>    port: 6443<br/>  kubernetes:<br/>    version: v1.17.9<br/>    imageRepo: kubesphere<br/>    clusterName: cluster.local<br/>    proxyMode: ipvs<br/>    masqueradeAll: false<br/>    maxPods: 110<br/>    nodeCidrMaskSize: 24<br/>  network:<br/>    plugin: calico<br/>    kubePodsCIDR: 10.233.64.0/18<br/>    kubeServiceCIDR: 10.233.0.0/18<br/>  registry:<br/>    privateRegistry: ""</span></pre><p id="791c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nh">注</em></p><ul class=""><li id="c9c4" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk ni ks kt ku bi translated"><em class="nh">增加新节点时，不允许修改已有节点的主机名(如</em> <code class="fe nb nc nd mq b"><em class="nh">master1</em></code> <em class="nh">)。</em></li><li id="658a" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk ni ks kt ku bi translated"><em class="nh">关于配置文件中不同参数的更多信息，参见</em> <a class="ae kl" href="https://kubesphere.io/blogs/install-kubernetes-using-kubekey/#install-kubernetes" rel="noopener ugc nofollow" target="_blank"> <em class="nh">本文</em> </a> <em class="nh">。</em></li></ul><p id="ab12" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.注意上面例子中的<code class="fe nb nc nd mq b">controlPlaneEndpoint</code>字段。</p><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="cd55" class="mu lb iq mq b gy mv mw l mx my">controlPlaneEndpoint:<br/>    # If loadbalancer is used, 'address' should be set to loadbalancer's ip.<br/>    domain: lb.kubesphere.local<br/>    address: 172.16.0.253<br/>    port: 6443</span></pre><ul class=""><li id="cb49" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk ni ks kt ku bi translated">负载均衡器的域名默认为<code class="fe nb nc nd mq b">lb.kubesphere.local</code>，供内部访问。你可以根据你的需要来改变它。</li><li id="3d01" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk ni ks kt ku bi translated">在大多数情况下，您需要为字段<code class="fe nb nc nd mq b">address</code>提供负载平衡器的<strong class="jp ir">私有IP地址</strong>。然而，不同的云提供商可能有不同的负载平衡器配置。例如，如果你在阿里云上配置了一个服务器负载均衡器(SLB)，平台会给SLB分配一个公共IP地址，这意味着你需要为字段<code class="fe nb nc nd mq b">address</code>指定公共IP地址。</li><li id="05c2" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk ni ks kt ku bi translated">字段<code class="fe nb nc nd mq b">port</code>表示<code class="fe nb nc nd mq b">api-server</code>的端口。</li></ul><p id="8631" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.保存文件并执行以下命令来应用配置:</p><p id="3ef7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe nb nc nd mq b">./kk add nodes -f sample.yaml</code></p><p id="76c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.缩放完成后，您可以看到如下输出。</p><p id="ca7a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe nb nc nd mq b">Congratulations! Scaling cluster is successful.</code></p><p id="8040" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">6.执行以下命令来检查名称空间的状态。</p><p id="181b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe nb nc nd mq b">kubectl get pod --all-namespaces</code></p><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="902d" class="mu lb iq mq b gy mv mw l mx my">NAMESPACE     NAME                 READY   STATUS    RESTARTS   AGE<br/>kube-system   calico-kube<br/>             -controllers<br/>             -59d85c5c84-tnk8s   1/1     Running   0          36m<br/>kube-system   calico-node<br/>             -87gtw              1/1     Running   0          75s<br/>kube-system   calico-node<br/>             -8dj8n              1/1     Running   0          76s<br/>kube-system   calico-node<br/>             -k2bjr              1/1     Running   0          35m<br/>kube-system   calico-node<br/>             -lpl78              1/1     Running   0          36m<br/>kube-system   calico-node<br/>             -scfld              1/1     Running   0          75s<br/>kube-system   calico-node<br/>             -t27vn              1/1     Running   0          35m<br/>kube-system   coredns<br/>             -74d59cc5c6-87qkr   1/1     Running   0          36m<br/>kube-system   coredns<br/>             -74d59cc5c6-qm7kb   1/1     Running   0          36m<br/>kube-system   kube-apiserver<br/>             -master1            1/1     Running   0          36m<br/>kube-system   kube-apiserver<br/>             -master2            1/1     Running   0          73s<br/>kube-system   kube-apiserver<br/>             -master3            1/1     Running   0          74s<br/>kube-system   kube-controller<br/>             -manager-master1    1/1     Running   0          36m<br/>kube-system   kube-controller<br/>             -manager-master2    1/1     Running   0          74s<br/>kube-system   kube-controller<br/>             -manager-master3    1/1     Running   0          74s<br/>kube-system   kube-proxy-48h9q   1/1     Running   0          35m<br/>kube-system   kube-proxy-72cv7   1/1     Running   0          76s<br/>kube-system   kube-proxy-gjzk2   1/1     Running   0          36m<br/>kube-system   kube-proxy-nkkv8   1/1     Running   0          75s<br/>kube-system   kube-proxy-swh67   1/1     Running   0          35m<br/>kube-system   kube-proxy-xn7g9   1/1     Running   0          75s<br/>kube-system   kube-scheduler<br/>             -master1            1/1     Running   0          36m<br/>kube-system   kube-scheduler<br/>             -master2            1/1     Running   0          73s<br/>kube-system   kube-scheduler<br/>             -master3            1/1     Running   0          74s<br/>kube-system   nodelocaldns<br/>             -47bgw              1/1     Running   0          35m<br/>kube-system   nodelocaldns<br/>             -4bp5b              1/1     Running   0          75s<br/>kube-system   nodelocaldns<br/>             -5f9g8              1/1     Running   0          36m<br/>kube-system   nodelocaldns<br/>             -h4xzk              1/1     Running   0          35m<br/>kube-system   nodelocaldns<br/>             -jz86j              1/1     Running   0          75s<br/>kube-system   nodelocaldns<br/>             -xcjt6              1/1     Running   0          76s</span></pre><p id="3418" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">7.执行以下命令检查您的节点。</p><p id="f5cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe nb nc nd mq b">kubectl get nodes</code></p><pre class="me mf mg mh gt mp mq mr ms aw mt bi"><span id="bd6f" class="mu lb iq mq b gy mv mw l mx my">NAME      STATUS   ROLES    AGE     VERSION<br/>master1   Ready    master   37m     v1.17.9<br/>master2   Ready    master   2m17s   v1.17.9<br/>master3   Ready    master   2m17s   v1.17.9<br/>worker1   Ready    worker   36m     v1.17.9<br/>worker2   Ready    worker   36m     v1.17.9<br/>worker3   Ready    worker   2m18s   v1.17.9</span></pre><p id="d8ba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如您在上面看到的，所有节点都已启动并运行。</p><h1 id="70ca" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">摘要</h1><p id="13d4" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">添加更多主节点以使您的集群高度可用的步骤与我在<a class="ae kl" href="https://kubesphere.io/blogs/scale-kubernetes-cluster-using-kubekey/" rel="noopener ugc nofollow" target="_blank">上一篇文章</a>中演示的步骤基本相同。主要区别在于您必须正确配置负载平衡器。</p><h1 id="6460" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">参考</h1><p id="39e3" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/kubesphere/kubekey" rel="noopener ugc nofollow" target="_blank"> KubeKey </a></p><p id="d5e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://kubesphere.io/docs/installing-on-linux/introduction/multioverview/" rel="noopener ugc nofollow" target="_blank">多节点安装</a></p><p id="5ce7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://kubesphere.io/blogs/install-kubernetes-using-kubekey/" rel="noopener ugc nofollow" target="_blank">kube key:Kubernetes和云原生插件的轻量级安装程序</a></p><p id="5877" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://kubesphere.io/blogs/scale-kubernetes-cluster-using-kubekey/" rel="noopener ugc nofollow" target="_blank">扩展Kubernetes集群:使用KubeKey的最佳实践之一</a></p></div></div>    
</body>
</html>