<html>
<head>
<title>Securely Decoupling Kubernetes-based Applications on Amazon EKS using Kafka with SASL/SCRAM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用带有SASL/SCRAM的Kafka安全地解耦亚马逊EKS上基于Kubernetes的应用</h1>
<blockquote>原文：<a href="https://itnext.io/securely-decoupling-applications-on-amazon-eks-using-kafka-with-sasl-scram-48c340e1ffe9?source=collection_archive---------5-----------------------#2021-07-26">https://itnext.io/securely-decoupling-applications-on-amazon-eks-using-kafka-with-sasl-scram-48c340e1ffe9?source=collection_archive---------5-----------------------#2021-07-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="cbb2" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用具有IRSA、SASL/SCRAM和数据加密的亚马逊MSK，安全地分离亚马逊EKS上基于Go的微服务</h2></div><p id="41a3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">随着组织的扩展和成熟，他们经常努力从单一的应用程序架构转向基于微服务的分布式范例。作为这种转变的一部分，组织经常采用现代编程语言和框架，采用容器化，获得对开源软件组件的偏好，并选择异步事件驱动的通信模型。无论最终的体系结构如何，组织都必须持续保持高水平的应用程序和基础架构安全性。</p><h1 id="b57b" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">介绍</h1><p id="4697" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">本文将探索一个简单的基于Go的应用程序，该应用程序使用亚马逊弹性Kubernetes服务(<a class="ae mb" href="https://aws.amazon.com/eks/" rel="noopener ugc nofollow" target="_blank">亚马逊EKS </a>)部署到Kubernetes。组成应用程序的微服务通过从Amazon Managed Streaming for Apache Kafka(<a class="ae mb" href="https://aws.amazon.com/msk/" rel="noopener ugc nofollow" target="_blank">亚马逊MSK </a>)产生和消费事件来异步通信。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mc"><img src="../Images/27520089786ad80972edfe8b325e67ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9KLiHqiAR1T2QHui5Sa7KQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">post的高级应用程序和AWS基础架构</figcaption></figure><h2 id="c3c6" class="ms lf it bd lg mt mu dn lk mv mw dp lo kr mx my lq kv mz na ls kz nb nc lu nd bi translated">Apache Kafka的认证和授权</h2><p id="9e8e" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">根据<a class="ae mb" href="https://docs.aws.amazon.com/msk/latest/developerguide/kafka_apis_iam.html" rel="noopener ugc nofollow" target="_blank"> AWS </a>的说法，你可以使用IAM来认证客户端，并允许或拒绝Apache Kafka的操作。或者，您可以使用TLS或SASL/SCRAM来验证客户端，并使用Apache Kafka ACLs来允许或拒绝操作。</p><p id="bdb7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于这篇文章，我们的亚马逊MSK集群将使用<a class="ae mb" href="https://datatracker.ietf.org/doc/html/rfc5802" rel="noopener ugc nofollow" target="_blank"> SASL/SCRAM </a>(简单认证和安全层/Salted Challenge Response机制)用户名和基于密码的认证来增加安全性。用于SASL/SCRAM认证的凭证将安全地存储在<a class="ae mb" href="https://aws.amazon.com/secrets-manager/" rel="noopener ugc nofollow" target="_blank"> AWS秘密管理器</a>中，并使用AWS密钥管理服务(<a class="ae mb" href="https://aws.amazon.com/kms/" rel="noopener ugc nofollow" target="_blank"> KMS </a>)进行加密。</p><h2 id="3dff" class="ms lf it bd lg mt mu dn lk mv mw dp lo kr mx my lq kv mz na ls kz nb nc lu nd bi translated">数据加密</h2><p id="9d0a" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">MSK集群中的静态数据将使用亚马逊MSK与AWS KMS的集成进行加密，以提供透明的服务器端加密。将使用<a class="ae mb" href="https://en.wikipedia.org/wiki/Transport_Layer_Security" rel="noopener ugc nofollow" target="_blank">传输层安全性</a> (TLS 1.2)对在MSK集群的代理之间传输的数据进行加密。</p><h2 id="dbfc" class="ms lf it bd lg mt mu dn lk mv mw dp lo kr mx my lq kv mz na ls kz nb nc lu nd bi translated">资源管理</h2><p id="6177" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">亚马逊MSK的AWS资源将使用<a class="ae mb" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> HashiCorp Terraform </a>创建和管理，这是一个流行的开源基础设施即代码(IaC)软件工具。亚马逊EKS资源将使用<code class="fe ne nf ng nh b"><a class="ae mb" href="https://eksctl.io/" rel="noopener ugc nofollow" target="_blank">eksctl</a></code>创建和管理，这是由<a class="ae mb" href="https://www.weave.works/" rel="noopener ugc nofollow" target="_blank"> Weaveworks </a>赞助的亚马逊EKS官方CLI。最后，Kubernetes资源将由开源的Kubernetes包管理器Helm来创建和管理。</p><h2 id="7716" class="ms lf it bd lg mt mu dn lk mv mw dp lo kr mx my lq kv mz na ls kz nb nc lu nd bi translated">示范应用</h2><p id="9c03" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">组成演示应用程序的基于Go的微服务将使用Segment流行的<code class="fe ne nf ng nh b"><a class="ae mb" href="https://github.com/segmentio/kafka-go" rel="noopener ugc nofollow" target="_blank">kafka-go</a></code>客户端。<a class="ae mb" href="https://segment.com/?ref=nav" rel="noopener ugc nofollow" target="_blank">细分市场</a>是领先的客户数据平台(CDP)。微服务将使用存储在<a class="ae mb" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html" rel="noopener ugc nofollow" target="_blank"> AWS系统管理器(SSM)参数存储</a>中的Kafka broker连接信息访问亚马逊MSK。</p><h2 id="86c1" class="ms lf it bd lg mt mu dn lk mv mw dp lo kr mx my lq kv mz na ls kz nb nc lu nd bi translated">源代码</h2><p id="65d7" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">这篇文章的所有源代码，包括演示应用程序、Terraform和Helm资源，都是开源的，位于GitHub上。</p><div class="ni nj gp gr nk nl"><a href="https://github.com/garystafford/terraform-msk-demo" rel="noopener  ugc nofollow" target="_blank"><div class="nm ab fo"><div class="nn ab no cl cj np"><h2 class="bd iu gy z fp nq fr fs nr fu fw is bi translated">garystafter/terraform-MSK-demo</h2><div class="ns l"><h3 class="bd b gy z fp nq fr fs nr fu fw dk translated">Terraform项目使用亚马逊弹性库伯内特公司的阿帕奇卡夫卡(亚马逊MSK)的亚马逊管理流…</h3></div><div class="nt l"><p class="bd b dl z fp nq fr fs nr fu fw dk translated">github.com</p></div></div><div class="nu l"><div class="nv l nw nx ny nu nz mm nl"/></div></div></a></div><h2 id="9366" class="ms lf it bd lg mt mu dn lk mv mw dp lo kr mx my lq kv mz na ls kz nb nc lu nd bi translated">先决条件</h2><p id="1f86" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">为了跟随这篇文章的演示，你需要安装最新版本的<code class="fe ne nf ng nh b">terraform</code>、<code class="fe ne nf ng nh b">eksctl</code>和<code class="fe ne nf ng nh b">helm</code>，并且可以从你的终端访问。可选地，具有<code class="fe ne nf ng nh b">git</code>或<code class="fe ne nf ng nh b">gh</code>、<code class="fe ne nf ng nh b">kubectl</code>和AWS CLI v2 ( <code class="fe ne nf ng nh b">aws</code>)将是有帮助的。</p><h1 id="0c48" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">示范</h1><p id="4d52" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">为了演示上述EKS和MSK功能，我们将按如下方式进行:</p><ol class=""><li id="069c" class="oa ob it kk b kl km ko kp kr oc kv od kz oe ld of og oh oi bi translated">使用<code class="fe ne nf ng nh b">eksctl</code>部署EKS集群和相关资源；</li><li id="7e61" class="oa ob it kk b kl oj ko ok kr ol kv om kz on ld of og oh oi bi translated">使用Terraform部署MSK集群和相关资源；</li><li id="7673" class="oa ob it kk b kl oj ko ok kr ol kv om kz on ld of og oh oi bi translated">更新VPC和相关子网的路由表，以便在对等VPC之间路由流量；</li><li id="8639" class="oa ob it kk b kl oj ko ok kr ol kv om kz on ld of og oh oi bi translated">使用<code class="fe ne nf ng nh b">eksctl</code>为服务帐户(IRSA)创建IAM角色，允许从EKS访问MSK和相关服务；</li><li id="34f6" class="oa ob it kk b kl oj ko ok kr ol kv om kz on ld of og oh oi bi translated">使用Helm将Kafka客户端容器部署到EKS；</li><li id="d9b1" class="oa ob it kk b kl oj ko ok kr ol kv om kz on ld of og oh oi bi translated">使用Kafka客户端为MSK创建Kafka主题和ACLs</li><li id="edb0" class="oa ob it kk b kl oj ko ok kr ol kv om kz on ld of og oh oi bi translated">使用Helm将基于Go的应用程序部署到EKS；</li><li id="7487" class="oa ob it kk b kl oj ko ok kr ol kv om kz on ld of og oh oi bi translated">确认应用程序的功能；</li></ol><h2 id="06cc" class="ms lf it bd lg mt mu dn lk mv mw dp lo kr mx my lq kv mz na ls kz nb nc lu nd bi translated">1.亚马逊EKS集群</h2><p id="000b" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">首先，使用Weaveworks的<code class="fe ne nf ng nh b">eksctl</code>创建一个新的亚马逊EKS集群。项目中包含的默认<code class="fe ne nf ng nh b">cluster.yaml</code>配置文件将基于<code class="fe ne nf ng nh b">us-east-1</code>中的<a class="ae mb" href="https://kubernetes.io/blog/2020/12/08/kubernetes-1-20-release-announcement/" rel="noopener ugc nofollow" target="_blank"> Kubernetes 1.20 </a>创建一个小型的开发级EKS集群。集群将包含一个由三个<code class="fe ne nf ng nh b">t3.medium</code> Amazon Linux 2 EC2工作节点组成的<a class="ae mb" href="https://docs.aws.amazon.com/eks/latest/userguide/managed-node-groups.html" rel="noopener ugc nofollow" target="_blank">托管节点组</a>。EKS集群将创建在一个新的VPC。</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="oo op l"/></div></figure><p id="daec" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">设置以下环境变量，然后运行<code class="fe ne nf ng nh b">eksctl create cluster</code>命令来创建新的EKS集群和相关的基础设施。</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="b7e4" class="ms lf it nh b gy ou ov l ow ox">export AWS_ACCOUNT=$(aws sts get-caller-identity \<br/>    --output text --query 'Account')<br/>export EKS_REGION="us-east-1"<br/>export CLUSTER_NAME="eks-kafka-demo"</span><span id="abf2" class="ms lf it nh b gy oy ov l ow ox">eksctl create cluster -f ./eksctl/cluster.yaml</span></pre><p id="c133" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据我的经验，完全构建和配置新的3节点EKS集群可能需要25-40分钟。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi oz"><img src="../Images/39f1339b3227a1224b39d3ef0c3450d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pUed4buRK6fuAFqjn1I31g.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">使用eksctl开始创建亚马逊EKS集群</figcaption></figure><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi oz"><img src="../Images/62baa61e1a1d9f5642fc47b281feca6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QrxWWC8E1CIC6xbTs37sbA.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">使用eksctl成功完成亚马逊EKS集群创建</figcaption></figure><p id="498c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">作为创建EKS集群的一部分，<code class="fe ne nf ng nh b">eksctl</code>将自动部署三个<a class="ae mb" href="https://aws.amazon.com/cloudformation/" rel="noopener ugc nofollow" target="_blank"> AWS CloudFormation </a>堆栈，包含以下资源:</p><ol class=""><li id="d4a1" class="oa ob it kk b kl km ko kp kr oc kv od kz oe ld of og oh oi bi translated">亚马逊虚拟专用云(VPC)、子网、路由表、NAT网关、安全策略和EKS控制平面；</li><li id="5316" class="oa ob it kk b kl oj ko ok kr ol kv om kz on ld of og oh oi bi translated">包含Kubernetes三个工作节点的EKS管理节点组；</li><li id="b2c2" class="oa ob it kk b kl oj ko ok kr ol kv om kz on ld of og oh oi bi translated">将AWS IAM角色映射到Kubernetes服务帐户的IAM服务帐户角色(IRSA );</li></ol><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi pa"><img src="../Images/94fa926a37cfb0028b78f8076b3cfa51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cjU9n00QHhAXgsVPzqyPFA.png"/></div></div></figure><p id="e3c8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">完成后，更新您的<code class="fe ne nf ng nh b">kubeconfig</code>文件，以便您可以使用以下AWS CLI命令连接到新的亚马逊EKS集群:</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="3110" class="ms lf it nh b gy ou ov l ow ox">aws eks --region ${EKS_REGION} update-kubeconfig \<br/>    --name ${CLUSTER_NAME}</span></pre><p id="0155" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用以下<code class="fe ne nf ng nh b">eksctl</code>命令查看新EKS集群的详细信息:</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="36fc" class="ms lf it nh b gy ou ov l ow ox">eksctl utils describe-stacks \<br/>  --region ${EKS_REGION} --cluster ${CLUSTER_NAME}</span></pre><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi oz"><img src="../Images/0a97f94f2c90f61ad8eda212182d2d83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JiR5gOuTGHURJfUGDGdZqg.png"/></div></div></figure><p id="9a00" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在亚马逊容器服务控制台的亚马逊EKS集群<a class="ae mb" href="https://console.aws.amazon.com/eks/home?region=us-east-1#/clusters" rel="noopener ugc nofollow" target="_blank">选项卡</a>中查看新的EKS集群。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi pb"><img src="../Images/9d56f9bae583ddeb1ce8e62d1120fdf5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EHIkFZ0VpjfgB74mklvfyw.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">从亚马逊容器服务控制台看到的新亚马逊EKS集群</figcaption></figure><p id="5b00" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面，请注意EKS集群的OpenID连接URL。<a class="ae mb" href="https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/setting-up-enable-IAM.html" rel="noopener ugc nofollow" target="_blank">在EKS集群上支持服务帐户</a> (IRSA)的IAM角色需要一个与之关联的OpenID Connect issuer URL。OIDC是在<code class="fe ne nf ng nh b">cluster.yaml</code>文件中配置的；参见第8行(显示在上方的<em class="pc">)。</em></p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi pb"><img src="../Images/31e08ac1d56aa8cd25cab94a6cbbd71c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C9J2z16svpcBVftX7KKWtA.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">从亚马逊容器服务控制台看到的新亚马逊EKS集群</figcaption></figure><p id="5c2b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在EKS集群的控制台中引用的由<code class="fe ne nf ng nh b">eksctl</code>创建的<a class="ae mb" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html" rel="noopener ugc nofollow" target="_blank"> OpenID Connect身份提供者</a>，可以在<a class="ae mb" href="https://console.aws.amazon.com/iamv2/home?#/identity_providers" rel="noopener ugc nofollow" target="_blank"> IAM身份提供者控制台</a>中看到。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi pa"><img src="../Images/90f3c5a007da867c264c63016612feb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0ZguIc3WKO2g26XTgW88DQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">IAM身份提供者控制台中EKS集群的OpenID连接身份提供者</figcaption></figure><h2 id="3ee4" class="ms lf it bd lg mt mu dn lk mv mw dp lo kr mx my lq kv mz na ls kz nb nc lu nd bi translated">2.亚马逊MSK集群</h2><p id="98fd" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">接下来，使用HashiCorp Terraform部署亚马逊MSK集群以及相关的网络和安全资源。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi pd"><img src="../Images/686ee807d5a9189eb1fe1383d05d877a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*873MeKtHK6mtY1DYxq4r5w.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">Terraform的AWS资源的Graphviz开源图形可视化</figcaption></figure><p id="6299" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在使用Terraform创建AWS基础设施之前，更新<a class="ae mb" href="https://www.terraform.io/docs/language/state/index.html" rel="noopener ugc nofollow" target="_blank"> Terraform状态</a>的位置。这个项目的代码使用亚马逊S3作为后端存储平台的状态。将亚马逊S3存储桶的名称更改为您现有的存储桶，位于<code class="fe ne nf ng nh b">main.tf</code>文件中。</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="4ae3" class="ms lf it nh b gy ou ov l ow ox">terraform {<br/>  backend "s3" {<br/><strong class="nh iu">    bucket = "terrform-us-east-1-your-unique-name"<br/></strong>    key    = "dev/terraform.tfstate"<br/>    region = "us-east-1"<br/>  }<br/>}</span></pre><p id="eab0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">同样，用步骤1中由<code class="fe ne nf ng nh b">eksctl</code>创建的EKS VPC的VPC ID更新<code class="fe ne nf ng nh b">variables.tf</code>文件中的<code class="fe ne nf ng nh b">eks_vpc_id</code>变量。</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="282e" class="ms lf it nh b gy ou ov l ow ox">variable "eks_vpc_id" {<br/><strong class="nh iu">  default = "vpc-your-id"<br/></strong>}</span></pre><p id="e817" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">获取EKS VPC ID的最快方法是使用以下AWS CLI v2命令:</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="4cfd" class="ms lf it nh b gy ou ov l ow ox">aws ec2 describe-vpcs --query 'Vpcs[].VpcId' \<br/>  --filters Name=tag:Name,Values=eksctl-eks-kafka-demo-cluster/VPC \<br/>  --output text</span></pre><p id="e871" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，在亚马逊S3初始化你的Terraform后端，用<code class="fe ne nf ng nh b">terraform init</code>初始化最新的<code class="fe ne nf ng nh b"><a class="ae mb" href="https://registry.terraform.io/providers/hashicorp/aws/latest" rel="noopener ugc nofollow" target="_blank">hashicorp/aws</a></code> provider插件。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi oz"><img src="../Images/bd14c80cf8b4cafbf2ae4e9376cd4fef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BmPP28JvE3vDNjdAqfyklw.png"/></div></div></figure><p id="c004" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用<code class="fe ne nf ng nh b">terraform plan</code>生成一个执行计划，显示Terraform将采取什么行动来应用当前配置。作为计划的一部分，Terraform将创建大约25个AWS资源。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi oz"><img src="../Images/24956e97f0eabdafcfd4a2bb10622d07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*785kIzzWJrKKcMF8rkPDkg.png"/></div></div></figure><p id="255f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，使用<code class="fe ne nf ng nh b">terraform apply</code>创建亚马逊资源。Terraform将在<code class="fe ne nf ng nh b">us-east-1</code>中基于Kafka 2.8.0创建一个小型的开发级MSK集群，包含一组三个<code class="fe ne nf ng nh b">kafka.m5.large</code>代理节点。Terraform将在新VPC创建MSK集群。代理节点分布在新VPC内的三个可用性区域中，每个区域位于一个专用子网中。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi pe"><img src="../Images/32eaa5068fcc01a54499f1d5d9d089c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*muiAnMX4Z8stx-uUilpkng.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">开始使用Terraform创建亚马逊MSK集群</figcaption></figure><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi pe"><img src="../Images/63a36ed452ccbaf6c332184228aaeb0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ub7_dfC4KJrMunQfbzoZXQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">使用Terraform成功创建亚马逊MSK集群</figcaption></figure><p id="b5e1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Terraform可能需要30分钟或更长时间来创建新的集群和相关基础架构。完成后，您可以在<a class="ae mb" href="https://console.aws.amazon.com/msk/home?region=us-east-1#/clusters" rel="noopener ugc nofollow" target="_blank">亚马逊MSK管理控制台</a>中查看新的MSK集群。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi pa"><img src="../Images/2d02c049becf27768d5122f63f52cab7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oVkz3K_15jip_4R4dH3oyQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">从亚马逊MSK控制台看到的新亚马逊MSK集群</figcaption></figure><p id="9c81" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面，请注意新群集的“访问控制方法”是SASL/SCRAM身份验证。群集使用TLS对传输中的数据进行加密，并使用AWM KSM中由客户管理的<a class="ae mb" href="https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html" rel="noopener ugc nofollow" target="_blank">客户主密钥</a> (CMS)对静态数据进行加密。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi pa"><img src="../Images/80946dfc04dbdad8aa3e0a5e7f175ba8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m7bNqsWX_I5fpckUUon4GA.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">从亚马逊MSK控制台看到的新亚马逊MSK集群</figcaption></figure><p id="403c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请注意下面的“AWS机密管理器的相关机密”密码<code class="fe ne nf ng nh b">AmazonMSK_credentials</code>包含SASL/SCRAM认证凭证——用户名和密码。这些是部署到EKS的演示应用程序用来安全访问MSK的凭证。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi pf"><img src="../Images/f7c7b1c84a17069de26f8abdc30cfa84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8kPgiM783fb6sG1KQduqLw.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">从亚马逊MSK控制台看到的新亚马逊MSK集群</figcaption></figure><p id="360a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">可以在<a class="ae mb" href="https://console.aws.amazon.com/secretsmanager/home?region=us-east-1#!/listSecrets" rel="noopener ugc nofollow" target="_blank"> AWS机密管理器控制台</a>中观察到上面显示的SASL/紧急停堆凭证机密。请注意客户管理的客户主密钥(CMK)，它存储在AWS KMS中，用于加密密钥。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi pf"><img src="../Images/8f3916af5a47cae63880641d50e838dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*16Y_p49hzfZxZYn8snaTaw.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">AWS机密管理器控制台中显示的SASL/紧急停堆凭证机密</figcaption></figure><h2 id="cb8c" class="ms lf it bd lg mt mu dn lk mv mw dp lo kr mx my lq kv mz na ls kz nb nc lu nd bi translated">3.更新VPC对等的路由表</h2><p id="3dfc" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">Terraform在新EKS VPC和MSK VPC之间建立了一种<a class="ae mb" href="https://docs.aws.amazon.com/vpc/latest/peering/what-is-vpc-peering.html" rel="noopener ugc nofollow" target="_blank"> VPC对等关系</a>。但是，我们需要通过更新路由表来完成对等配置。我们希望通过VPC对等连接资源，路由所有从EKS集群发往MSK(其VPC CIDR是<code class="fe ne nf ng nh b">10.0.0.0/22</code>)的流量。有四个路由表与EKS VPC相关联。向路由表中添加一条名称以'<code class="fe ne nf ng nh b">PublicRouteTable</code>'结尾的新路由，例如<code class="fe ne nf ng nh b">rtb-0a14e6250558a4abb / eksctl-eks-kafka-demo-cluster/PublicRouteTable</code>。使用VPC控制台的路由表<a class="ae mb" href="https://console.aws.amazon.com/vpc/home?region=us-east-1#RouteTables" rel="noopener ugc nofollow" target="_blank">选项卡</a>在该路由表中手动创建所需的路由，如下所示(<em class="pc">新路由在列表</em>中显示在第二位)。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi pf"><img src="../Images/535c20d0fec31d045755d8d40f4c40f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6uO5I2zDEO-uPXRqMmfLBQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">EKS路由表中有一条通过VPC对等连接到MSK的新路由</figcaption></figure><p id="30fb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">类似地，我们希望通过同一个VPC对等连接资源路由从MSK集群发往EKS的所有流量，的CIDR是<code class="fe ne nf ng nh b">192.168.0.0/16</code>。使用VPC控制台的路由表选项卡更新单MSK VPC的路由表，如下所示(<em class="pc">新路由显示在列表</em>的第二位)。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi pf"><img src="../Images/f10ad4e33c60aff0111f6a8553912b8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*izu-2Y8vD6gM3njB5I39IA.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">MSK路由表中有一条通过VPC对等连接到EKS的新路由</figcaption></figure><h2 id="6850" class="ms lf it bd lg mt mu dn lk mv mw dp lo kr mx my lq kv mz na ls kz nb nc lu nd bi translated">4.为服务帐户创建IAM角色(IRSA)</h2><p id="b8d1" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">随着EKS和MSK集群的创建和对等，我们准备开始部署Kubernetes资源。创建一个新的名称空间，<code class="fe ne nf ng nh b">kafka</code>，它将包含演示应用程序和Kafka客户端pods。</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="efea" class="ms lf it nh b gy ou ov l ow ox">export AWS_ACCOUNT=$(aws sts get-caller-identity \<br/>    --output text --query 'Account')<br/>export EKS_REGION="us-east-1"<br/>export CLUSTER_NAME="eks-kafka-demo"<br/>export NAMESPACE="kafka"</span><span id="f672" class="ms lf it nh b gy oy ov l ow ox">kubectl create namespace $NAMESPACE</span></pre><p id="b13c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后使用<code class="fe ne nf ng nh b">eksctl</code>，为与<a class="ae mb" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/" rel="noopener ugc nofollow" target="_blank"> Kubernetes服务帐户</a>相关联的服务帐户(IRSA)创建两个IAM角色。Kafka客户端的pod将使用其中一个角色，演示应用程序的pod将使用另一个角色。根据<a class="ae mb" href="https://eksctl.io/usage/iamserviceaccounts/#how-it-works" rel="noopener ugc nofollow" target="_blank"> eksctl文档</a>，IRSA通过EKS公开的IAM OpenID连接提供者(<a class="ae mb" href="https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html" rel="noopener ugc nofollow" target="_blank"> OIDC </a>)工作，IAM角色必须参考帖子前面描述的IAM OIDC提供者以及它将绑定的Kubernetes服务帐户的引用来构造。下面的<code class="fe ne nf ng nh b">eksctl</code>命令中引用的两个IAM策略是Terraform早先创建的。</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="dd3c" class="ms lf it nh b gy ou ov l ow ox"><em class="pc"># kafka-demo-app role<br/></em>eksctl create iamserviceaccount \<br/><strong class="nh iu">  --name kafka-demo-app-sasl-scram-serviceaccount \<br/></strong>  --namespace $NAMESPACE \<br/>  --region $EKS_REGION \<br/>  --cluster $CLUSTER_NAME \<br/><strong class="nh iu">  --attach-policy-arn "arn:aws:iam::${AWS_ACCOUNT}:policy/EKSScramSecretManagerPolicy" \<br/></strong>  --approve \<br/>  --override-existing-serviceaccounts</span><span id="0188" class="ms lf it nh b gy oy ov l ow ox"><em class="pc"># kafka-client-msk role<br/></em>eksctl create iamserviceaccount \<br/><strong class="nh iu">  --name kafka-client-msk-sasl-scram-serviceaccount \<br/></strong>  --namespace $NAMESPACE \<br/>  --region $EKS_REGION \<br/>  --cluster $CLUSTER_NAME \<br/><strong class="nh iu">  --attach-policy-arn "arn:aws:iam::${AWS_ACCOUNT}:policy/EKSKafkaClientMSKPolicy" \<br/>  --attach-policy-arn "arn:aws:iam::${AWS_ACCOUNT}:policy/EKSScramSecretManagerPolicy" \<br/></strong>  --approve \<br/>  --override-existing-serviceaccounts</span><span id="d3e8" class="ms lf it nh b gy oy ov l ow ox"><em class="pc"># confirm successful creation of accounts<br/></em>eksctl get iamserviceaccount \<br/>  --cluster $CLUSTER_NAME \<br/>  --namespace $NAMESPACE</span><span id="cd75" class="ms lf it nh b gy oy ov l ow ox">kubectl get serviceaccounts -n $NAMESPACE</span></pre><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi oz"><img src="../Images/3d99827e89d5ec7cf51901a600d58ee7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vXSWT0-YbykE7M2nldh7ZA.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">使用eksctl为服务帐户(IRSA)成功创建了两个IAM角色</figcaption></figure><p id="3ff2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">回忆一下<code class="fe ne nf ng nh b">eksctl</code>最初创造了三个云形成堆栈。添加了两个IAM角色后，我们现在总共部署了五个CloudFormation堆栈。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi pf"><img src="../Images/145645f77b7409831796ccb2de47f71b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SXt2SJwmFBHUfkGG2IXi5g.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">由eksctl创建的亚马逊EKS相关云形成堆栈</figcaption></figure><h2 id="43dd" class="ms lf it bd lg mt mu dn lk mv mw dp lo kr mx my lq kv mz na ls kz nb nc lu nd bi translated">5.卡夫卡客户端</h2><p id="f044" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">接下来，使用项目的掌舵图<code class="fe ne nf ng nh b">kafka-client-msk</code>部署Kafka客户端。我们将使用Kafka客户端来创建Kafka主题和<a class="ae mb" href="https://docs.aws.amazon.com/msk/latest/developerguide/msk-acls.html" rel="noopener ugc nofollow" target="_blank">Apache Kafka ACL</a>。这个特殊的Kafka客户端是基于一个定制的Docker映像，我自己用Java <a class="ae mb" href="https://openjdk.java.net/projects/jdk/17/" rel="noopener ugc nofollow" target="_blank"> OpenJDK 17 </a>、<code class="fe ne nf ng nh b">garystafford/kafka-client-msk</code>使用<a class="ae mb" href="https://alpinelinux.org/" rel="noopener ugc nofollow" target="_blank"> Alpine Linux </a>基础映像构建的。该映像包含最新的Kafka客户端以及AWS CLI v2和其他一些有用的工具，如<code class="fe ne nf ng nh b">jq</code>。如果你喜欢一个替代方案，Docker Hub上有多个Kafka客户端映像。</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="oo op l"/></div></figure><p id="c3f6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Kafka客户端只需要一个pod。运行下面的<code class="fe ne nf ng nh b">helm</code>命令，使用项目的Helm图表<code class="fe ne nf ng nh b">kafka-client-msk</code>将Kafka客户端部署到EKS:</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="91c2" class="ms lf it nh b gy ou ov l ow ox">cd helm/</span><span id="e465" class="ms lf it nh b gy oy ov l ow ox"><em class="pc"># perform dry run to validate chart<br/></em>helm install kafka-client-msk ./kafka-client-msk \<br/>  --namespace $NAMESPACE --debug --dry-run</span><span id="c338" class="ms lf it nh b gy oy ov l ow ox"><em class="pc"># apply chart resources<br/></em>helm install kafka-client-msk ./kafka-client-msk \<br/>  --namespace $NAMESPACE</span></pre><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi oz"><img src="../Images/d04fd980ed6797e0aff9926749f737d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p4r5Etx1124RcqV0osL1og.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">Kafka客户端舵图的成功部署</figcaption></figure><p id="6a5f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用以下命令之一确认Kafka客户端pod的成功创建:</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="f68b" class="ms lf it nh b gy ou ov l ow ox">kubectl get pods -n kafka</span><span id="9747" class="ms lf it nh b gy oy ov l ow ox">kubectl describe pod -n kafka -l app=kafka-client-msk</span></pre><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi oz"><img src="../Images/7047e90baa4164dd3019dd41ee32a622.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*akifcZibF4CplfHSinctEg.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">使用kubectl描述Kafka客户端pod</figcaption></figure><p id="b20e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Kafka客户端与亚马逊MSK、AWS SSM参数商店和AWS Secrets Manager交互的能力基于Terraform创建的两个IAM策略，<code class="fe ne nf ng nh b">EKSKafkaClientMSKPolicy</code>和<code class="fe ne nf ng nh b">EKSScramSecretManagerPolicy</code>。这两个策略与一个新的IAM角色相关联，该角色又与Kubernetes服务帐户<code class="fe ne nf ng nh b">kafka-client-msk-sasl-scram-serviceaccount</code>相关联。此服务帐户与Kafka客户端pod相关联，是Helm图表中Kubernetes部署资源的一部分。</p><h2 id="3298" class="ms lf it bd lg mt mu dn lk mv mw dp lo kr mx my lq kv mz na ls kz nb nc lu nd bi translated">6.卡夫卡主题和卡夫卡的ACL</h2><p id="735c" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">使用Kafka客户端创建Kafka主题和Apache Kafka ACLs。首先，使用<code class="fe ne nf ng nh b">kubectl exec</code>命令执行Kafka客户端容器中的命令。</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="e456" class="ms lf it nh b gy ou ov l ow ox">export KAFKA_CONTAINER=$(<br/>  kubectl get pods -n kafka -l app=kafka-client-msk | \<br/>    awk 'FNR == 2 {print $1}')</span><span id="4c1c" class="ms lf it nh b gy oy ov l ow ox">kubectl exec -it $KAFKA_CONTAINER -n kafka -- bash</span></pre><p id="fedf" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦成功连接到Kafka客户端容器，设置以下三个环境变量:1) Apache ZooKeeper连接字符串，2) Kafka引导程序代理，以及3)引导程序代理的'<em class="pc">可分辨名称'</em>(<a class="ae mb" href="https://docs.aws.amazon.com/msk/latest/developerguide/msk-acls.html" rel="noopener ugc nofollow" target="_blank"><em class="pc">参见AWS文档</em> </a>)。这些环境变量的值将从<a class="ae mb" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html" rel="noopener ugc nofollow" target="_blank"> AWS系统管理器(SSM)参数存储库</a>中检索。这些值是在创建MSK聚类期间由Terraform存储在参数存储中的。根据附加到与此Pod (IRSA)相关联的IAM角色的策略，客户端可以访问SSM参数存储中的这些特定参数。</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="9dd3" class="ms lf it nh b gy ou ov l ow ox">export ZOOKPR=$(\<br/>  aws ssm get-parameter --name /msk/scram/zookeeper \<br/>    --query 'Parameter.Value' --output text)</span><span id="a0b5" class="ms lf it nh b gy oy ov l ow ox">export BBROKERS=$(\<br/>  aws ssm get-parameter --name /msk/scram/brokers \<br/>    --query 'Parameter.Value' --output text)</span><span id="2bb5" class="ms lf it nh b gy oy ov l ow ox">export DISTINGUISHED_NAME=$(\<br/>  echo $BBROKERS | awk -F',' '{print $1}' | sed 's/b-1/*/g')</span></pre><p id="3d0a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用<code class="fe ne nf ng nh b">env</code>和<code class="fe ne nf ng nh b">grep</code>命令验证环境变量已被正确检索和构建。你的Zookeeper和Kafka bootstrap broker的URL将与下面显示的不同。</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="db41" class="ms lf it nh b gy ou ov l ow ox">env | grep 'ZOOKPR\|BBROKERS\|DISTINGUISHED_NAME'</span></pre><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi pe"><img src="../Images/804f6964a3428140483f448ce8716c0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*flxnRdaHxP5JDzdfD6x0BQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">在Kafka客户端容器中设置所需的环境变量</figcaption></figure><p id="db1e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要测试EKS和MSK之间的联系，请从Kafka客户端容器中列出现有的Kafka主题:</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="e970" class="ms lf it nh b gy ou ov l ow ox">bin/kafka-topics.sh --list --zookeeper $ZOOKPR</span></pre><p id="b0b9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您应该会看到三个默认主题，如下所示。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi oz"><img src="../Images/7eb628e7f19e96b174d22ee0e17e2119.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IYxRMaaDFJmjlTY4qpBi5w.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">新MSK集群的默认卡夫卡主题</figcaption></figure><p id="25fe" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果在上一步“建立EKS和MSK VPC的对等关系”中没有将新的VPC对等路由正确添加到适当的路由表中，您可能会在尝试连接时看到超时错误。返回并确认两个路由表都正确更新了新路由。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi oz"><img src="../Images/f69a6d99823100535db2d42f515c359d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JaU0bfL1XWFHtko-nBm_Kw.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">由于VPC对等相关路由表配置不正确，导致连接超时错误</figcaption></figure><h2 id="5bdb" class="ms lf it bd lg mt mu dn lk mv mw dp lo kr mx my lq kv mz na ls kz nb nc lu nd bi translated"><strong class="ak">卡夫卡主题、分区和复制品</strong></h2><p id="2c7c" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">演示应用程序从两个主题<code class="fe ne nf ng nh b">foo-topic</code>和<code class="fe ne nf ng nh b">bar-topic</code>中产生和使用消息。每个主题将有三个<a class="ae mb" href="https://kafka.apache.org/intro#intro_concepts_and_terms" rel="noopener ugc nofollow" target="_blank">分区</a>，三个代理节点各一个，以及三个<a class="ae mb" href="https://kafka.apache.org/intro#intro_concepts_and_terms" rel="noopener ugc nofollow" target="_blank">副本</a>。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi pg"><img src="../Images/758affd5f0f83a44c33a4a5cc3982b44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wJ_XGSrBduptz_zsn8ZMeQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">Kafka主题与分区、副本和代理的关系</figcaption></figure><p id="550b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用客户机容器中的以下命令创建两个新的Kafka主题。完成后，再次使用<code class="fe ne nf ng nh b">list</code>选项确认主题的创建。</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="2ffc" class="ms lf it nh b gy ou ov l ow ox">bin/kafka-topics.sh --create --topic foo-topic \<br/>  --partitions 3 --replication-factor 3 \<br/>  --zookeeper $ZOOKPR</span><span id="3840" class="ms lf it nh b gy oy ov l ow ox">bin/kafka-topics.sh --create --topic bar-topic \<br/>  --partitions 3 --replication-factor 3 \<br/>  --zookeeper $ZOOKPR</span><span id="f102" class="ms lf it nh b gy oy ov l ow ox">bin/kafka-topics.sh --list --zookeeper $ZOOKPR</span></pre><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi oz"><img src="../Images/976d348ca10f98aac26261bfc4151c4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EygzO7E2QjDRlfKksMnnKA.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">创造两个新的卡夫卡主题</figcaption></figure><p id="feb3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用<code class="fe ne nf ng nh b">describe</code>选项查看主题的详细信息。注意每个主题有三个分区，每个主题有三个副本。</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="e1cb" class="ms lf it nh b gy ou ov l ow ox">bin/kafka-topics.sh --describe --topic foo-topic --zookeeper $ZOOKPR</span><span id="dcad" class="ms lf it nh b gy oy ov l ow ox">bin/kafka-topics.sh --describe --topic bar-topic --zookeeper $ZOOKPR</span></pre><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi oz"><img src="../Images/13d19a24ecdacf72b2fb8992fad74537.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jgNjPBTvvvTJDYpG8HxMpA.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">描述两个新的卡夫卡主题</figcaption></figure><h2 id="9976" class="ms lf it bd lg mt mu dn lk mv mw dp lo kr mx my lq kv mz na ls kz nb nc lu nd bi translated"><strong class="ak">卡夫卡ACL</strong></h2><p id="be78" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">根据Kafka的<a class="ae mb" href="https://cwiki.apache.org/confluence/display/KAFKA/Kafka+Authorization+Command+Line+Interface" rel="noopener ugc nofollow" target="_blank">文档</a>，Kafka附带了一个可插拔的授权器和一个开箱即用的授权器实现，它使用Zookeeper来存储所有的访问控制列表(ACL)。Kafka ACLs是以“Principal P is[Allowed/Denied]Operation O From Host H On Resource r”的通用格式定义的，你可以在<a class="ae mb" href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-11+-+Authorization+Interface" rel="noopener ugc nofollow" target="_blank"> KIP-11 </a>上阅读更多关于ACL结构的内容。要添加、删除或列出ACL，您可以使用Kafka authorizer CLI。</p><p id="e9bf" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">授权Kafka代理和演示应用程序访问这两个主题。首先，允许使用<code class="fe ne nf ng nh b">DISTINGUISHED_NAME</code>环境变量从代理访问主题(<em class="pc">参见</em> <a class="ae mb" href="https://docs.aws.amazon.com/msk/latest/developerguide/msk-acls.html" rel="noopener ugc nofollow" target="_blank"> <em class="pc"> AWS文档</em> </a>)。</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="0668" class="ms lf it nh b gy ou ov l ow ox"><em class="pc"># read auth for brokers<br/></em>bin/kafka-acls.sh \<br/>  --authorizer-properties zookeeper.connect=$ZOOKPR \<br/>  --add \<br/><strong class="nh iu">  --allow-principal "User:CN=${DISTINGUISHED_NAME}" \<br/>  --operation Read \<br/>  --group=consumer-group-B \<br/>  --topic foo-topic</strong></span><span id="65b3" class="ms lf it nh b gy oy ov l ow ox">bin/kafka-acls.sh \<br/>  --authorizer-properties zookeeper.connect=$ZOOKPR \<br/>  --add \<br/><strong class="nh iu">  --allow-principal "User:CN=${DISTINGUISHED_NAME}" \<br/>  --operation Read \<br/>  --group=consumer-group-A \<br/>  --topic bar-topic</strong></span><span id="e57b" class="ms lf it nh b gy oy ov l ow ox"><em class="pc"># write auth for brokers<br/></em>bin/kafka-acls.sh \<br/>  --authorizer-properties zookeeper.connect=$ZOOKPR \<br/>  --add \<br/><strong class="nh iu">  --allow-principal "User:CN=${DISTINGUISHED_NAME}" \<br/>  --operation Write \<br/>  --topic foo-topic</strong></span><span id="7db7" class="ms lf it nh b gy oy ov l ow ox">bin/kafka-acls.sh \<br/>  --authorizer-properties zookeeper.connect=$ZOOKPR \<br/>  --add \<br/><strong class="nh iu">  --allow-principal "User:CN=${DISTINGUISHED_NAME}" \<br/>  --operation Write \<br/>  --topic bar-topic</strong></span></pre><p id="2929" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">服务A的三个实例(副本/pod)是<code class="fe ne nf ng nh b">consumer-group-A</code>的一部分，它们向<code class="fe ne nf ng nh b">foo-topic</code>生成消息，并从<code class="fe ne nf ng nh b">bar-topic</code>消费消息。相反，作为<code class="fe ne nf ng nh b">consumer-group-B</code>的一部分，服务B的三个实例向<code class="fe ne nf ng nh b">bar-topic</code>产生消息，并从<code class="fe ne nf ng nh b">foo-topic</code>消费消息。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi ph"><img src="../Images/441ac83e471a77ed2a147572393c84b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3oHlqgRv8DTGc9lc3dt2-Q.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">从微服务到Kafka主题的消息流</figcaption></figure><p id="a7fe" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">允许从演示应用的微服务访问适当的主题。首先，设置<code class="fe ne nf ng nh b">USER</code>环境变量——MSK集群的SASL/紧急停堆凭证的用户名，由Terraform存储在AWS Secrets Manager中。我们可以从Secrets Manager中检索用户名，并使用以下命令将其分配给环境变量。</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="b94a" class="ms lf it nh b gy ou ov l ow ox">export USER=$(<br/>  aws secretsmanager get-secret-value \<br/>    --secret-id AmazonMSK_credentials \<br/>    --query SecretString --output text | \<br/>    jq .username | sed -e 's/^"//' -e 's/"$//')</span></pre><p id="2e0f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">创建适当的ACL。</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="7c68" class="ms lf it nh b gy ou ov l ow ox"><em class="pc"># producers<br/></em>bin/kafka-acls.sh \<br/>  --authorizer kafka.security.auth.SimpleAclAuthorizer \<br/>  --authorizer-properties zookeeper.connect=$ZOOKPR \<br/>  --add \<br/><strong class="nh iu">  --allow-principal User:$USER \<br/>  --producer \<br/>  --topic foo-topic</strong></span><span id="f059" class="ms lf it nh b gy oy ov l ow ox">bin/kafka-acls.sh \<br/>  --authorizer kafka.security.auth.SimpleAclAuthorizer \<br/>  --authorizer-properties zookeeper.connect=$ZOOKPR \<br/>  --add \<br/><strong class="nh iu">  --allow-principal User:$USER \<br/>  --producer \<br/>  --topic bar-topic</strong></span><span id="8ce6" class="ms lf it nh b gy oy ov l ow ox"><em class="pc"># consumers<br/></em>bin/kafka-acls.sh \<br/>  --authorizer kafka.security.auth.SimpleAclAuthorizer \<br/>  --authorizer-properties zookeeper.connect=$ZOOKPR \<br/>  --add \<br/><strong class="nh iu">  --allow-principal User:$USER \<br/>  --consumer \<br/>  --topic foo-topic \<br/>  --group consumer-group-B</strong></span><span id="ec24" class="ms lf it nh b gy oy ov l ow ox">bin/kafka-acls.sh \<br/>  --authorizer kafka.security.auth.SimpleAclAuthorizer \<br/>  --authorizer-properties zookeeper.connect=$ZOOKPR \<br/>  --add \<br/><strong class="nh iu">  --allow-principal User:$USER \<br/>  --consumer \<br/>  --topic bar-topic \<br/>  --group consumer-group-A</strong></span></pre><p id="472a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要列出您刚刚创建的ACL，请使用以下命令:</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="b07a" class="ms lf it nh b gy ou ov l ow ox"><em class="pc"># list all ACLs<br/></em>bin/kafka-acls.sh \<br/>  --authorizer kafka.security.auth.SimpleAclAuthorizer \<br/>  --authorizer-properties zookeeper.connect=$ZOOKPR \<br/>  --list</span><span id="dfb6" class="ms lf it nh b gy oy ov l ow ox"><em class="pc"># list for individual topics, e.g. foo-topic<br/></em>bin/kafka-acls.sh \<br/>  --authorizer kafka.security.auth.SimpleAclAuthorizer \<br/>  --authorizer-properties zookeeper.connect=$ZOOKPR \<br/>  --list \<br/><strong class="nh iu">  --topic foo-topic</strong></span></pre><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi pe"><img src="../Images/0689cba5bd0629dac575d67b46fe64ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vpEFFvCbP9UhxaT6c43Ucw.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">与foo-topic Kafka主题关联的Kafka ACLs</figcaption></figure><h2 id="a1b2" class="ms lf it bd lg mt mu dn lk mv mw dp lo kr mx my lq kv mz na ls kz nb nc lu nd bi translated">7.部署示例应用程序</h2><p id="3917" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">我们应该最终准备好将我们的演示应用程序部署到EKS。该应用包含两个基于Go的微服务，即服务A和服务b。演示应用的功能来源于Soham Kamani在2020年9月发表的博文<a class="ae mb" href="https://www.sohamkamani.com/golang/working-with-kafka/" rel="noopener ugc nofollow" target="_blank">，在Golang中实现一个Kafka生产者和消费者(带有完整示例)用于生产</a>。演示应用程序的所有源代码都包含在项目中。</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="779c" class="ms lf it nh b gy ou ov l ow ox">.<br/>├── Dockerfile<br/>├── README.md<br/>├── consumer.go<br/>├── dialer.go<br/>├── dialer_scram.go<br/>├── go.mod<br/>├── go.sum<br/>├── main.go<br/>├── param_store.go<br/>├── producer.go<br/>└── tls.go</span></pre><p id="7c75" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">两个微服务都使用相同的Docker映像<code class="fe ne nf ng nh b">garystafford/kafka-demo-service</code>，配置了不同的环境变量。该配置使这两种服务以不同的方式运行。如前所述，微服务使用Segment的<code class="fe ne nf ng nh b"><a class="ae mb" href="https://github.com/segmentio/kafka-go" rel="noopener ugc nofollow" target="_blank">kafka-go</a></code>客户端与MSK集群的代理和主题进行通信。下面，我们看到了演示应用程序的消费者功能(<code class="fe ne nf ng nh b">consumer.go</code>)。</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="oo op l"/></div></figure><p id="d623" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上图中的消费者和生产者都使用SASL/SCRAM连接到MSK集群。下面，我们看到SASL/急停拨号器的功能。这个<code class="fe ne nf ng nh b">Dialer</code>类型镜像了<code class="fe ne nf ng nh b">net.Dialer</code> API，但是被设计用来打开Kafka连接而不是原始网络连接。请注意该函数如何访问AWS Secrets Manager来检索SASL/紧急停堆凭证。</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="oo op l"/></div></figure><p id="9fa4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将使用Helm部署每个微服务的三个副本(每个微服务三个单元)。下面，我们看到了每个微服务的Kubernetes <code class="fe ne nf ng nh b">Deployment</code>和<code class="fe ne nf ng nh b">Service</code>资源。</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="oo op l"/></div></figure><p id="3b73" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">运行下面的<code class="fe ne nf ng nh b">helm</code>命令，使用项目的Helm图表<code class="fe ne nf ng nh b">kafka-demo-app</code>将演示应用程序部署到EKS:</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="611d" class="ms lf it nh b gy ou ov l ow ox">cd helm/</span><span id="8dd4" class="ms lf it nh b gy oy ov l ow ox"><em class="pc"># perform dry run to validate chart<br/></em>helm install kafka-demo-app ./kafka-demo-app \<br/>    --namespace $NAMESPACE --debug --dry-run</span><span id="8196" class="ms lf it nh b gy oy ov l ow ox"><em class="pc"># apply chart resources<br/></em>helm install kafka-demo-app ./kafka-demo-app \<br/>    --namespace $NAMESPACE</span></pre><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi oz"><img src="../Images/afb975bf0eba9b89c72dac1212db76da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Iv02abebg9akVIUfkRVuJg.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">成功部署演示应用程序的舵图</figcaption></figure><p id="734e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用以下命令之一确认Kafka客户端pod的成功创建:</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="3080" class="ms lf it nh b gy ou ov l ow ox">kubectl get pods -n kafka</span><span id="520e" class="ms lf it nh b gy oy ov l ow ox">kubectl get pods -n kafka -l app=kafka-demo-service-a</span><span id="35e7" class="ms lf it nh b gy oy ov l ow ox">kubectl get pods -n kafka -l app=kafka-demo-service-b</span></pre><p id="a126" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在您应该有总共七个pods在<code class="fe ne nf ng nh b">kafka</code>名称空间中运行。除了之前部署的单个Kafka客户端pod之外，还应该有三个新的服务A pods和三个新的服务B pods。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi oz"><img src="../Images/93f6d2829c7589e9b998d39f3b6486d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Iw70wlFEFTusFA5zGn-S3A.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">kafka命名空间显示了七个正在运行的pod</figcaption></figure><p id="85cc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">演示应用程序与AWS SSM参数存储和AWS Secrets Manager交互的能力基于Terraform，<code class="fe ne nf ng nh b">EKSScramSecretManagerPolicy</code>创建的IAM策略。该策略与一个新的IAM角色相关联，该角色又与Kubernetes服务帐户<code class="fe ne nf ng nh b">kafka-demo-app-sasl-scram-serviceaccount</code>相关联。这个服务帐户与演示应用程序的pods相关联，是Helm图表中Kubernetes部署资源的一部分。</p><h2 id="ce03" class="ms lf it bd lg mt mu dn lk mv mw dp lo kr mx my lq kv mz na ls kz nb nc lu nd bi translated">8.验证应用程序功能</h2><p id="0dd4" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">虽然pod成功启动和运行是一个好的迹象，但是要确认演示应用程序是否正常运行，请使用<code class="fe ne nf ng nh b">kubectl</code>检查服务A和服务B的日志。这些日志将确认应用程序已经成功地从Secrets Manager检索到SASL/紧急停堆凭证，连接到MSK，并且可以从适当的主题生成和使用消息。</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="42aa" class="ms lf it nh b gy ou ov l ow ox">kubectl logs -l app=kafka-demo-service-a -n kafka</span><span id="fdf8" class="ms lf it nh b gy oy ov l ow ox">kubectl logs -l app=kafka-demo-service-b -n kafka</span></pre><p id="fa0e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe ne nf ng nh b">MSG_FREQ</code>环境变量控制微服务产生消息的频率。默认情况下，频率为60秒，但在舵图中会被覆盖并增加到10秒。</p><p id="ac97" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面，我们看到了由服务A pods生成的日志。注意，其中一条消息表明服务A生产者成功:<code class="fe ne nf ng nh b">writing 1 messages to foo-topic (partition: 0)</code>。以及指示消费者成功的消息:<code class="fe ne nf ng nh b">kafka-demo-service-a-db76c5d56-gmx4v received message: This is message 68 from host kafka-demo-service-b-57556cdc4c-sdhxc</code>。每条消息都包含生成和使用它的主机容器的名称。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi oz"><img src="../Images/90d61ea7e2ee72549ac761d8c08e5921.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0MnOSd62Ls_a1VuwkKKyCQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">服务A pods生成的日志</figcaption></figure><p id="def8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">同样，我们可以看到由两个服务B pods生成的日志。注意，其中一条消息表明服务B生产者成功:<code class="fe ne nf ng nh b">writing 1 messages to bar-topic (partition: 2)</code>。以及指示消费者成功的消息:<code class="fe ne nf ng nh b">kafka-demo-service-b-57556cdc4c-q8wvz received message: This is message 354 from host kafka-demo-service-a-db76c5d56-r88fk</code>。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi oz"><img src="../Images/bc8a9a11243dfc6b83b6a214949c48ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sasKXg1RP-1RRtUCjwVyjw.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">服务B窗格生成的日志</figcaption></figure><h2 id="c2bc" class="ms lf it bd lg mt mu dn lk mv mw dp lo kr mx my lq kv mz na ls kz nb nc lu nd bi translated">云观察指标</h2><p id="bbec" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">我们还可以检查可用的亚马逊MSK CloudWatch指标，以确认基于EKS的演示应用程序正在按预期与MSK通信。该集群有132个不同的指标可用。下面，我们看到两个主题的三个分区中的每一个的<code class="fe ne nf ng nh b">BytesInPerSec</code>和<code class="fe ne nf ng nh b">BytesOutPerSecond</code>，它们分布在三个Kafka broker节点中的每一个上。每个指标显示了每个主题的类似流量，包括入站和出站流量。除了日志之外，这些指标还显示了服务A和服务B的多个实例正在生成和使用消息。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi pf"><img src="../Images/a38de879c8d21b43c8759e6407bc1459.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YwpHmXISJkZMXzwjyJv39Q.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">MSK集群的亚马逊云观察指标</figcaption></figure><h2 id="2ca1" class="ms lf it bd lg mt mu dn lk mv mw dp lo kr mx my lq kv mz na ls kz nb nc lu nd bi translated">普罗米修斯</h2><p id="d333" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">我们也可以使用开源的可观测性工具来确认同样的结果，比如普罗米修斯。亚马逊MSK开发者指南概述了使用Prometheus监控Kafka的必要步骤。由<code class="fe ne nf ng nh b">eksctl</code>创建的亚马逊MSK集群已经启用了开放监控，并且端口<code class="fe ne nf ng nh b">11001</code>和<code class="fe ne nf ng nh b">11002</code>被Terraform添加到必要的MSK安全组。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi pa"><img src="../Images/ec3ce585a7cde2f57ef13c5283d69a12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vimTUuaEFWKsFR1CSgQBLQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">亚马逊MSK代理目标成功连接到Prometheus</figcaption></figure><p id="0162" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在EKS集群上的单个pod中运行Prometheus(从Ubuntu base Docker映像或类似映像构建)可能是这个演示中最简单的方法。</p><pre class="md me mf mg gt oq nh or os aw ot bi"><span id="7b80" class="ms lf it nh b gy ou ov l ow ox">rate(kafka_server_BrokerTopicMetrics_Count{topic=~"foo-topic|bar-topic", name=~"BytesInPerSec|BytesOutPerSec"}[5m])</span></pre><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi pa"><img src="../Images/3621e0ca54fd95ed58d786de5992d7b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jS8DkqtI3bAyHXbUNEBlUw.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">普罗米修斯图显示了<code class="fe ne nf ng nh b">BytesInPerSec</code>和<code class="fe ne nf ng nh b">BytesOutPerSecond for the two topics</code>的速率</figcaption></figure><h1 id="7d03" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">参考</h1><ul class=""><li id="4ca7" class="oa ob it kk b kl lw ko lx kr pi kv pj kz pk ld pl og oh oi bi translated"><a class="ae mb" href="https://docs.aws.amazon.com/msk/latest/developerguide/what-is-msk.html" rel="noopener ugc nofollow" target="_blank">亚马逊面向Apache Kafka开发者的托管流媒体指南</a></li><li id="1127" class="oa ob it kk b kl oj ko ok kr ol kv om kz on ld pl og oh oi bi translated"><a class="ae mb" href="https://github.com/segmentio/kafka-go" rel="noopener ugc nofollow" target="_blank">段的</a> <code class="fe ne nf ng nh b"><a class="ae mb" href="https://github.com/segmentio/kafka-go" rel="noopener ugc nofollow" target="_blank">kafka-go</a></code> <a class="ae mb" href="https://github.com/segmentio/kafka-go" rel="noopener ugc nofollow" target="_blank">项目</a> (GitHub)</li><li id="dafa" class="oa ob it kk b kl oj ko ok kr ol kv om kz on ld pl og oh oi bi translated"><a class="ae mb" href="https://www.sohamkamani.com/golang/working-with-kafka/" rel="noopener ugc nofollow" target="_blank">为生产</a>实现Golang <br/>中的Kafka生产者和消费者，作者Soham Kamani</li><li id="8ca6" class="oa ob it kk b kl oj ko ok kr ol kv om kz on ld pl og oh oi bi translated"><a class="ae mb" href="https://github.com/sohamkamani/golang-kafka-example" rel="noopener ugc nofollow" target="_blank">卡夫卡戈朗的例子</a> (GitHub/Soham Kamani)</li><li id="38c4" class="oa ob it kk b kl oj ko ok kr ol kv om kz on ld pl og oh oi bi translated"><a class="ae mb" href="https://amazonmsk-labs.workshop.aws/en/" rel="noopener ugc nofollow" target="_blank"> AWS亚马逊MSK车间</a></li></ul></div><div class="ab cl pm pn hx po" role="separator"><span class="pp bw bk pq pr ps"/><span class="pp bw bk pq pr ps"/><span class="pp bw bk pq pr"/></div><div class="im in io ip iq"><p id="97c0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这篇博客代表我自己的观点，而不是我的雇主亚马逊网络服务公司(AWS)的观点。所有产品名称、徽标和品牌都是其各自所有者的财产。</p></div></div>    
</body>
</html>