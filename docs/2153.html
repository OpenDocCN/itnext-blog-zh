<html>
<head>
<title>Laravel 5.8 Passport oAuth 2.0 Usage and Implementation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Laravel 5.8 Passport oAuth 2.0的使用和实施</h1>
<blockquote>原文：<a href="https://itnext.io/laravel-5-8-passport-oauth-2-0-usage-and-implementation-5e5d92aeab42?source=collection_archive---------1-----------------------#2019-04-08">https://itnext.io/laravel-5-8-passport-oauth-2-0-usage-and-implementation-5e5d92aeab42?source=collection_archive---------1-----------------------#2019-04-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><blockquote class="jq jr js"><p id="011f" class="jt ju jv jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr im bi translated">免责声明:本教程假设您熟悉Laravel、中间件、路由、get/post请求和浏览文档。本教程解释grant_type Client_credentials的实现</p></blockquote><h1 id="d467" class="ks kt it bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">步骤1:实施</h1><p id="5736" class="pw-post-body-paragraph jt ju it jw b jx lq jz ka kb lr kd ke ls lt kh ki lu lv kl km lw lx kp kq kr im bi translated">您必须遵循<a class="ae ly" href="https://laravel.com/docs/5.8/passport" rel="noopener ugc nofollow" target="_blank"> <strong class="jw iu"> <em class="jv">文档</em> </strong> </a>中说明的步骤。<br/>它提供了以下现成的授权类型。</p><p id="eace" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ls kg kh ki lu kk kl km lw ko kp kq kr im bi translated"><strong class="jw iu"> 1- </strong> <a class="ae ly" href="https://laravel.com/docs/5.8/passport#implicit-grant-tokens" rel="noopener ugc nofollow" target="_blank"> <strong class="jw iu">隐式授予</strong> </a> <strong class="jw iu">令牌:</strong>当你的app/网站需要使用来自客户端的个人资料或账户的数据时使用(大部分)。比如用facebook注册。或者在facebook上发布来自第三方的内容。</p><p id="7859" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ls kg kh ki lu kk kl km lw ko kp kq kr im bi translated"><strong class="jw iu"> 2- </strong> <a class="ae ly" href="https://laravel.com/docs/5.8/passport#client-credentials-grant-tokens" rel="noopener ugc nofollow" target="_blank"> <strong class="jw iu">客户端凭证授予</strong> </a> <strong class="jw iu">令牌:</strong>客户端凭证授予适用于机器对机器的认证。只能从命令行生成。</p><p id="d487" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ls kg kh ki lu kk kl km lw ko kp kq kr im bi translated"><strong class="jw iu"> 3- </strong> <a class="ae ly" href="https://laravel.com/docs/5.8/passport#personal-access-tokens" rel="noopener ugc nofollow" target="_blank"> <strong class="jw iu">个人访问</strong> </a> <strong class="jw iu">令牌:</strong>有时，您的用户可能希望向自己颁发访问令牌，而不经过(1)中提到的典型授权码重定向流程。</p><p id="7861" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ls kg kh ki lu kk kl km lw ko kp kq kr im bi translated"><strong class="jw iu"> 4-修改的Client_Credentials令牌:</strong>我希望用户注册并在机器之间进行通信，而不涉及任何中介，并进行可能的订阅，同时保持原始设置不变，避免<a class="ae ly" href="https://stackoverflow.com/questions/39833897/laravel-5-3-passport-api-unauthenticated-in-postman-using-personal-access-tokens" rel="noopener ugc nofollow" target="_blank">问题</a>并解决错误。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi lz"><img src="../Images/9a282d84443fa821ecea7ff91895af99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9Wklpxd5oCOW3ovR.png"/></div></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk translated">错误:未经验证</figcaption></figure></div><div class="ab cl mp mq hx mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="im in io ip iq"><h1 id="5d14" class="ks kt it bd ku kv mw kx ky kz mx lb lc ld my lf lg lh mz lj lk ll na ln lo lp bi translated">第二步:需要的修改</h1><p id="9067" class="pw-post-body-paragraph jt ju it jw b jx lq jz ka kb lr kd ke ls lt kh ki lu lv kl km lw lx kp kq kr im bi translated">现在，将与客户端凭据关联的所有api.php路由移出:</p><pre class="ma mb mc md gt nb nc nd ne aw nf bi"><span id="517e" class="ng kt it nc b gy nh ni l nj nk">/routes/api.php</span></pre><p id="bedd" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ls kg kh ki lu kk kl km lw ko kp kq kr im bi translated">并将它们移动到一个<strong class="jw iu"> <em class="jv">新的</em> </strong>路线文件中，命名为:</p><pre class="ma mb mc md gt nb nc nd ne aw nf bi"><span id="2702" class="ng kt it nc b gy nh ni l nj nk">/routes/client_credentials.php</span></pre><p id="4897" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ls kg kh ki lu kk kl km lw ko kp kq kr im bi translated">这样做可以确保核心功能不受影响。</p><p id="854c" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ls kg kh ki lu kk kl km lw ko kp kq kr im bi translated">接下来，我们需要使用这个新的路由文件(client_credentials.php)。为此，请更新:</p><pre class="ma mb mc md gt nb nc nd ne aw nf bi"><span id="ef2a" class="ng kt it nc b gy nh ni l nj nk">/app/Providers/RouteServiceProvider.php</span></pre><p id="2815" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ls kg kh ki lu kk kl km lw ko kp kq kr im bi translated">通过添加一个新方法并在现有的“map”方法中调用它，如下面的RouteServiceProvider.php文件所示</p><pre class="ma mb mc md gt nb nc nd ne aw nf bi"><span id="5c6a" class="ng kt it nc b gy nh ni l nj nk">&lt;?php</span><span id="0184" class="ng kt it nc b gy nl ni l nj nk">class RouteServiceProvider extends ServiceProvider<br/>{</span><span id="b903" class="ng kt it nc b gy nl ni l nj nk">// existing map method<br/>    public function map()<br/>    {<br/>        $this-&gt;mapApiRoutes();</span><span id="266c" class="ng kt it nc b gy nl ni l nj nk">$this-&gt;mapWebRoutes();<br/>    <br/>        // ref new method for adding client credentials<br/>        $this-&gt;mapClientCredentialRoutes();<br/>    }</span><span id="6140" class="ng kt it nc b gy nl ni l nj nk">// new client credentials method<br/>    protected function mapClientCredentialRoutes()<br/>    {<br/>        Route::prefix('api') // I still want /api/ urls<br/>            -&gt;middleware('client_credentials') // new middleware I'll set up in a bit<br/>            -&gt;namespace($this-&gt;namespace)<br/>            -&gt;group(base_path('routes/client_credentials.php')); // referencing my new routes file<br/>    }<br/>}</span></pre><p id="331f" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ls kg kh ki lu kk kl km lw ko kp kq kr im bi translated">现在修改内核文件，使上述文件成为路由系统的一部分。</p><pre class="ma mb mc md gt nb nc nd ne aw nf bi"><span id="f15f" class="ng kt it nc b gy nh ni l nj nk">/app/Http/Kernel.php</span></pre><p id="9e1b" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ls kg kh ki lu kk kl km lw ko kp kq kr im bi translated">在这里，为我们的新中间件的client_credentials创建一个新的中间件组。</p><pre class="ma mb mc md gt nb nc nd ne aw nf bi"><span id="bbe3" class="ng kt it nc b gy nh ni l nj nk">&lt;?php</span><span id="067b" class="ng kt it nc b gy nl ni l nj nk">class Kernel extends HttpKernel<br/>{<br/>    protected $middlewareGroups = [<br/>        'web' =&gt; [<br/>            \App\Http\Middleware\EncryptCookies::class,<br/>            \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class,<br/>            \Illuminate\Session\Middleware\StartSession::class,<br/>            // \Illuminate\Session\Middleware\AuthenticateSession::class,<br/>            \Illuminate\View\Middleware\ShareErrorsFromSession::class,<br/>            \App\Http\Middleware\VerifyCsrfToken::class,<br/>            \Illuminate\Routing\Middleware\SubstituteBindings::class,<br/>        ],</span><span id="b3b8" class="ng kt it nc b gy nl ni l nj nk">'api' =&gt; [<br/>            'throttle:60,1',<br/>            'bindings',<br/>        ],<br/>        <br/>        // NEW LINE<br/>        'client_credentials' =&gt; [<br/>            \Laravel\Passport\Http\Middleware\CheckClientCredentials::class,<br/>            'throttle:60,1',<br/>            'bindings',<br/>        ]<br/>    ];<br/>}</span></pre></div><div class="ab cl mp mq hx mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="im in io ip iq"><h1 id="003e" class="ks kt it bd ku kv mw kx ky kz mx lb lc ld my lf lg lh mz lj lk ll na ln lo lp bi translated">第三步:用法</h1><p id="1c70" class="pw-post-body-paragraph jt ju it jw b jx lq jz ka kb lr kd ke ls lt kh ki lu lv kl km lw lx kp kq kr im bi translated">现在是用法部分。</p><p id="b955" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ls kg kh ki lu kk kl km lw ko kp kq kr im bi translated">从默认vue组件创建新的客户端凭据</p><pre class="ma mb mc md gt nb nc nd ne aw nf bi"><span id="790c" class="ng kt it nc b gy nh ni l nj nk">&lt;passport-client&gt;&lt;/passport-client&gt;</span></pre><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi nm"><img src="../Images/784cba904a8d2141a5641848ada4d1a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-V23_wXcHqfDxbDyDse-ew.png"/></div></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk translated">仅在PHP服务器端脚本中使用的密钥</figcaption></figure><p id="35f7" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ls kg kh ki lu kk kl km lw ko kp kq kr im bi translated">按如下方式实现函数。</p><pre class="ma mb mc md gt nb nc nd ne aw nf bi"><span id="f2e3" class="ng kt it nc b gy nh ni l nj nk"><strong class="nc iu">&lt;?php<br/><br/>use </strong>App\User;<br/><strong class="nc iu">use </strong>Illuminate\Http\Request;<br/><br/>Route::<em class="jv">middleware</em>('client_credentials')-&gt;get('/user', <strong class="nc iu">function </strong>(Request $request) {<br/>   <strong class="nc iu">return </strong>response()-&gt;json(["data"=&gt;<strong class="nc iu">true</strong>]);<br/>});<br/>Route::<em class="jv">middleware</em>('client_credentials')-&gt;get('/user/get', <strong class="nc iu">function</strong>(Request $request){<br/>   $user_id = $request-&gt;get("uid");<br/>   $user = User::<em class="jv">where</em>('id','=',$user_id)-&gt;get()-&gt;first();<br/>   <strong class="nc iu">return </strong>response()-&gt;json($user);<br/>});</span></pre><p id="fb36" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ls kg kh ki lu kk kl km lw ko kp kq kr im bi translated">您可以下载并导入postman集合来测试基本用法</p><figure class="ma mb mc md gt me"><div class="bz fp l di"><div class="nn no l"/></div></figure></div></div>    
</body>
</html>