<html>
<head>
<title>How SNI Became a Battleground of Security v.s. Privacy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SNI如何成为安全与隐私的战场</h1>
<blockquote>原文：<a href="https://itnext.io/sni-from-a-to-z-72deffe942e1?source=collection_archive---------0-----------------------#2022-04-15">https://itnext.io/sni-from-a-to-z-72deffe942e1?source=collection_archive---------0-----------------------#2022-04-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="39f2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">不用说，加密是信息安全的支柱之一。它最广为人知的应用之一是传输层安全性— TLS。Google估计95%的网络流量是HTTPS，这只是TLS的一种使用方式——它可以与任何其他TCP协议一起使用，无论是本地的还是通过StartTLS(它甚至开始在UDP和QUIC中使用)。人们很容易理所当然地认为TLS的开发投入了多少工程和脑力；多年来，它已经发展了很多，其最新版本是1.3，由IETF在2018年的RFC 8446中正式定义。它包含了太多的复杂性和细微差别。</p><p id="6c58" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">今天我们将讨论TLS的一个不太为人所知的方面:服务器名称指示——又名SNI。它解决了许多有趣的问题，甚至引入了一些有趣的隐私问题。</p><p id="2725" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">它解决了什么问题？</p><p id="02e0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我经常说，解释一项技术或软件的最佳方式是解释它试图解决什么问题，而不是解释它做什么。要对SNI做到这一点，我们必须回到SSL/TLS的开始。</p><p id="f6d1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当安全套接字层(SSL)在上世纪90年代由前技术巨头Netscape首次开发时，web服务器只能“监听”单个套接字(也称为端口-IP组合)上的SSL流量。</p><p id="474b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="ko">补充说明:SSL和TLS被很多人(包括我自己)交替使用，但TLS在技术上是正确的术语——你应该感谢微软造成的混乱。早在20世纪90年代末，网景公司和微软公司之间就爆发了一场“浏览器大战”——微软的Internet Explorer和网景的Navigator。网景公司开发了SSL，微软和其他公司也在开发自己的加密网络流量的解决方案。IETF没有一堆不同的版本，而是组织了一次会议，就一个单一的全球标准达成一致。Netscape的SSL更常用，但微软不希望Netscape在新协议上获得事实上的命名权——所以每个人都同意了一个新的协议名称，TLS。</em></p><p id="d8a8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">例如，如果您浏览google.com，该套接字可能是TCP端口443上的142.250.81.206。如果您在TCP端口443上浏览该IP地址，web服务器只能加密流量并为该单一组合提供证书。如果你想托管另一个网站，你有4个选择:</p><ol class=""><li id="0bee" class="kp kq it js b jt ju jx jy kb kr kf ks kj kt kn ku kv kw kx bi translated">安装一台新的网络服务器——这是很昂贵的，因为在那个时代，它几乎总是一台物理服务器。这是假设你能从你的ISP那里得到一个额外的IP地址——如果你不能，你就不走运了。</li><li id="624d" class="kp kq it js b jt ky jx kz kb la kf lb kj lc kn ku kv kw kx bi translated">为该服务器上的NIC(网络接口卡)分配一个额外的IP地址。如上所述，这取决于你是否能够获得一个新的公共IP地址。</li><li id="099d" class="kp kq it js b jt ky jx kz kb la kf lb kj lc kn ku kv kw kx bi translated">使用不同的端口——这并不吸引人，因为所有的浏览器都默认为HTTP使用端口80，HTTPS使用端口443，除非在URL中指定了端口——所以要求用户除了域名之外还要记住端口是不友好的。继续在任何网站上尝试这种方法——只需在域名末尾加上:443——就像<a class="ae ld" href="https://google.com:443" rel="noopener ugc nofollow" target="_blank">https://google.com:443</a>——你会看到页面加载后端口会消失。想象一下，你必须记住google.com在443，而cloudflare.com在444。</li><li id="cbea" class="kp kq it js b jt ky jx kz kb la kf lb kj lc kn ku kv kw kx bi translated">获得多域证书—多SAN(主题别名)证书在2000年左右开始成为一种事物。多SAN证书非常常见，但几乎总是针对绑定到单个实体的域和子域。想象一下，如果你为多家公司托管网站；如果私钥泄露，所有这些域(以及公司)都将受到影响。</li></ol><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/0c01e450f1a7c5a8bb9c40d715e9ab63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z_wovAUatStNM3O5hn5jIQ.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">这些都是espn.com使用的证书上的SAN显然，它们都与ESPN相关联。</figcaption></figure><p id="d5c4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在web的早期，我们能够管理，但随着我们扩大规模并开始引入负载平衡器和内容交付网络(cdn)，如Akamai、CloudFlare和AWS CloudFront，这很快成为一个问题。互联网需要一种方法让web服务器在一个套接字上使用多个证书。进入SNI。</p><p id="fabd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">SNI所做的就是当用户试图访问一个网站时，它会在TLS客户端Hello中粘贴一个扩展名(本质上是一个头),指定他们试图连接的域名。客户端Hello是建立安全加密过程中的第一个动作，也称为“握手”，因此是完全未加密的。它紧接在TCP握手之后发生，TCP握手在客户端和服务器之间建立了稳定、可靠的连接。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi lu"><img src="../Images/9a550f03599f160f1ffedd80de3ee638.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_OHE0dYy2KGOBRzO.png"/></div></div></figure><p id="6150" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是我浏览https://www.espn.com<a class="ae ld" href="https://www.espn.com." rel="noopener ugc nofollow" target="_blank">的截图。</a>你可以看到在客户端Hello中包含了很多信息，包括服务器名称指示扩展——我们看到在底部附近指定了www.espn.com的<a class="ae ld" href="http://www.espn.com" rel="noopener ugc nofollow" target="_blank"/>——它与我的请求的域名相匹配。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi lv"><img src="../Images/9774c05308557c63ec8a4ec7445ccbb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bmrVYCNO9e6VqbUSWTojdg.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">补充说明:如果你仔细观察，你会发现在UDP而不是TCP上运行的HTTP的最新版本QUIC包括TLS握手。但那是未来的博客。</figcaption></figure><p id="3ac3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">web服务器检查每个证书中的所有San，并选择符合请求的San。Web服务器也有一个默认证书，这是它们在没有与请求的SNI扩展相匹配的SAN证书的情况下发布的证书。然而，这通常会导致证书名称不匹配的错误，并且您的浏览器会发出血腥谋杀的尖叫。</p><p id="353b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这释放了负载平衡器和cdn的力量，因为现在它们可以为无限域托管安全流量。它还有助于减少在TLS握手期间传输的证书的大小，因为您现在可以使用较少数量的San来颁发证书。我们说的只是数千字节的数据，但是由于页面加载时间是搜索结果的一个因素($$仍然是最大的因素)，从商业原因和安全角度来看，去除每一点不必要的数据传输是很重要的。</p><h2 id="16cf" class="lw lx it bd ly lz ma dn mb mc md dp me kb mf mg mh kf mi mj mk kj ml mm mn mo bi translated">企业安全如何利用这一点？</h2><p id="410f" class="pw-post-body-paragraph jq jr it js b jt mp jv jw jx mq jz ka kb mr kd ke kf ms kh ki kj mt kl km kn im bi translated"><a class="ae ld" rel="noopener ugc nofollow" target="_blank" href="/cdk-once-more-unto-the-breach-f2673cf219a6">正如我在其他博客</a>中提到的，控制出口流量是企业安全的基础，也是SC-7 中概述的FedRAMP适度基线的<a class="ae ld" href="https://wayfinder.digital/FedRAMP/SC007-FedRAMP.html" rel="noopener ugc nofollow" target="_blank">要求。为了限制暴露于恶意软件，每个安全网络(无论是企业还是政府)都有网络安全控制措施来监控用户和设备，防止他们访问未经授权的网站。将IP地址列入出口白名单是不可行的，因为网站的IP地址一直在变化，尤其是在公共云领域。由于SNI扩展是未加密的，网络防火墙可以检查出站TLS流量的SNI报头，以确定流量是否被允许流出。对于Palo Alto或Fortinet这样的NGFWs，以及AWS网络防火墙都是如此。</a></p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mu"><img src="../Images/662da1eb887ff928e1d89e344b5acafc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GSZ5ftVFQTygpp0h.png"/></div></div></figure><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mv"><img src="../Images/70cf7a1952d80b1204b5cf887c0b3213.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gonLRL-oSLC38ZHR.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated"><a class="ae ld" href="https://aws.amazon.com/blogs/security/hands-on-walkthrough-of-the-aws-network-firewall-flexible-rules-engine/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/security/hands-on-walk-of-the-AWS-network-firewall-flexible-rules-engine/</a></figcaption></figure><h2 id="f9fd" class="lw lx it bd ly lz ma dn mb mc md dp me kb mf mg mh kf mi mj mk kj ml mm mn mo bi translated">隐私呢？</h2><p id="bf6d" class="pw-post-body-paragraph jq jr it js b jt mp jv jw jx mq jz ka kb mr kd ke kf ms kh ki kj mt kl km kn im bi translated">虽然您通过TLS传输的数据将始终被加密(文本消息、登录网站时的用户名和密码、网上购物时的信用卡号等)，但网络窃听者仍然可以了解您的流量。你的DNS请求过去总是不加密的，所以数据包嗅探器总是可以检测到“哦，马特的家庭路由器刚刚对wikileaks.com进行了DNS查询——所以很明显我们知道那栋房子里有人试图访问Wikileaks . com”。但是现在，TLS上的DNS(DoT)和HTTPS上的DNS(DoH)正在解决这个问题，并提供加密DNS流量的方法。然而，SNI报头仍然是未加密的；TLS客户端Hello应该启动发送方和接收方之间的对话，讨论如何对流量进行加密——哪些密钥、哪些算法等。SNI在客户端Hello中被发送——在没有事先协商密钥和加密算法的情况下，如何加密东西？</p><p id="153c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">问题的答案:“总是DNS！！！!"</p><p id="d495" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">TLS 1.3最初通过引入加密SNI(ESNI)提供了一个解决方案。解决方案是在一个特殊的TXT记录中发布一个公钥，发送方用它来加密SNI报头。因此，如果我正在浏览cloudflare.com，我的浏览器最初会发送一个名为_esni.cloudflare.com的TXT记录的DNS查找</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mw"><img src="../Images/f88ec994a2db9314b7a64fb28e00ebc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tzEyWB0PboDt4ehyp8_NrQ.png"/></div></div></figure><p id="f9bc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因为从理论上讲，只有位于以下IP地址的服务器拥有相关的私钥来解密用DNS中公布的公钥加密的数据，所以我们可以确定，没有人能够在中间窥探我们的流量并得知我们去了Cloudflare.com(当然，假设我们也使用DoH或DoT加密DNS请求)</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mx"><img src="../Images/eca455547f335e69d3a0a690f99c592e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ON1yViD4LaXvZUy6Crm98A.png"/></div></div></figure><p id="a21d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然而，你不会再在野外看到太多ESNI，因为它已经发展到加密整个客户端Hello——称为ECH。这个想法是为了最小化窃听者可以从你的流量中得到的信息量——他们仍然可以看到哈希，使用的算法等等。最终，ECH使用与ESNI非常相似的方法，在DNS中以不同的记录类型HTTPS(这是像CNAME一样的实际记录类型)发布密钥。然而，当ECH可用和不可用时，使用ClientHelloInner和ClientHelloOuter的想法增加了一些复杂性。如果您想了解更多相关信息，CloudFlare发布了一篇精彩的博客。</p><p id="f52a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这也增加了企业的复杂性。企业仍然希望监视和控制其网络上的流量。如果SNI报头不再以明文形式发送，他们将不得不依赖完全解密的中间人技术，如SSL转发代理，来检查出口流量——实施和维护这些技术并不有趣——证书实际上是为破解东西而设计的！但即使是这些人，也会和ECH有矛盾。SSL转发代理通常有解密排除列表，您可以在其中列出希望防火墙对流量进行加密的域。当使用mTLS时(mTLS不能被SSL FP解密)以及在敏感域(如银行和医疗)上，您通常会看到这种情况，因为您不希望您的公司防火墙检查该流量。但是如果你不知道一个域是什么，你怎么能把它排除在解密之外呢？</p><p id="8699" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这需要将所有客户端配置为使用预定义的公钥进行所有ECH加密，私钥存储在您的防火墙上。或者只是通过政策完全禁止ECH。</p><h2 id="72f5" class="lw lx it bd ly lz ma dn mb mc md dp me kb mf mg mh kf mi mj mk kj ml mm mn mo bi translated">结论</h2><p id="0680" class="pw-post-body-paragraph jq jr it js b jt mp jv jw jx mq jz ka kb mr kd ke kf ms kh ki kj mt kl km kn im bi translated">正如我们所见，一个更复杂的系统(TLS)的一个小方面(SNI)在本质上常常是分形的。这也证明了在InfoSec中，当你实现一个新特性时，很少有100%成功的；功能几乎总是伴随着权衡——在这种情况下，隐私与安全，这将永远是有趣的，永远是不断发展的。</p></div><div class="ab cl my mz hx na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="im in io ip iq"><p id="2375" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Matthew是领先的AWS网络安全合作伙伴stackArmor的高级解决方案总监，该公司为希望满足合规框架安全要求的客户设计定制解决方案:FedRAMP、NIST 800系列、PCI-DSS、国防部SRG、HIPAA、FISMA、FIPS 140–2(和3)等。StackArmor提供了一个经过AWS审核的解决方案，可以加速FedRAMP ATO的运行并降低40%以上的成本。</p></div></div>    
</body>
</html>