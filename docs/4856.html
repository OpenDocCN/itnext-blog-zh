<html>
<head>
<title>Local Storage for OpenShift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">OpenShift的本地存储</h1>
<blockquote>原文：<a href="https://itnext.io/local-storage-for-openshift-121224daf2d9?source=collection_archive---------4-----------------------#2020-10-07">https://itnext.io/local-storage-for-openshift-121224daf2d9?source=collection_archive---------4-----------------------#2020-10-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/ad44c71d7aea419b2084137018f88cde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*W-t-V4lFc4ZxRmz5.jpg"/></div></div></figure><p id="15d1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">有时出于性能考虑，您可能希望使用本地存储而不是网络存储。<em class="kz">当然，你会失去围绕节点自由移动pod的灵活性。pod将绑定到提供本地存储的节点。</em></p><p id="cfa3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">本文探讨了如何在OpenShift 4.x环境中的不可变操作系统(RHCOS)上添加磁盘和创建文件系统。进一步创建用于容器的持久卷(PV)和存储类。</p><h2 id="1368" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated"><strong class="ak">在RHCOS中创建文件系统</strong></h2><p id="4ec9" class="pw-post-body-paragraph kb kc it kd b ke lt kg kh ki lu kk kl km lv ko kp kq lw ks kt ku lx kw kx ky im bi translated">在工作节点上，让我们添加一个额外的磁盘。我使用KVM，所以第二个磁盘将显示为/dev/vdb。如下所示创建LVM文件系统，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="84f2" class="la lb it md b gy mh mi l mj mk">ssh core@wokernode</span><span id="f8ad" class="la lb it md b gy ml mi l mj mk">sudo pvcreate /dev/vdb<br/>sudo vgcreate vg-disk2 /dev/vdb<br/>sudo lvcreate -n lv-disk2 -l 100%FREE vg-disk2<br/>sudo mkfs.xfs /dev/vg-disk2/lv-disk2</span></pre><p id="0edd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">RHCOS是容器的不可变操作系统，没有/etc/fstab来保存文件系统定义。我们需要创建一个systemd挂载文件，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="5191" class="la lb it md b gy mh mi l mj mk">[Unit]<br/>Before=local-fs.target<br/>[Mount]<br/>What=/dev/vg-disk2/lv-disk2<br/>Where=/var/mnt/disk2<br/>Type=xfs<br/>[Install]<br/>WantedBy=local-fs.target</span></pre><p id="98d4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">将该文件保存在<code class="fe mm mn mo md b">/etc/systemd/system/var-mnt-disk2.mount</code>中，注意文件名遵循核心操作系统挂载文件命名惯例。</p><p id="743d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">启用并安装它，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="4f79" class="la lb it md b gy mh mi l mj mk">sudo systemctl enable var-mnt-disk2.mount<br/>sudo systemctl start var-mnt-disk2.mount<br/>sudo mkdir /var/mnt/disk2/pv1</span></pre><p id="c5e9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在我们已经挂载了本地文件系统/var/mnt/disk2。我创建了一个子目录pv1来保存持久卷。</p><h2 id="0fcd" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">创建本地卷和存储类</h2><p id="f1dc" class="pw-post-body-paragraph kb kc it kd b ke lt kg kh ki lu kk kl km lv ko kp kq lw ks kt ku lx kw kx ky im bi translated">创建PV和各自的存储类，如下图所示:</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="f963" class="la lb it md b gy mh mi l mj mk">apiVersion: v1<br/>kind: PersistentVolume<br/>metadata:<br/>  name: local-pv-woker1-pv1<br/>spec:<br/>  capacity:<br/>    storage: 50Gi<br/>  accessModes:<br/>  - ReadWriteOnce<br/>  persistentVolumeReclaimPolicy: Retain<br/>  volumeMode: Filesystem<br/>  storageClassName: local-pv-woker1-pv1<br/>  local:<br/>    path: /var/mnt/disk2/pv1<br/>  nodeAffinity:<br/>    required:<br/>      nodeSelectorTerms:<br/>      - matchExpressions:<br/>        - key: kubernetes.io/hostname<br/>          operator: In<br/>          values:<br/>          - dev2-worker1.ocp.ibmcloud.io.cpak<br/>---<br/>kind: StorageClass<br/>apiVersion: storage.k8s.io/v1<br/>metadata:<br/>  name: local-pv-woker1-pv1<br/>provisioner: kubernetes.io/no-provisioner<br/>volumeBindingMode: WaitForFirstConsumer</span></pre><p id="3e8b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">nodeAffinity会将卷绑定到工作节点(dev2-worker1)。存储类是这样定义的，我们可以像使用动态存储类一样使用它。与动态存储类的区别在于，PV和它的存储类是一对一的映射。如果您需要第二个PVC，则必须创建一对单独的PV和存储类。</p><p id="0cd6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">只有当pod请求与其一起运行时，卷才会绑定。</p><p id="3398" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">使用PV中定义的nodeAffinity，Kubernetes的调度程序将调度pod在创建本地PV的特定节点上运行。<em class="kz">如果节点关闭，这将影响可用性。</em></p></div></div>    
</body>
</html>