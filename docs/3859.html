<html>
<head>
<title>Understanding delegate in Ruby on Rails</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">理解Ruby on Rails中的委托</h1>
<blockquote>原文：<a href="https://itnext.io/understanding-delegate-in-ruby-on-rails-i-wish-i-knew-before-5edd341bad47?source=collection_archive---------0-----------------------#2020-03-14">https://itnext.io/understanding-delegate-in-ruby-on-rails-i-wish-i-knew-before-5edd341bad47?source=collection_archive---------0-----------------------#2020-03-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="2a66" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本文中，我的重点是解释Ruby on Rails的<code class="fe ko kp kq kr b"><strong class="js iu">delegate</strong></code>方法——它是什么，为什么，以及如何用实际例子来说明。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="gh gi ks"><img src="../Images/b4b04660eecf546285ee482aa999706e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*aiJgazIHw5wY2_Yh.jpg"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">https://www.robcarol.com/effectively-delegate/<a class="ae le" href="https://www.robcarol.com/effectively-delegate/" rel="noopener ugc nofollow" target="_blank"/></figcaption></figure><h1 id="d4ea" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">什么？</h1><p id="c110" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">根据<a class="ae le" href="https://apidock.com/rails/Module/delegatehttps://apidock.com/rails/Module/delegate" rel="noopener ugc nofollow" target="_blank"> API文档</a>【1】—it "<em class="mi">提供了一个</em> <a class="ae le" href="https://apidock.com/rails/Module/delegate" rel="noopener ugc nofollow" target="_blank"> <em class="mi">委托</em> </a> <em class="mi">类方法，可以轻松地将包含对象的公共方法公开为自己的方法。”</em>方法的签名如下—</p><p id="6249" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe ko kp kq kr b"><strong class="js iu">delegate</strong>(*methods, to: nil, prefix: nil, allow_nil: nil)</code> <em class="mi">公共</em></p><p id="a9b7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果使用，这个委托类方法将把属于由<strong class="js iu">指定的目标对象的一组<strong class="js iu">*方法</strong>暴露给。</strong></p><p id="d412" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我将通过一些例子来解释其余的论点。</p><h1 id="53f2" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated"><strong class="ak">为什么？</strong></h1><p id="6a9a" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated"><a class="ae le" href="https://en.wikipedia.org/wiki/Law_of_Demeter" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">德米特里定律</strong></a>【2】或<strong class="js iu">最少知识原则</strong>是一个软件设计指南，根据维基百科，它被总结为—</p><ul class=""><li id="f712" class="mj mk it js b jt ju jx jy kb ml kf mm kj mn kn mo mp mq mr bi translated">每个单元应该只对其他单元有有限的了解:只有与当前单元“密切”相关的单元。</li><li id="9d3f" class="mj mk it js b jt ms jx mt kb mu kf mv kj mw kn mo mp mq mr bi translated">每个单位应该只和自己的朋友说话；不要和陌生人说话。</li><li id="5467" class="mj mk it js b jt ms jx mt kb mu kf mv kj mw kn mo mp mq mr bi translated">只和你最亲近的朋友说话。</li></ul><p id="9576" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Rails中的委托方法通过只暴露包含对象的必要方法来帮助执行这一规则，从而使它们更容易被访问。</p><h1 id="5a8d" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">如何？</h1><p id="3118" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">现在，对于“如何做”部分，我将通过一组示例进行讲解。大多数例子都是从书[3]——“拿我的钱:在网上接受支付”中收集的，但当然是为了本文的目的而编辑的。</p><p id="df91" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">假设我们有两个由has_many关联关联的ActiveRecord模型，如下所示—</p><pre class="kt ku kv kw gt mx kr my mz aw na bi"><span id="61e8" class="nb lg it kr b gy nc nd l ne nf">class Event &lt; ActiveRecord::Base<br/>  has_many :performances<br/>end</span><span id="6c01" class="nb lg it kr b gy ng nd l ne nf">class Performance &lt; ActiveRecord::Base<br/>  belongs_to :event<br/>end</span></pre><p id="aca2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我将启动<strong class="js iu"> rails控制台</strong>并检查这两个模型的成员—</p><blockquote class="nh ni nj"><p id="7cdf" class="jq jr mi js b jt ju jv jw jx jy jz ka nk kc kd ke nl kg kh ki nm kk kl km kn im bi translated">[3]撬(主)&gt;事件。<strong class="js iu">列名</strong> <br/> = &gt; ["id "，"名称"，"描述"，"图像url "，"创建时间"，"更新时间"]</p><p id="728c" class="jq jr mi js b jt ju jv jw jx jy jz ka nk kc kd ke nl kg kh ki nm kk kl km kn im bi translated">[4]撬(主)&gt;性能。<strong class="js iu">column _ names</strong><br/>=&gt;[" id "，" event_id "，" start_time "，" end_time "，" created_at "，" updated_at"]</p></blockquote><p id="8224" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在要从<strong class="js iu">性能</strong>对象<strong class="js iu">、</strong>中访问一个<strong class="js iu">事件</strong>对象的名称和描述，我们通常可以这样做</p><blockquote class="nh ni nj"><p id="3a5a" class="jq jr mi js b jt ju jv jw jx jy jz ka nk kc kd ke nl kg kh ki nm kk kl km kn im bi translated">性能=性能.查找(459352183)</p><p id="977a" class="jq jr mi js b jt ju jv jw jx jy jz ka nk kc kd ke nl kg kh ki nm kk kl km kn im bi translated">[8]撬(主)&gt;性能。<strong class="js iu"> event.name </strong> <br/> = &gt;"漂白剂流浪者"</p><p id="39f7" class="jq jr mi js b jt ju jv jw jx jy jz ka nk kc kd ke nl kg kh ki nm kk kl km kn im bi translated">[9]撬(主)&gt;性能。<strong class="js iu">event . description</strong><br/>=&gt;“一部关于露天看台流浪汉的戏”</p></blockquote><p id="5845" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，我们在这里浏览<strong class="js iu">:事件</strong>关联。</p><p id="f43a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是如果我们使用<strong class="js iu">委托</strong>方法，我们可以更方便地公开<strong class="js iu">名称</strong>和<strong class="js iu">描述</strong>方法。让我们修改我们的<strong class="js iu">性能</strong>模型来做到这一点。</p><pre class="kt ku kv kw gt mx kr my mz aw na bi"><span id="ea91" class="nb lg it kr b gy nc nd l ne nf">class Performance &lt; ApplicationRecord<br/>  belongs_to :event<br/>  <br/>  delegate :name, :description, to: :event<br/>end</span></pre><p id="fa9b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，我已经暴露了<strong class="js iu">名称</strong>和<strong class="js iu">描述<strong class="js iu">事件</strong>对象的</strong>方法，好像它们属于<strong class="js iu">性能</strong>对象。从rails控制台，现在我们可以访问<strong class="js iu">事件的</strong>名称和描述，如下所示—</p><blockquote class="nh ni nj"><p id="9f61" class="jq jr mi js b jt ju jv jw jx jy jz ka nk kc kd ke nl kg kh ki nm kk kl km kn im bi translated">[10]pry(main)&gt; performance . name<br/>=&gt;"漂白剂Bums "</p><p id="f266" class="jq jr mi js b jt ju jv jw jx jy jz ka nk kc kd ke nl kg kh ki nm kk kl km kn im bi translated">【11】撬(主)&gt;性能描述<br/> = &gt;《一出关于露天看台流浪汉的戏》</p></blockquote><p id="cdf8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们不再需要通过<strong class="js iu">:事件</strong>关联。</p><p id="9890" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是如果<strong class="js iu">性能</strong>模型本身有一个<strong class="js iu">名为</strong>的方法呢？这就是<strong class="js iu">前缀</strong>的作用。那样的话，我可以修改<strong class="js iu">的性能</strong>模型——</p><pre class="kt ku kv kw gt mx kr my mz aw na bi"><span id="d0b9" class="nb lg it kr b gy nc nd l ne nf">class Performance &lt; ApplicationRecord <br/>  belongs_to :event<br/><br/>  delegate :name, :description, to: :event, <strong class="kr iu">prefix: true</strong></span><span id="a89c" class="nb lg it kr b gy ng nd l ne nf"><strong class="kr iu">  def name<br/>    "performance"<br/>  end</strong><br/>end</span></pre><p id="d9e1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果我们指定<strong class="js iu">前缀:true，</strong>我们可以访问<strong class="js iu">性能的</strong>名称和<strong class="js iu">事件的</strong>名称，如下所示—</p><blockquote class="nh ni nj"><p id="a945" class="jq jr mi js b jt ju jv jw jx jy jz ka nk kc kd ke nl kg kh ki nm kk kl km kn im bi translated">[21]撬(主)&gt;性能。<strong class="js iu">名称</strong> <br/> = &gt;【性能】</p><p id="b4f2" class="jq jr mi js b jt ju jv jw jx jy jz ka nk kc kd ke nl kg kh ki nm kk kl km kn im bi translated">[22]撬(主)&gt;性能<strong class="js iu">。event_name </strong> <br/> = &gt;"漂白剂流浪者"</p></blockquote><p id="016b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我可以进一步指定我们想要的前缀，如下所示—</p><pre class="kt ku kv kw gt mx kr my mz aw na bi"><span id="8821" class="nb lg it kr b gy nc nd l ne nf">class Performance &lt; ApplicationRecord<br/>  belongs_to :event<br/>  <br/>  delegate :name, :description, to: :event, <strong class="kr iu">prefix: :show</strong><br/>end</span></pre><p id="6d1b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通过指定前缀，我们可以访问<strong class="js iu">事件</strong>的名称和描述，如下所示—</p><blockquote class="nh ni nj"><p id="4db9" class="jq jr mi js b jt ju jv jw jx jy jz ka nk kc kd ke nl kg kh ki nm kk kl km kn im bi translated">[25]撬(主)&gt;性能。<strong class="js iu">显示</strong>_名称<br/> = &gt;“漂白布”</p><p id="3cd6" class="jq jr mi js b jt ju jv jw jx jy jz ka nk kc kd ke nl kg kh ki nm kk kl km kn im bi translated">[26]撬(主)&gt;性能。<strong class="js iu">秀</strong>_描述<br/> = &gt;“一部关于露天看台流浪汉的戏”</p></blockquote><p id="7511" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果由<strong class="js iu">到</strong>指定的对象是<strong class="js iu"> nil </strong>，它将引发一个异常，如下所示—</p><pre class="kt ku kv kw gt mx kr my mz aw na bi"><span id="fc0e" class="nb lg it kr b gy nc nd l ne nf">class Performance &lt; ApplicationRecord<br/> <br/>  belongs_to :event<br/><br/>  delegate :name, :description, to: :event<br/>end</span></pre><blockquote class="nh ni nj"><p id="2979" class="jq jr mi js b jt ju jv jw jx jy jz ka nk kc kd ke nl kg kh ki nm kk kl km kn im bi translated">[33]pry(main)&gt; performance . new . event<br/>=&gt;<strong class="js iu">nil</strong></p><p id="3d88" class="jq jr mi js b jt ju jv jw jx jy jz ka nk kc kd ke nl kg kh ki nm kk kl km kn im bi translated">[34]pry(main)&gt; Performance . new . name<br/><strong class="js iu">Module::delegateion error</strong>:Performance # name委托给event.name，但event为零:# &lt; Performance id: nil，event_id: nil，start_time: nil，end_time: nil，created_at: nil，updated_at: nil &gt;</p></blockquote><p id="1507" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我收到了一个<strong class="js iu">模块::DelegationError </strong>。为了抑制这个错误并得到一个<strong class="js iu"> nil </strong>响应，我可以使用下面的<strong class="js iu"> allow_nil </strong>参数—</p><pre class="kt ku kv kw gt mx kr my mz aw na bi"><span id="f5d0" class="nb lg it kr b gy nc nd l ne nf">class Performance &lt; ApplicationRecord<br/> <br/>  belongs_to :event<br/>  <br/>  delegate :name, :description, to: :event, <strong class="kr iu">allow_nil: true</strong><br/>end</span></pre><blockquote class="nh ni nj"><p id="a58f" class="jq jr mi js b jt ju jv jw jx jy jz ka nk kc kd ke nl kg kh ki nm kk kl km kn im bi translated">[36]pry(main)&gt; performance . new . name<br/>=&gt;<strong class="js iu">nil</strong></p></blockquote><p id="22b2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">顺便提一下，如果接收对象是<strong class="js iu"> not nil </strong>但是方法不存在，我们将收到如下的<strong class="js iu"> NoMethodError </strong></p><pre class="kt ku kv kw gt mx kr my mz aw na bi"><span id="0669" class="nb lg it kr b gy nc nd l ne nf">class Performance &lt; ApplicationRecord<br/><br/>  belongs_to :event<br/><br/>  delegate :name, :description, <strong class="kr iu">:time</strong>, to: :event, allow_nil: true<br/>end</span></pre><p id="9182" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">[43]撬(主)&gt;性能。<strong class="js iu">时间</strong> <br/> <strong class="js iu"> NoMethodError:未定义的# &lt;事件的方法“时间”:0x007fd776780730 &gt; </strong></p><h1 id="6f4d" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">一个更实际的例子</h1><p id="6572" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">下面的节选也来自这本书[3] —</p><pre class="kt ku kv kw gt mx kr my mz aw na bi"><span id="d028" class="nb lg it kr b gy nc nd l ne nf">class StripeToken<br/><br/>  attr_accessor :credit_card_number, :expiration_month, :expiration_year, :cvc<br/><br/>  def initialize(credit_card_number:, expiration_month:, expiration_year:, cvc:)<br/>    @credit_card_number = credit_card_number<br/>    @expiration_month = expiration_month<br/>    @expiration_year = expiration_year<br/>    @cvc = cvc<br/>  end<br/><br/>  def token<br/>    @token ||= Stripe::Token.create(<br/>      card: {<br/>        number: credit_card_number, exp_month: expiration_month,<br/>        exp_year: expiration_year, cvc: cvc})<br/>  end<br/><br/>  delegate :id, to: :token<br/><br/>  def to_s<br/>    "STRIPE TOKEN: #{id}"<br/>  end<br/><br/>  def inspect<br/>    "STRIPE TOKEN #{id}"<br/>  end<br/>end</span></pre><p id="4193" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这里，我试图创建一个条带令牌对象。delegate命令将<strong class="js iu"> id </strong>转换为<strong class="js iu"> token.id </strong>。让我们在rails控制台上体验一下—</p><blockquote class="nh ni nj"><p id="68e2" class="jq jr mi js b jt ju jv jw jx jy jz ka nk kc kd ke nl kg kh ki nm kk kl km kn im bi translated">[102]pry(main)&gt; stripe token . new(credit _ card _ number:" 424242424242 "，expiration_month: 12，expiration_year: 2020，cvc: 111) <strong class="js iu">。id</strong><br/>=&gt;" Tok _ 1 gmrobbn 4 gtwm 2 epi 6 ody kka "</p></blockquote><p id="58ea" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">id委托提供了一种直接访问令牌id的好方法。从上面的代码可以看出，我可以很容易地使用<strong class="js iu"> id </strong>委托来定义方便的<strong class="js iu"> to_s </strong>和<strong class="js iu"> inspect </strong>方法。从rails控制台—</p><blockquote class="nh ni nj"><p id="3cb2" class="jq jr mi js b jt ju jv jw jx jy jz ka nk kc kd ke nl kg kh ki nm kk kl km kn im bi translated">[103]pry(main)&gt; stripe token . new(credit _ card _ number:" 424242424242 "，expiration_month: 12，expiration_year: 2020，cvc: 111)。<strong class="js iu">to _ s</strong><br/>=&gt;" STRIPE TOKEN:Tok _ 1 gmrquebn 4 gtwm 2 epbdehwfud "</p><p id="ae40" class="jq jr mi js b jt ju jv jw jx jy jz ka nk kc kd ke nl kg kh ki nm kk kl km kn im bi translated">[104]pry(main)&gt; stripe token . new(credit _ card _ number:" 424242424242 "，expiration_month: 12，expiration_year: 2020，cvc: 111)。<strong class="js iu">inspect</strong><br/>=&gt;" STRIPE Tok _ 1 gmrqkbn 4 gt WM 2 epu qbcp 55 o "</p></blockquote><p id="4e3c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本文中，我试图阐明Rail的<strong class="js iu">委托</strong>方法，以及读者如何将它付诸实际使用。我希望至少对某些人来说是愉快的:)</p><p id="7259" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mi">更多详细和深入的未来技术帖子请关注我这里或</em> <a class="ae le" href="https://twitter.com/meraj_enigma" rel="noopener ugc nofollow" target="_blank"> <em class="mi">推特</em> </a> <em class="mi">。</em></p><h1 id="5f5a" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">参考资料:</h1><ol class=""><li id="061d" class="mj mk it js b jt md jx me kb nn kf no kj np kn nq mp mq mr bi translated"><a class="ae le" href="https://apidock.com/rails/Module/delegate" rel="noopener ugc nofollow" target="_blank">https://API dock . com/rails/Module/delegate https://API dock . com/rails/Module/delegate</a></li><li id="0a34" class="mj mk it js b jt ms jx mt kb mu kf mv kj mw kn nq mp mq mr bi translated"><a class="ae le" href="http://en.wikipedia.org/wiki/Law_of_Demeter" rel="noopener ugc nofollow" target="_blank">http://en.wikipedia.org/wiki/Law_of_Demeter</a></li><li id="5f18" class="mj mk it js b jt ms jx mt kb mu kf mv kj mw kn nq mp mq mr bi translated"><a class="ae le" href="https://www.amazon.com/Take-My-Money-Accepting-Payments/dp/1680501992" rel="noopener ugc nofollow" target="_blank">https://www . Amazon . com/Take-My-Money-Accepting-Payments/DP/1680501992</a></li></ol></div></div>    
</body>
</html>