<html>
<head>
<title>Multicluster-Scheduler and Argo (Workflows and CD): a Deep Dive</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">多集群调度器和Argo(工作流和CD):深入探讨</h1>
<blockquote>原文：<a href="https://itnext.io/multicluster-scheduler-argo-workflows-across-kubernetes-clusters-ea98016499ca?source=collection_archive---------0-----------------------#2020-04-09">https://itnext.io/multicluster-scheduler-argo-workflows-across-kubernetes-clusters-ea98016499ca?source=collection_archive---------0-----------------------#2020-04-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/b51c66cf2bc733b81f0bf35f4d7f88d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dXE4qUoj-ueogLywCDYXMA.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">多集群调度—跨Kubernetes集群的智能调度</figcaption></figure><div class=""/><p id="863e" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">合著者:<a class="la lb ep" href="https://medium.com/u/a6d36eaaf61e?source=post_page-----ea98016499ca--------------------------------" rel="noopener" target="_blank">阿德里安·特罗伊劳</a></p><p id="798d" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">无论环境如何，在多个不同的Kubernetes集群上进行部署和管理的能力是支持多集群和多云平台的关键特性。联合将多集群管理的概念向前推进了一步，引入了通过主机集群中的单个API管理主配置的功能，并将该配置的全部或部分应用于作为联合成员的任何集群。</p><p id="9dbe" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">有多种方法可以在集群之间实现联合。例如，<a class="ae lc" href="https://github.com/kubernetes-sigs/kubefed" rel="noopener ugc nofollow" target="_blank"> Kubefed v2 </a>和<a class="ae lc" href="https://github.com/bookingcom/shipper" rel="noopener ugc nofollow" target="_blank"> Shipper </a>通过使用自定义资源定义向集群公开新资源来实现集群联合。另一方面，Multicluster-scheduler以基本单元pod为目标，不需要任何其他特定于联邦的配置。Multicluster-scheduler使用virtual-kubelet提供者(virtual kubelet提供了一个可插拔的提供者接口，开发人员可以实现该接口来定义典型kubelet的操作)来调度远程集群上的pods。</p><p id="465b" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><a class="ae lc" href="https://github.com/admiraltyio/multicluster-scheduler" rel="noopener ugc nofollow" target="_blank">海军部的多集群调度程序</a>将自身注入标准Kubernetes生命周期(变异的pod许可webhooks)并拦截所有创建带有特定注释的pod的调用，以创建一个额外的pod以及一个在虚拟kubelet上调度的名为proxy pod(占位符pod，它不做太多事情)的原始pod。原始Pod经过另一轮调度，其中在询问整个拓扑之后做出放置决定。</p><p id="7f73" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Multicluster-scheduler可以跨Kubernetes集群运行Argo工作流，而无需任何额外的平台更改。用户可以将窗格委派到资源可用的地方，或者由用户指定。并行工作流可以更快地运行，而不必横向扩展集群，并且它简化了多区域和多云ETL流程。这种集成可以很容易地与Argo耦合，因为Argo前端不需要任何更改。</p><h1 id="1b82" class="ld le jf bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">多集群调度程序</h1><p id="b6ee" class="pw-post-body-paragraph kc kd jf ke b kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz ij bi translated"><a class="ae lc" href="https://github.com/admiraltyio/multicluster-scheduler" rel="noopener ugc nofollow" target="_blank"> Multicluster-scheduler </a>是一个Kubernetes控制器系统，可以智能地跨集群调度工作负载。使用virtual-kubelet provider的Multicluster-scheduler将选出的pods转变为在一个<a class="ae lc" href="https://virtual-kubelet.io/" rel="noopener ugc nofollow" target="_blank"> virtual-kubelet </a>(一个<a class="ae lc" href="https://kubernetes.io/docs/reference/generated/kubelet/" rel="noopener ugc nofollow" target="_blank"> Kubernetes kubelet </a>的实现，它伪装成一个将Kubernetes集群连接到其他API的kubelet)上调度的代理pods，并在远程集群(实际运行的容器)中创建代理pods。</p><p id="ef93" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">反馈循环更新代理窗格的状态和注释，以反映代理窗格的状态和注释。目标群集中的代理负责创建委派窗格。代理pod与原始pod具有相同的规格。代理pod是基于拓扑分布的，它们可以跨集群分布，如果代理部署在主集群上，则它可以将代理pod与代理一起保存。</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mg"><img src="../Images/01babf177830ef8ac541e19341bd7c8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*g-Tyf8um_iIZRNUU"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">多集群调度器— Kubernetes</figcaption></figure><p id="fea9" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">当工作负载用“<em class="ml">multicluster.admiralty.io/elect</em>注释时，多集群调度器使用<a class="ae lc" href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/" rel="noopener ugc nofollow" target="_blank">变异pod准入webhooks </a>来拦截调用并创建一个虚拟pod。实际pod被变异为在虚拟kubelet节点上调度的'<em class="ml">代理pod</em>'(<a class="ae lc" href="https://godoc.org/admiralty.io/multicluster-scheduler" rel="noopener ugc nofollow" target="_blank">提供者实现</a>)并在成员集群中创建相应的“代理pod”。代理窗格是不请求内存或cpu的虚拟窗格，反映了代理窗格(实际功能容器)的状态和注释。</p><p id="4076" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">代理pod将源pod配置存储在一个注释中。当委托窗格被注释时，相同的注释被反馈给代理窗格。</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/ee87070070faccb7f9649e5e5f7dac9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FSn8oPai3tOShor3"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">邻近脚模型和突变</figcaption></figure><h1 id="6c7c" class="ld le jf bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">试用</h1><p id="4624" class="pw-post-body-paragraph kc kd jf ke b kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz ij bi translated">创建了不同区域的三个Kubernetes集群。其中一个集群'<em class="ml"> cluster-atlanta </em>'是主调度器集群(包含多集群调度器)，而'<em class="ml"> cluster-seattle </em>'、'<em class="ml"> cluster-dallas </em>'是成员集群(包含多集群调度器代理)。由于一些或所有的代表pods被安排在不同的集群上，因此服务需要将流量路由到它们。</p><p id="7634" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Cilum集群网格和全局服务可以跨集群执行全局路由。以代理pod为目标的服务被重新路由到其代理，跨集群复制，multicluster-scheduler将使用'<em class="ml">io.cilium/global-service=true'</em>注释服务，并跨集群复制服务，集群将在Cilium集群网格中实现负载平衡。</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/1b094c9c42f158bf2f0986fb56852a98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3WHrgtZPkm1Vuvrm"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">多集群/多区域拓扑</figcaption></figure><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mn"><img src="../Images/6fd766c30a7830db9415669ce6d6cb7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rjNbVOERIm6R-TdN"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">具有纤毛簇网格的多簇拓扑</figcaption></figure><p id="14be" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">主调度程序集群包含多集群调度程序，代理也可以与调度程序一起部署在同一个集群上。在上面的拓扑中，‘<em class="ml">集群——Atlanta</em>’充当主集群:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/68034de5e46329c516e1f749a49ee4a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Mn9qz5vJbBz0-WYi"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">集群上的多集群调度程序和代理-atlanta</figcaption></figure><p id="7e60" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">当multicluster-scheduler与实际的Kubernetes节点一起部署在集群上时，会创建一个虚拟的kubelet节点。</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/3194d6b186f83baac3e78286347fff4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SXRs0OwB5X4dyQ0N"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">由多集群调度程序创建的虚拟Kubelet节点</figcaption></figure><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/8214616e7f7d8b0e11daafca4792db42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yDmg9puMrCQ9LPy2"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">由多集群调度程序创建的虚拟Kubelet节点</figcaption></figure><p id="db54" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如上图所示，cluster-atlanta包含一个名为admiralty的虚拟kubelet节点。</p><p id="0f07" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">主集群上的multicluster-scheduler应该能够与成员集群的Kubernetes API服务器对话。服务帐户令牌作为kubeconfig文件从成员集群中提取，并作为机密保存在调度程序的集群中。</p><p id="5205" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">海军部的<a class="ae lc" href="https://github.com/admiraltyio/multicluster-service-account" rel="noopener ugc nofollow" target="_blank">多集群服务账户</a>，多集群工具包的一部分，使用户能够调用其他集群的Kubernetes APIs，并将远程服务账户令牌导入本地机密，并自动将它们挂载到注释窗格中。</p><p id="0bc2" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">作为主群集的cluster-atlanta包含cluster-dallas和cluster-seattle的服务帐户，如下所示:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/26a07e798d112115d75fbb1a783fc148.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JXilZIy0mifu-nac"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">使用MCSA导出为机密的成员集群的服务帐户</figcaption></figure><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/ddeb9f85b3fb94fce73af294c80d849c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cPi0FjNIFuYDCJza"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">作为Kubernetes秘密的成员集群的服务帐户</figcaption></figure><p id="bd74" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">装载到多集群调度程序部署的配置映射保存如下所示的机密信息:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/fda2315703f4dc8fa1beea7eb273d03a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ptbZwTtwGnhZ07q9"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">具有服务帐户信息的计划程序配置映射</figcaption></figure><p id="7814" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">除了服务帐户之外，所有成员集群都使用邀请加入主集群。邀请在以被邀请的集群命名的用户之间创建(集群)角色绑定，例如admiralty:cluster-seattle和multi cluster-scheduler-agent-for-cluster集群角色。调度程序模拟在代表被邀请的集群创建/更新/删除代表pod和服务时创建的用户。</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/2c148cb8c2189118c2874b2edd05dc40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PMLwwq_6rWkJk01k"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">为所有集群用户创建的集群角色</figcaption></figure><p id="d2d1" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在三个集群上部署了multicluster-scheduler和代理后，创建了一个nginx部署，其中包含五个副本和注释:在一个成员集群“cluster-seattle”上的“<em class="ml">multicluster.admiralty.io/elect</em>”:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/3b5db8a1f546095c70cb575bb89961f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vEUhmc0ecSsW78mD"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">启用多集群调度的Pod注释</figcaption></figure><p id="659c" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">此配置在virtual-kubelet节点上调度的cluster2-seattle上启动五个代理pod:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/5439b9dece80eabddb2fa545bc8fd8a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hwvpqWx2BefeM-QP"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">虚拟Kubelet节点上调度的代理pod</figcaption></figure><p id="9690" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如下面的代理pod配置所示，每个代理pod都将引用在其他成员群集中运行的代理pod清单，因为代理pod反映了代理pod(实际运行的容器)的规范。下面，pod规范包含指定delegate-pod集群和sourcepod清单的注释:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/38f189ac6336cfc1c401a08103d8dacd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9xJBDv7p8-u9n104"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">代理窗格-&gt;代理窗格引用</figcaption></figure><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mo"><img src="../Images/c2069a153c0db01d7094d50c93d55406.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*A3lX3cYbzepVjmOe"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">将sourcepod-manifest作为注释的代理pod</figcaption></figure><p id="5bc0" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">三个委派单元(nginx副本)安排在亚特兰大群集上，另外两个安排在达拉斯群集上:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/13231a03894c6de2fe258fea48ecbd28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ej77p6sRYhxPMudX"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">在cluster-seattle上创建的代理pod以及cluster-atlanta和cluster-dallas上相应的代理pod</figcaption></figure><p id="3f3d" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如上所示，成员集群atalanta和dallas上的delegate pods是在Kubernetes节点上调度的，因为这些是实际的运行/功能容器。每个delegate-pod配置都包含到parent-uid(代理pod uid)和控制器引用的映射，如下所示。</p><p id="8f8d" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在Kubernetes节点“cluster1-atlanta”上安排了“cluster-atlanta”上的三个复制副本(委派窗格)(所有三个集群都是具有一个节点的AIO Kubernetes集群)。</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/efb3ee38abdbcc3cdd2160f0a9095e69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vX_rdv-YZC95mt2o"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">在cluster-atlanta上创建的委派窗格(因为它包括调度程序和代理)</figcaption></figure><p id="941f" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如下所示，cluster-atlanta上的所有代理窗格都包含一个标签，该标签引用cluster-seattle上运行的父窗格(代理窗格)。</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/f8a22e716d1d1c38c99dc74e48f7d559.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zXwsZSHhyfdVP1nj"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">委托窗格-&gt;代理窗格父-uid映射</figcaption></figure><p id="18fe" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">注释“multi cluster . admiralty . io/controller-reference”包括映射信息(代表pod — -&gt;代理pod)。</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mq"><img src="../Images/9579d7e93d525bcc332ca74bf5ec4062.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vK1upBrRDmNk1v59"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">代理pod控制器-引用映射到代理pod</figcaption></figure><p id="d32f" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如上所示，运行在cluster-atlanta上的代理pod nginx-5466*包含运行在cluster-seattle上的代理pod nginx-5466*的父uid。</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/a5f41137209cf565b24ba50e9947b19e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nZ_FSgTcaYcPpJkg"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">代理pod控制器-引用映射到代理pod</figcaption></figure><h1 id="476b" class="ld le jf bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">强制放置—特定于群集的调度</h1><p id="08f0" class="pw-post-body-paragraph kc kd jf ke b kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz ij bi translated">Multicluster-scheduler便于用户指定目标集群，而不是让调度程序来决定。可以使用<em class="ml">' multi cluster . admiralty . io/cluster name '</em>注释来执行放置。</p><p id="608f" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">部署Nginx部署时，clustername注释映射到clustername: cluster3-dallas，作为cluster2-seattle中的目标集群:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mr"><img src="../Images/63cd8fcfbd9cd4758cae5bb2141e0429.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2XHkqFDjVDMAdbVJ"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">在pod注释中使用clustername强制放置</figcaption></figure><p id="8ca3" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">该配置在cluster3-dallas上创建了所有五个代理pod(运行容器),并且在cluster2-seattle上创建了所有五个代理pod。</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/011ce7bda2689c92676e634767570fca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*19U0V6WGl2Nl5QxJ"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">强制放置-在集群上创建所有代理窗格-dallas</figcaption></figure><p id="8ac4" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">集群2上的代理pods西雅图:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/56a190e28445a886ae39ac5295d6d8ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Blnus-Q4bAOEcG8Y"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">集群上的代理pods西雅图</figcaption></figure><p id="dec8" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">集群3上的代表舱-达拉斯:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/349f37c43d1bb2c963328d9d5bef6cc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QNkG8L_T3HGr7NfR"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">集群上的代表窗格-达拉斯</figcaption></figure><h1 id="4052" class="ld le jf bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">跨集群的Argo工作流</h1><p id="1e66" class="pw-post-body-paragraph kc kd jf ke b kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz ij bi translated">Argo向Kubernetes添加了一个名为工作流的新对象。说得好听一点，工作流是“步骤”的<a class="ae lc" href="https://en.wikipedia.org/wiki/Directed_acyclic_graph" rel="noopener ugc nofollow" target="_blank">有向无环图</a>。Multicluster-scheduler允许用户在工作流配置中配置pod注释，以指示pod应该在哪个集群中运行，同样，使用单个pod模板注释。在许多情况下，当与Argo结合使用时，多集群调度程序可以发挥重要作用，其中一些情况如下:</p><ol class=""><li id="e7da" class="ms mt jf ke b kf kg kj kk kn mu kr mv kv mw kz mx my mz na bi translated">在异构集群/环境中从中央Argo集群部署和管理工作流，而无需在远程集群中使用Argo。</li><li id="520b" class="ms mt jf ke b kf nb kj nc kn nd kr ne kv nf kz mx my mz na bi translated">大型并行工作流可以在多个群集上运行，保持并行性，其中每个步骤都可以利用单个群集的资源来更快地执行，而不是使用单个群集的资源来执行工作流的所有步骤。</li><li id="7b0a" class="ms mt jf ke b kf nb kj nc kn nd kr ne kv nf kz mx my mz na bi translated">需要特殊资源能力(如用于机器学习训练管道的GPU)的工作流的特定步骤可以针对具有资源的成员集群。</li><li id="530f" class="ms mt jf ke b kf nb kj nc kn nd kr ne kv nf kz mx my mz na bi translated">工作流可以在多个容量较低的较小集群上运行，从而消除了在单个集群中拥有高成本实例的需求。</li><li id="b734" class="ms mt jf ke b kf nb kj nc kn nd kr ne kv nf kz mx my mz na bi translated">用户可以选择特定的环境，在该环境中，工作流合并来自多个云或区域的数据。要么更有效，要么需要在离数据源更近的地方运行一些步骤。</li><li id="1906" class="ms mt jf ke b kf nb kj nc kn nd kr ne kv nf kz mx my mz na bi translated">必须在多个边缘位置上运行的边缘工作流可以从中央集群进行管理，而不必在资源节约的环境(边缘站点)中安装其他组件</li><li id="164f" class="ms mt jf ke b kf nb kj nc kn nd kr ne kv nf kz mx my mz na bi translated">如果集群耗尽了资源，那么向外扩展会容易得多。</li></ol><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/8625988029e06264b62b7d1f97e67c56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*a99mq5y_GP0urlXy"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">使用多集群调度程序跨Kubernetes集群的Argo工作流</figcaption></figure><p id="6a5b" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在上面的拓扑中，cluster-atlanta部署了argo工作流控制器，其他两个集群是非Argo集群，部署了多集群调度程序代理。</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/c1a9214778751aa0899cabe2d6fc606c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GwMbtFqv7zi4sGnY"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">部署在群集上的Argo服务器-亚特兰大</figcaption></figure><h1 id="e58b" class="ld le jf bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">跨集群运行示例并行嵌套DAG</h1><p id="e80e" class="pw-post-body-paragraph kc kd jf ke b kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz ij bi translated">以下示例在外部DAG上运行并行工作流，并限制同时运行的其子DAG的数量。A的并行度为2，三个DAG中只有两个(b2，b3，b4)会在b1完成后开始运行，左边的DAG会在其中一个完成后运行。</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ng"><img src="../Images/ea8880727ea10065384e37617fd4248a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qUeT0FtjzmhGB3EP"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">示例Argo DAG工作流-跨集群运行</figcaption></figure><p id="e28b" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">工作流模板配置有注释:“multi cluster . admiralty . io/elect”以启用多集群调度:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nh"><img src="../Images/819d01e2fe7c0b4ec0d071c66da7f420.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FcGscolPJw6tFlEK"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">带有多集群计划窗格注释的工作流清单</figcaption></figure><p id="878e" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">工作流需要14个pod才能完成，工作流从开始到完成如下所示:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ni"><img src="../Images/19b29d05f8c8b149d71482ab732d9572.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6q7oxmO8rVdeG38n"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">示例DAG —工作流执行—在多个集群上运行</figcaption></figure><p id="8d6f" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">工作流程由Argo集群提交:亚特兰大集群。所有代理窗格都是在cluster-atlanta上创建的，此外还有四个工作流委派窗格(执行工作流的实际运行容器):</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nj"><img src="../Images/d9ec0902bca6272d1bdb4179a63c6981.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1Qv683a41CHBjbnL"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">在群集-atlanta上创建的代理工作流窗格</figcaption></figure><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nk"><img src="../Images/6229a5d2515f4b638523851836bc7656.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PthxZbA_62VySmzI"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">虚拟Kubelet上安排的代理工作流窗格和实际Kubernetes节点上的委托窗格</figcaption></figure><p id="1c11" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如上所示，所有工作流代理窗格都在virtual-kubelet:admiralty上安排，而工作流代表窗格则在实际的Kubernetes节点上安排。代理窗格执行工作流，如下所示:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/1e2455a78f9fedcff56edab77f7e09ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ieoqFXFrZc39-fz5"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">执行工作流的委派窗格</figcaption></figure><p id="191a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在cluster-seattle上安排了四个工作流委派单元，在cluster-dallas上安排了另外六个工作流委派单元:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/3dbd0ec0ee88bab3f3dc697c2e51caad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ipN2WhW6dF71oAq1"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">群集上的代理工作流窗格-西雅图</figcaption></figure><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/12e995e3b2c55bda1aad44c616a899cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nIpk-0RvHju5S344"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">集群上的代理工作流窗格-dallas</figcaption></figure><h1 id="a035" class="ld le jf bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">在目标群集中运行特定的工作流步骤</h1><p id="0bb5" class="pw-post-body-paragraph kc kd jf ke b kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz ij bi translated">使用<em class="ml">' multi cluster . admiralty . io/cluster name '</em>标注工作流中的特定步骤可以在成员集群上运行。以特定集群为目标使用户能够从安装了Argo的中央集群在远程站点/边缘站点上运行和操作工作流。</p><p id="3de2" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">具有简单DAG工作流的示例场景，其中步骤A和C可以在cluster-atlanta中运行，但是步骤B必须在cluster-dallas中运行；步骤C依赖于步骤A和b。工作流模板提供了multicluster.admiralty.io/clustername pod模板注释以实施放置。</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nl"><img src="../Images/c2593c23dcbe88cb3fcb9aba5a44c8a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*j-7Ab_rL-GLnRd_1"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">目标集群上的多步DAG工作流示例</figcaption></figure><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nm"><img src="../Images/61d57b7b3b5fef3485a97fabf8628553.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*X9DnuSB_xSDe80sC"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">使用pod注释(clustername)在特定集群上强制放置特定步骤</figcaption></figure><p id="b3b8" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如下所示，工作流需要三个窗格来执行:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nn"><img src="../Images/998d43060bf82c796566517205da23d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xKkW3ALXPmZ5CZqU"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">示例DAG —工作流执行—在特定集群上运行特定步骤</figcaption></figure><p id="de82" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">工作流程由Argo集群提交:亚特兰大集群。在cluster-atlanta的Kubernetes节点上创建了两个执行步骤A和C的工作流委托窗格，并为cluster-dallas上执行步骤b的委托窗格创建了一个代理窗格</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi no"><img src="../Images/a84e55b19064ef5051e2ca50d9d0847d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*g4ca5_F5vj8imnTm"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">达拉斯群集上的代理工作流窗格和亚特兰大群集上的代理窗格</figcaption></figure><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/a13b8447b6913ccdbe97182710f9b63b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*74xSccGyRp1uAVYL"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">达拉斯群集上的代理工作流窗格和亚特兰大群集上的代理窗格</figcaption></figure><h1 id="c16a" class="ld le jf bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">Argo CD —使用多集群调度程序在远程集群上停止</h1><p id="2b3a" class="pw-post-body-paragraph kc kd jf ke b kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz ij bi translated"><a class="ae lc" href="https://github.com/argoproj/argo-cd" rel="noopener ugc nofollow" target="_blank"> Argo CD </a>是GitOps处理部署的方式，这意味着git存储库是事实的单一来源，配置的Kubernetes集群镜像来自这些存储库的一切。这属于Argo项目，以及Argo工作流和Argo事件。</p><p id="05f8" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">工作流提供了一种部署作业的方法，而对于传统的应用程序部署和连续交付，Argo CD提供了一个接口。在传统设置中，用户可以在提交部署时使用上下文，或者Argo CD允许配置多个集群及其端点以针对特定集群，而使用multicluster-scheduler，集群信息可以被烘焙到Git中的部署清单中。</p><p id="3dc9" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Argo CD和multicluster-scheduler可以有效地满足边缘用例的需求，用户可以使用GitOps在中央集群的边缘站点上部署应用程序。</p><p id="a617" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在cluster-dallas上从cluster-atlanta部署示例留言簿应用程序(Argo CD部署的集群)</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi np"><img src="../Images/7d8fcfc6f285650abca3eca5ebe6cf62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KB77GkLxq4a2f_5r"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Argo CD —使用多集群调度程序部署到目标集群</figcaption></figure><p id="d384" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Argo CD和相关组件仅安装在cluster-atlanta上:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/26a24222813fff385b0a5b7b128ddf16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0vGVR8861sxruPug"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">安装在群集上的Argo CD组件-亚特兰大</figcaption></figure><p id="4e6e" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Git上的部署清单是用clustername注释配置的，目标是cluster-dallas上的部署:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nq"><img src="../Images/66ceff46fb550e2861d306799f5ce9f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OJZgxxRfOL8U5_W8"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Git来源:在集群-dallas上部署强制放置的部署</figcaption></figure><p id="1e8f" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">包含Git信息的Argo CD部署清单:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nr"><img src="../Images/694f83f9d690ea0618e5daa1935b6b39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*G6GS60wrMu8G35HB"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Argo CD —使用Git源部署配置</figcaption></figure><p id="7e25" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">从群集上的Argo CD部署留言簿应用程序-atlanta:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ns"><img src="../Images/6724ca04c7ce0b6281654b03d41410a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HFtbE4HBpEDoddqx"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Argo CD留言簿示例部署</figcaption></figure><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/e28dde1ca85c401843714469f4042f82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hqS-t4bE7J0yiPWn"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Argo CD留言簿示例部署</figcaption></figure><p id="5376" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在virtual-kube let:admiralty on cluster-Atlanta上创建一个代理pod，其中源pod清单作为注释:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/427ca7cee2026c2cf35164ccbc769027.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZeLmlbJxJIFQKsiQ"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">在群集-atlanta上创建的留言簿代理窗格</figcaption></figure><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nt"><img src="../Images/657ddb371f2aa43e5ef16eb6cfe67487.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ximdyDgu11Bn3nSP"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">在cluster-atlanta上创建的留言簿代理pod，注释中包含sourcepod-manifest</figcaption></figure><p id="5df2" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">实际运行的应用程序容器(delegate pod)基于上面提供的配置部署在cluster-dallas上，controller-reference将parent-uid映射到cluster-atlanta上运行的代理pod:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nu"><img src="../Images/b9c2c3517e452b6195e4802042eff67b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*92zr65m6sYAdH6jy"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">在群集-达拉斯上创建的留言簿代表窗格</figcaption></figure><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nv"><img src="../Images/6819ab92a8e7645ab99bbffb56732ad6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eBRb81AEMlaYtn3w"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">在群集-达拉斯上创建的留言簿代表窗格</figcaption></figure><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nw"><img src="../Images/aed98b9769f316376ac1b3acb54408b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TJumZgmxAxVGIzyu"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">在cluster-dallas上创建的留言簿代理pod，其控制器引用cluster-atlanta上的代理pod</figcaption></figure><p id="4320" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">留言簿用户界面服务在集群中复制，目标代理服务被重新路由到代理，并标注有“<em class="ml">io.cilium/global-service=true'.</em></p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nx"><img src="../Images/21a1b9a07290832397ff03d70d4b0f85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XfyJpsR_lYXn6kiy"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">留言簿-ui服务— Git源</figcaption></figure><p id="8d05" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">没有任何端点的群集atlanta上的服务guestbook-ui(因为群集有一个代理pod)，带有值guestbook-dallas的实例标签(群集dallas上的delegate pod)以及启用Cilium全局服务负载平衡的注释:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/b2ecfb378a81c49856e23b2ea44739d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QGeru2FQhr3rMNMD"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">集群上的留言簿-ui服务-atlanta，无端点和Cilium global-服务标签自动添加</figcaption></figure><p id="74c3" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">cluster-dallas上的服务留言簿-ui，带有端点(delegate pod)、映射本地运行容器的实例标签和启用Cilium全局服务负载平衡的注释:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/3207589c692c5f83926eb55296faf839.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2cpeQRYknuboqvFE"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">带有端点和Cilium global的集群上的留言簿-ui服务-自动添加服务标签</figcaption></figure><p id="d463" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">由于在集群之间启用了Cilium集群网状网络，因此集群和子网之间的pod间连接已启用，并且使用上述配置，如果从cluster-atlanta调用服务，则请求会到达目标代理pod，然后这些代理pod会被重新路由到cluster-dallas上的代理pod:</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ny"><img src="../Images/f8891e88b5a6894661dc15f762105277.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*p9d7aueGs1J3iH_K"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">可从cluster-atlanta访问的留言簿用户界面服务—对代理pod的呼叫被路由到代理人</figcaption></figure><p id="1fd3" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在多集群和多云环境中运行Kubernetes，以实现Kubernetes的高级功能——如应用程序可移植性、多区域部署、高可用性等。–并避免供应商锁定情形，正受到企业的广泛关注。</p><p id="1fac" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">跨集群的智能调度在运行这些完全不同的环境中起着关键作用，multicluster-scheduler提供了一种更简单的方法来在Kubernetes本机方法中实现这一点，而不必处理特定的联邦配置和跨多个集群的部署。Argo可以无缝地利用multicluster-scheduler，在配置跨不同Kubernetes集群调度workflow pods的位置时进行粒度控制，而无需更改传统的Argo实现。</p></div></div>    
</body>
</html>