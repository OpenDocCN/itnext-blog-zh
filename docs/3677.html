<html>
<head>
<title>Deploy Nest.JS on ZEIT Now with Github Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">部署巢穴。JS on ZEIT Now与Github Actions</h1>
<blockquote>原文：<a href="https://itnext.io/deploy-nest-js-on-zeit-now-with-github-actions-86bc226e7371?source=collection_archive---------1-----------------------#2020-01-30">https://itnext.io/deploy-nest-js-on-zeit-now-with-github-actions-86bc226e7371?source=collection_archive---------1-----------------------#2020-01-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/82108b03b6ac4e2f705e4b290488fb52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LyrzwhFF5aLNNAscm6-QfA.png"/></div></div></figure><p id="33a1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我在去年发现了<a class="ae kw" href="https://zeit.co" rel="noopener ugc nofollow" target="_blank"> ZEIT Now </a>，并认为这是一种部署不同类型网站的简单方法，无论是前端还是后端，默认情况下<strong class="ka ir">没有配置</strong>。此外，我了解到我可以使用不同的编程语言，如Go、Python和Ruby！点击查看可用运行时间<a class="ae kw" href="https://zeit.co/docs/runtimes#official-runtimes" rel="noopener ugc nofollow" target="_blank">。😱那更牛逼！我希望他们继续支持更多的语言。期待它的进化！🔥</a></p><p id="48e5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在让我们进入正题吧！</p><h1 id="f488" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">什么是Github Actions？</h1><p id="008a" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">Github Actions是Github的一项功能，可以自动执行Github内部的软件工作流程。它使得在平台中构建、测试和部署您的代码变得容易。如果您仍在使用第三方CI/CD，您可能想尝试一下。😉</p><h1 id="7112" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">让我们把手弄脏吧</h1><p id="9d64" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">首先，创建一个空的Github存储库。我假设您已经有了一个Github存储库和Nest。JS代码，但我想从头开始，这样我们都有一个好的起点。</p><p id="4781" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建存储库之后，让我们克隆我们的嵌套。JS来自鸟巢提供的首发。JS团队。首先键入以下命令:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="af2b" class="mj ky iq mf b gy mk ml l mm mn">$ git clone <a class="ae kw" href="https://github.com/nestjs/typescript-starter" rel="noopener ugc nofollow" target="_blank">https://github.com/nestjs/typescript-starter</a></span></pre><p id="24e7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">克隆存储库之后，让我们将它推送到我们的Github存储库。应该是这样的:</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mo"><img src="../Images/6e6e202a8264158df40d697ffe140a47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CexX5AgGUZYZq1xBl0Ihlw.png"/></div></div></figure><p id="1996" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">既然我们已经准备好了。现在让我们继续配置ZEIT Now来完成我们的项目。等等，我以为我们不需要配置？我们将需要一个小的配置工作在我们的项目结构。ZEIT现在没有配置工作略有不同。这里可以看到<a class="ae kw" href="https://zeit.co/docs/runtimes#official-runtimes/node-js" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="e8d2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不过不用担心，只是一点配置😉</p><h1 id="aeae" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">现在配置ZEIT</h1><p id="92d5" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">在根目录下创建一个文件<code class="fe mp mq mr mf b">now.json</code></p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/11536acace464c55b6a669e0b8ce8040.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/format:webp/1*UOQ7gjg90OQYNenOWJU_-Q.png"/></div></figure><p id="a079" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是ZEIT现在在构建和部署我们的项目时要查看的文件。让我们继续添加我们的小配置。</p><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="44ce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面是我们的小配置！让我解释一下这里发生了什么。</p><p id="a050" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mp mq mr mf b">version</code> —该属性指定我们将在部署期间使用的ZEIT Now版本。版本2是目前最新的版本。</p><p id="0be9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mp mq mr mf b">name</code> —此属性指定部署的名称。它还用作部署URL的前缀值。例如，我们的名字是<code class="fe mp mq mr mf b">nestjs-now</code>，我们将有一个类似<code class="fe mp mq mr mf b">https://nestjs-now.${username}.now.sh</code>的部署URL。</p><p id="2b85" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mp mq mr mf b">builds</code> —此属性指定文件将在何处转换为无服务器功能。这就像告诉ZEIT现在，“这是我的根文件，建立一个无服务器的功能”。是的，我们正在改造我们的整个巢穴。JS应用程序转换成一个无服务器函数。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/edd84852fbee709ba5c20f576effa8a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WmKh_LvLQRTcgIDSN2qtkg.png"/></div></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated"><a class="ae kw" href="https://zeit.co" rel="noopener ugc nofollow" target="_blank">https://zeit.co</a></figcaption></figure><p id="cbc6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mp mq mr mf b">routes</code> —该属性指定所有路由都应该由我们的<code class="fe mp mq mr mf b">main.js</code>处理。我们只是告诉ZEIT现在将所有请求重定向到我们的巢。JS应用。这是因为我们的路由是由Nest处理的。JS应用程序已经。</p><p id="dbdf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有关配置的更多信息，您可以在这里阅读更多信息<a class="ae kw" href="https://zeit.co/docs/configuration" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="9b82" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以通过手动部署来测试我们的应用程序。让我们将ZEIT Now安装为项目依赖项的一部分，这样我们就可以在CI模式下调用ZEIT Now CLI。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="9dc9" class="mj ky iq mf b gy mk ml l mm mn">$ npm install --save now</span></pre><p id="9a5c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后在安装之后，让我们在我们的<code class="fe mp mq mr mf b">package.json</code>上添加一个部署脚本。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="905f" class="mj ky iq mf b gy mk ml l mm mn">{<br/>  "deploy": "npm run build &amp;&amp; now --prod --token $ZEIT_TOKEN"<br/>} </span></pre><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/ac5b1bbd444c77596b237bc1843c056c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wn4k4ykwe6xJkRer3OhAig.png"/></div></div></figure><p id="82ed" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们现在的下一步是从ZEIT获得一个令牌。让我们现在就做吧👍</p><p id="18e7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">登录您的ZEIT Now帐户，然后转到<strong class="ka ir">设置</strong>，然后导航到<strong class="ka ir">令牌</strong>部分。之后，让我们创建一个新的令牌，并将其命名为“nestjs-now-github-action ”,但是，是的，您可以随意命名。<strong class="ka ir">别忘了复制令牌</strong>！😉</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nb"><img src="../Images/e0ef31cd8af9f31146f9e51cbbaeb9c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zRDCg5LA_BIfjEHV6pvsrQ.png"/></div></div></figure><p id="c976" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们有了令牌，让我们尝试使用我们的自定义脚本并手动部署它。</p><p id="37ac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">转到项目根目录，通过键入以下命令开始。用我们不久前复制的那个替换<code class="fe mp mq mr mf b">ZEIT_TOKEN</code>:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="a8df" class="mj ky iq mf b gy mk ml l mm mn">$ ZEIT_TOKEN=xxxxxxx npm run deploy</span></pre><p id="adf4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们现在可以看到我们的应用程序已经成功部署。万岁！🚀</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="8a12" class="mj ky iq mf b gy mk ml l mm mn">$ ZEIT_TOKEN=xxxxxxx npm run deploy</span><span id="9f96" class="mj ky iq mf b gy nc ml l mm mn">$ npm run build &amp;&amp; now --prod --token $ZEIT_TOKEN</span><span id="c0c3" class="mj ky iq mf b gy nc ml l mm mn">...</span><span id="fe99" class="mj ky iq mf b gy nc ml l mm mn">&gt; Deploying ~/Documents/jm/typescript-starter under jmaicaaan</span><span id="e9b2" class="mj ky iq mf b gy nc ml l mm mn">&gt; Using project nestjs-now</span><span id="aaed" class="mj ky iq mf b gy nc ml l mm mn">&gt; NOTE: To deploy to production (nestjs-now-two-eta.now.sh), run `now --prod`</span><span id="5a46" class="mj ky iq mf b gy nc ml l mm mn">&gt; https://nestjs-now-ar99uog9g.now.sh [2s]</span><span id="2b5c" class="mj ky iq mf b gy nc ml l mm mn">&gt; Ready! Deployed to https://nestjs-now.jmaicaaan.now.sh [in clipboard] [29s]</span></pre><h1 id="f42a" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">设置Github操作</h1><p id="3b4c" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">现在我们可以手动部署我们的应用程序了。是时候使用Github Actions来自动化这个工作流程了！</p><p id="aef4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们转到Github上的Actions选项卡，开始创建我们的Github动作。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nd"><img src="../Images/d8a5e56653aedac0bc87ac2a2e9ff174.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cF3YjS9V7xKoree1u8Mitg.png"/></div></div></figure><p id="11e8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，再向下滚动一点，我们可以看到Node.js的工作流程</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ne"><img src="../Images/fa62b36beaee074d8a15378b5e03d999.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PREKBo0N5aFSry5M3MWFrg.png"/></div></div></figure><p id="6987" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">点击“设置此工作流程”按钮，将会引导您进入工作流程文件<code class="fe mp mq mr mf b">nodejs.yaml</code>。</p><p id="9b01" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们编辑<code class="fe mp mq mr mf b">nodejs.yaml</code>文件来适应我们的自动化。让我们执行以下步骤:</p><ul class=""><li id="e105" class="nf ng iq ka b kb kc kf kg kj nh kn ni kr nj kv nk nl nm nn bi translated">将<code class="fe mp mq mr mf b">name</code>重命名为您喜欢的名称。我更喜欢把它命名为“立即部署到ZEIT”。</li><li id="30c1" class="nf ng iq ka b kb no kf np kj nq kn nr kr ns kv nk nl nm nn bi translated">重命名后，让我们移动到“<strong class="ka ir">运行</strong>部分，并删除<code class="fe mp mq mr mf b">npm test</code>，因为我们现在没有测试，这只是一个基本的例子。让我们暂时摆脱它。</li><li id="b82b" class="nf ng iq ka b kb no kf np kj nq kn nr kr ns kv nk nl nm nn bi translated">既然我们删除了<code class="fe mp mq mr mf b">npm test</code>，让我们添加我们的部署脚本<code class="fe mp mq mr mf b">npm run deploy</code>。</li><li id="b2ee" class="nf ng iq ka b kb no kf np kj nq kn nr kr ns kv nk nl nm nn bi translated">因为我们的部署脚本需要<code class="fe mp mq mr mf b">ZEIT_TOKEN</code>环境变量。在“<strong class="ka ir"> env </strong>部分下面，我们再加上<code class="fe mp mq mr mf b">ZEIT_TOKEN: ${{ secrets.ZEIT_TOKEN }}</code>。</li></ul><p id="1689" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们的工作流程文件准备好了。让我们提交它，然后我们将在<code class="fe mp mq mr mf b">ZEIT_TOKEN</code>上工作。</p><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="4e92" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">既然我们的工作流已经提交到我们的存储库中。你可能想知道<code class="fe mp mq mr mf b">ZEIT_TOKEN</code>值从何而来，不是吗？啊哈，只需进入<strong class="ka ir">设置</strong>然后进入<strong class="ka ir">秘密</strong>部分并在那里添加秘密。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/d43471e005842072d1597ad4e501af07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AE5Ag6sb8w4EICZIGseXNg.png"/></div></div></figure><p id="17ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了访问这个秘密，我们可以使用Github提供的“秘密”上下文。这就是为什么在我们的<code class="fe mp mq mr mf b">nodejs.yml</code>工作流程中，在<strong class="ka ir"> env </strong>部分，有一个<code class="fe mp mq mr mf b">${{ secrets.ZEIT_TOKEN }}</code>。你可以在这里阅读更多<a class="ae kw" href="https://help.github.com/en/actions/automating-your-workflow-with-github-actions/creating-and-using-encrypted-secrets#using-encrypted-secrets-in-a-workflow" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="0634" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们的Github动作会在每次推送时触发，让我们试一下，看看我们的工作流是否会正常运行。让我们编辑一些代码，并推动它来触发我们的工作流程！</p><p id="1cd7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，我们可以编辑<code class="fe mp mq mr mf b">app.service.ts</code>来返回一个修改过的字符串。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/8066f90af24c90b5da0fdb5f9e112d43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-IGhZQLprYn4Pb4BQxgBVQ.png"/></div></div></figure><p id="7ff8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们看看我们的工作流程是否运行正常。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/5fd0469493dda3085f7ee0d6ce40fc51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vtrGWLvLekbSrQP9Kx1f-g.png"/></div></div></figure><p id="b0fa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">嗯，看起来是这样。让我们通过访问我们部署的应用程序来进一步确认这一点。我们可以通过日志看到。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/1301c6c6006fbecebfc07c11971ed4c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sd-JGERG0NZIK8O7Ts-yFA.png"/></div></div></figure><p id="eb0b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">再看<a class="ae kw" href="https://nestjs-now.jmaicaaan.now.sh" rel="noopener ugc nofollow" target="_blank">https://nestjs-now . jmaicaan . now . sh</a>，看起来是返回了预期的字符串值！😍</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nx"><img src="../Images/74592a0f79b3f0722f8cc14a5b95e86f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FvTN2i3lUl844tEaMovAuw.png"/></div></div></figure><p id="ec9e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">恭喜你！我们现在已经部署好了我们的巢穴。JS on ZEIT Now与Github Actions🎉</strong></p></div></div>    
</body>
</html>