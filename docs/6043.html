<html>
<head>
<title>Secure access to a private network from GitHub actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从GitHub actions安全访问专用网络</h1>
<blockquote>原文：<a href="https://itnext.io/secure-access-to-a-private-network-from-github-actions-47dab60cf37d?source=collection_archive---------1-----------------------#2021-07-31">https://itnext.io/secure-access-to-a-private-network-from-github-actions-47dab60cf37d?source=collection_archive---------1-----------------------#2021-07-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="gh gi ju"><img src="../Images/8ded5d17b3081087cf66492b55a927cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IA6y8Bz_dixLYXDp"/></div></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk translated">克劳迪娅·苏拉娅在<a class="ae kk" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="8163" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">GitHub的动作很牛逼。我喜欢它。但是通常构建步骤必须连接到云中的私有资源。比如运行在私有网络的MySQL服务器，或者私有k8s集群。这可能会成为一个真正的障碍，你不应该做的是向世界开放你的资源。互联网充满了威胁，如果不将基础设施锁定在专用网络后面，坏事可能会发生。在这篇文章中，我将演示一种叫做<strong class="kn ir"> ssh端口转发</strong>的简单技术，它将包括使用Terraform旋转一个堡垒虚拟机，然后通过ssh经由这个实例连接到一个私有的MySQL服务器。</p><p id="ee85" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在我们进入代码之前，让我们先讨论一下相关的网络。GitHub actions build step正在某个远程数据中心(可能是azure，因为微软几年前收购了GitHub)的某个容器上运行，并且想要连接到在另一个数据中心运行的专用MySQL服务器，我说它的专用是指它连接到虚拟专用网络，让我们以GCP为例。因此，MySQL实例只有一个私有IP地址，看起来类似于10.4.20.15，如果您尝试<em class="lj"> ping </em>此IP，您将会丢失100%的数据包，因为它在私有网络之外是不可到达的，为了能够从外部世界到达此IP，我们可以做一些技巧，在私有网络中安装VPN并连接到它<a class="ae kk" href="https://github.com/helm/charts/tree/master/stable/openvpn" rel="noopener ugc nofollow" target="_blank">(例如使用开放式VPN ) </a>。尽管这对于本地开发来说非常方便，但在我看来，在GitHub的每个版本上安装和配置VPN客户端有点太复杂了。</p><p id="55d1" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">现在，让我们进入代码:)</p><figure class="jv jw jx jy gt jz"><div class="bz fp l di"><div class="lk ll l"/></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk translated">端口转发命令</figcaption></figure><p id="72f9" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">让我们将它上面的命令分解成它的组件:</p><ul class=""><li id="a4ff" class="lm ln iq kn b ko kp ks kt kw lo la lp le lq li lr ls lt lu bi translated"><strong class="kn ir">-o stricthostkey checking = no</strong>告诉ssh不要检查我们将要连接的主机的<strong class="kn ir"> known_hosts </strong>文件</li><li id="fbdb" class="lm ln iq kn b ko lv ks lw kw lx la ly le lz li lr ls lt lu bi translated"><strong class="kn ir"> -tt </strong>将强制tty分配(关于什么是tty的好帖子可以在<a class="ae kk" href="https://www.howtogeek.com/428174/what-is-a-tty-on-linux-and-how-to-use-the-tty-command/" rel="noopener ugc nofollow" target="_blank">这里</a>找到)</li><li id="3523" class="lm ln iq kn b ko lv ks lw kw lx la ly le lz li lr ls lt lu bi translated">-I<strong class="kn ir">github_id_rsa " $ { SHH _ USER } @ $ { BASTION_IP } "</strong>使用位于工作目录中的github _ id _ RSA私钥作为SSH_USER连接到BASTION _ IP</li><li id="9887" class="lm ln iq kn b ko lv ks lw kw lx la ly le lz li lr ls lt lu bi translated"><strong class="kn ir">-L " 3306:$ { MYSQL _ IP }:3306 "</strong>L标志作为ssh手册页准确地告诉:指定到本地(客户端)主机上的给定TCP端口或Unix套接字的连接将被转发到远程端的给定主机和端口或Unix套接字。</li><li id="cbb4" class="lm ln iq kn b ko lv ks lw kw lx la ly le lz li lr ls lt lu bi translated"><strong class="kn ir"> &amp; </strong>在后台运行</li></ul><p id="244e" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">为了在构建步骤的工作指导中拥有私钥，我们需要以下命令。</p><figure class="jv jw jx jy gt jz"><div class="bz fp l di"><div class="lk ll l"/></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk translated">从github actions secret读取base 64编码的私钥，并写入本地文件</figcaption></figure><p id="e820" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">一旦执行了上面的命令，连接到<em class="lj"> localhost:3306 </em>上的MySQL服务器将通过我们创建的ssh隧道连接到远程MySQL服务器。以安全的方式。我们唯一缺少的是一个bastion服务器，它也安装了ssh，位于我们想要到达的私有网络中，并注入了github_id_rsa的pair公钥。在GCP的web控制台上点击几下就可以创建这个服务器，但是使用Terraform更有趣，所以让我们看一下代码。</p><figure class="jv jw jx jy gt jz"><div class="bz fp l di"><div class="lk ll l"/></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk translated">使用terraform创建堡垒ssh服务器</figcaption></figure><p id="5468" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这里有几件事情:</p><ul class=""><li id="d528" class="lm ln iq kn b ko kp ks kt kw lo la lp le lq li lr ls lt lu bi translated">为我们的堡垒虚拟机创建一个新的服务帐户(GCP服务帐户就像一个应用程序标识符)</li><li id="5439" class="lm ln iq kn b ko lv ks lw kw lx la ly le lz li lr ls lt lu bi translated">创建公共静态ip地址</li><li id="f533" class="lm ln iq kn b ko lv ks lw kw lx la ly le lz li lr ls lt lu bi translated">在私有网络中创建一个虚拟机，注入我们之前生成的ssh密钥对的公钥(ssh-keygen -c -C user@local -f key)，并为其分配网络标记</li><li id="df1c" class="lm ln iq kn b ko lv ks lw kw lx la ly le lz li lr ls lt lu bi translated">创建防火墙规则，使用我们创建的网络标记将我们的虚拟机作为目标，并向全世界开放端口22</li></ul><p id="d6e9" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我在这里没有提到的是私有网络本身的创建和Terraform GCP提供商的设置，这超出了本文的范围。(但真的没那么复杂)</p><p id="5517" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">为了测试在GCP项目上应用上述Terraform更改后一切正常，尝试对实例使用ssh。</p><p id="fd44" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">要从Terraform run获取其bastion IP:</p><blockquote class="ma mb mc"><p id="bca7" class="kl km lj kn b ko kp kq kr ks kt ku kv md kx ky kz me lb lc ld mf lf lg lh li ij bi translated"><em class="iq">地形状态显示Google _ compute _ address . bastion _ IP _ address</em></p><p id="8618" class="kl km lj kn b ko kp kq kr ks kt ku kv md kx ky kz me lb lc ld mf lf lg lh li ij bi translated">ssh ${BASTION_IP} -i用户id_rsa</p></blockquote><p id="dc11" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果ssh正常工作，并且您发现自己在vm中，那么恭喜您，一切都应该没问题了，防火墙已经配置好了，您可以安全地进入私有网络了。</p><p id="b9f5" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">关于k8s私有集群的一个注意事项:如果您想在私有集群中获得服务，有几种方法可以实现。在我看来，在您的集群中安装一个<a class="ae kk" href="https://github.com/kubernetes-sigs/external-dns" rel="noopener ugc nofollow" target="_blank">外部DNS k8s操作器</a>，它将为每个服务分配域名，然后通过与上述相同的技术访问这些服务，这是最简单的方法。(您需要一个外部DNS，因为您试图从k8s外部访问k8s中运行的服务，因此无法使用k8s内部DNS名称。但这是另一篇文章的内容。</p><p id="c65d" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">最后，不要忘记从容器中删除私钥，把私钥到处乱放是不好的做法。</p><figure class="jv jw jx jy gt jz"><div class="bz fp l di"><div class="lk ll l"/></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk translated">清理我们用于ssh隧道的私钥的构建步骤</figcaption></figure><p id="31a3" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">今天到此为止。</p><p id="98ec" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">再见，谢谢所有的鱼；)</p></div></div>    
</body>
</html>