<html>
<head>
<title>Monitoring Kubernetes Control Plane using Datadog and Helm</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Datadog和Helm监控Kubernetes控制平面</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-control-plane-monitoring-using-datadog-and-helm-6c2daf2039d8?source=collection_archive---------6-----------------------#2019-10-03">https://itnext.io/kubernetes-control-plane-monitoring-using-datadog-and-helm-6c2daf2039d8?source=collection_archive---------6-----------------------#2019-10-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/5d1660cc15fdb3bee2181b49f3af860a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bhHef4MjHQpGfFezHbnNmw.png"/></div></div></figure><h1 id="a9f1" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">简介:</h1><p id="783e" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">Datadog是最棒的监控工具之一。它们提供了与不同云提供商和开源工具的惊人集成。他们支持kubernetes监控已经有一段时间了，但是还不支持控制平面监控。Kubernetes控制平面的各个部分，如Kubernetes主进程和kubelet进程，控制着Kubernetes如何与集群通信。控制平面维护系统中所有Kubernetes对象的记录，并运行连续的控制循环来管理这些对象的状态。与控制平面相关的问题可能会导致群集范围的中断，因此监控控制平面非常重要。以下是运行在Kubernetes主节点上的Kubernetes控制平面的四个组件，datadog可以从2019年6月开始对其进行监控:</p><ul class=""><li id="4679" class="lx ly it lb b lc lz lg ma lk mb lo mc ls md lw me mf mg mh bi translated"><strong class="lb iu">kube-API server:</strong>kubernetes控制平面的前端，充当所有组件与集群通信的通信枢纽。</li><li id="e3b5" class="lx ly it lb b lc mi lg mj lk mk lo ml ls mm lw me mf mg mh bi translated"><strong class="lb iu"> etcd: </strong>一致且高度可用的键值存储，用作Kubernetes所有集群数据的后备存储，例如集群配置、运行组件的期望状态等。</li><li id="3bb5" class="lx ly it lb b lc mi lg mj lk mk lo ml ls mm lw me mf mg mh bi translated"><strong class="lb iu"> kube-scheduler: </strong>监视新创建的没有分配节点的pod，并为它们选择一个节点来运行。</li><li id="dc9f" class="lx ly it lb b lc mi lg mj lk mk lo ml ls mm lw me mf mg mh bi translated">kube-controller-manager: 它是一个守护进程，嵌入了Kubernetes附带的核心控制循环。它通过API服务器监视功能监视集群的状态，并进行更改以将集群移向所需的状态。</li></ul><p id="e2d7" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mn lm ln lo mo lq lr ls mp lu lv lw im bi translated">需要设置Datadog代理来监控您的基础架构。Datadog代理将指标和日志发送到您的datadog帐户。您可以将来自多个集群的指标和日志发送到您的Datadog组织，为此您需要一个应用密钥和api密钥。Datadog提供了多个选项来在您的kubernetes集群上部署datadog代理，其中我最喜欢的是helm。你可以从这个<a class="ae mq" href="https://github.com/helm/charts/tree/master/stable/datadog" rel="noopener ugc nofollow" target="_blank">链接</a>了解更多关于datadog头盔图的信息。您可以使用helm通过您的配置和检查，helm会创建一个包含您所有配置的Datadog <a class="ae mq" href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/" rel="noopener ugc nofollow" target="_blank"> Daemonset </a>。</p><h1 id="86ad" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">正在为Datadog代理创建控制平面配置:</h1><p id="6eef" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">让我们从在Kubernetes主节点上运行datadog所需的基本配置开始。</p><p id="475b" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mn lm ln lo mo lq lr ls mp lu lv lw im bi translated">参考这个<a class="ae mq" href="https://github.com/DataDog/integrations-core/blob/master/kube_apiserver_metrics/datadog_checks/kube_apiserver_metrics/data/conf.yaml.example" rel="noopener ugc nofollow" target="_blank">链接</a>来获得<strong class="lb iu"> kubernetes api服务器</strong>的所有配置。下面是我们将在helm图表中使用的<strong class="lb iu"> api-server </strong>的配置:</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="19f8" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mn lm ln lo mo lq lr ls mp lu lv lw im bi translated">对于<strong class="lb iu"> kubernetes调度器</strong>，检查所有配置的<a class="ae mq" href="https://github.com/DataDog/integrations-core/blob/master/kube_scheduler/datadog_checks/kube_scheduler/data/conf.yaml.example" rel="noopener ugc nofollow" target="_blank">链接</a>。</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="53fc" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mn lm ln lo mo lq lr ls mp lu lv lw im bi translated">对于<strong class="lb iu"> kubernetes控制器管理器</strong>，检查所有配置的<a class="ae mq" href="https://github.com/DataDog/integrations-core/blob/master/kube_controller_manager/datadog_checks/kube_controller_manager/data/conf.yaml.example" rel="noopener ugc nofollow" target="_blank">链接</a>。</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure><h2 id="56c3" class="mx kc it bd kd my mz dn kh na nb dp kl lk nc nd kp lo ne nf kt ls ng nh kx ni bi translated">etcd3配置和证书创建:</h2><p id="8cbb" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">从Kubernetes版本12开始，使用etcd3。etcd3具有额外的安全特性。我们需要向datadog config提供证书以进行身份验证。我使用KOPS来管理kubernetes，对于kops，这些证书已经可以在kubernetes主节点的<code class="fe nj nk nl nm b">/etc/kubernetes/pki/kube-apiserver</code>目录中获得。如果您喜欢为不同的服务使用不同的证书，那么您可以创建自己的证书并提供给datadog。KOPS正在使用etcd管理器，它在<code class="fe nj nk nl nm b">/etc/kubernetes/pki/etcd-manager-main</code>存储证书。使用以下命令创建您自己的证书集:</p><pre class="mr ms mt mu gt nn nm no np aw nq bi"><span id="9f2b" class="mx kc it nm b gy nr ns l nt nu">## Run the openssl commands on one of the KOPS master node.<br/>## You can run this commands from tmp directory</span><span id="808b" class="mx kc it nm b gy nv ns l nt nu">openssl req -nodes -new -out datadog.csr -keyout datadog.key -subj "/CN=datadog"</span><span id="cfa9" class="mx kc it nm b gy nv ns l nt nu">openssl x509 -req -in datadog.csr -CA /etc/kubernetes/pki/etcd-manager-main/etcd-clients-ca.crt -CAkey /etc/kubernetes/pki/etcd-manager-main/etcd-clients-ca.key -CAcreateserial -out datadog.crt -days 365 -sha256</span><span id="3c79" class="mx kc it nm b gy nv ns l nt nu">openssl x509 -in datadog.crt -outform PEM -out datadog.pem</span><span id="d832" class="mx kc it nm b gy nv ns l nt nu">openssl x509 -in /etc/kubernetes/pki/etcd-manager-main/etcd-clients-ca.crt -outform PEM -out etcd-ca.pem</span><span id="5a3f" class="mx kc it nm b gy nv ns l nt nu">## Test your certificates by running below command:<br/>curl --cacert etcd-ca.pem --cert datadog.pem --key datadog.key <a class="ae mq" href="https://127.0.0.1:4001/metrics" rel="noopener ugc nofollow" target="_blank">https://127.0.0.1:4001/metrics</a></span></pre><p id="d5ca" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mn lm ln lo mo lq lr ls mp lu lv lw im bi translated">这些证书必须安装在datadog daemonset上。我们稍后会谈到这一点，现在让我们假设我们将把它们挂载到<code class="fe nj nk nl nm b">/etc/datadog-agent/certs/</code>目录中。下面是您的etcd配置文件的样子:</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure><h1 id="5a64" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">用于控制平面监控的舵图</h1><p id="b083" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">我们有了为舵图创建值文件所需的所有部分。除此之外，我们还需要您的Datadog帐户提供api密钥和app密钥。您可以创建新的app-api密钥，也可以使用现有的密钥。下面的文档描述了如何获得:</p><div class="nw nx gp gr ny nz"><a href="https://docs.datadoghq.com/account_management/api-app-keys/" rel="noopener  ugc nofollow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd iu gy z fp oe fr fs of fu fw is bi translated">API和应用程序密钥</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">API密钥对您的组织来说是唯一的。Datadog代理需要一个API键来向…提交指标和事件</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">docs.datadoghq.com</p></div></div></div></a></div><p id="604f" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mn lm ln lo mo lq lr ls mp lu lv lw im bi translated">Datadog helm chart附带了一个选项来启用<strong class="lb iu"> datadog集群代理</strong>。Datadog集群代理提供了一种简化的集中式方法来收集集群级监控数据。我正在启用集群代理，因为它是一个很好的特性，并且易于使用helm进行配置。集群代理需要一个令牌，该令牌可以以纯文本形式提供，也可以通过您的舵轮图的密码提供。这篇<a class="ae mq" href="https://docs.datadoghq.com/agent/kubernetes/cluster/#secure-cluster-agent-to-agent-communication" rel="noopener ugc nofollow" target="_blank">文章</a>解释了更多关于集群代理令牌的内容。</p><p id="1e5f" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mn lm ln lo mo lq lr ls mp lu lv lw im bi translated">下面是datadog helm图表的values.yaml文件的外观:</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure><blockquote class="oi oj ok"><p id="3e27" class="kz la ol lb b lc lz le lf lg ma li lj om mn lm ln on mo lq lr oo mp lu lv lw im bi translated">我们使用容错来确保控制平面配置在主节点上运行。在worker上运行此命令将在与控制平面服务相关的worker节点日志中创建大量错误。</p></blockquote><p id="e939" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mn lm ln lo mo lq lr ls mp lu lv lw im bi translated">我们必须将这种容忍度设置在达蒙塞特水平。以下是正在使用的公差:</p><pre class="mr ms mt mu gt nn nm no np aw nq bi"><span id="36e0" class="mx kc it nm b gy nr ns l nt nu">tolerations:    <br/>- effect: NoSchedule      <br/>  key: node-role.kubernetes.io/master    <br/>- key: CriticalAddonsOnly      <br/>  operator: Exists</span></pre><p id="0ba5" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mn lm ln lo mo lq lr ls mp lu lv lw im bi translated">我们正在启用日志、apm、processagents以及datadog提供的所有优秀特性。要了解更多功能或禁用某些功能，请查看此<a class="ae mq" href="https://github.com/helm/charts/tree/master/stable/datadog" rel="noopener ugc nofollow" target="_blank">链接</a>。这是一篇来自datadog的关于使用舵图的好文章:</p><div class="nw nx gp gr ny nz"><a href="https://docs.datadoghq.com/agent/kubernetes/helm/?tab=macoshomebrew" rel="noopener  ugc nofollow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd iu gy z fp oe fr fs of fu fw is bi translated">使用Helm在Kubernetes中部署Datadog</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">Helm是Kubernetes的一个包管理工具。对于其他平台和安装舵的方法，请参考舵…</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">docs.datadoghq.com</p></div></div><div class="op l"><div class="oq l or os ot op ou jz nz"/></div></div></a></div><p id="c49a" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mn lm ln lo mo lq lr ls mp lu lv lw im bi translated">最后一部分是运行helm命令，并在控制面板上完成datadog的设置。我们将把我们的值文件命名为<code class="fe nj nk nl nm b">master-node-datadog-values.yaml</code>:</p><pre class="mr ms mt mu gt nn nm no np aw nq bi"><span id="cc70" class="mx kc it nm b gy nr ns l nt nu">helm install --name control-plane-ddagent \<br/>    --set datadog.apiKey=&lt;DATADOG_API_KEY&gt; \<br/>    --set datadog.appKey=&lt;DATADOG_APP_KEY \<br/>    --set clusterAgent.token= "&lt;ThirtyX2XcharactersXlongXtoken&gt;" \<br/>    -f master-node-datadog-values.yaml \<br/>    stable/datadog</span></pre><h2 id="6069" class="mx kc it bd kd my mz dn kh na nb dp kl lk nc nd kp lo ne nf kt ls ng nh kx ni bi translated">工作节点的舵图:</h2><p id="b724" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">上述所有步骤将只为控制平面设置数据狗。在worker节点上运行datadog实际上很容易。通过移除控制平面特定配置，我们可以获得工作节点的值文件。</p><p id="eb57" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mn lm ln lo mo lq lr ls mp lu lv lw im bi translated">下面是一个简单的值文件，我们称之为<code class="fe nj nk nl nm b">worker-node-datadog-values.yaml</code>:</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="ea96" class="pw-post-body-paragraph kz la it lb b lc lz le lf lg ma li lj lk mn lm ln lo mo lq lr ls mp lu lv lw im bi translated">舵命令保持不变，我们只改变值文件和发布名称:</p><pre class="mr ms mt mu gt nn nm no np aw nq bi"><span id="9366" class="mx kc it nm b gy nr ns l nt nu">helm install --name workder-node-ddagent \<br/>    --set datadog.apiKey=&lt;DATADOG_API_KEY&gt; \<br/>    --set datadog.appKey=&lt;DATADOG_APP_KEY \<br/>    --set clusterAgent.token= "&lt;ThirtyX2XcharactersXlongXtoken&gt;" \<br/>    -f <!-- -->worker-node-datadog-values.yaml<!-- --> \<br/>    stable/datadog</span></pre><h1 id="8ba9" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">支持集成:</h1><p id="16f6" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">到目前为止，我们已经启用了指标和日志收集。Datadog为kubernetes服务提供了良好的集成，只需点击几下鼠标即可启用。只需进入整合页面:<a class="ae mq" href="https://app.datadoghq.com/account/settings" rel="noopener ugc nofollow" target="_blank">https://app.datadoghq.com/account/settings</a>并搜索Kubernetes整合。启用集成将帮助您从datadog获得OOTB仪表板。例如，控制器管理器仪表板:</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ov"><img src="../Images/c9e4336fd3bb47dc12743b1a7f8e7749.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x73GA3PIquIcbbIgdLUF8w.png"/></div></div></figure><h1 id="0e45" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">现有问题:</h1><p id="dcee" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">控制平面监控是一项新功能，datadog目前正在开发中。有些问题可能会让你担心:</p><ul class=""><li id="b37a" class="lx ly it lb b lc lz lg ma lk mb lo mc ls md lw me mf mg mh bi translated">etcd集成存在问题，因为它支持api版本v2，而etcd3使用的是api版本v3。因此，Datadog提供的仪表板中没有数据。</li><li id="d96f" class="lx ly it lb b lc mi lg mj lk mk lo ml ls mm lw me mf mg mh bi translated">如果您是<code class="fe nj nk nl nm b">datadoghq.eu</code>用户，那么API-服务器集成将不可用。我目前正在跟踪他们的工程师，他们正在解决这个问题。</li></ul></div></div>    
</body>
</html>