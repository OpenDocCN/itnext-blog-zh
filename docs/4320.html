<html>
<head>
<title>Kafka on Kubernetes, the Strimzi way! (Part 1)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">库伯内特斯上的卡夫卡，斯特里姆兹之路！(第一部分)</h1>
<blockquote>原文：<a href="https://itnext.io/kafka-on-kubernetes-the-strimzi-way-part-1-bdff3e451788?source=collection_archive---------0-----------------------#2020-06-08">https://itnext.io/kafka-on-kubernetes-the-strimzi-way-part-1-bdff3e451788?source=collection_archive---------0-----------------------#2020-06-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b7db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">欢迎来到这个关于在Kubernetes上运行卡夫卡的博客系列:</p><ul class=""><li id="20e5" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">第1部分—本博客</li><li id="06d2" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated"><a class="ae kz" rel="noopener ugc nofollow" target="_blank" href="/kafka-on-kubernetes-the-strimzi-way-part-2-43192f1dd831">第二部分</a></li><li id="7262" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated"><a class="ae kz" rel="noopener ugc nofollow" target="_blank" href="/kafka-on-kubernetes-the-strimzi-way-part-3-19cfdfe86660">第三部分</a></li><li id="48f5" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated"><a class="ae kz" href="https://medium.com/@abhishek1987/kafka-on-kubernetes-the-strimzi-way-part-4-bf1e651e25b8" rel="noopener">第四部分</a></li></ul></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><p id="7f5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我之前的一些博文(比如<a class="ae kz" rel="noopener ugc nofollow" target="_blank" href="/kafka-connect-on-kubernetes-the-easy-way-b5b617b7d5e9"> Kafka Connect on Kubernetes，the easy way！</a>)，演示如何以Kubernetes-native方式使用<a class="ae kz" href="https://kafka.apache.org/documentation/#connect" rel="noopener ugc nofollow" target="_blank"> Kafka Connect </a>。这是使用<a class="ae kz" href="http://strimzi.io/" rel="noopener ugc nofollow" target="_blank"> Strimzi运算符</a>在<a class="ae kz" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>上发表的<a class="ae kz" href="https://kafka.apache.org/" rel="noopener ugc nofollow" target="_blank">阿帕奇卡夫卡</a>系列博文的第一篇。在本帖中，我们将从最简单的设置开始，即单节点Kafka(和Zookeeper)集群，并学习:</p><ul class=""><li id="1c89" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">Strimzi概述和设置</li><li id="734b" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">Kafka集群安装</li><li id="83b7" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">幕后使用/创建的Kubernetes资源</li><li id="7133" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">使用Kubernetes集群中的客户端测试Kafka设置</li></ul><blockquote class="lh li lj"><p id="45ca" class="jn jo lk jp b jq jr js jt ju jv jw jx ll jz ka kb lm kd ke kf ln kh ki kj kk ij bi translated"><em class="iq">代码在GitHub上有—</em>【https://github.com/abhirockzz/kafka-kubernetes-strimzi】<em class="iq"/></p></blockquote><h1 id="51fc" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">我需要什么来尝试这个？</h1><p id="ddd7" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated"><code class="fe mr ms mt mu b">kubectl</code>-<a class="ae kz" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank">https://kubernetes.io/docs/tasks/tools/install-kubectl/</a></p><p id="aac5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将使用<a class="ae kz" href="https://docs.microsoft.com/azure/aks/intro-kubernetes?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">Azure Kubernetes Service(AKS)</a>来演示这些概念，但总的来说，它是独立于Kubernetes提供者的(例如，可以随意使用像<code class="fe mr ms mt mu b">minikube</code>这样的本地设置)。如果你想使用<code class="fe mr ms mt mu b">AKS</code>，你只需要一个<a class="ae kz" href="https://docs.microsoft.com/azure/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">微软Azure账户</a>，如果你还没有的话，你可以<a class="ae kz" href="https://azure.microsoft.com/free/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">免费获得</a>。</p><h2 id="6795" class="mv lp iq bd lq mw mx dn lu my mz dp ly jy na nb mc kc nc nd mg kg ne nf mk ng bi translated">安装<code class="fe mr ms mt mu b">Helm</code></h2><p id="2c66" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">我将使用<code class="fe mr ms mt mu b">Helm</code>安装<code class="fe mr ms mt mu b">Strimzi</code>。这里是安装<code class="fe mr ms mt mu b">Helm</code>本身的文档-<a class="ae kz" href="https://helm.sh/docs/intro/install/" rel="noopener ugc nofollow" target="_blank">https://helm.sh/docs/intro/install/</a></p><blockquote class="lh li lj"><p id="5c02" class="jn jo lk jp b jq jr js jt ju jv jw jx ll jz ka kb lm kd ke kf ln kh ki kj kk ij bi translated"><em class="iq">您也可以使用</em> <code class="fe mr ms mt mu b"><em class="iq">YAML</em></code> <em class="iq">文件直接安装</em> <code class="fe mr ms mt mu b"><em class="iq">Strimzi</em></code> <em class="iq">。点击此处查看快速入门指南-</em><a class="ae kz" href="https://strimzi.io/docs/quickstart/latest/#proc-install-product-str" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://strim zi . io/docs/quick start/latest/# proc-install-product-str</em></a></p></blockquote><h2 id="75fc" class="mv lp iq bd lq mw mx dn lu my mz dp ly jy na nb mc kc nc nd mg kg ne nf mk ng bi translated">(可选)设置Azure Kubernetes服务</h2><p id="d045" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">Azure Kubernetes Service(AKS)使在Azure中部署托管的Kubernetes集群变得简单。它通过将大部分责任转移给Azure，降低了管理Kubernetes的复杂性和运营开销。以下是如何使用设置AKS集群的示例</p><ul class=""><li id="f69c" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated"><a class="ae kz" href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a>，— <a class="ae kz" href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough-portal?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure portal </a>或</li><li id="e971" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated"><a class="ae kz" href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough-rm-template?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">手臂模板</a></li></ul><p id="a919" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦你设置了集群，你可以很容易地<a class="ae kz" href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough?WT.mc_id=medium-blog-abhishgu#connect-to-the-cluster" rel="noopener ugc nofollow" target="_blank">配置</a> <code class="fe mr ms mt mu b"><a class="ae kz" href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough?WT.mc_id=medium-blog-abhishgu#connect-to-the-cluster" rel="noopener ugc nofollow" target="_blank">kubectl</a></code> <a class="ae kz" href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough?WT.mc_id=medium-blog-abhishgu#connect-to-the-cluster" rel="noopener ugc nofollow" target="_blank">来指向它</a></p><pre class="nh ni nj nk gt nl mu nm nn aw no bi"><span id="28dd" class="mv lp iq mu b gy np nq l nr ns">az aks get-credentials --resource-group &lt;CLUSTER_RESOURCE_GROUP&gt; --name &lt;CLUSTER_NAME&gt;</span></pre></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h1 id="bfdc" class="lo lp iq bd lq lr nt lt lu lv nu lx ly lz nv mb mc md nw mf mg mh nx mj mk ml bi translated">等等，什么是<code class="fe mr ms mt mu b">Strimzi</code>？</h1><figure class="nh ni nj nk gt nz gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/513d9e6b4151627659bc83e4964ae006.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*s1xcudrMZdrGmocL.gif"/></div></figure><p id="7f21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lk">来自Strimzi文档</em></p><p id="df40" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mr ms mt mu b">Strimzi</code>简化在Kubernetes集群中运行Apache Kafka的过程。Strimzi为在Kubernetes上运行Kafka提供了容器映像和操作符。它是作为<code class="fe mr ms mt mu b"><a class="ae kz" href="https://www.cncf.io/sandbox-projects/" rel="noopener ugc nofollow" target="_blank">Sandbox</a></code> <a class="ae kz" href="https://www.cncf.io/sandbox-projects/" rel="noopener ugc nofollow" target="_blank">项目</a>的 <code class="fe mr ms mt mu b"><a class="ae kz" href="https://strimzi.io/blog/2019/09/06/cncf/" rel="noopener ugc nofollow" target="_blank">Cloud Native Computing Foundation</a></code>的<a class="ae kz" href="https://strimzi.io/blog/2019/09/06/cncf/" rel="noopener ugc nofollow" target="_blank">部分(在撰写本文时)</a></p><p id="cf87" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mr ms mt mu b">Strimzi Operators</code>是项目的基础。这些操作人员具有专业的操作知识，能够有效地管理Kafka。运营商简化了以下过程:部署和运行Kafka集群和组件，配置和保护对Kafka的访问，升级和管理Kafka，甚至负责管理主题和用户。</p><p id="997e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下图展示了操作员角色的10，000英尺概况:</p><figure class="nh ni nj nk gt nz gh gi paragraph-image"><div role="button" tabindex="0" class="od oe di of bf og"><div class="gh gi oc"><img src="../Images/652c72c75fbe5a6016fd4690ba627f23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aM2iIQdSyevT1NU4IyKhrg.png"/></div></div><figcaption class="oh oi gj gh gi oj ok bd b be z dk translated">Strimzi运算符—<a class="ae kz" href="https://strimzi.io/docs/operators/master/images/operators.png" rel="noopener ugc nofollow" target="_blank">https://strim zi . io/docs/Operators/master/images/Operators . png</a></figcaption></figure></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h1 id="5d4c" class="lo lp iq bd lq lr nt lt lu lv nu lx ly lz nv mb mc md nw mf mg mh nx mj mk ml bi translated">安装Strimzi</h1><p id="00bf" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">使用<code class="fe mr ms mt mu b">Helm</code>安装<code class="fe mr ms mt mu b">Strimzi</code>非常简单:</p><pre class="nh ni nj nk gt nl mu nm nn aw no bi"><span id="442c" class="mv lp iq mu b gy np nq l nr ns">//add helm chart repo for Strimzi<br/>helm repo add strimzi https://strimzi.io/charts/</span><span id="5720" class="mv lp iq mu b gy ol nq l nr ns">//install it! (I have used strimzi-kafka as the release name)<br/>helm install strimzi-kafka strimzi/strimzi-kafka-operator</span></pre><p id="3dcd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将安装<code class="fe mr ms mt mu b">Strimzi</code>操作符(它只是一个<code class="fe mr ms mt mu b">Deployment</code>)、定制资源定义和其他Kubernetes组件，如<code class="fe mr ms mt mu b">Cluster Roles</code>、<code class="fe mr ms mt mu b">Cluster Role Bindings</code>和<code class="fe mr ms mt mu b">Service Accounts</code></p><blockquote class="lh li lj"><p id="116f" class="jn jo lk jp b jq jr js jt ju jv jw jx ll jz ka kb lm kd ke kf ln kh ki kj kk ij bi translated"><em class="iq">更多详情，</em> <a class="ae kz" href="https://github.com/strimzi/strimzi-kafka-operator/tree/master/helm-charts/strimzi-kafka-operator" rel="noopener ugc nofollow" target="_blank"> <em class="iq">查看此链接</em> </a></p><p id="2aad" class="jn jo lk jp b jq jr js jt ju jv jw jx ll jz ka kb lm kd ke kf ln kh ki kj kk ij bi translated"><em class="iq">删除，只需</em>T11】</p></blockquote><p id="c31a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了确认Strimzi操作器已经被部署，检查它的<code class="fe mr ms mt mu b">Pod</code>(它应该在一段时间后转换到<code class="fe mr ms mt mu b">Running</code>状态)</p><pre class="nh ni nj nk gt nl mu nm nn aw no bi"><span id="8cc2" class="mv lp iq mu b gy np nq l nr ns">kubectl get pods -l=name=strimzi-cluster-operator</span><span id="27d1" class="mv lp iq mu b gy ol nq l nr ns">NAME                                        READY   STATUS      <br/>strimzi-cluster-operator-5c66f679d5-69rgk   1/1     Running       </span></pre><p id="cfe5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还要检查自定义资源定义:</p><pre class="nh ni nj nk gt nl mu nm nn aw no bi"><span id="6887" class="mv lp iq mu b gy np nq l nr ns">kubectl get crd | grep strimzi</span><span id="9fb3" class="mv lp iq mu b gy ol nq l nr ns">kafkabridges.kafka.strimzi.io           2020-04-13T16:49:36Z<br/>kafkaconnectors.kafka.strimzi.io        2020-04-13T16:49:33Z<br/>kafkaconnects.kafka.strimzi.io          2020-04-13T16:49:36Z<br/>kafkaconnects2is.kafka.strimzi.io       2020-04-13T16:49:38Z<br/>kafkamirrormaker2s.kafka.strimzi.io     2020-04-13T16:49:37Z<br/>kafkamirrormakers.kafka.strimzi.io      2020-04-13T16:49:39Z<br/>kafkas.kafka.strimzi.io                 2020-04-13T16:49:40Z<br/>kafkatopics.kafka.strimzi.io            2020-04-13T16:49:34Z<br/>kafkausers.kafka.strimzi.io             2020-04-13T16:49:33Z</span></pre><blockquote class="lh li lj"><p id="8eff" class="jn jo lk jp b jq jr js jt ju jv jw jx ll jz ka kb lm kd ke kf ln kh ki kj kk ij bi translated"><code class="fe mr ms mt mu b"><em class="iq">kafkas.kafka.strimzi.io</em></code> <em class="iq"> CRD在《库伯涅茨》中代表卡夫卡集群</em></p></blockquote><p id="0d03" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们有了“大脑”(Strimzi操作符)，让我们使用它吧！</p></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h1 id="2acb" class="lo lp iq bd lq lr nt lt lu lv nu lx ly lz nv mb mc md nw mf mg mh nx mj mk ml bi translated">是时候创建Kafka集群了！</h1><p id="aaa4" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">如上所述，我们将保持简单，从以下设置开始(我们将在本系列的后续文章中逐步更新):</p><ul class=""><li id="c3ce" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">单节点Kafka集群(和Zookeeper)</li><li id="b444" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">对同一Kubernetes集群中的客户端内部可用</li><li id="e036" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">没有加密、认证或授权</li><li id="5f4a" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">无持久性(使用<code class="fe mr ms mt mu b">emptyDir</code>卷)</li></ul><p id="1fd3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要部署Kafka集群，我们需要做的就是创建一个Strimzi <code class="fe mr ms mt mu b">Kafka</code>资源。看起来是这样的:</p><pre class="nh ni nj nk gt nl mu nm nn aw no bi"><span id="47ef" class="mv lp iq mu b gy np nq l nr ns">apiVersion: kafka.strimzi.io/v1beta1<br/>kind: Kafka<br/>metadata:<br/>  name: my-kafka-cluster<br/>spec:<br/>  kafka:<br/>    version: 2.4.0<br/>    replicas: 1<br/>    listeners:<br/>      plain: {}<br/>    config:<br/>      offsets.topic.replication.factor: 1<br/>      transaction.state.log.replication.factor: 1<br/>      transaction.state.log.min.isr: 1<br/>      log.message.format.version: "2.4"<br/>    storage:<br/>      type: ephemeral<br/>  zookeeper:<br/>    replicas: 1<br/>    storage:<br/>      type: ephemeral</span></pre><blockquote class="lh li lj"><p id="c7c4" class="jn jo lk jp b jq jr js jt ju jv jw jx ll jz ka kb lm kd ke kf ln kh ki kj kk ij bi translated"><em class="iq">详细</em> <code class="fe mr ms mt mu b"><em class="iq">Kafka</em></code> <em class="iq"> CRD参考请查看文档-</em><a class="ae kz" href="https://strimzi.io/docs/operators/master/using.html#type-Kafka-reference" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://strim zi . io/docs/operators/master/using . html # type-Kafka-reference</em></a></p></blockquote><p id="43d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在<code class="fe mr ms mt mu b">metadata.name</code>中定义了星团的名字(<code class="fe mr ms mt mu b">my-kafka-cluster</code>)。以下是<code class="fe mr ms mt mu b">spec.kafka</code>中的属性汇总:</p><ul class=""><li id="4fbd" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated"><code class="fe mr ms mt mu b">version</code>——Kafka broker版本(在撰写本文时默认为<code class="fe mr ms mt mu b">2.5.0</code>，但我们使用的是<code class="fe mr ms mt mu b">2.4.0</code>)</li><li id="9c10" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated"><code class="fe mr ms mt mu b">replicas</code> - Kafka集群大小，即Kafka节点的数量(集群中的<code class="fe mr ms mt mu b">Pod</code></li><li id="8a8f" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated"><code class="fe mr ms mt mu b">listeners</code> -配置Kafka代理的监听器。在本例中，我们使用的是<code class="fe mr ms mt mu b">plain</code>监听器，这意味着集群可以被端口<code class="fe mr ms mt mu b">9092</code>上的内部客户端(在同一个Kubernetes集群中)访问(不涉及加密、认证或授权)。支持的类型有<code class="fe mr ms mt mu b">plain</code>、<code class="fe mr ms mt mu b">tls</code>、<code class="fe mr ms mt mu b">external</code>(参见<a class="ae kz" href="https://strimzi.io/docs/operators/master/using.html#type-KafkaListeners-reference" rel="noopener ugc nofollow" target="_blank">https://strim zi . io/docs/operators/master/using . html # type-KafkaListeners-reference</a>)。配置多个侦听器是可能的(我们将在后续的博客文章中涉及这一点)</li><li id="fbac" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated"><code class="fe mr ms mt mu b">config</code> -这些是用作Kafka代理配置属性的键值对</li><li id="c173" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated"><code class="fe mr ms mt mu b">storage</code>-Kafka集群的存储。支持的类型有<code class="fe mr ms mt mu b">ephemeral</code>、<code class="fe mr ms mt mu b">persistent-claim</code>和<code class="fe mr ms mt mu b">jbod</code>。我们在这个例子中使用了<code class="fe mr ms mt mu b">ephemeral</code>,这意味着使用了<code class="fe mr ms mt mu b"><a class="ae kz" href="https://kubernetes.io/docs/concepts/storage/volumes/#emptydir" rel="noopener ugc nofollow" target="_blank">emptyDir</a></code> <a class="ae kz" href="https://kubernetes.io/docs/concepts/storage/volumes/#emptydir" rel="noopener ugc nofollow" target="_blank">卷</a>,并且该数据只与Kafka代理<code class="fe mr ms mt mu b">Pod</code>的生命周期相关联(未来的博客文章将涉及<code class="fe mr ms mt mu b">persistent-claim</code>存储)</li></ul><p id="891b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Zookeeper集群细节(<code class="fe mr ms mt mu b">spec.zookeeper</code>)类似卡夫卡。在这种情况下，我们只需配置<code class="fe mr ms mt mu b">replicas</code>和<code class="fe mr ms mt mu b">storage</code>类型的编号。详情请参考<a class="ae kz" href="https://strimzi.io/docs/operators/master/using.html#type-ZookeeperClusterSpec-reference" rel="noopener ugc nofollow" target="_blank">https://strim zi . io/docs/operators/master/using . html # type-ZookeeperClusterSpec-reference</a></p><p id="ee2b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要创建Kafka集群，请执行以下操作:</p><pre class="nh ni nj nk gt nl mu nm nn aw no bi"><span id="a7cc" class="mv lp iq mu b gy np nq l nr ns">kubectl apply -f <a class="ae kz" href="https://raw.githubusercontent.com/abhirockzz/kafka-kubernetes-strimzi/master/part-1/kafka.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/abhirockzz/kafka-kubernetes-strimzi/master/part-1/kafka.yaml</a></span></pre></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h1 id="b15b" class="lo lp iq bd lq lr nt lt lu lv nu lx ly lz nv mb mc md nw mf mg mh nx mj mk ml bi translated">下一步是什么？</h1><figure class="nh ni nj nk gt nz gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/9a6a512fcd6a3635c86ffccff283d8ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*_OH3bC96bPEleq3p.gif"/></div></figure><p id="d666" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Strimzi操作符开始行动，创建许多Kubernetes资源来响应我们刚刚创建的<code class="fe mr ms mt mu b">Kafka</code> CRD实例。</p><p id="d7cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将创建以下资源:</p><ul class=""><li id="ae08" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated"><code class="fe mr ms mt mu b">StatefulSet</code> - Kafka和Zookeeper集群以<code class="fe mr ms mt mu b">StatefulSet</code>的形式存在，用于管理Kubernetes中的有状态工作负载。详情请参考<a class="ae kz" href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/docs/concepts/workloads/controllers/stateful set/</a>及相关资料</li><li id="a0fe" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated"><code class="fe mr ms mt mu b">Service</code> - Kubernetes <code class="fe mr ms mt mu b">ClusterIP</code>内部访问服务</li><li id="3f2d" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated"><code class="fe mr ms mt mu b">ConfigMap</code> -卡夫卡和动物园管理员配置存储在Kubernetes <code class="fe mr ms mt mu b"><a class="ae kz" href="https://kubernetes.io/docs/concepts/configuration/configmap/" rel="noopener ugc nofollow" target="_blank">ConfigMap</a></code> s中</li><li id="db93" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">Kubernetes为Kafka集群组件和客户端存储私钥和证书。这些用于TLS加密和认证(将在后续的博客文章中介绍)</li></ul><h2 id="1032" class="mv lp iq bd lq mw mx dn lu my mz dp ly jy na nb mc kc nc nd mg kg ne nf mk ng bi translated">Kafka自定义资源</h2><pre class="nh ni nj nk gt nl mu nm nn aw no bi"><span id="b63d" class="mv lp iq mu b gy np nq l nr ns">kubectl get kafka</span><span id="42a3" class="mv lp iq mu b gy ol nq l nr ns">NAME               DESIRED KAFKA REPLICAS   DESIRED ZK REPLICAS<br/>my-kafka-cluster   1                        1</span></pre><h2 id="0e92" class="mv lp iq bd lq mw mx dn lu my mz dp ly jy na nb mc kc nc nd mg kg ne nf mk ng bi translated"><code class="fe mr ms mt mu b">StatefulSet</code>和<code class="fe mr ms mt mu b">Pod</code></h2><p id="3d25" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">检查卡夫卡和动物园管理员<code class="fe mr ms mt mu b">StatefulSet</code>的使用:</p><pre class="nh ni nj nk gt nl mu nm nn aw no bi"><span id="7c24" class="mv lp iq mu b gy np nq l nr ns">kubectl get statefulset/my-kafka-cluster-zookeeper<br/>kubectl get statefulset/my-kafka-cluster-kafka</span></pre><p id="bdc4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">卡夫卡和动物园管理员</p><pre class="nh ni nj nk gt nl mu nm nn aw no bi"><span id="2fce" class="mv lp iq mu b gy np nq l nr ns">kubectl get pod/my-kafka-cluster-zookeeper-0<br/>kubectl get pod/my-kafka-cluster-kafka-0</span></pre><h2 id="c852" class="mv lp iq bd lq mw mx dn lu my mz dp ly jy na nb mc kc nc nd mg kg ne nf mk ng bi translated"><code class="fe mr ms mt mu b">ConfigMap</code></h2><p id="6382" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">创建单独的<code class="fe mr ms mt mu b">ConfigMap</code>来存储<code class="fe mr ms mt mu b">Kafka</code>和<code class="fe mr ms mt mu b">Zookeeper</code>配置</p><pre class="nh ni nj nk gt nl mu nm nn aw no bi"><span id="aff1" class="mv lp iq mu b gy np nq l nr ns">kubectl get configmap</span><span id="fc18" class="mv lp iq mu b gy ol nq l nr ns">my-kafka-cluster-kafka-config         4      19m<br/>my-kafka-cluster-zookeeper-config     2      20m</span></pre><p id="c75f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们来看看卡夫卡式的结构</p><pre class="nh ni nj nk gt nl mu nm nn aw no bi"><span id="dbf3" class="mv lp iq mu b gy np nq l nr ns">kubectl get configmap/my-kafka-cluster-kafka-config -o yaml</span></pre><p id="d2ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">输出很长，但我会强调重要的部分。作为数据部分的一部分，Kafka代理有两个配置属性— <code class="fe mr ms mt mu b">log4j.properties</code>和<code class="fe mr ms mt mu b">server.config</code>。</p><p id="89e7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是<code class="fe mr ms mt mu b">server.config</code>的一个片段。注意<code class="fe mr ms mt mu b">advertised.listeners</code>(突出显示端口<code class="fe mr ms mt mu b">9092</code>上的内部访问)和<code class="fe mr ms mt mu b">User provided configuration</code>(我们在<code class="fe mr ms mt mu b">yaml</code>清单中指定的那个)</p><pre class="nh ni nj nk gt nl mu nm nn aw no bi"><span id="8c67" class="mv lp iq mu b gy np nq l nr ns">##############################<br/>    ##############################<br/>    # This file is automatically generated by the Strimzi Cluster Operator<br/>    # Any changes to this file will be ignored and overwritten!<br/>    ##############################<br/>    ##############################</span><span id="b619" class="mv lp iq mu b gy ol nq l nr ns">    broker.id=${STRIMZI_BROKER_ID}<br/>    log.dirs=/var/lib/kafka/data/kafka-log${STRIMZI_BROKER_ID}</span><span id="68de" class="mv lp iq mu b gy ol nq l nr ns">    ##########<br/>    # Plain listener<br/>    ##########</span><span id="ede8" class="mv lp iq mu b gy ol nq l nr ns">    ##########<br/>    # Common listener configuration<br/>    ##########<br/>    listeners=REPLICATION-9091://0.0.0.0:9091,PLAIN-9092://0.0.0.0:9092<br/>    advertised.listeners=REPLICATION-9091://my-kafka-cluster-kafka-${STRIMZI_BROKER_ID}.my-kafka-cluster-kafka-brokers.default.svc:9091,PLAIN-9092://my-kafka-cluster-kafka-${STRIMZI_BROKER_ID}.my-kafka-cluster-kafka-brokers.default.svc:9092<br/>    listener.security.protocol.map=REPLICATION-9091:SSL,PLAIN-9092:PLAINTEXT<br/>    inter.broker.listener.name=REPLICATION-9091<br/>    sasl.enabled.mechanisms=<br/>    ssl.secure.random.implementation=SHA1PRNG<br/>    ssl.endpoint.identification.algorithm=HTTPS</span><span id="05aa" class="mv lp iq mu b gy ol nq l nr ns">    ##########<br/>    # User provided configuration<br/>    ##########<br/>    log.message.format.version=2.4<br/>    offsets.topic.replication.factor=1<br/>    transaction.state.log.min.isr=1<br/>    transaction.state.log.replication.factor=1</span></pre><h2 id="da05" class="mv lp iq bd lq mw mx dn lu my mz dp ly jy na nb mc kc nc nd mg kg ne nf mk ng bi translated"><code class="fe mr ms mt mu b">Service</code></h2><p id="0842" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">如果您查询<code class="fe mr ms mt mu b">Service</code> s，您应该会看到类似这样的内容:</p><pre class="nh ni nj nk gt nl mu nm nn aw no bi"><span id="e218" class="mv lp iq mu b gy np nq l nr ns">kubectl get svc</span><span id="6918" class="mv lp iq mu b gy ol nq l nr ns">NAME                                TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)<br/>my-kafka-cluster-kafka-bootstrap    ClusterIP   10.0.240.137   &lt;none&gt;        9091/TCP,9092/TCP<br/>my-kafka-cluster-kafka-brokers      ClusterIP   None           &lt;none&gt;        9091/TCP,9092/TCP<br/>my-kafka-cluster-zookeeper-client   ClusterIP   10.0.143.149   &lt;none&gt;        2181/TCP<br/>my-kafka-cluster-zookeeper-nodes    ClusterIP   None           &lt;none&gt;        2181/TCP,2888/TCP,3888/TCP</span></pre><p id="6dcd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mr ms mt mu b">my-kafka-cluster-kafka-bootstrap</code>使内部Kubernetes客户端可以访问Kafka集群，<code class="fe mr ms mt mu b">my-kafka-cluster-kafka-brokers</code>是与<code class="fe mr ms mt mu b">StatefulSet</code>相对应的<code class="fe mr ms mt mu b"><a class="ae kz" href="https://kubernetes.io/docs/concepts/services-networking/service/#headless-services" rel="noopener ugc nofollow" target="_blank">Headless</a></code> <a class="ae kz" href="https://kubernetes.io/docs/concepts/services-networking/service/#headless-services" rel="noopener ugc nofollow" target="_blank">服务</a></p><h2 id="0cf6" class="mv lp iq bd lq mw mx dn lu my mz dp ly jy na nb mc kc nc nd mg kg ne nf mk ng bi translated"><code class="fe mr ms mt mu b">Secret</code></h2><p id="7c76" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">虽然我们没有使用它们，但是看看由<code class="fe mr ms mt mu b">Strimzi</code>创造的<code class="fe mr ms mt mu b">Secret</code>是有帮助的:</p><pre class="nh ni nj nk gt nl mu nm nn aw no bi"><span id="94b0" class="mv lp iq mu b gy np nq l nr ns">kubectl get secret</span><span id="a206" class="mv lp iq mu b gy ol nq l nr ns">my-kafka-cluster-clients-ca               Opaque<br/>my-kafka-cluster-clients-ca-cert          Opaque<br/>my-kafka-cluster-cluster-ca               Opaque<br/>my-kafka-cluster-cluster-ca-cert          Opaque<br/>my-kafka-cluster-cluster-operator-certs   Opaque<br/>my-kafka-cluster-kafka-brokers            Opaque<br/>my-kafka-cluster-kafka-token-vb2qt        kubernetes.io/service-account-token<br/>my-kafka-cluster-zookeeper-nodes          Opaque<br/>my-kafka-cluster-zookeeper-token-xq8m2    kubernetes.io/service-account-token</span></pre><ul class=""><li id="12ef" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated"><code class="fe mr ms mt mu b">my-kafka-cluster-cluster-ca-cert</code> -集群CA证书，用于签署Kafka代理证书，并由连接客户端用于建立TLS加密连接</li><li id="c526" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated"><code class="fe mr ms mt mu b">my-kafka-cluster-clients-ca-cert</code> -客户端CA证书，供用户签署自己的客户端证书，以允许针对Kafka集群进行相互身份验证</li></ul></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h1 id="9891" class="lo lp iq bd lq lr nt lt lu lv nu lx ly lz nv mb mc md nw mf mg mh nx mj mk ml bi translated">好吧，但是它有用吗？</h1><p id="4ab0" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">让我们去兜一圈吧！</p><p id="cc5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建制作人<code class="fe mr ms mt mu b">Pod</code>:</p><pre class="nh ni nj nk gt nl mu nm nn aw no bi"><span id="7ea9" class="mv lp iq mu b gy np nq l nr ns">export KAFKA_CLUSTER_NAME=my-kafka-cluster</span><span id="ecd5" class="mv lp iq mu b gy ol nq l nr ns">kubectl run kafka-producer -ti --image=strimzi/kafka:latest-kafka-2.4.0 --rm=true --restart=Never -- bin/kafka-console-producer.sh --broker-list $KAFKA_CLUSTER_NAME-kafka-bootstrap:9092 --topic my-topic</span></pre><p id="271e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在另一个终端中，创建一个消费者<code class="fe mr ms mt mu b">Pod</code>:</p><pre class="nh ni nj nk gt nl mu nm nn aw no bi"><span id="a15b" class="mv lp iq mu b gy np nq l nr ns">export KAFKA_CLUSTER_NAME=my-kafka-cluster</span><span id="7ce2" class="mv lp iq mu b gy ol nq l nr ns">kubectl run kafka-consumer -ti --image=strimzi/kafka:latest-kafka-2.4.0 --rm=true --restart=Never -- bin/kafka-console-consumer.sh --bootstrap-server $KAFKA_CLUSTER_NAME-kafka-bootstrap:9092 --topic my-topic --from-beginning</span></pre><blockquote class="lh li lj"><p id="f792" class="jn jo lk jp b jq jr js jt ju jv jw jx ll jz ka kb lm kd ke kf ln kh ki kj kk ij bi translated"><em class="iq">以上演示摘自strim zi doc—</em><a class="ae kz" href="https://strimzi.io/docs/operators/master/deploying.html#deploying-example-clients-str" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://strim zi . io/docs/operators/master/deploying . html # deploying-example-clients-str</em></a></p><p id="d3b8" class="jn jo lk jp b jq jr js jt ju jv jw jx ll jz ka kb lm kd ke kf ln kh ki kj kk ij bi translated"><em class="iq">您也可以使用其他客户端</em></p></blockquote></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h1 id="4226" class="lo lp iq bd lq lr nt lt lu lv nu lx ly lz nv mb mc md nw mf mg mh nx mj mk ml bi translated">我们才刚刚开始…</h1><p id="b524" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">我们开始时规模很小，但是在Kubernetes上有一个Kafka集群，它很有效(希望对你也一样！).正如我之前提到的，这是一个多部分博客系列的开始。敬请关注即将发布的帖子，我们将探讨其他方面，如外部客户端访问、TLS访问、身份验证、持久性等。</p></div></div>    
</body>
</html>