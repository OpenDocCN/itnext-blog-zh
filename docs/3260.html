<html>
<head>
<title>JSF*ck — Does code weirdness affect execution performance?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">JSF·CK——代码古怪会影响执行性能吗？</h1>
<blockquote>原文：<a href="https://itnext.io/jsf-ck-does-code-weirdness-affect-execution-performance-779816003ef1?source=collection_archive---------1-----------------------#2019-11-07">https://itnext.io/jsf-ck-does-code-weirdness-affect-execution-performance-779816003ef1?source=collection_archive---------1-----------------------#2019-11-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="94b0" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">检查我们如何编写JS是否可以改变其执行的性能，即使是相同的代码？</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0c4f800f94be8bfa0c9524a7621d75ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*S_FSemQCdKnat8U_.jpg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">来源:https://media.boingboing.net/<a class="ae kv" href="https://media.boingboing.net/" rel="noopener ugc nofollow" target="_blank"/></figcaption></figure><blockquote class="kw kx ky"><p id="d5b4" class="kz la lb lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated"><em class="iq">这篇文章是基于马丁·克莱普(</em> <a class="ae kv" href="https://twitter.com/aemkei" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> @aemkei </em> </a> <em class="iq">)关于将JS转换成仅六个基本字符并保持其可执行性的工作而创建的。是对来自</em> <a class="ae kv" href="https://www.youtube.com/watch?v=sRWE5tnaxlI&amp;lc=Ugw8lYvWtPQReYaahmZ4AaABAg" rel="noopener ugc nofollow" target="_blank"> <em class="iq">的评论的回应乔纳森的意思是</em> </a> <em class="iq">。</em></p></blockquote><p id="6dcd" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">对于那些断章取义的读者，在开始测试之前，我将花点时间解释一下这个问题。</p><h1 id="ba4b" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">什么是JSF*ck？</h1><p id="9c46" class="pw-post-body-paragraph kz la iq lc b ld mr jr lf lg ms ju li lw mt ll lm lx mu lp lq ly mv lt lu lv ij bi translated">除了是NSFW，这是一种只用六个字符编写和执行JS代码的编程风格。我们之所以能这样做，是因为有一种叫做<strong class="lc ir">型强制</strong>的东西。JS强制偶尔会在JS会议上出现(主要是为了制作一些有趣的视频)，它的目的是允许用户操作不同类型的类型，而不是显式地将它们转换成一种类型。</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="f07a" class="nb ma iq mx b gy nc nd l ne nf">const a = "1" + 5 // "15"</span></pre><p id="6993" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">这个想法很棒，但有时(或者更可能是经常)人们不明白它实际上是如何工作的。对于那些对这个想法感兴趣的人，这里有一个规范的链接<a class="ae kv" href="http://www.ecma-international.org/ecma-262/#sec-type-conversion" rel="noopener ugc nofollow" target="_blank">http://www . ECMA-international . org/ECMA-262/# sec-type-conversion</a>。</p><p id="3aa7" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">大多数演讲都选择了一些非直觉的例子，比如</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="2697" class="nb ma iq mx b gy nc nd l ne nf">const a = [] + [] // ""</span></pre><p id="c9b2" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">还是最有名的一个(<code class="fe ng nh ni mx b">+ +"a"</code>回报<strong class="lc ir">“楠”</strong>)</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="d77d" class="nb ma iq mx b gy nc nd l ne nf">// "banana"<br/>const yellowFruit = ("b" + "a" + +"a" + "a").toLocaleLowerCase()</span></pre><h1 id="9523" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">我们能用它做什么？</h1><p id="8be2" class="pw-post-body-paragraph kz la iq lc b ld mr jr lf lg ms ju li lw mt ll lm lx mu lp lq ly mv lt lu lv ij bi translated">由于强制，我们应该能够在JavaScript中创建任何有效的句子(包括求值)。如果我们能做到这一点，那么我们应该能够将我们的代码转换成如下形式:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="33e5" class="nb ma iq mx b gy nc nd l ne nf">// 5+4<br/>[!+[]+!+[]+!+[]+!+[]+!+[]]+(+(+!+[]+(!+[]+[])[!+[]+!+[]+!+[]]+[+!+[]]+[+[]]+[+[]])+[])[!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]]</span></pre><p id="21f4" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">实现这一点并不像你想象的那么简单。</p><p id="87eb" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">得到一个字符串形式的数字</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="329a" class="nb ma iq mx b gy nc nd l ne nf">+[] // "0"<br/>+!+[] // "1"<br/>[+!+[]]+[+[]] // "10</span></pre><p id="f56e" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">获得字符串更加困难</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="b50c" class="nb ma iq mx b gy nc nd l ne nf">[][[]][!+[]+!+[]] // "d" or "undefined"[2]</span></pre><p id="db4b" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">它利用了字符串可以作为字符数组被访问的事实，你可以通过调用<code class="fe ng nh ni mx b">[][[]]</code>很容易地生成<strong class="lc ir"> "undefined" </strong>字符串。</p><p id="f26a" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">我不打算详细解释其中的每一个。https://www.youtube.com/watch?v=sRWE5tnaxlI的T2发布了一个很棒的视频，涵盖了这个话题。如果你想玩它，请去http://www.jsfuck.com/的<a class="ae kv" href="http://www.jsfuck.com/" rel="noopener ugc nofollow" target="_blank">试试你的代码。</a></p><h1 id="a2e1" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">对性能的影响</h1><p id="37a3" class="pw-post-body-paragraph kz la iq lc b ld mr jr lf lg ms ju li lw mt ll lm lx mu lp lq ly mv lt lu lv ij bi translated">您可能会注意到，以这种方式写下整串代码非常占用空间。我已经设法将一些测试代码解析成JSF约定和代码，如下所示</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="908f" class="nb ma iq mx b gy nc nd l ne nf">const startT1 = Date.now();<br/><br/>const N = 10000;<br/><br/>let f = { tmp: 3, tmp2: 3, tmp3: 3, tmp4: 3, tmp5: 3, a: 'Gandalf', b: 'The Grey' };<br/>let f2 = { tmp: 3, tmp2: 3, tmp3: 3, tmp4: 3, tmp5: 3, a: 'Jack', b: 'Sparrow' };<br/>let f3 = { tmp: 3, tmp2: 3, tmp3: 3, tmp4: 3, tmp5: 3, a: 'Charles', b: 'Xavier' };<br/>let f4 = { tmp: 3, tmp2: 3, tmp3: 3, tmp4: 3, tmp5: 3, a: 'Frodo', b: 'Baggins' };<br/>let f5 = { tmp: 3, tmp2: 3, tmp3: 3, tmp4: 3, tmp5: 3, a: 'Legolas', b: 'Thranduilion' };<br/>let f6 = { tmp: 3, tmp2: 3, tmp3: 3, tmp4: 3, tmp5: 3, a: 'Indiana', b: 'Jones' };<br/><br/>function test(obj) {<br/>  let result = '';<br/>  for (let i = 0; i &lt; N; i += 1) {<br/>    result += obj.a + obj.b;<br/>  }<br/>  return result;<br/>}<br/><br/>for(let i = 0; i &lt; N; i += 1) {<br/>	test(f);<br/>	test(f2);<br/>	test(f3);<br/>	test(f4);<br/>	test(f5);<br/>	test(f6);<br/>}<br/>console.log("test with one shape:", Date.now() - startT1, "ms.");</span></pre><p id="9de0" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">解析成847192行长的字符串。因此，我们现在有828KB的文件，而不是1KB以上。您可以在这里获取代码<a class="ae kv" href="https://gist.github.com/burnpiro/5a177d8bb307005c4d8f5672fe9ff0a3" rel="noopener ugc nofollow" target="_blank">，并通过调用<code class="fe ng nh ni mx b">node index.js</code>来执行它。</a></p><h2 id="d2fd" class="nb ma iq bd mb nj nk dn mf nl nm dp mj lw nn no ml lx np nq mn ly nr ns mp nt bi translated">是时候开始测试我们的代码了！！！</h2><p id="a2c1" class="pw-post-body-paragraph kz la iq lc b ld mr jr lf lg ms ju li lw mt ll lm lx mu lp lq ly mv lt lu lv ij bi translated">测试环境:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="9d7b" class="nb ma iq mx b gy nc nd l ne nf">Ubuntu 18.04 <br/>Node 12.13.0 <br/>Intel i7-7820X</span></pre><p id="7d8f" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated"><strong class="lc ir">测试示例:</strong></p><ul class=""><li id="37b8" class="nu nv iq lc b ld le lg lh lw nw lx nx ly ny lv nz oa ob oc bi translated">标准呼叫—<a class="ae kv" href="https://gist.github.com/burnpiro/56be270ac032924faf48824e08995687" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/burnpiro/56be 270 AC 032924 faf 48824 e 08995687</a></li><li id="013c" class="nu nv iq lc b ld od lg oe lw of lx og ly oh lv nz oa ob oc bi translated">string eval—<a class="ae kv" href="https://gist.github.com/burnpiro/ffaa8edac33370e1aa5126c83fb728bb" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/burn piro/ffaa 8 edac 33370 E1 aa 5126 c 83 FB 728 bb</a></li><li id="7d58" class="nu nv iq lc b ld od lg oe lw of lx og ly oh lv nz oa ob oc bi translated">JSF评估—<a class="ae kv" href="https://gist.github.com/burnpiro/5a177d8bb307005c4d8f5672fe9ff0a3" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/burnpiro/5a 177 D8 bb 307005 C4 D8 f 5672 Fe 9 ff 0 a 3</a></li></ul><p id="d68b" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">我测试了两次标准函数，以便能够发现<code class="fe ng nh ni mx b">eval</code>执行中的差异。</p><p id="e5b9" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated"><strong class="lc ir">测试结果:</strong></p><p id="365f" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">标准呼叫(50个样本)</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="0975" class="nb ma iq mx b gy nc nd l ne nf">AVG: 3274ms <br/>Std. Dev: 7ms <br/>Heap: 8.06MB</span></pre><p id="6c09" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">字符串评估(50个样本)</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="d9d6" class="nb ma iq mx b gy nc nd l ne nf">AVG: 3272ms <br/>Std. Dev: 6ms <br/>Heap: 8.08MB</span></pre><p id="a0f8" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated"><strong class="lc ir"> JSF </strong>评估(50个样本):</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="57e2" class="nb ma iq mx b gy nc nd l ne nf">AVG: 3241ms <br/>Std. Dev: 8ms <br/>Heap: 18.88MB</span></pre><blockquote class="kw kx ky"><p id="11b0" class="kz la lb lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated"><em class="iq">注意！您机器上的值可能不同，因为您使用的是不同版本的nodeJS或不同的处理器。</em></p></blockquote><h1 id="802e" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">结论</h1><p id="1ccc" class="pw-post-body-paragraph kz la iq lc b ld mr jr lf lg ms ju li lw mt ll lm lx mu lp lq ly mv lt lu lv ij bi translated">V8 (node)中同一代码不同版本的执行性能没有区别。这里看到的是V8使用的内存量，这是意料之中的，但也是非常重要的。求值和标准函数调用几乎没有区别，但是将代码解析为JSF比原始代码需要更多的内存。</p><p id="47b0" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">你看了也没那么惊讶。在JS Engine中存储和解析1MB的文件要比1KB的文件占用更多的内存。</p><p id="f82e" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">即使JSF代码不实用，人们也可以通过阅读它的一部分来更好地理解JS是如何工作的。类型强制并不像许多人在推特上说的那样神奇。我知道<strong class="lc ir"> <em class="lb">“任何足够先进的技术都无法与魔法区分开来”</em> </strong>(克拉克第一定律)但我喜欢重新表述一下:<strong class="lc ir"> <em class="lb">“任何无法理解的技术都无法与魔法区分开来”</em> </strong>。如果你能理解它，它就不再是魔法了:)</p></div><div class="ab cl oi oj hu ok" role="separator"><span class="ol bw bk om on oo"/><span class="ol bw bk om on oo"/><span class="ol bw bk om on"/></div><div class="ij ik il im in"><p id="2bcb" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated"><em class="lb">最初发布于</em><a class="ae kv" href="https://erdem.pl/2019/11/jsf-ck-does-code-weirdness-affect-execution-performance" rel="noopener ugc nofollow" target="_blank"><em class="lb">https://erdem . pl</em></a><em class="lb">。</em></p></div></div>    
</body>
</html>