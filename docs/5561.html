<html>
<head>
<title>How to run parallel tests in Ruby Minitest on Github Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Github Actions上运行Ruby Minitest中的并行测试</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-run-parallel-tests-in-ruby-minitest-on-github-actions-97b985f22fa7?source=collection_archive---------3-----------------------#2021-04-04">https://itnext.io/how-to-run-parallel-tests-in-ruby-minitest-on-github-actions-97b985f22fa7?source=collection_archive---------3-----------------------#2021-04-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="8d1b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如何在Github Actions上的Minitest中运行Ruby on Rails测试？如果测试很慢该怎么办？如何管理复杂的工作流程？您可以使用Github Actions构建矩阵来在作业之间划分Minitest文件，从而更快地运行测试套件。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/fcca7ed70f5c3e9e46f32166a90f547d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Aw7G-7r6ite7jSJl.jpeg"/></div></div></figure><p id="b8e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您的Minitest测试需要几十分钟，并且您想为您的Ruby工程团队节省一些时间，那么您可以在CI服务器上使用测试并行化。</p><p id="40ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了尽可能快地运行测试，您需要将它们分成相等的时段(并行作业)。但是怎么做呢？一些测试文件的执行速度非常快，如果运行系统测试(E2E测试)，其他Minitest文件可能需要几分钟。</p><p id="8582" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还有一个方面是为每个并行作业准备测试环境。我说的准备是指你需要克隆一个库，安装ruby gems或者从缓存中加载它们，也许你需要加载一些docker容器，等等。这可能会在每个并行作业上花费不同的时间。随机的网络错误会发生，比如网络延迟<a class="ae kx" href="https://docs.knapsackpro.com/2021/how-to-load-ruby-gems-from-cache-on-github-actions" rel="noopener ugc nofollow" target="_blank">加载缓存的gem</a>，或者Github动作有时会使你的某个作业比其他作业启动得晚。这是网络环境中不可避免的问题，会导致您的测试在每个并行任务上运行不同的时间。这在下图中可以看到，它导致CI构建变慢。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ky"><img src="../Images/89468c2e1613562df371272ff8f28005.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*S8It5e2Db10fLz1g.png"/></div></div></figure><p id="334e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在一个完美的场景中，您希望涵盖所有这些问题，并且无论如何，仍然能够以一种确保每个并行作业上的测试在相似的时间完成的方式，在并行作业中分割迷你测试工作。这保证了没有瓶颈。完美的测试划分如下图所示。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kz"><img src="../Images/db49e76a8672d3ac5ff0d1a0b43a80b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kH7OIYOYpES5cqxk.png"/></div></div></figure><h1 id="eee3" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">使用队列模式以动态方式分割测试</h1><p id="e8ad" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">您可以使用<a class="ae kx" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=medium-run-minitest-on-github-actions-with-parallel-jobs-using-build-matrix" rel="noopener ugc nofollow" target="_blank">背包Pro </a>队列模式在并行任务之间动态地分割测试。这样，每个作业都会消耗队列中的测试，直到队列为空。简单地说，这允许您有效地利用CI服务器资源，并在最佳时间运行测试。</p><p id="9752" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我描述了<a class="ae kx" href="https://docs.knapsackpro.com/2020/how-to-speed-up-ruby-and-javascript-tests-with-ci-parallelisation" rel="noopener ugc nofollow" target="_blank">队列模式如何与动态测试套件分割</a>并行分割Ruby和JavaScript测试。你可以从那篇文章中了解一下。</p><h1 id="57ad" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">Github动作构建矩阵来运行并行测试</h1><p id="2ae7" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">Github Actions有一个<a class="ae kx" href="https://docs.github.com/en/actions/learn-github-actions/managing-complex-workflows#using-a-build-matrix" rel="noopener ugc nofollow" target="_blank">构建矩阵特性</a>，允许同时运行许多作业。您可以使用它在并行作业之间运行Minitest测试。</p><p id="ae1e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是Rails项目和Minitest的完整Github Actions YML配置。测试是用<code class="fe md me mf mg b">knapsack_pro</code> Ruby gem和队列模式来划分的。</p><pre class="km kn ko kp gt mh mg mi mj aw mk bi"><span id="29cb" class="ml lb iq mg b gy mm mn l mo mp">name: Main<br/><br/>on: [push]<br/><br/>jobs:<br/>  test:<br/>    runs-on: ubuntu-latest<br/><br/>    <em class="mq"># If you need DB like PostgreSQL, Redis then define service below.</em><br/>    <em class="mq"># </em><a class="ae kx" href="https://github.com/actions/example-services/tree/master/.github/workflows" rel="noopener ugc nofollow" target="_blank"><em class="mq">https://github.com/actions/example-services/tree/master/.github/workflows</em></a><br/>    services:<br/>      postgres:<br/>        image: postgres:10.8<br/>        env:<br/>          POSTGRES_USER: postgres<br/>          POSTGRES_PASSWORD: ""<br/>          POSTGRES_DB: postgres<br/>        ports:<br/>          - 5432:5432<br/>        <em class="mq"># needed because the postgres container does not provide a healthcheck</em><br/>        <em class="mq"># tmpfs makes DB faster by using RAM</em><br/>        options: &gt;-<br/>          --mount type=tmpfs,destination=/var/lib/postgresql/data<br/>          --health-cmd pg_isready<br/>          --health-interval 10s<br/>          --health-timeout 5s<br/>          --health-retries 5<br/>      redis:<br/>        image: redis<br/>        ports:<br/>          - 6379:6379<br/>        options: --entrypoint redis-server<br/><br/>    <em class="mq"># </em><a class="ae kx" href="https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idstrategymatrix" rel="noopener ugc nofollow" target="_blank"><em class="mq">https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idstrategymatrix</em></a><br/>    strategy:<br/>      fail-fast: false<br/>      matrix:<br/>        <em class="mq"># Set N number of parallel jobs you want to run tests on.</em><br/>        <em class="mq"># Use higher number if you have slow tests to split them on more parallel jobs.</em><br/>        <em class="mq"># Remember to update ci_node_index below to 0..N-1</em><br/>        ci_node_total: [8]<br/>        <em class="mq"># set N-1 indexes for parallel jobs</em><br/>        <em class="mq"># When you run 2 parallel jobs then first job will have index 0, the second job will have index 1 etc</em><br/>        ci_node_index: [0, 1, 2, 3, 4, 5, 6, 7]<br/><br/>    env:<br/>      RAILS_ENV: test<br/>      PGHOST: localhost<br/>      PGUSER: postgres<br/>      <em class="mq"># Rails verifies Time Zone in DB is the same as time zone of the Rails app</em><br/>      TZ: "Europe/Warsaw"<br/><br/>    steps:<br/>      - uses: actions/checkout@v2<br/><br/>      - name: Set up Ruby<br/>        uses: ruby/setup-ruby@v1<br/>        with:<br/>          <em class="mq"># Not needed with a .ruby-version file</em><br/>          ruby-version: 2.7<br/>          <em class="mq"># runs 'bundle install' and caches installed gems automatically</em><br/>          bundler-cache: true<br/><br/>      - name: Create DB<br/>        run: |<br/>          bin/rails db:prepare<br/>      - name: Run tests<br/>        env:<br/>          KNAPSACK_PRO_TEST_SUITE_TOKEN_MINITEST: ${{ secrets.KNAPSACK_PRO_TEST_SUITE_TOKEN_MINITEST }}<br/>          KNAPSACK_PRO_CI_NODE_TOTAL: ${{ matrix.ci_node_total }}<br/>          KNAPSACK_PRO_CI_NODE_INDEX: ${{ matrix.ci_node_index }}<br/>          KNAPSACK_PRO_FIXED_QUEUE_SPLIT: true<br/>          KNAPSACK_PRO_LOG_LEVEL: info<br/>        run: |<br/>          bundle exec rake knapsack_pro:queue:minitest</span></pre><h1 id="59e0" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">摘要</h1><p id="6f20" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">如您所见，缓慢的Minitest测试套件对您来说并不是问题。QA、测试人员或自动化工程师可以从提高CI构建速度中受益，并允许他们的软件开发团队更快地交付产品。可以在<a class="ae kx" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=medium-run-minitest-on-github-actions-with-parallel-jobs-using-build-matrix" rel="noopener ugc nofollow" target="_blank">背包Pro </a>了解更多。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/35bc71699236b0063da60a381d917232.png" data-original-src="https://miro.medium.com/v2/resize:fit:160/format:webp/0*O9Qgvfz7AGYD-XEn.png"/></div></figure></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><p id="c1ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mq">原载于2021年4月4日</em><a class="ae kx" href="https://docs.knapsackpro.com/2021/run-minitest-on-github-actions-with-parallel-jobs-using-build-matrix" rel="noopener ugc nofollow" target="_blank"><em class="mq"/></a><em class="mq">。</em></p></div></div>    
</body>
</html>