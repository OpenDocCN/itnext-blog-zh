<html>
<head>
<title>Startup. Simple production setup.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">启动。简单的生产设置。</h1>
<blockquote>原文：<a href="https://itnext.io/startup-simple-production-setup-27de280c4159?source=collection_archive---------2-----------------------#2018-08-06">https://itnext.io/startup-simple-production-setup-27de280c4159?source=collection_archive---------2-----------------------#2018-08-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="c93b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">第1部分—编织网。Docker覆盖网络。</h2></div><p id="da97" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi lb translated">你好，你好。我开始讲述我的第一个上市公司的故事，我想展示我从研究和调查到上市候选人的所有步骤。我会把一个大故事分成几个逻辑部分，这样就不会让阅读变得困难。每个部分都将包含生产使用的技术理念和细节。这是一家初创公司，所以不是所有的事情都是理想的:)</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi lk"><img src="../Images/393d74b36fb275711aa6de6658bed264.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pO5MqfZH4PQ-T26iJQrwXA.jpeg"/></div></div></figure><h2 id="8c40" class="lw lx iq bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">五金器具</h2><p id="98e8" class="pw-post-body-paragraph kf kg iq kh b ki mp jr kk kl mq ju kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">生产服务器将被托管在<a class="ae mu" href="https://www.hetzner.de/" rel="noopener ugc nofollow" target="_blank">赫茨纳</a>上。它不是一个强大的服务器，但它足以测试生产架构和低负载公共使用的开放启动。</p><p id="788f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">服务器配置:</p><ul class=""><li id="925f" class="mv mw iq kh b ki kj kl km ko mx ks my kw mz la na nb nc nd bi translated">8个CPU</li><li id="62d7" class="mv mw iq kh b ki ne kl nf ko ng ks nh kw ni la na nb nc nd bi translated">64GB内存</li><li id="512a" class="mv mw iq kh b ki ne kl nf ko ng ks nh kw ni la na nb nc nd bi translated">2块500GB固态硬盘</li><li id="c405" class="mv mw iq kh b ki ne kl nf ko ng ks nh kw ni la na nb nc nd bi translated">最低安装Ubuntu 18.04 LTS</li></ul><h2 id="d5c7" class="lw lx iq bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">软件</h2><ul class=""><li id="c4b5" class="mv mw iq kh b ki mp kl mq ko nj ks nk kw nl la na nb nc nd bi translated">虚拟化KVM</li><li id="21e7" class="mv mw iq kh b ki ne kl nf ko ng ks nh kw ni la na nb nc nd bi translated">集装箱码头编号18.06.0-ce</li><li id="3562" class="mv mw iq kh b ki ne kl nf ko ng ks nh kw ni la na nb nc nd bi translated"><a class="ae mu" href="https://www.consul.io/" rel="noopener ugc nofollow" target="_blank">咨询</a> —服务发现和键值存储</li><li id="6a4b" class="mv mw iq kh b ki ne kl nf ko ng ks nh kw ni la na nb nc nd bi translated"><a class="ae mu" href="https://redis.io/" rel="noopener ugc nofollow" target="_blank"> Redis </a> —键值存储和会话存储</li><li id="a454" class="mv mw iq kh b ki ne kl nf ko ng ks nh kw ni la na nb nc nd bi translated"><a class="ae mu" href="https://www.rabbitmq.com/" rel="noopener ugc nofollow" target="_blank"> RabbitMQ </a> —排队系统</li><li id="63ca" class="mv mw iq kh b ki ne kl nf ko ng ks nh kw ni la na nb nc nd bi translated"><a class="ae mu" href="https://www.postgresql.org/" rel="noopener ugc nofollow" target="_blank"> Postgresql </a> —持久数据库</li><li id="98fd" class="mv mw iq kh b ki ne kl nf ko ng ks nh kw ni la na nb nc nd bi translated"><a class="ae mu" href="https://www.voltdb.com/" rel="noopener ugc nofollow" target="_blank"> VoltDB </a> —分析系统和即席查询系统</li><li id="f9d7" class="mv mw iq kh b ki ne kl nf ko ng ks nh kw ni la na nb nc nd bi translated"><a class="ae mu" href="https://www.weave.works/" rel="noopener ugc nofollow" target="_blank"> WeaveNet </a> —集装箱通信网络覆盖</li><li id="bdbe" class="mv mw iq kh b ki ne kl nf ko ng ks nh kw ni la na nb nc nd bi translated"><a class="ae mu" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Go </a> —应用逻辑的主要语言</li></ul><h2 id="bc85" class="lw lx iq bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">体系结构</h2><p id="3ee3" class="pw-post-body-paragraph kf kg iq kh b ki mp jr kk kl mq ju kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">两台虚拟机将放置在主机上。第一个具有2个CPU的虚拟机—用于数据库(Postgresql用于配置、授权、应用程序配置等。用于实时分析和特别查询的VoltDB)。第二个具有4个CPU的虚拟机—用于应用程序逻辑。</p><p id="7734" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">主机也有docker，用于协商集群。所有应用程序配置、参数、健康检查、服务发现都将放在那里。Consul将生成nginx上游配置，用于平衡容器之间的流量。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/4c141f71bae98982679765b031314973.png" data-original-src="https://miro.medium.com/v2/resize:fit:1382/format:webp/1*UKYNoug9rI3nscvZfujm0g.png"/></div><figcaption class="nn no gj gh gi np nq bd b be z dk translated">体系结构</figcaption></figure><h2 id="3d91" class="lw lx iq bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">目标</h2><ol class=""><li id="d0bb" class="mv mw iq kh b ki mp kl mq ko nj ks nk kw nl la nr nb nc nd bi translated">建立稳定的生产环境</li><li id="a516" class="mv mw iq kh b ki ne kl nf ko ng ks nh kw ni la nr nb nc nd bi translated">通过负载和逻辑在主机之间逻辑分离容器</li><li id="5a16" class="mv mw iq kh b ki ne kl nf ko ng ks nh kw ni la nr nb nc nd bi translated">容器应该可以从任何主机上看到</li></ol></div><div class="ab cl ns nt hu nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ij ik il im in"><p id="cad5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，我们的虚拟环境是完全配置的，docker安装在每台主机上，主机通过网络和iptables是可见的，没有任何限制。我们的虚拟网络配置如下:</p><ul class=""><li id="b31c" class="mv mw iq kh b ki kj kl km ko mx ks my kw mz la na nb nc nd bi translated">主机虚拟机— 192.168.123.1。主机虚拟机具有公共IPv4和公共IPv6网络。</li><li id="9af7" class="mv mw iq kh b ki ne kl nf ko ng ks nh kw ni la na nb nc nd bi translated">工作虚拟机— 192.168.123.11</li><li id="f0a9" class="mv mw iq kh b ki ne kl nf ko ng ks nh kw ni la na nb nc nd bi translated">数据库虚拟机— 192.168.123.15</li></ul><p id="6a09" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Docker网络具有默认的bridge0接口，其范围为172.17.0.0/16。</p><p id="452e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于编织网，我将使用172.20.0.0/16范围。</p></div><div class="ab cl ns nt hu nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ij ik il im in"><h2 id="8d32" class="lw lx iq bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">编织网装置</h2><p id="4e65" class="pw-post-body-paragraph kf kg iq kh b ki mp jr kk kl mq ju kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated"><a class="ae mu" href="https://www.weave.works/docs/net/latest/concepts/" rel="noopener ugc nofollow" target="_blank"> Weave Net文档</a>是理解覆盖网络如何工作以及如何设置它以适应不同环境的良好起点。我选择这个网络是因为它不需要安装额外软件，易于配置和管理子网，易于添加/删除新主机。</p><ul class=""><li id="7c6e" class="mv mw iq kh b ki kj kl km ko mx ks my kw mz la na nb nc nd bi translated">安装编织网络二进制</li></ul><pre class="ll lm ln lo gt nz oa ob oc aw od bi"><span id="fd65" class="lw lx iq oa b gy oe of l og oh"><strong class="oa ir">curl</strong> -L git.io/weave -o /usr/local/bin/weave<br/><strong class="oa ir">chmod</strong> a+x /usr/local/bin/weave</span></pre><blockquote class="oi oj ok"><p id="ca0e" class="kf kg ol kh b ki kj jr kk kl km ju kn om kp kq kr on kt ku kv oo kx ky kz la ij bi translated">根据文档，Weave Net定期检查自己的CDN是否有新版本。要禁用此功能，只需在启动编织网之前<strong class="kh ir">导出检查点_禁用=1 </strong>。</p></blockquote><ul class=""><li id="6de9" class="mv mw iq kh b ki kj kl km ko mx ks my kw mz la na nb nc nd bi translated">与同行推出织网。从<em class="ol">根</em>用户在主机和虚拟机上执行该命令。</li></ul><pre class="ll lm ln lo gt nz oa ob oc aw od bi"><span id="42e2" class="lw lx iq oa b gy oe of l og oh"><strong class="oa ir">weave launch</strong> --ipalloc-range=172.20.0.0/16 192.168.123.11 192.168.123.1 192.168.123.15</span></pre><ul class=""><li id="5693" class="mv mw iq kh b ki kj kl km ko mx ks my kw mz la na nb nc nd bi translated">编织网状态</li></ul><pre class="ll lm ln lo gt nz oa ob oc aw od bi"><span id="0c57" class="lw lx iq oa b gy oe of l og oh"># <strong class="oa ir">weave status</strong></span><span id="2349" class="lw lx iq oa b gy op of l og oh">Version: 2.4.0 (up to date; next check at 2018/08/02 15:50:56)</span><span id="8cc2" class="lw lx iq oa b gy op of l og oh">Service: router<br/>       Protocol: weave 1..2<br/>           Name: d2:15:65:66:6f:e1(worker)<br/>     Encryption: disabled<br/>  PeerDiscovery: enabled<br/>        Targets: 1<br/>    Connections: 1 (1 established)<br/>          Peers: 2 (with 2 established connections)<br/> TrustedSubnets: none</span><span id="9731" class="lw lx iq oa b gy op of l og oh">Service: ipam<br/>         Status: ready<br/>          Range: 172.20.0.0/16<br/>  DefaultSubnet: 172.20.0.0/16</span><span id="71ac" class="lw lx iq oa b gy op of l og oh">Service: dns<br/>         Domain: weave.local.<br/>       Upstream: 127.0.0.53<br/>            TTL: 1<br/>        Entries: 0</span><span id="c06e" class="lw lx iq oa b gy op of l og oh">Service: proxy<br/>        Address: unix:///var/run/weave/weave.sock</span><span id="eeec" class="lw lx iq oa b gy op of l og oh">Service: plugin (legacy)<br/>     DriverName: weave</span></pre><ul class=""><li id="fda7" class="mv mw iq kh b ki kj kl km ko mx ks my kw mz la na nb nc nd bi translated">默认情况下，您不能通过主机访问覆盖网络。为此，只需从池中暴露IP。下一个命令显示IP，将路由添加到路由表，并创建所需的iptables规则</li></ul><pre class="ll lm ln lo gt nz oa ob oc aw od bi"><span id="4acb" class="lw lx iq oa b gy oe of l og oh"><strong class="oa ir">weave expose</strong></span></pre><ul class=""><li id="f165" class="mv mw iq kh b ki kj kl km ko mx ks my kw mz la na nb nc nd bi translated">如果你想从另一个不存在编织网的主机连接到编织网中的容器，你应该添加<strong class="kh ir"> <em class="ol">路由</em> </strong>到存在暴露IP的主机</li></ul><pre class="ll lm ln lo gt nz oa ob oc aw od bi"><span id="932e" class="lw lx iq oa b gy oe of l og oh"><strong class="oa ir">ip route</strong> add &lt;weave subnet&gt; via &lt;host IP&gt;<br/>#example<br/>#ip route add 172.20.0.0/16 via 192.168.120.11</span></pre><ul class=""><li id="63c8" class="mv mw iq kh b ki kj kl km ko mx ks my kw mz la na nb nc nd bi translated">部署BusyBox容器</li></ul><pre class="ll lm ln lo gt nz oa ob oc aw od bi"><span id="147c" class="lw lx iq oa b gy oe of l og oh"><strong class="oa ir">eval</strong> $(weave env)<br/><strong class="oa ir">docker</strong> run -it --rm busybox</span></pre><p id="8c07" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在不同主机上启动几个BusyBox并尝试ping它。所有应该工作！</p><blockquote class="oi oj ok"><p id="39c0" class="kf kg ol kh b ki kj jr kk kl km ju kn om kp kq kr on kt ku kv oo kx ky kz la ij bi translated">在启动任何类型的容器之前，如果你想把它放到编织子网中，执行<strong class="kh ir"> eval $(weave env) </strong>。</p></blockquote><ul class=""><li id="597e" class="mv mw iq kh b ki kj kl km ko mx ks my kw mz la na nb nc nd bi translated"><strong class="kh ir">编织报告</strong> —返回编织网络的完整报告</li><li id="8e26" class="mv mw iq kh b ki ne kl nf ko ng ks nh kw ni la na nb nc nd bi translated"><strong class="kh ir">编织状态</strong> —编织网络返回状态</li><li id="b19b" class="mv mw iq kh b ki ne kl nf ko ng ks nh kw ni la na nb nc nd bi translated"><strong class="kh ir">编织隐藏</strong> —隐藏之前暴露的IP地址，用于主机系统和docker容器之间的通信</li></ul><h2 id="20fe" class="lw lx iq bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">结论</h2><p id="e7c6" class="pw-post-body-paragraph kf kg iq kh b ki mp jr kk kl mq ju kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">Weave Net是一个独立docker引擎的更简单的网络覆盖，没有任何外部依赖性。易于安装和维护。可以像内部DNS一样用于解析容器名称。</p><h2 id="f4ba" class="lw lx iq bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">待办事项</h2><ul class=""><li id="7b3e" class="mv mw iq kh b ki mp kl mq ko nj ks nk kw nl la na nb nc nd bi translated">集成编织网与Kubernetes和独立的docker引擎。</li><li id="a81c" class="mv mw iq kh b ki ne kl nf ko ng ks nh kw ni la na nb nc nd bi translated">通过docker部署容器-使用静态IP进行组合。</li></ul></div></div>    
</body>
</html>