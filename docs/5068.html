<html>
<head>
<title>Etcd Performance Consideration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Etcd性能考虑</h1>
<blockquote>原文：<a href="https://itnext.io/etcd-performance-consideration-43d98a1525a3?source=collection_archive---------2-----------------------#2020-12-02">https://itnext.io/etcd-performance-consideration-43d98a1525a3?source=collection_archive---------2-----------------------#2020-12-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/a2b97d5e616af086b5731d39b62a489f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vHadMG8MPC9uV-8o.jpg"/></div></div></figure><p id="8afa" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Etcd是库伯内特人的心脏。随着运营商模型的流行，Etcd不再仅限于使用Kubernetes核心集群引擎。</p><p id="4956" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">以下是部署基于运营商的解决方案框架时，我的OpenShift集群上的主要Etcd指标的屏幕截图。您可以看到，在普通的OCP平台上，数据库大小和内存都增加了3到4倍。</p><figure class="la lb lc ld gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi kz"><img src="../Images/096c81ea581ca268d73018d1c444fcdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AkIpfBDbr9nARzABWDBOdA.png"/></div></div></figure><p id="d5f1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">另一方面，如果不考虑一些硬件和软件因素，Etcd的稳定性将受到严重影响。</p><h2 id="5ed9" class="le lf it bd lg lh li dn lj lk ll dp lm km ln lo lp kq lq lr ls ku lt lu lv lw bi translated">硬盘延迟</h2><p id="8ecf" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">Etcd故意对磁盘延迟非常敏感。如果当前的领导者由于磁盘速度慢而不能及时将Raft日志同步到磁盘，那么集群将失去领导者。领导者选举过程被触发。如果新当选的领导人不能及时同步数据，那么就会形成一个死循环。连锁效应将会被触发，API服务器不可用，OpenShift集群操作符不可用，应用操作符也不能正常工作…</p><p id="6db1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Etcd以分发格式公开了两个与磁盘相关的指标。当Etcd向磁盘提交其最近更改的增量快照时，调用<em class="mc"> backend_commit </em>，对应的普罗米修斯度量是<em class="mc">Etcd _ disk _ back end _ commit _ duration _ seconds _ bucket</em>。当Etcd在应用之前将其日志条目保存到磁盘时，调用<em class="mc"> wal_fsync </em>，对应的普罗米修斯度量是Etcd _ disk _ wal _ fsync _ duration _ seconds _ bucket。</p><p id="b0ec" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一般来说，<em class="mc"> wal_fsync </em>的99个百分点应该小于10 ms，<em class="mc"> backend_commit </em>的99个百分点应该小于25 ms，我们可以用普罗米修斯公式来显示这些指标，</p><pre class="la lb lc ld gt md me mf mg aw mh bi"><span id="b9d7" class="le lf it me b gy mi mj l mk ml">histogram_quantile(0.99, rate(etcd_disk_wal_fsync_duration_seconds_bucket[5m]))</span><span id="6bb9" class="le lf it me b gy mm mj l mk ml">histogram_quantile(0.99, rate(etcd_disk_backend_commit_duration_seconds_bucket[5m]))</span></pre><p id="563c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面是我的集群上的两个指标分布。</p><figure class="la lb lc ld gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mn"><img src="../Images/0717d37a2db3f5a83a75fb58fc417fc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yyhQ-d42fcahR0j8aADI6A.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">后端提交的99%</figcaption></figure><figure class="la lb lc ld gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ms"><img src="../Images/43771c8e96e73963a80cdedfc0a24eff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fLPam412SfNp7d1n0JoY_g.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">wal_fsync的百分之99</figcaption></figure><p id="4f71" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您可以看到，由于负载过重，磁盘延迟指标达到了各自要求的极限。</p><p id="e7bc" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">SATA旋转磁盘不再是一个选项。主/etcd节点需要SSD级别的磁盘。</p><h2 id="756c" class="le lf it bd lg lh li dn lj lk ll dp lm km ln lo lp kq lq lr ls ku lt lu lv lw bi translated">KVM虚拟机磁盘调整</h2><p id="3e95" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">通常Kubernetes节点运行在虚拟机中。现代虚拟机管理程序技术已经取得了足够的进步，虚拟机磁盘性能几乎与裸机服务器相当。通常，虚拟机的默认设置将能够利用SSD磁盘。</p><p id="41c7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在我的KVM中，我做了一些小的优化。</p><ol class=""><li id="1029" class="mt mu it kd b ke kf ki kj km mv kq mw ku mx ky my mz na nb bi translated">磁盘映像是原始格式。</li><li id="a8f3" class="mt mu it kd b ke nc ki nd km ne kq nf ku ng ky my mz na nb bi translated">磁盘驱动程序正在使用高速缓存设置为“无”的虚拟模式。</li></ol><p id="f2b3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面列出了使用virsh创建VM的示例命令。</p><pre class="la lb lc ld gt md me mf mg aw mh bi"><span id="b0b5" class="le lf it me b gy mi mj l mk ml">virsh vol-create-as {{ .pool }} {{ .vmName }}.img {{.diskSize}}</span><span id="7e7b" class="le lf it me b gy mm mj l mk ml">virt-install --name={{ .vmName }} --ram={{ .mem }} --vcpus={{ .cpu }} --disk path={{ .path }}/{{ .vmName }}.img,<strong class="me iu">bus=virtio,cache=none</strong> --noautoconsole --graphics=vnc --network network={{ .network }},model=virtio --boot hd,cdrom --cdrom {{ .isoPath }}</span></pre><h2 id="b6bc" class="le lf it bd lg lh li dn lj lk ll dp lm km ln lo lp kq lq lr ls ku lt lu lv lw bi translated">主/Etcd节点的数量</h2><p id="c6e6" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">我曾经运行一个主/etcd节点来节省测试环境中的资源。在上面的OpenShift 4.4中，我应用了一些漫游来支持一个主节点。</p><pre class="la lb lc ld gt md me mf mg aw mh bi"><span id="def4" class="le lf it me b gy mi mj l mk ml">oc patch etcd cluster -p='{"spec": {"unsupportedConfigOverrides": {"useUnsupportedUnsafeNonHANonProductionUnstableEtcd": true}}}' --type=merge</span></pre><p id="1f80" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然而，在最新的OpenShift 4.6中，我的磁盘延迟处于推荐值的边缘。我别无选择，只能在测试环境中选择3个高手，或者面对一个不稳定的集群。</p><h2 id="9198" class="le lf it bd lg lh li dn lj lk ll dp lm km ln lo lp kq lq lr ls ku lt lu lv lw bi translated">结论</h2><p id="fb66" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">磁盘延迟对Kubernetes集群的整体稳定性有很大影响。选择固态硬盘和多个Etcd节点。</p></div></div>    
</body>
</html>