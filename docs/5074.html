<html>
<head>
<title>AKS Performance: Limit Ranges</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AKS性能:极限范围</h1>
<blockquote>原文：<a href="https://itnext.io/aks-performance-limit-ranges-8e18cbebe351?source=collection_archive---------1-----------------------#2020-12-04">https://itnext.io/aks-performance-limit-ranges-8e18cbebe351?source=collection_archive---------1-----------------------#2020-12-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><ul class=""><li id="0a80" class="jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated"><a class="ae kf" href="#31c7" rel="noopener ugc nofollow">极限范围</a></li><li id="b6f8" class="jn jo iq jp b jq kg js kh ju ki jw kj jy kk ka kb kc kd ke bi translated"><a class="ae kf" href="#44c3" rel="noopener ugc nofollow">防止产生大豆荚</a></li><li id="d992" class="jn jo iq jp b jq kg js kh ju ki jw kj jy kk ka kb kc kd ke bi translated"><a class="ae kf" href="#d92d" rel="noopener ugc nofollow">防止产生小豆荚</a></li><li id="f0fd" class="jn jo iq jp b jq kg js kh ju ki jw kj jy kk ka kb kc kd ke bi translated"><a class="ae kf" href="#a61d" rel="noopener ugc nofollow">创建极限范围</a></li><li id="1541" class="jn jo iq jp b jq kg js kh ju ki jw kj jy kk ka kb kc kd ke bi translated"><a class="ae kf" href="#4247" rel="noopener ugc nofollow">应用极限范围</a></li><li id="1b3c" class="jn jo iq jp b jq kg js kh ju ki jw kj jy kk ka kb kc kd ke bi translated"><a class="ae kf" href="#cc05" rel="noopener ugc nofollow">验证范围</a></li><li id="3059" class="jn jo iq jp b jq kg js kh ju ki jw kj jy kk ka kb kc kd ke bi translated"><a class="ae kf" href="#f844" rel="noopener ugc nofollow">展开吊舱</a></li><li id="a75e" class="jn jo iq jp b jq kg js kh ju ki jw kj jy kk ka kb kc kd ke bi translated"><a class="ae kf" href="#946c" rel="noopener ugc nofollow">总结</a></li></ul><blockquote class="kl km kn"><p id="a59f" class="ko kp kq jp b jq jr kr ks js jt kt ku kv kw kx ky kz la lb lc ld le lf lg ka ij bi translated">多少对多少</p></blockquote><p id="ccdd" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated">在我的上一篇文章中，我讨论了<a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/aks-performance-resource-quotas-2934ce468be7">资源配额</a>,并给出了一个例子，说明有人可能会考虑如何以及为什么在他们的集群上使用它们。在上一篇文章中，您可能会想“您可以限制名称空间资源，这很好，但是如果有人创建了一个pod来一次性使用所有资源，会发生什么呢？”。这就是极限范围发挥作用的地方。</p><h1 id="31c7" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">极限范围</h1><p id="5fb6" class="pw-post-body-paragraph ko kp iq jp b jq mf kr ks js mg kt ku ju mh kx ky jw mi lb lc jy mj lf lg ka ij bi translated"><a class="ae kf" href="https://kubernetes.io/docs/concepts/policy/limit-range/" rel="noopener ugc nofollow" target="_blank">K8s中的限制范围</a>在概念上类似于资源配额，因为它们是对象，并且专门用于控制名称空间中的资源。限制范围对象的目的是让您能够控制其他资源(如pod、容器和存储请求)如何消耗资源，尽管我在这些文章中没有讨论这一点。</p><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mk"><img src="../Images/4b81a89c3f0de45a37f8cfac6b506263.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IAUU6-3tcAPn5IWk372q_A.png"/></div></div></figure><p id="9b23" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated">本质上，这是一个可以与资源配额一起使用的工具，以进一步控制命名空间上的资源消耗，或者如果您对使用资源配额不感兴趣，也可以单独使用。对许多人来说，最大的吸引力可能是防止pod请求大量资源的能力，这些资源会违反或消耗比你可能想要的多得多的资源<strong class="jp ir">或</strong>防止人们创建令人惊讶的小pod，这些小pod最终可能会填满你的集群，这可能会被认为是绒毛pod，并可能会使集群的IP地址匮乏。</p><p id="60d7" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated">在我上面提到的两个场景中，我们需要处理两个独特的问题:</p><ol class=""><li id="f4a2" class="jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka mw kc kd ke bi translated">我们需要阻止人们创造资源饥渴的豆荚。</li><li id="f914" class="jn jo iq jp b jq kg js kh ju ki jw kj jy kk ka mw kc kd ke bi translated">我们需要防止人们制造小得可笑的豆荚，以及大量的豆荚。</li></ol><p id="80c4" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated">先说第一个。</p><h1 id="44c3" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">防止产生大豆荚</h1><p id="d733" class="pw-post-body-paragraph ko kp iq jp b jq mf kr ks js mg kt ku ju mh kx ky jw mi lb lc jy mj lf lg ka ij bi translated">坦率地说，如果你有一个占用大量资源的pod的问题，那么限制范围是你应该考虑的，可能与资源配额结合起来。配额<strong class="jp ir">迫使</strong>舱/容器有明确的资源/限制，同时也防止个人、团队等使你的集群饱和。极限范围实际上可以用于应用极限，即使规范没有指定它们。如果有人来了并立即要求用一个pod提供所有资源，那么将一个命名空间限制为2个vCores有什么意义呢？</p><p id="42b7" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated">使用限制范围允许您控制pod/container可以请求的资源量以及在应用它们之前允许它们消耗的上限。这意味着你可以强迫用户尊重你的配额和你的资源。如果准入控制员发现他们的请求超出了范围的界限…那么他们得到403，并被告知当他们想要尊重范围时再试一次。</p><h1 id="d92d" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">防止微小豆荚的产生</h1><p id="6612" class="pw-post-body-paragraph ko kp iq jp b jq mf kr ks js mg kt ku ju mh kx ky jw mi lb lc jy mj lf lg ka ij bi translated">一个圆荚体太大的对立面。允许创建极小的pod在某些情况下会导致节点过载，不是通过资源消耗，而是纯粹的对象创建。kubernetes在任何给定时间在一个节点上允许的pod数量是有限制的(你可以在这里<a class="ae kf" href="https://docs.microsoft.com/en-us/azure/aks/configure-kubenet#overview-of-kubenet-networking-with-your-own-subnet" rel="noopener ugc nofollow" target="_blank">阅读限制</a>)，虽然有一些方法可以在这里或那里做一些手脚，但一般来说，你不希望在一个节点上有100个pod，不管你有多少可用的资源。</p><p id="4a0b" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated">虽然限制范围并不完全允许您规定可以创建的pod的数量，但是它们可以用来防止人们创建小到可以用来填满一个集群的pod。想象一下复制集，它有一个pod请求1/10的内核和50 mb的内存，然后扩展到50mb。呸。</p><h1 id="a61d" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">创建限制范围</h1><p id="d82d" class="pw-post-body-paragraph ko kp iq jp b jq mf kr ks js mg kt ku ju mh kx ky jw mi lb lc jy mj lf lg ka ij bi translated">创建一个限制范围是非常简单的。事实上，我们只需要做两件事。</p><ol class=""><li id="f829" class="jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka mw kc kd ke bi translated">创建yaml</li><li id="e25b" class="jn jo iq jp b jq kg js kh ju ki jw kj jy kk ka mw kc kd ke bi translated">将yaml部署到一个名称空间。</li></ol><p id="1326" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated">让我们来看看一个基本的极限范围yaml</p><pre class="ml mm mn mo gt mx my mz na aw nb bi"><span id="84dd" class="nc li iq my b gy nd ne l nf ng"><strong class="my ir">apiVersion: v1<br/>kind: LimitRange<br/>metadata:<br/>  name: container-limits<br/>spec:<br/>  limits:<br/>  - max:<br/>      cpu: "125m"<br/>      memory: "128Mi"<br/>    min:<br/>      cpu: "50m"<br/>      memory: "64Mi"<br/>    default:<br/>      cpu: "125m"<br/>      memory: "128Mi"<br/>    defaultRequest:<br/>      cpu: "75m"<br/>      memory: "64Mi"<br/>    type: Container</strong></span></pre><p id="658f" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated">好的，让我们稍微展开一下，这样我们就能了解发生了什么。让我们从<code class="fe nh ni nj my b">limits</code>开始，向下移动。</p><p id="2323" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated"><code class="fe nh ni nj my b">max / min</code> =这是一个容器可以拥有的<strong class="jp ir">最大</strong>和<strong class="jp ir">最小</strong>请求。</p><p id="e8c5" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated"><code class="fe nh ni nj my b">default</code> =这是<strong class="jp ir">默认限制</strong>，如果没有定义限制，将在容器上设置。</p><p id="1233" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated"><code class="fe nh ni nj my b">defaultRequest</code> =这是<strong class="jp ir">默认请求</strong>，如果没有定义请求，将在容器上设置。</p><p id="6bd5" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated">现在，您可能想知道为什么我在文章的这一部分一直键入container而不是pod。朋友，这是因为你可以对不同的资源类型进行限制。您可以在容器级别设置这些限制，比如我在这里，在Pod级别，以及在持久卷声明级别。</p><p id="e4e0" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated">我之所以选择容器，是因为我想确保在容器级别，而不是pod级别，均匀地分配我的资源。请记住，一个吊舱包含容器，如果我需要一个吊舱有几个容器，其中一个接近极限，而其他的没有，如果我在吊舱级别设置范围，我可能无法部署。我不是说你会遇到这种情况，只是在这一点上我更喜欢。没有对错，只是看你的需求。</p><p id="817f" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated">在开始应用之前，我想让您知道我正在使用我在上一篇文章中用来部署资源配额的同一个集群，并且这次将使用team-2名称空间，而不是以前使用的team-1。</p><h1 id="4247" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">应用极限范围</h1><p id="70a3" class="pw-post-body-paragraph ko kp iq jp b jq mf kr ks js mg kt ku ju mh kx ky jw mi lb lc jy mj lf lg ka ij bi translated">请记住，限制范围与资源配额非常相似，适用于命名空间，可以直接与资源配额一起使用。让我们将该范围应用于团队2进行测试。如果您还没有创建名称空间，我们需要创建名称空间。为此，您可以运行<code class="fe nh ni nj my b">kubectl create ns team-2</code>。让我们看看他们在跑<code class="fe nh ni nj my b">kubectl get ns -A</code></p><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/605dc0a5630e6c45cc63e125f34aed69.png" data-original-src="https://miro.medium.com/v2/resize:fit:774/format:webp/1*IGHxGaVUCJbZKrKuZHRQHw.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">坐在底部准备摇滚</figcaption></figure><p id="11c8" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated">应用运行<code class="fe nh ni nj my b">kubectl apply -f locationofyourfile -n team-2</code>的yaml，然后让我们通过运行<code class="fe nh ni nj my b">kubectl get limitrange -n team-2</code>来验证它是否存在。</p><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div class="gh gi np"><img src="../Images/d31b8cfba6ce5f7394369db77e34f33a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/1*cB41kzTyc1CPiWqnNLTJLQ.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">她吹喇叭没造成任何问题。</figcaption></figure><h1 id="cc05" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">验证范围</h1><p id="b3b1" class="pw-post-body-paragraph ko kp iq jp b jq mf kr ks js mg kt ku ju mh kx ky jw mi lb lc jy mj lf lg ka ij bi translated">现在我们已经应用了范围，让我们在开始尝试部署吊舱之前确保一切看起来都很好。运行<code class="fe nh ni nj my b">kubectl describe limitrange -n team-2</code>。</p><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/33069e710ef12736fb285d499e9e7ab5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/format:webp/1*iFoP5TTkjf-WayTKZzvrGA.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">看起来不错</figcaption></figure><p id="4517" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated">你可能会注意到，我没有在我的规范中定义一个<code class="fe nh ni nj my b">Ratio</code>。事实上，我自己并不倾向于玩这个选项，我还没有看到任何人试图用它来代替其他限制方法。也就是说，目的是使用一个计算值，该值是通过将<code class="fe nh ni nj my b">limit</code>除以<code class="fe nh ni nj my b">request</code>确定的，然后强制该值小于或等于该比率。如果不是，准入控制器将不允许吊舱。</p><p id="2686" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated">代码和文档可以在这里<a class="ae kf" href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/resource-management/admission_control_limit_range.md" rel="noopener ugc nofollow" target="_blank">看到</a>如果还不清楚的话。</p><h1 id="f844" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">部署吊舱</h1><blockquote class="kl km kn"><p id="6d53" class="ko kp kq jp b jq jr kr ks js jt kt ku kv kw kx ky kz la lb lc ld le lf lg ka ij bi translated">部署没有限制设置的Pod</p></blockquote><p id="cbe8" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated">让我们来看看我们实际定义默认请求。下面我们有一个pod规范，它是<strong class="jp ir">而不是</strong>定义任何请求或限制。让我们将它应用于团队2，看看会发生什么。</p><p id="bef1" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated"><code class="fe nh ni nj my b">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/> name: radapp<br/> labels:<br/> app: sweetest<br/>spec:<br/> nodeSelector:<br/> “beta.kubernetes.io/os”: linux<br/> containers:<br/> — name: sweetiemcsweetakinsrad<br/> image: ubuntu<br/> command: [‘sh’, ‘-c’, ‘while :; do echo 1; done’]</code></p><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/f2b431ea3440558deab92b27224c0df0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1106/format:webp/1*fchnGR5FLLHV-wXrghyiSQ.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk">…!</figcaption></figure><p id="4ed3" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated">哇哦。即使我没有对这个规格设置任何要求/限制，它仍然是预定的！请记住，这是因为我设置限制范围的方式，如果没有设置，我专门将其配置为设置请求/限制。非常酷。我们去看看。下面我们可以通过描述pod: <code class="fe nh ni nj my b">kubectl describe pod radapp -n team-2</code>来查看由限值范围设置的限值</p><blockquote class="ns"><p id="10f4" class="nt nu iq bd nv nw nx ny nz oa ob ka dk translated">如果我的<code class="fe nh ni nj my b">excitement</code>看起来很奇怪，我在那个名称空间中有一个资源配额，<strong class="ak">强制在规范中设置</strong>请求/限制，否则它不会调度。<strong class="ak">这很酷的原因</strong>是因为极限范围在击中准入控制器之前为我注入了它们。干净利落。</p></blockquote><figure class="od oe of og oh mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi oc"><img src="../Images/2bfd5e00d69f99437107cbd36458dbbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v-5DCHC6KPc-GJH8sOuj2A.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">代表我们设定的限制！</figcaption></figure><p id="c5bc" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated">让我们试着部署一个pod，它有一个希望使用少于5000万cpu的容器。</p><p id="0c7a" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated"><code class="fe nh ni nj my b">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/> name: awesomeapp<br/> labels:<br/> app: sweetest<br/>spec:<br/> nodeSelector:<br/> “beta.kubernetes.io/os”: linux<br/> containers:<br/> — name: sweetiemcsweetakinsawesome<br/> image: ubuntu<br/> command: [‘sh’, ‘-c’, ‘while :; do echo 1; done’]<br/> resources:<br/> requests:<br/> cpu: 25m</code></p><p id="2a7a" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated">我将运行<code class="fe nh ni nj my b">kubectl apply -f awesomeAppLimitRange.yaml -n team-2</code>,我得到消息说创建被禁止，因为最小cpu使用率是50m，但我的请求是25m！</p><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi oi"><img src="../Images/0f5b8d741296f41390b622522ec504e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*60whsfHWswNQqdBX-5SC-w.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">来自服务器的错误(禁止):创建“awesomeAppLimitRange.yaml”时出错:pods“awesomeapp”被禁止:每个容器的最小cpu使用率为50m，但请求为25m</figcaption></figure><p id="63bb" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated">另一方面，如果我们提出过多的pod请求，我们会看到类似的消息，告诉我们离开，因为我们的请求高于我们的最大值。如果你想看这条信息，你应该去试试！请记住，您总是可以通过运行<code class="fe nh ni nj my b">kubectl delete limitrange -n yournamespace</code>来删除限制范围。</p><h1 id="946c" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">摘要</h1><p id="2c02" class="pw-post-body-paragraph ko kp iq jp b jq mf kr ks js mg kt ku ju mh kx ky jw mi lb lc jy mj lf lg ka ij bi translated">通过限制名称空间中的最小/最大请求/限制，限制范围可用于微调您的资源消耗。范围可以在命名空间上单独使用，也可以与资源配额结合使用，以实现额外的控制。</p><p id="9b89" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated">如果规范配置为自动应用请求/限制，则范围可以自动应用请求/限制，以帮助可能忘记将这些设置放入规范或不习惯这样做的用户。</p><p id="d456" class="pw-post-body-paragraph ko kp iq jp b jq jr kr ks js jt kt ku ju kw kx ky jw la lb lc jy le lf lg ka ij bi translated">如需更多信息，您可以在此处查看Kubernetes官方文档<a class="ae kf" href="https://kubernetes.io/docs/concepts/policy/limit-range/" rel="noopener ugc nofollow" target="_blank">，此外，在此处</a>查看准入控制详情<a class="ae kf" href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/resource-management/admission_control_limit_range.md" rel="noopener ugc nofollow" target="_blank">。</a></p></div></div>    
</body>
</html>