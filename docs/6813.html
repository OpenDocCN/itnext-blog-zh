<html>
<head>
<title>Observability, Part 1: Intro &amp; Postgres-Exporter</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">可观察性，第1部分:介绍和介绍导出器</h1>
<blockquote>原文：<a href="https://itnext.io/observability-part-1-intro-postgres-exporter-efe57ee2d534?source=collection_archive---------2-----------------------#2022-03-08">https://itnext.io/observability-part-1-intro-postgres-exporter-efe57ee2d534?source=collection_archive---------2-----------------------#2022-03-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/c82f1ca3ef87d2dcc5d92769c62fda90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lroMTJwbbO4QHhDH"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">Julian Hochgesang 在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="e22a" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">介绍</h1><p id="d0e9" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">高管们喜欢仪表盘，很多时候他们并不真正理解他们在看什么，但图表很容易消化和理解事情是上升还是下降。</p><p id="efc6" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">为了向内部团队展示尽可能多的指标，我已经开始检查我们可以添加指标的地方。当然，这包括已经为Prometheus提供的普通服务，这些服务很容易在本地引入，但也利用了导出器。</p><p id="c17a" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">这将是一个多部分系列，涵盖我们目前使用的不同出口商。这个系列将不包括我在上一篇文章中提到的<a class="ae kf" href="https://medium.com/analytics-vidhya/trending-gitlab-iteration-data-in-prometheus-4ca78749e6b0" rel="noopener"> GitLab Prometheus Exporter。</a></p><h2 id="647d" class="mh kh it bd ki mi mj dn km mk ml dp kq lp mm mn ku lt mo mp ky lx mq mr lc ms bi translated">到处都是仪表板</h2><p id="ad31" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">对于不熟悉Grafana的人，我建议你熟悉一下<a class="ae kf" href="https://grafana.com/grafana/dashboards/" rel="noopener ugc nofollow" target="_blank"> Grafana仪表盘库</a>。对于不同的产品、出口商等，这是一个绝对惊人的仪表盘资源。这是我寻找图表/仪表盘的第一站！</p><p id="6dac" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">我个人会循环浏览每一个仪表盘，寻找我要引入的特定来源。只需获取仪表板的ID，并通过Grafana中的导入选项加载它。</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mt"><img src="../Images/9ed252c99e241290315a74101428b3af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d4V8YDzNgUFSiWN9h40FrA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">仪表板导入</figcaption></figure><p id="c800" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">如果你不喜欢这个仪表盘，或者它不能真正满足你的需求，你可以快速轻松地删除它！只需进入仪表板的设置(齿轮图标)并滚动到底部，点击红色的“删除仪表板”按钮！</p><h1 id="f481" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">PostgreSQL服务器导出程序</h1><p id="062a" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如果您在自己的环境中运行Postgres，我强烈建议您部署<a class="ae kf" href="https://github.com/prometheus-community/postgres_exporter" rel="noopener ugc nofollow" target="_blank"> PostgreSQL服务器导出器</a>。它允许您获取数据库实例的各种指标。开箱即用的PostgreSQL Server Exporter将支持一个漂亮的仪表板，如下所示。这个仪表盘可以在<a class="ae kf" href="https://grafana.com/grafana/dashboards/9628" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi my"><img src="../Images/648eb9cfcc97a5b2ff4b04e41fcb6176.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MSo30VZxWscRamXEsIeV2Q.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">Lucas Estienne的PostgreSQL数据库仪表板</figcaption></figure><h2 id="6d9c" class="mh kh it bd ki mi mj dn km mk ml dp kq lp mm mn ku lt mo mp ky lx mq mr lc ms bi translated">但是等等，还有更多</h2><p id="db94" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">Postgres-Exporter还提供了通过SQL查询创建定制指标的能力。这是一个非常有用的工具，可以向管理团队展示生产统计数据，如事件计数、已加入的客户数量、事件类型等。主要是比实例使用多少RAM或页面大小等更高级别的东西。</p><h1 id="73c0" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">添加查询</h1><p id="bbcc" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我使用postgres-exporter的<a class="ae kf" href="https://bitnami.com/stack/postgresql-exporter" rel="noopener ugc nofollow" target="_blank"> Bitnami </a>容器，所以如果你遵循这个，你的目录可能会不同。</p><h2 id="6fdd" class="mh kh it bd ki mi mj dn km mk ml dp kq lp mm mn ku lt mo mp ky lx mq mr lc ms bi translated">Queries.yaml</h2><p id="1383" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><a class="ae kf" href="https://github.com/prometheus-community/postgres_exporter/blob/master/queries.yaml" rel="noopener ugc nofollow" target="_blank"> quries.yaml </a>文件存放了您的查询，这些查询将与一些元数据一起运行。<a class="ae kf" href="https://github.com/prometheus-community/postgres_exporter/blob/master/queries.yaml" rel="noopener ugc nofollow" target="_blank">postgres _ exporter Github repo</a>有一个示例queries.yaml，可以帮助您入门。它可能包含您不需要或不想要的项目，但它将让您开始了解条目的结构。</p><figure class="mu mv mw mx gt ju"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="2c54" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">我们还有一个PostgreSQL函数，称为row_estimator，它将处理大表的行数估计，因此我们不会进行全表扫描。您可以看到第二个指标使用了这个函数。</p><figure class="mu mv mw mx gt ju"><div class="bz fp l di"><div class="mz na l"/></div></figure><h2 id="54c0" class="mh kh it bd ki mi mj dn km mk ml dp kq lp mm mn ku lt mo mp ky lx mq mr lc ms bi translated">构建您的容器</h2><p id="3ecf" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">现在您已经构建好了查询文件，您需要将它包含在容器中。我使用一个非常简单的Dockerfile文件，它包含两行:</p><pre class="mu mv mw mx gt nb nc nd ne aw nf bi"><span id="8dfd" class="mh kh it nc b gy ng nh l ni nj">FROM bitnami/postgres-exporter:latest AS BASE<br/># these are custom queries<br/>COPY queries.yaml /opt/bitnami/</span></pre><h2 id="5d02" class="mh kh it bd ki mi mj dn km mk ml dp kq lp mm mn ku lt mo mp ky lx mq mr lc ms bi translated">部署您的容器</h2><p id="0f55" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">当您部署容器时，您需要通过<strong class="lg iu">PG _ EXPORTER _ EXTEND _ QUERY _ PATH e</strong>n环境变量告诉postgres-exporter查询文件在哪里。如果您使用的是我的同一个docker文件，您需要将它设置为:/opt/bitnami/queries.yaml。</p><h1 id="bd09" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">现在构建您的仪表板</h1><p id="80ab" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">现在您已经部署了您的容器，现在您可以在Prometheus中找到您的指标。这些指标将被命名为whatever your queries.yaml。因此，在我上面的示例中，我创建了两个指标，分别名为<em class="nk"> portal_customers </em>和<em class="nk"> portal_endpoints </em>。</p><h1 id="f36a" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">摘要</h1><p id="e6f1" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">希望这能帮助人们对他们的Postgres数据库及其内容有更多的了解。欢迎对您创建的任何有趣的指标发表评论！</p><p id="5dfb" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">在这个故事的下一部分，我将报道另一个出口商。</p><p id="0d37" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">如果你喜欢这篇文章或者期待更多的观察性谈话，请随时关注我。</p></div></div>    
</body>
</html>