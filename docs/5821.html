<html>
<head>
<title>Kubernetes-based Microservice Observability with Istio Service Mesh: Part 1 of 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于Kubernetes的Istio服务网格的微服务可观测性:第1部分，共2部分</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-based-microservice-observability-with-istio-service-mesh-part-1-of-2-19084d13a866?source=collection_archive---------2-----------------------#2021-06-02">https://itnext.io/kubernetes-based-microservice-observability-with-istio-service-mesh-part-1-of-2-19084d13a866?source=collection_archive---------2-----------------------#2021-06-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6a24" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过Istio服务网格在亚马逊EKS上使用Jaeger、Prometheus、Grafana、Kiali和Fluent Bit观察分布式系统</h2></div><p id="c17b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这篇由两部分组成的文章探索了一组流行的开源可观察性工具，这些工具很容易与Istio服务网格集成。虽然这些工具不是Istio的一部分，但它们对于充分利用Istio的可观察性特性是必不可少的。这些工具包括用于分布式事务监控的<strong class="kk iu"> Jaeger </strong>和<strong class="kk iu"> Zipkin </strong>，用于指标收集和警报的<strong class="kk iu"> Prometheus </strong>，用于指标查询、可视化和警报的<strong class="kk iu"> Grafana </strong>，以及用于Istio整体可观察性和管理的<strong class="kk iu"> Kiali </strong>。我们将通过添加用于日志处理和聚合的<strong class="kk iu"> Fluent Bit </strong>来完善工具集。我们将使用这些工具来观察一个部署到<strong class="kk iu">亚马逊弹性Kubernetes服务(亚马逊EKS) </strong>集群的分布式、RESTful、基于微服务的参考应用平台。该平台运行在EKS上，将使用亚马逊文档数据库作为持久数据存储，并使用亚马逊MQ来交换信息。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/37c8eeadc51933d4f622774230efb9ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XJGRL8oxig119UfbkSMcig.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">显示参考应用平台的Kiali管理控制台</figcaption></figure><h2 id="5ede" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">Post的以前版本</h2><p id="a4ce" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">这篇文章的前几个版本展示了基于Istio的可观察性，包括HTTP和gRPC，以及Google Cloud的GKE和Azure的AKS上的协议缓冲区，可以在这里找到:</p><div class="mt mu gp gr mv mw"><a rel="noopener  ugc nofollow" target="_blank" href="/istio-observability-with-go-grpc-and-protocol-buffers-based-microservices-d09e34c1255a"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">基于Go、gRPC和协议缓冲区的微服务在Google Kubernetes引擎(GKE)上的Istio可观测性</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">检查使用Istio的可观察性工具来监控使用协议缓冲区、gRPC和…的基于Go的微服务</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">itnext.io</p></div></div><div class="nf l"><div class="ng l nh ni nj nf nk lp mw"/></div></div></a></div><div class="mt mu gp gr mv mw"><a rel="noopener  ugc nofollow" target="_blank" href="/kubernetes-based-microservice-observability-with-istio-service-mesh-part-1-bed3dd0fac0b"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">基于Kubernetes的微服务可观测性与谷歌Kubernetes引擎(GKE)上的Istio服务网格:第1部分</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">在这篇由两部分组成的文章中，我们将探索最新版本的Istio……</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">itnext.io</p></div></div><div class="nf l"><div class="nl l nh ni nj nf nk lp mw"/></div></div></a></div><div class="mt mu gp gr mv mw"><a rel="noopener  ugc nofollow" target="_blank" href="/azure-kubernetes-service-aks-observability-with-istio-service-mesh-4eb28da0f764"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">Azure Kubernetes服务(AKS)与Istio服务网格的可观察性</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">使用Istio服务网格探索Azure Kubernetes服务(AKS)的可观察性</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">itnext.io</p></div></div><div class="nf l"><div class="nm l nh ni nj nf nk lp mw"/></div></div></a></div><h1 id="5810" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">可观察性</h1><p id="62bf" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">与量子计算、大数据、人工智能、机器学习、5G类似，可观测性是目前IT行业的热门流行语。根据维基百科的说法，可观测性是一种衡量系统内部状态从其外部输出中推断出来的程度。辛迪·斯里德哈兰所著的《T2分布式系统可观测性》一书在第四章中描述了<a class="ae le" href="https://www.oreilly.com/library/view/distributed-systems-observability/9781492033431/ch04.html" rel="noopener ugc nofollow" target="_blank">可观测性的三大支柱</a>:“<em class="ny">日志、度量和跟踪通常被称为可观测性的三大支柱。虽然简单地访问日志、度量和跟踪并不一定使系统更容易被观察到，但是这些是强大的工具，如果理解得好，可以释放构建更好的系统的能力。</em>”</p><blockquote class="nz oa ob"><p id="62fb" class="ki kj ny kk b kl km ju kn ko kp jx kq oc ks kt ku od kw kx ky oe la lb lc ld im bi translated">日志、度量和跟踪通常被称为可观察性的三大支柱。<br/> —辛迪·斯里达哈兰</p></blockquote><p id="f727" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Honeycomb是生产系统可观察性工具的开发者。honeycomb.io网站包括关于可观察性的文章、博客、白皮书和播客。根据Honeycomb的说法，“<em class="ny">当一个系统是可理解的时候，可观察性就实现了——这对于复杂的系统来说是很难的，在复杂的系统中，大多数问题是许多事情同时失败的集合。</em></p><p id="dc81" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">随着现代分布式系统变得越来越复杂，观察这些系统的能力同样需要考虑到这种复杂程度而设计的现代工具。不幸的是，传统的日志和监控工具难以适应当今多语言、分布式、事件驱动、短暂、容器化和无服务器的应用环境。Istio服务网试图通过提供与几种流行的开源遥测工具的轻松集成来解决可观测性挑战。Istio的集成包括用于分布式跟踪的<a class="ae le" href="https://www.jaegertracing.io/" rel="noopener ugc nofollow" target="_blank"> Jaeger </a>和<a class="ae le" href="https://zipkin.io/" rel="noopener ugc nofollow" target="_blank"> Zipkin </a>，用于Istio服务网格的整体可观察性和管理的<a class="ae le" href="https://www.kiali.io/" rel="noopener ugc nofollow" target="_blank"> Kiali </a>，以及用于指标收集、监控和警报的<a class="ae le" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank"> Prometheus </a>和<a class="ae le" href="https://grafana.com/" rel="noopener ugc nofollow" target="_blank"> Grafana </a>。结合云原生监控和日志记录工具，如<a class="ae le" href="https://fluentbit.io/" rel="noopener ugc nofollow" target="_blank"> Fluent Bit </a>和<a class="ae le" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/ContainerInsights.html" rel="noopener ugc nofollow" target="_blank">亚马逊cloud watch Container Insights</a>，您就拥有了一个完整的可观测性平台，用于运行在<a class="ae le" href="https://aws.amazon.com/eks/" rel="noopener ugc nofollow" target="_blank">亚马逊弹性Kubernetes服务</a>(亚马逊EKS)上的现代分布式应用。</p><blockquote class="nz oa ob"><p id="63bf" class="ki kj ny kk b kl km ju kn ko kp jx kq oc ks kt ku od kw kx ky oe la lb lc ld im bi translated">传统的日志记录和监控工具难以应对当今多语言、分布式、事件驱动、短暂、容器化和无服务器的应用环境。</p></blockquote><h1 id="70f1" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">源代码</h1><p id="18df" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">这篇文章的所有源代码都可以在GitHub的两个项目中找到。基于Go的微服务源代码和Kubernetes资源位于<a class="ae le" href="https://github.com/garystafford/k8s-istio-observe-backend/tree/2021-istio" rel="noopener ugc nofollow" target="_blank">k8s-istio-observe-back end</a>项目库中。基于Angular UI <a class="ae le" href="https://en.wikipedia.org/wiki/TypeScript" rel="noopener ugc nofollow" target="_blank">类型脚本的</a>源代码位于<a class="ae le" href="https://github.com/garystafford/k8s-istio-observe-frontend/tree/2021-istio" rel="noopener ugc nofollow" target="_blank">k8s-istio-observe-frontend</a>项目库中。对于这个演示，您不需要克隆Angular UI项目。</p><div class="mt mu gp gr mv mw"><a href="https://github.com/garystafford/k8s-istio-observe-backend" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">garystafter/k8s-istio-observe-back end</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">两篇博文的源代码，基于Kubernetes的带有Istio服务网格的微服务可观察性。请参见…</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">github.com</p></div></div><div class="nf l"><div class="of l nh ni nj nf nk lp mw"/></div></div></a></div><div class="mt mu gp gr mv mw"><a href="https://github.com/garystafford/k8s-istio-observe-frontend" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">garystafter/k8s-istio-observe-frontend</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">两篇博文的源代码，基于Kubernetes的带有Istio服务网格的微服务可观察性。请参见…</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">github.com</p></div></div><div class="nf l"><div class="og l nh ni nj nf nk lp mw"/></div></div></a></div><p id="314c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该演示对两个GitHub项目都使用了<code class="fe oh oi oj ok b">2021-istio</code>分支。使用以下命令克隆项目:</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="a001" class="lv lw it ok b gy op oq l or os">git clone --branch 2021-istio --single-branch \<br/>  <a class="ae le" href="https://github.com/garystafford/k8s-istio-observe-backend.git" rel="noopener ugc nofollow" target="_blank">https://github.com/garystafford/k8s-istio-observe-backend.git</a></span><span id="0df3" class="lv lw it ok b gy ot oq l or os"><em class="ny"># optional - not needed for demonstration<br/></em>git clone --branch 2021-istio --single-branch \<br/>  <a class="ae le" href="https://github.com/garystafford/k8s-istio-observe-frontend.git" rel="noopener ugc nofollow" target="_blank">https://github.com/garystafford/k8s-istio-observe-frontend.git</a></span></pre><p id="4acd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">用于Go服务和UI的Kubernetes <code class="fe oh oi oj ok b">Deployment</code>资源文件中引用的Docker图像都可以在<a class="ae le" href="https://hub.docker.com/u/garystafford/" rel="noopener ugc nofollow" target="_blank"> Docker Hub </a>上获得。Go微服务Docker镜像是使用DockerHub上的官方<a class="ae le" href="https://hub.docker.com/_/golang" rel="noopener ugc nofollow" target="_blank"> Golang Alpine </a>镜像构建的，包含<a class="ae le" href="https://golang.org/doc/go1.16" rel="noopener ugc nofollow" target="_blank"> Go版本1.16.4 </a>。使用Alpine映像和多阶段Docker构建方法来编译Go源代码，可以确保容器尽可能小，并最大限度地减少容器的潜在攻击面。</p><h1 id="d144" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">参考应用平台</h1><p id="df42" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">为了展示Istio的可观察性工具，我们将在AWS上为EKS部署一个参考应用平台，该平台用Go和TypeScript编写。我开发了参考应用平台来演示不同的Kubernetes平台，如EKS、GKE和AKS，以及服务网格、API管理、可观察性、DevOps和<a class="ae le" href="https://principlesofchaos.org/" rel="noopener ugc nofollow" target="_blank">混沌工程</a>等概念。该平台包括一个后端，包含八个基于<a class="ae le" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Go的</a>微服务，一般标记为服务A-服务H，一个基于Angular 12 <a class="ae le" href="https://en.wikipedia.org/wiki/TypeScript" rel="noopener ugc nofollow" target="_blank">类型脚本的</a>前端UI，四个<a class="ae le" href="https://www.mongodb.com/" rel="noopener ugc nofollow" target="_blank"> MongoDB </a>数据库，以及一个<a class="ae le" href="https://www.rabbitmq.com/" rel="noopener ugc nofollow" target="_blank"> RabbitMQ </a>消息队列。该平台及其所有源代码都在GitHub上开源。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi ou"><img src="../Images/4b55840eff21834568e18353928f0c44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aXNzBd8uZxcsu7Mz67IioQ.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">参考应用平台的基于角度的用户界面</figcaption></figure><p id="9345" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">参考应用程序平台旨在生成基于HTTP的同步服务到服务IPC(进程间通信)、基于TCP的异步服务到队列到服务通信以及基于TCP的服务到数据库通信。比如服务A调用服务B和服务C；服务B调用服务D和服务E；服务D在RabbitMQ队列上生成一条消息，服务F使用这条消息并将其写入MongoDB，依此类推。当系统部署到运行Istio服务网格的Kubernetes集群时，可以使用Istio的可观察性工具观察分布式服务通信。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi ov"><img src="../Images/ff8086d3129c8136e44f2292c3172883.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WPzMcvbDOF7nWxjH9GAXxg.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">参考应用平台的高层架构</figcaption></figure><h1 id="dc3f" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">服务响应</h1><p id="57fe" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">每个Go微服务包含一个<code class="fe oh oi oj ok b">/greeting</code>、<code class="fe oh oi oj ok b">/health</code>和<code class="fe oh oi oj ok b">/metrics</code>端点。服务的<code class="fe oh oi oj ok b">/health</code>端点用于配置<a class="ae le" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/" rel="noopener ugc nofollow" target="_blank"> Kubernetes活性、就绪和启动探测器</a>。<code class="fe oh oi oj ok b">/metrics</code>端点暴露了普罗米修斯废弃的指标。最后，当调用它们的<code class="fe oh oi oj ok b">/greeting</code>端点时，上游服务通过返回一个小的信息性JSON有效负载——一个<em class="ny">问候</em>来响应来自下游服务的请求。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="b631" class="lv lw it ok b gy op oq l or os">{<br/>    "id": "1f077127-2f9f-4a90-ad88-da52327c2620",<br/>    "service": "Service C",<br/><strong class="ok iu">    "message": "Konnichiwa (こんにちは), from Service C!",<br/></strong>    "created": "2021-06-04T04:34:02.901726709Z",<br/>    "hostname": "service-c-6d5cc8fdfd-stsq9"<br/>}</span></pre><p id="3d50" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">响应在整个服务调用链中聚合，导致一系列服务响应返回到边缘服务(服务A ),随后返回到在最终用户的web浏览器中运行的平台UI。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="2a62" class="lv lw it ok b gy op oq l or os">[<br/>    {<br/>        "id": "a9afab6a-3e2a-41a6-aec7-7257d2904076",<br/>        "service": "Service D",<br/><strong class="ok iu">        "message": "Shalom (שָׁלוֹם), from Service D!",<br/></strong>        "created": "2021-06-04T14:28:32.695151047Z",<br/>        "hostname": "service-d-565c775894-vdsjx"<br/>    },<br/>    {<br/>        "id": "6d4cc38a-b069-482c-ace5-65f0c2d82713",<br/>        "service": "Service G",<br/><strong class="ok iu">        "message": "Ahlan (أهلا), from Service G!",<br/></strong>        "created": "2021-06-04T14:28:32.814550521Z",<br/>        "hostname": "service-g-5b846ff479-znpcb"<br/>    },<br/>    {<br/>        "id": "988757e3-29d2-4f53-87bf-e4ff6fbbb105",<br/>        "service": "Service H",<br/><strong class="ok iu">        "message": "Nǐ hǎo (你好), from Service H!",<br/></strong>        "created": "2021-06-04T14:28:32.947406463Z",<br/>        "hostname": "service-h-76cb7c8d66-lkr26"<br/>    },<br/>    {<br/>        "id": "966b0bfa-0b63-4e21-96a1-22a76e78f9cd",<br/>        "service": "Service E",<br/><strong class="ok iu">        "message": "Bonjour, from Service E!",<br/></strong>        "created": "2021-06-04T14:28:33.007881464Z",<br/>        "hostname": "service-e-594d4754fc-pr7tc"<br/>    },<br/>    {<br/>        "id": "c612a228-704f-4562-90c5-33357b12ff8d",<br/>        "service": "Service B",<br/><strong class="ok iu">        "message": "Namasté (नमस्ते), from Service B!",<br/></strong>        "created": "2021-06-04T14:28:33.015985983Z",<br/>        "hostname": "service-b-697b78cf54-4lk8s"<br/>    },<br/>    {<br/>        "id": "b621bd8a-02ee-4f9b-ac1a-7d91ddad85f5",<br/>        "service": "Service C",<br/><strong class="ok iu">        "message": "Konnichiwa (こんにちは), from Service C!",<br/></strong>        "created": "2021-06-04T14:28:33.042001406Z",<br/>        "hostname": "service-c-7fd4dd5947-5wcgs"<br/>    },<br/>    {<br/>        "id": "52eac1fa-4d0c-42b4-984b-b65e70afd98a",<br/>        "service": "Service A",<br/><strong class="ok iu">        "message": "Hello, from Service A!",<br/></strong>        "created": "2021-06-04T14:28:33.093380628Z",<br/>        "hostname": "service-a-6f776d798f-5l5dz"<br/>    }<br/>]</span></pre><h2 id="5c1a" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">克-奥二氏分级量表</h2><p id="91f6" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">平台的后端边缘服务，服务A，使用<code class="fe oh oi oj ok b">access-control-allow-origin</code>响应头为<a class="ae le" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" rel="noopener ugc nofollow" target="_blank">跨源资源共享</a> (CORS)进行配置。CORS配置允许在最终用户的web浏览器中运行的Angular UI调用服务A的<code class="fe oh oi oj ok b">/greeting</code>端点，该端点可能驻留在与UI不同的主机中。下面显示的是服务a的Go源代码。注意第33行和第189行使用的<code class="fe oh oi oj ok b">ALLOWED_ORIGINS</code>环境变量，它允许您配置服务的<code class="fe oh oi oj ok b">Deployment</code>资源所允许的来源。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="ow ox l"/></div></figure><h1 id="2698" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">MongoDB和RabbitMQ即服务</h1><p id="8c86" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">使用外部服务将有助于我们理解Istio及其可观测性工具如何收集遥测数据，以便在Kubernetes上的参考应用平台和外部系统之间进行通信。</p><h2 id="12cc" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">亚马逊文档b</h2><p id="c81f" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">对于这个演示，参考应用平台的MongoDB数据库将在EKS之外托管在<a class="ae le" href="https://aws.amazon.com/documentdb/" rel="noopener ugc nofollow" target="_blank"> Amazon DocumentDB </a> ( <em class="ny">与MongoDB兼容</em>)上。根据AWS的说法，Amazon DocumentDB是一个专门为大规模JSON数据管理而构建的数据库服务，完全由AWS管理并与AWS集成，是企业级的，具有高耐用性。</p><h2 id="e490" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">亚马逊MQ</h2><p id="e98d" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">类似地，参考应用平台的RabbitMQ队列将在EKS之外的亚马逊MQ上托管。AWS MQ是Apache ActiveMQ和RabbitMQ的托管消息代理服务，使得在AWS上设置和操作消息代理变得很容易。Amazon MQ通过为您管理消息代理的供应、设置和维护来减少您的操作责任。对于RabbitMQ，Amazon MQ提供了对RabbitMQ web控制台的访问。控制台允许我们监控和管理RabbitMQ。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oy"><img src="../Images/c86ed02293b3ec9cd6f3f2ec0488ecec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hhZc9gNePB3QsHaEOMDPcA.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">RabbitMQ Web控制台显示参考平台的问候队列</figcaption></figure><p id="022c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面显示的是服务f的Go源代码。该服务使用RabbitMQ队列中的消息，由服务D放在那里，并将消息写入MongoDB。服务使用Sean Treadway的<a class="ae le" href="https://github.com/streadway/amqp" rel="noopener ugc nofollow" target="_blank"> Go RabbitMQ客户端库</a>和MongoDB的<a class="ae le" href="https://github.com/mongodb/mongo-go-driver" rel="noopener ugc nofollow" target="_blank"> MongoDB Go驱动程序</a>进行连接。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="ow ox l"/></div></figure><h1 id="dad6" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">先决条件</h1><p id="b526" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">这个职位将承担AWS EKS，Kubernetes和Istio的基本知识水平。此外，本文假设您已经安装了最新版本的<a class="ae le" href="https://aws.amazon.com/cli/" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a> v2、<a class="ae le" href="https://kubernetes.io/docs/tasks/tools/install-kubectl-macos/" rel="noopener ugc nofollow" target="_blank"> kubectl </a>、weaver works’<a class="ae le" href="https://eksctl.io/" rel="noopener ugc nofollow" target="_blank">eks CTL</a>、<a class="ae le" href="https://docs.docker.com/docker-for-mac/install/" rel="noopener ugc nofollow" target="_blank"> Docker </a>、<a class="ae le" href="https://istio.io/latest/docs/setup/getting-started/#download" rel="noopener ugc nofollow" target="_blank"> Istio </a>和<a class="ae le" href="https://github.com/mikefarah/yq" rel="noopener ugc nofollow" target="_blank"> yq </a>。这意味着<code class="fe oh oi oj ok b">aws</code>、<code class="fe oh oi oj ok b">kubectl</code>、<code class="fe oh oi oj ok b">eksctl</code>、<code class="fe oh oi oj ok b">istioctl</code>、<code class="fe oh oi oj ok b">docker</code>和<code class="fe oh oi oj ok b">yq</code>命令工具都可以从终端获得。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oz"><img src="../Images/51a3f3216e16e2f07c5f53e0230db67e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gak5Y5bSOn75TKDzC2DbXg.png"/></div></div></figure><h2 id="3306" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">亚马逊EKS的CLI</h2><p id="113f" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">Weaveworks是一个简单的CLI工具，用于在EKS上创建和管理集群——亚马逊为EC2提供的托管Kubernetes服务。它是用Go写的，用的是CloudFormation。</p><h2 id="9a53" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">Istio的CLI</h2><p id="7d9c" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">Istio配置命令行实用程序<code class="fe oh oi oj ok b">istioctl</code>旨在帮助调试和诊断Istio网格。</p><h1 id="d6c7" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">设置和安装</h1><p id="fcbc" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">尽管你可能更喜欢使用像<a class="ae le" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank"> Helm </a>或<a class="ae le" href="https://kustomize.io/" rel="noopener ugc nofollow" target="_blank">Kustomize</a>with<a class="ae le" href="https://www.weave.works/oss/flux/" rel="noopener ugc nofollow" target="_blank">Flux</a>或<a class="ae le" href="https://argoproj.github.io/argo-cd/" rel="noopener ugc nofollow" target="_blank"> Agro CD </a>这样的工具来将微服务平台部署到Kubernetes，在这篇文章中，我们将使用<code class="fe oh oi oj ok b">kubectl</code>来简化事情。如果你真的喜欢Helm，在GitHub库中有一个测试版的图表<a class="ae le" href="https://github.com/garystafford/k8s-istio-observe-backend/blob/2021-istio/helm/ref-app/" rel="noopener ugc nofollow" target="_blank">可以安装<code class="fe oh oi oj ok b">dev</code>名称空间资源。使用这个图表，你可以忽略这篇文章中引用<code class="fe oh oi oj ok b">dev</code>名称空间中的资源的任何说明。参见图表的</a><a class="ae le" href="https://github.com/garystafford/k8s-istio-observe-backend/blob/2021-istio/helm/ref-app/README.md" rel="noopener ugc nofollow" target="_blank">自述文件</a>获取进一步说明。</p><p id="d432" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将大致按照以下顺序进行:</p><ol class=""><li id="612b" class="pa pb it kk b kl km ko kp kr pc kv pd kz pe ld pf pg ph pi bi translated">为ALB创建TLS证书和Route53托管区域记录；</li><li id="c9da" class="pa pb it kk b kl pj ko pk kr pl kv pm kz pn ld pf pg ph pi bi translated">创建一个Amazon DocumentDB数据库集群；</li><li id="8e24" class="pa pb it kk b kl pj ko pk kr pl kv pm kz pn ld pf pg ph pi bi translated">创建一个Amazon MQ RabbitMQ消息代理；</li><li id="81d1" class="pa pb it kk b kl pj ko pk kr pl kv pm kz pn ld pf pg ph pi bi translated">创建EKS集群；</li><li id="76b3" class="pa pb it kk b kl pj ko pk kr pl kv pm kz pn ld pf pg ph pi bi translated">为您自己的环境修改Kubernetes资源；</li><li id="c555" class="pa pb it kk b kl pj ko pk kr pl kv pm kz pn ld pf pg ph pi bi translated">部署AWS应用程序负载平衡器(ALB)和相关资源；</li><li id="8794" class="pa pb it kk b kl pj ko pk kr pl kv pm kz pn ld pf pg ph pi bi translated">将Istio部署到EKS集群；</li><li id="b477" class="pa pb it kk b kl pj ko pk kr pl kv pm kz pn ld pf pg ph pi bi translated">将Fluent Bit部署到EKS集群；</li><li id="bf00" class="pa pb it kk b kl pj ko pk kr pl kv pm kz pn ld pf pg ph pi bi translated">将参考平台部署到EKS；</li><li id="4212" class="pa pb it kk b kl pj ko pk kr pl kv pm kz pn ld pf pg ph pi bi translated">对平台进行测试和故障排除；</li><li id="7671" class="pa pb it kk b kl pj ko pk kr pl kv pm kz pn ld pf pg ph pi bi translated">观察第二部分的结果；</li></ol><h1 id="9df4" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">亚马逊文档b</h1><p id="89f5" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">如前所述，MongoDB数据库将托管在EKS之外的亚马逊document db(T20)上，与MongoDB兼容。创建DocumentDB集群。为了演示的简单性和经济性，我建议创建一个单一的<code class="fe oh oi oj ok b">db.r5.large</code>节点集群。您将使用提供的<code class="fe oh oi oj ok b">mongodb://</code>连接字符串从微服务连接到Amazon DocumentDB。</p><p id="bce6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">亚马逊DocumentDB集群部署在亚马逊虚拟私有云(亚马逊VPC)内。如果您在VPC而不是EKS安装DocumentDB，您将需要确保EKS VPC可以访问DocumentDB VPC。根据DocumentDB <a class="ae le" href="https://docs.aws.amazon.com/documentdb/latest/developerguide/connect-from-outside-a-vpc.html" rel="noopener ugc nofollow" target="_blank">文档</a>，部署在同一个亚马逊VPC中的亚马逊EC2实例或其他AWS服务可以直接访问DocumentDB集群。此外，Amazon DocumentDB可以通过EC2实例或其他AWS服务从同一AWS区域或其他区域的不同VPC通过<a class="ae le" href="https://docs.aws.amazon.com/vpc/latest/peering/what-is-vpc-peering.html" rel="noopener ugc nofollow" target="_blank"> VPC对等</a>进行访问。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi po"><img src="../Images/7e2c5bcca7a8385c3807edb307f52d90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GB3DLDLmqxmGoZlTmqVAow.png"/></div></div></figure><h1 id="5a75" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">亚马逊MQ</h1><p id="5bdd" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">类似地，RabbitMQ队列将在EKS之外的亚马逊MQ上托管。创建一个Amazon MQ RabbitMQ代理。为了确保演示的简单性和可负担性，我推荐使用单个<code class="fe oh oi oj ok b">mq.m5.large</code>实例代理。代理正在运行RabbitMQ引擎，并禁用了TLS。您将使用<a class="ae le" href="https://en.wikipedia.org/wiki/Advanced_Message_Queuing_Protocol" rel="noopener ugc nofollow" target="_blank"> AMQP </a>(高级消息队列协议)从微服务连接到Amazon MQ。Amazon MQ提供了一个<code class="fe oh oi oj ok b">amqps://</code>端点。<code class="fe oh oi oj ok b">amqps</code> URI方案用于指示客户端与服务器建立安全连接。您可以从Amazon MQ提供的RabbitMQ web控制台管理和观察RabbitMQ。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oy"><img src="../Images/473bab79b2b94e6ef2e3916997dbb701.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MEuCztnX-CmnRJCL7c7EFQ.png"/></div></div></figure><h1 id="4caa" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">修改Kubernetes资源</h1><p id="ab0e" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">您需要更改GitHub项目的Kubernetes资源文件中的几个配置设置，以匹配您的环境。</p><h2 id="3f12" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">文档数据库的Istio ServiceEntry</h2><p id="bd28" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">修改Istio <code class="fe oh oi oj ok b">ServiceEntry</code>资源<code class="fe oh oi oj ok b">external-mesh-document-db.yaml</code>，添加您的DocumentDB主机地址。这些命令假设您的帐户中只有一个经纪人。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="db93" class="lv lw it ok b gy op oq l or os">export DOCDB_ENDPOINT=$(aws docdb describe-db-clusters --query 'DBClusters[0].Endpoint' | sed -e 's/^"//' -e 's/"$//')</span><span id="965c" class="lv lw it ok b gy ot oq l or os">yq e '.spec.hosts[0] = strenv(DOCDB_ENDPOINT)' -i ./resources/dev/istio/external-mesh-document-db.yaml</span></pre><p id="b64d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该文件允许流量从EKS上的微服务流出到DocumentDB集群。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="ab88" class="lv lw it ok b gy op oq l or os">apiVersion: networking.istio.io/v1alpha3<br/>kind: ServiceEntry<br/>metadata:<br/>  name: docdb-external-mesh<br/>spec:<br/>  hosts:<br/><strong class="ok iu">  - {{ your_document_db_hostname }}<br/></strong>  ports:<br/>  - name: mongo<br/>    number: 27017<br/>    protocol: MONGO<br/>  location: MESH_EXTERNAL<br/>  resolution: NONE</span></pre><h2 id="e164" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">亚马逊MQ的Istio ServiceEntry</h2><p id="f02b" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">修改Istio <code class="fe oh oi oj ok b">ServiceEntry</code>资源<code class="fe oh oi oj ok b">external-mesh-amazon-mq.yaml</code>，添加您的Amazon MQ主机地址。这些命令假设您的帐户中只有一个经纪人。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="9af0" class="lv lw it ok b gy op oq l or os">export BROKER_ID=$(aws mq list-brokers --query 'BrokerSummaries[0].BrokerId' | sed -e 's/^"//' -e 's/"$//')</span><span id="f545" class="lv lw it ok b gy ot oq l or os">export BROKER_HOSTNAME=$(aws mq describe-broker --broker-id $BROKER_ID --query 'BrokerInstances[0].ConsoleURL' | sed 's/https:\/\///g' | sed -e 's/^"//' -e 's/"$//')</span><span id="e53c" class="lv lw it ok b gy ot oq l or os">yq e '.spec.hosts[0] = strenv(BROKER_HOSTNAME)' -i ./resources/dev/istio/external-mesh-amazon-mq.yaml</span></pre><p id="86b9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该文件允许流量从EKS上的微服务流出到Amazon MQ RabbitMQ代理。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="3e60" class="lv lw it ok b gy op oq l or os">apiVersion: networking.istio.io/v1alpha3<br/>kind: ServiceEntry<br/>metadata:<br/>  name: amazon-mq-external-mesh<br/>spec:<br/>  hosts:<br/><strong class="ok iu">    - {{ your_amazon_mq_hostname }}<br/></strong>  ports:<br/>  - name: rabbitmq<br/>    number: 5671<br/>    protocol: TCP<br/>  location: MESH_EXTERNAL<br/>  resolution: NONE</span></pre><h2 id="72a6" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">Istio网关</h2><p id="c0a2" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">您可以使用多种策略通过Istio将流量路由到EKS集群。在这个演示中，我使用了一个<a class="ae le" href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html" rel="noopener ugc nofollow" target="_blank"> AWS应用程序负载平衡器</a> (ALB)。我已经将一个主机名<code class="fe oh oi oj ok b">observe-ui.example-api.com</code>映射到运行在EKS上的Angular UI应用程序。后端基于微服务的API，特别是边缘服务Service A，被映射到第二个主机名<code class="fe oh oi oj ok b">observe-api.example-api.com</code>。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oy"><img src="../Images/7199ae3ccdd3c6b1ba733c4d073509e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XbI0RDBBBEja9b7bUaE7FQ.png"/></div></div></figure><p id="35de" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据<a class="ae le" href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#Gateway" rel="noopener ugc nofollow" target="_blank">Istio</a>,<code class="fe oh oi oj ok b">Gateway</code>描述了在网格边缘运行的负载平衡器，接收传入或传出的HTTP/TCP连接。修改Istio入口<code class="fe oh oi oj ok b">Gateway</code>资源<code class="fe oh oi oj ok b">gateway.yaml</code>。将您自己的DNS条目插入到<code class="fe oh oi oj ok b">hosts</code>部分。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="da6f" class="lv lw it ok b gy op oq l or os">yq e '.spec.servers[0].hosts[0] = "<strong class="ok iu">{{ your_ui_hostname }}</strong>"' -i ./resources/dev/istio/gateway.yaml</span><span id="19c1" class="lv lw it ok b gy ot oq l or os">yq e '.spec.servers[0].hosts[1] = "<strong class="ok iu">{{ your_api_hostname }}</strong>"' -i ./resources/dev/istio/gateway.yaml</span></pre><p id="901e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这些是唯一允许通过端口80进入网状网络的主机。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="31b8" class="lv lw it ok b gy op oq l or os">apiVersion: networking.istio.io/v1beta1<br/>kind: Gateway<br/>metadata:<br/>  name: istio-gateway<br/>spec:<br/>  selector:<br/>    istio: ingressgateway # use istio default controller<br/>  servers:<br/>    - port:<br/>        number: 80<br/>        name: ui<br/>        protocol: HTTP<br/>      hosts:<br/><strong class="ok iu">        - {{ your_ui_hostname }}<br/>        - {{ your_api_hostname }}</strong></span></pre><h2 id="d90b" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">Istio虚拟服务</h2><p id="668b" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">根据<a class="ae le" href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#VirtualService" rel="noopener ugc nofollow" target="_blank"> Istio </a>，当主机被寻址时，<code class="fe oh oi oj ok b">VirtualService</code>定义一组要应用的流量路由规则。一个<code class="fe oh oi oj ok b">VirtualService</code>绑定到一个<code class="fe oh oi oj ok b">Gateway</code>来控制到达特定主机和端口的流量的转发。修改项目的两个Istio <code class="fe oh oi oj ok b">VirtualServices</code>资源，<code class="fe oh oi oj ok b">virtualservices.yaml</code>。从Istio网关插入相应的DNS条目。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="2115" class="lv lw it ok b gy op oq l or os">apiVersion: networking.istio.io/v1beta1<br/>kind: VirtualService<br/>metadata:<br/>  name: angular-ui<br/>spec:<br/>  hosts:<br/><strong class="ok iu">    - {{ your_ui_hostname }}<br/></strong>  gateways:<br/>    - istio-gateway<br/>  http:<br/>    - match:<br/>        - uri:<br/>            prefix: /<br/>      route:<br/>        - destination:<br/>            host: angular-ui.dev.svc.cluster.local<strong class="ok iu"><br/></strong>            subset: v1<br/>            port:<br/>              number: 80<br/>---<br/>apiVersion: networking.istio.io/v1beta1<br/>kind: VirtualService<br/>metadata:<br/>  name: service-a<br/>spec:<br/>  hosts:<br/><strong class="ok iu">    - {{ your_api_hostname }}<br/></strong>  gateways:<br/>    - istio-gateway<br/>  http:<br/>    - match:<br/>        - uri:<br/>            prefix: /api<br/>      route:<br/>        - destination:<br/>            host: service-a.dev.svc.cluster.local<br/>            subset: v1<br/>            port:<br/>              number: 8080</span></pre><h2 id="c1b9" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">库伯内特的秘密</h2><p id="7dca" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">根据Kubernetes项目，Kubernetes Secrets可以让你存储和管理敏感信息，比如密码、OAuth令牌和SSH密钥。将机密信息存储在Secret中比将其逐字放入Pod定义或容器映像中更安全、更灵活。</p><p id="0f53" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该项目包含两个库伯内特斯<code class="fe oh oi oj ok b">Opaque</code>型<code class="fe oh oi oj ok b">Secret</code>资源，<code class="fe oh oi oj ok b">go-srv-demo.yaml</code>。<code class="fe oh oi oj ok b">Secret</code>包含几个您想要保护的任意用户定义的数据。数据包括微服务使用的完整DocumentDB <code class="fe oh oi oj ok b">mongodb://</code>连接字符串和Amazon MQ <code class="fe oh oi oj ok b">amqps://</code>连接字符串。您将使用<code class="fe oh oi oj ok b">Secret</code>来保护整个连接字符串，包括主机名、端口、用户名和密码。该数据还包括DocumentDB主机、用户名和密码，以及使用基本身份验证登录Mongo Express的任意用户名和密码。</p><p id="481f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您必须使用<code class="fe oh oi oj ok b">base64</code>对您的秘密值进行编码。在Linux和Mac上，可以使用<code class="fe oh oi oj ok b">base64</code>程序对连接字符串进行编码。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="0d2a" class="lv lw it ok b gy op oq l or os">echo -n '{{ your_secret_to_encode }}' | base64</span><span id="d6fc" class="lv lw it ok b gy ot oq l or os"># e.g., echo -n 'amqps://username:password@hostname.mq.us-east-1.amazonaws.com:5671/' | base64</span></pre><p id="f4e0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将<code class="fe oh oi oj ok b">base64</code>编码值添加到<code class="fe oh oi oj ok b">Secret</code>资源中。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="2f77" class="lv lw it ok b gy op oq l or os">apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  name: go-srv-config<br/>  namespace: dev<br/>type: Opaque<br/>data:<br/><strong class="ok iu">  mongodb.conn: {{ your_base64_encoded_secret }}<br/>  rabbitmq.conn: {{ your_base64_encoded_secret }}</strong></span></pre><p id="ad62" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Mongo Express:</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="08cc" class="lv lw it ok b gy op oq l or os">apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  name: mongo-express-config<br/>  namespace: mongo-express<br/>type: Opaque<br/>data:<br/><strong class="ok iu">  me.basicauth.username: {{ your_base64_encoded_secret }}<br/>  me.basicauth.password: {{ your_base64_encoded_secret }}<br/>  mongodb.host: {{ your_base64_encoded_secret }}<br/>  mongodb.username: {{ your_base64_encoded_secret }}<br/>  mongodb.password: {{ your_base64_encoded_secret }}</strong></span></pre><h2 id="f1d8" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">AWS负载平衡器控制器</h2><p id="7b77" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">该项目包含一个<a class="ae le" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" rel="noopener ugc nofollow" target="_blank">自定义资源定义</a> (CRD)和关联资源<code class="fe oh oi oj ok b">aws-load-balancer-controller-v220-all.yaml</code>。这些资源使用<a class="ae le" href="https://docs.aws.amazon.com/eks/latest/userguide/aws-load-balancer-controller.html" rel="noopener ugc nofollow" target="_blank"> AWS负载平衡器控制器</a> v2.2.0、<code class="fe oh oi oj ok b">aws-load-balancer-controller</code>配置AWS应用负载平衡器(ALB)。AWS负载平衡器控制器为Kubernetes集群管理AWS弹性负载平衡器(ELB)。当您创建Kubernetes <code class="fe oh oi oj ok b">Ingress</code>时，控制器会提供一个AWS ALB。</p><p id="eba6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">修改第797行，以包含您自己的集群的名称。在整个演示过程中，我一直使用集群名称<code class="fe oh oi oj ok b">istio-observe-demo</code>。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="f11f" class="lv lw it ok b gy op oq l or os">spec:<br/>      containers:<br/>      - args:<br/><strong class="ok iu">        - --cluster-name=istio-observe-demo<br/></strong>        - --ingress-class=alb<br/>        image: amazon/aws-alb-ingress-controller:v2.2.0<br/>        livenessProbe:<br/>          failureThreshold: 2<br/>          httpGet:<br/>            path: /healthz<br/>            port: 61779<br/>            scheme: HTTP</span></pre><h2 id="009d" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">EKS集群配置</h2><p id="6894" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">该项目包含一个<code class="fe oh oi oj ok b">eksctl</code> <code class="fe oh oi oj ok b">ClusterConfig</code>资源<code class="fe oh oi oj ok b">cluster.yaml</code>。<code class="fe oh oi oj ok b">ClusterConfig</code>定义了亚马逊EKS集群的配置以及网络、安全和其他相关资源。在本演示中，<code class="fe oh oi oj ok b">eksctl</code>将创建一个VPC和相关的AWS资源，作为集群创建的一部分，而不是预先存在的亚马逊虚拟私有云(亚马逊VPC)。修改文件以匹配您的AWS区域、期望的EKS集群名称和Kubernetes版本(第4–6行)。对于演示，我使用的是最新的Kubernetes 1.20版本。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="ow ox l"/></div></figure><h1 id="9648" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">设置环境变量</h1><p id="edcb" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">在您的终端中修改和设置以下环境变量。我将对作为演示一部分的所有演示AWS资源使用<code class="fe oh oi oj ok b">us-east-1</code>。它们应该匹配上面的<code class="fe oh oi oj ok b">eksctl</code> <code class="fe oh oi oj ok b">ClusterConfig</code>资源。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="e320" class="lv lw it ok b gy op oq l or os">export AWS_ACCOUNT=$(aws sts get-caller-identity --output text --query 'Account')<br/>export EKS_REGION="us-east-1"<br/>export CLUSTER_NAME="istio-observe-demo"</span></pre><h2 id="3b44" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">Istio主页</h2><p id="53e7" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">设置您的<code class="fe oh oi oj ok b">ISTIO_HOME</code>目录。我已经安装了最新的<a class="ae le" href="https://istio.io/latest/news/releases/1.10.x/announcing-1.10/" rel="noopener ugc nofollow" target="_blank"> Istio 1.10.0 </a>，并且在我的<a class="ae le" href="https://ohmyz.sh/" rel="noopener ugc nofollow" target="_blank">Oh My Zsh</a>T10】文件中设置了<code class="fe oh oi oj ok b">ISTIO_HOME</code>环境变量。我还在我的<code class="fe oh oi oj ok b">PATH</code>环境变量中设置了Istio的<code class="fe oh oi oj ok b">bin/</code>子目录。<code class="fe oh oi oj ok b">bin/</code>子目录包含<code class="fe oh oi oj ok b">istioctl</code>可执行文件。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="5ee2" class="lv lw it ok b gy op oq l or os">echo $ISTIO_HOME</span><span id="4cb6" class="lv lw it ok b gy ot oq l or os"><em class="ny">/Applications/Istio/istio-1.10.0</em></span><span id="cf25" class="lv lw it ok b gy ot oq l or os">where istioctl</span><span id="e854" class="lv lw it ok b gy ot oq l or os"><em class="ny">/Applications/Istio/istio-1.10.0/bin/istioctl</em></span><span id="dbba" class="lv lw it ok b gy ot oq l or os">istioctl version<br/>                                                               <br/><em class="ny">client version: 1.10.0<br/>control plane version: 1.10.0<br/>data plane version: 1.10.0 (4 proxies)</em></span></pre><h1 id="d9e1" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">创建EKS集群</h1><p id="466d" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">使用前面修改的<code class="fe oh oi oj ok b">cluster.yaml</code>文件，将EKS集群部署到AWS上的新VPC。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="b409" class="lv lw it ok b gy op oq l or os">eksctl create cluster -f ./resources/other/cluster.yaml</span></pre><p id="cebf" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这一步使用CloudFormation部署大量资源。完整的EKS资源调配过程可能需要15–20分钟才能完成。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi pp"><img src="../Images/74fb2d594553977de8209ec8874d1a92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G0dHo43IUyfYQ0F7Q-Kb8g.png"/></div></div></figure><p id="9903" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于完整的演示，<code class="fe oh oi oj ok b">eksctl</code>将在您的AWS环境中部署总共四个CloudFormation堆栈。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oy"><img src="../Images/12e8c364a0f504ccc305d92f166abbce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8ngPP4O_OlxPafCPAlMPcA.png"/></div></div></figure><p id="4c0f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">完成后，配置<code class="fe oh oi oj ok b">kubectl</code>以便可以连接到亚马逊EKS集群。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="dd79" class="lv lw it ok b gy op oq l or os">aws eks --region ${EKS_REGION} update-kubeconfig \<br/>    --name ${CLUSTER_NAME}</span></pre><p id="8ab5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用以下命令确认集群创建成功:</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="cfc3" class="lv lw it ok b gy op oq l or os">kubectl cluster-info</span><span id="6dd1" class="lv lw it ok b gy ot oq l or os">eksctl utils describe-stacks \<br/>  --region ${EKS_REGION} --cluster ${CLUSTER_NAME}</span></pre><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi pp"><img src="../Images/d10c8d06e3a84114ef0864bee40fa5de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i9Zi_XBxnxsDXiyh4sZa7Q.png"/></div></div></figure><p id="ff25" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用EKS管理控制台查看新集群的详细信息。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/f84d9d4d66b38889003d5ee77067ffe0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WKKnxZg503h6waQa6713ww.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">EKS集群管理控制台的配置&gt;计算选项卡</figcaption></figure><p id="1940" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">本演示中的EKS集群是使用单个亚马逊EKS <a class="ae le" href="https://docs.aws.amazon.com/eks/latest/userguide/managed-node-groups.html" rel="noopener ugc nofollow" target="_blank">托管节点组</a>、<code class="fe oh oi oj ok b">managed-ng-1</code>创建的。受管节点组包含三个<code class="fe oh oi oj ok b">m5.large</code> EC2实例。EKS集群的组成可以在<code class="fe oh oi oj ok b">eksctl</code>、<code class="fe oh oi oj ok b">cluster.yaml</code>的<code class="fe oh oi oj ok b">ClusterConfig</code>资源中修改。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oy"><img src="../Images/80037e0ffd2898c31681c59eb21ee0e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nNgeDrxpA60GVfzZQsiZOg.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">EKS集群管理控制台的“概览”选项卡</figcaption></figure><h1 id="c4c5" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">部署AWS负载平衡器控制器</h1><p id="90d5" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">使用您之前修改的<code class="fe oh oi oj ok b">aws-load-balancer-controller-v220-all.yaml</code>文件，部署AWS负载平衡器控制器v2.2.0。请仔细阅读<a class="ae le" href="https://docs.aws.amazon.com/eks/latest/userguide/aws-load-balancer-controller.html" rel="noopener ugc nofollow" target="_blank"> AWS负载平衡器控制器</a>说明，以了解该资源是如何配置并与EKS集成的。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="93e4" class="lv lw it ok b gy op oq l or os">curl -o resources/aws/iam-policy.json \<br/>  <a class="ae le" href="https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.2.0/docs/install/iam_policy.json" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.2.0/docs/install/iam_policy.json</a></span><span id="53f7" class="lv lw it ok b gy ot oq l or os">aws iam create-policy \<br/>    --policy-name AWSLoadBalancerControllerIAMPolicy220 \<br/>    --policy-document file://resources/aws/iam-policy.json</span><span id="d74b" class="lv lw it ok b gy ot oq l or os">eksctl create iamserviceaccount \<br/>  --region ${EKS_REGION} \<br/>  --cluster ${CLUSTER_NAME} \<br/>  --namespace=kube-system \<br/>  --name=aws-load-balancer-controller \<br/>  --attach-policy-arn=arn:aws:iam::${AWS_ACCOUNT}:policy/AWSLoadBalancerControllerIAMPolicy220 \<br/>  --override-existing-serviceaccounts \<br/>  --approve</span><span id="d77e" class="lv lw it ok b gy ot oq l or os">kubectl apply --validate=false \<br/>  -f <a class="ae le" href="https://github.com/jetstack/cert-manager/releases/download/v1.3.1/cert-manager.yaml" rel="noopener ugc nofollow" target="_blank">https://github.com/jetstack/cert-manager/releases/download/v1.3.1/cert-manager.yaml</a></span><span id="b555" class="lv lw it ok b gy ot oq l or os">kubectl apply -f ./resources/other/aws-load-balancer-controller-v220-all.yaml</span></pre><p id="b1d2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要确认<code class="fe oh oi oj ok b">aws-load-balancer-controller</code>已部署就绪，运行以下命令:</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="8600" class="lv lw it ok b gy op oq l or os">kubectl get deployment -n kube-system aws-load-balancer-controller</span><span id="5634" class="lv lw it ok b gy ot oq l or os"><em class="ny">NAME                           READY   UP-TO-DATE   AVAILABLE   AGE<br/>aws-load-balancer-controller   </em><strong class="ok iu"><em class="ny">1/1</em></strong><em class="ny">     1            1           55s</em></span></pre><h2 id="b28a" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">AWS负载平衡器控制器策略</h2><p id="fb7e" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">有一个<a class="ae le" href="https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html" rel="noopener ugc nofollow" target="_blank"> OpenID连接提供者URL </a>与EKS集群相关联。要对服务帐户使用IAM角色，集群中必须存在IAM OIDC提供程序。从EKS管理控制台的详细信息选项卡中获取URL。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oy"><img src="../Images/c7cd65dc57c83c58f1482f53d56ef267.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8oyqAQE9TrI7vG7H22pD0g.png"/></div></div></figure><p id="9f22" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您也可以使用以下AWS CLI命令获取URL:</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="9960" class="lv lw it ok b gy op oq l or os">aws eks describe-cluster --name ${CLUSTER_NAME}</span><span id="172a" class="lv lw it ok b gy ot oq l or os">aws iam list-open-id-connect-providers</span></pre><p id="e71d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该项目包含一个策略文档<code class="fe oh oi oj ok b">trust-eks-policy.json</code>。通过添加上面找到的OpenID Connect信息来修改策略文档。AWS <a class="ae le" href="https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html" rel="noopener ugc nofollow" target="_blank">为集群创建IAM OIDC提供者</a>文档中也包含相关说明。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="7e89" class="lv lw it ok b gy op oq l or os">{<br/>   "Version":"2012-10-17",<br/>   "Statement":[<br/>      {<br/>         "Effect":"Allow",<br/>         "Principal":{<br/>            "Federated":" <strong class="ok iu">{{ your_openid_connect_arn }}</strong>"<br/>         },<br/>         "Action":"sts:AssumeRoleWithWebIdentity",<br/>         "Condition":{<br/>            "StringEquals":{<br/>               "oidc.eks.us-east-1.amazonaws.com/id/<strong class="ok iu">{{ your_open_id_connect_id }}</strong>:sub":"system:serviceaccount:kube-system:alb-ingress-controller"<br/>            }<br/>         }<br/>      }<br/>   ]<br/>}</span></pre><p id="b067" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">创建并附加AWS负载平衡器控制器IAM策略和角色。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="5105" class="lv lw it ok b gy op oq l or os">aws iam create-role \<br/>  --role-name eks-alb-ingress-controller-eks-istio-observe-demo \<br/>  --assume-role-policy-document file://resources/aws/trust-eks-policy.json</span><span id="6a52" class="lv lw it ok b gy ot oq l or os">aws iam attach-role-policy \<br/>  --role-name eks-alb-ingress-controller-eks-istio-observe-demo \<br/>  --policy-arn="arn:aws:iam::${AWS_ACCOUNT}:policy/AWSLoadBalancerControllerIAMPolicy220"</span><span id="43fa" class="lv lw it ok b gy ot oq l or os">aws iam attach-role-policy \<br/>  --role-name eks-alb-ingress-controller-eks-istio-observe-demo \<br/>  --policy-arn arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy</span><span id="19ca" class="lv lw it ok b gy ot oq l or os">aws iam attach-role-policy \<br/>  --role-name eks-alb-ingress-controller-eks-istio-observe-demo \<br/>  --policy-arn arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy</span></pre><h1 id="594f" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">创建名称空间</h1><p id="74ce" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">Kubernetes支持由同一个物理集群支持的多个虚拟集群。这些虚拟集群被称为<a class="ae le" href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/" rel="noopener ugc nofollow" target="_blank">名称空间</a>。<code class="fe oh oi oj ok b">dev</code>名称空间将容纳本次演示的参考应用平台Angular UI前端和Go微服务后端。这个名称空间代表我们的参考应用程序平台在EKS上的开发环境。第二个名称空间<code class="fe oh oi oj ok b">mongo-express</code>将在本文稍后用于部署Mongo Express。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="1e80" class="lv lw it ok b gy op oq l or os">kubectl apply -f ./resources/other/namespaces.yaml</span></pre><h2 id="2f76" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">启用自动边车注射</h2><p id="590a" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">要利用Istio的功能，网格中的单元必须运行Istio边车代理。通过在名称空间上设置<code class="fe oh oi oj ok b">istio-injection=enabled</code> <code class="fe oh oi oj ok b">label</code>并启用注入webhook，在该名称空间中创建的任何新pod将自动添加一个Istio sidecar代理。为<a class="ae le" href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" rel="noopener ugc nofollow" target="_blank">自动边车注入</a>标记<code class="fe oh oi oj ok b">dev</code>命名空间确保了我们的参考应用平台——UI和微服务——将Istio边车代理自动注入到它们的<a class="ae le" href="https://kubernetes.io/docs/concepts/workloads/pods/" rel="noopener ugc nofollow" target="_blank"> pods </a>中。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="9faf" class="lv lw it ok b gy op oq l or os">kubectl label namespace dev istio-injection=enabled</span></pre><h1 id="e07b" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">部署秘密资源</h1><p id="29f1" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">在适当的<code class="fe oh oi oj ok b">dev</code>和<code class="fe oh oi oj ok b">mongo-express</code>名称空间中创建DocumentDB和Amazon MQ秘密。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="8504" class="lv lw it ok b gy op oq l or os">kubectl apply -f ./resources/dev/secrets/secrets.yaml</span><span id="0042" class="lv lw it ok b gy ot oq l or os">kubectl apply -f ./resources/mongo-express/secrets/secrets.yaml</span></pre><h1 id="bb10" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">安装Istio配置描述文件</h1><p id="a80d" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">Istio带有几个内置配置<a class="ae le" href="https://istio.io/latest/docs/setup/additional-setup/config-profiles/" rel="noopener ugc nofollow" target="_blank">配置文件</a>。这些配置文件提供了对Istio控制平面和Istio数据平面侧柜的定制。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="7eb2" class="lv lw it ok b gy op oq l or os">istioctl profile list</span><span id="7fe0" class="lv lw it ok b gy ot oq l or os"><em class="ny">Istio configuration profiles:<br/>  default<br/>  demo<br/>  empty<br/>  external<br/>  minimal<br/>  openshift<br/>  preview<br/>  remote</em></span></pre><p id="391a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于这个演示，使用<code class="fe oh oi oj ok b">default</code>概要文件，它安装Istio核心、<code class="fe oh oi oj ok b">istiod</code>、<code class="fe oh oi oj ok b">istio-ingressgateway</code>和<code class="fe oh oi oj ok b">istio-egressgateway</code>。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="d444" class="lv lw it ok b gy op oq l or os">istioctl install --set profile=demo -y</span><span id="f0aa" class="lv lw it ok b gy ot oq l or os"><em class="ny">✔ Istio core installed<br/>✔ Istiod installed<br/>✔ Ingress gateways installed<br/>✔ Egress gateways installed<br/>✔ Installation complete</em></span></pre><h1 id="d12e" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">在Dev命名空间中部署Istio资源</h1><p id="6657" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">Istio <code class="fe oh oi oj ok b"><a class="ae le" href="https://istio.io/latest/docs/reference/config/networking/gateway/" rel="noopener ugc nofollow" target="_blank">Gateway</a></code>描述了在网格边缘运行的负载平衡器，接收输入或输出的HTTP/TCP连接。Istio <code class="fe oh oi oj ok b"><a class="ae le" href="https://istio.io/latest/docs/reference/config/networking/virtual-service/" rel="noopener ugc nofollow" target="_blank">VirtualService</a></code>定义了当主机被寻址时要应用的一组流量路由规则。最后，Istio <code class="fe oh oi oj ok b"><a class="ae le" href="https://istio.io/latest/docs/reference/config/networking/destination-rule/" rel="noopener ugc nofollow" target="_blank">DestinationRule</a></code>定义了在路由发生后应用于某个服务的流量的策略。你需要部署一个Istio <code class="fe oh oi oj ok b"><a class="ae le" href="https://istio.io/latest/docs/reference/config/networking/gateway/" rel="noopener ugc nofollow" target="_blank">Gateway</a></code>和一套<code class="fe oh oi oj ok b"><a class="ae le" href="https://istio.io/latest/docs/reference/config/networking/virtual-service/" rel="noopener ugc nofollow" target="_blank">VirtualService</a></code>。您还需要部署一组<code class="fe oh oi oj ok b"><a class="ae le" href="https://istio.io/latest/docs/reference/config/networking/destination-rule/" rel="noopener ugc nofollow" target="_blank">DestinationRule</a></code>资源。使用以下命令创建Istio <code class="fe oh oi oj ok b"><a class="ae le" href="https://istio.io/latest/docs/reference/config/networking/gateway/" rel="noopener ugc nofollow" target="_blank">Gateway</a></code>、两个<code class="fe oh oi oj ok b">VirtualService</code>、九个<code class="fe oh oi oj ok b"><a class="ae le" href="https://istio.io/latest/docs/reference/config/networking/destination-rule/" rel="noopener ugc nofollow" target="_blank">DestinationRule</a></code>和两个<code class="fe oh oi oj ok b">ServiceEntry</code>资源:</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="f7d8" class="lv lw it ok b gy op oq l or os">kubectl apply -f ./resources/dev/istio/</span></pre><h1 id="b62c" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">部署Istio遥测插件</h1><p id="2fb6" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">Istio项目包括与Istio集成的各种遥测插件的示例部署。附加组件包括Jaeger、Kiali、Prometheus和Grafana，以及可选的Zipkin。虽然这些应用程序不是Istio的一部分，但它们对于充分利用Istio的可观察性功能至关重要。根据Istio项目，这些部署旨在快速启动并运行以用于演示目的，并针对这种情况进行了优化。因此，这些部署不适用于生产。参见<a class="ae le" href="https://github.com/istio/istio/tree/master/samples/addons" rel="noopener ugc nofollow" target="_blank"> GitHub项目</a>了解更多关于集成每个插件的生产级版本的信息。</p><p id="5a83" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用默认方法安装附加组件。然后，用项目中包含的修改后的配置更新Prometheus。在<code class="fe oh oi oj ok b">prometheus.yaml</code>文件中修改的Kubernetes <code class="fe oh oi oj ok b">ConfigMap</code>增加了配置来抓取参考平台的<code class="fe oh oi oj ok b">/api/metrics</code>端点。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="722c" class="lv lw it ok b gy op oq l or os">kubectl apply -f $ISTIO_HOME/samples/addons</span><span id="fda8" class="lv lw it ok b gy ot oq l or os">kubectl apply -f ./resources/istio-system/prometheus.yaml</span></pre><p id="21ce" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在EKS管理控制台的“workloads”选项卡中，您应该会看到命名空间中有七个工作负载，每个工作负载都有一个pod正在运行。工作负载包括Grafana、Jaeger、Kiali和Prometheus。还包括之前安装的Istio配置<code class="fe oh oi oj ok b">demo</code>配置文件的<code class="fe oh oi oj ok b">istiod</code>、<code class="fe oh oi oj ok b">istio-ingressgateway</code>和<code class="fe oh oi oj ok b">istio-egressgateway</code>。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oy"><img src="../Images/8831953259ecb50fc5b9bf0d11559eb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PKUleP2SpUvBmfMxKWrozA.png"/></div></div></figure><h1 id="4659" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">部署Kubernetes Web UI(仪表板)</h1><p id="afc0" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated"><a class="ae le" href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" rel="noopener ugc nofollow" target="_blank"> Kubernetes Web UI </a>(仪表板)是一个基于Web的Kubernetes用户界面。您可以使用Dashboard将容器化的应用程序部署到Kubernetes集群，对容器化的应用程序进行故障排除，并管理集群资源。此外，您可以使用仪表板来了解集群上运行的应用程序的概况，以及创建或修改单个Kubernetes资源。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oy"><img src="../Images/682ec29dfd73632b36756a27b01c2a56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I7-m0A84h7y0S_fFewd_NQ.png"/></div></div></figure><p id="3892" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要部署仪表板，请遵循<a class="ae le" href="https://docs.aws.amazon.com/eks/latest/userguide/dashboard-tutorial.html" rel="noopener ugc nofollow" target="_blank">教程中概述的步骤:部署Kubernetes仪表板(web UI) </a>。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="f704" class="lv lw it ok b gy op oq l or os">kubectl apply -f <a class="ae le" href="https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.5/aio/deploy/recommended.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.5/aio/deploy/recommended.yaml</a></span><span id="1bea" class="lv lw it ok b gy ot oq l or os">kubectl apply -f ./resources/kube-system/eks-admin-service-account.yaml</span></pre><p id="3a70" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">每个服务帐户都有一个密码，该密码带有用于登录仪表板的有效不记名令牌。使用以下命令检索与<code class="fe oh oi oj ok b">eks-admin</code>帐户相关联的令牌。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="8152" class="lv lw it ok b gy op oq l or os">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep eks-admin | awk '{print $1}')</span></pre><p id="f16d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在单独的终端窗口中启动<code class="fe oh oi oj ok b">kubectl proxy</code>。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="f2d8" class="lv lw it ok b gy op oq l or os">kubectl proxy</span></pre><p id="27a2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用<code class="fe oh oi oj ok b">eks-admin</code>帐户的令牌登录到位于以下URL的Kubernetes仪表板:</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="b524" class="lv lw it ok b gy op oq l or os"><a class="ae le" href="http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/#!/login" rel="noopener ugc nofollow" target="_blank">http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/#!/login</a></span></pre><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/5c70079047edfe9bd8ca80cd9d693b3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sMef2hZbDjUI16Mk9cPCZA.png"/></div></div></figure><h1 id="e7e9" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">部署Mongo Express</h1><p id="a9ec" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">Mongo Express是一个基于web的MongoDB管理接口，用Node.js、Express和Bootstrap3编写。将Mongo Express安装到EKS集群上的<code class="fe oh oi oj ok b">mongo-express</code>名称空间中，以管理DocumentDB集群。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="a60e" class="lv lw it ok b gy op oq l or os">kubectl apply -f ./resources/mongo-express/services/mongo-express.yaml</span></pre><p id="bcf6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用以下两个命令获取任何Kubernetes工作节点的外部IP地址和Mongo Express的节点端口:</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="c3c3" class="lv lw it ok b gy op oq l or os">kubectl get nodes -o wide |  awk {'print $1" " $2 " " $7'} | column -t</span><span id="2eb7" class="lv lw it ok b gy ot oq l or os">kubectl get service/mongo-express -n mongo-express</span></pre><p id="5421" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了确保对Mongo Express的安全访问，在您的VPC的安全组中创建一个入站规则，只允许您的IP地址(“我的IP”选项)访问在上面获得的节点端口上运行的Mongo Express。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oy"><img src="../Images/6be1185430629d46170310b973acca2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hTcTec8sVy9L-diKatzghw.png"/></div></div></figure><p id="fe93" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在单独的终端窗口中启动<code class="fe oh oi oj ok b">kubectl proxy</code>。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="62c2" class="lv lw it ok b gy op oq l or os">kubectl proxy</span></pre><p id="22b7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用任何Kubernetes工作节点和当前节点端口的外部IP地址来访问Mongo Express。Mongo Express将要求您输入您在之前使用基本身份验证创建的Kubernetes Secret中编码的用户名和密码。一旦您部署了参考应用程序平台，在本文的后面，您将会看到四个数据库:<code class="fe oh oi oj ok b">service-c</code>、<code class="fe oh oi oj ok b">service-f</code>、<code class="fe oh oi oj ok b">service-g</code>和<code class="fe oh oi oj ok b">service-h</code>。您通常在自己的MongoDB安装中看到的典型操作数据库在UI中是不可用的，因为DocumentDB是一个托管服务。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oy"><img src="../Images/8cb2e821bd9796e707c999f1e3818373.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qbMUQDNXz8jLgHuADbBQ8Q.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">Mongo Express UI显示了四个参考平台的数据库</figcaption></figure><h1 id="26de" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">修改和部署ALB入口</h1><p id="1829" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">该项目包含一个ALB <code class="fe oh oi oj ok b">Ingress</code>资源<code class="fe oh oi oj ok b">alb-ingress.yaml</code>。先前安装的AWS负载平衡器控制器被配置为限制ALB入口控制器控制的入口。通过设置<code class="fe oh oi oj ok b">--ingress-class=alb</code>参数，它将控制器的范围限制为使用匹配的<code class="fe oh oi oj ok b">kubernetes.io/ingress.class: alb</code>注释。这在同一个集群中运行多个入口控制器时尤其有用。</p><p id="5385" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">ALB <code class="fe oh oi oj ok b">Ingress</code>资源<code class="fe oh oi oj ok b">alb-ingress.yaml</code>需要在部署之前进行修改。首先，更新<code class="fe oh oi oj ok b"><a class="ae le" href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.2/guide/ingress/annotations/#health-check" rel="noopener ugc nofollow" target="_blank">alb.ingress.kubernetes.io/healthcheck-port</a></code>注释。端口值来自于<code class="fe oh oi oj ok b">istio-ingressgateway</code>的<code class="fe oh oi oj ok b">status-port</code>，它作为Istio <code class="fe oh oi oj ok b">demo</code>配置文件的一部分安装。要从<code class="fe oh oi oj ok b">istio-ingressgateway</code>获得<code class="fe oh oi oj ok b">status-port</code>，运行以下命令:</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="06db" class="lv lw it ok b gy op oq l or os">export STATUS_PORT=$(kubectl -n istio-system get svc istio-ingressgateway \<br/>  -o jsonpath='{.spec.ports[?(@.name=="status-port")].nodePort}')</span><span id="fa5a" class="lv lw it ok b gy ot oq l or os">yq e '.metadata.annotations."alb.ingress.kubernetes.io/healthcheck-port" = env(STATUS_PORT)' -i ./resources/istio-system/alb-ingress.yaml</span></pre><p id="7382" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，将与<code class="fe oh oi oj ok b"><a class="ae le" href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.2/guide/integrations/external_dns/" rel="noopener ugc nofollow" target="_blank">external-dns.alpha.kubernetes.io/hostname</a></code>注释中列出的域相关联的SSL/TLS ( <a class="ae le" href="https://en.wikipedia.org/wiki/Transport_Layer_Security" rel="noopener ugc nofollow" target="_blank">传输层安全性</a>)证书的ARN插入到ALB <code class="fe oh oi oj ok b">Ingress</code>资源<code class="fe oh oi oj ok b">alb-ingress.yaml</code>中。运行以下命令将TLS证书的ARN插入到<code class="fe oh oi oj ok b"><a class="ae le" href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.2/guide/tasks/ssl_redirect/" rel="noopener ugc nofollow" target="_blank">alb.ingress.kubernetes.io/certificate-arn</a></code> <a class="ae le" href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.2/guide/tasks/ssl_redirect/" rel="noopener ugc nofollow" target="_blank"> </a>注释中。该命令假设您的SSL/TLS证书已向<a class="ae le" href="https://docs.aws.amazon.com/acm/latest/userguide/acm-overview.html" rel="noopener ugc nofollow" target="_blank"> AWS证书管理器</a> (ACM)注册。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="5f8e" class="lv lw it ok b gy op oq l or os">export ALB_CERT=$(aws acm list-certificates --certificate-statuses ISSUED \<br/>  | jq -r '.CertificateSummaryList[] | select(.DomainName=="*.example-api.com") | .CertificateArn')</span><span id="54c0" class="lv lw it ok b gy ot oq l or os">yq e '.metadata.annotations."alb.ingress.kubernetes.io/certificate-arn" = strenv(ALB_CERT)' -i ./resources/istio-system/alb-ingress.yaml</span></pre><p id="7a69" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe oh oi oj ok b"><a class="ae le" href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.2/guide/tasks/ssl_redirect/" rel="noopener ugc nofollow" target="_blank">alb.ingress.kubernetes.io/actions.ssl-redirect</a></code>注释将所有HTTP流量重定向到HTTPS。TLS证书用于HTTPS流量。然后，ALB终止ALB上的HTTPS流量，并将未加密的流量转发到端口80上的EKS集群。</p><p id="a2c1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，用您的平台的UI和API主机名的公共分隔列表更新<code class="fe oh oi oj ok b"><a class="ae le" href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.2/guide/integrations/external_dns/" rel="noopener ugc nofollow" target="_blank">external-dns.alpha.kubernetes.io/hostname</a></code>注释。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="5fd4" class="lv lw it ok b gy op oq l or os">yq e '.metadata.annotations."external-dns.alpha.kubernetes.io/hostname" = "<strong class="ok iu">api.example.com, ui.example.com"</strong>' -i ./resources/istio-system/alb-ingress.yaml</span></pre><p id="a29f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是完整的ALB <code class="fe oh oi oj ok b">Ingress</code>资源，<code class="fe oh oi oj ok b">alb-ingress.yaml</code>。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="4653" class="lv lw it ok b gy op oq l or os">apiVersion: networking.k8s.io/v1<br/>kind: Ingress<br/>metadata:<br/>  name: demo-ingress<br/>  namespace: istio-system<br/>  annotations:<br/>    kubernetes.io/ingress.class: alb<br/>    alb.ingress.kubernetes.io/scheme: internet-facing<br/>    alb.ingress.kubernetes.io/tags: Environment=dev<br/><strong class="ok iu">    alb.ingress.kubernetes.io/healthcheck-port: '{{ your_status_port }}'<br/></strong>    alb.ingress.kubernetes.io/healthcheck-path: /healthz/ready<br/>    alb.ingress.kubernetes.io/healthcheck-protocol: HTTP<br/>    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS":443}]'<br/>    alb.ingress.kubernetes.io/actions.ssl-redirect: '{"Type": "redirect", "RedirectConfig": { "Protocol": "HTTPS", "Port": "443", "StatusCode": "HTTP_301"}}'<br/><strong class="ok iu">    external-dns.alpha.kubernetes.io/hostname: "{{ your_ui_hostname, your_api_hostname }}"<br/>    alb.ingress.kubernetes.io/certificate-arn: "{{ your_ssl_tls_cert_arn }}"<br/></strong>    alb.ingress.kubernetes.io/load-balancer-attributes: routing.http2.enabled=true,idle_timeout.timeout_seconds=30<br/>  labels:<br/>    app: reference-app<br/>spec:<br/>  rules:<br/>    - http:<br/>        paths:<br/>          - pathType: Prefix<br/>            path: /<br/>            backend:<br/>              service:<br/>                name: ssl-redirect<br/>                port:<br/>                  name: use-annotation<br/>          - pathType: Prefix<br/>            path: /<br/>            backend:<br/>              service:<br/>                name: istio-ingressgateway<br/>                port:<br/>                  number: 80<br/>          - pathType: Prefix<br/>            path: /api<br/>            backend:<br/>              service:<br/>                name: istio-ingressgateway<br/>                port:<br/>                  number: 80</span></pre><p id="c18b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要部署ALB <code class="fe oh oi oj ok b">Ingress</code>资源<code class="fe oh oi oj ok b">alb-ingress.yaml</code>，请运行以下命令:</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="b120" class="lv lw it ok b gy op oq l or os">kubectl apply -f ./resources/istio-system/alb-ingress.yaml</span></pre><p id="76aa" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要确认AWS负载平衡器控制器和ingresses ALB入口控制器控件的配置，请运行以下命令:</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="b779" class="lv lw it ok b gy op oq l or os">kubectl describe ingress.networking.k8s.io --all-namespaces</span></pre><p id="9beb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">任何错误配置都应该在<code class="fe oh oi oj ok b">Events</code>部分显示为错误。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oz"><img src="../Images/511f7ad7968e6beef9099ba1e611a53a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UfdT4PkxLq8kUFlOJdKagw.png"/></div></div></figure><p id="5739" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">运行以下命令应该会显示与端口80相关联的ALB的公共DNS地址。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="e297" class="lv lw it ok b gy op oq l or os">kubectl -n istio-system get ingress</span><span id="1ce9" class="lv lw it ok b gy ot oq l or os"><em class="ny">NAME           CLASS    HOSTS   ADDRESS                                                                   PORTS   AGE<br/>demo-ingress   &lt;none&gt;   *       k8s-istiosys-demoingr-</em>...<em class="ny">us-east-1.elb.amazonaws.com   80      23m</em></span></pre><p id="f4e7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用EC2负载平衡器管理控制台查看新ALB的详细信息。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oy"><img src="../Images/4c02edae740fafe9de72dfc99a2169d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x7cPMehMfJBYpHwtUxlOQA.png"/></div></div></figure><h1 id="0e1d" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">部署流畅位和云观察代理</h1><p id="9ae4" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">根据AWS最近的一篇博客文章，<a class="ae le" href="https://aws.amazon.com/blogs/containers/fluent-bit-integration-in-cloudwatch-container-insights-for-eks/" rel="noopener ugc nofollow" target="_blank">Fluent Bit Integration in CloudWatch Container Insights for EKS</a>，<a class="ae le" href="https://fluentbit.io/" rel="noopener ugc nofollow" target="_blank"> Fluent Bit </a>是一个开源的多平台日志处理器和转发器，允许您从不同的来源收集数据和日志，并将其统一发送到不同的目的地，包括cloud watch日志。Fluent Bit还完全兼容<a class="ae le" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker </a>和<a class="ae le" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>环境。使用新推出的Fluent Bit <code class="fe oh oi oj ok b">DaemonSet</code>，您可以将容器日志从您的EKS集群发送到CloudWatch logs进行日志存储和分析。亚马逊EKS集群上的CloudWatch代理<code class="fe oh oi oj ok b">DaemonSet</code>将向CloudWatch发送指标，而Fluent Bit <code class="fe oh oi oj ok b">DaemonSet</code>将向CloudWatch日志发送日志。</p><p id="1f51" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了安装Fluent Bit和CloudWatch代理，我使用了AWS文档中概述的步骤:<a class="ae le" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Container-Insights-setup-EKS-quickstart.html" rel="noopener ugc nofollow" target="_blank">亚马逊EKS和Kubernetes上Container Insights的快速启动设置</a>。我建议查看该文档以获得详细的安装说明。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="3309" class="lv lw it ok b gy op oq l or os">kubectl apply -f <a class="ae le" href="https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/cloudwatch-namespace.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/cloudwatch-namespace.yaml</a></span><span id="eb64" class="lv lw it ok b gy ot oq l or os">ClusterName=${CLUSTER_NAME}<br/>RegionName=${EKS_REGION}<br/>FluentBitHttpPort='2020'<br/>FluentBitReadFromHead='Off'<br/>[[ ${FluentBitReadFromHead} = 'On' ]] &amp;&amp; FluentBitReadFromTail='Off'|| FluentBitReadFromTail='On'<br/>[[ -z ${FluentBitHttpPort} ]] &amp;&amp; FluentBitHttpServer='Off' || FluentBitHttpServer='On'<br/>kubectl create configmap fluent-bit-cluster-info \<br/>--from-literal=cluster.name=${ClusterName} \<br/>--from-literal=http.server=${FluentBitHttpServer} \<br/>--from-literal=http.port=${FluentBitHttpPort} \<br/>--from-literal=read.head=${FluentBitReadFromHead} \<br/>--from-literal=read.tail=${FluentBitReadFromTail} \<br/>--from-literal=logs.region=${RegionName} -n amazon-cloudwatch</span><span id="4322" class="lv lw it ok b gy ot oq l or os">kubectl apply -f <a class="ae le" href="https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/fluent-bit/fluent-bit.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/fluent-bit/fluent-bit.yaml</a></span><span id="8167" class="lv lw it ok b gy ot oq l or os">kubectl get pods -n amazon-cloudwatch</span><span id="88d5" class="lv lw it ok b gy ot oq l or os">DASHBOARD_NAME=istio_observe_demo<br/>REGION_NAME=${EKS_REGION}<br/>CLUSTER_NAME=${CLUSTER_NAME}</span><span id="82ba" class="lv lw it ok b gy ot oq l or os">curl <a class="ae le" href="https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/service/cwagent-prometheus/sample_cloudwatch_dashboards/fluent-bit/cw_dashboard_fluent_bit.json" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/service/cwagent-prometheus/sample_cloudwatch_dashboards/fluent-bit/cw_dashboard_fluent_bit.json</a> \<br/>| sed "s/{{YOUR_AWS_REGION}}/${REGION_NAME}/g" \<br/>| sed "s/{{YOUR_CLUSTER_NAME}}/${CLUSTER_NAME}/g" \<br/>| xargs -0 aws cloudwatch put-dashboard --dashboard-name ${DASHBOARD_NAME} --dashboard-body</span><span id="8f07" class="lv lw it ok b gy ot oq l or os">curl <a class="ae le" href="https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/fluentd/fluentd.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/fluentd/fluentd.yaml</a> | kubectl delete -f -<br/>kubectl delete configmap cluster-info -n amazon-cloudwatch</span></pre><h2 id="f461" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">可选:Prometheus的CloudWatch代理</h2><p id="0902" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">或者，您也可以将带有Prometheus monitoring 的<a class="ae le" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/ContainerInsights-Prometheus-metrics.html" rel="noopener ugc nofollow" target="_blank"> CloudWatch代理安装到您的亚马逊EKS集群中。如果您主要使用CloudWatch来监控您的EKS集群，我建议添加这个额外的指标收集功能。要使用Prometheus monitoring <code class="fe oh oi oj ok b">DaemonSet</code>配置和部署CloudWatch代理，请遵循文档</a><a class="ae le" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/ContainerInsights-Prometheus-install-EKS.html" rel="noopener ugc nofollow" target="_blank">在亚马逊EKS和Kubernetes集群上设置和配置Prometheus度量集合</a>。</p><p id="026a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了节省时间，我修改了说明中讨论的<code class="fe oh oi oj ok b">prometheus-eks.yaml</code>文件，并将其包含在项目中。要使用该文件，用以下命令替换教程 ( <code class="fe oh oi oj ok b">kubectl apply -f prometheus-eks.yaml</code>)的<a class="ae le" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/ContainerInsights-Prometheus-Setup-configure.html#ContainerInsights-Prometheus-Setup-new-exporters" rel="noopener ugc nofollow" target="_blank">步骤5中的命令:</a></p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="0d1b" class="lv lw it ok b gy op oq l or os">kubectl apply -f ./resources/amazon-cloudwatch/prometheus-eks.yaml</span></pre><p id="f934" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您检查EKS集群的<code class="fe oh oi oj ok b">amazon-cloudwatch</code>名称空间，您应该观察到两个<code class="fe oh oi oj ok b">DaemonSet</code>正在运行:<code class="fe oh oi oj ok b">cloudwatch-agent</code>和<code class="fe oh oi oj ok b">fluent-bit</code>。如果你在Prometheus上安装了CloudWatch代理，你会多一个<code class="fe oh oi oj ok b">Deployment</code>、<code class="fe oh oi oj ok b">cwagent-prometheus</code>。每个<code class="fe oh oi oj ok b">DaemonSet</code>向集群的每个工作节点部署一个pod。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/7a53ed115200bad779bf26d807386415.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FeDjVtbijcFISb0tJZuXzA.png"/></div></div></figure><p id="f399" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦参考应用程序平台部署并运行，您应该能够在<a class="ae le" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/ContainerInsights.html" rel="noopener ugc nofollow" target="_blank">Amazon cloud watch Container Insights</a>控制台的地图视图中可视化应用程序。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oy"><img src="../Images/9b2656cbb5664084fd7e9d81341f8935.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0BzPxW1-86Gn-xC17XdTvA.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">Amazon CloudWatch容器洞察UI</figcaption></figure><p id="fd2a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">参考平台的集群日志也将在Amazon CloudWatch中提供。您应该能够访问每个应用程序组件的单独日志组。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oy"><img src="../Images/e402b193b0a79e821b02baafd96899d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eHLVGVNEIKozMt4Nm4xetg.png"/></div></div></figure><p id="bc72" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，还可以通过Kubernetes仪表板查看单个pod日志。微服务的日志详细级别默认设置为<code class="fe oh oi oj ok b">info</code>。这个级别可以使用服务的Kubernetes <code class="fe oh oi oj ok b">Deployment</code>资源中的<code class="fe oh oi oj ok b">LOG_LEVEL</code>环境变量来更改。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oy"><img src="../Images/82ffd45340bfcf0768cce4ad11be0ec5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7zEugUxsXQvBPhemVc7a9Q.png"/></div></div></figure><h1 id="2364" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">部署ServiceEntry资源</h1><p id="5ff7" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">使用Istio <code class="fe oh oi oj ok b">ServiceEntry</code> <a class="ae le" href="https://istio.io/latest/docs/tasks/traffic-management/egress/egress-control/#controlled-access-to-external-services" rel="noopener ugc nofollow" target="_blank">配置</a>，您可以从您的Istio集群中访问任何可公开访问的服务。Istio代理可以配置为阻止任何没有在网格中定义HTTP服务或服务条目的主机。我们不会在演示中走到这个极端。然而，我们将配置<code class="fe oh oi oj ok b">ServiceEntry</code>配置来监控参考平台的两个外部服务DocumentDB和Amazon MQ的出口流量。</p><p id="05db" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">确认<code class="fe oh oi oj ok b">istio-egressgateway</code>正在运行，然后部署您之前修改的两个<code class="fe oh oi oj ok b">ServiceEntry</code>资源。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="6dd3" class="lv lw it ok b gy op oq l or os">kubectl get pod -l istio=egressgateway -n istio-system</span><span id="320c" class="lv lw it ok b gy ot oq l or os"><em class="ny">NAME                                   READY   STATUS    RESTARTS   AGE<br/>istio-egressgateway-585f7668fc-74qtf   1/1     Running   0          14h</em></span><span id="26aa" class="lv lw it ok b gy ot oq l or os">kubectl apply -f ./resources/dev/istio/external-mesh-document-db-internal.yaml</span><span id="344c" class="lv lw it ok b gy ot oq l or os">kubectl apply -f ./resources/dev/istio/external-mesh-amazon-mq-internal.yaml</span></pre><h1 id="d195" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">部署参考应用程序平台</h1><p id="5639" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">平台的每个组件在项目中都有一个文件，包含Kubernetes <code class="fe oh oi oj ok b">Service</code>和相应的<code class="fe oh oi oj ok b">Deployment</code>资源。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="b780" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用以下命令将参考应用平台的前端UI和八个后端微服务部署到EKS集群:</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="8620" class="lv lw it ok b gy op oq l or os">kubectl apply -f ./resources/dev/services/ -n dev</span></pre><p id="6d60" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从EKS管理控制台的“工作负载”选项卡中，您应该观察到每个参考应用程序平台组件的三个窗格都已启动并在<code class="fe oh oi oj ok b">dev</code>名称空间中运行。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oy"><img src="../Images/bd8b296b10a94ea902a564b8beb23220.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q7E2zDFbmiRAIBRz7Dl9lQ.png"/></div></div></figure><p id="7dce" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您还可以使用Kubernetes仪表板来确认成功部署到了<code class="fe oh oi oj ok b">dev</code>名称空间。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oy"><img src="../Images/ab7b882d860ae497478e23e988d568ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cMe3106keKewdaLfOLJOhw.png"/></div></div></figure><h1 id="0a32" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">测试平台</h1><p id="54de" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">您希望确保平台的基于web的UI可以通过AWS应用程序负载平衡器到达EKS(通过Istio)和UI的FQDN(完全合格的域名)<code class="fe oh oi oj ok b">angular-ui.dev.svc.cluster.local</code>。您希望确保平台的八个微服务相互通信，并与外部DocumentDB集群和Amazon MQ RabbitMQ代理通信。测试集群最简单的方法是在web浏览器中查看Angular UI。比如我的<code class="fe oh oi oj ok b"><a class="ae le" href="https://observe-ui.example-api.com)." rel="noopener ugc nofollow" target="_blank">https://observe-ui.example-api.com</a></code> <a class="ae le" href="https://observe-ui.example-api.com)." rel="noopener ugc nofollow" target="_blank">。</a></p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/f0ba4f78f12b3cb7eacdf25066dedd7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Sdta2rzXDMr4p9I_XlJFQ.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">参考应用平台的基于角度的用户界面</figcaption></figure><p id="1993" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">UI要求您输入后端的主机名，即边缘服务Service A。因为您希望使用自己的主机名，并且UI的JavaScript代码在您的web浏览器中本地运行，所以该选项允许您提供自己的主机名。这个主机名与您插入到服务A的Istio <code class="fe oh oi oj ok b">VirtualService</code>中的主机名相同。这个主机名将API调用路由到在<code class="fe oh oi oj ok b">dev</code>名称空间<code class="fe oh oi oj ok b">service-a.dev.svc.cluster.local</code>中运行的服务A的FQDN。您应该观察到UI中显示了七个问候响应，除了Service F。</p><p id="71bd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">也可以使用类似<a class="ae le" href="https://www.postman.com/" rel="noopener ugc nofollow" target="_blank"> Postman </a>这样的工具直接测试后端，使用和上面一样的后端主机名。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oy"><img src="../Images/25bd247c4aa62452f2a24ac6851c16cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*13H0j851Qv6oGwyvSfruBA.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">使用Postman对服务A的/greeting端点发出请求</figcaption></figure><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/9a405525ab33c9413055d19e159e799d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*snQP_VcG_89w6JLEjM4igQ.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">使用Postman对服务A的/request-echo端点发出请求</figcaption></figure><h2 id="33c6" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">使用Hey进行负载测试</h2><p id="d6f1" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">您还可以使用性能测试工具对平台进行负载测试。许多问题直到平台被置于升高的负载下才会显现出来。我最近尝试了<a class="ae le" href="https://github.com/rakyll/hey" rel="noopener ugc nofollow" target="_blank"> hey </a>，一个基于go的现代负载生成器工具，作为Apache Bench ( <code class="fe oh oi oj ok b">ab</code>)的替代品，与<code class="fe oh oi oj ok b">ab</code>不同，<code class="fe oh oi oj ok b">hey</code>支持HTTP/2端点，这是在EKS用Istio测试平台所必需的。可以用<a class="ae le" href="https://brew.sh/" rel="noopener ugc nofollow" target="_blank">自制</a>安装hey。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="d28b" class="lv lw it ok b gy op oq l or os">brew install hey</span></pre><p id="1a31" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用hey，您可以通过点击API主机名和<code class="fe oh oi oj ok b">/api/greeting</code>端点来测试参考应用程序平台。下面的命令生成1000个请求，模拟25个并发用户，使用<a class="ae le" href="https://en.wikipedia.org/wiki/HTTP/2" rel="noopener ugc nofollow" target="_blank"> HTTP/2 </a>。所有服务、RabbitMQ代理和DocumentDB数据库之间都会产生流量。</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="0b74" class="lv lw it ok b gy op oq l or os">hey -n 1000 -c 25 -h2 <a class="ae le" href="https://observe-istio-eks.example-api.com" rel="noopener ugc nofollow" target="_blank">{</a>{ your_api_hostname }}/api/greeting</span></pre><p id="58a5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">结果显示，参考平台的API在大约43秒内成功响应了1000次<code class="fe oh oi oj ok b">HTTP 200</code>，平均响应时间为1.0430秒。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi pq"><img src="../Images/51b7d2f729cb08555d3250d405dd2979.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u16XESyfyfO4ysfYIMYMrw.png"/></div></div></figure><p id="7147" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要在较长时间内生成一致的流量水平，请尝试以下命令变体:</p><pre class="lg lh li lj gt ol ok om on aw oo bi"><span id="043f" class="lv lw it ok b gy op oq l or os">hey -n <!-- -->25000<!-- --> -c 25 <!-- -->-q 1 <!-- -->-h2 <a class="ae le" href="https://observe-istio-eks.example-api.com" rel="noopener ugc nofollow" target="_blank">{</a>{ your_api_hostname }}/api/greeting</span></pre><p id="e28f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该命令会产生大约18分钟的稳定流量，这使得在探索和排除可观测性工具的故障时更加方便。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi pr"><img src="../Images/1c05b61e07dbaaa0f161a8d77c86a076.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Scs7mlU0hX-g8AWoAeah_Q.png"/></div></div></figure><h1 id="6327" class="nn lw it bd lx no np nq ma nr ns nt md jz nu ka mg kc nv kd mj kf nw kg mm nx bi translated">第二部分</h1><p id="9c3e" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">在本帖的第二部分<a class="ae le" rel="noopener ugc nofollow" target="_blank" href="/kubernetes-based-microservice-observability-with-istio-service-mesh-part-2-of-2-ceec27575040">中，我们将探索每个可观察性工具，看看它们如何帮助我们管理运行在EKS集群上的参考应用平台。</a></p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oy"><img src="../Images/ccd5177931f55550987feb62f0d528a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QA7y4t82umtdAxxLPvuQCg.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">Jaeger UI显示服务A的分布式跟踪</figcaption></figure></div><div class="ab cl ps pt hx pu" role="separator"><span class="pv bw bk pw px py"/><span class="pv bw bk pw px py"/><span class="pv bw bk pw px"/></div><div class="im in io ip iq"><p id="089e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">本博客代表我自己的观点，不代表我的雇主亚马逊网络服务公司(AWS)的观点。所有产品名称、徽标和品牌都是其各自所有者的财产。</p></div></div>    
</body>
</html>