<html>
<head>
<title>How to do Port Forwarding on LXC with Awall</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用防火墙在LXC上进行端口转发</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-do-port-forwarding-on-lxc-with-awall-bd498da69164?source=collection_archive---------1-----------------------#2021-08-23">https://itnext.io/how-to-do-port-forwarding-on-lxc-with-awall-bd498da69164?source=collection_archive---------1-----------------------#2021-08-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="c0ac" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">介绍</h1><p id="3ea9" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我们将使用一个Linux系统来运行我们的LXC容器，以便在由T2 panta cor构建的嵌入式设备上运行容器，这样我们将减少管理LXC容器的麻烦，并且我们将使用Raspberry PI 4来运行一切。</p><p id="9631" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">Pantavisor使用LXC在嵌入式计算机上运行容器。默认情况下，所有容器共享主机的网络命名空间，因此，网络的LXC配置将为:</p><p id="f486" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><strong class="kn ir"> lxc.net.[0]。type = none </strong></p><p id="d552" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><a class="ae lj" href="https://linuxcontainers.org/lxc/manpages/man5/lxc.container.conf.5.html#lbAO" rel="noopener ugc nofollow" target="_blank"> LXC —联机帮助页— lxc.container.conf.5 </a></p><p id="c65c" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这意味着如果有多个容器使用同一个网络<strong class="kn ir">端口，</strong>容器初始化将会失败。解决该问题的一种方法是创建具有虚拟以太网类型网络的容器，然后从主机网络向容器IP进行端口转发。</p><p id="4c30" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在Docker中，当您运行容器时，端口转发是一个简单的配置。但对于LXC集装箱来说，事情就没那么简单了。在本帖中，我们将描述如何在<em class="lp"> pantavisor内部转发端口。</em>使用Pantavisor工具，您将创建LXC配置，然后使用<em class="lp">墙</em>构建将管理转发的容器IP表。</p><h1 id="082d" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">将Raspberry Pi配置为Adguard的DNS服务器</h1><p id="6771" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在这个用例中，您将使用一个Raspberry PI作为DNS服务器，使用<a class="ae lj" href="https://hub.docker.com/r/adguard/adguardhome" rel="noopener ugc nofollow" target="_blank"> adguard </a>应用程序直接过滤来自DNS的任何广告。</p><p id="4c9d" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">首先，让我们观察Docker上的Adguard端口:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="366c" class="lz jo iq lv b gy ma mb l mc md">docker run --name adguardhome \<br/>    --restart unless-stopped \<br/>    -v /my/own/workdir:/opt/adguardhome/work \<br/>    -v /my/own/confdir:/opt/adguardhome/conf \<br/>    -p 53:53/tcp -p 53:53/udp \<br/>    -p 67:67/udp -p 68:68/udp \<br/>    -p 3000:3000/tcp \<br/>    -p 853:853/tcp \<br/>    -p 784:784/udp -p 853:853/udp -p 8853:8853/udp \<br/>    -p 5443:5443/tcp -p 5443:5443/udp \<br/>    -d adguard/adguardhome</span></pre><p id="d9af" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">要映射的端口有:</p><ul class=""><li id="03a5" class="me mf iq kn b ko lk ks ll kw mg la mh le mi li mj mk ml mm bi translated"><strong class="kn ir"> 53 tcp/udp </strong>:普通DNS。</li><li id="d072" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><strong class="kn ir"> 67/udp，68 tcp/udp </strong>:如果您打算将AdGuard Home用作DHCP服务器，请添加。</li><li id="62bd" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><strong class="kn ir"> 3000/tcp </strong>:如果您想使用AdGuard Home的管理面板，并且还想将AdGuard Home作为HTTPS/DNS-over-HTTPS服务器运行，请添加此选项。</li><li id="ff32" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><strong class="kn ir"> 853/tcp </strong>:如果您计划将AdGuard Home作为DNS-over-TLS服务器运行，请添加。</li><li id="d0fa" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><strong class="kn ir"> 784/udp、853 udp、8853/udp </strong>:如果要将AdGuard Home作为DNS-over-QUIC服务器运行，请添加。你只能留下一两个。</li><li id="74e2" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><strong class="kn ir"> 5443/tcp，5443/udp: </strong>如果要将AdGuard Home作为DNSCrypt服务器运行，请添加。</li></ul><p id="1d45" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在Pantavisor模式中，<a class="ae lj" href="https://gitlab.com/pantacor/pv-platforms/wifi-connect" rel="noopener ugc nofollow" target="_blank"> awconnect </a>容器为Raspberry PI上Pantavisor的默认映像执行所有网络管理。这让你可以通过wifi将树莓皮连接到互联网，或者通过wifi热点分享你的有线互联网。</p><p id="cf45" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">正是这个容器提供了DNS和DHCP。除此之外，您可能还有另一个使用端口3000的容器。</p><h1 id="34cd" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">开始之前</h1><p id="4ee1" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">为了解决这个问题，我们需要一个支持Pantavisor的Raspberry PI 3+或Raspberry PI 4。您还需要在开发计算机上安装以下软件:</p><ol class=""><li id="0a8f" class="me mf iq kn b ko lk ks ll kw mg la mh le mi li ms mk ml mm bi translated">fakeroot</li><li id="41a6" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li ms mk ml mm bi translated">squashfs</li><li id="e1dc" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li ms mk ml mm bi translated">码头工人</li><li id="485b" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li ms mk ml mm bi translated">pvr cli</li><li id="cdbd" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li ms mk ml mm bi translated">在hub.pantacor.com<a class="ae lj" href="https://hub.pantacor.com/" rel="noopener ugc nofollow" target="_blank">注册账户</a></li></ol><p id="180f" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">你可以从你的发行版或者你的OS软件包管理器安装<strong class="kn ir"> fakeroot </strong>和<strong class="kn ir">squashfs</strong>:apt，yum，apk，homebrew等等。</p><p id="4146" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">例如，基于Ubuntu/Debian的发行版会安装这些实用程序:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="8bf9" class="lz jo iq lv b gy ma mb l mc md">sudo apt install fakeroot squashfs-tools</span></pre><p id="d9b8" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">要为您的特定操作系统安装Docker，请参考Docker <a class="ae lj" href="https://docs.docker.com/engine/install/" rel="noopener ugc nofollow" target="_blank">安装文档</a></p><p id="b871" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">最后但同样重要的是，您还需要安装PVR cli来管理<a class="ae lj" href="https://hub.pantacor.com/" rel="noopener ugc nofollow" target="_blank">hub.pantacor.com</a>内的<a class="ae lj" href="https://www.pantavisor.io/" rel="noopener ugc nofollow" target="_blank"> pantavisor </a>设备。你可以在Pantacor <a class="ae lj" href="https://docs.pantahub.com/install-pvr/" rel="noopener ugc nofollow" target="_blank">文档</a>中找到更多关于如何安装PVR的信息。</p><p id="84ee" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">因为我们将从您的开发计算机远程向设备发送新的修订和配置，所以设备需要连接到<a class="ae lj" href="https://hub.pantacor.com/" rel="noopener ugc nofollow" target="_blank">hub.pantacor.com</a>云服务。您需要在那里创建一个帐户。</p><p id="7808" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">现在您已经安装了所有的东西，我们可以继续解决我们的网络隔离和端口转发问题。</p><h1 id="c8ae" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">#1安装Pantavisor并认领设备</h1><p id="46e7" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">声明过程可以使最终用户能够声明设备并证明其所有权。这种过程最初是通过声明消息触发的，这可以通过几种方式来完成。</p><p id="2cc5" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在您安装了Pantavisor映像之后，或者如果您已经安装了Pantavisor，您需要申请您的设备。有几种方法可以认领您的设备:</p><p id="9e4a" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><strong class="kn ir"> 1。-使用预先声明的图像</strong></p><p id="8230" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">认领该设备最简单的方法是下载一个映像，在第一次启动时自动认领。从<a class="ae lj" href="https://hub.pantacor.com/download-image" rel="noopener ugc nofollow" target="_blank">https://hub.pantacor.com/download-image</a>下载这张图片</p><p id="0330" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">2.- <strong class="kn ir">手动申报</strong></p><p id="3b2d" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">另一种申请方式是遵循pantavisor.io上的<a class="ae lj" href="https://www.pantavisor.io/guides/getting_started/" rel="noopener ugc nofollow" target="_blank">入门指南</a>，然后在您的开发计算机上使用PVR CLI手动申请该设备:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="c0a4" class="lz jo iq lv b gy ma mb l mc md">pvr device scan</span></pre><p id="ac4b" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">该命令的结果应该如下所示:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="791f" class="lz jo iq lv b gy ma mb l mc md">sergiomarin@penguin:~$ pvr device scan<br/>Scanning ...<br/>        ID: 61147e8af0e0f5000a50d11c (unclaimed)<br/>        Host: localhost.local.<br/>        IPv4: [192.168.68.115]<br/>        IPv6: [fe80::d4ac:9722:ab19:7b81]<br/>        Port: 22<br/>        Claim Cmd: pvr claim -c marginally-optimum-midge https://api.pantahub.com:443/devices/61147e8af0e0f5000a50d11c<br/>Pantavisor devices detected in network: 1 (see above for details)</span></pre><p id="d0e0" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">然后取要求的Cmd值并运行它。例如:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="3195" class="lz jo iq lv b gy ma mb l mc md">pvr claim -c marginally-optimum-midge <a class="ae lj" href="https://api.pantahub.com:443/devices/61147e8af0e0f5000a50d11c" rel="noopener ugc nofollow" target="_blank">https://api.pantahub.com:443/devices/61147e8af0e0f5000a50d11c</a></span></pre><p id="da01" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">完成此步骤后，您将能够在“设备”页面的hub.pantacor.com<a class="ae lj" href="https://hub.pantacor.com/" rel="noopener ugc nofollow" target="_blank">看到您申请的设备。</a></p><figure class="lq lr ls lt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi mt"><img src="../Images/1ce32b33714fa8e8f0674b12f316422a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HT4rvCHSBXNdEOwZ"/></div></div></figure><p id="c1bf" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">您将看到状态为<strong class="kn ir">同步的新设备。</strong>，这意味着您的设备已被认领，正在上传到云端。当这个过程<strong class="kn ir">完成后，</strong>您将能够克隆和修改设备。</p><figure class="lq lr ls lt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nb"><img src="../Images/e6b8a30da0eba262d2fb0eea6ebc4dd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VRFaxcaZkRL9HJpf"/></div></div></figure><h1 id="cc77" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">#2将设备URL克隆到您的计算机</h1><p id="23a3" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在设备详细信息面板中，您将看到<strong class="kn ir">克隆URL </strong>。复制URL并在您的开发笔记本电脑上运行以下命令:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="73ad" class="lz jo iq lv b gy ma mb l mc md">pvr clone CLONE_URL</span></pre><p id="7daa" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">示例:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="c86b" class="lz jo iq lv b gy ma mb l mc md">pvr clone <a class="ae lj" href="https://pvr.pantahub.com/highercomve/specially_brief_monkey" rel="noopener ugc nofollow" target="_blank">https://pvr.pantahub.com/highercomve/specially_brief_monkey</a></span></pre><p id="3f3f" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这就创建了一个名为`<strong class="kn ir">specially _ brief _ monkey`</strong>的新文件夹，很像“git clone”的工作方式。在该文件夹中，您应该会看到类似如下的结构:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="d434" class="lz jo iq lv b gy ma mb l mc md">specially_brief_monkey<br/>├── awconnect<br/>│   ├── lxc.container.conf<br/>│   ├── root.squashfs<br/>│   ├── root.squashfs.docker-digest<br/>│   ├── run.json<br/>│   └── src.json<br/>├── bsp<br/>│   ├── addon-plymouth.cpio.xz4<br/>│   ├── build.json<br/>│   ├── firmware.squashfs<br/>│   ├── kernel.img<br/>│   ├── modules.squashfs<br/>│   ├── pantavisor<br/>│   ├── run.json<br/>│   └── src.json<br/>├── _hostconfig<br/>│   └── pvr<br/>│       └── docker.json<br/>├── network-mapping.json<br/>├── pv-avahi<br/>│   ├── lxc.container.conf<br/>│   ├── root.squashfs<br/>│   ├── root.squashfs.docker-digest<br/>│   ├── run.json<br/>│   └── src.json<br/>├── pvr-sdk<br/>│   ├── lxc.container.conf<br/>│   ├── root.squashfs<br/>│   ├── root.squashfs.docker-digest<br/>│   ├── run.json<br/>│   └── src.json<br/>└── storage-mapping.json</span></pre><p id="2f08" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这是Pantavisor定义设备及其运行容器的方式:</p><ul class=""><li id="176c" class="me mf iq kn b ko lk ks ll kw mg la mh le mi li mj mk ml mm bi translated"><strong class="kn ir"> BSP </strong>:在嵌入式系统中，板支持包(BSP)是一层软件，包含特定于硬件的驱动程序和其他例程，允许特定的操作系统在特定的硬件环境中运行。</li><li id="7220" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><strong class="kn ir"> awconnect </strong>:设备的Pantavisor基础平台，网络配置在此<a class="ae lj" href="https://gitlab.com/pantacor/pv-platforms/wifi-connect" rel="noopener ugc nofollow" target="_blank">容器</a>中。</li><li id="a0ed" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated">pv-avahi :一个容器，它发送使用pvr设备扫描发现网络中的设备所需的所有信息，并为此使用avahi协议。你可以在这里看到源容器:<a class="ae lj" href="https://gitlab.com/pantacor/pv-platforms/pv-avahi" rel="noopener ugc nofollow" target="_blank">https://gitlab.com/pantacor/pv-platforms/pv-avahi</a></li><li id="07dc" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><strong class="kn ir"> pv-sdk </strong>:带有Pantavisor SDK的容器，允许您直接从设备维护设备，并负责管理设备和设备内部容器的ssh连接。</li></ul><p id="cfeb" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这些容器中的每一个都有一个<strong class="kn ir"> src.json </strong>文件，该文件描述了创建容器的源以及运行容器的一些Pantavisor特定的配置。</p><h1 id="cace" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">#3为我们的设备添加adguard</h1><p id="3a0c" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我们将使用<a class="ae lj" href="https://hub.docker.com/r/adguard/adguardhome" rel="noopener ugc nofollow" target="_blank"> adguard docker容器</a>作为Pantavisor容器(基本上是一个LXC容器)的源。为了在由<strong class="kn ir"> pvr克隆</strong>进程创建的文件夹中添加一个来自Docker的新容器，我们将运行以下命令:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="b050" class="lz jo iq lv b gy ma mb l mc md">pvr app add --from=adguard/adguardhome:latest adguard</span></pre><p id="32a7" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这将在设备定义中创建一个名为adguard的新文件夹，其结构如下:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="093a" class="lz jo iq lv b gy ma mb l mc md">adguard/<br/>├── lxc.container.conf<br/>├── root.squashfs<br/>├── root.squashfs.docker-digest<br/>├── run.json<br/>└── src.json</span></pre><p id="3b5b" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">src.json应该是这样的:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="2166" class="lz jo iq lv b gy ma mb l mc md">{<br/>  "#spec": "service-manifest-src@1",<br/>  "template": "builtin-lxc-docker",<br/>  "args": {<br/>   "PV_RUNLEVEL": "app"<br/>  },<br/>  "config": {},<br/>  "docker_name": "adguard/adguardhome",<br/>  "docker_tag": "latest",<br/>  "docker_digest": "adguard/adguardhome@sha256:cd5e6641e969ec8a1df1ed02dc969db49d6cf540055f14346d0d5d42951f75d6",<br/>  "docker_source": "remote,local",<br/>  "docker_platform": "linux/arm",<br/>  "persistence": {}<br/>}</span></pre><h1 id="3887" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">#4配置LXC功能和Adguard持久性的参数</h1><p id="14de" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">现在，我们将只讨论这个文件的两个部分:<strong class="kn ir"> args </strong>和<strong class="kn ir"> persistence。</strong></p><ul class=""><li id="aa4a" class="me mf iq kn b ko lk ks ll kw mg la mh le mi li mj mk ml mm bi translated"><strong class="kn ir">参数:</strong>这是pvr cli工具的配置，它为LXC容器设置了一些功能。</li><li id="0a2d" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><strong class="kn ir">持久化</strong>:卷的配置和运行容器的持久化。默认情况下，pvr会自动添加Dockerfile文件中定义的所有卷。您可以在这里添加更多的卷，即使它们没有在docker文件中定义。</li></ul><p id="b8ba" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">如前所述，pvr默认将所有容器添加到主机网络名称空间中。因此，我们需要做的第一个配置是在LXC网桥网络内隔离这个容器。</p><p id="4f31" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">为此，我们需要在args配置中添加几个新参数:</p><ul class=""><li id="6554" class="me mf iq kn b ko lk ks ll kw mg la mh le mi li mj mk ml mm bi translated"><strong class="kn ir">PV _ LXC _网络_类型</strong>:此参数配置<strong class="kn ir"> lxc.net.[0]。键入</strong>和LXC配置中的其他参数，具体取决于我们在那里分配的值。</li><li id="1948" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><strong class="kn ir">PV _ LXC _网络_ IPV4 _地址</strong>:这将是分配给虚拟网络接口的IP地址。</li></ul><p id="e833" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">产生的<strong class="kn ir">参数</strong>如下所示:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="6216" class="lz jo iq lv b gy ma mb l mc md">"args": {<br/>    "PV_LXC_NETWORK_IPV4_ADDRESS": "10.0.3.20/24",<br/>    "PV_LXC_NETWORK_TYPE": "veth",<br/>    "PV_RUNLEVEL": "app"<br/>}</span></pre><p id="18aa" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">如果你想知道更多关于什么参数可以被使用，你可以阅读我们的<a class="ae lj" href="https://gitlab.com/pantacor/pvr/-/blob/develop/templates/builtin-lxc-docker.go" rel="noopener ugc nofollow" target="_blank">模板的源代码来构建lxc配置</a>。</p><p id="644c" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">为了持久化，我们需要添加<strong class="kn ir"> /opt/adguardhome/work </strong>和<strong class="kn ir"> /opt/adguardhome/conf </strong>文件夹。adguard使用这两者来保存服务的配置。</p><p id="a2f3" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">最终的持久性配置将是:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="0a84" class="lz jo iq lv b gy ma mb l mc md">"persistence": {<br/>    "/opt/adguardhome/conf/": "permanent",<br/>    "/opt/adguardhome/work/": "permanent"<br/>}</span></pre><h1 id="a65d" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">#5安装Adguard应用程序</h1><p id="d2f5" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">设置好持久性并启用LXC功能后，您就可以使用<strong class="kn ir"> pvr安装Adguard应用程序了。</strong></p><p id="ece1" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">首先，检查最终的src.json看起来像这样:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="9287" class="lz jo iq lv b gy ma mb l mc md">{<br/>  "#spec": "service-manifest-src@1",<br/>  "args": {<br/>    "PV_LXC_NETWORK_IPV4_ADDRESS": "10.0.3.20/24",<br/>    "PV_LXC_NETWORK_TYPE": "veth",<br/>    "PV_RUNLEVEL": "app"<br/>  },<br/>  "config": {},<br/>  "docker_digest": "adguard/adguardhome@sha256:cd5e6641e969ec8a1df1ed02dc969db49d6cf540055f14346d0d5d42951f75d6",<br/>  "docker_name": "adguard/adguardhome",<br/>  "docker_platform": "linux/arm",<br/>  "docker_source": "remote,local",<br/>  "docker_tag": "latest",<br/>  "persistence": {<br/>    "/opt/adguardhome/conf/": "permanent",<br/>    "/opt/adguardhome/work/": "permanent"<br/>  },<br/>  "template": "builtin-lxc-docker"<br/>}</span></pre><p id="fa20" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">如果您的“src.json”看起来不错，让我们使用以下命令继续安装:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="db71" class="lz jo iq lv b gy ma mb l mc md">pvr app install adguard</span></pre><p id="31da" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">要查看Adguard是如何安装和隔离的，请将更改推送到设备:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="4222" class="lz jo iq lv b gy ma mb l mc md">pvr add &amp;&amp; pvr commit &amp;&amp; pvr post -m "Install adguard into the device"</span></pre><p id="d281" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在此之后，您将能够在<a class="ae lj" href="https://hub.pantacor.com/" rel="noopener ugc nofollow" target="_blank">hub.pantacor.com</a>看到设备的新版本，与此类似:</p><figure class="lq lr ls lt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nc"><img src="../Images/023c92817944332e30106f7e7ba28c21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*y5ddVcio0gJZF657"/></div></div></figure><p id="44bc" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">当设备状态为<strong class="kn ir">完成</strong>或<strong class="kn ir">更新</strong>时，流程结束。该设备现在应该运行Adguard，但由于它是隔离的，您将无法使用web UI，甚至无法将其用作DNS。</p><h1 id="4a62" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">#6用wall映射Adguard端口</h1><p id="5c96" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kn ir"> awconnect </strong>平台使用iptables来管理防火墙并管理路由，而<strong class="kn ir"> awall </strong>是一个基于JSON配置生成iptables和路由的实用程序。</p><p id="c45c" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这是一个关于防火墙如何工作的很好的指南。我不会进入墙的最深处，相反，我将展示如何在这个用例中使用它。</p><h1 id="a6c5" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">为Pantavisor配置墙</h1><p id="2db8" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">首先，让我们开始添加这个小的实用程序脚本来运行wall，而不是安装在您的计算机上，而是从Docker容器中运行它。你可以在这里看到并下载脚本<a class="ae lj" href="https://gist.githubusercontent.com/highercomve/295cf75fb660be4c6b054627c330cb4b/raw/d51989dd5c57c36136814033af6d460db3024bef/awall2pvmwall" rel="noopener ugc nofollow" target="_blank">。</a></p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="bf9d" class="lz jo iq lv b gy ma mb l mc md">wget https://gist.githubusercontent.com/highercomve/295cf75fb660be4c6b054627c330cb4b/raw/d51989dd5c57c36136814033af6d460db3024bef/awall2pvmwall &amp;amp;&amp;amp; chmod +x awall2pvmwall</span></pre><p id="ac2c" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">该脚本针对设备文件夹的根目录中的“awall.json”文件以及设备的任何应用程序或平台内的任何“awall configuration”文件夹运行。</p><p id="6ca6" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">我们将创建几个JSON文件来配置防火墙。Port_forward_example是我的设备存储库所在的文件夹名称，也是我们将添加所有新文件进行配置的位置。</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="7283" class="lz jo iq lv b gy ma mb l mc md">mkdir -p adguard/_awall<br/>touch awall.json<br/>touch adguard/_awall/config.json<br/>touch bsp/_awall.json</span></pre><p id="1ea4" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">配置文件bsp/_awall.json为我们的设备定义了几个变量。</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="df04" class="lz jo iq lv b gy ma mb l mc md">{<br/>   "variable": {<br/>   	"containernet_if": "lxcbr0",<br/>   	"wan_if": "eth0",<br/>   	"lan_if": "wlan0"<br/>   }<br/>}</span></pre><p id="2edf" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这些是Pantavisor为Raspberry PI 4设置的默认值。如果你的Raspberry Pi通过以太网电缆连接到互联网，那么<strong class="kn ir"> wan_if </strong>将会是<strong class="kn ir"> eth0 </strong>并且也许你的wifi将会是局域网。在某些情况下，您可能通过wifi连接到互联网提供商，并将eth0用作本地网络的入口点。</p><p id="66d7" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><strong class="kn ir"> awall.json </strong>配置文件定义了设备的通用防火墙规则。我们将在该文件中添加与主机网络命名空间直接相关的所有内容。</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="eaa6" class="lz jo iq lv b gy ma mb l mc md">{<br/>   "description": "How to use awall",<br/>   "filter": [<br/>       {<br/>           "action": "accept",<br/>           "in": "internet",<br/>           "service": [<br/>               "ping",<br/>               "dns",<br/>               "ssh",<br/>               "dhcp",<br/>               "pvssh"<br/>           ]<br/>       },<br/>       {<br/>           "action": "accept",<br/>           "in": "intranet",<br/>           "service": [<br/>               "dns",<br/>               "ping",<br/>               "ssh",<br/>               "dhcp",<br/>               "pvssh"<br/>           ]<br/>       },<br/>       {<br/>           "action": "accept",<br/>           "in": "internet",<br/>           "out": "_fw",<br/>           "service": [<br/>               "ssh",<br/>               "dhcp",<br/>               "pvssh"<br/>           ]<br/>       },<br/>       {<br/>           "action": "accept",<br/>           "out": "internet",<br/>           "service": [<br/>               "http",<br/>               "https"<br/>           ]<br/>       }<br/>   ],<br/>   "import": [<br/>       "bsp"<br/>   ],<br/>   "policy": [<br/>       {<br/>           "action": "accept",<br/>           "out": "internet"<br/>       },<br/>       {<br/>           "action": "drop",<br/>           "in": "internet"<br/>       },<br/>       {<br/>           "action": "accept",<br/>           "out": "intranet"<br/>       },<br/>       {<br/>           "action": "drop",<br/>           "in": "intranet"<br/>       },<br/>       {<br/>           "action": "accept",<br/>           "in": "containernet"<br/>       },<br/>       {<br/>           "action": "accept",<br/>           "out": "containernet"<br/>       },<br/>       {<br/>           "action": "reject"<br/>       }<br/>   ],<br/>   "service": {<br/>       "pvssh": [<br/>           {<br/>               "port": 8222,<br/>               "proto": "tcp"<br/>           }<br/>       ]<br/>   },<br/>   "snat": [<br/>       {<br/>           "out": "internet"<br/>       }<br/>   ],<br/>   "zone": {<br/>       "containernet": {<br/>           "iface": "$containernet_if"<br/>       },<br/>       "internet": {<br/>           "iface": "$wan_if"<br/>       },<br/>       "intranet": {<br/>           "iface": "$lan_if"<br/>       }<br/>   }<br/>}</span></pre><p id="dbd7" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">通过这种配置，我们可以访问设备的某些端口:</p><ul class=""><li id="2cba" class="me mf iq kn b ko lk ks ll kw mg la mh le mi li mj mk ml mm bi translated"><strong class="kn ir"> ssh </strong>:访问<strong class="kn ir"> pvr-sdk </strong>容器的端口22</li><li id="6be7" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><strong class="kn ir"> pvssh </strong>:端口8222直接进入一个容器</li><li id="80c9" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><strong class="kn ir"> dns </strong>:端口53</li><li id="7ca5" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><strong class="kn ir"> ping: </strong> icmp端口</li><li id="d5b4" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><strong class="kn ir"> dhcp: </strong>端口67和68</li></ul><h1 id="f2c1" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">#7使用DNAT将流量重定向到Adguard IP</h1><p id="403b" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">现在，让我们使用DNAT配置将所有内容重定向到Adguard IP地址。我们需要用这个配置填充`<strong class="kn ir">aguard/_ a wall/config . JSON `</strong>文件。</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="ef86" class="lz jo iq lv b gy ma mb l mc md">{<br/>   "description": "Forward All need it ports to this container",<br/>   "filter": [<br/>       {<br/>           "action": "accept",<br/>           "dnat": "10.0.3.20",<br/>           "in": "internet",<br/>           "service": "adguard-web"<br/>       },<br/>       {<br/>           "action": "accept",<br/>           "dnat": "10.0.3.20",<br/>           "in": "intranet",<br/>           "service": "adguard-web"<br/>       },<br/>       {<br/>           "action": "accept",<br/>           "dnat": "10.0.3.20",<br/>           "in": "internet",<br/>           "service": "adguard-dotls"<br/>       },<br/>       {<br/>           "action": "accept",<br/>           "dnat": "10.0.3.20",<br/>           "in": "intranet",<br/>           "service": "adguard-dotls"<br/>       },<br/>       {<br/>           "action": "accept",<br/>           "dnat": "10.0.3.20",<br/>           "in": "internet",<br/>           "service": "adguard-dnsencrypt"<br/>       },<br/>       {<br/>           "action": "accept",<br/>           "dnat": "10.0.3.20",<br/>           "in": "intranet",<br/>           "service": "adguard-dnsencrypt"<br/>       }<br/>   ],<br/>   "service": {<br/>       "adguard-web": [<br/>           {<br/>               "port": 3000,<br/>               "proto": "tcp"<br/>           },<br/>           {<br/>               "port": 3000,<br/>               "proto": "udp"<br/>           }<br/>       ],<br/>       "adguard-dotls": [<br/>           {<br/>               "port": 53,<br/>               "proto": "tcp"<br/>           },<br/>           {<br/>               "port": 53,<br/>               "proto": "udp"<br/>           },<br/>           {<br/>               "port": 853,<br/>               "proto": "tcp"<br/>           },<br/>           {<br/>               "port": 853,<br/>               "proto": "udp"<br/>           },<br/>           {<br/>               "port": 784,<br/>               "proto": "udp"<br/>           },<br/>           {<br/>               "port": 8853,<br/>               "proto": "udp"<br/>           },<br/>           {<br/>               "port": 5443,<br/>               "proto": "tcp"<br/>           },<br/>           {<br/>               "port": 8853,<br/>               "proto": "udp"<br/>           }<br/>       ],<br/>       "adguard-dnsencrypt": [<br/>           {<br/>               "port": 5443,<br/>               "proto": "tcp"<br/>           },<br/>           {<br/>               "port": 8853,<br/>               "proto": "udp"<br/>           }<br/>       ]<br/>   }<br/>}</span></pre><p id="deae" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在那里，您可以看到按服务分组的端口。所有这些服务都将从WAN和LAN接口转换到容器IP。</p><h1 id="04b9" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">#8设置端口转发并查看Adguard仪表板</h1><p id="890e" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">现在我们已经准备好了所有的JSON配置，我们可以运行<strong class="kn ir"> awall2pvmwall </strong>脚本来创建一个具有如下结构的文件夹:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="e27a" class="lz jo iq lv b gy ma mb l mc md">_config/<br/>└── awconnect<br/>	└── etc<br/>    	└── iptables<br/>        	├── dump<br/>        	├── rules.v4<br/>        	└── rules.v6</span></pre><p id="9459" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">现在，我们可以将这个新版本发布到我们的设备上:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="99bf" class="lz jo iq lv b gy ma mb l mc md">pvr add .<br/>pvr commit<br/>pvr post -m "Update awconnect with port forwading to adguard"</span></pre><figure class="lq lr ls lt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nd"><img src="../Images/5d2380c251b4ccafd2130db6b9207748.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TIQzIG8RcHg5NbJn"/></div></div></figure><figure class="lq lr ls lt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nd"><img src="../Images/6b106b4f75a9addbf9e5490c3e2a0dc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ksoKJC85K_TiUlaD"/></div></div></figure><p id="3027" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><strong class="kn ir">注意:在这里，从端口80移动到3000 </strong>很重要</p><figure class="lq lr ls lt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nd"><img src="../Images/4572d970777df8a2cc1659491aceb46f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eRc17ktGqfwrLhts"/></div></div></figure><p id="f270" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在几个next和next之后，您将能够进入adguard仪表板，使用您的Raspberry PI作为整个网络的DNS，并且还将通过DoT使用上游DNS来阻止广告，等等..</p><figure class="lq lr ls lt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi ne"><img src="../Images/159591e898654ec49e0e785fdeea8f85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vbv3vTQ7QQeuVpwq"/></div></div></figure><p id="b001" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这里有一个已知DNS提供商的列表供选择。</p><p id="2897" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">你可以在<a class="ae lj" href="https://hub.pantacor.com/u/highercomve/devices/61147e8af0e0f5000a50d11c" rel="noopener ugc nofollow" target="_blank">这里</a>看到我为这个指南制作的设备，或者你也可以用:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="d507" class="lz jo iq lv b gy ma mb l mc md">pvr clone <a class="ae lj" href="https://pvr.pantahub.com/highercomve/port_fordward_example" rel="noopener ugc nofollow" target="_blank">https://pvr.pantahub.com/highercomve/port_fordward_example</a></span></pre><p id="f738" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">现在去玩Pantavisor和容器吧，愿原力与你同在。</p></div></div>    
</body>
</html>