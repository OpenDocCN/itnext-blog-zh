<html>
<head>
<title>Using State Machines in Laravel</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Laravel中使用状态机</h1>
<blockquote>原文：<a href="https://itnext.io/using-state-machines-in-laravel-bbc07384c232?source=collection_archive---------4-----------------------#2019-05-20">https://itnext.io/using-state-machines-in-laravel-bbc07384c232?source=collection_archive---------4-----------------------#2019-05-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="3d90" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">“国家机器”</p><p id="fb29" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这会让你的身体对高级计算机科学理论感到恐惧吗？又是那种“总有一天我会深究一下”的感觉？</p><p id="7e63" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不要害怕！我将向您介绍一个非常简单但实用的用例，它会让您想知道没有它们您是如何度过的。</p><p id="b9c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们先简单描述一下这是怎么回事。您是否曾经遇到过这样的问题单，即“该订单的状态为‘已取消’，但后来不知何故又变成了‘待处理’。请调查一下。”？</p><p id="284c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是状态机的设计目的。它们是<strong class="jp ir">你内部状态变化的验证规则。</strong>这就是你现在需要理解的全部内容！</p><p id="a483" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们所做的是，通过使用代码库，定义流程中所有有效的状态变化。然后，每当您想要更新该实体的状态时，首先通过您的规则集运行它，以检查它是否正常。通过这种方式，随着越来越多的业务逻辑被添加，您总是有一个潜在的安全检查，即您的业务工作流被遵循。</p><p id="5b2f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里有一个非常简单的例子，您可以在默认的Laravel安装上试用，而无需太多代码。我们有一个例子，我们的<code class="fe kl km kn ko b">Users</code>是军人，每个人都有一个军衔。以下是业务规则:</p><ol class=""><li id="590f" class="kp kq iq jp b jq jr ju jv jy kr kc ks kg kt kk ku kv kw kx bi translated">总军衔名单是:列兵、下士A级、下士B级、下士C级、中士A级、中士B级</li><li id="d9eb" class="kp kq iq jp b jq ky ju kz jy la kc lb kg lc kk ku kv kw kx bi translated">规则是:</li></ol><p id="b6a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">A)二等兵可以成为三个职业中任何一个的下士。</p><p id="6223" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">b) A级下士或B级下士只能成为A级中士；同样，下士B级或下士C级只能成为中士B级(因此下士B级可以成为任何一种类型的中士)。</p><p id="a400" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">c)没有降级。</p><p id="c55e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要设置这个，添加一个字符串字段“rank”到你的标准安装<code class="fe kl km kn ko b">Users</code>表，然后composer安装<a class="ae ld" href="https://github.com/sebdesign/laravel-state-machine" rel="noopener ugc nofollow" target="_blank">https://github.com/sebdesign/laravel-state-machine</a></p><p id="ea6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们刚刚安装的实际上只是一个真正逻辑上的Laravel的服务提供者，在<a class="ae ld" href="https://github.com/winzou/state-machine" rel="noopener ugc nofollow" target="_blank">https://github.com/winzou/state-machine</a>库中找到，但是我们现在不需要担心这个。如果您确实想在没有Laravel的情况下使用状态机，那么直接使用git repo。</p><p id="23eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步是发布:` PHP artisan vendor:publish—provider = " SEB design \ SM \ service provider " `。这将在<code class="fe kl km kn ko b">config/state-machine.php</code>创建一个配置文件，我们将在这里设置“验证规则”。</p><pre class="le lf lg lh gt li ko lj lk aw ll bi"><span id="5bb9" class="lm ln iq ko b gy lo lp l lq lr">return [<br/>    'rank_graph' =&gt; [<br/>        'class' =&gt; App\User::class,<br/><br/>        'property_path' =&gt; 'rank',<br/><br/>        'states' =&gt; [<br/>            'Private',<br/>            'Corporal A Class',<br/>            'Corporal B Class',<br/>            'Corporal C Class',<br/>            'Sergeant A Class',<br/>            'Sergeant B Class',<br/>        ],<br/><br/>        'transitions' =&gt; [<br/>            'promote_private_to_corporal_a_class' =&gt; [<br/>                'from' =&gt; ['Private'],<br/>                'to' =&gt; 'Corporal A Class',<br/>            ],<br/>            'promote_private_to_corporal_b_class' =&gt; [<br/>                'from' =&gt; ['Private'],<br/>                'to' =&gt; 'Corporal B Class',<br/>            ],<br/>            'promote_private_to_corporal_c_class' =&gt; [<br/>                'from' =&gt; ['Private'],<br/>                'to' =&gt; 'Corporal C Class',<br/>            ],<br/>            'promote_corporal_a_class_sergeant_a_class' =&gt; [<br/>                'from' =&gt; ['Corporal A Class'],<br/>                'to' =&gt; 'Sergeant A Class',<br/>            ],<br/>            'promote_corporal_b_class_to_sergeant_a_class' =&gt; [<br/>                'from' =&gt; ['Corporal B Class'],<br/>                'to' =&gt; 'Sergeant A Class',<br/>            ],<br/>            'promote_corporal_b_class_to_sergeant_b_class' =&gt; [<br/>                'from' =&gt; ['Corporal B Class'],<br/>                'to' =&gt; 'Sergeant B Class',<br/>            ],<br/>            'promote_corporal_c_class_sergeant_b_class' =&gt; [<br/>                'from' =&gt; ['Corporal C Class'],<br/>                'to' =&gt; 'Sergeant B Class',<br/>            ],<br/>        ],<br/>    ],<br/>];</span></pre><p id="ba1e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们来分析一下。对于状态机，单个规则集被称为“图”。我们的图叫做‘秩图’;对我们来说，它是数组中的键值，仅此而已。我们可能有其他集合来描述系统的其他部分，它们可以添加到下面的同一个配置数组中。</p><p id="8716" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">“类”是我们正在检查的模型；“property_path”我们保存各种等级、状态的字段，无论你想怎么称呼它们。顺便说一句，这些不一定是雄辩的模型。“States”是所有可能等级的完整列表——从某种意义上说，它只是一个枚举。</p><p id="972f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">“过渡”是奇迹发生的地方。我们设置了所有<em class="ls">允许的</em>等级变化——“过渡路径”。每个验证规则都是一个嵌套的数组，它具有1)一个标签(通常是对所检查的更改的清晰描述)和2)一个“从/到”关系，该关系将允许哪些“从”状态更改为哪些“到”状态。例如，三个“promote _ private _ to _下士_*_class”转换表明，如果用户当前是“private ”,他们可以被更改为三个下士军衔中的任何一个。然而，他们<strong class="jp ir">不能</strong>成为中士，因此这两个军衔不包括在“to”数组中。</p><p id="2493" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">既然我们已经建立了验证规则，我们需要确保我们的更新通过它们。有许多不同的方法来设置它(我将在最后提到一些其他的方法)，但是一个非常简单的方法是在你的模型中添加一个函数。有三种不同的语法可用于此目的:</p><pre class="le lf lg lh gt li ko lj lk aw ll bi"><span id="14f3" class="lm ln iq ko b gy lo lp l lq lr">// Style 1: <strong class="ko ir">Get the factory from the interface</strong></span><span id="45b4" class="lm ln iq ko b gy lt lp l lq lr">use SM\Factory\FactoryInterface;<br/>public function stateMachine()<br/>{<br/>    $factory = app(CallbackFactoryInterface::class);<br/>    return $factory-&gt;get($this, 'rank_graph');<br/>}</span><span id="36dc" class="lm ln iq ko b gy lt lp l lq lr">// Style 2: <strong class="ko ir">Or get the factory from the alias</strong></span><span id="1081" class="lm ln iq ko b gy lt lp l lq lr">use SM\Factory\FactoryInterface;<br/>public function stateMachine()<br/>{<br/>    $factory = app('sm.factory');<br/>    return $factory-&gt;get($this, 'rank_graph');<br/>}</span><span id="e180" class="lm ln iq ko b gy lt lp l lq lr">// Style 3: <strong class="ko ir">Or get the state machine directly from the facade</strong></span><span id="ffa6" class="lm ln iq ko b gy lt lp l lq lr">use Sebdesign\SM\Facade as StateMachine;<br/>public function stateMachine()<br/>{<br/>    return StateMachine::get($this, 'rank_graph');<br/>}</span></pre><p id="6a0b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这与我们在上面的配置中设置的名称是同一个数组键。这样，我们可以从用户实例调用状态机，并检查和更新逻辑:</p><pre class="le lf lg lh gt li ko lj lk aw ll bi"><span id="80d2" class="lm ln iq ko b gy lo lp l lq lr">$user-&gt;update($input);<br/>$user-&gt;stateMachine()-&gt;apply('promote_private_to_corporal_a_class');<br/>$user-&gt;save();</span></pre><p id="e9ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kl km kn ko b">update()</code>和<code class="fe kl km kn ko b">save()</code>是标准的Laravel，用于任何其他可能更新的字段。中间一行是检查state-machine.php配置的地方，以查看是否允许这种特定的更改。在内部，它将检查当前的等级，查看我们试图更新到的等级，然后要么允许它通过，要么抛出一个SMException错误。</p><p id="5f37" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样，真的！你能做的还有很多，但这将保证你的安全。接下来要做的是为您的各种状态设置一系列单元测试，例如:</p><pre class="le lf lg lh gt li ko lj lk aw ll bi"><span id="5e8e" class="lm ln iq ko b gy lo lp l lq lr">/** @test */<br/>public function it_can_promote_private_to_corporal_b_class()<br/>{<br/>    $user = factory(User::class)-&gt;create(['rank' =&gt; 'Private']);<br/><br/>    $user-&gt;update(['rank' =&gt; 'Corporal B Class']);<br/>    $user-&gt;stateMachine()-&gt;apply('promote_private_to_corporal_b_class');<br/>    $user-&gt;save();<br/><br/>    $updated_user = User::find($user-&gt;id);<br/>    $this-&gt;assertEquals('Corporal B Class', $updated_user-&gt;rank);<br/>}</span></pre><p id="8cf3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就像我们在配置文件中所做的转换一样，这些转换彼此非常相似，不需要花费太多精力来设置。他们将帮助我们确保，如果我们确实需要改变我们的状态机逻辑，一切都继续工作。</p><p id="10d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">更多阅读和高级用法:</strong></p><p id="dcc8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的例子非常简单，但是在我们的一些站点上已经有了实际的产品(当然，有了实际的项目领域逻辑)。然而，一旦你设置了这个实验，你可能会发现你想更好地利用这个库。如果是这样，这里有一些更复杂的用例，您可以继续研究:</p><p id="aec6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae ld" href="https://github.com/sebdesign/laravel-state-machine" rel="noopener ugc nofollow" target="_blank">https://github.com/sebdesign/laravel-state-machine</a>我们用来和拉勒维尔合作的图书馆。您可以看到合并Laravel Gates和策略以及添加回调的更多示例。</p><p id="b36d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae ld" href="https://gist.github.com/iben12/7e24b695421d92cbe1fec3eb5f32fc94" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/iben 12/7 e 24 b 695421d 92 CBE 1 FEC 3 EB 5 f 32 fc 94</a>Bence Ivady<a class="lu lv ep" href="https://medium.com/u/9382cd37c64c?source=post_page-----bbc07384c232--------------------------------" rel="noopener" target="_blank">的完整构建示例</a>。他还创造了一个特征来代替我上面展示的<code class="fe kl km kn ko b">stateMachine</code>函数。</p><p id="b4ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae ld" href="https://github.com/winzou/state-machine" rel="noopener ugc nofollow" target="_blank">https://github.com/winzou/state-machine</a>底层状态机库由<a class="ae ld" href="https://twitter.com/a_bacco" rel="noopener ugc nofollow" target="_blank">https://twitter.com/a_bacco</a>这是框架不可知的；继续在一个简单的php文件中使用它！</p><p id="342a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae ld" href="https://en.wikipedia.org/wiki/Finite-state_machine" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/Finite-state_machine</a>为了你们当中更勤奋好学的人；这是学习一般状态机的起点。</p><p id="3681" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">希望有所帮助！</p></div></div>    
</body>
</html>