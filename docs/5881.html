<html>
<head>
<title>How to Scale an ASP.NET Core Microservice and Sharded Database. Load Test with JMeter</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何扩展ASP.NET核心微服务和分片数据库。用JMeter进行负载测试</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-scale-an-asp-net-core-microservice-and-sharded-database-load-test-with-jmeter-1a8c7292e7e3?source=collection_archive---------1-----------------------#2021-06-20">https://itnext.io/how-to-scale-an-asp-net-core-microservice-and-sharded-database-load-test-with-jmeter-1a8c7292e7e3?source=collection_archive---------1-----------------------#2021-06-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7493" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用Docker Compose在HAProxy负载平衡器后运行多个DBMS和C#容器。使用不同数量的实例测试缩放</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/915ebbde83a7e5623f00e27dc2f37ebd.png" data-original-src="https://miro.medium.com/v2/resize:fit:656/format:webp/1*zZry4z9DbP2JxzDun3gNIw.png"/></div></figure><p id="9ddc" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在<a class="ae lj" rel="noopener ugc nofollow" target="_blank" href="/how-to-use-database-sharding-and-scale-an-asp-net-core-microservice-architecture-22c24916590f"> <strong class="kp ir">上一篇文章</strong> </a>中，你创建了一个<strong class="kp ir">微服务架构</strong>并手动实现了<strong class="kp ir">应用层数据库分片</strong>。</p><p id="8f0d" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">现在</strong>，您将<strong class="kp ir">扩展应用</strong>并<strong class="kp ir">运行微服务和数据库的多个容器实例</strong>。您将使用<strong class="kp ir"> Docker Compose </strong>和<strong class="kp ir"> HAProxy负载平衡器</strong>:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lk"><img src="../Images/28644c646c0d3578ec58f95fb9706e21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qfNgu11fAZHUkZeohvUzzA.png"/></div></div></figure><p id="eef1" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">然后运行<strong class="kp ir"> JMeter负载测试</strong>到<strong class="kp ir">，看看当使用<strong class="kp ir">不同数量的实例</strong>时，应用程序如何伸缩</strong>。最后，您还将<strong class="kp ir">发布和接收来自RabbitMQ </strong>的消息。</p><h1 id="8ce3" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">1.运行多个数据库和微服务实例</h1><h2 id="6eac" class="mh lq iq bd lr mi mj dn lv mk ml dp lz kw mm mn mb la mo mp md le mq mr mf ms bi translated"><strong class="ak">记录微服务</strong></h2><p id="d41f" class="pw-post-body-paragraph kn ko iq kp b kq mt jr ks kt mu ju kv kw mv ky kz la mw lc ld le mx lg lh li ij bi translated"><strong class="kp ir">使用上一篇文章</strong>  <strong class="kp ir">中的</strong> <a class="ae lj" rel="noopener ugc nofollow" target="_blank" href="/how-to-use-database-sharding-and-scale-an-asp-net-core-microservice-architecture-22c24916590f"> <strong class="kp ir">代码和环境作为基础</strong>。</a></p><p id="2264" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">将Visual Studio项目资源管理器中的文件“docker file”</strong>重命名为“<em class="my"> dockerfile </em>”(第一个字符小写)。然后右键单击Docker文件，选择<strong class="kp ir"> <em class="my">创建Docker图像</em> </strong>。这也会将图像推送到docker。</p><h2 id="8e54" class="mh lq iq bd lr mi mj dn lv mk ml dp lz kw mm mn mb la mo mp md le mq mr mf ms bi translated">在Docker中运行应用程序</h2><p id="abcd" class="pw-post-body-paragraph kn ko iq kp b kq mt jr ks kt mu ju kv kw mv ky kz la mw lc ld le mx lg lh li ij bi translated">创建文件<em class="my"> docker-compose.yml </em>:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="37e6" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">docker文件配置了3个数据库容器和4个<em class="my"> Post </em>服务实例。目前，<em class="my"> Post </em>服务实例只使用两个数据库。您可以稍后删除该注释以使用第三个数据库。一个HAProxy负载均衡器在端口5001上公开了<em class="my"> Post </em>服务容器。</p><p id="8b9d" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">每个容器有一个0.5 CPU的限制，以帮助在本地机器上进行实际的负载测试。在我的12核笔记本电脑上，仍然有未使用的资源，因此添加更多的服务和数据库实例可以带来好处。</p><h2 id="851c" class="mh lq iq bd lr mi mj dn lv mk ml dp lz kw mm mn mb la mo mp md le mq mr mf ms bi translated"><strong class="ak">启动应用</strong></h2><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="1f31" class="mh lq iq nc b gy ng nh l ni nj">C:\dev&gt;docker-compose up -d</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/2de2a4e93536da653c0d281e13e8b559.png" data-original-src="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*AQEIZE2W6w_mMOoZVMumtA.png"/></div></figure><h2 id="c3b1" class="mh lq iq bd lr mi mj dn lv mk ml dp lz kw mm mn mb la mo mp md le mq mr mf ms bi translated"><strong class="ak">初始化数据库</strong></h2><p id="1086" class="pw-post-body-paragraph kn ko iq kp b kq mt jr ks kt mu ju kv kw mv ky kz la mw lc ld le mx lg lh li ij bi translated">在<a class="ae lj" href="http://localhost:5001/swagger/index.html" rel="noopener ugc nofollow" target="_blank">打开浏览器http://localhost:5001/swagger/index . html</a></p><p id="b65d" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">用至少100个用户和10个类别初始化数据库。</p><blockquote class="nl nm nn"><p id="b762" class="kn ko my kp b kq kr jr ks kt ku ju kv no kx ky kz np lb lc ld nq lf lg lh li ij bi translated">您可以创建更多的用户和类别，但由于CPU的限制，这需要一些时间。</p></blockquote><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nr"><img src="../Images/6e1872aee3991c11fcd1ad3cdf0b9901.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fBl-wzNlTuKb9U2O9eJuPA.png"/></div></div></figure><h1 id="c5b6" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">2.用JMeter对扩展的应用程序进行负载测试</h1><h2 id="ba80" class="mh lq iq bd lr mi mj dn lv mk ml dp lz kw mm mn mb la mo mp md le mq mr mf ms bi translated">创建JMeter测试计划</h2><p id="240f" class="pw-post-body-paragraph kn ko iq kp b kq mt jr ks kt mu ju kv kw mv ky kz la mw lc ld le mx lg lh li ij bi translated"><strong class="kp ir">安装</strong>，打开<a class="ae lj" href="https://jmeter.apache.org/download_jmeter.cgi" rel="noopener ugc nofollow" target="_blank"> <strong class="kp ir"> JMeter </strong> </a> <strong class="kp ir">。</strong></p><p id="4806" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">创建一个测试计划</strong>和一个线程组:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi ns"><img src="../Images/d1559f9c02114d17ac084524f03734a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2MOppF-OQDqtob6NQ6OnxQ.png"/></div></div></figure><p id="63d7" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">32个线程是一个不错的开始数字。在线程的每个循环中，它添加一个post并读取10个post。</p><p id="945f" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">添加HTTP请求以创建帖子:</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nt"><img src="../Images/4175636d864a08b1542925ac6049d62d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LZ7EcNWkotCzPOR07nJA-w.png"/></div></div></figure><ul class=""><li id="5094" class="nu nv iq kp b kq kr kt ku kw nw la nx le ny li nz oa ob oc bi translated">服务器名:本地主机</li><li id="f945" class="nu nv iq kp b kq od kt oe kw of la og le oh li nz oa ob oc bi translated">端口:5001</li><li id="ec98" class="nu nv iq kp b kq od kt oe kw of la og le oh li nz oa ob oc bi translated">HTTP-请求:发布</li><li id="ed2e" class="nu nv iq kp b kq od kt oe kw of la og le oh li nz oa ob oc bi translated">路径:/API/post</li><li id="227d" class="nu nv iq kp b kq od kt oe kw of la og le oh li nz oa ob oc bi translated">身体数据:</li></ul><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="5f59" class="mh lq iq nc b gy ng nh l ni nj">{<br/> "title": "MyTitle",<br/> "content": "MyContent",<br/> "userId": ${__Random(1,100)},<br/> "categoryId": "Category${__Random(1,10)}"<br/>}</span></pre><p id="098e" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">它为随机用户(ID 1–100)和类别(1–10)创建一个帖子。</p><p id="6216" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">向请求添加一个</strong> <code class="fe oi oj ok nc b"><strong class="kp ir">Content-Type application/json</strong></code> <strong class="kp ir"> HTTP头:</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/880127557983ce4bd7eee76fa7941d3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*PU0P4sIvFow3KnatcuRs_g.png"/></div></figure><p id="f17c" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">随机阅读10篇文章:</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi om"><img src="../Images/5cd671c7c3616031455eff251ff9478e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*shqj_R9K4-gKRXP4Bv0_NA.png"/></div></div></figure><ul class=""><li id="e926" class="nu nv iq kp b kq kr kt ku kw nw la nx le ny li nz oa ob oc bi translated">服务器名:本地主机</li><li id="9c17" class="nu nv iq kp b kq od kt oe kw of la og le oh li nz oa ob oc bi translated">端口:5001</li><li id="c3f1" class="nu nv iq kp b kq od kt oe kw of la og le oh li nz oa ob oc bi translated">HTTP-请求:获取</li><li id="7555" class="nu nv iq kp b kq od kt oe kw of la og le oh li nz oa ob oc bi translated">路径:/API/post</li><li id="49e7" class="nu nv iq kp b kq od kt oe kw of la og le oh li nz oa ob oc bi translated">随请求发送参数:</li></ul><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="6729" class="mh lq iq nc b gy ng nh l ni nj">NAME | VALUE | CONTENT-TYPE<br/>category | Category${__Random(1,10)} | text/plain<br/>count | 10 | text/plain</span></pre><h2 id="e5f0" class="mh lq iq bd lr mi mj dn lv mk ml dp lz kw mm mn mb la mo mp md le mq mr mf ms bi translated">运行测试</h2><p id="fc7a" class="pw-post-body-paragraph kn ko iq kp b kq mt jr ks kt mu ju kv kw mv ky kz la mw lc ld le mx lg lh li ij bi translated">测试运行时，看一下<em class="my">总结报告</em>:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi on"><img src="../Images/dfc1a91d8e9aa107cff1b4e12b6a598d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*roMDBtblo5M4cdddAupG-w.png"/></div></div></figure><p id="bb7a" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">不应该有错误。</strong></p><p id="5f96" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">等待一段时间</strong>，直到<em class="my">平均值</em>(响应时间)和<em class="my">吞吐量</em>的值稳定。</p><h2 id="a701" class="mh lq iq bd lr mi mj dn lv mk ml dp lz kw mm mn mb la mo mp md le mq mr mf ms bi translated">修改测试参数</h2><p id="c6b2" class="pw-post-body-paragraph kn ko iq kp b kq mt jr ks kt mu ju kv kw mv ky kz la mw lc ld le mx lg lh li ij bi translated">停止JMeter中的测试。</p><p id="45e4" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">您可以<strong class="kp ir">改变测试计划中的线程</strong>。将它们增加到例如64或128个线程。或者将线程减少到16个甚至1个。</p><p id="e859" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在编辑<em class="my"> docker-compose.yml </em>之前，关闭应用程序:</p><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="f1b7" class="mh lq iq nc b gy ng nh l ni nj">C:\dev&gt;docker-compose down</span></pre><p id="1f43" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">您可以通过“<em class="my"> scale </em>”属性<strong class="kp ir">更改<em class="my"> post </em>服务实例</strong>的数量。更改数据库数量的“<em class="my">环境</em>属性(添加/删除注释):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oo"><img src="../Images/cb820166e853db3645ec999638052501.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B2VytQ-0YZxOnRGzTIn7zw.png"/></div></div></figure><p id="703e" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">更改后启动应用程序</strong>:</p><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="4bff" class="mh lq iq nc b gy ng nh l ni nj">C:\dev&gt;docker-compose up -d</span></pre><p id="3c41" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">数据库服务器运行需要一些时间。还有<strong class="kp ir">记得初始化数据库:</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nr"><img src="../Images/6e1872aee3991c11fcd1ad3cdf0b9901.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fBl-wzNlTuKb9U2O9eJuPA.png"/></div></div></figure><h1 id="0aab" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">3.测试结果示例</h1><p id="89ab" class="pw-post-body-paragraph kn ko iq kp b kq mt jr ks kt mu ju kv kw mv ky kz la mw lc ld le mx lg lh li ij bi translated">两个post服务对一个数据库的比率在我的计算机上产生了良好的结果。我可以将它扩展到六个服务和三个数据库，直到我达到硬件的极限。平均时间保持在500毫秒以下。将线程数增加到64以上会产生错误。</p><blockquote class="nl nm nn"><p id="bfef" class="kn ko my kp b kq kr jr ks kt ku ju kv no kx ky kz np lb lc ld nq lf lg lh li ij bi translated">结果取决于我的环境和CPU限制。它们在您的机器上会有所不同。</p></blockquote><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi op"><img src="../Images/6c571efdc8072a7c04ddf9436bd7637b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fFUuYLRlBc6dPKU8PGQSxA.png"/></div></div></figure><p id="d661" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">每秒吞吐量与实例数量成正比:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/915ebbde83a7e5623f00e27dc2f37ebd.png" data-original-src="https://miro.medium.com/v2/resize:fit:656/format:webp/1*zZry4z9DbP2JxzDun3gNIw.png"/></div></figure><p id="53ff" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在CPU有限的容器中，每秒305个请求相当于每天2500万个请求。这将允许100万用户每天写10个帖子并阅读帖子。当然，现实生活中的应用程序会更复杂，但是我希望这个例子展示了基本的思想。</p><h1 id="820f" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">4.微服务间通信和复制用户更改</h1><p id="87ca" class="pw-post-body-paragraph kn ko iq kp b kq mt jr ks kt mu ju kv kw mv ky kz la mw lc ld le mx lg lh li ij bi translated"><em class="my"> Post </em>服务通过Rabbitmq消息接收来自<em class="my">用户</em>微服务的用户变更；</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oq"><img src="../Images/2ab2f600e3b54e233d950dfd9010bb9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bmYSW4DUFtT0Gp4tI753MA.png"/></div></div></figure><p id="fec0" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">您也将使用JMeter进行模拟。</p><h2 id="ee0e" class="mh lq iq bd lr mi mj dn lv mk ml dp lz kw mm mn mb la mo mp md le mq mr mf ms bi translated"><strong class="ak">创建RabbitMQ容器</strong></h2><p id="6668" class="pw-post-body-paragraph kn ko iq kp b kq mt jr ks kt mu ju kv kw mv ky kz la mw lc ld le mx lg lh li ij bi translated"><strong class="kp ir">发出下面的命令</strong>(在控制台窗口的一行中)来用admin UI启动RabbitMQ容器:</p><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="3605" class="mh lq iq nc b gy ng nh l ni nj">C:\dev&gt;docker run -d  -p 15672:15672 -p 5672:5672 <!-- -->-e RABBITMQ_DEFAULT_USER=test -e RABBITMQ_DEFAULT_PASS=test <!-- -->--hostname my-rabbit --name some-rabbit rabbitmq:3-management</span></pre><p id="90d7" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">该命令将“<em class="my">测试</em>”配置为用户和密码，而不是默认的<em class="my">来宾</em>凭证。<em class="my"> Guest </em>限于localhost，但是在docker内部，容器在不同的主机上。</p><h2 id="d777" class="mh lq iq bd lr mi mj dn lv mk ml dp lz kw mm mn mb la mo mp md le mq mr mf ms bi translated"><strong class="ak">修改岗位微服务</strong></h2><p id="6537" class="pw-post-body-paragraph kn ko iq kp b kq mt jr ks kt mu ju kv kw mv ky kz la mw lc ld le mx lg lh li ij bi translated">安装<em class="my"> RabbitMQ。客户端</em>在Visual Studio中获取包。</p><p id="8714" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">添加<em class="my">IntegrationEventListenerService</em>类:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="cbdc" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">后台服务使用“<em class="my"> test </em>”账号访问RabbitMQ和<em class="my"> host.docker.internal </em>和<em class="my"> localhost </em>作为主机。这允许从容器和Visual Studio调试器内部进行连接。</p><p id="97e9" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><a class="ae lj" href="https://www.rabbitmq.com/consumers.html#single-active-consumer" rel="noopener ugc nofollow" target="_blank">单个活动消费者</a>保证只有一个<em class="my"> Post </em>服务实例接收消息。</p><blockquote class="nl nm nn"><p id="8503" class="kn ko my kp b kq kr jr ks kt ku ju kv no kx ky kz np lb lc ld nq lf lg lh li ij bi translated">如果活动实例崩溃，下一个实例将接管。您可以稍后通过停止docker中当前正在接收的实例来尝试它。</p></blockquote><p id="1de6" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果交换和管道还不存在，代码将创建它们。它使用手动确认。</p><p id="056b" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">修改<em class="my">startup . cs</em>T35】运行IntegrationEventListenerService:</strong></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mz na l"/></div></figure><h2 id="64d6" class="mh lq iq bd lr mi mj dn lv mk ml dp lz kw mm mn mb la mo mp md le mq mr mf ms bi translated">在Docker中运行已更改的微服务</h2><p id="fb50" class="pw-post-body-paragraph kn ko iq kp b kq mt jr ks kt mu ju kv kw mv ky kz la mw lc ld le mx lg lh li ij bi translated"><strong class="kp ir">关闭docker中的应用</strong>:</p><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="9a62" class="mh lq iq nc b gy ng nh l ni nj">C:\dev&gt;docker-compose down</span></pre><p id="f29b" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">构建<em class="my"> Post </em>服务，将其docker化并发布到docker。</strong></p><p id="9c09" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">更改后启动应用程序</strong>:</p><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="5c70" class="mh lq iq nc b gy ng nh l ni nj">C:\dev&gt;docker-compose up -d</span></pre><p id="e47e" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">数据库服务器运行需要一些时间。还有<strong class="kp ir">记得初始化数据库:</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nr"><img src="../Images/6e1872aee3991c11fcd1ad3cdf0b9901.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fBl-wzNlTuKb9U2O9eJuPA.png"/></div></div></figure><h2 id="43d1" class="mh lq iq bd lr mi mj dn lv mk ml dp lz kw mm mn mb la mo mp md le mq mr mf ms bi translated"><strong class="ak">修改JMeter测试</strong></h2><p id="4ca9" class="pw-post-body-paragraph kn ko iq kp b kq mt jr ks kt mu ju kv kw mv ky kz la mw lc ld le mx lg lh li ij bi translated">在JMeter测试计划<strong class="kp ir">中添加一个只有一个线程的线程组</strong>:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi or"><img src="../Images/99da16fc310131cb829fd1b700923b65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*csXHQdi4ZTfjcuZ0yl1Xkw.png"/></div></div></figure><p id="1393" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">添加一个常量计时器:</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi os"><img src="../Images/ce0ca770c8b5d16a97696d237559f4c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:436/format:webp/1*K8111jOJGfnuUIlzL7xTpg.png"/></div></figure><p id="9629" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">常量计时器将测试限制为每秒一条消息。</p><blockquote class="nl nm nn"><p id="0091" class="kn ko my kp b kq kr jr ks kt ku ju kv no kx ky kz np lb lc ld nq lf lg lh li ij bi translated">每秒一条消息还是很常见的。即使半年后有100万用户注册，也只是每分钟4个新用户。</p></blockquote><p id="3438" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">添加HTTP请求</strong>将消息发布到RabbitMQ:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi ot"><img src="../Images/cef4485357f3a69f2e4b16df2e53bcfc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jT78IqwvyI4rQeBPLhOhTg.png"/></div></div></figure><ul class=""><li id="7fb4" class="nu nv iq kp b kq kr kt ku kw nw la nx le ny li nz oa ob oc bi translated">服务器名:本地主机</li><li id="d324" class="nu nv iq kp b kq od kt oe kw of la og le oh li nz oa ob oc bi translated">端口:15672</li><li id="8d1c" class="nu nv iq kp b kq od kt oe kw of la og le oh li nz oa ob oc bi translated">HTTP-请求:发布</li><li id="2061" class="nu nv iq kp b kq od kt oe kw of la og le oh li nz oa ob oc bi translated">路径:/API/exchange/% 2F/userloadtest/publish</li><li id="76be" class="nu nv iq kp b kq od kt oe kw of la og le oh li nz oa ob oc bi translated">身体数据:</li></ul><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="41c0" class="mh lq iq nc b gy ng nh l ni nj">{<br/> "properties":{},<br/> "routing_key":"user.update",<br/> "payload":"<br/> {<br/>  id:1,name:\"NewName${__counter(TRUE,)}\",version:${__counter(TRUE,)}<br/> }",<br/> "payload_encoding":"string"<br/>}</span></pre><p id="f07e" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">用户实体有一个版本字段来处理乱序消息。为了使测试简单，它只更新一个用户并增加版本字段。性能影响应该保持不变。</p><p id="61e4" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">为<em class="my">的内容类型</em>和对RabbitMQ的授权添加一个HTTP头管理器</strong>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/92759e4e9a834bd93ce344e0e57cac00.png" data-original-src="https://miro.medium.com/v2/resize:fit:836/format:webp/1*_aIRJ2JqTYdaYVo8qr6PUg.png"/></div></figure><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="494b" class="mh lq iq nc b gy ng nh l ni nj">Content-Type | application/json<br/>Authorization | Basic dGVzdDp0ZXN0</span></pre><blockquote class="nl nm nn"><p id="3086" class="kn ko my kp b kq kr jr ks kt ku ju kv no kx ky kz np lb lc ld nq lf lg lh li ij bi translated">“dGVzdDp0ZXN0”是base64编码的用户和密码“test”。</p></blockquote><h2 id="e10e" class="mh lq iq bd lr mi mj dn lv mk ml dp lz kw mm mn mb la mo mp md le mq mr mf ms bi translated"><strong class="ak">运行测试</strong></h2><p id="a32c" class="pw-post-body-paragraph kn ko iq kp b kq mt jr ks kt mu ju kv kw mv ky kz la mw lc ld le mx lg lh li ij bi translated">吞吐量应该类似于前面的测试。</p><p id="cac2" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">您还可以通过查看控制台输出来识别docker中的活动RabbitMQ消费者。您可以停止容器，另一个实例将接管。</p><h1 id="de58" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">5.最后的想法和展望</h1><p id="0974" class="pw-post-body-paragraph kn ko iq kp b kq mt jr ks kt mu ju kv kw mv ky kz la mw lc ld le mx lg lh li ij bi translated">您<strong class="kp ir">创建了微服务架构</strong>并实现了应用层<strong class="kp ir">数据库分片</strong>。然后<strong class="kp ir">用多个容器实例</strong>扩展应用程序，并<strong class="kp ir">对其进行负载测试</strong>。您还处理了来自RabbitMQ 的<strong class="kp ir">用户变更事件。</strong></p><p id="a816" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这仅仅是一个示例应用。您将不得不<strong class="kp ir">调整代码以在生产环境中使用它</strong>。</p><p id="28c6" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">下一步是什么？获取帖子最多的前10个类别的数据需要查询多个数据库实例。这可能会导致延迟并降低性能。<strong class="kp ir"> Redis可以成为查询聚合数据的解决方案</strong>。我会在我的下一篇文章中展示它。</p><p id="135b" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">您还可以在Kubernetes 中运行应用程序。见<strong class="kp ir">我的其他文章:</strong></p><ul class=""><li id="7587" class="nu nv iq kp b kq kr kt ku kw nw la nx le ny li nz oa ob oc bi translated"><a class="ae lj" href="https://levelup.gitconnected.com/kubernetes-angular-asp-net-core-microservice-architecture-c46fc66ede44" rel="noopener ugc nofollow" target="_blank"> <strong class="kp ir">如何将您的ASP.NET核心应用部署到Kubernetes </strong> </a></li><li id="7c72" class="nu nv iq kp b kq od kt oe kw of la og le oh li nz oa ob oc bi translated"><a class="ae lj" href="https://levelup.gitconnected.com/kubernetes-angular-asp-net-core-microservice-architecture-c46fc66ede44" rel="noopener ugc nofollow" target="_blank"> <strong class="kp ir">为UI使用角度</strong> </a></li></ul><p id="4559" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果你有任何问题、想法或建议，请联系我。</p></div></div>    
</body>
</html>