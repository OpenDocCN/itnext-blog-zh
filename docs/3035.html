<html>
<head>
<title>How To Build Your Own Jenkins Shared Library</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何构建自己的Jenkins共享库</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-build-your-own-jenkins-shared-library-9dc129db260c?source=collection_archive---------0-----------------------#2019-09-19">https://itnext.io/how-to-build-your-own-jenkins-shared-library-9dc129db260c?source=collection_archive---------0-----------------------#2019-09-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="93e1" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">我的Jenkins共享库系列的第二部分</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/9746f5e21ebee43ceaaaf97de40026bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1xY4qH6IqSRQ7SJnVJDDZw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://jenkins.io/" rel="noopener ugc nofollow" target="_blank">https://jenkins.io/</a></figcaption></figure></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="917b" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">在我的Jenkins共享库系列的第一篇文章<a class="ae kv" href="https://medium.com/@werne2j/jenkins-shared-libraries-part-1-5ba3d072536a" rel="noopener">中，我描述了什么是共享库以及为什么你应该开始利用它们。在这篇文章中，我将一步一步地介绍如何构建自己的</a><a class="ae kv" href="https://jenkins.io/doc/book/pipeline/shared-libraries/" rel="noopener ugc nofollow" target="_blank"> Jenkins共享库</a>。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="b605" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated"><strong class="lf ir">免责声明</strong>:我不会在本教程中向你展示如何设置Jenkins。在这篇文章的其余部分，我将假设你有詹金斯运行。你可以按照<a class="ae kv" href="https://jenkins.io/doc/book/installing/" rel="noopener ugc nofollow" target="_blank">官方Jenkins文档</a>进行Jenkins设置</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="921a" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">先决条件</h1><p id="297e" class="pw-post-body-paragraph ld le iq lf b lg mr jr li lj ms ju ll lm mt lo lp lq mu ls lt lu mv lw lx ly ij bi translated">本教程要求我们在Jenkins实例上安装Node JS。因此，在我们开始创建Jenkins共享库之前，我将向您展示我们如何进行设置。</p><ul class=""><li id="3311" class="mw mx iq lf b lg lh lj lk lm my lq mz lu na ly nb nc nd ne bi translated">从Jenkins主屏幕，导航至<code class="fe nf ng nh ni b">Manage Jenkins</code>，然后导航至<code class="fe nf ng nh ni b">Manage Plugins</code>。</li><li id="778b" class="mw mx iq lf b lg nj lj nk lm nl lq nm lu nn ly nb nc nd ne bi translated">点击<code class="fe nf ng nh ni b">Available</code>选项卡，然后使用过滤器，通过<code class="fe nf ng nh ni b">nodejs</code>进行过滤。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/f6d557ac7ec5f8ed2478c2fd89774164.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BqaU52-6U4wp_rWWelYq4Q.png"/></div></div></figure><ul class=""><li id="6c39" class="mw mx iq lf b lg lh lj lk lm my lq mz lu na ly nb nc nd ne bi translated">选中<code class="fe nf ng nh ni b">Install</code>下方的复选框，然后点击<code class="fe nf ng nh ni b">Install without restart</code>。</li><li id="3064" class="mw mx iq lf b lg nj lj nk lm nl lq nm lu nn ly nb nc nd ne bi translated">安装完成后，导航回<code class="fe nf ng nh ni b">Manage Jenkins</code>。</li><li id="4b2e" class="mw mx iq lf b lg nj lj nk lm nl lq nm lu nn ly nb nc nd ne bi translated">导航至<code class="fe nf ng nh ni b">Global Tool Configuration</code>，然后向下滚动，直到看到<code class="fe nf ng nh ni b">Node JS</code>。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/02b58a9361fba6961337522d5adc881f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XltMFQiMyaOECHvUbH18ig.png"/></div></div></figure><ul class=""><li id="af73" class="mw mx iq lf b lg lh lj lk lm my lq mz lu na ly nb nc nd ne bi translated">点击<code class="fe nf ng nh ni b">Add NodeJS</code>。</li><li id="3ed3" class="mw mx iq lf b lg nj lj nk lm nl lq nm lu nn ly nb nc nd ne bi translated">填写表单，如下所示:</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/70a4e72c585f247a3606e2ead0834973.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g7XjOBlYnmurwFyvlGZcIg.png"/></div></div></figure><ul class=""><li id="425c" class="mw mx iq lf b lg lh lj lk lm my lq mz lu na ly nb nc nd ne bi translated">点击<code class="fe nf ng nh ni b">Save</code>。现在节点JS应该可供我们在Jenkins上使用了！</li></ul></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="c57d" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak">入门</strong></h1><p id="e9bd" class="pw-post-body-paragraph ld le iq lf b lg mr jr li lj ms ju ll lm mt lo lp lq mu ls lt lu mv lw lx ly ij bi translated">要做的第一件事是为我们的共享库规划变量。在本例中，我们将看几个不同的场景:</p><ul class=""><li id="07d7" class="mw mx iq lf b lg lh lj lk lm my lq mz lu na ly nb nc nd ne bi translated">我们要处理的第一个场景是共享一个完整的管道。对于可能有相似部署策略的团队来说，共享完整的管道可能是有益的。这可以让团队拥有像一行代码一样简单的Jenkinsfile。</li><li id="611e" class="mw mx iq lf b lg nj lj nk lm nl lq nm lu nn ly nb nc nd ne bi translated">第二个场景是共享某种助手代码的例子。这在不同的团队可能不共享同一个Jenkinsfile，但他们可能共享代码块的情况下很有用。</li></ul><p id="fc1d" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">在本系列的第一部分中，我描述了共享库所需的目录结构。我们将需要一个<code class="fe nf ng nh ni b">src</code>和<code class="fe nf ng nh ni b">vars</code>目录。</p><p id="ea76" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">首先，打开您的终端，切换到您想要共享库代码的目录。我喜欢把我所有的代码放在一个<code class="fe nf ng nh ni b">Developer</code>目录中。一旦进入您选择的目录，我们将为我们的共享库创建必要的目录，然后<code class="fe nf ng nh ni b">cd</code>进入项目目录。</p><p id="70eb" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">这方面的一个例子是:</p><pre class="kg kh ki kj gt nr ni ns nt aw nu bi"><span id="d629" class="nv ma iq ni b gy nw nx l ny nz">mkdir -p ~/Developer/jenkins-shared-library/{src, vars}<br/>cd ~/Developer/jenkins-shared-library</span></pre><p id="62d8" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated"><code class="fe nf ng nh ni b">src</code>目录应该看起来像标准的Java目录结构。因此，对于我们的示例，我们将添加子目录<code class="fe nf ng nh ni b">org/example</code>到<code class="fe nf ng nh ni b">src</code>。为此，运行<code class="fe nf ng nh ni b">mkdir -p src/org/example.</code></p><p id="c0c8" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">此时，您的目录结构应该是这样的:</p><pre class="kg kh ki kj gt nr ni ns nt aw nu bi"><span id="9db6" class="nv ma iq ni b gy nw nx l ny nz">├── jenkins-shared-library<br/>│   ├── src<br/>│   │   ├── org<br/>│   │   │   ├── example<br/>│   ├── vars</span></pre></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="0085" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak">创建管道变量</strong></h1><p id="7daa" class="pw-post-body-paragraph ld le iq lf b lg mr jr li lj ms ju ll lm mt lo lp lq mu ls lt lu mv lw lx ly ij bi translated">我们要创建的第一个变量将被称为<code class="fe nf ng nh ni b">buildJavascriptApp</code>，如果这看起来很熟悉，那是因为这是我在本系列第一部分中使用的一个例子。</p><p id="b9cc" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">使用您选择的编辑器，在<code class="fe nf ng nh ni b">vars</code>目录中创建一个名为<code class="fe nf ng nh ni b">buildJavascriptApp.groovy</code>的文件，并粘贴以下代码:</p><pre class="kg kh ki kj gt nr ni ns nt aw nu bi"><span id="df08" class="nv ma iq ni b gy nw nx l ny nz">def call(Map config=[:], Closure body) {<br/>    node {<br/>        git url: "<a class="ae kv" href="https://github.com/werne2j/sample-nodejs" rel="noopener ugc nofollow" target="_blank">https://github.com/werne2j/sample-nodejs</a>"</span><span id="1d82" class="nv ma iq ni b gy oa nx l ny nz">        stage("Install") {<br/>            sh "npm install"<br/>        }</span><span id="aefd" class="nv ma iq ni b gy oa nx l ny nz">        stage("Test") {<br/>            sh "npm test"<br/>        }</span><span id="a600" class="nv ma iq ni b gy oa nx l ny nz">        stage("Deploy") {<br/>            if (config.deploy) {<br/>                sh "npm publish"<br/>            }<br/>        }</span><span id="7fe1" class="nv ma iq ni b gy oa nx l ny nz">        body()<br/>    }<br/>}</span></pre><p id="aaad" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">如果有些没有意义，请不要担心，我们将遍历每一段代码。</p><p id="356d" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">从文件的顶部开始，我们有了<code class="fe nf ng nh ni b">call()</code>方法。这是Jenkins所要求的，它告诉Jenkins当从Jenkinsfile调用var时要运行什么方法。所以所有的变量都必须有一个调用方法。</p><p id="b6ba" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">我们的变量有两个参数，一个名为<code class="fe nf ng nh ni b">config</code>的映射和一个名为<code class="fe nf ng nh ni b">body</code>的闭包。<code class="fe nf ng nh ni b">config</code>参数允许我们将命名参数传递给调用方法。在这个例子中，我们只关心一个名为<code class="fe nf ng nh ni b">deploy</code>的参数，它告诉我们是否要运行发布命令。</p><p id="8e76" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">当被调用时，这看起来像是:</p><pre class="kg kh ki kj gt nr ni ns nt aw nu bi"><span id="8ba0" class="nv ma iq ni b gy nw nx l ny nz">buildJavascriptApp deploy: true</span></pre><p id="94e3" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">另一个参数是一个<a class="ae kv" href="https://groovy-lang.org/closures.html" rel="noopener ugc nofollow" target="_blank"> Groovy闭包</a>。这使得消费者能够通过传递我们想要执行的代码块来“扩展”这个变量，这可以像普通方法一样通过调用<code class="fe nf ng nh ni b">body()</code>来完成。</p><p id="5631" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">当从Jenkinsfile调用变量并传递闭包时，它看起来像这样:</p><pre class="kg kh ki kj gt nr ni ns nt aw nu bi"><span id="97e4" class="nv ma iq ni b gy nw nx l ny nz">buildJavascriptApp {<br/>  stage(“extra step”) {<br/>    …<br/>  }<br/>}</span></pre><p id="5ec3" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">变量的其余部分由基本的Jenkins步骤组成。我们使用<code class="fe nf ng nh ni b">git</code>步骤来检查我们的样本节点JS项目的源代码。然后我们使用<code class="fe nf ng nh ni b">sh</code>步骤来执行<code class="fe nf ng nh ni b">npm install</code>和<code class="fe nf ng nh ni b">npm test</code>。最后一个阶段检查部署变量是否被设置为真，如果是，运行<code class="fe nf ng nh ni b">npm publish</code>命令。</p><p id="8e0c" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">这是第一个变量！</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="bc87" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak">创建辅助变量</strong></h1><p id="36fb" class="pw-post-body-paragraph ld le iq lf b lg mr jr li lj ms ju ll lm mt lo lp lq mu ls lt lu mv lw lx ly ij bi translated">对于这个变量，我们将创建一个<code class="fe nf ng nh ni b">notify</code>变量，它封装了通过Slack或email发送通知的代码。在您选择的编辑器中，在<code class="fe nf ng nh ni b">vars</code>目录下创建一个名为<code class="fe nf ng nh ni b">notify.groovy</code>的文件。在这个例子中，我们不打算写一个全功能的通知变量，而是写一些简单的<code class="fe nf ng nh ni b">if/else</code>逻辑，但是这个变量可以很容易地调整，以处理复杂的现实世界的逻辑。</p><p id="69fc" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">对于这个变量，我们将利用位于<code class="fe nf ng nh ni b">src</code>目录中的一些代码。在<code class="fe nf ng nh ni b">src/org/example</code>中，创建一个名为<code class="fe nf ng nh ni b">Constants.groovy</code>的文件，这将是一个导出常量供我们在变量中使用的类。</p><p id="739c" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">打开，<code class="fe nf ng nh ni b">Constants.groovy</code>并添加此代码:</p><pre class="kg kh ki kj gt nr ni ns nt aw nu bi"><span id="144a" class="nv ma iq ni b gy nw nx l ny nz">package org.example</span><span id="30bc" class="nv ma iq ni b gy oa nx l ny nz">class Constants {<br/>  static final String SLACK_MESSAGE = "Sending Slack Notification"<br/>  static final String EMAIL_MESSAGE = "Sending Email"<br/>}</span></pre><p id="dc70" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated"><code class="fe nf ng nh ni b">src</code>目录可以用于这样的事情，或者甚至用于存放您的共享库的大部分逻辑，您可以在本系列的第3部分中读到更多。</p><p id="3d4e" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">现在，回到变量，打开<code class="fe nf ng nh ni b">notify.groovy</code>并添加以下代码:</p><pre class="kg kh ki kj gt nr ni ns nt aw nu bi"><span id="21ac" class="nv ma iq ni b gy nw nx l ny nz">import org.example.Constants</span><span id="8a45" class="nv ma iq ni b gy oa nx l ny nz">def call(Map config=[:]) {<br/>    if (config.type == "slack") {<br/>        echo Constants.SLACK_MESSAGE<br/>        echo config.message<br/>    } else {<br/>        echo Constants.EMAIL_MESSAGE<br/>        echo config.message<br/>    }<br/>}</span></pre><p id="9d09" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">这个变量接受一个名为config的参数。像第一个例子一样，这是一个映射，允许我们将命名参数传递给变量。</p><p id="635e" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">我们还从<code class="fe nf ng nh ni b">src</code>目录导入了Constants类，这样我们就可以访问我们创建的常量。</p><p id="d962" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">这个变量中的逻辑非常简单，如果我们要发送的通知类型是<code class="fe nf ng nh ni b">slack</code>，我们将打印出<code class="fe nf ng nh ni b">Sending Slack Notification</code>，否则我们将假设要发送一封电子邮件，并将打印出<code class="fe nf ng nh ni b">Sending Email</code>。我们还打印出一条传递给变量的消息。</p><p id="5f5d" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">在Jenkinsfile中，可以这样调用此变量:</p><pre class="kg kh ki kj gt nr ni ns nt aw nu bi"><span id="467b" class="nv ma iq ni b gy nw nx l ny nz">notify type: “slack” message: “a slack notification”</span></pre><p id="8658" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">这就是我们的第二个变量！我们现在有两个不同的变量可以使用！</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="952a" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak">将我们的共享库加载到Jenkins中</strong></h1><p id="06c3" class="pw-post-body-paragraph ld le iq lf b lg mr jr li lj ms ju ll lm mt lo lp lq mu ls lt lu mv lw lx ly ij bi translated">现在是时候将共享库加载到Jenkins中，看看它们是否工作！</p><ul class=""><li id="dc04" class="mw mx iq lf b lg lh lj lk lm my lq mz lu na ly nb nc nd ne bi translated">点击<code class="fe nf ng nh ni b">Manage Jenkins -&gt; Configure System</code>。</li><li id="51f5" class="mw mx iq lf b lg nj lj nk lm nl lq nm lu nn ly nb nc nd ne bi translated">滚动直到你看到<code class="fe nf ng nh ni b">Global Pipeline Libraries</code>，这是我们加载库的地方。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/200c6b62e99959ad605e38f23d3ca86a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GXjnQCujBsLSVMP9ZWJ2cg.png"/></div></div></figure><ul class=""><li id="ed1f" class="mw mx iq lf b lg lh lj lk lm my lq mz lu na ly nb nc nd ne bi translated">点击<code class="fe nf ng nh ni b">Add</code>。</li><li id="fa92" class="mw mx iq lf b lg nj lj nk lm nl lq nm lu nn ly nb nc nd ne bi translated">我们将这个库命名为<code class="fe nf ng nh ni b">jenkins-shared-library</code>，并将默认版本设置为<code class="fe nf ng nh ni b">master</code>。</li><li id="971b" class="mw mx iq lf b lg nj lj nk lm nl lq nm lu nn ly nb nc nd ne bi translated">确保选择复选框<code class="fe nf ng nh ni b">Load Implicitly</code>。<a class="ae kv" href="https://jenkins.io/doc/book/pipeline/shared-libraries/#using-libraries" rel="noopener ugc nofollow" target="_blank">标记为</a> <code class="fe nf ng nh ni b"><a class="ae kv" href="https://jenkins.io/doc/book/pipeline/shared-libraries/#using-libraries" rel="noopener ugc nofollow" target="_blank">Load Implicitly</a></code> <a class="ae kv" href="https://jenkins.io/doc/book/pipeline/shared-libraries/#using-libraries" rel="noopener ugc nofollow" target="_blank">的共享库允许管道立即使用任何此类库定义的类或全局变量。</a></li><li id="d1ed" class="mw mx iq lf b lg nj lj nk lm nl lq nm lu nn ly nb nc nd ne bi translated">选择<code class="fe nf ng nh ni b">Modern SCM</code>，然后选择<code class="fe nf ng nh ni b">Git</code>。我将从https://github.com/werne2j/jenkins-shared-library.git加载库。如果你愿意的话，你可以试着把你的库推到Github并加载进去。</li><li id="a948" class="mw mx iq lf b lg nj lj nk lm nl lq nm lu nn ly nb nc nd ne bi translated">将库的存储库url放在<code class="fe nf ng nh ni b">Project Repository</code>中。</li><li id="b22f" class="mw mx iq lf b lg nj lj nk lm nl lq nm lu nn ly nb nc nd ne bi translated">点击<code class="fe nf ng nh ni b">Save</code>。</li></ul><p id="e1d3" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">库现在加载到詹金斯！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/5acbebcfe55d3432bd10c5a7a02008d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ViCAESE5W0VxZEASToPBWg.png"/></div></div></figure></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="82fb" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">从Jenkins作业测试共享库</h1><p id="956a" class="pw-post-body-paragraph ld le iq lf b lg mr jr li lj ms ju ll lm mt lo lp lq mu ls lt lu mv lw lx ly ij bi translated">最后要做的事情是创建一个Jenkins作业并测试库。</p><ul class=""><li id="295c" class="mw mx iq lf b lg lh lj lk lm my lq mz lu na ly nb nc nd ne bi translated">在詹金斯首页点击<code class="fe nf ng nh ni b">create new job</code>。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi od"><img src="../Images/a3f50635e9bcba3e863b8a30ed6a14e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CnxWiktpwAQ3C-Y5DOdCkA.png"/></div></div></figure><ul class=""><li id="b0d5" class="mw mx iq lf b lg lh lj lk lm my lq mz lu na ly nb nc nd ne bi translated">输入您的工作名称，我将使用<code class="fe nf ng nh ni b">test-shared-library</code>。</li><li id="47dd" class="mw mx iq lf b lg nj lj nk lm nl lq nm lu nn ly nb nc nd ne bi translated">选择<code class="fe nf ng nh ni b">Pipeline</code>作为工作类型，然后点击<code class="fe nf ng nh ni b">OK</code>。</li><li id="51b2" class="mw mx iq lf b lg nj lj nk lm nl lq nm lu nn ly nb nc nd ne bi translated">创建作业后，您将进入该作业的配置页面。向下滚动直到看到<code class="fe nf ng nh ni b">Pipeline</code>。</li><li id="331e" class="mw mx iq lf b lg nj lj nk lm nl lq nm lu nn ly nb nc nd ne bi translated">我们将选择<code class="fe nf ng nh ni b">Pipeline Script</code>,这样我们就可以测试这个库，而不必从Git加载Jenkinsfile。</li><li id="af2c" class="mw mx iq lf b lg nj lj nk lm nl lq nm lu nn ly nb nc nd ne bi translated">在脚本区域，我们将测试<code class="fe nf ng nh ni b">buildJavascriptApp</code>变量，同时将<code class="fe nf ng nh ni b">notify</code>变量作为闭包的一部分进行传递。一旦写出来就都说得通了。</li><li id="ce2a" class="mw mx iq lf b lg nj lj nk lm nl lq nm lu nn ly nb nc nd ne bi translated">在管道脚本区域粘贴以下代码:</li></ul><pre class="kg kh ki kj gt nr ni ns nt aw nu bi"><span id="cd5d" class="nv ma iq ni b gy nw nx l ny nz">node {<br/>    env.NODEJS_HOME = "${tool 'node'}"<br/>    env.PATH = "${env.NODEJS_HOME}/bin:${env.PATH}"<br/>    <br/>    buildJavascriptApp deploy: false, {<br/>        notify type: "slack", message: "Build succeeded"<br/>    }<br/>}</span></pre><p id="2757" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">希望这段代码现在有意义了。这里唯一不同的是变量调用上面的两行。我们需要告诉Jenkins使用我们的Node JS配置，我们通过在path环境变量上设置Node JS工具来做到这一点。</p><ul class=""><li id="2ec8" class="mw mx iq lf b lg lh lj lk lm my lq mz lu na ly nb nc nd ne bi translated">点击屏幕底部的<code class="fe nf ng nh ni b">Save</code>。考验的时候到了！</li><li id="9da0" class="mw mx iq lf b lg nj lj nk lm nl lq nm lu nn ly nb nc nd ne bi translated">您将被带到工作的主页。到达后，单击<code class="fe nf ng nh ni b">Build Now </code>测试管道脚本。</li></ul><p id="9287" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">几秒钟后，你应该会看到管道出现，如果你看到所有的绿色，那么恭喜你，你已经成功地创建了你的第一个共享库！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oe"><img src="../Images/f15153ab13001fa3c04f89ebc048700f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jjeWlbDVuHUm71V18VFZVQ.png"/></div></div></figure><p id="3c99" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">我们可以查看控制台输出，看看发生了什么。单击构建作业编号旁边的蓝色圆圈，在本例中为<code class="fe nf ng nh ni b">#1</code>。这将带您到构建的控制台输出。</p><p id="5676" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">如果你向下滚动，你应该会看到Jenkins从Github检查出样本节点JS应用程序，然后运行<code class="fe nf ng nh ni b">npm install</code>和<code class="fe nf ng nh ni b">npm test</code>。这表明这些阶段只是通过在管道脚本中包含<code class="fe nf ng nh ni b">buildJavascriptApp</code>来执行的。</p><p id="54ad" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">再往下一点，你会看到另一个变量在起作用。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi of"><img src="../Images/1ddc9a52560c6ec016a8aa00affc87ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1336/format:webp/1*sAF66z8ePlwpW947UHXs8A.png"/></div></figure><p id="0276" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">在管道脚本中，我们声明希望在传递给<code class="fe nf ng nh ni b">buildJavascriptApp</code>的闭包中运行类型slack的<code class="fe nf ng nh ni b">notify</code>，正如我们在这里看到的，我们从<code class="fe nf ng nh ni b">src</code>中的constants类获得slack通知常量，以及传递给<code class="fe nf ng nh ni b">notify</code>的消息。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="19ac" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">希望本教程能够为您提供一些技能，让您能够开始创建自己的Jenkins共享库！</p><p id="5456" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">感谢您阅读我的Jenkins共享库系列的第二部分。</p><p id="7941" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">在我的Jenkins共享库系列的第三部分中，我们将讨论如何为共享库编写测试。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h2 id="fcf7" class="nv ma iq bd mb og oh dn mf oi oj dp mj lm ok ol ml lq om on mn lu oo op mp oq bi translated">我的詹金斯共享图书馆系列</h2><div class="or os gp gr ot ou"><a href="https://medium.com/@werne2j/jenkins-shared-libraries-part-1-5ba3d072536a" rel="noopener follow" target="_blank"><div class="ov ab fo"><div class="ow ab ox cl cj oy"><h2 class="bd ir gy z fp oz fr fs pa fu fw ip bi translated">什么是Jenkins共享库，为什么你应该使用它们</h2><div class="pb l"><h3 class="bd b gy z fp oz fr fs pa fu fw dk translated">Jenkins共享库系列文章的第1部分</h3></div><div class="pc l"><p class="bd b dl z fp oz fr fs pa fu fw dk translated">medium.com</p></div></div><div class="pd l"><div class="pe l pf pg ph pd pi kp ou"/></div></div></a></div><div class="or os gp gr ot ou"><a href="https://medium.com/@werne2j/how-to-build-your-own-jenkins-shared-library-9dc129db260c" rel="noopener follow" target="_blank"><div class="ov ab fo"><div class="ow ab ox cl cj oy"><h2 class="bd ir gy z fp oz fr fs pa fu fw ip bi translated">如何构建自己的Jenkins共享库</h2><div class="pb l"><h3 class="bd b gy z fp oz fr fs pa fu fw dk translated">我的Jenkins共享库系列的第二部分</h3></div><div class="pc l"><p class="bd b dl z fp oz fr fs pa fu fw dk translated">medium.com</p></div></div><div class="pd l"><div class="pj l pf pg ph pd pi kp ou"/></div></div></a></div><div class="or os gp gr ot ou"><a href="https://medium.com/@werne2j/unit-testing-a-jenkins-shared-library-9bfb6b599748" rel="noopener follow" target="_blank"><div class="ov ab fo"><div class="ow ab ox cl cj oy"><h2 class="bd ir gy z fp oz fr fs pa fu fw ip bi translated">Jenkins共享库的单元测试</h2><div class="pb l"><h3 class="bd b gy z fp oz fr fs pa fu fw dk translated">Jenkins共享库系列文章的第三部分</h3></div><div class="pc l"><p class="bd b dl z fp oz fr fs pa fu fw dk translated">medium.com</p></div></div><div class="pd l"><div class="pj l pf pg ph pd pi kp ou"/></div></div></a></div><div class="or os gp gr ot ou"><a href="https://medium.com/@werne2j/collecting-code-coverage-for-a-jenkins-shared-library-c2d8f502732e" rel="noopener follow" target="_blank"><div class="ov ab fo"><div class="ow ab ox cl cj oy"><h2 class="bd ir gy z fp oz fr fs pa fu fw ip bi translated">收集Jenkins共享库的代码覆盖率</h2><div class="pb l"><h3 class="bd b gy z fp oz fr fs pa fu fw dk translated">我的Jenkins共享库系列的第四部分</h3></div><div class="pc l"><p class="bd b dl z fp oz fr fs pa fu fw dk translated">medium.com</p></div></div><div class="pd l"><div class="pj l pf pg ph pd pi kp ou"/></div></div></a></div></div></div>    
</body>
</html>