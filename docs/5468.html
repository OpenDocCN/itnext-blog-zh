<html>
<head>
<title>Kubernetes: what are Endpoints</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes:什么是端点</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-what-are-endpoints-3cc9e769b614?source=collection_archive---------0-----------------------#2021-03-13">https://itnext.io/kubernetes-what-are-endpoints-3cc9e769b614?source=collection_archive---------0-----------------------#2021-03-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/bc674a6dcebfe4ca5cbafd8351e7f1dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I8jSNBx4kgCcVkUqThFK_Q.png"/></div></div></figure><p id="2737" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通常，当使用Kubernetes服务时，我们看不到端点对象，因为它们在幕后工作，类似于“隐藏”在Kubernetes部署后面的<a class="ae kw" href="https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/" rel="noopener ugc nofollow" target="_blank">复制集</a>。</p><h1 id="4c24" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Kubernetes服务</h1><p id="5a8f" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">因此，<a class="ae kw" href="https://kubernetes.io/docs/concepts/services-networking/service/" rel="noopener ugc nofollow" target="_blank">服务</a>是一个Kubernetes抽象，它使用<em class="ma">标签</em>来选择将流量路由到的pods，请参见<a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-clusterip-vs-nodeport-vs-loadbalancer-services-and-ingress-an-overview-with-examples/" rel="noopener ugc nofollow" target="_blank">Kubernetes:cluster IP vs node port vs load balancer，Services and Ingress—概述示例</a>和<a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-service-load-balancing-kube-proxy-and-iptables/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:服务、负载平衡、kube-proxy和iptables </a>:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="6470" class="mk ky iq mg b gy ml mm l mn mo">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: my-service<br/>spec:<br/>  selector:<br/>    app: MyApp<br/>  ports:<br/>    - protocol: TCP<br/>      port: 80<br/>      targetPort: 9376</span></pre><p id="bce7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦一个新的pod出现在集群中，标签与服务的<code class="fe mp mq mr mg b">selector</code>相匹配，上面示例中的<code class="fe mp mq mr mg b">app=MyApp</code>服务将开始向它发送流量。</p><p id="4e4d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是通过将该Pod的IP地址添加到该服务的<em class="ma">端点</em>列表中来实现的。</p><p id="4fca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们创建一个简单的例子:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="a4b1" class="mk ky iq mg b gy ml mm l mn mo">---<br/>apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  name: nginx-pod<br/>  labels:<br/>    app: nginx<br/>spec:<br/>  containers:<br/>    - name: nginx-container<br/>      image: nginx<br/>      ports:<br/>        - name: web<br/>          containerPort: 80<br/>          protocol: TCP<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: nginx-svc<br/>spec:<br/>  selector:<br/>    app: nginx<br/>  ports:<br/>    - protocol: TCP<br/>      port: 80<br/>      targetPort: 80</span></pre><p id="f017" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里，我们用NGINX创建了一个Pod，以及一个默认类型为<code class="fe mp mq mr mg b">ClusterIP</code>的服务。</p><p id="bac1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">应用清单:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="9d58" class="mk ky iq mg b gy ml mm l mn mo">$ kubectl apply -f svc-example.yaml<br/>pod/nginx-pod created<br/>service/nginx-svc created</span></pre><p id="0f38" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查服务:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="ab46" class="mk ky iq mg b gy ml mm l mn mo">$ kubectl get service nginx-svc<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br/>nginx-svc ClusterIP 172.20.69.253 &lt;none&gt; 80/TCP 26s</span></pre><h1 id="683c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Kubernetes端点</h1><p id="a798" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">现在，让我们仔细看看它:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="b165" class="mk ky iq mg b gy ml mm l mn mo">$ kubectl describe service nginx-svc<br/>Name: nginx-svc<br/>Namespace: default<br/>Labels: &lt;none&gt;<br/>Annotations: &lt;none&gt;<br/>Selector: app=nginx<br/>Type: ClusterIP<br/>IP Families: &lt;none&gt;<br/>IP: 172.20.69.253<br/>IPs: &lt;none&gt;<br/>Port: &lt;unset&gt; 80/TCP<br/>TargetPort: 80/TCP<br/>Endpoints: 10.21.56.143:80</span></pre><p id="e717" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，我们可以看到这个服务的端点pod的IP。</p><p id="a956" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查此Pod:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="a5ba" class="mk ky iq mg b gy ml mm l mn mo">$ kubectl describe pod nginx-pod<br/>Name: nginx-pod<br/>Namespace: default<br/>Priority: 0<br/>Node: ip-10–21–49–33.us-east-2.compute.internal/10.21.49.33<br/>Start Time: Sat, 13 Mar 2021 08:37:55 +0200<br/>Labels: app=nginx<br/>Annotations: kubernetes.io/psp: eks.privileged<br/>Status: Running<br/>IP: 10.21.56.143<br/>…</span></pre><p id="61b7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里是上面提到的IP。</p><p id="ddcc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们检查端点，它们是专用的API对象，可以像服务和pod一样进行观察:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="2829" class="mk ky iq mg b gy ml mm l mn mo">$ kubectl get endpoints nginx-svc<br/>NAME ENDPOINTS AGE<br/>nginx-svc 10.21.56.143:80 18m</span></pre><p id="3697" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果我们通过在清单文件中将其描述为附加对象或通过创建部署来添加具有相同标签的其他pod，则这些pod将被添加为服务的端点:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="aa97" class="mk ky iq mg b gy ml mm l mn mo">---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: nginx-deploy<br/>  labels:<br/>    app: nginx<br/>spec:<br/>  replicas: 2<br/>  selector:<br/>    matchLabels:<br/>      app: nginx<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: nginx<br/>    spec:<br/>      containers:<br/>      - name: nginx-container<br/>        image: nginx<br/>        ports:<br/>          - name: web<br/>            containerPort: 80<br/>            protocol: TCP<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: nginx-svc<br/>spec:<br/>  selector:<br/>    app: nginx<br/>  ports:<br/>    - protocol: TCP<br/>      port: 80<br/>      targetPort: 80</span></pre><p id="639d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建部署:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="1dee" class="mk ky iq mg b gy ml mm l mn mo">$ kubectl apply -f svc-example.yaml<br/>deployment.apps/nginx-deploy created<br/>service/nginx-svc unchanged</span></pre><p id="bf8e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并检查端点:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="2e8c" class="mk ky iq mg b gy ml mm l mn mo">$ kubectl get endpoints nginx-svc<br/>NAME ENDPOINTS AGE<br/>nginx-svc 10.21.37.55:80,10.21.54.174:80,10.21.56.143:80 21m</span></pre><p id="47fd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这里，我们可以看到上一个pod中的<em class="ma"> 10.21.56.143:80 </em>，以及两个新的——来自上面部署的<code class="fe mp mq mr mg b">replicas</code>中指定的pod。</p><p id="4b02" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过使用<code class="fe mp mq mr mg b">--selector</code>找到这些pod，类似地，当服务寻找pod以将它们添加到其端点时:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="58c5" class="mk ky iq mg b gy ml mm l mn mo">$ kubectl get pod --selector=app=nginx -o wide<br/>NAME READY STATUS RESTARTS AGE IP<br/>nginx-deploy-7fcd954c94-gbm6d 1/1 Running 0 2m28s 10.21.54.174<br/>nginx-deploy-7fcd954c94-mg8kr 1/1 Running 0 2m28s 10.21.37.55<br/>nginx-pod 1/1 Running 0 23m 10.21.56.143</span></pre><h2 id="06da" class="mk ky iq bd kz ms mt dn ld mu mv dp lh kj mw mx ll kn my mz lp kr na nb lt nc bi translated">自定义端点</h2><p id="3923" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们还可以创建一个自定义端点，它将指向任何所需的资源。</p><p id="228c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，描述一项新服务:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="0000" class="mk ky iq mg b gy ml mm l mn mo">kind: Service<br/>apiVersion: v1<br/>metadata:<br/>  name: external-svc<br/>spec:<br/>  ports:<br/>    - name: web<br/>      protocol: TCP<br/>      port: 80<br/>      targetPort: 80</span></pre><p id="4689" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意，在这种情况下，我们没有添加<code class="fe mp mq mr mg b">selector</code>字段。</p><p id="38b4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">和描述端点对象:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="aa4a" class="mk ky iq mg b gy ml mm l mn mo">kind: Endpoints<br/>apiVersion: v1<br/>metadata:<br/>  name: external-svc<br/>subsets: <br/>  - addresses:<br/>        - ip: 139.59.205.180<br/>    ports:<br/>      - port: 80<br/>        name: web</span></pre><p id="1750" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里:</p><ol class=""><li id="625c" class="nd ne iq ka b kb kc kf kg kj nf kn ng kr nh kv ni nj nk nl bi translated"><code class="fe mp mq mr mg b">name</code>:必须与服务相同</li><li id="8a77" class="nd ne iq ka b kb nm kf nn kj no kn np kr nq kv ni nj nk nl bi translated"><code class="fe mp mq mr mg b">addresses</code>:向其发送流量的地址，在本例中，这是<a class="ae kw" href="https://rtfm.co.ua/" rel="noopener ugc nofollow" target="_blank">rtfm.co.ua</a>所在的数字海洋云中的一个服务器的IP地址，但是您可以设置多个地址，这样服务将在它们之间进行负载平衡，如<a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-service-load-balancing-kube-proxy-and-iptables/" rel="noopener ugc nofollow" target="_blank"> Kubernetes: Service、load balancing、kube-proxy和iptables </a>中所述</li><li id="06c4" class="nd ne iq ka b kb nm kf nn kj no kn np kr nq kv ni nj nk nl bi translated"><code class="fe mp mq mr mg b">ports.port</code>和<code class="fe mp mq mr mg b">ports.name</code>也必须与相应的服务相同</li></ol><p id="1fd6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建它们:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="5d94" class="mk ky iq mg b gy ml mm l mn mo">$ kubectl apply -f external-endpoint.yaml<br/>service/external-svc created<br/>endpoints/external-svc created<br/>Check the Service and its Endpoints:<br/>kubectl describe svc external-svc<br/>Name: external-svc<br/>Namespace: default<br/>Labels: &lt;none&gt;<br/>Annotations: &lt;none&gt;<br/>Selector: &lt;none&gt;<br/>Type: ClusterIP<br/>IP Families: &lt;none&gt;<br/>IP: 172.20.45.77<br/>IPs: &lt;none&gt;<br/>Port: web 80/TCP<br/>TargetPort: 80/TCP<br/>Endpoints: 139.59.205.180:80</span></pre><p id="a288" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行Pod以检查此服务是否工作:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="41c5" class="mk ky iq mg b gy ml mm l mn mo">$ kubectl run pod — rm -i — tty — image ubuntu — bash</span></pre><p id="02f0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将<code class="fe mp mq mr mg b">curl</code>安装在该吊舱中:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="08d6" class="mk ky iq mg b gy ml mm l mn mo">root@pod:/# apt update &amp;&amp; apt -y install curl</span></pre><p id="76db" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并按名称检查服务:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="f809" class="mk ky iq mg b gy ml mm l mn mo">root@pod:/# curl -Ls external-svc | grep \&lt;title\&gt;<br/>&lt;title&gt;RTFM: Linux, DevOps, and system administration&lt;/title&gt;</span></pre><p id="f909" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者通过使用它的FQDN:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="9804" class="mk ky iq mg b gy ml mm l mn mo">root@pod:/# curl -Ls external-svc.default.svc.cluster.local | grep \&lt;title\&gt;<br/>&lt;title&gt;RTFM: Linux, DevOps, and system administration&lt;/title&gt;</span></pre><h1 id="8610" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated"><code class="fe mp mq mr mg b">externalName</code></h1><p id="f30d" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">访问外部资源的另一个解决方案是使用<code class="fe mp mq mr mg b"><a class="ae kw" href="https://rtfm.co.ua/kubernetes-clusterip-vs-nodeport-vs-loadbalancer-services-i-ingress-obzor-primery/#ExternalName" rel="noopener ugc nofollow" target="_blank">externalName</a></code>类型的服务:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="f7ce" class="mk ky iq mg b gy ml mm l mn mo">---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: rtfm-service<br/>spec:<br/>  ports:<br/>    - port: 80<br/>  type: ExternalName<br/>  externalName: rtfm.co.ua</span></pre><p id="1a44" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">应用并检查:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="586e" class="mk ky iq mg b gy ml mm l mn mo">$ root@pod:/# curl -Ls rtfm-service | grep \&lt;title\&gt;<br/>&lt;title&gt;RTFM: Linux, DevOps, and system administration&lt;/title&gt;</span></pre><p id="db43" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成了。</p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><p id="b4f7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ma">最初发布于</em> <a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-what-is-endpoints/" rel="noopener ugc nofollow" target="_blank"> <em class="ma"> RTFM: Linux，devo PSисистемноеадммиитиииииованниое</em></a><em class="ma">。</em></p></div></div>    
</body>
</html>