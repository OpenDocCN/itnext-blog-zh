<html>
<head>
<title>Embedding a Web application in a Golang binary</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Golang二进制文件中嵌入Web应用程序</h1>
<blockquote>原文：<a href="https://itnext.io/embedding-a-web-application-in-a-golang-binary-f9733b25bbf7?source=collection_archive---------2-----------------------#2020-12-27">https://itnext.io/embedding-a-web-application-in-a-golang-binary-f9733b25bbf7?source=collection_archive---------2-----------------------#2020-12-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/a2e33032c5d05e0d4709f8cfd3ef8210.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9xJ7gakEXqA3AnaFkaNhtQ.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@helibertoarias?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">赫利贝托·阿里亚斯</a>在<a class="ae kf" href="https://unsplash.com/s/photos/software?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="3f1e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">前一段时间，我写了一篇关于如何在没有Envoy的情况下通过web应用程序运行gRPC的文章。我将在本文中使用<a class="ae kf" href="https://github.com/percybolmer/grpcexample" rel="noopener ugc nofollow" target="_blank">项目</a>，并将web应用程序嵌入到二进制文件中。如果你不熟悉这个项目，我建议你阅读第一部分。</p><div class="le lf gp gr lg lh"><a href="https://programmingpercy.tech/blog/using-grpc-tls-go-react-no-reverse-proxy/" rel="noopener  ugc nofollow" target="_blank"><div class="li ab fo"><div class="lj ab lk cl cj ll"><h2 class="bd iu gy z fp lm fr fs ln fu fw is bi translated">将gRPC与TLS、Golang、React一起使用，无需反向代理(Envoy)</h2><div class="lo l"><h3 class="bd b gy z fp lm fr fs ln fu fw dk translated">一篇关于如何在Go后端服务器和React客户端之间实现gRPC而不使用反向代理的文章…</h3></div><div class="lp l"><p class="bd b dl z fp lm fr fs ln fu fw dk translated">编程percy.tech</p></div></div><div class="lq l"><div class="lr l ls lt lu lq lv jz lh"/></div></div></a></div><p id="410b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是如果你只是想学习如何在Go中使用embed包，你应该可以在没有任何先验知识的情况下阅读这篇文章。</p><p id="39a9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为什么我们要在二进制文件中包含像web应用程序这样的东西？</p><p id="0064" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对我来说，一切都在于部署。能够只向服务器发送一个二进制文件可以节省大量时间。</p><p id="877f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在Golang 1.16之前(这是embed包发布的时候)，我们需要部署二进制文件、web应用程序或任何其他我们需要的非编译代码的文件。</p><p id="3aaf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了解决这个问题，我倾向于使用<a class="ae kf" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker </a>，我知道很多人也推荐<a class="ae kf" href="https://www.packer.io/" rel="noopener ugc nofollow" target="_blank"> Packer。不要让我在docker上开始，我喜欢它，我是一个超级粉丝。</a></p><p id="e308" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是，说实话，有时候二进制比docker更有意义。</p><h1 id="8415" class="lw lx it bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">让我们开始设置项目</h1><p id="b991" class="pw-post-body-paragraph kg kh it ki b kj mu kl km kn mv kp kq kr mw kt ku kv mx kx ky kz my lb lc ld im bi translated">在我们开始编码之前，让我们抓住我们将要修改的项目。</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="6791" class="ni lx it ne b gy nj nk l nl nm">mkdir embedding &amp;&amp; cd embedding<br/>git init<br/>git pull https://github.com/percybolmer/grpcexample</span></pre><p id="b244" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是一个超级简单的gRPC API，它有一个Ping函数和一个React应用程序，该应用程序托管在<a class="ae kf" href="https://localhost:8080/ui/pingpongapp/build/" rel="noopener ugc nofollow" target="_blank"> localhost:8080 </a>上，每隔3秒调用一次Ping函数。这对于本教程并不重要，您可以使用任何其他web应用程序。如果你有兴趣阅读更多关于这个项目的内容，请看这个系列的第一部分。</p><p id="2f40" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您正在使用该项目，您需要生成证书，如果您还没有。进入cert文件夹并运行<em class="nn"> certgen.sh </em>脚本。这需要您安装openssl。</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="f528" class="ni lx it ne b gy nj nk l nl nm">cd cert <br/>bash certgen.sh</span></pre><p id="b565" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们还需要编译我们嵌入的react应用程序。该应用程序位于<em class="nn"> ui </em>文件夹中。<br/>在运行构建命令之前，确保在<em class="nn"> package.json </em>文件中添加两行。我们需要告诉React应用程序，这些文件将在没有服务器的情况下被提供。</p><p id="fddf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将下面两行添加到<em class="nn">ui/pingpongapp/package . JSON</em></p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="a323" class="ni lx it ne b gy nj nk l nl nm">“homepage”: “.”,<br/>”proxy”: “https://localhost:8080",</span></pre><p id="8843" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">运行以下命令。</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="7515" class="ni lx it ne b gy nj nk l nl nm">npm install<br/>npm run build</span></pre><p id="0818" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="nn"> npm install </em>将下载任何需要的依赖项，而<em class="nn"> npm run build </em>将在名为build的新文件夹中构建一个静态应用程序。这是我们稍后将嵌入的文件夹。</p><p id="5009" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你还需要运行至少Golang <strong class="ki iu"> <em class="nn"> 1.16。</em> </strong>运行以下命令测试您的安装</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="1503" class="ni lx it ne b gy nj nk l nl nm">go version</span></pre><figure class="mz na nb nc gt ju gh gi paragraph-image"><div class="gh gi no"><img src="../Images/9ee385e6595266aae4a97af99ed879a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:806/format:webp/1*OvHo5jn03INdwo-oU0ra1g.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">您应该会看到一个提到当前版本的输出</figcaption></figure><h1 id="e55d" class="lw lx it bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">让嵌入</h1><p id="45cf" class="pw-post-body-paragraph kg kh it ki b kj mu kl km kn mv kp kq kr mw kt ku kv mx kx ky kz my lb lc ld im bi translated">完成所有设置后，打开main.go。</p><p id="5dc2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可以在这里  <em class="nn">阅读关于embed包<a class="ae kf" href="https://tip.golang.org/pkg/embed/" rel="noopener ugc nofollow" target="_blank"> <em class="nn">。我们需要的是嵌入我们的构建文件夹，并将其作为文件系统嵌入到我们的二进制文件中。我推荐阅读链接的软件包文档，它非常简短，并且解释得非常清楚。</em></a></em></p><p id="6a8e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">嵌入包不同于我以前见过的其他包。我们实际上将使用注释来告诉编译器要执行什么操作。<br/>语法短小精悍。</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="97d3" class="ni lx it ne b gy nj nk l nl nm">//go:embed $PATH<br/>var content $WANTED_DATA_TYPE</span></pre><p id="277d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有2行代码，一个注释和一个变量声明。他们必须直接跟在对方后面，从评论开始。</p><p id="b0be" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">看到$PATH和$WANTED_DATA_TYPE了吗？那些需要被替换。<br/> $PATH应该替换为您想要包含的文件或目录的路径。另一个注意事项是，如果使用数据类型embed。FS，它在一个注释中接受多个路径，同时也接受多个注释。</p><p id="dd1c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">$WANTED_DATA_TYPE将替换为任何可用的数据类型:</p><ul class=""><li id="d0cb" class="np nq it ki b kj kk kn ko kr nr kv ns kz nt ld nu nv nw nx bi translated"><strong class="ki iu"> <em class="nn"> String </em> </strong> =接受单个文件，并在构建时将该文件的内容作为字符串读入变量</li><li id="f44c" class="np nq it ki b kj ny kn nz kr oa kv ob kz oc ld nu nv nw nx bi translated"><strong class="ki iu"><em class="nn">[]字节</em> </strong> =与字符串相同，但为[]字节</li><li id="17e1" class="np nq it ki b kj ny kn nz kr oa kv ob kz oc ld nu nv nw nx bi translated"><strong class="ki iu"> <em class="nn">嵌入。FS </em> </strong>(文件系统的缩写)=这就是嵌入式让我兴奋的地方。我们被允许嵌入多个目录和文件。而最好的部分，它们是<a class="ae kf" href="https://tip.golang.org/pkg/io/fs/" rel="noopener ugc nofollow" target="_blank"> io/FS </a>接口的一部分。这意味着net/http包可以开箱即用。</li></ul><p id="2a2a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有了这些新的知识，让我们更新<em class="nn"> main.go </em>以在<em class="nn"> ui/pingpongapp/ </em> build中嵌入构建文件夹。</p><p id="40b2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在旧的<em class="nn"> main.go </em>中，路径是硬编码的，需要转换成嵌入式文件系统。</p><figure class="mz na nb nc gt ju"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="26dd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们构建二进制文件并运行它</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="d575" class="ni lx it ne b gy nj nk l nl nm">go1.16beta1 build -o api . &amp;&amp; ./api</span></pre><p id="4963" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">访问<a class="ae kf" href="https://localhost:8080/ui/pingpongapp/build/" rel="noopener ugc nofollow" target="_blank"> localhost:8080 </a>，3秒后观察状态由假变真！</p><p id="7d20" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">就是这样！我不得不把它交给Golang的团队，他们把它做得超级简单。我们只用了2行新代码就在二进制文件中添加了一个嵌入式web应用程序。</p><p id="0e0b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你感兴趣，请随意阅读<a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/grpc-interceptors-e221aa4cc49">关于实现gRPC拦截器的第2部分。</a></p></div></div>    
</body>
</html>