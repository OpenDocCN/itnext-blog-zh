<html>
<head>
<title>How to Deploy a Highly Available WireGuard® Network Management Server on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Kubernetes上部署高可用的WireGuard网络管理服务器</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-deploy-a-highly-available-wireguard-network-management-server-on-kubernetes-294e23c7abcb?source=collection_archive---------0-----------------------#2021-10-22">https://itnext.io/how-to-deploy-a-highly-available-wireguard-network-management-server-on-kubernetes-294e23c7abcb?source=collection_archive---------0-----------------------#2021-10-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c8b7136e04d3d273f81d7e73d298f0d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7dEsoNK2cFkQQUuJbs7Row.png"/></div></div></figure></div><div class="ab cl jy jz hu ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="ij ik il im in"><p id="a47f" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">在本文中，我们将讨论WireGuard  <em class="ld">以及将WireGuard </em> <em class="ld">投入生产的问题。然后我们将介绍Netmaker，一个让您的WireGuard </em> <em class="ld">管理高度可用的平台。最后，我们将简要介绍如何在Kubernetes上以HA模式部署Netmaker。</em></p></div><div class="ab cl jy jz hu ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="ij ik il im in"><p id="8562" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">WireGuard太棒了。它小巧、安全、速度极快。它问世的那天，让OpenVPN和ZeroTier <a class="ae le" href="https://restoreprivacy.com/vpn/wireguard-vs-openvpn/" rel="noopener ugc nofollow" target="_blank">看起来像恐龙。</a></p><p id="1d73" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">WireGuard支持跨多云、edge、<a class="ae le" rel="noopener ugc nofollow" target="_blank" href="/8-use-cases-for-kubernetes-over-vpn-unlocking-multicloud-flexibility-3958dab2219f">和Kubernetes </a>的尖端网络模式。我的主要问题是，为什么不是每个企业都已经将它用于他们的企业VPN和覆盖网络？</p><p id="278b" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">一个问题就是知识差距。WireGuard比旧的VPN技术更容易学习，但它仍然是新的，人们喜欢坚持他们所知道的。</p><p id="8f61" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">一个更重要的问题是大规模管理基于WireGuard的网络的复杂性。如果您通过WireGuard创建了一个包含100台机器的平面(点对点)虚拟网络，您需要负责管理所有100台机器的配置。每当任何一台机器的端点、端口或密钥改变时，或者每当一台机器被添加到网络中或从网络中移除时，所有机器上的所有配置都必须被更新。</p><p id="3eb6" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">因此，大规模管理WireGuard虚拟网络需要某种形式的自动化。不幸的是，到目前为止，生态系统还没有跟上。工具的出现使WireGuard管理变得更加容易，但它们往往处于开发周期的早期，这将我们带到了最后一个问题。</p><p id="105b" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">虽然存在许多工具来管理WireGuard自动化，但它们往往缺乏大型企业所寻求的稳定性。如果您使用服务器来管理您的网络，它最好是可靠、稳定和高度可用的。这导致企业使用Ansible、Terraform和Puppet等工具建立自己的定制自动化形式。虽然肯定可行，但如果有一个高可用性的WireGuard自动化工具就更好了。</p></div><div class="ab cl jy jz hu ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="ij ik il im in"><p id="997c" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">输入<a class="ae le" href="https://github.com/gravitl/netmaker" rel="noopener ugc nofollow" target="_blank">造网者</a>。Netmaker是一个用于创建和管理基于WireGuard的虚拟网络的平台。Netmaker的服务器管理认证并保存机器的配置。Netmaker的客户端(netclient)在本地拉取和推送WireGuard的配置更新。最终结果是一个基于WireGuard的虚拟网络，当任何对等体发生任何变化时，它将自动更新。</p><p id="692e" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">企业需要为他们的网络微调参数，这就是为什么Netmaker的服务器能够远程管理广泛的参数，包括MTU、密钥、ip地址、DNS等等。它还允许您处理不同类型的网络拓扑，包括全网状、站点到站点、入口、出口和中继。如果你需要Netmaker的介绍，你可以看看这个<a class="ae le" rel="noopener ugc nofollow" target="_blank" href="/getting-started-with-netmaker-a-wireguard-virtual-networking-platform-3d563fbd87f0">演练</a>。</p></div><div class="ab cl jy jz hu ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="ij ik il im in"><p id="f08a" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">这样一个系统的关键是服务器。Netmaker v0.8.4提供了管理高可用性服务器的更新，这样您的客户端就不会失去连接。V0.8.4还引入了对PostgreSQL的支持，以最大限度地提高数据库的可靠性。</p><p id="81a7" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">最后，v0.8.4为Kubernetes引入了<a class="ae le" href="https://github.com/gravitl/netmaker-helm" rel="noopener ugc nofollow" target="_blank">掌舵图</a>，以简化HA部署。这些图表创建了一个负载平衡的多实例服务器，由HA PostgreSQL集群提供支持。</p><p id="4988" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">我们现在要做一个快速演练，在Kubernetes上部署HA Netmaker。</p></div><div class="ab cl jy jz hu ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="ij ik il im in"><h1 id="d9be" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">要求</h1><h2 id="ab0c" class="md lg iq bd lh me mf dn ll mg mh dp lp kq mi mj lt ku mk ml lx ky mm mn mb mo bi translated">舵</h2><p id="e916" class="pw-post-body-paragraph kf kg iq kh b ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky mt la lb lc ij bi translated">如果你通过helm安装…你将需要helm。我们推荐<a class="ae le" href="https://helm.sh/docs/intro/quickstart/" rel="noopener ugc nofollow" target="_blank">头盔3 </a>。</p><h2 id="fdcf" class="md lg iq bd lh me mf dn ll mg mh dp lp kq mi mj lt ku mk ml lx ky mm mn mb mo bi translated">进入</h2><p id="98d6" class="pw-post-body-paragraph kf kg iq kh b ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky mt la lb lc ij bi translated">Netmaker需要带有TLS的入口才能安全运行。通过Helm部署Netmaker时，默认情况下将禁用入口。这是因为在Kubernetes上，ingress有多种形式，通常自己设置ingress更好。</p><p id="ea34" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">要使Netmaker自动部署Ingress，您必须具备以下条件:</p><p id="46e3" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">cert-Manger for automated TLS Certificates:Helm chart寻找一个“ClusterIssuer ”,并使用它来生成证书。</p><p id="2394" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">Nginx或Traefik入口控制器:舵图可以为Nginx或Traefik生成入口对象。</p><p id="5285" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">如果您对部署ingress有其他要求，您应该禁用ingress并在安装后部署它。</p><h2 id="22f6" class="md lg iq bd lh me mf dn ll mg mh dp lp kq mi mj lt ku mk ml lx ky mm mn mb mo bi translated">节点</h2><p id="5298" class="pw-post-body-paragraph kf kg iq kh b ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky mt la lb lc ij bi translated">默认情况下，Netmaker需要3个工作节点来运行HA。这是因为每个实例都需要管理节点级的虚拟接口。</p><p id="9970" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">对于那些节点级接口，helm图表还将创建10个节点端口。这听起来很多，但它是针对WireGuard接口的，这些接口是加密的。该数字可以根据需要进行修改。</p><h2 id="da0e" class="md lg iq bd lh me mf dn ll mg mh dp lp kq mi mj lt ku mk ml lx ky mm mn mb mo bi translated">许可</h2><p id="931e" class="pw-post-body-paragraph kf kg iq kh b ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky mt la lb lc ij bi translated">Netmaker服务器需要NET_ADMIN权限来部署接口。此外，init容器在机器上设置ip转发，这需要在特权模式下运行。</p><p id="5922" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">还建议在每个节点的内核上安装WireGuard。如果是这样，可以在服务器上启用内核模式，这样会快很多。默认情况下，这是禁用的，以减少对节点级访问的需求，这意味着WireGuard将在服务器上以用户空间模式运行。</p><h2 id="6a00" class="md lg iq bd lh me mf dn ll mg mh dp lp kq mi mj lt ku mk ml lx ky mm mn mb mo bi translated">降低要求(客户端模式=关闭)</h2><p id="d02f" class="pw-post-body-paragraph kf kg iq kh b ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky mt la lb lc ij bi translated">如果关闭了客户端模式，Netmaker可以在没有任何节点端口或主机权限(NET_ADMIN，privileged)的情况下运行。在这种情况下，服务器上没有WireGuard，它只是一个配置服务器。这也意味着您可以在相同的节点上运行任意多的服务器实例。</p><h1 id="d494" class="lf lg iq bd lh li mu lk ll lm mv lo lp lq mw ls lt lu mx lw lx ly my ma mb mc bi translated">安装</h1><p id="75c0" class="pw-post-body-paragraph kf kg iq kh b ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky mt la lb lc ij bi translated">假设您已经满足了所有的需求，让我们看两个在Kubernetes上部署Netmaker的例子。但是首先，确保在本地添加helm repo:</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="8407" class="md lg iq ne b gy ni nj l nk nl">helm repo add netmaker https://gravitl.github.io/netmaker-helm/<br/>helm repo update</span></pre><h1 id="9905" class="lf lg iq bd lh li mu lk ll lm mv lo lp lq mw ls lt lu mx lw lx ly my ma mb mc bi translated">完全安装(理想)</h1><p id="6e49" class="pw-post-body-paragraph kf kg iq kh b ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky mt la lb lc ij bi translated">以下是Netmaker的“完整安装”,列出了所有选项:</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="a314" class="md lg iq ne b gy ni nj l nk nl">helm install netmaker/netmaker --generate-name <br/>--set wireguard.kernel=true<br/>--set baseDomain=nm.example.com<br/>--set replicas=3<br/>--set ingress.enabled=true<br/>--set ingress.className=nginx<br/>--set ingress.tls.issuerName=letsencrypt-prod  <br/>--set dns.enabled=true <br/>--set dns.clusterIP=10.245.75.75<br/>--set dns.RWX.storageClassName=nfs <br/>--set postgresql-ha.postgresql.replicaCount=2</span></pre><p id="8e77" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">这个“helm install”命令将使用内核WireGuard安装Netmaker。Helm将部署服务器的3个副本，这意味着它预计有3个工作节点可用，并且必须在所有3个节点上安装内核WireGuard。</p><p id="098f" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">通过将“nginx”设置为入口类别来启用入口。它将寻找名为“letsencrypt-prod”的ClusterIssuer来生成TLS证书。它将使用以下路由进入:</p><p id="dfbf" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">api.nm.example.com</p><p id="db7c" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">grpc.nm.example.com</p><p id="fe72" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">dashboard.nm.example.com</p><p id="1edc" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">DNS已启用，这意味着我们需要指定DNS要使用的clusterIP(从服务IP范围中)。这也意味着我们需要一个RWX存储类。</p><p id="2bf4" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">最后，Bitnami的Postgresql-HA图表将部署两个副本作为后备数据库。</p><p id="997d" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">这是你能得到的最完整的安装。</p><h1 id="e2b8" class="lf lg iq bd lh li mu lk ll lm mv lo lp lq mw ls lt lu mx lw lx ly my ma mb mc bi translated"><strong class="ak">基础安装(最低)</strong></h1><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="461c" class="md lg iq ne b gy ni nj l nk nl">helm install netmaker/netmaker --generate-name <br/>--set baseDomain=nm.example2.com</span></pre><p id="43c8" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">下面将安装带有用户空间WireGuard、无DNS和无入口的Netmaker。Netmaker仍然需要Ingress才能运行，并且您必须指定基本域。安装后，您必须为以下各项设置有效的入口路由:</p><p id="fed7" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">api.nm2.example.com</p><p id="8783" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">grpc.nm2.example.com</p><p id="605a" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">dashboard.nm2.example.com</p><p id="5bba" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">需要特别注意的是，gRPC路由需要http2。不同的入口控制器对使用gRPC有不同的考虑，所以请确保您了解您的提供商需要什么。</p><h1 id="cddf" class="lf lg iq bd lh li mu lk ll lm mv lo lp lq mw ls lt lu mx lw lx ly my ma mb mc bi translated">结论</h1><p id="b80d" class="pw-post-body-paragraph kf kg iq kh b ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky mt la lb lc ij bi translated">使用Helm chart安装Netmaker后，您将拥有一个高度可用的WireGuard管理服务器。服务器本身可以为您的网络执行许多功能，例如充当出口和入口网关，或者为您的节点中继流量。</p><p id="c6f3" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated">下一步，我们推荐<a class="ae le" rel="noopener ugc nofollow" target="_blank" href="/getting-started-with-netmaker-a-wireguard-virtual-networking-platform-3d563fbd87f0">Netmaker</a>入门指南。有关更多信息，请查看我们关于使用Netmaker管理WireGuard网络的其他教程:</p><p id="2666" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated"><a class="ae le" href="https://docs.netmaker.org/getting-started.html" rel="noopener ugc nofollow" target="_blank">网商文档(入门)</a></p><p id="1ae9" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated"><a class="ae le" rel="noopener ugc nofollow" target="_blank" href="/multi-cluster-kubernetes-networking-with-netmaker-bfa4e22eb2fb">多集群网络</a></p><p id="b0e6" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated"><a class="ae le" href="https://afeiszli.medium.com/how-to-enable-secure-access-to-your-hosted-services-using-netmaker-and-wireguard-1b3282d4b7aa" rel="noopener">安全地访问资源</a></p><p id="155c" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated"><a class="ae le" href="https://www.youtube.com/watch?v=krCKBJhwwDk" rel="noopener ugc nofollow" target="_blank">站点到站点/网关联网</a></p></div><div class="ab cl jy jz hu ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="ij ik il im in"><p id="4084" class="pw-post-body-paragraph kf kg iq kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ij bi translated"><strong class="kh ir">免责声明:</strong> <a class="ae le" href="https://wireguard.com/" rel="noopener ugc nofollow" target="_blank"> WireGuard </a>是Jason A. Donenfeld的注册商标。</p></div></div>    
</body>
</html>