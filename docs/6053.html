<html>
<head>
<title>Using a Smart contract in an Web Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Web应用程序中使用智能合约</h1>
<blockquote>原文：<a href="https://itnext.io/using-a-smart-contract-in-an-web-application-78432ed68527?source=collection_archive---------2-----------------------#2021-08-03">https://itnext.io/using-a-smart-contract-in-an-web-application-78432ed68527?source=collection_archive---------2-----------------------#2021-08-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/4ae80a4ff2c14b8626bd9fdf97be0072.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*beNNk4dNgWcVyjA6L7uWJg.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">珀西·博尔默拍摄的图片</figcaption></figure><p id="ffce" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">这是我们在Solidity中构建BEP20智能合约系列的第三部分。我们现在将开始在web应用程序中使用智能合约，并看看如何将合约推向生产。</p><ol class=""><li id="933e" class="lf lg it kj b kk kl ko kp ks lh kw li la lj le lk ll lm ln bi translated"><a class="ae lo" href="https://medium.com/@percybolmer1/building-a-decentralized-application-with-bep-20-contract-in-solidity-d2c066447aa6" rel="noopener"> <strong class="kj iu">【在Solidity中用BEP-20契约构建一个去中心化的应用】</strong> </a> —这篇文章将帮助你理解Solidity的基础知识</li><li id="fee4" class="lf lg it kj b kk lp ko lq ks lr kw ls la lt le lk ll lm ln bi translated"><a class="ae lo" href="https://medium.com/@percybolmer1/creating-a-inheritable-staking-contract-in-solidity-7804ae2d7a32" rel="noopener"> <strong class="kj iu">【在实体中创建可继承的赌注契约】</strong> </a> —第二篇文章，我们将介绍更高级的实体物品，并实现赌注和奖励</li><li id="efdb" class="lf lg it kj b kk lp ko lq ks lr kw ls la lt le lk ll lm ln bi translated"><strong class="kj iu">【在Web应用中使用智能合约】</strong> —本系列的第三篇文章，我们将学习如何使用元掩码通过Web应用连接到区块链</li><li id="6ee3" class="lf lg it kj b kk lp ko lq ks lr kw ls la lt le lk ll lm ln bi translated"><a class="ae lo" href="https://medium.com/@percybolmer1/deploying-smart-contracts-to-binance-smart-chain-with-truffle-c57a7d1eb6ed" rel="noopener"> <strong class="kj iu">【将智能合约部署到币安松露智能连锁店】</strong> </a> —第四篇也是最后一篇文章，我们将学习如何将智能合约部署到真实网络中</li></ol><p id="ee30" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">你可以在这里找到上一篇文章<a class="ae lo" href="https://github.com/percybolmer/DevToken/tree/stakeable" rel="noopener ugc nofollow" target="_blank">的完整代码。我们现在将更新并添加一个web应用程序，以便在网络上运行。</a></p><h2 id="684c" class="lu lv it bd lw lx ly dn lz ma mb dp mc ks md me mf kw mg mh mi la mj mk ml mm bi translated">将智能合同迁移到网络</h2><p id="f076" class="pw-post-body-paragraph kh ki it kj b kk mn km kn ko mo kq kr ks mp ku kv kw mq ky kz la mr lc ld le im bi translated">我们要做的第一件事就是把写好的智能合约迁移到网络上。我们将使用Ganache托管一个本地网络，您也可以使用真实的测试网络。迁移意味着将智能合约推送到网络上。这将花费汽油，因此将要求推送智能合同的客户具有适当的可用汽油量。</p><p id="60d9" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">我们可以使用truffle迁移到开发、测试网，甚至mainnet。请注意，mainnet将花费真正的天然气(这意味着真正的钱)。</p><p id="d8a7" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">我们稍后将介绍testnet和mainnet，现在，我们将依靠Ganache来托管网络。</p><p id="1749" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">如果你没看过前两篇文章，<a class="ae lo" href="https://medium.com/@percybolmer1/building-a-defi-application-with-bep-20-and-solidity-d2c066447aa6" rel="noopener">第一篇</a>解释了如何安装Ganache。确保你有ganache启动和运行，否则松露将失败。</p><p id="1de4" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">迁移很容易，如果您位于代码库的根目录，可以通过运行以下命令来执行。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="a9b1" class="lu lv it mx b gy nb nc l nd ne">truffle migrate</span></pre><p id="ac9a" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">输出应该显示你使用的账户，汽油费用，实际以太币费用，等等。</p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nf"><img src="../Images/4a60ab6f9645393e4bd1cba0e97c6453.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SPQ1zMTO1-lh6z2bDQIqUQ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">块菌迁移到加纳切部署网络</figcaption></figure><p id="1e7a" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">如果编译和迁移成功，您应该会看到一个名为build的新文件夹。这个文件夹将包含解释合同的JSON文件。这些文件在以后会很重要，因为JavaScript客户机使用它们来理解可用的函数。</p><h2 id="e9f5" class="lu lv it bd lw lx ly dn lz ma mb dp mc ks md me mf kw mg mh mi la mj mk ml mm bi translated">构建web应用程序</h2><p id="4071" class="pw-post-body-paragraph kh ki it kj b kk mn km kn ko mo kq kr ks mp ku kv kw mq ky kz la mr lc ld le im bi translated">在本文中，我们将使用web3-eth npm包来处理网络。</p><p id="6c72" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">我将使用react工具<a class="ae lo" href="https://reactjs.org/docs/create-a-new-react-app.html" rel="noopener ugc nofollow" target="_blank"> create-react-app </a>来生成我可以使用的模板应用程序。我将把我的应用程序命名为dapp，因为它将是一个<a class="ae lo" href="https://ethereum.org/en/dapps/" rel="noopener ugc nofollow" target="_blank">分散式应用程序</a>。我们将关注这个应用程序的功能，而不是设计。设计取决于未来的你。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="f5fb" class="lu lv it mx b gy nb nc l nd ne">create-react-app dapp</span></pre><p id="f7f4" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">我们还需要安装eth3依赖项，进入dapp应用程序并运行</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="c07c" class="lu lv it mx b gy nb nc l nd ne">npm install --save web3-eth</span></pre><p id="e1d8" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">如果您是React新手，那么您可能希望在继续之前启动应用程序，看看它正在运行什么以及它看起来如何。运行npm start并访问<a class="ae lo" href="http://localhost:3000/" rel="noopener ugc nofollow" target="_blank"> localhost:3000 </a>。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="a06c" class="lu lv it mx b gy nb nc l nd ne">npm start</span></pre><h2 id="08bb" class="lu lv it bd lw lx ly dn lz ma mb dp mc ks md me mf kw mg mh mi la mj mk ml mm bi translated">连接到区块链网络</h2><p id="080f" class="pw-post-body-paragraph kh ki it kj b kk mn km kn ko mo kq kr ks mp ku kv kw mq ky kz la mr lc ld le im bi translated">我们将在加载后开始将应用程序连接到区块链网络。</p><p id="ff4a" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">打开<strong class="kj iu"> src/App.js </strong>。</p><p id="6452" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">首先，我们需要导入Web3并使用Effect，这样我们就可以在应用程序加载时触发连接。如果你不熟悉react，<a class="ae lo" href="https://reactjs.org/docs/hooks-effect.html" rel="noopener ugc nofollow" target="_blank"> useEffect </a>是一个在函数被调用时被触发的函数，可以把它想象成一个每当你的组件被加载时都应该运行的函数。</p><p id="7bd4" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">我们将检查所使用的浏览器是否支持<a class="ae lo" href="https://web3js.readthedocs.io/en/v1.4.0/" rel="noopener ugc nofollow" target="_blank"> web3 </a>。这是与区块链网络通信所必需的，因此也是我们的智能合约所必需的。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">Defi —首先检查浏览器，使其支持web3</figcaption></figure><p id="95f7" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">重新加载网站，你应该会看到这个错误信息。</p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ni"><img src="../Images/8857bc18e94d3d0a87de8b3e08e0263f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U9-cLkMiZH0Ux1WaMGqGQw.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">defi——当没有web3支持时，我们无法运行网站。在生产中，这将重定向到一个下载页面或什么的</figcaption></figure><p id="0f01" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">让我们通过下载并安装对web3的支持来解决这个问题。我喜欢<a class="ae lo" href="https://metamask.io/" rel="noopener ugc nofollow" target="_blank"> MetaMask </a>，它是一个浏览器插件，使用起来很友好。</p><p id="f3a4" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">安装MetaMask时，它将引导您完成安装过程。我不会涵盖所有的细节，但你应该选择“创建一个钱包”，并输入一个安全的密码。确保您<strong class="kj iu">阅读了恢复短语</strong>并<strong class="kj iu">保存它</strong>。</p><p id="1b6e" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">一旦你完成了设置，你的浏览器现在应该可以和以太坊区块链对话了。</p><p id="85a1" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">重新访问localhost:3000，您现在应该会看到一条欢迎消息。</p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nj"><img src="../Images/657ac6bbfcfacace03da3806ffd601eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VKQHFQeo7Ca-nb6ck6QYiQ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp—访问网站时的当前闪屏</figcaption></figure><p id="9edb" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">现在，我们还没有完全准备好。我们只检查了浏览器是否可以运行web3。然而，有许多web3提供商，而不仅仅是MetaMask。我们现在只支持元掩码，所以让我们检查一下提供者是否是元掩码。我们将自动触发这个触发器，但是你通常有一个按钮，或者几个按钮来支持许多提供者。</p><p id="5de3" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">如果是，我们将获取在当前元掩码中找到的帐户。我们将使用web3打电话请求帐户。这将提示MetaMask插件弹出一个窗口，要求接受连接。</p><p id="489d" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">我们还将确保捕捉任何错误，以防用户拒绝或出错。在这个DApp中，我将简单地抛出一个错误，但它会向您展示如何抛出。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp —如何让用户在访问网站时连接到MetaMask</figcaption></figure><p id="65e9" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">访问该网站，MetaMask会提示您允许该网站连接。</p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nk"><img src="../Images/ffdbd6ceb45e61786d787991da0fe59d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PDPa6B-Kq_fsUgAWgva51Q.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">元掩码—允许连接权限</figcaption></figure><p id="5233" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">如果您按“取消”,您将看到一个错误，如果您接受，那么您将配置一个连接。现在我们只把账户打印到控制台上，但是我们将会改变这一点。</p><h2 id="88e6" class="lu lv it bd lw lx ly dn lz ma mb dp mc ks md me mf kw mg mh mi la mj mk ml mm bi translated">在元掩码中连接到正确的网络</h2><p id="a37b" class="pw-post-body-paragraph kh ki it kj b kk mn km kn ko mo kq kr ks mp ku kv kw mq ky kz la mr lc ld le im bi translated">既然我们已经连接到MetaMask，那么是时候看看如何连接到应该使用的网络了。</p><p id="cfb8" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">让我们首先将本地主机网络作为网络添加到元掩码中。首先打开MetaMask并选择networks下拉菜单。<br/>转到自定义RPC并输入以下值。如果你找不到，请查阅<a class="ae lo" href="https://metamask.zendesk.com/hc/en-us/articles/360043227612-How-to-add-custom-Network-RPC-and-or-Block-Explorer" rel="noopener ugc nofollow" target="_blank">官方文件</a>。</p><ul class=""><li id="533d" class="lf lg it kj b kk kl ko kp ks lh kw li la lj le nl ll lm ln bi translated">到ganache网络的URL(在我的例子中，HTTP://127.0.0.1:7545)</li><li id="9fa0" class="lf lg it kj b kk lp ko lq ks lr kw ls la lt le nl ll lm ln bi translated">链码(1337) —元掩码会告诉您它是否是其他东西</li></ul><p id="2862" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">你可以在元掩码插件的顶部看到当前使用的网络。它应该显示您刚刚添加的网络的名称，这样它才是正确的。</p><p id="30f7" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">网络也是我们发送请求的网络，但是我们也必须跟踪我们的帐户。您的MetaMask帐户上可以有多个帐户。现在我们正在使用Ganache，您可以使用一个私钥导入保存所有以太坊的已创建帐户。</p><p id="01e6" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">打开Ganache并转到帐户选项卡。在那里，您应该会在最右侧看到一个钥匙的图像。按下它显示帐户的私人密钥。复制私钥并返回元掩码插件。单击顶部的圆圈显示所有帐户，选择导入帐户，粘贴私钥，您应该有可用的Ganache测试帐户。</p><p id="030d" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">您现在只能看到以太坊，但是您可以添加我们正在开发的令牌，这样我们就可以看到该令牌的帐户余额。</p><p id="d8df" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">如果您在MetaMask中选择了正确的帐户，请选择“Assets”选项卡，然后按下大的“Add Token”按钮。它将要求您粘贴迁移的合同地址，您可以从Truffle migrate的输出中找到该地址，或者在Ganache的“合同”选项卡中找到该地址。</p><h2 id="a86f" class="lu lv it bd lw lx ly dn lz ma mb dp mc ks md me mf kw mg mh mi la mj mk ml mm bi translated">在JavaScript中连接到智能合约</h2><p id="60f4" class="pw-post-body-paragraph kh ki it kj b kk mn km kn ko mo kq kr ks mp ku kv kw mq ky kz la mr lc ld le im bi translated">现在，我们需要为智能合约创建一个客户端，为此，我们需要智能合约的地址和部署合约时生成的ABI。ABI是描述以太坊区块链智能合约的标准方式。这是您在<strong class="kj iu">构建文件夹</strong>中为DevToken准备的JSON文件。我们使用web3中的ABI来了解哪些功能可用。</p><p id="990e" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">我将创建一个名为getABI的函数，它从DevToken.json获取数据。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="0bc0" class="lu lv it mx b gy nb nc l nd ne">cp build/DevToken.json dapp/public/</span></pre><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp-getABI将从公共文件夹加载ABI</figcaption></figure><p id="62da" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">接下来，我们需要智能合约的地址，这样我们就可以连接到它。运行truffle migrate时，智能契约的地址位于它的输出中。否则，您可以在Ganache的Contracts选项卡下找到该地址。</p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/899a392197e1c7c01f62b3909ff7ef65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A2DzlpV3ewUrtA2e3sn7ng.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">Ganache —显示已部署的合同及其信息</figcaption></figure><p id="6a34" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">让我们创建一个简单的函数，将地址返回给我们。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp——这应该在生产中替换为从配置或环境中加载</figcaption></figure><p id="c390" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">如果我们将这些函数联系在一起，我们可以创建一个连接到智能合约的函数。我们导入的web3包可以使用abi JSON和地址作为输入，从ABI创建一个契约对象。</p><p id="11a4" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">我们将使用一个反应状态来分配创建的契约对象。在应用程序功能的顶部添加状态创建。通常情况下，所有状态都在函数的顶部声明，还会添加一个Set函数。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp —添加了一个状态和一个状态设置器，我们可以使用它来分配智能合约</figcaption></figure><p id="e153" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">让我们将所有这些放入一个名为connectToSelectedNetwork的函数中，该函数将为我们连接和设置devToken状态。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp —连接到合同并设置状态。</figcaption></figure><p id="a6e6" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">您还需要在效果中添加对connectToSelectedNetwork的调用，以便在加载页面时执行。</p><p id="4617" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">这是我最后的效果片段。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp —将合同连接并分配给州的使用效果</figcaption></figure><h2 id="c2a3" class="lu lv it bd lw lx ly dn lz ma mb dp mc ks md me mf kw mg mh mi la mj mk ml mm bi translated">从网页调用智能合同功能</h2><p id="3a46" class="pw-post-body-paragraph kh ki it kj b kk mn km kn ko mo kq kr ks mp ku kv kw mq ky kz la mr lc ld le im bi translated">我们终于有了合同，并把我们的账户与它挂钩。是时候开始调用调用了，看看我们能否利用区块链合约。</p><p id="8c8b" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">让我们从简单的开始，让我们抓住代币的总供应量和用户帐户余额和赌注摘要。因为我们想为来访用户显示一个配置文件。</p><p id="b9cf" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">首先，我们添加一个名为accounts的新状态，它将用于存储用户的帐户。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp—添加一个州，用于存储在connectMetaMask中检索到的帐户</figcaption></figure><p id="c7bd" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">我们将从修改connectMetaMask函数开始。在这个函数中，我们已经请求了用户帐户，我们只需要在继续之前保存它们。现在，让我们确保保存帐户，而不只是将它们打印到控制台。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp —修改connectMetaMask以在请求帐户后实际存储它们</figcaption></figure><p id="9b55" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">在继续之前，我建议在执行完<strong class="kj iu"> connectToSelectedNetwork </strong>调用后放置一个调试器。然后，您可以探索所创建的devToken契约，这有助于理解正在发生的一些事情。</p><p id="a1c6" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">在devToken对象中，我们可以看到所有可用的事件和方法。当应用程序增长并且您正在开发真实的东西时，这可能是有用的。</p><p id="26e0" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">我们将以两种不同的方式调用函数，异步调用和回调调用。所有被调用的功能都将由智能契约执行，我们不知道结果何时返回。所以处决将全部返回<a class="ae lo" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" rel="noopener ugc nofollow" target="_blank">的承诺</a>。我不会涉及细节，因为这是一个太广泛的话题，但基本上这是一种让我们在响应返回时调用函数的方法。Async意味着我们可以使用await关键字来代替，使它更容易使用，但缺点是在它完成之前会阻塞其他执行。只有在函数decleration中使用关键字Async时，才能使用Async，如下例所示。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp——等待总供给的召唤。</figcaption></figure><p id="e557" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">为了进行试验，我们将确保在devToken契约完全加载时调用getUserProfile。为了实现这一点，我们将添加另一个useEffect并订阅一个名为loaded的新状态。每当加载的状态更新时，我们将重新加载用户信息。</p><p id="c203" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">添加一个先加载的新状态调用。同样，这应该放在文件的顶部</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp —我们可以监听以触发用户更新的加载状态</figcaption></figure><p id="5a9e" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">让我们也创建一个useEffect，它将把已加载的状态作为触发器。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp —使用一个监听加载状态变化效果</figcaption></figure><p id="58d7" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">刷新并检查您的开发人员控制台，您应该看到打印的总供应量。</p><p id="ac52" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">调用函数的第二种方法是进行调用并给出一个回调函数。每当检索到响应时，都会调用该函数。使用call()方法实际上会返回一个承诺，因此我们可以使用与之前相同的模式来触发response方法。这样做的好处是不必在延迟期间阻塞所有其他执行。您将会看到我更喜欢这种模式的原因，它有更多的代码，但是当您稍后使用testnet时，您会注意到某些事务可能会花费一些时间。我将把getUserProfile改为使用回调。更改后，请确保刷新并查看它是否仍在打印耗材。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp—调用智能合约函数并使用回调而不是等待</figcaption></figure><p id="9ab7" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">我们希望呈现totalSupply令牌，因此让我们添加一个名为total supply的状态，并让getUserProfile设置供应量，而不是将其记录到控制台。我们还将更新HTML代码来呈现状态。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp —我们添加了一个新的总供给状态</figcaption></figure><p id="87a2" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">将getUserProfile中的console.log更改为调用totalSupply的setter。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp-更新了GetuserInfo以在状态中存储结果</figcaption></figure><p id="24cd" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">让我们更新从App函数返回的内容，以便在标题中呈现供应。在一个功能性的react应用程序中，你可以在html中使用{}来引用状态。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp-呈现总供应状态</figcaption></figure><p id="20fb" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">好了，现在我们知道如何调用一个函数来检索信息。在查看交易之前，我们还要添加当前帐户余额和可用的赌注。</p><p id="805b" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">从我们需要的两个新状态开始。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp——我们的用户资料中新增了两个州</figcaption></figure><p id="bf19" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">接下来，我们将更新HTML来呈现新的状态。我们现在只将赌注打印到控制台日志中。我们还会花时间为将来的赌注添加一个按钮，它现在不会工作。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp —添加要呈现的用户帐户信息</figcaption></figure><p id="26bd" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">现在，我们将更新getUserProfile，以获取所有需要的数据。因为每个请求看起来基本上都一样，而且我是<strong class="kj iu"> DRY的忠实支持者，</strong>我们将创建一个助手函数，它将请求作为参数执行。它还将接受应用于响应的回调，以及应该传递给区块链的最终参数。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp——使用一个叫做call的简单助手功能收集所有需要的用户数据</figcaption></figure><p id="ecc0" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">重新加载网站，并确保其正常工作。</p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nm"><img src="../Images/4cd021f8c5b6194d82967e55148f276f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WUe6xKUsSnty8JBPZ1YM2w.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp-当前用户配置文件。</figcaption></figure><h2 id="59b7" class="lu lv it bd lw lx ly dn lz ma mb dp mc ks md me mf kw mg mh mi la mj mk ml mm bi translated">触发合同上的交易记录</h2><p id="b596" class="pw-post-body-paragraph kh ki it kj b kk mn km kn ko mo kq kr ks mp ku kv kw mq ky kz la mr lc ld le im bi translated">让我们尝试实现一个赌注按钮，我们不会做一个花哨的渲染或UI，而是一个简单的按钮，当按下时，赌注1000个令牌。</p><p id="898f" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">现在，我们将实现stake函数，这将是一个硬编码的请求，用于在当前帐户上下注1000个令牌。</p><p id="003a" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">您会注意到，我们现在将使用另一种方式来调用智能合约，原因一开始可能不是非常清楚。但是每当我们触发一个不改变区块链、视图修改器等状态的函数时，我们应该使用<strong class="kj iu">调用</strong>。当我们触发新的事务并修改状态时，我们应该使用<strong class="kj iu"> send。</strong>这里可以阅读更深入的解释<a class="ae lo" href="https://bitsofco.de/calling-smart-contract-functions-using-web3-js-call-vs-send/" rel="noopener ugc nofollow" target="_blank">。还有一点必须知道的是，每笔交易都要花汽油费。Web3提供了一个很好的方法来估算燃气成本，我们可以在触发请求之前使用这个方法。</a></p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp——估算天然气成本，然后发送股份交易</figcaption></figure><p id="6f01" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">重新加载网站并按下赌注按钮，如果你有0个代币，请确保从ganache导入一个帐户并切换到该帐户。当您按下Stake按钮时，您应该会从MetaMask获得一个弹出窗口，其中包含有关交易的信息以及一个拒绝或确认按钮。按确认并等待它完成。</p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nn"><img src="../Images/353e569fcdc14b901b2bb24d95a8156d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QZTU7oRC_ae4mQguOPQczg.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp——meta mask的股权交易</figcaption></figure><p id="fe2a" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">如果你想了解更多信息，你也可以在Ganache查看交易。转到ganache中的“transactions”窗口，找到您的交易，然后按它进入详细信息窗格。</p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi no"><img src="../Images/5112f5d0c2f190d4fb4d8c05c4b53b36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VPxbjU_2RlBU82E3woLIDw.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">Ganache —交易概述。</figcaption></figure><p id="5f17" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">如果您进入事务的细节，您可以看到它是什么方法和它触发的事件。这很重要，因为它将引导我们进入下一个主题，记得我说过事件纯粹是为了登录的可靠性吗？这里有一个额外的好东西，我们可以订阅事件。让我们这样做，以便我们可以正确地更新帐户余额时，股权已被接受。</p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi np"><img src="../Images/de91adee3a97d920e641d5f36e5daa31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K6QFZEmO0IEO1UMSJAYCMA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">Ganache —事务细节向我们展示了事件</figcaption></figure><p id="828f" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">太好了，现在我们知道如何使用事务了。随意尝试添加一些其他交易，如津贴或帐户之间的简单转移。</p><h2 id="412a" class="lu lv it bd lw lx ly dn lz ma mb dp mc ks md me mf kw mg mh mi la mj mk ml mm bi translated">订阅区块链的活动</h2><p id="d2cd" class="pw-post-body-paragraph kh ki it kj b kk mn km kn ko mo kq kr ks mp ku kv kw mq ky kz la mr lc ld le im bi translated">让我们来看看如何订阅某些事件，以便收听并据此采取行动。</p><p id="6819" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">我们通过读取ABI创建的契约实际上包含了Events字段中的所有可用事件。因此，要订阅，我们只需接受该事件，并在一些可用的主题上注册听众。我们将加载用户概要文件。</p><p id="decc" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">从<a class="ae lo" href="https://web3js.readthedocs.io/en/v1.2.11/web3-eth-subscribe.html" rel="noopener ugc nofollow" target="_blank">文档</a>中可以找到4个主题</p><blockquote class="nq nr ns"><p id="98cd" class="kh ki nt kj b kk kl km kn ko kp kq kr nu kt ku kv nv kx ky kz nw lb lc ld le im bi translated"><code class="fe nx ny nz mx b">on("data")</code>返回<code class="fe nx ny nz mx b">Object</code>:对每个传入的日志触发，将日志对象作为参数。</p><p id="2faa" class="kh ki nt kj b kk kl km kn ko kp kq kr nu kt ku kv nv kx ky kz nw lb lc ld le im bi translated"><code class="fe nx ny nz mx b">on("changed")</code>返回<code class="fe nx ny nz mx b">Object</code>:在从区块链移走的每根原木上触发。日志会有一个额外的属性<code class="fe nx ny nz mx b">"removed: true"</code>。</p><p id="2cda" class="kh ki nt kj b kk kl km kn ko kp kq kr nu kt ku kv nv kx ky kz nw lb lc ld le im bi translated"><code class="fe nx ny nz mx b">on("error")</code>返回<code class="fe nx ny nz mx b">Object</code>:当订阅发生错误时触发。</p><p id="d521" class="kh ki nt kj b kk kl km kn ko kp kq kr nu kt ku kv nv kx ky kz nw lb lc ld le im bi translated"><code class="fe nx ny nz mx b">on("connected")</code>返回<code class="fe nx ny nz mx b">String</code>:订阅成功连接后触发一次。返回订阅id。</p></blockquote><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">DApp —注册Staked事件的听众</figcaption></figure><p id="e56a" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">倾听事件并不比这更难。不过要确保你的过滤是正确的。尝试压注一次，并在控制台上查看结果。</p><h2 id="14e8" class="lu lv it bd lw lx ly dn lz ma mb dp mc ks md me mf kw mg mh mi la mj mk ml mm bi translated">结论</h2><p id="c76d" class="pw-post-body-paragraph kh ki it kj b kk mn km kn ko mo kq kr ks mp ku kv kw mq ky kz la mr lc ld le im bi translated">第三篇到此结束。本系列还有一篇文章，你可以在我的<a class="ae lo" href="https://github.com/percybolmer/DevToken/tree/dapp" rel="noopener ugc nofollow" target="_blank">库</a>的DApp分支中找到完整的代码。</p><p id="5ff7" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">在这一部分中，我们讨论了以下主题</p><ul class=""><li id="6d2f" class="lf lg it kj b kk kl ko kp ks lh kw li la lj le nl ll lm ln bi translated">React应用程序的设置</li><li id="a598" class="lf lg it kj b kk lp ko lq ks lr kw ls la lt le nl ll lm ln bi translated">了解如何连接元掩码</li><li id="e5aa" class="lf lg it kj b kk lp ko lq ks lr kw ls la lt le nl ll lm ln bi translated">如何调用和发送交易</li><li id="9424" class="lf lg it kj b kk lp ko lq ks lr kw ls la lt le nl ll lm ln bi translated">收听某些事件</li></ul><p id="bb9a" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">下一篇文章将介绍如何部署到币安测试网络和主网络。</p><p id="794f" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">我希望你喜欢它，如果有任何问题，请随时联系我们。</p></div></div>    
</body>
</html>