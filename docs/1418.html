<html>
<head>
<title>How to handle the POST request body in Dart without using a framework</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在不使用框架的情况下处理Dart中的POST请求主体</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-handle-the-post-request-body-in-dart-without-using-a-framework-c56f12744fd2?source=collection_archive---------3-----------------------#2018-10-10">https://itnext.io/how-to-handle-the-post-request-body-in-dart-without-using-a-framework-c56f12744fd2?source=collection_archive---------3-----------------------#2018-10-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4b9d" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">了解如何处理对服务器的POST请求</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/e81f018e5938c25ebe4a35e9c28e210a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DdEaYGpfvt63a3eyrJ6-HQ.png"/></div></div></figure><p id="5691" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在这篇与几个月前我在Node.js上写的文章相关的文章中，我将展示我们如何在Dart中处理POST请求的有效负载。这里假设这个有效负载的<code class="fe lo lp lq lr b">Content-Type</code>是<code class="fe lo lp lq lr b">application/x-www-form-urlencoded</code>，它本质上描述了格式化为查询字符串的数据。</p><h1 id="a736" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">1.创建我们的服务器</h1><p id="6378" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">创建一个<code class="fe lo lp lq lr b">main.dart</code>文件，并输入下面的代码片段:</p><pre class="kg kh ki kj gt mp lr mq mr aw ms bi"><span id="059f" class="mt lt iq lr b gy mu mv l mw mx"><strong class="lr ir">import 'dart:io'</strong>;</span><span id="ca05" class="mt lt iq lr b gy my mv l mw mx">void <strong class="lr ir">main</strong>() <strong class="lr ir">async</strong> {<br/>  var <strong class="lr ir">server</strong> = <strong class="lr ir">await HttpServer.bind</strong>('localhost', 9000);</span><span id="71d2" class="mt lt iq lr b gy my mv l mw mx">  <strong class="lr ir">await for (HttpRequest req in server) {</strong><br/>    <strong class="lr ir">req.response</strong><br/>      ..<strong class="lr ir">headers.set</strong>('Content-Type', 'text/html')<br/>      ..<strong class="lr ir">write</strong>('''<br/>        &lt;!doctype html&gt;<br/>        &lt;html&gt;<br/>        &lt;body&gt;<br/>          &lt;form action="/" method="post"&gt;<br/>            &lt;input type="text" name="fname" /&gt;&lt;br /&gt;<br/>            &lt;input type="number" name="age" /&gt;&lt;br /&gt;<br/>            &lt;input type="file" name="photo" /&gt;&lt;br /&gt;<br/>            &lt;button&gt;Save&lt;/button&gt;<br/>          &lt;/form&gt;<br/>        &lt;/body&gt;<br/>        &lt;/html&gt;<br/>      ''')<br/>      ..<strong class="lr ir">close()</strong>;<br/>  <strong class="lr ir">}<br/></strong>}</span></pre><p id="289b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这将引导我们的服务器，并在向<code class="fe lo lp lq lr b">http://localhost:9000</code>发出请求时用一个表单进行响应。该代码片段从导入<code class="fe lo lp lq lr b">dart:io</code>库开始，因为它包含了创建服务器所需的类。整个引导过程发生在一个<code class="fe lo lp lq lr b">main()</code>函数中，运行我们的Dart应用程序需要这个函数。</p><p id="2e74" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">要运行该文件，请在终端中键入以下命令:</p><pre class="kg kh ki kj gt mp lr mq mr aw ms bi"><span id="df26" class="mt lt iq lr b gy mu mv l mw mx">dart main.dart</span></pre><p id="57eb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您应该会在浏览器中看到一个表单:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mz"><img src="../Images/76a8b293e600ee61302080bfb2088b4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P_LvxhXS4JcmEzefXvy_lw.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">在http://localhost:9000提供的html</figcaption></figure><h1 id="9940" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">2.捕获发布的有效负载</h1><p id="96f8" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">现在让我们确保我们正在处理一个POST请求:</p><pre class="kg kh ki kj gt mp lr mq mr aw ms bi"><span id="4644" class="mt lt iq lr b gy mu mv l mw mx">...<br/>...</span><span id="580f" class="mt lt iq lr b gy my mv l mw mx">await for (HttpRequest req in server) {<br/>  <strong class="lr ir">if (req.method == 'POST') {</strong><br/>   <strong class="lr ir">// deal with the payload</strong>  <br/>  <strong class="lr ir">} else {</strong><br/>    req.response<br/>      ..headers.set('Content-Type', 'text/html')<br/>      ..write('''<br/>        &lt;!doctype html&gt;<br/>        &lt;html&gt;<br/>        &lt;body&gt;<br/>          &lt;form action="/" method="post"&gt;<br/>            &lt;input type="text" name="fname" /&gt;&lt;br /&gt;<br/>            &lt;input type="number" name="age" /&gt;&lt;br /&gt;<br/>            &lt;input type="file" name="photo" /&gt;&lt;br /&gt;<br/>            &lt;button&gt;Save&lt;/button&gt;<br/>          &lt;/form&gt;<br/>        &lt;/body&gt;<br/>        &lt;/html&gt;<br/>      ''')<br/>      ..close();<br/>  <strong class="lr ir">}</strong><br/>}</span></pre><p id="1c4c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">对服务器的请求被视为一个<code class="fe lo lp lq lr b">Stream</code>，这意味着我们可以使用请求的<code class="fe lo lp lq lr b">transform</code>方法来解码内容。</p><pre class="kg kh ki kj gt mp lr mq mr aw ms bi"><span id="3488" class="mt lt iq lr b gy mu mv l mw mx">if (req.method == 'POST') {<br/>  var content = <strong class="lr ir">await req.transform().join()</strong>;<br/>} ...</span></pre><p id="b2e4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这不会马上生效，因为<code class="fe lo lp lq lr b">transform</code>方法需要一个<code class="fe lo lp lq lr b">StreamTransformer</code>。一个<code class="fe lo lp lq lr b">StreamTransformer</code>包含一个<code class="fe lo lp lq lr b">bind</code>方法，允许它以某种方式操作流数据。我们需要一个来将我们的流数据转换成可读的格式，然后使用<code class="fe lo lp lq lr b">join</code>方法来组合我们的<em class="ne">转换后的</em>块。</p><p id="2f68" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在我们的<code class="fe lo lp lq lr b">dart:io</code>导入下，我们需要<code class="fe lo lp lq lr b">dart:convert</code>库:</p><pre class="kg kh ki kj gt mp lr mq mr aw ms bi"><span id="0a87" class="mt lt iq lr b gy mu mv l mw mx">import 'dart:io';<br/><strong class="lr ir">import 'dart:convert';</strong></span></pre><p id="9aba" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">并将<code class="fe lo lp lq lr b">Utf8Decoder</code>用作我们的变压器:</p><pre class="kg kh ki kj gt mp lr mq mr aw ms bi"><span id="a573" class="mt lt iq lr b gy mu mv l mw mx">var content = await req.transform(<strong class="lr ir">Utf8Decoder()</strong>).join();</span></pre><p id="ab15" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果您在表格中填写了相关的详细信息，打印出的<code class="fe lo lp lq lr b">content</code>将会给出以下结果:</p><pre class="kg kh ki kj gt mp lr mq mr aw ms bi"><span id="43b8" class="mt lt iq lr b gy mu mv l mw mx">fname<strong class="lr ir">=</strong>John<strong class="lr ir">&amp;</strong>age=30<strong class="lr ir">&amp;</strong>photo<strong class="lr ir">=</strong>file.jpg</span></pre><p id="85c4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然而，我们仍然需要从查询字符串中提取信息的键/值对。幸运的是，我们在核心Dart SDK中有一个<code class="fe lo lp lq lr b">Uri</code>类:</p><pre class="kg kh ki kj gt mp lr mq mr aw ms bi"><span id="7f6f" class="mt lt iq lr b gy mu mv l mw mx">var content = await req.transform(Utf8Decoder()).join();<br/>var queryParams = <strong class="lr ir">Uri(query: content).queryParameters</strong>;</span></pre><h1 id="e33b" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">3.回复帖子</h1><p id="66de" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">现在让我们发回一个响应:</p><pre class="kg kh ki kj gt mp lr mq mr aw ms bi"><span id="bb58" class="mt lt iq lr b gy mu mv l mw mx">var content = await req.transform(Utf8Decoder()).join();<br/>var queryParams = Uri(query: content).queryParameters;</span><span id="b6b6" class="mt lt iq lr b gy my mv l mw mx"><strong class="lr ir">req.response<br/>  ..write('Parsed data belonging to ${queryParams['fname']}')<br/>  ..close();</strong></span></pre><p id="832f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">更新20/10/2018</strong>:<a class="nf ng ep" href="https://medium.com/u/fc8b5cd1b260?source=post_page-----c56f12744fd2--------------------------------" rel="noopener" target="_blank">to be O</a>(<em class="ne">创建者</em> <a class="ae ln" href="https://github.com/angel-dart/angel" rel="noopener ugc nofollow" target="_blank"> <em class="ne">天使</em> </a>)有用的指出了使用<code class="fe lo lp lq lr b">splitQueryString</code>静态方法提取查询参数:</p><pre class="kg kh ki kj gt mp lr mq mr aw ms bi"><span id="78c1" class="mt lt iq lr b gy mu mv l mw mx">// var queryParams = Uri(query: content).queryParameters;<br/><strong class="lr ir">var queryParams = Uri.splitQueryString(content);</strong></span></pre><p id="81d1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们的查询参数作为一个<code class="fe lo lp lq lr b">Map</code>对象返回，允许我们像这样提取我们的值:</p><pre class="kg kh ki kj gt mp lr mq mr aw ms bi"><span id="2ef0" class="mt lt iq lr b gy mu mv l mw mx">queryParams['fname'];<br/>queryParams['age'];<br/>queryParams['photo'];</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nh"><img src="../Images/a2a0562c461b2308ca6a4ceef031676b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N46Xjfd8VD9NDTcNSs5W7A.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">我们发布请求的响应</figcaption></figure><p id="2aef" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">以下是完整的解决方案:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">完成的代码🎯</figcaption></figure><h1 id="bb04" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">最后…</h1><p id="ea7b" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">与相关的文章一样，如果有效负载内容类型是<code class="fe lo lp lq lr b">application/x-www-form-urlencoded</code>，这种方法是可行的，如果解析其他内容类型，则需要不同的方法。我们将在以后的文章中讨论这个问题。</p><p id="dbfc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">订阅</strong><a class="ae ln" href="https://www.youtube.com/channel/UCHSRZk4k6e-hqIXBBM4b2iA?view_as=subscriber" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir">Youtube频道</strong> </a> <strong class="kt ir">了解Dart </strong>上即将推出的视频。谢谢！</p><p id="a907" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">喜欢，分享，关注我</strong>😍有关Dart的更多内容。</p></div><div class="ab cl nk nl hu nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ij ik il im in"><h1 id="ea81" class="ls lt iq bd lu lv nr lx ly lz ns mb mc jw nt jx me jz nu ka mg kc nv kd mi mj bi translated">进一步阅读</h1><ol class=""><li id="048a" class="nw nx iq kt b ku mk kx ml la ny le nz li oa lm ob oc od oe bi translated"><a class="ae ln" href="https://www.dartlang.org/tutorials/dart-vm/httpserver#run-the-hello-world-server" rel="noopener ugc nofollow" target="_blank">Dart中的Hello world服务器</a></li><li id="c6a3" class="nw nx iq kt b ku of kx og la oh le oi li oj lm ob oc od oe bi translated"><a class="ae ln" href="https://www.dartlang.org/articles/libraries/creating-streams" rel="noopener ugc nofollow" target="_blank">在Dart中创建流</a></li><li id="9910" class="nw nx iq kt b ku of kx og la oh le oi li oj lm ob oc od oe bi translated"><a class="ae ln" href="https://egghead.io/instructors/jermaine-oppong" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir">egghead . io上的免费飞镖截屏</strong> </a></li></ol></div></div>    
</body>
</html>