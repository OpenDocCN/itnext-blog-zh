<html>
<head>
<title>Kubernetes: Authentication and Authorization</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes:认证和授权</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-authentication-and-authorization-afce3c464e94?source=collection_archive---------3-----------------------#2020-11-29">https://itnext.io/kubernetes-authentication-and-authorization-afce3c464e94?source=collection_archive---------3-----------------------#2020-11-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/0159344bb1e1e4245b66a1c65c966218.png" data-original-src="https://miro.medium.com/v2/resize:fit:1238/format:webp/0*jCLgWQbZIm-IPUfD.png"/></div></figure><h2 id="bc05" class="ju jv iq bd jw jx jy dn jz ka kb dp kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">介绍</h2><p id="bed3" class="pw-post-body-paragraph kq kr iq ks b kt ku kv kw kx ky kz la kd lb lc ld kh le lf lg kl lh li lj lk ij bi translated">在本文中，我们将探讨kubernetes中的身份验证和授权是如何工作的。</p><p id="114f" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">但是首先有什么区别呢？</p><p id="46e2" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated"><strong class="ks ir">认证</strong>:</p><p id="1eda" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">当您根据服务或系统验证您的身份时，您就通过了身份验证，这意味着系统会将您识别为有效用户。在kubernetes中，当您创建集群时，基本上是创建一个CA (Certificate Authority ),然后使用它为所有组件和用户生成证书。</p><p id="8262" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated"><strong class="ks ir">授权</strong>:</p><p id="6938" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">在你被认证之后，系统需要知道你是否有足够的特权去做你想做的任何事情。在kubernetes中，这被称为RBAC(基于角色的访问控制),它将角色转换为具有权限的实体，并在给定的名称空间范围内通过角色绑定与服务帐户相关联，否则您可以拥有集群角色和集群角色绑定。</p><p id="ce5c" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">因此，我们将创建一个名称空间、一个服务帐户、一个角色和一个角色绑定，然后为它生成一个kubeconfig，然后测试它。</p><p id="5f3a" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">这篇文章的来源可以在:<a class="ae lq" href="https://github.com/kainlite/rbac-example" rel="noopener ugc nofollow" target="_blank"> RBAC例子</a>找到</p><h2 id="a5d7" class="ju jv iq bd jw jx jy dn jz ka kb dp kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">让我们开始吧</h2><p id="ba82" class="pw-post-body-paragraph kq kr iq ks b kt ku kv kw kx ky kz la kd lb lc ld kh le lf lg kl lh li lj lk ij bi translated">让我们开始，我将使用这些生成器，但我将它们保存到一个文件中，然后应用。</p><p id="20dd" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated"><strong class="ks ir">名称空间</strong></p><p id="bd0b" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">命名空间资源类似于其他资源的容器，在将许多应用程序部署到同一个集群或有多个用户时，它通常很有用:</p><figure class="lr ls lt lu gt jr"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="e9ea" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">你可以在这里看到更多<a class="ae lq" href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/" rel="noopener ugc nofollow" target="_blank"/></p><p id="a754" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated"><strong class="ks ir">服务账户</strong></p><p id="1048" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">服务帐户是您作为系统一部分的身份，用户帐户与服务帐户有一些重要的区别，例如:</p><ul class=""><li id="c533" class="lx ly iq ks b kt ll kx lm kd lz kh ma kl mb lk mc md me mf bi translated">用户账户是给人类的。服务帐户用于在pod中运行的流程。</li><li id="83c0" class="lx ly iq ks b kt mg kx mh kd mi kh mj kl mk lk mc md me mf bi translated">用户帐户应该是全局的。名称在群集的所有命名空间中必须是唯一的。服务帐户是有名称空间的。在本例中，我们为一个pod生成一个serviceaccount，并为我们生成一个用户帐户，以便与kubectl一起使用(如果我们想要一个全局用户，我们应该使用clusterrole和clusterrolebinding)。</li></ul><figure class="lr ls lt lu gt jr"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="c079" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">你可以在这里看到更多<a class="ae lq" href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/" rel="noopener ugc nofollow" target="_blank"/></p><p id="0a48" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated"><strong class="ks ir">角色</strong></p><p id="e959" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">该角色具有类似管理员的权限，允许的动词是，我们使用*表示所有，以防您对<a class="ae lq" href="https://kubernetes.io/docs/concepts/overview/kubernetes-api/#api-groups" rel="noopener ugc nofollow" target="_blank">API组</a>有疑问，更多信息请参见<a class="ae lq" href="https://kubernetes.io/docs/concepts/overview/kubernetes-api/#api-groups" rel="noopener ugc nofollow" target="_blank">文档</a>:</p><figure class="lr ls lt lu gt jr"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="61b6" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">你可以看到更多的<a class="ae lq" href="https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb" rel="noopener ugc nofollow" target="_blank">这里</a>和<a class="ae lq" href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#clusterrole-example" rel="noopener ugc nofollow" target="_blank">这里</a></p><p id="c786" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated"><strong class="ks ir">角色绑定</strong></p><p id="9052" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">这是将角色中的权限赋予我们创建的服务帐户的粘合剂。</p><figure class="lr ls lt lu gt jr"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="90d5" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">你可以在这里看到更多<a class="ae lq" href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#clusterrolebinding-example" rel="noopener ugc nofollow" target="_blank"/></p><p id="ce98" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated"><strong class="ks ir">示例pod </strong></p><p id="341d" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">在这里，我们用curl创建一个样本pod，并给它一个服务帐户<code class="fe ml mm mn mo b">--serviceaccount</code></p><figure class="lr ls lt lu gt jr"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="82ce" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated"><strong class="ks ir">申请</strong></p><p id="0324" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">在这里，我们创建所有资源</p><figure class="lr ls lt lu gt jr"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="1036" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated"><strong class="ks ir">从pod验证</strong></p><p id="ac90" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">在这里，我们将导出服务帐户的令牌，并查询kubernetes API。注意，为了能够访问kubernetes服务，因为它在不同的名称空间中，我们需要用<code class="fe ml mm mn mo b">.default</code>来指定它(因为它在默认的名称空间中)，尝试:<code class="fe ml mm mn mo b">kubectl get svc -A</code>来查看所有服务。</p><figure class="lr ls lt lu gt jr"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="7edd" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">我们的pod一切顺利，我们可以从我们的pod与API通信，让我们看看它是否也适用于kubectl。</p><p id="8dc7" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated"><strong class="ks ir">生成库对象配置</strong></p><p id="8b65" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">获取令牌(如你所见，它被保存为kubernetes的秘密，所以它像任何其他秘密一样被安装到pods，但自动感谢服务帐户)</p><figure class="lr ls lt lu gt jr"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="461e" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">注意:我使用了<code class="fe ml mm mn mo b">kubectl config view</code>来发现种类端点，在我的例子中是<code class="fe ml mm mn mo b">server: https://127.0.0.1:35617</code>，然后替换CA的秘密值和服务帐户令牌/秘密值，还要注意使用<code class="fe ml mm mn mo b">kubectl get -o yaml</code>时需要从base64解码，还要注意当我们试图在名称空间之外做事情时会出错，因为我们没有权限， 这是向用户授予权限的一种非常有效的方式，这是因为我们为额外的用户和pod服务帐户创建了角色绑定(连接时要小心)。</p><p id="fd04" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">这里可以看到更多<a class="ae lq" href="http://docs.shippable.com/deploy/tutorial/create-kubeconfig-for-self-hosted-kubernetes-cluster/" rel="noopener ugc nofollow" target="_blank">，这里</a>可以看到更多<a class="ae lq" href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/" rel="noopener ugc nofollow" target="_blank"/></p><h2 id="85e7" class="ju jv iq bd jw jx jy dn jz ka kb dp kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">打扫</h2><p id="4e92" class="pw-post-body-paragraph kq kr iq ks b kt ku kv kw kx ky kz la kd lb lc ld kh le lf lg kl lh li lj lk ij bi translated">永远记得清理你的本地机器/集群/等等，在我的情况下<code class="fe ml mm mn mo b">kind delete cluster</code>会这样做。</p><h1 id="46e6" class="mp jv iq bd jw mq mr ms jz mt mu mv kc mw mx my kg mz na nb kk nc nd ne ko nf bi translated">正误表</h1><p id="f09c" class="pw-post-body-paragraph kq kr iq ks b kt ku kv kw kx ky kz la kd lb lc ld kh le lf lg kl lh li lj lk ij bi translated">如果您发现任何错误或有任何建议，请给我发消息，以便解决问题。</p><p id="f84c" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">此外，您可以在这里检查源代码和<a class="ae lq" href="https://github.com/kainlite/kainlite.github.io" rel="noopener ugc nofollow" target="_blank">生成代码</a>和<a class="ae lq" href="https://github.com/kainlite/blog" rel="noopener ugc nofollow" target="_blank">源代码的变化</a></p></div><div class="ab cl ng nh hu ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="ij ik il im in"><p id="92e0" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated"><em class="nn">原载于2020年11月29日</em><a class="ae lq" href="https://techsquad.rocks/blog/kubernetes_authentication_and_authorization/" rel="noopener ugc nofollow" target="_blank"><em class="nn">https://tech squad . rocks</em></a><em class="nn">。</em></p></div></div>    
</body>
</html>