<html>
<head>
<title>How to expose your Kubernetes Dashboard with cert-manager</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用证书管理器显示您的Kubernetes仪表板</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-expose-your-kubernetes-dashboard-with-cert-manager-422ab1e3bf30?source=collection_archive---------0-----------------------#2018-05-08">https://itnext.io/how-to-expose-your-kubernetes-dashboard-with-cert-manager-422ab1e3bf30?source=collection_archive---------0-----------------------#2018-05-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="82ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以<a class="ae kl" href="https://github.com/jetstack/kube-lego#kube-lego" rel="noopener ugc nofollow" target="_blank"> kube-lego </a>已经死了，如果你在你的Kubernetes集群上使用<a class="ae kl" href="https://www.helm.sh/" rel="noopener ugc nofollow" target="_blank">包管理器</a>(你应该这样做)，你现在除了使用cert-manager别无选择。</p><p id="1228" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为一种商品，我真的很喜欢将Kubernetes仪表板暴露给公众，通过简单的基本认证来保护，我还没有找到如何在1-2-3步指南中完成这一点。</p><p id="5054" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以，在这里！</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="2ee8" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">证书颁发者</h1><p id="e65f" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">假设您的集群已经有<a class="ae kl" href="https://github.com/jetstack/cert-manager" rel="noopener ugc nofollow" target="_blank"> cert-manager </a>和<a class="ae kl" href="https://github.com/kubernetes/ingress-nginx" rel="noopener ugc nofollow" target="_blank"> nginx-ingress </a>在工作，您的下一步将是设置<a class="ae kl" href="http://docs.cert-manager.io/en/latest/reference/issuers.html" rel="noopener ugc nofollow" target="_blank"> Issuer </a>或<a class="ae kl" href="http://docs.cert-manager.io/en/latest/reference/clusterissuers.html" rel="noopener ugc nofollow" target="_blank"> ClusterIssuer </a></p><p id="cf99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将设置一个临时ClusterIssuer:</p><p id="776c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> letsencrypt-stg.yaml </strong></p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="f577" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个ClusterIssuer假设您已经在<strong class="jp ir"> kube-system </strong>名称空间中安装了nginx-ingress和cert-manager，如果不是这样，您应该更改<strong class="jp ir">名称空间</strong>元数据。</p><p id="722e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">来申请吧:<code class="fe md me mf mg b">kubectl apply -f letsencrypt-stg.yaml</code></p><p id="e6c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以检查我们创建的ClusterIssuer <code class="fe md me mf mg b">kubectl -n kube-system describe clusterissuer letsencrypt-stg</code></p><h1 id="86d2" class="kt ku iq bd kv kw mh ky kz la mi lc ld le mj lg lh li mk lk ll lm ml lo lp lq bi translated">证书的显式创建</h1><p id="52c6" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">对于通过cert-manager公开的大多数服务，您可以使用<a class="ae kl" href="http://docs.cert-manager.io/en/latest/reference/ingress-shim.html" rel="noopener ugc nofollow" target="_blank">ingress-shim</a><a class="ae kl" href="http://docs.cert-manager.io/en/latest/reference/ingress-shim.html#supported-annotations" rel="noopener ugc nofollow" target="_blank">annotations</a>，但是Kubernetes仪表板通常只在HTTPS上公开，这会干扰证书的自动生成。</p><p id="2bc7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么，让我们使用一个显式证书</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="7b8c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建证书:<code class="fe md me mf mg b">kubectl apply -f kubernetes-dashboard-stg.yaml</code></p><p id="9aa6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">检查您新创建的资源:<code class="fe md me mf mg b">kubectl -n kube-system describe certificates kubernetes-dashboard-stg</code></p><p id="fe9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此时我们应该检查我们的证书的创建:<code class="fe md me mf mg b">kubectl -n kube-system describe certificate kubernetes-dashboard-stg</code></p><p id="7fa8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你应该看到这样的东西:</p><pre class="lw lx ly lz gt mm mg mn mo aw mp bi"><span id="f9ae" class="mq ku iq mg b gy mr ms l mt mu">Reason               Message<br/>------               -------<br/>PrepareCertificate   Preparing certificate with issuer<br/>PresentChallenge     Presenting http-01 challenge for domain your.awesome.host<br/>SelfCheck            Performing self-check for domain your.awesome.host<br/>ObtainAuthorization  Obtained authorization for domain your.awesome.host<br/>IssueCertificate     Issuing certificate...<br/>CeritifcateIssued    Certificated issued successfully<br/>RenewalScheduled     Certificate scheduled for renewal in 1438 hours</span></pre><p id="2389" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用以下嵌套命令，还可以通过查看您的证书管理器窗格来跟踪证书创建:</p><pre class="lw lx ly lz gt mm mg mn mo aw mp bi"><span id="42f1" class="mq ku iq mg b gy mr ms l mt mu">kubectl -n kube-system logs -f $(kubectl -n kube-system get pods -l app=cert-manager -o jsonpath="{.items[0].metadata.name}") cert-manager</span></pre><p id="dd88" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您应该会看到类似这样的内容:</p><pre class="lw lx ly lz gt mm mg mn mo aw mp bi"><span id="4913" class="mq ku iq mg b gy mr ms l mt mu">Setting lastTransitionTime for Certificate "kubernetes-dashboard-stg" condition "Ready"<br/>Certificated issued successfully<br/>Certificate scheduled for renewal in 1438 hours<br/>certificates controller: Finished processing work item "kube-system/kubernetes-dashboard-stg"<br/>certificates controller: syncing item 'kube-system/kubernetes-dashboard-stg'<br/>Certificate scheduled for renewal in 1438 hours<br/>certificates controller: Finished processing work item "kube-system/kubernetes-dashboard-stg"</span></pre><h1 id="c797" class="kt ku iq bd kv kw mh ky kz la mi lc ld le mj lg lh li mk lk ll lm ml lo lp lq bi translated">入口本身的创建</h1><p id="366c" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">最后，我们的系统只缺少一个入口来启动一切。</p><p id="2797" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">仪表板的工作入口应该是这样的:</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="e375" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种配置中一些值得注意的关键点:</p><p id="b2c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> secretName </strong>必须是上面的证书中指定的那个，因为这两个资源之间没有自动绑定。</p><p id="1317" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">kubernetes.io/ingress.class指定使用哪种负载均衡器，如果你使用GKE或裸机实例，<code class="fe md me mf mg b">nginx </code>是你想要的值。</p><p id="c48d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">nginx.ingress.kubernetes.io/ssl-redirect</strong>指示NGINX将HTTP流量重定向到HTTPS，您的kubernetes仪表板将没有<strong class="jp ir">HTTP版本，因为仪表板本身由HTTPS提供服务。</strong></p><p id="25f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">nginx.ingress.kubernetes.io/secure-backends</strong>明确指出仪表板只在HTTPS提供服务，所以不要期待HTTP响应，而是HTTPS响应。</p><p id="9b5a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/annotations.md" rel="noopener ugc nofollow" target="_blank">商品:nginx-ingress注释的完整引用</a></p><p id="8d90" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此时，导航到<a class="ae kl" href="https://your.awesome.host" rel="noopener ugc nofollow" target="_blank">https://your . awesome . host</a>应该会显示如下内容:</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/de2345e3b1b942fc00e998e4c07bf0d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/format:webp/1*Uu1noZM4FPEepakSaFJiRA.png"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">这看起来像是Chrome上的临时Letsencrypt证书，看起来不太成功。但事实如此。</figcaption></figure><p id="2f84" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们正确地完成了这一步，我们基本上已经成功了，现在我们只需要复制我们的所有资源用于生产部署。</p><h1 id="637a" class="kt ku iq bd kv kw mh ky kz la mi lc ld le mj lg lh li mk lk ll lm ml lo lp lq bi translated"><strong class="ak">生产部署</strong></h1><p id="9398" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">此时，新的ClusterIssuer、证书和入口将是继续生产环境所必需的。</p><p id="197a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将包括一个ClusterIssuer的例子，因为它很难在线获得:</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="9a1e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">继续复制其他资源，记住使用不同的秘密名称，因为这个原因，之前已经使用了前缀<code class="fe md me mf mg b">stg</code>。</p><p id="94b8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在过程的最后，我们应该会得到一个可用的仪表板URL:</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/acc44b947f61dc2a98a0721fb3d600a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:818/format:webp/1*rPDQ_np_ihb7AaELgLSn8g.png"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">生产许可证工作中的加密证书</figcaption></figure><p id="1942" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们完事了吗？不完全是。我们仍然没有隐私可言，绝对的最低要求是在到达仪表板之前有一个基本的认证墙。</p><h1 id="3ed5" class="kt ku iq bd kv kw mh ky kz la mi lc ld le mj lg lh li mk lk ll lm ml lo lp lq bi translated">基本认证</h1><p id="3888" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">首先，让我们生成一些凭证；我们将使用MD5 hash而不是Bcrypt(这样更安全)，因为NGINX <a class="ae kl" href="https://stackoverflow.com/questions/31833583/nginx-gives-an-internal-server-error-500-after-i-have-configured-basic-auth/35834603#35834603" rel="noopener ugc nofollow" target="_blank">似乎与它</a>有问题。</p><pre class="lw lx ly lz gt mm mg mn mo aw mp bi"><span id="723e" class="mq ku iq mg b gy mr ms l mt mu">docker run --rm -it xmartlabs/htpasswd -m &lt;user&gt; &lt;password &gt;&gt; htpasswd-dashboard</span></pre><p id="30f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可以多次使用该命令来获取有效的用户/密码组合列表。</p><p id="8d20" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦完成，我们将把这个文件转换成一个Kubernetes <a class="ae kl" href="https://kubernetes.io/docs/concepts/configuration/secret/" rel="noopener ugc nofollow" target="_blank">秘密</a></p><pre class="lw lx ly lz gt mm mg mn mo aw mp bi"><span id="e666" class="mq ku iq mg b gy mr ms l mt mu">kubectl -n kube-system create secret generic htpasswd-dashboard --from-file=auth=htpasswd-dashboard</span></pre><p id="b415" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，我们创建了一个名为<strong class="jp ir"> htpasswd-dashboard </strong>的秘密，其中包含一个<strong class="jp ir"> auth </strong>密钥，表明这是我们的htpasswd文件；NGINX想要这种格式的秘密。</p><p id="969b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们必须在入口中添加一些元数据:</p><pre class="lw lx ly lz gt mm mg mn mo aw mp bi"><span id="be98" class="mq ku iq mg b gy mr ms l mt mu">metadata:</span><span id="d6ab" class="mq ku iq mg b gy nd ms l mt mu">  annotations:</span><span id="9c3e" class="mq ku iq mg b gy nd ms l mt mu">    nginx.ingress.kubernetes.io/auth-type: basic</span><span id="16df" class="mq ku iq mg b gy nd ms l mt mu">    nginx.ingress.kubernetes.io/auth-secret: htpasswd-dashboard</span><span id="6973" class="mq ku iq mg b gy nd ms l mt mu">    nginx.ingress.kubernetes.io/auth-realm: "Authentication Required"</span></pre><p id="36a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦我们编辑或应用了新修改的入口，我们就可以开始了。</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/4a3caced0bcac7c3efd13b3a3934aba5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1170/format:webp/1*LVYuYuA2WFNwqEK83rQG5A.png"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">在配置Kubernetes时，即使得到密码提示也是成功的一刻。</figcaption></figure><p id="d871" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">目标是安全地公开Kubernetes仪表板，在基本的auth登录之后，您必须提供一个kubeconfig/ServiceAccount令牌。</p><p id="0c24" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有了这些令牌，您可以充分利用基于角色的访问控制。</p><p id="342c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">到下一次。</p><p id="e3fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://about.me/colthreepv" rel="noopener ugc nofollow" target="_blank">-瓦莱里奥</a></p></div></div>    
</body>
</html>