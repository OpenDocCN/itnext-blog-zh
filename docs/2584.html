<html>
<head>
<title>SonarQube: running tests from Jenkins Pipeline in Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SonarQube:在Docker中运行来自Jenkins管道的测试</h1>
<blockquote>原文：<a href="https://itnext.io/sonarqube-running-tests-from-jenkins-pipeline-from-docker-7740702b6f42?source=collection_archive---------1-----------------------#2019-06-18">https://itnext.io/sonarqube-running-tests-from-jenkins-pipeline-from-docker-7740702b6f42?source=collection_archive---------1-----------------------#2019-06-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/78429a8eb528e8d0b65bc692cb92085d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zfct_YkfaESUYN_yZL0vcg.png"/></div></div></figure><p id="2076" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">任务是使用来自Jenkins管道作业的SonarQube运行我们的后端PHP测试。</p><p id="1715" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Jenkins运行在Docker中，它的所有构建也使用Docker。</p><p id="5ba1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这个设置过程中，我面临的主要问题是，使用sonar cube的容器运行两个服务:一个是sonar cube本身，另一个是Elasticesearch(而containers concept说“<em class="kz">每个容器一个服务</em>”)。</p><p id="1dfe" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在此期间，Elasticsearch无法从root用户启动，所以我不得不使用uid和挂载点。</p><h2 id="2828" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">内容</h2><ul class=""><li id="f515" class="lt lu it kd b ke lv ki lw km lx kq ly ku lz ky ma mb mc md bi translated"><a class="ae me" href="https://rtfm.co.ua/en/sonarqube-running-tests-from-jenkins-pipeline-from-docker/#Docker_Compose_for_SonarQube" rel="noopener ugc nofollow" target="_blank">码头工人为SonarQube </a>作曲</li><li id="40eb" class="lt lu it kd b ke mf ki mg km mh kq mi ku mj ky ma mb mc md bi translated"><a class="ae me" href="https://rtfm.co.ua/en/sonarqube-running-tests-from-jenkins-pipeline-from-docker/#NGINX" rel="noopener ugc nofollow" target="_blank"> NGINX </a></li><li id="3ef7" class="lt lu it kd b ke mf ki mg km mh kq mi ku mj ky ma mb mc md bi translated"><a class="ae me" href="https://rtfm.co.ua/en/sonarqube-running-tests-from-jenkins-pipeline-from-docker/#Jenkins_Docker_Compose" rel="noopener ugc nofollow" target="_blank">詹金斯码头工人作曲</a></li><li id="6345" class="lt lu it kd b ke mf ki mg km mh kq mi ku mj ky ma mb mc md bi translated"><a class="ae me" href="https://rtfm.co.ua/en/sonarqube-running-tests-from-jenkins-pipeline-from-docker/#Jenkins_configuration" rel="noopener ugc nofollow" target="_blank">詹金斯配置</a></li><li id="fc3f" class="lt lu it kd b ke mf ki mg km mh kq mi ku mj ky ma mb mc md bi translated"><a class="ae me" href="https://rtfm.co.ua/en/sonarqube-running-tests-from-jenkins-pipeline-from-docker/#A_project_configuration_in_SonarQube" rel="noopener ugc nofollow" target="_blank">sonar cube中的项目配置</a></li></ul></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h2 id="75b7" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">为SonarQube编写Docker</h2><p id="f502" class="pw-post-body-paragraph kb kc it kd b ke lv kg kh ki lw kk kl km mr ko kp kq ms ks kt ku mt kw kx ky im bi translated">检查SonarQube Docker映像中默认用户的UID:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="04aa" class="la lb it mz b gy nd ne l nf ng">root@jenkins-dev:/opt/sonarqube# docker run -ti sonarqube id<br/>uid=999(sonarqube) gid=999(sonarqube) groups=999(sonarqube)</span></pre><p id="9367" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">创建目录以保存SonarQube的数据:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="6c54" class="la lb it mz b gy nd ne l nf ng">root@jenkins-dev:~# mkdir -p /data/sonarqube/{conf,logs,temp,data,extensions,bundled_plugins,postgresql,postgresql_data}</span></pre><p id="0bf9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">创建新用户并更改这些目录的所有者:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="aee6" class="la lb it mz b gy nd ne l nf ng">root@jenkins-dev:~# adduser sonarqube<br/>root@jenkins-dev:~# usermod -aG docker sonarqube<br/>root@jenkins-dev:~# chown -R sonarqube:sonarqube /data/sonarqube/</span></pre><p id="8749" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">查找上面创建的用户的UID:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="e1f4" class="la lb it mz b gy nd ne l nf ng">root@jenkins-dev:/opt/sonarqube# id sonarqube<br/>uid=1004(sonarqube) gid=1004(sonarqube) groups=1004(sonarqube),999(docker)</span></pre><p id="9180" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">使用<code class="fe nh ni nj mz b">user</code>中的UID创建一个Docker合成文件:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="6898" class="la lb it mz b gy nd ne l nf ng">version: "3"<br/><br/>networks:<br/>  sonarnet:<br/>    driver: bridge<br/><br/>services:<br/>  sonarqube:<br/>    // use UID here<br/>    user: 1004:1004<br/>    image: sonarqube<br/>    ports:<br/>      - "9000:9000"<br/>    networks:<br/>      - sonarnet<br/>    environment:<br/>      - sonar.jdbc.url=jdbc:postgresql://db:5432/sonar<br/>    volumes:<br/>      - /data/sonarqube/conf:/opt/sonarqube/conf<br/>      - /data/sonarqube/logs:/opt/sonarqube/logs<br/>      - /data/sonarqube/temp:/opt/sonarqube/temp<br/>      - /data/sonarqube/data:/opt/sonarqube/data<br/>      - /data/sonarqube/extensions:/opt/sonarqube/extensions<br/>      - /data/sonarqube/bundled_plugins:/opt/sonarqube/lib/bundled-plugins<br/><br/>  db:<br/>    image: postgres<br/>    networks:<br/>      - sonarnet<br/>    environment:<br/>      - POSTGRES_USER=sonar<br/>      - POSTGRES_PASSWORD=sonar<br/>    volumes:<br/>      - /data/sonarqube/postgresql:/var/lib/postgresql<br/>      - /data/sonarqube/postgresql_data:/var/lib/postgresql/data</span></pre><p id="64da" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">检查一下:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="e90c" class="la lb it mz b gy nd ne l nf ng">root@jenkins-dev:/opt/sonarqube# docker-compose -f sonarqube-compose.yml up<br/>Starting sonarqube_db_1 … done<br/>Recreating sonarqube_sonarqube_1 … done<br/>…<br/>sonarqube_1 | 2019.06.14 15:33:46 INFO app[][o.s.a.SchedulerImpl] Process[ce] is up<br/>sonarqube_1 | 2019.06.14 15:33:46 INFO app[][o.s.a.SchedulerImpl] SonarQube is up</span></pre></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h2 id="9c2c" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">NGINX</h2><p id="1771" class="pw-post-body-paragraph kb kc it kd b ke lv kg kh ki lw kk kl km mr ko kp kq ms ks kt ku mt kw kx ky im bi translated">现在，需要配置NGINX和SSL来访问SonarQube的web界面。</p><p id="a904" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">停止NGINX，安装Let's Encrypt client，获取一个证书(更多细节参见AWS EC2 上的<a class="ae me" href="https://rtfm.co.ua/en/bitwarden-an-organizations-password-manager-self-hosted-version-installation-on-an-aws-ec2/#Lets_Encrypt" rel="noopener ugc nofollow" target="_blank"> Bitwarden:一个组织的密码管理器自托管版本安装):</a></p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="c06f" class="la lb it mz b gy nd ne l nf ng">root@jenkins-dev:/opt/sonarqube# systemctl stop nginx<br/>root@jenkins-dev:/opt/sonarqube# /opt/letsencrypt/letsencrypt-auto certonly -d sonar.example.com<br/>root@jenkins-dev:/opt/sonarqube# systemctl start nginx</span></pre><p id="5bf5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">创建一个虚拟主机配置，这里只是通过复制已经存在的:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="0bde" class="la lb it mz b gy nd ne l nf ng">root@jenkins-dev:/opt/sonarqube# cp /etc/nginx/conf.d/ci.example.com.conf /etc/nginx/conf.d/sonar.example.com.conf</span></pre><p id="2d75" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">更新它，使它看起来像next(在SSL部分可能有点过时，但仍然给出+结果):</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="1ce3" class="la lb it mz b gy nd ne l nf ng">upstream sonar {<br/>    server 127.0.0.1:9000;<br/>}<br/><br/><br/>server {<br/><br/>    listen 80;<br/>    server_name  dev.sonar.example.com;<br/><br/>    # Lets Encrypt Webroot<br/>    location ~ /.well-known {<br/><br/>    root /var/www/html;<br/>        allow all;<br/>    }<br/><br/>    location / {<br/>        return 301 <a class="ae me" href="https://dev.sonar.example.com;" rel="noopener ugc nofollow" target="_blank">https://dev.sonar.example.com;</a><br/>    }<br/>}<br/><br/>server {<br/><br/>    listen       443 ssl;<br/>    server_name  dev.sonar.example.com;<br/><br/>    access_log  /var/log/nginx/dev.sonar.example.com-access.log proxy;<br/>    error_log /var/log/nginx/dev.sonar.example.com-error.log warn;<br/><br/>    ssl_certificate /etc/letsencrypt/live/dev.sonar.example.com/fullchain.pem;<br/>    ssl_certificate_key /etc/letsencrypt/live/dev.sonar.example.com/privkey.pem;<br/><br/>    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;<br/>    ssl_prefer_server_ciphers on;<br/>    ssl_dhparam /etc/nginx/dhparams.pem;<br/>    ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:ECDHE-RSA-AES128-GCM-SHA256:AES256+EECDH:DHE-RSA-AES128-GCM-SHA256:AES256+EDH:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4";<br/>    ssl_session_timeout 1d;<br/>    ssl_stapling on;<br/>    ssl_stapling_verify on;<br/><br/>    location / {<br/>        proxy_http_version 1.1;<br/>        proxy_request_buffering off;<br/>        proxy_buffering off;<br/><br/>        proxy_redirect          off;<br/>        proxy_set_header        Host            $host;<br/>        proxy_set_header        X-Real-IP       $remote_addr;<br/>        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;<br/>        proxy_set_header        X-Forwarded-Proto   $scheme;<br/>        proxy_pass <a class="ae me" href="http://sonar$request_uri;" rel="noopener ugc nofollow" target="_blank">http://sonar$request_uri;</a><br/>    }<br/>}</span></pre><p id="63e2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">检查语法并重新加载NGINX的配置:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="7088" class="la lb it mz b gy nd ne l nf ng">root@jenkins-dev:/home/admin# nginx -t &amp;&amp; systemctl start nginx<br/>nginx: the configuration file /etc/nginx/nginx.conf syntax is ok<br/>nginx: configuration file /etc/nginx/nginx.conf test is successful</span></pre></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h2 id="48db" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">詹金斯·道克尔作曲</h2><p id="d3ba" class="pw-post-body-paragraph kb kc it kd b ke lv kg kh ki lw kk kl km mr ko kp kq ms ks kt ku mt kw kx ky im bi translated">现在是时候将sonar cube添加到Jenkins Docker Compose文件中了(尽管可以作为一个专用服务使用)—将sonar cube和PostgreSQL移动到这个文件中:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="4c18" class="la lb it mz b gy nd ne l nf ng">version: '3'<br/><br/>networks:<br/> jenkins:<br/><br/>services:<br/><br/>  jenkins:<br/>    user: root<br/>    image: jenkins/jenkins:2.164.3<br/>    networks:<br/>      - jenkins<br/>    ports:<br/>      - '8080:8080'<br/>      - '50000:50000'<br/>    volumes:<br/>      - /data/jenkins:/var/lib/jenkins<br/>      - /var/run/docker.sock:/var/run/docker.sock<br/>      - /usr/bin/docker:/usr/bin/docker<br/>      - /usr/lib/x86_64-linux-gnu/libltdl.so.7:/usr/lib/x86_64-linux-gnu/libltdl.so.7<br/>    environment:<br/>      - JENKINS_HOME=/var/lib/jenkins<br/>      - JAVA_OPTS=-Duser.timezone=Europe/Kiev<br/>      - JENKINS_JAVA_OPTIONS="-Djava.awt.headless=true -Dhudson.model.DirectoryBrowserSupport.CSP=\"default-src 'self' 'unsafe-inline' 'unsafe-eval'; img-src 'self' 'unsafe-inline' data:;\""<br/>    logging:<br/>      driver: "journald"<br/><br/>  sonarqube:<br/>    user: 1004:1004<br/>    image: sonarqube<br/>    ports:<br/>      - "9000:9000"<br/>    networks:<br/>      - jenkins<br/>    environment:<br/>      - sonar.jdbc.url=jdbc:postgresql://db:5432/sonar<br/>    volumes:<br/>      - /data/sonarqube/conf:/opt/sonarqube/conf<br/>      - /data/sonarqube/logs:/opt/sonarqube/logs<br/>      - /data/sonarqube/temp:/opt/sonarqube/temp<br/>      - /data/sonarqube/data:/opt/sonarqube/data<br/>      - /data/sonarqube/extensions:/opt/sonarqube/extensions<br/>      - /data/sonarqube/bundled_plugins:/opt/sonarqube/lib/bundled-plugins<br/>    logging:<br/>      driver: "journald"<br/><br/>  db:<br/>    image: postgres<br/>    networks:<br/>      - jenkins<br/>    environment:<br/>      - POSTGRES_USER=sonar<br/>      - POSTGRES_PASSWORD=sonar<br/>    volumes:<br/>      - /data/sonarqube/postgresql:/var/lib/postgresql<br/>      - /data/sonarqube/postgresql_data:/var/lib/postgresql/data<br/>    logging:<br/>      driver: "journald"</span></pre><p id="8646" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">重启Jenkins服务(参见<a class="ae me" href="https://rtfm.co.ua/linux-systemd-servis-dlya-docker-compose/" rel="noopener ugc nofollow" target="_blank">Linux:systemdсервсдляdocker撰写帖子</a> ( <em class="kz"> Rus </em>)):</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="3e48" class="la lb it mz b gy nd ne l nf ng">root@jenkins-dev:/opt/jenkins# systemctl restart jenkins</span></pre><p id="ddc2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">检查容器:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="3ddd" class="la lb it mz b gy nd ne l nf ng">root@jenkins-dev:/home/admin# docker ps<br/>CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES<br/>fc2662391c45 sonarqube “./bin/run.sh” 48 seconds ago Up 46 seconds 0.0.0.0:9000-&gt;9000/tcp jenkins_sonarqube_1<br/>3ac2bb5f0e87 postgres “docker-entrypoint.s…” 48 seconds ago Up 46 seconds 5432/tcp jenkins_db_1<br/>113496304b0f jenkins/jenkins:2.164.3 “/sbin/tini — /usr/…” 48 seconds ago Up 46 seconds 0.0.0.0:8080-&gt;8080/tcp, 0.0.0.0:50000-&gt;50000/tcp jenkins_jenkins_1</span></pre><p id="a2de" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">进入声纳的网络界面:</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nk"><img src="../Images/54f2249b3a9221dc4918ea9ec3989cb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lDi9QkxjftJh7IYs.png"/></div></div></figure><p id="ddcf" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">用<em class="kz"> admin:admin </em>登录。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h2 id="1f18" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">詹金斯构型</h2><p id="0a5b" class="pw-post-body-paragraph kb kc it kd b ke lv kg kh ki lw kk kl km mr ko kp kq ms ks kt ku mt kw kx ky im bi translated">通常，对于Jenkins，使用的是<a class="ae me" href="https://plugins.jenkins.io/sonar" rel="noopener ugc nofollow" target="_blank">sonar cube Scanner</a>插件，但是我们将从Docker容器运行Scanner，所以不需要安装这个插件。</p><h2 id="d13b" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">作业配置</h2><p id="217e" class="pw-post-body-paragraph kb kc it kd b ke lv kg kh ki lw kk kl km mr ko kp kq ms ks kt ku mt kw kx ky im bi translated">创建管道作业:</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nl"><img src="../Images/0b2252c57dd20f6edca8c745045662f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5ovEll6HV6EWUNgH.png"/></div></div></figure><p id="3b5f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">创建管道脚本:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="832e" class="la lb it mz b gy nd ne l nf ng">node {<br/>    <br/>    stage('Clone repo') {<br/>        git branch: "develop", url: "git@github.com:example-dev/example-me.git", credentialsId: "jenkins-github"<br/>    }<br/>    <br/>    stage('SonarTests') {<br/>        docker.image('newtmitch/sonar-scanner').inside('-v /var/run/docker.sock:/var/run/docker.sock') {<br/>            sh "--version"<br/>        }<br/>    }<br/>}</span></pre><p id="51db" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">再次面临入口点错误:</p><blockquote class="nm nn no"><p id="ef1c" class="kb kc kz kd b ke kf kg kh ki kj kk kl np kn ko kp nq kr ks kt nr kv kw kx ky im bi translated">$ docker top d 2269 Fe 30970490 ba 9957 AC 57701 EC 6091 f 3c CBF 78 f 957 e 903 a 3319 fa 1445 BD-EO PID，comm <br/>错误:容器已启动，但没有运行预期的命令。请仔细检查您的入口点是否按照官方docker映像的要求，执行了作为docker run参数传递的命令(请参见<a class="ae me" href="https://github.com/docker-library/official-images#consistency" rel="noopener ugc nofollow" target="_blank">https://github . com/docker-library/official-images # consistency</a>了解入口点一致性要求)。<br/>或者，您可以通过添加选项`— entrypoint= ' ' '来强制禁用图像入口点。</p></blockquote><p id="a6f8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们使用来自<a class="ae me" href="https://rtfm.co.ua/en/jenkins-running-phpunit-from-codeception-by-a-pull-reguest-in-github-and-allure-reports/#Jenkins_Docker_Plugin_The_container_started_but_didnt_run_the_expected_command_Please_double_check_your_ENTRYPOINT" rel="noopener ugc nofollow" target="_blank"> Jenkins的解决方案:通过Github和Allure-reports </a>帖子中的Pull请求从Codeception运行PHPUnit。</p><p id="f19c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">运行容器，将<code class="fe nh ni nj mz b">entrypoint</code>设置为<code class="fe nh ni nj mz b">bash</code>:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="6ad0" class="la lb it mz b gy nd ne l nf ng">docker run -ti — entrypoint=”bash” newtmitch/sonar-scanner<br/>root@20baaae7de9a:/usr/src#</span></pre><p id="2072" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">找到扫描仪的可执行文件:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="d7e0" class="la lb it mz b gy nd ne l nf ng">root@20baaae7de9a:/usr/src# which sonar-scanner<br/>/usr/local/bin/sonar-scanner</span></pre><p id="c700" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">更新Jenkins脚本—在<code class="fe nh ni nj mz b">sh</code> - <code class="fe nh ni nj mz b">/usr/local/bin/sonar-scanner</code>中设置<code class="fe nh ni nj mz b">--entrypoint=""</code>和完整路径:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="2903" class="la lb it mz b gy nd ne l nf ng">node {<br/>    <br/>    stage('Clone repo') {<br/>        git branch: "develop", url: "git@github.com:example-dev/example-me.git", credentialsId: "jenkins-github"<br/>    }<br/>    <br/>    stage('SonarTests') {<br/>        docker.image('newtmitch/sonar-scanner').inside('-v /var/run/docker.sock:/var/run/docker.sock --entrypoint=""') {<br/>            sh "/usr/local/bin/sonar-scanner --version"<br/>        }<br/>    }<br/>}</span></pre><p id="6a0b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">运行构建，检查结果:</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ns"><img src="../Images/2a7698c5b316aa25efce58cffd3fddb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*npNf3Mt_Cv2C51DO.png"/></div></div></figure><p id="d819" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">很好——很有效。</p><p id="d33d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">但现在另一个问题来了:</p><ol class=""><li id="fb45" class="lt lu it kd b ke kf ki kj km nt kq nu ku nv ky nw mb mc md bi translated">詹金斯在<em class="kz">詹金斯_詹金斯</em>网络中作为码头集装箱运行</li><li id="17b1" class="lt lu it kd b ke mf ki mg km mh kq mi ku mj ky nw mb mc md bi translated">SonarQube在<em class="kz"> jenkins_jenkins </em>网络中作为Docker容器运行</li><li id="e81c" class="lt lu it kd b ke mf ki mg km mh kq mi ku mj ky nw mb mc md bi translated">Jenkins创建了一个带有<code class="fe nh ni nj mz b">sonar-scanner</code>的新容器，它必须能够访问SonarQube容器，而SonarQube容器又运行在一个“外部”网络中<em class="kz"> jenkins_jenkins </em>(从扫描器的容器角度来看)</li></ol><p id="5d93" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">检查Jenkins主机上Docker中的现有网络:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="e615" class="la lb it mz b gy nd ne l nf ng">root@jenkins-dev:/home/admin# docker network ls<br/>NETWORK ID NAME DRIVER SCOPE<br/>67900babbbc4 bridge bridge local<br/>d51bc8ee54d0 host host local<br/>30b091d801d6 jenkins_jenkins bridge local<br/>16ab0c37234e none null local</span></pre><p id="eb1c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">解决方案是更新扫描仪的容器设置—将其网络设置为<em class="kz"> jenkins_jenkins </em> ( <code class="fe nh ni nj mz b">--net jenkins_jenkins</code>):</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="dd26" class="la lb it mz b gy nd ne l nf ng">node {<br/>    <br/>    stage('Clone repo') {<br/>        git branch: "develop", url: "git@github.com:example-dev/example-me.git", credentialsId: "jenkins-github"<br/>    }<br/>    <br/>    stage('SonarTests') {<br/>        docker.image('newtmitch/sonar-scanner').inside('-v /var/run/docker.sock:/var/run/docker.sock --entrypoint="" --net jenkins_jenkins') {<br/>            sh "/usr/local/bin/sonar-scanner -Dsonar.host.url=http://sonarqube:9000 -Dsonar.sources=."<br/>        }<br/>    }<br/>}</span></pre><p id="8c64" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">运行它:</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nx"><img src="../Images/51911e92ff2379fcb6a6ca8c94aef8cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AEoLrI9j_gV73wZt.png"/></div></div></figure><p id="a1a6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">很好—声纳扫描仪正在运行，并且能够连接到SonarQube容器。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h2 id="d3fb" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">SonarQube中的项目配置</h2><p id="954a" class="pw-post-body-paragraph kb kc it kd b ke lv kg kh ki lw kk kl km mr ko kp kq ms ks kt ku mt kw kx ky im bi translated">添加新项目:</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/2cb3a3dad7916eb73bb64b6edf266dce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/0*uzmh8y-iGbpQRK4-.png"/></div></figure><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/c67eb4403a1f34ade8bc9d6bf6c1bf90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1160/format:webp/0*-LrU789esbkSzvoc.png"/></div></figure><p id="0e3c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">创建其令牌:</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/cb842b5b7561ebead8cf5fd5ebe231a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1160/format:webp/0*XVolkAWq_2gNb3cp.png"/></div></figure><p id="7b74" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">选择平台，SonarQube将显示必要的设置:</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oa"><img src="../Images/58105e88e7ed02c226997c10c6bf61f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*i82fpMqfeX9DyjtK.png"/></div></div></figure><p id="0094" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">更新脚本，运行作业，然后:</p><blockquote class="nm nn no"><p id="0dfe" class="kb kc kz kd b ke kf kg kh ki kj kk kl np kn ko kp nq kr ks kt nr kv kw kx ky im bi translated">错误:SonarQube扫描仪执行期间出错<br/>错误:没有找到质量配置文件，您可能没有安装任何语言插件。</p></blockquote><p id="419a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">好吧…</p><p id="6321" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">回到SonarQube到<em class="kz">管理&gt;市场</em>并安装SonarPHP:</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ob"><img src="../Images/fb653c832c18210b91e5c2ed12b674ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Sn5JlNWQnuxik27F.png"/></div></div></figure><p id="1ee8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">重启声纳:</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ob"><img src="../Images/3770046758b5078b58b5157c7de6ef5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TX0vnwBXg6DClbHi.png"/></div></div></figure><p id="88d0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">立即检查已安装的插件:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="a0fc" class="la lb it mz b gy nd ne l nf ng">root@jenkins-dev:/home/admin# curl localhost:9000/api/plugins/installed<br/>{“plugins”:[{“key”:”php”,”name”:”SonarPHP”,”description”:”Code Analyzer for PHP”,”version”:”3.0.0.4537",”license”:”GNU LGPL v3",”organizationName”:”SonarSource and Akram Ben Aissi”,”editionBundled”:false,”homepageUrl”:”http://redirect.sonarsource.com/plugins/php.html","issueTrackerUrl":"http://jira.codehaus.org/browse/SONARPHP","implementationBuild":"026dee08c29a3689ab1228552e14bfefda9ae57e","updatedAt":1560775404315,"filename":"sonar-php-plugin-3.0.0.4537.jar","sonarLintSupported":true,"hash":"c80c0d053f074a9147d341cf1357d994"}]}</span></pre><blockquote class="nm nn no"><p id="ab2b" class="kb kc kz kd b ke kf kg kh ki kj kk kl np kn ko kp nq kr ks kt nr kv kw kx ky im bi translated">" name":"SonarPHP "，" description ":" PHP代码分析器"</p></blockquote><p id="e11c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">好，安装完毕，再次运行作业:</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oc"><img src="../Images/bc47046540375a8768caa08b2bd3b40e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZaxURXi91FEXslI-.png"/></div></div></figure><p id="a109" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">并导致SonarQube:</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi od"><img src="../Images/ae4abc0260376b31683cbb3116de7a87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hRPkMgaFjnRlDmuv.png"/></div></div></figure><h2 id="5ed0" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">声纳扫描仪:索引了0个文件</h2><p id="e4a8" class="pw-post-body-paragraph kb kc it kd b ke lv kg kh ki lw kk kl km mr ko kp kq ms ks kt ku mt kw kx ky im bi translated">但是为什么<em class="kz"> 0扫描了</em>？</p><blockquote class="nm nn no"><p id="b061" class="kb kc kz kd b ke kf kg kh ki kj kk kl np kn ko kp nq kr ks kt nr kv kw kx ky im bi translated">… <br/>信息:索引文件… <br/>信息:项目配置:<br/>信息:索引0个文件<br/> …</p></blockquote><p id="2b76" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">从Jenkins到其扫描仪容器的目录映射有问题。</p><p id="e4c0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们尝试显式设置<code class="fe nh ni nj mz b">sonar.sources</code>和<code class="fe nh ni nj mz b">sonar.projectBaseDir</code>:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="78fc" class="la lb it mz b gy nd ne l nf ng">...<br/>    stage('SonarTests') {<br/>        docker.image('newtmitch/sonar-scanner').inside('-v /var/run/docker.sock:/var/run/docker.sock --entrypoint="" --net jenkins_jenkins') {<br/>            sh "/usr/local/bin/sonar-scanner -Dsonar.host.url=http://sonarqube:9000 -Dsonar.sources=/var/lib/jenkins/workspace/SonarTest -Dsonar.projectBaseDir=/var/lib/jenkins/workspace/SonarTest -Dsonar.projectKey=ProjectName -Dsonar.login=91a691e7c91154d3fee69a05a8fa6e2b10bc82a6 -Dsonar.verbose=true"<br/>        }<br/>    }</span></pre><p id="1859" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">运行它:</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oe"><img src="../Images/70a762c29f7b7f4431d0c0aa989a6ec3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vs4SUNR4cfy2KMvO.png"/></div></div></figure><p id="db9b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">作品。</p><p id="0e34" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">再一次SonarQube的结果:</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi of"><img src="../Images/20b0c921828dcaef8802c819e8538c3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*D-OO-_645dl93azT.png"/></div></div></figure><p id="e75a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">实际上——就这些了，现在需要把这一切弄得更干净。</p><p id="9815" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">所以这个问题的出现是因为Jenkins Docker插件将一个当前的工作目录映射到一个同名的容器中，然后将其设置为一个<code class="fe nh ni nj mz b">--workdir</code>:</p><blockquote class="nm nn no"><p id="49c4" class="kb kc kz kd b ke kf kg kh ki kj kk kl np kn ko kp nq kr ks kt nr kv kw kx ky im bi translated">… <br/> $ docker运行[…]-w/var/lib/Jenkins/workspace/SonarTest<br/>…</p></blockquote><p id="a9ac" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当<code class="fe nh ni nj mz b">sonar-scanner</code>试图在基于默认<em class="kz">的目录</em>中找到它时:</p><blockquote class="nm nn no"><p id="258b" class="kb kc kz kd b ke kf kg kh ki kj kk kl np kn ko kp nq kr ks kt nr kv kw kx ky im bi translated">… <br/> 09:08:56.666信息:基本目录:/usr/src <br/> …</p></blockquote><p id="b4b6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们尝试将<code class="fe nh ni nj mz b">sonar.projectBaseDir</code>设置为“<code class="fe nh ni nj mz b">.</code>”值，即-当前目录。</p><p id="9d8a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在脚本看起来像下面这样:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="3529" class="la lb it mz b gy nd ne l nf ng">node {<br/>    <br/>    stage('Clone repo') {<br/>        git branch: "develop", url: "git@github.com:example-dev/example-me.git", credentialsId: "jenkins-github"<br/>    }<br/>    <br/>    stage('SonarTests') {<br/>        docker.image('newtmitch/sonar-scanner').inside('-v /var/run/docker.sock:/var/run/docker.sock --entrypoint="" --net jenkins_jenkins') {<br/>            sh "/usr/local/bin/sonar-scanner -Dsonar.host.url=http://sonarqube:9000 -Dsonar.projectBaseDir=. -Dsonar.projectKey=ProjectName -Dsonar.login=91a691e7c91154d3fee69a05a8fa6e2b10bc82a6"<br/>        }<br/>    }<br/>}</span></pre><p id="2042" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">运行它:</p><blockquote class="nm nn no"><p id="3a26" class="kb kc kz kd b ke kf kg kh ki kj kk kl np kn ko kp nq kr ks kt nr kv kw kx ky im bi translated">… <br/>信息:基本目录:/var/lib/Jenkins/workspace/SonarTest<br/>信息:工作目录:/var/lib/Jenkins/workspace/SonarTest/。扫描器工作… <br/>信息:执行成功</p></blockquote><p id="4a26" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">项目的设置可以移动到项目的Github资源库根目录下的<code class="fe nh ni nj mz b">sonar-project.properties</code>文件中:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="77cb" class="la lb it mz b gy nd ne l nf ng">sonar.host.url=http://sonarqube:9000<br/>sonar.projectBaseDir=.<br/>sonar.projectKey=ProjectName<br/>sonar.login=91a691e7c91154d3fee69a05a8fa6e2b10bc82a6</span></pre><p id="c2d2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">并更新我们的脚本以删除所有参数——扫描仪将寻找<code class="fe nh ni nj mz b">sonar-project.properties</code>来使用它的设置:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="f909" class="la lb it mz b gy nd ne l nf ng">node {<br/>    <br/>    stage('Clone repo') {<br/>        git branch: "develop", url: "git@github.com:example-dev/example-me.git", credentialsId: "jenkins-github"<br/>    }<br/>    <br/>    stage('SonarTests') {<br/>        docker.image('newtmitch/sonar-scanner').inside('-v /var/run/docker.sock:/var/run/docker.sock --entrypoint="" --net jenkins_jenkins') {<br/>            sh "/usr/local/bin/sonar-scanner"<br/>        }<br/>    }<br/>}</span></pre><p id="6f47" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">完成了。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><p id="b561" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="kz">最初发布于</em> <a class="ae me" href="https://rtfm.co.ua/en/sonarqube-running-tests-from-jenkins-pipeline-from-docker/" rel="noopener ugc nofollow" target="_blank"> <em class="kz"> RTFM: Linux、DevOps和系统管理</em> </a> <em class="kz">。</em></p></div></div>    
</body>
</html>