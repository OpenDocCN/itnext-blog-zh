<html>
<head>
<title>Argo: Workflow Engine for Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Argo:Kubernetes的工作流引擎</h1>
<blockquote>原文：<a href="https://itnext.io/argo-workflow-engine-for-kubernetes-7ae81eda1cc5?source=collection_archive---------1-----------------------#2019-05-23">https://itnext.io/argo-workflow-engine-for-kubernetes-7ae81eda1cc5?source=collection_archive---------1-----------------------#2019-05-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/d584367f9e679cee42eb224f111df820.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bMziOMNX0jy2TRQZM3Nozw.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Argo:Kubernetes的工作流管理器</figcaption></figure><div class=""/><p id="e1e1" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">来自<a class="ae la" href="https://applatix.com/" rel="noopener ugc nofollow" target="_blank"> Applatix </a>的Argo 是一个开源项目，它为Kubernetes提供容器原生工作流，将工作流中的每一步都实现为一个容器。Argo使用户能够使用类似于传统YAML的自定义DSL来启动多步管道。该框架提供了复杂的循环、条件、依赖管理和DAG等。这有助于增加部署应用程序堆栈的灵活性以及配置和依赖性的灵活性。使用Argo，用户可以定义依赖关系，以编程方式构建复杂的工作流，将任何步骤的输出作为输入链接到后续步骤的工件管理，并在易于阅读的用户界面中监控计划的作业。</p><p id="4a92" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">阿尔戈V2是作为一个库伯内特CRD(自定义资源定义)实现的。因此，Argo工作流可以使用kubectl进行管理，并与其他Kubernetes服务(如卷、秘密和RBAC)进行本地集成。新的Argo软件是轻量级的，安装不到一分钟，但提供完整的工作流程功能，包括参数替换、工件、夹具、循环和递归工作流程。</p><p id="c82b" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Argo中的工作流自动化是由YAML模板驱动的(易于采用，因为Kubernetes主要使用相同的DSL ),这些模板是使用ADSL (Argo领域特定语言)设计的。使用ADSL提供的每条指令都被视为一段代码，并与应用程序代码一起托管在SCM(源代码管理)中。Argo提供/支持六种不同的YAML构造:容器模板:根据需要创建单个容器和参数，工作流模板:定义作业，换句话说，短期运行应用程序运行到完成。工作流中的步骤可以是容器、策略模板:用于触发/调用作业或通知的规则、部署模板:创建长时间运行的应用程序、固定模板:在Argo之外粘合第三方资源、项目模板:可以在Argo目录中访问的工作流定义。</p><p id="2310" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Argo支持几种不同的方式来定义Kubernetes清单:<a class="ae la" href="https://ksonnet.io/" rel="noopener ugc nofollow" target="_blank"> Ksonnet </a>应用程序、<a class="ae la" href="http://helm.io/" rel="noopener ugc nofollow" target="_blank"> Helm </a>图表和YAML/json清单的简单目录。</p><h1 id="b263" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">基本Argo工作流模板</h1><p id="c709" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">下面的模板是一个简单的模板，其中定义了一个工作流来创建一个包含两个容器的pod，其中一个容器包含curl(仅包含curl的基于Alpine的映像)，另一个是Nginx sidecar容器(sidecar作为第二个流程与服务一起运行，并提供“平台基础架构功能”)。这里curl是一个“主”容器，它轮询nginx sidecar容器，直到它准备好服务请求。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi me"><img src="../Images/7a7b238ac6b3589abe6347aca9119146.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Q6I094PHsTq2T4gL"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Argo配置/工作流模板</figcaption></figure><ul class=""><li id="9f07" class="mj mk jf ke b kf kg kj kk kn ml kr mm kv mn kz mo mp mq mr bi translated">上述工作流中的事件:</li></ul><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ms"><img src="../Images/a3ea41a28ffb0a7a2a4ef574540bddf5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*c5EHm5N9ypUQdnWY"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">上面工作流中的详细事件</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mt"><img src="../Images/4f806b75dccae36ec8a7d0d33b454705.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vbX0OYgK-1rpa3Zp"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Nginx边车执行卷曲操作</figcaption></figure><p id="93df" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如上所示，工作流创建一个pod，执行规范中定义的配置，并终止将pod状态标记为完成的容器。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/d78b091c306bdcc03ae1dd439c72ddd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*clyIeQOkvBf0X0YS"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">工作流生命周期示例</figcaption></figure><ul class=""><li id="3942" class="mj mk jf ke b kf kg kj kk kn ml kr mm kv mn kz mo mp mq mr bi translated">Argo仪表板视图</li></ul><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mv"><img src="../Images/260a2b9a2d827d3ff28ab478b9d4c57b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*w-NvYlBc9-g_uAzx"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Argo仪表板工作流执行视图</figcaption></figure><h1 id="f203" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">带有条件的工作流模板</h1><p id="b778" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">Argo支持工作流执行中的条件模式。argo提供的示例描述了如何在模板中使用“when ”,模板的执行依赖于从父模板接收的输出。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/54014a7d1ac11a974ccffba0cdf8739a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1020/0*XT0fTlwNLctJMYz8"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">抛硬币示例</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mx"><img src="../Images/3087822b1f0ef7948c5108e0b57026c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dsqnsTjRnSB-2hRv"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">抛硬币工作流程配置</figcaption></figure><p id="cc7e" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">上面的工作流运行一个随机整数脚本，其中常数0 =正面，1 =反面，其中特定模板(正面或反面)的调用取决于“抛硬币”任务的输出。如上面的工作流图所示，抛硬币任务产生正面，其中仅执行正面模板。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi my"><img src="../Images/821aaf95221b55afc3c87e04d1e93598.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TR_QyF7XXosl2QlZ"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Argo CLI查询工作流</figcaption></figure><p id="4d25" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">上述工作流创建了两个容器，一个用于执行randomint python脚本，另一个用于根据脚本结果执行heads模板。如下所示，heads模板是根据randomint脚本的结果(result==heads)执行的。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/57c945128dfccdbeb1ec0120a50e14d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*14xwJaFoVZVEc3mK"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">抛硬币工作流执行</figcaption></figure><p id="759a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">类似地，递归(递归调用的模板)可以添加到条件规范中。例如，下面的模板输出显示抛硬币模板被执行n次，直到结果是正面。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi na"><img src="../Images/5875adc230bbbc5c419f01b1505357b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yvq--5RYbbM5WfQk"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">抛硬币=递归</figcaption></figure><h1 id="d276" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">带有循环和参数的工作流模板</h1><p id="fe27" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">Argo便于在工作流模板中迭代一组输入，用户可以提供参数(例如:输入参数)。在下面的工作流中，使用两个输入参数“hello kubernetes”和“hello argo”执行Whalesay模板。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nb"><img src="../Images/a71369dd5cccb9a81c79ea218ebb8fe9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HhYF-_0m9PKQWIXR"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">基于循环和参数的工作流配置</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/f8eef5a5c4499e0e417d3059249c9dd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NHWGVcCHm0omvXI2"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Argo CLI查询循环</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nd"><img src="../Images/bc8e05ab890a9c1580eea036dd5e35c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oGQ2lT5xhtWrteRr"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">工作流程—回路配置</figcaption></figure><p id="fa82" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">上面的模板包含一个模板，该模板将使用一个项目列表，并根据所提供的参数值的数量来运行任务。因此，这创建了两个pod，一个执行使用参数“hello kubernetes”的工作流，另一个使用“hello argo ”,如下所示:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ne"><img src="../Images/2ed5c5f2764b53a617ebbb56abfe618c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QqsHtMKLtylk0DrH"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">具有循环配置的工作流执行</figcaption></figure><p id="5d6f" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">类似的复杂循环:遍历一组条目，动态生成条目列表。</p><h1 id="e8d0" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">具有由DAG(有向非循环图)和步骤定义的依赖性的多步骤工作流模板</h1><p id="9c9f" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">Argo允许用户使用简单的Python对象DAG(有向无环图)启动多步管道，并且还便于在工作流规范(嵌套工作流)中定义多个模板</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nf"><img src="../Images/d58b35f2db4fa2cb930f3588c21eb69c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vUIbcJxuV0DIKQCF"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">DAG工作流执行模式</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ng"><img src="../Images/4bd4ce670240026c3c48713f78fdc1e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CmiUqkkbVX3ErqN0"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">基于DAG依赖性的工作流配置</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nh"><img src="../Images/38f96746f251db692ca002292e1e1670.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8hlETYLfpAaJgnxO"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">DAG执行</figcaption></figure><p id="c8d7" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">类似地，步骤可以用于定义多步骤工作流，下面的例子包括两个模板hello-hello-hello和whalesay(嵌套工作流)。</p><ul class=""><li id="312e" class="mj mk jf ke b kf kg kj kk kn ml kr mm kv mn kz mo mp mq mr bi translated">使用步骤的多步骤工作流</li></ul><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ni"><img src="../Images/a9617d0862d004f06c47e7f5195788bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1aSQpYrYp2O20lYR"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">基于配置的排序</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nj"><img src="../Images/7dc0bf809892cf499bb4d6cdfe9ab248.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_PIXWKlp5kUKBJzg"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">模板配置</figcaption></figure><p id="79cb" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这里，基于步骤控制流程，基于虚线定义运行格式。</p><h1 id="ec04" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用Minio进行工件管理并与Argo集成</h1><p id="95e2" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">工件是任何工作流(例如:CI-CD)的组成部分，工作流中的步骤生成工件，并且这些工件将被其他后续步骤消费。</p><p id="3529" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这里使用的工件存储库是Minio:带有亚马逊S3兼容API的开源对象存储服务器。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nk"><img src="../Images/b3e41c764c26a3efa3f79c638672700f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*E3i5DUZKwdwCacBB"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">工厂管理</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nl"><img src="../Images/fad2e4fc84514f35d978bb001f9e494b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*j4ubt1Bh3luRHWLG"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">工厂管理配置</figcaption></figure><p id="354c" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">上述工作流程由两个步骤组成。生成工件:使用whalesay模板和2。消费工件:消费步骤1中创建的工件，并打印消息。按照配置中的定义，这两个任务按顺序运行。第一步中生成的artifactory存储在Minio中，通过在workflow-configmap中提供以下配置，artifactory存储库可以与Argo集成。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nm"><img src="../Images/0d51ea05f25010201e325806d4b58678.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*C5IxH18d60KLFFjZ"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Artifactory管理的工作流配置</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nn"><img src="../Images/210762c9e7ed378f2913b405d777e2fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pxNQKUAGHedKlWaE"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">米尼奥</figcaption></figure><p id="c511" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">上面创建的artifactory存储在my-bucket的Minio中。“使用artifactory”任务将根据提供的配置提取artifactory。Minio类似于S3，并提供一个可共享的链接来使用artifactory，如下所示。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi no"><img src="../Images/0dfb1ce8e0824321f45a8015a1fc7088.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AzlJLgOWVQ8Pblds"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">迷你桶视图</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi np"><img src="../Images/b6575740419698d41f30d706cd4dfbf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rA7aLrso75-XTBt8"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Minio工件列表</figcaption></figure><h1 id="454e" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用Argo部署完整的应用程序堆栈(应用程序、数据库、监控和日志记录以及跟踪),以及长期运行的应用程序(部署和服务)</h1><p id="ef59" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">如上所述，Argo支持各种结构，这些结构可用于部署简化的工作流，以创建具有定义良好的规则集的复杂应用程序堆栈。在下面的例子中，一个成熟的web应用程序(样本袜子商店应用程序)部署了日志记录(使用Elastic Search、Kibana和FluentD)、监控(Prometheus和Grafana)、跟踪(Zipkin)。</p><p id="6e74" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Argo可以使用各种Kubernetes配置(部署、服务、集群角色等。)使用传统的基于YAML的文件提供。在本例中，工作流目录包含所有基于Argo的工作流配置，这些配置使用Kubernetes-spec目录中的Kubernetes对象配置。</p><ul class=""><li id="9c2f" class="mj mk jf ke b kf kg kj kk kn ml kr mm kv mn kz mo mp mq mr bi translated"><strong class="ke jg"> Kubernetes Spec目录内容:</strong></li></ul><p id="37ea" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如下图所示，应用程序堆栈配置分为日志记录、监控、db (shock-shop-db)、app (sock-shop)和zipkin (tracing)等单独的子目录，这些子目录构成了特定于服务的部署、服务、配置图和集群角色等。(基本上所有Kubernetes配置都需要部署app)。例如，Zipkin包含:Mysql部署、Mysql服务、Zipkin部署、Zipkin服务。</p><pre class="mf mg mh mi gt nq nr ns nt aw nu bi"><span id="bed8" class="nv lc jf nr b gy nw nx l ny nz">kubernetes-spec<br/>├── logging<br/>│   ├── elasticsearch.yml<br/>│   ├── fluentd-crb.yml<br/>│   ├── fluentd-daemon.yml<br/>│   ├── fluentd-sa.yaml<br/>│   └── kibana.yml<br/>├── logging-cr<br/>│   └── fluentd-cr.yml<br/>├── monitoring<br/>│   ├── grafana-dep.yaml<br/>│   ├── grafana-svc.yaml<br/>│   ├── prometheus-alertrules.yaml<br/>│   ├── prometheus-configmap.yaml<br/>│   ├── prometheus-crb.yml<br/>│   ├── prometheus-dep.yaml<br/>│   ├── prometheus-exporter-disk-usage-ds.yaml<br/>│   ├── prometheus-exporter-kube-state-dep.yaml<br/>│   ├── prometheus-exporter-kube-state-svc.yaml<br/>│   ├── prometheus-sa.yml<br/>│   └── prometheus-svc.yaml<br/>├── monitoring-cfg<br/>│   ├── grafana-configmap.yaml<br/>│   └── grafana-import-dash-batch.yaml<br/>├── monitoring-cr<br/>│   └── prometheus-cr.yml<br/>├── sock-shop-db<br/>│   ├── carts-db-dep.yaml<br/>│   ├── carts-db-svc.yaml<br/>│   ├── catalogue-db-dep.yaml<br/>│   ├── catalogue-db-svc.yaml<br/>│   ├── orders-db-dep.yaml<br/>│   ├── orders-db-svc.yaml<br/>│   ├── session-db-dep.yaml<br/>│   ├── session-db-svc.yaml<br/>│   ├── user-db-dep.yaml<br/>│   └── user-db-svc.yaml<br/>├── sock-shop-persist-db<br/>│   ├── carts-db-ss.yaml<br/>│   ├── carts-db-svc.yaml<br/>│   ├── catalogue-db-dep.yaml<br/>│   ├── catalogue-db-svc.yaml<br/>│   ├── orders-db-ss.yaml<br/>│   ├── orders-db-svc.yaml<br/>│   ├── session-db-dep.yaml<br/>│   ├── session-db-svc.yaml<br/>│   ├── user-db-ss.yaml<br/>│   └── user-db-svc.yaml<br/>├── sock-shop-usvc<br/>│   ├── carts-dep.yaml<br/>│   ├── carts-svc.yml<br/>│   ├── front-end-dep.yaml<br/>│   ├── front-end-svc.yaml<br/>│   ├── orders-dep.yaml<br/>│   ├── orders-svc.yaml<br/>│   ├── queue-master-dep.yaml<br/>│   ├── queue-master-svc.yaml<br/>│   ├── rabbitmq-dep.yaml<br/>│   ├── rabbitmq-svc.yaml<br/>│   ├── shipping-dep.yaml<br/>│   └── shipping-svc.yaml<br/>├── sock-shop-zipkin-usvc<br/>│   ├── catalogue-dep.yaml<br/>│   ├── catalogue-svc.yaml<br/>│   ├── payment-dep.yaml<br/>│   ├── payment-svc.yaml<br/>│   ├── user-dep.yaml<br/>│   └── user-svc.yaml<br/>└── zipkin<br/>    ├── zipkin-cron-dep.yml<br/>    ├── zipkin-dep.yaml<br/>    ├── zipkin-mysql-dep.yaml<br/>    ├── zipkin-mysql-svc.yaml<br/>    └── zipkin-svc.yaml</span><span id="13d5" class="nv lc jf nr b gy oa nx l ny nz">10 directories, 63 files</span></pre><ul class=""><li id="9f9c" class="mj mk jf ke b kf kg kj kk kn ml kr mm kv mn kz mo mp mq mr bi translated"><strong class="ke jg">工作流目录内容:</strong></li></ul><p id="31d6" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">工作流目录包含所有基于Argo的工作流配置，这些配置使用上述Kubernetes规范文件。</p><pre class="mf mg mh mi gt nq nr ns nt aw nu bi"><span id="dcb8" class="nv lc jf nr b gy nw nx l ny nz">workflows/<br/>├── logging-workflow.yaml<br/>├── monitoring-workflow.yaml<br/>├── sock-shop-persist-workflow.yaml<br/>└── sock-shop-workflow.yaml</span><span id="a622" class="nv lc jf nr b gy oa nx l ny nz">0 directories, 4 files</span></pre><p id="d7eb" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">请看上面的登录工作流示例:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ob"><img src="../Images/e88b33457dca91c71b1fa6e667346ecc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*N6v_IwXuFY4_a0W4"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">记录工作流配置</figcaption></figure><p id="6334" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">类似地，所有特定的工作流都使用特定的Kubernetes资源来无缝地部署应用程序，如下面的工作流所示。</p><ul class=""><li id="c28e" class="mj mk jf ke b kf kg kj kk kn ml kr mm kv mn kz mo mp mq mr bi translated"><strong class="ke jg">T3】伐木T5】</strong></li></ul><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi od"><img src="../Images/f38bc2421be7add108f7460ba6e1f50f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LzYocck2l7LraWgZ"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">记录工作流程</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oe"><img src="../Images/b0eb1b3a524337a2970c0e953d513d50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WUfCcfz945VsFV5Y"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Argo CLI查询日志记录工作流</figcaption></figure><p id="00a0" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如上所示，登录工作流创建了elastic search:deployment and service，Kibana: deployment and service，Fluentd: service account，daemonset。</p><ul class=""><li id="47be" class="mj mk jf ke b kf kg kj kk kn ml kr mm kv mn kz mo mp mq mr bi translated"><strong class="ke jg"> <em class="oc">监控</em> </strong></li></ul><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi of"><img src="../Images/758af186d47151a471362a4468d22c90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*z8SIFycPIy-QK8kp"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">监控工作流程</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi og"><img src="../Images/6d82c8b04f3e346b70857c5180eac112.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aVHleDbShDxc6Ome"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Argo CLI查询监控工作流</figcaption></figure><p id="9f7f" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如上所示，监控工作流为正在运行的Prometheus和Grafana堆栈创建所需的资源。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oh"><img src="../Images/d3c5ca325653aa94d7169727abf5c7b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*azV0NxsaCF9VtSRE"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Argo工作流引擎部署的Kubernetes资源</figcaption></figure><ul class=""><li id="b857" class="mj mk jf ke b kf kg kj kk kn ml kr mm kv mn kz mo mp mq mr bi translated"><strong class="ke jg"> <em class="oc">袜子店</em> </strong></li></ul><figure class="mf mg mh mi gt is gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/1d98a8a1d95bcc6a73346b46bad04d6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1148/0*gbJ0alKuXbxFnvLi"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">袜子店工作流程执行</figcaption></figure><p id="1c31" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如上所述，该工作流构成了一个多应用程序/模板工作流，其中Zipkin与具有依赖性需求的sock-shop一起部署。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oj"><img src="../Images/0e644be329f756f696889c24757cd753.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6dvbPon9xfxutrFQ"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">袜子店Argo工作流执行</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ok"><img src="../Images/0a3126867b57e27940e7f2a0e090ff05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KEKQ61_oVnEt0VN7"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Kubernetes上部署的袜子店</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ol"><img src="../Images/2f33f37bf53ec3f1d29dbb7e10ef1318.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*b0q3gr661ayeCd2n"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">应用程序跟踪组件</figcaption></figure><p id="ca92" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">有了它，一个成熟的应用程序与日志记录、监控和跟踪一起上线了。所有必需的服务都将基于所提供的配置来创建。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi om"><img src="../Images/e83b627d88f584b058cb93caf93c6690.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KcC0vpbAHjiMnPC6"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Kubernetes为上面创建的组件提供服务</figcaption></figure><p id="e118" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><em class="oc"> * </em> <strong class="ke jg"> <em class="oc">前端(网店)</em> </strong></p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi on"><img src="../Images/70ef244476f929242945110369d511d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9iIkXcTQ6Sy4NEwx"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Shock-Shop前端Web应用程序</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oo"><img src="../Images/c666573962769c83de16053d103ca4d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DXilViPLWRRPRKMb"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Shock-Shop前端Web应用程序—目录</figcaption></figure><p id="e2ca" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><em class="oc"> * </em> <strong class="ke jg"> <em class="oc">伐木(基巴纳)</em> </strong></p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi op"><img src="../Images/32109e3bfca9b90f627393bccd1471fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xVceu4kMgx_OqNq8"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">用于测井可视化的Kibana</figcaption></figure><p id="8553" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><em class="oc"> * </em> <strong class="ke jg"> <em class="oc">监控(普罗米修斯和格拉夫纳)</em> </strong></p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oq"><img src="../Images/8b8a77d988bbd92ac354eab1e471019a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZDJnLAwR0XMJQr3a"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">普罗米修斯进行监控</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi or"><img src="../Images/1c66fc1b8f51e46e753b9eac529396af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OCDxDnvDQwEINMQP"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">在Grafana上可视化普罗米修斯导出的度量</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi os"><img src="../Images/0f46d936c5ee58a918956071ce5fae89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*iLmrHjAMwomPvnCG"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">在Grafana上可视化普罗米修斯导出的度量</figcaption></figure><p id="7a5a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><em class="oc"> * </em> <strong class="ke jg"> <em class="oc">描摹(Zipkin) </em> </strong></p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi or"><img src="../Images/d41fc3c10f13a2addcd47904392c642a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*o9H1QQgHxN4iYCVb"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">使用Zipkin进行应用程序跟踪</figcaption></figure><p id="89be" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Argo通过将工作流引擎的丰富功能集与本机工件管理、准入控制、“fixtures”、对DinD (Docker-in-Docker)的内置支持以及策略相结合，在诸如传统CI/CD管道、具有顺序和并行步骤及依赖性的复杂作业、分布式应用的编排部署以及基于策略架构触发基于时间/事件的工作流等场景中具有极大的重要性。</p></div></div>    
</body>
</html>