<html>
<head>
<title>Lazy Load Apollo Link in Apollo Client</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Apollo客户端延迟加载Apollo链接</h1>
<blockquote>原文：<a href="https://itnext.io/lazy-load-apollo-link-in-apollo-client-f548e0254a16?source=collection_archive---------2-----------------------#2020-01-10">https://itnext.io/lazy-load-apollo-link-in-apollo-client-f548e0254a16?source=collection_archive---------2-----------------------#2020-01-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5a08" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">10行代码有所帮助</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/0f75955ca7b15fea6adbb55456a92089.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*RfC7JGqSpvpKeFCv.png"/></div></div></figure><h1 id="d87d" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">介绍</h1><p id="c259" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">这是一篇关于我的小图书馆的短文。</p><p id="e884" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><a class="ae mn" href="https://github.com/apollographql/apollo-client" rel="noopener ugc nofollow" target="_blank"> Apollo客户端</a>是GraphQL的一个库。<a class="ae mn" href="https://github.com/apollographql/apollo-link" rel="noopener ugc nofollow" target="_blank"> Apollo Link </a>是扩展Apollo客户端的接口。</p><p id="2051" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">通常，您会像这样初始化apollo客户机。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="212d" class="mt kv it mp b gy mu mv l mw mx">import { ApolloClient } from 'apollo-client';<br/>import { InMemoryCache } from 'apollo-cache-inmemory';<br/>import { HttpLink } from 'apollo-link-http';</span><span id="7557" class="mt kv it mp b gy my mv l mw mx">const cache = new InMemoryCache();<br/>const link = new HttpLink({ uri });</span><span id="997a" class="mt kv it mp b gy my mv l mw mx">const client = new ApolloClient({<br/>  cache: cache,<br/>  link: link,<br/>});</span></pre><p id="9269" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">我想在另一个文件中定义链接，并延迟加载它，因为它不是一个HttpLink，而是一个复杂的大链接。</p><h1 id="9588" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">如何使用</h1><p id="91b4" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">为此，我们使用<a class="ae mn" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import" rel="noopener ugc nofollow" target="_blank">动态导入</a>。</p><p id="5d7b" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">假设我们有一个导出阿波罗链接的<code class="fe mz na nb mp b">link.js</code>文件。如果能动态导入就好了。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="a40b" class="mt kv it mp b gy mu mv l mw mx">import { lazy } from 'apollo-link-lazy';</span><span id="3b78" class="mt kv it mp b gy my mv l mw mx">const link = lazy(() =&gt; import('./link'));</span></pre><p id="13a2" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><code class="fe mz na nb mp b">import()</code>返回一个承诺，但是没有<code class="fe mz na nb mp b">await</code>。这怎么可能？</p><h1 id="daed" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">如何实施</h1><p id="a25a" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">有趣的是，阿波罗链接本质上是异步的。然而，它不是基于承诺的。它有可观察的界面。</p><p id="5f5b" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">所以，你所需要的就是将承诺转化为可观察到的东西。</p><p id="925b" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">这是代码。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="138a" class="mt kv it mp b gy mu mv l mw mx">import { ApolloLink, fromPromise, toPromise, Observable } from 'apollo-link';</span><span id="02cc" class="mt kv it mp b gy my mv l mw mx">export const lazy = (factory) =&gt; new ApolloLink(<br/>  (operation, forward) =&gt; fromPromise(<br/>    factory().then((resolved) =&gt; {<br/>      const link = resolved instanceof ApolloLink ? resolved : resolved.default;<br/>      return toPromise(link.request(operation, forward) || Observable.of());<br/>    }),<br/>  ),<br/>);</span></pre><p id="ff33" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">幸运的是，阿波罗客户端导出了<code class="fe mz na nb mp b">fromPromise</code>和<code class="fe mz na nb mp b">toPromise</code>实用函数。因此，它可以很容易地实现。</p><p id="548a" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">这里的一个小技巧是同时支持ApolloLink承诺和默认导出。</p><h1 id="c795" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">演示</h1><p id="7b47" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">我开发这个代码作为一个库。</p><div class="nc nd gp gr ne nf"><a href="https://github.com/dai-shi/apollo-link-lazy" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd iu gy z fp nk fr fs nl fu fw is bi translated">戴-史/阿波罗-林克-懒惰</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">这是一个很小的库，用于延迟加载阿波罗链接。它对代码分割很有用。npm…</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">github.com</p></div></div><div class="no l"><div class="np l nq nr ns no nt ks nf"/></div></div></a></div><p id="3251" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">可以安装使用。它支持TypeScript。</p><p id="7274" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">这里还有一个codesandbox中的演示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><h1 id="9d9a" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">结束语</h1><p id="205a" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">由于我的动机是代码分割，支持像<a class="ae mn" href="https://reactjs.org/docs/code-splitting.html#reactlazy" rel="noopener ugc nofollow" target="_blank"> React.lazy </a>这样的默认导出实际上已经足够了。因为它也支持直接承诺，所以我们可以将它用于任何异步初始化，如下所示。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="bda1" class="mt kv it mp b gy mu mv l mw mx">import { lazy } from 'apollo-link-lazy';</span><span id="5e79" class="mt kv it mp b gy my mv l mw mx">const link = lazy(async () =&gt; {<br/>  // await ...<br/>  return new ApolloLink(...);<br/>});</span></pre><p id="3bfe" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">我希望这可以帮助其他尝试延迟加载apollo链接的开发者。</p></div><div class="ab cl nw nx hx ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="im in io ip iq"><p id="f562" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><em class="od">原载于2020年1月10日https://blog.axlight.com</em><a class="ae mn" href="https://blog.axlight.com/posts/lazy-load-apollo-link-in-apollo-client/" rel="noopener ugc nofollow" target="_blank"><em class="od"/></a><em class="od">。</em></p></div></div>    
</body>
</html>