<html>
<head>
<title>Useful commands to work with certificates</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用证书的有用命令</h1>
<blockquote>原文：<a href="https://itnext.io/useful-commands-to-work-with-certificates-402dac84bb75?source=collection_archive---------6-----------------------#2020-04-08">https://itnext.io/useful-commands-to-work-with-certificates-402dac84bb75?source=collection_archive---------6-----------------------#2020-04-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/80072d1d09a44558a1143196eace70a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SGGYxtGzWgOU2KH7N9q_pQ.png"/></div></div></figure><p id="44fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们好像终于切换到<em class="kw"> https </em>了。这意味着我们无时无刻不在使用证书，却常常不太注意它们。你如何<em class="kw">看到</em>一个证书的内容？将其转换为不同的格式？有许多有用的命令很难记住，除非你经常使用它们(或者，方便的话，找一个关于这个主题的帖子)。我想分享其中的一些，重点是从命令行做事情。也许你已经看过<a class="ae kx" href="https://www.sslshopper.com/article-most-common-openssl-commands.html" rel="noopener ugc nofollow" target="_blank">这篇关于OpenSSL命令的精彩文章</a>。我希望我能提供更多的背景。</p><p id="d7e9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">回顾一下，在使用<em class="kw"> https </em>时，我们通常使用证书来验证服务器的身份。但是，如果您使用mTLS，客户端也需要提供证书。X.509格式是我们在野外常见的格式。</p><p id="27d5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将使用一些方便的工具来完成这项工作，这些工具可以与<a class="ae kx" href="https://brew.sh/" rel="noopener ugc nofollow" target="_blank"> brew </a>一起安装，例如:</p><ul class=""><li id="9fb6" class="ky kz iq ka b kb kc kf kg kj la kn lb kr lc kv ld le lf lg bi translated"><a class="ae kx" href="https://github.com/FiloSottile/mkcert" rel="noopener ugc nofollow" target="_blank"> mkcert </a></li><li id="1e1f" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated"><a class="ae kx" href="https://www.openssl.org/" rel="noopener ugc nofollow" target="_blank"> openssl </a></li><li id="c617" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">base64</li></ul><h1 id="d53c" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">创建测试证书</h1><p id="19ec" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">要开始，我们需要一个证书。如果您拥有一个域，您将希望使用<a class="ae kx" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank"> LetsEncrypt </a>以编程方式生成一个域。出于演示的目的，我将使用<code class="fe mp mq mr ms b">mkcert</code>。</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="2d97" class="nb ln iq ms b gy nc nd l ne nf">mkcert -install <br/>mkcert example.com app1.example.com app2.example.com</span></pre><p id="a87f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">结果存储在<code class="fe mp mq mr ms b">example.com+2-key.pem</code>和<code class="fe mp mq mr ms b">example.com+2.pem</code>下</p><p id="ee45" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个证书是为三个域颁发的，使用所谓的<a class="ae kx" href="https://en.wikipedia.org/wiki/Subject_Alternative_Name" rel="noopener ugc nofollow" target="_blank"> SAN </a>，它扩展了<a class="ae kx" href="https://support.dnsimple.com/articles/what-is-common-name/" rel="noopener ugc nofollow" target="_blank">通用名称</a>，这样您就可以指定多个域。CN限于64个字符，这对于有很多子域的内部证书来说可能是个问题(不要问我是怎么学会这个的！).</p><p id="aae1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">即使它是自签名的，我们仍然可以验证它:</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="92d1" class="nb ln iq ms b gy nc nd l ne nf">openssl verify -CAfile ~/Library/Application\ Support/mkcert/rootCA.pem example.com+2.pem</span></pre><h1 id="61b7" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">阅读证书</h1><p id="adff" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">您可以使用以下方法读取证书:</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="1d20" class="nb ln iq ms b gy nc nd l ne nf">openssl x509 -in example.com+2.pem -text -noout</span></pre><p id="a69e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它显示了这样的内容:</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="8d81" class="nb ln iq ms b gy nc nd l ne nf">Certificate:<br/>    Data:<br/>        Version: 3 (0x2)<br/>        Serial Number:<br/>            d7:98:98:19:27:dd:52:d0:1f:1f:07:b5:ea:85:54:eb<br/>    Signature Algorithm: sha256WithRSAEncryption<br/>        Issuer: O=mkcert development CA, OU=me@my-computer (My Name), CN=mkcert me@my-computer (My Name)<br/>        Validity<br/>            Not Before: Jun  1 00:00:00 2019 GMT<br/>            Not After : Apr  6 20:21:32 2030 GMT<br/>        Subject: O=mkcert development certificate, OU=me@my-computer (My Name)<br/>        Subject Public Key Info:<br/>            Public Key Algorithm: rsaEncryption<br/>                Public-Key: (2048 bit)<br/>                Modulus:<br/>                    00:b1:b7:1b:14:f9:61:79:90:be:21:bc:91:12:78: (...)<br/>                Exponent: 65537 (0x10001)<br/>        X509v3 extensions:<br/>            X509v3 Key Usage: critical<br/>                Digital Signature, Key Encipherment<br/>            X509v3 Extended Key Usage: <br/>                TLS Web Server Authentication<br/>            X509v3 Basic Constraints: critical<br/>                CA:FALSE<br/>            X509v3 Authority Key Identifier: <br/>                keyid:34:0F:21:0C:F8:7D:D5:DF:E4:15:B6:15:B9:94:C9:2B:F3:E0:24:AD<br/><br/>            X509v3 Subject Alternative Name: <br/>                DNS:example.com, DNS:app1.example.com, DNS:app2.example.com<br/>    Signature Algorithm: sha256WithRSAEncryption<br/>         a8:52:3b:19:dc:74:4f:e3:6b:9c:cd:0c:59:c3:fe:e8:0b:2d: (...)</span></pre><p id="2208" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以在那里看到所有相关的信息。<em class="kw"> X509v3主题别名</em>往往是最有趣的部分，因为您可以看到证书覆盖的域。</p><h1 id="13ac" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">编码证书</h1><p id="4725" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">通常，证书以Base64 ASCII中的PEM格式存储。你通过开头的<code class="fe mp mq mr ms b">---- BEGIN CERTIFICATE----</code>线认出他们。例如，这就是<code class="fe mp mq mr ms b">mkcert</code>给我们的。</p><p id="20f0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有时，PEM证书本身以Base64编码传输。假设我们通过网络接收证书。我们把它存放在<code class="fe mp mq mr ms b">/tmp/b64-cert</code>下，它看起来是这样的:</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="d061" class="nb ln iq ms b gy nc nd l ne nf">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVlakNDQXVLZ0F3SUJBZ0lSQU5lWW1Ca24zVkxRSHg4SHRlcUZWT3N3RFFZSktvWklodmNOQVFFTEJRQXcKZ1lNeEhqQWNCZ05WQkFvVEZXMXJZMlZ5ZENCa1pYWmxiRzl3YldWdWRDQkRRVEVzTUNvR0ExVUVDd3dqYldabApjbTVoYm1SbGVrQm9hWE52YTJFZ0tFMWhjbWx2SUVabGNtNWhibVJsZWlreE16QXhCZ05WQkFNTUttMXJZMlZ5CmRDQnRabVZ5Ym1GdVpHVjZRR2hwYzI5cllTQW9UV0Z5YVc4Z1JtVnlibUZ1WkdWNktUQWVGdzB4T1RBMk1ERXcKTURBd01EQmFGdzB6TURBME1EWXlNREl4TXpKYU1GY3hKekFsQmdOVkJBb1RIbTFyWTJWeWRDQmtaWFpsYkc5dwpiV1Z1ZENCalpYSjBhV1pwWTJGMFpURXNNQ29HQTFVRUN3d2piV1psY201aGJtUmxla0JvYVhOdmEyRWdLRTFoCmNtbHZJRVpsY201aGJtUmxlaWt3Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLQW9JQkFRQ3gKdHhzVStXRjVrTDRodkpFU2VMNENTL3JET3RxbGZGN0syN1g3NERuQ0ExeHpDMlkwTkJxa1hPVWFka2VRZ1MrSgo4NVFZQlYrcWFFRGhZNVNMZm1MTGxkMmFWQnIvSG9MYVFuRDc4VXJuVHNHM1JJb2dEYlI0R25CQnJUc0ltQWk3CnRNeU1kVVZSc21EM1RYcmUxdFM4dmowL3RQNzE1UEQvRTd1Tk94M2VyYjUrQmtFY0JodElnbVU4ZUVybnpLMnEKNkV0N0tsUERwQm5mL2pySEM0ZU1URFBiRDhqeGZBRmhvZ2R0YUgrTGRxeDZ6Uk5mN2pTZXNXMTJNMW5JenpsTwpLa0IxaHBhOEZqc3Y3Ry9ONytFeHFzQzMrQjdaZHB5UWl5Zm8ydU1KL1lJQWJMN29sbnV5THF5UkZPNWNaNnp3Cjg5MG5lV1gweE5hWmE5bWo3RmNwQWdNQkFBR2pnWk13Z1pBd0RnWURWUjBQQVFIL0JBUURBZ1dnTUJNR0ExVWQKSlFRTU1Bb0dDQ3NHQVFVRkJ3TUJNQXdHQTFVZEV3RUIvd1FDTUFBd0h3WURWUjBqQkJnd0ZvQVVOQThoRFBoOQoxZC9rRmJZVnVaVEpLL1BnSkswd09nWURWUjBSQkRNd01ZSUxaWGhoYlhCc1pTNWpiMjJDRUdGd2NERXVaWGhoCmJYQnNaUzVqYjIyQ0VHRndjREl1WlhoaGJYQnNaUzVqYjIwd0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dHQkFLaFMKT3huY2RFL2phNXpOREZuRC91Z0xMYlNlV0NsVjFMSnFNU3NLbE16VXZ4aVlmKzdzeDZRUmxZcGtYeWpndVFUNwppRWZMWUhQZG8zeTJMNmFIaW9tbU1FUjNmWjAyMjJWUWJhV2hjUkJmUDgzdFhnQmdqN0pUZjArUUxjVERXZG9YCnd2KzZQNHNuNmVqV2xWc3drZTBQcjhLMm9DM1NyazVibjJFVVpQSU1oQnNMZFdmczBZbkZhRTFCY2ZlWGNVV0QKU3QzckRZcjFlSW1mQ1FTQ1BkU0ZwTU5HWS81dkdtWm5lVTNxbXlhS2hLNWZRREhkWVpQYlQ5NFE4ZDBVVXRaMgpEeWdxQmFmTG5oMWxmVHRRNi9NUjdIQlNWZCtWajcwRnFCajJlaEJlTXZhUDUrQlRCTEFCbWdoK0VMVHp6VTRUCmdHMHZuSzF2OUhvd1FDaVdadDkxZDRtdFRHbldJQVVHWGpKcDBjMmVHbU5NOUN4eVM0QTJNRXRJcngwZy9ESWQKNU9rMXZodnVJOTV4cWVOZ1E4UDBrOEF0VWlYdVp4Uk53M1FubHdLRzloMDhmVGJRc04rZEh1T2lhRWNPcWY4WgoxcStxakxQMlVsbmZYaGwyN25aUVgwZ3F5ZnROUldRV3pvc0V6cGh0RVpwdGJrVzZPUExhby9DNHhVRU5lQT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K</span></pre><p id="acc5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">是的，那是一条很长的线。<code class="fe mp mq mr ms b">openssl</code>不能开箱读取，所以我们必须先解码。此外，可能是因为一旦解码，行太长，这使<code class="fe mp mq mr ms b">openssl</code>感到困惑。我们将解码并折叠该字符串，以便可以再次读取证书:</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="781b" class="nb ln iq ms b gy nc nd l ne nf">base64 -d /tmp/b64-cert | fold -64 | openssl x509 -text -noout</span></pre><h1 id="4823" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">二进制证书</h1><p id="29a6" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">有时候你的证书是用二进制格式的<a class="ae kx" href="https://wiki.openssl.org/index.php/DER" rel="noopener ugc nofollow" target="_blank"> DER </a>编码的。<code class="fe mp mq mr ms b">JVM</code>世界真的很喜欢用这种方式运证。您会注意到，如果您检查这样的证书，它将主要是一堆特殊字符和胡言乱语。幸运的是，<code class="fe mp mq mr ms b">openssl</code>可以在两个方向上从DER转换到PEM。</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="567c" class="nb ln iq ms b gy nc nd l ne nf">openssl x509 -in example.com+2.pem -outform DER -out example.com+2.der<br/>openssl x509 -inform DER -in example.com+2.der -text -noout</span></pre><h1 id="620a" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">以base64url编码的二进制证书</h1><p id="f67e" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">如果您有一个DER格式的证书，并且已经用<a class="ae kx" href="https://base64.guru/standards/base64url" rel="noopener ugc nofollow" target="_blank"> base64url </a>进行了编码，该怎么办？你的第一个想法可能是，“这是一个奇怪的特定组合”。但这真的会发生。如果您正在实现自己的ACME服务器，请求证书是<a class="ae kx" href="https://tools.ietf.org/html/rfc8555#section-7.1.5" rel="noopener ugc nofollow" target="_blank">协议的一部分</a>。我最近花了相当多的时间试图弄明白这一点。</p><p id="2db6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">没有现成的工具来解码Base64 URL，但是您可以使用类似于<a class="ae kx" href="https://raw.githubusercontent.com/Moodstocks/moodstocks-api-clients/master/bash/base64url.sh" rel="noopener ugc nofollow" target="_blank">这个</a>的脚本。您可以通过结合脚本和前面的调用来阅读这个神秘的证书:</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="3392" class="nb ln iq ms b gy nc nd l ne nf">./base64url.sh decode `cat /tmp/b64url-cert | tr -d '\n'` | openssl x509 -inform DER -text -noout</span></pre><p id="10ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可能永远也不会遇到这种情况，但是如果你遇到了，这将会节省你大量的时间。</p><h1 id="4d73" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">检查远程服务器上的证书</h1><p id="3bf2" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">如果您没有证书，但想从远程服务器获取它，该怎么办？openssl 能够胜任这项任务。</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="f654" class="nb ln iq ms b gy nc nd l ne nf">openssl s_client -connect google.com:443 -servername google.com | openssl x509 -text -noout</span></pre><p id="b729" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用<code class="fe mp mq mr ms b">s_client</code>命令，我们请求特定端口(通常是443)上的主机提供的证书。在这种情况下，我们正在检查来自<em class="kw">google.com</em>的证书。我们可以将输出通过管道传输到读取证书的标准命令中。</p><p id="05ed" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可能想知道<code class="fe mp mq mr ms b">-servername</code>选项。那就是与<a class="ae kx" href="https://en.wikipedia.org/wiki/Server_Name_Indication" rel="noopener ugc nofollow" target="_blank"> SNI </a>有关。如果目标为同一IP地址下的多个域提供服务，您可能希望选择与某个域相关联的IP地址。我最近在测试一个提供自签名证书的Kubernetes <a class="ae kx" href="https://github.com/kubernetes/ingress-nginx" rel="noopener ugc nofollow" target="_blank"> nginx ingress </a>时需要这个选项，除非我指定了这个选项。</p><h1 id="a01a" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">我们只是触及了表面</h1><p id="a496" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">这篇文章的重点是阅读现有的证书，但是你可以用<code class="fe mp mq mr ms b">openssl</code>做更多的事情，包括写证书、提取密钥等等。更不用说<a class="ae kx" href="https://en.wikipedia.org/wiki/Certificate_signing_request" rel="noopener ugc nofollow" target="_blank">证书签名请求</a>。然而，阅读是熟悉证书的好地方。</p></div><div class="ab cl ng nh hu ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="ij ik il im in"><p id="77d6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw">原载于2020年4月8日https://hceris.com</em><em class="kw">的</em> <a class="ae kx" href="https://hceris.com/useful-commands-to-work-with-certificates/" rel="noopener ugc nofollow" target="_blank"> <em class="kw">。</em></a></p></div></div>    
</body>
</html>