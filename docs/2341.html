<html>
<head>
<title>Coding a countdown timer with RxJS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用RxJS编码倒计时器</h1>
<blockquote>原文：<a href="https://itnext.io/coding-a-countdown-timer-with-rxjs-b3d459935b41?source=collection_archive---------2-----------------------#2019-05-08">https://itnext.io/coding-a-countdown-timer-with-rxjs-b3d459935b41?source=collection_archive---------2-----------------------#2019-05-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e6d4" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在本教程中，我们将使用RxJS用几行代码构建一个非常简单的定时器应用程序。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/02f5a380fb2edae9e686a91eb155af43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*UqfNSA5wgWcEXphLsBXuUg.gif"/></div></div></figure><h2 id="3c40" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">试映</h2><p id="6dc5" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">在我们开始之前，您可以使用令人惊叹的Stackblitz查看结果。你可以在<a class="ae mg" href="https://rxjs-rajp6s.stackblitz.io" rel="noopener ugc nofollow" target="_blank">这个链接</a>看到一个预览。</p><p id="ceee" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">当你登陆页面时，计时器自动启动，你可以点击时间来停止它，再次点击重新启动计时器。</p><p id="7043" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">当时间结束时，会提示用户休息一下！这是一个非常简单的例子，所以计时器不会重新启动。</p><h2 id="cc79" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">常数</h2><p id="b72f" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">让我们首先定义一些我们将要使用的常数:</p><ul class=""><li id="a473" class="mm mn iq lp b lq mh lt mi la mo le mp li mq mf mr ms mt mu bi translated">我们定义<code class="fe mv mw mx my b">K</code>是因为我们会经常用到它，因为我们要处理毫秒，所以我们把<code class="fe mv mw mx my b">1000</code>赋值为值</li><li id="aea3" class="mm mn iq lp b lq mz lt na la nb le nc li nd mf mr ms mt mu bi translated">时间间隔是指更新计时器所需的时间。如果我们将它设置为<code class="fe mv mw mx my b">5000</code>，计时器将每5秒更新一次</li><li id="fd3a" class="mm mn iq lp b lq mz lt na la nb le nc li nd mf mr ms mt mu bi translated">我们设置分钟，我们希望我们的计时器长，它的时间以毫秒为单位</li></ul><pre class="kg kh ki kj gt ne my nf ng aw nh bi"><span id="bf6e" class="kr ks iq my b gy ni nj l nk nl">const K = 1000;<br/>const INTERVAL = K;<br/>const MINUTES = 25;<br/>const TIME = MINUTES * K * 60;</span></pre><h2 id="bab2" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">状态变量</h2><p id="5450" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">为了在暂停/恢复定时器时保持定时器的状态，我们定义了两个变量:</p><pre class="kg kh ki kj gt ne my nf ng aw nh bi"><span id="e453" class="kr ks iq my b gy ni nj l nk nl">let current: number;<br/>let time = TIME;</span></pre><ul class=""><li id="37f2" class="mm mn iq lp b lq mh lt mi la mo le mp li mq mf mr ms mt mu bi translated"><code class="fe mv mw mx my b">current</code>将每秒不断更新</li><li id="e841" class="mm mn iq lp b lq mz lt na la nb le nc li nd mf mr ms mt mu bi translated"><code class="fe mv mw mx my b">time</code>将在计时器停止时更新</li></ul><h2 id="63c2" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">助手功能</h2><p id="19df" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">我们定义了一些由我们的流使用的助手函数。我们希望:</p><ul class=""><li id="886e" class="mm mn iq lp b lq mh lt mi la mo le mp li mq mf mr ms mt mu bi translated">将剩余时间转换为毫秒和秒</li><li id="14f4" class="mm mn iq lp b lq mz lt na la nb le nc li nd mf mr ms mt mu bi translated">具有显示剩余分钟和秒钟的功能</li></ul><pre class="kg kh ki kj gt ne my nf ng aw nh bi"><span id="4301" class="kr ks iq my b gy ni nj l nk nl">const toMinutes = (ms: number) =&gt; <br/>    Math.floor(ms / K / 60);</span><span id="cfc8" class="kr ks iq my b gy nm nj l nk nl">const toSeconds = (ms: number) =&gt; <br/>    Math.floor(ms / K) % 60;</span><span id="f71c" class="kr ks iq my b gy nm nj l nk nl">const toSecondsString = (ms: number) =&gt; {<br/>    const seconds = toSeconds(ms);<br/>    return seconds &lt; 10 ? `0${seconds}` : seconds.toString();<br/>}</span><span id="7cdc" class="kr ks iq my b gy nm nj l nk nl">const toMs = (t: number) =&gt; t * INTERVAL;</span><span id="79ed" class="kr ks iq my b gy nm nj l nk nl">const currentInterval = () =&gt; time / INTERVAL;</span><span id="a6ed" class="kr ks iq my b gy nm nj l nk nl">const toRemainingSeconds = (t: number) =&gt; currentInterval() - t;</span></pre><h2 id="ae0e" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">定义接收流</h2><p id="9318" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">首先，我们定义了<code class="fe mv mw mx my b">timer$</code>流:</p><ul class=""><li id="7591" class="mm mn iq lp b lq mh lt mi la mo le mp li mq mf mr ms mt mu bi translated">我们使用可观察的创造者<code class="fe mv mw mx my b">timer</code>，它每<code class="fe mv mw mx my b">INTERVAL</code>次发射一次，这基本上意味着它将每秒发射一次</li></ul><p id="ac4e" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">该流将把从<code class="fe mv mw mx my b">timer</code>发出的毫秒转换成剩余的秒。</p><pre class="kg kh ki kj gt ne my nf ng aw nh bi"><span id="7844" class="kr ks iq my b gy ni nj l nk nl">const toggle$ = new BehaviorSubject(true);<br/>const remainingSeconds$ = toggle$.pipe(<br/>    switchMap((running: boolean) =&gt; {<br/>        return running ? timer(0, INTERVAL) : NEVER;<br/>    }),<br/>    map(toRemainingSeconds),<br/>    takeWhile(t =&gt; t &gt;= 0)<br/>);</span></pre><p id="f36e" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">让我们详细解释一下这是干什么的:</p><pre class="kg kh ki kj gt ne my nf ng aw nh bi"><span id="07ab" class="kr ks iq my b gy ni nj l nk nl"><strong class="my ir">toggle$ </strong>-&gt; true...false...true</span><span id="acd1" class="kr ks iq my b gy nm nj l nk nl">-----</span><span id="6e2b" class="kr ks iq my b gy nm nj l nk nl"><strong class="my ir">switchMap</strong> to:</span><span id="d280" class="kr ks iq my b gy nm nj l nk nl"><strong class="my ir">if toggle is true -&gt; timer(0, INTERVAL = 1000)</strong> -&gt; 0...1000...2000 <br/> <strong class="my ir">if toggle is false ? -&gt; </strong>NEVER = do not continue</span><span id="dbba" class="kr ks iq my b gy nm nj l nk nl">----</span><span id="8bcc" class="kr ks iq my b gy nm nj l nk nl"><strong class="my ir">map(toRemainingSeconds)</strong> -&gt; ms elapsed mapped to remaining seconds (ex. 1500)</span><span id="4ce0" class="kr ks iq my b gy nm nj l nk nl">----</span><span id="545c" class="kr ks iq my b gy nm nj l nk nl"><strong class="my ir">takeWhile(remainingSeconds)</strong> -&gt; complete once <strong class="my ir">remainingSeconds$'s </strong>value<strong class="my ir"> </strong>is no more &gt;= 0</span></pre><p id="182e" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">让我们考虑一下所使用的运算符:</p><ul class=""><li id="b2c5" class="mm mn iq lp b lq mh lt mi la mo le mp li mq mf mr ms mt mu bi translated">映射器<code class="fe mv mw mx my b">toSeconds</code>将把可观测值返回的毫秒数转换成剩余的秒数</li><li id="486e" class="mm mn iq lp b lq mz lt na la nb le nc li nd mf mr ms mt mu bi translated">通过使用操作符<code class="fe mv mw mx my b">takeWhile</code>,我们基本上是在告诉<code class="fe mv mw mx my b">remainingSeconds$</code>观察值继续前进，直到剩余的秒数大于或等于0</li><li id="89d3" class="mm mn iq lp b lq mz lt na la nb le nc li nd mf mr ms mt mu bi translated">此后，<code class="fe mv mw mx my b">remainingSeconds$</code>将发出它的完成回调，我们可以用它来用一些其他内容替换计时器</li></ul><p id="1566" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">在创建我们将显示的相对分钟和秒钟之前，我们希望能够停止和恢复计时器。</p><p id="e8cf" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">如果<code class="fe mv mw mx my b">toggle$</code>以<code class="fe mv mw mx my b">true</code>为值发出，计时器继续运行，而如果它以<code class="fe mv mw mx my b">false</code>发出，它将停止，因为它将发出可观测的<code class="fe mv mw mx my b">NEVER</code>，而不是映射到<code class="fe mv mw mx my b">remainingSeconds$</code>。</p><h2 id="07b6" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">暂停和恢复计时器</h2><p id="263c" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">通过使用<code class="fe mv mw mx my b">fromEvent</code>，我们可以监听点击事件，并通过切换其当前值来更新行为主体。</p><pre class="kg kh ki kj gt ne my nf ng aw nh bi"><span id="cd95" class="kr ks iq my b gy ni nj l nk nl">const toggleElement = document.querySelector('.timer');</span><span id="18f2" class="kr ks iq my b gy nm nj l nk nl">fromEvent(toggleElement, ‘click’).subscribe(() =&gt; {<br/>    toggle$.next(!toggle$.value);<br/>});</span></pre><p id="2b30" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">但是<code class="fe mv mw mx my b">toggle$</code>还做了其他事情:</p><ul class=""><li id="8cd1" class="mm mn iq lp b lq mh lt mi la mo le mp li mq mf mr ms mt mu bi translated">每次计时器停止时，我们都希望用当前时间更新时间变量，这样下次计时器重新启动时，它将从当前时间重新启动。</li></ul><pre class="kg kh ki kj gt ne my nf ng aw nh bi"><span id="3e82" class="kr ks iq my b gy ni nj l nk nl">toggle$.pipe(<br/>    filter((toggled: boolean) =&gt; !toggled)<br/>).subscribe(() =&gt; {<br/>    time = current;<br/>});</span></pre><p id="b139" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">现在，我们可以定义用于显示分钟和秒钟的毫秒可观测值:</p><pre class="kg kh ki kj gt ne my nf ng aw nh bi"><span id="4066" class="kr ks iq my b gy ni nj l nk nl">const ms$ = time$.pipe(<br/>    map(toMs),<br/>    tap(t =&gt; current = t)<br/>);</span></pre><p id="c5d6" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">每次<code class="fe mv mw mx my b">ms$</code>发出时，我们使用<code class="fe mv mw mx my b">tap</code>操作符来更新有状态变量<code class="fe mv mw mx my b">current</code>。</p><p id="1a51" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">接下来，我们将通过重用本文前面定义的助手方法来定义分钟和秒钟。</p><pre class="kg kh ki kj gt ne my nf ng aw nh bi"><span id="c540" class="kr ks iq my b gy ni nj l nk nl">const minutes$ = ms$.pipe(<br/>    map(toMinutesDisplay),<br/>    map(s =&gt; s.toString()),<br/>    startWith(toMinutesDisplay(time).toString())<br/>);</span><span id="3624" class="kr ks iq my b gy nm nj l nk nl">const seconds$ = ms$.pipe(<br/>    map(toSecondsDisplayString),<br/>    startWith(toSecondsDisplayString(time).toString())<br/>);</span></pre><p id="57fb" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">就是这样！我们的流已经准备好了，现在可以更新DOM了。</p><h2 id="3392" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">更新DOM</h2><p id="3e93" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">我们定义了一个名为<code class="fe mv mw mx my b">updateDom</code>的简单函数，它将一个可观察对象作为第一个参数，将一个HTML元素作为第二个参数。每次源发出，都会更新节点的<code class="fe mv mw mx my b">innerHTML</code>。</p><pre class="kg kh ki kj gt ne my nf ng aw nh bi"><span id="2bd5" class="kr ks iq my b gy ni nj l nk nl">// HTML<br/>&lt;div class="timer"&gt;<br/>    &lt;span class="minutes"&gt;&lt;/span&gt;<br/>    &lt;span&gt;:&lt;/span&gt;<br/>    &lt;span class="seconds"&gt;&lt;/span&gt;<br/>&lt;/div&gt;</span><span id="9af1" class="kr ks iq my b gy nm nj l nk nl">-----</span><span id="49be" class="kr ks iq my b gy nm nj l nk nl">// DOM nodes<br/>const minutesElement = document.querySelector('.minutes');<br/>const secondsElement = document.querySelector('.seconds');</span><span id="e65a" class="kr ks iq my b gy nm nj l nk nl">updateDom(minutes$, minutesElement);<br/>updateDom(seconds$, secondsElement);</span><span id="1733" class="kr ks iq my b gy nm nj l nk nl">function updateDom(source$: Observable&lt;string&gt;, element: Element) {<br/>    source$.subscribe((value) =&gt; element.innerHTML = value);<br/>}</span></pre><p id="7f9d" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">最后，我们希望在计时器停止时显示一条消息:</p><pre class="kg kh ki kj gt ne my nf ng aw nh bi"><span id="dbcf" class="kr ks iq my b gy ni nj l nk nl">timer$.subscribe({<br/>    complete: () =&gt; updateDom(of('Take a break!'), toggleElement)<br/>});</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/92b3974d19fef101fff0bee9e9d3e9ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*viwakc1HIU6SKXtrXgTLPw.gif"/></div></div></figure><p id="ac5f" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">您可以在<a class="ae mg" href="https://stackblitz.com/edit/rxjs-rajp6s?file=index.ts" rel="noopener ugc nofollow" target="_blank"> Stackblitz </a>上找到完整的代码片段。</p><p id="bed9" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">希望你喜欢这篇文章，如果你同意，不同意，或者如果你想做任何不同的事情，请留言！</p></div><div class="ab cl nn no hu np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="ij ik il im in"><p id="b1d9" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated"><em class="nu">如果你喜欢这篇文章，请关注我的</em><a class="ae mg" href="https://medium.com/@.gc" rel="noopener"><em class="nu">Medium</em></a><em class="nu">或</em><a class="ae mg" href="https://twitter.com/home" rel="noopener ugc nofollow" target="_blank"><em class="nu">Twitter</em></a><em class="nu">以获取更多关于Angular、RxJS、Typescript等的文章！</em></p></div><div class="ab cl nn no hu np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="ij ik il im in"><p id="7d50" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated"><em class="nu">原发布于</em><a class="ae mg" href="https://frontend.consulting/a-simple-countdown-with-rx-js" rel="noopener ugc nofollow" target="_blank"><em class="nu">https://frontend . consulting</em></a><em class="nu">。</em></p></div></div>    
</body>
</html>