<html>
<head>
<title>GTM Stack: IoT Data Analytics at the Edge</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GTM堆栈:边缘的物联网数据分析</h1>
<blockquote>原文：<a href="https://itnext.io/iot-data-analytics-at-the-edge-d116b6681d7b?source=collection_archive---------1-----------------------#2020-10-09">https://itnext.io/iot-data-analytics-at-the-edge-d116b6681d7b?source=collection_archive---------1-----------------------#2020-10-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5351" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">利用基于ARM架构的Grafana、Mosquitto和TimescaleDB探索边缘物联网数据分析</h2></div><p id="be9d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le">在接下来的文章中，我们将探讨几个开源软件应用程序的集成，以构建一个物联网边缘分析堆栈，旨在基于ARM的边缘节点上运行。我们将使用堆栈来收集、分析和可视化物联网数据，而无需首先将数据传输到云或其他外部系统。</em></p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/1a36479acfcb7692a0eb16e997463eff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bI8wnC7Jv2Dr-aO_hV0c0g.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">GMT物联网边缘分析堆栈架构(I <em class="lv">作者</em>的图像)</figcaption></figure><h1 id="8b9f" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">边缘</h1><p id="7a3b" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">边缘计算是一种快速发展的技术趋势，它涉及到将计算能力推向<em class="le">边缘</em>。<a class="ae mt" href="https://en.wikipedia.org/wiki/Edge_computing" rel="noopener ugc nofollow" target="_blank">维基百科</a>将边缘计算描述为一种分布式计算范式，它将计算和数据存储带到更靠近所需位置的地方，以缩短响应时间并节省带宽。术语<em class="le">边缘</em>通常是指网络边缘的计算节点(<em class="le">边缘设备</em>)，位于数据源附近，在数据源和外部系统(如云)之间。</p><p id="6bea" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在他最近的文章<a class="ae mt" href="https://www.linkedin.com/pulse/3-advantages-1-disadvantage-edge-computing-bernard-marr/" rel="noopener ugc nofollow" target="_blank">边缘计算的3个优点(和1个缺点)</a>中，著名的未来学家Bernard Marr认为降低带宽需求、减少延迟、增强安全性和隐私性是边缘计算的三个主要优点。Marr建议，由于数据下采样等技术，边缘计算的一个潜在缺点是，在寻求节省带宽和减少延迟的过程中，重要数据可能会被忽略和丢弃。</p><p id="2646" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Quiss Technology PLC的营销主管David Ricketts在他的帖子<a class="ae mt" href="https://www.linkedin.com/pulse/cloud-edge-computing-stats-you-need-know-2018-david-ricketts/" rel="noopener ugc nofollow" target="_blank">云计算和边缘计算——2018年你需要知道的统计数据</a>中估计，到2022年，全球边缘计算市场预计将达到67.2亿美元，年复合增长率高达35.4%。意识到市场潜力，许多主要的云提供商、边缘设备制造商和集成商正在快速扩展他们的边缘计算能力。例如，<a class="ae mt" href="https://aws.amazon.com/edge/" rel="noopener ugc nofollow" target="_blank">AWS目前在边缘计算领域提供了</a>十几项服务。</p><h1 id="7f47" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">物联网</h1><p id="b546" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">边缘计算经常与物联网(IoT)联系在一起。物联网设备、工业设备和传感器生成数据，这些数据通常通过边缘节点(如物联网网关)传输到其他内部和外部系统。物联网设备通常会生成时序数据。根据维基百科的说法，时间序列是一组按时间顺序排列的数据点——在连续的等距时间点上拍摄的序列。物联网设备通常会生成持续的高容量时序数据流，通常每秒钟数百万个数据点。物联网数据特征要求物联网平台最低限度地支持时态准确性、大容量摄取和处理、高效的数据压缩和下采样以及实时查询功能。</p><p id="7487" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">物联网设备和边缘设备，如物联网网关，将物联网数据从这些设备聚合并传输到外部系统，通常功耗较低，处理器、内存和存储能力有限。因此，物联网平台必须满足物联网数据的所有要求，同时支持资源受限的环境。</p><h1 id="adf2" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">边缘的物联网分析</h1><p id="34c4" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">领先的云提供商AWS、Azure、谷歌云、IBM云、甲骨文云和阿里云都提供物联网服务。许多公司提供具有边缘计算能力的物联网服务。AWS提供<a class="ae mt" href="https://aws.amazon.com/greengrass/" rel="noopener ugc nofollow" target="_blank"> AWS物联网绿草</a>。Greengrass为边缘设备提供本地计算、消息传递、数据管理、同步和ML推理功能。Azure提供<a class="ae mt" href="https://azure.microsoft.com/en-us/services/iot-edge/" rel="noopener ugc nofollow" target="_blank"> Azure IoT Edge </a>。Azure IoT Edge提供了在使用标准容器的边缘设备上运行AI、Azure和第三方服务以及自定义业务逻辑的能力。谷歌云提供<a class="ae mt" href="https://cloud.google.com/edge-tpu" rel="noopener ugc nofollow" target="_blank">边缘TPU </a>。Edge TPU(张量处理单元)是谷歌专门打造的专用集成电路(ASIC)，旨在边缘运行人工智能。</p><h2 id="5889" class="mu lx it bd ly mv mw dn mc mx my dp mg kr mz na mi kv nb nc mk kz nd ne mm nf bi translated">物联网分析</h2><p id="b566" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">许多云提供商也提供物联网分析作为其物联网服务套件的一部分，尽管不是在边缘。AWS提供<a class="ae mt" href="https://aws.amazon.com/iot-analytics" rel="noopener ugc nofollow" target="_blank"> AWS物联网分析</a>，而Azure拥有<a class="ae mt" href="https://azure.microsoft.com/en-us/services/time-series-insights/#features" rel="noopener ugc nofollow" target="_blank"> Azure时序洞察</a>。谷歌通过<a class="ae mt" href="https://cloud.google.com/solutions/iot" rel="noopener ugc nofollow" target="_blank">下游分析系统</a>和使用<a class="ae mt" href="https://cloud.google.com/bigquery" rel="noopener ugc nofollow" target="_blank">谷歌BigQuery </a>的特别分析或使用<a class="ae mt" href="https://cloud.google.com/ml-engine" rel="noopener ugc nofollow" target="_blank">云机器学习引擎</a>的高级分析和机器学习，间接地提供物联网分析。这些服务通常都需要将数据传输到云中进行分析。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi ng"><img src="../Images/d95f426a046675da1c8d82dbcdec6a2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ddcEzHaU9IAecdfyTHKxYw.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">以云为中心的物联网平台数据流(作者的图片)</figcaption></figure><p id="8e8c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">随着数据实时流动，在边缘分析物联网数据的能力对于快速反馈循环至关重要。物联网边缘分析可以加快异常检测，提高预测性维护能力，并加快主动库存补充。</p><h1 id="b859" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">物联网边缘分析堆栈</h1><p id="8c32" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">在我看来，理想的物联网边缘分析堆栈由轻量级、专门构建、易于部署和管理、平台和编程语言无关的开源软件组件组成。最小的物联网边缘分析堆栈应该包括一个轻量级消息代理、一个时序数据库、一个ANSI标准的特别查询引擎和一个数据可视化工具。每个组件都应为物联网量身打造。</p><h2 id="3a8e" class="mu lx it bd ly mv mw dn mc mx my dp mg kr mz na mi kv nb nc mk kz nd ne mm nf bi translated">轻量级消息代理</h2><p id="de5c" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">我们将使用<a class="ae mt" href="https://mosquitto.org/" rel="noopener ugc nofollow" target="_blank">Eclipse mosquito</a>作为我们的消息代理。根据该项目的描述，Mosquitto是一个开源的消息代理，它实现了<a class="ae mt" href="https://en.wikipedia.org/wiki/MQTT" rel="noopener ugc nofollow" target="_blank">消息队列遥测传输</a> (MQTT)协议版本5.0、3.1.1和3.1。Mosquitto是轻量级的，适用于从低功耗单板计算机(SBC)到全服务器的所有设备。</p><h2 id="3060" class="mu lx it bd ly mv mw dn mc mx my dp mg kr mz na mi kv nb nc mk kz nd ne mm nf bi translated">MQTT客户端库</h2><p id="bb6f" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">我们将使用<a class="ae mt" href="https://www.eclipse.org/paho/" rel="noopener ugc nofollow" target="_blank"> Eclipse Paho </a>与Mosquitto进行交互。根据该项目，Eclipse Paho项目提供了开源的、主要是客户端的MQTT和MQTT-SN的各种编程语言的实现。传感器网络的MQTT和<a class="ae mt" href="https://www.u-blox.com/en/blogs/insights/mqtt-sn" rel="noopener ugc nofollow" target="_blank">MQTT</a>(MQTT-SN)分别是TCP/IP和UDP等无连接协议的轻量级发布/订阅消息传输。</p><p id="51d8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将使用泛美卫生组织的Python客户端。<a class="ae mt" href="https://www.eclipse.org/paho/index.php?page=clients/python/index.php" rel="noopener ugc nofollow" target="_blank"> Paho Python客户端</a>提供了一个客户端类，支持Python 2.7或3.x上的MQTT v3.1和v3.1.1。该客户端还提供了助手函数，使向MQTT服务器发布消息变得简单明了。</p><h2 id="5fdf" class="mu lx it bd ly mv mw dn mc mx my dp mg kr mz na mi kv nb nc mk kz nd ne mm nf bi translated">时间序列数据库</h2><p id="03d9" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">时序数据库最适合存储物联网数据。<a class="ae mt" href="https://www.influxdata.com/time-series-database/" rel="noopener ugc nofollow" target="_blank">据领先的时间序列数据库制造商InfluxData </a>称，<a class="ae mt" href="https://www.influxdata.com/products/influxdb-overview/" rel="noopener ugc nofollow" target="_blank"> InfluxDB </a>是一个时间序列数据库(TSDB)，是一个为时间戳或时间序列数据优化的数据库。时间序列数据只是随着时间的推移而被跟踪、监控、缩减采样和聚合的测量值或事件。阿里云的焦贤就时序数据库生态系统撰写了一篇颇有见地的文章，<a class="ae mt" href="https://www.alibabacloud.com/blog/what-are-time-series-databases_595165#" rel="noopener ugc nofollow" target="_blank">什么是时序数据库？</a>一些领先的云提供商提供专门构建的时间序列数据库，尽管它们在边缘不可用。AWS提供<a class="ae mt" href="https://aws.amazon.com/timestream" rel="noopener ugc nofollow" target="_blank">亚马逊时间流</a>阿里云提供<a class="ae mt" href="https://www.alibabacloud.com/product/hitsdb" rel="noopener ugc nofollow" target="_blank">时间序列数据库</a>。</p><p id="d6a7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">InfluxDB是时序数据库的绝佳选择。在开发这个堆栈时，它是我的第一选择，还有TimescaleDB。然而，<a class="ae mt" href="https://www.influxdata.com/" rel="noopener ugc nofollow" target="_blank"> InfluxDB </a> Flux与一些基于ARM的架构明显不兼容，因此排除了将其包含在本文的堆栈中。</p><p id="fd6b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将使用<a class="ae mt" href="https://www.timescale.com/" rel="noopener ugc nofollow" target="_blank">时标数据库</a>作为我们的时间序列数据库。TimescaleDB是领先的时序数据开源关系数据库。TimescaleDB被描述为“时间序列的PostgreSQL”，它基于PostgreSQL，提供完整的ANSI SQL、坚如磐石的可靠性和庞大的生态系统。TimescaleDB声称其查询速度比PostgreSQL、InfluxDB和MongoDB快10到100倍，并针对时序分析进行了本机优化。</p><p id="1461" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">TimescaleDB设计用于执行分析查询，通过其对PostgreSQL的全部SQL功能的本机支持，以及TimescaleDB本机的<a class="ae mt" href="https://docs.timescale.com/latest/using-timescaledb/reading-data#advanced-analytics" rel="noopener ugc nofollow" target="_blank">附加函数</a>。这些时序优化函数包括中位数/百分位数、累积和、移动平均、增长率、比率、增量、时段、直方图和差距填充。</p><h2 id="2171" class="mu lx it bd ly mv mw dn mc mx my dp mg kr mz na mi kv nb nc mk kz nd ne mm nf bi translated">特定数据查询引擎</h2><p id="b523" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">我们可以选择使用基于终端的PostgreSQL前端<code class="fe nh ni nj nk b">psql</code>，对TimescaleDB执行特定查询。<code class="fe nh ni nj nk b">psql</code>前端使您能够交互式地输入查询，将它们发送给PostgreSQL，并查看查询结果。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nl"><img src="../Images/3ee9c51bc847acbd8fe48e4b23b932a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J-oAdvmGGwd6A25Ecr-e4w.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">用于查询TimescaleDB数据库的基于psql终端的界面视图</figcaption></figure><p id="7717" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们还可以选择使用<a class="ae mt" href="https://www.pgadmin.org/" rel="noopener ugc nofollow" target="_blank"> pgAdmin </a>，特别是<a class="ae mt" href="https://hub.docker.com/r/biarms/pgadmin4" rel="noopener ugc nofollow" target="_blank"> biarms/pgadmin4 </a> Docker版本，来执行特定查询和大多数其他数据库任务。pgAdmin是PostgreSQL最流行的开源管理和开发平台。虽然几个流行的Docker版本的<a class="ae mt" href="https://www.pgadmin.org/" rel="noopener ugc nofollow" target="_blank"> pgAdmin </a>只支持Linux AMD64架构，但是<a class="ae mt" href="https://hub.docker.com/r/biarms/pgadmin4" rel="noopener ugc nofollow" target="_blank"> biarms/pgadmin4 </a> Docker版本支持基于ARM的设备。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nm"><img src="../Images/d419f27a652588ef1492d9264def143c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4fLTeHxkiioUAsZGN4_npQ.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">pgAdmin UI中TimescaleDB数据库的仪表板视图</figcaption></figure><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nm"><img src="../Images/759cc2afde66ac4f36e47667f60fb32a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YDu7ABqW_juLmuMZtPMchQ.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">使用pgAdmin的查询工具对TimescaleDB数据库执行查询</figcaption></figure><h2 id="2655" class="mu lx it bd ly mv mw dn mc mx my dp mg kr mz na mi kv nb nc mk kz nd ne mm nf bi translated">数据可视化</h2><p id="1935" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">对于数据可视化，我们将使用Grafana。<a class="ae mt" href="https://grafana.com/" rel="noopener ugc nofollow" target="_blank"> Grafana </a>允许您查询、可视化、提醒和理解指标，无论它们存储在哪里。借助Grafana，您可以创建、探索和共享仪表板，培养数据驱动的文化。Grafana允许您直观地定义阈值，并通过Slack、PagerDuty等得到通知。Grafana支持<a class="ae mt" href="https://grafana.com/grafana/plugins?type=datasource" rel="noopener ugc nofollow" target="_blank">几十种</a>数据源，包括MySQL、PostgreSQL、Elasticsearch、InfluxDB、TimescaleDB、Graphite、Prometheus、Google BigQuery、GraphQL和Oracle。Grafana可通过一个<a class="ae mt" href="https://grafana.com/grafana/plugins" rel="noopener ugc nofollow" target="_blank">大型插件集合</a>进行扩展。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nn"><img src="../Images/e3fb103b72824e93ee02ed3e0199482b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xP9YAz5vjT7cLutOJOZLkg.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">显示邮报物联网传感器数据的Grafana仪表板示例</figcaption></figure><h2 id="a300" class="mu lx it bd ly mv mw dn mc mx my dp mg kr mz na mi kv nb nc mk kz nd ne mm nf bi translated">边缘部署和管理平台</h2><p id="b765" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">Docker在2013年推出了集装箱的现行行业标准。Docker <a class="ae mt" href="https://www.docker.com/resources/what-container" rel="noopener ugc nofollow" target="_blank"> containers </a>是一个标准化的软件单元，允许开发人员将应用程序与他们的环境隔离开来。我们将使用Docker将物联网边缘分析堆栈(这里称为GTM堆栈)部署到基于ARM的边缘节点，该堆栈由Eclipse <strong class="kk iu"> M </strong> osquitto、<strong class="kk iu"> T </strong> imescaleDB和<strong class="kk iu"> G </strong> rafana以及pgAdmin的容器化版本组成。缩写GTM来自于组成这个堆栈的三个主要的OSS项目。这个首字母缩写词还暗示了<strong class="kk iu">G</strong>reenwich<strong class="kk iu">M</strong>ean<strong class="kk iu">T</strong>ime，与物联网数据的精确时序性质有关。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/1a36479acfcb7692a0eb16e997463eff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bI8wnC7Jv2Dr-aO_hV0c0g.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">GMT物联网边缘分析堆栈架构(作者为我<em class="lv">的图片</em></figcaption></figure><p id="3cea" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在swarm模式下运行Docker引擎，我们可以使用Docker将完整的物联网边缘分析堆栈部署到swarm，运行在边缘节点上。deploy命令接受Docker Compose文件形式的堆栈描述，Docker Compose文件是用于配置应用程序服务的YAML文件。只需一个命令，我们就可以从配置文件中创建并启动所有服务。</p><h1 id="87b8" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">源代码</h1><p id="354c" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">这篇文章的所有源代码可以在<a class="ae mt" href="https://github.com/garystafford/iot-analytics-at-the-edge" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。使用下面的命令来<code class="fe nh ni nj nk b">git clone</code>项目的本地副本。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="no np l"/></div></figure><h1 id="7bb6" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">物联网设备</h1><p id="71e6" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">在这篇文章中，我部署了三个基于Linux ARM的物联网设备，每个设备都连接到一个传感器阵列。每个传感器阵列包含多个模拟和数字传感器。传感器记录温度、湿度、空气质量(液化石油气(LPG)、一氧化碳(CO)和烟雾)、光线和运动。有关物联网设备和传感器硬件的更多信息，请参见我以前的帖子。</p><div class="nq nr gp gr ns nt"><a href="https://towardsdatascience.com/getting-started-with-iot-analytics-on-aws-5f2093bcf704" rel="noopener follow" target="_blank"><div class="nu ab fo"><div class="nv ab nw cl cj nx"><h2 class="bd iu gy z fp ny fr fs nz fu fw is bi translated">AWS物联网分析入门</h2><div class="oa l"><h3 class="bd b gy z fp ny fr fs nz fu fw dk translated">借助AWS物联网分析，近乎实时地分析来自物联网设备的环境传感器数据</h3></div><div class="ob l"><p class="bd b dl z fp ny fr fs nz fu fw dk translated">towardsdatascience.com</p></div></div><div class="oc l"><div class="od l oe of og oc oh lp nt"/></div></div></a></div><p id="8607" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">每个基于ARM的物联网设备都运行一个基于Python3的小脚本，<a class="ae mt" href="https://github.com/garystafford/iot-analytics-at-the-edge/blob/main/scripts/sensor_data_to_mosquitto.py" rel="noopener ugc nofollow" target="_blank">sensor _ data _ to _ mosquitto . py</a>，如下所示。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="2126" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">物联网设备的脚本实现了<a class="ae mt" href="http://eclipse.org/paho/" rel="noopener ugc nofollow" target="_blank"> Eclipse Paho </a> MQTT Python客户端库。包含来自每个传感器的同步读数的MQTT消息以可配置的频率发送到边缘节点上的Mosquitto主题。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="no np l"/></div></figure><h1 id="3ed6" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">物联网边缘节点</h1><p id="56cb" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">在这篇文章中，我部署了一个基于Linux ARM的边缘节点。这三个包含传感器阵列的物联网设备通过Wi-Fi与边缘节点通信。物联网设备可以轻松使用替代通信协议，如BLE、LoRaWAN或以太网。想了解更多关于BLE和劳拉旺的信息，请看我以前的一些帖子。</p><div class="nq nr gp gr ns nt"><a rel="noopener  ugc nofollow" target="_blank" href="/lora-for-iot-1f91085c5917"><div class="nu ab fo"><div class="nv ab nw cl cj nx"><h2 class="bd iu gy z fp ny fr fs nz fu fw is bi translated">面向物联网的LoRa和LoRaWAN</h2><div class="oa l"><h3 class="bd b gy z fp ny fr fs nz fu fw dk translated">面向物联网低功耗广域网的LoRa和LoRaWAN协议入门</h3></div><div class="ob l"><p class="bd b dl z fp ny fr fs nz fu fw dk translated">itnext.io</p></div></div><div class="oc l"><div class="oi l oe of og oc oh lp nt"/></div></div></a></div><div class="nq nr gp gr ns nt"><a rel="noopener  ugc nofollow" target="_blank" href="/ble-and-gatt-for-iot-2ae658baafd5"><div class="nu ab fo"><div class="nv ab nw cl cj nx"><h2 class="bd iu gy z fp ny fr fs nz fu fw is bi translated">BLE与关贸总协定的物联网</h2><div class="oa l"><h3 class="bd b gy z fp ny fr fs nz fu fw dk translated">物联网蓝牙低能耗(BLE)和通用属性配置文件(GATT)规范入门</h3></div><div class="ob l"><p class="bd b dl z fp ny fr fs nz fu fw dk translated">itnext.io</p></div></div><div class="oc l"><div class="oj l oe of og oc oh lp nt"/></div></div></a></div><p id="006b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">边缘节点还运行一个基于Python3的小脚本，<a class="ae mt" href="https://github.com/garystafford/iot-analytics-at-the-edge/blob/main/scripts/mosquitto_to_timescaledb.py" rel="noopener ugc nofollow" target="_blank">mosquitto _ to _ timescaledb . py</a>，如下所示。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="d999" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">与物联网设备类似，边缘节点的脚本实现了<a class="ae mt" href="http://eclipse.org/paho/" rel="noopener ugc nofollow" target="_blank"> Eclipse Paho </a> MQTT Python客户端库。该脚本从Mosquitto主题中提取MQTT消息，将消息负载序列化为JSON，并将负载数据写入TimescaleDB数据库。edge节点的脚本接受几个参数，这些参数允许您配置必要的Mosquitto和TimescaleDB变量。</p><h2 id="b958" class="mu lx it bd ly mv mw dn mc mx my dp mg kr mz na mi kv nb nc mk kz nd ne mm nf bi translated">为什么不用Telegraf？</h2><p id="aa9b" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">Telegraf是一个插件驱动的代理，它收集、处理、聚合和编写指标。有一个Telegraf输出插件，TimescaleDB出品的Telegraf 的<a class="ae mt" href="https://docs.timescale.com/latest/tutorials/telegraf-output-plugin" rel="noopener ugc nofollow" target="_blank"> PostgreSQL和TimescaleDB输出插件。该插件可以取代管理和维护上述脚本的需要。然而，我选择不使用它，因为它还不是官方的Telegraf插件。如果这个插件包含在Telegraf版本中，我当然会鼓励使用它。</a></p><h2 id="c975" class="mu lx it bd ly mv mw dn mc mx my dp mg kr mz na mi kv nb nc mk kz nd ne mm nf bi translated">脚本管理</h2><p id="ba82" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">基于Linux的物联网设备和边缘节点都运行<code class="fe nh ni nj nk b"><a class="ae mt" href="https://www.freedesktop.org/wiki/Software/systemd/" rel="noopener ugc nofollow" target="_blank">systemd</a></code>系统和服务管理器。为了确保Python脚本在系统重启的情况下继续运行，我们定义了一个<code class="fe nh ni nj nk b">systemd</code>单元。单元是<code class="fe nh ni nj nk b">systemd</code>知道如何管理的对象。这基本上是系统资源的标准化表示，可以由守护进程套件管理，并由提供的实用程序操作。每个脚本都有一个<code class="fe nh ni nj nk b">systemd</code>单元文件。下面，我们看到的是<code class="fe nh ni nj nk b">gtm_stack_mosquitto</code>单元文件，<a class="ae mt" href="https://github.com/garystafford/iot-analytics-at-the-edge/blob/main/systemctl/gtm_stack_mosquitto.service" rel="noopener ugc nofollow" target="_blank">GTM _ stack _ mosquitto . service</a>。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="105c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nh ni nj nk b">gtm_stack_mosq_to_tmscl</code>单元文件<a class="ae mt" href="https://github.com/garystafford/iot-analytics-at-the-edge/blob/main/systemctl/gtm_stack_mosq_to_tmscl.service" rel="noopener ugc nofollow" target="_blank">GTM _ stack _ mosq _ to _ TMS cl . service</a>几乎相同。</p><p id="f628" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要在每个物联网设备上安装<code class="fe nh ni nj nk b">gtm_stack_mosquitto.service</code> <code class="fe nh ni nj nk b">systemd</code>单元文件，请使用以下命令:</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="ccde" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在边缘节点上安装<code class="fe nh ni nj nk b">gtm_stack_mosq_to_tmscl.service</code>单元文件几乎是相同的。</p><h1 id="0d0e" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">码头栈</h1><p id="3bc4" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">边缘节点在<a class="ae mt" href="https://docs.docker.com/engine/swarm/" rel="noopener ugc nofollow" target="_blank">群</a>中运行GTM Docker栈<a class="ae mt" href="https://github.com/garystafford/iot-analytics-at-the-edge/blob/main/docker/stack.yml" rel="noopener ugc nofollow" target="_blank"> stack.yml </a>。如前所述，堆栈包含四个容器:Eclipse Mosquitto、TimescaleDB和Grafana，以及pgAdmin。Mosquitto、TimescaleDB和Grafana容器在容器内有路径，绑定到边缘设备上的目录。使用绑定装载，如果容器被删除并重新创建，容器的数据将会持续存在。这些容器运行在它们自己隔离的<a class="ae mt" href="https://docs.docker.com/network/overlay/" rel="noopener ugc nofollow" target="_blank">覆盖网络</a>上。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="f71f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用以下命令在边缘节点上安装GTM Docker堆栈。对于这篇文章，我们将假设Docker和git预安装在边缘节点上。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="4bb6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们在边缘设备上创建适当的本地目录，它将用于绑定到容器的目录。下面，我们看到了绑定挂载的本地目录，其中存储了最终容器的内容。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nl"><img src="../Images/e93b2662cb66aac15510bb01a9ae1482.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I-_Yw8oiFwMKbBpjGp_LcQ.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">堆栈中边缘设备上绑定装载的本地目录</figcaption></figure><p id="fd8c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们将项目中包含的自定义Mosquitto配置文件<a class="ae mt" href="https://github.com/garystafford/iot-analytics-at-the-edge/blob/main/docker/mosquitto.conf" rel="noopener ugc nofollow" target="_blank"> mosquitto.conf </a>复制到边缘设备上的正确位置。最后，我们初始化Docker swarm并部署堆栈。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nl"><img src="../Images/6da388299d6b733e69ee2df5288de10c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VIDaHtFUCuwCxoVXxu1NkA.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">'<code class="fe nh ni nj nk b">docker container ls'</code>命令的输出，显示正在运行的GTM堆栈容器</figcaption></figure><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nl"><img src="../Images/64d9d6ddc94bdf05002f89f8faf73dc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ihtU9qJllHNo3-rhYY_klg.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">“docker stats”命令的输出，显示GTM堆栈容器的资源消耗</figcaption></figure><h1 id="4f38" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">时标DB设置</h1><p id="3ac9" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">随着GTM堆栈的运行，我们需要在TimescaleDB <code class="fe nh ni nj nk b">demo_iot</code>数据库中创建一个单独的时间刻度<a class="ae mt" href="https://docs.timescale.com/latest/using-timescaledb/hypertables" rel="noopener ugc nofollow" target="_blank">超级表</a>、<code class="fe nh ni nj nk b">sensor_data</code>，以保存传入的物联网传感器数据。根据TimescaleDB的说法，Hypertables被设计成易于管理，其行为类似于标准的PostgreSQL表。超表由许多相互链接的“块”表组成。对超表发出的命令自动将改变向下传播到属于该超表的所有块。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="4447" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我建议使用<code class="fe nh ni nj nk b">psql</code>来执行所需的DDL语句，这将创建超表，以及后续的视图和数据库用户权限。所有SQL语句都包含在项目的<a class="ae mt" href="https://github.com/garystafford/iot-analytics-at-the-edge/blob/main/sql/statements.sql" rel="noopener ugc nofollow" target="_blank"> statements.sql </a>文件中。使用<code class="fe nh ni nj nk b">psql</code>的一种方法是将其安装在本地工作站上，然后使用<code class="fe nh ni nj nk b">psql</code>连接到远程边缘节点。我更喜欢实例化一个运行<code class="fe nh ni nj nk b">psql</code>的本地PostgreSQL Docker容器实例。然后，我使用本地容器的<code class="fe nh ni nj nk b">psql</code>客户端连接到边缘节点的TimescaleDB数据库。例如，在我的本地机器上，我运行下面的<code class="fe nh ni nj nk b">docker run</code>命令来连接到位于本地<code class="fe nh ni nj nk b">192.168.1.12</code>的edge节点上的TimescaleDB数据库。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="229d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">虽然并不总是可行，但也可以使用下面的<code class="fe nh ni nj nk b">docker exec</code>命令从运行在实际边缘节点上的TimescaleDB Docker容器中访问<code class="fe nh ni nj nk b">psql</code>:</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="no np l"/></div></figure><h2 id="d322" class="mu lx it bd ly mv mw dn mc mx my dp mg kr mz na mi kv nb nc mk kz nd ne mm nf bi translated">时标b连续聚合</h2><p id="5996" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">对于这篇文章的演示，我们需要创建四个TimescaleDB数据库视图<a class="ae mt" href="https://www.postgresqltutorial.com/postgresql-views/" rel="noopener ugc nofollow" target="_blank">和</a>，这些视图将从Grafana仪表板中查询。视图是时标DB <a class="ae mt" href="https://docs.timescale.com/latest/using-timescaledb/continuous-aggregates" rel="noopener ugc nofollow" target="_blank">连续集合</a>。根据时间尺度，触及大量时间序列数据的聚合查询可能需要很长时间来计算，因为系统需要在每次查询执行时扫描大量数据。TimescaleDB连续聚合在后台自动计算查询结果，并将结果具体化。</p><p id="62f4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，在这篇文章中，我们每五秒钟从三个物联网设备生成一次传感器数据。当在Grafana中可视化一个24小时周期时，使用间隔为一分钟的连续聚合，我们将查询的数据总量从大约51，840行减少到大约4，320行，减少了91%以上。被分析的物联网设备的时间段或数量越大，这些节省对查询性能的积极影响就越大。</p><p id="a9f1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">所有连续聚集视图都需要hypertable的时间分区列上的<code class="fe nh ni nj nk b">time_bucket</code>。在这种情况下，<code class="fe nh ni nj nk b">time_bucket</code>功能的铲斗宽度(<em class="le">间隔</em>)为1分钟。间隔是可配置的。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="no np l"/></div></figure><h2 id="73e5" class="mu lx it bd ly mv mw dn mc mx my dp mg kr mz na mi kv nb nc mk kz nd ne mm nf bi translated">限制Grafana对物联网数据的访问</h2><p id="df00" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">遵循数据库用户权限的<a class="ae mt" href="https://grafana.com/docs/grafana/latest/features/datasources/postgres/#database-user-permissions-important" rel="noopener ugc nofollow" target="_blank"> Grafana建议</a>，我们创建一个<code class="fe nh ni nj nk b">grafanareader</code>PostgreSQL用户，并限制该用户对<code class="fe nh ni nj nk b">sensor_data</code>表和我们创建的四个视图的访问。Grafana将使用这个用户的凭证从TimescaleDB <code class="fe nh ni nj nk b">demo_iot</code>数据库中执行<code class="fe nh ni nj nk b">SELECT</code>查询。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="no np l"/></div></figure><h1 id="11ea" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">Grafana仪表板</h1><p id="12ab" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">使用我们创建的TimescaleDB连续聚合，我们可以在Grafana中快速构建功能丰富的仪表板。下面我们看到了一个典型的物联网仪表板，你可以构建它来近乎实时地监控邮报的物联网传感器数据。GitHub项目中包含一个导出版本<a class="ae mt" href="https://github.com/garystafford/iot-analytics-at-the-edge/blob/main/dashboard/dashboard_external_export.json" rel="noopener ugc nofollow" target="_blank">dashboard _ external _ export . JSON</a>。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nn"><img src="../Images/e3fb103b72824e93ee02ed3e0199482b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xP9YAz5vjT7cLutOJOZLkg.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">显示邮报物联网传感器数据的Grafana仪表板示例</figcaption></figure><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nn"><img src="../Images/f15c41eb0e1d1bce121262a6941570af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FGKRqdAYmqrcp2Rf2ZVWtg.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">显示传感器数据的Grafana物联网演示仪表板示例</figcaption></figure><p id="7745" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Grafana的文档包括一套关于在Grafana 中使用PostgreSQL<a class="ae mt" href="https://grafana.com/docs/grafana/latest/features/datasources/postgres/" rel="noopener ugc nofollow" target="_blank">的完整说明。为了从Grafana连接到TimescaleDB数据库，我们使用PostgreSQL数据源。</a></p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nn"><img src="../Images/a0a50e293c6735e2e09e6d69055bd03b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3SKCgEH8N0Ur2sJ9dTLolQ.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">在Grafana中配置TimescaleDB数据库连接</figcaption></figure><p id="1dbb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Grafana仪表板中每个面板中显示的数据都基于SQL查询。例如,“平均温度”面板可能会使用类似于以下示例的查询。这个特定的查询还将摄氏温度转换为华氏温度。注意Grafana <a class="ae mt" href="https://grafana.com/docs/grafana/latest/features/datasources/postgres/#macros" rel="noopener ugc nofollow" target="_blank">宏</a>的使用(例如<code class="fe nh ni nj nk b">$__time()</code>、<code class="fe nh ni nj nk b">$__timeFilter()</code>)。可以在查询中使用宏来简化语法并允许动态部分。</p><pre class="lg lh li lj gt ok nk ol om aw on bi"><span id="b55f" class="mu lx it nk b gy oo op l oq or">SELECT<br/>  $__time(bucket),<br/>  device_id AS metric,<br/>  ((avg_temp * 1.9) + 32) AS avg_temp<br/>FROM temperature_humidity_summary_minute<br/>WHERE<br/>  $__timeFilter(bucket)<br/>ORDER BY 1,2</span></pre><p id="0390" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面，我们看到平均湿度面板的另一个例子。在这个特定的查询中，我们可能选择验证湿度数据在0%–100%的可接受范围内。</p><pre class="lg lh li lj gt ok nk ol om aw on bi"><span id="949b" class="mu lx it nk b gy oo op l oq or">SELECT<br/>  $__time(bucket),<br/>  device_id AS metric,<br/>  avg_humidity<br/>FROM temperature_humidity_summary_minute<br/>WHERE<br/>  $__timeFilter(bucket)<br/>  AND avg_humidity &gt;= 0.0<br/>  AND avg_humidity &lt;= 100.0<br/>ORDER BY 1,2</span></pre><h2 id="fae7" class="mu lx it bd ly mv mw dn mc mx my dp mg kr mz na mi kv nb nc mk kz nd ne mm nf bi translated">移动友好</h2><p id="104d" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">Grafana仪表板是移动友好的。下面我们看到了仪表盘的两个视图，使用的是苹果iPhone上的Chrome移动浏览器。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi os"><img src="../Images/74fae744d9ab20cbe19768104e6dd213.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_M7Q0TolFTrY0nGg2BObuA.png"/></div></div></figure><h2 id="a0b6" class="mu lx it bd ly mv mw dn mc mx my dp mg kr mz na mi kv nb nc mk kz nd ne mm nf bi translated">Grafana警报</h2><p id="530b" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">Grafana允许根据您在每个面板中定义的规则创建<a class="ae mt" href="https://grafana.com/docs/grafana/latest/alerting/" rel="noopener ugc nofollow" target="_blank">警报</a>。如果数据值符合您预先定义的规则条件，例如温度读数在设定的时间内高于特定阈值，则会向您选择的目的地发送警报。根据下面显示的规则，如果平均温度超过75°F达5分钟，就会发出警报。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nn"><img src="../Images/d695df4ac0f17090f372a1506a74ab8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kGJH7VOu3n8rI2jtoIDAZw.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">高温规则配置</figcaption></figure><p id="bd86" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如下所示，当实验室温度开始超过75°F时，警报进入“未决”状态。如果温度在预定的5分钟内超过75°F，警报状态将变为“警报”,并将发出警报。当温度在预定的5分钟内降至75°F以下时，警报状态从“警报”变为“正常”,并发出后续通知。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nn"><img src="../Images/e8ca92b2c1c11fafe7f7190840538405.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kxq5kpV40m8-xwaPoI4G7g.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">显示各种警报状态变化的平均温度图</figcaption></figure><p id="11e7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">目前Grafana有18个现成的目的地，包括<a class="ae mt" href="https://slack.com/" rel="noopener ugc nofollow" target="_blank"> Slack </a>、email、PagerDuty、webhooks、HipChat和微软团队。如果根据数据检测到问题，我们可以使用Grafana Alerts近乎实时地通知适当的资源。下面，我们看到了Grafana向Slack频道发送的一系列实际的高温警报，随后是温度恢复正常时的后续通知。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi ot"><img src="../Images/04662016b3f51943d07fd4388440f22e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YG5ZuEV8_ToXZHYwrg_QAw.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">空闲频道中的Grafana警报通知</figcaption></figure><h1 id="7986" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">即席查询</h1><p id="ffd0" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">对时序物联网数据执行即席查询的能力是物联网边缘分析堆栈的一项基本功能。我们可以使用<code class="fe nh ni nj nk b">psql</code>或pgAdmin对TimescaleDB数据库执行特定查询。下面是我们可能对物联网传感器数据执行的典型即席查询的示例。这些示例查询展示了TimescaleDB处理时间序列数据的高级分析能力，包括<a class="ae mt" href="https://docs.timescale.com/latest/using-timescaledb/reading-data#moving-average" rel="noopener ugc nofollow" target="_blank">移动平均值</a>、<a class="ae mt" href="https://docs.timescale.com/latest/using-timescaledb/reading-data#delta" rel="noopener ugc nofollow" target="_blank">增量</a>、<a class="ae mt" href="https://docs.timescale.com/latest/using-timescaledb/reading-data#time-bucket" rel="noopener ugc nofollow" target="_blank">时段</a>和<a class="ae mt" href="https://docs.timescale.com/latest/using-timescaledb/reading-data#histogram" rel="noopener ugc nofollow" target="_blank">直方图</a>。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="no np l"/></div></figure><h1 id="26b6" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">结论</h1><p id="b269" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">在本文中，我们探讨了物联网边缘分析堆栈的开发，该堆栈由轻量级、专门构建、易于部署和管理、平台和编程语言无关的开源软件组件组成。这些组件包括Eclipse Mosquitto、TimescaleDB、Grafana和pgAdmin的Docker容器化版本，称为GTM栈。使用GTM堆栈，我们收集、分析和可视化了物联网数据，而无需首先将数据传输到云或其他外部系统。</p></div><div class="ab cl ou ov hx ow" role="separator"><span class="ox bw bk oy oz pa"/><span class="ox bw bk oy oz pa"/><span class="ox bw bk oy oz"/></div><div class="im in io ip iq"><p id="6d18" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这篇博客代表我自己的观点，而不是我的雇主亚马逊网络服务公司的观点。所有产品名称、徽标和品牌都是其各自所有者的财产。</p></div></div>    
</body>
</html>