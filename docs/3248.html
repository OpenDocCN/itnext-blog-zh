<html>
<head>
<title>Automated deployment of Kubernetes on 15 Raspberry Pis boot in under 8 minutes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在8分钟内将Kubernetes自动部署到15个Raspberry Pis上</h1>
<blockquote>原文：<a href="https://itnext.io/headless-kubernetes-on-15-raspberry-pis-boot-in-under-8-minutes-808402ea2348?source=collection_archive---------1-----------------------#2019-11-05">https://itnext.io/headless-kubernetes-on-15-raspberry-pis-boot-in-under-8-minutes-808402ea2348?source=collection_archive---------1-----------------------#2019-11-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c8bcc1705427777af0db63164315f9dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e_-ZfeDjPXpykMLIL_wmGg.jpeg"/></div></div></figure><p id="0026" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">别告诉我它不能自动化。</p><p id="06d6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本指南将在SD卡上创建Kubernetes的自动部署。最后，你应该有一个SD卡加载到你的Raspberry Pi集群中，打开并“工作”。这是在您的家庭集群上运行和维护Kubernetes的一种完全自动化且几乎不变的方法。</p><p id="c29a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">范围是创建Kubernetes集群的自动化方法，对代码的研究留给您。</p><p id="812d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">开发这一堆栈背后的主要驱动力是模拟在云环境(如<a class="ae kw" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank">【GCP】</a>)中使用<a class="ae kw" href="http://cloudscaling.com/blog/cloud-computing/the-history-of-pets-vs-cattle/" rel="noopener ugc nofollow" target="_blank">宠物对牛方法</a>进行开发的情况。</p><h2 id="5b78" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">先决条件</h2><p id="f9fd" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">我的堆栈由15个覆盆子Pis组成，但是最小推荐数量是4个，以便能够遵循指南。</p><p id="23ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这在理论上可以用2个Raspberry Pis个主人和1个工人)来执行。然而，为了迎合这一点，你需要调整在<code class="fe lv lw lx ly b">Makefile</code>中使用的<code class="fe lv lw lx ly b">KUBE_MASTER_IP_XX</code>变量。</p><ul class=""><li id="0964" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv me mf mg mh bi translated">Linux操作系统</li><li id="aff1" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated"><a class="ae kw" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank">库贝克特尔</a></li><li id="8d39" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">至少4个树莓派(3个主人和1个工人)</li><li id="f772" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">访问<a class="ae kw" href="https://github.com/lucasteligioridis/raspbernetes" rel="noopener ugc nofollow" target="_blank">https://github.com/lucasteligioridis/raspbernetes</a></li></ul><h2 id="e26f" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">我的堆栈中的零件列表:</h2><ul class=""><li id="52d7" class="lz ma iq ka b kb lq kf lr kj mn kn mo kr mp kv me mf mg mh bi translated">15个<a class="ae kw" href="https://raspberry.piaustralia.com.au/raspberry-pi-4-model-b" rel="noopener ugc nofollow" target="_blank">树莓Pi 4 (4GB) </a></li><li id="ec37" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">15根<a class="ae kw" href="https://www.pccasegear.com/products/46540/pccg-usb-3-1-type-a-to-type-c-gen2-cable-50cm-black" rel="noopener ugc nofollow" target="_blank"> USBA到USBC的电缆</a>(50厘米)</li><li id="e0d5" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">15根<a class="ae kw" href="https://www.pccasegear.com/products/36092/cablemod-cat-6-ethernet-cable-blue-50cm" rel="noopener ugc nofollow" target="_blank">以太网电缆</a>(50厘米)</li><li id="c4d5" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">15个<a class="ae kw" href="https://www.amazon.com/SanDisk-Ultra-microSDXC-Memory-Adapter/dp/B073JWXGNT/ref=sr_1_2?keywords=sandisk+32gb+sd+card+micro&amp;qid=1572351870&amp;sr=8-2" rel="noopener ugc nofollow" target="_blank"> Sandisk 32GB Ultra microSDHC卡10类</a></li><li id="b833" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">3个<a class="ae kw" href="https://www.pccasegear.com/products/39096" rel="noopener ugc nofollow" target="_blank"> Netgear ProSAFE 8端口千兆交换机</a></li><li id="3d4a" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">3个<a class="ae kw" href="https://www.amazon.com/Anker-Charger-PowerPort-iPhone-Galaxy/dp/B00P936188/ref=sr_1_4?keywords=anker+usb+hub+60w&amp;qid=1572351821&amp;s=electronics&amp;sr=1-4" rel="noopener ugc nofollow" target="_blank"> Anker PowerPort 6端口60W </a></li><li id="3b1c" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">4 x <a class="ae kw" href="https://www.amazon.com/GeeekPi-Cluster-Raspberry-Heatsink-Stackable/dp/B07MW24S61" rel="noopener ugc nofollow" target="_blank"> GeeekPi集群案例</a></li></ul><h2 id="cdab" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">应用程序的版本</h2><p id="8b49" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">创建该堆栈的所有启动脚本都固定了所有应用程序版本，以产生一致的预期行为。</p><ul class=""><li id="f9a1" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv me mf mg mh bi translated"><a class="ae kw" href="https://downloads.raspberrypi.org/raspbian_lite/images/raspbian_lite-2019-09-30/2019-09-26-raspbian-buster-lite.zip" rel="noopener ugc nofollow" target="_blank">拉斯扁</a> —拉斯扁_ lite-2019–09–30</li><li id="a75c" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated"><a class="ae kw" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank">库伯内特斯</a> — 1.16.1</li><li id="3fde" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated"><a class="ae kw" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank">码头工人</a> — 18.09.0</li><li id="6133" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated"><a class="ae kw" href="http://www.haproxy.org/" rel="noopener ugc nofollow" target="_blank"> HA代理</a> — 1.8.19</li><li id="b968" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated"><a class="ae kw" href="https://www.keepalived.org/" rel="noopener ugc nofollow" target="_blank">保持激活</a> — 2.0.10</li><li id="0ea5" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated"><a class="ae kw" href="https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml" rel="noopener ugc nofollow" target="_blank">法兰绒</a> —根据<a class="ae kw" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network" rel="noopener ugc nofollow" target="_blank"> kubeadm安装页面</a>上的说明</li></ul><h2 id="26bf" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">网络拓扑结构</h2><p id="f2b7" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">该设计包括在三个主设备上使用浮动VIP(虚拟IP)的完全高可用性，以备断电时替代负载平衡器。</p><p id="2d9e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该设计还提供了一些额外的灵活性，允许任何节点断电而不影响群集。下图描述了整个堆栈的概要情况:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mq"><img src="../Images/05fbecd3fd4755c283e1c58aa0efc58a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WrIHYS8OL97QhlOCATqTQw.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">具有全网状HA的树莓Pi群集</figcaption></figure><h2 id="c67e" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">主机名和IP配置</h2><p id="90e3" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">下面是本指南中经常使用的主机名和IP地址的完整列表，您可以随意创建自己的列表以供参考。</p><p id="83d9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">根据集群中Raspberry Pis的数量进行相应的调整，下面描述了我在集群中使用的配置:</p><ul class=""><li id="4db9" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv me mf mg mh bi translated">rpi-kube-master-01:192 . 168 . 1 . 101</li><li id="ba0a" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">rpi-kube-master-02:192 . 168 . 1 . 102</li><li id="7bea" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">rpi-kube-master-03: </li><li id="e862" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">rpi-kube-worker-01:192 . 168 . 1 . 111</li><li id="0997" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">rpi-kube-worker-02:192 . 168 . 1 . 112</li><li id="3088" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">rpi-kube-worker-03:192 . 168 . 1 . 113</li><li id="176a" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">rpi-kube-worker-04:192 . 168 . 1 . 114</li><li id="646a" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">rpi-kube-worker-05:192 . 168 . 1 . 115</li><li id="83c3" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">rpi-kube-worker-06:192 . 168 . 1 . 116</li><li id="09b8" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">rpi-kube-worker-07:192 . 168 . 1 . 117</li><li id="f244" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">rpi-kube-worker-08:192 . 168 . 1 . 118</li><li id="ab44" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">rpi-kube-worker-09:192 . 168 . 1 . 119</li><li id="c30e" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">rpi-kube-worker-10:192 . 168 . 1 . 120</li><li id="9c7a" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">rpi-kube-worker-11:192 . 168 . 1 . 121</li><li id="71ff" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated">rpi-kube-worker-12:192 . 168 . 1 . 122</li></ul><h1 id="0346" class="mz ky iq bd kz na nb nc lc nd ne nf lf ng nh ni li nj nk nl ll nm nn no lo np bi translated">必读</h1><p id="42e3" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">在开始之前，你应该知道有助于构建SD卡的<code class="fe lv lw lx ly b">Makefile</code>。SD设备的默认名称是:</p><ul class=""><li id="c49c" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv me mf mg mh bi translated"><strong class="ka ir"> /dev/mmcblk0 </strong></li></ul><p id="e15b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意，我只在基于Debian的操作系统上测试过，如果不小心，你可能会意外删除错误的设备。确保当您插入空白SD卡准备写入此堆栈的映像时，这些是正确的设备名称。为了确认这一点，一旦SD卡被插入到您的机器中，在您的终端中运行<code class="fe lv lw lx ly b">lsblk</code>来确认，您应该得到如下或类似的输出:</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="f2b2" class="kx ky iq ly b gy nu nv l nw nx">$ lsblk<br/>NAME            MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT<br/>mmcblk0         179:0    0  29.7G  0 disk<br/>├─mmcblk0p1     179:1    0   256M  0 part  <br/>└─mmcblk0p2     179:2    0  29.5G  0 part  </span></pre><p id="0daa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您发现您的设备名称不同，您可以在终端中使用以下命令覆盖现有的默认名称:</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="c2da" class="kx ky iq ly b gy nu nv l nw nx">export MNT_DEVICE=/dev/&lt;YOUR_DEVICE_NAME&gt;</span></pre><h1 id="d736" class="mz ky iq bd kz na nb nc lc nd ne nf lf ng nh ni li nj nk nl ll nm nn no lo np bi translated">设置</h1><p id="c771" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">本指南中的每一步都假设您正在同一个终端会话中运行。</p><h2 id="a698" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">普通的</h2><p id="2621" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">克隆已提供的存储库，并签出到下面列出的发布标签，以确保本指南中的说明与编写时一致:</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="284c" class="kx ky iq ly b gy nu nv l nw nx">git clone <a class="ae kw" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>:lucasteligioridis/raspbernetes<br/>cd raspbernetes<br/>git checkout v1.0</span></pre><p id="46ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果想要对每个<code class="fe lv lw lx ly b">make</code>目标的简要描述，只需在终端输入以下命令:</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="ffdd" class="kx ky iq ly b gy nu nv l nw nx">make</span></pre><p id="01e5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Bootstrap每个排列或类型的节点将使用的第一组静态变量(根据您的特定环境进行更改):</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="2467" class="kx ky iq ly b gy nu nv l nw nx">export RPI_DNS=192.168.1.1<br/>export RPI_NETWORK_TYPE=eth0<br/>export RPI_TIMEZONE=Australia/Melbourne<br/>export KUBE_MASTER_VIP=192.168.1.100<br/>export KUBE_MASTER_IP_01=192.168.1.101<br/>export KUBE_MASTER_IP_02=192.168.1.102<br/>export KUBE_MASTER_IP_03=192.168.1.103</span></pre><p id="564d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于这种设置，假设<code class="fe lv lw lx ly b">RPI_NETWORK_TYPE</code>是一个<code class="fe lv lw lx ly b">eth0</code>(从Raspberry Pi连接到网络交换机的以太网电缆)。有一个通过设置以下命令连接到WiFi的选项(在导出密码环境变量时添加了一个空格作为后缀，以防止保存到历史记录):</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="e1af" class="kx ky iq ly b gy nu nv l nw nx">export RPI_NETWORK_TYPE=wlan0<br/>export WIFI_SSID="YourWifiSSID"<br/> export WIFI_PASSWORD="PasswordForWifi"</span></pre><h2 id="bdbe" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">掌握</h2><p id="ae2c" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">将SD卡插入机器的SD卡插槽，并运行以下命令:</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="9cc0" class="kx ky iq ly b gy nu nv l nw nx">export KUBE_NODE_TYPE=master<br/>export RPI_HOSTNAME=rpi-kube-master-01<br/>export RPI_IP=192.168.1.101</span><span id="36aa" class="kx ky iq ly b gy ny nv l nw nx">make build</span></pre><p id="67e9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果这是你第一次运行这个，你需要从官方网站下载Raspbian图像。只要您不删除下载到存储库<code class="fe lv lw lx ly b">output/</code>目录中的<code class="fe lv lw lx ly b">.img</code>文件，就只需要这样做一次。</p><p id="41d9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你现在应该看到<code class="fe lv lw lx ly b">dd</code>用一个全新的Raspbian副本格式化SD卡。将映像成功写入SD卡后，将生成配置文件并将其放在SD卡上，以便在引导时获取。</p><p id="08fe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上述命令的输出应该类似于以下示例:</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="bf95" class="kx ky iq ly b gy nu nv l nw nx">Formatting SD card with 2019-09-26-raspbian-buster-lite.img<br/>2243952640 bytes (2.2 GB, 2.1 GiB) copied, 7 s, 317 MB/s<br/>536+0 records in<br/>536+0 records out<br/>2248146944 bytes (2.2 GB, 2.1 GiB) copied, 109.321 s, 20.6 MB/s</span><span id="e7fe" class="kx ky iq ly b gy ny nv l nw nx">Created a headless Kubernetes SD card with the following properties:<br/>Network:<br/>- Hostname: rpi-kube-master-01<br/>- Static IP: 192.168.1.101<br/>- Gateway address: 192.168.1.1<br/>- Network adapter: eth0<br/>- Timezone: Australia/Melbourne<br/>Kubernetes:<br/>- Node Type: master<br/>- Control Plane Endpoint: 192.168.1.100<br/>- Master IP 01: 192.168.1.101<br/>- Master IP 02: 192.168.1.102<br/>- Master IP 03: 192.168.1.103</span></pre><p id="4b6d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，您可以随意将SD卡从您的机器中弹出，并插入您选择的Raspberry Pi。</p><p id="414c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用上述命令制作2个以上的主机，您将需要更改贴在上方的<a class="ae kw" href="#c67e" rel="noopener ugc nofollow">表中的<code class="fe lv lw lx ly b">RPI_HOSTNAME</code>和<code class="fe lv lw lx ly b">RPI_IP</code>。</a></p><p id="314e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">恭喜各位高手现在已经整装待发了！</p><h2 id="6ac3" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">工人</h2><p id="ac23" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">完全按照主设置插入SD卡，并参考贴在上方的<a class="ae kw" href="#c67e" rel="noopener ugc nofollow">表，获取主机名和IP参考:</a></p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="1ec9" class="kx ky iq ly b gy nu nv l nw nx">export KUBE_NODE_TYPE=worker<br/>export RPI_HOSTNAME=rpi-kube-worker-01<br/>export RPI_IP=192.168.1.111</span><span id="c8bc" class="kx ky iq ly b gy ny nv l nw nx">make build</span></pre><p id="3e4a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦SD卡完成写入并且<code class="fe lv lw lx ly b">make</code>命令成功完成，按照上面的<a class="ae kw" href="#c67e" rel="noopener ugc nofollow">表中<code class="fe lv lw lx ly b">RPI_HOSTNAME</code>和<code class="fe lv lw lx ly b">RPI_IP</code>的详细信息，继续将剩余的SD卡作为工作节点写入。</a></p><p id="6406" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">恭喜你，所有的工人都准备好了！</p><h1 id="d160" class="mz ky iq bd kz na nb nc lc nd ne nf lf ng nh ni li nj nk nl ll nm nn no lo np bi translated">Kubernetes集群时间</h1><p id="b50c" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">现在所有的Raspberry Pis都加载了正确的配置参数，您已经准备好打开集群了。引导的设计方式确保Pis可以以任何顺序引导，无需等待集群首先初始化。它已被配置为避免任何种类的竞争情况或集群的裂脑。</p><p id="a0ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">启动时将要发生的事情的分解:</p><ol class=""><li id="5695" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv nz mf mg mh bi translated">所有节点同时启动。</li><li id="4358" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv nz mf mg mh bi translated">已经设置了主机名和IP。</li><li id="f719" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv nz mf mg mh bi translated">所有Kubernetes包都已经安装了所有必需的依赖项。</li><li id="061e" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv nz mf mg mh bi translated"><code class="fe lv lw lx ly b">Keepalived</code>在一个主节点上设置VIP后，集群初始化开始。</li><li id="62f5" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv nz mf mg mh bi translated">所有其他节点(主节点和工作节点)等待，直到第一个主节点初始化集群。</li><li id="6358" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv nz mf mg mh bi translated">可以开始加入集群，在托管VIP的主节点上并行检索加入命令和证书，以用于剩余的主节点和工作节点。</li></ol><p id="f3ad" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">记下生成的SSH密钥，并放在用于所有集群间通信和远程Raspberry Pis的<code class="fe lv lw lx ly b">output/ssh/</code>目录中。<strong class="ka ir">不要丢掉这个！</strong></p><h2 id="dd40" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">准备启动</h2><p id="0a00" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">因为我有15个不同的节点，我想监控所有的日志，所以我将用<code class="fe lv lw lx ly b">tmux</code>分割我的终端，这是可选的。如果你不使用<code class="fe lv lw lx ly b">tmux</code>,我强烈推荐你使用它，尽管你在本指南中并不需要它，它是一个在你的终端中有效导航的好工具。</p><h2 id="e7c0" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">通电</h2><p id="b784" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">你现在可以以任何顺序开启你的覆盆子。在您的集群完全建立之前，这大约需要8分钟。在通电至少1分钟后(等待主机名发生更改)，您可以使用以下命令跟踪节点上的日志(用您要监视的节点替换<strong class="ka ir"> &lt; RPI_HOSTNAME &gt; </strong>):</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="f63e" class="kx ky iq ly b gy nu nv l nw nx">ssh -i output/ssh/id_ed25519 -o StrictHostKeyChecking=no pi@<strong class="ly ir">&lt;RPI_HOSTNAME&gt;</strong>.local tail -f -n 200 /var/log/syslog | grep -Eo 'kubernetes-bootstrap:(.*)'</span></pre><p id="e490" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果正确遵循了所有步骤，那么您的Kubernetes集群就已经成功部署了！如果您跟踪所有或任何节点上的日志，输出中的最后一行应该是:</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="46cb" class="kx ky iq ly b gy nu nv l nw nx">kubernetes-bootstrap: Finished booting! Kubernetes successfully running!</span></pre><p id="108b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这表明节点已经完成引导并加入/初始化集群！恭喜你走到这一步！</p><p id="70cb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面是我的<code class="fe lv lw lx ly b">tmux</code>会话的截图，它分布在所有15个跟踪日志的节点上:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/fe2e51717ae10c8c050d67376183d9fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HfDIR9acQpHO0i6NjYKBcw.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">带有15个分割窗格尾随引导日志的Tmux</figcaption></figure><h2 id="fe6c" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">检索配置</h2><p id="c6e9" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">既然您的集群已经启动，现在是时候从本地机器检索配置文件来运行<code class="fe lv lw lx ly b">kubectl</code>命令了。要获取配置文件，请运行以下命令。请记住，这可能会覆盖您机器上现有的任何Kubernetes配置文件，因此请进行相应的调整:</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="fb78" class="kx ky iq ly b gy nu nv l nw nx">mkdir -p ~/.kube/<br/>scp pi@${KUBE_MASTER_VIP}:/home/pi/.kube/config ~/.kube/config</span></pre><h2 id="e587" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">测试与集群的连接</h2><p id="bc54" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">测试Kubernetes集群是否正常工作:</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="a478" class="kx ky iq ly b gy nu nv l nw nx">kubectl get nodes</span></pre><p id="d029" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这将返回当前已经加入并创建了kubernetes集群的节点列表。在我的案例中，结果是:</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="4ffc" class="kx ky iq ly b gy nu nv l nw nx">NAME                 STATUS   ROLES    AGE     VERSION<br/>rpi-kube-master-01   Ready    master   3m5s    v1.16.1<br/>rpi-kube-master-02   Ready    master   115s    v1.16.1<br/>rpi-kube-master-03   Ready    master   4m9s    v1.16.1<br/>rpi-kube-worker-01   Ready    &lt;none&gt;   3m35s   v1.16.1<br/>rpi-kube-worker-02   Ready    &lt;none&gt;   3m25s   v1.16.1<br/>rpi-kube-worker-03   Ready    &lt;none&gt;   3m25s   v1.16.1<br/>rpi-kube-worker-04   Ready    &lt;none&gt;   3m35s   v1.16.1<br/>rpi-kube-worker-05   Ready    &lt;none&gt;   3m32s   v1.16.1<br/>rpi-kube-worker-06   Ready    &lt;none&gt;   3m35s   v1.16.1<br/>rpi-kube-worker-07   Ready    &lt;none&gt;   3m41s   v1.16.1<br/>rpi-kube-worker-08   Ready    &lt;none&gt;   3m29s   v1.16.1<br/>rpi-kube-worker-09   Ready    &lt;none&gt;   3m32s   v1.16.1<br/>rpi-kube-worker-10   Ready    &lt;none&gt;   3m22s   v1.16.1<br/>rpi-kube-worker-11   Ready    &lt;none&gt;   3m41s   v1.16.1<br/>rpi-kube-worker-12   Ready    &lt;none&gt;   3m25s   v1.16.1</span></pre><h2 id="1c7c" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">部署应用程序</h2><p id="6937" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">我们将使用<code class="fe lv lw lx ly b"><a class="ae kw" href="https://www.nginx.com/" rel="noopener ugc nofollow" target="_blank">NGiNX</a></code>的<a class="ae kw" href="https://hub.docker.com/_/nginx" rel="noopener ugc nofollow" target="_blank">标准映像</a>作为集群上的web服务器进行测试。</p><p id="dbea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个<a class="ae kw" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" rel="noopener ugc nofollow" target="_blank">部署</a>，该部署将添加到运行单个pod的默认名称空间，为此，使用以下命令:</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="9d60" class="kx ky iq ly b gy nu nv l nw nx">kubectl create deployment nginx --image=nginx</span></pre><p id="3d8a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要查看部署状态，可以使用以下命令来查看一些基本的详细信息:</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="2561" class="kx ky iq ly b gy nu nv l nw nx">$ kubectl get deployments<br/>NAME    READY   UP-TO-DATE   AVAILABLE   AGE<br/>nginx   1/1     1            1           43s</span></pre><p id="b0d7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您还可以查看将<code class="fe lv lw lx ly b">NGiNX</code>部署到集群中的<a class="ae kw" href="https://kubernetes.io/docs/concepts/workloads/pods/pod/" rel="noopener ugc nofollow" target="_blank"> pod </a>的状态:</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="9382" class="kx ky iq ly b gy nu nv l nw nx">$ kubectl get pods<br/>NAME                     READY   STATUS    RESTARTS   AGE<br/>nginx-86c57db685-n9w2b   1/1     Running   0          60s</span></pre><p id="0aab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用<code class="fe lv lw lx ly b"><a class="ae kw" href="https://kubernetes.io/docs/concepts/services-networking/service/#nodeport" rel="noopener ugc nofollow" target="_blank">NodePort</a></code> <a class="ae kw" href="https://kubernetes.io/docs/concepts/services-networking/service/" rel="noopener ugc nofollow" target="_blank">服务</a>暴露部署，因为这将是测试pod入口的最简单方法:</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="62be" class="kx ky iq ly b gy nu nv l nw nx">kubectl create service nodeport nginx --tcp=80:80</span></pre><p id="16af" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">获取公开的服务信息以测试web服务器连接:</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="80aa" class="kx ky iq ly b gy nu nv l nw nx">$ kubectl get service nginx<br/>NAME    TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE<br/>nginx   NodePort   10.98.7.192   &lt;none&gt;        80:31611/TCP   2s</span></pre><p id="9d45" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过在终端中向上面列出的随机分配的端口发送一个<code class="fe lv lw lx ly b">curl</code>请求来测试连通性，集群中的任何节点都可以用于将流量定向到pod。将使用IP地址为<code class="fe lv lw lx ly b">192.168.1.111</code>的主机<code class="fe lv lw lx ly b">rpi-kube-worker-01</code>节点:</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="1fb0" class="kx ky iq ly b gy nu nv l nw nx">curl 192.168.1.111:31611</span></pre><p id="f9e2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用与上述相同的测试参数在浏览器中测试连接性，以了解网页渲染:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/668aac182f537c118e9b6496bd5d4ae9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ShWpjeU0E7XoxPRnA1OeVA.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">Chromium中的NGiNX连接示例</figcaption></figure><p id="d1d1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以随意尝试一些事情，如<a class="ae kw" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#scaling-a-deployment" rel="noopener ugc nofollow" target="_blank">扩展</a>部署和观看pod扩展:</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="00aa" class="kx ky iq ly b gy nu nv l nw nx">kubectl scale deployment/nginx --replicas=3<br/>kubectl get pods -o wide -w</span></pre><p id="baf1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">恭喜恭喜！</strong>您已经创建了一个可以成功部署pod的Kubernetes集群！</p><h1 id="e3b0" class="mz ky iq bd kz na nb nc lc nd ne nf lf ng nh ni li nj nk nl ll nm nn no lo np bi translated">重新部署节点</h1><p id="39bd" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">这个堆栈构建方式中包含的一些好处是无缝重新部署。</p><p id="647c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当我运行这个集群自动化的开发时，我意外地破坏了节点并丢失了状态(因为在这个设计中我没有备份)，所以我决定增加一些额外的弹性并满足轻松替换Raspberry Pi的需要。</p><h2 id="0af2" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">关机</h2><p id="e421" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">举个例子，我指的是，选择一个主设备进行不安全的破坏或关闭(模拟一个混沌工程场景)。出于这个例子的目的，让我们选择<code class="fe lv lw lx ly b">rpi-kube-master-01</code>并通过拔出电源线来关闭它。</p><p id="5623" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">关闭后，运行以下命令查看节点显示为<code class="fe lv lw lx ly b">NotReady</code>(API可能需要20-30秒来显示状态变化):</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="a76f" class="kx ky iq ly b gy nu nv l nw nx">$ kubectl get nodes<br/>NAME                 STATUS     ROLES    AGE     VERSION<br/>rpi-kube-master-01   NotReady   master   7m36s   v1.16.1<br/>rpi-kube-master-02   Ready      master   6m26s   v1.16.1<br/>rpi-kube-master-03   Ready      master   8m40s   v1.16.1<br/>rpi-kube-worker-01   Ready      &lt;none&gt;   8m6s    v1.16.1<br/>rpi-kube-worker-02   Ready      &lt;none&gt;   7m56s   v1.16.1<br/>rpi-kube-worker-03   Ready      &lt;none&gt;   7m56s   v1.16.1<br/>rpi-kube-worker-04   Ready      &lt;none&gt;   8m6s    v1.16.1<br/>rpi-kube-worker-05   Ready      &lt;none&gt;   8m3s    v1.16.1<br/>rpi-kube-worker-06   Ready      &lt;none&gt;   8m6s    v1.16.1<br/>rpi-kube-worker-07   Ready      &lt;none&gt;   8m12s   v1.16.1<br/>rpi-kube-worker-08   Ready      &lt;none&gt;   8m      v1.16.1<br/>rpi-kube-worker-09   Ready      &lt;none&gt;   8m3s    v1.16.1<br/>rpi-kube-worker-10   Ready      &lt;none&gt;   7m53s   v1.16.1<br/>rpi-kube-worker-11   Ready      &lt;none&gt;   8m12s   v1.16.1<br/>rpi-kube-worker-12   Ready      &lt;none&gt;   7m56s   v1.16.1</span></pre><h2 id="53ef" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">重建</h2><p id="e22b" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">现在，节点确实已经关闭，Kubernetes集群已经识别出故障，您可以从您关闭的Raspberry Pi中取出SD卡，并将其插回到您的计算机中，以便按照本指南前面或下面的相同配置进行重建。</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="ebdc" class="kx ky iq ly b gy nu nv l nw nx">export KUBE_NODE_TYPE=master<br/>export RPI_HOSTNAME=rpi-kube-master-01<br/>export RPI_IP=192.168.1.101</span><span id="cc5e" class="kx ky iq ly b gy ny nv l nw nx">make build</span></pre><p id="58d6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这已经用与最初启动时完全相同的配置写入了SD卡，使它回到了原始的无头状态。</p><h2 id="cbc9" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">通电</h2><p id="1e54" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">将SD卡插回之前关闭的Raspberry Pi，然后重新打开电源。大约6分钟后，您可以运行<code class="fe lv lw lx ly b">kubectl</code>命令，现在应该看到节点回到了<code class="fe lv lw lx ly b">Ready</code>状态:</p><pre class="mr ms mt mu gt nq ly nr ns aw nt bi"><span id="0641" class="kx ky iq ly b gy nu nv l nw nx">$ kubectl get nodes<br/>NAME                 STATUS   ROLES    AGE   VERSION<br/>rpi-kube-master-01   Ready    master   36s   v1.16.1<br/>rpi-kube-master-02   Ready    master   12m   v1.16.1<br/>rpi-kube-master-03   Ready    master   15m   v1.16.1<br/>rpi-kube-worker-01   Ready    &lt;none&gt;   14m   v1.16.1<br/>rpi-kube-worker-02   Ready    &lt;none&gt;   14m   v1.16.1<br/>rpi-kube-worker-03   Ready    &lt;none&gt;   14m   v1.16.1<br/>rpi-kube-worker-04   Ready    &lt;none&gt;   14m   v1.16.1<br/>rpi-kube-worker-05   Ready    &lt;none&gt;   14m   v1.16.1<br/>rpi-kube-worker-06   Ready    &lt;none&gt;   14m   v1.16.1<br/>rpi-kube-worker-07   Ready    &lt;none&gt;   14m   v1.16.1<br/>rpi-kube-worker-08   Ready    &lt;none&gt;   14m   v1.16.1<br/>rpi-kube-worker-09   Ready    &lt;none&gt;   14m   v1.16.1<br/>rpi-kube-worker-10   Ready    &lt;none&gt;   14m   v1.16.1<br/>rpi-kube-worker-11   Ready    &lt;none&gt;   14m   v1.16.1<br/>rpi-kube-worker-12   Ready    &lt;none&gt;   14m   v1.16.1</span></pre><h2 id="d486" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">神奇吧？</h2><p id="ef25" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">让我们具体分析一下这里发生了什么:</p><ol class=""><li id="769e" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv nz mf mg mh bi translated">SD卡是用我们开始时的原始参数重建的。</li><li id="45c7" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv nz mf mg mh bi translated">Raspberry Pi以<code class="fe lv lw lx ly b">rpi-kube-master-01</code>的身份启动，并试图运行Kubernetes的启动脚本。</li><li id="2d5d" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv nz mf mg mh bi translated">启动脚本中的第一步检查现有集群是否正在运行，并找出与其自身匹配的节点名称是否存在并处于<code class="fe lv lw lx ly b">NotReady</code>状态。</li><li id="84bd" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv nz mf mg mh bi translated">已从Kubernetes群集中删除节点。</li><li id="5f6d" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv nz mf mg mh bi translated">从<code class="fe lv lw lx ly b">etcd</code>配置中删除了过时的成员。</li><li id="15ae" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv nz mf mg mh bi translated">更新了<code class="fe lv lw lx ly b">kubeadm-config</code>配置图，删除了过时的节点。</li><li id="2b84" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv nz mf mg mh bi translated">作为全新的主节点加入集群。</li></ol><p id="eeef" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最终，<code class="fe lv lw lx ly b">kubeadm</code>最好能提供某种清理功能，可以从集群中运行的现有主服务器上运行。这将减少对<code class="fe lv lw lx ly b">kubeadm-config</code>和<code class="fe lv lw lx ly b">etcd</code>配置进行任何修改的需要，所以我提供的代码补偿了这个缺失的功能。</p><p id="2f54" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上述重新部署方法理论上可以用于栈中的任何节点，但是对于worker类型，不需要进行<code class="fe lv lw lx ly b">etcd</code>或<code class="fe lv lw lx ly b">kubeadm-config</code>更改。只需简单地从Kubernetes中删除节点就可以满足特定的操作。</p><h1 id="b239" class="mz ky iq bd kz na nb nc lc nd ne nf lf ng nh ni li nj nk nl ll nm nn no lo np bi translated">结论</h1><p id="0662" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">在本指南结束时，您将熟悉如何编写一个SD卡，并对Kubernetes在Raspberry Pi集群上的运行进行最基本的依赖。这样做的目的不是教你部署Kubernetes的复杂性，而是鼓励并向你展示任何复杂的环境都可以通过简单的可维护代码抽象出来。</p><p id="d2b3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一些可能从中吸取的小东西:</p><ol class=""><li id="7fa3" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv nz mf mg mh bi translated">无论有多复杂，总是使用源代码控制来跟踪变更和管理您的基础设施。</li><li id="6524" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv nz mf mg mh bi translated">使用git项目可以帮助您跟踪基础设施在代码中的一致状态，以实现可重复、一致和可预测的部署。</li><li id="fef4" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv nz mf mg mh bi translated">通过开源知识很容易分享和帮助社区。</li><li id="ba2b" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv nz mf mg mh bi translated">这种特殊的方法理论上是无限可扩展的。</li><li id="113a" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv nz mf mg mh bi translated">记得查看我共享的<a class="ae kw" href="https://github.com/lucasteligioridis/raspbernetes" rel="noopener ugc nofollow" target="_blank"> Github项目</a>中的代码，以了解幕后发生了什么！如果你也发现了一些错误或改进，也许可以做些贡献！</li></ol><h1 id="18c9" class="mz ky iq bd kz na nb nc lc nd ne nf lf ng nh ni li nj nk nl ll nm nn no lo np bi translated">参考</h1><ul class=""><li id="6df3" class="lz ma iq ka b kb lq kf lr kj mn kn mo kr mp kv me mf mg mh bi translated"><a class="ae kw" href="https://medium.com/@kvaps/for-make-this-scheme-more-safe-you-can-add-haproxy-layer-between-keepalived-and-kube-apiservers-62c344283076" rel="noopener"> HA代理Kubernetes可用性</a></li><li id="0eec" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated"><a class="ae kw" href="https://kubernetes.io/docs" rel="noopener ugc nofollow" target="_blank"> Kubernetes文档</a></li></ul></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><p id="540a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi oj translated">感谢你跟随我的旅程。我希望你喜欢读这篇文章，并学到了一些东西！</p><blockquote class="os ot ou"><p id="5202" class="jy jz ov ka b kb kc kd ke kf kg kh ki ow kk kl km ox ko kp kq oy ks kt ku kv ij bi translated">请随时在<a class="ae kw" href="https://www.linkedin.com/in/lucas-teligioridis/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上与我联系，并访问我的<a class="ae kw" href="https://github.com/lucasteligioridis" rel="noopener ugc nofollow" target="_blank"> Github </a>。黑客快乐！</p></blockquote></div></div>    
</body>
</html>