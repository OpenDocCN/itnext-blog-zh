<html>
<head>
<title>Entity Framework Core 2.1: Data Seeding</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">实体框架核心2.1:数据播种</h1>
<blockquote>原文：<a href="https://itnext.io/entity-framework-core-2-1-data-seeding-48713a05d48d?source=collection_archive---------1-----------------------#2018-09-16">https://itnext.io/entity-framework-core-2-1-data-seeding-48713a05d48d?source=collection_archive---------1-----------------------#2018-09-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/5ae5e8477d3cd6e1d11bb5111d1e116a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qlNAVavqYunhHI_NNHmbpQ.png"/></div></div></figure><p id="adee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我花了一些时间来探索随推出的一些新功能。NET Core 2.1发布，这篇文章将是这个过程的延续。以下是其他帖子的链接。</p><p id="4bfd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://elanderson.net/2018/09/host-asp-net-core-application-as-a-windows-service/" rel="noopener ugc nofollow" target="_blank">作为Windows服务托管ASP.NET核心应用</a><br/><a class="ae kw" href="https://elanderson.net/2018/09/asp-net-core-2-1-actionresult/" rel="noopener ugc nofollow" target="_blank">ASP.NET核心2.1:action result&lt;T&gt;</a></p><p id="cd53" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">今天，我们将了解添加到实体框架中的一个新特性，它允许数据播种。我使用此功能的<a class="ae kw" href="https://docs.microsoft.com/en-us/ef/core/modeling/data-seeding" rel="noopener ugc nofollow" target="_blank">官方文档</a>作为参考。</p><h2 id="7038" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">示例应用程序</h2><p id="202b" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">我们将使用。NET CLI创建一个新的应用程序使用MVC模板与个人授权，因为它是一个模板来与实体框架已经成立。如果你有一个现有的项目，需要添加实体框架，你可以查看<a class="ae kw" href="https://elanderson.net/2018/04/add-entity-framework-core-to-an-existing-asp-net-core-project/" rel="noopener ugc nofollow" target="_blank">这篇</a>文章。以下是我用来创建项目的命令。</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="af43" class="kx ky iq ma b gy me mf l mg mh">dotnet new mvc --auth Individual</span></pre><h2 id="54ff" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">模型</h2><p id="5e2d" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">在我们开始数据播种之前，我们需要创建一个实体来播种。在本例中，我们将创建一个联系人实体(惊喜！).在<strong class="ka ir"> Models </strong>目录下，我创建了一个<strong class="ka ir"> Contacts.cs </strong>文件，内容如下。</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="dd82" class="kx ky iq ma b gy me mf l mg mh">public class Contact<br/>{<br/>    public int Id { get; set; }<br/>    public string Name { get; set; }<br/>    public string Address { get; set; }<br/>    public string City { get; set; }<br/>    public string State { get; set; }<br/>    public string Zip { get; set; }<br/>}</span></pre><p id="1f60" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，在<strong class="ka ir">数据</strong>目录中，我们将打开<code class="fe mi mj mk ma b">ApplicationDbContext</code>类，并为我们的新联系人实体添加一个<code class="fe mi mj mk ma b">DbSet</code>。将以下属性添加到类中。</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="2cd7" class="kx ky iq ma b gy me mf l mg mh">public DbSet&lt;Contact&gt; Contacts { get; set; }</span></pre><p id="d686" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们已经有了我们的<code class="fe mi mj mk ma b">DbContext</code>设置，让我们使用下面的代码为这个新的联系实体添加一个迁移。NET CLI命令。</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="9ae9" class="kx ky iq ma b gy me mf l mg mh">dotnet ef migrations add Contacts -o Data/Migrations</span></pre><p id="7ea5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，运行以下命令为该应用程序创建/更新数据库。</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="76a0" class="kx ky iq ma b gy me mf l mg mh">dotnet ef database update</span></pre><h2 id="9b17" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">数据播种</h2><p id="a131" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">现在我们的项目已经设置好了，我们可以继续实际的数据播种了。在实体框架中，核心数据播种是在你的<code class="fe mi mj mk ma b">DbContext</code>类的<code class="fe mi mj mk ma b">OnModelCreating</code>函数中完成的。在本例中，这是<code class="fe mi mj mk ma b">ApplicationDbContext</code>类。下面的例子展示了如何使用新的<code class="fe mi mj mk ma b">HasData</code>方法为<code class="fe mi mj mk ma b">Contact</code>实体添加种子数据。</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="de34" class="kx ky iq ma b gy me mf l mg mh">protected override void OnModelCreating(ModelBuilder builder)<br/>{<br/>    base.OnModelCreating(builder);<br/><br/>    builder.Entity&lt;Contact&gt;().HasData(<br/>        new Contact <br/>        {<br/>            Id = 1,<br/>            Name = "Eric",<br/>            Address = "100 Main St",<br/>            City = "Hometown",<br/>            State = "TN",<br/>            Zip = "153789"<br/>        }<br/>    );<br/>}</span></pre><p id="6ab6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">数据播种是通过Entity Framework Core中的迁移来处理的，这与以前的版本有很大的不同。为了显示我们的种子数据，我们需要创建一个迁移，可以使用下面的命令来完成。</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="7534" class="kx ky iq ma b gy me mf l mg mh">dotnet ef migrations add ContactSeedData -o Data/Migrations</span></pre><p id="c1bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后使用以下命令将迁移应用到您的数据库。</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="ba4a" class="kx ky iq ma b gy me mf l mg mh">dotnet ef database update</span></pre><p id="2dcc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">查看迁移创建的代码，您可以看到它只是插入数据。</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="a1e7" class="kx ky iq ma b gy me mf l mg mh">public partial class ContactSeedData : Migration<br/>{<br/>    protected override void Up(MigrationBuilder migrationBuilder)<br/>    {<br/>        migrationBuilder.InsertData(<br/>            table: "Contacts",<br/>            columns: new[] { "Id", "Address", "City", "Name", "State", "Zip" },<br/>            values: new object[] { 1, "100 Main St", "Hometown", "Eric", "TN",<br/>                                   "153789" });<br/>    }<br/><br/>    protected override void Down(MigrationBuilder migrationBuilder)<br/>    {<br/>        migrationBuilder.DeleteData(<br/>            table: "Contacts",<br/>            keyColumn: "Id",<br/>            keyValue: 1);<br/>    }<br/>}</span></pre><p id="6797" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上面的方法在新数据库或新表中非常有效，但是如果您试图将种子数据添加到现有数据库中，就会出现问题。查看<a class="ae kw" href="https://twitter.com/RehanSaeedUK" rel="noopener ugc nofollow" target="_blank"> Rehan的</a>关于<a class="ae kw" href="https://rehansaeed.com/migrating-to-entity-framework-core-seed-data/" rel="noopener ugc nofollow" target="_blank">迁移到实体框架核心种子数据</a>的帖子，了解如何处理这个问题。</p><h2 id="7923" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">包扎</h2><p id="1456" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">我很高兴看到我们有了一种在实体框架核心中预先填充数据的方法，这将使一些场景(如大部分是静态数据)更容易处理。我认为迁移方法的一个缺点是不能有一些内置的测试数据，因为迁移将总是应用于您的数据库。</p></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><p id="fcb4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ms">原载于</em><a class="ae kw" href="https://elanderson.net/2018/09/entity-framework-core-2-1-data-seeding/" rel="noopener ugc nofollow" target="_blank"><em class="ms"/></a><em class="ms">。</em></p></div></div>    
</body>
</html>