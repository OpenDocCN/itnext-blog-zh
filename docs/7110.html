<html>
<head>
<title>Route trino queries dynamically using Trino Gateway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用trino网关动态路由Trino查询</h1>
<blockquote>原文：<a href="https://itnext.io/route-trino-queries-dynamically-using-trino-gateway-9772d62b1630?source=collection_archive---------2-----------------------#2022-06-15">https://itnext.io/route-trino-queries-dynamically-using-trino-gateway-9772d62b1630?source=collection_archive---------2-----------------------#2022-06-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/7b9824d8dcc59628b1df1d5433c94624.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*d8fj6Icg2_n6HCew"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">萨姆·莫格达姆·卡姆西在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="7c27" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Trino是一个流行的查询引擎，用于查询数据仓库中的数据。</p><p id="bde4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">假设只有一个由许多节点组成的大型trino集群，但是这样一个大型trino集群对于一些组织来说可能会有问题。Trino可用于ETL工作负载和交互式查询。当ETL工作负载已经使用了这么大的trino集群的所有资源时，就没有执行交互式查询的空间了，否则交互式查询会变得更慢。</p><p id="9994" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要解决这个问题，可以使用Trino Gateway。我们可以分别为ETL工作负载和交互式查询创建trino集群，然后可以使用trino gateway将trino查询动态路由到下游trino集群。</p><p id="bfc7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这里，我将展示如何创建这样的trino网关，以使用我已经编写的开源的<a class="ae kc" href="https://github.com/cloudcheflabs/dataroaster/tree/master/trino-ecosystem/trino-gateway" rel="noopener ugc nofollow" target="_blank">数据烘烤器Trino网关</a>和<a class="ae kc" href="https://github.com/cloudcheflabs/dataroaster/tree/master/operators/trino" rel="noopener ugc nofollow" target="_blank">数据烘烤器Trino操作符</a>动态地路由Trino查询。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="2c2a" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">Trino网关架构</h1><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/258d686a798ab419de42b28a859815fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3zqwUWL4eHwGM4gSt-R0bg.jpeg"/></div></div></figure><ul class=""><li id="a982" class="ml mm iq kf b kg kh kk kl ko mn ks mo kw mp la mq mr ms mt bi translated"><code class="fe mu mv mw mx b">Admin</code>使用trino操作符创建和删除trino集群，如<a class="ae kc" href="https://github.com/cloudcheflabs/dataroaster/tree/master/operators/trino" rel="noopener ugc nofollow" target="_blank">数据烘烤器Trino操作符</a>。</li><li id="b033" class="ml mm iq kf b kg my kk mz ko na ks nb kw nc la mq mr ms mt bi translated">在kubernetes上创建trino集群后，<code class="fe mu mv mw mx b">Admin</code>向<code class="fe mu mv mw mx b">Trino Gateway</code>注册trino集群和用户，以将trino查询路由到注册的trino集群。</li><li id="d117" class="ml mm iq kf b kg my kk mz ko na ks nb kw nc la mq mr ms mt bi translated"><code class="fe mu mv mw mx b">Admin</code>可以禁用查询不会路由到的trino集群。在停用trino集群时，可以修改后端trino集群的配置，并可以升级后端trino集群。我们可以考虑这样优雅地关闭trino集群。首先停用trino gateway中的trino集群，这样查询就不会被路由，然后监视trino集群中当前执行的查询。在trino集群中执行完所有查询后，可以关闭trino集群或将其升级到新版本。</li><li id="7002" class="ml mm iq kf b kg my kk mz ko na ks nb kw nc la mq mr ms mt bi translated">当客户端发送查询时，<code class="fe mu mv mw mx b">Trino Gateway</code>将首先对用户进行身份验证，并找到用户所属的集群组，查询将被路由到随机选择的属于该集群组的下游trino集群。</li></ul><h1 id="271b" class="li lj iq bd lk ll nd ln lo lp ne lr ls lt nf lv lw lx ng lz ma mb nh md me mf bi translated">安装Trino网关</h1><p id="7397" class="pw-post-body-paragraph kd ke iq kf b kg ni ki kj kk nj km kn ko nk kq kr ks nl ku kv kw nm ky kz la ij bi translated">要让客户端通过TLS访问trino trino gateway，需要先安装nginx入口控制器和cert-manager。</p><h2 id="ee18" class="nn lj iq bd lk no np dn lo nq nr dp ls ko ns nt lw ks nu nv ma kw nw nx me ny bi translated">安装NGINX入口控制器</h2><pre class="mh mi mj mk gt nz mx oa ob aw oc bi"><span id="dba2" class="nn lj iq mx b gy od oe l of og">helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx<br/>helm repo update<br/><br/>## create namespace.<br/>kubectl create namespace ingress-nginx;<br/><br/>helm install \<br/>--namespace ingress-nginx \<br/>ingress-nginx \<br/>ingress-nginx/ingress-nginx \<br/>--version 4.0.17;</span></pre><h2 id="85c1" class="nn lj iq bd lk no np dn lo nq nr dp ls ko ns nt lw ks nu nv ma kw nw nx me ny bi translated">安装证书管理器</h2><pre class="mh mi mj mk gt nz mx oa ob aw oc bi"><span id="89af" class="nn lj iq mx b gy od oe l of og">helm repo add jetstack https://charts.jetstack.io<br/>helm repo update<br/><br/>helm install cert-manager \<br/>jetstack/cert-manager \<br/>--namespace cert-manager \<br/>--create-namespace \<br/>--version v1.5.3 \<br/>--set installCRDs=true;</span></pre><p id="a635" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因为我们将使用加密证书来支持TLS，所以为它创建一个颁发者。</p><pre class="mh mi mj mk gt nz mx oa ob aw oc bi"><span id="49f4" class="nn lj iq mx b gy od oe l of og">## for production.<br/>cat &lt;&lt;EOF &gt; prod-issuer.yaml<br/>apiVersion: cert-manager.io/v1<br/>kind: ClusterIssuer<br/>metadata:<br/>  name: letsencrypt-prod<br/>spec:<br/>  acme:<br/>    server: https://acme-v02.api.letsencrypt.org/directory<br/>    email: mykidong@gmail.com<br/>    privateKeySecretRef:<br/>      name: letsencrypt-prod<br/>    solvers:<br/>    - http01:<br/>        ingress:<br/>          class: nginx<br/>EOF<br/><br/>kubectl apply -f prod-issuer.yaml;</span></pre><h2 id="4bd3" class="nn lj iq bd lk no np dn lo nq nr dp ls ko ns nt lw ks nu nv ma kw nw nx me ny bi translated">将入口主机名添加到公共dns服务器</h2><p id="32e8" class="pw-post-body-paragraph kd ke iq kf b kg ni ki kj kk nj km kn ko nk kq kr ks nl ku kv kw nm ky kz la ij bi translated">Trino gateway有两个用于代理和管理REST API的服务。例如，为了通过TLS将两个服务公开为入口，我们需要注册公共dns服务器的入口主机名。</p><pre class="mh mi mj mk gt nz mx oa ob aw oc bi"><span id="cb0e" class="nn lj iq mx b gy od oe l of og">trino-gateway-proxy-test.cloudchef-labs.com ---&gt; 146.56.150.205<br/>trino-gateway-rest-test.cloudchef-labs.com  ---&gt; 146.56.150.205</span></pre><p id="39ad" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">，其中<code class="fe mu mv mw mx b">146.56.150.205</code>是nginx服务的外部ip。检查nginx服务的外部ip，并设置正确的ip。用您的主机名替换这些主机名。</p><p id="329a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些主机名将用于创建下面trino gateway的入口。</p><h2 id="3231" class="nn lj iq bd lk no np dn lo nq nr dp ls ko ns nt lw ks nu nv ma kw nw nx me ny bi translated">安装Trino网关</h2><pre class="mh mi mj mk gt nz mx oa ob aw oc bi"><span id="20bb" class="nn lj iq mx b gy od oe l of og">helm repo add dataroaster-trino-gateway https://cloudcheflabs.github.io/trino-gateway-helm-repo/<br/>helm repo update<br/><br/>helm install \<br/>trino-gateway \<br/>--create-namespace \<br/>--namespace trino-gateway \<br/>--version v1.6.0 \<br/>--set ingress.proxyHostName=trino-gateway-proxy-test.cloudchef-labs.com \<br/>--set ingress.restHostName=trino-gateway-rest-test.cloudchef-labs.com \<br/>--set trino.proxy.publicEndpoint="https://trino-gateway-proxy-test.cloudchef-labs.com" \<br/>--set dataroastermysql.storage.storageClass=oci \<br/>--set redis.global.storageClass=oci \<br/>--set redis.replica.replicaCount=1 \<br/>dataroaster-trino-gateway/dataroaster-trino-gateway;</span></pre><ul class=""><li id="26d6" class="ml mm iq kf b kg kh kk kl ko mn ks mo kw mp la mq mr ms mt bi translated"><code class="fe mu mv mw mx b">ingress.proxyHostName</code>和<code class="fe mu mv mw mx b">ingress.restHostName</code>需要替换为上面dns的注册主机名。</li><li id="95bb" class="ml mm iq kf b kg my kk mz ko na ks nb kw nc la mq mr ms mt bi translated"><code class="fe mu mv mw mx b">trino.proxy.publicEndpoint</code>是公共端点，trino客户端可以连接到该端点来运行查询。</li><li id="5b88" class="ml mm iq kf b kg my kk mz ko na ks nb kw nc la mq mr ms mt bi translated"><code class="fe mu mv mw mx b">dataroastermysql.storage.storageClass</code>哪一个是依赖关系mysql的存储类，需要修改以适应您的kubernetes集群。</li><li id="e8ef" class="ml mm iq kf b kg my kk mz ko na ks nb kw nc la mq mr ms mt bi translated"><code class="fe mu mv mw mx b">redis.global.storageClass</code>和<code class="fe mu mv mw mx b">redis.replica.replicaCount</code>分别是依赖redis存储类和副本计数。</li></ul><p id="bbd3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">确保证书已成功创建。</p><pre class="mh mi mj mk gt nz mx oa ob aw oc bi"><span id="bc94" class="nn lj iq mx b gy od oe l of og">kubectl get certificate -n trino-gateway;<br/>NAME                                              READY   SECRET                                            AGE<br/>trino-gateway-proxy-test.cloudchef-labs.com-tls   True    trino-gateway-proxy-test.cloudchef-labs.com-tls   46s<br/>trino-gateway-rest-test.cloudchef-labs.com-tls    True    trino-gateway-rest-test.cloudchef-labs.com-tls    46s</span></pre><h1 id="0f43" class="li lj iq bd lk ll nd ln lo lp ne lr ls lt nf lv lw lx ng lz ma mb nh md me mf bi translated">使用Trino操作器安装Trino集群</h1><p id="76fa" class="pw-post-body-paragraph kd ke iq kf b kg ni ki kj kk nj km kn ko nk kq kr ks nl ku kv kw nm ky kz la ij bi translated">要创建trino集群，使用trino操作符有一个简单的方法。</p><h2 id="a4bf" class="nn lj iq bd lk no np dn lo nq nr dp ls ko ns nt lw ks nu nv ma kw nw nx me ny bi translated">安装Trino操作器</h2><pre class="mh mi mj mk gt nz mx oa ob aw oc bi"><span id="e702" class="nn lj iq mx b gy od oe l of og">helm repo add dataroaster-trino-operator <a class="ae kc" href="https://cloudcheflabs.github.io/trino-helm-repo/" rel="noopener ugc nofollow" target="_blank">https://cloudcheflabs.github.io/trino-helm-repo/</a><br/>helm repo update</span><span id="61d0" class="nn lj iq mx b gy oh oe l of og">helm install \<br/>trino-operator \<br/>--create-namespace \<br/>--namespace trino-operator \<br/>--version v2.1.6 \<br/>dataroaster-trino-operator/dataroastertrinooperator;</span></pre><h2 id="b6c9" class="nn lj iq bd lk no np dn lo nq nr dp ls ko ns nt lw ks nu nv ma kw nw nx me ny bi translated">使用自定义资源创建trino集群</h2><p id="250d" class="pw-post-body-paragraph kd ke iq kf b kg ni ki kj kk nj km kn ko nk kq kr ks nl ku kv kw nm ky kz la ij bi translated">创建trino集群的自定义资源，例如<code class="fe mu mv mw mx b">cluster-1.yaml</code>。</p><pre class="mh mi mj mk gt nz mx oa ob aw oc bi"><span id="62b5" class="nn lj iq mx b gy od oe l of og">apiVersion: "trino-operator.cloudchef-labs.com/v1beta1"<br/>kind: TrinoCluster<br/>metadata:<br/>  name: trino-cluster-etl         # (1)<br/>  namespace: trino-operator<br/>spec:<br/>  namespace: trino-cluster-etl    # (2)<br/>  serviceAccountName: trino<br/>  image:<br/>    repository: trinodb/trino<br/>    tag: "384"<br/>    imagePullPolicy: IfNotPresent<br/>    imagePullSecrets: null<br/>  securityContext:<br/>    runAsUser: 1000<br/>    runAsGroup: 1000<br/>  coordinator:<br/>    resources: null<br/>    nodeSelector: null<br/>    affinity: null<br/>    tolerations: null<br/>    configs:<br/>      - name: node.properties<br/>        path: /etc/trino<br/>        value: |<br/>          node.environment=production<br/>          node.data-dir=/data/trino<br/>          plugin.dir=/usr/lib/trino/plugin<br/>      - name: config.properties<br/>        path: /etc/trino<br/>        value: |<br/>          coordinator=true<br/>          node-scheduler.include-coordinator=false<br/>          http-server.http.port=8080<br/>          query.max-memory=4GB<br/>          query.max-memory-per-node=1GB<br/>          memory.heap-headroom-per-node=1GB<br/>          discovery-server.enabled=true<br/>          discovery.uri=http://localhost:8080<br/>      - name: jvm.config<br/>        path: /etc/trino<br/>        value: |<br/>          -server<br/>          -Xmx8G<br/>          -XX:+UseG1GC<br/>          -XX:G1HeapRegionSize=32M<br/>          -XX:+UseGCOverheadLimit<br/>          -XX:+ExplicitGCInvokesConcurrent<br/>          -XX:+HeapDumpOnOutOfMemoryError<br/>          -XX:+ExitOnOutOfMemoryError<br/>          -Djdk.attach.allowAttachSelf=true<br/>          -XX:-UseBiasedLocking<br/>          -XX:ReservedCodeCacheSize=512M<br/>          -XX:PerMethodRecompilationCutoff=10000<br/>          -XX:PerBytecodeRecompilationCutoff=10000<br/>          -Djdk.nio.maxCachedBufferSize=2000000<br/>          -XX:+UnlockDiagnosticVMOptions<br/>          -XX:+UseAESCTRIntrinsics<br/>      - name: log.properties<br/>        path: /etc/trino<br/>        value: |<br/>          io.trino=INFO<br/>      - name: tpch.properties<br/>        path: /etc/trino/catalog<br/>        value: |<br/>          connector.name=tpch<br/>          tpch.splits-per-node=4<br/>      - name: tpcds.properties<br/>        path: /etc/trino/catalog<br/>        value: |<br/>          connector.name=tpcds<br/>          tpcds.splits-per-node=4<br/>  worker:<br/>    replicas: 2<br/>    autoscaler:<br/>      minReplicas: 2<br/>      maxReplicas: 5<br/>      targetCPUUtilizationPercentage: 50<br/>    resources: null<br/>    nodeSelector: null<br/>    affinity: null<br/>    tolerations: null<br/>    configs:<br/>      - name: node.properties<br/>        path: /etc/trino<br/>        value: |<br/>          node.environment=production<br/>          node.data-dir=/data/trino<br/>          plugin.dir=/usr/lib/trino/plugin<br/>      - name: config.properties<br/>        path: /etc/trino<br/>        value: |<br/>          coordinator=false<br/>          http-server.http.port=8080<br/>          query.max-memory=4GB<br/>          query.max-memory-per-node=1GB<br/>          memory.heap-headroom-per-node=1GB<br/>          discovery.uri=http://trino-coordinator-service.trino-cluster-etl.svc:8080   # (3)<br/>      - name: jvm.config<br/>        path: /etc/trino<br/>        value: |<br/>          -server<br/>          -Xmx8G<br/>          -XX:+UseG1GC<br/>          -XX:G1HeapRegionSize=32M<br/>          -XX:+UseGCOverheadLimit<br/>          -XX:+ExplicitGCInvokesConcurrent<br/>          -XX:+HeapDumpOnOutOfMemoryError<br/>          -XX:+ExitOnOutOfMemoryError<br/>          -Djdk.attach.allowAttachSelf=true<br/>          -XX:-UseBiasedLocking<br/>          -XX:ReservedCodeCacheSize=512M<br/>          -XX:PerMethodRecompilationCutoff=10000<br/>          -XX:PerBytecodeRecompilationCutoff=10000<br/>          -Djdk.nio.maxCachedBufferSize=2000000<br/>          -XX:+UnlockDiagnosticVMOptions<br/>          -XX:+UseAESCTRIntrinsics<br/>      - name: log.properties<br/>        path: /etc/trino<br/>        value: |<br/>          io.trino=INFO<br/>      - name: tpch.properties<br/>        path: /etc/trino/catalog<br/>        value: |<br/>          connector.name=tpch<br/>          tpch.splits-per-node=4<br/>      - name: tpcds.properties<br/>        path: /etc/trino/catalog<br/>        value: |<br/>          connector.name=tpcds<br/>          tpcds.splits-per-node=4</span></pre><p id="6561" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要创建自定义资源，请像这样运行。</p><pre class="mh mi mj mk gt nz mx oa ob aw oc bi"><span id="0e13" class="nn lj iq mx b gy od oe l of og">kubectl apply -f cluster-1.yaml;</span></pre><p id="f2c1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要创建第二个和第三个trino集群，需要修改<code class="fe mu mv mw mx b"># (1)</code>、<code class="fe mu mv mw mx b"># (2)</code>、<code class="fe mu mv mw mx b"># (3)</code>并保存为另一个yaml文件，即<code class="fe mu mv mw mx b">cluster-2.yaml</code>和<code class="fe mu mv mw mx b">cluster-3.yaml</code>。举个例子，</p><ul class=""><li id="86ce" class="ml mm iq kf b kg kh kk kl ko mn ks mo kw mp la mq mr ms mt bi translated"><code class="fe mu mv mw mx b"># (1)</code>是在trino运算符的名称空间中创建的自定义资源名称。<code class="fe mu mv mw mx b">trino-cluster-etl-2</code>和<code class="fe mu mv mw mx b">trino-cluster-etl-3</code>为2。集群和3。分别聚类。</li><li id="e920" class="ml mm iq kf b kg my kk mz ko na ks nb kw nc la mq mr ms mt bi translated"><code class="fe mu mv mw mx b"># (2)</code>是将创建trino集群的名称空间。<code class="fe mu mv mw mx b">trino-cluster-etl-2</code>和<code class="fe mu mv mw mx b">trino-cluster-etl-3</code>为2。集群和3。分别聚类。</li><li id="8b32" class="ml mm iq kf b kg my kk mz ko na ks nb kw nc la mq mr ms mt bi translated"><code class="fe mu mv mw mx b"># (3)</code>是trino worker将注册到的发现url。<code class="fe mu mv mw mx b">http://trino-coordinator-service.trino-cluster-etl-2.svc:8080</code>和<code class="fe mu mv mw mx b">http://trino-coordinator-service.trino-cluster-etl-3.svc:8080</code>为2。集群和3。分别聚类。</li></ul><p id="d595" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建另外两个trino集群。</p><pre class="mh mi mj mk gt nz mx oa ob aw oc bi"><span id="b917" class="nn lj iq mx b gy od oe l of og">kubectl apply -f cluster-2.yaml;<br/>kubectl apply -f cluster-3.yaml;</span></pre><p id="0973" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在已经创建了三个trino集群。</p><p id="d03b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，<code class="fe mu mv mw mx b">trino-cluster-etl</code>名称空间中trino cluster的已安装资源看起来与此类似。</p><pre class="mh mi mj mk gt nz mx oa ob aw oc bi"><span id="fc7b" class="nn lj iq mx b gy od oe l of og">kubectl get all -n trino-cluster-etl<br/>NAME                                     READY   STATUS    RESTARTS   AGE<br/>pod/trino-coordinator-5b565cb97b-7prtd   1/1     Running   0          24h<br/>pod/trino-worker-7cd68f7fd-jpm6c         1/1     Running   0          24h<br/>pod/trino-worker-7cd68f7fd-rf6vx         1/1     Running   0          24h</span><span id="f70d" class="nn lj iq mx b gy oh oe l of og">NAME                                TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE<br/>service/trino-coordinator-service   ClusterIP   10.96.35.157   &lt;none&gt;        8080/TCP   24h</span><span id="c4ff" class="nn lj iq mx b gy oh oe l of og">NAME                                READY   UP-TO-DATE   AVAILABLE   AGE<br/>deployment.apps/trino-coordinator   1/1     1            1           24h<br/>deployment.apps/trino-worker        2/2     2            2           24h</span><span id="c2c5" class="nn lj iq mx b gy oh oe l of og">NAME                                           DESIRED   CURRENT   READY   AGE<br/>replicaset.apps/trino-coordinator-5b565cb97b   1         1         1       24h<br/>replicaset.apps/trino-worker-7cd68f7fd         2         2         2       24h</span><span id="89a2" class="nn lj iq mx b gy oh oe l of og">NAME                                               REFERENCE                 TARGETS         MINPODS   MAXPODS   REPLICAS   AGE<br/>horizontalpodautoscaler.autoscaling/trino-worker   Deployment/trino-worker   &lt;unknown&gt;/50%   2         5         2          24h</span></pre><h1 id="b6a7" class="li lj iq bd lk ll nd ln lo lp ne lr ls lt nf lv lw lx ng lz ma mb nh md me mf bi translated">向trino网关注册trino集群</h1><p id="a4f2" class="pw-post-body-paragraph kd ke iq kf b kg ni ki kj kk nj km kn ko nk kq kr ks nl ku kv kw nm ky kz la ij bi translated">最后，将trino集群和用户注册到trino gateway，对用户进行身份验证，并将查询动态路由到trino集群。</p><p id="f17e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">可以看到trino gateway支持的<a class="ae kc" href="https://github.com/cloudcheflabs/dataroaster/tree/master/trino-ecosystem/trino-gateway#trino-gateway-rest-api" rel="noopener ugc nofollow" target="_blank">REST API</a>。</p><h2 id="1dc9" class="nn lj iq bd lk no np dn lo nq nr dp ls ko ns nt lw ks nu nv ma kw nw nx me ny bi translated">创建集群组</h2><pre class="mh mi mj mk gt nz mx oa ob aw oc bi"><span id="e6dc" class="nn lj iq mx b gy od oe l of og">curl -XPOST \<br/>https://trino-gateway-rest-test.cloudchef-labs.com/v1/cluster_group/create \<br/>-d  "group_name=etl_group";</span></pre><h2 id="682a" class="nn lj iq bd lk no np dn lo nq nr dp ls ko ns nt lw ks nu nv ma kw nw nx me ny bi translated">注册用户</h2><pre class="mh mi mj mk gt nz mx oa ob aw oc bi"><span id="81cd" class="nn lj iq mx b gy od oe l of og">## register user who belongs to the cluster group.<br/>curl -XPOST \<br/>https://trino-gateway-rest-test.cloudchef-labs.com/v1/users/create \<br/>-d  "user=trino" \<br/>-d  "password=trino123" \<br/>-d  "group_name=etl_group";</span></pre><h2 id="dd6c" class="nn lj iq bd lk no np dn lo nq nr dp ls ko ns nt lw ks nu nv ma kw nw nx me ny bi translated">注册trino集群</h2><p id="3a04" class="pw-post-body-paragraph kd ke iq kf b kg ni ki kj kk nj km kn ko nk kq kr ks nl ku kv kw nm ky kz la ij bi translated">我们需要为之前创建的trino集群注册三个trino协调器服务。</p><pre class="mh mi mj mk gt nz mx oa ob aw oc bi"><span id="37af" class="nn lj iq mx b gy od oe l of og"># register cluster 1.<br/>curl -XPOST \<br/>https://trino-gateway-rest-test.cloudchef-labs.com/v1/cluster/create \<br/>-d  "cluster_name=etl-trino-cluster-1" \<br/>-d  "cluster_type=etl" \<br/>-d  "url=http://trino-coordinator-service.trino-cluster-etl.svc:8080" \<br/>-d  "activated=true" \<br/>-d  "group_name=etl_group";<br/><br/># register cluster 2.<br/>curl -XPOST \<br/>https://trino-gateway-rest-test.cloudchef-labs.com/v1/cluster/create \<br/>-d  "cluster_name=etl-trino-cluster-2" \<br/>-d  "cluster_type=etl" \<br/>-d  "url=http://trino-coordinator-service.trino-cluster-etl-2.svc:8080" \<br/>-d  "activated=true" \<br/>-d  "group_name=etl_group";<br/><br/><br/># register cluster 3.<br/>curl -XPOST \<br/>https://trino-gateway-rest-test.cloudchef-labs.com/v1/cluster/create \<br/>-d  "cluster_name=etl-trino-cluster-3" \<br/>-d  "cluster_type=etl" \<br/>-d  "url=http://trino-coordinator-service.trino-cluster-etl-3.svc:8080" \<br/>-d  "activated=true" \<br/>-d  "group_name=etl_group";</span></pre><p id="36ed" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有时，您需要停用trino集群，该集群应该升级到新版本。为此，只需使用trino gateway 的停用rest API<a class="ae kc" href="https://github.com/cloudcheflabs/dataroaster/tree/master/trino-ecosystem/trino-gateway#update-activated" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="5512" class="li lj iq bd lk ll nd ln lo lp ne lr ls lt nf lv lw lx ng lz ma mb nh md me mf bi translated">使用客户端运行查询</h1><p id="923d" class="pw-post-body-paragraph kd ke iq kf b kg ni ki kj kk nj km kn ko nk kq kr ks nl ku kv kw nm ky kz la ij bi translated">Trino客户端将用于运行对trino网关的查询。</p><h2 id="e3c0" class="nn lj iq bd lk no np dn lo nq nr dp ls ko ns nt lw ks nu nv ma kw nw nx me ny bi translated">安装trino客户端</h2><pre class="mh mi mj mk gt nz mx oa ob aw oc bi"><span id="3b52" class="nn lj iq mx b gy od oe l of og">mkdir -p ~/trino-cli;<br/>cd ~/trino-cli;<br/><br/>curl -L -O https://repo1.maven.org/maven2/io/trino/trino-cli/384/trino-cli-384-executable.jar;<br/>mv trino-cli-384-executable.jar trino<br/>chmod +x trino<br/><br/>./trino --version;</span></pre><h2 id="f2fa" class="nn lj iq bd lk no np dn lo nq nr dp ls ko ns nt lw ks nu nv ma kw nw nx me ny bi translated">连接到trino网关</h2><pre class="mh mi mj mk gt nz mx oa ob aw oc bi"><span id="7185" class="nn lj iq mx b gy od oe l of og"># user/password: trino/trino123<br/>./trino --server https://trino-gateway-proxy-test.cloudchef-labs.com \<br/>--user trino \<br/>--password --debug;</span></pre><p id="06dd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">和运行查询。</p><pre class="mh mi mj mk gt nz mx oa ob aw oc bi"><span id="6f3e" class="nn lj iq mx b gy od oe l of og">...<br/>trino&gt; select * from tpch.tiny.nation limit 5;<br/> nationkey |   name    | regionkey |                                                   comment<br/>-----------+-----------+-----------+-------------------------------------------------------------------------------------------------------------<br/>         0 | ALGERIA   |         0 |  haggle. carefully final deposits detect slyly agai<br/>         1 | ARGENTINA |         1 | al foxes promise slyly according to the regular accounts. bold requests alon<br/>         2 | BRAZIL    |         1 | y alongside of the pending deposits. carefully special packages are about the ironic forges. slyly special<br/>         3 | CANADA    |         1 | eas hang ironic, silent packages. slyly regular packages are furiously over the tithes. fluffily bold<br/>         4 | EGYPT     |         4 | y above the carefully unusual theodolites. final dugouts are quickly across the furiously regular d<br/>(5 rows)</span><span id="540e" class="nn lj iq mx b gy oh oe l of og">Query 20220710_150615_00039_532z5, FINISHED, 2 nodes<br/><a class="ae kc" href="http://trino-coordinator-service.trino-cluster-etl.svc:8080/ui/query.html?20220710_150615_00039_532z5" rel="noopener ugc nofollow" target="_blank">http://trino-coordinator-service.trino-cluster-etl.svc:8080/ui/query.html?20220710_150615_00039_532z5</a><br/>Splits: 10 total, 10 done (100.00%)<br/>CPU Time: 0.0s total, 8.33K rows/s,     0B/s, 100% active<br/>Per Node: 0.0 parallelism,   145 rows/s,     0B/s<br/>Parallelism: 0.0<br/>Peak Memory: 760B<br/>0.09 [25 rows, 0B] [290 rows/s, 0B/s]</span><span id="6264" class="nn lj iq mx b gy oh oe l of og"><br/>trino&gt; select count(*) from tpch.tiny.nation;<br/> _col0<br/>-------<br/>    25<br/>(1 row)</span><span id="1d80" class="nn lj iq mx b gy oh oe l of og">Query 20220710_150731_00014_kdsmu, FINISHED, 2 nodes<br/><a class="ae kc" href="http://trino-coordinator-service.trino-cluster-etl-3.svc:8080/ui/query.html?20220710_150731_00014_kdsmu" rel="noopener ugc nofollow" target="_blank">http://trino-coordinator-service.trino-cluster-etl-3.svc:8080/ui/query.html?20220710_150731_00014_kdsmu</a><br/>Splits: 10 total, 10 done (100.00%)<br/>CPU Time: 0.0s total, 4.17K rows/s,     0B/s, 75% active<br/>Per Node: 0.0 parallelism,   143 rows/s,     0B/s<br/>Parallelism: 0.1<br/>Peak Memory: 864B<br/>0.09 [25 rows, 0B] [287 rows/s, 0B/s]<br/>...</span></pre></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><p id="4615" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们已经用三个trino集群构建了一个trino网关。为了改进我们的trino网关，我们需要考虑这样的问题，比如检测查询不应该被路由到的集群的疲惫的trino工作者，以及在集群关闭之前执行所有查询的正常关闭。</p><p id="8728" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">参见<a class="ae kc" rel="noopener ugc nofollow" target="_blank" href="/trino-gateway-8e654366df5e"> Trino Gateway </a>。</p></div></div>    
</body>
</html>