<html>
<head>
<title>3 Types of Automated Testing System You Can Build to Enhance DevOps in Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">您可以构建3种类型的自动化测试系统来增强Kubernetes中的DevOps</h1>
<blockquote>原文：<a href="https://itnext.io/3-types-of-automated-testing-system-you-can-build-to-enhance-devops-in-kubernetes-c5e701560d0e?source=collection_archive---------0-----------------------#2021-04-21">https://itnext.io/3-types-of-automated-testing-system-you-can-build-to-enhance-devops-in-kubernetes-c5e701560d0e?source=collection_archive---------0-----------------------#2021-04-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="f8a4" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">层层测试</h1><p id="f15c" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">测试的目的是验证预期的功能并发现潜在的缺陷。测试增强了交付合格产品的信心，也带来了敏捷迭代的可能性。可以肯定地说，测试决定了产品的开发进度。</p><p id="12e8" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">您可能已经知道，在网络中，有7层OSI模型和4层TCP模型。在开发中，我们也有不同的模式，如MTV、MVC、MVP和MVVM。这些技术已经变得更加成熟，其特点是高内聚、低耦合以及责任、模块和层的划分。他们帮助我们构建架构和标准。</p><p id="5d30" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">同样，我们也有不同类型的测试——UI测试、API测试和单元测试。测试是一种平衡产出和成本的方法，而不是一种新型技术。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div class="gh gi lo"><img src="../Images/95229ba2d5d9a8082682027fb719762d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1238/format:webp/0*sC2uLhP_lWI-bpdj.png"/></div></figure><p id="b50a" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">从上图所示的测试金字塔中可以看出，更高层的测试需要更高的成本、更严格的环境要求、更长的实施周期和更仔细的维护。然而，测试的层次越高，就越接近最终用户场景。在《Google如何测试软件》一书中，Google建议进行70/20/10的划分:70%的单元测试，20%的API测试，10%的UI测试。</p><p id="dec1" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">这篇博客分享了如何使用<a class="ae lx" href="https://kubesphere.io/devops" rel="noopener ugc nofollow" target="_blank"> <strong class="kn ir"> KubeSphere DevOps系统</strong> </a>为Kubernetes驱动的应用程序运行自动化测试的想法。</p><h1 id="ac34" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">什么是KubeSphere DevOps</h1><p id="9a77" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">基于Jenkins，<a class="ae lx" href="https://kubesphere.io" rel="noopener ugc nofollow" target="_blank"> KubeSphere </a>为Kubernetes和容器的用例提供了一站式<a class="ae lx" href="https://kubesphere.io/devops" rel="noopener ugc nofollow" target="_blank"> DevOps系统</a>，包括丰富的CI/CD管道构建和插件管理功能，二进制到映像(B2I)，以及Kubernetes中DevOps的源到映像(S2I)。还为管道、S2I和B2I提供了代码依赖缓存支持，以及代码质量管理和管道日志记录等其他功能。</p><p id="59bf" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">KubeSphere 的内置D <a class="ae lx" href="https://kubesphere.io/devops" rel="noopener ugc nofollow" target="_blank"> evOps系统，将应用开发和自动化发布与容器平台顺利结合。它还支持第三方私有映像注册中心和代码库的集成，这带来了私有场景下改进的CI/CD功能，并提供了端到端的用户体验。</a></p><p id="3129" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">尽管如此，用户很少知道KubeSphere DevOps也可以用来构建自动化测试系统，这样自动化的<strong class="kn ir">单元测试、API测试、UI测试</strong>可以有很大的便利性，测试人员的工作也可以更加高效。</p><h1 id="5ec0" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">单元测试</h1><p id="1be0" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">单元测试有很高的运行频率，每次代码提交都应该触发它。由于依赖性很少，单元测试通常只需要一个容器运行时环境。</p><p id="5732" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">下面是一个使用golang:latest在管道中运行单元测试的示例。</p><pre class="lp lq lr ls gt ly lz ma mb aw mc bi"><span id="cba0" class="md jo iq lz b gy me mf l mg mh">pipeline {<br/>  agent {<br/>    node {<br/>      label 'go'<br/>    }<br/>  }<br/>  stages {<br/>    stage('testing') {<br/>      steps {<br/>        container('go') {<br/>          sh '''<br/>          git clone https://github.com/etcd-io/etcd.git<br/>          cd etcd<br/>          make test<br/>          '''<br/>        }</span><span id="958e" class="md jo iq lz b gy mi mf l mg mh">      }<br/>    }<br/>  }<br/>}</span></pre><p id="35c2" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">您可以看到如下管道日志:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mj"><img src="../Images/07b838f24fb4a4ff45458bd3765217e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*50BIIp7es_xaNCLy.png"/></div></div></figure><p id="39a2" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">至于其他语言和框架，通过安装某些包和模拟相关的服务，单元测试也可以很容易地在Kubernetes上运行。因此，我们应该更加关注如何编写有用的单元测试，而不是沉迷于运行时或单元测试计划。</p><h1 id="4dcf" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">API测试</h1><p id="5f32" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果一个团队刚刚开始自动化测试，自动化API测试将是一个很好的起点。</p><p id="91f9" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">单元测试主要是由R&amp;D人编写的。在快速迭代过程中，有经验的R&amp;D人不会忘记编写单元测试。测试在更快的重构和变更过程中扮演着更重要的角色。如果没有人愿意写单元测试，那么单元测试就会被忽视，并且很难推动一些被实践者忽视的东西，这些东西对管理人员来说好处有限。</p><p id="1e51" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">此外，自动化UI测试通常会被手动测试所取代。同时，自动化UI测试的维护带来了很高的成本，这意味着快速迭代过程中的自动化UI测试应该合理地进行。</p><p id="8a98" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">如果团队成员更熟悉API，那么API测试更可取，因为他们在运行测试时有完整的API文档和资料作为参考，特别是在前端和后端代码分开的架构中。</p><p id="f5e0" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">下面是一个使用Postman在管道中运行自动化API测试的示例。</p><pre class="lp lq lr ls gt ly lz ma mb aw mc bi"><span id="6ff3" class="md jo iq lz b gy me mf l mg mh">pipeline {<br/>  agent {<br/>    kubernetes {<br/>      label 'apitest'<br/>      yaml '''apiVersion: v1<br/>kind: Pod<br/>spec:<br/>  containers:<br/>  - name: newman<br/>    image: postman/newman_alpine33<br/>    command: [\'cat\']<br/>    tty: true<br/>    volumeMounts:<br/>    - name: dockersock<br/>      mountPath: /var/run/docker.sock<br/>    - name: dockerbin<br/>      mountPath: /usr/bin/docker<br/>  volumes:<br/>  - name: dockersock<br/>    hostPath:<br/>      path: /var/run/docker.sock<br/>  - name: dockerbin<br/>    hostPath:<br/>      path: /usr/bin/docker<br/>      '''<br/>      defaultContainer 'newman'<br/>    }<br/>  }</span><span id="be3a" class="md jo iq lz b gy mi mf l mg mh">  parameters {<br/>    string(name: 'HOST', defaultValue: '10.10.10.10', description: '')<br/>    string(name: 'PORT', defaultValue: '8000', description: '')<br/>    string(name: 'USERNAME', defaultValue: 'admin', description: '')<br/>    string(name: 'PASSWORD', defaultValue: 'password', description: '')</span><span id="798c" class="md jo iq lz b gy mi mf l mg mh">  }</span><span id="7aab" class="md jo iq lz b gy mi mf l mg mh">  stages {<br/>    stage('testing') {<br/>      steps {<br/>          sh '''<br/>          apk add --no-cache bash git openssh<br/>          git clone https://yourdomain.com/ns/ks-api-test.git</span><span id="0e48" class="md jo iq lz b gy mi mf l mg mh">          cd ks-api-test</span><span id="5a7a" class="md jo iq lz b gy mi mf l mg mh">          sed -i "s/__HOST__/$HOST/g" postman_environment.json<br/>          sed -i "s/__PORT__/$PORT/g" postman_environment.json<br/>          sed -i "s/__USERNAME__/$USERNAME/g" postman_environment.json<br/>          sed -i "s/__PASSWORD__/$PASSWORD/g" postman_environment.json</span><span id="0882" class="md jo iq lz b gy mi mf l mg mh">          npm install -g newman-reporter-htmlextra<br/>          newman run iam/postman_collection.json -e postman_environment.json -r htmlextra<br/>          '''<br/>      }<br/>    }<br/>  }<br/>  post {<br/>    always {<br/>        archiveArtifacts 'ks-api-test/newman/*'<br/>    }<br/>  }<br/>}</span></pre><p id="181a" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">工件将在运行流程后归档:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mj"><img src="../Images/d62d3b5d8a2ee1fdc9df181b0a2509a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5SUIylDqbtoVbQXU.png"/></div></div></figure><p id="278d" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">下载归档的工件并解压缩，以查看测试报告:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mo"><img src="../Images/8a79dc0f8a5181841bf668e8e4269c92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LV203-nUA1OVbaXL.png"/></div></div></figure><p id="9fba" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">自动化API测试的框架很容易通过以下功能的实现来建立:</p><ul class=""><li id="e9ae" class="mp mq iq kn b ko lj ks lk kw mr la ms le mt li mu mv mw mx bi translated">接口请求</li><li id="85c6" class="mp mq iq kn b ko my ks mz kw na la nb le nc li mu mv mw mx bi translated">响应断言</li><li id="c54e" class="mp mq iq kn b ko my ks mz kw na la nb le nc li mu mv mw mx bi translated">请求业务流程</li><li id="34a1" class="mp mq iq kn b ko my ks mz kw na la nb le nc li mu mv mw mx bi translated">报表生成</li></ul><p id="2e4a" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">请记住，您需要根据您的API测试和交付习惯来选择最适合您的团队的解决方案。例如，您可以开发自己的解决方案，或者只使用现有的工具。以上解决方案选择Postman和Newman的原因是团队一般使用Postman进行API测试。</p><p id="fd25" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">剩下的是如何在团队中组织测试。团队既可以单独向同一个存储库提交文件，也可以使用Postman的收费版本共享数据进行集中测试。</p><h1 id="fba4" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">用户界面测试</h1><p id="a256" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">自动化UI测试的高成本可归因于以下几点:</p><ul class=""><li id="affa" class="mp mq iq kn b ko lj ks lk kw mr la ms le mt li mu mv mw mx bi translated">随着前端风格和产品逻辑的变化，测试用例很难维护。</li><li id="c40b" class="mp mq iq kn b ko my ks mz kw na la nb le nc li mu mv mw mx bi translated">稳定的运行环境很难提供，各种超时和脏读会导致很高的失败率。</li></ul><p id="17b0" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">这里的自动化UI测试使用我熟悉的Robotframework，关键字用于自动化测试。</p><p id="45d3" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">下面是一个使用Robotframework在管道中运行自动化UI测试的示例。</p><pre class="lp lq lr ls gt ly lz ma mb aw mc bi"><span id="5fbc" class="md jo iq lz b gy me mf l mg mh">pipeline {<br/>  agent {<br/>    kubernetes {<br/>      label 'robotframework'<br/>      yaml '''apiVersion: v1<br/>kind: Pod<br/>spec:<br/>  containers:<br/>  - name: robotframework<br/>    image: shaowenchen/docker-robotframework:latest<br/>    tty: true<br/>    volumeMounts:<br/>    - name: dockersock<br/>      mountPath: /var/run/docker.sock<br/>    - name: dockerbin<br/>      mountPath: /usr/bin/docker<br/>  volumes:<br/>  - name: dockersock<br/>    hostPath:<br/>      path: /var/run/docker.sock<br/>  - name: dockerbin<br/>    hostPath:<br/>      path: /usr/bin/docker<br/>      '''<br/>      defaultContainer 'robotframework'<br/>    }<br/>  }</span><span id="faa0" class="md jo iq lz b gy mi mf l mg mh">  parameters {<br/>    string(name: 'HOST', defaultValue: '10.10.10.10', description: '')<br/>    string(name: 'PORT', defaultValue: '8080', description: '')<br/>    string(name: 'USERNAME', defaultValue: 'admin', description: '')<br/>    string(name: 'PASSWORD', defaultValue: 'password', description: '')<br/>  }</span><span id="b59e" class="md jo iq lz b gy mi mf l mg mh">  stages {<br/>    stage('testing') {<br/>      steps {<br/>          sh '''<br/>          curl -s -L https://raw.githubusercontent.com/shaowenchen/scripts/master/kubesphere/preinstall.sh | bash<br/>          git clone https://yourdomain.com/ns/ks-ui-test.git</span><span id="e3c6" class="md jo iq lz b gy mi mf l mg mh">          cd ks-ui-test</span><span id="de7b" class="md jo iq lz b gy mi mf l mg mh">          sed -i "s/__USERNAME__/$USERNAME/g" tests/common.robot<br/>          sed -i "s/__PASSWORD__/$PASSWORD/g" tests/common.robot</span><span id="0165" class="md jo iq lz b gy mi mf l mg mh">          echo "\nTestEnv  http://$HOST:$PORT" &gt;&gt; tests/api.robot<br/>          echo "\nTestEnv  http://$HOST:$PORT" &gt;&gt; tests/devops.robot<br/>          ./start.sh'''<br/>      }<br/>    }<br/>  }</span><span id="244b" class="md jo iq lz b gy mi mf l mg mh">  post {<br/>    always {<br/>        sh 'tar cvf report-$BUILD_NUMBER.tar ks-ui-test/tests/report'<br/>        archiveArtifacts '*.tar'<br/>    }<br/>  }<br/>}</span></pre><p id="7a64" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">您可以看到如下管道日志:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mj"><img src="../Images/4c41909528fe7b508672cc8b9df08cbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TP6-46ACxxmuVXFQ.png"/></div></div></figure><p id="1d7f" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">下载归档的工件并解压缩，以查看测试报告:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nd"><img src="../Images/e5dee97568e00b567283949eb57a9480.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*w2z08H0BFJh3AxsW.png"/></div></div></figure><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi ne"><img src="../Images/ba42a8c9843978c35de5b7b0e088f380.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Vtqmfxnh_VbKhnIh.png"/></div></div></figure><h1 id="c9c0" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">关于KubeSphere</h1><p id="74b4" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">KubeSphere是一个基于Kubernetes的开源容器平台，其核心是应用程序。它提供全栈It自动化操作和简化的开发运维工作流。</p><p id="f35e" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><a class="ae lx" href="https://kubesphere.io/" rel="noopener ugc nofollow" target="_blank"> KubeSphere </a>已被全球数千家企业采用，如<strong class="kn ir"> Aqara、新浪、奔来、中国太平、华夏银行、国药控股、微众银行、Geko Cloud、VNG公司、Radore </strong>。KubeSphere为运维提供向导界面和各种企业级功能，包括Kubernetes资源管理、<a class="ae lx" href="https://kubesphere.io/devops/" rel="noopener ugc nofollow" target="_blank">、DevOps (CI/CD) </a>、应用生命周期管理、服务网格、多租户管理、<a class="ae lx" href="https://kubesphere.io/observability/" rel="noopener ugc nofollow" target="_blank">监控</a>、日志记录、警报、通知、存储和网络管理以及GPU支持。有了KubeSphere，企业能够快速建立一个强大且功能丰富的容器平台。</p><p id="f755" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">欲了解更多信息，请访问<a class="ae lx" href="https://kubesphere.io/" rel="noopener ugc nofollow" target="_blank"> https://kubesphere.io </a></p></div></div>    
</body>
</html>