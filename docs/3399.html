<html>
<head>
<title>EKS + Fargate = Extensibility of Kubernetes + Serverless Benefits</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">EKS+Fargate = Kubernetes的可扩展性+无服务器优势</h1>
<blockquote>原文：<a href="https://itnext.io/eks-fargate-extensibility-of-kubernetes-serverless-benefits-77599ac1763?source=collection_archive---------0-----------------------#2019-12-06">https://itnext.io/eks-fargate-extensibility-of-kubernetes-serverless-benefits-77599ac1763?source=collection_archive---------0-----------------------#2019-12-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/5e04d02415d63e56e38c0c3063338ac3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YqS0pE-gfajisVJFTZOxIQ.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Amazon Elastic Kubernetes服务在AWS Fargate上运行Kubernetes pods</figcaption></figure><div class=""/><p id="4dc6" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">云计算的一个基本优势是大大降低了管理服务器硬件的复杂性。随着应用程序容器化的兴起，AWS提出了大量特定于容器的平台。然而，在AWS引入Fargate (ECS启动类型)之前，配置和管理虚拟服务器并不是一个选项，而且始终是一个运营负担，在Fargate中，容器工作负载部署在AWS管理的计算资源上，用户无需管理任何EC2实例。Fargate依赖docker容器来运行应用程序。容器作为ECS任务运行(类似于Kubernetes Pod)，任务由服务管理(类似于Kubernetes部署)，服务可以用弹性负载平衡器设置，以通过HTTP接收外部流量。</p><p id="99e0" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">选择容器执行策略包括管理EC2实例，其中最大的灵活性、对配置和价格的控制开始发挥作用。AWS提供了三种运行容器的主要模型:ECS、Fargate和EKS。</p><ul class=""><li id="5ee4" class="la lb jf ke b kf kg kj kk kn lc kr ld kv le kz lf lg lh li bi translated">ECS是AWS提供的第一个容器编排工具。它基本上由EC2实例组成，这些实例已经安装了docker，并运行一个Docker容器与AWS后端进行对话。</li><li id="ab5f" class="la lb jf ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">Fargate是第二个服务产品，旨在从用户那里抽象出容器下的所有东西(运行它们的EC2实例)。</li><li id="9de3" class="la lb jf ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">EKS是最新的产品。通过EKS，启动Kubernetes集群的一些复杂性从用户那里抽象出来，因为AWS管理主节点——控制平面。</li></ul><p id="6d3b" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">AWS Fargate是两种可用的ECS发布类型之一，Fargate本身不是附加的容器或产品，它是一种发布类型。AWS Fargate将容器呈现为服务(CaaS ),而EC2的基础设施即服务(IaaS)更简单地说就是“无服务器”。这意味着容器已经设置好了，包括网络、安全和最重要的扩展。这些主要的操作负担被抽象出来，为用户提供了直接在云上运行容器的能力。有了这项服务，开发人员只需为每个容器实例指定资源，并让Fargate无缝地处理所有其他需求。</p><figure class="lp lq lr ls gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi lo"><img src="../Images/0be160f39b9fa27539e02c4ad645677d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BD9mN3AvHl-zKrXA"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">AWS Fargate</figcaption></figure><h1 id="c2b9" class="lt lu jf bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">ECS(容器实例)与Fargate</h1><p id="e68e" class="pw-post-body-paragraph kc kd jf ke b kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv mv kx ky kz ij bi translated">ECS容器实例只不过是运行ECS容器代理的EC2实例。EC2实例由用户拥有和管理。该实例像任何其他EC2实例一样出现在EC2实例列表中。另一方面，AWS Fargate管理任务的执行。不再需要管理EC2实例。在Fargate中运行的每个任务都有一个专用的弹性网络接口(ENI ),它有一个私有的IP地址。同一任务的所有容器都可以通过localhost相互通信。</p><figure class="lp lq lr ls gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mw"><img src="../Images/fc152f51988fca5a1274092ec1a6dd5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*S4PFfXtq2BvIoXx_"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">AWS ECS vs AWS Fargate</figcaption></figure><h1 id="3757" class="lt lu jf bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">使用亚马逊EKS和AWS Fargate的无服务器Kubernetes Pods</h1><p id="4a18" class="pw-post-body-paragraph kc kd jf ke b kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv mv kx ky kz ij bi translated">在拉斯维加斯的AWS re:Invent上，该公司宣布Fargate上提供弹性Kubernetes服务(EKS)。用户可以使用该功能让EKS在AWS Fargate上运行Kubernetes pods。有了AWS Fargate，就不再需要担心修补、扩展或保护Amazon EC2实例集群来在云中运行Kubernetes容器。</p><h1 id="9bc4" class="lt lu jf bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">那时和现在</h1><p id="122c" class="pw-post-body-paragraph kc kd jf ke b kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv mv kx ky kz ij bi translated">用户启动EKS控制面板，并将Amazon EC2添加到EKS集群。EC2提供了运行基于Kubernetes的工作负载所需的计算能力。管理主节点和工作节点的费用为0.20美元/集群/小时，按照常规EC2实例成本收取。其他免费费用适用于启动补充资源，如EBS卷、网络/弹性负载平衡器等。</p><figure class="lp lq lr ls gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mx"><img src="../Images/f2e9c90c5f6d4d71bbbca1857648006b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xUWyLFI4fU2CkA7j"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">EKS — EC2节点</figcaption></figure><p id="d9a8" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在，用户启动EKS控制平面并配置fargate-profile，还可以将EC2添加到集群中。Fargate上的网络使用与EKS的AWS CNI配置相同的子网，其中每个Fargate pod都分配有指定子网集中的ENI。有了这一新增功能，用户可以利用无服务器/无节点Kubernetes，他们只需为运行pod所需的vCPU和内存资源量付费。</p><p id="581e" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">使用AWS Fargate，用户只需为pod运行所需的vCPU和内存资源量付费。这包括pod请求的资源，以及在pod旁边运行Kubernetes组件所需的少量内存。</p><figure class="lp lq lr ls gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi my"><img src="../Images/b24ab25681a9f46a82cc58a2f6aade94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dkTlhOLV9asqdda7"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">EKS —法盖特和EC2</figcaption></figure><h1 id="2ff8" class="lt lu jf bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">亚马逊EKS上的AWS Fargate</h1><p id="837f" class="pw-post-body-paragraph kc kd jf ke b kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv mv kx ky kz ij bi translated">带有EKS的AWS Fargate可以与“eksctl”无缝部署，其中所有必需的实体都是自动创建的。AWS还允许用户将Fargate功能与现有的EKS集群关联起来(将EC2作为Kubernetes节点，版本=1.14)。</p><p id="bf77" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在使用<a class="ae mz" href="https://docs.aws.amazon.com/eks/latest/userguide/managed-node-groups.html" rel="noopener ugc nofollow" target="_blank">受管节点组</a>(用于供应或注册提供计算能力的实例)的现有集群中，所有集群安全组都自动配置到基于Fargate的工作负载，或者用户可以将安全组添加到节点组或自动扩展组，以实现在现有EC2实例上运行的pod与在Fargate上运行的pod之间的通信。在Fargate上运行的pod被自动配置为使用与它们相关联的集群的集群安全组。</p><p id="6a02" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">使用Fargate创建EKS集群有多种方法。用户可以使用eksctl、Terraform或AWS控制台在EKS上创建Fargate。用户可以使用“fargate-profiles”来控制fargate或现有EC2 Kubernetes节点上的Kubernetes pods的调度。Fargate配置文件便于使用选择器来根据名称空间或key:value标签来确定pod的部署范围，这些标签可以添加到Kubernetes部署/pod标签中。</p><h1 id="25ef" class="lt lu jf bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">使用eksctl创建集群</h1><p id="5192" class="pw-post-body-paragraph kc kd jf ke b kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv mv kx ky kz ij bi translated">eksctl中添加了一个新选项“— fargate”，它会自动创建所需的IAM策略和fargate配置文件，以便将fargate用于EKS。</p><figure class="lp lq lr ls gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi na"><img src="../Images/b0f702914773bd0c4e6ab2b59e80505b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bOlxMcM5SpsL8qFY"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">在EKS创建Fargate—eks CTL</figcaption></figure><h1 id="2de5" class="lt lu jf bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">使用Terraform创建集群</h1><p id="08cd" class="pw-post-body-paragraph kc kd jf ke b kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv mv kx ky kz ij bi translated">Terraform增加了创建所需的fargate配置文件并将其附加到EKS集群的支持。</p><p id="04f5" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">创建fargate配置文件:</p><pre class="lp lq lr ls gt nb nc nd ne aw nf bi"><span id="7aa4" class="ng lu jf nc b gy nh ni l nj nk">resource "aws_eks_fargate_profile" "example" {<br/>  cluster_name           = aws_eks_cluster.example.name<br/>  fargate_profile_name   = "example"<br/>  pod_execution_role_arn = aws_iam_role.example.arn<br/>  subnet_ids             = aws_subnet.example[*].id</span><span id="46b7" class="ng lu jf nc b gy nl ni l nj nk">  selector {<br/>    namespace = "example"<br/>  }</span><span id="34b0" class="ng lu jf nc b gy nl ni l nj nk">}</span></pre><p id="ed93" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为EKS·法盖特配置文件创建IAM职责:</p><pre class="lp lq lr ls gt nb nc nd ne aw nf bi"><span id="444b" class="ng lu jf nc b gy nh ni l nj nk">resource "aws_iam_role" "example" {<br/>  name = "eks-fargate-profile-example"</span><span id="d4d3" class="ng lu jf nc b gy nl ni l nj nk">  assume_role_policy = jsonencode({<br/>    Statement = [{<br/>      Action    = "sts:AssumeRole"<br/>      Effect    = "Allow"<br/>      Principal = {<br/>        Service = "eks-fargate-pods.amazonaws.com"<br/>      }<br/>    }]<br/>    Version = "2012-10-17"<br/>  })<br/>}<br/></span><span id="7aaf" class="ng lu jf nc b gy nl ni l nj nk">resource "aws_iam_role_policy_attachment" "example-AmazonEKSFargatePodExecutionRolePolicy" {<br/>  policy_arn = "arn:aws:iam::aws:policy/AmazonEKSFargatePodExecutionRolePolicy"<br/>  role       = aws_iam_role.example.name<br/>}</span></pre><h1 id="ee0c" class="lt lu jf bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">使用AWS控制台创建集群</h1><p id="e450" class="pw-post-body-paragraph kc kd jf ke b kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv mv kx ky kz ij bi translated">一旦从AWS控制台“EKS”部分创建了EKS集群，就可以将Fargate配置文件添加到其中。</p><figure class="lp lq lr ls gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nm"><img src="../Images/0d0a1f72e671bd52027e5d0a8057e39d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QR7_grsq3WripQ6H"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">创建Fargate配置文件— AWS控制台</figcaption></figure><h1 id="158e" class="lt lu jf bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">配置组件</h1><h1 id="2c7a" class="lt lu jf bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">Fargate Pod执行角色</h1><p id="cfa5" class="pw-post-body-paragraph kc kd jf ke b kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv mv kx ky kz ij bi translated">AWS Fargate上的Pods需要从Amazon ECR调用AWS APIs。亚马逊EKS pod执行角色为IAM提供了代表用户执行操作的权限。</p><p id="b739" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">IAM角色的信任关系:</p><pre class="lp lq lr ls gt nb nc nd ne aw nf bi"><span id="53f9" class="ng lu jf nc b gy nh ni l nj nk">{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Effect": "Allow",<br/>      "Principal": {<br/>        "Service": [<br/>          "eks.amazonaws.com",<br/>          "eks-fargate-pods.amazonaws.com"<br/>        ]<br/>      },<br/>      "Action": "sts:AssumeRole"<br/>    }<br/>  ]<br/>}</span></pre><p id="e310" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">将信任关系与IAM角色相关联:</p><figure class="lp lq lr ls gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nn"><img src="../Images/bd26fedbd2877acb89a71b32f1596967.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gDQr98-HEmLdS4Np"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">信任关系—角色— PodExecutionPolicy</figcaption></figure><p id="15c6" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">将AmazonEKSFargatePodExecutionRolePolicy添加到上述角色:</p><pre class="lp lq lr ls gt nb nc nd ne aw nf bi"><span id="3f60" class="ng lu jf nc b gy nh ni l nj nk">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "ecr:GetAuthorizationToken",<br/>                "ecr:BatchCheckLayerAvailability",<br/>                "ecr:GetDownloadUrlForLayer",<br/>                "ecr:BatchGetImage"<br/>            ],<br/>            "Resource": "*"<br/>        }<br/>    ]<br/>}</span></pre><figure class="lp lq lr ls gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi na"><img src="../Images/32808e285a483c295903dd73fbe22a7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*J36xnkr3tLCY5hDl"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">IAM角色— PodExecutionPolicy</figcaption></figure><p id="2085" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Kubernetes代理或kubelet代表用户调用Kubernetes API服务器，因此集群需要IAM策略和角色来知道kubelet属于特定用户。此IAM角色被称为pod执行IAM角色。出于与您的帐户相关联的不同目的，用户可以拥有多个pod执行角色。</p><h1 id="7621" class="lt lu jf bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">法盖特简介</h1><p id="8494" class="pw-post-body-paragraph kc kd jf ke b kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv mv kx ky kz ij bi translated">Fargate配置文件允许用户声明在Fargate上运行哪些pod。这使得用户可以在节点(EC2实例)和Fargate上运行工作负载。应至少指定一个Fargate配置文件，以确定启动时应使用Fargate的pod。Fargate配置文件是不可变的，应该创建一个新的更新配置文件来替换现有的配置文件，然后删除原始配置文件。</p><p id="5edd" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">用户创建一个与Kubernetes pods中定义的名称空间和标签相匹配的配置文件。当新的pod启动时，它们将使用配置文件中定义的执行角色和子网在Fargate上运行。</p><pre class="lp lq lr ls gt nb nc nd ne aw nf bi"><span id="b3be" class="ng lu jf nc b gy nh ni l nj nk">{<br/>    "fargateProfileName": "",</span><span id="1788" class="ng lu jf nc b gy nl ni l nj nk">    "clusterName": "",</span><span id="9378" class="ng lu jf nc b gy nl ni l nj nk">    "podExecutionRoleArn": "",</span><span id="9ed8" class="ng lu jf nc b gy nl ni l nj nk">    "subnets": [<br/>        "subnet-1",</span><span id="11f9" class="ng lu jf nc b gy nl ni l nj nk">        "subnet-2"<br/>    ],</span><span id="f053" class="ng lu jf nc b gy nl ni l nj nk">    "selectors": [<br/>        {<br/>            "namespace": "",</span><span id="159d" class="ng lu jf nc b gy nl ni l nj nk">            "key-1": "label",</span><span id="bcfd" class="ng lu jf nc b gy nl ni l nj nk">            "key-2": "label"<br/>        }<br/>    ]<br/>}</span></pre><ul class=""><li id="1c95" class="la lb jf ke b kf kg kj kk kn lc kr ld kv le kz lf lg lh li bi translated"><strong class="ke jg"> fargateProfileName </strong>:标识fargate配置文件对象的唯一名称</li><li id="ceba" class="la lb jf ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated"><strong class="ke jg">集群名</strong>:要附加概要文件的集群的名称</li><li id="e59f" class="la lb jf ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated"><strong class="ke jg"> podExecutionRoleArn </strong>:与Fargate上的pod一起使用的pod执行角色的Amazon资源名称(示例:arn:AWS:iam::XXX:role/AmazonEKSFargatePodExecutionRole)。这个角色被添加到集群的Kubernetes RBAC进行授权，以便在Fargate基础设施上运行的kubelet可以向Amazon EKS集群注册，并作为节点出现在集群中。</li><li id="1c4a" class="la lb jf ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated"><strong class="ke jg">子网</strong>:与配置文件相关联的子网id。对于现有集群，用户可以选择活动集群的子网id。由于AWS CNI使用创建时分配的一组确定子网中的IP，因此可以选择相同的子网来满足Fargate的需求，从而允许集群中的pod和服务之间进行通信。到目前为止，该参数只接受私有子网(没有到互联网网关的直接路由)。</li><li id="a272" class="la lb jf ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated"><strong class="ke jg">选择器</strong>:选择器是一个“键:值”对，用于匹配pod以使用Fargate配置文件。每个选择器必须有一个关联的名称空间。或者，用户也可以为名称空间指定标签。用户可以在一个Fargate配置文件中指定多达五个选择器。一个pod只需要匹配一个选择器就可以使用Fargate配置文件运行。</li></ul><p id="719a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">例如，用户希望在EKS上部署Fargate，其中所有在名称空间中创建的Kubernetes pod:kube-system和default都在Fargate上提供。在这种情况下，CoreDNS——部署在用户基础设施上的唯一EKS控制平面组件也将在Fargate上创建，因为用户选择了“kube-system”命名空间。</p><p id="0626" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Fargate配置文件配置:</p><pre class="lp lq lr ls gt nb nc nd ne aw nf bi"><span id="796f" class="ng lu jf nc b gy nh ni l nj nk">{<br/>    "fargateProfileName": "fargate-profile-1",</span><span id="af05" class="ng lu jf nc b gy nl ni l nj nk">    "clusterName": "eks-kube-fargate",</span><span id="f6f1" class="ng lu jf nc b gy nl ni l nj nk">    "podExecutionRoleArn": "arn:aws:iam::xxx:role/AmazonEKSFargatePodExecutionRole",</span><span id="aaae" class="ng lu jf nc b gy nl ni l nj nk">    "subnets": [<br/>        "subnet-0968a124a4e4b0afe",</span><span id="9f73" class="ng lu jf nc b gy nl ni l nj nk">        "subnet-0723bbe802a360eb9"<br/>    ],</span><span id="e2f7" class="ng lu jf nc b gy nl ni l nj nk">    "selectors": [<br/>        {<br/>            "namespace": "kube-system",<br/>            "namespace": "default"<br/>        }<br/>    ]<br/>}</span></pre><figure class="lp lq lr ls gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi no"><img src="../Images/85f51794277dba0ebba66cb2b85d6e71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*X00ieFZe8KnYdck3"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Fargate配置文件— AWS控制台</figcaption></figure><p id="c662" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">可选地，在pod选择器菜单中，用户可以添加特定的标签，这些标签允许指定来自特定名称空间的哪些pod使用该配置文件在Fargate上运行。</p><figure class="lp lq lr ls gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi np"><img src="../Images/db4eceb8beb2a5d2a3256f52c763d33f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xxBVweZZVX7itKmi"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Fargate Profile — Pod选择器</figcaption></figure><p id="7173" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">多个fargate配置文件可以连接到一个EKS集群。</p><figure class="lp lq lr ls gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nq"><img src="../Images/8e765a1bffcd114d8addc78e330459c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*91bqzkOmxesIyiwp"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">法盖特简介</figcaption></figure><h1 id="18d8" class="lt lu jf bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">在法盖特部署豆荚</h1><p id="a96d" class="pw-post-body-paragraph kc kd jf ke b kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv mv kx ky kz ij bi translated">创建了两个Fargate概要文件，第一个指定名称空间:kube-system和default，另一个指定名称空间“eks-fargate”和标签“environment:fargate”。为配置文件选择了pod执行角色(ARN)。</p><figure class="lp lq lr ls gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nr"><img src="../Images/3d9d585a787de43818937b43fa0f19a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nirRT6I70MBFV4dm"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">法盖特简介</figcaption></figure><figure class="lp lq lr ls gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi na"><img src="../Images/72fede7947589285bb403cab11885b4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SybJOK5zmgQr68hp"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">法盖特简介</figcaption></figure><figure class="lp lq lr ls gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi na"><img src="../Images/1b993c8e1b815c41190cfbfa22550214.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LROBezDphQ7TW8dy"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">法盖特简介</figcaption></figure><p id="db2a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">由于在profile-1中选择了“kube-system ”, CoreDNS pod将被安排在Fargate上。用户可以在EC2集群上控制CoreDNS pods的部署，从上面的配置文件中删除名称空间。</p><figure class="lp lq lr ls gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ns"><img src="../Images/9ed05a64a68b8d00d36285b22e96ee16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hk7_YJn74mv4LFz_"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">法盖特的库伯内特豆荚</figcaption></figure><p id="eedc" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如上所示，在Fargate上创建了两个CoreDNS pod(deployment-replicas:2 ),并提供了来自配置文件中配置的子网的IP。与Fargate AWS管理底层基础设施一样，运行pod的计算能力分布在AWS管理的随机节点上。</p><p id="f9f1" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">EKS自动分配所需的特定标签，以将基于fargate的pod与其他pod(如果存在的话)分开，其中包括使用的Fargate配置文件。可选地，用户可以向fargate配置文件提供标签，这些标签将被添加到pod标签中。</p><figure class="lp lq lr ls gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nt"><img src="../Images/8f484608a258b1fa03b2051f6ef30697.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AE27guTMEfHixOcv"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Kubernetes标签— Fargate</figcaption></figure><p id="1bf4" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">fargate-profile“fargate-profile-2”如上所述，选择器配置包括选择一个名称空间“eks-fargate”和一个自定义标签“environment:fargate”。使用下面的清单部署了一个示例nginx部署，该清单只包含“namespace:eks-fargate”:</p><pre class="lp lq lr ls gt nb nc nd ne aw nf bi"><span id="a1bc" class="ng lu jf nc b gy nh ni l nj nk">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: nginx-aws<br/>  namespace: eks-fargate<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app: nginx-aws<br/>  replicas: 1<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: nginx-aws<br/>    spec:<br/>      containers:<br/>      - name: nginx-aws<br/>        image: nginx<br/>        ports:</span><span id="9777" class="ng lu jf nc b gy nl ni l nj nk">        - containerPort: 80</span></pre><p id="1555" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">由于“fargate-profile-2”包括标签“environment:fargate”以及“namespace:eks-fargate”，上面的部署将保持挂起状态，因为集群中没有其他EC2 Kubernetes节点。</p><figure class="lp lq lr ls gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nu"><img src="../Images/7d212f6209adc3e97169d304cc5fee4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*i5wp-cg_9ehXWLXP"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">基于标签的选择器— Fargate配置文件</figcaption></figure><p id="c15e" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这展示了使用定制标签和名称空间来控制Fargate上的pod调度的能力。来自相同名称空间的pod可以在EC2或Faragate上运行。如下所示，一旦添加了标签“环境:Fargate ”, pod将被安排在Fargate上。</p><figure class="lp lq lr ls gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi na"><img src="../Images/34947d6bece6ad0b042c6d6c809292ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EMdnX_VcZiBq8Ard"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">基于标签的选择器— Fargate配置文件</figcaption></figure><h1 id="c702" class="lt lu jf bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">限制</h1><p id="4918" class="pw-post-body-paragraph kc kd jf ke b kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv mv kx ky kz ij bi translated">在EKS上使用Fargate的原生EKS功能有一定的限制。使用混合集群(EC2+Fargate)可以缓解大部分问题，在混合集群中，具有复杂需求的Kubernetes对象可以使用EC2节点，而具有最低需求的其他pod可以部署在Fargate上，这可以显著减少集群中EC2实例的数量。</p><figure class="lp lq lr ls gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nv"><img src="../Images/c19679deb11cb76659acf6f1e36d307c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*E0ZLVCKj776tcq88"/></div></div></figure><h1 id="86f2" class="lt lu jf bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">用例</h1><ul class=""><li id="31a7" class="la lb jf ke b kf mr kj ms kn nw kr nx kv ny kz lf lg lh li bi translated">如果工作负载符合CPU或内存要求(大约:4个vCPU和30Gb ),并且没有复杂的要求(存储、LB等)。)，用户可以在Fargate上调度这些特定的工作负载集，而不是使用EC2来获得计算能力。</li><li id="b710" class="la lb jf ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">当工作负载由一致的周期性任务组成时，比如来自队列的cron作业或临时作业，那么可以利用AWS Fargate。AWS Fargate可以用来根据需求运行容器，而不是为EC2实例付费。</li><li id="a0b9" class="la lb jf ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">如果工作负载小而简单(网站或应用程序中的一层),应用程序在白天有更多流量，而在晚上流量较低，那么AWS Fargate仍然是最佳选择。用户可以在晚上在Fargate上缩小到成本很低的小容器，而在EC2上白天当基础设施需求更高时再扩大。</li><li id="2ac6" class="la lb jf ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">对于开发和测试团队来说，Fargate可以用来在组织内部启动pod。</li><li id="6091" class="la lb jf ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">对于按需或按计划运行且不需要专用EC2实例的任务。</li></ul><p id="3d54" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi">*****************************************************************</p><p id="acf3" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">EKS的AWS Fargate将允许客户移除操作工人节点的无差别重负载，同时还能够使用Kubernetes API。有了Fargate，用户只需为pod运行所需的vCPU、内存和资源量付费，这意味着开发人员不必担心过度配置，因为Fargate应该在任何给定时刻运行该pod所需的确切数量的资源，而不是更多。</p><p id="8118" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">亚马逊EKS和AWS Fargate提供了Fargate的无服务器优势、亚马逊EKS的最佳实践以及Kubernetes开箱即用的可扩展性。</p></div></div>    
</body>
</html>