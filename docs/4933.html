<html>
<head>
<title>Kubernetes: running SQL migrations with Kubernetes Job and Helm hook</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes:使用Kubernetes Job和Helm hook运行SQL迁移</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-running-sql-migrations-with-kubernetes-job-and-helm-hook-6b25c7041b10?source=collection_archive---------0-----------------------#2020-10-27">https://itnext.io/kubernetes-running-sql-migrations-with-kubernetes-job-and-helm-hook-6b25c7041b10?source=collection_archive---------0-----------------------#2020-10-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/e8b650911a5563fa094f6d923d4a4a95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vYjNPycxLPi6nv7fDPoBwQ.png"/></div></div></figure><p id="d3b6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们有一个在Kubernetes中运行的项目，它需要在部署期间运行SQL迁移。</p><p id="1398" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要运行迁移，需要克隆一个Github存储库，并实际运行存储在其中的迁移。</p><p id="4db9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">目前，这是通过<a class="ae kw" href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/" rel="noopener ugc nofollow" target="_blank"> Kubernetes initContainers </a>完成的，有两个——第一个使用<code class="fe kx ky kz la b">git</code>将带有迁移文件的存储库克隆到<a class="ae kw" href="https://kubernetes.io/docs/concepts/storage/volumes/" rel="noopener ugc nofollow" target="_blank"> Kubernetes卷</a>中，然后另一个使用<code class="fe kx ky kz la b"><a class="ae kw" href="https://github.com/rubenv/sql-migrate" rel="noopener ugc nofollow" target="_blank">sql-migrate</a></code>从这个共享卷运行这些迁移。</p><p id="69e1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尽管如此，这种方法还是有一些问题:</p><ol class=""><li id="eb7b" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv lg lh li lj bi translated">每次当我们运行一个新的pod时，它都会运行它的initContainers和迁移</li><li id="40bc" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated">如果一个部署启动了几个单元，每个单元将运行迁移</li><li id="5a1a" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated">如果迁移将运行一段时间，并且不会对Kubernetes的就绪状态做出响应，那么它可能会在完成迁移之前就被终止</li></ol><p id="9345" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了避免上述所有情况，让我们重新配置这个过程，使用一个<a class="ae kw" href="https://kubernetes.io/docs/concepts/workloads/controllers/job/" rel="noopener ugc nofollow" target="_blank"> Kubernetes作业</a>来只运行一个pod，并添加<a class="ae kw" href="https://helm.sh/docs/topics/charts_hooks/" rel="noopener ugc nofollow" target="_blank"> Helm Hooks </a>来在部署期间触发迁移。</p><p id="50bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="lp">注意:这里的kk是kubectl的别名。</em></p><h1 id="f475" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">准备</h1><h2 id="8019" class="mo lr iq bd ls mp mq dn lw mr ms dp ma kj mt mu me kn mv mw mi kr mx my mm mz bi translated">Docker图像</h2><p id="36a4" class="pw-post-body-paragraph jy jz iq ka b kb na kd ke kf nb kh ki kj nc kl km kn nd kp kq kr ne kt ku kv ij bi translated">首先，让我们用21点和https://github.com/rubenv/sql-migrate<code class="fe kx ky kz la b">git</code>和<a class="ae kw" href="https://github.com/rubenv/sql-migrate" rel="noopener ugc nofollow" target="_blank">创造我们自己的码头工人形象。</a></p><p id="f7e3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建Dockerfile文件:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="4b91" class="mo lr iq la b gy nn no l np nq">FROM golang:alpine AS builder<br/>RUN apk add --no-cache git gcc g++<br/>RUN go get -v github.com/rubenv/sql-migrate/sql-migrate<br/>RUN mv /go/bin/sql-migrate /bin/sql-migrate</span></pre><p id="9aa7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">构建并推动它:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="8e37" class="mo lr iq la b gy nn no l np nq">$ docker build -t projectname/sql-migrate-git .<br/>$ docker push projectname/sql-migrate-git</span></pre><h2 id="92c7" class="mo lr iq bd ls mp mq dn lw mr ms dp ma kj mt mu me kn mv mw mi kr mx my mm mz bi translated">Git认证</h2><p id="cd2b" class="pw-post-body-paragraph jy jz iq ka b kb na kd ke kf nb kh ki kj nc kl km kn nd kp kq kr ne kt ku kv ij bi translated">第二件事是Github认证。</p><p id="fdf5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此时，我们的git-container通过一个保存在Kubernetes Secrets中的RSA密钥进行身份验证，然后它通过一个环境变量传递给一个pod，bash脚本<code class="fe kx ky kz la b">/opt/git/git.sh</code>从这个环境变量获取这个密钥，这个脚本用于在容器内部创建一个密钥文件<code class="fe kx ky kz la b">/root/.ssh/id_rsa</code>，这个密钥最终用于身份验证。</p><p id="c967" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们部署中的<code class="fe kx ky kz la b">initContainers</code>目前看起来像是下一个:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="6d75" class="mo lr iq la b gy nn no l np nq">...<br/>      initContainers:<br/>      - name: git-clone<br/>        image: projectname/git-cloner<br/>        env:<br/>        - name: SSH_PRIVATE_KEY<br/>          valueFrom:<br/>            secretKeyRef:<br/>              name: git-ssh-key<br/>              key: id_rsa<br/>        - name: REPOSITORY_URL<br/>          value: {{ .Values.git.repo }}<br/>        - name: GIT_BRANCH<br/>          value: {{ .Values.git.branch }}<br/>        command: ['sh', '-c', '/opt/git/git.sh']<br/>        volumeMounts:<br/>          - name: git-volume<br/>            mountPath: "/git"<br/>            readOnly: false<br/>      - name: init-migration<br/>        image: fufuhu/sql-migrate:latest<br/>        command: ['sh', '-c', 'while [ ! -d /git/db/migrations ]; do sleep 2; done &amp;&amp; sleep 2; /bin/sql-migrate up -config=/config/config.yaml -env=main']<br/>        volumeMounts:<br/>          - name: migration-config<br/>            mountPath: "/config/"<br/>            readOnly: true<br/>          - name: git-volume<br/>            mountPath: "/git"<br/>            readOnly: false<br/>...</span></pre><p id="b087" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">很多步骤，很多对象，复杂的过程。</p><p id="ec7f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">相反，让我们使用一个登录名和一个<a class="ae kw" href="https://docs.github.com/en/free-pro-team@latest/github/authenticating-to-github/creating-a-personal-access-token" rel="noopener ugc nofollow" target="_blank"> Github令牌</a>，它将从环境变量传递到我们的容器中，然后我们可以通过HTTPS克隆这个库。</p><p id="6b66" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们来测试一下:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="9fe4" class="mo lr iq la b gy nn no l np nq">~ # export GIT_AUTHUSER=backend-user<br/>~ # export GIT_AUTHKEY=cdc***0fe<br/>~ # git clone<br/><a class="ae kw" href="https://$GIT_AUTHUSER:$GIT_AUTHKEY@github.com/projectname-dev/backend-services.git" rel="noopener ugc nofollow" target="_blank">https://$GIT_AUTHUSER:$GIT_AUTHKEY@github.com/projectname-dev/backend-services.git</a><br/>Cloning into ‘backend-services’…<br/>…<br/>Receiving objects: 100% (5115/5115), 846.55 KiB | 1.30 MiB/s, done.<br/>Resolving deltas: 100% (2826/2826), done.</span></pre><p id="f0cb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">很好，“有用”</p><h1 id="3a4e" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">Kubernetes中的SQL迁移</h1><p id="9feb" class="pw-post-body-paragraph jy jz iq ka b kb na kd ke kf nb kh ki kj nc kl km kn nd kp kq kr ne kt ku kv ij bi translated">现在，我们可以开始编写一个清单文件<code class="fe kx ky kz la b">templates/appname-api-migrations.yaml</code>来描述我们的Kubernetes任务，这个任务稍后将由一个Helm hook触发。</p><h2 id="b571" class="mo lr iq bd ls mp mq dn lw mr ms dp ma kj mt mu me kn mv mw mi kr mx my mm mz bi translated">库伯内特工作</h2><h2 id="f39e" class="mo lr iq bd ls mp mq dn lw mr ms dp ma kj mt mu me kn mv mw mi kr mx my mm mz bi translated"><code class="fe kx ky kz la b">git clone</code></h2><p id="00c8" class="pw-post-body-paragraph jy jz iq ka b kb na kd ke kf nb kh ki kj nc kl km kn nd kp kq kr ne kt ku kv ij bi translated">首先，为了确保作业正常运行——让我们在不使用Helm变量和值的情况下编写它，所有pod的环境变量都将被设置为明文值，这里的操作暂时为<code class="fe kx ky kz la b">git clone</code>:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="112c" class="mo lr iq la b gy nn no l np nq">apiVersion: batch/v1<br/>kind: Job<br/>metadata:<br/>  name: "migration-job"<br/>  labels:<br/>  annotations:<br/>spec: <br/>  backoffLimit: 0<br/>  template:<br/>    metadata:<br/>      name: "migration-job-pod"<br/>    spec:<br/>      restartPolicy: Never<br/>      containers:<br/>      - name: db-migrations<br/>        image: projectname/sql-migrate-git:latest<br/>        command: ["/bin/sh", "-c"]<br/>        args:<br/>          - git clone --single-branch --branch develop <a class="ae kw" href="https://backend-user:cdc***0fe@github.com/projectname/backend-services.git" rel="noopener ugc nofollow" target="_blank">https://backend-user:cdc***0fe@github.com/projectname/backend-services.git</a> &amp;&amp;<br/>            ls -l backend-services/db/migrations</span></pre><p id="b397" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这里的<code class="fe kx ky kz la b"><a class="ae kw" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy" rel="noopener ugc nofollow" target="_blank">restartPolicy</a></code>中，我们已经设置为如果失败就不重启容器，因为我们希望看到迁移失败，并且在<code class="fe kx ky kz la b">backoffLimit=0</code>中也是如此——如果失败就不重新创建pod，并且只让作业处于<em class="lp">失败</em>状态。</p><p id="43b1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe kx ky kz la b">git clone</code>中，将从Jenkins作业中设置一个分支，用户和URL将被设置在<code class="fe kx ky kz la b">values.yaml</code>中，认证令牌将与<a class="ae kw" href="https://rtfm.co.ua/en/helm-helm-secrets-sensitive-data-encryption-with-aws-kms-and-use-it-from-jenkins/" rel="noopener ugc nofollow" target="_blank"> Helm secrets </a>一起保存，稍后会将其移动到一个环境变量中。</p><p id="e469" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建作业:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="0a52" class="mo lr iq la b gy nn no l np nq">$ kk -n eks-dev-1-appname-api-ns apply -f appname-api-jobs.yaml<br/>job.batch/migration-job created</span></pre><p id="b166" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查其日志:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="4383" class="mo lr iq la b gy nn no l np nq">$ kk -n eks-dev-1-appname-api-ns logs job/migration-job<br/>Cloning into ‘backend-services’…<br/>total 20<br/>-rw-r — r — 1 root root 538 Oct 24 12:20 BS_1_init_schema.up.sql<br/>-rw-r — r — 1 root root 180 Oct 24 12:20 BS_2_add_brand_field.up.sql<br/>-rw-r — r — 1 root root 225 Oct 24 12:20 BS_3_alter_table.up.sql<br/>-rw-r — r — 1 root root 194 Oct 24 12:20 BS_4_add_created_at_field.sql<br/>-rw-r — r — 1 root root 272 Oct 24 12:20 BS_5_alter_table_nourishment_diet.up.sql</span></pre><p id="f08c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">存储库已克隆，现在可以访问迁移文件。</p><p id="1243" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查pod的状态:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="44c8" class="mo lr iq la b gy nn no l np nq">$ kk -n eks-dev-1-appname-api-ns get pod<br/>NAME READY STATUS RESTARTS AGE<br/>migration-job-f72vs 0/1 Completed 0 9s</span></pre><p id="50d4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以及作业的状态:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="0399" class="mo lr iq la b gy nn no l np nq">$ kk -n eks-dev-1-appname-api-ns get job<br/>NAME COMPLETIONS DURATION AGE<br/>migration-job 1/1 2s 5s</span></pre><p id="fbf0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在可以继续进行准确的迁移过程了。</p><h2 id="d748" class="mo lr iq bd ls mp mq dn lw mr ms dp ma kj mt mu me kn mv mw mi kr mx my mm mz bi translated"><code class="fe kx ky kz la b">Secret</code></h2><p id="2d33" class="pw-post-body-paragraph jy jz iq ka b kb na kd ke kf nb kh ki kj nc kl km kn nd kp kq kr ne kt ku kv ij bi translated">要运行迁移，我们需要创建一个配置文件，该文件将存储在<a class="ae kw" href="https://rtfm.co.ua/kubernetes-configmaps-i-secrets-na-primere-gorush-servera/" rel="noopener ugc nofollow" target="_blank"> Kubernetes ConfigMap </a>中，但是在这个文件中，必须设置数据库的密码。</p><p id="a5d0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将它明文存储在配置图和文件中并不是一个好主意，但是<code class="fe kx ky kz la b">sql-migrate</code>允许我们在文件中使用一个环境变量，查看它的文档-<a class="ae kw" href="https://github.com/rubenv/sql-migrate#as-a-standalone-tool" rel="noopener ugc nofollow" target="_blank">https://github.com/rubenv/sql-migrate#as-a-standalone-tool</a></p><p id="1d05" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，我们将为pod创建一个名为<code class="fe kx ky kz la b">$DB_PASSWORD</code>的变量，并将实际密码保存在Kubernetes Secrets中，稍后在Helm中，我们将使用<a class="ae kw" href="https://rtfm.co.ua/en/helm-helm-secrets-sensitive-data-encryption-with-aws-kms-and-use-it-from-jenkins/" rel="noopener ugc nofollow" target="_blank"> Helm secrets </a>将其加密存储在图表值中。</p><p id="1a43" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">同样在这个秘密中，我们将为在<code class="fe kx ky kz la b">git clone</code>命令中使用的<code class="fe kx ky kz la b">$GIT_TOKEN</code>环境变量存储一个值。</p><p id="834c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">还有一个<code class="fe kx ky kz la b">templates/appname-api-migrations.yaml</code>加一个<code class="fe kx ky kz la b">Secret</code>:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="ed4d" class="mo lr iq la b gy nn no l np nq">...<br/>---<br/>apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  name: backend-db-password<br/>type: Opaque<br/>stringData:<br/>  db_password: password<br/>  git_token: cdc***0fe</span></pre><p id="b11c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在作业的<code class="fe kx ky kz la b">spec.containers.env</code>中添加变量并更新<code class="fe kx ky kz la b">git clone</code>以使用<code class="fe kx ky kz la b">$GIT_TOKEN</code>变量:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="f4d1" class="mo lr iq la b gy nn no l np nq">...<br/>      containers:<br/>      - name: db-migrations<br/>        image: projectname/sql-migrate-git:latest<br/>        command: ["/bin/sh", "-c"]<br/>        args:<br/>          - git clone --single-branch --branch develop <a class="ae kw" href="https://backend-user:$GIT_TOKEN@github.com/projectnamev/backend-services.git" rel="noopener ugc nofollow" target="_blank">https://backend-user:$GIT_TOKEN@github.com/projectnamev/backend-services.git</a> &amp;&amp;<br/>            ls -l backend-services/db/migrations;<br/>            cat /config/config.yaml<br/>        env:<br/>        - name: GIT_TOKEN<br/>          valueFrom:<br/>            secretKeyRef:<br/>              name: backend-db-password<br/>              key: git_token<br/>        - name: DB_PASSWORD<br/>          valueFrom:<br/>            secretKeyRef:<br/>              name: backend-db-password<br/>              key: db_password<br/>...</span></pre><h2 id="49a0" class="mo lr iq bd ls mp mq dn lw mr ms dp ma kj mt mu me kn mv mw mi kr mx my mm mz bi translated"><code class="fe kx ky kz la b">ConfigMap</code></h2><p id="83de" class="pw-post-body-paragraph jy jz iq ka b kb na kd ke kf nb kh ki kj nc kl km kn nd kp kq kr ne kt ku kv ij bi translated">接下来，创建一个<code class="fe kx ky kz la b">ConfigMap</code>来保存<code class="fe kx ky kz la b">sql-migrate</code>的<code class="fe kx ky kz la b">/config/config.yaml</code>内容，并在其中使用<code class="fe kx ky kz la b">$DB_PASSWORD</code>变量:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="d919" class="mo lr iq la b gy nn no l np nq">...<br/>---<br/>apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: migration-config<br/>data:<br/>  config.yaml: |<br/>    main:<br/>      dialect: mysql<br/>      datasource: backend-user:${DB_PASSWORD}@tcp(stage.backend-db3-master.example.com:3306)/dbname?parseTime=true<br/>      dir: backend-services/db/migrations<br/>      table: backend_services_migrations</span></pre><p id="49fe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在任务的pod模板中添加<code class="fe kx ky kz la b">volumes</code>，通过<code class="fe kx ky kz la b">volumeMounts</code>在<code class="fe kx ky kz la b">spec.containers</code>中挂载配置图为<code class="fe kx ky kz la b">/config/config.yaml</code>文件的卷。</p><p id="3f28" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该作业的完整清单如下:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="678d" class="mo lr iq la b gy nn no l np nq">apiVersion: batch/v1<br/>kind: Job<br/>metadata:<br/>  name: "migration-job"<br/>  labels:<br/>  annotations:<br/>spec: <br/>  backoffLimit: 0<br/>  template: <br/>    metadata:<br/>      name: "migration-job-pod"<br/>    spec:<br/>      restartPolicy: Never<br/>      containers:<br/>      - name: db-migrations<br/>        image: projectname/sql-migrate-git:latest<br/>        command: ["/bin/sh", "-c"]<br/>        args:<br/>          - git clone --single-branch --branch develop <a class="ae kw" href="https://backend-user:$GIT_TOKEN@github.com/projectname/backend-services.git" rel="noopener ugc nofollow" target="_blank">https://backend-user:$GIT_TOKEN@github.com/projectname/backend-services.git</a> &amp;&amp;<br/>            ls -l backend-services/db/migrations;<br/>            cat /config/config.yaml<br/>        env:<br/>        - name: GIT_TOKEN<br/>          valueFrom:<br/>            secretKeyRef:<br/>              name: backend-db-password<br/>              key: git_token<br/>        - name: DB_PASSWORD<br/>          valueFrom:<br/>            secretKeyRef:<br/>              name: backend-db-password<br/>              key: db_password<br/>        volumeMounts:<br/>        - name: migration-config<br/>          mountPath: "/config/config.yaml"<br/>          subPath: "config.yaml"<br/>          readOnly: true<br/>      volumes:<br/>        - name: migration-config<br/>          configMap: <br/>            name: migration-config<br/>            items:<br/>            - key: "config.yaml"<br/>              path: "config.yaml"<br/>...</span></pre><p id="ed7d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行它:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="d451" class="mo lr iq la b gy nn no l np nq">$ kk -n eks-dev-1-appname-api-ns apply -f appname-api-jobs.yaml<br/>job.batch/migration-job created<br/>secret/backend-db-password created<br/>configmap/migration-config created</span></pre><p id="5d7e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="8572" class="mo lr iq la b gy nn no l np nq">$ kk -n eks-dev-1-appname-api-ns logs job/migration-job<br/>Cloning into ‘backend-services’…<br/>total 20<br/>-rw-r — r — 1 root root 538 Oct 24 13:41 BS_1_init_schema.up.sql<br/>-rw-r — r — 1 root root 180 Oct 24 13:41 BS_2_add_brand_field.up.sql<br/>-rw-r — r — 1 root root 225 Oct 24 13:41 BS_3_alter_table.up.sql<br/>-rw-r — r — 1 root root 194 Oct 24 13:41 BS_4_add_created_at_field.sql<br/>-rw-r — r — 1 root root 272 Oct 24 13:41 BS_5_alter_table_nourishment_diet.up.sql<br/>main:<br/>dialect: mysql<br/>datasource: backend-user:${DB_PASSWORD}@tcp(stage.backend-db3-master.example.com:3306)/dbname?parseTime=true<br/>dir: backend-services/db/migrations<br/>table: backend_services_migrations</span></pre><p id="a3e9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好—存储库已克隆，配置文件已创建。</p><h2 id="a1e2" class="mo lr iq bd ls mp mq dn lw mr ms dp ma kj mt mu me kn mv mw mi kr mx my mm mz bi translated">运行迁移</h2><p id="702c" class="pw-post-body-paragraph jy jz iq ka b kb na kd ke kf nb kh ki kj nc kl km kn nd kp kq kr ne kt ku kv ij bi translated">现在我们可以用<code class="fe kx ky kz la b">-dryrun</code>选项和第二个命令——检查其状态——来描述迁移过程:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="fa65" class="mo lr iq la b gy nn no l np nq">...<br/>        args:<br/>          - git clone --single-branch --branch develop <a class="ae kw" href="https://backend-user:$GIT_TOKEN@github.com/projectname/backend-services.git" rel="noopener ugc nofollow" target="_blank">https://backend-user:$GIT_TOKEN@github.com/projectname/backend-services.git</a> &amp;&amp;<br/>            ls -l backend-services/db/migrations &amp;&amp;<br/>            cat /config/config.yaml &amp;&amp;<br/>            /bin/sql-migrate up -config=/config/config.yaml -env=main -dryrun &amp;&amp;<br/>            /bin/sql-migrate status -config=/config/config.yaml -env=main<br/>...</span></pre><p id="1a9f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行，并检查其日志:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="8096" class="mo lr iq la b gy nn no l np nq">$ kk -n eks-dev-1-appname-test-migrations-ns logs job/migration-job<br/>Cloning into ‘backend-services’…<br/>total 20<br/>-rw-r — r — 1 root root 538 Oct 24 14:02 BS_1_init_schema.up.sql<br/>-rw-r — r — 1 root root 180 Oct 24 14:02 BS_2_add_brand_field.up.sql<br/>-rw-r — r — 1 root root 225 Oct 24 14:02 BS_3_alter_table.up.sql<br/>-rw-r — r — 1 root root 194 Oct 24 14:02 BS_4_add_created_at_field.sql<br/>-rw-r — r — 1 root root 272 Oct 24 14:02 BS_5_alter_table_nourishment_diet.up.sql<br/>main:<br/>dialect: mysql<br/>datasource: backnd-user:${DB_PASSWORD}@tcp(stage.backend-db3-master.example.com:3306)/dbname?parseTime=true<br/>dir: backend-services/db/migrations<br/>table: backend_services_migrations<br/>+ — — — — — — — — — — — — — — — — — — — — — + — — — — — — — — — — — — — — — -+<br/>| MIGRATION | APPLIED |<br/>+ — — — — — — — — — — — — — — — — — — — — — + — — — — — — — — — — — — — — — -+<br/>| BS_1_init_schema.up.sql | 2020–05–07 12:21:25 +0000 UTC |<br/>| BS_2_add_brand_field.up.sql | 2020–05–12 14:31:17 +0000 UTC |<br/>| BS_3_alter_table.up.sql | 2020–05–13 06:17:25 +0000 UTC |<br/>| BS_4_add_created_at_field.sql | 2020–07–21 09:55:49 +0000 UTC |<br/>| BS_5_alter_table_nourishment_diet.up.sql | 2020–07–21 09:55:49 +0000 UTC |<br/>+ — — — — — — — — — — — — — — — — — — — — — + — — — — — — — — — — — — — — — -+</span></pre><p id="6250" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在可以去舵轮图了。</p><h1 id="81aa" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">舵模板</h1><p id="a12c" class="pw-post-body-paragraph jy jz iq ka b kb na kd ke kf nb kh ki kj nc kl km kn nd kp kq kr ne kt ku kv ij bi translated">在旧图表中我们需要做什么？</p><ol class=""><li id="f574" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv lg lh li lj bi translated">拆下<code class="fe kx ky kz la b">initContainers</code></li><li id="b0c4" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated">消除旧的秘密</li><li id="3947" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated">在<code class="fe kx ky kz la b">values.yaml</code>中移动新变量的值</li><li id="dcfa" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated">将令牌和数据库的密码移入<code class="fe kx ky kz la b">secrets.yaml</code></li></ol><p id="bd9b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里的主要部分是添加注释，以在Helm部署期间触发迁移过程</p><p id="62da" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将<code class="fe kx ky kz la b">annotations</code>添加到工作中:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="f4ef" class="mo lr iq la b gy nn no l np nq">apiVersion: batch/v1<br/>kind: Job<br/>metadata:<br/>  name: {{ .Chart.Name }}-migration-job<br/>  labels:<br/>  annotations:<br/>    "helm.sh/hook": pre-install,pre-upgrade<br/>    "helm.sh/hook-weight": "-1"<br/>    "helm.sh/hook-delete-policy": before-hook-creation<br/>spec: <br/>  backoffLimit: 0<br/>...</span></pre><p id="908f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里:</p><ul class=""><li id="be39" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv nr lh li lj bi translated"><code class="fe kx ky kz la b">"helm.sh/hook": pre-install,pre-upgrade</code>:在<code class="fe kx ky kz la b">helm install</code>或<code class="fe kx ky kz la b">upgrade</code>之前运行作业(在我们的Jenkins管道中，从<code class="fe kx ky kz la b">helm secrets upgrade --install</code>开始)</li><li id="8c2b" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv nr lh li lj bi translated"><code class="fe kx ky kz la b">"helm.sh/hook-weight": "-1"</code>:创建资源的优先级，因为首先我们需要创建我们的作业将使用的<code class="fe kx ky kz la b">ConfigMap</code>和<code class="fe kx ky kz la b">Secret</code>，所以将它们的权重设置为小于作业的权重</li><li id="61b9" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv nr lh li lj bi translated"><code class="fe kx ky kz la b">"helm.sh/hook-delete-policy"</code>:默认值为<em class="lp">创建钩子前的</em>(查看<a class="ae kw" href="https://helm.sh/docs/topics/charts_hooks/" rel="noopener ugc nofollow" target="_blank">文档</a>)，设置为if用于测试，然后可以更改为<em class="lp">钩子成功</em>(但是如果迁移失败，您将无法查看日志)</li></ul><p id="16b2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将<code class="fe kx ky kz la b">annotations</code>块添加到配置图中，并在作业中使用小于<code class="fe kx ky kz la b">hook-weight</code>的密码。</p><p id="99af" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kx ky kz la b">ConfigMap</code>清单现在全部内容:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="4e50" class="mo lr iq la b gy nn no l np nq">---<br/>apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: migration-config<br/>  annotations:<br/>    "helm.sh/hook": pre-install,pre-upgrade<br/>    "helm.sh/hook-weight": "-5"<br/>    "helm.sh/hook-delete-policy": before-hook-creation<br/>data:         <br/>  config.yaml: |<br/>    main:<br/>      dialect: {{ .Values.backendConfig.db.driver }}<br/>      datasource: {{ .Values.backendConfig.db.user }}:${DB_PASSWORD}@tcp({{ .Values.backendConfig.db.host }}:{{ .Values.backendConfig.db.port }})/{{ .Values.backendConfig.db.database }}?parseTime=true<br/>      dir: backend-services/db/migrations<br/>      table: {{ .Values.backendConfig.db.migrationsTable }}</span></pre><p id="2f98" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kx ky kz la b">Secret</code>一:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="ff77" class="mo lr iq la b gy nn no l np nq">---     <br/>apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  name: {{ .Chart.Name }}-migration-secrets<br/>  annotations: <br/>    "helm.sh/hook": pre-install,pre-upgrade<br/>    "helm.sh/hook-weight": "-10"<br/>    "helm.sh/hook-delete-policy": before-hook-creation<br/>type: Opaque<br/>stringData:<br/>  backend-db-password: {{ .Values.backendConfig.db.password }}<br/>  git_token: {{ .Values.git.token }}</span></pre><p id="dc42" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">而<code class="fe kx ky kz la b">Job</code>:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="cf30" class="mo lr iq la b gy nn no l np nq">apiVersion: batch/v1<br/>kind: Job<br/>metadata:<br/>  name: {{ .Chart.Name }}-migration-job<br/>  labels:<br/>  annotations:<br/>    "helm.sh/hook": pre-install,pre-upgrade<br/>    "helm.sh/hook-weight": "-1"<br/>    "helm.sh/hook-delete-policy": before-hook-creation<br/>spec:<br/>  backoffLimit: 0<br/>  template:<br/>    metadata:<br/>      name: {{ .Chart.Name }}-migration-job-pod<br/>    spec:<br/>      restartPolicy: Never<br/>      containers:<br/>      - name: {{ .Chart.Name }}-db-migrations<br/>        image: projectname/sql-migrate-git:latest<br/>        command: ["/bin/sh", "-c"]<br/>        args: <br/>          - git clone --single-branch --branch {{ .Values.git.branch }} <a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/{{">https://{{</a> .Values.git.user }}:$GIT_TOKEN@{{ .Values.git.repo }} &amp;&amp;<br/>            ls -l backend-services/db/migrations &amp;&amp;<br/>            cat /config/config.yaml &amp;&amp;<br/>            /bin/sql-migrate up -config=/config/config.yaml -env=main || exit 1;<br/>            /bin/sql-migrate status -config=/config/config.yaml -env=main<br/>        env:<br/>        - name: GIT_TOKEN<br/>          valueFrom:<br/>            secretKeyRef:<br/>              name: {{ .Chart.Name }}-migration-secrets<br/>              key: git_token<br/>        - name: DB_PASSWORD<br/>          valueFrom:<br/>            secretKeyRef:<br/>              name: {{ .Chart.Name }}-migration-secrets<br/>              key: backend-db-password<br/>        volumeMounts:<br/>        - name: migration-config<br/>          mountPath: "/config/config.yaml"<br/>          subPath: "config.yaml"<br/>          readOnly: true<br/>      volumes:<br/>        - name: migration-config<br/>          configMap: <br/>            name: migration-config<br/>            items:<br/>            - key: "config.yaml"<br/>              path: "config.yaml"</span></pre><p id="3939" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这里，我将<code class="fe kx ky kz la b">exit 1</code>添加到了<code class="fe kx ky kz la b">/bin/sql-migrate up</code>中，这样，如果在迁移过程中出现错误，作业将<em class="lp">失败</em>，从而不会启动部署过程。</p><p id="b120" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在詹金斯运行它:</p><figure class="nf ng nh ni gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/48ea1d8f3992c933939b78613bbc3f6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LOUKqS29KwkJM9aT.png"/></div></div></figure><figure class="nf ng nh ni gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/a6498e362a48d431484514d19c5f7d97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-OlwPIH80hYGb15K.png"/></div></div></figure><p id="f466" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<em class="lp">钩子</em>中，我们可以看到，首先创建了具有<code class="fe kx ky kz la b">hook-weight": "-10"</code>的秘密，然后是配置图，最后是作业。</p><p id="91c7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，部署流程如下所示:</p><figure class="nf ng nh ni gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/e227aaa2100a329cefad0826386eca90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WpUu8hLq1dJdAvZ3.png"/></div></div></figure><p id="3c98" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，秘密的ConfigMap и作业资源被移除(根据<code class="fe kx ky kz la b">"helm.sh/hook-delete-policy": before-hook-creation</code>)，然后被创建。</p><p id="4bee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查作业的状态:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="82d7" class="mo lr iq la b gy nn no l np nq">$ kk -n eks-stage-1-appname-api-ns get job<br/>NAME COMPLETIONS DURATION AGE<br/>appname-api-migration-job 1/1 3s 6m21s</span></pre><p id="144b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它的日志:</p><pre class="nf ng nh ni gt nj la nk nl aw nm bi"><span id="fd97" class="mo lr iq la b gy nn no l np nq">$ kk -n eks-stage-1-appname-api-ns logs job/appname-api-migration-job<br/>Cloning into ‘backend-services’…<br/>total 20<br/>-rw-r — r — 1 root root 538 Oct 26 11:32 BS_1_init_schema.up.sql<br/>-rw-r — r — 1 root root 180 Oct 26 11:32 BS_2_add_brand_field.up.sql<br/>-rw-r — r — 1 root root 225 Oct 26 11:32 BS_3_alter_table.up.sql<br/>-rw-r — r — 1 root root 194 Oct 26 11:32 BS_4_add_created_at_field.sql<br/>-rw-r — r — 1 root root 272 Oct 26 11:32 BS_5_alter_table_nourishment_diet.up.sql<br/>main:<br/>dialect: mysql<br/>datasource: backend-user:${DB_PASSWORD}@tcp(stage.backend-db3-master.example.com:3306)/dbname?parseTime=true<br/>dir: backend-services/db/migrations<br/>table: backend_services_migrations<br/>Applied 0 migrations<br/>+ — — — — — — — — — — — — — — — — — — — — — + — — — — — — — — — — — — — — — -+<br/>| MIGRATION | APPLIED |<br/>+ — — — — — — — — — — — — — — — — — — — — — + — — — — — — — — — — — — — — — -+<br/>| BS_1_init_schema.up.sql | 2020–05–07 12:21:25 +0000 UTC |<br/>| BS_2_add_brand_field.up.sql | 2020–05–12 14:31:17 +0000 UTC |<br/>| BS_3_alter_table.up.sql | 2020–05–13 06:17:25 +0000 UTC |<br/>| BS_4_add_created_at_field.sql | 2020–07–21 09:55:49 +0000 UTC |<br/>| BS_5_alter_table_nourishment_diet.up.sql | 2020–07–21 09:55:49 +0000 UTC |<br/>+ — — — — — — — — — — — — — — — — — — — — — + — — — — — — — — — — — — — — — -+</span></pre><p id="4e6d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="lp">应用了0个迁移</em> </strong>，因为在最后一个<code class="fe kx ky kz la b">APPLIED</code>之后迁移文件没有变化。</p><p id="d03c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成了。</p></div><div class="ab cl nv nw hu nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="ij ik il im in"><p id="2fe5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="lp">最初发布于</em> <a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-running-sql-migrations-with-kubernetes-job-and-helm-hook/" rel="noopener ugc nofollow" target="_blank"> <em class="lp"> RTFM: Linux、DevOps、系统管理</em> </a> <em class="lp">。</em></p></div></div>    
</body>
</html>