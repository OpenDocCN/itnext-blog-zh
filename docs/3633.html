<html>
<head>
<title>Migrating to Helm 3: What You Need to Know</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">迁移到头盔3:你需要知道什么</h1>
<blockquote>原文：<a href="https://itnext.io/additional-tips-for-migrating-to-helm-3-304c9d50f1b4?source=collection_archive---------4-----------------------#2020-01-21">https://itnext.io/additional-tips-for-migrating-to-helm-3-304c9d50f1b4?source=collection_archive---------4-----------------------#2020-01-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/2cd11273ff43c071de7a8fd5bbb914cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*l0nJssQk4YoxQI1S"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">马特·阿特兹在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="c11e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在Helm包管理器的最新和最好的主要版本已经稳定了，您可能想知道升级/迁移/移动需要花费多少精力。尽可能复杂的头盔，放心升级过程非常简单。<strong class="ki iu">官方Helm博客有一个优秀的迁移过程指南，</strong> <a class="ae kf" href="https://helm.sh/blog/migrate-from-helm-v2-to-helm-v3/" rel="noopener ugc nofollow" target="_blank"> <strong class="ki iu">可以在这里找到</strong> </a>。这篇文章非常简单明了，它给了你开始将各个版本单独移植到Helm 3所需要的一切。但是，如果您想一次全部迁移，该怎么办呢？在移除蒂勒之前，你如何确定没有东西还在使用它？</p><h1 id="3a35" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">下载Helm 3二进制文件</h1><p id="0c45" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我们想在测试最新版本的同时测试Helm 2，所以我们应该准备好两个版本的二进制文件，直到我们准备好拔掉v2的插头。在这里下载v3 <a class="ae kf" href="https://github.com/helm/helm/releases" rel="noopener ugc nofollow" target="_blank">的最新稳定版本，并将其添加到您的PATH中。我发现将现有的v2二进制文件重命名为<code class="fe mh mi mj mk b">helm2</code>并将最新版本重命名为<code class="fe mh mi mj mk b">helm3</code>更容易。我把两个版本都保存在<code class="fe mh mi mj mk b">/usr/local/bin</code>，这样我就可以在需要的时候在它们之间切换:</a></p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="0ca0" class="mt lf it mk b gy mu mv l mw mx">➜ helm2 version<br/>Client: &amp;version.Version{SemVer:"v2.16.0", GitCommit:"e13bc94621d4ef666270cfbe734aaabf342a49bb", GitTreeState:"clean"}<br/>Server: &amp;version.Version{SemVer:"v2.14.3", GitCommit:"0e7f3b6637f7af8fcfddb3d2941fcc7cbebb0085", GitTreeState:"clean"}</span><span id="6cb0" class="mt lf it mk b gy my mv l mw mx">➜ helm3 version<br/>version.BuildInfo{Version:"v3.0.1", GitCommit:"7c22ef9ce89e0ebeb7125ba2ebf7d421f3e82ffa", GitTreeState:"clean", GoVersion:"go1.13.4"}</span></pre><h1 id="2103" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">准备您的CI脚本和图表</h1><p id="fbb1" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">在运行升级过程之前，您必须确保您的配置项脚本和自定义图表与Helm 3兼容。我写了一篇博客，<a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/breaking-changes-in-helm-3-and-how-to-fix-them-39fea23e06ff">涵盖了一些需要注意的事情，其中大部分都可以轻松解决。OpenAPI验证机制非常酷，但是它可能会让您措手不及:</a></p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="d375" class="mt lf it mk b gy mu mv l mw mx">➜ helm install prometheus .<br/>Error: unable to build kubernetes objects from release manifest: error validating "": error validating data: ValidationError(Deployment.spec.template.spec.containers[0].volumeMounts[0]): unknown field "defaultMode" in io.k8s.api.core.v1.VolumeMount</span></pre><p id="0f33" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦所有这些初期问题都解决了，你就可以开始迁移到头盔3了！</p><h1 id="d0e2" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">迁移舵配置</h1><p id="1ab6" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我之前提到的Helm博客文章中的这个步骤会更新你所有的本地配置，这样它就可以被Helm 3使用了。如果您从一个CI系统(如Jenkins、TeamCity或TravisCI)中的构建代理运行Helm，那么您可以跳过这一步。如果你从本地机器或者一个有持久文件系统的中央服务器上运行Helm，一定要把你的配置转移过来，特别是如果你有自己的Helm repos或者使用定制插件的话。不管怎样，确保你通读了这篇文章，以确定它是否与你相关。</p><h1 id="aa08" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">迁移释放物—带分蘖</h1><p id="2e91" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">现在，这里有几种方法。你可以将特定的版本移植到Helm 3来做一些测试，这在博客文章<a class="ae kf" href="https://helm.sh/blog/migrate-from-helm-v2-to-helm-v3/#migrate-helm-v2-releases" rel="noopener ugc nofollow" target="_blank">这里</a>中有所涉及。您还可以选择迁移发布版本，并从Tiller中一次性删除它们。就我个人而言，我发现在一个给定的环境中一次性迁移我们所有的版本更容易，但是<em class="mz">将发布数据留在Tiller </em>中，直到我完全确定Helm v2没有在我们的环境中使用。这样，就没有盲点，一切都使用相同版本的Helm。这里有一个快速的方法:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="9304" class="mt lf it mk b gy mu mv l mw mx"># List Helm 2 Releases<br/># omit --tls flag if you're not using TLS<br/>RELEASES=$(helm list --tls -aq)</span><span id="e000" class="mt lf it mk b gy my mv l mw mx"># Loop through releases and, for each one, test conversion<br/>while IFS= read -r release; do<br/>  helm3 2to3 convert $release --dry-run<br/>done &lt;&lt;&lt; "$RELEASES"</span></pre><p id="7d6a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦你对它的外观感到满意，移除<code class="fe mh mi mj mk b">--dry-run</code>标志，观察<code class="fe mh mi mj mk b">2to3</code>插件的神奇之处。</p><p id="ce87" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">注意:</strong>正如我提到的，有一个<code class="fe mh mi mj mk b">--delete-v2-releases </code>标志，它将迁移释放<em class="mz">并从Tiller中删除它。如果你确定你不再需要这些信息，那就自担风险吧。</em></p><h1 id="a215" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">在你移除分蘖之前…</h1><p id="9cd5" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">这是我不想仓促进行的一步，以防我们需要回到掌舵2。在这一点上，只要你的CI系统和团队成员都在使用Helm 3，就没有理由保留Tiller。但是如果你想<em class="mz">绝对确定</em>没有任何东西还在使用旧版本，我建议让Tiller呆几个小时，观察<code class="fe mh mi mj mk b">helm ls</code>的输出，看看<code class="fe mh mi mj mk b">UPDATED</code>栏中的时间戳是否有任何变化。如果是的话，你知道有东西/有人没有使用头盔3。</p><p id="0add" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果版本在迁移到Helm 3后被Helm 2修改，您必须删除保存版本信息的Helm 3 Kubernetes secret，以便在不删除相关资源的情况下将其从Helm 3中清除:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="e40e" class="mt lf it mk b gy mu mv l mw mx">➜ kubectl get secret -n dev<br/>NAMESPACE                NAME                                                 TYPE                                  DATA   AGE                           dev          sh.helm.release.v1.postgres.v1                 helm.sh/release.v1                    1      36d<br/>➜ kubectl delete secret -n dev sh.helm.release.v1.postgres.v1<br/>secret "secret "sh.helm.release.v1.postgres.v1" deleted</span></pre><p id="98c3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，如果我们用Helm 3列出<code class="fe mh mi mj mk b">dev</code>名称空间中的版本，我们将看到该版本不再存在:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="9cb5" class="mt lf it mk b gy mu mv l mw mx">NAME           NAMESPACE      REVISION UPDATED                                 STATUS   CHART                APP VERSION</span></pre><p id="5df2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，我们可以再次执行迁移过程，一旦我们找出谁或什么仍然在使用Helm 2。一旦解决了这个问题，使用<code class="fe mh mi mj mk b">helm3 2to3 convert</code>进行迁移就大功告成了。</p><p id="dbc0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦您完全确定已经准备好删除Tiller及其相关的rbac角色和数据，只需运行<code class="fe mh mi mj mk b">helm 2to3 cleanup</code>。</p><h1 id="8f22" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">迁移释放——无舵舵舵</h1><p id="28e1" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">只需在我上面提供的脚本中添加<code class="fe mh mi mj mk b">--tiller-out-cluster</code>标志，<code class="fe mh mi mj mk b">2to3</code>插件就会从您的本地Tiller实例中删除发布信息！</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="e161" class="mt lf it mk b gy mu mv l mw mx"># List Helm 2 Releases<br/># omit --tls flag if you're not using TLS<br/>RELEASES=$(helm list --tls -aq)</span><span id="4ffb" class="mt lf it mk b gy my mv l mw mx"># Loop through releases and, for each one, test conversion<br/>while IFS= read -r release; do<br/>  helm3 2to3 convert $release --tiller-out-cluster<br/>done &lt;&lt;&lt; "$RELEASES"</span></pre></div></div>    
</body>
</html>