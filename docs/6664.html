<html>
<head>
<title>Building Multi-CPU Architecture Docker Images for ARM and x86 (2): Building in GitLab CI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为ARM和x86构建多CPU架构Docker映像(2):在GitLab CI中构建</h1>
<blockquote>原文：<a href="https://itnext.io/building-multi-cpu-architecture-docker-images-for-arm-and-x86-2-building-in-gitlab-ci-295966b7185d?source=collection_archive---------2-----------------------#2022-01-21">https://itnext.io/building-multi-cpu-architecture-docker-images-for-arm-and-x86-2-building-in-gitlab-ci-295966b7185d?source=collection_archive---------2-----------------------#2022-01-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/4697cad62920dc61a04ac7f02a058a4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4F8NGHbx8jO7P0x4"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@pankajpatel?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Pankaj Patel </a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="492b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在“<a class="ae kc" href="https://medium.com/p/2fa97869a99b" rel="noopener">为ARM和x86构建多CPU架构Docker映像(1):基础知识</a>”中，我们介绍了使用buildx/buildkit构建多拱Docker映像的一般工作流程。然而，要让它在Gitlab CI上运行，您将需要一些额外的设置。</p><h1 id="7a83" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">在GitLab CI/CD作业中启用Docker命令</h1><p id="4c62" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">在GitLab CI/CD作业中启用Docker命令有三个选项:</p><ul class=""><li id="c925" class="me mf iq kf b kg kh kk kl ko mg ks mh kw mi la mj mk ml mm bi translated"><a class="ae kc" href="https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#use-the-shell-executor" rel="noopener ugc nofollow" target="_blank">外壳执行程序</a></li><li id="c491" class="me mf iq kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated"><a class="ae kc" href="https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#use-docker-socket-binding" rel="noopener ugc nofollow" target="_blank"> Docker插座装订</a></li><li id="2650" class="me mf iq kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated"><a class="ae kc" href="https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#use-the-kubernetes-executor-with-docker-in-docker" rel="noopener ugc nofollow" target="_blank">具有Docker图像的Docker执行器(Docker-in-Docker) </a>:需要<a class="ae kc" href="https://docs.gitlab.com/runner/executors/docker.html" rel="noopener ugc nofollow" target="_blank"> Docker执行器</a>或<a class="ae kc" href="https://docs.gitlab.com/runner/executors/kubernetes.html" rel="noopener ugc nofollow" target="_blank"> Kubernetes执行器</a></li></ul><p id="98a8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将只讨论k8s (Kubernetes) executor的<code class="fe ms mt mu mv b">dind</code> (Docker-in-Docker)选项，用于设置多拱建筑管道。</p><h1 id="2d5a" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">部署Kubernetes Executor Gitlab Runner</h1><p id="a1fe" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">要部署Kubernetes executor Gitlab Runner，您可以使用<a class="ae kc" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank"> Helm </a>将Helm Chart部署到您的k8s集群中。</p><p id="5367" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，我们可以为我们的部署创建配置值文件(` config.yaml `):</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="dbb2" class="ne lc iq mv b gy nf ng l nh ni">gitlabUrl: "https://gitlab.com/"<br/>runnerRegistrationToken: "xxxxxx"<br/>concurrent: 1<br/>runners:<br/>  tags: "k8s-runners"<br/>  privileged: true<br/>  config: |<br/>    [[runners]]<br/>      [runners.kubernetes]<br/>        image = "ubuntu:20.04"<br/>        privileged = true<br/>      [[runners.kubernetes.volumes.empty_dir]]<br/>        name = "docker-certs"<br/>        mount_path = "/certs/client"<br/>        medium = "Memory"<br/>      [runners.cache]<br/>        Type = "gcs"<br/>        Path = "gitlab_runner"<br/>        Shared = false<br/>        [runners.cache.gcs]<br/>          AccessID = "xxx@xxxx.com"<br/>          PrivateKey = "xxxxxxx"<br/>          BucketName = "xxxxxx"</span></pre><p id="e87f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里，您需要用自己的注册令牌替换“runnerRegistrationToken”。该设置假设使用GCS (google云存储)作为缓存存储。如果您使用AWS s3，您可以将<code class="fe ms mt mu mv b">[runners.cache]</code>部分替换为:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="3faf" class="ne lc iq mv b gy nf ng l nh ni">      [runners.cache]<br/>        Type = "s3"<br/>        Path = "runner"<br/>        Shared = false<br/>        [runners.cache.s3]<br/>          ServerAddress = "s3.amazonaws.com"<br/>          BucketName = "xxxxxx"<br/>          BucketLocation = "eu-west-1"<br/>          Insecure = false<br/>          AuthenticationType = "access-key"<br/>          AccessKey = "xxxx"<br/>          SecretKey = "xxxxx"</span></pre><p id="8e52" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">其次，添加Gitlab Runner Helm Chart repo(如果你还没有):</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="c627" class="ne lc iq mv b gy nf ng l nh ni">helm repo add gitlab https://charts.gitlab.io</span></pre><p id="6fa4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用我们创建的<code class="fe ms mt mu mv b">config.yaml</code>配置文件部署Gitlab Runner:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="16e0" class="ne lc iq mv b gy nf ng l nh ni">helm install --namespace &lt;NAMESPACE&gt; gitlab-runner -f config.yaml gitlab/gitlab-runner</span></pre><p id="1381" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里，<code class="fe ms mt mu mv b">&lt;NAMESPACE&gt;</code>是要安装GitLab Runner的Kubernetes名称空间。</p><h1 id="53df" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">将环境变量添加到<code class="fe ms mt mu mv b">.gitlab-ci.yml</code></h1><p id="3f75" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">部署Kubernetes executor Gitlab Runner后，我们还需要将以下ENV变量添加到Gitlab CI/CD配置文件<code class="fe ms mt mu mv b">.gitlab-ci.yml</code>:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="6b65" class="ne lc iq mv b gy nf ng l nh ni">variables:<br/>  DOCKER_HOST: tcp://docker:2376<br/>  DOCKER_TLS_CERTDIR: "/certs"<br/>  DOCKER_TLS_VERIFY: 1<br/>  DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"</span></pre><h1 id="eb79" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">带有' buildx` Pluigin的Docker图像</h1><p id="a13c" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">要在CI中运行<code class="fe ms mt mu mv b">docker buildx build</code>命令，您需要一个包含docker命令&amp; `buildx `插件的docker映像。我们已经在“<a class="ae kc" href="https://medium.com/p/2fa97869a99b" rel="noopener">为ARM和x86构建多CPU架构docker映像(1):基础知识</a>”中介绍了如何创建这样的Docker映像。</p><p id="356f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您也可以使用我发布的预建docker图像:<code class="fe ms mt mu mv b"><a class="ae kc" href="https://hub.docker.com/r/data61/magda-builder-docker/tags" rel="noopener ugc nofollow" target="_blank">data61/magda-builder-docker:latest</a></code>。</p><h1 id="0501" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">构建多拱Docker图像和推送至Gitlab Docker注册表</h1><p id="46f6" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">在运行<code class="fe ms mt mu mv b">docker buildx build</code>之前，我们需要用以下命令创建一个“构建器实例”:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="311a" class="ne lc iq mv b gy nf ng l nh ni"># Create a new docker context for builder instance to use<br/>docker context create builder-context</span><span id="be4d" class="ne lc iq mv b gy nj ng l nh ni"># Create a builder instance named "builderx"<br/>docker buildx create --name builderx --driver docker-container --use builder-context</span></pre><p id="17c5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">以下是构建多拱Docker图像并推送到Gitlab Docker注册表的完整示例:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="47c1" class="ne lc iq mv b gy nf ng l nh ni"># All env vars are auto-provided by GitLab CI at runtime<br/>docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY</span><span id="a76c" class="ne lc iq mv b gy nj ng l nh ni"># Create a new docker context for builder instance to use<br/>docker context create builder-context</span><span id="8639" class="ne lc iq mv b gy nj ng l nh ni"># Create a builder instance named "builderx"<br/>docker buildx create --name builderx --driver docker-container --use builder-context</span><span id="e861" class="ne lc iq mv b gy nj ng l nh ni">docker buildx build -t $CI_REGISTRY/xx/myimage:$CI_COMMIT_REF_SLUG -f [path to Dockerfile] --push --platform=linux/arm64,linux/amd64 [path to build context]</span></pre><h1 id="b52f" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">将多拱图像重新标记和复制到Docker Hub</h1><p id="56ba" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">在CI管道中，我们经常将docker映像推送到CI平台提供的注册表中进行测试和验证。但是，最终，我们会希望将Gitlab注册表中的多拱Docker图像重新标记和复制到生产注册表中。例如码头中心。</p><p id="df12" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于多拱图像，我们不能使用旧的工作流程来使用<code class="fe ms mt mu mv b">docker tag</code> &amp; <code class="fe ms mt mu mv b">docker push</code>命令重新标记和推送docker图像到不同的注册表，因为它们只处理一个图像，而不是一个清单注册表条目后的多个图像。</p><p id="5815" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要解决这个问题，我们可以使用<code class="fe ms mt mu mv b"><a class="ae kc" href="https://github.com/regclient/regclient" rel="noopener ugc nofollow" target="_blank">regclient</a></code>。它的命令语法非常简单。为了重新标记&amp;复制我们在前面的例子中构建的&amp;推送到Gitlab注册表的图像，并推送到Docker hub，我们可以运行:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="72f2" class="ne lc iq mv b gy nf ng l nh ni"># Login to gitlab registry<br/>docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY</span><span id="b3f7" class="ne lc iq mv b gy nj ng l nh ni"># Login to docker hub<br/>docker login -u my-dockerhub-username -p $DOCKER_HUB_PASSWORD</span><span id="249d" class="ne lc iq mv b gy nj ng l nh ni">regctl image copy $CI_REGISTRY/xx/myimage:$CI_COMMIT_REF_SLUG docker.io/xx/myimage:v1</span></pre><p id="396c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请注意:我发布的预构建docker映像:<code class="fe ms mt mu mv b"><a class="ae kc" href="https://hub.docker.com/r/data61/magda-builder-docker/tags" rel="noopener ugc nofollow" target="_blank">data61/magda-builder-docker:latest</a></code>已经包含了<code class="fe ms mt mu mv b">regclient</code>实用程序。如果您使用自己预先构建的docker映像，您将需要手动安装它。</p><h1 id="3791" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">然后</h1><p id="6e82" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated"><a class="ae kc" href="https://medium.com/p/a382feab5af9" rel="noopener">为ARM和x86构建多CPU架构Docker映像(3):在GitHub Action CI中构建</a></p></div></div>    
</body>
</html>