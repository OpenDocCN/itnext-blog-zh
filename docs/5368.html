<html>
<head>
<title>How To Setup A Private Image Registry On K3s</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在K3s上设置私人图像注册表</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-setup-a-private-registry-on-k3s-d9283906d16?source=collection_archive---------0-----------------------#2021-02-19">https://itnext.io/how-to-setup-a-private-registry-on-k3s-d9283906d16?source=collection_archive---------0-----------------------#2021-02-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/18a3e7c3ec4a7c74509943e1004def6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3f-dqfFNSocu4qIP"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">由<a class="ae kf" href="https://unsplash.com/@qwitka?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">马克西姆·卡哈里茨基</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="d036" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将自己的容器映像推送到公共注册中心并不总是合适的。这篇文章展示了一种在K3s Kubernetes集群中创建私有映像注册表的快速方法。</p><p id="a1d8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请注意，对于以下清单，当从群集中删除注册表资源时，所有映像也将被删除。清单的最后一行有一个TODO来解决这个问题。</p><p id="9fc0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">同样需要注意的是:注册表是不安全的。必须采取进一步的措施来保护它，如用户名/密码或证书，这不是本教程的范围。</p><h2 id="55c0" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">库伯内特资源公司</h2><p id="a64e" class="pw-post-body-paragraph kg kh it ki b kj lx kl km kn ly kp kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">在应用这个清单之前，<code class="fe mc md me mf b">spec:rules:host</code>下的域名需要相应地更改。</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="df20" class="le lf it mf b gy mo mp l mq mr">---<br/>apiVersion: networking.k8s.io/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: docker-registry-ingress<br/>  annotations:<br/>    kubernetes.io/ingress.class: "traefik"<br/>spec:<br/>  rules:<br/>  - host: registry.domain.de<br/>    http:<br/>      paths:<br/>      - path: /<br/>        backend:<br/>          serviceName: docker-registry-service<br/>          servicePort: 5000<br/><br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: docker-registry-service<br/>  labels:<br/>    run: docker-registry<br/>spec:<br/>  selector:<br/>    app: docker-registry<br/>  ports:<br/>    - protocol: TCP<br/>      port: 5000<br/><br/>---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: docker-registry<br/>  labels:<br/>    app: docker-registry<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: docker-registry<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: docker-registry<br/>    spec:<br/>      containers:<br/>      - name: docker-registry<br/>        image: registry<br/>        ports:<br/>        - containerPort: 5000<br/>          protocol: TCP<br/>        volumeMounts:<br/>        - name: storage<br/>          mountPath: /var/lib/registry<br/>        env:<br/>        - name: REGISTRY_HTTP_ADDR<br/>          value: :5000<br/>        - name: REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY<br/>          value: /var/lib/registry<br/>      volumes:<br/>      - name: storage<br/>        emptyDir: {} # TODO -make this more permanent later</span></pre><p id="20d5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">清单应用于:</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="cefa" class="le lf it mf b gy mo mp l mq mr">kubectl apply -f registry.yaml</span></pre><h2 id="0ff0" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">设置</h2><p id="7f30" class="pw-post-body-paragraph kg kh it ki b kj lx kl km kn ly kp kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">在K3s节点上，需要用以下内容创建文件<code class="fe mc md me mf b">/etc/rancher/k3s/registries.yaml</code>。域名需要与上述清单中的域名相匹配。</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="d255" class="le lf it mf b gy mo mp l mq mr">mirrors:<br/>  "registry.domain.de":<br/>    endpoint:<br/>      - "http://registry.domain.de"</span></pre><p id="1d7d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我在服务器和代理节点上这样做了。我不确定是否真的要在代理人身上做，我已经做了。</p><p id="2350" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">之后，需要重新启动服务器和代理。</p><p id="7ad2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在服务器上执行:</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="7964" class="le lf it mf b gy mo mp l mq mr">systemctl restart k3s</span></pre><p id="4b60" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在代理节点上:</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="128a" class="le lf it mf b gy mo mp l mq mr">systemctl restart k3s-agent</span></pre><p id="51bf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果应用的更改可以通过以下方式检查:</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="2f62" class="le lf it mf b gy mo mp l mq mr">crictl info</span></pre><p id="5336" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有一个叫做<code class="fe mc md me mf b">registry</code>的部分应该会列出新创建的私有注册表。</p><p id="2119" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">本地工作站也需要知道新的注册表。我用Docker桌面在macOS上工作。在“首选项-&gt; Docker引擎”下，必须使用以下条目扩展设置:</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="af9e" class="le lf it mf b gy mo mp l mq mr">{<br/>  ...<br/>  <br/>  "insecure-registries": [<br/>    "registry.domain.de"<br/>  ]<br/>}</span></pre><h2 id="957d" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">测试注册表</h2><p id="2c6d" class="pw-post-body-paragraph kg kh it ki b kj lx kl km kn ly kp kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">为了测试一个图像是否可以被推送到新的注册表，我用一个定制的HTML文件构建了一个仅包含Nginx的小图像:</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="4920" class="le lf it mf b gy mo mp l mq mr">&lt;html&gt;<br/>&lt;head&gt;&lt;title&gt;Hello World!&lt;/title&gt;<br/>  &lt;style&gt;<br/>    html {<br/>      font-size: 500.0%;<br/>    }<br/>    div {<br/>      text-align: center;<br/>    }<br/>  &lt;/style&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>  &lt;div&gt;Hello World!&lt;/div&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="1273" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">新图像的docker文件:</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="50c0" class="le lf it mf b gy mo mp l mq mr">FROM nginx:alpine<br/>COPY index.html /usr/share/nginx/html</span></pre><p id="dc24" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据您的注册域构建并标记新映像:</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="3ad0" class="le lf it mf b gy mo mp l mq mr">docker build -t registry.domain.de/hello:latest .</span></pre><p id="1f6d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后图像可以被推送。</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="cf6a" class="le lf it mf b gy mo mp l mq mr">docker push registry.domain.de/hello:latest</span></pre><p id="80b3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">希望这没有任何问题。</p><p id="be99" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于另一个测试，也可以从本地工作站删除映像，然后再从私有注册表中取出。</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="63e9" class="le lf it mf b gy mo mp l mq mr">docker rmi registry.domain.de/hello:latest<br/>docker pull registry.domain.de/hello:latest</span></pre><p id="ebc6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你喜欢这篇文章，请随时给我买杯咖啡！ </p><h2 id="ddef" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">资源</h2><ul class=""><li id="9459" class="ms mt it ki b kj lx kn ly kr mu kv mv kz mw ld mx my mz na bi translated"><a class="ae kf" href="https://llimon.github.io/post/k3s-registry/" rel="noopener ugc nofollow" target="_blank"> Kubernetes (K3s) —添加私有的不安全注册表</a></li><li id="ac4c" class="ms mt it ki b kj nb kn nc kr nd kv ne kz nf ld mx my mz na bi translated"><a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/setup-a-private-registry-on-k3s-f30404f8e4d3">在K3s上设置私有注册表</a></li><li id="a5c7" class="ms mt it ki b kj nb kn nc kr nd kv ne kz nf ld mx my mz na bi translated"><a class="ae kf" href="https://carpie.net/articles/installing-docker-registry-on-k3s" rel="noopener ugc nofollow" target="_blank">在k3s上安装docker注册表</a></li></ul></div></div>    
</body>
</html>