<html>
<head>
<title>Transfer terabytes of data between AWS s3 buckets cross-account, cross-region and cross-vpc</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS s3存储桶之间跨客户、跨地区和跨vpc传输数TB的数据</h1>
<blockquote>原文：<a href="https://itnext.io/transfer-terabytes-of-data-between-aws-s3-buckets-cross-account-cross-region-and-cross-vpc-ccdbec15e53?source=collection_archive---------0-----------------------#2022-08-24">https://itnext.io/transfer-terabytes-of-data-between-aws-s3-buckets-cross-account-cross-region-and-cross-vpc-ccdbec15e53?source=collection_archive---------0-----------------------#2022-08-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="a02b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在将我们的基础设施迁移到Kubernetes时，我们有多个s3存储桶要从我们的旧基础设施迁移到新基础设施。</p><p id="5103" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个博客的目的是向你展示我们对最终实现的解决方案所做的不同实验。如果您对Kubernetes如何帮助我们完成这项工作感兴趣，您可以直接阅读“处理更大的水桶”</p><h1 id="00b4" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">背景:</h1><p id="8479" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">为了理解任务的复杂性，我画了下面的架构图:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi lo"><img src="../Images/fcec7170961f8be868a88086a48124bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*croukRrY_ZIg_pq4h23DXA.png"/></div></div></figure><p id="d23a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如图所示，我们在帐户A中有3个存储桶(bucket-A-*)，位于虚拟私有云A中，托管在爱尔兰地区(EU-西1)。相反，我们在虚拟私有云B的账户B中有3个空桶(bucket-B-*)，托管在巴黎地区(EU-西-3) <strong class="jp ir">。</strong></p><p id="7595" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">目标是将桶A中的所有数据转移到桶b中。</strong></p><p id="6cad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在此次迁移中面临的多重挑战:</p><ul class=""><li id="840a" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mf mg mh mi bi translated">两个存储桶都受到存储桶策略的保护</li><li id="7a79" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">桶A包含大量的小文件</li><li id="1683" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">要传输的总数据量是10到</li><li id="fcd9" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">不同的账户、不同的vpc和不同的地区使得操作变得复杂</li><li id="39ed" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">目的桶是<strong class="jp ir">加密的</strong></li></ul><p id="ea41" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">为了简化文章操作，我们将对每个帐户只使用一个bucket:bucket-A和bucket-B。如果您处理多个bucket，您会发现一些工业化流程的技巧。</strong></p><h1 id="b895" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">先决条件</h1><blockquote class="mo mp mq"><p id="634f" class="jn jo mr jp b jq jr js jt ju jv jw jx ms jz ka kb mt kd ke kf mu kh ki kj kk ij bi translated">我们将假设桶目的地(桶-b)被创建并且是空的</p></blockquote><p id="ae03" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">请求权限准备操作:</strong></p><p id="6020" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要创建s3cross-account用户帐户并相应地添加适当的权限，您首先需要一个admin帐户来管理它。</p><p id="3f71" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">如果您拥有帐户A和b的管理员权限，您可以跳过这一部分。</strong></p><figure class="lp lq lr ls gt lt"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="2ec4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您不能访问管理员帐户，您至少可以请求帐户A和B的管理员访问:</p><ul class=""><li id="537e" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mf mg mh mi bi translated">完全访问存储桶-A</li><li id="01f5" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">完全访问桶-B</li><li id="9d06" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">在帐户B中创建IAM用户的权限</li></ul><h2 id="8dc6" class="mx km iq bd kn my mz dn kr na nb dp kv jy nc nd kz kc ne nf ld kg ng nh lh ni bi translated">创建S3跨帐户IAM用户:</h2><p id="06bb" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">第一步是创建用户并设置所需的权限，以确保存储桶之间的转移。该用户帐户将在存储桶A上以只读方式访问，在存储桶b上以读写方式访问。</p><p id="f3ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用户帐户需要在帐户b中创建。<strong class="jp ir">我们假设您知道如何在AWS控制台上创建IAM用户帐户。</strong></p><p id="bea9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于我们的存储桶受存储桶策略和IAM用户策略的保护，授予S3-交叉帐户的权限将分为两部分:</p><ol class=""><li id="218a" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk nj mg mh mi bi translated"><strong class="jp ir">从用户角度授予对两个存储桶的访问权限</strong>将保证帐户可以访问存储桶(下图中的黑色箭头)</li><li id="7eed" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk nj mg mh mi bi translated"><strong class="jp ir">从存储桶策略</strong>授予对两个存储桶的访问权限将允许存储桶授权帐户进行更改。(下图中绿色的存储桶策略)</li></ol><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi nk"><img src="../Images/82debda329dda1442cc1379e6a6f37a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DdTLra3jJxRR5RmEYizNpA.png"/></div></div></figure><h2 id="1dcb" class="mx km iq bd kn my mz dn kr na nb dp kv jy nc nd kz kc ne nf ld kg ng nh lh ni bi translated">创建S3-跨帐户用户的策略:</h2><p id="62c8" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">在S3-交叉帐户用户的策略上，创建两个内联策略:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi nl"><img src="../Images/340dd1cad52f6aee7ad188b27234235e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SRdZN6YTke9DFj4mW_27lg.png"/></div></div></figure><figure class="lp lq lr ls gt lt"><div class="bz fp l di"><div class="mv mw l"/></div></figure><blockquote class="mo mp mq"><p id="73ef" class="jn jo mr jp b jq jr js jt ju jv jw jx ms jz ka kb mt kd ke kf mu kh ki kj kk ij bi translated">如果您要处理多个要传输的bucket，我建议您向所有bucket-B授予“Resource”:“arn:AWS:S3:::bucket-B-*”的访问权限。对于bucket-A-*来说，你需要一个接一个地手工编写它们。</p></blockquote><p id="5693" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以注意到，bucket B策略授予对KMS密钥的访问权限，以允许s3跨帐户用户将加密文件放入bucket。如果不使用加密，可以删除grantKMSkey部分。</p><blockquote class="mo mp mq"><p id="e82f" class="jn jo mr jp b jq jr js jt ju jv jw jx ms jz ka kb mt kd ke kf mu kh ki kj kk ij bi translated">请注意，您不能将任何未加密的文件放入加密的s3存储桶中。您将看到“权限被拒绝”的错误。</p></blockquote><h2 id="b44e" class="mx km iq bd kn my mz dn kr na nb dp kv jy nc nd kz kc ne nf ld kg ng nh lh ni bi translated">更改存储桶的策略:</h2><p id="08d1" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">下一步是从存储桶的角度授予S3-交叉帐户。</p><p id="884d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<strong class="jp ir">存储桶A </strong>上添加以下存储桶策略(存储桶策略在权限选项卡下):</p><figure class="lp lq lr ls gt lt"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="5ee3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<strong class="jp ir">时段B，</strong>添加以下时段策略:</p><figure class="lp lq lr ls gt lt"><div class="bz fp l di"><div class="mv mw l"/></div></figure><blockquote class="mo mp mq"><p id="cc43" class="jn jo mr jp b jq jr js jt ju jv jw jx ms jz ka kb mt kd ke kf mu kh ki kj kk ij bi translated">对于多个存储桶的修改，您可以使用这个<a class="ae nm" href="https://gist.github.com/ilyesAj/db76562a158a34e809d1c97a4f7bf635" rel="noopener ugc nofollow" target="_blank">脚本</a>来自动修改多个存储桶上的策略，而不需要逐个手动访问它们。</p></blockquote><p id="e8f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">权限抽测:</strong></p><p id="db73" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在配置了您的S3-交叉账户用户的访问密钥和秘密密钥之后(如果您不熟悉这个过程，您可以看看这里的<a class="ae nm" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html" rel="noopener ugc nofollow" target="_blank"/>)</p><p id="56ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们现在可以测试用户是否拥有正确的权限。您可以执行以下操作:</p><pre class="lp lq lr ls gt nn no np nq aw nr bi"><span id="eadb" class="mx km iq no b gy ns nt l nu nv"># test bucket A access<br/>$ aws s3 ls --profile s3-prod-cross-account s3://bucket-A --region eu-west-1<br/>$ aws s3 cp --profile s3-prod-cross-account s3://bucket-A/some-file . --region eu-west-1<br/>-&gt; some-file downloaded locally</span><span id="8a65" class="mx km iq no b gy nw nt l nu nv"># test bucket B access<br/>$ aws s3 ls --profile s3-prod-cross-account s3://bucket-B --region eu-west-3<br/>$ touch dummyfile<br/>$ aws s3 cp --profile s3-prod-cross-account ./dummyfile s3://bucket-B --region eu-west-3<br/>-&gt; dummyfile uploaded to s3</span></pre><blockquote class="mo mp mq"><p id="f6da" class="jn jo mr jp b jq jr js jt ju jv jw jx ms jz ka kb mt kd ke kf mu kh ki kj kk ij bi translated"><strong class="jp ir">当您尝试这些命令时，确保配置文件和区域的名称是正确的。</strong></p></blockquote><p id="5189" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们准备好了，我们可以开始转移了。</p><h1 id="a4c6" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">传输数据:</h1><p id="a4f2" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">正如我提到的，我们要处理数万亿字节的数据和数千个文件。我们有些桶只有千兆字节的数据，有些桶有兆兆字节。</p><p id="4eaa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本节旨在向您介绍我们已经测试过的不同解决方案。解决方案没有好坏之分；这取决于您的架构&amp;存储桶的大小和对象的总数。</p><h2 id="870f" class="mx km iq bd kn my mz dn kr na nb dp kv jy nc nd kz kc ne nf ld kg ng nh lh ni bi translated">处理小桶:</h2><p id="018e" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">处理小桶并不意味着复制会很快。对象的数量也很重要，因为它可以将复制时间乘以10。</p><p id="cebc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我们必须复制的一个存储桶示例:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi nx"><img src="../Images/82b55abf06c500db59d822aece16a076.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l9dnwz_cGLdamv-10IsJsA.png"/></div></div></figure><p id="ceab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将存储桶从一个区域复制到另一个区域的通用命令是:</p><pre class="lp lq lr ls gt nn no np nq aw nr bi"><span id="15f4" class="mx km iq no b gy ns nt l nu nv">aws s3 cp --profile s3-prod-cross-account s3://bucket-source/ s3://bucket-target/ --source-region source-region --region target-region --recursive</span></pre><p id="bbb9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们认为存储桶A是一个小存储桶，您可以用以下公式复制它:</p><pre class="lp lq lr ls gt nn no np nq aw nr bi"><span id="bbd4" class="mx km iq no b gy ns nt l nu nv">aws s3 cp --profile s3-prod-cross-account s3://bucket-A/ s3://bucket-B/ --source-region <!-- -->eu-west-1<!-- --> --region <!-- -->eu-west-3<!-- --> --recursive</span></pre><p id="d0b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以考虑一些优化来加快复制速度:</p><ul class=""><li id="dfb4" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mf mg mh mi bi translated"><strong class="jp ir">复制命令“cp”而不是同步:</strong>同步需要枚举桶内的所有文件来决定复制哪些文件。Copy命令会将源存储桶的内容复制到目标存储桶。如果目标中存在该文件，它将被覆盖</li><li id="4c6f" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated"><strong class="jp ir">并行运行:</strong>您可以在不同的终端中运行多个awscli实例，以提高传输速度。</li><li id="3223" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated"><strong class="jp ir">将运行分割成多个部分:</strong>您可以使用“排除”和“包含”过滤器将您的桶分割成多个部分，并同时复制它们(进一步说明<a class="ae nm" href="https://aws.amazon.com/premiumsupport/knowledge-center/s3-improve-transfer-sync-command/" rel="noopener ugc nofollow" target="_blank">此处</a>)。</li><li id="3674" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated"><strong class="jp ir">后台作业:</strong>我建议总是使用“cronjobs”或“nohup”命令在后台作业上运行AWS s3副本</li></ul><h2 id="030c" class="mx km iq bd kn my mz dn kr na nb dp kv jy nc nd kz kc ne nf ld kg ng nh lh ni bi translated">处理更大的铲斗:</h2><p id="9681" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">在如此复杂的架构中处理更大的存储桶是迁移过程中的一个痛点(这也是促使我写这篇博客的原因)。这是我们转移的一个桶的例子。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi ny"><img src="../Images/43b80ed07d4f7854aab8f3e2f033ef1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NNS6F7DwBk4u3pc5IjVkJA.png"/></div></div></figure><p id="51da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第一次运行</strong>是从我的笔记本电脑上使用<code class="fe nz oa ob no b">aws cp</code>命令(像上一节一样)来执行复制。我给出的想法，因为它将需要几天的时间来完成与公布的速度复制。</p><p id="1659" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第二次运行时，</strong>我试图最接近AWS基础设施；因为我们在帐户B上运行Kubernetes集群，所以我运行了一个带有awscli映像的作业，它将为我启动cp命令。你可以在下面找到这份工作的一个片段。</p><figure class="lp lq lr ls gt lt"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="9ab5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种方法中，我遇到了以下错误:</p><pre class="lp lq lr ls gt nn no np nq aw nr bi"><span id="0396" class="mx km iq no b gy ns nt l nu nv">An error occurred (AccessDenied) when calling the CopyObject operation: VPC endpoints do not support cross-region requests</span></pre><p id="554a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当深入研究这个问题时，我发现我不能从vpc内部进行复制，因为亚马逊S3 的<a class="ae nm" href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-endpoints-s3.html#vpc-endpoints-policies-s3" rel="noopener ugc nofollow" target="_blank"> VPC端点目前不支持跨区域请求。(正如我前面提到的，包含bucket A的vpc-A与包含bucket B的vpc-B有一个对等关系)。</a></p><p id="59a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有多种解决方案可以解决这个问题:</p><ul class=""><li id="4eee" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mf mg mh mi bi translated">通过从路由表中删除VPC端点，暂时禁用VPC端点。此过程将强制awscli通过internet传递，而不是使用vpc内部调用</li><li id="f0a0" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">创建一个没有VPC端点的新VPC，并在那里启动EC2。</li><li id="9aa1" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">启动一台既不在区域A也不在区域B的EC2机器</li></ul><p id="f006" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">在我们的设置中，没有一个解决方案是可行的；我们需要在不改变架构或增加资源的情况下进行迁移。</strong></p><p id="7a81" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">在第三次运行时</strong>(就是那个好的！)，我基于这个<a class="ae nm" href="https://stackoverflow.com/a/65184575/11436917" rel="noopener ugc nofollow" target="_blank">评论</a>提出了我的解决方案，并将其调整为在Kubernetes上运行。</p><p id="3194" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了解释设置，您可以在下面找到一个模式:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi oc"><img src="../Images/51807847c1ba9c05d55fffa73c412d43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TGjtqha9afDMHz1CUFIBrA.png"/></div></div></figure><p id="1589" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们已经创建了一个pod(由一个作业控制),它包含两个带有共享文件夹的容器:</p><ol class=""><li id="9b06" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk nj mg mh mi bi translated">s3-sync-local会将文件从源存储桶(存储桶-a)复制到本地文件夹/数据</li><li id="8c36" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk nj mg mh mi bi translated">s3-sync-remote会将/data中的文件移动到远程bucket (bucket-b)。如果文件夹是空的，他将等待5秒钟，然后重新运行移动命令。如果文件夹在两次迭代中为空(10秒睡眠),则while循环停止。)</li></ol><blockquote class="mo mp mq"><p id="fea1" class="jn jo mr jp b jq jr js jt ju jv jw jx ms jz ka kb mt kd ke kf mu kh ki kj kk ij bi translated">/data是两个容器之间的共享文件夹，将用作缓冲区(s3-sync-local具有写访问权限，s3-sync-remote具有只读访问权限)。该文件夹在kubernetes一侧以PVC为背衬。您也可以使用tempdir，但是您可能会使节点饱和(在kubelet端会有磁盘压力警告)</p></blockquote><p id="85c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以在下面找到我使用的代码片段:</p><figure class="lp lq lr ls gt lt"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="a868" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该解决方案的优势在于:</p><ul class=""><li id="651b" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mf mg mh mi bi translated">解决vpc跨区域限制</li><li id="6968" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">使用Kubernetes的强大功能同时自动复制存储桶</li><li id="385a" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">可以使用cronjob进行调度</li><li id="6e06" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">只需要bucket总大小的5%就可以复制整个bucket(根据我的测试，对于一个5，4tb的bucket，您将需要大约250 Gb的存储作为缓冲)</li><li id="fc5a" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">您可以使用subpath变量来创建同一个存储桶的多个并行运行</li></ul><blockquote class="mo mp mq"><p id="7374" class="jn jo mr jp b jq jr js jt ju jv jw jx ms jz ka kb mt kd ke kf mu kh ki kj kk ij bi translated">尽管有所有的优势，你需要考虑到这种方法会复制两次相同的文件(bucket-A -&gt; pod -&gt; bucket-B)，这<strong class="jp ir">可能会导致网络饱和</strong>。您还需要意识到，如果作业失败，您需要从头重新启动它。</p></blockquote><h2 id="3c47" class="mx km iq bd kn my mz dn kr na nb dp kv jy nc nd kz kc ne nf ld kg ng nh lh ni bi translated">最终结果:</h2><p id="1ac8" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">对一个最大的木桶的真正考验:</p><ul class=""><li id="5d38" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mf mg mh mi bi translated">文件总数:946 803</li><li id="eafb" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">桶的总尺寸:4,391To</li><li id="ef51" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated">文件的大小是不同的；我们有1ko到200ko和15Mb到30Mb的文件。</li></ul><p id="a17d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该存储桶有十个主文件夹，其中包含多个子文件夹和对象。我创造了十份工作；每个作业处理一个主文件夹。这种采样帮助我加快了复制速度，并在作业失败时限制了影响。</p><p id="278d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">我用了77分钟复制了整个桶(~4To)！</strong></p><pre class="lp lq lr ls gt nn no np nq aw nr bi"><span id="e142" class="mx km iq no b gy ns nt l nu nv">NAME                 COMPLETIONS   DURATION   AGE</span><span id="94f9" class="mx km iq no b gy nw nt l nu nv">s3-copy-bucket-a      1/1           66m        22d</span><span id="bf22" class="mx km iq no b gy nw nt l nu nv">s3-copy-bucket-a1     1/1           77m        22d</span><span id="5d50" class="mx km iq no b gy nw nt l nu nv">s3-copy-bucket-a2     1/1           74m        22d</span><span id="64f6" class="mx km iq no b gy nw nt l nu nv">s3-copy-bucket-a3     1/1           72m        22d</span><span id="c8cd" class="mx km iq no b gy nw nt l nu nv">s3-copy-bucket-a4     1/1           65m        22d</span><span id="2f53" class="mx km iq no b gy nw nt l nu nv">s3-copy-bucket-a5     1/1           64m        21d</span><span id="9a8d" class="mx km iq no b gy nw nt l nu nv">s3-copy-bucket-a6     1/1           66m        22d</span><span id="263a" class="mx km iq no b gy nw nt l nu nv">s3-copy-bucket-a7     1/1           67m        22d</span><span id="a2ae" class="mx km iq no b gy nw nt l nu nv">s3-copy-bucket-a8     1/1           77m        22d</span><span id="580c" class="mx km iq no b gy nw nt l nu nv">s3-copy-bucket-a9     1/1           74m        22d</span></pre><p id="01de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如我之前所说的，您需要监控这个操作的网络，因为它可能会使您的网络饱和。这是我复制时的流量快照:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi od"><img src="../Images/eca140f6badf53b6e82d1883248cf33d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jim5ExYa5-co2rdJYv0UcQ.png"/></div></div></figure><blockquote class="mo mp mq"><p id="9087" class="jn jo mr jp b jq jr js jt ju jv jw jx ms jz ka kb mt kd ke kf mu kh ki kj kk ij bi translated"><strong class="jp ir">替代解决方案(AWS管理):</strong>当我写这篇博客时，我发现您可以使用<a class="ae nm" href="https://aws.amazon.com/blogs/storage/replicating-existing-objects-between-s3-buckets/" rel="noopener ugc nofollow" target="_blank">这篇博客</a>来测试它作为复制跨帐户跨区域的可能解决方案。</p></blockquote><h1 id="2bf8" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">最后的想法</h1><p id="49be" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">尽管最终的解决方案需要耗费大量的网络资源，但结果非常令人满意。我们能够优化跨地区、跨VPC和跨帐户的数据传输，从几天缩短到几个小时。</p><p id="bb86" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">AWS最近宣布<a class="ae nm" href="https://aws.amazon.com/s3/features/replication/#Amazon_S3_Cross-Region_Replication_.28CRR.29" rel="noopener ugc nofollow" target="_blank">亚马逊S3跨区域复制(CRR) </a> <a class="ae nm" href="https://aws.amazon.com/blogs/aws/new-replicate-existing-objects-with-amazon-s3-batch-replication/" rel="noopener ugc nofollow" target="_blank">现在</a>支持复制现有对象。这项服务可能是一个替代解决方案。请务必估计转移成本，因为账单可能会呈指数增长。</p><h2 id="8751" class="mx km iq bd kn my mz dn kr na nb dp kv jy nc nd kz kc ne nf ld kg ng nh lh ni bi translated">参考资料:</h2><ul class=""><li id="de7b" class="ma mb iq jp b jq lj ju lk jy oe kc of kg og kk mf mg mh mi bi translated"><a class="ae nm" href="https://aws.amazon.com/blogs/security/how-to-restrict-amazon-s3-bucket-access-to-a-specific-iam-role/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/security/how-to-restrict-Amazon-S3-bucket-access-a-specific-iam-role/</a></li><li id="cb75" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated"><a class="ae nm" href="https://aws.amazon.com/premiumsupport/knowledge-center/s3-troubleshoot-copy-between-buckets/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/premium support/knowledge-center/S3-trouble shooting-copy-between-bucket/</a></li><li id="5b63" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated"><a class="ae nm" href="https://aws.amazon.com/premiumsupport/knowledge-center/s3-improve-transfer-sync-command/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/premium support/knowledge-center/S3-improve-transfer-sync-command/</a></li><li id="4bf1" class="ma mb iq jp b jq mj ju mk jy ml kc mm kg mn kk mf mg mh mi bi translated"><a class="ae nm" href="https://stackoverflow.com/questions/39707923/aws-cli-copy-between-s3-regions-on-ec2" rel="noopener ugc nofollow" target="_blank">https://stack overflow . com/questions/39707923/AWS-CLI-copy-between-S3-regions-on-ec2</a></li></ul></div></div>    
</body>
</html>