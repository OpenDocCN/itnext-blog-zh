<html>
<head>
<title>Part 2: NextJS + API Routes + MongoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">第2部分:NextJS + API Routes + MongoDB</h1>
<blockquote>原文：<a href="https://itnext.io/part-2-nextjs-api-routes-mongodb-b6895232c27?source=collection_archive---------1-----------------------#2021-08-20">https://itnext.io/part-2-nextjs-api-routes-mongodb-b6895232c27?source=collection_archive---------1-----------------------#2021-08-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="a2d5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将MongoDB数据库添加到我们在本博客系列的第一部分中构建的SaaS MVP应用程序中。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/22e382daf19aa733d6234bd405f16fbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GkRxndMbnm_chQqNQ8isqg.jpeg"/></div></div></figure><p id="3b80" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们使用NextJS、TypeScript、MaterialUI、Storybook、Jest和SWR为SaaS MVP建立的初始代码库描述如下:</p><div class="la lb gp gr lc ld"><a rel="noopener  ugc nofollow" target="_blank" href="/nextjs-storybookjs-material-ui-jest-swr-fe2ff5cb9af8"><div class="le ab fo"><div class="lf ab lg cl cj lh"><h2 class="bd iu gy z fp li fr fs lj fu fw is bi translated">next js+storybook js+Material-UI+Jest+SWR</h2><div class="lk l"><h3 class="bd b gy z fp li fr fs lj fu fw dk translated">这是我最喜欢的新应用程序设置，我想你也会喜欢的。</h3></div><div class="ll l"><p class="bd b dl z fp li fr fs lj fu fw dk translated">itnext.io</p></div></div><div class="lm l"><div class="ln l lo lp lq lm lr ky ld"/></div></div></a></div><p id="9fcb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这篇文章中，我们将把我们的应用程序连接到一个MongoDB数据库。</p><p id="8ecb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们使用NextJS API Routes(【https://nextjs.org/docs/api-routes/introduction】T4)让HTTP API后端驻留在相同的代码基上，当然是使用TypeScript。</p><h1 id="fbb6" class="lt lu it bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">首先，创建一个MongoDB数据库</h1><p id="6137" class="pw-post-body-paragraph jq jr it js b jt mr jv jw jx ms jz ka kb mt kd ke kf mu kh ki kj mv kl km kn im bi translated">有几个基于云的MongoDB解决方案，其中之一(如果不是最好的)是MongoDB Atlas(<a class="ae ls" href="https://www.mongodb.com/cloud/atlas" rel="noopener ugc nofollow" target="_blank">https://www.mongodb.com/cloud/atlas</a>)。MongoDB Atlas有一个500Mb的免费层。</p><p id="87e1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在Atlas上创建一个MongoDB数据库。第一步，创建一个<strong class="js iu">项目</strong>:</p><div class="kp kq kr ks gt ab cb"><figure class="mw kt mx my mz na nb paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><img src="../Images/ee6bb0c3ab656017c2433cd2d02744eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*c4qdE_zfv2FDmRuDTrSo2w.png"/></div></figure><figure class="mw kt mx my mz na nb paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><img src="../Images/d4daab83ac61952636b8d2bbb4bf15dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*Y1sToOcvpi23XFoSO5YwMA.png"/></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk ng di nh ni translated">创建项目</figcaption></figure></div><p id="3d5a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第二步，通过选择计划(自由)和主机(云)创建数据库集群:</p><div class="kp kq kr ks gt ab cb"><figure class="mw kt nj my mz na nb paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><img src="../Images/11fcf66a1c7c10f735870713474e7552.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*hwImGSAQzxhKRntUPKnU_Q.png"/></div></figure><figure class="mw kt nj my mz na nb paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><img src="../Images/2fed38d3b6e2a127ffbce8f2abd3560d.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*zjaHfdsPpQW9o76Qlq_oUA.png"/></div></figure><figure class="mw kt nj my mz na nb paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><img src="../Images/62b999c3078df7064edeb0c40eb174be.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*LursV5RFDHGtbcNJ6fPkrw.png"/></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk nk di nl ni translated">创建数据库集群</figcaption></figure></div><p id="7eec" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第三步，创建数据库集群用户:</p><p id="286d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="nm">注意:在某个地方写下用户密码，我们将在后面的步骤中需要它。</em></p><div class="kp kq kr ks gt ab cb"><figure class="mw kt nj my mz na nb paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><img src="../Images/040592e838fb88903123ca6e46a27c82.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0YPYOMdt17eJiLiurEgCpg.png"/></div></figure><figure class="mw kt nj my mz na nb paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><img src="../Images/7fa59236b3063e8175fb99b312c0b867.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*P_EAChfOKJPeW63o_UVTcw.png"/></div></figure><figure class="mw kt nj my mz na nb paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><img src="../Images/ab8b42ea02c8a3d8bbc49e9c48a76efd.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*LN_dwWMGaIMNBzoVsNQKtQ.png"/></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk nk di nl ni translated">创建数据库用户</figcaption></figure></div><p id="6e52" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦创建了数据库集群用户，我们就可以使用连接功能创建一个数据库。</p><div class="kp kq kr ks gt ab cb"><figure class="mw kt mx my mz na nb paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><img src="../Images/694d322524c5d3bc4de010507ba92c5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*GW7gTTyqYa3xkhrM8I3Y-w.png"/></div></figure><figure class="mw kt mx my mz na nb paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><img src="../Images/5e53ae57a68ce9a25e55c24cc4f43a7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*SaCc1ajp8KBGSTfk33KX7w.png"/></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk ng di nh ni translated">连接到数据库集群(IP访问)</figcaption></figure></div><div class="ab cb"><figure class="mw kt mx my mz na nb paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><img src="../Images/aea29d7d70d6457b23cd08d836ec9529.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*CqNaDhLAkVlc9XW_LBhTVQ.png"/></div></figure><figure class="mw kt mx my mz na nb paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><img src="../Images/5f5c092eed00433609a7af2e82e5f16b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*6aNcFqIpZS39HcO66iZFzw.png"/></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk ng di nh ni translated">连接到数据库集群(MongoDB Compass)</figcaption></figure></div><p id="b315" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">MongoDB Compass(<a class="ae ls" href="https://www.mongodb.com/products/compass" rel="noopener ugc nofollow" target="_blank">https://www.mongodb.com/products/compass</a>)是一个桌面MongoDB客户端。下载并安装在您的本地机器上。我们将使用它在集群上创建数据库，并在其上创建集合和查询数据。</p><p id="1c50" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们的数据库名称将是:<code class="fe nn no np nq b">saas-db</code>和第一个集合<code class="fe nn no np nq b">registrations</code></p><div class="kp kq kr ks gt ab cb"><figure class="mw kt mx my mz na nb paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><img src="../Images/7e613e19c5385dfba2a7617a30ab739e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*4GKrffbbTmoDE2WEq1MRAQ.png"/></div></figure><figure class="mw kt mx my mz na nb paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><img src="../Images/52dcd9e13d2397a542d8187e344ab04f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*U9gYVWu5H__Xzq6B2_B9TQ.png"/></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk ng di nh ni translated">MongoDB Compass正在连接到数据库集群</figcaption></figure></div><div class="ab cb"><figure class="mw kt mx my mz na nb paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><img src="../Images/13695f2b7a4393383d5faf496bdf928f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*-dHmfneqgGb8gfVfrqFqqg.png"/></div></figure><figure class="mw kt mx my mz na nb paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><img src="../Images/a0af0382a95227533ae8b431934f85f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*GsSLw3-VKdFd_MDJlgAztA.png"/></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk ng di nh ni translated">MongoDB Compass创建一个数据库和集合</figcaption></figure></div><h1 id="b533" class="lt lu it bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">从NextJS API路由使用MongoDB</h1><p id="841e" class="pw-post-body-paragraph jq jr it js b jt mr jv jw jx ms jz ka kb mt kd ke kf mu kh ki kj mv kl km kn im bi translated">从我们在第1部分中创建的repo开始，让我们修改它，这样我们就可以在数据库中存储和查询注册用户。</p><p id="a9d4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个回购中，我们使用了一个内存变量来存储来自页面的电子邮件注册。我们将修改端点，改为使用MongoDB集合<code class="fe nn no np nq b">registrations</code>。</p><h2 id="5f7e" class="nr lu it bd lv ns nt dn lz nu nv dp md kb nw nx mh kf ny nz ml kj oa ob mp oc bi translated">安装依赖项</h2><p id="db46" class="pw-post-body-paragraph jq jr it js b jt mr jv jw jx ms jz ka kb mt kd ke kf mu kh ki kj mv kl km kn im bi translated"><code class="fe nn no np nq b">mongodb</code>是我们唯一需要的依赖</p><pre class="kp kq kr ks gt od nq oe of aw og bi"><span id="0da7" class="nr lu it nq b gy oh oi l oj ok">$ yarn add mongodb<br/>yarn add v1.22.11<br/>[1/4] 🔍  Resolving packages...<br/>[2/4] 🚚  Fetching packages...<br/>[3/4] 🔗  Linking dependencies...<br/>[4/4] 🔨  Building fresh packages...</span><span id="b588" class="nr lu it nq b gy ol oi l oj ok">success Saved lockfile.<br/>success Saved 9 new dependencies.<br/>info Direct dependencies<br/>└─ mongodb@4.1.0<br/>info All dependencies<br/>├─ <a class="ae ls" href="http://twitter.com/types/webidl-conversions" rel="noopener ugc nofollow" target="_blank">@types/webidl-conversions</a>@6.1.1<br/>├─ <a class="ae ls" href="http://twitter.com/types/whatwg-url" rel="noopener ugc nofollow" target="_blank">@types/whatwg-url</a>@8.2.1<br/>├─ bson@4.5.0<br/>├─ denque@1.5.1<br/>├─ memory-pager@1.5.0<br/>├─ mongodb-connection-string-url@1.1.2<br/>├─ mongodb@4.1.0<br/>├─ saslprep@1.0.3<br/>└─ sparse-bitfield@3.0.3<br/>✨  Done in 7.90s.</span></pre><p id="8d0e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">正在连接到MongoDB</p><p id="482f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了连接到MongoDB，我们重用了NextJS repo examples文件夹中的“连接函数”(<a class="ae ls" href="https://github.com/vercel/next.js/tree/canary/examples/with-mongodb" rel="noopener ugc nofollow" target="_blank">https://github . com/vercel/next . js/tree/canary/examples/with-MongoDB</a>)并用一个直接提供数据库访问的通用函数来包装它，这样我们就不必担心每次需要查询时都要连接到数据库。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="om on l"/></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk translated">src/lib/mongo.ts</figcaption></figure><p id="1716" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe nn no np nq b">withMongo</code>异步函数是通用的<code class="fe nn no np nq b">&lt;T&gt;</code>，允许返回一个类型值<code class="fe nn no np nq b">T</code>。例如:</p><pre class="kp kq kr ks gt od nq oe of aw og bi"><span id="3867" class="nr lu it nq b gy oh oi l oj ok">const registrations = await withMongo(async (db: Db) =&gt; {<br/>  const collection = db.collection&lt;User&gt;('registrations')<br/>  return await collection.find().toArray()<br/>})</span></pre><p id="4a1d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个例子中,<code class="fe nn no np nq b">registrations</code>变量的类型是<code class="fe nn no np nq b">User[]</code></p><p id="d139" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另一个重要的细节是设置环境运行时变量:</p><ul class=""><li id="3ac6" class="oo op it js b jt ju jx jy kb oq kf or kj os kn ot ou ov ow bi translated"><code class="fe nn no np nq b">MONGO_DB_URL</code> : MongoDB连接URL地址(这与我们使用Compass连接到MongoDB数据库集群的地址相同)</li><li id="f65a" class="oo op it js b jt ox jx oy kb oz kf pa kj pb kn ot ou ov ow bi translated"><code class="fe nn no np nq b">MONGO_DB_NAME</code> : MongoDB名称(我们将其设置为<code class="fe nn no np nq b">saas-db</code>)</li></ul><p id="6120" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在项目的根目录下创建一个<code class="fe nn no np nq b">.env</code>(或<code class="fe nn no np nq b">.env.local</code>)文件。</p><pre class="kp kq kr ks gt od nq oe of aw og bi"><span id="9ccd" class="nr lu it nq b gy oh oi l oj ok">MONGO_DB_URL=mongodb+srv://&lt;user&gt;:&lt;pass&gt;@&lt;server-url&gt;<br/>MONGO_DB_NAME=saas-db</span></pre><p id="f05b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">修改<code class="fe nn no np nq b">src/pages/api/subscriptions.ts</code>文件:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="om on l"/></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk translated">src/pages/api/subscriptions.ts</figcaption></figure><p id="b7c9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">运行您的应用程序。它现在有一个MongoDB后端。</p><div class="kp kq kr ks gt ab cb"><figure class="mw kt pc my mz na nb paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><img src="../Images/a993ee1b489c085aa0fac68f485c109d.png" data-original-src="https://miro.medium.com/v2/resize:fit:926/format:webp/1*z9ep-7fymBNv5RHSjerBjA.png"/></div></figure><figure class="mw kt pd my mz na nb paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><img src="../Images/f533a2a472a314e9f81fe1dd3e973447.png" data-original-src="https://miro.medium.com/v2/resize:fit:1076/format:webp/1*GW1FWBs1I2MavlO8PvFStA.png"/></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk pe di pf ni translated">向注册集合中的注册-&gt;电子邮件添加电子邮件。</figcaption></figure></div><h1 id="45a3" class="lt lu it bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">结论</h1><ul class=""><li id="968b" class="oo op it js b jt mr jx ms kb pg kf ph kj pi kn ot ou ov ow bi translated">为SaaS MVP建立一个数据库应该不会花费太多的时间和金钱。存在免费层，因此您可以引导您的应用程序。如果您的应用程序增长，您可以使用无服务器计划(<a class="ae ls" href="https://www.mongodb.com/pricing" rel="noopener ugc nofollow" target="_blank">https://www.mongodb.com/pricing</a>)按需购买更多空间</li><li id="5444" class="oo op it js b jt ox jx oy kb oz kf pa kj pb kn ot ou ov ow bi translated">MongoDB Atlas免费层为您提供500Mb的数据库空间。只要确保使用强密码保护其访问，如果可能的话，允许IPs列表、对等(<a class="ae ls" href="https://docs.atlas.mongodb.com/security-vpc-peering/" rel="noopener ugc nofollow" target="_blank">https://docs.atlas.mongodb.com/security-vpc-peering/</a>)或私有端点(<a class="ae ls" href="https://docs.atlas.mongodb.com/security-private-endpoint/" rel="noopener ugc nofollow" target="_blank">https://docs.atlas.mongodb.com/security-private-endpoint/</a>)</li><li id="be2c" class="oo op it js b jt ox jx oy kb oz kf pa kj pb kn ot ou ov ow bi translated">TypeScript类型使一切变得简单多了。<code class="fe nn no np nq b">mongodb</code>包全打。使用它。</li><li id="31da" class="oo op it js b jt ox jx oy kb oz kf pa kj pb kn ot ou ov ow bi translated">完整的代码可以在<a class="ae ls" href="https://github.com/outsrc/next-mui/tree/efg/with-mongodb" rel="noopener ugc nofollow" target="_blank">https://github.com/outsrc/next-mui/tree/efg/with-mongodb</a>找到</li><li id="e463" class="oo op it js b jt ox jx oy kb oz kf pa kj pb kn ot ou ov ow bi translated">运行演示在:<a class="ae ls" href="https://next-mui-r3ranh7al-outsrc.vercel.app/" rel="noopener ugc nofollow" target="_blank">https://next-mui-r3ranh7al-outsrc.vercel.app/</a>(<em class="nm">)由于没有删除按钮，电子邮件显示在页面上可见，我们每隔几个小时删除所有数据。</em>)</li></ul><p id="2115" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">快乐编码…</p></div></div>    
</body>
</html>