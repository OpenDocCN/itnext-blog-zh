<html>
<head>
<title>Remote YouTube downloader Slack bot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">远程YouTube下载者Slack bot</h1>
<blockquote>原文：<a href="https://itnext.io/remote-youtube-downloader-slack-bot-dff265f57a70?source=collection_archive---------5-----------------------#2018-12-12">https://itnext.io/remote-youtube-downloader-slack-bot-dff265f57a70?source=collection_archive---------5-----------------------#2018-12-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/2ebc263f6657dd72a1c52a271c00519d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*i-uHytV3NdqyZ_Ey.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">我们的流程</figcaption></figure><p id="7c93" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在这个简短的教程中，我们将看到使用Webhook中继<a class="ae la" href="https://webhookrelay.com/v1/guide/socket-server" rel="noopener ugc nofollow" target="_blank">套接字服务器</a>在你的应用程序中直接接收web hook是多么容易。我们的应用程序将是一个<a class="ae la" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>守护进程，它监听webhooks并下载用户(您)请求的视频。虽然守护程序可以用任何语言编写，但我选择了JavaScript，因为它非常容易阅读，而且大多数人都在野外遇到过。</p><p id="75f5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">对于webhook生产者，我们将使用Slack和他们的slash命令。<a class="ae la" href="https://api.slack.com/slash-commands" rel="noopener ugc nofollow" target="_blank">松弛斜线命令</a>的优点:</p><ul class=""><li id="edfc" class="lb lc iq ke b kf kg kj kk kn ld kr le kv lf kz lg lh li lj bi translated">不需要Slack client SDK</li><li id="4b16" class="lb lc iq ke b kf lk kj ll kn lm kr ln kv lo kz lg lh li lj bi translated">通过可以用任何语言轻松处理的webhooks工作</li><li id="c0ac" class="lb lc iq ke b kf lk kj ll kn lm kr ln kv lo kz lg lh li lj bi translated">不需要身份验证令牌(只需要一个webhook端点来发送请求)</li></ul><h1 id="aaca" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">问题</h1><p id="0335" class="pw-post-body-paragraph kc kd iq ke b kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ij bi translated">Webhooks很棒，但是你的应用程序需要公开到互联网上才能接收它们。它还必须有一个能够处理这些网络钩子的网络服务器。对于一个简单的应用程序或者不需要总是在线的应用程序，配置NAT/防火墙可能是多余的。</p><h1 id="4a90" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">解决办法</h1><p id="7087" class="pw-post-body-paragraph kc kd iq ke b kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ij bi translated">Webhook Relay + WebSocket client可以让您的应用程序从第三方服务接收Webhook，而无需公共IP/域、配置NAT，甚至web服务器也变得不必要。您可以直接在应用程序中处理webhooks。</p><h1 id="eb35" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">先决条件</h1><ol class=""><li id="2e1e" class="lb lc iq ke b kf mn kj mo kn ms kr mt kv mu kz mv lh li lj bi translated">Webhook中继<a class="ae la" href="https://my.webhookrelay.com/register" rel="noopener ugc nofollow" target="_blank">账户</a></li><li id="bf44" class="lb lc iq ke b kf lk kj ll kn lm kr ln kv lo kz mv lh li lj bi translated">松弛帐户和工作区</li><li id="fe1e" class="lb lc iq ke b kf lk kj ll kn lm kr ln kv lo kz mv lh li lj bi translated"><a class="ae la" href="https://www.npmjs.com" rel="noopener ugc nofollow" target="_blank"> npm </a>和节点。JS在你的机器上</li></ol></div><div class="ab cl mw mx hu my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="ij ik il im in"><h1 id="9e94" class="lp lq iq bd lr ls nd lu lv lw ne ly lz ma nf mc md me ng mg mh mi nh mk ml mm bi translated">创建一个webhook转发桶</h1><p id="4a52" class="pw-post-body-paragraph kc kd iq ke b kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ij bi translated">我们将创建一个存储桶(存储桶用于对Webhook中继中的输入/输出进行分组)来捕获和中继松弛的web hook。转到<a class="ae la" href="https://my.webhookrelay.com/buckets" rel="noopener ugc nofollow" target="_blank">桶页面</a>并创建一个名为<code class="fe ni nj nk nl b">slash</code>的新桶。它将获得一个默认的公共端点，我们将在下一步中使用它。也创建一个内部输出，目的地并不重要，但它将帮助我们进行调试:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div class="ab gu cl nq"><img src="../Images/c8e2c54d29f42c129ae826960987e49a.png" data-original-src="https://miro.medium.com/v2/format:webp/0*vw5MV1ul6pe1_XcU.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">创建存储桶</figcaption></figure><h1 id="1d12" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">创建松弛斜线命令应用程序</h1><p id="ca30" class="pw-post-body-paragraph kc kd iq ke b kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ij bi translated">首先，我们需要一种简单的方法来发送网页挂钩。我最初想尝试Airtable和Google Sheets，但对他们的服务中缺乏webhooks感到非常失望。Zapier似乎试图在这方面提供一些帮助，但是他们的网络挂钩只能每15分钟工作一次，即使这样我也没有收到任何网络挂钩..:)所以，另一个明显而简单的选择是<a class="ae la" href="https://api.slack.com/slash-commands" rel="noopener ugc nofollow" target="_blank">松弛斜线命令</a>。</p><blockquote class="nr ns nt"><p id="89f8" class="kc kd nu ke b kf kg kh ki kj kk kl km nv ko kp kq nw ks kt ku nx kw kx ky kz ij bi translated">Slash命令让用户直接从Slack的消息框中触发与你的应用的交互。</p></blockquote><p id="216a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">创建一个斜杠命令实际上比你想象的要简单得多，看看官方文档中的<a class="ae la" href="https://api.slack.com/slash-commands#creating_commands" rel="noopener ugc nofollow" target="_blank">。想出一个名称并选择一个工作区:</a></p><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/6b82803b505663d40d29602a664c37be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ynqosf8g0uKp8yxZ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">创建闲置应用程序</figcaption></figure><p id="0042" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在，从“添加特性和功能”中选择<strong class="ke ir">斜线命令</strong>并填写一些细节:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/f1d22703953f6f27008d17db6fe1a441.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/0*50vxiAzs42SuXqae.png"/></div></figure><p id="b23a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">您可以使用命令前缀<code class="fe ni nj nk nl b">/dl</code>进行创作，因为我们的应用程序不会使用它，只有命令后面的文本会在代码中使用。在请求URL中添加您的Webhook中继输入端点，即<code class="fe ni nj nk nl b">https://my.webhookrelay.com/v1/webhooks/....</code>。一旦您对细节满意，保存并安装它:</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/ef41b0595f3e0f300f7e89934076ae94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QEsnnf0J4Cxpfioj.png"/></div></div></figure><p id="ebcf" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在，每当我们键入<code class="fe ni nj nk nl b">/dl https://www.youtube.com/watch?v=tPEE9ZwTmy0</code>，它就会发送一个webhook到Webhook中继输入，从那里我们可以把它中继到我们的应用程序。试试看，会被俘虏的。</p><h1 id="2c23" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">分析松弛命令有效负载</h1><p id="9c24" class="pw-post-body-paragraph kc kd iq ke b kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ij bi translated">一旦我们得到了测试载荷，我们需要检查它里面有什么。不幸的是，我找不到让它发送JSON的方法，所以我们必须使用<code class="fe ni nj nk nl b">Content-Type: [ "application/x-www-form-urlencoded" ]</code>。Webhook中继有助于解析消息:</p><pre class="nm nn no np gt ob nl oc od aw oe bi"><span id="510a" class="of lq iq nl b gy og oh l oi oj">token: gp9AyhCMqffRI2pahREQrg2S<br/>team_id: T3QT2DM0Q<br/>team_domain: webhookrelay<br/>channel_id: C3RLQ5C4C<br/>channel_name: general<br/>user_id: U3S9BEU6B<br/>user_name: karolis<br/>command: /dl<br/>text: <a class="ae la" href="https://www.youtube.com/watch?v=tPEE9ZwTmy0" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=tPEE9ZwTmy0</a><br/>response_url: <a class="ae la" href="https://hooks.slack.com/commands/T3QT2DM0Q/495886160947/J0YHv46ot6nZNeHiGR4a1I12" rel="noopener ugc nofollow" target="_blank">https://hooks.slack.com/commands/T3QT2DM0Q/495886160947/J0YHv46ot6nZNeHiGR4a1I12</a><br/>trigger_id: 495384852801.126920463024.5438c17b6d97870e3a05f145c6d4bc70</span></pre><p id="931e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">因此，我们现在知道我们将选择哪些领域:</p><ul class=""><li id="52d3" class="lb lc iq ke b kf kg kj kk kn ld kr le kv lf kz lg lh li lj bi translated"><strong class="ke ir">正文</strong> —这是我们下载的网址</li><li id="a562" class="lb lc iq ke b kf lk kj ll kn lm kr ln kv lo kz lg lh li lj bi translated"><strong class="ke ir"> response_url </strong> —这是我们可以回复用户的地方</li></ul><h1 id="083f" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">创建我们的应用程序</h1><p id="1479" class="pw-post-body-paragraph kc kd iq ke b kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ij bi translated">应用程序代码可以在<a class="ae la" href="https://github.com/webhookrelay/slack-slash-downloader" rel="noopener ugc nofollow" target="_blank"> Github repo </a>上找到，可以随意克隆。为了让我们的生活更轻松，一些主要的图书馆:</p><ul class=""><li id="d362" class="lb lc iq ke b kf kg kj kk kn ld kr le kv lf kz lg lh li lj bi translated"><a class="ae la" href="https://github.com/przemyslawpluta/node-youtube-dl" rel="noopener ugc nofollow" target="_blank">https://github.com/przemyslawpluta/node-youtube-dl</a>—下载视频。</li><li id="c36a" class="lb lc iq ke b kf lk kj ll kn lm kr ln kv lo kz lg lh li lj bi translated">https://github.com/ljharb/qs—查询字符串解析(帮助我们解析Slack负载)。</li><li id="f42e" class="lb lc iq ke b kf lk kj ll kn lm kr ln kv lo kz lg lh li lj bi translated"><a class="ae la" href="https://github.com/request/request" rel="noopener ugc nofollow" target="_blank">https://github.com/request/request</a>—简单的HTTP客户端。尽管我总是更喜欢使用stdlib，但在这种情况下，它对我来说更好。</li></ul><p id="e541" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">对于读者来说，下面是整个应用程序:</p><figure class="nm nn no np gt jr"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="668a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">通过以下方式从<a class="ae la" href="https://github.com/webhookrelay/slack-slash-downloader/blob/master/package.json" rel="noopener ugc nofollow" target="_blank">https://github . com/webhook relay/slack-slash-downloader/blob/master/package . JSON</a>安装依赖项:</p><pre class="nm nn no np gt ob nl oc od aw oe bi"><span id="eb31" class="of lq iq nl b gy og oh l oi oj">npm install</span></pre><h1 id="86ea" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">运行应用程序</h1><p id="e429" class="pw-post-body-paragraph kc kd iq ke b kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ij bi translated">要启动它，从<a class="ae la" href="https://my.webhookrelay.com/tokens" rel="noopener ugc nofollow" target="_blank">令牌页面</a>中检索令牌，并将其设置为环境变量:</p><pre class="nm nn no np gt ob nl oc od aw oe bi"><span id="57bc" class="of lq iq nl b gy og oh l oi oj">export RELAY_KEY=your-token-key<br/>export RELAY_SECRET=your-token-secret</span></pre><p id="7bff" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后:</p><pre class="nm nn no np gt ob nl oc od aw oe bi"><span id="689a" class="of lq iq nl b gy og oh l oi oj">node app.js</span></pre><p id="ae2b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">一旦它开始运行，你就可以开始通过Slack下载视频，只需输入:</p><pre class="nm nn no np gt ob nl oc od aw oe bi"><span id="d4ee" class="of lq iq nl b gy og oh l oi oj">/dl <a class="ae la" href="https://www.youtube.com/watch?v=H_4eRD8aegk" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=H_4eRD8aegk</a></span></pre><figure class="nm nn no np gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi om"><img src="../Images/1f0855b8fb5409acc2e3e57ea0d90a56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pVwv6lawVXEKsXMa.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">机器人响应迟缓</figcaption></figure><p id="9a76" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">应用程序日志应该与此类似:</p><pre class="nm nn no np gt ob nl oc od aw oe bi"><span id="0d40" class="of lq iq nl b gy og oh l oi oj">URL:  <a class="ae la" href="https://www.youtube.com/watch?v=H_4eRD8aegk" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=H_4eRD8aegk</a><br/>Download started<br/>Filename: justforfunc #43 - Migrating Go Modules to v2+-H_4eRD8aegk.mp4<br/>Size: 61705357<br/>Finished downloading!<br/>ok</span></pre><p id="c658" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">您的文件应该出现在与应用程序相同的目录中:</p><pre class="nm nn no np gt ob nl oc od aw oe bi"><span id="7584" class="of lq iq nl b gy og oh l oi oj">➜  slack-slash-downloader git:(master) ✗ ls -alh<br/>total 97M<br/>drwxrwxr-x  4 karolis karolis 4.0K Dec  5 23:37  .<br/>drwxr-xr-x 12 karolis karolis 4.0K Dec  4 10:40  ..<br/>-rw-rw-r--  1 karolis karolis 2.8K Dec  4 23:11  app.js<br/>drwxrwxr-x  8 karolis karolis 4.0K Dec 12 19:39  .git<br/>-rw-rw-r--  1 karolis karolis   27 Dec  4 23:11  .gitignore<br/>-rw-rw-r--  1 karolis karolis  59M Dec  5 23:37 'justforfunc #43 - Migrating Go Modules to v2+-H_4eRD8aegk.mp4'<br/>drwxrwxr-x 61 karolis karolis 4.0K Dec  4 12:07  node_modules<br/>-rw-rw-r--  1 karolis karolis  38M Dec  4 11:29 'Overwatch Winter Wonderland Details Leaks, Skins and More!--b-DktHyWJk.mp4'<br/>-rw-rw-r--  1 karolis karolis  386 Dec  4 12:07  package.json<br/>-rw-rw-r--  1 karolis karolis  16K Dec  4 12:07  package-lock.json</span></pre><p id="b66e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">您可以修改代码，将其放入您的下载目录或任何您想要保存文件的地方。</p><h1 id="9e17" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">综上</h1><p id="48b2" class="pw-post-body-paragraph kc kd iq ke b kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ij bi translated">在这个技术演示中，我们展示了一个轻量级Node.js守护进程如何在没有公共IP或运行web服务器的情况下接收和处理webhooks的实际用例。这可以大大简化整个应用程序，减少攻击面，并在此基础上提供审计功能。</p><p id="f9bd" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">你可以在这里阅读更多关于Socket Server的内容:<a class="ae la" href="https://webhookrelay.com/v1/guide/socket-server" rel="noopener ugc nofollow" target="_blank">https://webhookrelay.com/v1/guide/socket-server</a></p></div><div class="ab cl mw mx hu my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="ij ik il im in"><p id="6874" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><em class="nu">原载于2018年12月12日</em><a class="ae la" href="https://webhookrelay.com/blog/2018/12/12/remote-tube-downloader/" rel="noopener ugc nofollow" target="_blank"><em class="nu">webhookrelay.com</em></a><em class="nu">。</em></p></div></div>    
</body>
</html>