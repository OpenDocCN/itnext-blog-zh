<html>
<head>
<title>Jenkins X — Securing the Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Jenkins X —保护集群</h1>
<blockquote>原文：<a href="https://itnext.io/jenkins-x-securing-the-cluster-e1b9fcd8dd05?source=collection_archive---------2-----------------------#2019-06-22">https://itnext.io/jenkins-x-securing-the-cluster-e1b9fcd8dd05?source=collection_archive---------2-----------------------#2019-06-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/5b5f9662b004e41dec683b529f2a2c18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-fvV2TI45m_tmQ2y"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">何塞·丰塔诺在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="79dc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://jenkins-x.io/" rel="noopener ugc nofollow" target="_blank"> Jenkins X </a>是一个在Kubernetes上快速创建CI/CD管道的伟大工具。然而，快速设置的便利也带来了一些负面影响。在一系列的帖子中，我将讨论这些问题，并提供我对我们如何解决其中一些问题的看法。</p><p id="8326" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我们开始之前，我想对我的对手伊利亚·沙伊斯尔塔诺夫(T7)说几句话。像他这样的同事让这样的冒险变得更加愉快:-)。</p><p id="be8d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在为我们的大数据分析公司<a class="ae kf" href="https://www.datameer.com/" rel="noopener ugc nofollow" target="_blank"> Datameer </a>创建初始CI/CD基础架构时，我们从以下目标开始:</p><ul class=""><li id="d4d1" class="lg lh it ki b kj kk kn ko kr li kv lj kz lk ld ll lm ln lo bi translated">VPC: 任何私人的东西都应该放在某种防火墙后面。</li><li id="fccb" class="lg lh it ki b kj lp kn lq kr lr kv ls kz lt ld ll lm ln lo bi translated"><strong class="ki iu"> VPN: </strong>如果服务是公开可用的，我们需要限制谁可以访问它们。</li><li id="2236" class="lg lh it ki b kj lp kn lq kr lr kv ls kz lt ld ll lm ln lo bi translated"><strong class="ki iu"> TLS: </strong>因为，老实说，今天没有理由需要任何人通过http提供任何服务。</li><li id="69f8" class="lg lh it ki b kj lp kn lq kr lr kv ls kz lt ld ll lm ln lo bi translated"><strong class="ki iu"> OAuth: </strong>使用静态Jenkins，我们希望允许开发人员使用他们的帐户信息登录，而不是在Jenkins中创建额外的独立用户。</li><li id="5684" class="lg lh it ki b kj lp kn lq kr lr kv ls kz lt ld ll lm ln lo bi translated"><strong class="ki iu">照本宣科:</strong>我们希望将手动步骤减到最少。</li></ul><p id="f5c6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">詹金斯X提供了一些现成的。但是为了有100%的覆盖率，需要做一些调整。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="676c" class="mb mc it bd md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my bi translated">保护集群—第一点</h1><p id="1597" class="pw-post-body-paragraph kg kh it ki b kj mz kl km kn na kp kq kr nb kt ku kv nc kx ky kz nd lb lc ld im bi translated">首要任务是保护我们的GKE集群。Jenkins X提供了自动创建集群的选项，包括:</p><pre class="ne nf ng nh gt ni nj nk nl aw nm bi"><span id="d9df" class="nn mc it nj b gy no np l nq nr">jx create cluster gke</span></pre><p id="7484" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">不幸的是，GKE的默认设置目前让世界可以访问主服务器，这意味着我们需要提前创建我们自己的安全集群。顺便说一句，根据发行说明，GKE将在不久的将来默认为VPC本地人<a class="ae kf" href="https://cloud.google.com/kubernetes-engine/docs/release-notes" rel="noopener ugc nofollow" target="_blank">，但是现在我们需要明确地创建一个。</a></p><p id="eafc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">网上有很多好的资源，像<a class="ae kf" href="https://medium.com/google-cloud/vpc-native-clusters-on-google-kubernetes-engine-b7c022c07510" rel="noopener">这个</a>用于手动设置集群，或者<a class="ae kf" href="https://registry.terraform.io/modules/gruntwork-io/gke/google/0.1.1/submodules/gke-cluster" rel="noopener ugc nofollow" target="_blank">使用terraform模块</a>。我们使用terraform来创建我们的集群。</p><p id="638c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">无论您如何操作，这里有一些重要的要点:</p><ul class=""><li id="c6eb" class="lg lh it ki b kj kk kn ko kr li kv lj kz lk ld ll lm ln lo bi translated">您将能够使用  <a class="ae kf" href="https://cloud.google.com/kubernetes-engine/docs/how-to/authorized-networks" rel="noopener ugc nofollow" target="_blank"> <strong class="ki iu"> <em class="ns">授权网络</em> </strong> </a> <strong class="ki iu">仅</strong>限制对主设备的访问，限制对内部网络或通过VPN的外部访问。</li><li id="fc2c" class="lg lh it ki b kj lp kn lq kr lr kv ls kz lt ld ll lm ln lo bi translated">您将能够<strong class="ki iu"> <em class="ns">为工作节点、单元和服务</em> </strong>分配IP范围。这可以用来确保分配的IP范围不会与您的内部网络发生冲突，如果您希望两者对等的话。谷歌为<a class="ae kf" href="https://cloud.google.com/kubernetes-engine/docs/how-to/flexible-pod-cidr" rel="noopener ugc nofollow" target="_blank">提供了一个确定集群规模的指南。</a></li></ul><p id="645d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，集群是安全的，只能通过可信网络访问，是时候安装Jenkins X了。</p><p id="c25b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">更新—2019年6月25日:<br/> </strong>感谢<a class="le lf ep" href="https://medium.com/u/5f3fdb3c45b6?source=post_page-----e1b9fcd8dd05--------------------------------" rel="noopener" target="_blank"> Hays Clark </a>的这个<a class="ae kf" href="https://kubernetes.slack.com/archives/C9MBGQJRH/p1561405754145600?thread_ts=1561188900.039500&amp;cid=C9MBGQJRH" rel="noopener ugc nofollow" target="_blank">提醒</a> :-)。<strong class="ki iu">如果在GKE </strong>上创建一个私有集群，你将不能从dockerhub等上拉映像，因为你的集群是私有的。要解决这个问题，只需按照本文中的<a class="ae kf" href="https://medium.com/google-cloud/using-cloud-nat-with-gke-cluster-c82364546d9e" rel="noopener">添加一个谷歌云NAT。</a></p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="0efc" class="mb mc it bd md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my bi translated">保护集群—第二点</h1><p id="000a" class="pw-post-body-paragraph kg kh it ki b kj mz kl km kn na kp kq kr nb kt ku kv nc kx ky kz nd lb lc ld im bi translated">Cloudbees的工作人员做得很好，他们用合理的默认值让安装Jenkins X变得尽可能简单。然而，为了能够在稍后的过程中使用<code class="fe nt nu nv nj b">*.domain.xyz</code>通配符证书，我们需要做出两个决定:</p><ul class=""><li id="19cc" class="lg lh it ki b kj kk kn ko kr li kv lj kz lk ld ll lm ln lo bi translated">我们需要使用一个真实的域(对于证书管理器<a class="ae kf" href="https://docs.cert-manager.io/en/latest/tasks/issuers/setup-acme/dns01/" rel="noopener ugc nofollow" target="_blank"> DNS挑战</a>)</li><li id="0e09" class="lg lh it ki b kj lp kn lq kr lr kv ls kz lt ld ll lm ln lo bi translated">我们需要将公开服务的<a class="ae kf" href="https://github.com/jenkins-x/exposecontroller/search?q=UrlTemplate&amp;unscoped_q=UrlTemplate" rel="noopener ugc nofollow" target="_blank"> urltemplate </a>从<br/> <code class="fe nt nu nv nj b">"{{.Service}}.{{.Namespace}}.{{.Domain}}"<br/></code>更改为<br/> <code class="fe nt nu nv nj b">"{{.Service}}-{{.Namespace}}.{{.Domain}}"</code> <br/>，这意味着每个名称空间都有一个新的子域。</li></ul><p id="2c07" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们的安装命令看起来像这样:</p><pre class="ne nf ng nh gt ni nj nk nl aw nm bi"><span id="7302" class="nn mc it nj b gy no np l nq nr">jx install - provider=gke \<br/> - git-username=${github_username} \<br/> - git-api-token=${github_api_token} \<br/> - default-admin-password=${default_admin_password} \<br/> - version=${jx_version} \<br/> - no-default-environments=true \<br/> - git-private=true \<br/> - no-tiller=false \<br/> - domain=${jx_domain} \<br/> - long-term-storage=false \<br/> - exposecontroller-urltemplate='"{{.Service}}-{{.Namespace}}.{{.Domain}}"' \<br/> - urltemplate='"{{.Service}}-{{.Namespace}}.{{.Domain}}"' \<br/> - buildpack=kubernetes-workloads \<br/> - batch-mode=true</span></pre><blockquote class="nw nx ny"><p id="5581" class="kg kh ns ki b kj kk kl km kn ko kp kq nz ks kt ku oa kw kx ky ob la lb lc ld im bi translated"><strong class="ki iu">重要提示:</strong>在安装过程中，将会创建<strong class="ki iu">jxing-nginx-ingress-controller</strong>服务。</p></blockquote><p id="366b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您需要创建指向以下内容的DNS记录(类型A ):</p><ul class=""><li id="7c70" class="lg lh it ki b kj kk kn ko kr li kv lj kz lk ld ll lm ln lo bi translated"><code class="fe nt nu nv nj b">YOUR-DOMAIN</code> &gt;负载平衡器ip</li><li id="b019" class="lg lh it ki b kj lp kn lq kr lr kv ls kz lt ld ll lm ln lo bi translated"><code class="fe nt nu nv nj b">*.YOUR-DOMAIN</code> &gt;负载平衡器ip</li></ul><p id="3f1d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以使用以下命令找到负载平衡器ip:</p><pre class="ne nf ng nh gt ni nj nk nl aw nm bi"><span id="ddf0" class="nn mc it nj b gy no np l nq nr">kubectl get svc jxing-nginx-ingress-controller -n kube-system -o'jsonpath={ .status.loadBalancer.ingress[0].ip }'</span></pre><p id="53df" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在短短几分钟内，我们就有了一个闪亮的新Jenkins X平台，并与<a class="ae kf" href="https://jenkins.io/" rel="noopener ugc nofollow" target="_blank"> Jenkins </a>、<a class="ae kf" href="https://www.sonatype.com/nexus-repository-sonatype" rel="noopener ugc nofollow" target="_blank"> Nexus </a>和众多其他服务一起在我们的安全集群中运行。</p><blockquote class="oc"><p id="56fb" class="od oe it bd of og oh oi oj ok ol ld dk translated">但是等等，服务只有http！？！</p></blockquote><p id="9404" class="pw-post-body-paragraph kg kh it ki b kj om kl km kn on kp kq kr oo kt ku kv op kx ky kz oq lb lc ld im bi translated">不要害怕，一个简单的<code class="fe nt nu nv nj b">jx upgrade ingress</code>执行所有必要的步骤来升级你的入口到我们的域上的https你可以在<a class="ae kf" href="https://technologyconversations.com/2019/05/31/upgrading-ingress-rules-and-adding-tls-certificates-with-jenkins-x" rel="noopener ugc nofollow" target="_blank">这篇由Viktor Farcic </a>写的文章中读到更多关于这个的内容。</p><p id="9827" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">几分钟后，https就可用了。不错！</p><blockquote class="oc"><p id="be4e" class="od oe it bd of og oh oi oj ok ol ld dk translated">但是坚持住，我所有的服务都是对全世界开放的！？！</p></blockquote><p id="0b00" class="pw-post-body-paragraph kg kh it ki b kj om kl km kn on kp kq kr oo kt ku kv op kx ky kz oq lb lc ld im bi translated">啊，当然！限制对主机的访问只能防止人们通过<code class="fe nt nu nv nj b">kubectl</code>访问集群。默认情况下，创建的任何入口都是打开的。</p><h1 id="2729" class="mb mc it bd md me or mg mh mi os mk ml mm ot mo mp mq ou ms mt mu ov mw mx my bi translated"><strong class="ak">限制对服务的访问</strong></h1><p id="7363" class="pw-post-body-paragraph kg kh it ki b kj mz kl km kn na kp kq kr nb kt ku kv nc kx ky kz nd lb lc ld im bi translated">在权衡我们的选择后，最实际的解决方案是从源头解决问题，即“jxing-nginx-ingress-controller”。</p><p id="5d5f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们使用了nginx的<a class="ae kf" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#whitelist-source-range" rel="noopener ugc nofollow" target="_blank"> <em class="ns">白名单-来源-范围</em> </a> <em class="ns"> </em>设置，它说:</p><blockquote class="nw nx ny"><p id="d3de" class="kg kh ns ki b kj kk kl km kn ko kp kq nz ks kt ku oa kw kx ky ob la lb lc ld im bi translated">您可以通过<code class="fe nt nu nv nj b">nginx.ingress.kubernetes.io/whitelist-source-range</code>注释指定允许的客户端IP源范围。该值是一个逗号分隔的<a class="ae kf" href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing" rel="noopener ugc nofollow" target="_blank">CIDR</a>列表，例如<code class="fe nt nu nv nj b">10.0.0.0/24,172.10.0..1,...</code>。</p><p id="6f4e" class="kg kh ns ki b kj kk kl km kn ko kp kq nz ks kt ku oa kw kx ky ob la lb lc ld im bi translated">为了对所有入口规则进行全局配置，可以在<a class="ae kf" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#whitelist-source-range" rel="noopener ugc nofollow" target="_blank"> NGINX配置图</a>中设置<code class="fe nt nu nv nj b">whitelist-source-range</code>值。</p><p id="53a7" class="kg kh ns ki b kj kk kl km kn ko kp kq nz ks kt ku oa kw kx ky ob la lb lc ld im bi translated"><strong class="ki iu">提示1: </strong>为了让webhooks工作，GitHub服务器也需要被列入白名单。你可以在这里找到他们。</p><p id="5c5a" class="kg kh ns ki b kj kk kl km kn ko kp kq nz ks kt ku oa kw kx ky ob la lb lc ld im bi translated"><strong class="ki iu">专业提示#2: </strong>不要忘记添加用于您的pod的ip范围(参见上面的VPC部分)。<br/>否则你会发现你自己的pods不能访问同一个集群内的服务URLs个小时的调试，直到我找到这个😅 ).</p></blockquote><p id="1c08" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，可以通过以下方式修补jxing-nginx-ingress-controller:</p><pre class="ne nf ng nh gt ni nj nk nl aw nm bi"><span id="19c8" class="nn mc it nj b gy no np l nq nr">kubectl patch configmap/jxing-nginx-ingress-controller \<br/>      — type merge \<br/>      -p '{"data" : {"whitelist-source-range" : "...CIDRS..."}}' \<br/>      -n kube-system</span></pre><p id="f0e1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该死的。没起作用！</p><p id="09ed" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">事实证明，要让这一切正常进行，GKE还需要一件东西。为了允许授权的IP范围，我们需要<a class="ae kf" href="https://kubernetes.io/docs/tasks/access-application-cluster/create-external-load-balancer/#preserving-the-client-source-ip" rel="noopener ugc nofollow" target="_blank">保留客户端源ip </a>。</p><p id="4744" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">幸运的是，这只是另一个简单的补丁。</p><pre class="ne nf ng nh gt ni nj nk nl aw nm bi"><span id="c1f9" class="nn mc it nj b gy no np l nq nr">kubectl patch svc jxing-nginx-ingress-controller \<br/>      -p '{"spec":{"externalTrafficPolicy":"Local"}}' \<br/>      -n kube-system</span></pre><h1 id="4640" class="mb mc it bd md me or mg mh mi os mk ml mm ot mo mp mq ou ms mt mu ov mw mx my bi translated">成功！</h1><figure class="ne nf ng nh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ow"><img src="../Images/b36f31094fba10441c220473c92ccc69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cMfm1tKMAROrePi--mLdxA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">没有VPN</figcaption></figure><p id="3b46" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们的集群和Jenkins X服务都被安全地打包在白名单IP范围的后面，现在是时候考虑OAuth集成了。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><p id="b951" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在接下来的几篇文章中，我将经历更多的冒险，包括:</p><ul class=""><li id="9180" class="lg lh it ki b kj kk kn ko kr li kv lj kz lk ld ll lm ln lo bi translated">管理Jenkins服务器、配置和作业</li><li id="7fbb" class="lg lh it ki b kj lp kn lq kr lr kv ls kz lt ld ll lm ln lo bi translated">为启用https的预览环境引入通配符证书</li><li id="e7c3" class="lg lh it ki b kj lp kn lq kr lr kv ls kz lt ld ll lm ln lo bi translated">管理定制nexus存储库和配置</li><li id="4e37" class="lg lh it ki b kj lp kn lq kr lr kv ls kz lt ld ll lm ln lo bi translated">…可能还有其他事情，比如集成<a class="ae kf" href="https://gitversion.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> GitVersion </a>来使用<a class="ae kf" href="https://nvie.com/posts/a-successful-git-branching-model/" rel="noopener ugc nofollow" target="_blank"> GitFlow </a>跟踪我们的应用版本。不过先看看我们是如何做到的:-)吧</li></ul><p id="8df0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">直到下一集...</p></div></div>    
</body>
</html>