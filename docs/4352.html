<html>
<head>
<title>Source Code Walkthrough of Telegram-iOS Part 5: AsyncDisplayKit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">电报源代码演练-iOS第5部分:AsyncDisplayKit</h1>
<blockquote>原文：<a href="https://itnext.io/source-code-walkthrough-of-telegram-ios-part-5-asyncdisplaykit-8c6a209da681?source=collection_archive---------1-----------------------#2020-06-14">https://itnext.io/source-code-walkthrough-of-telegram-ios-part-5-asyncdisplaykit-8c6a209da681?source=collection_archive---------1-----------------------#2020-06-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><blockquote class="jn jo jp"><p id="ae08" class="jq jr js jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated"><a class="ae kp" href="https://hubo.dev/2020-06-14-source-code-walkthrough-of-telegram-ios-part-5/" rel="noopener ugc nofollow" target="_blank"> hubo.dev </a>之镜</p></blockquote><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi kq"><img src="../Images/c343d0f4b593e475a50de75b1b826b77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0xW8-SfZgmU23eo4BIPvTA.png"/></div></div></figure><p id="11e0" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi lf translated">elegram-iOS基于AsyncDisplayKit构建了大部分ui。它被称为该项目的<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/tree/release-6.1.2/submodules/AsyncDisplayKit" rel="noopener ugc nofollow" target="_blank">子模块</a>，其中许多功能已被移除，其中一些功能在Swift中重新实现。这篇文章讨论了项目中的组件结构和UI编程模式。</p><h1 id="0199" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">1.概观</h1><p id="8565" class="pw-post-body-paragraph jq jr iq jt b ju mm jw jx jy mn ka kb lc mo ke kf ld mp ki kj le mq km kn ko ij bi translated">AsyncDisplayKit是一个异步UI框架，最初<a class="ae kp" href="https://engineering.fb.com/ios/introducing-asyncdisplaykit-for-smooth-and-responsive-apps-on-ios/" rel="noopener ugc nofollow" target="_blank">诞生于脸书</a>。是Pinterest 采用的<a class="ae kp" href="https://medium.com/pinterest-engineering/introducing-texture-a-new-home-for-asyncdisplaykit-e7c003308f50" rel="noopener">，2017年更名为</a><a class="ae kp" href="https://texturegroup.org/" rel="noopener ugc nofollow" target="_blank">纹理</a>。它的核心概念是使用<code class="fe mr ms mt mu b"><a class="ae kp" href="https://texturegroup.org/docs/getting-started.html" rel="noopener ugc nofollow" target="_blank">node</a></code>作为<code class="fe mr ms mt mu b">UIView</code>的抽象，这有点类似于React Virtual DOM的想法。节点是线程安全的，这有助于将昂贵的UI操作移出主线程，如图像解码、文本大小调整等。节点也是轻量级的，这允许您在表和集合中不重用单元格。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi mv"><img src="../Images/122dd5885f9943dbee3f72a38d35e6a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JbCF2EYgTVpMvsLsDT6wmg.png"/></div></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">民间AsyncDisplayKit的结构</figcaption></figure><p id="08f5" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated">如图所示，Telegram-iOS保留了大约35%的代码，用蓝框表示，并从正式版本中删除了其他代码。</p><ul class=""><li id="7302" class="na nb iq jt b ju jv jy jz lc nc ld nd le ne ko nf ng nh ni bi translated">从上游合并的最新提交是<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TextureGroup/Texture/commit/ae2b3af9" rel="noopener ugc nofollow" target="_blank">ae2b3af9</a></code></li><li id="5b4d" class="na nb iq jt b ju nj jy nk lc nl ld nm le nn ko nf ng nh ni bi translated">像<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/AsyncDisplayKit/Source/ASDisplayNode.mm" rel="noopener ugc nofollow" target="_blank">ASDisplayNode</a></code>、<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/AsyncDisplayKit/Source/ASControlNode.mm" rel="noopener ugc nofollow" target="_blank">ASControlNode</a></code>、<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/AsyncDisplayKit/Source/ASEditableTextNode.mm" rel="noopener ugc nofollow" target="_blank">ASEditableTextNode</a></code>和<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/AsyncDisplayKit/Source/ASScrollNode.mm" rel="noopener ugc nofollow" target="_blank">ASScrollNode</a></code>这样的基本节点大部分是完整的。</li><li id="f3b6" class="na nb iq jt b ju nj jy nk lc nl ld nm le nn ko nf ng nh ni bi translated"><code class="fe mr ms mt mu b"><a class="ae kp" href="https://texturegroup.org/docs/image-node.html" rel="noopener ugc nofollow" target="_blank">ASImageNode</a></code>及其子类被删除。Telegram使用MTProto而不是HTTPS从数据中心下载文件。正式版的<a class="ae kp" href="https://texturegroup.org/docs/network-image-node.html" rel="noopener ugc nofollow" target="_blank">网络镜像支持</a>没有用，所以对<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/pinterest/PINRemoteImage" rel="noopener ugc nofollow" target="_blank">PINRemoteImage</a></code>的依赖也被删除了。</li><li id="9f20" class="na nb iq jt b ju nj jy nk lc nl ld nm le nn ko nf ng nh ni bi translated">移除所有正式的<a class="ae kp" href="https://texturegroup.org/docs/containers-overview.html" rel="noopener ugc nofollow" target="_blank">节点容器</a>，如<code class="fe mr ms mt mu b"><a class="ae kp" href="https://texturegroup.org/docs/containers-ascollectionnode.html" rel="noopener ugc nofollow" target="_blank">ASCollectionNode</a></code>、<code class="fe mr ms mt mu b"><a class="ae kp" href="https://texturegroup.org/docs/containers-astablenode.html" rel="noopener ugc nofollow" target="_blank">ASTableNode</a></code>、<code class="fe mr ms mt mu b"><a class="ae kp" href="https://texturegroup.org/docs/containers-asviewcontroller.html" rel="noopener ugc nofollow" target="_blank">ASViewController</a></code>等。节点上的表和视图控制器在Swift中重新实现，不依赖<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TextureGroup/Texture/blob/master/Source/Layout/ASLayout%2BIGListDiffKit.h" rel="noopener ugc nofollow" target="_blank">IGListKit</a></code>。</li><li id="88c4" class="na nb iq jt b ju nj jy nk lc nl ld nm le nn ko nf ng nh ni bi translated">该项目更喜欢手动布局。受CSS Flexbox 启发的<a class="ae kp" href="https://texturegroup.org/docs/layout2-quickstart.html" rel="noopener ugc nofollow" target="_blank">官方布局API去掉了，</a><a class="ae kp" href="https://texturegroup.org/development/layout-specs.html" rel="noopener ugc nofollow" target="_blank"> yoga引擎</a>也去掉了。</li><li id="4d23" class="na nb iq jt b ju nj jy nk lc nl ld nm le nn ko nf ng nh ni bi translated">移除内部<a class="ae kp" href="https://texturegroup.org/development/how-to-debug.html" rel="noopener ugc nofollow" target="_blank">测井和调试</a>支架。</li></ul><p id="aec3" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated">基本上来说，Telegram-iOS保留了核心节点系统的最小集合，然后用数百个节点子类对其进行扩展。代码分布在子模块中，如<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/tree/release-6.1.2/submodules/Display" rel="noopener ugc nofollow" target="_blank">Display</a></code>、<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/tree/release-6.1.2/submodules/TelegramUI" rel="noopener ugc nofollow" target="_blank">TelegramUI</a></code>、<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/tree/release-6.1.2/submodules/ItemListUI" rel="noopener ugc nofollow" target="_blank">ItemListUI</a></code>和其他支持主电报UI特性的子模块。</p><h1 id="69f7" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">2.核心节点</h1><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi no"><img src="../Images/3ffe42ee5db7f9d49c8a693585de12f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J8c8NvQV6_wszAFqlEzS5Q.png"/></div></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">核心节点类</figcaption></figure><p id="daf6" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated">有几个节点类作为构建应用程序用户界面的基本块。让我们按照图表中所列来检查它们。</p><blockquote class="jn jo jp"><p id="a4ff" class="jq jr js jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">带箭头的边表示右边的节点是左边节点的子类。没有边的同一级别的节点意味着它们与最左边的节点共享同一个父类。</p></blockquote><h2 id="2620" class="np lp iq bd lq nq nr dn lu ns nt dp ly lc nu nv mc ld nw nx mg le ny nz mk oa bi translated">文本</h2><p id="e04d" class="pw-post-body-paragraph jq jr iq jt b ju mm jw jx jy mn ka kb lc mo ke kf ld mp ki kj le mq km kn ko ij bi translated"><code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/TextNode.swift#L775" rel="noopener ugc nofollow" target="_blank">TextNode</a></code>、<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/ImmediateTextNode.swift#L9" rel="noopener ugc nofollow" target="_blank">ImmediateTextNode</a></code>、<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/ImmediateTextNode.swift#L199" rel="noopener ugc nofollow" target="_blank">ASTextNode</a></code>负责文本渲染。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ob oc l"/></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">文本节点</figcaption></figure><p id="4b8d" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated"><code class="fe mr ms mt mu b">TextNode</code>利用<code class="fe mr ms mt mu b">CoreText</code>渲染一个<code class="fe mr ms mt mu b">NSAttributedString</code>。它有一个方法<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/TextNode.swift#L826" rel="noopener ugc nofollow" target="_blank">calculateLayout</a></code>来计算基于行的文本布局，并覆盖类方法<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/TextNode.swift#L1084" rel="noopener ugc nofollow" target="_blank">draw</a></code>来呈现文本。公共类方法<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/TextNode.swift#L1198" rel="noopener ugc nofollow" target="_blank">asyncLayout</a></code>用于异步调用布局计算并缓存结果。通过设计调用<code class="fe mr ms mt mu b">asyncLayout</code>是被调用者的责任。否则，它不会呈现任何内容，因为缓存的布局为零。实现支持<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/TextNode.swift#L32" rel="noopener ugc nofollow" target="_blank"> RTL </a>和<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/TextNode.swift#L668" rel="noopener ugc nofollow" target="_blank">可访问性</a>也很棒。</p><p id="f825" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated"><code class="fe mr ms mt mu b">ImmediateTextNode</code>通过添加更多属性来控制文本布局样式，丰富了<code class="fe mr ms mt mu b">TextNode</code>。它还支持链接高亮显示和点击操作。</p><p id="a909" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated"><code class="fe mr ms mt mu b">ASTextNode</code>在设置属性<code class="fe mr ms mt mu b">attributedText</code>时简单更新布局。它不是AsyncDisplayKit项目中的<a class="ae kp" href="https://texturegroup.org/docs/text-node.html" rel="noopener ugc nofollow" target="_blank">同一个</a>,尽管它共享相同的类名。</p><p id="ca6b" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated"><code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/EditableTextNode.swift#L5" rel="noopener ugc nofollow" target="_blank">EditableTextNode</a></code>扩展<code class="fe mr ms mt mu b">ASEditableTextNode</code>以支持RTL输入检测。</p><h2 id="0ec6" class="np lp iq bd lq nq nr dn lu ns nt dp ly lc nu nv mc ld nw nx mg le ny nz mk oa bi translated">图像</h2><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ob oc l"/></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">图像节点</figcaption></figure><p id="4593" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated"><code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/Nodes/ASImageNode.swift#L5" rel="noopener ugc nofollow" target="_blank">ASImageNode</a></code>渲染一个<code class="fe mr ms mt mu b">UIImage</code>并使用图像大小作为其节点大小。同样不是官方项目中的<a class="ae kp" href="https://texturegroup.org/docs/image-node.html" rel="noopener ugc nofollow" target="_blank">同级</a>。</p><p id="db6c" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated"><code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/ImageNode.swift#L124" rel="noopener ugc nofollow" target="_blank">ImageNode</a></code>接受信号异步设置图像内容。虽然名字看起来很普通，但却是<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/AvatarNode/Sources/AvatarNode.swift#L216" rel="noopener ugc nofollow" target="_blank">AvatarNode</a></code>专用的。</p><p id="f0e3" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated"><code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/176e4eaad7505b12c86a400b9da6903695b3bc35/submodules/Display/Source/TransformImageNode.swift#L17" rel="noopener ugc nofollow" target="_blank">TransformImageNode</a></code>是异步图像最广泛使用的类。它支持改变图像的阿尔法动画，并支持颜色覆盖。</p><h2 id="a0c8" class="np lp iq bd lq nq nr dn lu ns nt dp ly lc nu nv mc ld nw nx mg le ny nz mk oa bi translated">纽扣</h2><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ob oc l"/></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">按钮节点</figcaption></figure><p id="4c9f" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated"><code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/Nodes/ButtonNode.swift#L5" rel="noopener ugc nofollow" target="_blank">ASButtonNode</a></code>模拟一个带有图像和标题的按钮，有三种状态:正常、高亮和禁用。</p><p id="a070" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated"><code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/HighlightableButton.swift#L87" rel="noopener ugc nofollow" target="_blank">HighlightableButtonNode</a></code>在跟踪按钮时添加高亮动画。</p><h2 id="309f" class="np lp iq bd lq nq nr dn lu ns nt dp ly lc nu nv mc ld nw nx mg le ny nz mk oa bi translated">状态</h2><p id="2fa6" class="pw-post-body-paragraph jq jr iq jt b ju mm jw jx jy mn ka kb lc mo ke kf ld mp ki kj le mq km kn ko ij bi translated"><code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/ActivityIndicator/Sources/ActivityIndicator.swift#L57" rel="noopener ugc nofollow" target="_blank">ActivityIndicator</a></code>复制了<code class="fe mr ms mt mu b">UIActivityIndicatorView</code>的风格，并提供灵活的选项来定制细节，如<a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/ActivityIndicator/Sources/ActivityIndicator.swift#L64" rel="noopener ugc nofollow" target="_blank">颜色、直径和线宽</a>。</p><h2 id="8266" class="np lp iq bd lq nq nr dn lu ns nt dp ly lc nu nv mc ld nw nx mg le ny nz mk oa bi translated">媒体</h2><p id="3cb3" class="pw-post-body-paragraph jq jr iq jt b ju mm jw jx jy mn ka kb lc mo ke kf ld mp ki kj le mq km kn ko ij bi translated">Telegram-iOS实现了一组丰富的组件来支持不同的媒体类型。这篇文章只是一瞥。这个系列值得专门写一篇，包括FFMpeg集成，第三方视频网站的应用内视频播放，贴纸动画等。</p><p id="fa6c" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated"><code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/MediaPlayer/Sources/MediaPlayerNode.swift#L54" rel="noopener ugc nofollow" target="_blank">MediaPlayNode</a></code>是子模块<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/tree/release-6.1.2/submodules/MediaPlayer" rel="noopener ugc nofollow" target="_blank">MediaPlayer</a></code>中的一个节点类，用于在<code class="fe mr ms mt mu b">AVSampleBufferDisplayLayer</code>上渲染视频帧。</p><p id="c526" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated"><code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/TelegramUniversalVideoContent/Sources/WebEmbedPlayerNode.swift#L63" rel="noopener ugc nofollow" target="_blank">WebEmbedPlayerNode</a></code>通过嵌入<code class="fe mr ms mt mu b">WKWebView</code>播放网页中的视频。它支持来自Youtube、Vimeo、Twitch等的视频。</p><p id="269f" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated"><code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/AnimatedStickerNode/Sources/AnimatedStickerNode.swift#L385" rel="noopener ugc nofollow" target="_blank">AnimatedStickerNode</a></code>播放来自<code class="fe mr ms mt mu b">AnimatedStickerNodeSource</code>的华丽动画。</p><h2 id="32b2" class="np lp iq bd lq nq nr dn lu ns nt dp ly lc nu nv mc ld nw nx mg le ny nz mk oa bi translated">酒吧</h2><p id="5db9" class="pw-post-body-paragraph jq jr iq jt b ju mm jw jx jy mn ka kb lc mo ke kf ld mp ki kj le mq km kn ko ij bi translated"><code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/SearchBarNode/Sources/SearchBarNode.swift#L253" rel="noopener ugc nofollow" target="_blank">SearchBarNode</a></code>、<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/NavigationBar.swift#L105" rel="noopener ugc nofollow" target="_blank">NavigationBar</a></code>、<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/TabBarNode.swift#L303" rel="noopener ugc nofollow" target="_blank">TabBarNode</a></code>和<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/ToolbarNode.swift#L5" rel="noopener ugc nofollow" target="_blank">ToolbarNode</a></code>模仿UIKit对应物的特征。它还消除了操作系统版本之间不一致行为的影响，这是一个令人不快的问题，因为UIKit内部对开发人员来说是不可见的。</p><p id="74ec" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated"><code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/StatusBar.swift#L66" rel="noopener ugc nofollow" target="_blank">StatusBar</a></code>在系统状态栏区域显示通话中文本通知。</p><h2 id="421b" class="np lp iq bd lq nq nr dn lu ns nt dp ly lc nu nv mc ld nw nx mg le ny nz mk oa bi translated">目录</h2><p id="a676" class="pw-post-body-paragraph jq jr iq jt b ju mm jw jx jy mn ka kb lc mo ke kf ld mp ki kj le mq km kn ko ij bi translated">是为滚动列表设计的最复杂的节点类之一。它利用一个隐藏的<code class="fe mr ms mt mu b">UIScrollView</code>，并借用它的平移手势来获得滚动行为，就像我们从<a class="ae kp" href="https://asciiwwdc.com/2014/sessions/235" rel="noopener ugc nofollow" target="_blank"> WWDC 2014 </a>中学到的一样。除了管理列表中项目的可见性，无论项目是小还是大，它还提供了额外的简洁功能，如方便的项目标题、可定制的滚动指示器、记录项目、滚动节点、捕捉边界等。</p><p id="c94d" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated"><code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/GridNode.swift#L208" rel="noopener ugc nofollow" target="_blank">GridNode</a></code>是另一个用于网格布局的滚动UI组件。它支持贴纸选择屏幕、壁纸设置等功能。</p><h1 id="9b62" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">3.控制器</h1><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi od"><img src="../Images/8e75c72dd31865a2461573d95a3fc737.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GkTMdJ8olDgIUWpB1yvKPw.png"/></div></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">通用控制器</figcaption></figure><p id="5130" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated"><code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/ViewController.swift#L76" rel="noopener ugc nofollow" target="_blank">ViewController</a></code>使<code class="fe mr ms mt mu b">UIViewController</code>成为节点层次结构的容器。与官方的节点控制器类<code class="fe mr ms mt mu b"><a class="ae kp" href="https://texturegroup.org/docs/containers-asviewcontroller.html" rel="noopener ugc nofollow" target="_blank">ASViewController</a></code>不同，它没有像<a class="ae kp" href="https://texturegroup.org/docs/asvisibility.html" rel="noopener ugc nofollow" target="_blank">可见深度</a>和<a class="ae kp" href="https://texturegroup.org/docs/intelligent-preloading.html" rel="noopener ugc nofollow" target="_blank">智能预加载</a>这样的特性。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ob oc l"/></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">视图控制器</figcaption></figure><p id="266e" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated">每个ViewController通过一个根内容节点来管理节点层次结构，该节点存储在该类的<code class="fe mr ms mt mu b">displayNode</code>属性中。有函数<code class="fe mr ms mt mu b">loadDisplayNode</code>和<code class="fe mr ms mt mu b">displayNodeDidLoad</code>可以实现与我们在<code class="fe mr ms mt mu b">UIViewController</code>中所熟悉的相同的惰性视图加载行为。</p><p id="fdd5" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated">作为基类，它为子类准备了几个共享节点组件:一个状态栏、一个导航栏、一个工具栏和一个<code class="fe mr ms mt mu b">scrollToTopView</code>。还有方便的属性来定制它的导航栏这对于一个普通的<code class="fe mr ms mt mu b">UIViewController</code>来说还是一个繁琐的问题。</p><p id="e337" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated"><code class="fe mr ms mt mu b">ViewController</code>很少单独使用，项目中有超过100个控制器子类用于不同的用户界面。UIKit中最常用的两个容器控制器<code class="fe mr ms mt mu b">UINavigationController</code>和<code class="fe mr ms mt mu b">UITabBarController</code>，被重新实现为<code class="fe mr ms mt mu b">NavigationController</code>和<code class="fe mr ms mt mu b">TabBarController</code>。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ob oc l"/></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">导航控制器</figcaption></figure><p id="0a20" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated"><code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/Navigation/NavigationController.swift#L105" rel="noopener ugc nofollow" target="_blank">NavigationController</a></code>扩展了<code class="fe mr ms mt mu b">UINavigationController</code>来借用它的公共API，因为它可能与普通的视图控制器一起工作。它在内部重建一切，包括以下内容:</p><ul class=""><li id="2e44" class="na nb iq jt b ju jv jy jz lc nc ld nd le ne ko nf ng nh ni bi translated">子控制器的直接管理。由于它只是一个简单的数组，所以它可以自由地调整堆栈操作的一些边缘情况。</li><li id="7c4d" class="na nb iq jt b ju nj jy nk lc nl ld nm le nn ko nf ng nh ni bi translated">过渡动画。你可以在<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/ContainedViewLayoutTransition.swift#L65" rel="noopener ugc nofollow" target="_blank">ContainedViewLayoutTransition</a></code>里找到所有的动画细节。</li><li id="fea4" class="na nb iq jt b ju nj jy nk lc nl ld nm le nn ko nf ng nh ni bi translated">互动流行手势。添加了一个<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/InteractiveTransitionGestureRecognizer.swift#L62" rel="noopener ugc nofollow" target="_blank">InteractiveTransitionGestureRecognizer</a></code>,使弹出手势能够应用于所有屏幕区域。</li><li id="f23b" class="na nb iq jt b ju nj jy nk lc nl ld nm le nn ko nf ng nh ni bi translated">iPad等大屏幕的分割母版细节布局。它支持两种布局:<code class="fe mr ms mt mu b">flat</code>和<code class="fe mr ms mt mu b">split</code>。很高兴有一个容器控制器来支持iPhone和iPad，而不是在<code class="fe mr ms mt mu b">UISplitViewController</code>上耗费精力。</li><li id="4972" class="na nb iq jt b ju nj jy nk lc nl ld nm le nn ko nf ng nh ni bi translated">主题。通过属性<code class="fe mr ms mt mu b">theme</code>很容易定制外观和感觉。</li></ul><p id="fa9f" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated"><code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/TabBarController.swift#L75" rel="noopener ugc nofollow" target="_blank">TabBarController</a></code>只在根屏幕中使用，所以它是<code class="fe mr ms mt mu b">ViewController</code>而不是<code class="fe mr ms mt mu b">UITabBarController</code>的子类，因为不需要保存API。同样的规则也适用于<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/ActionSheetController.swift#L4" rel="noopener ugc nofollow" target="_blank">ActionSheetController</a></code>、<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/AlertController.swift#L70" rel="noopener ugc nofollow" target="_blank">AlertController</a></code>和<code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/Display/Source/ContextMenuController.swift#L15" rel="noopener ugc nofollow" target="_blank">ContextMenuController</a></code>。该实现完美地涵盖了系统视图控制器内部的细节，用户体验几乎与用户IMO相同。</p><p id="0be0" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lc kd ke kf ld kh ki kj le kl km kn ko ij bi translated">通过管理一个<code class="fe mr ms mt mu b">ListView</code><code class="fe mr ms mt mu b"><a class="ae kp" href="https://github.com/TelegramMessenger/Telegram-iOS/blob/release-6.1.2/submodules/ItemListUI/Sources/ItemListController.swift#L105" rel="noopener ugc nofollow" target="_blank">ItemListController</a></code>相当于<code class="fe mr ms mt mu b">UITableViewController</code>。它还支持自定义覆盖节点、搜索视图和重新排序项目。</p><h1 id="e554" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">4.布局</h1><p id="251e" class="pw-post-body-paragraph jq jr iq jt b ju mm jw jx jy mn ka kb lc mo ke kf ld mp ki kj le mq km kn ko ij bi translated">AsyncDisplayKit中的Flexbox布局系统被混合布局机制所取代:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ob oc l"/></div></figure><ul class=""><li id="2511" class="na nb iq jt b ju jv jy jz lc nc ld nd le ne ko nf ng nh ni bi translated">所有布局都是手动完成的。很明显，工程师们不喜欢自动布局的概念。</li><li id="e893" class="na nb iq jt b ju nj jy nk lc nl ld nm le nn ko nf ng nh ni bi translated">布局计算在简单ui的主线程中运行。布局代码可以放在用于节点的<code class="fe mr ms mt mu b">layout</code>方法中，或者放在用于视图控制器的<code class="fe mr ms mt mu b">containerLayoutUpdated</code>方法中。</li><li id="2173" class="na nb iq jt b ju nj jy nk lc nl ld nm le nn ko nf ng nh ni bi translated"><code class="fe mr ms mt mu b">ListView</code>为项目节点建立灵活的布局机制，支持同步和异步计算。</li></ul><h1 id="0f5d" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">5.结论</h1><p id="b9e9" class="pw-post-body-paragraph jq jr iq jt b ju mm jw jx jy mn ka kb lc mo ke kf ld mp ki kj le mq km kn ko ij bi translated">Telegram集成AsyncDisplayKit的方法给我留下了深刻的印象。为了效率和完全控制，它在节点上重建了整个UIKit组件系列。聊天消息列表在旧设备上感觉很流畅，尽管气泡界面呈现起来很复杂。处理系统升级债务的代码很少，每年WWDC之后总要耗费大部分工程师的一些“快乐时光”。让我们看看在两周后的第一次在线WWDC后，可能会打破什么。</p></div></div>    
</body>
</html>