<html>
<head>
<title>Getting started with Otomi</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Otomi入门</h1>
<blockquote>原文：<a href="https://itnext.io/getting-started-with-otomi-a82d361330a2?source=collection_archive---------1-----------------------#2021-10-09">https://itnext.io/getting-started-with-otomi-a82d361330a2?source=collection_archive---------1-----------------------#2021-10-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="0bef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Otomi是Kubernetes的一个单一包，包括Istio、Knative、Prometheus、Harbor、Keycloak、Nginx ingress、External-DNS、Cert-manager、Hashicorp Vault、Gatekeeper、Drone、Gitea等项目，并将它们与大量自动化和类似桌面的用户界面相结合。所有集成的项目都是预先配置的，这意味着它们在安装Otomi后就可以开箱即用。使用Otomi，您将在20分钟内获得基于任何Kubernetes集群的完整企业级平台体验。点击阅读更多关于Otomi <a class="ae kl" href="https://otomi.io" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><p id="0b18" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇文章中，我将通过解释如何安装Otomi和创建一个服务来展示开始使用Otomi是多么容易。在这个例子中，我将在AKS上安装Otomi。</p><h2 id="a64b" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">属国</h2><p id="d65d" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">要在AKS上安装Otomi，目前有一个依赖项。您需要能够访问DNS区域。这种依赖将很快被移除，允许您在没有任何外部依赖的情况下使用Otomi。</p><p id="5a82" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个例子中，我不打算使用KMS(加密配置值存储库中的密码)，也不打算使用OIDC(将Azure Active Directory用作IDP)。这两个选项都是可选的。当你不使用OIDC时，默认情况下，Otomi会将Keycloak配置为IDP。</p><h2 id="8b3f" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">安装Otomi</h2><p id="9232" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">首先，我们需要访问一个正在运行的AKS集群。对于这个例子，我使用Azure门户快速创建了一个</p><ul class=""><li id="3110" class="lk ll iq jp b jq jr ju jv jy lm kc ln kg lo kk lp lq lr ls bi translated">最新可用的Kubernetes版本(1.20.9)</li><li id="8ad2" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated">3个Standard_D3_v2实例的节点池</li><li id="63c5" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated">自动缩放(最小3，最大5)</li><li id="e844" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated">蔚蓝CNI</li><li id="d4a1" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated">RBAC已启用(必需)</li><li id="f33c" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated">Azure策略和Azure监视器已禁用</li></ul><p id="5f10" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，Otomi提供了一套完整的策略，因此不需要添加Azure policy插件，并且因为Otomi提供了Prometheus和Loki，所以不需要使用Azure Monitor。</p><p id="a930" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">AKS正在运行，所以让我们获取凭证:</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="2137" class="km kn iq md b gy mh mi l mj mk">az aks get-credentials — resource-group otomi-aks-demo — name otomi-aks-demo — admin</span></pre><p id="44ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们看看节点是否准备好了:</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="d7b1" class="km kn iq md b gy mh mi l mj mk">kubectl get nodes                                                                 <br/>NAME                                STATUS   ROLES   AGE   VERSION<br/>aks-agentpool-14128372-vmss000000   Ready    agent   77s   v1.20.9<br/>aks-agentpool-14128372-vmss000001   Ready    agent   91s   v1.20.9<br/>aks-agentpool-14128372-vmss000002   Ready    agent   83s   v1.20.9</span></pre><p id="27f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们现在需要做的唯一事情是设置一个DNS区域，创建一个服务主体，并将SP指定为DNS区域资源组的读取者和DNS区域本身的贡献者。完整的设置说明可以在<a class="ae kl" href="https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/azure.md" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="d95d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要使用Helm Chart安装Otomi，我们现在首先必须创建一个“values.yaml”文件。在本例中，我使用了以下值:</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="a094" class="km kn iq md b gy mh mi l mj mk">cluster:<br/>  domainSuffix: demo.aks.redkubes.net<br/>  k8sVersion: "1.20"<br/>  name: demo<br/>  owner: redkubes<br/>  provider: azure</span><span id="95d7" class="km kn iq md b gy ml mi l mj mk">otomi:<br/>  adminPassword: mypassword<br/>  hasExternalDNS: true</span><span id="f69c" class="km kn iq md b gy ml mi l mj mk">dns:<br/>  provider:<br/>    azure:<br/>      resourceGroup: external-dns<br/>      aadClientId: #################<br/>      aadClientSecret: #################<br/>      tenantId: #################<br/>      subscriptionId: #################</span><span id="b62c" class="km kn iq md b gy ml mi l mj mk">charts:<br/>  cert-manager:<br/>    email: admins@redkubes.com<br/>    stage: production<br/>  external-dns:<br/>    domainFilters:<br/>      - aks.redkubes.net</span></pre><p id="d894" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如你所见，我的DNS区域是aks.redkubes.net，域名后缀是demo.aks.redkubes.net，这意味着Otomi将为所有端点创建主机名，产生的URL如Otomi控制台的otomi.demo.aks.redkubes.net和Keycloak的keycloak.demo.aks.redkubes.net。</p><p id="ba75" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们安装图表。首先，添加Otomi Helm repo并更新repo:</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="9ef2" class="km kn iq md b gy mh mi l mj mk">helm repo add otomi <a class="ae kl" href="https://otomi.io/otomi-core" rel="noopener ugc nofollow" target="_blank">https://otomi.io/otomi-core</a></span><span id="66bd" class="km kn iq md b gy ml mi l mj mk">helm repo update</span></pre><p id="868f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后安装图表:</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="ace9" class="km kn iq md b gy mh mi l mj mk">helm install -f values.yaml otomi otomi/otomi<br/>NAME: otomi<br/>LAST DEPLOYED: Sat Oct  9 09:36:43 2021<br/>NAMESPACE: default<br/>STATUS: deployed<br/>REVISION: 1<br/>TEST SUITE: None<br/>NOTES:<br/>The Otomi installer was successfully deployed on the cluster.</span><span id="cf50" class="km kn iq md b gy ml mi l mj mk">Please inspect the output of the installer job (default/otomi) for any feedback or errors.</span><span id="2f8f" class="km kn iq md b gy ml mi l mj mk">Also visit otomi.io for further instructions and reference documentation.</span></pre><p id="c1e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了监控安装的进度，我通常使用K9s。Otomi安装程序在默认名称空间中作为Kubernetes作业运行。</p><p id="7230" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装完成后(通常需要20分钟左右)，首先需要做的是在Keycloak中创建一个用户，并为该用户分配一个Keycloak角色(由Otomi创建)。为此，您首先需要登录到Keycloak，因此我将转到keycloak.demo.aks.redkubes.net，使用图表值中提供的<code class="fe mm mn mo md b">admin</code>用户和密码登录。</p><figure class="ly lz ma mb gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi mp"><img src="../Images/61014ce5f98f48e489858d06f5069845.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cXe1eUexSrFimji-x2ZKzQ.png"/></div></div></figure><p id="7c36" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">确保在Keycloak中选择了Otomi领域，然后创建一个用户。用户至少需要有一个电子邮件地址。然后你可以将用户分配到一个默认的Otomi组中(T1组和T2组)。如需完整说明，请查看此处的Otomi文档<a class="ae kl" href="https://otomi.io/docs/installation/post-install-actions" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="74ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我可以登录到Otomi控制台。在我的例子中，控制台的URL是otomi.demo.aks.redkubes.net</p><figure class="ly lz ma mb gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi mx"><img src="../Images/ada26c25d9c5021d7069e9c4fa4441ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h7iwWnSX40AXr-BRA1hNXg.png"/></div></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">Otomi控制台中所有应用程序的快捷键</figcaption></figure><p id="67c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要开始使用控制台，我们现在首先要启用无人机。Drone用于将所需状态(由Otomi API创建的新配置代码)自动同步到集群。要启用Drone，首先登录Gitea，使用<code class="fe mm mn mo md b">otomi-admin</code> Gitea用户帐户(由Otomi创建)和values中提供的密码。</p><p id="0c78" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后进入无人机(使用Otomi控制台中的快捷键)。你会看到Otomi创建的<code class="fe mm mn mo md b">otomi/values</code>库。现在点击<code class="fe mm mn mo md b">activate</code>，再点击<code class="fe mm mn mo md b">activate repository</code>，再点击<code class="fe mm mn mo md b">save</code>。现在我们准备好使用Otomi控制台，创建一个团队并部署我们的第一个应用程序。</p><p id="8172" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要在Otomi中创建一个新的服务(用于部署应用程序和/或公开服务)，我们首先需要创建一个团队。在Otomi控制台中，点击右侧菜单中的团队，然后点击<code class="fe mm mn mo md b">Create team</code>。我正在创建一个名为“测试”的团队，我将使用所有默认设置:</p><figure class="ly lz ma mb gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi nc"><img src="../Images/beab0788a229479c11b07a184f0a6054.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vw4hUhINxHEx1e5PUvK_QA.png"/></div></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">用Otomi控制台创建团队</figcaption></figure><p id="78ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">默认情况下，Otomi配置了多租户选项。这意味着每个团队都有自己的监控、警报、日志等等。我现在不打算在这里讨论所有的多租户细节。</p><p id="03df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在只需按回车键或点击<code class="fe mm mn mo md b">Submit</code>，然后点击<code class="fe mm mn mo md b">Deply changes</code>。要查看团队创建的进度，请访问无人机。您将看到一个管道自动开始创建团队。现在，等待管道完成，这将需要几分钟时间。创建团队后，注意Otomi为团队创建了一个新角色(在本例中称为<code class="fe mm mn mo md b">team-test</code>)。现在，您可以创建更多用户，并只允许他们访问团队。</p><p id="f1c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，现在我们准备创建我们的第一个服务。</p><p id="09f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Otomi控制台(顶部栏)中，选择您的团队。在我的案例中，团队“测试”。在右边的菜单中，你会看到团队选项。点击<code class="fe mm mn mo md b">Services</code>，然后点击<code class="fe mm mn mo md b">Create service</code>。添加一个名称(如果您正在创建一个服务来公开预先部署的Kubernetes服务，请确保该名称与预先部署的Kubernetes服务的名称相匹配，选择<code class="fe mm mn mo md b">Public</code>(公开公开服务)并使用所有默认设置。在<code class="fe mm mn mo md b">Service type</code>下选择<code class="fe mm mn mo md b">New knative service</code>。该选项允许您部署一个映像，Otomi将在其中自动创建一个新的Knative服务。</p><p id="7020" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将部署标签为<code class="fe mm mn mo md b">stable</code>的<code class="fe mm mn mo md b">nginxinc/nginx-unprivileged</code>映像。我使用默认的限制和请求。现在我只需要点击<code class="fe mm mn mo md b">Submit</code>，然后再点击<code class="fe mm mn mo md b">Deploy Changes</code>。同样，您可以检查无人机管道，查看何时成功部署了变更。</p><p id="5b48" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在团队服务中，您现在将看到创建的服务和服务的URL。</p><figure class="ly lz ma mb gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi nd"><img src="../Images/65c593c193d681b1d3f7f2fc77dd99ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9hl7T0EJdyTRQA0zl5pBsA.png"/></div></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">Otomi控制台中的团队服务列表</figcaption></figure><p id="8e99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为Otomi现在已经为服务自动配置了入口(使用Istio)，在DNS区域创建了一个主机名，并创建了一个证书，所以可能需要几分钟URL才能工作。</p><p id="30f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们在控制台中单击URL(https://nginx.team-test.demo.aks.redkubes.net ):</p><figure class="ly lz ma mb gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi ne"><img src="../Images/4e19960843dd25784bde5cc4f19d51d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DvuKTf5jOeBqbQ-U5Hp1FQ.png"/></div></div></figure><p id="1c33" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Nginx正在运行并公开曝光！</p><p id="d155" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，这只是如何安装Otomi、创建团队和部署应用程序的一个简单示例。Otomi提供了更多的功能和配置选项。查看<a class="ae kl" href="https://otomi.io" rel="noopener ugc nofollow" target="_blank"> https://otomi.io </a>了解更多信息。</p><p id="fe3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">想看看我们在GitHub上的项目吗？去<a class="ae kl" href="https://github.com/redkubes/otomi-core" rel="noopener ugc nofollow" target="_blank">https://github.com/redkubes/otomi-core</a>和明星！</p></div></div>    
</body>
</html>