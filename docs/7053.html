<html>
<head>
<title>The comprehensive guide for your AWS VPC cross communication (peering, sharing, transit gateway, etc…)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS VPC交叉通信(对等、共享、中转网关等)的全面指南</h1>
<blockquote>原文：<a href="https://itnext.io/the-ultimate-guide-for-your-aws-vpc-cross-communication-peering-sharing-transit-gateway-etc-df06ca1e877c?source=collection_archive---------1-----------------------#2022-05-27">https://itnext.io/the-ultimate-guide-for-your-aws-vpc-cross-communication-peering-sharing-transit-gateway-etc-df06ca1e877c?source=collection_archive---------1-----------------------#2022-05-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/65253bd72f360633a33423b0fb52e35e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v0BoQWLTeO0ZDFe1DRN6wg.jpeg"/></div></div></figure><p id="5bed" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">作为一名开发人员和云架构师，网络端花了我最多的时间去掌握。但是在小型到大型公司的多个项目中工作过之后，我想记录下构建、管理和跨VPC交流的不同方法以及它们的优缺点。这个想法是有一种决策树来选择最佳解决方案。</p><blockquote class="kw kx ky"><p id="ab5c" class="jy jz kz ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">不要忘了，没有放之四海而皆准的解决方案，只有针对特定需求的更好设计。</p></blockquote><p id="d936" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将讨论的不同设计是:</p><ul class=""><li id="5c6f" class="ld le iq ka b kb kc kf kg kj lf kn lg kr lh kv li lj lk ll bi translated">避免交叉交流</li><li id="f14d" class="ld le iq ka b kb lm kf ln kj lo kn lp kr lq kv li lj lk ll bi translated">VPC对等</li><li id="1021" class="ld le iq ka b kb lm kf ln kj lo kn lp kr lq kv li lj lk ll bi translated">AWS中转网关</li><li id="436f" class="ld le iq ka b kb lm kf ln kj lo kn lp kr lq kv li lj lk ll bi translated">VPC端点服务</li><li id="b3d2" class="ld le iq ka b kb lm kf ln kj lo kn lp kr lq kv li lj lk ll bi translated">VPC共享</li></ul><h1 id="9661" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">VPC和子网101</h1><p id="58a3" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">如果你正在读这篇文章，我想你已经有了基本的知识，所以我会长话短说。</p><p id="55c6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">VPC代表虚拟专用云</strong>，它是一个隔离的网络，在这个网络中，您的所有资源都可以相互通信。AWS默认VPC与此CIDR块172.31.0.0/16。这提供了65，536个私有IPv4地址</p><p id="a28d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">子网是分配在可用性区域</strong>的VPC的一部分。AWS默认子网是大小/20的块，因此4094专用IPv4 (172.31.0.0/20、172.31.16.0/20、172.31.32.0/20)。当子网连接了Internet网关时，该子网可以是公共的，否则该子网将被视为私有的。这意味着私有子网中的资源将无法访问互联网(例如，不允许<em class="kz"> yum更新</em>)。</p><h1 id="06f7" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">AWS多账户架构设计</h1><p id="1b9b" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">现在，AWS推荐多帐户架构，将不同的服务隔离到它们自己的专用帐户中。</p><h1 id="baf4" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">问题</h1><p id="1ab4" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">由于这种设计，问题是:<strong class="ka ir">既然VPC是隔离的，那么在不同VPC中运行的服务如何相互通信呢？</strong></p></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><h1 id="fd92" class="lr ls iq bd lt lu nb lw lx ly nc ma mb mc nd me mf mg ne mi mj mk nf mm mn mo bi translated">解决方法</h1><h1 id="7e7f" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">解决方案1:避免交叉沟通</h1><p id="f9b1" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">当我在做一个设计或者一个账户重组的时候，我首先会挑战VPC的交叉沟通的需求。你真的需要你的VPC互相通信吗？或者你能更好地设计你的架构来避免它吗？这个问题真的很重要，因为如果你能避免“桥接”你的VPC，你将大大减轻你的帐户和安全的网络管理。它也有一些我们稍后会看到的优点。</p><p id="dc2d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用例:您可以将您的统计数据放入一个可访问的共享位置，而不是公开一个端点来获取一些统计数据。基本上你可以推而不是拉你的数据。</p><h1 id="50d4" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">解决方案2: VPC对等</h1><p id="4004" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">VPC对等是在两个VPC之间建立桥梁的最简单的方法。</p><p id="4802" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">VPC A向VPC B请求对等。VPC B接受连接。VPC更新它们的路由表并建立连接。</p><figure class="nh ni nj nk gt jr gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/3b926fae591f87e2213612f19bff2379.png" data-original-src="https://miro.medium.com/v2/resize:fit:902/format:webp/1*R2w1FZbv16lGiEeyoxIw7w.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">VPC对等</figcaption></figure><p id="23a6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这种模式很简单，因为我们没有添加任何组件，它可以跨区域工作，并且因为它是免费的，所以也很划算。如果VPC很少，这种设计是完美的，因为子网CIDR块不能重叠。在帐户工厂模式中更难管理(当您可以用相同的过程创建多个帐户时)。对等与同一帐户或不同帐户、同一地区或跨地区的VPC一起工作。因此，当您想要查看您的ec2、rds或lambdas时，它会非常有用。</p><h1 id="bc72" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">解决方案3: AWS中转网关</h1><p id="0084" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">VPC对等是一个很好的解决方案，但是当您的网络扩展到数百或数千个VPC时，就很难管理了。管理路由表并避免IP重叠并不容易。这就是AWS Transit Gateway的用武之地。</p><div class="nh ni nj nk gt ab cb"><figure class="np jr nq nr ns nt nu paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><img src="../Images/219f4673b1996eb5965fbb8db58240c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*8rrnZQ3IAt-LoK_34UGFxQ.png"/></div></figure><figure class="np jr nq nr ns nt nu paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><img src="../Images/f7d05ba55c0103bd37bad581b7dd4417.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*ON-t0OLHHMTGGtP4IHxttQ.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk nv di nw nx translated">不带和带AWS中转网关</figcaption></figure></div><p id="188b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以看到，中转网关通过这个中心辐射式组件集中管理所有VPC连接。它还允许您连接本地VPC。很容易理解它是如何简化数百个虚拟个人计算机的管理的。一些拥有大型网络的公司为网络管理创建了专用的AWS帐户。这就是AWS中转网关的位置。</p><p id="3c0c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，如果中转网关看起来如此完美，你应该忘记对等吗？一点也不。与对等相比，转接网关有一些缺点。其中之一是这种结构是按照VPC附件收费的。<strong class="ka ir"> 730小时* 0.05美元= 37美元每VPC</strong>不含流量费，这对于中型公司来说可能很贵。Transit Gateway还将在您的通信中增加另一跳，因此如果您正在寻求高性能，可以考虑一下。最后，transit gateway具有50Gbps的带宽限制。</p><p id="8e0d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为在你的中转网关中不能有IP重叠，所以你必须非常小心地分配你的CIDR块。通常你想使用一个小的范围，比如/28</p><h1 id="ee6b" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">解决方案4: VPC端点服务</h1><p id="9503" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">有时候你不需要暴露你所有的VPC，你只需要暴露一个端点。还记得我在解决方案1中的第一个用例吗，您想要为像prometheus这样的内部监控工具公开一个/metrics端点。如果这是你唯一的终点，也许凝视你的VPC有点太夸张了。另一个解决方案是创建一个VPC端点。</p><figure class="nh ni nj nk gt jr gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/09ae9f9ac5f92d13cff6c86a77031078.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/format:webp/1*s3JV3S-j_9OzpARC7BTtNA.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">VPC端点服务</figcaption></figure><p id="93a4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该解决方案适用于提供商/消费者系统。提供者通过NLB的VPC端点服务公开其服务，消费者通过VPC ENI消费服务。此解决方案不是跨区域兼容的。连接是单向的，这意味着提供商将无法访问消费者的VPC中的服务。</p><p id="0eb8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">另一个要点是，提供商只能通过网络负载平衡器公开服务。关于安全性，您可以定义VPC端点策略，即IAM策略。最后，每个接口端点可以支持每个可用性区域高达10 Gbps的带宽，并自动扩展到40 Gbps。</p><p id="48b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">每个端点接口每月每AZ收费7.3美元，不含流量。</p><h1 id="21bc" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">解决方案5: VPC共享</h1><p id="901a" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">从AWS来看，“当团队之间的网络隔离不需要由VPC所有者严格管理，但帐户级别的用户和权限必须如此时，共享VPC非常有用”</p><p id="325e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这种模式在Account Factory模式下非常适用，在这种模式下，您需要为每个新服务/项目创建一个新帐户。云管理员创建一个VPC，并与所有其他帐户共享。在这种情况下，管理非常简单，因为没有VPC之间的连接。所有服务都在同一个VPC中，因此可以相互通信。安全性由安全组管理。</p><figure class="nh ni nj nk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/280b4d24caaaa3450af4e1bb1fd9d891.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zYrLND1FnJ36lDnl86D1yQ.jpeg"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">AWS VPC分享</figcaption></figure><p id="fb97" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果部署在共享VPC中的所有服务都属于同一个所有者(例如，考虑一个银行中的私有网络)，这种设计很好，但是如果您想要隔离您的一些客户，我不推荐这种设计。</p><p id="a6de" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这种架构没有配额，降低了成本，因为在同一AZ跨多个帐户的流量没有数据传输费用。</p><p id="17ca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">其中一个缺点是，共享VPC仅适用于同一组织中的不同帐户。因此，如果你打算考虑你的组织，这不会是一帆风顺的。</p></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><h1 id="cf13" class="lr ls iq bd lt lu nb lw lx ly nc ma mb mc nd me mf mg ne mi mj mk nf mm mn mo bi translated">摘要</h1><p id="e4b7" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">现在我们对根据不同需求的不同设计有了更好的了解，下面我们来总结一下。</p><figure class="nh ni nj nk gt jr"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="698a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请随意添加您的评论，我将很乐意更新这篇文章。</p></div></div>    
</body>
</html>