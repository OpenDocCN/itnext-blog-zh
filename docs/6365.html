<html>
<head>
<title>Building Restful APIs with Micronaut</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Micronaut构建Restful APIs</h1>
<blockquote>原文：<a href="https://itnext.io/building-restful-apis-with-micronaut-98f4eb39211c?source=collection_archive---------1-----------------------#2021-10-27">https://itnext.io/building-restful-apis-with-micronaut-98f4eb39211c?source=collection_archive---------1-----------------------#2021-10-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="6c59" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与Spring Boot类似，Micronaut是一个基于JVM的框架，旨在构建微服务和云原生应用。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/f3c1ee87b106cbb43f22533ca86c4f7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zQQZFdnK1KadoGtvK5pRDA.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated"><a class="ae lb" href="https://unsplash.com/@onice?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">黄祖儿</a>在<a class="ae lb" href="https://unsplash.com/s/photos/china-snow?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="b931" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与Spring Boot不同，Micronaut在编译时处理IOC并删除运行时反射，因此更容易构建本机映像。</p><blockquote class="lc ld le"><p id="afc6" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq"> Spring也开始了一个Spring原生项目，不过是早期。</em></p></blockquote><p id="af00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于不熟悉Micronaut的开发人员来说，如果您对Spring Boot有所了解，使用Micronaut开发您的应用程序会很容易。在这篇文章中，我将从Spring开发者的角度分享我使用Micronaut从头创建一个简单的Restful API应用程序的经验。</p><h1 id="974a" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">生成项目框架</h1><p id="652a" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">类似于<a class="ae lb" href="https://start.spring.io" rel="noopener ugc nofollow" target="_blank"> Spring Initializr </a>，Micronaut提供了一个名为<strong class="jp ir"> Launch </strong>的在线服务来帮助你生成一个项目框架。</p><p id="8ba6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">打开您的浏览器，进入<a class="ae lb" href="https://micronaut.io/launch/" rel="noopener ugc nofollow" target="_blank"> Micronaut Launch </a>，您将看到以下屏幕。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mm"><img src="../Images/0fec65f116e2bfb27a2c6a0e51e820be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XfXojoTfgHQQe4Yp.png"/></div></div></figure><p id="43cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<strong class="jp ir"> Java版本</strong>字段中，选择最新的LTS版本<strong class="jp ir"> 17 </strong>。然后点击<strong class="jp ir">功能</strong>按钮，添加<em class="lf"> lombok </em>、<em class="lf"> data hibernate jpa </em>、<em class="lf"> assertj </em>、<em class="lf"> postgres </em>、<em class="lf"> testcontainers </em>。最后，点击<strong class="jp ir">生成项目</strong>按钮，将项目文件生成一个存档文件供下载。</p><p id="8c4b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将项目文件解压缩到磁盘中，并导入到您的IDE中。</p><blockquote class="lc ld le"><p id="7ccc" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq">您也可以使用Micronaut CLI创建Micronaut项目，查看</em> <a class="ae lb" href="https://micronaut-projects.github.io/micronaut-starter/latest/guide/#installation" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> Micronaut Starter文档</em> </a> <em class="iq">。</em></p></blockquote><h1 id="2913" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">探索项目结构</h1><p id="bf94" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">让我们看看项目中的文件。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="6fb8" class="ms lk iq mo b gy mt mu l mv mw">.<br/>├── build.gradle<br/>├── gradle<br/>│   └── wrapper<br/>│       ├── gradle-wrapper.jar<br/>│       └── gradle-wrapper.properties<br/>├── gradle.properties<br/>├── gradlew<br/>├── gradlew.bat<br/>├── micronaut-cli.yml<br/>├── settings.gradle<br/>└── src<br/>    ├── main<br/>    │   ├── java<br/>    │   │   └── com<br/>    │   │       └── example<br/>    │   │           └── Application.java<br/>    │   └── resources<br/>    │       ├── application.yml<br/>    │       └── logback.xml<br/>    └── test<br/>        ├── java<br/>        │   └── com<br/>        │       └── example<br/>        │           └── DemoTest.java<br/>        └── resources<br/>            ├── application-test.yml<br/>            └── logback-test.xml</span></pre><p id="3a73" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除了Gradle build脚本相关的资源之外，它的结构类似于Spring Boot项目。</p><ul class=""><li id="10e5" class="mx my iq jp b jq jr ju jv jy mz kc na kg nb kk nc nd ne nf bi translated"><code class="fe ng nh ni mo b">Application</code>是应用程序的入口类。</li><li id="856a" class="mx my iq jp b jq nj ju nk jy nl kc nm kg nn kk nc nd ne nf bi translated"><em class="lf">src/main/resources/application . yml</em>是应用配置。</li><li id="9b26" class="mx my iq jp b jq nj ju nk jy nl kc nm kg nn kk nc nd ne nf bi translated"><em class="lf">src/main/resources/log back . XML</em>是日志配置。</li><li id="edbf" class="mx my iq jp b jq nj ju nk jy nl kc nm kg nn kk nc nd ne nf bi translated"><code class="fe ng nh ni mo b">DemoTest</code>是使用<code class="fe ng nh ni mo b">@MicronautTest</code>的一个例子。</li><li id="b6ca" class="mx my iq jp b jq nj ju nk jy nl kc nm kg nn kk nc nd ne nf bi translated">在<em class="lf"> src/test/resources </em>文件夹下，有一些测试用的配置资源。</li></ul><p id="4e07" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们来看看<em class="lf"> build.gradle </em>。</p><p id="0fcf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它使用<code class="fe ng nh ni mo b">com.github.johnrengelman.shadow</code>将应用程序打包到jar档案中。<code class="fe ng nh ni mo b">micronaut</code>插件将通过Java编译器注释处理器在编译时处理依赖注入。该插件还包括其他任务，如将应用程序构建到Docker映像和GraalVM本机映像中。</p><h1 id="2fee" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">声明一个Bean</h1><p id="f6d8" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">在Micronaut中，它使用JSR330(aka @Inject)规范来注释可注入的beans。JSR330最初由SpringSource(现在的VMware)和Google领导。</p><blockquote class="lc ld le"><p id="8245" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq"> Spring也内置了JSR330支持，默认情况下是不激活的。您应该在您的项目依赖项中添加</em> <code class="fe ng nh ni mo b"><em class="iq">inject</em></code> <em class="iq">工件来启用它。</em></p></blockquote><p id="cfb8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当一个类用<code class="fe ng nh ni mo b">@Singleton</code>注释时，意味着在应用范围内只有一个共享的实例，<code class="fe ng nh ni mo b">@Prototype</code>将为每次注入产生一个新的实例。</p><p id="ab0e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，Micronaut提供了一个<code class="fe ng nh ni mo b">@Factory</code>来分组生产简单的豆子。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="a7ff" class="ms lk iq mo b gy mt mu l mv mw">@Factory<br/>class MyConfig{<br/>    <br/>    @Singleton<br/>    public Foo foo(){}<br/>    <br/>    @Singleton<br/>    public Bar bar(){}<br/>}</span></pre><p id="80f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如前所述，Micronaut在编译时处理IOC。构建应用程序时，浏览项目<em class="lf"> build/classes </em>文件夹，您会发现在编译时生成了许多额外的类，它们的名称都以美元(“<strong class="jp ir"> $ </strong>”)符号开头。</p><h1 id="82f8" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">设置数据库</h1><p id="6545" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">打开<em class="lf">src/main/resources/application . yml</em>，生成项目时配置<code class="fe ng nh ni mo b">datasources</code>。根据您的环境更改属性。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="a910" class="ms lk iq mo b gy mt mu l mv mw">datasources:<br/>  default:<br/>    url: jdbc:postgresql://localhost:5432/blogdb<br/>    driverClassName: org.postgresql.Driver<br/>    username: user<br/>    password: password<br/>    schema-generate: CREATE_DROP<br/>    dialect: POSTGRES<br/>jpa.default.properties.hibernate.hbm2ddl.auto: update</span></pre><p id="7324" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个docker合成文件来引导docker容器中的Postgres。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="d25c" class="ms lk iq mo b gy mt mu l mv mw">version: '3.7' # specify docker-compose version</span><span id="796e" class="ms lk iq mo b gy no mu l mv mw">services:<br/>  postgres:<br/>    image: postgres<br/>    ports:<br/>      - "5432:5432"<br/>    restart: always<br/>    environment:<br/>      POSTGRES_PASSWORD: password<br/>      POSTGRES_DB: blogdb<br/>      POSTGRES_USER: user<br/>    volumes:<br/>      - ./data:/var/lib/postgresql<br/>      - ./pg-initdb.d:/docker-entrypoint-initdb.d</span></pre><p id="9892" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动Postgres数据库。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="3687" class="ms lk iq mo b gy mt mu l mv mw">docker compose up postgres</span></pre><h1 id="4d25" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">使用Micronaut数据访问数据</h1><p id="3c67" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">我们在生成项目时添加了<em class="lf"> data-jpa </em>特性，这使得Micronaut数据支持成为可能。如果您有Spring数据JPA的经验，迁移到Micronaut数据是很容易的。</p><p id="2f10" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在演示其他框架时，我在前面的例子中使用了一个简单的博客应用程序。在这篇文章中，我将重用博客应用程序的概念。</p><p id="d6b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">基本上它包括两个JPA实体，<code class="fe ng nh ni mo b">Post</code>和<code class="fe ng nh ni mo b">Comment</code>，这是一个<code class="fe ng nh ni mo b">OneToMany</code>关系。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="8cdb" class="ms lk iq mo b gy mt mu l mv mw">@Getter<br/>@Setter<br/>@NoArgsConstructor<br/>@AllArgsConstructor<br/>@Builder<br/>@Entity<br/>@Table(name = "posts")<br/>public class Post implements Serializable {</span><span id="bff6" class="ms lk iq mo b gy no mu l mv mw">    @Id<br/>    @GeneratedValue(generator = "uuid")<br/>    @GenericGenerator(name = "uuid", strategy = "uuid2")<br/>    UUID id;<br/>    String title;<br/>    String content;</span><span id="d439" class="ms lk iq mo b gy no mu l mv mw">    @Builder.Default<br/>    Status status = Status.DRAFT;</span><span id="d458" class="ms lk iq mo b gy no mu l mv mw">    @Builder.Default<br/>    LocalDateTime createdAt = LocalDateTime.now();</span><span id="f818" class="ms lk iq mo b gy no mu l mv mw">    @OneToMany(cascade = {CascadeType.ALL}, orphanRemoval = true, mappedBy = "post")<br/>    @Builder.Default<br/>    @OrderColumn(name = "comment_idx")<br/>    List&lt;Comment&gt; comments = new ArrayList&lt;&gt;();</span><span id="2ba4" class="ms lk iq mo b gy no mu l mv mw">    @Override<br/>    public boolean equals(Object o) {<br/>        if (this == o) return true;<br/>        if (o == null || getClass() != o.getClass()) return false;<br/>        Post post = (Post) o;<br/>        return getTitle().equals(post.getTitle());<br/>    }</span><span id="8ee1" class="ms lk iq mo b gy no mu l mv mw">    @Override<br/>    public int hashCode() {<br/>        return Objects.hash(getTitle());<br/>    }</span><span id="fe73" class="ms lk iq mo b gy no mu l mv mw">    @Override<br/>    public String toString() {<br/>        return "Post{" +<br/>                "id=" + id +<br/>                ", title='" + title + '\'' +<br/>                ", content='" + content + '\'' +<br/>                ", status=" + status +<br/>                ", createdAt=" + createdAt +<br/>                '}';<br/>    }<br/>}</span><span id="4102" class="ms lk iq mo b gy no mu l mv mw">// Comment entity <br/>@Getter<br/>@Setter<br/>@NoArgsConstructor<br/>@AllArgsConstructor<br/>@Builder<br/>@Entity<br/>@Table(name = "comments")<br/>public class Comment implements Serializable {</span><span id="207f" class="ms lk iq mo b gy no mu l mv mw">    @Id<br/>    @GeneratedValue(generator = "uuid")<br/>    @GenericGenerator(name = "uuid", strategy = "uuid2")<br/>    private UUID id;</span><span id="b112" class="ms lk iq mo b gy no mu l mv mw">    @ManyToOne<br/>    @JoinColumn(name = "post_id")<br/>    private Post post;</span><span id="12db" class="ms lk iq mo b gy no mu l mv mw">    private String content;</span><span id="4612" class="ms lk iq mo b gy no mu l mv mw">    @Builder.Default<br/>    @Column(name = "created_at")<br/>    private LocalDateTime createdAt = LocalDateTime.now();</span><span id="4256" class="ms lk iq mo b gy no mu l mv mw">    @Override<br/>    public boolean equals(Object o) {<br/>        if (this == o) return true;<br/>        if (o == null || getClass() != o.getClass()) return false;<br/>        Comment comment = (Comment) o;<br/>        return getContent().equals(comment.getContent());<br/>    }</span><span id="773b" class="ms lk iq mo b gy no mu l mv mw">    @Override<br/>    public int hashCode() {<br/>        return Objects.hash(getContent());<br/>    }</span><span id="a142" class="ms lk iq mo b gy no mu l mv mw">    @Override<br/>    public String toString() {<br/>        return "Comment{" +<br/>                "id=" + id +<br/>                ", content='" + content + '\'' +<br/>                ", createdAt=" + createdAt +<br/>                '}';<br/>    }<br/>}</span></pre><p id="cbc4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它们是标准的JPA <code class="fe ng nh ni mo b">@Entity</code>类。</p><p id="07e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">JPA实体类应该用一个<code class="fe ng nh ni mo b">@Entity</code>注释进行注释，并包含一个<code class="fe ng nh ni mo b">@Id</code>字段来标识这个实体和一个无参数构造函数。这里我们使用Lombok在编译时生成setters、getters和constructors。我们使用IDE根据业务需求生成<code class="fe ng nh ni mo b">equals</code>和<code class="fe ng nh ni mo b">hasCode</code>。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="15cd" class="ms lk iq mo b gy mt mu l mv mw">@Repository<br/>public interface PostRepository extends JpaRepository&lt;Post, UUID&gt;{</span><span id="6357" class="ms lk iq mo b gy no mu l mv mw">}</span><span id="b6fc" class="ms lk iq mo b gy no mu l mv mw">@Repository<br/>public interface CommentRepository extends JpaRepository&lt;Comment, UUID&gt; {</span><span id="0f06" class="ms lk iq mo b gy no mu l mv mw">    List&lt;Comment&gt; findByPost(Post post);<br/>}</span></pre><p id="544b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">添加一个<code class="fe ng nh ni mo b">DataInitializer</code> bean来初始化一些样本数据。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="a0a6" class="ms lk iq mo b gy mt mu l mv mw">@Singleton<br/>@RequiredArgsConstructor<br/>@Slf4j<br/>public class DataInitializer implements ApplicationEventListener&lt;ApplicationStartupEvent&gt; {<br/>    private final PostRepository posts;</span><span id="4713" class="ms lk iq mo b gy no mu l mv mw">    private final TransactionOperations&lt;?&gt; tx;</span><span id="fb5d" class="ms lk iq mo b gy no mu l mv mw">    @Override<br/>    public void onApplicationEvent(ApplicationStartupEvent event) {<br/>        log.info("initializing sample data...");<br/>        var data = List.of(Post.builder().title("Getting started wit Micronaut").content("test").build(),<br/>                Post.builder().title("Getting started wit Micronaut: part 2").content("test").build());<br/>        tx.executeWrite(status -&gt; {<br/>            this.posts.deleteAll();<br/>            this.posts.saveAll(data);<br/>            return null;<br/>        });<br/>        tx.executeRead(status -&gt; {<br/>            this.posts.findAll().forEach(p -&gt; log.info("saved post: {}", p));<br/>            return null;<br/>        });<br/>        log.info("data initialization is done...");<br/>    }<br/>}</span></pre><p id="8810" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">编写一个测试来验证<code class="fe ng nh ni mo b">PostRepository</code>的功能。类似于<code class="fe ng nh ni mo b">@SpringBootTest</code>，Micronaut提供了一个<code class="fe ng nh ni mo b">@MicronautTest</code>。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="08fb" class="ms lk iq mo b gy mt mu l mv mw">@MicronautTest(application = Application.class, startApplication = false)<br/>class PostRepositoryTest {</span><span id="2066" class="ms lk iq mo b gy no mu l mv mw">    @Inject<br/>    PostRepository posts;</span><span id="22e1" class="ms lk iq mo b gy no mu l mv mw">    @PersistenceContext<br/>    EntityManager entityManager;</span><span id="b2dd" class="ms lk iq mo b gy no mu l mv mw">    @Test<br/>    void testCreatePost() {<br/>        var entity = Post.builder().title("test title").content("test content").build();<br/>        this.entityManager.persist(entity);</span><span id="e21c" class="ms lk iq mo b gy no mu l mv mw">        assertThat(entity.getId()).isNotNull();<br/>        assertTrue(posts.findById(entity.getId()).isPresent());<br/>    }</span><span id="2c08" class="ms lk iq mo b gy no mu l mv mw">}</span></pre><p id="b264" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我们设置<code class="fe ng nh ni mo b">startApplication = false</code>，它不启动嵌入式服务器来托管应用程序，为了测试数据库，我们不需要运行应用程序</p><p id="8a6d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们增加了<code class="fe ng nh ni mo b">testcontainers</code>功能，它会自动配置一个Postgres进行测试。检查<code class="fe ng nh ni mo b">src/test/resources/application-test.yml</code>中的testcontainers配置。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="bb86" class="ms lk iq mo b gy mt mu l mv mw">datasources:<br/>  default:<br/>    url: jdbc:tc:postgresql:12:///postgres<br/>    driverClassName: org.testcontainers.jdbc.ContainerDatabaseDriver</span></pre><p id="ecc8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当有一个<code class="fe ng nh ni mo b">tc</code>作为数据库主机名时，testcontainer将自动启动一个Postgres数据库。</p><h1 id="045c" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">公开Restful APIs</h1><p id="3b2d" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">类似于Spring WebMVC，在Micronaut中，我们可以使用一个控制器来公开Restful APIs。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="26bf" class="ms lk iq mo b gy mt mu l mv mw">@Controller("/posts")<br/>@RequiredArgsConstructor(onConstructor_ = {@Inject})<br/>@Validated<br/>public class PostController {<br/>    private final PostRepository posts;<br/>    private final CommentRepository comments;</span><span id="81a0" class="ms lk iq mo b gy no mu l mv mw">    @Get(uri = "/", produces = MediaType.APPLICATION_JSON)<br/>    public HttpResponse&lt;List&lt;PostSummaryDto&gt;&gt; getAll() {<br/>        var body = posts.findAll()<br/>                .stream()<br/>                .map(p -&gt; new PostSummaryDto(p.getId(), p.getTitle(), p.getCreatedAt()))<br/>                .toList();<br/>        return ok(body);<br/>    }</span><span id="1695" class="ms lk iq mo b gy no mu l mv mw">    @Get(uri = "/{id}", produces = MediaType.APPLICATION_JSON)<br/>    public HttpResponse&lt;?&gt; getById(@PathVariable UUID id) {<br/>        return posts.findById(id)<br/>                .map(p -&gt; ok(new PostDetailsDto(p.getId(), p.getTitle(), p.getContent(), p.getStatus(), p.getCreatedAt())))<br/>                //.orElseThrow(() -&gt; new PostNotFoundException(id));<br/>        .orElseGet(HttpResponse::notFound);<br/>    }<br/>}</span></pre><p id="ee0e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个控制器用<code class="fe ng nh ni mo b">@Controller</code>标注，你可以设置一个基础<code class="fe ng nh ni mo b">uri</code>应用于所有的方法。<code class="fe ng nh ni mo b">@Get</code>、<code class="fe ng nh ni mo b">@Post</code>、<code class="fe ng nh ni mo b">@Put</code>、<code class="fe ng nh ni mo b">@Delete</code>映射处理各种HTTP方法，类似于Spring的<code class="fe ng nh ni mo b">@GetMapping</code>、<code class="fe ng nh ni mo b">@PostMapping</code>等。您可以使用这些注释中的<em class="lf"> consumes </em>或<em class="lf"> produces </em>属性来设置媒体类型，以限制请求和响应的内容类型，或者使用独立的注释<code class="fe ng nh ni mo b">@Consumes</code>和<code class="fe ng nh ni mo b">@Produces</code>来设置媒体类型。</p><p id="01f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过Gradle命令启动应用程序。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="a3a0" class="ms lk iq mo b gy mt mu l mv mw">./gradlew run</span></pre><blockquote class="lc ld le"><p id="58d9" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated">不要忘记首先启动Postgres。</p></blockquote><p id="31fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<code class="fe ng nh ni mo b">curl</code>测试<code class="fe ng nh ni mo b">/posts</code>端点。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="c4a5" class="ms lk iq mo b gy mt mu l mv mw">curl <a class="ae lb" href="http://localhost:8080/posts" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/posts</a><br/>[ {<br/>  "id" : "b6fb90ab-2719-498e-a5fd-93d0c7669fdf",<br/>  "title" : "Getting started wit Micronaut",<br/>  "createdAt" : "2021-10-14T22:00:28.80933"<br/>}, {<br/>  "id" : "8c6147ea-8de4-473f-b97d-e211c8e43bac",<br/>  "title" : "Getting started wit Micronaut: part 2",<br/>  "createdAt" : "2021-10-14T22:00:28.80933"<br/>} ]</span><span id="392e" class="ms lk iq mo b gy no mu l mv mw">curl <a class="ae lb" href="http://localhost:8080/posts/b6fb90ab-2719-498e-a5fd-93d0c7669fdf" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/posts/b6fb90ab-2719-498e-a5fd-93d0c7669fdf</a><br/> {<br/>  "id" : "b6fb90ab-2719-498e-a5fd-93d0c7669fdf",<br/>  "title" : "Getting started wit Micronaut",<br/>  "content": "test",<br/>  "createdAt" : "2021-10-14T22:00:28.80933"<br/>}</span></pre><blockquote class="lc ld le"><p id="6c82" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq"> Micronaut CLI提供生成控制器、bean等命令。运行</em> <code class="fe ng nh ni mo b"><em class="iq">mn --help</em></code> <em class="iq">获取所有可用命令。</em></p></blockquote><p id="2c40" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为<code class="fe ng nh ni mo b">PostController</code>编写一个测试。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="78a3" class="ms lk iq mo b gy mt mu l mv mw">@MicronautTest(environments = Environment.TEST)<br/>public class PostControllerTest {</span><span id="94e0" class="ms lk iq mo b gy no mu l mv mw">    @Inject<br/>    @Client("/")<br/>    HttpClient client;</span><span id="47ac" class="ms lk iq mo b gy no mu l mv mw">    @Inject<br/>    PostRepository posts;</span><span id="9278" class="ms lk iq mo b gy no mu l mv mw">    @Inject<br/>    CommentRepository comments;</span><span id="fc18" class="ms lk iq mo b gy no mu l mv mw">    @MockBean(PostRepository.class)<br/>    PostRepository posts() {<br/>        return mock(PostRepository.class);<br/>    }</span><span id="cff4" class="ms lk iq mo b gy no mu l mv mw">    @MockBean(CommentRepository.class)<br/>    CommentRepository comments() {<br/>        return mock(CommentRepository.class);<br/>    }</span><span id="fccd" class="ms lk iq mo b gy no mu l mv mw">    @Test<br/>    @DisplayName("test GET '/posts' endpoint")<br/>    public void testGetAllPosts() throws Exception {<br/>        when(this.posts.findAll()).thenReturn(<br/>                List.of(Post.builder().id(UUID.randomUUID()).title("test title").content("test content").build())<br/>        );<br/>        var response = client.toBlocking().exchange("/posts", PostSummaryDto[].class);<br/>        assertEquals(HttpStatus.OK, response.status());<br/>        var body = response.body();<br/>        assertThat(body.length).isEqualTo(1);<br/>        assertThat(body[0].title()).isEqualTo("test title");</span><span id="3c40" class="ms lk iq mo b gy no mu l mv mw">        verify(this.posts, times(1)).findAll();<br/>        verifyNoMoreInteractions(this.posts);<br/>    }</span><span id="d8f5" class="ms lk iq mo b gy no mu l mv mw">    @Test<br/>    @DisplayName("test GET '/posts/{id}' endpoint")<br/>    public void testGetSinglePost() throws Exception {<br/>        when(this.posts.findById(any(UUID.class))).thenReturn(<br/>                Optional.ofNullable(Post.builder().id(UUID.randomUUID()).title("test title").content("test content").build())<br/>        );<br/>        var request = HttpRequest.GET(UriBuilder.of("/posts/{id}").expand(Map.of("id", UUID.randomUUID())));<br/>        var response = client.toBlocking().exchange(request, PostDetailsDto.class);<br/>        assertEquals(HttpStatus.OK, response.status());<br/>        var body = response.body();<br/>        assertThat(body.title()).isEqualTo("test title");</span><span id="f6bc" class="ms lk iq mo b gy no mu l mv mw">        verify(this.posts, times(1)).findById(any(UUID.class));<br/>        verifyNoMoreInteractions(this.posts);<br/>    }</span><span id="8d03" class="ms lk iq mo b gy no mu l mv mw">    @Test<br/>    @DisplayName("test GET '/posts/{id}' endpoint that does not exist")<br/>    public void testGetSinglePost_notFound() throws Exception {<br/>        when(this.posts.findById(any(UUID.class))).thenReturn(Optional.ofNullable(null));<br/>        var request = HttpRequest.GET(UriBuilder.of("/posts/{id}").expand(Map.of("id", UUID.randomUUID())));<br/>        var exception = assertThrows(HttpClientResponseException.class, () -&gt; client.toBlocking().exchange(request, PostDetailsDto.class));</span><span id="d80a" class="ms lk iq mo b gy no mu l mv mw">        assertEquals(HttpStatus.NOT_FOUND, exception.getStatus());<br/>        verify(this.posts, times(1)).findById(any(UUID.class));<br/>        verifyNoMoreInteractions(this.posts);<br/>    }<br/>}</span></pre><p id="7c88" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个测试中，我们使用Mockito来模拟<code class="fe ng nh ni mo b">PostController</code>中的所有依赖bean(<code class="fe ng nh ni mo b">PostRepository</code>和<code class="fe ng nh ni mo b">CommentRepository</code>)。为了在测试上下文中模拟bean，Micronaut提供了一个<code class="fe ng nh ni mo b">MockBean</code>来生成一个模拟实例，以替换真正的bean。</p><p id="70b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与Spring的<code class="fe ng nh ni mo b">RestTemplate</code>或<code class="fe ng nh ni mo b">WebClient</code>类似，Micronaut提供了一个<code class="fe ng nh ni mo b">HttpClient</code>向某个URI发送请求，默认使用<em class="lf">react vestream</em>s兼容API，如果你坚持传统的阻塞API，调用<code class="fe ng nh ni mo b">toBlocking()</code>方法切换使用。</p><p id="29c4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ng nh ni mo b">exchange</code>方法会返回一个HTTP响应对象，<code class="fe ng nh ni mo b">retrieve</code>方法直接返回响应体。</p><blockquote class="lc ld le"><p id="4cc5" class="jn jo lf jp b jq jr js jt ju jv jw jx lg jz ka kb lh kd ke kf li kh ki kj kk ij bi translated"><em class="iq">注意:使用阻塞API时，如果返回一个失败的HTTP响应，比如返回一个4xx状态码，它会抛出一个</em> <code class="fe ng nh ni mo b"><em class="iq">HttpClientResponseException</em></code> <em class="iq">来代替。相比之下，在ReactiveStreams APIs中，它会向错误通道发出异常。</em></p></blockquote><h1 id="ab50" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">异常处理</h1><p id="8fa2" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">在上面的<code class="fe ng nh ni mo b">PostController</code>中，如果没有找到给定文章id的文章，它直接返回404 HTTP状态。在真实的应用程序中，我们可以使用异常来封装异常情况。和Spring WebMVC一样，Micronaut也提供了异常处理机制。</p><p id="abe9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，创建一个<code class="fe ng nh ni mo b">PostNotFoundException</code>来代表id找不到帖子的情况。</p><p id="d6f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个<code class="fe ng nh ni mo b">PostNotFoundException</code>类。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="2b64" class="ms lk iq mo b gy mt mu l mv mw">public class PostNotFoundException extends RuntimeException {<br/>    public PostNotFoundException(UUID id) {<br/>        super("Post[id=" + id + "] was not found");<br/>    }<br/>}</span></pre><p id="665a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe ng nh ni mo b">PostController</code>中，抛出异常。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="73ec" class="ms lk iq mo b gy mt mu l mv mw">@Get(uri = "/{id}", produces = MediaType.APPLICATION_JSON)<br/>public HttpResponse&lt;?&gt; getById(@PathVariable UUID id) {<br/>    return posts.findById(id)<br/>        .map(p -&gt; ok(new PostDetailsDto(p.getId(), p.getTitle(), p.getContent(), p.getStatus(), p.getCreatedAt())))<br/>        .orElseThrow(() -&gt; new PostNotFoundException(id));<br/>}</span></pre><p id="f883" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">增加一个<code class="fe ng nh ni mo b">PostNotFoundExceptionHandler</code>来处理<code class="fe ng nh ni mo b">PostNotFoundException</code>。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="3440" class="ms lk iq mo b gy mt mu l mv mw">@Produces<br/>@Singleton<br/>@Requires(classes = { PostNotFoundException.class})<br/>@RequiredArgsConstructor<br/>public class PostNotFoundExceptionHandler implements ExceptionHandler&lt;PostNotFoundException, HttpResponse&lt;?&gt;&gt; {<br/>    private final ErrorResponseProcessor&lt;?&gt; errorResponseProcessor;</span><span id="8cb4" class="ms lk iq mo b gy no mu l mv mw">    @Override<br/>    public HttpResponse&lt;?&gt; handle(HttpRequest request, PostNotFoundException exception) {<br/>        return errorResponseProcessor.processResponse(<br/>                ErrorContext.builder(request)<br/>                        .cause(exception)<br/>                        .errorMessage(exception.getMessage())<br/>                        .build(),<br/>                HttpResponse.notFound()<br/>        );<br/>    }<br/>}</span></pre><p id="aaac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">打开您的终端，使用<code class="fe ng nh ni mo b">curl</code>测试不存在id的<code class="fe ng nh ni mo b">/posts/{id}</code>端点。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="fbbb" class="ms lk iq mo b gy mt mu l mv mw"># curl <a class="ae lb" href="http://localhost:8080/posts/b6fb90ab-2719-498e-a5fd-93d0c7669fdf" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/posts/b6fb90ab-2719-498e-a5fd-93d0c7669fdf</a> -v<br/>&gt; GET /posts/b6fb90ab-2719-498e-a5fd-93d0c7669fdf HTTP/1.1<br/>&gt; Host: localhost:8080<br/>&gt; User-Agent: curl/7.55.1<br/>&gt; Accept: */*<br/>&gt;<br/>&lt; HTTP/1.1 404 Not Found<br/>&lt; Content-Type: application/json<br/>&lt; date: Mon, 25 Oct 2021 07:02:01 GMT<br/>&lt; content-length: 301<br/>&lt; connection: keep-alive<br/>&lt;<br/>{<br/>  "message" : "Not Found",<br/>  "_links" : {<br/>    "self" : {<br/>      "href" : "/posts/b6fb90ab-2719-498e-a5fd-93d0c7669fdf",<br/>      "templated" : false<br/>    }<br/>  },<br/>  "_embedded" : {<br/>    "errors" : [ {<br/>      "message" : "Post[id=b6fb90ab-2719-498e-a5fd-93d0c7669fdf] was not found"<br/>    } ]<br/>  }<br/>}</span></pre><h1 id="5225" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">页码</h1><p id="9466" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">与Spring数据类似，Micronaut数据为长查询结果提供分页，<code class="fe ng nh ni mo b">findAll</code>接受一个<code class="fe ng nh ni mo b">Pageable</code>参数，并返回一个<code class="fe ng nh ni mo b">Page</code>结果。Micronaut数据还包括一个<code class="fe ng nh ni mo b">Specification</code>来采用JPA标准API进行类型安全查询。</p><p id="a108" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">更改<code class="fe ng nh ni mo b">PostRepository</code>，将<code class="fe ng nh ni mo b">JpaSpecificationExecutor&lt;Post&gt;</code>添加到扩展列表。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="0d9c" class="ms lk iq mo b gy mt mu l mv mw">@Repository<br/>public interface PostRepository extends JpaRepository&lt;Post, UUID&gt;, JpaSpecificationExecutor&lt;Post&gt; {</span><span id="0411" class="ms lk iq mo b gy no mu l mv mw">}</span></pre><p id="1fe5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个特定的<code class="fe ng nh ni mo b">PostSpecifications</code>来分组查询帖子的所有规范。目前只添加一个按关键字和状态查询。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="26c5" class="ms lk iq mo b gy mt mu l mv mw">public class PostSpecifications {<br/>    private PostSpecifications(){<br/>        // forbid to instantiate<br/>    }</span><span id="40f2" class="ms lk iq mo b gy no mu l mv mw">    public static Specification&lt;Post&gt; filterByKeywordAndStatus(<br/>            final String keyword,<br/>            final Status status<br/>    ) {<br/>        return (Root&lt;Post&gt; root, CriteriaQuery&lt;?&gt; query, CriteriaBuilder cb) -&gt; {<br/>            List&lt;Predicate&gt; predicates = new ArrayList&lt;&gt;();<br/>            if (StringUtils.hasText(keyword)) {<br/>                predicates.add(<br/>                        cb.or(<br/>                                cb.like(root.get(Post_.title), "%" + keyword + "%"),<br/>                                cb.like(root.get(Post_.content), "%" + keyword + "%")<br/>                        )<br/>                );<br/>            }</span><span id="0f2c" class="ms lk iq mo b gy no mu l mv mw">            if (status != null) {<br/>                predicates.add(cb.equal(root.get(Post_.status), status));<br/>            }</span><span id="ab58" class="ms lk iq mo b gy no mu l mv mw">            return cb.and(predicates.toArray(new Predicate[0]));<br/>        };<br/>    }<br/>}</span></pre><p id="eaf7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将<code class="fe ng nh ni mo b">PostController</code>的<code class="fe ng nh ni mo b">getAll</code>方法改为如下。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="e0e7" class="ms lk iq mo b gy mt mu l mv mw">@Get(uri = "/", produces = MediaType.APPLICATION_JSON)<br/>@Transactional<br/>public HttpResponse&lt;Page&lt;PostSummaryDto&gt;&gt; getAll(@QueryValue(defaultValue = "") String q,<br/>                                                 @QueryValue(defaultValue = "") String status,<br/>                                                 @QueryValue(defaultValue = "0") int page,<br/>                                                 @QueryValue(defaultValue = "10") int size) {<br/>    var pageable = Pageable.from(page, size, Sort.of(Sort.Order.desc("createdAt")));<br/>    var postStatus = StringUtils.hasText(status) ? com.example.domain.Status.valueOf(status) : null;<br/>    var data = this.posts.findAll(PostSpecifications.filterByKeywordAndStatus(q, postStatus), pageable);<br/>    var body = data.map(p -&gt; new PostSummaryDto(p.getId(), p.getTitle(), p.getCreatedAt()));<br/>    return ok(body);<br/>}</span></pre><p id="ed3e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所有查询参数都是可选的。</p><p id="e982" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们用<code class="fe ng nh ni mo b">curl</code>来测试一下<em class="lf">/波斯特</em>端点。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="a781" class="ms lk iq mo b gy mt mu l mv mw"># curl <a class="ae lb" href="http://localhost:8080/posts" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/posts</a><br/>{<br/>  "content" : [ {<br/>    "id" : "c9ec963d-2df5-4d65-bfbe-5a0d4cb14ca6",<br/>    "title" : "Getting started wit Micronaut",<br/>    "createdAt" : "2021-10-25T16:35:03.732951"<br/>  }, {<br/>    "id" : "0a79185c-5981-4301-86d1-c266b26b4980",<br/>    "title" : "Getting started wit Micronaut: part 2",<br/>    "createdAt" : "2021-10-25T16:35:03.732951"<br/>  } ],<br/>  "pageable" : {<br/>    "number" : 0,<br/>    "sort" : {<br/>      "orderBy" : [ {<br/>        "property" : "createdAt",<br/>        "direction" : "DESC",<br/>        "ignoreCase" : false,<br/>        "ascending" : false<br/>      } ],<br/>      "sorted" : true<br/>    },<br/>    "size" : 10,<br/>    "offset" : 0,<br/>    "sorted" : true,<br/>    "unpaged" : false<br/>  },<br/>  "totalSize" : 2,<br/>  "totalPages" : 1,<br/>  "empty" : false,<br/>  "size" : 10,<br/>  "offset" : 0,<br/>  "numberOfElements" : 2,<br/>  "pageNumber" : 0<br/>}</span></pre><h1 id="e4f2" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">自定义JsonSerializer</h1><p id="f295" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated"><code class="fe ng nh ni mo b">Page</code>物体渲染结果有点繁琐，大多数情况下，我们不需要所有这些字段，我们可以通过Jackson <code class="fe ng nh ni mo b">JsonSerializer</code>自定义。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="a1b6" class="ms lk iq mo b gy mt mu l mv mw">@Singleton<br/>public class PageJsonSerializer extends JsonSerializer&lt;Page&lt;?&gt;&gt; {<br/>    @Override<br/>    public void serialize(Page&lt;?&gt; value, JsonGenerator gen, SerializerProvider serializers) throws IOException {<br/>        gen.writeStartObject();<br/>        gen.writeNumberField("pageNumber", value.getPageNumber());<br/>        if (value.getNumberOfElements() != value.getSize()) {<br/>            //only display it in the last page when number of elements is not equal to page size.<br/>            gen.writeNumberField("numberOfElements", value.getNumberOfElements());<br/>        }<br/>        gen.writeNumberField("size", value.getSize());<br/>        gen.writeNumberField("totalPages", value.getTotalPages());<br/>        gen.writeNumberField("totalSize", value.getTotalSize());<br/>        gen.writeObjectField("content", value.getContent());<br/>        gen.writeEndObject();<br/>    }<br/>}</span></pre><p id="1b4a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">再次运行应用程序，并提示<em class="lf"> /posts </em>端点。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="eb3e" class="ms lk iq mo b gy mt mu l mv mw"># curl <a class="ae lb" href="http://localhost:8080/posts" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/posts</a><br/>{<br/>  "pageNumber" : 0,<br/>  "numberOfElements" : 2,<br/>  "size" : 10,<br/>  "totalPages" : 1,<br/>  "totalSize" : 2,<br/>  "content" : [ {<br/>    "id" : "53fb77d5-4159-4a80-bab9-c76d9a535b36",<br/>    "title" : "Getting started wit Micronaut",<br/>    "createdAt" : "2021-10-25T16:47:05.545594"<br/>  }, {<br/>    "id" : "aa02fd49-0c24-4f12-b204-2e48213c7a1e",<br/>    "title" : "Getting started wit Micronaut: part 2",<br/>    "createdAt" : "2021-10-25T16:47:05.545594"<br/>  } ]<br/>}</span></pre><p id="5ab1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">修改测试代码以验证更改。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="5cb1" class="ms lk iq mo b gy mt mu l mv mw">class PostControllerTest{<br/>    //...<br/>    <br/>    @Test<br/>    @DisplayName("test GET '/posts' endpoint")<br/>    public void testGetAllPosts() throws Exception {<br/>        var content = List.of(Post.builder().id(UUID.randomUUID()).title("test title").content("test content").build());<br/>        when(this.posts.findAll(isA(Specification.class), isA(Pageable.class))).thenReturn(<br/>                Page.of(content, Pageable.from(0, 20), 1)<br/>        );<br/>        var request = HttpRequest.GET("/posts");<br/>        var response = client.toBlocking().exchange(request, String.class);<br/>        assertEquals(HttpStatus.OK, response.status());<br/>        var body = response.body();<br/>        assertThat(JsonPath.from(body).getInt("totalSize")).isEqualTo(1);<br/>        assertThat(JsonPath.from(body).getString("content[0].title")).isEqualTo("test title");</span><span id="78de" class="ms lk iq mo b gy no mu l mv mw">        verify(this.posts, times(1)).findAll(isA(Specification.class), isA(Pageable.class));<br/>        verifyNoMoreInteractions(this.posts);<br/>    }<br/>}</span></pre><h1 id="872b" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">创建帖子</h1><p id="b3e2" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">我们已经讨论了如何通过关键字查询帖子和通过id获取单个帖子，在这一节中，我们将专注于创建一个新帖子。</p><p id="b7f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据REST约定，我们将使用POST HTTP方法在端点<em class="lf"> /posts </em>上发送请求，并接受JSON数据作为请求体。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="16fe" class="ms lk iq mo b gy mt mu l mv mw">@io.micronaut.http.annotation.Post(uri = "/", consumes = MediaType.APPLICATION_JSON)<br/>@Transactional<br/>public HttpResponse&lt;Void&gt; create(@Body CreatePostCommand dto) {<br/>    var data = Post.builder().title(dto.title()).content(dto.content()).build();<br/>    var saved = this.posts.save(data);<br/>    return HttpResponse.created(URI.create("/posts/" + saved.getId()));<br/>}</span></pre><p id="dba8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请求体被内置的Jackson <code class="fe ng nh ni mo b">JsonDesearilizer</code>反序列化为一个POJO，它用一个<code class="fe ng nh ni mo b">@Body</code>注释来表示它将被反序列化到哪个目标类。帖子数据保存后，将响应头<code class="fe ng nh ni mo b">Location</code>设置为访问新帖子的URI。</p><p id="447e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行应用程序，尝试通过<code class="fe ng nh ni mo b">curl</code>添加帖子，然后访问新创建的帖子。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="6c95" class="ms lk iq mo b gy mt mu l mv mw"># curl -X POST -v  -H "Content-Type:application/json" <a class="ae lb" href="http://localhost:8080/posts" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/posts</a> -d "{\"title\":\"test title\",\"content\":\"test content\"}"<br/>&gt; POST /posts HTTP/1.1<br/>&gt; Host: localhost:8080<br/>&gt; User-Agent: curl/7.55.1<br/>&gt; Accept: */*<br/>&gt; Content-Type:application/json<br/>&gt; Content-Length: 47<br/>&gt;<br/>* upload completely sent off: 47 out of 47 bytes<br/>&lt; HTTP/1.1 201 Created<br/>&lt; location: /posts/7db15639-62e3-4d3e-9cf4-f54413502ea6<br/>&lt; date: Mon, 25 Oct 2021 09:07:40 GMT<br/>&lt; connection: keep-alive<br/>&lt; transfer-encoding: chunked<br/>&lt;<br/># curl <a class="ae lb" href="http://localhost:8080/posts/7db15639-62e3-4d3e-9cf4-f54413502ea6" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/posts/7db15639-62e3-4d3e-9cf4-f54413502ea6</a><br/>{<br/>  "id" : "7db15639-62e3-4d3e-9cf4-f54413502ea6",<br/>  "title" : "test title",<br/>  "content" : "test content",<br/>  "status" : "DRAFT",<br/>  "createdAt" : "2021-10-25T17:07:40.87621"<br/>}</span></pre><h1 id="8208" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">数据有效性</h1><p id="d042" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">通常，在实际应用中，我们必须确保请求数据满足需求。Micronaut具有内置的Bean验证支持。</p><p id="dac6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的<code class="fe ng nh ni mo b">CreatPostCommand</code>类中，在字段上添加Bean验证注释。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="3a95" class="ms lk iq mo b gy mt mu l mv mw">@Introspected<br/>public record CreatePostCommand(@NotBlank String title, @NotBlank String content) {<br/>}</span></pre><p id="717c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您必须添加<code class="fe ng nh ni mo b">@Introspected</code>注释，让micronaut插件在编译时预处理bean验证注释，并让Bean验证在运行时无需任何反射API即可工作。</p><p id="0f3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe ng nh ni mo b">PostController</code>中，在类上添加一个<code class="fe ng nh ni mo b">@Validated</code>，在方法参数上添加一个<code class="fe ng nh ni mo b">@Valid</code>。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="93d3" class="ms lk iq mo b gy mt mu l mv mw">@Validated<br/>public class PostController {<br/>    public HttpResponse&lt;Void&gt; create(@Body @Valid CreatePostCommand dto) {...}<br/>    //...<br/>}</span></pre><p id="c7ba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们试着创建一个帖子。注意，将<code class="fe ng nh ni mo b">content</code>字段设置为空。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="b9a5" class="ms lk iq mo b gy mt mu l mv mw">curl -X POST -v  -H "Content-Type:application/json" <a class="ae lb" href="http://localhost:8080/posts" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/posts</a> -d "{\"title\":\"test title\",\"content\":\"\"}"<br/>&gt; POST /posts HTTP/1.1<br/>&gt; Host: localhost:8080<br/>&gt; User-Agent: curl/7.55.1<br/>&gt; Accept: */*<br/>&gt; Content-Type:application/json<br/>&gt; Content-Length: 35<br/>&gt;<br/>* upload completely sent off: 35 out of 35 bytes<br/>&lt; HTTP/1.1 400 Bad Request<br/>&lt; Content-Type: application/json<br/>&lt; date: Mon, 25 Oct 2021 09:23:22 GMT<br/>&lt; content-length: 237<br/>&lt; connection: keep-alive<br/>&lt;<br/>{<br/>  "message" : "Bad Request",<br/>  "_embedded" : {<br/>    "errors" : [ {<br/>      "message" : "dto.content: must not be blank"<br/>    } ]<br/>  },<br/>  "_links" : {<br/>    "self" : {<br/>      "href" : "/posts",<br/>      "templated" : false<br/>    }<br/>  }<br/>}</span></pre><h1 id="222e" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">删除帖子</h1><p id="9948" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">根据REST约定，要删除一个帖子，在<code class="fe ng nh ni mo b">/posts/{id}</code>上发送一个<code class="fe ng nh ni mo b">DELETE</code>请求，如果成功，返回204状态。如果<code class="fe ng nh ni mo b">id</code>不存在，则返回一个<code class="fe ng nh ni mo b">404</code>。</p><p id="ead3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将以下代码添加到<code class="fe ng nh ni mo b">PostController</code>中。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="a71a" class="ms lk iq mo b gy mt mu l mv mw">@Delete(uri = "/{id}", produces = MediaType.APPLICATION_JSON)<br/>@Transactional<br/>public HttpResponse&lt;?&gt; deleteById(@PathVariable UUID id) {<br/>    return posts.findById(id)<br/>        .map(p -&gt; {<br/>            this.posts.delete(p);<br/>            return HttpResponse.noContent();<br/>        })<br/>        .orElseThrow(() -&gt; new PostNotFoundException(id));<br/>    //.orElseGet(HttpResponse::notFound);<br/>}</span></pre><h1 id="ee7d" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">处理子资源</h1><p id="b614" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">在我们的应用程序中，a <code class="fe ng nh ni mo b">Comment</code>资源，当添加评论或获取特定帖子的评论时，它应该是<code class="fe ng nh ni mo b">Post</code>资源的子资源，我们可以这样设计评论资源。</p><ul class=""><li id="6588" class="mx my iq jp b jq jr ju jv jy mz kc na kg nb kk nc nd ne nf bi translated"><code class="fe ng nh ni mo b">POST /posts/{id}/comments</code>，给特定的<code class="fe ng nh ni mo b">Post</code>添加一个<code class="fe ng nh ni mo b">Comment</code>资源。</li><li id="f9e1" class="mx my iq jp b jq nj ju nk jy nl kc nm kg nn kk nc nd ne nf bi translated"><code class="fe ng nh ni mo b">GET /posts/{id}/comments</code>，获取id值为路径变量<code class="fe ng nh ni mo b">id</code>的某个<code class="fe ng nh ni mo b">Post</code>的所有评论。</li></ul><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="724c" class="ms lk iq mo b gy mt mu l mv mw">// nested comments endpoints<br/>@Get(uri = "/{id}/comments", produces = MediaType.APPLICATION_JSON)<br/>public HttpResponse&lt;?&gt; getCommentsByPostId(@PathVariable UUID id) {<br/>    return posts.findById(id)<br/>        .map(post -&gt; {<br/>            var comments = this.comments.findByPost(post);<br/>            return ok(comments.stream().map(c -&gt; new CommentDetailsDto(c.getId(), c.getContent(), c.getCreatedAt())));<br/>        })<br/>        .orElseThrow(() -&gt; new PostNotFoundException(id));<br/>    //.orElseGet(HttpResponse::notFound);<br/>}</span><span id="5b37" class="ms lk iq mo b gy no mu l mv mw">@io.micronaut.http.annotation.Post(uri = "/{id}/comments", consumes = MediaType.APPLICATION_JSON)<br/>@Transactional<br/>public HttpResponse&lt;?&gt; create(@PathVariable UUID id, @Body @Valid CreateCommentCommand dto) {</span><span id="f713" class="ms lk iq mo b gy no mu l mv mw">    return posts.findById(id)<br/>        .map(post -&gt; {<br/>            var data = Comment.builder().content(dto.content()).post(post).build();<br/>            post.getComments().add(data);<br/>            var saved = this.comments.save(data);<br/>            return HttpResponse.created(URI.create("/comments/" + saved.getId()));<br/>        })<br/>        .orElseThrow(() -&gt; new PostNotFoundException(id));<br/>    // .orElseGet(HttpResponse::notFound);</span><span id="be28" class="ms lk iq mo b gy no mu l mv mw">}</span></pre><h1 id="44db" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">集成测试</h1><p id="a569" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">下面是一个集成测试的例子，它试图在一个集成环境中用一个真实的数据库测试所有的API，并且运行在一个实时的嵌入式服务器上。</p><pre class="km kn ko kp gt mn mo mp mq aw mr bi"><span id="c108" class="ms lk iq mo b gy mt mu l mv mw">@MicronautTest<br/>@Slf4j<br/>class IntegrationTests {</span><span id="aad7" class="ms lk iq mo b gy no mu l mv mw">    @Inject<br/>    @Client("/")<br/>    HttpClient client;</span><span id="4130" class="ms lk iq mo b gy no mu l mv mw">    @Inject<br/>    EmbeddedApplication&lt;?&gt; application;</span><span id="8fbb" class="ms lk iq mo b gy no mu l mv mw">    @Test<br/>    void testItWorks() {<br/>        Assertions.assertTrue(application.isRunning());<br/>    }</span><span id="312a" class="ms lk iq mo b gy no mu l mv mw">    @Test<br/>    void testGetAllPosts() {<br/>        var response = client.exchange(HttpRequest.GET("/posts"), String.class);</span><span id="a2d7" class="ms lk iq mo b gy no mu l mv mw">        var bodyFlux = Flux.from(response).map(HttpResponse::body);<br/>        StepVerifier.create(bodyFlux)<br/>                .consumeNextWith(posts -&gt; assertThat(JsonPath.from(posts).getInt("totalSize")).isGreaterThanOrEqualTo(2))<br/>                .verifyComplete();<br/>    }</span><span id="613d" class="ms lk iq mo b gy no mu l mv mw">    @Test<br/>    public void testCrudFlow() {<br/>        //create a new post<br/>        var request = HttpRequest.POST("/posts", new CreatePostCommand("test title", "test content"));<br/>        var blockingHttpClient = client.toBlocking();<br/>        var response = blockingHttpClient.exchange(request);<br/>        assertThat(response.status().getCode()).isEqualTo(201);<br/>        var savedUrl = response.getHeaders().get("Location");<br/>        assertThat(savedUrl).isNotNull();<br/>        log.debug("saved post url: {}", savedUrl);</span><span id="a4ab" class="ms lk iq mo b gy no mu l mv mw">        //get by id<br/>        var getPostResponse = blockingHttpClient.exchange(savedUrl, Post.class);<br/>        assertThat(getPostResponse.getStatus().getCode()).isEqualTo(200);</span><span id="afcf" class="ms lk iq mo b gy no mu l mv mw">        // add comments<br/>        var addCommentRequest = HttpRequest.POST(savedUrl + "/comments", new CreateCommentCommand("test content"));<br/>        var addCommentResponse = blockingHttpClient.exchange(addCommentRequest);<br/>        assertThat(addCommentResponse.getStatus().getCode()).isEqualTo(201);<br/>        var savedCommentUrl = addCommentResponse.getHeaders().get("Location");<br/>        assertThat(savedCommentUrl).isNotNull();</span><span id="ad6e" class="ms lk iq mo b gy no mu l mv mw">        // get all comments<br/>        var getAllCommentsRequest = HttpRequest.GET(savedUrl + "/comments");<br/>        var getAllCommentsResponse = blockingHttpClient.exchange(getAllCommentsRequest, Argument.listOf(CommentDetailsDto.class));<br/>        assertThat(getAllCommentsResponse.status().getCode()).isEqualTo(200);<br/>        assertThat(getAllCommentsResponse.body().size()).isEqualTo(1);</span><span id="bc11" class="ms lk iq mo b gy no mu l mv mw">        //delete by id<br/>        var deletePostResponse = blockingHttpClient.exchange(HttpRequest.DELETE(savedUrl));<br/>        assertThat(deletePostResponse.getStatus().getCode()).isEqualTo(204);</span><span id="832c" class="ms lk iq mo b gy no mu l mv mw">        //get by id again(404)<br/>        var e = Assertions.assertThrows(HttpClientResponseException.class, () -&gt;<br/>                blockingHttpClient.exchange(HttpRequest.GET(savedUrl)));<br/>        var getPostResponse2 = e.getResponse();<br/>        assertThat(getPostResponse2.getStatus().getCode()).isEqualTo(404);<br/>    }</span><span id="b209" class="ms lk iq mo b gy no mu l mv mw">}</span></pre><p id="bd74" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe ng nh ni mo b">testGetAllPosts</code>测试中，我们尝试使用反应式<code class="fe ng nh ni mo b">HttpClient</code>API，并使用reactor-test的<code class="fe ng nh ni mo b">StepVerifier</code>断言反应式数据流中的数据。</p><p id="5df4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第二种测试方法是验证创建帖子、添加评论、获取评论和删除帖子的整个流程。</p><p id="a547" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在API集成测试中，测试本身作为一个HTTP客户端(通过一个Http客户端库)与具有定义的API的后端进行交互。理想情况下，您可以使用任何HttpClient来测试API，例如Java 11 HttpClient、OKHttp等。示例库中有一些使用<code class="fe ng nh ni mo b">RestAssured</code>和Java 11新<code class="fe ng nh ni mo b">HttpClient</code>的示例，检查<a class="ae lb" href="https://github.com/hantsy/micronaut-sandbox/tree/master/post-service" rel="noopener ugc nofollow" target="_blank">源代码</a>并自己探索它们。</p><p id="e361" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">示例代码存放在我的GitHub上，请查看<a class="ae lb" href="https://github.com/hantsy/micronaut-sandbox/tree/master/data-jpa-post-service" rel="noopener ugc nofollow" target="_blank">hantsy/micro naut-sandbox #后期服务</a>。</p></div></div>    
</body>
</html>