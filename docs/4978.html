<html>
<head>
<title>Setting Up Self-Signed HTTPS Access To Local Dev K8s Cluster in Minikube</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Minikube中设置对本地Dev K8s群集的自签名HTTPS访问</h1>
<blockquote>原文：<a href="https://itnext.io/setting-up-self-signed-https-access-to-local-dev-k8s-cluster-in-minikube-539bc62ad62f?source=collection_archive---------0-----------------------#2020-11-07">https://itnext.io/setting-up-self-signed-https-access-to-local-dev-k8s-cluster-in-minikube-539bc62ad62f?source=collection_archive---------0-----------------------#2020-11-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3a5df2cdde216664988011887b9b38d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XG8k3ICAf1uKIAxY"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@isisfra?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Isis frana</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure></div><div class="ab cl kd ke hu kf" role="separator"><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki kj"/><span class="kg bw bk kh ki"/></div><div class="ij ik il im in"><h1 id="bf90" class="kk kl iq bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">为什么HTTPS在本地开发集群上</h1><p id="0633" class="pw-post-body-paragraph li lj iq lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf ij bi translated">自从<a class="ae kc" href="https://www.chromium.org/updates/same-site" rel="noopener ugc nofollow" target="_blank"> Google的SameSite Cookie改变推出</a>以来，你会发现测试一个本地Web UI客户端变得越来越困难，API后端运行在一个本地K8s开发集群中。首先，您需要将cookie的<a class="ae kc" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie/SameSite" rel="noopener ugc nofollow" target="_blank"> SameSite </a>设置为“None ”,以便启用跨源请求。然而，只有<code class="fe mg mh mi mj b">SameSite=None</code>设置的cookie也会被谷歌浏览器拒绝，除非你将<code class="fe mg mh mi mj b"><a class="ae kc" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#Secure" rel="noopener ugc nofollow" target="_blank">Secure=true</a></code>设置为只能通过HTTPS连接使用。这使得HTTPS访问成为测试您的本地集群的“必备”工具。</p><h1 id="335f" class="kk kl iq bd km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld mo lf lg lh bi translated">安装证书管理器</h1><p id="f512" class="pw-post-body-paragraph li lj iq lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf ij bi translated">要为您的集群颁发自签名证书，您需要首先安装<a class="ae kc" href="https://cert-manager.io/docs/" rel="noopener ugc nofollow" target="_blank"> cert-manager </a>:</p><ul class=""><li id="f201" class="mp mq iq lk b ll mr lp ms lt mt lx mu mb mv mf mw mx my mz bi translated">使用kubectl安装证书管理器<a class="ae kc" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" rel="noopener ugc nofollow" target="_blank"> CRDs </a> (v1.7.3)</li></ul><pre class="na nb nc nd gt ne mj nf ng aw nh bi"><span id="33c4" class="ni kl iq mj b gy nj nk l nl nm">kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.7.3/cert-manager.crds.yaml</span></pre><ul class=""><li id="a6ed" class="mp mq iq lk b ll mr lp ms lt mt lx mu mb mv mf mw mx my mz bi translated">使用Helm安装证书管理器</li></ul><pre class="na nb nc nd gt ne mj nf ng aw nh bi"><span id="99a7" class="ni kl iq mj b gy nj nk l nl nm"># If you haven't install jetstack helm chart repo yet</span><span id="9b11" class="ni kl iq mj b gy nn nk l nl nm">helm repo add jetstack https://charts.jetstack.io</span><span id="4562" class="ni kl iq mj b gy nn nk l nl nm"># Create namespace for cert-manager</span><span id="8196" class="ni kl iq mj b gy nn nk l nl nm">kubectl create namespace cert-manager</span><span id="f363" class="ni kl iq mj b gy nn nk l nl nm"># install cert manager v1.7.3</span><span id="8cc6" class="ni kl iq mj b gy nn nk l nl nm">helm upgrade --namespace cert-manager --version 1.7.3 --install cert-manager jetstack/cert-manager</span></pre><h1 id="5db0" class="kk kl iq bd km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld mo lf lg lh bi translated">创建自签名证书颁发者</h1><p id="7592" class="pw-post-body-paragraph li lj iq lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf ij bi translated">已安装的cert-manager <a class="ae kc" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" rel="noopener ugc nofollow" target="_blank"> CRDs </a>允许我们创建一个定制的K8s资源—‘cluster issuer ’,它代表一组cert-manager配置，决定如何处理证书请求。这里，我们需要创建一个自签名证书颁发者，如下所示:</p><pre class="na nb nc nd gt ne mj nf ng aw nh bi"><span id="5ef8" class="ni kl iq mj b gy nj nk l nl nm">apiVersion: cert-manager.io/v1<br/>kind: ClusterIssuer<br/>metadata:  <br/>  name: selfsigned-issuer<br/>spec:  <br/>  selfSigned: {}</span></pre><p id="df79" class="pw-post-body-paragraph li lj iq lk b ll mr ln lo lp ms lr ls lt no lv lw lx np lz ma mb nq md me mf ij bi translated">您可以使用“kubectl”从YAML文件创建ClusterIssuer:</p><pre class="na nb nc nd gt ne mj nf ng aw nh bi"><span id="90f6" class="ni kl iq mj b gy nj nk l nl nm">kubectl apply -f <a class="ae kc" href="https://gist.githubusercontent.com/t83714/51440e2ed212991655959f45d8d037cc/raw/7b16949f95e2dd61e522e247749d77bc697fd63c/selfsigned-issuer.yaml" rel="noopener ugc nofollow" target="_blank">https://gist.githubusercontent.com/t83714/51440e2ed212991655959f45d8d037cc/raw/7b16949f95e2dd61e522e247749d77bc697fd63c/selfsigned-issuer.yaml</a></span></pre><p id="43a0" class="pw-post-body-paragraph li lj iq lk b ll mr ln lo lp ms lr ls lt no lv lw lx np lz ma mb nq md me mf ij bi translated">请注意:<code class="fe mg mh mi mj b">ClusterIssuer</code>是一个集群范围(非命名空间)的资源，您只需要为整个集群创建一个。</p><h1 id="53f0" class="kk kl iq bd km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld mo lf lg lh bi translated">设置入口</h1><p id="972c" class="pw-post-body-paragraph li lj iq lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf ij bi translated">首先，如果您还没有这样做，您应该通过以下方式启用内置的<a class="ae kc" href="https://kubernetes.io/docs/tasks/access-application-cluster/ingress-minikube/#enable-the-ingress-controller" rel="noopener ugc nofollow" target="_blank"> minikube入口控制器</a>:</p><pre class="na nb nc nd gt ne mj nf ng aw nh bi"><span id="0e68" class="ni kl iq mj b gy nj nk l nl nm">minikube addons enable ingress</span></pre><p id="8136" class="pw-post-body-paragraph li lj iq lk b ll mr ln lo lp ms lr ls lt no lv lw lx np lz ma mb nq md me mf ij bi translated">要使用创建的ClusterIssuer发布新证书，我们只需在创建入口时添加一个注释— <code class="fe mg mh mi mj b">cert-manager.io/cluster-issuer: selfsigned-issuer</code>来公开集群中的HTTP端点/服务。这里，<code class="fe mg mh mi mj b">selfsigned-issuer</code>是集群发布者的名称。例如:</p><pre class="na nb nc nd gt ne mj nf ng aw nh bi"><span id="c7d5" class="ni kl iq mj b gy nj nk l nl nm">apiVersion: networking.k8s.io/v1 <br/>kind: Ingress <br/>metadata: <br/>  annotations: <br/>    cert-manager.io/cluster-issuer: selfsigned-issuer <br/>  name: local-ingress <br/>spec: <br/>  rules: <br/>  - host: test-app.com <br/>    http: <br/>      paths: <br/>      - backend: <br/>          service:<br/>            name: "my-app-service"<br/>            port: <br/>              number: 80 <br/>        path: "/"<br/>        pathType: "Prefix" <br/>  tls: <br/>  - hosts: <br/>    - test-app.com <br/>    secretName: test-app-cert-tls</span></pre><p id="82d4" class="pw-post-body-paragraph li lj iq lk b ll mr ln lo lp ms lr ls lt no lv lw lx np lz ma mb nq md me mf ij bi translated">上面的ingress配置使用Ingress来公开一个<a class="ae kc" href="https://kubernetes.io/docs/concepts/services-networking/service/" rel="noopener ugc nofollow" target="_blank"> k8s服务</a> (`my-app-service `)并用域<code class="fe mg mh mi mj b">test-app.com</code>的自签名证书来保护它。</p><p id="19ea" class="pw-post-body-paragraph li lj iq lk b ll mr ln lo lp ms lr ls lt no lv lw lx np lz ma mb nq md me mf ij bi translated">要应用入口清单，您可以运行:</p><pre class="na nb nc nd gt ne mj nf ng aw nh bi"><span id="ed72" class="ni kl iq mj b gy nj nk l nl nm">kubectl -n [my-namespace] apply -f ingress.yaml</span></pre><p id="87be" class="pw-post-body-paragraph li lj iq lk b ll mr ln lo lp ms lr ls lt no lv lw lx np lz ma mb nq md me mf ij bi translated">测试域名<code class="fe mg mh mi mj b">test-app.com</code>不需要向任何域名注册商注册。但是您需要将以下条目添加到您的本地机器/etc/hosts文件中(在windows上，它是` c:\ Windows \ System32 \ Drivers \ etc \ hosts ` ),以使域解析到您的` minikube `群集IP:</p><pre class="na nb nc nd gt ne mj nf ng aw nh bi"><span id="51e0" class="ni kl iq mj b gy nj nk l nl nm"># Here 192.168.64.1 is your minikube cluster IP. <br/># You can use command `minikube ip` to find it out.<br/>192.168.64.1    test-app.com</span></pre><p id="6056" class="pw-post-body-paragraph li lj iq lk b ll mr ln lo lp ms lr ls lt no lv lw lx np lz ma mb nq md me mf ij bi translated">&gt;请注意:当您将minikube与<a class="ae kc" href="https://minikube.sigs.k8s.io/docs/drivers/" rel="noopener ugc nofollow" target="_blank"> docker驱动程序</a>一起使用时(例如在苹果M1机器上)，您将无法通过minikube IP访问ingress exposed服务。你需要运行<code class="fe mg mh mi mj b">minikube tunnel</code>来通过本地ip <code class="fe mg mh mi mj b">127.0.0.1</code>提供服务。您还需要在<code class="fe mg mh mi mj b">/etc/hosts</code>中将<code class="fe mg mh mi mj b">minikube.data.gov.au</code>映射到IP <code class="fe mg mh mi mj b">127.0.0.1</code>。</p><h1 id="b055" class="kk kl iq bd km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld mo lf lg lh bi translated">信任自签名证书</h1><p id="bb50" class="pw-post-body-paragraph li lj iq lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf ij bi translated">由于用于保护您的HTTPS端点的证书是自签名证书，您的web浏览器不会识别它，除非您更改系统设置，使您的本地计算机信任该证书。</p><p id="2ffd" class="pw-post-body-paragraph li lj iq lk b ll mr ln lo lp ms lr ls lt no lv lw lx np lz ma mb nq md me mf ij bi translated">在Mac上，您可以执行以下步骤:</p><ul class=""><li id="7f49" class="mp mq iq lk b ll mr lp ms lt mt lx mu mb mv mf mw mx my mz bi translated">导航谷歌浏览器到你的测试域</li><li id="5c8c" class="mp mq iq lk b ll nr lp ns lt nt lx nu mb nv mf mw mx my mz bi translated">一旦看到不可信证书的警告，您可以单击地址栏中的“不安全”按钮，然后从弹出菜单中单击证书项目。</li><li id="2eea" class="mp mq iq lk b ll nr lp ns lt nt lx nu mb nv mf mw mx my mz bi translated">将证书图标(见下文)拖放到桌面上以下载证书文件。</li></ul><figure class="na nb nc nd gt jr gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/e9cedf597abc5640fb6e2836a167ef9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:868/format:webp/1*ku61MX57p5sDXLhHtdia_w.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">拖放证书图标以下载证书</figcaption></figure><ul class=""><li id="89d8" class="mp mq iq lk b ll mr lp ms lt mt lx mu mb mv mf mw mx my mz bi translated">从“实用工具”文件夹中打开“钥匙串访问”应用程序。</li><li id="4118" class="mp mq iq lk b ll nr lp ns lt nt lx nu mb nv mf mw mx my mz bi translated">在左侧面板的“钥匙串”标题下选择“系统”，并在“类别”标题下选择“证书”。</li><li id="b782" class="mp mq iq lk b ll nr lp ns lt nt lx nu mb nv mf mw mx my mz bi translated">将之前下载的证书文件拖放到右侧面板。</li><li id="8047" class="mp mq iq lk b ll nr lp ns lt nt lx nu mb nv mf mw mx my mz bi translated">选择证书并点按“简介”按钮。</li></ul><figure class="na nb nc nd gt jr gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/67a38a61e4e1a0851f83e95fb82af3d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:148/format:webp/1*o5DpOgK8o1dFgYjcCfl2rA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">获取信息按钮</figcaption></figure><ul class=""><li id="06e9" class="mp mq iq lk b ll mr lp ms lt mt lx mu mb mv mf mw mx my mz bi translated">从“信任”部分选择“总是信任”。</li></ul><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/c85bfaeba5ef1fa5c0b72214555cf4dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_pmjuzyqcOLQNSLzMQJ42A.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">证书信息弹出窗口</figcaption></figure><p id="7024" class="pw-post-body-paragraph li lj iq lk b ll mr ln lo lp ms lr ls lt no lv lw lx np lz ma mb nq md me mf ij bi translated">在Windows上，你可以按照下面的文章让Chrome接受windows 10上的自签名证书:</p><div class="nz oa gp gr ob oc"><a href="https://www.pico.net/kb/how-do-you-get-chrome-to-accept-a-self-signed-certificate" rel="noopener  ugc nofollow" target="_blank"><div class="od ab fo"><div class="oe ab of cl cj og"><h2 class="bd ir gy z fp oh fr fs oi fu fw ip bi translated">如何让Chrome接受自签名证书？</h2><div class="oj l"><h3 class="bd b gy z fp oh fr fs oi fu fw dk translated">以下步骤基于用户提供的答案:kgrote，适用于Windows 10上的Chrome 68:导航至…</h3></div><div class="ok l"><p class="bd b dl z fp oh fr fs oi fu fw dk translated">www.pico.net</p></div></div><div class="ol l"><div class="om l on oo op ol oq jw oc"/></div></div></a></div><h1 id="c5e1" class="kk kl iq bd km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld mo lf lg lh bi translated">解决纷争</h1><p id="4cea" class="pw-post-body-paragraph li lj iq lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf ij bi translated">如果在完成上述设置后，您仍然无法使用HTTPS协议访问本地测试域。您可以运行以下命令来获取证书颁发过程中涉及的所有对象的信息:</p><pre class="na nb nc nd gt ne mj nf ng aw nh bi"><span id="ebba" class="ni kl iq mj b gy nj nk l nl nm">kubectl get Issuers,ClusterIssuers,Certificates,CertificateRequests,Orders,Challenges --all-namespaces</span></pre><p id="011f" class="pw-post-body-paragraph li lj iq lk b ll mr ln lo lp ms lr ls lt no lv lw lx np lz ma mb nq md me mf ij bi translated">这将使您对证书颁发过程有一个全面的了解，并帮助您确定问题。</p></div></div>    
</body>
</html>