<html>
<head>
<title>macOS CI on a budget</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">预算上的macOS CI</h1>
<blockquote>原文：<a href="https://itnext.io/macos-ci-on-a-budget-975b26dad425?source=collection_archive---------3-----------------------#2021-07-05">https://itnext.io/macos-ci-on-a-budget-975b26dad425?source=collection_archive---------3-----------------------#2021-07-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/30b4b3c01f1f7ddece7d95e85c50a561.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Nov_kV_5B8mFt1sG.jpg"/></div></div></figure><p id="05ec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">作为开发人员，我们都喜欢观察绿色指示灯的光芒，以及构建和测试我们的应用程序的迷人的技术舞蹈。可惜在iOS的世界里，现实看起来并不那么美好。CI服务对于我们的宠物项目来说是<a class="ae kw" href="https://www.bitrise.io/pricing" rel="noopener ugc nofollow" target="_blank">负担不起的</a>，而租用一台专用的构建机器甚至<a class="ae kw" href="https://www.macstadium.com/pricing" rel="noopener ugc nofollow" target="_blank">更加昂贵</a>。问题当然不是这些服务贪婪，而是我们被捆绑的平台。一个iOS应用只能建立在macOS上，就是这样。</p><p id="0ee8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这篇文章中，我想提供一个解决这个问题的方法，并展示如何使用你自己的苹果电脑，你已经使用它作为一个CI机器。我们将使用<a class="ae kw" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank"> GitHub Actions </a>作为CI框架，使用<a class="ae kw" href="https://www.virtualbox.org" rel="noopener ugc nofollow" target="_blank"> VirtualBox </a>在后台运行我们的CI机器。唯一的要求是，你的电脑上必须有一台x86架构的苹果电脑和至少100GB的磁盘空间。据我所知，VirtualBox <a class="ae kw" href="https://forums.virtualbox.org/viewtopic.php?t=98742" rel="noopener ugc nofollow" target="_blank">不支持</a>M1架构。不过，您可以使用其他虚拟化解决方案，如<a class="ae kw" href="https://www.parallels.com" rel="noopener ugc nofollow" target="_blank"> Parallels </a>或<a class="ae kw" href="https://www.vmware.com/products/fusion.html" rel="noopener ugc nofollow" target="_blank"> VMware Fusion </a>，来实现相同的结果。</p><h1 id="183f" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">放弃</h1><p id="f599" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">运行虚拟化的macOS是一个历史上敏感的话题。据我所知，在苹果的EULA下，我们在这里做的一切都是合法的。我们不是越狱或运行黑客程序。我们在正版macOS上运行虚拟化macOS，这在EULA的以下条款中有所提及。</p><p id="aa5f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://www.apple.com/legal/sla/docs/macOSBigSur.pdf" rel="noopener ugc nofollow" target="_blank">引用</a> : <em class="ma"> (iii)在您拥有或控制的已经运行苹果软件的每台苹果电脑的虚拟操作系统环境中安装、使用和运行最多两(2)份苹果软件的附加副本或实例，目的是:(a)软件开发；(b)软件开发期间的测试；使用macOS服务器；或(d)个人非商业用途。</em></p><p id="0728" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当然，用你最好的判断，因为我不是律师，不能给你这方面的建议。</p><h1 id="a3e4" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">什么是GitHub动作</h1><p id="3193" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">正如GitHub自己所说，<em class="ma">“GitHub Actions是GitHub上因果的API:编排任何工作流，基于任何事件”</em>。我将使用这个特殊的平台，因为如果你提供你自己的<a class="ae kw" href="https://docs.github.com/en/actions/hosting-your-own-runners/about-self-hosted-runners" rel="noopener ugc nofollow" target="_blank">构建机器</a>，它将免费为你提供大量的特性。在我们的情况下，这真的很令人兴奋，因为通过提供我们机器的一部分，我们可以获得全功能的macOS CI。</p><p id="504f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">GitHub Actions不仅仅是构建你的项目。您可以用它做任何事情，包括优秀的Bash脚本。该平台使用YAML文件来设置由步骤定义的构建过程。这些步骤可以是任何东西，从你自己的脚本到社区编写的<a class="ae kw" href="https://github.com/marketplace?category=&amp;type=actions" rel="noopener ugc nofollow" target="_blank">大型库</a>和官方步骤。很可能，您可能需要的一切都已经为您编写好了，这使得您的CI设置非常通用。</p><p id="cb76" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">GitHub还提供了自己的构建服务器，甚至还有免费的每月分钟数供你试用。不幸的是，在iOS世界里，问题依然存在。在GitHub上，构建时间对我们来说非常昂贵，与Linux分钟相比，它是以10的倍数计算的。</p><p id="bccf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可能会问，我们如何将我们的机器用作构建服务器。GitHub让它变得非常简单。在你的机器上启动GitHub Action Runner(<a class="ae kw" href="https://oleksandrkirichenko.com/blog/github-runner-on-synology/" rel="noopener ugc nofollow" target="_blank">我有另一篇关于如何在Synology NAS </a>上运行它的文章)，并将其链接到你的帐户，完成。一旦您的机器被链接，您在YAML文件中指定您想要使用一个自托管的构建机器，那么一切都工作得很好。</p><p id="650a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">正如我前面提到的，我们将在虚拟机上运行GitHub Actions Runner。有几个原因可以解释你为什么想这么做。首先也是最重要的，是安全问题。因为您将运行社区提供的第三方代码，所以您不希望这些代码在您的主机上运行。其次，方便。我们不希望这个进程在我们的机器上不受控制地运行，产生进程并安装各种软件。通过将它转移到虚拟机，我们隔离了该环境，因此我们不需要太担心那里会发生什么。当然，虚拟机将拥有可管理的分配内存量，在后台整洁地运行。</p><p id="7dd9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">听起来不错，对吧？现在让我们试着把这个付诸实践。</p><h1 id="aed2" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">把所有的放在一起</h1><p id="d3d1" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">安装过程可能相当繁琐，所以一定要按照每一步操作，不要跳过任何“不必要”的东西。在安装过程中，我们将创建一个可引导的ISO文件，用于在虚拟机上安装macOS。接下来，我们将准备一个足以构建iOS项目的构建环境。一切准备就绪后，我们就可以将它链接到我们的GitHub帐户了。作为最后一步，我们将设置最棘手的部分，当我们的机器启动时，让一切在后台自动启动。</p><h1 id="c5e7" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">创建可引导的ISO文件</h1><p id="563b" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">macOS发行版<a class="ae kw" href="https://support.apple.com/en-us/HT201372" rel="noopener ugc nofollow" target="_blank">拥有创建可引导ISO映像所需的一切</a>，因此我们在这里不会使用任何不必要的第三方工具。你需要的只是官方的macOS发行版和终端。</p><ol class=""><li id="fc85" class="mb mc iq ka b kb kc kf kg kj md kn me kr mf kv mg mh mi mj bi translated">确保您有大约30GB的可用磁盘空间来执行此过程。</li><li id="8036" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">从<a class="ae kw" href="https://apps.apple.com/de/app/macos-big-sur/id1526878132" rel="noopener ugc nofollow" target="_blank"> Mac应用商店</a>下载macOS。是的，如果你是新手，即使你已经在使用这个macOS版本，你也可以从Mac App Store下载macOS。我在我的主机上使用的是Big Sur 11.4，我打算在虚拟机上安装相同版本的macOS。如果你用相同版本的macOS跟我学就更好了。</li><li id="758e" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">创建一个临时磁盘映像，我们将使用它来创建macOS安装ISO <code class="fe mp mq mr ms b">hdiutil create -o /tmp/BigSur -size 16G -layout SPUD -fs HFS+J -type SPARSE</code></li><li id="df25" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">安装它<code class="fe mp mq mr ms b">hdiutil attach /tmp/BigSur.sparseimage -noverify -mountpoint /Volumes/mac_install</code></li><li id="28f9" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">使用macOS发行版中的<code class="fe mp mq mr ms b">createinstallmedia</code>实用程序，使挂载的映像成为macOS安装映像<code class="fe mp mq mr ms b">sudo /Applications/Install\ macOS\ Big\ Sur.app/Contents/Resources/createinstallmedia --volume /Volumes/mac_install</code></li><li id="bc09" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">卸下它<code class="fe mp mq mr ms b">hdiutil detach /Volumes/Install\ macOS\ Big\ Sur</code>。如果它总是占线，您可能需要<code class="fe mp mq mr ms b">-force</code>标志。</li><li id="1d65" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">将稀疏图像转换成ISO图像<code class="fe mp mq mr ms b">hdiutil convert /tmp/BigSur.sparseimage -format UDTO -o /tmp/BigSur.iso</code></li><li id="f349" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">将你的ISO文件移动到桌面，将扩展名从<code class="fe mp mq mr ms b">cdr</code>改为<code class="fe mp mq mr ms b">iso</code> <code class="fe mp mq mr ms b">mv /tmp/BigSur.iso.cdr ~/Desktop/BigSur.iso</code></li><li id="8020" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">删除临时图像<code class="fe mp mq mr ms b">rm /tmp/BigSur.sparseimage</code></li></ol><p id="da6d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就是这样。现在您有了一个可引导的ISO文件来安装macOS，我们可以进入下一步了。</p><h1 id="aba1" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">创建虚拟机</h1><p id="607a" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我在撰写本文时的VirtualBox版本是6.1.22，如果您想在相同的环境中遵循这些步骤，这可能很重要。</p><ol class=""><li id="fb68" class="mb mc iq ka b kb kc kf kg kj md kn me kr mf kv mg mh mi mj bi translated">安装VirtualBox + VirtualBox扩展包。可以从<a class="ae kw" href="https://www.virtualbox.org/wiki/Downloads" rel="noopener ugc nofollow" target="_blank">官网</a>获取，按照说明安装。在安装过程中，您需要在系统偏好设置- &gt;安全&amp;隐私中允许Oracle扩展。不需要额外的设置。</li><li id="6b60" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">如果看不到内存设置，请按CMD+N创建一个新的虚拟机，并将此屏幕切换到专家模式。</li><li id="d806" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">在向导的第一个屏幕上，我使用了以下设置。名称:<code class="fe mp mq mr ms b">BigSurCI</code>，类型:<code class="fe mp mq mr ms b">Mac OS X</code>，版本:<code class="fe mp mq mr ms b">Mac OS X (64-bit)</code>，内存大小:<code class="fe mp mq mr ms b">4096 MB</code>，硬盘:<code class="fe mp mq mr ms b">Create a virtual hard disk now</code>。</li><li id="87f7" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">接下来，在第二个屏幕上。文件大小:<code class="fe mp mq mr ms b">160 GB</code>(这个很多，可以减小大小，但我会建议至少100GB，Xcode和CI会占很大空间)，类型:<code class="fe mp mq mr ms b">VDI</code>，物理硬盘上的存储:<code class="fe mp mq mr ms b">Dynamically allocated</code>(如果不在乎磁盘空间，固定大小大概会好一点)。</li><li id="ecca" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">点击创建按钮。现在让我们在安装macOS之前对这台机器做一些小的调整。</li><li id="dae4" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">按CMD+S打开虚拟机设置并更改以下参数。</li><li id="b946" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">系统-&gt;处理器-&gt;处理器:<code class="fe mp mq mr ms b">2</code>。</li><li id="f7d0" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">显示-&gt;屏幕-&gt;显存:<code class="fe mp mq mr ms b">128</code>。</li><li id="a2c7" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">音频-&gt;启用音频:<code class="fe mp mq mr ms b">off</code>。</li><li id="0e97" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">网络-&gt;适配器1 -&gt;高级-&gt;端口转发。添加以下规则:名称:<code class="fe mp mq mr ms b">SSH Rule</code>，协议:<code class="fe mp mq mr ms b">TCP</code>，主机IP: <code class="fe mp mq mr ms b">127.0.0.1</code>，主机端口:<code class="fe mp mq mr ms b">2222</code>，访客IP: <code class="fe mp mq mr ms b">leave it blank</code>，访客端口:<code class="fe mp mq mr ms b">22</code>。有了这些设置，您应该能够通过连接到<code class="fe mp mq mr ms b">127.0.0.1:2222</code>经由SSH连接到您的虚拟机。稍后，您需要启用远程登录功能才能使其工作。</li><li id="0d80" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">Storage -&gt; Optical Drive:通过单击磁盘图标选择您在上一步中创建的BigSur ISO文件。</li></ol><h1 id="778c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">安装macOS</h1><ol class=""><li id="66a5" class="mb mc iq ka b kb lv kf lw kj mt kn mu kr mv kv mg mh mi mj bi translated">启动虚拟机，并在对话框中选择您的ISO来启动机器。在这个阶段，您将被要求允许输入监控。</li><li id="23de" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">等待几分钟让机器加载，然后选择您喜欢的语言。</li><li id="b0ae" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">打开<code class="fe mp mq mr ms b">Disk Utility</code>。</li><li id="8c7b" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">选择<code class="fe mp mq mr ms b">VBOX HARDDISK</code>介质并按下擦除按钮，设置如下。名称:<code class="fe mp mq mr ms b">Macintosh HD</code>，格式:<code class="fe mp mq mr ms b">Mac OS Extended (Journaled)</code>，方案:<code class="fe mp mq mr ms b">GUID</code>。</li><li id="f163" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">关闭<code class="fe mp mq mr ms b">Disk Utility</code>，选择<code class="fe mp mq mr ms b">Install macOS Big Sur</code>。</li><li id="cc5f" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">仔细阅读许可协议，选择新格式化的驱动器。点击“继续”并等待。</li><li id="50ba" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">现在系统已经安装好了，您必须完成不断增长的macOS onboarding过程。性能很可能绝对无法使用。经历一下这个。这很好，因为它不会影响CI性能。入职完成后，系统启动并显示dock可能需要几分钟时间。耐心点。</li><li id="17f8" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">右击桌面-&gt;改变桌面背景-&gt;屏保:禁用屏保。</li><li id="449a" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">系统首选项-&gt;能源服务器:禁用所有睡眠设置，并将睡眠定时器设置为<code class="fe mp mq mr ms b">Never</code>。如果您仍然遇到计算机进入睡眠的问题，您可以随时使用<a class="ae kw" href="https://apps.apple.com/de/app/amphetamine/id937984704?l=en&amp;mt=12" rel="noopener ugc nofollow" target="_blank">这个应用程序</a>来解决这个问题。</li><li id="7344" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">系统系统首选项-&gt;用户和组-&gt;登录选项为您的用户启用<code class="fe mp mq mr ms b">Automatic Login</code>。</li><li id="5cb7" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">系统偏好设置-&gt;共享:启用<code class="fe mp mq mr ms b">Remote Login</code>。</li></ol><p id="bb07" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">既然我们已经经历了这一切，我们终于可以开始收获我们所播种的了。让我们设置我们需要的一切，以便我们的CI可以建立一个应用程序，然后当我们看到它可以工作时，我们可以做最后的抛光。</p><ol class=""><li id="557d" class="mb mc iq ka b kb kc kf kg kj md kn me kr mf kv mg mh mi mj bi translated">打开<a class="ae kw" href="https://developer.apple.com/download/" rel="noopener ugc nofollow" target="_blank">苹果开发者门户</a>，在该系统上下载并安装当前Xcode版本。记住安装后至少运行一次。</li><li id="cdb4" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">最后，我们可以离开我们虚拟机的UI，切换到终端。使用<code class="fe mp mq mr ms b">ssh username@127.0.0.1 -p 2222</code>登录您的机器。当然，使用您的用户名和密码。如果您愿意，可以继续在虚拟机的终端中执行所有操作。</li><li id="083e" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">Do xcode-select <code class="fe mp mq mr ms b">sudo xcode-select -s /Applications/Xcode.app/Contents/Developer</code>。</li><li id="a5a0" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">安装<a class="ae kw" href="https://brew.sh" rel="noopener ugc nofollow" target="_blank">自制</a>T0】。这可能需要一些时间，因为Xcode的<code class="fe mp mq mr ms b">Command Line Tools</code>需要和它一起安装。安装时可能会卡住。重新启动系统并再次执行此步骤可能会有所帮助。如果你在完成<code class="fe mp mq mr ms b">Command Line Tools</code>安装步骤时一直有问题，你可以事先用一个单独的<code class="fe mp mq mr ms b">xcode-select --install</code>命令来完成。</li><li id="6ea8" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">安装<a class="ae kw" href="https://cocoapods.org" rel="noopener ugc nofollow" target="_blank">椰子</a>T4】</li><li id="43b5" class="mb mc iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">安装<a class="ae kw" href="https://fastlane.tools" rel="noopener ugc nofollow" target="_blank">浪子</a>T5】</li></ol><p id="768d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">既然我们现在有了一个完整的构建环境，这应该足以构建几乎任何原生iOS项目。是时候安装GitHub Actions Runner了，它将在这台机器上构建您的项目。</p><p id="1b41" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将<a class="ae kw" href="https://docs.github.com/en/actions/hosting-your-own-runners/adding-self-hosted-runners" rel="noopener ugc nofollow" target="_blank">将GitHub Actions Runner </a>添加到一个存储库中，以简化这个过程。当然，您可以将其添加到您的组织中，以便在您的所有项目中共享。要将GitHub Actions Runner添加到您的存储库中，请在GitHub上打开您的存储库，进入设置- &gt;操作- &gt; Runners，单击添加Runner。您将看到如何下载和激活您的跑步者的说明。按照这些说明，您将拥有一个完全配置好并准备运行的CI。你现在可以试一试。</p><h1 id="1941" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">最后的步骤</h1><p id="fa8d" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">虽然您的CI现在已经启动并运行，但还远远不够完美。你仍然有VirtualBox和一个虚拟机在dock中运行。更有甚者，如果你重启电脑，所有的魔力都会瞬间消失。让我们来解决这个问题，使这个设置尽可能无缝。为此，我们将在主机和虚拟机上都使用<code class="fe mp mq mr ms b">launchd</code>。在我们的主机上，我们需要让虚拟机在后台自动启动。另一方面，虚拟机应该在启动时自动启动GitHub Actions Runner。<code class="fe mp mq mr ms b">launchd</code>文件的语法相当复杂。如果你想做一些定制，我可以推荐一个<a class="ae kw" href="https://www.launchd.info" rel="noopener ugc nofollow" target="_blank">极好的资源</a>，里面有所有这些设置的描述。</p><p id="604b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在使用<code class="fe mp mq mr ms b">sudo</code>权限的虚拟机上，我们创建了一个<code class="fe mp mq mr ms b">launchd</code>文件，当系统启动时，它将启动GitHub Actions Runner。此外，我们将设置<code class="fe mp mq mr ms b">KeepAlive</code>来保持其运行，并在出现故障时重启。创建文件<code class="fe mp mq mr ms b">sudo vim /Library/LaunchAgents/org.my.actions.runner.plist</code>并将以下内容复制到其中。不要忘记将文件路径更新到虚拟机上正确的<code class="fe mp mq mr ms b">run.sh</code>位置。</p><pre class="mw mx my mz gt na ms nb nc aw nd bi"><span id="5a59" class="ne ky iq ms b gy nf ng l nh ni">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br/>&lt;!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;<br/>&lt;plist version="1.0"&gt;<br/>&lt;dict&gt;<br/>    &lt;key&gt;Disabled&lt;/key&gt;  &lt;false/&gt;<br/>    &lt;key&gt;RunAtLoad&lt;/key&gt; &lt;true/&gt;<br/>    &lt;key&gt;KeepAlive&lt;/key&gt; &lt;true/&gt;<br/>    &lt;key&gt;Label&lt;/key&gt;     &lt;string&gt;org.my.actions.runner&lt;/string&gt;<br/>    &lt;key&gt;EnvironmentVariables&lt;/key&gt;<br/>      &lt;dict&gt;<br/>        &lt;key&gt;PATH&lt;/key&gt;<br/>	&lt;string&gt;/bin:/usr/bin:/usr/local/bin&lt;/string&gt;<br/>        &lt;key&gt;RUNNER_ALLOW_RUNASROOT&lt;/key&gt;<br/>        &lt;string&gt;1&lt;/string&gt;<br/>        &lt;key&gt;LC_ALL&lt;/key&gt;<br/>        &lt;string&gt;en_US.UTF-8&lt;/string&gt;<br/>        &lt;key&gt;LANG&lt;/key&gt;<br/>        &lt;string&gt;en_US.UTF-8&lt;/string&gt;<br/>      &lt;/dict&gt;<br/>    &lt;key&gt;ProgramArguments&lt;/key&gt;<br/>        &lt;array&gt;<br/>            &lt;string&gt;/Users/test/actions-runner/run.sh&lt;/string&gt;<br/>        &lt;/array&gt;<br/>&lt;/dict&gt;<br/>&lt;/plist&gt;</span></pre><p id="39ca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">重启你的虚拟机<code class="fe mp mq mr ms b">sudo shutdown -r now</code>，确保GitHub Actions Runner已经启动。重启后，您可以通过重新登录到<code class="fe mp mq mr ms b">ssh</code>并执行类似于<code class="fe mp mq mr ms b">ps -ax | grep runner</code>的操作来验证它已经启动。或者，你可以在你添加它的页面上看到它在GitHub上运行。它应该出现在跑步者列表中，旁边有一个绿色指示器。如果它不能正常工作，我建议在我们刚刚创建的<code class="fe mp mq mr ms b">plist</code>中设置日志路径，并在前面提到的网站上寻找更多的故障排除建议。</p><p id="247e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此时，您的虚拟机是完全自动化的。我们的下一个也是最后一个任务是让这台机器在你的计算机启动时在后台运行。我们将对<code class="fe mp mq mr ms b">launchd</code>使用与GitHub Actions Runner相同的方法。</p><p id="6511" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在主机上使用<code class="fe mp mq mr ms b">sudo</code>权限创建一个包含以下内容的<code class="fe mp mq mr ms b">launchd</code> <code class="fe mp mq mr ms b">sudo vim /Library/LaunchAgents/org.github.actions.vm.launch.plist</code>文件。同样，记得检查VirtualBox的路径和虚拟机的名称。</p><pre class="mw mx my mz gt na ms nb nc aw nd bi"><span id="4437" class="ne ky iq ms b gy nf ng l nh ni">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br/>&lt;!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;<br/>&lt;plist version="1.0"&gt;<br/>&lt;dict&gt;<br/>    &lt;key&gt;Disabled&lt;/key&gt;  &lt;false/&gt;<br/>    &lt;key&gt;RunAtLoad&lt;/key&gt; &lt;true/&gt;<br/>    &lt;key&gt;KeepAlive&lt;/key&gt; &lt;true/&gt;<br/>    &lt;key&gt;Label&lt;/key&gt;     &lt;string&gt;org.github.actions.vm.launch&lt;/string&gt;<br/><br/>    &lt;key&gt;ProgramArguments&lt;/key&gt;<br/>        &lt;array&gt;<br/>            &lt;string&gt;/Applications/VirtualBox.app/Contents/MacOS/VBoxManage&lt;/string&gt;<br/>            &lt;string&gt;startvm&lt;/string&gt;<br/>            &lt;string&gt;BigSurCI&lt;/string&gt;<br/>            &lt;string&gt;--type&lt;/string&gt;<br/>            &lt;string&gt;headless&lt;/string&gt;<br/>        &lt;/array&gt;<br/>&lt;/dict&gt;<br/>&lt;/plist&gt;</span></pre><p id="cb6a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">重新启动计算机，打开VirtualBox应用程序，检查虚拟机是否在后台运行。此外，检查您的跑步者是否仍在GitHub上运行。</p><p id="b5a2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我想指出的是，除了切换<code class="fe mp mq mr ms b">plist</code>中的<code class="fe mp mq mr ms b">Disabled</code>标志并重启电脑之外，我没有找到在后台快速停止这台机器的方法。如果你只是在VirtualBox中关闭它，它会立即重新启动。如果你知道解决这个问题的更好的方法，我将非常感谢你的建议。</p><h1 id="2917" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">结论</h1><p id="194c" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">如果您预算紧张，这可能是您获得真正的macOS CI的一个好选择。我尝试了一个月的设置，从我个人的经验来看，我遇到的唯一问题是在DaVinci Resolve中编辑视频，这种问题一直持续到我关闭虚拟机。你也必须牺牲少量的内存，但你可能不会注意到它。另一个值得一提的负面影响是，如果您在构建期间将机器置于睡眠模式，构建将会失败。这些是我个人注意到的唯一的问题，坦率地说，我预计会有更多的问题。反正选择权在你。我个人倾向于裸机设置，并希望<a class="ae kw" href="https://en.wikipedia.org/wiki/Hypervisor#Classification" rel="noopener ugc nofollow" target="_blank"> type 1虚拟机监控程序</a>很快可以在苹果M1处理器上使用。保持健康，祝你实验好运！</p><h1 id="a96b" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">提到的软件版本</h1><p id="3fa4" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">电脑:<code class="fe mp mq mr ms b">iMac 2019 3,2 GHz 6-Core Intel Core i7 16 GB</code> <br/> MacOS: <code class="fe mp mq mr ms b">BigSur 11.4</code> <br/>虚拟盒子:<code class="fe mp mq mr ms b">6.1.22</code><br/>GirHub Actions Runner:<code class="fe mp mq mr ms b">actions-runner-osx-x64-2.278.0.tar.gz</code><br/>CocoaPods:<code class="fe mp mq mr ms b">1.10.1</code><br/>fast lane:<code class="fe mp mq mr ms b">2.185.1</code><br/>Xcode:<code class="fe mp mq mr ms b">12.5</code></p></div><div class="ab cl nj nk hu nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ij ik il im in"><p id="5c22" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ma">考虑开发一个Flutter或者iOS的app，或者找咨询或者人力？从初创企业到公司层面，我都可以雇佣。只需</em> <a class="ae kw" href="https://oleksandrkirichenko.com/contact/" rel="noopener ugc nofollow" target="_blank"> <em class="ma">联系我</em> </a> <em class="ma">看看我们能一起做些什么！</em></p><p id="4d4d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ma">喜欢这篇文章？别忘了砸这个拍手</em>👏按钮让我感觉很棒，有动力写更多！</p><p id="0277" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ma">原载于</em><a class="ae kw" href="https://oleksandrkirichenko.com/blog/macos-ci-on-a-budget/" rel="noopener ugc nofollow" target="_blank"><em class="ma">https://oleksandrkirichenko.com</em></a><em class="ma">。</em></p></div></div>    
</body>
</html>