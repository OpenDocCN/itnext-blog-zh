<html>
<head>
<title>Six Ways to Take Your Terraform to the Next Level</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">六种方法让你的地形更上一层楼</h1>
<blockquote>原文：<a href="https://itnext.io/six-ways-to-take-your-terraform-to-the-next-level-e08b3e21b243?source=collection_archive---------1-----------------------#2021-11-07">https://itnext.io/six-ways-to-take-your-terraform-to-the-next-level-e08b3e21b243?source=collection_archive---------1-----------------------#2021-11-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/24960b6d995ab22daaddebe546b20508.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*g7NLGMYFrvOa5Aaj"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">“通向无限，甚至更远！”<a class="ae kf" href="https://unsplash.com/@zoltantasi?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Zoltan·塔斯</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="c7ed" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Terraform无需介绍。它是事实上的云基础设施供应和生命周期管理工具，截至2021年，有X个用户分布在Y个云提供商中。此外，随着1.0版本的发布，它没有表现出放缓或淡出的迹象。</p><p id="5202" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Terraform是开源的，这意味着它由社区使用和支持。这意味着应该如何使用、构建和管理它的方法和观点可能会不同。这篇文章也不例外，但是请记住，我下面概述的工具和策略来自社区和个人经验。YMMV！</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><ol class=""><li id="0ca2" class="ll lm it ki b kj kk kn ko kr ln kv lo kz lp ld lq lr ls lt bi translated"><strong class="ki iu">调整你的模块</strong></li></ol><figure class="lv lw lx ly gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi lu"><img src="../Images/339c47c6ac29b67438e0f7ed95be3f7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-O8w96prAiXyVwAK"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@glencarrie?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Glen Carrie </a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="7a0e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">为您打算在多个团队之间共享或开源的模块使用单独的Git存储库。</strong>当您有一个其他团队可能会贡献或经常使用的模块时，这是非常理想的。缺点之一是它增加了开发工作量。当您对正在讨论的子模块进行更改时，需要在两个不同的存储库中有两个单独的pull请求来使您的更改到位:一个用于子模块，另一个用于项目，以更新模块的标记或分支。在一些组织中，这种程度的抽象和额外的分离可能是可以容忍的；在其他情况下，它会阻碍开发到不可持续的程度，尤其是在处理许多模块的时候。这完全取决于什么最适合您的用例。</p><p id="0fd6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">如果你不需要在团队之间共享代码，或者如果所讨论的代码是非常特定于你的项目的，那么在你的项目中为模块使用一个子文件夹。</strong>比方说，你想将Azure中跨环境重复部署的几个资源组合在一起。出于我们的目的，该模块将部署一个AKS集群、一个数据库、Redis和一个事件中心。为了简化开发，模块可以存储在与根项目相同的repo中，以便简化开发。这允许更快的开发，允许您在一次提交下标记所有内容。</p><p id="e3d4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">和上面的方法一样，这个决定也有它自己的挑战。最明显的是，您不能再孤立地开发一个模块:您的代码将与其他可能比您移动得更快或更慢的代码一起提交和合并，所有这些都在同一个存储库中。将模块分离到它们自己的repos中，可以更好地控制调用子模块的版本，而不必在标签中挑选提交。</p><p id="269c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，<strong class="ki iu">我强烈建议不要为单个资源</strong>使用一个模块，除非你有非常好的理由这样做。为了确保你的代码是干巴巴的，也为了执行全面的标准，使用局部变量和变量，并尽量使用合理的默认值。为此使用单资源模块很麻烦，并且模糊了底层资源的配置，这意味着要花费更多的精力来维护本应非常简单的东西。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="fda8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu"> 2。使用</strong> <a class="ae kf" href="https://tfsec.dev/" rel="noopener ugc nofollow" target="_blank"> <strong class="ki iu"> tfsec </strong> </a> <strong class="ki iu">扫描安全漏洞和误配置</strong></p><figure class="lv lw lx ly gt ju gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/56b54df133525f14131bada53d0282d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/format:webp/1*JTl6BB5WyVU15A1fE3VyrA.png"/></div></figure><p id="99e9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://tfsec.dev/" rel="noopener ugc nofollow" target="_blank"> tfsec </a>是Aqua Security推出的一款非常棒的工具，它可以扫描您的Terraform配置文件，查找安全问题和错误配置。它易于安装，可以轻松集成到您的CI渠道中。文档非常优秀，包括不安全配置的示例以及如何修复它们。这里有一个关于VPC配置的示例:</p><pre class="lv lw lx ly gt ma mb mc md aw me bi"><span id="72cc" class="mf mg it mb b gy mh mi l mj mk">resource "aws_network_acl_rule" "bad_example" {<br/>  egress         = false<br/>  protocol       = "tcp"<br/>  from_port      = 22<br/>  to_port        = 22<br/>  rule_action    = "allow"<br/>  cidr_block     = "0.0.0.0/0"<br/>}</span></pre><p id="6143" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这将导致tfsec失败，因为让你的VPC对互联网开放，<em class="ml">尤其是在端口22 </em>上，是一个糟糕的主意。当我在本地测试时，我看到了预期的行为:</p><pre class="lv lw lx ly gt ma mb mc md aw me bi"><span id="0d28" class="mf mg it mb b gy mh mi l mj mk">$ tfsec .</span><span id="c130" class="mf mg it mb b gy mm mi l mj mk"><strong class="mb iu">Result 1</strong></span><span id="df7c" class="mf mg it mb b gy mm mi l mj mk">[aws-vpc-no-public-ingress][<strong class="mb iu">CRITICAL</strong>] Resource 'aws_network_acl_rule.bad_example' defines a Network ACL rule that allows specific ingress ports from anywhere.</span><span id="bf2b" class="mf mg it mb b gy mm mi l mj mk">/Users/admin/nacl.tf:1-8</span><span id="a90c" class="mf mg it mb b gy mm mi l mj mk">1 | <strong class="mb iu">resource "aws_network_acl_rule" "bad_example" {<br/></strong>2 | <strong class="mb iu">  egress         = false<br/></strong>3 | <strong class="mb iu">  protocol       = "tcp"<br/></strong>4 | <strong class="mb iu">  from_port      = 22<br/></strong>5 | <strong class="mb iu">  to_port        = 22<br/></strong>6 | <strong class="mb iu">  rule_action    = "allow"<br/></strong>7 | <strong class="mb iu">  cidr_block     = "0.0.0.0/0"<br/></strong>8 | <strong class="mb iu">}<br/></strong>9 |</span><span id="b572" class="mf mg it mb b gy mm mi l mj mk">Legacy ID:  AWS049</span><span id="5d36" class="mf mg it mb b gy mm mi l mj mk">Impact:     The ports are exposed for ingressing data to the internet</span><span id="302b" class="mf mg it mb b gy mm mi l mj mk">Resolution: Set a more restrictive cidr range</span><span id="8a64" class="mf mg it mb b gy mm mi l mj mk">More Info:<br/>- https://tfsec.dev/docs/aws/vpc/no-public-ingress#aws/vpc</span><span id="37da" class="mf mg it mb b gy mm mi l mj mk">- <a class="ae kf" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/network_acl_rule#cidr_block" rel="noopener ugc nofollow" target="_blank">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/network_acl_rule#cidr_block</a><br/>- https://docs.aws.amazon.com/vpc/latest/userguide/vpc-network-acls.html</span></pre><p id="1ef5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">tfsec发现我的VPC在端口22上是可公开访问的，这很理想，因为我们不希望任何人通过SSH进入我们的VPC。但是，如果我真的需要公开它，该怎么办呢？如果它是堡垒网络的一部分呢？别担心。我们只需设置<code class="fe mn mo mp mb b">-e</code>标志来忽略该规则并再次运行它:</p><pre class="lv lw lx ly gt ma mb mc md aw me bi"><span id="60d7" class="mf mg it mb b gy mh mi l mj mk">$ tfsec -e aws-vpc-no-public-ingress<br/>...<br/><strong class="mb iu">No problems detected!</strong></span></pre><p id="9fa6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们还可以在代码中添加一个注释来忽略特定的规则，这比在命令行中为每个规则添加一个exclude要有效得多。<a class="ae kf" href="https://github.com/aquasecurity/tfsec#ignoring-warnings" rel="noopener ugc nofollow" target="_blank">更多相关文档可在此处找到</a>。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="071d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu"> 3。使用变量验证来强制云提供商和内部命名约定<br/> </strong>验证输入变量将节省您的时间，并防止在您的环境中出现输入错误。而不是等待Terraform初始化、规划、应用，然后最终等待AWS/Azure/GCP等。API拒绝您的请求，您可以从一开始就验证您的输入。这是一个非常简单、非常有用的验证Azure存储帐户的选项:</p><pre class="lv lw lx ly gt ma mb mc md aw me bi"><span id="4546" class="mf mg it mb b gy mh mi l mj mk">variable "sa_account_name" {<br/>  type        = string<br/>  description = "The name of the Azure Storage account."</span><span id="bf5a" class="mf mg it mb b gy mm mi l mj mk">  validation {<br/>    condition     <strong class="mb iu">=</strong> length(var.sa_account_name) <strong class="mb iu">&gt;</strong> 2 <strong class="mb iu">&amp;&amp;</strong> length(var.sa_account_name) &lt; 25 substr(var.<strong class="mb iu">image_id</strong>, 0, 4) <strong class="mb iu">==</strong> "ami-"<br/>    error_message <strong class="mb iu">=</strong> "Azure Storage Account names must be between 3 and 24 characters in length."<br/>  }<br/>  validation {<br/>    condition.    = can(regex("[A-Z]+", var.sa_account_name))<br/>    error_message = "Azure Storage Account names must not contain uppercase characters."</span><span id="3f4c" class="mf mg it mb b gy mm mi l mj mk">}</span></pre><p id="23f3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这里，我们确保我们作为Azure存储帐户名传递的任何内容都符合Azure存储命名约定。当Azure API不可避免地告诉我名称中不能有大写字符，或者帐户名太长时，这使我不必等待Terraform初始化、计划，然后使apply失败。注意，我这里没有针对特殊字符的正则表达式——它在我的列表中，但是我还没有时间使用它。</p><p id="71d7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">另一个例子是强制命名约定。您可以添加任意数量的条件块，在这种情况下，您可以为每个变量添加一个块，以确保您的所有资源都包含符合您的命名约定的特定字符串或<code class="fe mn mo mp mb b">local</code>。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="7088" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu"> 4。使用terratest为你的代码编写单元测试</strong></p><figure class="lv lw lx ly gt ju gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/4bf7e9607652eeec78f887e6a46970e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:720/format:webp/1*9Dj-fJZS5NJwHkiXY0ORQw.png"/></div></figure><p id="90c7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://terratest.gruntwork.io/" rel="noopener ugc nofollow" target="_blank"> Terratest </a>可用于编写单元/集成测试，这有助于简化您的配置测试。Terratest是用Go写的，就像Terraform一样。幸运的是，你不需要太多的Go或Terraform代码库的经验就能理解Terratest。💸注意:您在Terratest中所做的任何事情都会导致资源在测试过程中被创建和销毁。你将负责任何产生的费用，所以要小心！💸</p><p id="7242" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我不会在这里粘贴测试文件的内容，而是链接一些由Gruntworks提供的优秀文档:</p><p id="5b5e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://gruntwork.io/repos/v0.23.4/terratest/examples/terraform-aws-s3-example#" rel="noopener ugc nofollow" target="_blank">https://grunt work . io/repos/v 0 . 23 . 4/terra test/examples/terra form-AWS-S3-example #</a></p><p id="daf6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个例子非常简单，它向您展示了如何配置一些基本的测试来对到S3存储桶的连接实施SSL。在这里可以找到一个更复杂(也更酷)的例子来验证在EC2实例上是否配置了SSH:<a class="ae kf" href="https://github.com/gruntwork-io/terratest/blob/v0.23.4/test/terraform_ssh_example_test.go" rel="noopener ugc nofollow" target="_blank">https://github . com/grunt work-io/terra test/blob/v 0 . 23 . 4/test/terra form _ SSH _ example _ test . go</a>。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="f63e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu"> 5。使用部分后端配置，如果你还没有</strong> <br/> Terraform允许你以多种方式传递后端配置。通常情况下，最好避免将所有配置硬编码到一个<code class="fe mn mo mp mb b">remote.tf</code>文件中。您可以通过使用<a class="ae kf" href="https://www.terraform.io/docs/language/settings/backends/configuration.html#partial-configuration" rel="noopener ugc nofollow" target="_blank">部分配置</a>来自动初始化您的后端。防止覆盖预先存在的后端是一个好主意；您可以在运行<code class="fe mn mo mp mb b">terraform init</code>时指定<code class="fe mn mo mp mb b">input=false</code>来实现这一点，这将导致Terraform在提示输入时出错。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="8458" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu"> 6。经常为供应商库做贡献，即使只是提出一个问题。</strong></p><figure class="lv lw lx ly gt ju gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/2a7b5bfc94c17224ed839349dae39576.png" data-original-src="https://miro.medium.com/v2/resize:fit:860/format:webp/1*IzwDKVx-BT5NGmAe9xMR3Q.jpeg"/></div></figure><p id="d0fc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu"> Terraform是开源的，所以我们都在一起</strong>。我经常在AzureRM提供商GitHub repo以及其他一些开源模块上提出问题。这并不是因为我脾气暴躁或者在找bugs我每天都使用Azure，希望它尽可能流畅，适合所有人。不仅仅是我希望X特性得到支持，作为社区的一员，我觉得有义务做出贡献。如果你想做出贡献，但不知道如何做，请查看一些最受欢迎的提供商的指南，不要害羞！</p><ul class=""><li id="bb0d" class="ll lm it ki b kj kk kn ko kr ln kv lo kz lp ld ms lr ls lt bi translated">azure RM:<a class="ae kf" href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs#features-and-bug-requests" rel="noopener ugc nofollow" target="_blank">https://registry . terraform . io/providers/hashi corp/azure RM/latest/docs # features-and-bug-requests</a></li><li id="69e4" class="ll lm it ki b kj mt kn mu kr mv kv mw kz mx ld ms lr ls lt bi translated">AWS:<a class="ae kf" href="https://github.com/hashicorp/terraform-provider-aws/issues/new/choose" rel="noopener ugc nofollow" target="_blank">https://github . com/hashi corp/terra form-provider-AWS/issues/new/choose</a></li><li id="2cb2" class="ll lm it ki b kj mt kn mu kr mv kv mw kz mx ld ms lr ls lt bi translated">GCP:<a class="ae kf" href="https://registry.terraform.io/providers/hashicorp/google/latest/docs#features-and-bug-requests" rel="noopener ugc nofollow" target="_blank">https://registry . terraform . io/providers/hashi corp/Google/latest/docs # features-and-bug-requests</a></li></ul></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="453d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这只是你可以使你的地形变得更加干燥、可扩展，并且最终更加令人愉快的一个小列表。还有许多其他工具可以加速云基础架构的自动化。如果你有什么你用的工具，想推荐，欢迎随时回复这个故事，分享你的经验。</p></div></div>    
</body>
</html>