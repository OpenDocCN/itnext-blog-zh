<html>
<head>
<title>First steps with AWS Amplify for an Angular application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS放大器用于角度应用的第一步</h1>
<blockquote>原文：<a href="https://itnext.io/first-steps-with-aws-amplify-for-an-angular-app-31c271ade5a6?source=collection_archive---------3-----------------------#2020-06-19">https://itnext.io/first-steps-with-aws-amplify-for-an-angular-app-31c271ade5a6?source=collection_archive---------3-----------------------#2020-06-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/7cd932bf99e9b0251f5a32f735a30b65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Km-EKmWvXKKvOvEk9lFSog.jpeg"/></div></div></figure><p id="bc97" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本文中，我将描述如何用AWS Amplify构建一个Angular应用程序，这是一个开发web和移动应用程序的解决方案。</p><p id="1391" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将致力于一个小应用程序，可以帮助一个自由职业者编辑其客户的账单。该应用程序将基本上定义三个对象:客户，账单和行(自由职业者将能够在同一个账单中支付几个东西)。</p><p id="64ec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以在https://github.com/feloy/aws-amplify-demo的<a class="ae kw" href="https://github.com/feloy/aws-amplify-demo" rel="noopener ugc nofollow" target="_blank">找到项目的来源。</a></p><p id="4ce3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本页描述了CLI的安装和第一个项目的创建(我们将基于Angular前端创建一个项目):<a class="ae kw" href="https://docs.amplify.aws/start/getting-started/installation/q/integration/angular" rel="noopener ugc nofollow" target="_blank">https://docs . amplify . AWS/start/getting-started/installation/q/integration/Angular</a></p><p id="035b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">实际上，您必须首先安装CLI，然后运行<code class="fe kx ky kz la b">amplify configure</code>来选择一个AWS区域，创建一个新的AWS用户，并将相关的凭证保存到您的本地配置中:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="413d" class="lj lk iq la b gy ll lm l ln lo">$ npm install -g @aws-amplify/cli<br/>$ amplify configure</span></pre><h1 id="9394" class="lp lk iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">应用程序初始化</h1><p id="7f1f" class="pw-post-body-paragraph jy jz iq ka b kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">下一步是从头开始创建一个Angular应用程序，并初始化项目。全部在本页描述:<a class="ae kw" href="https://docs.amplify.aws/start/getting-started/setup/q/integration/angular" rel="noopener ugc nofollow" target="_blank">https://docs . amplify . AWS/start/getting-started/setup/q/integration/angular</a></p><h1 id="c5b1" class="lp lk iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">API创建</h1><p id="1dc2" class="pw-post-body-paragraph jy jz iq ka b kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">是时候创建一个API了，它将包含用于<strong class="ka ir">客户</strong>、<strong class="ka ir">账单</strong>和<strong class="ka ir">行</strong>的三个表。我们将使用GraphQL服务来访问API，并将集成的<em class="mr"> Amazon Cognito用户池</em>作为授权服务。</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="d329" class="lj lk iq la b gy ll lm l ln lo">$ amplify add api<br/>? Please select from one of the below mentioned services: <strong class="la ir">GraphQL</strong><br/>? Provide API name: <strong class="la ir">billing</strong><br/>? Choose the default authorization type for the API Amazon Cognito User Pool<br/>Using service: <strong class="la ir">Cognito</strong>, provided by: awscloudformation<br/> <br/> The current configured provider is Amazon Cognito. <br/> <br/> Do you want to use the default authentication and security configuration? <strong class="la ir">Default configuration</strong><br/> Warning: you will not be able to edit these selections. <br/> How do you want users to be able to sign in? <strong class="la ir">Username</strong><br/> Do you want to configure advanced settings? <strong class="la ir">No, I am done.</strong><br/>Successfully added auth resource<br/>? Do you want to configure advanced settings for the GraphQL API <strong class="la ir">No, I am done.</strong><br/>? Do you have an annotated GraphQL schema? <strong class="la ir">No</strong><br/>? Do you want a guided schema creation? Yes<br/>? What best describes your project: <strong class="la ir">One-to-many relationship (e.g., “Blogs” with “Posts” and “Comments”)</strong><br/>? Do you want to edit the schema now? <strong class="la ir">Yes<br/></strong>[...]</span></pre><p id="8904" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">受给定示例和https://docs.amplify.aws/cli/graphql-transformer/o<a class="ae kw" href="https://docs.amplify.aws/cli/graphql-transformer/overview" rel="noopener ugc nofollow" target="_blank">verview文档的启发，我创建了以下模型，其中客户可以包含许多账单，账单可以包含许多行、账单和仅分别属于一个客户和账单的行:</a></p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="4f9b" class="lj lk iq la b gy ll lm l ln lo">type Customer<br/>@model<br/>@auth(rules: [{allow: owner}])<br/>{<br/>  id: ID!<br/>  name: String!<br/>  bills: [Bill] @connection(keyName: "byCustomer", fields: ["id"])<br/>}</span><span id="5e07" class="lj lk iq la b gy ms lm l ln lo">type Bill<br/>@model<br/>@auth(rules: [{allow: owner}])<br/>@key(name: "byCustomer", fields: ["customerID"])<br/>{<br/>  id: ID!<br/>  title: String!<br/>  customerID: ID!<br/>  customer: Customer @connection(fields: ["customerID"])<br/>  lines: [Line] @connection(keyName: "byBill", fields: ["id"])<br/>}</span><span id="e9b2" class="lj lk iq la b gy ms lm l ln lo">type Line<br/>@model<br/>@auth(rules: [{allow: owner}])<br/>@key(name: "byBill", fields: ["billID", "title"])<br/>{<br/>  id: ID!<br/>  billID: ID!<br/>  bill: Bill @connection(fields: ["billID"])<br/>  title: String!<br/>  quantity: Int!<br/>  cost: Float!<br/>}</span></pre><p id="e6d5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该模型目前包含最少的字段。稍后，您可以通过向表中添加更多字段来完成它。</p><blockquote class="mt mu mv"><p id="62b9" class="jy jz mr ka b kb kc kd ke kf kg kh ki mw kk kl km mx ko kp kq my ks kt ku kv ij bi translated">请注意<code class="fe kx ky kz la b">@auth(rules: [{allow: owner}])</code>，它将限制用户对他所创建的数据的访问。</p></blockquote><p id="64eb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在使用以下选项运行<code class="fe kx ky kz la b">amplify push</code>之后，您可以在AWS控制台中看到API已经部署，并且创建了一个<code class="fe kx ky kz la b">API.service.ts</code>文件来帮助您从Angular应用程序访问API。</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="e4ad" class="lj lk iq la b gy ll lm l ln lo">? Do you want to generate code for your newly created GraphQL API <strong class="la ir">Yes</strong><br/>? Choose the code generation language target <strong class="la ir">angular</strong><br/>? Enter the file name pattern of graphql queries, mutations and subscriptions <strong class="la ir">src/graphql/**/*.graphql</strong><br/>? Do you want to generate/update all possible GraphQL operations - queries, mutations and subscriptions <strong class="la ir">Yes</strong><br/>? Enter maximum statement depth [increase from default if your schema is deeply nested] <strong class="la ir">2</strong><br/>? Enter the file name for the generated code <strong class="la ir">src/app/API.service.ts</strong></span></pre><p id="49c4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你还可以在<code class="fe kx ky kz la b">src/graphql</code>中找到三个有趣的文件:<code class="fe kx ky kz la b">queries.graphql</code>、<code class="fe kx ky kz la b">mutations.graphql</code>和<code class="fe kx ky kz la b">subscriptions.graphql</code>。这些文件包含已定义的GraphQL查询、变异和订阅，将用于检索数据、创建/更新数据和监听数据更改。</p><h1 id="2394" class="lp lk iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">测试API</h1><p id="f442" class="pw-post-body-paragraph jy jz iq ka b kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">要从AWS控制台测试API，您必须首先创建一个用户:转到Cognito控制台，选择“管理用户池”，选择已经由amplify创建的用户池，然后选择菜单项“用户和组”，最后选择按钮“创建用户”。键入用户名、临时密码和有效的电子邮件地址。取消选中“将电话号码标记为已验证？”并创建用户。您应该会收到一封包含您的登录名和临时密码的电子邮件。</p><p id="0665" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您还需要一个应用程序客户端Id来连接，您可以在Cognito控制台的应用程序客户端菜单中找到它。</p><p id="8a7f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在转到Amplify控制台，选择你的应用程序，然后“后端环境”&gt;开发&gt; API &gt;在AppSync中查看&gt;运行查询。您应该访问一个GraphQL查询编辑器。通过点击“使用用户池登录”首次登录，并使用应用程序客户端ID、登录名和临时密码；您必须键入一个新密码。最后，你应该被认证。</p><p id="db17" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以尝试创建第一个客户:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="8b7e" class="lj lk iq la b gy ll lm l ln lo">mutation add {<br/>  createCustomer(input: {<br/>    name: "Casino"<br/>  }) {<br/>    id<br/>    name<br/>  }<br/>}</span><span id="255d" class="lj lk iq la b gy ms lm l ln lo">{<br/>  "data": {<br/>    "createCustomer": {<br/>      "id": "99a34936-e773-42ad-aba4-7935c3e5bcc1",<br/>      "name": "Casino"<br/>    }<br/>  }<br/>}</span></pre><p id="2b8e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后得到这个特定的客户:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="9a89" class="lj lk iq la b gy ll lm l ln lo">{<br/> getCustomer (<br/>   id: "99a34936-e773-42ad-aba4-7935c3e5bcc1"<br/>  ) {<br/>   id<br/>   name<br/> }<br/>}</span><span id="43d4" class="lj lk iq la b gy ms lm l ln lo">{<br/>  "data": {<br/>    "getCustomer": {<br/>      "id": "99a34936-e773-42ad-aba4-7935c3e5bcc1",<br/>      "name": "Casino"<br/>    }<br/>  }<br/>}</span></pre><p id="ee0f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者获取客户列表:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="f7f6" class="lj lk iq la b gy ll lm l ln lo">{<br/> listCustomers {<br/>    items {<br/>      id<br/>      name<br/>    }<br/>  }<br/>}</span><span id="a4b5" class="lj lk iq la b gy ms lm l ln lo">{<br/>  "data": {<br/>    "listCustomers": {<br/>      "items": [<br/>        {<br/>          "id": "99a34936-e773-42ad-aba4-7935c3e5bcc1"<br/>          "name": "Casino",<br/>        }<br/>      ]<br/>    }<br/>  }<br/>}</span></pre><p id="b05e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以验证用户只能访问他们创建的数据，正如我们在每个表定义中添加的<code class="fe kx ky kz la b">@auth(rules: [{allow: owner}])</code>所指定的那样:如上所述创建第二个用户，断开与第一个用户的连接并与第二个用户连接，然后再次运行listCustomers查询。您应该得到一个空列表。然后创建一个新客户，并再次获取列表。您应该只能看到该用户的客户。</p><h1 id="667a" class="lp lk iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">认证集成</h1><p id="f4dc" class="pw-post-body-paragraph jy jz iq ka b kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">要将身份验证集成到应用程序中，您必须在应用程序的根目录放置一个<code class="fe kx ky kz la b">amplify-authenticator</code>组件，并在用户登录后将应用程序结构包含在该组件中:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="d6b7" class="lj lk iq la b gy ll lm l ln lo">&lt;amplify-authenticator&gt;<br/> &lt;main&gt;<br/>  &lt;mat-toolbar color="primary"&gt;<br/>   &lt;span&gt;Billing Application&lt;/span&gt;<br/>   &lt;span class="fill-remaining-space"&gt;&lt;/span&gt;<br/>   &lt;a mat-button [routerLink]="['/customers']"&gt;My customers&lt;/a&gt;<br/>   &lt;a mat-button [routerLink]="['/bills']"&gt;My bills&lt;/a&gt;<br/>   &lt;amplify-sign-out&gt;&lt;/amplify-sign-out&gt;<br/>  &lt;/mat-toolbar&gt;<br/>  &lt;div class="content"&gt;<br/>   &lt;router-outlet&gt;&lt;/router-outlet&gt;<br/>  &lt;/div&gt;<br/> &lt;/main&gt;<br/>&lt;/amplify-authenticator&gt;</span></pre><h1 id="44f3" class="lp lk iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated"><strong class="ak">列出客户</strong></h1><p id="e8d6" class="pw-post-body-paragraph jy jz iq ka b kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">由于前面创建的<code class="fe kx ky kz la b">API.service.ts</code>,可以通过对API的唯一调用获得客户列表:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="981e" class="lj lk iq la b gy ll lm l ln lo">constructor(private api: APIService) { }</span><span id="aeb4" class="lj lk iq la b gy ms lm l ln lo">ngOnInit(): void {<br/>  this.api.ListCustomers().then((list: ListCustomersQuery) =&gt; {<br/>    this.customers = list.items;<br/>  });<br/>}</span></pre><p id="4c6a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并像往常一样显示模板中的列表:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="14d3" class="lj lk iq la b gy ll lm l ln lo">&lt;mat-list&gt;<br/>  &lt;a *ngFor="let customer of customers" mat-list-item [routerLink]="['/customer', customer.id]"&gt;{{customer.name}}&lt;/a&gt;<br/>&lt;/mat-list&gt;</span></pre><h1 id="18d9" class="lp lk iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">编辑客户</h1><p id="7c04" class="pw-post-body-paragraph jy jz iq ka b kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated"><code class="fe kx ky kz la b">API.servicets</code>为您提供添加、更新和删除客户的功能:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="c88a" class="lj lk iq la b gy ll lm l ln lo">loadCustomer(id: string) {<br/>  this.api.GetCustomer(id).then((customer: GetCustomerQuery) =&gt; {<br/>    this.form.patchValue({<br/>      id: customer.id,<br/>      name: customer.name,<br/>    })<br/>  });<br/>}</span><span id="2941" class="lj lk iq la b gy ms lm l ln lo">add() {<br/>  this.api.CreateCustomer(this.form.value).then(() =&gt; {<br/>    this.router.navigate(['customers']);<br/>  })<br/>}</span><span id="336d" class="lj lk iq la b gy ms lm l ln lo">update() {<br/>  this.api.UpdateCustomer(this.form.value).then(() =&gt; {<br/>    this.router.navigate(['customers']);<br/>  })<br/>}</span><span id="07b6" class="lj lk iq la b gy ms lm l ln lo">delete() {<br/>  this.api.DeleteCustomer({ id: this.form.value['id']}).then(() =&gt; {<br/>    this.router.navigate(['customers']);<br/>  })<br/>}</span></pre><h1 id="6412" class="lp lk iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">编辑账单</h1><p id="c4ed" class="pw-post-body-paragraph jy jz iq ka b kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">账单和行的版本类似于客户的版本。</p><h1 id="fcf9" class="lp lk iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">发布应用程序</h1><p id="0a02" class="pw-post-body-paragraph jy jz iq ka b kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">当您准备好发布应用程序时，首先需要将应用程序的源代码推送到Git存储库中。</p><p id="ca81" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，您必须转到AWS Amplify控制台，选择“前端环境”，选择您的Git提供商，然后按照说明选择包含应用程序源代码和您要部署的分支的存储库。</p><p id="24c9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择已经创建的<code class="fe kx ky kz la b">dev</code>后端环境，并如上所述创建一个新的服务角色。</p><p id="abe1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">给出了一个<code class="fe kx ky kz la b">amplify.yml</code>的内容。您可以下载它并将其保存在项目的根目录下。您也可以按照<a class="ae kw" href="https://docs.aws.amazon.com/amplify/latest/userguide/build-settings.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/amplify/latest/user guide/build-settings . html</a>上的说明进行个性化设置。特别是，如果您使用Angular v9，您将必须指定使用节点12:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="6ce0" class="lj lk iq la b gy ll lm l ln lo">version: 1<br/>backend:<br/> phases:<br/>  build:<br/>   commands:<br/>   - '# Execute Amplify CLI with the helper script'<br/>   - amplifyPush --simple<br/>frontend:<br/> phases:<br/>  preBuild:<br/>   commands:<br/><strong class="la ir">    - nvm use $VERSION_NODE_12<br/></strong>    - npm ci<br/>  build:<br/>   commands:<br/>    - npm run build<br/> artifacts:<br/>  baseDirectory: dist/billing<br/>  files:<br/>  - '**/*'<br/> cache:<br/>  paths:<br/>  - node_modules/**/*</span></pre><p id="a740" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后点击“保存并部署”。这将运行应用程序的首次构建和部署。</p><p id="4c48" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">稍后，当您在主分支中推送内容时，将自动启动新的构建，如果构建成功，应用程序将被部署。</p><h2 id="2ce3" class="lj lk iq bd lq mz na dn lu nb nc dp ly kj nd ne mc kn nf ng mg kr nh ni mk nj bi translated">在构建期间运行单元测试</h2><p id="2e29" class="pw-post-body-paragraph jy jz iq ka b kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">如果您想在构建期间运行单元测试，您必须使用无头chrome驱动程序:</p><p id="a996" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先修改<code class="fe kx ky kz la b">package.json</code>:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="32ed" class="lj lk iq la b gy ll lm l ln lo">"scripts": {<br/>   [...]<br/>   "test": "ng test<strong class="la ir"> --no-watch --no-progress --browsers=ChromeHeadlessNoSandbox</strong>",</span></pre><p id="16d9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后将驱动程序添加到<code class="fe kx ky kz la b">karma.conf.js,</code>，并使用<code class="fe kx ky kz la b">--no-sandbox</code>选项运行，因为测试是以root用户身份运行的，如果没有这个选项，Chrome不会以root用户身份启动。</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="af48" class="lj lk iq la b gy ll lm l ln lo">browsers: ['Chrome'<strong class="la ir">, 'ChromeHeadlessNoSandbox'</strong>],<br/><strong class="la ir">customLaunchers: {<br/> ChromeHeadlessNoSandbox: {<br/>  base: 'ChromeHeadless',<br/>  flags: ['--no-sandbox']<br/> }<br/>},</strong></span></pre><p id="ff50" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，您可以安装Chrome并从<code class="fe kx ky kz la b">amplify.yml</code>文件运行测试，在<code class="fe kx ky kz la b">preBuild</code>阶段:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="2b3c" class="lj lk iq la b gy ll lm l ln lo">[...]<br/>frontend:<br/> phases:<br/>  preBuild:<br/>   commands:<br/>   - nvm use $VERSION_NODE_12<br/>   - npm m ci<br/><strong class="la ir">   - wget </strong><a class="ae kw" href="https://dl.google.com/linux/direct/google-chrome-stable_current_x86_64.rpm" rel="noopener ugc nofollow" target="_blank"><strong class="la ir">https://dl.google.com/linux/direct/google-chrome-stable_current_x86_64.rpm</strong></a><strong class="la ir"><br/>   - yum install -y ./google-chrome-stable_current_*.rpm<br/></strong>   <strong class="la ir">- npm run test</strong></span></pre><h1 id="e926" class="lp lk iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">用赛普拉斯运行e2e测试</h1><p id="9604" class="pw-post-body-paragraph jy jz iq ka b kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">现在，Cypress是运行图形用户界面端到端测试的一个非常好的工具。这是AWS Amplify文档中记录的工具。让我们用它来做e2e测试。首先为我们的应用程序安装它:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="8e9f" class="lj lk iq la b gy ll lm l ln lo">$ npm add cypress --dev<br/>$ $(npm bin)/cypress open</span></pre><p id="f317" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个最新的命令首先创建一个包含默认规范文件的<code class="fe kx ky kz la b">cypress</code>目录，然后打开一个命令窗口，帮助您交互式地运行测试。你可以暂时打开窗户。</p><p id="01b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面是检查登录过程的第一个测试，保存在<code class="fe kx ky kz la b">cypress/integration/authenticator_spec.js</code>中:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="a80a" class="lj lk iq la b gy ll lm l ln lo">describe('Authenticator:', function () {<br/> beforeEach(function () {<br/> cy.visit('/');<br/>});</span><span id="29ef" class="lj lk iq la b gy ms lm l ln lo">describe('Sign In:', () =&gt; {<br/> it('allows a user to signin', () =&gt; {<br/>  cy.get('amplify-authenticator')<br/>   .find(selectors.usernameInput, { includeShadowDom: true })<br/>   .type("test", { force: true });<br/>  cy.get('amplify-authenticator')<br/>   .find(selectors.signInPasswordInput, { includeShadowDom: true })<br/>   .type("password", , { force: true });<br/>  cy.get('amplify-authenticator')<br/>   .find(selectors.signInSignInButton, { includeShadowDom: true })<br/>   .contains('Sign In')<br/>   .click();</span><span id="ecb0" class="lj lk iq la b gy ms lm l ln lo">cy.get('amplify-authenticator')<br/>   .find(selectors.signOutButton, { includeShadowDom: true })<br/>   .contains('Sign Out').should('be.visible');<br/>  });<br/> });<br/>});</span><span id="e33a" class="lj lk iq la b gy ms lm l ln lo">export const selectors = {<br/> // Auth component classes<br/> usernameInput: 'input[data-test="sign-in-username-input"]',<br/> signInPasswordInput: '[data-test="sign-in-password-input"]',<br/> signInSignInButton: '[data-test="sign-in-sign-in-button"]',<br/> signOutButton: '[data-test="sign-out-button"]'<br/>}</span></pre><p id="0f4b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意，<strong class="ka ir">认证器</strong>组件使用影子DOM，并且在撰写本文时(2020–06)，影子DOM支持仍处于试验阶段。您必须在<code class="fe kx ky kz la b">cypress.json</code>文件中添加一个选项来启用它:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="313d" class="lj lk iq la b gy ll lm l ln lo">{<br/>  "baseUrl": "http://localhost:4200/",<br/>  "experimentalShadowDomSupport": true<br/>}</span></pre><p id="291a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您需要为测试创建一个专用用户(这里是<code class="fe kx ky kz la b">test/password</code>)。请按照上述步骤创建用户。记得第一次手动加载时验证其密码。</p><p id="5485" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要尝试本地测试，首先使用<code class="fe kx ky kz la b">ng serve</code>从另一个终端启动应用程序，然后运行:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="e9b0" class="lj lk iq la b gy ll lm l ln lo">$ $(npm bin)/cypress run</span></pre><p id="a028" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要在CI/CD期间运行e2e测试，您需要在<code class="fe kx ky kz la b">amplify.yml</code>文件中添加一个<code class="fe kx ky kz la b">test</code>部分:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="e889" class="lj lk iq la b gy ll lm l ln lo">test:<br/> phases:<br/>  preTest:<br/>   commands:<br/>   - npm ci<br/>   - npm install wait-on<br/>   - npm install mocha@5.2.0 mochawesome mochawesome-merge mochawesome-report-generator<br/>   - 'npm start &amp; npx wait-on <a class="ae kw" href="http://localhost:4200'" rel="noopener ugc nofollow" target="_blank">http://localhost:4200'</a><br/>  test:<br/>   commands:<br/>   - 'npx cypress run --reporter mochawesome --reporter-options "reportDir=cypress/report/mochawesome-report,overwrite=false,html=false,json=true,timestamp=mmddyyyy_HHMMss"'<br/>  postTest:<br/>   commands:<br/>   - npx mochawesome-merge cypress/report/mochawesome-report/mochawesome*.json &gt; cypress/report/mochawesome.json<br/> artifacts:<br/>  baseDirectory: cypress<br/>  configFilePath: '**/mochawesome.json'<br/>  files:<br/>  - '**/*.png'<br/>  - '**/*.mp4'</span></pre><h1 id="be89" class="lp lk iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">维护应用程序</h1><p id="c6fe" class="pw-post-body-paragraph jy jz iq ka b kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">一旦你的应用被部署，你可能需要对它进行一些改进。为此，AWS Amplify可以帮助您使用专用后端处理功能分支。</p><p id="d792" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先在新的git存储库中创建一个新的分支，例如<code class="fe kx ky kz la b">add-address</code>，并将其推到原点:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="1bac" class="lj lk iq la b gy ll lm l ln lo">$ git checkout -b add-address<br/>$ git push --set-upstream origin add-address</span></pre><p id="c489" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，您可以从Amplify控制台连接这个新分支。在常规应用程序设置中，列出了管理的分支机构列表，一个按钮<strong class="ka ir">连接一个分支机构</strong>让您有机会管理您的新分支机构。</p><p id="fd6e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在表单中，选择新的分支名称<code class="fe kx ky kz la b">add-address</code>，选择“创建新环境”作为后端环境，并将其命名为<code class="fe kx ky kz la b">appaddress</code> ( <em class="mr">环境名称必须在2到10个字符之间，仅小写</em>)。当点击<strong class="ka ir">保存并部署</strong>时，一个名为<code class="fe kx ky kz la b">addaddress</code>的新后端将被创建并附加到您的新分支，前端将被构建，并被参数化以访问该后端。此操作可能需要几分钟时间。</p><p id="ed0c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您现在可以通过类似于<a class="ae kw" href="https://add-address.d1054gnrjvy2b0.amplifyapp.com/" rel="noopener ugc nofollow" target="_blank"> https://add-address的地址连接到您的开发前端。*.amplifyapp.com/ </a>。由于你的后台是空的，你必须创建一个新用户，这一次是从你的应用程序的登录页面。</p><p id="dfb2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要在本地处理新的后端，您必须使用后端环境中的命令在本地创建它的配置:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="4bba" class="lj lk iq la b gy ll lm l ln lo">$ amplify pull --appId <strong class="la ir"><em class="mr">anAppId</em></strong> --envName addaddress</span></pre><p id="40d4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要向<code class="fe kx ky kz la b">Customer</code>表添加一个<code class="fe kx ky kz la b">address</code>字段，您必须编辑<code class="fe kx ky kz la b">amplify/backend/api/billing/schema.graphql</code>文件:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="a15f" class="lj lk iq la b gy ll lm l ln lo">type Customer<br/><a class="ae kw" href="http://twitter.com/model" rel="noopener ugc nofollow" target="_blank">@model</a><br/><a class="ae kw" href="http://twitter.com/auth" rel="noopener ugc nofollow" target="_blank">@auth</a>(rules: [{allow: owner}])<br/>{<br/>  id: ID!<br/>  name: String!<br/><strong class="la ir">  address: String<br/></strong>  bills: [Bill] <a class="ae kw" href="http://twitter.com/connection" rel="noopener ugc nofollow" target="_blank">@connection</a>(keyName: "byCustomer", fields: ["id"])<br/>}</span></pre><p id="1770" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，您可以推送您在API上所做的更改:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="0bbe" class="lj lk iq la b gy ll lm l ln lo">$ amplify api push<br/>Current Environment: <strong class="la ir">addaddress</strong></span><span id="c18b" class="lj lk iq la b gy ms lm l ln lo">| Category | Resource name | Operation | Provider plugin   |<br/>| -------- | ------------- | --------- | ----------------- |<br/>| Api      | billing       | Update    | awscloudformation |<br/>? Are you sure you want to continue? <strong class="la ir">Yes</strong><br/>? Do you want to update code for your updated GraphQL API <strong class="la ir">Yes</strong><br/>? Do you want to generate GraphQL statements (queries, mutations and subscription) based on your schema types?<br/>This will overwrite your current graphql queries, mutations and subscriptions <strong class="la ir">Yes</strong></span></pre><p id="6dc3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">验证这些更改将在<code class="fe kx ky kz la b">addaddress</code>环境中进行，然后验证这些更改。此操作可能需要几分钟时间。</p><p id="17f0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成后，您可以在AppSync控制台中验证<code class="fe kx ky kz la b">billing-addaddress</code> API模式中的表<code class="fe kx ky kz la b">Customer</code>是否包含新的<code class="fe kx ky kz la b">address</code>字段:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="eca1" class="lj lk iq la b gy ll lm l ln lo">input CreateCustomerInput {<br/> id: ID<br/> name: String!<br/><strong class="la ir"> address: String<br/></strong>}</span></pre><p id="c6cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，你可以用你的Angular应用来管理这个新领域。请注意，<code class="fe kx ky kz la b">API.service.ts</code>文件已经更新，以匹配后端模式中所做的更改。</p><p id="1567" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦完成，您可以将更改提交到<code class="fe kx ky kz la b">add-address</code>分支，并将分支推送到原点。AWS Amplify将检测到这些变化，应用程序将自动构建并再次部署。</p><p id="f0e8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦应用程序部署完毕，您或您的客户或产品所有者就可以验证应用程序是否按预期运行。当你满意的时候，你可以将这个分支合并到主分支中，并将最后一个分支拉到原点。这样，AWS Amplify将检测到变化:它将更新生产后端以添加新字段，然后重建应用程序并部署它。</p><p id="8e04" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您现在可以分离开发分支并删除开发后端。</p><h1 id="5573" class="lp lk iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">添加自定义计算</h1><p id="67ef" class="pw-post-body-paragraph jy jz iq ka b kb mm kd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">您可能希望在后端添加特定的计算。在我们的应用程序中，我们希望每个账单都被分配一个新的字段<code class="fe kx ky kz la b">serialnum</code>，根据账单创建的月份，自动计算出一个递增值。该字段将得到形式<code class="fe kx ky kz la b">YYYYmmNNNN</code> —例如，2020年6月的第二张账单将是<code class="fe kx ky kz la b">2020060002</code>。</p><p id="fa9f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为此，我们需要定义一个Lambda函数，当在数据库中创建一个新的账单时，该函数将被触发，并且能够查询和更新现有的账单。我们可以通过以下方式创建它:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="6bf8" class="lj lk iq la b gy ll lm l ln lo">$ amplify function add<br/>Using service: Lambda, provided by: awscloudformation<br/>? Provide a friendly name for your resource to be used as a label for this category in the project: <strong class="la ir">serial</strong><br/>? Provide the AWS Lambda function name: <strong class="la ir">serial</strong><br/>? Choose the function runtime that you want to use: <strong class="la ir">NodeJS</strong><br/>? Choose the function template that you want to use: <strong class="la ir">Lambda trigger</strong><br/>? What event source do you want to associate with Lambda trigger? <strong class="la ir">Amazon DynamoDB Stream</strong><br/>? Choose a DynamoDB event source option <strong class="la ir">Use API category graphql </strong><a class="ae kw" href="http://twitter.com/model" rel="noopener ugc nofollow" target="_blank"><strong class="la ir">@model</strong></a><strong class="la ir"> backed DynamoDB table(s) in the current Amplify project</strong><br/>Selected resource billing<br/>? Choose the graphql <a class="ae kw" href="http://twitter.com/model" rel="noopener ugc nofollow" target="_blank">@model</a>(s) <strong class="la ir">Bill</strong><br/>? Do you want to access other resources created in this project from your Lambda function? <strong class="la ir">Yes</strong><br/>? Select the category <strong class="la ir">storage</strong><br/>? Storage has 3 resources in this project. Select the one you would like your Lambda to access <strong class="la ir">Bill:</strong><a class="ae kw" href="http://twitter.com/model" rel="noopener ugc nofollow" target="_blank"><strong class="la ir">@model</strong></a><strong class="la ir">(appsync)</strong><br/>? Select the operations you want to permit for Bill:<a class="ae kw" href="http://twitter.com/model" rel="noopener ugc nofollow" target="_blank">@model</a>(appsync) <strong class="la ir">update, read</strong></span><span id="95fd" class="lj lk iq la b gy ms lm l ln lo">You can access the following resource attributes as environment variables from your Lambda function<br/>        API_BILLING_BILLTABLE_ARN<br/>        API_BILLING_BILLTABLE_NAME<br/> API_BILLING_GRAPHQLAPIIDOUTPUT<br/> ENV<br/> REGION<br/>? Do you want to invoke this function on a recurring schedule? <strong class="la ir">No</strong><br/>? Do you want to edit the local lambda function now? <strong class="la ir">No</strong><br/>Successfully added resource serial locally.</span></pre><p id="82a5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将创建一个<code class="fe kx ky kz la b">serialnum</code>字段来存储这个自动值。</p><p id="4127" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了能够按创建日期顺序查询账单，您需要向账单模型添加一个二级键，并定义两个字段<code class="fe kx ky kz la b">createdAt</code>和<code class="fe kx ky kz la b">owner</code>。这些字段由系统编写，但是您需要声明它们以便能够在键中引用它们:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="bb53" class="lj lk iq la b gy ll lm l ln lo">type Bill<br/>@model<br/>@auth(rules: [{allow: owner}])<br/>@key(name: "byCustomer", fields: ["customerID"])<br/><strong class="la ir">@key(name: "byOwnerCreation", fields: ["owner", "createdAt"])<br/></strong>{<br/> id: ID!<br/><strong class="la ir"> serialnum: String<br/></strong> title: String!<br/> customerID: ID!<br/> customer: Customer @connection(fields: ["customerID"])<br/> lines: [Line] @connection(keyName: "byBill", fields: ["id"])<br/><strong class="la ir"> createdAt: AWSDateTime!<br/> owner: String<br/></strong>}</span></pre><p id="68ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">函数的代码可以在这里找到:<a class="ae kw" href="https://github.com/feloy/aws-amplify-demo/blob/master/amplify/backend/function/serial/src/index.js" rel="noopener ugc nofollow" target="_blank">https://github . com/feloy/AWS-amplify-demo/blob/master/amplify/back end/function/serial/src/index . js</a></p></div></div>    
</body>
</html>