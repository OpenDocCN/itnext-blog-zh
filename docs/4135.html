<html>
<head>
<title/>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1/>
<blockquote>原文：<a href="https://itnext.io/state-of-persistent-storage-in-k8s-a-benchmark-77a96bb1ac29?source=collection_archive---------0-----------------------#2020-05-04">https://itnext.io/state-of-persistent-storage-in-k8s-a-benchmark-77a96bb1ac29?source=collection_archive---------0-----------------------#2020-05-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><p id="4ffa" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">K8s中持久存储的状态—基准</p><p id="3995" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi jn translated">这是一篇对Kubernetes储物解决方案的不科学评论。这解决了您需要使用节点磁盘存储来提供持久卷的问题，同时在节点损坏或重启时具有冗余。</p><p id="c44c" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">我的动机是将公司的服务器从多个裸机专用服务器迁移到Kubernetes集群。</p><figure class="jx jy jz ka gt kb gh gi paragraph-image"><div class="gh gi jw"><img src="../Images/fa748684c9075f67e545397f481973cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/1*OQgJiJlG3dGEyQHowWijPg.png"/></div><figcaption class="ke kf gj gh gi kg kh bd b be z dk translated">受新冠肺炎危机影响，巴西雷亚尔兑美元汇率跌至历史新低</figcaption></figure><p id="510b" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">我们是一家巴西公司，有巨大的处理(主要是CPU)需求和一个非常浅的口袋。我的初创公司叫做Escavador——www.escavador.com的<a class="ae ki" href="http://www.escavador.com" rel="noopener ugc nofollow" target="_blank"/>。我们开发NLP解决方案来构建法律数据。</p><p id="3697" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">我们的货币实际上被低估了，这里高级开发人员的平均工资大约是每月2000美元。所以，我们没有奢侈的花费在云服务上。上次我算了一下，对于我们需要的性能要求，与使用AWS相比，我们节省了75%。对于我们目前的使用，我可以用节省下来的钱雇佣一个开发人员，他们认为这是对我们资金的更好的利用。</p><p id="dfcc" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">受Vito Botta的一系列帖子的启发，我使用Rancher创建了一个K8s集群。到目前为止一切都很好。他还非常出色地分析了Kubernetes的多种存储解决方案(<a class="ae ki" href="https://vitobotta.com/2019/08/06/kubernetes-storage-openebs-rook-longhorn-storageos-robin-portworx/" rel="noopener ugc nofollow" target="_blank">https://vito botta . com/2019/08/06/Kubernetes-storage-open EBS-rook-longhorn-storage OS-robin-portworx/</a>)。他的结论是，Linstor是明显的赢家，并进入了一个完全不同的联盟(<a class="ae ki" href="https://vitobotta.com/2020/01/04/linstor-storage-the-kubernetes-way/" rel="noopener ugc nofollow" target="_blank">https://vito botta . com/2020/01/04/Linstor-storage-the-kubernetes-way/</a>)。<em class="kj">剧透预警:我同意</em></p><figure class="jx jy jz ka gt kb gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kk"><img src="../Images/993cfee1889e51efcf507d7e80c72dfd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fk3jrCZ6p-N2RndBih-J7A.png"/></div></div><figcaption class="ke kf gj gh gi kg kh bd b be z dk translated"><a class="ae ki" href="https://landscape.cncf.io" rel="noopener ugc nofollow" target="_blank">存储的CNCF风景— https://landscape.cncf.io </a></figcaption></figure><p id="7a7b" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">我关注Kubernetes的“浪潮”有一段时间了，当我最终决定尝试它，因为我的提供商发布了一个新的锐龙线。当我意识到许多东西仍在开发中且不成熟，尤其是裸机部署(虚拟机虚拟化、MetalLB等)时，我大吃一惊。裸机存储仍然不成熟，多个商业和开源解决方案似乎可以解决这个问题。我决定对即将推出的主要免费解决方案进行基准测试(尽管我测试了一个商业解决方案，以检查我遗漏了什么)。</p><p id="1a6c" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated"><strong class="ir kp">免责声明，我对K8s很陌生。</strong></p><p id="9b26" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">实验中使用的硬件是4个工作节点*锐龙3700X，每个具有64GB ECC RAM和2TB NVMe。所有的基准测试都是使用so caster/d bench:latest image(基于fio)和O_DIRECT标志进行的。</p><h1 id="f3f2" class="kq kr iq bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">长角牛</h1><p id="3b52" class="pw-post-body-paragraph io ip iq ir b is lo iu iv iw lp iy iz ja lq jc jd je lr jg jh ji ls jk jl jm ij bi translated"><strong class="ir kp">许可证:</strong>阿帕奇2 <br/>商业支持:牧场主<br/>URL:<a class="ae ki" href="https://github.com/longhorn/longhorn" rel="noopener ugc nofollow" target="_blank">https://github.com/longhorn/longhorn</a><br/>GitHub stars:1.3k</p><p id="d169" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">长角牛是我喜欢的项目。因为是完全与牧场主融为一体的。这是一个点击安装从一个舵。</p><figure class="jx jy jz ka gt kb gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi lt"><img src="../Images/2922eb7122d865f89ed92d83d85ee036.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KPHt4bgVQB5fT-3KT4IC6Q.png"/></div></div><figcaption class="ke kf gj gh gi kg kh bd b be z dk translated">安装牧场主的长角牛</figcaption></figure><p id="24be" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">它是开源的，也是云本地计算基金会(CNCF)的沙盒项目。Rancher是一家资金雄厚、产品稳定的公司，它实际上为开发提供了资金。</p><figure class="jx jy jz ka gt kb gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi lu"><img src="../Images/c5008860e7a7659f7515b8e51c41ed78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*db2_9ITKKUJgskrrtwVmfg.png"/></div></div></figure><p id="fbf5" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">它还有一个很棒的图形用户界面，你可以直观地做任何事情。它的性能还可以。它仍处于测试阶段，并在GitHub上查看它显示的问题。</p><p id="b348" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">在我的测试中，我使用2个副本和Longhorn 0.8.0运行基准测试</p><p id="1222" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi">==================</p><p id="9e0b" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated"><strong class="ir kp">随机读/写IOPS: </strong> 28.2k/16.2k</p><p id="e0bf" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated"><strong class="ir kp">读写带宽:</strong>205兆比特/秒/108兆比特/秒</p><p id="b173" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated"><strong class="ir kp">读/写的平均延迟(usec):</strong>593.27/644.27</p><p id="c4b3" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated"><strong class="ir kp">顺序读/写:</strong>201兆字节/秒/108兆字节/秒</p><p id="bde8" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated"><strong class="ir kp">混合随机读/写IOPS: </strong> 14.7k/4904</p><h1 id="adaa" class="kq kr iq bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">OpenEBS</h1><p id="40d9" class="pw-post-body-paragraph io ip iq ir b is lo iu iv iw lp iy iz ja lq jc jd je lr jg jh ji ls jk jl jm ij bi translated">许可证:Apache 2 <br/>商业支持:多家公司(？)但是<a class="ae ki" href="https://mayadata.io/" rel="noopener ugc nofollow" target="_blank"> https://mayadata.io </a>貌似最大的<br/>网址:<a class="ae ki" href="https://github.com/openebs/openebs" rel="noopener ugc nofollow" target="_blank">https://github.com/openebs/openebs</a>Github stars:6k</p><p id="ae28" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">这也是一个云计算本地计算基金会(CNCF)沙盒项目。GitHub上有超过6k颗星星，这看起来是一个非常有前途的解决方案。在Vito Botta，它抱怨性能不佳。但是Mayadata的首席执行官是这样说的:</p><figure class="jx jy jz ka gt kb"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="3efe" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">在OpenEBS中，这是对其状态的免责声明:</p><blockquote class="lx ly lz"><p id="b1b1" class="io ip kj ir b is it iu iv iw ix iy iz ma jb jc jd mb jf jg jh mc jj jk jl jm ij bi translated">OpenEBS是业内使用和测试最广泛的Kubernetes存储基础设施之一。自2019年5月以来的CNCF沙盒项目，OpenEBS是第一个也是唯一一个跨内部和云系统在多个后端(本地、nfs、zfs、nvme)上提供一致的软件定义的存储功能的存储系统，并且是第一个开源其自己的针对有状态工作负载的混沌工程框架的存储系统，即<a class="ae ki" href="https://litmuschaos.io" rel="noopener ugc nofollow" target="_blank"> Litmus Project </a>，社区依赖该项目来自动评估OpenEBS版本的每月进度。自2018年以来，企业客户一直在生产中使用OpenEBS，该项目每周支持250多万次码头装卸。</p></blockquote><p id="94f7" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">它也有多个引擎，其最新的引擎对其性能做出了巨大的承诺:“MayaStor——一个NVMe在织物上的阿尔法引擎”。不幸的是，我没有测试它，因为它现在是一个阿尔法引擎。在我的测试中，我使用了1.8.0版本的jiva引擎。我在之前的尝试中也测试了cStor，但是忘记保存结果，但是jiva更快一些。我刚刚安装了默认的helm和所有默认设置，并使用helm安装创建的默认存储类(openebs-jiva-default)运行了基准测试。性能是所有发动机中最差的。(能不能有人指导一下我能不能提高这个成绩？)</p><p id="6c3b" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">带jiva引擎的OpenEBS 1.8.0。(3复制品？)</p><p id="2578" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi">==================</p><p id="e65e" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated"><strong class="ir kp">随机读/写IOPS: </strong> 2182/1527</p><p id="d1ac" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated"><strong class="ir kp">读写带宽:</strong>65.0兆比特/秒/41.9兆比特/秒</p><p id="4776" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated"><strong class="ir kp">读/写的平均延迟(usec):</strong>1825.49/2612.87</p><p id="ce58" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated"><strong class="ir kp">顺序读/写:</strong>95.5兆字节/秒/37.8兆字节/秒</p><p id="2a38" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated"><strong class="ir kp">混合随机读/写IOPS: </strong> 2607/856</p><h1 id="9f1b" class="kq kr iq bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">存储</h1><p id="dc43" class="pw-post-body-paragraph io ip iq ir b is lo iu iv iw lp iy iz ja lq jc jd je lr jg jh ji ls jk jl jm ij bi translated">许可证:商业<br/>网址:<a class="ae ki" href="https://storageos.com/" rel="noopener ugc nofollow" target="_blank">https://storageos.com/</a><br/>Github stars:不适用</p><p id="e740" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">这是一个商业解决方案，可免费使用高达110GB的存储空间。通过产品UI注册可以获得免费的开发者许可证，提供高达500GB的存储空间。它在Rancher上被列为“合作伙伴”,安装非常容易。它有一个基本的仪表板。我没有进行太深入的测试，因为这是一个商业解决方案，价格也不适合我。但是我想知道武力的商业一面可以做什么。</p><p id="cfaf" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">我利用了创建的名为“Fast”的存储类。结果是惊人的。比以前的解决方案好得多。</p><p id="46e9" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">存储操作系统—模板0.2.19 — Fast(默认配置，1个主服务器+ 0个副本服务器？)</p><p id="2b31" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi">==================</p><p id="1604" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated"><strong class="ir kp">随机读/写IOPS: </strong> 117k/90.4k</p><p id="91af" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated"><strong class="ir kp">读写带宽:</strong>2124兆比特/秒/457兆比特/秒</p><p id="3da4" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated"><strong class="ir kp">读/写的平均延迟(usec):</strong>63.44/86.52</p><p id="282e" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated"><strong class="ir kp">顺序读/写:</strong>1907兆字节/秒/448兆字节/秒</p><p id="e493" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated"><strong class="ir kp">混合随机读/写IOPS: </strong> 81.9k/27.3k</p><h1 id="6cb0" class="kq kr iq bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">比雷埃夫斯(基于Linstor)</h1><p id="434d" class="pw-post-body-paragraph io ip iq ir b is lo iu iv iw lp iy iz ja lq jc jd je lr jg jh ji ls jk jl jm ij bi translated"><strong class="ir kp">牌照:</strong>GPLv3<br/>T3】商业支持:LINBIT—<a class="ae ki" href="https://www.linbit.com/en/linstor/" rel="noopener ugc nofollow" target="_blank">https://www.linbit.com/en/linstor/</a><br/><strong class="ir kp">网址:</strong><a class="ae ki" href="https://github.com/piraeusdatastore/piraeus" rel="noopener ugc nofollow" target="_blank">https://github.com/piraeusdatastore/piraeus</a><br/>基于:<a class="ae ki" href="https://github.com/LINBIT/linstor-server" rel="noopener ugc nofollow" target="_blank">https://github.com/LINBIT/linstor-server</a><br/><strong class="ir kp">GitHub明星:</strong> 26😯(去启动项目吧！)</p><p id="4a7c" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">Vito Botta显然决定使用Linstor，这对我测试它是一个很好的暗示。乍一看，这个项目看起来很奇怪。几乎没有GitHub星，奇怪的名字，而且它甚至没有出现在<a class="ae ki" href="https://landscape.cncf.io" rel="noopener ugc nofollow" target="_blank"> CNCF景观</a>上。但是仔细看看，这并不是一个非常冒险的选择，因为？</p><ul class=""><li id="4a0b" class="md me iq ir b is it iw ix ja mf je mg ji mh jm mi mj mk ml bi translated"><a class="ae ki" href="https://en.wikipedia.org/wiki/Distributed_Replicated_Block_Device" rel="noopener ugc nofollow" target="_blank"> DRBD </a>用作底层存储复制机制。事实上它来自同一家公司。十多年来，DRBD 8.x一直是官方Linux内核的一部分。我们谈论的是一项经过20多年战斗考验的技术😱</li><li id="c421" class="md me iq ir b is mm iw mn ja mo je mp ji mq jm mi mj mk ml bi translated">LINSTOR用于存储管理，它也是一项成熟的技术，来自同一家公司。linstor-server(<a class="ae ki" href="https://github.com/LINBIT/linstor-server" rel="noopener ugc nofollow" target="_blank">https://github.com/LINBIT/linstor-server</a>)于2018年2月在GitHub上发布了第一个版本。它有连接器，并在多个项目中使用了一段时间，如Proxmox、OpenNebula和OpenStack。</li><li id="7d7e" class="md me iq ir b is mm iw mn ja mo je mp ji mq jm mi mj mk ml bi translated">Linbit似乎致力于不断创新，并不断推出新功能和改进。DRBD版本10处于alpha阶段，有一些非常创新的特性，比如擦除编码😍</li><li id="eeed" class="md me iq ir b is mm iw mn ja mo je mp ji mq jm mi mj mk ml bi translated">显然，他们正在采取一些行动，以便在CNCF得到代表</li></ul><p id="fb8f" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">好的，看起来足够可信了，可以把我珍贵的数据放上去了。但是性能比替代品更好吗？让我们看看。</p><h1 id="1ea0" class="kq kr iq bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">设置</h1><p id="8282" class="pw-post-body-paragraph io ip iq ir b is lo iu iv iw lp iy iz ja lq jc jd je lr jg jh ji ls jk jl jm ij bi translated">Vito在这里教大家如何设置Linstor <a class="ae ki" href="https://vitobotta.com/2020/01/04/linstor-storage-the-kubernetes-way/" rel="noopener ugc nofollow" target="_blank">。但在评论中，Linstor团队推荐了一个更新的项目，名为Piraeus。据我所知</a><a class="ae ki" href="https://github.com/piraeusdatastore/piraeus/" rel="noopener ugc nofollow" target="_blank">比雷埃夫斯</a>将是来自Linbit的开源项目，提供所有与K8s相关的东西。他们确实有一个<a class="ae ki" href="https://github.com/piraeusdatastore/piraeus-operator" rel="noopener ugc nofollow" target="_blank">舵手在开发中</a>，但是现在他们推荐</p><h2 id="696b" class="mr kr iq bd ks ms mt dn kw mu mv dp la ja mw mx le je my mz li ji na nb lm nc bi translated">比雷埃夫斯应该能够只使用这个yaml引用进行安装。</h2><pre class="jx jy jz ka gt nd ne nf ng aw nh bi"><span id="c3df" class="mr kr iq ne b gy ni nj l nk nl">kubectl apply -f <a class="ae ki" href="https://raw.githubusercontent.com/piraeusdatastore/piraeus/master/deploy/all.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/bratao/piraeus/master/deploy/all.yaml</a></span></pre><p id="9758" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated"><strong class="ir kp">警告—</strong>2020–05–04—<strong class="ir kp">你从我的私人仓库里拿东西。你应该尽快查看官方资料库！我更新了图片版本，因为它解决了我在使用Ubuntu时遇到的一个问题。</strong></p><h2 id="7eb5" class="mr kr iq bd ks ms mt dn kw mu mv dp la ja mw mx le je my mz li ji na nb lm nc bi translated">你应该检查一下https://github.com/piraeusdatastore/piraeus/的官方档案</h2><p id="409d" class="pw-post-body-paragraph io ip iq ir b is lo iu iv iw lp iy iz ja lq jc jd je lr jg jh ji ls jk jl jm ij bi translated">另一个选择是来自kvaps的，看起来比官方的比雷埃夫斯仓库多七个维护:<a class="ae ki" href="https://github.com/kvaps/kube-linstor" rel="noopener ugc nofollow" target="_blank">https://github.com/kvaps/kube-linstor</a></p><figure class="jx jy jz ka gt kb gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/253f84c0692e21c8c9631b9a1d1f36cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sLT0aoXK0bCWutT1d_oLcw.png"/></div></div><figcaption class="ke kf gj gh gi kg kh bd b be z dk translated">比雷埃夫斯安装后运行的所有节点</figcaption></figure><h1 id="8df0" class="kq kr iq bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">管理</h1><p id="3193" class="pw-post-body-paragraph io ip iq ir b is lo iu iv iw lp iy iz ja lq jc jd je lr jg jh ji ls jk jl jm ij bi translated">所有的管理都是通过命令行完成的。您可以访问比雷埃夫斯-控制器节点的外壳来访问它。</p><figure class="jx jy jz ka gt kb gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/82e9d28544fc223f7d0dec8c37364689.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*maqNeQVRvNPSLCykdUNlWg.png"/></div></div></figure><p id="67b4" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">在控制器上，您可以访问linstor-server应用程序。这是drbd上的一个抽象层，可以在你的舰队上发布命令。在下面的屏幕截图中，您可以看到多个方便的管理命令，例如:</p><ul class=""><li id="e944" class="md me iq ir b is it iw ix ja mf je mg ji mh jm mi mj mk ml bi translated">linstor节点列表—显示已连接节点的列表及其状态</li><li id="4f66" class="md me iq ir b is mm iw mn ja mo je mp ji mq jm mi mj mk ml bi translated">linstor卷列表—显示已创建卷的列表以及它们的位置</li><li id="4329" class="md me iq ir b is mm iw mn ja mo je mp ji mq jm mi mj mk ml bi translated">linstor节点信息—显示每个节点的功能</li></ul><p id="b4d6" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">完整的列表你可以查看官方文档</p><div class="no np gp gr nq nr"><a href="https://www.linbit.com/drbd-user-guide/users-guide-linstor/" rel="noopener  ugc nofollow" target="_blank"><div class="ns ab fo"><div class="nt ab nu cl cj nv"><h2 class="bd kp gy z fp nw fr fs nx fu fw ny bi translated">用户指南LINSTOR“LINBIT</h2><div class="nz l"><h3 class="bd b gy z fp nw fr fs nx fu fw dk translated">《LINSTOR用户指南》请先阅读本指南。本指南旨在为软件定义的存储的用户提供服务</h3></div><div class="oa l"><p class="bd b dl z fp nw fr fs nx fu fw dk translated">www.linbit.com</p></div></div><div class="ob l"><div class="oc l od oe of ob og kc nr"/></div></div></a></div><figure class="jx jy jz ka gt kb gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/b07101a19456a095dba5440a889d4131.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tqYhSQ2nWvdyA-DVLpW07w.png"/></div></div><figcaption class="ke kf gj gh gi kg kh bd b be z dk translated">Linstor命令</figcaption></figure><p id="069b" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">在一些罕见的情况下，比如大脑分裂，您可以通过节点直接访问drbd。</p><h1 id="c47b" class="kq kr iq bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">灾难恢复</h1><p id="24ee" class="pw-post-body-paragraph io ip iq ir b is lo iu iv iw lp iy iz ja lq jc jd je lr jg jh ji ls jk jl jm ij bi translated">我竭尽全力破坏我的集群。我多次拔出插头(硬电源重置)我的节点。linstor具有惊人的弹性。</p><p id="2e98" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">但是在一种情况下，这被称为裂脑。drbd很擅长检测。在我的情况下，辅助节点从复制中脱离。</p><blockquote class="lx ly lz"><p id="a8ee" class="io ip kj ir b is it iu iv iw ix iy iz ma jb jc jd mb jf jg jh mc jj jk jl jm ij bi translated">裂脑是这样一种情况，由于集群节点之间的所有网络链接暂时出现故障，并且可能由于集群管理软件的干预或人为错误，两个节点在断开连接时都切换到了<em class="iq">主</em>角色。这是一种潜在的有害状态，因为它意味着可能在任一节点上对数据进行了修改，而没有复制到对等节点。因此，在这种情况下，很可能已经创建了两个不同的数据集，不能轻易合并。</p><p id="30e6" class="io ip kj ir b is it iu iv iw ix iy iz ma jb jc jd mb jf jg jh mc jj jk jl jm ij bi translated">DRBD裂脑与集群裂脑不同，后者是指由分布式集群管理应用程序(如Heartbeat)管理的主机之间失去所有连接。为避免混淆，本指南使用以下约定:</p><p id="17b4" class="io ip kj ir b is it iu iv iw ix iy iz ma jb jc jd mb jf jg jh mc jj jk jl jm ij bi translated"><em class="iq">裂脑</em>指的是上一段描述的DRBD裂脑。</p><p id="cc6c" class="io ip kj ir b is it iu iv iw ix iy iz ma jb jc jd mb jf jg jh mc jj jk jl jm ij bi translated">失去所有集群连接被称为<em class="iq">集群分区</em>，这是集群裂脑的另一种说法。</p></blockquote><p id="cb2c" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">你可以从官方的drbd文档中读到它(<a class="ae ki" href="https://www.linbit.com/drbd-user-guide/drbd-guide-9_0-en/" rel="noopener ugc nofollow" target="_blank">https://www.linbit.com/drbd-user-guide/drbd-guide-9_0-en/</a>)</p><figure class="jx jy jz ka gt kb gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/b9d1ed2a71a30ba2e9463c190adf1f50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RDDUDqDO_J_LRdE8MEmX5A.png"/></div></div><figcaption class="ke kf gj gh gi kg kh bd b be z dk translated">辅助节点已退出复制</figcaption></figure><p id="672d" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">在我的例子中，我决定通过丢弃辅助数据并要求它与主节点重新同步来解决这个问题。因为我喜欢图形界面，所以我使用了drbdtop实用程序。有了它，你可以在drbd节点中可视化地监控和发布命令。首先，我进入损坏的海盗节点外壳。在我的例子中，它是“worker2-gpu”。</p><figure class="jx jy jz ka gt kb gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/285ad0c24941054e563a97eb182e83e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hqG2EhXodbmki02dyMOFkw.png"/></div></div><figcaption class="ke kf gj gh gi kg kh bd b be z dk translated">访问节点</figcaption></figure><p id="461e" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">在这个shell中，我下载了drdbtop接口。我在哪里可以找到这个伟大的界面</p><pre class="jx jy jz ka gt nd ne nf ng aw nh bi"><span id="edbb" class="mr kr iq ne b gy ni nj l nk nl"><a class="ae ki" href="https://github.com/LINBIT/drbdtop/releases/download/v0.2.2/drbdtop-linux-amd64" rel="noopener ugc nofollow" target="_blank">wget https://github.com/LINBIT/drbdtop/releases/download/v0.2.2/drbdtop-linux-amd64</a><br/>chmod +x drbdtop-linux-amd64<br/>./drbdtop-linux-amd64</span></pre><figure class="jx jy jz ka gt kb gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ok"><img src="../Images/d7327f78c52512657015274fc0b9f0e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5GoEGr768YZaOf9BhAL4cg.png"/></div></div><figcaption class="ke kf gj gh gi kg kh bd b be z dk translated">运行drbdtop工具</figcaption></figure><p id="8d3e" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">看看底部的工具栏。你可以发布命令来修复裂脑。</p><figure class="jx jy jz ka gt kb gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/c447c91627e269a21e0a64bac6f1ae43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k8cn3qu4hJ3ToqMDd7ILiQ.png"/></div></div></figure><p id="37d3" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">之后，节点会自动连接和同步😍</p><h1 id="2534" class="kq kr iq bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">提高速度</h1><p id="bc62" class="pw-post-body-paragraph io ip iq ir b is lo iu iv iw lp iy iz ja lq jc jd je lr jg jh ji ls jk jl jm ij bi translated">默认情况下，Piraeus/Linstor/drbd具有令人难以置信的性能，正如您将在下面看到的。它有一个合理且非常安全的默认设置。但写作表现却有些欠缺。因为我的服务器分散在不同的数据中心(但是很近)，所以我想调整它们的性能。</p><p id="c426" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">优化的第一点是复制的协议。默认情况下，它使用协议C，等待远程辅助节点上的写入确认。下面是对可能的协议的描述:</p><p id="68dc" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated"><strong class="ir kp">协议A </strong></p><p id="b7f1" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">异步复制协议。一旦本地磁盘写入完成，主节点上的本地写入操作即被视为完成，并且复制数据包已被放置在本地TCP发送缓冲区中。重要的一点是TCP发送缓冲区非常小。你可以增加它，直到一个极限。</p><p id="a736" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated"><strong class="ir kp">协议B </strong></p><p id="614e" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">内存同步(半同步)复制协议。一旦本地磁盘写入发生，并且复制数据包已到达对等节点，主节点上的本地写入操作即被视为完成。</p><p id="545e" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated"><strong class="ir kp">协议C(默认)</strong></p><p id="2329" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">同步复制协议。只有在确认了本地和远程磁盘写入后，主节点上的本地写入操作才被视为完成。</p><p id="5e2e" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">因此，我还通过在控制器的shell中运行以下命令，在Linstor中使用异步协议(它支持同步/半同步/异步复制)进行了基准测试:</p><pre class="jx jy jz ka gt nd ne nf ng aw nh bi"><span id="dc83" class="mr kr iq ne b gy ni nj l nk nl">linstor c drbd-options --protocol A --after-sb-0pri=discard-zero-changes  --after-sb-1pri=discard-secondary  --after-sb-2pri=disconnect --max-buffers 131072 --sndbuf-size 1085760 --rcvbuf-size 1085760 --c-max-rate 4194304 --c-fill-target 1048576</span></pre><p id="5a50" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">这个使用异步协议，并将缓冲区增加到1MB。相对安全。或者你可以使用下面的忽略磁盘刷新，有一个更大的缓冲区</p><pre class="jx jy jz ka gt nd ne nf ng aw nh bi"><span id="ab22" class="mr kr iq ne b gy ni nj l nk nl">linstor c drbd-options --protocol A --after-sb-0pri=discard-zero-changes  --after-sb-1pri=discard-secondary  --after-sb-2pri=disconnect --max-buffers 131072 --sndbuf-size 10485760 --rcvbuf-size 10485760 --disk-barrier no --disk-flushes no --c-max-rate 4194304 --c-fill-target 1048576</span></pre><p id="5220" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">请记住，在主节点关闭的情况下，副本节点上可能会有少量数据丢失。</p><figure class="jx jy jz ka gt kb gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/cb33e7b664ff0545f04b94c01384207c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CN4d81HSiyBY0gnKPWOedA.png"/></div></div><figcaption class="ke kf gj gh gi kg kh bd b be z dk translated">在繁重的写入任务期间，节点会使用异步协议暂时过时</figcaption></figure><h1 id="fb4c" class="kq kr iq bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">基准</h1><p id="df8a" class="pw-post-body-paragraph io ip iq ir b is lo iu iv iw lp iy iz ja lq jc jd je lr jg jh ji ls jk jl jm ij bi translated">所有基准器都是使用以下工作制作的:</p><pre class="jx jy jz ka gt nd ne nf ng aw nh bi"><span id="a208" class="mr kr iq ne b gy ni nj l nk nl">kind: PersistentVolumeClaim<br/>apiVersion: v1<br/>metadata:<br/>  name: dbench<br/>spec:<br/>  storageClassName:  STORAGE_CLASS<br/>  accessModes:<br/>    - ReadWriteOnce<br/>  resources:<br/>    requests:<br/>      storage: 5Gi<br/>---<br/>apiVersion: batch/v1<br/>kind: Job<br/>metadata:<br/>  name: dbench<br/>spec:<br/>  template:<br/>    spec:<br/>      containers:<br/>      - name: dbench<br/>        image: sotoaster/dbench:latest<br/>        imagePullPolicy: IfNotPresent<br/>        env:<br/>          - name: DBENCH_MOUNTPOINT<br/>            value: /data<br/>          - name: FIO_SIZE<br/>            value: 1G<br/>        volumeMounts:<br/>        - name: dbench-pv<br/>          mountPath: /data<br/>      restartPolicy: Never<br/>      volumes:<br/>      - name: dbench-pv<br/>        persistentVolumeClaim:<br/>          claimName: dbench<br/>  backoffLimit: 4</span></pre><p id="624d" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">机器之间的延迟为(ttl=61时间=0.211毫秒)。测得它们之间的带宽为943兆比特/秒。这里所有节点运行Ubuntu 18.04。</p><figure class="jx jy jz ka gt kb"><div class="bz fp l di"><div class="on lw l"/></div></figure><figure class="jx jy jz ka gt kb gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oo"><img src="../Images/f7356d1d968cf0dc2dc9483817f938f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jLqMeDm_UHVDLzy3gmUTbA.png"/></div></div><figcaption class="ke kf gj gh gi kg kh bd b be z dk translated">结果汇编</figcaption></figure><p id="f148" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">如您所见，比雷埃夫斯和StorageOS获得了最佳性能。具有2个副本和异步协议的比雷埃夫斯具有所有性能中最好的。</p><h1 id="50e4" class="kq kr iq bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">结论</h1><p id="d041" class="pw-post-body-paragraph io ip iq ir b is lo iu iv iw lp iy iz ja lq jc jd je lr jg jh ji ls jk jl jm ij bi translated">这是对K8s的一些存储解决方案的简单且可能不公平的比较。</p><p id="0d56" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">Longhorn是我最喜欢的解决方案，因为它有很好的GUI和与Rancher的集成。但表现乏善可陈。显然，他们现在关注的是安全性和正确性，以后会关注性能。</p><p id="f36a" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">我在一些项目的生产环境中使用Linstor/Piraeus已经有一段时间了，到目前为止一切都很好。我创建并删除了多个磁盘，重启了节点，并且没有停机😃</p><p id="d629" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">在我看来，比雷埃夫斯号已经可以生产了，但仍需要一些抛光。我向他们的slack频道报告了一些bug，但是(不要认为这是一种冒犯)被他们的开发者忽略了:“去学习Kubernetes”(这是真的，我对k8s非常陌生)。经过一番争论后，我向他们展示了这实际上是他们的init脚本中的一个错误。昨天，在内核更新和重启期间，一个节点无法启动。将drbd模块注入内核的脚本编译失败(【https://github.com/piraeusdatastore/piraeus/issues/30】T2)。恢复到旧内核解决了这个问题。</p><p id="c8d6" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">话虽如此。通过他们在drbd上构建它的方式，你可以得到一个经过实战考验的、性能卓越的解决方案。如果有任何问题，你可以直接去找drbd管理部门解决。你可以在网上找到多年的问题和答案。</p><p id="688e" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">如果我做错了什么，如果这里有我可以改进的地方，或者你需要任何帮助，你可以随时通过我的推特<a class="ae ki" href="https://twitter.com/BrunoPotelo" rel="noopener ugc nofollow" target="_blank">(https://twitter.com/BrunoPotelo</a>)或者我的GitHub(<a class="ae ki" href="https://github.com/bratao" rel="noopener ugc nofollow" target="_blank">https://github.com/bratao</a>)联系我</p></div></div>    
</body>
</html>