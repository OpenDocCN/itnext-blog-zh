# 使用 Helm 支持 Kubernetes 中服务的多个版本

> 原文：<https://itnext.io/support-multiple-versions-of-a-service-in-kubernetes-using-helm-ce26adcb516d?source=collection_archive---------1----------------------->

T 这里有许多场景，人们希望在产品中保留一个服务多个版本。一些典型的使用案例包括:

*   特性的 A/B 测试。
*   生产环境中的测试。
*   中断服务更改的迁移路径。例如 API 的变化——但是旧的客户端需要支持一段时间，直到它们被升级。
*   在广泛提供之前，为早期客户推出该功能。
*   还有更多..

在这些情况下，路由到特定版本的服务通常是基于请求头来完成的。

用传统方式支持多个版本需要为每个服务版本创建多个清单 yamls。这给保持不同版本的同步带来了挑战。

## **拯救舵图模板**

在这里，我将演示如何使用舵图以声明的方式实现对服务的多版本支持。

舵模板引擎支持[流量控制](https://github.com/kubernetes/helm/blob/master/docs/chart_template_guide/control_structures.md)。我们可以使用范围结构来提供“for-each”样式的循环。以下是示例`values.yaml`文件:

请注意，versions 是一个数组，数组中的每一项都包含特定于服务版本的变量。在上面的例子中，我有一个`stable`版本和另一个`next-gen`版本。

以下代码片段显示了相应的部署规范:

这个部署模板文件遍历 Values.yaml 中定义的所有版本，并创建相应的部署和 RouteRule 规范。我正在利用 Istio 进行基于标题的路由。该规则指定，如果请求包含版本头，则将其路由到相应的服务版本。

请注意，一个版本可以根据需要与另一个版本相似或不同。在这方面不做任何假设。每个服务版本都可以通过更新`values.yaml`的版本数组中相应的配置来更新。

使用这个技巧——多版本服务可以以声明性的代码配置方式得到支持。希望你觉得有用。

快乐驾驶！！！