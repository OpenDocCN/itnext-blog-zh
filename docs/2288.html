<html>
<head>
<title>Visual Regression Test with WebdriverIO &amp; WebdriverCSS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用WebdriverIO &amp; WebdriverCSS进行可视化回归测试</h1>
<blockquote>原文：<a href="https://itnext.io/visual-regression-test-with-webdriverio-webdrivercss-d7675a1812b2?source=collection_archive---------2-----------------------#2019-05-01">https://itnext.io/visual-regression-test-with-webdriverio-webdrivercss-d7675a1812b2?source=collection_archive---------2-----------------------#2019-05-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/d882cf7bf6401824026b2e72b1cb81b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*nt7Y2jXeWqMwtMGka0-lRg.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated"><em class="jy">视觉回归测试结果</em></figcaption></figure><p id="77fe" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><strong class="kb ir"> TLTR </strong>:它会捕捉图像作为第一次运行的基线，然后与下一次运行的图像进行比较！就是这样。</p><p id="e7bf" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">使用Spec Reporter将结果显示在您的日志中，这样您就可以知道您的测试是否失败。</p><p id="7ac4" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><strong class="kb ir">要求</strong></p><p id="b06f" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">运行<a class="ae kx" href="https://github.com/mojoaxel/awesome-regression-testing" rel="noopener ugc nofollow" target="_blank">可视化回归测试</a>的工具太多了，我总是更喜欢免费的。在这篇文章中，我将向你展示如何用<a class="ae kx" href="http://v4.webdriver.io" rel="noopener ugc nofollow" target="_blank"> WebdriverIO v4 </a>(它还不能与v5一起使用)<a class="ae kx" href="https://github.com/visualregressiontesting/webdrivercss" rel="noopener ugc nofollow" target="_blank"> WebdriverCSS </a>、<a class="ae kx" href="http://chromedriver.chromium.org/" rel="noopener ugc nofollow" target="_blank"> Chromedriver </a>和<a class="ae kx" href="http://www.graphicsmagick.org/" rel="noopener ugc nofollow" target="_blank"> GraphicsMagick </a>进行可视化回归测试。</p><p id="4bed" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">在开始编写测试代码之前，您应该阅读关于如何安装GraphicsMagick的文档。</p><p id="8bf9" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><strong class="kb ir">入门</strong></p><p id="a4ef" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">为您的项目准备package.json</p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="2e45" class="lh li iq ld b gy lj lk l ll lm">// package.json</span><span id="2c8f" class="lh li iq ld b gy ln lk l ll lm">{<br/>  "name": "visual-regression-test",<br/>  "version": "1.0.0",<br/>  "description": "Visual Regression Test",<br/>  "main": "index.js",<br/>  "scripts": {<br/>    "clean": "find . -name '*.diff.png' -delete",<br/>    "test": "npm run clean &amp;&amp; wdio",<br/>    "dev": "wdio --spec"<br/>  },<br/>  "keywords": [<br/>    "webdriverio",<br/>    "webdrivercss",<br/>    "visual-regression-testing",<br/>    "regression-testing"<br/>  ],<br/>  "author": "Dale Nguyen",<br/>  "license": "ISC",<br/>  "dependencies": {<br/>    "webdrivercss": "github:visualregressiontesting/webdrivercss",<br/>    "webdriverio": "^4.14.4"<br/>  },<br/>  "devDependencies": {<br/>    "wdio-mocha-framework": "^0.6.4",<br/>    "wdio-selenium-standalone-service": "0.0.12",<br/>    "wdio-spec-reporter": "^0.1.5"<br/>  }<br/>}</span></pre><p id="0235" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">之后，你只需要安装所有的软件包。</p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="0cf6" class="lh li iq ld b gy lj lk l ll lm">npm install</span></pre><p id="906d" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><strong class="kb ir">准备您的WebdriverIO配置文件</strong></p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="2e79" class="lh li iq ld b gy lj lk l ll lm">./node_modules/.bin/wdio config</span></pre><p id="d871" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后回答一些问题。</p><p id="5953" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">编写你的第一个测试</p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="53c9" class="lh li iq ld b gy lj lk l ll lm">// test/home.page.spec.js</span><span id="cfc8" class="lh li iq ld b gy ln lk l ll lm">const assert = require('assert');<br/>const wdio = require('webdriverio');<br/>var getDiffFiles = require('../utils/get_diff_files');</span><span id="917a" class="lh li iq ld b gy ln lk l ll lm">let client;</span><span id="a8dd" class="lh li iq ld b gy ln lk l ll lm">const options = {<br/>    url: '<a class="ae kx" href="https://learn.visualregressiontesting.com/'" rel="noopener ugc nofollow" target="_blank">https://learn.visualregressiontesting.com/'</a>,<br/>    // url: '<a class="ae kx" href="https://learn.visualregressiontesting.com/broke.html'" rel="noopener ugc nofollow" target="_blank">https://learn.visualregressiontesting.com/broke.html'</a>,<br/>    screenshotRoot: 'screenshots/page1',<br/>    failedComparisonsRoot: 'screenshots/page1/diffs'<br/>}</span><span id="5b59" class="lh li iq ld b gy ln lk l ll lm">describe('my website should always look the same',function() {<br/>    beforeEach('init webdrivercss', () =&gt; {<br/>        client = wdio.remote({<br/>            desiredCapabilities: {<br/>                browserName: 'chrome',<br/>                chromeOptions: {<br/>                    args: [<br/>                        '--headless', <br/>                        '--disable-gpu',<br/>                        'window-size=1920,1080'<br/>                    ]<br/>                }        <br/>            }<br/>        }).init();<br/>        <br/>        require('webdrivercss').init(client, {<br/>            // example options<br/>            screenshotRoot: options.screenshotRoot,<br/>            failedComparisonsRoot: options.failedComparisonsRoot,<br/>            // misMatchTolerance: 0.05,<br/>            // screenWidth: [320,480,640,1024]<br/>        });<br/>    })</span><span id="2b01" class="lh li iq ld b gy ln lk l ll lm">it('homepage should look the same', async (done) =&gt; {<br/>        await client.url(options.url)<br/>            .webdrivercss('homepage', [<br/>                {<br/>                    name: 'header',<br/>                    elem: '.header'<br/>                },<br/>                {<br/>                    name: 'benefits',<br/>                    elem: '.benefits',<br/>                    screenWidth: [320, 640, 1024]<br/>                }<br/>            ])<br/>            .end()            <br/>            .call(done);</span><span id="1af8" class="lh li iq ld b gy ln lk l ll lm">        // test diff folder<br/>        const files = await getDiffFiles(options.failedComparisonsRoot);        <br/>        // console.table({files})<br/>        assert.equal(files.length, 0, `There are changes on the site! Please check in ${options.failedComparisonsRoot} folder.`)<br/>    });<br/>})</span></pre><p id="77a4" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">测试将在Chrome headless模式下运行。第一次运行时，您将使用<a class="ae kx" href="https://learn.visualregressiontesting.com/'" rel="noopener ugc nofollow" target="_blank">https://learn.visualregressiontesting.com/</a>站点创建基础映像。下一次，你可以用<a class="ae kx" href="https://learn.visualregressiontesting.com/broke.html'" rel="noopener ugc nofollow" target="_blank">https://learn.visualregressiontesting.com/broke.html</a>，来展示两个站点的区别。如有差异，将保存在<strong class="kb ir">截图/**/diffs </strong>文件夹下。</p><p id="0136" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">测试将检查<strong class="kb ir"> diffs </strong>文件夹下是否有文件，并分割出结果。</p><p id="00c0" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">这是等待<strong class="kb ir"> diffs </strong>文件夹下文件的帮助函数。</p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="44e3" class="lh li iq ld b gy lj lk l ll lm">// utils/get_diff_files.js</span><span id="16d2" class="lh li iq ld b gy ln lk l ll lm">const fs = require('fs');</span><span id="c5d1" class="lh li iq ld b gy ln lk l ll lm">const getDiffFiles = (path) =&gt; {<br/>    return new Promise((resolve, reject) =&gt; {<br/>        fs.readdir(path, function(err, items) { <br/>            var temp = [];<br/>            for (var i=0; i&lt;items.length; i++) {<br/>                if(items[i].includes('.png')) {<br/>                    temp.push(items[i]);<br/>                }                <br/>            }<br/>            resolve(temp);<br/>        });<br/>    })<br/>}</span><span id="e8fe" class="lh li iq ld b gy ln lk l ll lm">module.exports = getDiffFiles</span></pre><p id="afe3" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">就是这样。你只需要跑</p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="141a" class="lh li iq ld b gy lj lk l ll lm">npm test</span></pre><p id="ad5b" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">以便显示在您更新或更改您的网站后是否有任何差异。</p><p id="ad46" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">这里是<a class="ae kx" href="https://github.com/dalenguyen/visual-regression-testing" rel="noopener ugc nofollow" target="_blank"> Git库</a>，以防你想检查工作代码。</p><p id="261c" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><a class="ae kx" href="https://github.com/dalenguyen/visual-regression-testing" rel="noopener ugc nofollow" target="_blank">https://github.com/dalenguyen/visual-regression-testing</a></p></div></div>    
</body>
</html>