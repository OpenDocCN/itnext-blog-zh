<html>
<head>
<title>Event Source with Angular</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带角度的事件源</h1>
<blockquote>原文：<a href="https://itnext.io/event-source-with-angular-c9f7f5369082?source=collection_archive---------1-----------------------#2018-06-11">https://itnext.io/event-source-with-angular-c9f7f5369082?source=collection_archive---------1-----------------------#2018-06-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="4c56" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">介绍</h1><p id="389a" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">事件源是SSE(服务器发送的事件)的一部分。它通过提供服务器与浏览器之间的单向通信，将数据推送到浏览器。这里，通信只在服务器和浏览器之间进行，浏览器不向服务器发送任何数据。</p><h2 id="9467" class="lj jo iq bd jp lk ll dn jt lm ln dp jx kw lo lp kb la lq lr kf le ls lt kj lu bi translated">事件源示例</h2><ol class=""><li id="cf15" class="lv lw iq kn b ko kp ks kt kw lx la ly le lz li ma mb mc md bi translated">网站上板球比分的自动更新。</li><li id="02d9" class="lv lw iq kn b ko me ks mf kw mg la mh le mi li ma mb mc md bi translated">在线股票价格更新的自动更新。</li><li id="7834" class="lv lw iq kn b ko me ks mf kw mg la mh le mi li ma mb mc md bi translated">自动更新天气信息，如温度、湿度、降雨预报等。</li><li id="06fd" class="lv lw iq kn b ko me ks mf kw mg la mh le mi li ma mb mc md bi translated">Twitter更新时间表。</li></ol><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/fdc035692f9ce8b4d72e3de2ce9e7ed7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yrcwo4VRf0WPmbfzkTHmmQ.jpeg"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">Angular和Java之间的事件源(spring boot)</figcaption></figure><h1 id="662e" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated"><strong class="ak">事件源或SSE Vs Web-socket </strong></h1><h2 id="7414" class="lj jo iq bd jp lk ll dn jt lm ln dp jx kw lo lp kb la lq lr kf le ls lt kj lu bi translated"><em class="mz">事件来源</em></h2><ol class=""><li id="2851" class="lv lw iq kn b ko kp ks kt kw lx la ly le lz li ma mb mc md bi translated">它是服务器发送的通信，仅在服务器和web浏览器客户端之间进行。它支持单向通信。</li><li id="8acc" class="lv lw iq kn b ko me ks mf kw mg la mh le mi li ma mb mc md bi translated">它不支持二进制。它只使用UTF-8。</li><li id="7986" class="lv lw iq kn b ko me ks mf kw mg la mh le mi li ma mb mc md bi translated">它有一个最大的开放连接限制。</li><li id="742f" class="lv lw iq kn b ko me ks mf kw mg la mh le mi li ma mb mc md bi translated">它内置了对重新连接和事件Id的支持。</li></ol><h2 id="c8dc" class="lj jo iq bd jp lk ll dn jt lm ln dp jx kw lo lp kb la lq lr kf le ls lt kj lu bi translated"><em class="mz">网络插座</em></h2><ol class=""><li id="6043" class="lv lw iq kn b ko kp ks kt kw lx la ly le lz li ma mb mc md bi translated">它通过单个TCP连接提供双向全双工通信。</li><li id="a7ae" class="lv lw iq kn b ko me ks mf kw mg la mh le mi li ma mb mc md bi translated">数据可以从服务器传输到浏览器，反之亦然。网聊就是最好的例子。</li><li id="55d2" class="lv lw iq kn b ko me ks mf kw mg la mh le mi li ma mb mc md bi translated">它支持任意二进制数据。</li></ol><h1 id="630f" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated"><strong class="ak">代码讨论</strong></h1><p id="2371" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><em class="na">服务等级(弹簧启动)</em></p><p id="1f2a" class="pw-post-body-paragraph kl km iq kn b ko nb kq kr ks nc ku kv kw nd ky kz la ne lc ld le nf lg lh li ij bi translated">这里，服务类从某个数据源接收数据，并将其提供给控制器类，如下所示:</p><pre class="mk ml mm mn gt ng nh ni nj aw nk bi"><span id="9040" class="lj jo iq nh b gy nl nm l nn no">package com.myservice;</span><span id="c7df" class="lj jo iq nh b gy np nm l nn no">import java.io.IOException;<br/>import java.util.HashMap;<br/>import java.util.Map;</span><span id="3726" class="lj jo iq nh b gy np nm l nn no">import org.springframework.cache.annotation.CachePut;<br/>import org.springframework.cache.annotation.Cacheable;<br/>import org.springframework.stereotype.Service;</span><span id="d6fa" class="lj jo iq nh b gy np nm l nn no">import com.fasterxml.jackson.databind.ObjectMapper;<br/>import com.philips.models.WorkflowDataModel;</span><span id="e9c8" class="lj jo iq nh b gy np nm l nn no"><a class="ae nq" href="http://twitter.com/Service" rel="noopener ugc nofollow" target="_blank">@Service</a><br/>public class StatusInProgress {</span><span id="d615" class="lj jo iq nh b gy np nm l nn no"> private static Map&lt;String, String&gt; storeData = new HashMap&lt;String, String&gt;();</span><span id="391a" class="lj jo iq nh b gy np nm l nn no"><a class="ae nq" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/> public void triggerEvent(MyDataModel eventData) {<br/>  System.out.println("Display To Angular App");<br/>  try {</span><span id="2256" class="lj jo iq nh b gy np nm l nn no">System.out.println(eventData.getPatientId());<br/>   ObjectMapper mapper = new ObjectMapper();<br/>   String jsonText = mapper.writeValueAsString(eventData);<br/>   putPatient(jsonText);<br/>  } catch (IOException e1) {<br/>   e1.printStackTrace();<br/>  }<br/> }</span><span id="e35b" class="lj jo iq nh b gy np nm l nn no"><a class="ae nq" href="http://twitter.com/CachePut" rel="noopener ugc nofollow" target="_blank">@CachePut</a>(value = "myData")<br/> public void putMyData(String myData) {<br/>  if (storeData.containsKey("mydata")) {<br/>   storeData.remove("mydata");<br/>  }</span><span id="d548" class="lj jo iq nh b gy np nm l nn no">storeData.put("mydata", patientData);<br/> }</span><span id="0d85" class="lj jo iq nh b gy np nm l nn no"><a class="ae nq" href="http://twitter.com/Cacheable" rel="noopener ugc nofollow" target="_blank">@Cacheable</a>(value = "myData")<br/> public String getMyData() {<br/>  String myitem= "";<br/>  try {<br/>   myitem = storeData.get("mydata");<br/>  } catch (Exception e) {<br/>  }</span><span id="ce71" class="lj jo iq nh b gy np nm l nn no">return myitem;<br/> }<br/>}</span></pre><p id="acc2" class="pw-post-body-paragraph kl km iq kn b ko nb kq kr ks nc ku kv kw nd ky kz la ne lc ld le nf lg lh li ij bi translated"><em class="na">控制器类(弹簧启动)</em></p><p id="0abf" class="pw-post-body-paragraph kl km iq kn b ko nb kq kr ks nc ku kv kw nd ky kz la ne lc ld le nf lg lh li ij bi translated">控制器类从服务类接收数据，并通过REST API发出数据。它使用SseEmitter。</p><pre class="mk ml mm mn gt ng nh ni nj aw nk bi"><span id="3fb9" class="lj jo iq nh b gy nl nm l nn no">package com.controller;</span><span id="c566" class="lj jo iq nh b gy np nm l nn no">import java.io.IOException;</span><span id="be8c" class="lj jo iq nh b gy np nm l nn no">import org.springframework.beans.factory.annotation.Autowired;</span><span id="0deb" class="lj jo iq nh b gy np nm l nn no">import org.springframework.stereotype.Controller;</span><span id="f927" class="lj jo iq nh b gy np nm l nn no">import org.springframework.web.bind.annotation.CrossOrigin;</span><span id="ab9e" class="lj jo iq nh b gy np nm l nn no">import org.springframework.web.bind.annotation.RequestMapping;</span><span id="fa18" class="lj jo iq nh b gy np nm l nn no">import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;</span><span id="4d2b" class="lj jo iq nh b gy np nm l nn no">import com.myservice;</span><span id="688c" class="lj jo iq nh b gy np nm l nn no">@Controller</span><span id="3dbb" class="lj jo iq nh b gy np nm l nn no">public class MyDataController {</span><span id="d590" class="lj jo iq nh b gy np nm l nn no">@Autowired</span><span id="4e54" class="lj jo iq nh b gy np nm l nn no">private StatusInProgress statusInProgress;</span><span id="ca0d" class="lj jo iq nh b gy np nm l nn no">@CrossOrigin(exposedHeaders = "Access-Control-Allow-Origin")</span><span id="5f70" class="lj jo iq nh b gy np nm l nn no">@RequestMapping(value = "/get_mydata")</span><span id="59aa" class="lj jo iq nh b gy np nm l nn no">public SseEmitter getMyData() throws InterruptedException {</span><span id="4715" class="lj jo iq nh b gy np nm l nn no">SseEmitter notifier = new SseEmitter(600L);</span><span id="cc12" class="lj jo iq nh b gy np nm l nn no">try {</span><span id="7361" class="lj jo iq nh b gy np nm l nn no">String myData = statusInProgress.getMyData();</span><span id="b466" class="lj jo iq nh b gy np nm l nn no">if (myData!= null &amp;&amp; myData!= "") {</span><span id="cba6" class="lj jo iq nh b gy np nm l nn no">notifier.send(SseEmitter.event().reconnectTime(500).data(myData));</span><span id="bc34" class="lj jo iq nh b gy np nm l nn no">}</span><span id="9e46" class="lj jo iq nh b gy np nm l nn no">} catch (IOException e) {</span><span id="67ba" class="lj jo iq nh b gy np nm l nn no">e.printStackTrace();</span><span id="69dd" class="lj jo iq nh b gy np nm l nn no">}</span><span id="5bea" class="lj jo iq nh b gy np nm l nn no">return notifier;</span><span id="6f38" class="lj jo iq nh b gy np nm l nn no">}</span><span id="21c2" class="lj jo iq nh b gy np nm l nn no">}</span></pre><p id="7421" class="pw-post-body-paragraph kl km iq kn b ko nb kq kr ks nc ku kv kw nd ky kz la ne lc ld le nf lg lh li ij bi translated"><em class="na">组件(角度4) </em></p><p id="872b" class="pw-post-body-paragraph kl km iq kn b ko nb kq kr ks nc ku kv kw nd ky kz la ne lc ld le nf lg lh li ij bi translated">该组件类型脚本类从服务器订阅API，如下所示:</p><pre class="mk ml mm mn gt ng nh ni nj aw nk bi"><span id="73b4" class="lj jo iq nh b gy nl nm l nn no">import { Component, OnInit } from '<a class="ae nq" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import {Observable} from "rxjs";</span><span id="84f0" class="lj jo iq nh b gy np nm l nn no"><a class="ae nq" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a>({<br/>templateUrl: './app/home/home.html'<br/>})</span><span id="8f15" class="lj jo iq nh b gy np nm l nn no">export class HomeListComponent{<br/>  myData: any;<br/>  <br/>    constructor(private airService: AIRadiologyService) {<br/>    this.connect();<br/>  }</span><span id="fdf9" class="lj jo iq nh b gy np nm l nn no">connect(): void {<br/>    let source = new EventSource('<a class="ae nq" href="http://serverip:port/get_mydata'" rel="noopener ugc nofollow" target="_blank">http://serverip:port/get_mydata'</a>);<br/>    source.addEventListener('message', message =&gt; {<br/>        this.myData = JSON.parse(message.data);        <br/>    });<br/> }<br/>}</span></pre><h1 id="97fa" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">结论</h1><p id="cbef" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">事件源非常适合用实时数据更新或刷新浏览器数据。这种协议非常简单，因为它不需要添加任何外部JavaScript库，从而提供了灵活性。JavaScript本身提供了EventSource接口来接收服务器发送的实时数据或消息。</p></div></div>    
</body>
</html>