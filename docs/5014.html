<html>
<head>
<title>Using Terraform to deploy a Docker Swarm stack on OCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform在OCI部署Docker Swarm堆栈</h1>
<blockquote>原文：<a href="https://itnext.io/using-terraform-to-deploy-a-docker-swarm-stack-on-oci-8b7caa6876a1?source=collection_archive---------3-----------------------#2020-11-16">https://itnext.io/using-terraform-to-deploy-a-docker-swarm-stack-on-oci-8b7caa6876a1?source=collection_archive---------3-----------------------#2020-11-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="1af1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Oracle云基础设施(OCI)是一种IaaS，可提供内部部署的高性能计算能力来运行云本地和企业公司的IT工作负载。OCI通过结合Oracle的自主服务、集成安全性和无服务器计算，为企业应用程序提供实时弹性。适用于公共云。</p><p id="3c47" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本文是以下系列相关帖子的延续:</p><ul class=""><li id="5204" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated"><a class="ae ku" rel="noopener ugc nofollow" target="_blank" href="/oracle-always-free-cloud-instances-in-ha-configuration-e1d3dd59d3b1"> Oracle始终释放HA配置中的云实例</a></li><li id="dab8" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated"><a class="ae ku" rel="noopener ugc nofollow" target="_blank" href="/my-own-dev-test-cloud-environment-using-oracle-always-free-instances-598695cc3a10">我自己的开发/测试云环境使用Oracle Always免费实例</a></li><li id="37ca" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated"><a class="ae ku" href="https://marcelo-ochoa.medium.com/my-own-iot-deployment-at-oracle-cloud-free-using-autonomous-db-and-ml-f0632e240a29" rel="noopener">我自己在Oracle Cloud使用自主数据库和ML免费部署物联网</a></li><li id="b933" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated"><a class="ae ku" rel="noopener ugc nofollow" target="_blank" href="/using-lets-encrypt-certs-with-oracle-cloud-load-balancer-including-auto-renew-feature-7ae87e6d207b">使用Oracle云负载平衡器加密证书——包括自动更新功能</a></li><li id="5262" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated"><a class="ae ku" href="https://marcelo-ochoa.medium.com/using-oracle-cloud-object-storage-as-docker-volume-3ec7882f51b7" rel="noopener">使用Oracle云对象存储作为Docker卷</a></li></ul><p id="d87a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，这篇文章不是描述如何按照一步一步的说明进行部署，而是关于使用基础设施作为使用<a class="ae ku" href="https://es.wikipedia.org/wiki/Terraform_(software)" rel="noopener ugc nofollow" target="_blank"> Terraform </a>和<a class="ae ku" href="https://docs.cloud.oracle.com/en-us/iaas/Content/ResourceManager/Concepts/resourcemanager.htm" rel="noopener ugc nofollow" target="_blank"> Oracle Resource Manager </a>的代码，在文章的最后，只需点击几下鼠标，您就会有一个运行在Oracle Always Free实例上的双节点Swarm集群。</p><p id="919f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们首先介绍我们的测试环境，参见部署图:</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi la"><img src="../Images/ee78c66bc7ef779602e097ea96e5dc27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*S-Fm42uD9VON8KST"/></div><figcaption class="li lj gj gh gi lk ll bd b be z dk translated">Docker群堆栈部署图</figcaption></figure><p id="41f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在上面看到了共享存储，这种共享存储是使用VM块存储实现的，并使用GlusterFS进行复制，该存储是为MongoDB或MySQL等块级IO而设计的，我们的Docker容器有一个新的共享存储，它是使用为存储HTML页面、图像、配置文件或Docker注册表blob对象而设计的对象存储实现的。</p><blockquote class="lm ln lo"><p id="75ef" class="jn jo lp jp b jq jr js jt ju jv jw jx lq jz ka kb lr kd ke kf ls kh ki kj kk ij bi translated">注意:通过为Oracle对象存储添加Docker插件，我们也可以从<a class="ae ku" href="https://docs.cloud.oracle.com/en-us/iaas/Content/API/Concepts/devcloudshellgettingstarted.htm" rel="noopener ugc nofollow" target="_blank"> Oracle Cloud Shell </a>以常规文件系统的方式进行访问。</p></blockquote></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="253d" class="ma mb iq bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">部署文件</h1><p id="7add" class="pw-post-body-paragraph jn jo iq jp b jq my js jt ju mz jw jx jy na ka kb kc nb ke kf kg nc ki kj kk ij bi translated">在我的GitHub库<a class="ae ku" href="https://github.com/marcelo-ochoa/oci-swarm-cluster" rel="noopener ugc nofollow" target="_blank"> oci-swarm-cluster </a>中可以找到示例脚本和配置文件，只需克隆并执行:</p><pre class="lb lc ld le gt nd ne nf ng aw nh bi"><span id="cc7d" class="ni mb iq ne b gy nj nk l nl nm">$ git clone <a class="ae ku" href="https://github.com/marcelo-ochoa/oci-swarm-cluster" rel="noopener ugc nofollow" target="_blank">https://github.com/marcelo-ochoa/oci-swarm-cluster</a><br/>$ cd oci-swarm-cluster<br/>$ docker build -t oci-swarm -f Dockerfile .<br/>$ docker run -v $PWD:/transfer --rm --entrypoint cp oci-swarm:latest /package/<strong class="ne ir"><em class="lp">oci-swarm-stack.zip</em></strong> /transfer/<strong class="ne ir"><em class="lp">oci-swarm-stack.zip</em></strong></span></pre><p id="af12" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">仅此而已，<strong class="jp ir"><em class="lp">OCI-swarm-Stack . zip</em></strong>是用来创建Swarm栈的文件。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="853d" class="ma mb iq bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">部署Docker群堆栈</h1><p id="2070" class="pw-post-body-paragraph jn jo iq jp b jq my js jt ju mz jw jx jy na ka kb kc nb ke kf kg nc ki kj kk ij bi translated">按照使用Oracle云控制台的四次点击指南，资源管理器-&gt;堆栈菜单</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi nn"><img src="../Images/7f09eb15239961cd2b94cc59dd5c4f90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zVcRyVlgc6wjHzvV"/></div></div><figcaption class="li lj gj gh gi lk ll bd b be z dk translated">堆栈欢迎页面</figcaption></figure><p id="ed76" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">选择创建堆栈、ZIP文件配置并浏览生成的<strong class="jp ir"><em class="lp">OCI-swarm-Stack . ZIP</em></strong>文件</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi ns"><img src="../Images/fbcfa1f90babec8703c96400c4f05907.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wY406D18m_yiFWHB"/></div></div><figcaption class="li lj gj gh gi lk ll bd b be z dk translated">创建堆栈选项</figcaption></figure><p id="bb2a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">单击下一步，取消选中自动生成的公共SSH密钥，从您的计算机上传一个公共密钥，该公共密钥将允许您访问为群集创建的计算实例。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi nt"><img src="../Images/32dbe67e14d2ac2880a499fee9f6cc13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FhVQLQFnQZoeIw_N"/></div></div><figcaption class="li lj gj gh gi lk ll bd b be z dk translated">创建堆栈选项(选择SSH公钥)</figcaption></figure><p id="5ed9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">单击下一步，查看公钥和堆栈信息</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi nu"><img src="../Images/4fab9a67972bed23d940fe520ee223b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ralCdXXZ51k7J2Nt"/></div></div><figcaption class="li lj gj gh gi lk ll bd b be z dk translated">创建堆栈审核窗格</figcaption></figure><p id="897b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击创建，你的地形堆栈将被创建，从<strong class="jp ir"> <em class="lp">地形动作</em> </strong>菜单选择<strong class="jp ir"> <em class="lp">应用</em> </strong></p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi nn"><img src="../Images/ae678b150044f3832de1ddb82949973c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*q2SU2cCOcARCjYn0"/></div></div><figcaption class="li lj gj gh gi lk ll bd b be z dk translated">堆栈已创建</figcaption></figure><p id="f001" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">显示应用确认操作，点击应用按钮。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/34816dd4780ed99ef56cde3093a3903f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/0*Sk0vhbvy_ByGlMS4"/></div><figcaption class="li lj gj gh gi lk ll bd b be z dk translated">应用确认操作</figcaption></figure><p id="d3c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您的堆栈正在部署中…</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi nw"><img src="../Images/2057bfa19070b1cb7dded52319d6f7d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XtxOtD2r8ly2_QlQ"/></div></div><figcaption class="li lj gj gh gi lk ll bd b be z dk translated">堆叠日志</figcaption></figure><p id="eef5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在日志的末尾，您会看到类似这样的内容:</p><pre class="lb lc ld le gt nd ne nf ng aw nh bi"><span id="9710" class="ni mb iq ne b gy nj nk l nl nm">Outputs:</span><span id="a5fc" class="ni mb iq ne b gy nx nk l nl nm">autonomous_database_password = random_generated_atp_pwd</span><span id="fc4e" class="ni mb iq ne b gy nx nk l nl nm">comments = The application URL will be unavailable for a few minutes after provisioning, while the application is configured</span><span id="26e1" class="ni mb iq ne b gy nx nk l nl nm">deploy_id = MQut</span><span id="7242" class="ni mb iq ne b gy nx nk l nl nm">deployed_to_region = us-ashburn-1</span><span id="a9c3" class="ni mb iq ne b gy nx nk l nl nm">dev = Made with ❤ by Marcelo Ochoa</span><span id="7452" class="ni mb iq ne b gy nx nk l nl nm">generated_private_key_pem = No Keys Auto Generated</span><span id="967b" class="ni mb iq ne b gy nx nk l nl nm">lb_public_url = <a class="ae ku" href="http://nn.nn.nn.nn" rel="noopener ugc nofollow" target="_blank">http://nn.nn.nn.nn</a></span><span id="6e1e" class="ni mb iq ne b gy nx nk l nl nm">oci_swarm_basic_source_code = <a class="ae ku" href="https://github.com/marcelo-ochoa/oci-swarm-cluster" rel="noopener ugc nofollow" target="_blank">https://github.com/marcelo-ochoa/oci-swarm-cluster</a></span></pre></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="87ce" class="ma mb iq bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">一些调整</h1><p id="57cd" class="pw-post-body-paragraph jn jo iq jp b jq my js jt ju mz jw jx jy na ka kb kc nb ke kf kg nc ki kj kk ij bi translated">这个项目就像是一个部署更复杂的堆栈的模板，例如Oracle开发的MuShop应用程序的修改版本:<a class="ae ku" href="https://github.com/marcelo-ochoa/oci-cloudnative" rel="noopener ugc nofollow" target="_blank">https://github.com/marcelo-ochoa/oci-cloudnative</a></p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi ny"><img src="../Images/0b235326bc5de013140449612159f479.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rHfp0N0KHf8FVWEX.png"/></div></div><figcaption class="li lj gj gh gi lk ll bd b be z dk translated">MuShop演示应用程序</figcaption></figure><p id="581c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要部署这个示例堆栈，只需执行与上面相同的操作:</p><pre class="lb lc ld le gt nd ne nf ng aw nh bi"><span id="dcef" class="ni mb iq ne b gy nj nk l nl nm">$ git clone <a class="ae ku" href="https://github.com/marcelo-ochoa/oci-cloudnative" rel="noopener ugc nofollow" target="_blank">https://github.com/marcelo-ochoa/oci-cloudnative</a><br/>$ cd oci-cloudnative<br/>$ docker build -t mushop-basic -f deploy/basic/Dockerfile .<br/>$ docker run -v $PWD:/transfer --rm --entrypoint cp mushop-basic:latest /package/mushop-basic-stack.zip /transfer/mushop-basic-stack.zip</span></pre><p id="88bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">并使用Oracle云资源管理器部署<strong class="jp ir"><em class="lp">mushop-basic-stack . zip</em></strong>。</p><p id="e03f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一个简单的测试调整是用<a class="ae ku" href="https://www.portainer.io/" rel="noopener ugc nofollow" target="_blank"> PortainerIO </a>应用程序添加服务，用以下代码编辑您的<a class="ae ku" href="https://github.com/marcelo-ochoa/oci-swarm-cluster/blob/main/terraform/scripts/docker-compose.yml" rel="noopener ugc nofollow" target="_blank">terraform/scripts/docker-compose . yml</a>文件:</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="0c62" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦你的栈部署完毕，你就可以访问Portainer控制台并开始图形化管理你的Docker Swarm栈，如下图所示</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi nn"><img src="../Images/844573b79ded5a677b869c480f36955f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rOqhcfHapZ9fZyll"/></div></div><figcaption class="li lj gj gh gi lk ll bd b be z dk translated">PortainerIO控制台</figcaption></figure><p id="e095" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与OCI的Docker Swarm玩得开心，下一篇文章可能是一个具有更多节点的大型集群的Terraform部署，但它需要一个云付费帐户才能工作。</p></div></div>    
</body>
</html>