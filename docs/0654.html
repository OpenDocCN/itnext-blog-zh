<html>
<head>
<title>Hosting multiple apps on the same server — Implement a reverse proxy with Node</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在同一服务器上托管多个应用程序—使用节点实施反向代理</h1>
<blockquote>原文：<a href="https://itnext.io/hosting-multiple-apps-on-the-same-server-implement-a-reverse-proxy-with-node-a4e213497345?source=collection_archive---------0-----------------------#2018-05-01">https://itnext.io/hosting-multiple-apps-on-the-same-server-implement-a-reverse-proxy-with-node-a4e213497345?source=collection_archive---------0-----------------------#2018-05-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/e4b56c41c14458b10f185d766d629732.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*08QYO7vZDl9c6Lml."/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated"><a class="ae jd" href="https://unsplash.com/@marion_michele?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">马里恩·米歇尔</a>在<a class="ae jd" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的《威尼斯海滩彩色墙前拿着塑料咖啡杯的人》</figcaption></figure><div class=""/><p id="ba24" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">每当我选择一个新的云托管计划，以便为我的开发提供一个远程服务器时，我经常会在上面运行多个应用程序。</p><p id="3c89" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这有许多原因，例如:</p><ul class=""><li id="ffd9" class="lb lc jg kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">它允许我保持我的电脑干净，远离下载和安装大量ide、库、包等带来的垃圾。</li><li id="4b74" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">它允许我拥有一台24/7运行的服务器，这样我的客户就可以随时关注我的进展。</li><li id="635a" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">它消除了配置我的盒子以允许公众访问我的项目的麻烦。</li><li id="8630" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><strong class="kf jh">基本上，物理服务器就是一台计算机，就像其他任何计算机一样，那么为什么我每台服务器只托管一个应用程序呢？</strong></li></ul><p id="2c12" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在到了实现部分，如果您尝试过这个练习，您会知道它通常是这样结束的:</p><figure class="lq lr ls lt gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi lp"><img src="../Images/96748f5b035965384e6e42d43a4d3acd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Du7e-TxPfJJC5GvuFpbbQ.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">多个项目，每个项目都在特定的端口上运行</figcaption></figure><p id="8884" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里需要注意的是，一旦你在运行一个项目，它会监听一个特定的端口，如果你不想遇到致命的错误，你必须保留一个使用端口的列表:</p><blockquote class="lu"><p id="c386" class="lv lw jg bd lx ly lz ma mb mc md la dk translated">EADDRINUSE:这个端口已经被使用了</p></blockquote><p id="acbb" class="pw-post-body-paragraph kd ke jg kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ij bi translated">另一个棘手的问题是，当您与您的程序交互时，您的请求看起来会像这样:</p><p id="55bf" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mj mk ml mm b">http(s)://domain.ext:port/route</code></p><p id="e325" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">其中<code class="fe mj mk ml mm b">port</code>是您的项目监听的端口。</p></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><p id="85bd" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh">这篇文章的目标是教你如何创建一个反向代理，以便最终你能够为你的项目使用有意义的URL。</strong></p><p id="20db" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就这样:</p><p id="c860" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mj mk ml mm b">http(s)://domain.ext/nameOfYourProject/route</code></p><p id="3785" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">而不是必须记住你的应用在监听哪个端口。</p></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><h1 id="7a2d" class="mu mv jg bd mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr bi translated">首先，什么是反向代理？</h1><p id="085a" class="pw-post-body-paragraph kd ke jg kf b kg ns ki kj kk nt km kn ko nu kq kr ks nv ku kv kw nw ky kz la ij bi translated">一幅画胜过千言万语。</p><figure class="lq lr ls lt gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nx"><img src="../Images/3b462796d8bb256014ebccee1baccc26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N5pHiViIFLg5JI1zPj-DMg.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">归功于我自己😆</figcaption></figure><p id="9cc6" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">简而言之，反向代理将传入的请求与其组件相匹配。</p><p id="9c2b" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它只是一个请求组织者。它的作用是根据标准(URL部分、请求体，基本上任何东西都可以作为标准)重定向请求，并从请求被重定向到的组件返回响应。</p><p id="d21f" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这个例子中，在端口443上运行的反向代理将把REST请求代理给在端口5000上监听的Python REST API，并且它将把网站请求代理给在端口80上监听的Apache服务器。</p><p id="05c1" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于这种特殊情况(我处理的一个真实用例)，标准是域名后面的URL部分，如下所示:</p><p id="e6b0" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mj mk ml mm b">https://website.com/rest</code> - &gt; Python REST API</p><p id="52a0" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mj mk ml mm b">https://website.com/web</code> - &gt;阿帕奇网络服务器</p></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><h1 id="9f6e" class="mu mv jg bd mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr bi translated"><strong class="ak">如何实现一个？</strong></h1><p id="d7d9" class="pw-post-body-paragraph kd ke jg kf b kg ns ki kj kk nt km kn ko nu kq kr ks nv ku kv kw nw ky kz la ij bi translated">开始之前，请确保您具备以下条件:</p><ul class=""><li id="5ffd" class="lb lc jg kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated"><strong class="kf jh">节点:</strong>T29】https://nodejs.org/en/</li><li id="6168" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><strong class="kf jh">快递:</strong> <code class="fe mj mk ml mm b">npm install express</code></li><li id="f623" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><strong class="kf jh"> HTTP代理中间件:</strong>T3】</li></ul><p id="89ff" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Express将允许您运行服务器，HTTP代理中间件将把请求代理到您配置的端点。</p><p id="f81a" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，我们将使用一个JSON配置文件，该文件将包含如下映射:</p><figure class="lq lr ls lt gt is"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="d9c1" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这意味着一旦<code class="fe mj mk ml mm b">/project1</code>被请求，该请求就被代理到<code class="fe mj mk ml mm b">http://localhost:1001</code>。</p><p id="0b6f" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">假设您创建了一个JSON文件和一个JS文件来运行服务器，那么您应该以下面的内容结束:</p><p id="9c45" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mj mk ml mm b">/project<br/> app.js<br/> config.json</code></p><p id="91ca" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是你必须插入到<code class="fe mj mk ml mm b">app.js</code>中的代码:</p><figure class="lq lr ls lt gt is"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="8dc3" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对此的解释是:</p><ul class=""><li id="67bc" class="lb lc jg kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated"><code class="fe mj mk ml mm b">Line 6</code>:通过<code class="fe mj mk ml mm b">require</code>将JSON文件转化为JS对象</li><li id="5acc" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><code class="fe mj mk ml mm b">Line 10</code>:逐一迭代所有路线</li><li id="ed4f" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><code class="fe mj mk ml mm b">Line 11</code>:使用<code class="fe mj mk ml mm b">app.use(route,handler)</code>意味着无论请求中使用什么HTTP方法，当<code class="fe mj mk ml mm b">route</code>被请求时，服务器都会使用<code class="fe mj mk ml mm b">handler</code>。</li><li id="3eab" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><code class="fe mj mk ml mm b">Line 12</code>:创建一个匿名处理程序来代理请求(<a class="ae jd" href="https://github.com/chimurai/http-proxy-middleware" rel="noopener ugc nofollow" target="_blank">文档在这里</a>)</li><li id="271c" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><code class="fe mj mk ml mm b">Line 13</code>:目标是请求将被发送到的地方</li><li id="6c70" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><code class="fe mj mk ml mm b">Line 14</code> : <code class="fe mj mk ml mm b">pathRewrite</code>可以是函数。我们定义了我们的，所以它去掉了糖的部分。让我解释一下。</li></ul></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><p id="cd67" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要访问<code class="fe mj mk ml mm b">project1</code>，您将打开浏览器并键入:<code class="fe mj mk ml mm b"><a class="ae jd" href="http://domain.ext/project1/route/parameters/blabla" rel="noopener ugc nofollow" target="_blank">http://domain.ext/project1/route/parameters/blabla</a></code></p><p id="9f15" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当被调用时，<code class="fe mj mk ml mm b">pathRewrite</code>将用域部分后面的内容填充<code class="fe mj mk ml mm b">path</code>参数。</p><p id="d1bf" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们的例子中，<code class="fe mj mk ml mm b">path</code>将等于:<code class="fe mj mk ml mm b">/project1/route/parameters/blabla</code></p><p id="e6bd" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但实际上你的app只需要<code class="fe mj mk ml mm b">/project1</code>之后的东西。</p><p id="9b80" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这就是你如何摆脱它:</p><ul class=""><li id="dbfb" class="lb lc jg kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated"><code class="fe mj mk ml mm b">path.split('/')</code> = <code class="fe mj mk ml mm b">['','project1','route','parameters','blabla']</code></li><li id="6896" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><code class="fe mj mk ml mm b">.slice(2)</code> = <code class="fe mj mk ml mm b">['route','parameters','blabla']</code></li><li id="d87c" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><code class="fe mj mk ml mm b">.join('/')</code> = <code class="fe mj mk ml mm b">route/parameters/blabla</code>(不需要<code class="fe mj mk ml mm b">route </code>前的<code class="fe mj mk ml mm b">/</code>)</li></ul></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><ul class=""><li id="1664" class="lb lc jg kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">运行服务器，你就可以开始了😃</li></ul><p id="d5dc" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh">我建议使用类似</strong> <code class="fe mj mk ml mm b">pm2</code> <strong class="kf jh">或任何其他实用程序的防崩溃启动程序来运行您的反向代理，这样，如果它崩溃了，它会自动重启，而不会影响它重定向到的项目。</strong></p><p id="3551" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如:</p><p id="2cad" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mj mk ml mm b">pm2 start app.js</code></p></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><p id="ef6d" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh">您现在应该能够使用有意义的URL来访问同一服务器上的不同项目，而不必为每个请求手动指定端口。</strong></p><p id="6c2c" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意，这个反向代理也可以使用<code class="fe mj mk ml mm b">https</code>(这是我个人的想法)。</p></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><h1 id="1368" class="mu mv jg bd mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr bi translated">作者说明</h1><p id="af86" class="pw-post-body-paragraph kd ke jg kf b kg ns ki kj kk nt km kn ko nu kq kr ks nv ku kv kw nw ky kz la ij bi translated">这篇文章带来了一个我在日常开发生活中经常用到的有用技巧。</p><p id="e453" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可能会想“嗯，我不必再键入端口，但我仍然必须键入关键字”。<strong class="kf jh">哪个对你更有意义？</strong></p><p id="95cc" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像往常一样，你可以自由选择。</p></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><h1 id="738c" class="mu mv jg bd mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr bi translated">感谢阅读</h1><p id="52ad" class="pw-post-body-paragraph kd ke jg kf b kg ns ki kj kk nt km kn ko nu kq kr ks nv ku kv kw nw ky kz la ij bi translated">我的上一篇文章可以在这里找到:<a class="ae jd" rel="noopener ugc nofollow" target="_blank" href="/node-express-letsencrypt-generate-a-free-ssl-certificate-and-run-an-https-server-in-5-minutes-a730fbe528ca"> Node + Express + LetsEncrypt:生成一个免费的SSL证书并在5分钟或更短时间内运行一个HTTPS服务器</a></p><p id="8277" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我欣赏评论、建议和辩论。</p><p id="e28f" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请随时联系<strong class="kf jh"> david.mellul@outlook.fr😃☕️ </strong></p><figure class="lq lr ls lt gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oa"><img src="../Images/5d7b5509e9038dbfc50e07d28db85d07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*X70npWMl_-2y4CEz."/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated"><a class="ae jd" href="https://unsplash.com/@takeshi2?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">吴仪</a>在<a class="ae jd" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的《白色马克杯里的卡布奇诺，白色泡沫艺术在木桌上》</figcaption></figure></div></div>    
</body>
</html>