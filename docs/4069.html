<html>
<head>
<title>AWS Elastic Kubernetes Service: running ALB Ingress controller</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS弹性Kubernetes服务:运行ALB入口控制器</h1>
<blockquote>原文：<a href="https://itnext.io/aws-elastic-kubernetes-service-running-alb-ingress-controller-8d0d457615fa?source=collection_archive---------1-----------------------#2020-04-21">https://itnext.io/aws-elastic-kubernetes-service-running-alb-ingress-controller-8d0d457615fa?source=collection_archive---------1-----------------------#2020-04-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/cd8105bdaa693a302aa3daf458908369.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8YLNJ_ePNZYgymfBEePLUQ.png"/></div></div></figure><p id="4496" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://github.com/kubernetes-sigs/aws-alb-ingress-controller" rel="noopener ugc nofollow" target="_blank">用于Kubernetes </a>的AWS ALB入口控制器——是一个Kubernetes控制器，当在Kubernetes集群中创建带有<code class="fe kx ky kz la b">kubernetes.io/ingress.class: alb</code>注释的<code class="fe kx ky kz la b">Ingress</code>资源时，它实际控制AWS帐户中的AWS应用程序负载平衡器(ALB)。</p><p id="b28e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个<code class="fe kx ky kz la b">Ingress</code>资源反过来描述了一个ALB监听器配置，带有SSL终端或者到集群工作节点的流量路由。</p><p id="99cf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更多信息，请点击此处:</p><ul class=""><li id="5119" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv lg lh li lj bi translated"><a class="ae kw" href="https://kubernetes.io/docs/concepts/services-networking/ingress/" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/docs/concepts/services-networking/ingress/</a></li><li id="6ab7" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated"><a class="ae kw" href="https://github.com/kubernetes-sigs/aws-alb-ingress-controller" rel="noopener ugc nofollow" target="_blank">https://github . com/kubernetes-sigs/AWS-ALB-ingress-controller</a></li><li id="ea4a" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated"><a class="ae kw" href="https://aws.amazon.com/ru/blogs/opensource/kubernetes-ingress-aws-alb-ingress-controller/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/ru/blogs/open source/kubernetes-ingress-AWS-ALB-ingress-controller/</a></li></ul><h2 id="11a8" class="lp lq iq bd lr ls lt dn lu lv lw dp lx kj ly lz ma kn mb mc md kr me mf mg mh bi translated">入口控制器类型</h2><p id="ac55" class="pw-post-body-paragraph jy jz iq ka b kb mi kd ke kf mj kh ki kj mk kl km kn ml kp kq kr mm kt ku kv ij bi translated">AWS ALB入口控制器支持两种流量路由策略类型，即<strong class="ka ir">实例模式</strong>和<strong class="ka ir"> ip模式</strong>:</p><ul class=""><li id="7384" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv lg lh li lj bi translated"><strong class="ka ir">实例模式</strong>:流量将在ALB上被接受，然后被路由到节点端口服务，然后被路由到集群内部的pod</li><li id="33f4" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated"><strong class="ka ir"> ip模式</strong>:流量将首先到达ALB，然后直接路由到集群中的pod。文档表明为Kubernetes 安装<a class="ae kw" href="https://github.com/aws/amazon-vpc-cni-k8s" rel="noopener ugc nofollow" target="_blank"> AWS CNI插件是必要的，但是在AWS EKS它开箱即用</a></li></ul><p id="30eb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更多文档见<a class="ae kw" href="https://github.com/kubernetes-sigs/aws-alb-ingress-controller/blob/master/docs/guide/ingress/annotation.md" rel="noopener ugc nofollow" target="_blank">此处&gt; &gt; &gt; </a>。</p><h2 id="0cb0" class="lp lq iq bd lr ls lt dn lu lv lw dp lx kj ly lz ma kn mb mc md kr me mf mg mh bi translated"><code class="fe kx ky kz la b">eksctl</code> -创建一个集群</h2><p id="6e56" class="pw-post-body-paragraph jy jz iq ka b kb mi kd ke kf mj kh ki kj mk kl km kn ml kp kq kr mm kt ku kv ij bi translated">首先，让我们创建一个测试集群:</p><pre class="mn mo mp mq gt mr la ms mt aw mu bi"><span id="d0ad" class="lp lq iq la b gy mv mw l mx my">$ eksctl create cluster — profile arseniy — region eu-north-1 — name eks-alb-testing<br/>[ℹ] eksctl version 0.15.0<br/>[ℹ] using region eu-north-1<br/>[ℹ] setting availability zones to [eu-north-1b eu-north-1c eu-north-1a]<br/>[ℹ] subnets for eu-north-1b — public:192.168.0.0/19 private:192.168.96.0/19<br/>[ℹ] subnets for eu-north-1c — public:192.168.32.0/19 private:192.168.128.0/19<br/>[ℹ] subnets for eu-north-1a — public:192.168.64.0/19 private:192.168.160.0/19<br/>[ℹ] nodegroup “ng-c408bab3” will use “ami-0d40170cbe0b51e62” [AmazonLinux2/1.14]<br/>[ℹ] using Kubernetes version 1.14<br/>[ℹ] creating EKS cluster “eks-alb-testing” in “eu-north-1” region with un-managed nodes<br/>…<br/>[ℹ] node “ip-192–168–11–166.eu-north-1.compute.internal” is ready<br/>[ℹ] node “ip-192–168–35–128.eu-north-1.compute.internal” is ready<br/>[ℹ] kubectl command should work with “/home/setevoy/.kube/config”, try ‘kubectl get nodes’<br/>[✔] EKS cluster “eks-alb-testing” in “eu-north-1” region is ready</span></pre><h2 id="0f3c" class="lp lq iq bd lr ls lt dn lu lv lw dp lx kj ly lz ma kn mb mc md kr me mf mg mh bi translated">IAM OIDC提供商</h2><p id="4835" class="pw-post-body-paragraph jy jz iq ka b kb mi kd ke kf mj kh ki kj mk kl km kn ml kp kq kr mm kt ku kv ij bi translated">文档—<a class="ae kw" href="https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/eks/latest/user guide/enable-iam-roles-for-service-accounts . html</a>。</p><p id="357d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">控制器所用的服务账户需要OIDC集成，详见<a class="ae kw" href="https://eksctl.io/usage/iamserviceaccounts" rel="noopener ugc nofollow" target="_blank">https://eksctl.io/usage/iamserviceaccounts</a>。</p><p id="1ad8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建它:</p><pre class="mn mo mp mq gt mr la ms mt aw mu bi"><span id="b6fa" class="lp lq iq la b gy mv mw l mx my">$ eksctl — profile arseniy — region=eu-north-1 utils associate-iam-oidc-provider — cluster eks-alb-testing — approve<br/>[ℹ] eksctl version 0.15.0<br/>[ℹ] using region eu-north-1<br/>[ℹ] will create IAM Open ID Connect provider for cluster “eks-alb-testing” in “eu-north-1”<br/>[✔] created IAM Open ID Connect provider for cluster “eks-alb-testing” in “eu-north-1”</span></pre><p id="88cf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查:</p><pre class="mn mo mp mq gt mr la ms mt aw mu bi"><span id="7d73" class="lp lq iq la b gy mv mw l mx my">$ aws — profile arseniy. — region=eu-north-1 eks describe-cluster — name eks-alb-testing — query “cluster.identity.oidc.issuer” — output text<br/><a class="ae kw" href="https://oidc.eks.eu-north-1.amazonaws.com/id/B59F43D7826EB61861FC73EE13216CD8" rel="noopener ugc nofollow" target="_blank">https://oidc.eks.eu-north-1.amazonaws.com/id/B59F43D7826EB61861FC73EE13216CD8</a></span></pre><p id="5a61" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者通过<a class="ae kw" href="https://console.aws.amazon.com/iam/home?region=eu-west-3#/providers" rel="noopener ugc nofollow" target="_blank"> AWS UI </a> &gt; <em class="mz">身份提供者</em>:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/85cc8e1988ebb37a6b55e233c3949b82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uKXkksycnkIK5v9G.png"/></div></div></figure><h2 id="98e8" class="lp lq iq bd lr ls lt dn lu lv lw dp lx kj ly lz ma kn mb mc md kr me mf mg mh bi translated">ALB IAM策略</h2><p id="0189" class="pw-post-body-paragraph jy jz iq ka b kb mi kd ke kf mj kh ki kj mk kl km kn ml kp kq kr mm kt ku kv ij bi translated">下一步是添加一个IAM策略，该策略将为AWS帐户中带有ALB入口控制器的pod提供访问权限，以便对AWS核心进行API调用，从而创建和配置应用程序负载平衡器。</p><p id="e19c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">可以使用AWS CLI通过以下命令创建它:</p><pre class="mn mo mp mq gt mr la ms mt aw mu bi"><span id="e0bb" class="lp lq iq la b gy mv mw l mx my">$ aws — profile arseniy — region=eu-north-1 iam create-policy — policy-name ALBIngressControllerIAMPolicy — policy-document <a class="ae kw" href="https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/iam-policy.json" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/iam-policy.json</a></span></pre><p id="cfc1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者可以使用<code class="fe kx ky kz la b"><a class="ae kw" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-iam-role.html" rel="noopener ugc nofollow" target="_blank">AWS::IAM::Role</a></code>资源添加到CloudFormation模板中。</p><p id="a89b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在命令的输出中，您将有一个ARN—<em class="mz">" Arn ":" Arn:AWS:iam::534 * * * 385:policy/ALBIngressControllerIAMPolicy "</em>—保留它，我们将在下面的步骤中使用它。</p><h2 id="e585" class="lp lq iq bd lr ls lt dn lu lv lw dp lx kj ly lz ma kn mb mc md kr me mf mg mh bi translated">ALB入口IAM角色</h2><p id="f8b1" class="pw-post-body-paragraph jy jz iq ka b kb mi kd ke kf mj kh ki kj mk kl km kn ml kp kq kr mm kt ku kv ij bi translated">参见<a class="ae kw" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/docs/tasks/configure-pod-container/configure-service-account/</a></p><blockquote class="nb nc nd"><p id="323d" class="jy jz mz ka b kb kc kd ke kf kg kh ki ne kk kl km nf ko kp kq ng ks kt ku kv ij bi translated">1 iamserviceaccount(kube-系统/ALB-入口-控制器)除外</p></blockquote><p id="a67f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<a class="ae kw" href="https://docs.aws.amazon.com/eks/latest/userguide/alb-ingress.html" rel="noopener ugc nofollow" target="_blank">官方文档</a>中，顺序有点不同:首先，它建议创建一个RBAC-角色和角色绑定，然后是iamserviceaccount。</p><p id="b275" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我的例子中，这导致了在创建新的service account "<em class="mz">kube-system/ALB-ingress-controller</em>"—<code class="fe kx ky kz la b">eksctl</code>被告知它已经存在并跳过它，尽管有<code class="fe kx ky kz la b">--override-existing-serviceaccounts</code>选项:</p><pre class="mn mo mp mq gt mr la ms mt aw mu bi"><span id="888d" class="lp lq iq la b gy mv mw l mx my">[ℹ] eksctl version 0.15.0<br/>[ℹ] using region eu-north-1<br/>[ℹ] 1 iamserviceaccount(s) that already exist (kube-system/alb-ingress-controller) will be excluded<br/>[ℹ] combined exclude rules: kube-system/alb-ingress-controller<br/>[ℹ] 1 iamserviceaccount (kube-system/alb-ingress-controller) was excluded (based on the include/exclude rules)<br/>[!] serviceaccounts that exists in Kubernetes will be excluded, use — override-existing-serviceaccounts to override<br/>[ℹ] no tasks</span></pre><p id="f5fa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在包含AWS支持之后(我喜欢这些家伙——在我看来是所有云提供商中最好的支持者)，我们改变了顺序:首先，创建IAM角色，然后是RBAC角色和绑定。</p><p id="3c7a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是——我们继续吧。</p><p id="bf26" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查当前配置的群集—以防万一:</p><pre class="mn mo mp mq gt mr la ms mt aw mu bi"><span id="bf9f" class="lp lq iq la b gy mv mw l mx my">$ kubectl config current-context<br/>arseniy@eks-alb-testing.eu-north-1.eksctl.io</span></pre><p id="2399" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好吧。</p><p id="9ddc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在使用<code class="fe kx ky kz la b">eksctl</code>创建IAM角色，并使用上面创建的策略的ARN——将其附加到该角色(将创建一个额外的CloudFormation堆栈):</p><pre class="mn mo mp mq gt mr la ms mt aw mu bi"><span id="2645" class="lp lq iq la b gy mv mw l mx my">$ eksctl — profile arseniy — region=eu-north-1 create iamserviceaccount — name alb-ingress-controller — namespace kube-system — override-existing-serviceaccounts — approve — cluster eks-alb-testing — attach-policy-arn arn:aws:iam::534***385:policy/ALBIngressControllerIAMPolicy<br/>[ℹ] eksctl version 0.15.0<br/>[ℹ] using region eu-north-1<br/>[ℹ] 1 task: { 2 sequential sub-tasks: { create IAM role for serviceaccount “kube-system/alb-ingress-controller”, create serviceaccount “kube-system/alb-ingress-controller” } }<br/>[ℹ] building iamserviceaccount stack “eksctl-eks-alb-testing-addon-iamserviceaccount-kube-system-alb-ingress-controller”<br/>[ℹ] deploying stack “eksctl-eks-alb-testing-addon-iamserviceaccount-kube-system-alb-ingress-controller”<br/>[ℹ] created serviceaccount “kube-system/alb-ingress-controller”</span></pre><p id="82cb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">等待它的规定:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/1c2842906ac0b2e7b25654db7149a2ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XxVtgkzhuVfpOOK3.png"/></div></div></figure><h2 id="913a" class="lp lq iq bd lr ls lt dn lu lv lw dp lx kj ly lz ma kn mb mc md kr me mf mg mh bi translated">ALB入口服务帐户</h2><p id="54fe" class="pw-post-body-paragraph jy jz iq ka b kb mi kd ke kf mj kh ki kj mk kl km kn ml kp kq kr mm kt ku kv ij bi translated">在<em class="mz"> kube-system </em>名称空间中创建一个名为<em class="mz"> alb-ingress-controller </em>的ServiceAccount，添加名为<em class="mz"> alb-ingress-controller </em>的<code class="fe kx ky kz la b">ClusterRoleBinding</code>和<code class="fe kx ky kz la b">ClusterRole</code>，添加访问规则:</p><pre class="mn mo mp mq gt mr la ms mt aw mu bi"><span id="f3dd" class="lp lq iq la b gy mv mw l mx my">$ kubectl apply -f <a class="ae kw" href="https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/rbac-role.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/rbac-role.yaml</a><br/>clusterrole.rbac.authorization.k8s.io/alb-ingress-controller created<br/>clusterrolebinding.rbac.authorization.k8s.io/alb-ingress-controller created<br/>serviceaccount/alb-ingress-controller created</span></pre><p id="e77a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查:</p><pre class="mn mo mp mq gt mr la ms mt aw mu bi"><span id="4118" class="lp lq iq la b gy mv mw l mx my">$ kubectl -n kube-system get serviceaccounts | grep alb<br/>alb-ingress-controller 1 32s</span></pre><h2 id="151d" class="lp lq iq bd lr ls lt dn lu lv lw dp lx kj ly lz ma kn mb mc md kr me mf mg mh bi translated">启动ALB入口控制器</h2><p id="f455" class="pw-post-body-paragraph jy jz iq ka b kb mi kd ke kf mj kh ki kj mk kl km kn ml kp kq kr mm kt ku kv ij bi translated">我们可以从这里使用部署文件启动它—<a class="ae kw" href="https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/alb-ingress-controller.yaml" rel="noopener ugc nofollow" target="_blank">https://raw . githubusercontent . com/kubernetes-sigs/AWS-ALB-ingress-controller/v 1 . 1 . 4/docs/examples/ALB-ingress-controller . YAML</a>，它将使用<em class="mz">docker.io/amazon/aws-alb-ingress-controller</em>Docker映像启动一个pod。</p><p id="bc58" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将其克隆到您的工作站:</p><pre class="mn mo mp mq gt mr la ms mt aw mu bi"><span id="e391" class="lp lq iq la b gy mv mw l mx my">$ wget <a class="ae kw" href="https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/alb-ingress-controller.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/alb-ingress-controller.yaml</a></span></pre><p id="0165" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在块中打开以供编辑:</p><pre class="mn mo mp mq gt mr la ms mt aw mu bi"><span id="7040" class="lp lq iq la b gy mv mw l mx my">...<br/>    spec:<br/>      containers:<br/>        - name: alb-ingress-controller<br/>          args:<br/>...</span></pre><p id="91a0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加以下参数:</p><ul class=""><li id="58f5" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv lg lh li lj bi translated"><code class="fe kx ky kz la b">--cluster-name=eks-alb-testing</code></li><li id="6809" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated"><code class="fe kx ky kz la b">--aws-vpc-id=vpc-06a182dd0e5ef1b70</code></li><li id="fb72" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated"><code class="fe kx ky kz la b">--aws-region=eu-north-1</code></li></ul><p id="a6dc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">VPC ID可以在根堆栈的<em class="mz">输出</em>中找到—<em class="mz">eks CTL-eks-ALB-testing-cluster</em>(查看<a class="ae kw" href="https://rtfm.co.ua/en/aws-cloudformation-nested-stacks-and-stacks-parameters-import-export/" rel="noopener ugc nofollow" target="_blank"> AWS: CloudFormation —嵌套堆栈和堆栈参数导入/导出</a>帖子，了解这些堆栈是如何创建的):</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/7eaed15ee9c013b3d63c8700751683b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*L91k94NkVHb3fGzy.png"/></div></div></figure><p id="946f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，该文件必须如下所示:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/5b2bf4a709f02567ec97bcdfbd4eab8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/0*-_N-03bH5xJbLF8X.png"/></div></figure><p id="4dd2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">应用它运行ALB入口控制器:</p><pre class="mn mo mp mq gt mr la ms mt aw mu bi"><span id="08ba" class="lp lq iq la b gy mv mw l mx my">$ kubectl apply -f alb-ingress-controller.yaml<br/>deployment.apps/alb-ingress-controller created</span></pre><p id="827c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查它的吊舱:</p><pre class="mn mo mp mq gt mr la ms mt aw mu bi"><span id="2d98" class="lp lq iq la b gy mv mw l mx my">$ kubectl -n kube-system get pod<br/>NAME READY STATUS RESTARTS AGE<br/>alb-ingress-controller-c47448d84–49tsc 1/1 Running 0 36s</span></pre><p id="79e3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以及控制器的日志:</p><pre class="mn mo mp mq gt mr la ms mt aw mu bi"><span id="83ba" class="lp lq iq la b gy mv mw l mx my">$ kubectl logs -n kube-system deployment.apps/alb-ingress-controller -f<br/> — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — -<br/>AWS ALB Ingress controller<br/>Release: v1.1.4<br/>…<br/>I0325 14:18:03.203499 1 leaderelection.go:205] attempting to acquire leader lease kube-system/ingress-controller-leader-alb…<br/>I0325 14:18:03.211928 1 leaderelection.go:214] successfully acquired lease kube-system/ingress-controller-leader-alb<br/>I0325 14:18:03.312309 1 controller.go:134] kubebuilder/controller “level”=0 “msg”=”Starting Controller” “controller”=”alb-ingress-controller”<br/>I0325 14:18:03.412486 1 controller.go:154] kubebuilder/controller “level”=0 “msg”=”Starting workers” “controller”=”alb-ingress-controller” “worker count”=1</span></pre><p id="7f75" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">嗯——已经开始了，看起来甚至可以用了——太好了！</p><p id="09f3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是真的有效吗？我们来测试一下。</p><h2 id="4810" class="lp lq iq bd lr ls lt dn lu lv lw dp lx kj ly lz ma kn mb mc md kr me mf mg mh bi translated">ALB入口控制器测试</h2><p id="9f05" class="pw-post-body-paragraph jy jz iq ka b kb mi kd ke kf mj kh ki kj mk kl km kn ml kp kq kr mm kt ku kv ij bi translated">对于测试——让我们启动一个额外的部署，它将运行一个包含NGINX和Kubernetes入口服务的pod。</p><p id="2099" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以，需要创造:</p><ol class=""><li id="1264" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv nk lh li lj bi translated">Kubernetes为吊舱部署</li><li id="f943" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv nk lh li lj bi translated">一项<code class="fe kx ky kz la b">NodePort</code>服务，用于将流量路由到pod</li><li id="0a56" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv nk lh li lj bi translated">和带有<em class="mz">面向互联网的ALB </em>注释的<code class="fe kx ky kz la b">Ingress</code>对象——这必须触发我们的ALB控制器来创建一个AWS应用程序负载平衡器</li></ol><p id="208c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">应用:</p><pre class="mn mo mp mq gt mr la ms mt aw mu bi"><span id="fdc2" class="lp lq iq la b gy mv mw l mx my">$ kubectl apply -f nginx-testing-app.yml<br/>deployment.apps/eks-alb-testing-deployment created<br/>service/eks-alb-testing-web-service created<br/>ingress.extensions/eks-alb-testing-web-ingress created</span></pre><p id="68b6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查控制器日志:</p><pre class="mn mo mp mq gt mr la ms mt aw mu bi"><span id="4c2d" class="lp lq iq la b gy mv mw l mx my">E0325 14:24:06.627453 1 controller.go:217] kubebuilder/controller “msg”=”Reconciler error” “error”=”no object matching key \”default/eks-alb-testing-web-ingress\” in local store” “controller”=”alb-ingress-controller” “request”={“Namespace”:”default”,”Name”:”eks-alb-testing-web-ingress”}<br/>I0325 14:24:09.257834 1 security_group.go:36] default/eks-alb-testing-web-ingress: creating securityGroup dbd770cc-default-eksalbtes-09fa:managed LoadBalancer securityGroup by ALB Ingress Controller<br/>…<br/>I0325 14:24:09.665207 1 loadbalancer.go:191] default/eks-alb-testing-web-ingress: creating LoadBalancer dbd770cc-default-eksalbtes-09fa<br/>…<br/>I0325 14:24:10.636180 1 targets.go:80] default/eks-alb-testing-web-ingress: Adding targets to arn:aws:elasticloadbalancing:eu-north-1:534***385:targetgroup/dbd770cc-fe1e32fc96596dcf2c1/ef783b9fead58965: i-0622ff000570f32c7:31095, i-062329ba6419ba845:31095<br/>I0325 14:24:10.821148 1 listener.go:110] default/eks-alb-testing-web-ingress: creating listener 80<br/>…<br/>I0325 14:24:13.171590 1 rules.go:82] default/eks-alb-testing-web-ingress: modifying rule 1 on arn:aws:elasticloadbalancing:eu-north-1:534***385:listener/app/dbd770cc-default-eksalbtes-09fa/979c262ea2e12983/455a07658116adcd<br/>I0325 14:24:13.192456 1 rules.go:98] default/eks-alb-testing-web-ingress: rule 1 modified with conditions [{ Field: “path-pattern”, Values: [“/*”] }]</span></pre><p id="5d33" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查<code class="fe kx ky kz la b">Ingress</code>资源:</p><pre class="mn mo mp mq gt mr la ms mt aw mu bi"><span id="d987" class="lp lq iq la b gy mv mw l mx my">$ kubectl get ingress -o wide<br/>NAME HOSTS ADDRESS PORTS AGE<br/>eks-alb-testing-web-ingress * dbd770cc-default-eksalbtes-09fa-1532296804.eu-north-1.elb.amazonaws.com 80 114s</span></pre><p id="df62" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并尝试连接到它:</p><pre class="mn mo mp mq gt mr la ms mt aw mu bi"><span id="8b90" class="lp lq iq la b gy mv mw l mx my">$ curl -I dbd770cc-default-eksalbtes-09fa-1532296804.eu-north-1.elb.amazonaws.com<br/>HTTP/1.1 200 OK<br/>Date: Wed, 25 Mar 2020 14:26:27 GMT<br/>Content-Type: text/html<br/>Content-Length: 612<br/>Connection: keep-alive<br/>Server: nginx/1.17.9<br/>Last-Modified: Tue, 03 Mar 2020 14:32:47 GMT<br/>ETag: “5e5e6a8f-264”<br/>Accept-Ranges: bytes</span></pre><p id="9354" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成了。</p></div><div class="ab cl nl nm hu nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="ij ik il im in"><p id="1588" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="mz">最初发布于</em> <a class="ae kw" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-running-alb-ingress-controller/" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> <em class="mz"> RTFM: Linux、DevOps和系统管理</em> </strong> </a> <em class="mz">。</em></p></div></div>    
</body>
</html>