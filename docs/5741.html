<html>
<head>
<title>Understanding Kubernetes Maven Plugin’s Image XML configuration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解Kubernetes Maven插件的图像XML配置</h1>
<blockquote>原文：<a href="https://itnext.io/understanding-kubernetes-maven-plugins-image-xml-configuration-e98ef633e231?source=collection_archive---------2-----------------------#2021-05-16">https://itnext.io/understanding-kubernetes-maven-plugins-image-xml-configuration-e98ef633e231?source=collection_archive---------2-----------------------#2021-05-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/47d070768d1a77f5505555855fcc3df7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*VPk4GCUqHoQwIQ_v5bqWCw.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated"><a class="ae jy" href="https://www.eclipse.org/jkube" rel="noopener ugc nofollow" target="_blank">日蚀JKube </a></figcaption></figure><p id="7188" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">在我以前的博客中，您可能已经看到了Eclipse JKube如何通过提供自以为是的默认值(也称为<a class="ae jy" href="https://www.eclipse.org/jkube/docs/kubernetes-maven-plugin#zero-config" rel="noopener ugc nofollow" target="_blank">零配置模式</a>)来简化映像构建过程。</p><p id="31c3" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">但有时，您可能希望在应用程序的docker映像中进行配置。这些包括像激活一个额外的端口，添加额外的文件到你的图像，改变入口点等。在这篇博客中，我们将看看如何利用Eclipse JKube的image XML配置来根据您的需要创建任何类型的Docker图像。Eclipse JKube也支持Dockerfiles，我们将在另一篇博客中看到。</p><p id="c720" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">假设您想要构建一个简单的docker映像，其docker文件如下所示:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="e45b" class="lg lh iq lc b gy li lj l lk ll"><strong class="lc ir">FROM</strong> adoptopenjdk/openjdk11:alpine-jre <br/><strong class="lc ir">WORKDIR</strong> /usr/home/app <br/><strong class="lc ir">COPY</strong> target/your-project.jar your-project.jar <br/><strong class="lc ir">EXPOSE</strong> 8080 <br/><strong class="lc ir">CMD</strong> ["java", "-jar", "your-project.jar"]</span></pre><p id="54d8" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">这是一个非常简单的docker文件，它将在目标中找到的任何jar文件复制到容器中，然后执行它。如果我们想通过Eclipse JKube Plugins的XML配置做同样的事情，看起来应该是这样的:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="510a" class="lg lh iq lc b gy li lj l lk ll"><strong class="lc ir">&lt;plugin&gt;<br/>  &lt;groupId&gt;</strong>org.eclipse.jkube<strong class="lc ir">&lt;/groupId&gt;<br/>  &lt;artifactId&gt;</strong>kubernetes-maven-plugin<strong class="lc ir">&lt;/artifactId&gt;<br/>  &lt;version&gt;</strong>${jkube.version}<strong class="lc ir">&lt;/version&gt;<br/>  &lt;configuration&gt;<br/>     &lt;images&gt;<br/>        &lt;image&gt;<br/>          &lt;!--(1)--&gt;<br/>          &lt;name&gt;</strong>user/imagename:latest<strong class="lc ir">&lt;/name&gt;<br/>           &lt;build&gt;<br/>              &lt;!--(2)--&gt;<br/>              &lt;from&gt;</strong>adoptopenjdk/openjdk11:alpine-jre<strong class="lc ir">&lt;/from&gt;</strong><br/>              <strong class="lc ir">&lt;!--(3)--&gt;<br/>              &lt;assembly&gt;<br/>                 &lt;mode&gt;</strong>dir<strong class="lc ir">&lt;/mode&gt;<br/>                 &lt;targetDir&gt;</strong>/usr/home/app<strong class="lc ir">&lt;/targetDir&gt;<br/>                 &lt;inline&gt;</strong><br/>                    <strong class="lc ir">&lt;id&gt;</strong>copy-jar<strong class="lc ir">&lt;/id&gt;<br/>                    &lt;baseDirectory&gt;</strong>/home/home/app<strong class="lc ir">&lt;/baseDirectory&gt;<br/>                    &lt;!--(4)--&gt;</strong><br/>                    <strong class="lc ir">&lt;files&gt;</strong><br/>                       <strong class="lc ir">&lt;file&gt;</strong><br/>                          <strong class="lc ir">&lt;source&gt;<br/>                 </strong>target/${project.artifactId}-${project.version}.jar<br/>                          <strong class="lc ir">&lt;/source&gt;</strong><br/>                          <strong class="lc ir">&lt;outputDirectory&gt;</strong>.<strong class="lc ir">&lt;/outputDirectory&gt;</strong><br/>                       <strong class="lc ir">&lt;/file&gt;</strong><br/>                    <strong class="lc ir">&lt;/files&gt;</strong><br/>                 <strong class="lc ir">&lt;/inline&gt;</strong><br/>              <strong class="lc ir">&lt;/assembly&gt;<br/>              &lt;!--(5)--&gt;<br/></strong>              <strong class="lc ir">&lt;workdir&gt;</strong>/usr/home/app<strong class="lc ir">&lt;/workdir&gt;<br/>              &lt;!--(6)--&gt;</strong><br/>              <strong class="lc ir">&lt;cmd&gt;<br/>        </strong>java -jar ${project.artifactId}-${project.version}.jar<br/>              <strong class="lc ir">&lt;/cmd&gt;<br/>              &lt;!--(7)--&gt;<br/>              &lt;ports&gt;<br/>                 &lt;port&gt;</strong>8080<strong class="lc ir">&lt;/port&gt;</strong><br/>              <strong class="lc ir">&lt;/ports&gt;<br/>           &lt;/build&gt;<br/>         &lt;/image&gt;<br/>     &lt;/images&gt;<br/>  &lt;/configuration&gt;<br/>&lt;/plugin&gt;</strong></span></pre><p id="f906" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">以下是解释的所有组件:</p><ol class=""><li id="7f68" class="lm ln iq kb b kc kd kg kh kk lo ko lp ks lq kw lr ls lt lu bi translated">要构建的图像的名称</li><li id="e101" class="lm ln iq kb b kc lv kg lw kk lx ko ly ks lz kw lr ls lt lu bi translated">此应用程序映像所基于的基本映像，<code class="fe ma mb mc lc b">FROM</code>等效</li><li id="975f" class="lm ln iq kb b kc lv kg lw kk lx ko ly ks lz kw lr ls lt lu bi translated">用于将文件/目录复制到您的映像的程序集配置</li><li id="d8ec" class="lm ln iq kb b kc lv kg lw kk lx ko ly ks lz kw lr ls lt lu bi translated">要复制到映像中的文件列表</li><li id="8a65" class="lm ln iq kb b kc lv kg lw kk lx ko ly ks lz kw lr ls lt lu bi translated">工作目录为镜像，<code class="fe ma mb mc lc b">WORKDIR</code>等效</li><li id="9604" class="lm ln iq kb b kc lv kg lw kk lx ko ly ks lz kw lr ls lt lu bi translated">容器启动时要运行的命令，<code class="fe ma mb mc lc b">CMD</code>等效</li><li id="cf1c" class="lm ln iq kb b kc lv kg lw kk lx ko ly ks lz kw lr ls lt lu bi translated">端口暴露在您的图像中，<code class="fe ma mb mc lc b">EXPOSE</code>相当于</li></ol><p id="539d" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">你可以像往常一样使用<code class="fe ma mb mc lc b">mvn k8s:build</code>目标来建立你的形象。您还可以检查图像，以检查您的jar是否被正确复制。</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="4fd1" class="lg lh iq lc b gy li lj l lk ll"><strong class="lc ir">$</strong> mvn k8s:build</span><span id="bac8" class="lg lh iq lc b gy md lj l lk ll">...</span><span id="0c95" class="lg lh iq lc b gy md lj l lk ll"><strong class="lc ir">$</strong> docker run -it cf0c7 /bin/sh <br/>/usr/home/app # ls <br/>random-generator-0.0.1.jar</span></pre><h2 id="1880" class="lg lh iq bd me mf mg dn mh mi mj dp mk kk ml mm mn ko mo mp mq ks mr ms mt mu bi translated">将多个文件复制到映像中:</h2><p id="537d" class="pw-post-body-paragraph jz ka iq kb b kc mv ke kf kg mw ki kj kk mx km kn ko my kq kr ks mz ku kv kw ij bi translated">Eclipse JKube还允许您将多个文件复制到映像中。假设您的项目目录中有两个文件，您想将其复制到映像中:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="2c29" class="lg lh iq lc b gy li lj l lk ll"><strong class="lc ir">eclipse-jkube-demo-project : $</strong> ls -l <br/><br/>-rw-rw-r--. 1 rohaan rohaan    19 May 16 19:47 first.txt <br/>-rwxrwxr-x. 1 rohaan rohaan  4259 May 10 20:30 <strong class="lc ir">pom.xml</strong> <br/>-rw-rw-r--. 1 rohaan rohaan    20 May 16 19:47 second.txt <br/>drwxrwxr-x. 1 rohaan rohaan    16 Nov 16 19:06 <strong class="lc ir">src</strong> <br/>drwxrwxr-x. 1 rohaan rohaan   394 May 10 20:32 <strong class="lc ir">target</strong></span></pre><p id="4a46" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">如果我想将<code class="fe ma mb mc lc b">first.txt</code>和<code class="fe ma mb mc lc b">second.txt</code>与我的jar文件一起复制到我的映像中。我需要添加额外的<code class="fe ma mb mc lc b">&lt;file&gt;</code>元素，引用需要复制到图像的文件的路径，如下所示:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="ed10" class="lg lh iq lc b gy li lj l lk ll"><strong class="lc ir">&lt;assembly&gt;<br/>    &lt;mode&gt;</strong>dir<strong class="lc ir">&lt;/mode&gt;<br/>    &lt;targetDir&gt;</strong>/usr/home/app<strong class="lc ir">&lt;/targetDir&gt;<br/>    &lt;inline&gt;<br/>        &lt;id&gt;</strong>copy-jar&lt;<strong class="lc ir">/id&gt;<br/>        &lt;baseDirectory&gt;</strong>/usr/home/app<strong class="lc ir">&lt;/baseDirectory&gt;</strong><br/>        <strong class="lc ir">&lt;files&gt;</strong><br/>            <strong class="lc ir">&lt;file&gt;<br/>                &lt;source&gt;</strong>first.txt<strong class="lc ir">&lt;/source&gt;<br/>                &lt;outputDirectory&gt;</strong>.<strong class="lc ir">&lt;/outputDirectory&gt;<br/>            &lt;/file&gt;<br/>            &lt;file&gt;<br/>                &lt;source&gt;</strong>second.txt<strong class="lc ir">&lt;/source&gt;<br/>                &lt;outputDirectory&gt;</strong>.<strong class="lc ir">&lt;/outputDirectory&gt;<br/>            &lt;/file&gt;<br/>        &lt;/files&gt;<br/>    &lt;/inline&gt;<br/>&lt;/assembly&gt;</strong></span></pre><h2 id="d9c9" class="lg lh iq bd me mf mg dn mh mi mj dp mk kk ml mm mn ko mo mp mq ks mr ms mt mu bi translated">将目录复制到映像:</h2><p id="0dae" class="pw-post-body-paragraph jz ka iq kb b kc mv ke kf kg mw ki kj kk mx km kn ko my kq kr ks mz ku kv kw ij bi translated">对于复制目录，您需要使用<code class="fe ma mb mc lc b">&lt;fileSet&gt;</code> XML元素。假设您想要将<code class="fe ma mb mc lc b">src/main/resources</code>和<code class="fe ma mb mc lc b">target/classes</code>目录复制到您的目标映像。下面是使用XML配置的方法:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="416c" class="lg lh iq lc b gy li lj l lk ll"><strong class="lc ir">&lt;assembly&gt;<br/>    &lt;mode&gt;</strong>dir<strong class="lc ir">&lt;/mode&gt;<br/>    &lt;targetDir&gt;</strong>/usr/home/app<strong class="lc ir">&lt;/targetDir&gt;<br/>    &lt;inline&gt;<br/>        &lt;id&gt;</strong>copy-jar<strong class="lc ir">&lt;/id&gt;<br/>        &lt;baseDirectory&gt;</strong>/usr/home/app<strong class="lc ir">&lt;/baseDirectory&gt;<br/>        &lt;fileSets&gt;<br/>            &lt;fileSet&gt;<br/>                &lt;directory&gt;</strong>target/classes<strong class="lc ir">&lt;/directory&gt;<br/>                &lt;outputDirectory&gt;</strong>classes<strong class="lc ir">&lt;/outputDirectory&gt;<br/>            &lt;/fileSet&gt;<br/>            &lt;fileSet&gt;<br/>                &lt;directory&gt;</strong>src/main/resources<strong class="lc ir">&lt;/directory&gt;<br/>                &lt;outputDirectory&gt;</strong>resources<strong class="lc ir">&lt;/outputDirectory&gt;<br/>            &lt;/fileSet&gt;<br/>        &lt;/fileSets&gt;<br/>    &lt;/inline&gt;<br/>&lt;/assembly&gt;</strong></span></pre><p id="df10" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后您可以像往常一样执行<code class="fe ma mb mc lc b">mvn k8s:build</code>,检查目录是否被复制到您的容器映像中:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="21c6" class="lg lh iq lc b gy li lj l lk ll"><strong class="lc ir">$</strong> mvn k8s:build</span><span id="80c1" class="lg lh iq lc b gy md lj l lk ll">...</span><span id="e05b" class="lg lh iq lc b gy md lj l lk ll"><strong class="lc ir">$</strong> docker run -it 1706a /bin/sh <br/>/usr/home/app # ls <br/><strong class="lc ir">classes</strong>                     random-generator-0.0.1.jar  <strong class="lc ir">resources</strong> <br/>/usr/home/app # cd resources/ <br/>/usr/home/app/resources # ls <br/>application.properties <br/>/usr/home/app/resources # cat application.properties  <br/>spring.devtools.remote.secret=mysecret</span></pre><h2 id="887a" class="lg lh iq bd me mf mg dn mh mi mj dp mk kk ml mm mn ko mo mp mq ks mr ms mt mu bi translated">切换映像构建策略:</h2><p id="b244" class="pw-post-body-paragraph jz ka iq kb b kc mv ke kf kg mw ki kj kk mx km kn ko my kq kr ks mz ku kv kw ij bi translated">Eclipse JKube不仅使用<a class="ae jy" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker </a>构建容器映像，还提供了构建容器映像的替代方法。在撰写本文时，它还支持JIB，使用它您可以构建您的容器映像，而无需任何类型的守护程序。还有<a class="ae jy" href="https://github.com/openshift/source-to-image" rel="noopener ugc nofollow" target="_blank"> S2I </a>构建策略，但它只在openshift-maven-plugin的情况下可用。</p><p id="78d1" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">默认情况下，Docker是默认的构建策略。但是您可以通过<code class="fe ma mb mc lc b">jkube.build.strategy</code>属性或者通过<code class="fe ma mb mc lc b">&lt;buildStrategy&gt;</code> XML配置元素来定制它，如下所示:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="cbbf" class="lg lh iq lc b gy li lj l lk ll"><strong class="lc ir">&lt;plugin&gt;<br/>    &lt;groupId&gt;</strong>org.eclipse.jkube<strong class="lc ir">&lt;/groupId&gt;<br/>    &lt;artifactId&gt;</strong>kubernetes-maven-plugin<strong class="lc ir">&lt;/artifactId&gt;<br/>    &lt;version&gt;</strong>${jkube.version}<strong class="lc ir">&lt;/version&gt;<br/>    &lt;configuration&gt;<br/>        </strong>&lt;!-- JIB Build Strategy: No daemon required--&gt;<strong class="lc ir">          <br/>        &lt;buildStrategy&gt;</strong>jib<strong class="lc ir">&lt;/buildStrategy&gt;<br/>        &lt;images&gt;<br/>        ...<br/>        &lt;/images&gt;<br/>    &lt;/configuration&gt;<br/>&lt;/plugin&gt;</strong></span></pre><h2 id="db0c" class="lg lh iq bd me mf mg dn mh mi mj dp mk kk ml mm mn ko mo mp mq ks mr ms mt mu bi translated">指定容器注册表凭据:</h2><p id="97ca" class="pw-post-body-paragraph jz ka iq kb b kc mv ke kf kg mw ki kj kk mx km kn ko my kq kr ks mz ku kv kw ij bi translated">Eclipse JKube还允许您将图像推送到容器注册中心。您可以通过<code class="fe ma mb mc lc b">docker login</code> (Eclipse JKube读作<code class="fe ma mb mc lc b">~/.docker/config.json</code>)或您的<code class="fe ma mb mc lc b">~/.m2/settings.xml</code>来提供容器注册凭证。但是您也可以使用XML配置使用<code class="fe ma mb mc lc b">&lt;authConfig&gt;</code>部分来指定这些。假设您已经为注册表用户名和密码定义了环境变量:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="7974" class="lg lh iq lc b gy li lj l lk ll"><strong class="lc ir">$</strong> export DOCKERHUB_USERNAME=myusername<br/><strong class="lc ir">$</strong> export DOCKERHUB_PASSWORD=secret</span></pre><p id="abf5" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">您可以像这样在<code class="fe ma mb mc lc b">&lt;authConfig&gt;</code>中指定这些:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="51fb" class="lg lh iq lc b gy li lj l lk ll"><strong class="lc ir">&lt;plugin&gt;<br/>    &lt;groupId&gt;</strong>org.eclipse.jkube<strong class="lc ir">&lt;/groupId&gt;<br/>    &lt;artifactId&gt;</strong>kubernetes-maven-plugin<strong class="lc ir">&lt;/artifactId&gt;<br/>    &lt;version&gt;</strong>${jkube.version}<strong class="lc ir">&lt;/version&gt;<br/>    &lt;configuration&gt;<br/>        &lt;images&gt; <br/>          ...<br/>        &lt;/images&gt; <br/>        &lt;authConfig&gt;<br/>            &lt;username&gt;</strong>${env.DOCKERHUB_USERNAME}<strong class="lc ir">&lt;/username&gt;<br/>            &lt;password&gt;</strong>${env.DOCKERHUB_PASSWORD}<strong class="lc ir">&lt;/password&gt;<br/>        &lt;/authConfig&gt;<br/>    &lt;/configuration&gt;<br/>&lt;/plugin&gt;</strong></span></pre><h2 id="3a4a" class="lg lh iq bd me mf mg dn mh mi mj dp mk kk ml mm mn ko mo mp mq ks mr ms mt mu bi translated">结论:</h2><p id="0466" class="pw-post-body-paragraph jz ka iq kb b kc mv ke kf kg mw ki kj kk mx km kn ko my kq kr ks mz ku kv kw ij bi translated">我希望这篇博客简要介绍了如何在为java应用程序构建容器映像的同时利用Eclipse JKube XML配置。你可以在<a class="ae jy" href="https://www.eclipse.org/jkube/docs/kubernetes-maven-plugin#build-goal-configuration" rel="noopener ugc nofollow" target="_blank"> Eclipse JKube构建配置文档</a>中读到更多关于它的细节。</p></div></div>    
</body>
</html>