<html>
<head>
<title>Nextcloud: running in Docker Compose on Debian with Let’s Encrypt SSL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Nextcloud:在Debian上运行Docker Compose，让我们加密SSL</h1>
<blockquote>原文：<a href="https://itnext.io/nextcloud-running-in-docker-compose-on-debian-with-lets-encrypt-ssl-510d937d115a?source=collection_archive---------2-----------------------#2019-11-30">https://itnext.io/nextcloud-running-in-docker-compose-on-debian-with-lets-encrypt-ssl-510d937d115a?source=collection_archive---------2-----------------------#2019-11-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/a6173861ae72126f32242d9351055761.png" data-original-src="https://miro.medium.com/v2/resize:fit:260/format:webp/0*3-BcjCSHSIDfKy7t.png"/></div></figure><p id="424e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">不久前我测试了Nextcloud，见<a class="ae ks" href="https://rtfm.co.ua/en/nextcloud-installing-server-on-debian-behind-nginx-with-php-fpm-and-client-on-arch-linux/" rel="noopener ugc nofollow" target="_blank"> NextCloud:用PHP-FPM在NGINX后面的Debian上安装服务器，在Arch Linux上安装客户端</a>帖子。</p><p id="c19f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">总的来说，看起来还不错，所以是时候尝试在生产环境下运行，最后从Dropbox迁移到it上了。</p><p id="a87d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">今天，让我们使用Docker Compose在数字海洋中运行的一个droplet上运行一个Nextcloud实例。</p><p id="878a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这个droplet安装了一个额外的卷，以便于在实例之间迁移数据和备份数据。</p><p id="7388" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要运行所有必要的服务，让我们用下面的容器创建一个Docker合成文件:</p><ol class=""><li id="b85a" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ky kz la lb bi translated">NGINX:一种代理服务</li><li id="f710" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">让我们加密:一个SSL代理</li><li id="6baf" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">MariaDB:存储Nextcloud设置的数据库服务器</li><li id="410f" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">Nextcloud:一个包含Apache和Nextcloud源代码的Nextcloud容器</li></ol><p id="d6a4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">参见文档<a class="ae ks" href="https://github.com/nextcloud/docker" rel="noopener ugc nofollow" target="_blank">此处&gt; &gt; &gt; </a>。</p><p id="5bf8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因为SSL将使用来自<a class="ae ks" href="https://github.com/JrCs/docker-letsencrypt-nginx-proxy-companion" rel="noopener ugc nofollow" target="_blank">docker-letsencrypt-nginx-proxy-companion</a>映像<strong class="jw ir">的加密客户端。</strong></p><h2 id="daa3" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">Docker和Docker组成装置</h2><p id="b268" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">安装Docker:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="74fd" class="lh li iq mk b gy mo mp l mq mr">root@setevoy-do-nextcloud-production:~# curl <a class="ae ks" href="https://get.docker.com/" rel="noopener ugc nofollow" target="_blank">https://get.docker.com/</a> | bash</span></pre><p id="90f1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">和Docker Compose(先检查版本— <em class="ms">下载/1.24.1/ </em>在<a class="ae ks" href="https://github.com/docker/compose/releases/" rel="noopener ugc nofollow" target="_blank">发布页面</a>):</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="a57b" class="lh li iq mk b gy mo mp l mq mr">root@setevoy-do-nextcloud-production:~# curl -L “https://github.com/docker/compose/releases/download/1.24.1/docker-compose-$(uname -s)-$(uname -m)” -o /usr/local/bin/docker-compose<br/>root@setevoy-do-nextcloud-production:~# chmod +x /usr/local/bin/docker-compose</span></pre><p id="2a74" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建一个新目录来存储我们将来的合成文件:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="7269" class="lh li iq mk b gy mo mp l mq mr">root@setevoy-do-nextcloud-production:~# mkdir /opt/nextcloud<br/>root@setevoy-do-nextcloud-production:~# cd /opt/nextcloud/</span></pre><p id="b965" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们从堆栈创建开始。</p><h2 id="09a3" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">运行Nexcloud</h2><h2 id="7f06" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated"><code class="fe mt mu mv mk b">nginx-proxy</code></h2><p id="2d47" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">创建目录来保存NGINX a让加密文件:</p><p id="4bc7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">root @ setevoy-do-next cloud-production:/data/next cloud # mkdir-p/data/next cloud/nginx/{ certs，vhost.d，html}</p><p id="eab4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建合成文件<code class="fe mt mu mv mk b">/opt/nextcloud/nextcloud-compose.yml</code>，先添加一个网络:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="c6bd" class="lh li iq mk b gy mo mp l mq mr">networks:<br/>  nextcloud_network:</span></pre><p id="1ac8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，添加第一个包含将使用该网络的<code class="fe mt mu mv mk b">nginx-proxy</code>映像的容器，从上面创建的目录中添加卷，因此该文件将是下一个:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="8e6c" class="lh li iq mk b gy mo mp l mq mr">version: '3'  <br/><br/>services:<br/><br/>  nginx-proxy:<br/>    image: jwilder/nginx-proxy:alpine<br/>    labels:<br/>      - "com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy=true"<br/>    container_name: nextcloud-proxy<br/>    networks:<br/>      - nextcloud_network<br/>    ports:<br/>      - 80:80<br/>      - 443:443<br/>    volumes:<br/><br/>      - /data/nextcloud/nginx/vhost.d:/etc/nginx/vhost.d:rw<br/>      - /data/nextcloud/nginx/html:/usr/share/nginx/html:rw<br/>      - /data/nextcloud/nginx/certs:/etc/nginx/certs:ro<br/><br/>      - /etc/localtime:/etc/localtime:ro<br/>      - /var/run/docker.sock:/tmp/docker.sock:ro<br/><br/>    restart: unless-stopped<br/><br/>networks:<br/>  nextcloud_network:</span></pre><p id="d9ea" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">let加密容器将使用<em class="ms">标签:com . github . jrcs . Lets Encrypt _ nginx _ proxy _ companion . nginx _ proxy = true</em>字符串来查找“它自己的”代理服务。</p><p id="e750" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里的目录:</p><ul class=""><li id="1cbd" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr mw kz la lb bi translated"><code class="fe mt mu mv mk b">/etc/nginx/certs</code>:存储SSL的证书和私有密钥(对于<code class="fe mt mu mv mk b">nginx-proxy</code>容器是只读的，因为这些文件将由let加密容器生成)。</li><li id="f917" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr mw kz la lb bi translated"><code class="fe mt mu mv mk b">/etc/nginx/vhost.d</code>:虚拟主机配置</li><li id="b1e9" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr mw kz la lb bi translated"><code class="fe mt mu mv mk b">/usr/share/nginx/html</code>:用于颁发新SSL证书时的域验证</li></ul><p id="dbdf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行它:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="ecc9" class="lh li iq mk b gy mo mp l mq mr">root@setevoy-do-nextcloud-production:/opt/nextcloud# docker-compose -f nextcloud-compose.yml up<br/>Creating nextcloud-proxy … done<br/>Attaching to nextcloud-proxy<br/>nextcloud-proxy | WARNING: /etc/nginx/dhparam/dhparam.pem was not found. A pre-generated dhparam.pem will be used for now while a new one<br/>nextcloud-proxy | is being generated in the background. Once the new dhparam.pem is in place, nginx will be reloaded.<br/>nextcloud-proxy | forego | starting dockergen.1 on port 5000<br/>nextcloud-proxy | forego | starting nginx.1 on port 5100<br/>nextcloud-proxy | Generating DH parameters, 2048 bit long safe prime, generator 2<br/>nextcloud-proxy | dockergen.1 | 2019/11/27 08:15:10 Generated ‘/etc/nginx/conf.d/default.conf’ from 1 containers<br/>nextcloud-proxy | dockergen.1 | 2019/11/27 08:15:10 Running ‘nginx -s reload’<br/>nextcloud-proxy | dockergen.1 | 2019/11/27 08:15:10 Watching docker events<br/>nextcloud-proxy | dockergen.1 | 2019/11/27 08:15:10 Contents of /etc/nginx/conf.d/default.conf did not change. Skipping notification ‘nginx -s reload’<br/>nextcloud-proxy | 2019/11/27 08:15:41 [notice] 41#41: signal process started<br/>nextcloud-proxy | This is going to take a long time<br/>nextcloud-proxy | dhparam generation complete, reloading nginx</span></pre><p id="a82d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并尝试连接:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="8911" class="lh li iq mk b gy mo mp l mq mr">[setevoy@setevoy-arch-work ~] $ curl -I cloud.example.org.ua<br/>HTTP/1.1 503 Service Temporarily Unavailable<br/>Server: nginx/1.17.5<br/>Date: Wed, 27 Nov 2019 07:57:28 GMT<br/>Content-Type: text/html<br/>Content-Length: 197<br/>Connection: keep-alive</span></pre><p id="5e32" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">酷毙了。此时503错误对我们来说没有意义，因为我们还没有启动其他服务。</p><h2 id="6653" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">让我们加密Docker</h2><p id="c2a2" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">现在，将Let's Encrypt容器添加到这个合成文件中:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="3846" class="lh li iq mk b gy mo mp l mq mr">...<br/>  letsencrypt:<br/>    image: jrcs/letsencrypt-nginx-proxy-companion<br/>    container_name: nextcloud-letsencrypt<br/>    depends_on:<br/>      - nginx-proxy<br/>    networks:<br/>      - nextcloud_network<br/>    volumes:<br/><br/>      - /data/nextcloud/nginx/vhost.d:/etc/nginx/vhost.d:rw<br/>      - /data/nextcloud/nginx/html:/usr/share/nginx/html:rw<br/>      - /data/nextcloud/nginx/certs:/etc/nginx/certs:rw<br/><br/>      - /etc/localtime:/etc/localtime:ro<br/>      - /var/run/docker.sock:/var/run/docker.sock:ro<br/><br/>    restart: unless-stopped<br/>...</span></pre><p id="13fe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">重新创建堆栈:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="edbc" class="lh li iq mk b gy mo mp l mq mr">root@setevoy-do-nextcloud-production:/opt/nextcloud# docker-compose -f nextcloud-compose.yml up<br/>Starting nextcloud-proxy … done<br/>Creating nextcloud-letsencrypt … done<br/>Attaching to nextcloud-proxy, nextcloud-letsencrypt<br/>nextcloud-proxy | Custom dhparam.pem file found, generation skipped<br/>nextcloud-proxy | forego | starting dockergen.1 on port 5000<br/>nextcloud-proxy | forego | starting nginx.1 on port 5100<br/>nextcloud-proxy | dockergen.1 | 2019/11/27 08:31:01 Contents of /etc/nginx/conf.d/default.conf did not change. Skipping notification ‘nginx -s reload’<br/>nextcloud-proxy | dockergen.1 | 2019/11/27 08:31:01 Watching docker events<br/>nextcloud-proxy | dockergen.1 | 2019/11/27 08:31:01 Contents of /etc/nginx/conf.d/default.conf did not change. Skipping notification ‘nginx -s reload’<br/>nextcloud-proxy | dockergen.1 | 2019/11/27 08:31:02 Received event start for container 2f40fa5f50ea<br/>nextcloud-proxy | dockergen.1 | 2019/11/27 08:31:02 Contents of /etc/nginx/conf.d/default.conf did not change. Skipping notification ‘nginx -s reload’<br/>nextcloud-letsencrypt | Generating a RSA private key<br/>nextcloud-letsencrypt | ……………………………………………………………………………………………………………++++<br/>nextcloud-letsencrypt | ………..++++<br/>nextcloud-letsencrypt | writing new private key to ‘/etc/nginx/certs/default.key.new’<br/>nextcloud-letsencrypt | — — -<br/>nextcloud-letsencrypt | Info: a default key and certificate have been created at /etc/nginx/certs/default.key and /etc/nginx/certs/default.crt.<br/>nextcloud-letsencrypt | Info: Creating Diffie-Hellman group in the background.<br/>nextcloud-letsencrypt | A pre-generated Diffie-Hellman group will be used for now while the new one<br/>nextcloud-letsencrypt | is being created.<br/>nextcloud-letsencrypt | Generating DH parameters, 2048 bit long safe prime, generator 2<br/>nextcloud-letsencrypt | Reloading nginx proxy (2e665ad175d4e2dbd270b4616bbe5d0e1c5f78421d25da55d163cc15836e859c)…<br/>nextcloud-letsencrypt | 2019/11/27 08:31:03 Generated ‘/etc/nginx/conf.d/default.conf’ from 2 containers<br/>nextcloud-letsencrypt | 2019/11/27 08:31:03 [notice] 34#34: signal process started<br/>nextcloud-letsencrypt | 2019/11/27 08:31:03 Generated ‘/app/letsencrypt_service_data’ from 2 containers<br/>nextcloud-letsencrypt | 2019/11/27 08:31:03 Running ‘/app/signal_le_service’<br/>nextcloud-letsencrypt | 2019/11/27 08:31:04 Watching docker events<br/>nextcloud-letsencrypt | 2019/11/27 08:31:04 Contents of /app/letsencrypt_service_data did not change. Skipping notification ‘/app/signal_le_service’<br/>nextcloud-letsencrypt | Sleep for 3600s<br/>nextcloud-letsencrypt | This is going to take a long time<br/>nextcloud-letsencrypt | Info: Diffie-Hellman group creation complete, reloading nginx.<br/>nextcloud-letsencrypt | Reloading nginx proxy (2e665ad175d4e2dbd270b4616bbe5d0e1c5f78421d25da55d163cc15836e859c)…<br/>nextcloud-letsencrypt | 2019/11/27 08:31:12 Contents of /etc/nginx/conf.d/default.conf did not change. Skipping notification ‘’<br/>nextcloud-letsencrypt | 2019/11/27 08:31:12 [notice] 54#54: signal process started</span></pre><p id="d290" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们加密容器为我们生成的证书—检查它:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="7d93" class="lh li iq mk b gy mo mp l mq mr">root@setevoy-do-nextcloud-production:/data/nextcloud# ll /data/nextcloud/nginx/certs/<br/>total 12<br/>-rw-r — r — 1 root root 1870 Nov 27 08:31 default.crt<br/>-rw-r — r — 1 root root 3272 Nov 27 08:31 default.key<br/>-rw-r — r — 1 root root 424 Nov 27 08:31 dhparam.pem</span></pre><p id="ee71" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并通过HTTPS/443查询可用性:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="1c31" class="lh li iq mk b gy mo mp l mq mr">[setevoy@setevoy-arch-work ~] $ curl -I <a class="ae ks" href="https://cloud.example.org.ua" rel="noopener ugc nofollow" target="_blank">https://cloud.example.org.ua</a><br/>curl: (60) SSL certificate problem: self signed certificate<br/>More details here: <a class="ae ks" href="https://curl.haxx.se/docs/sslcerts.html" rel="noopener ugc nofollow" target="_blank">https://curl.haxx.se/docs/sslcerts.html</a><br/>curl failed to verify the legitimacy of the server and therefore could not<br/>establish a secure connection to it. To learn more about this situation and<br/>how to fix it, please visit the web page mentioned above.</span></pre><p id="cd25" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好的—连接正常，只是证书名称无效。我们将在稍后使用Nextcloud实例添加web应用程序时修复它</p><p id="29a5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，可以通过使用<code class="fe mt mu mv mk b">curl -k</code>跳过这个检查:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="cf80" class="lh li iq mk b gy mo mp l mq mr">[setevoy@setevoy-arch-work ~] $ curl -kI <a class="ae ks" href="https://cloud.example.org.ua" rel="noopener ugc nofollow" target="_blank">https://cloud.example.org.ua</a><br/>HTTP/2 503<br/>server: nginx/1.17.5<br/>date: Wed, 27 Nov 2019 08:32:58 GMT<br/>content-type: text/html<br/>content-length: 197</span></pre><p id="eab9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">仍然是503，但主要的事实是，HTTPS正在工作，一切顺利。</p><h2 id="ff03" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">码头工人中的MariaDB</h2><p id="47e8" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">接下来是添加一个MariaDB实例。</p><p id="eabe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要使其数据持久，请在主机上创建一个新目录:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="aebd" class="lh li iq mk b gy mo mp l mq mr">root@setevoy-do-nextcloud-production:/data/nextcloud# mkdir /data/nextcloud/mysql</span></pre><p id="a758" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将其服务添加到合成文件:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="6ee4" class="lh li iq mk b gy mo mp l mq mr">...<br/>  mysql:<br/>    image: mariadb<br/>    container_name: nextcloud-mysql<br/>    networks:<br/>      - nextcloud_network<br/>    volumes:<br/>      - /data/nextcloud/mysql:/var/lib/mysql<br/>      - /etc/localtime:/etc/localtime:ro<br/>    environment:<br/>      - MYSQL_ROOT_PASSWORD=mysql-root-p@ssw0rd<br/>      - MYSQL_PASSWORD=nextcloud-p@ssw0rd<br/>      - MYSQL_DATABASE=nextcloud<br/>      - MYSQL_USER=nextcloud<br/>    restart: unless-stopped<br/>...</span></pre><p id="b2fd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行堆栈:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="fdc8" class="lh li iq mk b gy mo mp l mq mr">…<br/>nextcloud-mysql | 2019–11–27 09:16:38+00:00 [Note] [Entrypoint]: Database files initialized<br/>nextcloud-mysql | 2019–11–27 09:16:38+00:00 [Note] [Entrypoint]: Starting temporary server<br/>nextcloud-mysql | 2019–11–27 09:16:38+00:00 [Note] [Entrypoint]: Waiting for server startup<br/>nextcloud-mysql | 2019–11–27 9:16:38 0 [Note] mysqld (mysqld 10.4.10-MariaDB-1:10.4.10+maria~bionic) starting as process 121 …<br/>nextcloud-mysql | 2019–11–27 9:16:38 0 [Note] InnoDB: Using Linux native AIO<br/>nextcloud-mysql | 2019–11–27 9:16:38 0 [Note] InnoDB: Mutexes and rw_locks use GCC atomic builtins<br/>nextcloud-mysql | 2019–11–27 9:16:38 0 [Note] InnoDB: Uses event mutexes<br/>…<br/>nextcloud-mysql | 2019–11–27 9:16:38 0 [Note] mysqld: ready for connections.<br/>nextcloud-mysql | Version: ‘10.4.10-MariaDB-1:10.4.10+maria~bionic’ socket: ‘/var/run/mysqld/mysqld.sock’ port: 0 mariadb.org binary distribution<br/>nextcloud-mysql | 2019–11–27 09:16:39+00:00 [Note] [Entrypoint]: Temporary server started.<br/>…</span></pre><p id="2fcf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查主机上是否存在数据:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="8973" class="lh li iq mk b gy mo mp l mq mr">root@setevoy-do-nextcloud-production:~# ll /data/nextcloud/mysql/<br/>…<br/>drwx — — — 2 systemd-coredump systemd-coredump 4096 Nov 27 09:17 mysql<br/>drwx — — — 2 systemd-coredump systemd-coredump 4096 Nov 27 09:17 nextcloud<br/>drwx — — — 2 systemd-coredump systemd-coredump 4096 Nov 27 09:16 performance_schema<br/>Okay.</span></pre><p id="8dff" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">尝试本地连接:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="33a8" class="lh li iq mk b gy mo mp l mq mr">root@setevoy-do-nextcloud-production:/data/nextcloud# mysql -h localhost -u root<br/>…<br/>MariaDB [(none)]&gt;</span></pre><p id="97fa" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">很好，起作用了。</p><h2 id="1076" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">Nextcloud</h2><p id="0d92" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">最后，让我们添加Nextcloud应用程序。</p><p id="736e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建目录:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="a11c" class="lh li iq mk b gy mo mp l mq mr">root@setevoy-do-nextcloud-production:~# mkdir -p /data/nextcloud/app/{config,custom_apps,data,themes,html}</span></pre><p id="5ce1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更新撰写文件:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="235e" class="lh li iq mk b gy mo mp l mq mr">...<br/>  nextcloud-app:<br/>    image: nextcloud:latest<br/>    container_name: nextcloud-app<br/>    networks:<br/>      - nextcloud_network<br/>    depends_on:<br/>      - letsencrypt<br/>      - nginx-proxy<br/>      - mysql<br/>    volumes:<br/>      - /data/nextcloud/app/html:/var/www/html<br/>      - /data/nextcloud/app/config:/var/www/html/config<br/>      - /data/nextcloud/app/custom_apps:/var/www/html/custom_apps<br/>      - /data/nextcloud/app/data:/var/www/html/data<br/>      - /data/nextcloud/app/themes:/var/www/html/themes<br/>      - /etc/localtime:/etc/localtime:ro<br/>    environment:<br/>      - VIRTUAL_HOST=cloud.example.org.ua<br/>      - LETSENCRYPT_HOST=cloud.example.org.ua<br/>      - LETSENCRYPT_EMAIL=root@example.org.ua<br/>    restart: unless-stopped<br/>...</span></pre><p id="c9ad" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe mt mu mv mk b">VIRTUAL_HOST</code>将被<code class="fe mt mu mv mk b">nginx-proxy</code>用来选择代理的内容和位置，而<code class="fe mt mu mv mk b">LETSENCRYPT_HOST</code>将被Let的加密容器用来确定一个域名以创建一个SSL证书。此处&gt; &gt; &gt; 见文档。</p><p id="8307" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行堆栈</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="1293" class="lh li iq mk b gy mo mp l mq mr">root@setevoy-do-nextcloud-production:/opt/nextcloud# docker-compose -f nextcloud-compose.yml up — force-recreate<br/>Recreating nextcloud-proxy … done<br/>Recreating nextcloud-mysql … done<br/>Recreating nextcloud-letsencrypt … done<br/>Creating nextcloud-app … done<br/>Attaching to nextcloud-mysql, nextcloud-proxy, nextcloud-letsencrypt, nextcloud-app<br/>…</span></pre><p id="4a21" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查HTTPS，但现在没有<code class="fe mt mu mv mk b">-k</code>，因为现在必须有一个有效的SSL证书，在我们指定了上述变量中的域名之后:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="6238" class="lh li iq mk b gy mo mp l mq mr">[setevoy@setevoy-arch-work ~] $ curl -I <a class="ae ks" href="https://cloud.example.org.ua" rel="noopener ugc nofollow" target="_blank">https://cloud.example.org.ua</a><br/>HTTP/2 200<br/>server: nginx/1.17.5<br/>…</span></pre><p id="d106" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在浏览器中:</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/e07d9778705239d2a2da1a848265e169.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/format:webp/0*BV79C3xrOydTolIQ.png"/></div></figure><h2 id="c957" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">Nextcloud配置</h2><p id="464b" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">接下来的步骤与<a class="ae ks" href="https://rtfm.co.ua/en/nextcloud-installing-server-on-debian-behind-nginx-with-php-fpm-and-client-on-arch-linux/" rel="noopener ugc nofollow" target="_blank"> NextCloud中的步骤相同:在NGINX后面的Debian上安装带有PHP-FPM的服务器，在Arch Linux上安装客户机</a> post，只是将MySQL的主机指定为Docker Compose文件中的服务，在当前示例中它将是<em class="ms">MySQL</em>——Docker将通过服务的名称对来自<code class="fe mt mu mv mk b">nextcloud_network</code>的相应容器的IP执行DNS解析:</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi my"><img src="../Images/5abd056124a5cdff4cf2772178dab43e.png" data-original-src="https://miro.medium.com/v2/resize:fit:842/format:webp/0*CBTbPkMRUW21VagV.png"/></div></figure><p id="5d25" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并且:</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/f33cb67278436a0cdfd5bb31cbc15e44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7fdgc5rHiXQVO1tH.png"/></div></div></figure><h2 id="8427" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">标签和完整的docker-compose文件</h2><p id="51b7" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">在最终确定这个设置之前，让我们更新我们的合成文件，而不是使用<em class="ms">最新的</em>标签——设置用于提取图像的严格版本——这在任何类似生产的设置中都是很好的做法。</p><p id="c727" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在撰写本报告时，它们是:</p><ul class=""><li id="faa1" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr mw kz la lb bi translated">jwilder/nginx-proxy:0.4.0</li><li id="fe19" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr mw kz la lb bi translated">jrcs/lets encrypt-nginx-proxy-companion:v 1.12</li><li id="0f27" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr mw kz la lb bi translated">马里亚布:10.4.10</li><li id="2dc1" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr mw kz la lb bi translated">下一代云:17 . 0 . 1-阿帕奇</li></ul><p id="b005" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，完整的文件将是下一个:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="579e" class="lh li iq mk b gy mo mp l mq mr">version: '3'<br/><br/>services:<br/><br/>  nginx-proxy:<br/>    image: jwilder/nginx-proxy:0.4.0<br/>    labels:<br/>      - "com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy=true"<br/>    container_name: nextcloud-proxy<br/>    networks:<br/>      - nextcloud_network<br/>    ports:<br/>      - 80:80<br/>      - 443:443<br/>    volumes:<br/>      - /data/nextcloud/nginx/vhost.d:/etc/nginx/vhost.d:rw<br/>      - /data/nextcloud/nginx/html:/usr/share/nginx/html:rw<br/>      - /data/nextcloud/nginx/certs:/etc/nginx/certs:ro<br/>      - /etc/localtime:/etc/localtime:ro<br/>      - /var/run/docker.sock:/tmp/docker.sock:ro<br/>    restart: unless-stopped<br/><br/>  letsencrypt:<br/>    image: jrcs/letsencrypt-nginx-proxy-companion:v1.12<br/>    container_name: nextcloud-letsencrypt<br/>    depends_on:<br/>      - nginx-proxy<br/>    networks:<br/>      - nextcloud_network<br/>    volumes:<br/>      - /data/nextcloud/nginx/vhost.d:/etc/nginx/vhost.d:rw<br/>      - /data/nextcloud/nginx/html:/usr/share/nginx/html:rw<br/>      - /data/nextcloud/nginx/certs:/etc/nginx/certs:rw<br/>      - /etc/localtime:/etc/localtime:ro<br/>      - /var/run/docker.sock:/var/run/docker.sock:ro<br/>    restart: unless-stopped<br/><br/>  mysql:<br/>    image: mariadb:10.4.10<br/>    container_name: nextcloud-mysql<br/>    networks:<br/>      - nextcloud_network<br/>    volumes:<br/>      - /data/nextcloud/mysql:/var/lib/mysql<br/>      - /etc/localtime:/etc/localtime:ro<br/>    environment:<br/>      - MYSQL_ROOT_PASSWORD=mysql-root-p@ssw0rd<br/>      - MYSQL_PASSWORD=nextcloud-p@ssw0rd<br/>      - MYSQL_DATABASE=nextcloud<br/>      - MYSQL_USER=nextcloud<br/>    restart: unless-stopped<br/><br/>  nextcloud-app:<br/>    image: nextcloud:17.0.1-apache<br/>    container_name: nextcloud-app<br/>    networks:<br/>      - nextcloud_network<br/>    depends_on:<br/>      - letsencrypt<br/>      - nginx-proxy<br/>      - mysql<br/>    volumes:<br/>      - /data/nextcloud/app/html:/var/www/html<br/>      - /data/nextcloud/app/config:/var/www/html/config<br/>      - /data/nextcloud/app/custom_apps:/var/www/html/custom_apps<br/>      - /data/nextcloud/app/data:/var/www/html/data<br/>      - /data/nextcloud/app/themes:/var/www/html/themes<br/>      - /etc/localtime:/etc/localtime:ro<br/>    environment:<br/>      - VIRTUAL_HOST=cloud.example.org.ua<br/>      - LETSENCRYPT_HOST=cloud.example.org.ua<br/>      - LETSENCRYPT_EMAIL=root@example.org.ua<br/>    restart: unless-stopped<br/><br/>networks:<br/>  nextcloud_network:</span></pre><p id="9bdc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">拉取图像:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="c769" class="lh li iq mk b gy mo mp l mq mr">root@setevoy-do-nextcloud-production:/opt/nextcloud# docker-compose -f nextcloud-compose.yml pull</span></pre><p id="54de" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">重新创建堆栈:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="ae1a" class="lh li iq mk b gy mo mp l mq mr">root@setevoy-do-nextcloud-production:/opt/nextcloud# docker-compose -f nextcloud-compose.yml up — force-recreate</span></pre><p id="4d3d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并测试是否一切正常。</p><h2 id="0473" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated"><code class="fe mt mu mv mk b">systemd</code></h2><p id="9463" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">这里的最后一步是为一个服务创建一个<code class="fe mt mu mv mk b">systemd</code>单元文件，正如在<a class="ae ks" href="https://rtfm.co.ua/linux-systemd-servis-dlya-docker-compose/" rel="noopener ugc nofollow" target="_blank">Linux:systemdсервсдляdocker compose</a>post(RUS)中所描述的，让我们将它保存为<code class="fe mt mu mv mk b">/etc/systemd/system/nextcloud.service</code>:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="3c01" class="lh li iq mk b gy mo mp l mq mr">[Unit]<br/>Description=Nextcloud stack<br/>Requires=docker.service<br/>After=docker.service<br/><br/>[Service]<br/>Restart=always<br/>WorkingDirectory=/opt/nextcloud<br/>ExecStart=/usr/local/bin/docker-compose -f nextcloud-compose.yml up<br/>ExecStop=/usr/local/bin/docker-compose -f nextcloud-compose.yml down                                                                                                                                                                          <br/><br/>[Install]<br/>WantedBy=multi-user.target</span></pre><p id="6c45" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行服务:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="34c9" class="lh li iq mk b gy mo mp l mq mr">root@setevoy-do-nextcloud-production:~# systemctl start nextcloud<br/>root@setevoy-do-nextcloud-production:~# systemctl status nextcloud<br/>● nextcloud.service — Nextcloud stack<br/>Loaded: loaded (/etc/systemd/system/nextcloud.service; disabled; vendor preset: enabled)<br/>Active: active (running) since Wed 2019–11–27 13:56:37 UTC; 4s ago<br/>Main PID: 16599 (docker-compose)<br/>Tasks: 7 (limit: 1167)<br/>Memory: 74.3M<br/>CGroup: /system.slice/nextcloud.service<br/>├─16599 /usr/local/bin/docker-compose -f nextcloud-compose.yml up<br/>…</span></pre><p id="8dd9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将其添加到自动启动:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="d8a0" class="lh li iq mk b gy mo mp l mq mr">root@setevoy-do-nextcloud-production:~# systemctl enable nextcloud<br/>Created symlink /etc/systemd/system/multi-user.target.wants/nextcloud.service → /etc/systemd/system/nextcloud.service.</span></pre><p id="4bda" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">完成了。</p></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><p id="1072" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ms">最初发布于</em> <a class="ae ks" href="https://rtfm.co.ua/en/nextcloud-running-in-docker-compose-on-debian-with-lets-encrypt-ssl/" rel="noopener ugc nofollow" target="_blank"> <em class="ms"> RTFM: Linux、DevOps和系统管理</em> </a> <em class="ms">。</em></p></div></div>    
</body>
</html>