<html>
<head>
<title>Jenkins X — TLS enabled Previews</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Jenkins X —启用TLS的预览</h1>
<blockquote>原文：<a href="https://itnext.io/jenkins-x-tls-enabled-previews-d04fa68c7ce9?source=collection_archive---------3-----------------------#2019-06-25">https://itnext.io/jenkins-x-tls-enabled-previews-d04fa68c7ce9?source=collection_archive---------3-----------------------#2019-06-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/0b279c3e5e54d19fc1ef6821bf4b18bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aghOvNrKQcp0ykD3hFKjaw.png"/></div></div></figure><p id="c7b2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">欢迎回到Jenkins X上的迷你系列。这一节将致力于为预览环境设置通配符证书和TLS。</p><p id="4a1e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<a class="ae kw" href="https://medium.com/@sboardwell/jenkins-x-securing-the-cluster-e1b9fcd8dd05" rel="noopener">我之前的帖子</a>中，我讨论了如何保护这两者:</p><ul class=""><li id="2eb2" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">GKE集群(对工作节点、pod和服务使用授权网络访问和专用IP范围)</li><li id="e86f" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://jenkins-x.io/" rel="noopener ugc nofollow" target="_blank"> Jenkins X </a>默认服务(为访问添加ssl证书和IP白名单)</li></ul><p id="b402" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">做完这些之后，是时候考虑将TLS添加到Jenkins X提供的动态预览环境中了。</p><p id="5b0d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">非常感谢<a class="ll lm ep" href="https://medium.com/u/2f0bedd32a9b?source=post_page-----d04fa68c7ce9--------------------------------" rel="noopener" target="_blank"> Pablo Loschi </a>在这里发表了他关于<a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/using-wildcard-certificates-with-cert-manager-in-kubernetes-and-replicating-across-all-namespaces-5ed1ea30bb93">在Kubernetes </a>中使用通配符证书管理器的原创故事。这是一个救生圈和信用的信用到期，所以谢谢你:-)。</p><p id="6074" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">和往常一样，我要向陪伴我进行这次小小冒险的伊利亚·沙伊斯尔塔诺夫(Ilya Shaisultanov)大声致意。</p></div><div class="ab cl ln lo hu lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ij ik il im in"><h1 id="f350" class="lu lv iq bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">预先提供一点信息</h1><p id="88cf" class="pw-post-body-paragraph jy jz iq ka b kb ms kd ke kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">在继续之前，我想请你对我们做出的几个技术决策做一个简短的解释。</p><ol class=""><li id="6fdd" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv mx ld le lf bi translated">我们决定使用单个域来支持<code class="fe my mz na nb b">*.domain</code>通配符证书。为此，我们在exposecontroller中指定了<code class="fe my mz na nb b">"{{.Service}}-{{.Namespace}}.{{.Domain}}"</code>，例如<br/><a class="ae kw" href="https://jenkins.jx.domain.xyz" rel="noopener ugc nofollow" target="_blank">https://Jenkins . JX . domain . XYZ</a>—&gt;<a class="ae kw" href="https://jenkins-jx.domain.xyz" rel="noopener ugc nofollow" target="_blank">https://Jenkins-JX . domain . XYZ</a></li><li id="87fa" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv mx ld le lf bi translated">如果使用DNS-01质询，LetsEncrypt将只发布通配符证书，因此我们需要使用受支持的DNS-01提供商之一的<a class="ae kw" href="https://docs.cert-manager.io/en/latest/tasks/issuers/setup-acme/dns01/index.html#supported-dns01-providers" rel="noopener ugc nofollow" target="_blank"/>。<br/>Google cloud DNS<a class="ae kw" href="https://docs.cert-manager.io/en/latest/tasks/issuers/setup-acme/dns01/google.html" rel="noopener ugc nofollow" target="_blank">和</a><a class="ae kw" href="https://docs.cert-manager.io/en/latest/tasks/issuers/setup-acme/dns01/cloudflare.html" rel="noopener ugc nofollow" target="_blank"> Cloudflare </a>都是在这种背景下测试的。</li></ol><figure class="nd ne nf ng gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/cd8eacada32450da9a14037d8c7b9fbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3fF6F67kta34M_9ahCgK-Q.png"/></div></div><figcaption class="nh ni gj gh gi nj nk bd b be z dk translated">从证书管理器网站</figcaption></figure><h1 id="35a0" class="lu lv iq bd lw lx nl lz ma mb nm md me mf nn mh mi mj no ml mm mn np mp mq mr bi translated">TL；不耐烦的博士</h1><p id="7c76" class="pw-post-body-paragraph jy jz iq ka b kb ms kd ke kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">这个帖子包含了相当多的信息，涵盖了各种半连接的主题。</p><p id="6ade" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然而，对于那些手头时间不多的人，我们将执行以下一般步骤:</p><ul class=""><li id="9b62" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">确保准备了正确的DNS记录</li><li id="8928" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">添加<a class="ae kw" href="https://github.com/mittwald/kubernetes-replicator" rel="noopener ugc nofollow" target="_blank"> kubernetes-replicator </a>(稍后预览时需要)</li><li id="0920" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">设置凭据启用DNS-01质询</li><li id="52c9" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">为我们的域创建通配符证书</li><li id="7477" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">添加所需的kubernetes-replicator注释</li><li id="2aa3" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">从新创建的证书创建带有TLS的Jenkins X预览</li></ul></div><div class="ab cl ln lo hu lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ij ik il im in"><h1 id="62a6" class="lu lv iq bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">关于在供应链管理中保守秘密的快速说明</h1><p id="c90d" class="pw-post-body-paragraph jy jz iq ka b kb ms kd ke kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">对于这个小问题，你可能有自己的解决办法，但我还是想提一下，如果只是为了安全起见。</p><p id="5f80" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Mozilla公司的sops是一个很棒的加密各种文件格式的小工具，包括YAML。来自<a class="ae kw" href="https://github.com/mozilla/sops" rel="noopener ugc nofollow" target="_blank">网站</a>:</p><blockquote class="nq nr ns"><p id="6bef" class="jy jz nt ka b kb kc kd ke kf kg kh ki nu kk kl km nv ko kp kq nw ks kt ku kv ij bi translated"><strong class="ka ir"> sops </strong>是一个加密文件编辑器，支持YAML、JSON、ENV、INI和二进制格式，用AWS KMS、GCP KMS、Azure Key Vault和PGP加密。</p></blockquote><p id="632b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们用它来加密我们的kubernetes秘密，从而允许我们用明文把它们保存在git中。以上面的<code class="fe my mz na nb b">01-clouddns-service-account.yaml</code>为例，加密文件如下所示:</p><pre class="nd ne nf ng gt nx nb ny nz aw oa bi"><span id="6f92" class="ob lv iq nb b gy oc od l oe of">$ cat cert-manager-utils/01-clouddns-service-account.yaml<br/>apiVersion: v1<br/>data:<br/> devops-dns-admin_token: <strong class="nb ir">ENC[AES256_GCM,data:&lt;redacted&gt;,type:str]</strong><br/>kind: Secret<br/>metadata:<br/> creationTimestamp: null<br/> name: clouddns-service-account<br/> namespace: cert-manager<br/>sops:<br/> kms:<br/> — arn: <strong class="nb ir">&lt;redacted&gt;</strong><br/> created_at: ‘2019–05–23T15:56:06Z’<br/> enc: &lt;redacted&gt;<br/> gcp_kms: []<br/> azure_kv: []<br/> lastmodified: ‘2019–05–23T18:40:17Z’<br/> mac: <strong class="nb ir">ENC[AES256_GCM,data:&lt;redacted&gt;,type:str]</strong><br/> pgp: []<br/> encrypted_suffix: _token<br/> version: 3.2.0</span></pre><p id="8625" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">未加密时，该文件看起来像:</p><pre class="nd ne nf ng gt nx nb ny nz aw oa bi"><span id="bf93" class="ob lv iq nb b gy oc od l oe of">$ sops -d cert-manager-utils/01-clouddns-service-account.yaml<br/>apiVersion: v1<br/>data:<br/> devops-dns-admin_token: <strong class="nb ir">&lt;redacted&gt;</strong><br/>kind: Secret<br/>metadata:<br/> creationTimestamp: null<br/> name: clouddns-service-account<br/> namespace: cert-manager</span></pre><p id="5d7e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一个额外的好处是能够将此与<code class="fe my mz na nb b">kubectl apply</code>和<a class="ae kw" href="http://www.gnu.org/software/bash/manual/bash.html#Process-Substitution" rel="noopener ugc nofollow" target="_blank">过程替代</a>相结合，以提供<strong class="ka ir">动态解密</strong>:</p><pre class="nd ne nf ng gt nx nb ny nz aw oa bi"><span id="131b" class="ob lv iq nb b gy oc od l oe of">kubectl apply -f &lt;(sops -d cert-manager-utils/01-clouddns-service-account.yaml)</span></pre><p id="5802" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">虽然，最后我真的不介意选择哪种方法，只要大家都在用加密:-)。</p><h1 id="3ed2" class="lu lv iq bd lw lx nl lz ma mb nm md me mf nn mh mi mj no ml mm mn np mp mq mr bi translated">确保存在正确的DNS条目</h1><p id="6661" class="pw-post-body-paragraph jy jz iq ka b kb ms kd ke kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">这是我在安装Jenkins X (搜索<em class="nt">“你将需要创建DNS记录】</em>)期间在<a class="ae kw" href="https://medium.com/@sboardwell/jenkins-x-securing-the-cluster-e1b9fcd8dd05" rel="noopener">早先的帖子中提到过的。</a></p><p id="ddc8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以防万一你在这里有一个<em class="nt">预装的</em> Jenkins X平台，请确保你有域名的DNS记录。以下是我之前帖子的摘录:</p><p id="cd1f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您需要创建指向以下内容的DNS记录(类型A ):</p><ul class=""><li id="7c70" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated"><code class="fe my mz na nb b">YOUR-DOMAIN</code> &gt;负载平衡器ip</li><li id="b019" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><code class="fe my mz na nb b">*.YOUR-DOMAIN</code> &gt;负载平衡器ip</li></ul><p id="3f1d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以使用以下命令找到负载平衡器ip:</p><pre class="nd ne nf ng gt nx nb ny nz aw oa bi"><span id="ddf0" class="ob lv iq nb b gy oc od l oe of">kubectl get svc jxing-nginx-ingress-controller -n kube-system -o'jsonpath={ .status.loadBalancer.ingress[0].ip</span></pre><h1 id="d691" class="lu lv iq bd lw lx nl lz ma mb nm md me mf nn mh mi mj no ml mm mn np mp mq mr bi translated">安装Kubernetes复制器</h1><p id="848c" class="pw-post-body-paragraph jy jz iq ka b kb ms kd ke kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">接下来我们将安装<a class="ae kw" href="https://github.com/mittwald/kubernetes-replicator" rel="noopener ugc nofollow" target="_blank"> kubernetes-replicator </a>。不幸的是，在撰写本文时，似乎还没有一个官方的掌舵图。然而，它非常容易安装，所以这里有一个快速安装v1.0.0的代码片段。</p><p id="7ec8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">只需复制并粘贴到shell中:</p><figure class="nd ne nf ng gt jr"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="db2e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在复制器安装完毕，我们可以添加通配符证书了。</p><h1 id="1c1c" class="lu lv iq bd lw lx nl lz ma mb nm md me mf nn mh mi mj no ml mm mn np mp mq mr bi translated">创建通配符证书</h1><p id="c949" class="pw-post-body-paragraph jy jz iq ka b kb ms kd ke kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">首先，我们需要DNS管理员帐户凭证，根据您的域注册商，可以创建如下:</p><ul class=""><li id="31ec" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated"><a class="ae kw" href="https://docs.cert-manager.io/en/latest/tasks/issuers/setup-acme/dns01/google.html" rel="noopener ugc nofollow" target="_blank">谷歌云域名系统</a></li><li id="e4d7" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://blog.darkedges.com/2019/02/17/cert-manager-kubernetes-cloudflare-dns/" rel="noopener ugc nofollow" target="_blank"> Cloudflare </a>(第<em class="nt">节“创建CloudFlare DNS颁发者”</em>)</li></ul><blockquote class="nq nr ns"><p id="7a6f" class="jy jz nt ka b kb kc kd ke kf kg kh ki nu kk kl km nv ko kp kq nw ks kt ku kv ij bi translated"><strong class="ka ir">提示:</strong>您不一定要使用多个发行者，但是同时指定这两个发行者允许您对多个域使用相同的配置文件。</p></blockquote><p id="43ed" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦创建了凭证，我们就可以创建必要的kubernetes资源。资源文件被分成3组:</p><ul class=""><li id="13c8" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">DNS管理机密</li><li id="5ec4" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">集群发行者</li><li id="2f40" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">证书本身</li></ul><pre class="nd ne nf ng gt nx nb ny nz aw oa bi"><span id="f236" class="ob lv iq nb b gy oc od l oe of">$ tree cert-manager-utils<br/>cert-manager-utils<br/>├── 01-clouddns-service-account.yaml      # cert-manager namespace<br/>├── 01-cloudflare-api-key.yaml            # cert-manager namespace<br/>├── 02-clusterissuer-prod.yaml            # kube-system namespace<br/>├── 02-clusterissuer-staging.yaml         # kube-system namespace<br/>├── 03-cluster-certificate-prod.yaml      # kube-system namespace<br/>└── 03-cluster-certificate-staging.yaml   # kube-system namespace</span></pre><p id="536e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nt">【暂存】</em><em class="nt">【生产】</em>都有文件。这些分别使用<a class="ae kw" href="https://letsencrypt.org/docs/staging-environment/" rel="noopener ugc nofollow" target="_blank"> LetsEncrypt staging和prod环境</a>。</p><p id="a7e6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我强烈建议在转移到LetsEncrypt prod环境之前，首先使用登台环境来确保配置是正确的。</p><h2 id="ac69" class="ob lv iq bd lw oi oj dn ma ok ol dp me kj om on mi kn oo op mm kr oq or mq os bi translated">DNS的秘密</h2><p id="9a1f" class="pw-post-body-paragraph jy jz iq ka b kb ms kd ke kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">下面的名字只是顺便提个建议。当然，您可以自由地为下面使用的密钥选择自己的名称，如<em class="nt">“devo PS-DNS-admin _ token”</em>等。</p><pre class="nd ne nf ng gt nx nb ny nz aw oa bi"><span id="459f" class="ob lv iq nb b gy oc od l oe of">cert-manager-utils/01-clouddns-service-account.yaml<br/>—-</span><span id="e4a9" class="ob lv iq nb b gy ot od l oe of">apiVersion: v1<br/>data:<br/> devops-dns-admin_token: REPLACE_WITH_BASE64_ENCODED_JSON<br/>kind: Secret<br/>metadata:<br/> creationTimestamp: null<br/> name: clouddns-service-account<br/> namespace: cert-manager</span><span id="f8be" class="ob lv iq nb b gy ot od l oe of"><br/>cert-manager-utils/01-cloudflare-api-key.yaml<br/>—-</span><span id="26f9" class="ob lv iq nb b gy ot od l oe of">apiVersion: v1<br/>data:<br/> api-key.txt: REPLACE_WITH_BASE64_ENCODED_API_KEY<br/>kind: Secret<br/>metadata:<br/> name: cloudflare-api-key<br/> namespace: cert-manager</span></pre><h2 id="0d4f" class="ob lv iq bd lw oi oj dn ma ok ol dp me kj om on mi kn oo op mm kr oq or mq os bi translated">LetsEncrypt暂存文件</h2><p id="c111" class="pw-post-body-paragraph jy jz iq ka b kb ms kd ke kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">这些资源将创建一个通配符证书，由LetsEncrypt临时环境颁发。</p><pre class="nd ne nf ng gt nx nb ny nz aw oa bi"><span id="f959" class="ob lv iq nb b gy oc od l oe of">cert-manager-utils/02-clusterissuer-staging.yaml<br/>---</span><span id="d257" class="ob lv iq nb b gy ot od l oe of">apiVersion: certmanager.k8s.io/v1alpha1<br/>kind: ClusterIssuer<br/>metadata:<br/>  name: letsencrypt-<strong class="nb ir">staging</strong>-dns<br/>spec:<br/>  acme:<br/>    server: <a class="ae kw" href="https://acme-staging-v02.api.letsencrypt.org/directory" rel="noopener ugc nofollow" target="_blank"><strong class="nb ir">https://acme-staging-v02.api.letsencrypt.org/directory</strong></a><br/>    email: <a class="ae kw" href="mailto:REPLACE_WITH_your.email@your.domain.com" rel="noopener ugc nofollow" target="_blank">REPLACE_WITH_your.email@your.domain.com</a><br/>    privateKeySecretRef:<br/>      name: letsencrypt-<strong class="nb ir">staging</strong><br/>    dns01:<br/>      providers:<br/>        - name: clouddns<br/>          clouddns:<br/>            serviceAccountSecretRef:<br/>              name: clouddns-service-account<br/>              key: devops-dns-admin_token<br/>            project: REPLACE_WITH_your-google-cloud-project<br/>        - name: cloudflare<br/>          cloudflare:<br/>            apiKeySecretRef:<br/>              key: api-key.txt<br/>              name: cloudflare-api-key<br/>            email: <a class="ae kw" href="mailto:REPLACE_WITH_your.email@your.domain.com" rel="noopener ugc nofollow" target="_blank">REPLACE_WITH_your.email@your.domain.com</a><br/></span><span id="48ad" class="ob lv iq nb b gy ot od l oe of">cert-manager-utils/03-cluster-certificate-staging.yaml<br/>---</span><span id="d410" class="ob lv iq nb b gy ot od l oe of">apiVersion: certmanager.k8s.io/v1alpha1<br/>kind: Certificate<br/>metadata:<br/>  name: jxing-nginx-ingress-controller-wildcard-<strong class="nb ir">staging</strong><br/>  namespace: kube-system<br/>spec:<br/>  secretName: jxing-nginx-ingress-controller-wildcard-<strong class="nb ir">staging</strong>-tls<br/>  issuerRef:<br/>    name: letsencrypt-<strong class="nb ir">staging</strong>-dns<br/>    kind: ClusterIssuer<br/>  commonName: REPLACE_WITH_YOUR_DOMAIN<br/>  dnsNames:<br/>    - REPLACE_WITH_YOUR_DOMAIN<br/>    - "*.REPLACE_WITH_YOUR_DOMAIN"<br/>  acme:<br/>    config:<br/>      - dns01:<br/>          provider: cloudflare<br/>        domains:<br/>          - REPLACE_WITH_YOUR_DOMAIN<br/>          - "*.REPLACE_WITH_YOUR_DOMAIN"<br/>      - dns01:<br/>          provider: clouddns<br/>        domains:<br/>          - REPLACE_WITH_YOUR_DOMAIN<br/>          - "*.REPLACE_WITH_YOUR_DOMAIN"</span></pre><h2 id="6e8e" class="ob lv iq bd lw oi oj dn ma ok ol dp me kj om on mi kn oo op mm kr oq or mq os bi translated">LetsEncrypt产品文件</h2><p id="61a6" class="pw-post-body-paragraph jy jz iq ka b kb ms kd ke kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">这里与staging文件的唯一区别是LetsEncrypt的<em class="nt"> "acme.server" </em>的值以及一些资源名称(prod vs staging，用于将两个资源组分开)。</p><pre class="nd ne nf ng gt nx nb ny nz aw oa bi"><span id="4d16" class="ob lv iq nb b gy oc od l oe of">cert-manager-utils/02-clusterissuer-prod.yaml<br/>---</span><span id="778b" class="ob lv iq nb b gy ot od l oe of">apiVersion: certmanager.k8s.io/v1alpha1<br/>kind: ClusterIssuer<br/>metadata:<br/>  name: letsencrypt-<strong class="nb ir">prod</strong>-dns<br/>spec:<br/>  acme:<br/>    server: <a class="ae kw" href="https://acme-v02.api.letsencrypt.org/directory" rel="noopener ugc nofollow" target="_blank"><strong class="nb ir">https://acme-v02.api.letsencrypt.org/directory</strong></a><br/>    email: <a class="ae kw" href="mailto:REPLACE_WITH_your.email@your.domain.com" rel="noopener ugc nofollow" target="_blank">REPLACE_WITH_your.email@your.domain.com</a><br/>    privateKeySecretRef:<br/>      name: letsencrypt-<strong class="nb ir">prod</strong><br/>    dns01:<br/>      providers:<br/>        - name: clouddns<br/>          clouddns:<br/>            serviceAccountSecretRef:<br/>              name: clouddns-service-account<br/>              key: devops-dns-admin_token<br/>            project: REPLACE_WITH_your-google-cloud-project<br/>        - name: cloudflare<br/>          cloudflare:<br/>            apiKeySecretRef:<br/>              key: api-key.txt<br/>              name: cloudflare-api-key<br/>            email: <a class="ae kw" href="mailto:REPLACE_WITH_your.email@your.domain.com" rel="noopener ugc nofollow" target="_blank">REPLACE_WITH_your.email@your.domain.com</a></span><span id="5033" class="ob lv iq nb b gy ot od l oe of">cert-manager-utils/03-cluster-certificate-prod.yaml<br/>---</span><span id="7785" class="ob lv iq nb b gy ot od l oe of">apiVersion: certmanager.k8s.io/v1alpha1<br/>kind: Certificate<br/>metadata:<br/>  name: jxing-nginx-ingress-controller-wildcard-<strong class="nb ir">prod</strong><br/>  namespace: kube-system<br/>spec:<br/>  secretName: jxing-nginx-ingress-controller-wildcard-<strong class="nb ir">prod</strong>-tls<br/>  issuerRef:<br/>    name: letsencrypt-<strong class="nb ir">prod</strong>-dns<br/>    kind: ClusterIssuer<br/>  commonName: REPLACE_WITH_YOUR_DOMAIN<br/>  dnsNames:<br/>    - REPLACE_WITH_YOUR_DOMAIN<br/>    - "*.REPLACE_WITH_YOUR_DOMAIN"<br/>  acme:<br/>    config:<br/>      - dns01:<br/>          provider: cloudflare<br/>        domains:<br/>          - REPLACE_WITH_YOUR_DOMAIN<br/>          - "*.REPLACE_WITH_YOUR_DOMAIN"<br/>      - dns01:<br/>          provider: clouddns<br/>        domains:<br/>          - REPLACE_WITH_YOUR_DOMAIN<br/>          - "*.REPLACE_WITH_YOUR_DOMAIN"</span></pre><h1 id="d108" class="lu lv iq bd lw lx nl lz ma mb nm md me mf nn mh mi mj no ml mm mn np mp mq mr bi translated">把所有的放在一起</h1><p id="dcba" class="pw-post-body-paragraph jy jz iq ka b kb ms kd ke kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">使用一个小小的bash函数，我们可以将所有东西放在一起:</p><figure class="nd ne nf ng gt jr"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="5aa1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这样就可以用了。</p><p id="fef4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe my mz na nb b">add_certificates staging</code> <br/>或<br/> <code class="fe my mz na nb b">add_certificates prod</code></p><p id="2a71" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">几分钟后，您应该会看到类似这样的内容:</p><figure class="nd ne nf ng gt jr"><div class="bz fp l di"><div class="og oh l"/></div></figure><h1 id="8f26" class="lu lv iq bd lw lx nl lz ma mb nm md me mf nn mh mi mj no ml mm mn np mp mq mr bi translated">在预览环境中使用通配符证书</h1><p id="3e64" class="pw-post-body-paragraph jy jz iq ka b kb ms kd ke kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">既然我们已经配置了所有必要的组件，那么将TLS添加到预览环境中就非常简单了。</p><h2 id="05ea" class="ob lv iq bd lw oi oj dn ma ok ol dp me kj om on mi kn oo op mm kr oq or mq os bi translated">检查exposecontroller版本</h2><p id="f361" class="pw-post-body-paragraph jy jz iq ka b kb ms kd ke kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">确保你的预览版<code class="fe my mz na nb b">requirements.yaml</code>是2.3.111或更高版本。</p><p id="01c3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">参见<a class="ae kw" href="https://github.com/sboardwell/jx-static-qs01/blob/master/charts/preview/requirements.yaml#L3..L10" rel="noopener ugc nofollow" target="_blank">本例</a>。</p><h2 id="f519" class="ob lv iq bd lw oi oj dn ma ok ol dp me kj om on mi kn oo op mm kr oq or mq os bi translated">添加空密码以复制您的通配符证书</h2><p id="d6d7" class="pw-post-body-paragraph jy jz iq ka b kb ms kd ke kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">添加一个空秘密<a class="ae kw" href="https://github.com/mittwald/kubernetes-replicator#2-create-empty-secret" rel="noopener ugc nofollow" target="_blank">，如这里所述</a>。kubernetes-replicator将检测这个秘密并将真正的秘密复制到预览名称空间中。</p><p id="eb47" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">见<a class="ae kw" href="https://github.com/sboardwell/jx-static-qs01/blob/master/charts/preview/templates/empty-tls-secret-for-kubernetes-replicator.yaml" rel="noopener ugc nofollow" target="_blank">本例</a>。</p><h2 id="b665" class="ob lv iq bd lw oi oj dn ma ok ol dp me kj om on mi kn oo op mm kr oq or mq os bi translated">编辑exposecontroller配置以添加TLS</h2><p id="4677" class="pw-post-body-paragraph jy jz iq ka b kb ms kd ke kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">将对以下属性进行更改:</p><pre class="nd ne nf ng gt nx nb ny nz aw oa bi"><span id="79a9" class="ob lv iq nb b gy oc od l oe of">tlsacme: true<br/>urltemplate: "\"{{.Service}}-{{.Namespace}}.{{.Domain}}\""<br/>tlsSecretName: "jxing-nginx-ingress-controller-wildcard-prod-tls"</span></pre><p id="ef08" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">参见<a class="ae kw" href="https://github.com/sboardwell/jx-static-qs01/blob/master/charts/preview/values.yaml#L9..L11" rel="noopener ugc nofollow" target="_blank">本例</a>。</p><h2 id="c38a" class="ob lv iq bd lw oi oj dn ma ok ol dp me kj om on mi kn oo op mm kr oq or mq os bi translated">成功！</h2><p id="76a7" class="pw-post-body-paragraph jy jz iq ka b kb ms kd ke kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">就是这样！每个预览版都将启用TLS并使用我们的通配符证书。</p><p id="1ad8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">恭喜你！</p><h1 id="2d52" class="lu lv iq bd lw lx nl lz ma mb nm md me mf nn mh mi mj no ml mm mn np mp mq mr bi translated">可选奖金设置</h1><p id="82b9" class="pw-post-body-paragraph jy jz iq ka b kb ms kd ke kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">nginx还有另一个不错的小选项<a class="ae kw" href="https://kubernetes.github.io/ingress-nginx/user-guide/tls/#default-ssl-certificate" rel="noopener ugc nofollow" target="_blank">为给定的入口控制器</a>设置一个“默认ssl证书”。</p><p id="6683" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">设置此选项后，会添加一个默认ssl证书作为任何入口请求的后备，因此无需在入口配置中设置<code class="fe my mz na nb b">spec.tls.secretName</code>。</p><p id="e015" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">目前，您需要在exposecontroller配置中设置<code class="fe my mz na nb b">tlsSecretName</code>,这意味着上述技巧无法使用。然而，首先非常感谢文森特·贝哈尔为<a class="ae kw" href="https://github.com/jenkins-x/exposecontroller/pull/178" rel="noopener ugc nofollow" target="_blank">增加了选项</a>。</p><p id="7cd3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您确实希望将默认的ssl证书添加到nginx控制器中，这里有一个bash小代码片段可以做到这一点。</p><figure class="nd ne nf ng gt jr"><div class="bz fp l di"><div class="og oh l"/></div></figure></div><div class="ab cl ln lo hu lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ij ik il im in"><p id="4e64" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以，这就是关于Jenkins X的迷你系列的第二部分。我希望它能有所帮助。</p><p id="0a43" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在第三部分中，我将介绍我们如何在Jenkins X平台中管理Jenkins服务器，添加OAuth，更新插件和配置，以及在git中保存作业配置。敬请关注…</p></div></div>    
</body>
</html>