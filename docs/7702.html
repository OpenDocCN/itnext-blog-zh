<html>
<head>
<title>TrueNAS Scale Low Power Setup🌱</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TrueNAS Scale低功耗设置🌱</h1>
<blockquote>原文：<a href="https://itnext.io/truenas-scale-low-power-setup-db62acbeee69?source=collection_archive---------0-----------------------#2022-12-24">https://itnext.io/truenas-scale-low-power-setup-db62acbeee69?source=collection_archive---------0-----------------------#2022-12-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2062" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">一个人能走多低？修补实验…</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/4b4ce72a259b9cc1fa34f0a0c3873c79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1236/format:webp/1*Qeg_zo79irVmyOYJYdwEFw.png"/></div></figure><p id="cd04" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">不久前，我写了一篇关于我的备份解决方案的博文。自那以后，我所在的欧洲发生了很多变化，最明显的是能源危机。在过去的12个月里，电力和天然气价格大幅上涨，这直接影响了像我这样的个体经营者。在此期间，我的电费从€的每千瓦时0.21英镑涨到了€的0.72英镑。这是由多种因素造成的，但在荷兰，电价是与天然气价格挂钩的。由于天然气价格上涨是由于……<em class="lk">ehm</em>、地缘政治事件……(我就不说了)；电价也是如此。</p><p id="b027" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">可以肯定地说，我没有非常复杂的家庭实验室设置，远非如此。我倾向于成为一个技术极简主义者，试图用我需要的最小的服务足迹来有效地满足我的需求，同时重用旧的台式机来运行家中的关键服务。然而，即使在我的小设置中，一台TrueNAS服务器在角落里嗡嗡作响，每小时消耗60W的电力，按照我的提供商向我收取的每千瓦时电力的当前价格，每月运行€31.10英镑。因为这台机器大部分时间都闲置着，这是浪费钱，所以我决定做点什么。</p><h1 id="2aff" class="ll lm iq bd ln lo lp lq lr ls lt lu lv jw lw jx lx jz ly ka lz kc ma kd mb mc bi translated">评估</h1><p id="e175" class="pw-post-body-paragraph kn ko iq kp b kq md jr ks kt me ju kv kw mf ky kz la mg lc ld le mh lg lh li ij bi translated">对我来说，对于一台空闲的服务器来说，60W听起来很耗电。因此，为了看看我能做些什么，我列出了我用于TrueNAS服务器的旧PC的所有规格:</p><ul class=""><li id="79fb" class="mi mj iq kp b kq kr kt ku kw mk la ml le mm li mn mo mp mq bi translated">华硕Z170A主板</li><li id="3c31" class="mi mj iq kp b kq mr kt ms kw mt la mu le mv li mn mo mp mq bi translated">带DeepCool(双风扇)冷却器的英特尔i7 6700K CPU</li><li id="536a" class="mi mj iq kp b kq mr kt ms kw mt la mu le mv li mn mo mp mq bi translated">4个8GB DDR4 RAM模块</li><li id="7e1b" class="mi mj iq kp b kq mr kt ms kw mt la mu le mv li mn mo mp mq bi translated">256GB NVME M.2固态硬盘</li><li id="2260" class="mi mj iq kp b kq mr kt ms kw mt la mu le mv li mn mo mp mq bi translated">4个Western Digital RED 3.5英寸硬盘</li><li id="ee68" class="mi mj iq kp b kq mr kt ms kw mt la mu le mv li mn mo mp mq bi translated">海盗船CX600M PSU</li><li id="e5b2" class="mi mj iq kp b kq mr kt ms kw mt la mu le mv li mn mo mp mq bi translated">3个BeQuiet 120mm毫米机箱风扇</li></ul><p id="9c6b" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">出于本文的目的，我将讨论三种主要的功耗。</p><h2 id="587d" class="mw lm iq bd ln mx my dn lr mz na dp lv kw nb nc lx la nd ne lz le nf ng mb nh bi translated">CPU功耗</h2><p id="630a" class="pw-post-body-paragraph kn ko iq kp b kq md jr ks kt me ju kv kw mf ky kz la mg lc ld le mh lg lh li ij bi translated">英特尔i7 6700K CPU的TDP(热设计功率)为95W。这意味着在满载时，CPU将消耗高达95瓦的电能，但这可能更多地取决于CPU是否超频。当CPU空闲时，BIOS(如果启用了适当的设置)将利用电源优化来降低CPU的功耗。这种降低和/或优化功耗的能力统称为C状态，目前共有6种。根据CPU的年龄，您可能会有一些较低的C-状态(1、2和3)和较新的CPU的C6。C状态越高，CPU中空闲的电路越多，CPU消耗的功率越少。</p><p id="3cab" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">p状态也旨在降低CPU的功耗，但通过操纵电压和频率来降低功耗。</p><h2 id="41ac" class="mw lm iq bd ln mx my dn lr mz na dp lv kw nb nc lx la nd ne lz le nf ng mb nh bi translated">磁盘功耗</h2><p id="f2b6" class="pw-post-body-paragraph kn ko iq kp b kq md jr ks kt me ju kv kw mf ky kz la mg lc ld le mh lg lh li ij bi translated">像Western Digital Red这样的旋转磁盘即使在空闲时(不读或写)也要消耗大量的能量来保持旋转；事实上，根据我的测量，每个驱动器大约3-5W，稍后您将会看到。相比之下，SSD在空闲时消耗的功率要少得多，但就每GB成本而言，它在NAS设置中要贵得多，我认为不值得。</p><h2 id="b9dc" class="mw lm iq bd ln mx my dn lr mz na dp lv kw nb nc lx la nd ne lz le nf ng mb nh bi translated">电源消耗</h2><p id="3151" class="pw-post-body-paragraph kn ko iq kp b kq md jr ks kt me ju kv kw mf ky kz la mg lc ld le mh lg lh li ij bi translated">电源(PSU)通常是电脑构建中被忽视的部分，然而，质量差的电源可能会对一些顶级组件造成严重破坏。我总是选择体面的电源在我所有的建设，我从来没有一个组件死在我一直在建设计算机，足够说！</p><p id="8cf0" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">PSU有不同的形状和形式，但只要说我总是选择至少80+金PSU就够了。这意味着在100%负载下，PSU的效率将达到87%。负载为50%时，效率为90%。这是PSU的一个重要特征，越接近PSU额定输出最大功率的50%，效率就越高。换句话说，600瓦的PSU在300瓦时效率最高。同样，在&gt; 50%和&lt; 50%时，PSU的效率越来越低。在60W的功率下，我的服务器消耗了电源额定输出的11%，效率不是很高。</p><h1 id="e969" class="ll lm iq bd ln lo lp lq lr ls lt lu lv jw lw jx lx jz ly ka lz kc ma kd mb mc bi translated">BIOS调整—瓦特可以完成吗？；)</h1><p id="9b31" class="pw-post-body-paragraph kn ko iq kp b kq md jr ks kt me ju kv kw mf ky kz la mg lc ld le mh lg lh li ij bi translated">为了降低我的TrueNAS服务器的功耗，我进行了大量的反复试验。我将总结我所做的，并在最后揭示当前的功耗。</p><h2 id="1164" class="mw lm iq bd ln mx my dn lr mz na dp lv kw nb nc lx la nd ne lz le nf ng mb nh bi translated">1.BIOS更新</h2><p id="0693" class="pw-post-body-paragraph kn ko iq kp b kq md jr ks kt me ju kv kw mf ky kz la mg lc ld le mh lg lh li ij bi translated">任何新机器的第一步都是刷新新的BIOS固件。这个过程因主板而异，但对我来说，我是通过BIOS中的内置工具下载的。大多数现代主板都是这样工作的，但是对于一些主板，你可以通过u盘手动操作。请阅读您的主板说明，如果您愿意，也可以跳过这一步。</p><h2 id="5680" class="mw lm iq bd ln mx my dn lr mz na dp lv kw nb nc lx la nd ne lz le nf ng mb nh bi translated">2.CPU时钟不足</h2><p id="4b13" class="pw-post-body-paragraph kn ko iq kp b kq md jr ks kt me ju kv kw mf ky kz la mg lc ld le mh lg lh li ij bi translated">欠频实际上是超频的对立面，有两个主要目标。第一种是通过给芯片本身提供较少的电压来降低CPU在负载下的温度。第二，由于温度较低，是为了防止热节流。应该注意的是，在空闲时，欠锁并不会对CPU功耗产生任何影响，因为C状态已经相当有效地管理了这一点。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="nj nk di nl bf nm"><div class="gh gi ni"><img src="../Images/c9766915c8f315c8726508093a3ef6e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JFncamWrDyqSNPzYA1eyIQ.jpeg"/></div></div></figure><p id="e64d" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在上面的BIOS设置中，我将“CPU内核/高速缓存电压”设置修改为自适应模式，并将“偏移模式符号”设置为“-”或“-”。这实际上减去了上面截图中“附加Turbo模式CPU内核电压”中设置的电压。在这种情况下，CPU的时钟不足0.500V。所有其他设置都保留为自动。</p><h2 id="d6b1" class="mw lm iq bd ln mx my dn lr mz na dp lv kw nb nc lx la nd ne lz le nf ng mb nh bi translated">3.CPU调整</h2><p id="37e3" class="pw-post-body-paragraph kn ko iq kp b kq md jr ks kt me ju kv kw mf ky kz la mg lc ld le mh lg lh li ij bi translated">在Tweakers paradise设置中，我将一切都设置为自动。英特尔SpeedStep也保持启用状态，但是我禁用了“加速模式”,因为我不需要此功能。</p><div class="kg kh ki kj gt ab cb"><figure class="nn kk no np nq nr ns paragraph-image"><div role="button" tabindex="0" class="nj nk di nl bf nm"><img src="../Images/001ce1751ffef6358dd38662d0b6d1e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*dmDjwgt0Xc7KJJiRvkG6ZA.jpeg"/></div></figure><figure class="nn kk no np nq nr ns paragraph-image"><div role="button" tabindex="0" class="nj nk di nl bf nm"><img src="../Images/ad8587cd16fdbe73f4efc8f89afe2509.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*cv9l41wvNZwMzHL7lvVu-w.jpeg"/></div></figure></div><p id="4f7f" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">然后我禁用了“超线程”。HT使用更多的CPU能力，因为它允许CPU内核在更长的时间内保持活动状态，同样是为了满足我在大部分时间处于空闲状态的Linux服务器上的需求，HT会与节能产生相反的效果。虚拟化也被禁用了，因为我不打算使用这台机器来运行虚拟机(目前还没有…也许将来会有)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="nj nk di nl bf nm"><div class="gh gi ni"><img src="../Images/61a752c953bcea1b865a0f95f69be7b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BRSk5A8cUXdbvRYekwK8Cg.jpeg"/></div></div></figure><p id="f060" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在“CPU电源管理控制”下，还有一个地方可以禁用SpeedStep，我假设这两个地方显示的设置是相同的。不管怎样，当它出现在这个屏幕上时，在这里也被禁用了。我把C状态设置为自动。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="nj nk di nl bf nm"><div class="gh gi ni"><img src="../Images/efa1ed45839e3352b66f3acca280e752.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lv3LloTCZSYzqP5IoZ3XXQ.jpeg"/></div></div></figure><h2 id="d345" class="mw lm iq bd ln mx my dn lr mz na dp lv kw nb nc lx la nd ne lz le nf ng mb nh bi translated">4.外围设备</h2><p id="9ee4" class="pw-post-body-paragraph kn ko iq kp b kq md jr ks kt me ju kv kw mf ky kz la mg lc ld le mh lg lh li ij bi translated">主板包含许多消耗功率的附加电路。从PCI express插槽到内置音频、USB等等。即使你不使用它们，它们在活动时也会消耗少量的能量。以下是我在板上禁用的内容:</p><ul class=""><li id="e775" class="mi mj iq kp b kq kr kt ku kw mk la ml le mm li mn mo mp mq bi translated">禁用霹雳和霹雳PCIe支持</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="nj nk di nl bf nm"><div class="gh gi ni"><img src="../Images/b7bd7c46c17f9a8e7b939838f1ff16c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bsSX4J5BTyx57aRBtuZdsw.jpeg"/></div></div></figure><ul class=""><li id="29a2" class="mi mj iq kp b kq kr kt ku kw mk la ml le mm li mn mo mp mq bi translated">禁用高清音频，主板内置音频控制器</li><li id="b5fb" class="mi mj iq kp b kq mr kt ms kw mt la mu le mv li mn mo mp mq bi translated">禁用USB 3.1充电支持</li><li id="3d2f" class="mi mj iq kp b kq mr kt ms kw mt la mu le mv li mn mo mp mq bi translated">已禁用led设计开关。这会点亮主板上的内置LED，使其具有未来感。因为我不太喜欢LED，所以我把它关掉了。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="nj nk di nl bf nm"><div class="gh gi ni"><img src="../Images/91217c08c9620a9c0380a5df0c526d1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y7HPx-s2VE_665XTlBVKhA.jpeg"/></div></div></figure><ul class=""><li id="d148" class="mi mj iq kp b kq kr kt ku kw mk la ml le mm li mn mo mp mq bi translated">已启用内置PCI电源管理设置。这应该会关闭未使用的PCI设备。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="nj nk di nl bf nm"><div class="gh gi ni"><img src="../Images/a452e47b4bd2762a00b59d78bc27cf40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fbHrzyfP0H1W1CwuTOuMnA.jpeg"/></div></div></figure><ul class=""><li id="6264" class="mi mj iq kp b kq kr kt ku kw mk la ml le mm li mn mo mp mq bi translated">禁用所有USB 3.1端口-这些是主板背面的蓝色端口，很容易识别。从现在开始，只有黑色端口可以使用——方便键盘和鼠标使用。</li></ul><div class="kg kh ki kj gt ab cb"><figure class="nn kk no np nq nr ns paragraph-image"><div role="button" tabindex="0" class="nj nk di nl bf nm"><img src="../Images/140c89d9a09a9679baee3cbb6f2b629b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*28_F-jWzQ_4x5HgVllU4OQ.jpeg"/></div></figure><figure class="nn kk no np nq nr ns paragraph-image"><div role="button" tabindex="0" class="nj nk di nl bf nm"><img src="../Images/f99cd77dc93a8f3ad963dcb3152d1c60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*I4BJIkBV0qK7xvrUekv4eQ.jpeg"/></div></figure></div><h1 id="6c9c" class="ll lm iq bd ln lo lp lq lr ls lt lu lv jw lw jx lx jz ly ka lz kc ma kd mb mc bi translated">TrueNAS节能优化</h1><p id="379f" class="pw-post-body-paragraph kn ko iq kp b kq md jr ks kt me ju kv kw mf ky kz la mg lc ld le mh lg lh li ij bi translated">虽然其中一些技巧是显而易见的，但我还是会在这里列出来。这些是我已经更改的各种设置和我在服务器上实现的软件实用程序。但是应该指出的是，我只将我的服务器用于备份，即没有实时编辑，没有Plex服务器，只是一个普通的旧文件系统，现在使用rclone定期从我网络上的设备中收集文件。这意味着我确切地知道服务器什么时候会忙，其余的时间我知道它会空闲。</p><h2 id="375a" class="mw lm iq bd ln mx my dn lr mz na dp lv kw nb nc lx la nd ne lz le nf ng mb nh bi translated">1.使用powertop</h2><p id="dc37" class="pw-post-body-paragraph kn ko iq kp b kq md jr ks kt me ju kv kw mf ky kz la mg lc ld le mh lg lh li ij bi translated">对于我来说，我不记得TrueNAS Scale是否配有powertop，但我认为它配有。我简单地运行了命令:</p><p id="ff83" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><code class="fe nt nu nv nw b">powertop --auto-tune</code></p><p id="09b8" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这个命令将自动指示Linux内核对它能找到合适的电源设置的所有硬件应用所需的电源优化。这马上救了1-2W。</p><h2 id="cb3d" class="mw lm iq bd ln mx my dn lr mz na dp lv kw nb nc lx la nd ne lz le nf ng mb nh bi translated">2.降速3.5英寸磁盘</h2><p id="fe87" class="pw-post-body-paragraph kn ko iq kp b kq md jr ks kt me ju kv kw mf ky kz la mg lc ld le mh lg lh li ij bi translated">如上所述，旋转磁盘非常耗电！为了省电，请在闲置一段时间后关闭它们。这需要双管齐下的方法。首先，将TrueNAS的日志从旋转磁盘池中移出(如果这是您在初始设置期间配置它的方式),并移到您的操作系统驱动器(理想情况下不是旋转磁盘)上。这可以通过高级日志设置下的TrueNAS UI来完成。即使您的主驱动器是一个旋转的磁盘，只有一个(或两个)旋转也比让它们都耗电要好。如果你的主操作系统磁盘是SD卡或闪存盘，我建议你不要这样做——它会立刻磨损硬盘。我不建议在闪存卡或SD卡上运行服务器，因为它们对高读/写周期非常敏感，相当不可靠。</p><p id="3c24" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">其次，一旦你把文件从旋转的磁盘上移走，<a class="ae lj" href="https://github.com/ngandrass/truenas-spindown-timer" rel="noopener ugc nofollow" target="_blank">把这个脚本安装到你的服务器上</a>。此降速计时器脚本将定期检查您的旋转磁盘池的活动，如果没有活动，它将使磁盘降速。您可以完全控制等待的时间、磁盘必须空闲多长时间等。自述文件中的说明非常清楚，它对我来说完美无缺。通过TrueNAS UI将脚本添加到init / boot脚本中，您就可以开始工作了。</p><h2 id="6499" class="mw lm iq bd ln mx my dn lr mz na dp lv kw nb nc lx la nd ne lz le nf ng mb nh bi translated">3.整合工作</h2><p id="af0e" class="pw-post-body-paragraph kn ko iq kp b kq md jr ks kt me ju kv kw mf ky kz la mg lc ld le mh lg lh li ij bi translated">整合所有计划任务，使它们一起运行或尽可能靠近运行。ZFS清理任务、备份作业、快照、云上传等。都可以在几个小时内运行，具体取决于数据集的大小。目的是最大化硬件的空闲时间，最小化硬件的睡眠/唤醒周期。</p><h1 id="36ca" class="ll lm iq bd ln lo lp lq lr ls lt lu lv jw lw jx lx jz ly ka lz kc ma kd mb mc bi translated">结果——成功了吗？</h1><p id="f5eb" class="pw-post-body-paragraph kn ko iq kp b kq md jr ks kt me ju kv kw mf ky kz la mg lc ld le mh lg lh li ij bi translated">响亮的是。只需调整BIOS，降低CPU功耗，并禁用不必要的硬件，墙壁电源测量值就降至37W左右。在为旋转磁盘ZFS池实施降速脚本后，我现在让我的服务器以28W的功率空闲。那是相当不同的！</p><p id="ae2e" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我还测量了有和没有机箱风扇和CPU冷却器的情况。CPU冷却器，因为它是相当低效的，使用3和4W之间。我可以用一个被动冷却器来代替它，这样可以将我的功耗降低23到24W。对于ATX的外形来说，这是非常高效的，我对结果非常满意。</p><p id="fcb7" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">也就是说，当我的备份服务器的唯一备份计划设置为每周运行一次时，我仍然无法证明全天运行备份服务器是合理的。目前，我有一个智能插头，它会在每周的固定时间自动启动，触发“打开交流电”BIOS设置并给机器通电。我留出几个小时来运行我的备份流程，并完成所有其他TrueNAS日常工作。然后，cronjob会在插件自动关闭之前关闭服务器。感谢Google Home！这当然是最节能的设置，同样，我使用我所需要的，而不是燃烧树木来毫无理由地闲置机器。</p><p id="77bb" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我希望这能帮助其他人降低旧硬件的功耗！</p></div><div class="ab cl nx ny hu nz" role="separator"><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc"/></div><div class="ij ik il im in"><p id="4033" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果你从这篇文章中受益，请考虑关注我，这是在媒体上建立追随者基础并确保我的努力到达目标受众的唯一方法。</p></div></div>    
</body>
</html>