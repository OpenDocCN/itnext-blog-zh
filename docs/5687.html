<html>
<head>
<title>Easy Modular Monolith — Part 1 — MVP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">简易模块化整体结构—第1部分— MVP</h1>
<blockquote>原文：<a href="https://itnext.io/easy-modular-monolith-part-1-mvp-d57f47935e24?source=collection_archive---------2-----------------------#2021-05-03">https://itnext.io/easy-modular-monolith-part-1-mvp-d57f47935e24?source=collection_archive---------2-----------------------#2021-05-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="72bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如今，模块化整体架构方法越来越受欢迎。不是没有原因的。它允许更容易地开始一个项目，更“抗坏设计”，更容易部署和维护。<br/>更重要的是，这是进入微服务世界的第一步！</p><p id="8fb3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如何使用<strong class="jp ir">实现这样的架构。网芯</strong>和<strong class="jp ir">联发科</strong>带着<strong class="jp ir"> CQRS* </strong>引擎盖下？</p><h1 id="c994" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">第一步——分析</h1><p id="d992" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">创建一个复杂系统最重要也是最关键的一步是分析所有的功能性和非功能性需求！这可以通过多种方式实现，但所有方式都有一个共同点——与企业/利益相关者沟通。当我们试图创建一个模块化的整体系统时，我们需要理解到底什么可以并且应该被分割成模块。</p><p id="9cc3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本文不会关注这一部分，但我认为这是值得一提的，因为这是创建工作产品的最重要的步骤之一。<br/>进行这种分析的一个很好的工具是使用<strong class="jp ir"> <em class="lo">事件风暴研讨会* </em> </strong> <em class="lo">。</em></p><h1 id="4d70" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">系统结构</h1><h2 id="2a98" class="lp km iq bd kn lq lr dn kr ls lt dp kv jy lu lv kz kc lw lx ld kg ly lz lh ma bi translated">第一个问题——什么是模块？</h2><p id="9ad8" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">让我们问问维基百科:</p><blockquote class="mb mc md"><p id="085a" class="jn jo lo jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated"><strong class="jp ir">模块化编程</strong>是一种<a class="ae mh" href="https://en.wikipedia.org/wiki/Software_design" rel="noopener ugc nofollow" target="_blank">软件设计</a>技术，它强调将一个<a class="ae mh" href="https://en.wikipedia.org/wiki/Computer_program" rel="noopener ugc nofollow" target="_blank">程序</a>的功能分成独立的、可互换的<strong class="jp ir">模块</strong>，这样每个模块都包含执行所需功能的一个方面所需的一切。</p></blockquote><h1 id="144d" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">语境</h1><p id="ce2a" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">假设我们试图创建一个“历史”功能，负责跟踪和存储系统中发生的数据/事件。<br/>在第一步(<strong class="jp ir">分析</strong>)之后，我们决定我们应该有两个模块——一个负责“产品”(产品的CRUD所有业务规则)，另一个负责存储产品模块中发生的变化的信息。</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi mi"><img src="../Images/8e2727027576bb46a4b07a0e50ad3046.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JJD0jTdOkC7hMX1QDyShfQ.png"/></div></div></figure><h2 id="96a5" class="lp km iq bd kn lq lr dn kr ls lt dp kv jy lu lv kz kc lw lx ld kg ly lz lh ma bi translated">上述设计如何符合“模块”的定义？</h2><ul class=""><li id="42cb" class="mu mv iq jp b jq lj ju lk jy mw kc mx kg my kk mz na nb nc bi translated">这两个模块都包含它们自己的基础设施/域/应用层，它们封装了执行功能所需的全部逻辑。</li><li id="49cd" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated">尽管它们共享一个MVP版本的数据库，但是它们被“模式”分开。</li><li id="5614" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated">模块之间的必要通信由事件以及(将来)由这些模块公开的入口点接口来保证。</li><li id="28ef" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated">模块不共享任何可以将它们相互耦合的逻辑。</li></ul><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/c1ab7e73bdbb8374ad8432e7b3a4ff78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1304/format:webp/1*Gope6IBKhm-Coi0MWunjtQ.png"/></div></figure><h2 id="5871" class="lp km iq bd kn lq lr dn kr ls lt dp kv jy lu lv kz kc lw lx ld kg ly lz lh ma bi translated">流程:</h2><p id="f700" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">我们的<strong class="jp ir">产品模块</strong>将成为事件生产者。它将使用MediatR发布事件。我们将在<strong class="jp ir"> ModularMonolith中存储我们所有的事件契约。合同</strong>项目。<br/> <strong class="jp ir"> ModularMonolith。合同</strong>项目将被用作历史和产品模块中的参考。它不应该包含任何外部NuGet包，而应该包含MediatR。</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi nj"><img src="../Images/78d580da73b8971e9daade9b46a3ad0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NEr1iT9PZOUNDYX89CAFzQ.png"/></div></div><figcaption class="nk nl gj gh gi nm nn bd b be z dk translated">合同示例</figcaption></figure><p id="03cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，当我们有一份合同时，让我们看看如何使用它:</p><p id="556e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">执行顺序如下所示:</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi no"><img src="../Images/612f761d7959c02be1222253594fdb56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZwHUMPnM3ib4ozQhWGi8OQ.png"/></div></div></figure><p id="2c04" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个怎么翻译成代码？<br/>在API项目中，让我们创建一个产品控制器:</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi np"><img src="../Images/01261745bc07a3133d0704a041e4e71f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H2CKKQMwjIzM1gVfs2QxRw.png"/></div></div></figure><p id="b554" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ProductController包含执行“命令”的简单逻辑。该动作的命令和命令处理程序存储在<strong class="jp ir">产品模块</strong>本身中。<br/>让我们来看看:</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi nq"><img src="../Images/858ccc659e95bb2bf05fb089f83a2a3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*idHN6SfFfhxPD0fzUnUFvA.png"/></div></div></figure><p id="6648" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上述命令处理程序最重要的部分是包含_mediator.Publish的那一行。mediator现在发布的事件将由所有订阅者处理。在我们的例子中——模块历史<strong class="jp ir">。<br/>让我们来看看:</strong></p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi nr"><img src="../Images/b4d9c34413e61ae1671aa6070b1aee89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pZ8Vu_Xy7WrdC9waMXSY7g.png"/></div></div></figure><p id="d12e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在<strong class="jp ir">产品模块</strong>中产生的事件由<strong class="jp ir">历史模块</strong>处理！</p><figure class="mj mk ml mm gt mn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><h2 id="641d" class="lp km iq bd kn lq lr dn kr ls lt dp kv jy lu lv kz kc lw lx ld kg ly lz lh ma bi translated">共享数据库—唯一模式</h2><p id="1863" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">为了简单起见，在MVP版本中，我共享一个数据库实例。我通过将每个模块表分成一个单独的模式来保证数据的独立性。这可以通过EF内核轻松实现。</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi nu"><img src="../Images/31487e672c51d1258f91c6eac8c2e40c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rYlMj9BcHgxQ1604W_geMw.png"/></div></div><figcaption class="nk nl gj gh gi nm nn bd b be z dk translated">设置模式</figcaption></figure><p id="2fbe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">警告是每个模块不应该直接使用来自其他模式的表！</p><h1 id="ab2b" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">总结:</h1><ul class=""><li id="35a2" class="mu mv iq jp b jq lj ju lk jy mw kc mx kg my kk mz na nb nc bi translated">WebApi项目是应用程序的入口点。</li><li id="c961" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated">每个模块都封装了执行功能所需的全部逻辑。</li><li id="0986" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated">模块使用MediatR事件相互通信。</li><li id="7e12" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated">数据库是共享的，但是我们通过用模式分隔表来保证独立性。</li></ul><h2 id="774c" class="lp km iq bd kn lq lr dn kr ls lt dp kv jy lu lv kz kc lw lx ld kg ly lz lh ma bi translated"><strong class="ak">优点:</strong></h2><ul class=""><li id="4d50" class="mu mv iq jp b jq lj ju lk jy mw kc mx kg my kk mz na nb nc bi translated">非常灵活——允许非常快速地更改模块限制的上下文。</li><li id="1cd2" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated">更容易测试(集成测试)。</li><li id="3ce6" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated">更容易添加可观察性(日志/度量)。</li><li id="a29d" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated">开发和维护“分布式事务”要容易得多。</li><li id="f285" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated">简单的基础设施。</li><li id="1c3c" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated">简单的部署/发布。</li></ul><h2 id="c479" class="lp km iq bd kn lq lr dn kr ls lt dp kv jy lu lv kz kc lw lx ld kg ly lz lh ma bi translated">缺点:</h2><ul class=""><li id="8e22" class="mu mv iq jp b jq lj ju lk jy mw kc mx kg my kk mz na nb nc bi translated">可扩展性问题—所有模块都作为单个实例托管。</li><li id="5da9" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated">数据库可伸缩性的问题—共享数据库实例。</li><li id="6984" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated">可能违反数据独立性。</li><li id="6a15" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated">数据一致性的潜在问题(如果多个通知使用者中的一个失败)。</li></ul><h1 id="c3b9" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">在下一部分:</h1><ul class=""><li id="9300" class="mu mv iq jp b jq lj ju lk jy mw kc mx kg my kk mz na nb nc bi translated">发件箱模式—保证事件传递。</li></ul><div class="nv nw gp gr nx ny"><a href="https://ridikk12.medium.com/easy-modular-monolith-part-2-the-outbox-pattern-b4566724fb68" rel="noopener follow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd ir gy z fp od fr fs oe fu fw ip bi translated">简易模块化整体结构—第2部分—发件箱模式</h2><div class="of l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">ridikk12.medium.com</p></div></div><div class="og l"><div class="oh l oi oj ok og ol ms ny"/></div></div></a></div><h1 id="8b31" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated"><strong class="ak">未来(此列表可以更改):</strong></h1><ul class=""><li id="b3f2" class="mu mv iq jp b jq lj ju lk jy mw kc mx kg my kk mz na nb nc bi translated">可观察性。</li><li id="de3b" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated">数据库方法(多个数据源)。</li><li id="8615" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated">准备微服务(用RabbitMq代替MediatR)。</li><li id="0249" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated">迁移到微服务。</li></ul><h1 id="abd7" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">完整代码可在此处获得:</h1><p id="6a09" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated"><a class="ae mh" href="https://github.com/Ridikk12/ModularMonolith" rel="noopener ugc nofollow" target="_blank">https://github.com/Ridikk12/ModularMonolith</a></p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div class="gh gi om"><img src="../Images/80b2e5d3e1a36067ad385a62f454af7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/1*ZwfY2M6cKyQ8LDUf1AOe1g.gif"/></div></figure><h1 id="f635" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">参考</h1><ul class=""><li id="fe07" class="mu mv iq jp b jq lj ju lk jy mw kc mx kg my kk mz na nb nc bi translated"><a class="ae mh" href="https://en.wikipedia.org/wiki/Event_storming#:~:text=Event%20storming%20is%20a%20workshop,notes%20on%20a%20wide%20wall" rel="noopener ugc nofollow" target="_blank">https://en . Wikipedia . org/wiki/Event _ storming #:~:text = Event % 20 storming % 20 is % 20a % 20 workshop，notes % 20 on % 20a % 20 wide % 20 wall</a>。</li><li id="fe4e" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated"><a class="ae mh" href="https://en.wikipedia.org/wiki/Event-driven_architecture#:~:text=Event%2Ddriven%20architecture%20(EDA),sale%22%20to%20%22sold%22." rel="noopener ugc nofollow" target="_blank">https://en . Wikipedia . org/wiki/Event-driven _ architecture #:~:text = Event % 2d driven % 20 architecture % 20(EDA)，sale % 22 % 20to % 20 % 22sold % 22。</a></li><li id="5a89" class="mu mv iq jp b jq nd ju ne jy nf kc ng kg nh kk mz na nb nc bi translated"><a class="ae mh" href="https://martinfowler.com/bliki/CQRS.html#:~:text=CQRS%20stands%20for%20Command%20Query,you%20use%20to%20read%20information" rel="noopener ugc nofollow" target="_blank">https://Martin fowler . com/bliki/cqrs . html #:~:text = CQRS % 20 stands % 20 for % 20 command % 20 query，you % 20 use % 20 to % 20 read % 20 information</a>。</li></ul></div></div>    
</body>
</html>