<html>
<head>
<title>AWS: Lambda — copy EC2 tags to its EBS, part 2 — create a Lambda function</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS: Lambda —将EC2标记复制到它的EBS，第2部分—创建Lambda函数</h1>
<blockquote>原文：<a href="https://itnext.io/aws-lambda-copy-ec2-tags-to-its-ebs-part-2-create-a-lambda-function-7edf7945ab84?source=collection_archive---------3-----------------------#2021-10-13">https://itnext.io/aws-lambda-copy-ec2-tags-to-its-ebs-part-2-create-a-lambda-function-7edf7945ab84?source=collection_archive---------3-----------------------#2021-10-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/4116eb2906df88b0d6fcf1c7806264e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:730/format:webp/1*6dXEkU-sfm3IrnC9WoL1QA.png"/></div></figure><p id="64d5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们继续我们的AWS Lambda函数之旅，它将把EC2的AWS标记复制到所有EBS卷，并附加到它上面。</p><p id="6117" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在第一部分中，<a class="ae ks" rel="noopener ugc nofollow" target="_blank" href="/aws-lambda-copy-ec2-tags-to-its-ebs-part-1-python-and-boto3-73d7bf171aef?source=friends_link&amp;sk=eef97d0c9832a983409359e4ca4b1b8c"> AWS: Lambda —将EC2标记复制到其EBS，第一部分— Python和boto3 </a>，我们编写了一个Python脚本，它可以获取AWS区域中的所有EC2实例，然后对于每个EC2，它获取其EBS卷，然后将所有AWS标记从EC2复制到其所有EBS，此外还会添加一个。</p><p id="2df9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这一部分中，我们将创建一个由AWS CloudWatch事件触发的<a class="ae ks" href="https://rtfm.co.ua/en/aws-lambda-functions-and-overview-and-integration-with-aws-api-gateway/" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>函数。</p><h1 id="1259" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">内容</h1><ul class=""><li id="4150" class="lr ls iq jw b jx lt kb lu kf lv kj lw kn lx kr ly lz ma mb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/aws-lambda-copy-ec2-tags-to-its-ebs-part-2-create-a-lambda-function/#Creating_an_AWS_Lambda_function" rel="noopener ugc nofollow" target="_blank">创建AWS Lambda函数</a></li><li id="170a" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/aws-lambda-copy-ec2-tags-to-its-ebs-part-2-create-a-lambda-function/#Adding_an_Amazon_EventBridge_CloudWatch_Events_trigger" rel="noopener ugc nofollow" target="_blank">添加一个Amazon EventBridge (CloudWatch事件)触发器</a></li><li id="6e27" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/aws-lambda-copy-ec2-tags-to-its-ebs-part-2-create-a-lambda-function/#AWS_Lambda_UnauthorizedOperation" rel="noopener ugc nofollow" target="_blank"> AWS Lambda:未授权操作</a></li><li id="6cf5" class="lr ls iq jw b jx mc kb md kf me kj mf kn mg kr ly lz ma mb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/aws-lambda-copy-ec2-tags-to-its-ebs-part-2-create-a-lambda-function/#Parsing_a_Lambda_event" rel="noopener ugc nofollow" target="_blank">解析Lambda事件</a></li></ul><h1 id="d101" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">创建AWS Lambda函数</h1><p id="e91c" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">转到AWS Lambda，从头开始从"<em class="mk">作者</em>创建一个新函数，运行时设置为Python 3.8:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi ml"><img src="../Images/833ed2cc7090ef47efe5063291e4b2ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1318/format:webp/0*AncZhURUJ3XDcJq7.png"/></div></div></figure><p id="3ec2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<em class="mk">执行角色</em>中，保留“<em class="mk">创建新角色</em>”—稍后，我们将使用IAM策略为其添加额外的权限。</p><p id="8182" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将脚本的代码粘贴到函数中，在代码结束时更新执行的<code class="fe mu mv mw mx b">lambda_hanlder()</code>，并在它的参数中设置<code class="fe mu mv mw mx b">event, context</code>而不是前面post中的<em class="mk"> 0，0】</em>:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi my"><img src="../Images/572c16d760dbf5d76de01c63bd33abe4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dY7mfGq-JTb5GrgA.png"/></div></div></figure><p id="d548" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了检查<code class="fe mu mv mw mx b">event</code>对象的内容，我们稍后将使用它来获取EC2 ID，将其输出添加到函数的日志中。</p><p id="db06" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加<code class="fe mu mv mw mx b">import json</code>和<code class="fe mu mv mw mx b">print("CONTEXT: " + json.dumps(event))</code>:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/382644a16f82ab1c8a9472d5bdf9cdef.png" data-original-src="https://miro.medium.com/v2/resize:fit:776/format:webp/0*rhVJwLtzoC77pte9.png"/></div></figure><p id="0d88" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">同样，对于<code class="fe mu mv mw mx b">ec2 = boto3.resource()</code>调用，删除AWS键，并留下唯一的资源类型——“<em class="mk">ec2</em>”:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi na"><img src="../Images/107b3f11136a17f599347ccc280757d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:740/format:webp/0*SfZLB9qeOt13CUNW.png"/></div></figure><p id="88b0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">不要忘记按下<em class="mk">部署</em>按钮，将您的更改应用到AWS Lambda。</p><h2 id="b28e" class="nb ku iq bd kv nc nd dn kz ne nf dp ld kf ng nh lh kj ni nj ll kn nk nl lp nm bi translated">添加Amazon EventBridge (CloudWatch事件)触发器</h2><p id="e4a1" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">接下来，每次在一个地区推出新的EC2时，我们都需要运行这个函数。</p><p id="2871" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这里，我们可以使用Amazon EventBridge(以前的CloudWatch事件)。转到<em class="mk"> CloudWatch事件&gt;规则</em>，点击<em class="mk">创建规则</em>:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/2b4eede8c4a1005571b39f84664ad96a.png" data-original-src="https://miro.medium.com/v2/resize:fit:774/format:webp/0*buFO9aviAoUP-HzO.png"/></div></figure><p id="8f23" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<em class="mk">事件模式</em>中选择<em class="mk">服务名== EC2，在<em class="mk">事件类型</em>中选择<em class="mk"> EC2实例状态变更通知</em>，在<em class="mk">特定状态</em>中选择<em class="mk">运行</em>:</em></p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi no"><img src="../Images/f9600f75328814916c6416a46e0a17d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_lnRwmeKgfGXq3va.png"/></div></div></figure><p id="91ce" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<em class="mk">添加目标</em>的右侧，选择我们在上面创建的AWS Lambda函数:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi np"><img src="../Images/ad2f5be0485099e45ecb2cf742631041.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gt1mLEcBM04vYbqO.png"/></div></div></figure><p id="f489" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在页面的最后，在<em class="mk">显示示例事件中，</em>我们可以看到一个<code class="fe mu mv mw mx b">event</code>对象的示例，它将被传递给函数以获取EC2 ID:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi nq"><img src="../Images/9cbc62eeb95f922cf2eff5ebcb076c62.png" data-original-src="https://miro.medium.com/v2/resize:fit:862/format:webp/0*Ip1w0nyY3kxVKXSq.png"/></div></div></figure><p id="1545" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">保存新规则:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi nr"><img src="../Images/6d9ba2dfd8a4ce9023949761f39918a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*APiBtiFvLoVxqL58.png"/></div></div></figure><p id="79a3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查它是否作为触发器添加到Lambda函数中:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi ns"><img src="../Images/7f8ad99e6b44f8b3f6f64d0771a81cad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ezPDRkytxdsyHJNP.png"/></div></div></figure><p id="bf21" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们看看这是如何工作的。</p><p id="d0a3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在CloudWatch规则中打开规则的监控:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/f02941732edad85e7fc737e979af4366.png" data-original-src="https://miro.medium.com/v2/resize:fit:1156/format:webp/0*f5d650iwwz5m29km.png"/></div></figure><p id="b8ad" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">旋转新的EC2，例如通过触发自动缩放组:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/57ae6d1dc4aeecd009129f350334fd2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1172/format:webp/0*CLfif0R78VujO5nB.png"/></div></figure><p id="7ac3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在CloudWatch图中，我们可以看到规则被触发:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi nv"><img src="../Images/dc272d0313cb8fc2488b0dbccb28002e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EDf5cZmA6JxyOqU_.png"/></div></div></figure><p id="34a0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查Lambda函数的日志:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi nw"><img src="../Images/ddcaf70c35b24798c57f88b018e3a417.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NHvftqQ5QQlP_Ybp.png"/></div></div></figure><h2 id="6cfe" class="nb ku iq bd kv nc nd dn kz ne nf dp ld kf ng nh lh kj ni nj ll kn nk nl lp nm bi translated">AWS Lambda:未授权操作</h2><p id="73a1" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">在日志中，我们对两条记录感兴趣。</p><p id="2cc8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">第一个是从<code class="fe mu mv mw mx b">print("CONTEXT: " + json.dumps(event))</code>保存到日志中的<code class="fe mu mv mw mx b">event</code>内容:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/c3adde412bb4e0c3806bb9c9aeb71f16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1270/format:webp/0*YWBt-rtVm9Loauqs.png"/></div></figure><p id="48bb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">第二个是<strong class="jw ir"><em class="mk">“client error:调用DescribeInstances操作时出错(UnauthorizedOperation):您无权执行此操作”</em> </strong>错误:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi ny"><img src="../Images/ee2c476ac3cbfb6e42015eefa6ad92e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wqeYfb_uB-tQBQCP.png"/></div></div></figure><p id="19e9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里的问题很明显:我们的Lambda函数现在使用的是IAM角色，它是在函数创建过程中创建的，它没有对EC2操作的API调用的权限:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi nz"><img src="../Images/f56c8f93c91adf8291fa70435ee8d4cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*r_rjV5DuTvNdpH6O.png"/></div></div></figure><p id="b6f3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">转到AWS IAM，找到角色，点击<em class="mk">附加策略</em>:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/06fb5d4986c0e49aae7583ad55ac3c1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/format:webp/0*ZHj4GRp489k2vjSv.png"/></div></figure><p id="537c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建新策略:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/be00637f49f7cf8acb4fb2d0de762fc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:744/format:webp/0*cClhxP5o8lumvYG7.png"/></div></figure><p id="24d0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在此描述EC2权限:</p><pre class="mm mn mo mp gt oc mx od oe aw of bi"><span id="fc83" class="nb ku iq mx b gy og oh l oi oj">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Sid": "VisualEditor0",<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "ec2:DescribeInstances",<br/>                "ec2:DeleteTags",<br/>                "ec2:CreateTags",<br/>                "ec2:DescribeVolumes"<br/>            ],<br/>            "Resource": "*"<br/>        }<br/>    ]<br/>}</span></pre><p id="6dee" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">保存它:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi ok"><img src="../Images/f6929e8f66ff5ac7065d7e564fd6ef10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*d3E8aKfhlpXDbbK9.png"/></div></div></figure><p id="f83d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">返回Lambda函数的IAM角色，并添加一个新策略:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/cdd0b4ddaddd5ed133a99d8ceda9ab5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1286/format:webp/0*EHTosbK9Y35R1zy4.png"/></div></figure><p id="97b3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">重复一次新的EC2启动，并再次检查函数日志:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi om"><img src="../Images/ab833f242016032857a7e2d7c4fb7f9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*h_6zuWUSlkXifeXy.png"/></div></div></figure><p id="8f1b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">耶！<strong class="jw ir"> <em class="mk">有用！</em> </strong>”</p><p id="443e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来，需要更新代码以从<code class="fe mu mv mw mx b">event</code>对象中获取<code class="fe mu mv mw mx b">instance-id</code>。</p><h2 id="d73b" class="nb ku iq bd kv nc nd dn kz ne nf dp ld kf ng nh lh kj ni nj ll kn nk nl lp nm bi translated">解析一个λ<code class="fe mu mv mw mx b">event</code></h2><p id="cc3a" class="pw-post-body-paragraph ju jv iq jw b jx lt jz ka kb lu kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">当我们创建CloudWatch规则时，我们已经看到了一个<code class="fe mu mv mw mx b">event</code>的例子，我们知道它将作为一个带有一组键的python字典传递给<code class="fe mu mv mw mx b">lambda_handler()</code>函数:</p><pre class="mm mn mo mp gt oc mx od oe aw of bi"><span id="89d8" class="nb ku iq mx b gy og oh l oi oj">{<br/>    "version": "0",<br/>    "id": "a99597e5-90a5-5ac3-3aba-da3ecd51452a",<br/>    "detail-type": "EC2 Instance State-change Notification",<br/>    "source": "aws.ec2",<br/>    "account": "534***385",<br/>    "time": "2021-10-11T09:02:09Z",<br/>    "region": "eu-west-3",<br/>    "resources": [<br/>        "arn:aws:ec2:eu-west-3:534***385:instance/i-0cc24729109ba61e5"<br/>    ],<br/>    "detail": {<br/>        "instance-id": "i-0cc24729109ba61e5",<br/>        "state": "running"<br/>    }<br/>}</span></pre><p id="97e7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从这里我们需要获取<code class="fe mu mv mw mx b">detail.instance-id</code>元素的值。</p><p id="d0bb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">向脚本中添加一个新变量，我们称之为<code class="fe mu mv mw mx b">instance_id</code>，它将保存一个来自<code class="fe mu mv mw mx b">event["detail"]["instance-id"]</code>的值，然后通过使用这个ID，我们正在创建一个<code class="fe mu mv mw mx b">ec2.Instance</code>类的新对象，即<code class="fe mu mv mw mx b">ec2.Instance(instance_id)</code>:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi on"><img src="../Images/4edea53a00ec93d422d992f0124145ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1010/format:webp/0*-0OqVvWyRZRBZqY1.png"/></div></figure><p id="3a41" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">不用手动运行一个新的EC2，我们可以通过传递一个<code class="fe mu mv mw mx b">event</code>对象来对我们的Lambda使用<em class="mk">测试</em>。</p><p id="36c7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建新的测试事件:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/4b80d22c3d8921ce0fe36e62e489f93c.png" data-original-src="https://miro.medium.com/v2/resize:fit:628/format:webp/0*19iFUfbnU2aThznT.png"/></div></figure><p id="f4ab" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加一个类似于我们将从CloudWatch获得的数据:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi op"><img src="../Images/fdd65015ff59b254db47274d49cb2e58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1182/format:webp/0*JCLEKB_hp44XQVTw.png"/></div></figure><pre class="mm mn mo mp gt oc mx od oe aw of bi"><span id="9332" class="nb ku iq mx b gy og oh l oi oj">{<br/>    "version": "0",<br/>    "id": "a99597e5-90a5-5ac3-3aba-da3ecd51452a",<br/>    "detail-type": "EC2 Instance State-change Notification",<br/>    "source": "aws.ec2",<br/>    "account": "534***385",<br/>    "time": "2021-10-11T09:02:09Z",<br/>    "region": "eu-west-3",<br/>    "resources": [<br/>        "arn:aws:ec2:eu-west-3:534***385:instance/i-0cc24729109ba61e5"<br/>    ],<br/>    "detail": {<br/>        "instance-id": "i-0cc24729109ba61e5",<br/>        "state": "running"<br/>    }<br/>}</span></pre><p id="2b20" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行测试:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi oq"><img src="../Images/c3f59d18e63688b1dba055a43dfb77f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AiaNomfoVNnxcddx.png"/></div></div></figure><p id="879d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> <em class="mk">“管用！”</em> </strong> <em class="mk"> </em></p><p id="d842" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在让我们构建一个通用的EC2来检查整个方案，包括CloudWatch事件、Lambda的触发器及其执行结果。</p><p id="9652" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">触发自动缩放群组:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi or"><img src="../Images/549ecd1f69181bfa0ff87dd66f5e1bb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1268/format:webp/0*NxQ_Yblez-fXQDAM.png"/></div></figure><p id="fdae" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建了一个新的EC2<em class="mk">I-051 F2 E1 f1 BC 8d 332 b</em>，检查Lambda的日志:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi os"><img src="../Images/c592e8f30cf4bcb152628728d0a23e0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*aIv9AK6HkfWWHyuT.png"/></div></div></figure><p id="1434" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">找到此EC2的EBS:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi ot"><img src="../Images/7908536805b9a978fa1c765028d9ede2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*i_PkEzSnfLycTbFd.png"/></div></div></figure><p id="bc54" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并检查它的标签:</p><figure class="mm mn mo mp gt jr gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/e1be8bb277b268dd4bb489667b543b83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1356/format:webp/0*1p36vU2lo91tiDCB.png"/></div></figure><p id="0978" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下面是这个函数的代码:</p><pre class="mm mn mo mp gt oc mx od oe aw of bi"><span id="6b16" class="nb ku iq mx b gy og oh l oi oj">#!/usr/bin/env python<br/><br/>import os<br/>import json<br/>import boto3<br/><br/><br/>def lambda_handler(event, context):<br/><br/>    ec2 = boto3.resource('ec2')<br/>    instance_id = event["detail"]["instance-id"]<br/>    instance = ec2.Instance(instance_id)<br/><br/>    print("[DEBUG] EC2\n\t\tID:  " + str(instance))<br/>    print("\tEBS")<br/><br/>    for vol in instance.volumes.all():<br/><br/>        vol_id = str(vol)<br/>        print("VOLUME: " + str(vol))<br/><br/>        device_id = "ec2.vol.Device('" + str(vol.attachments[0]['Device']) + "')"<br/>        print("\t\tID:  " + vol_id + "\n\t\tDev: " + device_id)<br/><br/>        role_tag = vol.create_tags(Tags=set_role_tag(vol))<br/>        ec2_tags = vol.create_tags(Tags=copy_ec2_tags(instance))<br/>        print("\t\tTags set:\n\t\t\t" + str(role_tag) + "\n\t\t\t" + str(ec2_tags) + "\n")<br/><br/><br/>def is_pvc(vol): <br/><br/>    try:<br/>        for tag in vol.tags:<br/>            if tag['Key'] == 'kubernetes.io/created-for/pvc/name':<br/>                return True<br/>                break<br/>    except TypeError:<br/>            return False<br/><br/><br/>def set_role_tag(vol):<br/>    <br/>    device = vol.attachments[0]['Device']<br/>    tags_list = []<br/>    values = {}<br/>        <br/>    if is_pvc(vol):<br/>        values['Key'] = "Role"<br/>        values['Value'] = "PvcDisk"<br/>        tags_list.append(values)<br/>    elif device == "/dev/xvda":<br/>        values['Key'] = "Role"<br/>        values['Value'] = "RootDisk"<br/>        tags_list.append(values)<br/>    else:   <br/>        values['Key'] = "Role"<br/>        values['Value'] = "DataDisk"<br/>        tags_list.append(values)<br/><br/>    return tags_list<br/><br/>    <br/>def copy_ec2_tags(instance):<br/>            <br/>    tags_list = []<br/>    values = {} <br/>        <br/>    for instance_tag in instance.tags:<br/><br/>        if instance_tag['Key'] == 'Env':<br/>            tags_list.append(instance_tag)<br/>        elif instance_tag['Key'] == 'Tier':<br/>            tags_list.append(instance_tag)<br/>        elif instance_tag['Key'] == 'DataClass':<br/>            tags_list.append(instance_tag)<br/>        elif instance_tag['Key'] == 'JiraTicket':<br/>            tags_list.append(instance_tag)<br/><br/>    return tags_list<br/><br/><br/>if __name__ == "__main__":<br/>    lambda_handler(event, context)</span></pre><p id="a236" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">完成了。</p></div><div class="ab cl ov ow hu ox" role="separator"><span class="oy bw bk oz pa pb"/><span class="oy bw bk oz pa pb"/><span class="oy bw bk oz pa"/></div><div class="ij ik il im in"><p id="93ee" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="mk">最初发布于</em> <a class="ae ks" href="https://rtfm.co.ua/en/aws-lambda-copy-ec2-tags-to-its-ebs-part-2-create-a-lambda-function/" rel="noopener ugc nofollow" target="_blank"> <em class="mk"> RTFM: Linux，DevOps，和系统管理</em> </a> <em class="mk">。</em></p></div></div>    
</body>
</html>