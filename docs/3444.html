<html>
<head>
<title>Use WebSocket on .Net Core &amp; Angular with SignalR</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用WebSocket on。带信号的网芯和角形</h1>
<blockquote>原文：<a href="https://itnext.io/use-websocket-on-net-core-angular-with-signalr-340ad5076e64?source=collection_archive---------0-----------------------#2019-12-18">https://itnext.io/use-websocket-on-net-core-angular-with-signalr-340ad5076e64?source=collection_archive---------0-----------------------#2019-12-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="6ff3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们先来解释一下什么是web socket和SignalR:</p><p id="a4cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据Mozilla的说法:</p><blockquote class="kl km kn"><p id="0ca6" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><a class="ae ks" href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">web socket API</strong>是一项先进的技术，可以在用户浏览器和服务器之间开启双向互动通信会话。</a></p></blockquote><p id="c45e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">而<strong class="jp ir"> SignalR </strong>是一个用于消费WebSocket in的包装器。Net应用程序。它真的让你的工作更容易通用。</p></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><p id="2366" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通常，客户端向服务器发送请求并等待响应。但是如果您在服务器上的工作需要很长时间，您可能会得到一个超时异常。第一个解决方案是不时地轮询服务器来检查你的工作进度。这看起来是可以接受的，但是如果成千上万的用户每秒都在轮询你的服务器，你的服务器将开始膨胀，如果你使用云，你将在月底收到一份不错的账单。</p><p id="f706" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">说够了，让我们编码。</p></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><p id="0608" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将解释一个聊天应用程序的工作(作为一个传统)。因为需求非常明显，而且每个人都知道聊天应用程序是如何工作的:)</p><p id="da6e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，使用CLI或Visual Studio创建一个带有angular模板的. Net核心应用程序。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="2c2e" class="lj lk iq lf b gy ll lm l ln lo">dotnet new angular --name websocket-demo</span></pre><h1 id="c7a1" class="lp lk iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">第一步:准备。网络核心</h1><p id="2c9b" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">在<code class="fe mr ms mt lf b">startup.cs</code>中，在方法<code class="fe mr ms mt lf b">ConfigureServices</code>中添加以下代码</p><figure class="la lb lc ld gt mu"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="57a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，用<code class="fe mr ms mt lf b">Configure</code>的方法，把这几行:</p><figure class="la lb lc ld gt mu"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="41d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mr ms mt lf b">KeepAliveInterval</code>保存发送ping消息以保持连接活动的时间值。</p><p id="5227" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意<code class="fe mr ms mt lf b">Line:14</code>我们用URL注册我们的中心。</p><p id="1b70" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以把<strong class="jp ir"> Hubs </strong>想象成SignalR中WebSocket的控制器。我们将创建一个名为<code class="fe mr ms mt lf b">ChatHub</code>的中心，并将相关动作放入该文件中。</p><figure class="la lb lc ld gt mu"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="ff6b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe mr ms mt lf b">ChatHub.cs</code>中，你会看到三个异步方法。当WebSocket客户端调度名为的操作时，将调用这些操作。</p><p id="c006" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mr ms mt lf b">Clients</code> object允许您访问所有连接的客户端并分派新的操作。</p><p id="dc47" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> —依赖注入</strong></p><p id="519b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了能够从控制器或作业向客户机发送数据，您需要访问hub上下文。可以用<code class="fe mr ms mt lf b">IHubContext&lt;&gt;</code>代替。</p><figure class="la lb lc ld gt mu"><div class="bz fp l di"><div class="mv mw l"/></div></figure><h1 id="6b41" class="lp lk iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated"><strong class="ak">步骤2:准备角度</strong></h1><p id="1403" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">首先，使用npm安装<code class="fe mr ms mt lf b">@microsoft/signalr</code></p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="6516" class="lj lk iq lf b gy ll lm l ln lo">npm install @microsoft/signalr</span></pre><p id="00ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后导航到您想要实现web socket的组件。在<code class="fe mr ms mt lf b">ngOnInit</code>中，准备如下连接。</p><figure class="la lb lc ld gt mu"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="2e46" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe mr ms mt lf b">.withUrl</code>方法中，传递想要连接的集线器的路径。(注册时我们在Startup.cs中指定了那个路径。).</p><p id="fc2b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mr ms mt lf b">this.connetion.on</code>方法允许我们订阅WebSocket事件，并用我们的代码处理有效负载。</p><p id="1075" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们已经配置了我们的客户端，但是还没有开始连接。要开始连接，请使用</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="0f22" class="lj lk iq lf b gy ll lm l ln lo">this.connection.start();</span></pre><p id="749c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以像<code class="fe mr ms mt lf b">this.connection.start().then()</code>一样在<code class="fe mr ms mt lf b">start</code>之后连锁事件。</p><p id="1f6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动连接后，您应该会看到一个对服务器进行协商的HTTP调用</p><figure class="la lb lc ld gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi mx"><img src="../Images/56d0a4486860e40de274531cc5f43d1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RuOC_-ocfiP8Bi9WV4Ffzg.png"/></div></div></figure><p id="c368" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，它应该升级到web套接字的连接。之后，在ChromeDevTools的<strong class="jp ir"> WS </strong>标签中，你应该会看到WebSocket与有效负载的连接</p><figure class="la lb lc ld gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi ne"><img src="../Images/8a9051c71ccbda46eb6e37ace83be607.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*79j5wzh4OA1WLAQU1POVtw.png"/></div></div></figure><h1 id="e4f3" class="lp lk iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated"><strong class="ak">第三步:发布</strong></h1><p id="a1d0" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated"><strong class="jp ir"> —服务器</strong></p><p id="222c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了能够在生产环境中使用WebSocket，您应该在服务器中启用WebSocket协议。按照以下说明在服务器上启用WebSocket协议:</p><ol class=""><li id="bc62" class="nf ng iq jp b jq jr ju jv jy nh kc ni kg nj kk nk nl nm nn bi translated">打开<strong class="jp ir">服务器管理器</strong>。</li><li id="b166" class="nf ng iq jp b jq no ju np jy nq kc nr kg ns kk nk nl nm nn bi translated">在<strong class="jp ir">管理</strong>菜单下，点击<strong class="jp ir">添加角色和功能</strong>。</li><li id="48f7" class="nf ng iq jp b jq no ju np jy nq kc nr kg ns kk nk nl nm nn bi translated">选择<strong class="jp ir">基于角色或基于功能的安装</strong>，然后点击<strong class="jp ir">下一步</strong>。</li><li id="9bd2" class="nf ng iq jp b jq no ju np jy nq kc nr kg ns kk nk nl nm nn bi translated">选择合适的服务器(默认选择您的本地服务器)，然后点击<strong class="jp ir">下一步</strong>。</li><li id="7f76" class="nf ng iq jp b jq no ju np jy nq kc nr kg ns kk nk nl nm nn bi translated">在<strong class="jp ir">角色</strong>树中展开<strong class="jp ir"> Web服务器(IIS) </strong>，然后展开<strong class="jp ir"> Web服务器</strong>，再展开<strong class="jp ir">应用开发</strong>。</li><li id="e409" class="nf ng iq jp b jq no ju np jy nq kc nr kg ns kk nk nl nm nn bi translated">选择<strong class="jp ir"> WebSocket协议</strong>，然后点击<strong class="jp ir">下一步</strong>。</li><li id="4f5b" class="nf ng iq jp b jq no ju np jy nq kc nr kg ns kk nk nl nm nn bi translated">如果不需要其他功能，点击下一个的<strong class="jp ir">。</strong></li><li id="4273" class="nf ng iq jp b jq no ju np jy nq kc nr kg ns kk nk nl nm nn bi translated">点击<strong class="jp ir">安装</strong>。</li><li id="63ca" class="nf ng iq jp b jq no ju np jy nq kc nr kg ns kk nk nl nm nn bi translated">安装完成后，点击<strong class="jp ir">关闭</strong>退出向导。</li></ol><p id="89c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ko">来源:</em><a class="ae ks" href="https://docs.microsoft.com/en-us/iis/get-started/whats-new-in-iis-8/iis-80-websocket-protocol-support#step-by-step-instructions" rel="noopener ugc nofollow" target="_blank"><em class="ko">https://docs . Microsoft . com/en-us/IIS/get-started/whats-new-in-IIS-8/IIS-80-web socket-protocol-support #分步说明</em> </a></p><p id="3621" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> —天蓝色</strong></p><p id="0519" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">浏览Azure控制台并打开您的应用程序仪表板。</p><p id="72bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">转到<strong class="jp ir">配置</strong>部分。</p><p id="8114" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">切换到<strong class="jp ir">通用设置</strong>选项卡并启用WebSockets</p><figure class="la lb lc ld gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi nt"><img src="../Images/3d936c51189192d8fd85ba7527364397.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ufs6dNDvy0hNHuik_-vMsw.png"/></div></div></figure></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><p id="1548" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是实现web套接字所要做的全部工作。净核心和角使用信号。</p><p id="a54b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，如果你认为你与客户端和服务器保持连接，如果你有这么多的用户，也许使用网络推送更好。你可以查看我的<a class="ae ks" rel="noopener ugc nofollow" target="_blank" href="/push-notification-with-angular-net-core-a2280d18eda1?source=friends_link&amp;sk=c03f898f59ccb9562507d55d6f560f6c"> <strong class="jp ir">其他</strong> </a>文章使用Web Push使用FCM。</p></div></div>    
</body>
</html>