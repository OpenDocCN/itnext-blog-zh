<html>
<head>
<title>Improve your Twitter bot with MongoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用MongoDB改进你的Twitter机器人</h1>
<blockquote>原文：<a href="https://itnext.io/improve-your-twitter-bot-with-mongodb-1f1e51e632d4?source=collection_archive---------8-----------------------#2018-05-30">https://itnext.io/improve-your-twitter-bot-with-mongodb-1f1e51e632d4?source=collection_archive---------8-----------------------#2018-05-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b56ee0e87209a6423fd6ec6fa65df9fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i9KQSsKKYfqFv33_iNWsBg.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">米海·沃尔高在<a class="ae kc" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="8d4e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<a class="ae kc" href="https://medium.com/@mihailgaberov/creating-a-twitter-bot-in-5am-2a42a9920e67" rel="noopener">的另一篇文章</a>中，我们看到了如何创建一个twitter机器人，向他的追随者发送私人消息，包含按预定义标准搜索的推文——我们选择的某些标签。这一次，我们将通过添加额外的功能来改进发送的报告。我们会将结果存储在数据库中，并根据我们存储的内容过滤新收到的推文。因此，我们将只能发送(<em class="lb">几乎* </em>)唯一的结果。</p><p id="a52a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">TL；DR <br/> </strong>这是一步一步教程<a class="ae kc" href="https://medium.com/@mihailgaberov/creating-a-twitter-bot-in-5am-2a42a9920e67" rel="noopener">的第二部分</a>向你展示如何创建你自己的Twitter机器人，并把它放在<a class="ae kc" href="http://herokuapp.com" rel="noopener ugc nofollow" target="_blank"> heroku </a>上。这次我们将通过使用<a class="ae kc" href="https://www.npmjs.com/package/mongoose" rel="noopener ugc nofollow" target="_blank">mongose</a>和<a class="ae kc" href="https://www.mongodb.com" rel="noopener ugc nofollow" target="_blank"> MongoDB </a>来升级我们的代码，以产生更好的结果。此外，我们将通过提取消息内容的组合来扩展我们的<em class="lb">助手</em>的用法。最后，我们将看看如何使用<a class="ae kc" href="https://mlab.com/" rel="noopener ugc nofollow" target="_blank"> Mlab </a>托管服务(免费计划)来托管我们的数据库。</p><p id="004a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你想直接跳到代码，这里是GitHub repo。</p><p id="d726" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">推理<br/> </strong>那样做的理由是什么？</p><blockquote class="lc ld le"><p id="2849" class="kd ke lb kf b kg kh ki kj kk kl km kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated">现在有很多关于创建twitter机器人的教程和文章，但我找不到任何一个将这个主题扩展到下一个级别的教程和文章——为改进你的机器人处理数据的方式提供方向。</p></blockquote><p id="5525" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这就是为什么我决定在等式中引入一个新的玩家。一些将帮助我们做更多关于我们的tweet报告的事情——数据库。</p><p id="4f5c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">数据库<br/> </strong> MongoDB是著名的<a class="ae kc" href="https://en.wikipedia.org/wiki/NoSQL" rel="noopener ugc nofollow" target="_blank"> NoSQL </a>数据库，与<a class="ae kc" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>有很大的集成。它快速易用，非常适合我们的目的。在向关注者发送消息之前，我们将使用它来消除提要中的重复内容。</p></div><div class="ab cl li lj hu lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ij ik il im in"><h2 id="0e25" class="lp lq iq bd lr ls lt dn lu lv lw dp lx ko ly lz ma ks mb mc md kw me mf mg mh bi translated">逐步地</h2><p id="ad16" class="pw-post-body-paragraph kd ke iq kf b kg mi ki kj kk mj km kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated">如果你想坚持到底，以下是你可以采取的步骤:</p><ol class=""><li id="4c7c" class="mn mo iq kf b kg kh kk kl ko mp ks mq kw mr la ms mt mu mv bi translated">在<a class="ae kc" href="https://mlab.com/signup/" rel="noopener ugc nofollow" target="_blank"> Mlab </a>中注册一个新账户。</li><li id="ce5a" class="mn mo iq kf b kg mw kk mx ko my ks mz kw na la ms mt mu mv bi translated">将您的DB_USER和DB_PASSWORD凭据添加到您的。env文件(与我们在第一部分<a class="ae kc" href="https://medium.com/@mihailgaberov/creating-a-twitter-bot-in-5am-2a42a9920e67" rel="noopener">中使用Twitter API键的方式相同)。</a></li><li id="159c" class="mn mo iq kf b kg mw kk mx ko my ks mz kw na la ms mt mu mv bi translated">在项目的根文件夹中创建一个名为“/ <em class="lb"> db </em>的新目录，并在其中添加一个新文件:<strong class="kf ir"> db.js </strong> <em class="lb">。这里是我们放置与数据库连接的逻辑的地方。</em></li><li id="95a1" class="mn mo iq kf b kg mw kk mx ko my ks mz kw na la ms mt mu mv bi translated">在文件的开头，导入<a class="ae kc" href="http://mongoosejs.com/" rel="noopener ugc nofollow" target="_blank">mongose</a>——一个<a class="ae kc" href="https://www.mongodb.org/" rel="noopener ugc nofollow" target="_blank"> MongoDB </a>对象建模工具，设计用于在异步环境中工作。稍后我们会看到，当使用<strong class="kf ir">mongose</strong>和<strong class="kf ir"> Node.js </strong>时，使用MongoDB是多么容易。</li></ol><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="68c1" class="lp lq iq ng b gy nk nl l nm nn">const mongoose = require('mongoose')</span></pre><p id="c367" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">5.下一步是组成我们的连接字符串。为了能够连接和使用我们的数据库，我们需要这个。它应该是这样的:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="ca4a" class="lp lq iq ng b gy nk nl l nm nn">const dbURI = `mongodb://${process.env.DB_USER}:${process.env.DB_PASS}@ds219130.mlab.com:19130/twitter-bot-db`</span></pre><p id="51c0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">6.这个<a class="ae kc" href="https://github.com/mihailgaberov/twitter-bot/blob/v2/db/db.js" rel="noopener ugc nofollow" target="_blank">文件</a>的其余部分只是来自<em class="lb">mongose、</em>的简单逻辑，涉及为可能发生的不同事件设置不同的监听器。其中一个事件是“<em class="lb">连接</em>”，它告诉我们何时成功连接到数据库。</p><p id="3aef" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">7.设置您的数据库模型——在同一个文件夹中创建一个名为<strong class="kf ir"> tweets.model.js </strong>的新文件。这是我们数据库模型背后的逻辑。一个简单的<a class="ae kc" href="http://mongoosejs.com/docs/guide.html" rel="noopener ugc nofollow" target="_blank">mongose模式</a>，作为我们数据库文档的蓝图。它只包含四个字段。这个唯一的ID参数叫做i <em class="lb"> d_str。</em>我们将在检查重复时使用它。推文的内容，作者名称<em class="lb">和推文的创建日期<em class="lb">创建于</em>。所有的字段都定义为<a class="ae kc" href="http://mongoosejs.com/docs/schematypes.html" rel="noopener ugc nofollow" target="_blank"> <em class="lb">字符串和</em> <em class="lb">必填</em> </a> <em class="lb">。</em></em></p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="4b83" class="lp lq iq ng b gy nk nl l nm nn">const tweetSchema = new Schema({ <br/>  id_str: { <br/>    type: String, <br/>    unique: true,<br/>    required: true <br/>  }, <br/>  status: { <br/>    type: String, <br/>    required: true <br/>  }, <br/>  author: {<br/>    type: String,<br/>    required: true <br/>  }<br/>  created_at: {<br/>    type: String,<br/>    required: true<br/>})</span></pre><p id="a71c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">8.启动和运行数据库的最后一步是创建数据库控制器。该文件将包含与数据库交互的主要逻辑。在这里，我们将把读写记录的方法放入其中。同样在这里，我们将实现仅从每个提要获取唯一tweets的功能，并记录它们以供发布使用。首先，在“<em class="lb"> /db </em>”文件夹中创建一个新文件，将其命名为<strong class="kf ir"> tweets.controller.js </strong>，并在其中粘贴<a class="ae kc" href="https://github.com/mihailgaberov/twitter-bot/blob/v2/db/tweets.controller.js" rel="noopener ugc nofollow" target="_blank">此代码</a>。您可能已经看到，在这个文件中，我们导出了一些方法，其中一些被定义为局部常量。遵循最佳实践，我们将在我们的主流程中只使用导出的。</p><blockquote class="no"><p id="2bf5" class="np nq iq bd nr ns nt nu nv nw nx la dk translated">通过将其余部分定义为本地，我们限制了对外部世界不必要的暴露。</p></blockquote><p id="8443" class="pw-post-body-paragraph kd ke iq kf b kg ny ki kj kk nz km kn ko oa kq kr ks ob ku kv kw oc ky kz la ij bi translated">本地方法，仅在此处使用:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="0718" class="lp lq iq ng b gy nk nl l nm nn">const fetchTweets = function () { ... }<br/>const recordTweet = function ({ id_str, text, user }) {...}</span></pre><p id="c79b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">导出方法，用于<a class="ae kc" href="https://github.com/mihailgaberov/twitter-bot/blob/v2/bot.js" rel="noopener ugc nofollow" target="_blank"> <em class="lb"> bot.js </em> </a>:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="7501" class="lp lq iq ng b gy nk nl l nm nn">module.exports.recordUniqueTweets = function (tweets) {...} module.exports.getUniqueTweets = function (latestTweets) {...}</span></pre><p id="bf59" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">助手<br/> </strong>在我的<a class="ae kc" href="https://medium.com/@mihailgaberov/creating-a-twitter-bot-in-5am-2a42a9920e67" rel="noopener">上一篇文章</a>中我提到了提取或模块化可以在许多其他地方重用的功能有多好。我们用获取当前时间的方法做到了这一点。这次我们将向<a class="ae kc" href="https://github.com/mihailgaberov/twitter-bot/blob/v2/helpers.js" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir">helpers . js</strong></a><strong class="kf ir">，</strong>添加另一个方法，我们将使用它来生成消息内容。如果由于任何原因，我们没有收到任何新的推文，我们将向关注者发送消息。比如这个:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="503c" class="lp lq iq ng b gy nk nl l nm nn"><em class="lb">`-— Nothing new this time (14.05.2018 14.02).`.</em></span></pre><p id="a70c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们将稍微重构一下获取当前时间的方法。然后我们将能够在编写消息内容时使用它来添加推文创建的日期。</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="ed01" class="lp lq iq ng b gy nk nl l nm nn">const from = this.getTime(tweet.created_at)</span></pre><p id="3faf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">更新主流程<br/> </strong>在我们完成与数据库相关的任务后，是时候修改我们的<a class="ae kc" href="https://github.com/mihailgaberov/twitter-bot/blob/v2/bot.js" rel="noopener ugc nofollow" target="_blank">主应用程序流程</a>并使其开始使用新的设置了。实际上，我们需要做的改变很小。我们需要从"<em class="lb"> /db </em>"文件夹中导入<strong class="kf ir"> db.js </strong>和<strong class="kf ir"> tweets.controller.js </strong>文件，如下所示:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="e42d" class="lp lq iq ng b gy nk nl l nm nn">require('./db/db')<br/>const db = require('./db/tweets.controller')</span></pre><p id="de11" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，在获取tweets的第一个调用的回调中，用以下代码替换<em class="lb"> forEach </em>循环:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="8609" class="lp lq iq ng b gy nk nl l nm nn">   db.getUniqueTweets(data.statuses).then((tweets) =&gt; {        <br/>     const content = helpers.composeContent(tweets)<br/>     db.recordUniqueTweets(tweets)<br/>  ...<br/>})</span></pre><p id="04a3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">仅此而已。👌</p><p id="2f77" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你可以在这里找到代码<a class="ae kc" href="https://github.com/mihailgaberov/twitter-bot/blob/v2/bot.js" rel="noopener ugc nofollow" target="_blank">的最终版本</a>。</p><p id="7175" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">托管在Mlab上<br/> </strong>好了，现在我们完成了编码，是时候发布我们更新的应用程序和它使用的数据库了。为此，我们将对数据库使用<a class="ae kc" href="https://mlab.com/welcome/" rel="noopener ugc nofollow" target="_blank"> Mlab </a>，对应用程序本身使用<a class="ae kc" href="http://herokuapp.com/home" rel="noopener ugc nofollow" target="_blank"> Herokuapp </a>。</p><p id="d83d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你在使用Heroku部署应用程序时需要帮助，你可以看看本教程的第一部分。只是不要忘记在“设置”标签下的“配置变量”部分添加新的配置变量。</p><p id="b85a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了开始使用Mlab上的数据库，您首先需要登录到您的帐户，并使用提供的控制面板创建一个新的数据库。</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/b45159e4ec3da95383b12836da867939.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*71PlZ2K2UfzHUjNYfsWGfg.png"/></div></div></figure><p id="12bc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建后，只需转到它的设置并找到需要添加到应用程序中的连接字符串。</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oe"><img src="../Images/22938be071033a2920107a90c0e48216.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tMMLs0FnIJtIBSlD07NvQw.png"/></div></div></figure><blockquote class="lc ld le"><p id="323d" class="kd ke lb kf b kg kh ki kj kk kl km kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated">如果你已经完成了本教程的编码部分，你将不得不添加一个集合到数据库中，并将其命名为“tweets”，以便与代码保持一致，并最终获得一个工作的应用程序。</p></blockquote><p id="ef2b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦正确创建了数据库，连接字符串就在您的代码中就位，应用程序就通过Heroku部署好了。🎆 🆒</p><p id="1ff7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">结论<br/> </strong>这篇文章有两个目的。一是成为第一篇<a class="ae kc" href="https://medium.com/@mihailgaberov/creating-a-twitter-bot-in-5am-2a42a9920e67" rel="noopener">文章</a>的逻辑延续。其次是展示我们如何轻松地使用noSQL数据库(如MongoDB)和Node.js以及服务(如Mlab和Heroku)来实现简单Twitter bot应用程序的改进版本。值得一提的是，通过这种方式，我们实际上正在创建自己的twitter状态数据库，以后可能会用于其他用途。也许是一些统计研究或机器学习的材料，谁知道呢。最棒的是，一切都是自动发生的。</p><blockquote class="lc ld le"><p id="06b6" class="kd ke lb kf b kg kh ki kj kk kl km kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated">总会有选择的。我们只需要想想他们。</p></blockquote><p id="52ca" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意:<em class="lb">如果不想使用Mlab提供的用户界面，进行与数据库的交互，可以使用其他工具，比如</em><a class="ae kc" href="https://studio3t.com" rel="noopener ugc nofollow" target="_blank"><em class="lb">studio 3t</em></a><em class="lb">。</em></p><p id="10fa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当然，欢迎任何评论或问题。</p><p id="10db" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">🔥编码快乐！🔥</strong></p><p id="7799" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">你可以在这里找到我的实现</em><a class="ae kc" href="https://github.com/mihailgaberov/twitter-bot/tree/v2" rel="noopener ugc nofollow" target="_blank"><em class="lb">https://github.com/mihailgaberov/twitter-bot</em></a><em class="lb">。如果你想开始收到和我一样的报告，请在Twitter @HerrKlinkerhof3中关注我的机器人。</em></p></div><div class="ab cl li lj hu lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ij ik il im in"><p id="5133" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我说的是“几乎”，因为在某些情况下，你可能会收到内容相同的推文，但发布者不同。根据已实施的检查，这些是不同的，因为它们具有不同的id，但仍然… </p><p id="0bca" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">哦…还有<strong class="kf ir">感谢</strong>阅读。😅</p></div></div>    
</body>
</html>