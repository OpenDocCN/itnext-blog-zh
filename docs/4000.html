<html>
<head>
<title>Using Broadway and RabbitMQ to Create a Data Pipeline in Elixir</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用百老汇和RabbitMQ在Elixir中创建数据管道</h1>
<blockquote>原文：<a href="https://itnext.io/using-broadway-and-rabbitmq-to-create-a-data-pipeline-in-elixir-900ddff57c7d?source=collection_archive---------1-----------------------#2020-04-08">https://itnext.io/using-broadway-and-rabbitmq-to-create-a-data-pipeline-in-elixir-900ddff57c7d?source=collection_archive---------1-----------------------#2020-04-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/944dd19f3b17958a9d8a73075915cd78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HwWtfo9OudnUZhUR.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://martinfowler.com/articles/data-monolith-to-mesh.html" rel="noopener ugc nofollow" target="_blank">https://Martin fowler . com/articles/data-monolith-to-mesh . html</a></figcaption></figure><p id="3ca0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本文中，我将重点关注使用<strong class="ki iu">百老汇</strong> [1]库为Elixir创建一个数据接收和处理管道。根据<strong class="ki iu">百老汇的</strong> github页面，这个库是用来—</p><p id="d6d8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le">“使用Elixir构建并发和多阶段数据接收和数据处理管道。它允许开发人员有效地使用来自不同来源的数据，这些来源被称为生产者，如亚马逊SQS、Apache Kafka、谷歌云PubSub、RabbitMQ等。”</em></p><p id="d8d2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本文中，我将使用<strong class="ki iu">百老汇</strong>rabbit MQ【2】的生产者，来演示开发一个简单的股票报价检索应用程序的基本用法。</p><p id="3648" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">附注:<em class="le">本文中的例子是虚构的，并没有充分利用这个库的所有特性。特别是，由于用于检索股票报价的外部API每分钟只允许使用自由层进行5次调用，因此没有利用库的并发支持。但是对于真正的应用程序来说，并发数据管道将大大提高处理能力，这可能是大多数应用程序所需要的。然而，由于外部API的限制，我将展示我们如何利用作为这个库的一部分的速率限制特性。</em></p><h1 id="4293" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">百老汇的主要特点:</h1><ul class=""><li id="eb35" class="md me it ki b kj mf kn mg kr mh kv mi kz mj ld mk ml mm mn bi translated">背压</li><li id="8fda" class="md me it ki b kj mo kn mp kr mq kv mr kz ms ld mk ml mm mn bi translated">定量</li><li id="3696" class="md me it ki b kj mo kn mp kr mq kv mr kz ms ld mk ml mm mn bi translated">内置测试</li><li id="85bd" class="md me it ki b kj mo kn mp kr mq kv mr kz ms ld mk ml mm mn bi translated">排序和分区</li><li id="ba0f" class="md me it ki b kj mo kn mp kr mq kv mr kz ms ld mk ml mm mn bi translated">限速的</li><li id="675e" class="md me it ki b kj mo kn mp kr mq kv mr kz ms ld mk ml mm mn bi translated">韵律学</li></ul><p id="217f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可以在官方文档<a class="ae kf" href="https://github.com/dashbitco/broadway" rel="noopener ugc nofollow" target="_blank">这里</a>阅读更多关于这些特性的内容。</p><h1 id="38b4" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">我们的应用:</h1><p id="7ae6" class="pw-post-body-paragraph kg kh it ki b kj mf kl km kn mg kp kq kr mt kt ku kv mu kx ky kz mv lb lc ld im bi translated">我将开发一个股票报价检索应用程序，并将使用RabbitMQ作为股票符号生产者和消费者之间的消息代理，消费者从RabbitMQ消费这些符号并检索它们的报价。对于这样一个简单的应用程序，RabbitMQ可能有些过头了。但是如果生产者和消费者驻留在不同的应用程序中，我们将需要一个消息队列作为中间的代理。</p><h1 id="e5f9" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">先决条件:设置RabbitMQ</h1><p id="bee6" class="pw-post-body-paragraph kg kh it ki b kj mf kl km kn mg kp kq kr mt kt ku kv mu kx ky kz mv lb lc ld im bi translated">我用下面的命令在Mac上安装了RabbitMQ</p><blockquote class="mw mx my"><p id="316c" class="kg kh le ki b kj kk kl km kn ko kp kq mz ks kt ku na kw kx ky nb la lb lc ld im bi translated">$ brew更新</p><p id="08a3" class="kg kh le ki b kj kk kl km kn ko kp kq mz ks kt ku na kw kx ky nb la lb lc ld im bi translated">$ brew安装rabbitmq</p></blockquote><p id="8493" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">启动rabbitmq服务后，我使用下面的命令创建了一个将在示例应用程序中使用的队列</p><blockquote class="mw mx my"><p id="26d2" class="kg kh le ki b kj kk kl km kn ko kp kq mz ks kt ku na kw kx ky nb la lb lc ld im bi translated">$ rabbitmqadmin声明队列名称= <strong class="ki iu">股票_队列</strong>持久=真</p></blockquote><p id="3f0a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">durable选项告诉即使服务器重新启动也要保留队列。</p><p id="957e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦创建了队列，它可以被如下列出—</p><blockquote class="mw mx my"><p id="a1fb" class="kg kh le ki b kj kk kl km kn ko kp kq mz ks kt ku na kw kx ky nb la lb lc ld im bi translated">$ rabbitmqctl list_queues <br/>超时:60.0秒……<br/>列出vhost / … <br/> name消息的队列<br/> stock_queue 0</p></blockquote><p id="0a74" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如我们所见，<strong class="ki iu"> stock_queue </strong>已创建，目前其中没有任何消息。</p><h1 id="49ac" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">设置Elixir项目</h1><p id="56e1" class="pw-post-body-paragraph kg kh it ki b kj mf kl km kn mg kp kq kr mt kt ku kv mu kx ky kz mv lb lc ld im bi translated">在这个阶段，我使用下面的命令创建了Elixir应用程序—</p><blockquote class="mw mx my"><p id="1e77" class="kg kh le ki b kj kk kl km kn ko kp kq mz ks kt ku na kw kx ky nb la lb lc ld im bi translated">$ mix new broadway_stock — sup</p></blockquote><p id="ca44" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我在<strong class="ki iu"> mix.exs </strong>文件中添加了必要的依赖项—</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="e822" class="nl lg it nh b gy nm nn l no np">defp deps do<br/>  [<br/>    # {:dep_from_hexpm, "~&gt; 0.3.0"},<br/>    # {:dep_from_git, git: "https://github.com/elixir-lang/my_dep.git", tag: "0.1.0"}<br/>    {:httpoison, "~&gt; 0.10.0"},<br/>    {:hackney, github: "benoitc/hackney", override: true},<br/>    {:json, "~&gt; 1.0.0"},<br/>    <strong class="nh iu">{:broadway_rabbitmq, "~&gt; 0.6.0"}</strong><br/>  ]<br/>end</span></pre><p id="ce11" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">添加完依赖项后，我使用下面的命令安装了它们—</p><blockquote class="mw mx my"><p id="11ca" class="kg kh le ki b kj kk kl km kn ko kp kq mz ks kt ku na kw kx ky nb la lb lc ld im bi translated">$ mix deps.get</p></blockquote><p id="743a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我在根项目目录下创建了一个名为<strong class="ki iu">数据</strong>的子目录，并复制了保存各种股票符号信息的<a class="ae kf" href="https://raw.githubusercontent.com/imeraj/Elixir_Playground/master/broadway_stock/data/companylist.csv" rel="noopener ugc nofollow" target="_blank"> <strong class="ki iu"> CSV文件</strong> </a>。</p><h1 id="6c20" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">生产者代码</h1><p id="5656" class="pw-post-body-paragraph kg kh it ki b kj mf kl km kn mg kp kq kr mt kt ku kv mu kx ky kz mv lb lc ld im bi translated">我们的生产者端代码将解析CSV文件，生成股票符号，并写入RabbitMQ中的<strong class="ki iu"> stock_queue </strong>。代码如下—</p><figure class="nc nd ne nf gt ju"><div class="bz fp l di"><div class="nq nr l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://raw.githubusercontent.com/imeraj/Elixir_Playground/master/broadway_stock/lib/broadway_stock.ex" rel="noopener ugc nofollow" target="_blank"><em class="ns">https://raw . githubusercontent . com/imeraj/Elixir _ Playground/master/Broadway _ stock/lib/Broadway _ stock . ex</em></a></figcaption></figure><p id="0120" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里—</p><ul class=""><li id="6d75" class="md me it ki b kj kk kn ko kr nt kv nu kz nv ld mk ml mm mn bi translated">第8–10行:打开通道到<strong class="ki iu"> stock_queue </strong></li><li id="24c3" class="md me it ki b kj mo kn mp kr mq kv mr kz ms ld mk ml mm mn bi translated">第12–20行:解析CSV文件并将股票符号写入<strong class="ki iu"> stock_queue </strong>调用函数<strong class="ki iu"> write_queue </strong>。</li><li id="a493" class="md me it ki b kj mo kn mp kr mq kv mr kz ms ld mk ml mm mn bi translated">第25–27行:将股票符号发布到<strong class="ki iu">股票队列</strong>的<strong class="ki iu"> write_queue </strong>函数的定义</li><li id="2620" class="md me it ki b kj mo kn mp kr mq kv mr kz ms ld mk ml mm mn bi translated">第22行:关闭到队列的连接</li></ul><h1 id="1302" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated"><strong class="ak">消费者代码:</strong></h1><p id="cda8" class="pw-post-body-paragraph kg kh it ki b kj mf kl km kn mg kp kq kr mt kt ku kv mu kx ky kz mv lb lc ld im bi translated">接下来，是在这个生产者消费者关系中定义我们的消费者代码。百老汇上演了。这方面的代码如下—</p><figure class="nc nd ne nf gt ju"><div class="bz fp l di"><div class="nq nr l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://raw.githubusercontent.com/imeraj/Elixir_Playground/master/broadway_stock/lib/broadway_stock_worker.ex" rel="noopener ugc nofollow" target="_blank">https://raw . githubusercontent . com/imeraj/Elixir _ Playground/master/Broadway _ stock/lib/Broadway _ stock _ worker . ex</a></figcaption></figure><p id="dc29" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这里，我使用了行为<strong class="ki iu">百老汇</strong>并定义了它需要的函数和回调。</p><ul class=""><li id="39be" class="md me it ki b kj kk kn ko kr nt kv nu kz nv ld mk ml mm mn bi translated">第10–28行:定义配置管道的start_link函数。这里需要注意一些重要的事情— <strong class="ki iu"> 1 </strong>)我使用的是同一个队列— <strong class="ki iu"> stock_queue，2 </strong>)我定义了一个转换器来在处理之前执行一些数据转换(稍后会详细介绍)，<strong class="ki iu"> 3 </strong>)因为我将调用外部API来获取股票报价，而自由层服务每分钟只允许5次调用，所以我使用了<strong class="ki iu">速率限制</strong>来每12秒只允许1条消息(第17–20行)和<strong class="ki iu">4【T44】所以我只使用了一个处理器(第22–26行)</strong></li><li id="207c" class="md me it ki b kj mo kn mp kr mq kv mr kz ms ld mk ml mm mn bi translated">第42–47行:定义了我们的转换函数<strong class="ki iu"> transform/2。</strong>通常，在被<strong class="ki iu"> handle_message </strong>回调处理之前，该函数应该用于执行任何需要的转换。在这个函数中，我只是处理了从队列中出来的股票符号，并删除了它们周围的双引号。</li><li id="aab5" class="md me it ki b kj mo kn mp kr mq kv mr kz ms ld mk ml mm mn bi translated">第31–40行:定义<strong class="ki iu"> handle_message </strong>函数，该函数一次获取一个股票代码，并调用<strong class="ki iu"> get_quote </strong>函数来检索报价，并使用函数<strong class="ki iu"> display_quote进行显示。</strong></li></ul><h1 id="a7a6" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated"><strong class="ak">检索股票报价</strong></h1><p id="3857" class="pw-post-body-paragraph kg kh it ki b kj mf kl km kn mg kp kq kr mt kt ku kv mu kx ky kz mv lb lc ld im bi translated"><strong class="ki iu"> api_worker.ex </strong>文件包含了获取给定股票代码的股票报价所需的所有代码。这是Elixir的<strong class="ki iu"> GenServer </strong>行为的非常直接的实现。这方面的代码如下—</p><figure class="nc nd ne nf gt ju"><div class="bz fp l di"><div class="nq nr l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://raw.githubusercontent.com/imeraj/Elixir_Playground/master/broadway_stock/lib/api_worker.ex" rel="noopener ugc nofollow" target="_blank">https://raw . githubusercontent . com/imeraj/Elixir _ Playground/master/Broadway _ stock/lib/API _ worker . ex</a></figcaption></figure><p id="f6a0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这段代码应该很容易理解。有一点需要注意，尽管我把来自https://www.alphavantage.co<a class="ae kf" href="https://www.alphavantage.co" rel="noopener ugc nofollow" target="_blank"><strong class="ki iu"/></a>的API密匙留在了这个文件中。但是对于生产就绪代码，它应该存储在配置文件中，并且应该使用环境变量注入。</p><h1 id="ace4" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">监督树:</h1><p id="1564" class="pw-post-body-paragraph kg kh it ki b kj mf kl km kn mg kp kq kr mt kt ku kv mu kx ky kz mv lb lc ld im bi translated">最后，我们需要在<strong class="ki iu"> application.ex </strong>文件中填充我们的监督树，如下所示</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="d59f" class="nl lg it nh b gy nm nn l no np">children = [<br/>  # Starts a worker by calling: BroadwayStock.Worker.start_link(arg)<br/>  <strong class="nh iu">{BroadwayStock.Worker, []},</strong><br/>  <strong class="nh iu">{Api.Worker, []}</strong><br/>]</span></pre><p id="16ae" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们的应用主管将监督BroadwayStock。工人和<strong class="ki iu"> Api。工人</strong>。</p><h1 id="c347" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">输出:</h1><p id="741d" class="pw-post-body-paragraph kg kh it ki b kj mf kl km kn mg kp kq kr mt kt ku kv mu kx ky kz mv lb lc ld im bi translated">我运行了以下命令来编译和加载iex中的应用程序—</p><blockquote class="mw mx my"><p id="f2e6" class="kg kh le ki b kj kk kl km kn ko kp kq mz ks kt ku na kw kx ky nb la lb lc ld im bi translated">$ mix编译</p><p id="1bb6" class="kg kh le ki b kj kk kl km kn ko kp kq mz ks kt ku na kw kx ky nb la lb lc ld im bi translated">$ iex -S混合</p></blockquote><p id="9c05" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来是—</p><blockquote class="mw mx my"><p id="5b0f" class="kg kh le ki b kj kk kl km kn ko kp kq mz ks kt ku na kw kx ky nb la lb lc ld im bi translated">$ BraodwayStock.dispatch</p></blockquote><p id="0a19" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这应该每12秒产生一行输出，应该如下所示</p><blockquote class="mw mx my"><p id="e996" class="kg kh le ki b kj kk kl km kn ko kp kq mz ks kt ku na kw kx ky nb la lb lc ld im bi translated">EOD——3.91美元<br/>油井——44.40美元<br/>WCC——23.54美元<br/>WST——158.14美元<br/>沃尔玛——32.03美元<br/>WALA——23.00美元</p></blockquote><h1 id="5dab" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated"><strong class="ak">批处理</strong></h1><p id="0f0b" class="pw-post-body-paragraph kg kh it ki b kj mf kl km kn mg kp kq kr mt kt ku kv mu kx ky kz mv lb lc ld im bi translated">百老汇管道也允许成批处理。我没有在这个例子中使用，因为没有太多的范围。但是你可以在官方文件中读到如何做——<a class="ae kf" href="https://hexdocs.pm/broadway/rabbitmq.html" rel="noopener ugc nofollow" target="_blank">https://hexdocs.pm/broadway/rabbitmq.html</a></p><h1 id="b354" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated"><strong class="ak">结束语</strong></h1><p id="5cf1" class="pw-post-body-paragraph kg kh it ki b kj mf kl km kn mg kp kq kr mt kt ku kv mu kx ky kz mv lb lc ld im bi translated">尽管我没有用这个简单的应用程序探索百老汇的全部力量，但我认为这将有助于一些人开始使用这个库。示例应用程序的完整代码可以在我的github上找到，这里是<a class="ae kf" href="https://github.com/imeraj/Elixir_Playground/tree/master/broadway_stock" rel="noopener ugc nofollow" target="_blank">https://github . com/imeraj/Elixir _ Playground/tree/master/Broadway _ stock</a></p><p id="6325" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le">更多详细和深入的未来技术帖子请关注我这里或点击</em> <a class="ae kf" href="https://twitter.com/meraj_enigma" rel="noopener ugc nofollow" target="_blank"> <em class="le"> twitter </em> </a> <em class="le">。</em></p><h1 id="56d7" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">参考资料:</h1><p id="b62b" class="pw-post-body-paragraph kg kh it ki b kj mf kl km kn mg kp kq kr mt kt ku kv mu kx ky kz mv lb lc ld im bi translated">[1]https://github.com/dashbitco/broadway的百老汇— <a class="ae kf" href="https://github.com/dashbitco/broadway" rel="noopener ugc nofollow" target="_blank"/></p><p id="7fc4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">[2]rabbit MQ的百老汇制作人—<a class="ae kf" href="https://github.com/dashbitco/broadway_rabbitmq" rel="noopener ugc nofollow" target="_blank">https://github.com/dashbitco/broadway_rabbitmq</a></p><p id="52f0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">[3] BroadwayStock app的源代码—<a class="ae kf" href="https://github.com/imeraj/Elixir_Playground/tree/master/broadway_stock" rel="noopener ugc nofollow" target="_blank">https://github . com/imeraj/Elixir _ Playground/tree/master/Broadway _ stock</a></p></div></div>    
</body>
</html>