<html>
<head>
<title>Package and deploy a Lambda function as a Docker container with AWS CDK</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS CDK将Lambda函数打包并部署为Docker容器</h1>
<blockquote>原文：<a href="https://itnext.io/package-and-deploy-a-lambda-function-as-a-docker-container-with-aws-cdk-fd0df5e37de7?source=collection_archive---------0-----------------------#2022-05-03">https://itnext.io/package-and-deploy-a-lambda-function-as-a-docker-container-with-aws-cdk-fd0df5e37de7?source=collection_archive---------0-----------------------#2022-05-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d8ab" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated"><em class="kf">使用基础设施即代码(IaaC)为Slack部署无服务器后端</em></h2></div><p id="2ca1" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">我在<a class="ae lc" rel="noopener ugc nofollow" target="_blank" href="/using-aws-lambda-function-url-to-build-a-serverless-backend-for-slack-a292ef355a5d">之前的一篇博文</a>讲述了如何通过使用<a class="ae lc" href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-urls.html" rel="noopener ugc nofollow" target="_blank"> Lambda函数URL </a>作为一个webhook来为Slack构建一个无服务器的后端。</p><div class="ld le gp gr lf lg"><a rel="noopener  ugc nofollow" target="_blank" href="/using-aws-lambda-function-url-to-build-a-serverless-backend-for-slack-a292ef355a5d"><div class="lh ab fo"><div class="li ab lj cl cj lk"><h2 class="bd ir gy z fp ll fr fs lm fu fw ip bi translated">使用AWS Lambda函数URL构建Slack的无服务器后端</h2><div class="ln l"><h3 class="bd b gy z fp ll fr fs lm fu fw dk translated">与Giphy API集成的Slack应用程序</h3></div><div class="lo l"><p class="bd b dl z fp ll fr fs lm fu fw dk translated">itnext.io</p></div></div><div class="lp l"><div class="lq l lr ls lt lp lu lv lg"/></div></div></a></div><p id="2162" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">因为我想专注于应用程序本身，所以简化了基础设施设置部分——使用AWS CLI，将函数打包为zip文件，进行配置，最后创建一个函数URL以及所需的权限。</p><p id="46f6" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">在这篇博客中，您将最终部署相同的解决方案，但这次使用IaaC(基础设施即代码)和<a class="ae lc" href="https://docs.aws.amazon.com/cdk/v2/guide/home.html" rel="noopener ugc nofollow" target="_blank"> AWS云开发套件</a> (CDK)，这是一个用代码定义云基础设施并通过AWS CloudFormation提供它的框架。您可以从支持的编程语言列表中进行选择(在编写时— TypeScript、JavaScript、Python、Java、C#/。Net，并(在开发者预览版中))将基础设施组件定义为代码，就像您对任何其他应用程序所做的那样！</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi lw"><img src="../Images/43631b18a68f2bdc0d3f0edbe4d2f407.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0wqYiMf898PPE2Or"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">Guillaume Bolduc 在<a class="ae lc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="0a5b" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">您将学习如何使用<a class="ae lc" href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2" rel="noopener ugc nofollow" target="_blank"> Go CDK库</a>来处理基础设施组件:</p><ul class=""><li id="35ce" class="ml mm iq ki b kj kk km kn kp mn kt mo kx mp lb mq mr ms mt bi translated">定义一个λ函数，</li><li id="592b" class="ml mm iq ki b kj mu km mv kp mw kt mx kx my lb mq mr ms mt bi translated">添加一个Lambda函数URL，</li><li id="c299" class="ml mm iq ki b kj mu km mv kp mw kt mx kx my lb mq mr ms mt bi translated">将函数部署为Docker容器(不是zip文件)</li></ul><p id="bcd1" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">在这篇博文结束时，你应该已经有了和之前的<a class="ae lc" rel="noopener ugc nofollow" target="_blank" href="/using-aws-lambda-function-url-to-build-a-serverless-backend-for-slack-a292ef355a5d">博客</a>中描述的一样的设置。</p><blockquote class="mz na nb"><p id="d29f" class="kg kh nc ki b kj kk jr kl km kn ju ko nd kq kr ks ne ku kv kw nf ky kz la lb ij bi translated"><em class="iq">代号为</em> <a class="ae lc" href="https://github.com/abhirockzz/awsome-slack-backend" rel="noopener ugc nofollow" target="_blank"> <em class="iq">可在GitHub </em> </a> <em class="iq">上获得，一如既往！</em></p></blockquote><h1 id="9986" class="ng nh iq bd ni nj nk nl nm nn no np nq jw nr jx ns jz nt ka nu kc nv kd nw nx bi translated">先决条件</h1><ul class=""><li id="8818" class="ml mm iq ki b kj ny km nz kp oa kt ob kx oc lb mq mr ms mt bi translated"><a class="ae lc" href="https://portal.aws.amazon.com/gp/aws/developer/registration/index.html" rel="noopener ugc nofollow" target="_blank">创建一个AWS帐户</a>(如果您还没有)并登录。您使用的IAM用户必须有足够的权限进行必要的AWS服务调用和管理AWS资源。</li><li id="51f4" class="ml mm iq ki b kj mu km mv kp mw kt mx kx my lb mq mr ms mt bi translated">安装<a class="ae lc" href="https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html#getting_started_install" rel="noopener ugc nofollow" target="_blank">自动气象站CDK </a></li><li id="0442" class="ml mm iq ki b kj mu km mv kp mw kt mx kx my lb mq mr ms mt bi translated">设置<a class="ae lc" href="https://docs.docker.com/get-docker/" rel="noopener ugc nofollow" target="_blank">码头</a></li><li id="b13d" class="ml mm iq ki b kj mu km mv kp mw kt mx kx my lb mq mr ms mt bi translated"><a class="ae lc" href="https://go.dev/dl/" rel="noopener ugc nofollow" target="_blank">安装Go </a></li><li id="8ed8" class="ml mm iq ki b kj mu km mv kp mw kt mx kx my lb mq mr ms mt bi translated"><a class="ae lc" href="https://git-scm.com/downloads" rel="noopener ugc nofollow" target="_blank">安装Git </a></li><li id="5e80" class="ml mm iq ki b kj mu km mv kp mw kt mx kx my lb mq mr ms mt bi translated"><a class="ae lc" href="https://slack.com/create" rel="noopener ugc nofollow" target="_blank">如果没有，创建一个宽松的工作空间</a>。</li><li id="e486" class="ml mm iq ki b kj mu km mv kp mw kt mx kx my lb mq mr ms mt bi translated">创建一个GIHPY帐户(这是免费的！)和<a class="ae lc" href="https://developers.giphy.com/dashboard/?create=true" rel="noopener ugc nofollow" target="_blank">创建一个app </a>。您创建的每个应用程序都有自己的API密钥。</li></ul></div><div class="ab cl od oe hu of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="ij ik il im in"><h1 id="5395" class="ng nh iq bd ni nj ok nl nm nn ol np nq jw om jx ns jz on ka nu kc oo kd nw nx bi translated">IaaC的CDK—快速浏览</h1><p id="fcb2" class="pw-post-body-paragraph kg kh iq ki b kj ny jr kl km nz ju ko kp op kr ks kt oq kv kw kx or kz la lb ij bi translated">CDK代码非常简洁，但它完成了工作！让我们快速浏览一遍。</p><p id="4d33" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">首先，我们定义函数及其打包格式(作为Docker容器):</p><pre class="lx ly lz ma gt os ot ou ov aw ow bi"><span id="46eb" class="ox nh iq ot b gy oy oz l pa pb"><em class="nc">// environment variable for Lambda function</em><br/>lambdaEnvVars := &amp;map[string]*string{slackSecretEnvVar: jsii.String(slackSecret), giphyAPIKeyEnvVar: jsii.String(giphyAPIKey)}</span><span id="21e5" class="ox nh iq ot b gy pc oz l pa pb">function := awslambda.NewDockerImageFunction(stack, jsii.String("awsome-func-docker"), &amp;awslambda.DockerImageFunctionProps{FunctionName: jsii.String(functionName), Environment: lambdaEnvVars, Code: awslambda.DockerImageCode_FromImageAsset(jsii.String("../function"), nil)})</span></pre><p id="bca1" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">注意<a class="ae lc" href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2@v2.22.0/awslambda#NewDockerImageFunction" rel="noopener ugc nofollow" target="_blank"> NewDockerImageFunction </a>是如何被使用的(传统上，人们会使用<a class="ae lc" href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2@v2.22.0/awslambda#NewFunction" rel="noopener ugc nofollow" target="_blank"> NewFunction </a>并引用一个zip文件进行部署)。在这种情况下，我们指向函数代码所在的文件夹(使用<a class="ae lc" href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2@v2.22.0/awslambda#DockerImageCode_FromImageAsset" rel="noopener ugc nofollow" target="_blank">DockerImageCode _ from imageasset</a>)。</p><p id="e41a" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">对于要打包成Docker映像的函数，我使用了<a class="ae lc" href="https://gallery.ecr.aws/lambda/go" rel="noopener ugc nofollow" target="_blank"> Go:1.x基础映像</a> ( <a class="ae lc" href="https://github.com/abhirockzz/awsome-slack-backend/blob/master/function/Dockerfile" rel="noopener ugc nofollow" target="_blank">参见Dockerfile </a>)。但是，你也可以探索其他的选择。在部署期间，Docker映像在本地构建，被推送到一个<a class="ae lc" href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/Registries.html" rel="noopener ugc nofollow" target="_blank">私有ECR注册表</a>，最后Lambda函数被创建——所有这一切，只需几行代码！</p><p id="acde" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">使用<a class="ae lc" href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2@v2.22.0/awslambda#NewFunctionUrl" rel="noopener ugc nofollow" target="_blank"> NewFunctionUrl </a>函数URL位很简单:</p><pre class="lx ly lz ma gt os ot ou ov aw ow bi"><span id="6588" class="ox nh iq ot b gy oy oz l pa pb">funcURL := awslambda.NewFunctionUrl(stack, jsii.String("awsome-func-url"), &amp;awslambda.FunctionUrlProps{AuthType: awslambda.FunctionUrlAuthType_NONE, Function: function})</span></pre><blockquote class="mz na nb"><p id="bca0" class="kg kh nc ki b kj kk jr kl km kn ju ko nd kq kr ks ne ku kv kw nf ky kz la lb ij bi translated"><em class="iq">在这个示例应用程序中，我们使用</em> <code class="fe pd pe pf ot b"><em class="iq">NONE</em></code> <em class="iq">作为认证类型。这意味着Lambda函数的URL将可以公开访问</em></p></blockquote></div><div class="ab cl od oe hu of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="ij ik il im in"><h1 id="398d" class="ng nh iq bd ni nj ok nl nm nn ol np nq jw om jx ns jz on ka nu kc oo kd nw nx bi translated">在空闲时创建/配置命令</h1><p id="d213" class="pw-post-body-paragraph kg kh iq ki b kj ny jr kl km nz ju ko kp op kr ks kt oq kv kw kx or kz la lb ij bi translated">首先登录你的<a class="ae lc" href="https://slack.com/signin" rel="noopener ugc nofollow" target="_blank"> Slack Workspace </a>和<a class="ae lc" href="https://api.slack.com/apps/new" rel="noopener ugc nofollow" target="_blank">创建一个新的Slack应用</a>。</p><p id="dedc" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">完成后，创建一个斜线命令——转到应用程序的设置页面，然后在导航菜单中点击<em class="nc">斜线命令</em>功能。您将看到一个标有<em class="nc">创建新命令</em>的按钮，当您点击它时，您将看到一个屏幕，要求您用所需信息定义新的<em class="nc">斜线命令</em>。</p><p id="0e31" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">输入所需信息:</p><ul class=""><li id="339d" class="ml mm iq ki b kj kk km kn kp mn kt mo kx mp lb mq mr ms mt bi translated"><code class="fe pd pe pf ot b">/awsome</code>为命令。</li><li id="f1f2" class="ml mm iq ki b kj mu km mv kp mw kt mx kx my lb mq mr ms mt bi translated">在“请求URL”部分，输入一个虚拟URL，例如<a class="ae lc" href="https://comingsoon.com" rel="noopener ugc nofollow" target="_blank">https://comingsoon.com</a></li></ul><blockquote class="mz na nb"><p id="e5ab" class="kg kh nc ki b kj kk jr kl km kn ju ko nd kq kr ks ne ku kv kw nf ky kz la lb ij bi translated"><em class="iq">这是临时的，部署后将被Lambda函数URL替换</em></p></blockquote><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi pg"><img src="../Images/224538e0ae078fe7cbb4ebb1fafe542a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-Ry-Gk31gEGq8B_H.png"/></div></div></figure><p id="6efd" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">最后，将应用程序安装到您的工作区—单击导航菜单中的<em class="nc">基本信息</em>功能，选择<em class="nc">将应用程序安装到您的工作区</em>，然后单击<em class="nc">将应用程序安装到工作区</em>。这将把应用程序安装到您的Slack工作区，以测试您的应用程序并生成您需要与Slack API交互的令牌。</p><p id="8245" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">一旦你安装完应用程序，<em class="nc">应用程序凭证</em>就会出现在同一页面上。你需要从那里获取你的<em class="nc">松弛签名秘密</em></p><blockquote class="mz na nb"><p id="2af2" class="kg kh nc ki b kj kk jr kl km kn ju ko nd kq kr ks ne ku kv kw nf ky kz la lb ij bi translated"><em class="iq">记下你的应用签名密码，因为你以后会用到它</em></p></blockquote><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi ph"><img src="../Images/3e5b45aa214c3a22b4c762f27817cd9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5Pt3EOu57r1M6Ew0.png"/></div></div></figure><h1 id="cad4" class="ng nh iq bd ni nj nk nl nm nn no np nq jw nr jx ns jz nt ka nu kc nv kd nw nx bi translated">使用CDK部署该功能并更新备用配置</h1><p id="8d0c" class="pw-post-body-paragraph kg kh iq ki b kj ny jr kl km nz ju ko kp op kr ks kt oq kv kw kx or kz la lb ij bi translated">克隆Github repo并移动到正确的目录:</p><pre class="lx ly lz ma gt os ot ou ov aw ow bi"><span id="b8a1" class="ox nh iq ot b gy oy oz l pa pb">git clone https://github.com/abhirockzz/awsome-slack-backend<br/>cd awsome-slack-backend/function</span></pre><p id="44a6" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">构建Go函数:</p><pre class="lx ly lz ma gt os ot ou ov aw ow bi"><span id="e6b6" class="ox nh iq ot b gy oy oz l pa pb">GOOS=linux go build -o awsome</span></pre><p id="a023" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">部署功能:</p><pre class="lx ly lz ma gt os ot ou ov aw ow bi"><span id="73fb" class="ox nh iq ot b gy oy oz l pa pb">export SLACK_SIGNING_SECRET=&lt;enter the slack signing secret&gt;<br/>export GIPHY_API_KEY=&lt;enter the giphy API key&gt;</span><span id="8633" class="ox nh iq ot b gy pc oz l pa pb">cd ../cdk &amp;&amp; cdk deploy</span></pre><blockquote class="mz na nb"><p id="c6fc" class="kg kh nc ki b kj kk jr kl km kn ju ko nd kq kr ks ne ku kv kw nf ky kz la lb ij bi translated"><em class="iq">记下作为输出接收的Lambda函数URL</em></p></blockquote><p id="9c50" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">回到Slack并更新配置以反映Lambda函数URL。</p><p id="8f9b" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">一切都已经设置和配置好了。现在转到您的Slack工作区，调用您刚刚配置的Slack命令！试试这个:</p><pre class="lx ly lz ma gt os ot ou ov aw ow bi"><span id="3011" class="ox nh iq ot b gy oy oz l pa pb">/awsome serverless</span></pre></div><div class="ab cl od oe hu of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="ij ik il im in"><h1 id="40d1" class="ng nh iq bd ni nj ok nl nm nn ol np nq jw om jx ns jz on ka nu kc oo kd nw nx bi translated">清除</h1><p id="5104" class="pw-post-body-paragraph kg kh iq ki b kj ny jr kl km nz ju ko kp op kr ks kt oq kv kw kx or kz la lb ij bi translated">完成后，您可以删除该功能和相关资源:</p><pre class="lx ly lz ma gt os ot ou ov aw ow bi"><span id="9c35" class="ox nh iq ot b gy oy oz l pa pb">cdk destroy</span></pre><p id="ff9d" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">在这篇博文中，我们介绍了如何使用AWS CDK简化我们的无服务器后端的部署过程！</p></div></div>    
</body>
</html>