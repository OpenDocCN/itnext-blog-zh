<html>
<head>
<title>Kubernetes on Devstack part 2: Manually setting up a Kubernetes cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">第2部分:手动设置Kubernetes集群</h1>
<blockquote>原文：<a href="https://itnext.io/a-kubernetes-cluster-with-openstack-cloud-provider-and-cinder-plugin-b3f058ce898c?source=collection_archive---------4-----------------------#2020-11-06">https://itnext.io/a-kubernetes-cluster-with-openstack-cloud-provider-and-cinder-plugin-b3f058ce898c?source=collection_archive---------4-----------------------#2020-11-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c127" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本页是关于在OpenStack 上运行Kubernetes集群的<a class="ae kl" href="https://berndbausch.medium.com/running-a-kubernetes-cluster-on-devstack-533d579bb2f9" rel="noopener">系列的第二部分。它基于安装kubernetes的kubernetes.io </a><a class="ae kl" href="https://kubernetes.io/blog/2020/02/07/deploying-external-openstack-cloud-provider-with-kubeadm/" rel="noopener ugc nofollow" target="_blank">博客条目</a>和官方<a class="ae kl" href="https://github.com/kubernetes/cloud-provider-openstack/tree/master/docs" rel="noopener ugc nofollow" target="_blank"> OpenStack-Kubernetes云提供商文档</a>。</p><p id="7473" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<a class="ae kl" href="https://berndbausch.medium.com/a-single-server-devstack-cloud-as-a-kubernetes-platform-cd30e28e405a" rel="noopener">部署Devstack cloud </a>之后，您将使用<em class="km"> kubeadm </em>在主实例和工作实例上启动Kubernetes集群。然后，您将添加OpenStack云提供商和Cinder CSI插件。这将使您能够启动Kubernetes<em class="km">load balancer</em>服务，并使用由OpenStack资源实现的持久卷。</p><ol class=""><li id="63dd" class="kn ko iq jp b jq jr ju jv jy kp kc kq kg kr kk ks kt ku kv bi translated"><a class="ae kl" href="https://medium.com/p/b3f058ce898c#3aae" rel="noopener">安装Kubernetes </a></li><li id="ec0f" class="kn ko iq jp b jq kw ju kx jy ky kc kz kg la kk ks kt ku kv bi translated"><a class="ae kl" href="https://medium.com/p/b3f058ce898c#99aa" rel="noopener">构建Kubernetes集群</a></li><li id="7a59" class="kn ko iq jp b jq kw ju kx jy ky kc kz kg la kk ks kt ku kv bi translated"><a class="ae kl" href="https://medium.com/p/b3f058ce898c#5b15" rel="noopener">安装OpenStack云提供商</a></li><li id="27c2" class="kn ko iq jp b jq kw ju kx jy ky kc kz kg la kk ks kt ku kv bi translated"><a class="ae kl" href="https://medium.com/p/b3f058ce898c#7c34" rel="noopener">安装CSI Cinder插件</a></li></ol><h1 id="3aae" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">安装Kubernetes</h1><p id="7ac5" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">首先，登录到主节点和工作节点，并将它们的主机名设置为各自的OpenStack实例名。</p><p id="a5fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Devstack服务器上，列出实例:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="c75b" class="mn lc iq mj b gy mo mp l mq mr">$ source ~/devstack/openrc kube kube <br/>$ openstack server list +--------+---------+--------+-------------------------------------+---------+---------+<br/>| ID     | Name    | Status | Networks                            | Image   | Flavor  |<br/>+--------+---------+--------+-------------------------------------+---------+---------+<br/>| 32d... | worker1 | ACTIVE | kubenet=172.16.0.99, 192.168.1.228  | centos7 | ds4G    |<br/>| cf8... | master1 | ACTIVE | kubenet=172.16.0.169, 192.168.1.221 | centos7 | ds4G    |<br/>+--------+---------+--------+-------------------------------------+---------+---------+</span></pre><p id="52c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果这些实例不存在，根据<a class="ae kl" href="https://github.com/berndbausch/Devstack-Kubernetes/blob/main/devstack-setup.md#configuring-your-cloud" rel="noopener ugc nofollow" target="_blank">准备脚本</a>创建它们。</p><p id="b4a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要登录一个实例，您需要它的IP地址和SSH密钥。上面输出中每个实例的第二个IP地址是它的浮动IP。如果您使用准备脚本创建了实例，那么键就是$HOME/kubekey。</p><p id="cbba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">登录到服务器并修复它们的主机名。还要将主机名添加到/etc/hosts中。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="a7d0" class="mn lc iq mj b gy mo mp l mq mr">$ ssh -i kubekey centos@192.168.1.221 <br/>$ sudo hostnamectl set-hostname master1 <br/>$ echo 192.168.1.221 master1 | sudo tee -a /etc/hosts <br/>$ echo 192.168.1.228 worker1 | sudo tee -a /etc/hosts <br/>$ exit <br/>$ ssh -i kubekey centos@192.168.1.228 <br/>$ sudo hostnamectl set-hostname worker1 <br/>$ echo 192.168.1.221 master1 | sudo tee -a /etc/hosts <br/>$ echo 192.168.1.228 worker1 | sudo tee -a /etc/hosts <br/>$ exit</span></pre><p id="ce23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，在主节点和工作节点这两个节点上安装Docker和Kubernetes软件。你可以平行地做那件事。</p><p id="dd88" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最简单的方法是运行<a class="ae kl" href="https://github.com/berndbausch/Devstack-Kubernetes/blob/main/install-node.sh" rel="noopener ugc nofollow" target="_blank">安装节点</a>脚本。这个脚本逐字摘自kubernetes.io <a class="ae kl" href="https://kubernetes.io/blog/2020/02/07/deploying-external-openstack-cloud-provider-with-kubeadm/#install-docker-and-kubernetes" rel="noopener ugc nofollow" target="_blank">博客文章</a>。随意手动执行博客中的步骤，但是在<code class="fe ms mt mu mj b">modprobe br_netfilter</code>之后停止。</p><h1 id="99aa" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">构建Kubernetes集群</h1><p id="ca19" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">以下说明略微改编自官方<a class="ae kl" href="https://github.com/kubernetes/cloud-provider-openstack/blob/release-1.19/docs/using-openstack-cloud-controller-manager.md" rel="noopener ugc nofollow" target="_blank"> OpenStack云提供商</a>文档。</p><h2 id="2f96" class="mn lc iq bd ld mv mw dn lh mx my dp ll jy mz na lp kc nb nc lt kg nd ne lx nf bi translated">引导集群</h2><p id="10ff" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">在主服务器上，下载<a class="ae kl" href="https://github.com/berndbausch/Devstack-Kubernetes/blob/main/manifests/kubeadm-config-os.yaml" rel="noopener ugc nofollow" target="_blank"> kubeadm-config-os.yaml </a>并将其输入<em class="km"> kubeadm </em>以构建一个简单的集群。<em class="km"> kubeadm </em>命令<strong class="jp ir">必须以root </strong>身份运行。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="06ea" class="mn lc iq mj b gy mo mp l mq mr">$ sudo kubeadm init --config kubeadm-config-os.yaml</span></pre><p id="c554" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这需要几分钟时间。在这段时间里，你可能想看看<em class="km"> kubeadm-config-os.yaml </em>。它配置了一个外部云提供商，并定义了一个10.244.0.0/16的pod子网。</p><p id="a5d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当<em class="km"> kubeadm </em>完成时，它会告诉你如何创建一个<em class="km">。kube </em>配置目录以及如何向集群添加其他节点:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="8d6e" class="mn lc iq mj b gy mo mp l mq mr">Your Kubernetes control-plane has initialized successfully!<br/><br/>To start using your cluster, you need to run the following as a regular user:<br/><br/>  mkdir -p $HOME/.kube<br/>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br/>  sudo chown $(id -u):$(id -g) $HOME/.kube/config<br/><br/>You should now deploy a pod network to the cluster.<br/>Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:<br/>  https://kubernetes.io/docs/concepts/cluster-administration/addons/<br/><br/>Then you can join any number of worker nodes by running the following on each as root:<br/><br/>kubeadm join 172.16.0.152:6443 --token arr5on.ecrqdbjpt9vqr44z \<br/>	--discovery-token-ca-cert-hash sha256:8c9cae87374f82f18be7ca1bad17c77c30ff1f58b920d37e6d6e5956badc1114</span></pre><p id="6ac9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创造<em class="km">。kube/config </em>按照指示。记下<em class="km"> kubeadm join </em>命令，但不要执行它。</p><h2 id="01af" class="mn lc iq bd ld mv mw dn lh mx my dp ll jy mz na lp kc nb nc lt kg nd ne lx nf bi translated">添加网络插件</h2><p id="28c9" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">例如，以<strong class="jp ir">非特权centos用户</strong>的身份安装法兰绒run <em class="km"> kubectl </em>:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="ad96" class="mn lc iq mj b gy mo mp l mq mr">$ kubectl apply -f <a class="ae kl" href="https://github.com/coreos/flannel/raw/master/Documentation/kube-flannel.yml" rel="noopener ugc nofollow" target="_blank">https://github.com/coreos/flannel/raw/master/Documentation/kube-flannel.yml</a></span></pre><h2 id="b5da" class="mn lc iq bd ld mv mw dn lh mx my dp ll jy mz na lp kc nb nc lt kg nd ne lx nf bi translated">将工作实例加入集群</h2><p id="c1b9" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">检查worker节点上的Docker和Kubernetes安装是否完成。一旦完成，在worker节点上以root身份运行上面的<em class="km"> kubeadm join </em>命令<strong class="jp ir">。</strong></p><p id="4e1c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完成后，在主上<strong class="jp ir">，用检查结果</strong></p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="7c9f" class="mn lc iq mj b gy mo mp l mq mr">$ kubectl get nodes<br/>NAME      STATUS   ROLES    AGE     VERSION<br/>master1   Ready    master   7m37s   v1.19.2<br/>worker1   Ready    &lt;none&gt;   58s     v1.19.2</span></pre><p id="a12d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果<em class="km">工人1 </em>未准备好，几秒钟后再次检查。</p><h2 id="3dc5" class="mn lc iq bd ld mv mw dn lh mx my dp ll jy mz na lp kc nb nc lt kg nd ne lx nf bi translated">确认集群正在工作</h2><p id="a67c" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">您现在有了一个工作的Kubernetes集群。您可以随意使用一些<em class="km"> kubectl get </em>命令来探索它，或者在它上面部署一个应用程序。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="21e3" class="mn lc iq mj b gy mo mp l mq mr">$ kubectl get pods -n kube-system<br/>NAME                              READY   STATUS    RESTARTS   AGE<br/>coredns-f9fd979d6-hwmpf           1/1     Running   0          9m12s<br/>coredns-f9fd979d6-kht96           1/1     Running   0          9m12s<br/>etcd-master1                      1/1     Running   0          9m19s<br/>kube-apiserver-master1            1/1     Running   0          9m19s<br/>kube-controller-manager-master1   1/1     Running   0          9m19s<br/>kube-flannel-ds-c27nb             1/1     Running   0          2m53s<br/>kube-flannel-ds-zpbkr             1/1     Running   0          3m43s<br/>kube-proxy-dxnck                  1/1     Running   0          9m12s<br/>kube-proxy-hl62l                  1/1     Running   0          2m53s<br/>kube-scheduler-master1            1/1     Running   0          9m19s</span></pre><h1 id="5b15" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">安装OpenStack云提供商</h1><p id="7e1a" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">OpenStack cloud provider使Kubernetes集群能够管理在OpenStack实例上实现的节点，并使用OpenStack负载平衡器。</p><p id="5d46" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要安装和配置它，需要以下组件:</p><ul class=""><li id="e14b" class="kn ko iq jp b jq jr ju jv jy kp kc kq kg kr kk ng kt ku kv bi translated">云身份验证详细信息</li><li id="2dee" class="kn ko iq jp b jq kw ju kx jy ky kc kz kg la kk ng kt ku kv bi translated">其他云详细信息，如负载平衡器所连接的网络</li><li id="248d" class="kn ko iq jp b jq kw ju kx jy ky kc kz kg la kk ng kt ku kv bi translated">云控制器经理的RBAC角色</li><li id="a300" class="kn ko iq jp b jq kw ju kx jy ky kc kz kg la kk ng kt ku kv bi translated">云控制器管理器</li></ul><h2 id="9998" class="mn lc iq bd ld mv mw dn lh mx my dp ll jy mz na lp kc nb nc lt kg nd ne lx nf bi translated">配置身份验证和网络详细信息</h2><p id="811f" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">下面的模板包含了云的细节(点1和点2)。他们告诉Cinder CSI插件如何访问云。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="cbc6" class="mn lc iq mj b gy mo mp l mq mr">[Global]<br/>region=RegionOne<br/>username=kube<br/>password=pw<br/>auth-url=http://&lt;&lt;DEVSTACK-SERVER-IP/identity/v3&gt;&gt;<br/>tenant-id=&lt;&lt;KUBE-PROJECT-ID&gt;&gt;<br/>domain-id=default</span><span id="e132" class="mn lc iq mj b gy nh mp l mq mr">[LoadBalancer]<br/>network-id=&lt;&lt;ID-OF-KUBENET-NETWORK&gt;&gt; </span><span id="68a8" class="mn lc iq mj b gy nh mp l mq mr">[Networking]<br/>public-network-name=public</span></pre><p id="0f5f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要获得<code class="fe ms mt mu mj b">KUBE-PROJECT-ID</code>和<code class="fe ms mt mu mj b">ID-OF-KUBENET-NETWORK</code>，在Devstack服务器上运行这些命令<strong class="jp ir">:</strong></p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="c4d1" class="mn lc iq mj b gy mo mp l mq mr">$ source ~/devstack/openrc kube kube<br/>$ openstack project show kube -c id<br/>+-------+----------------------------------+<br/>| Field | Value                            |<br/>+-------+----------------------------------+<br/>| id    | 7a099eff1fb1479b89fa721da3e1a018 |<br/>+-------+----------------------------------+<br/><br/>$ openstack network list -c ID -c Name<br/>+--------------------------------------+---------+<br/>| ID                                   | Name    |<br/>+--------------------------------------+---------+<br/>| 0e80607f-7cd1-4fe5-a782-3459fa447202 | public  |<br/>| dd07c40e-5e6d-4f4c-bb66-cfdcee6dbc70 | kubenet |<br/>| e9bbe2fc-daa3-4cdf-aaf3-4c65c8a1a321 | shared  |<br/>+--------------------------------------+---------+</span></pre><p id="c6b1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">在主节点</strong>上，将上述模板复制到名为<em class="km"> cloud.conf </em>的文件中，并替换两个id以及Devstack服务器的IP地址。由于此配置包含密码，因此必须将其转换为密码:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="f7f4" class="mn lc iq mj b gy mo mp l mq mr">$ kubectl create secret -n kube-system generic cloud-config \<br/>                        --from-file=cloud.conf</span></pre><h2 id="22af" class="mn lc iq bd ld mv mw dn lh mx my dp ll jy mz na lp kc nb nc lt kg nd ne lx nf bi translated">创建RBAC资源</h2><p id="73e5" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">使用OpenStack云提供商报告中的清单来创建RBAC资源。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="c0ee" class="mn lc iq mj b gy mo mp l mq mr">kubectl apply -f https://raw.githubusercontent.com/kubernetes/cloud-provider-openstack/master/cluster/addons/rbac/cloud-controller-manager-roles.yaml<br/>kubectl apply -f https://raw.githubusercontent.com/kubernetes/cloud-provider-openstack/master/</span></pre><h2 id="bb5d" class="mn lc iq bd ld mv mw dn lh mx my dp ll jy mz na lp kc nb nc lt kg nd ne lx nf bi translated">启动控制器管理器</h2><p id="fa17" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">使用Github上OpenStack云提供商repo中的清单。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="4d39" class="mn lc iq mj b gy mo mp l mq mr">kubectl apply -f <a class="ae kl" href="https://raw.githubusercontent.com/kubernetes/cloud-provider-openstack/master/manifests/controller-manager/openstack-cloud-controller-manager-ds.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kubernetes/cloud-provider-openstack/master/manifests/controller-manager/openstack-cloud-controller-manager-ds.yaml</a></span></pre><p id="251f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当控制器管理器启动时，探索它的清单可能是有益的。云控制器被实现为具有单个容器的<em class="km"> daemonset </em>。看看容器中的命令及其选项。分析这个秘密是如何使用的:它被挂载为一个名为<em class="km"> cloud-config-volume </em>的卷。</p><p id="881d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动将需要几秒钟才能完成。用…检验它的成功</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="b4c3" class="mn lc iq mj b gy mo mp l mq mr">$ kubectl -n kube-system get daemonset,pv,pod<br/>NAME                                                DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR                     AGE<br/>daemonset.apps/kube-flannel-ds                      2         2         2       2            2           &lt;none&gt;                            38m<br/>daemonset.apps/kube-proxy                           2         2         2       2            2           kubernetes.io/os=linux            44m<br/>daemonset.apps/openstack-cloud-controller-manager   1         1         0       1            0           node-role.kubernetes.io/master=   34s<br/><br/>NAME                                           READY   STATUS    RESTARTS   AGE<br/>pod/coredns-f9fd979d6-hwmpf                    1/1     Running   0          44m<br/>pod/coredns-f9fd979d6-kht96                    1/1     Running   0          44m<br/>pod/etcd-master1                               1/1     Running   0          44m<br/>pod/kube-apiserver-master1                     1/1     Running   0          44m<br/>pod/kube-controller-manager-master1            1/1     Running   0          44m<br/>pod/kube-flannel-ds-c27nb                      1/1     Running   0          38m<br/>pod/kube-flannel-ds-zpbkr                      1/1     Running   0          38m<br/>pod/kube-proxy-dxnck                           1/1     Running   0          44m<br/>pod/kube-proxy-hl62l                           1/1     Running   0          38m<br/>pod/kube-scheduler-master1                     1/1     Running   0          44m<br/>pod/openstack-cloud-controller-manager-9c2pp   0/1     Error     1          34s</span></pre><p id="db12" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">(最后一行显示这次发射失败)。</p><p id="9552" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动成功后，您可以通过创建负载平衡器服务来测试它。或者直接跳到<a class="ae kl" href="https://github.com/berndbausch/Devstack-Kubernetes/blob/main/k8s-manual-setup.md#cinder" rel="noopener ugc nofollow" target="_blank"> Cinder CSI插件</a>的安装。</p><h2 id="45cc" class="mn lc iq bd ld mv mw dn lh mx my dp ll jy mz na lp kc nb nc lt kg nd ne lx nf bi translated">故障排除提示</h2><p id="f01c" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">如果过一会儿云控制器管理器pod不处于运行状态<em class="km"/>，您需要找出问题所在。<em class="km"> cloud.conf </em>可能不正确，机密名称可能与云控制器管理器清单不一致，云控制器管理器可能无法连接到云或向其进行身份验证。有关详细信息，请查看pod的日志。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="fa2d" class="mn lc iq mj b gy mo mp l mq mr">$ kubectl -n kube-system logs pod/openstack-cloud-controller-manager-9c2pp<br/>...<br/>... openstack.go:300] failed to read config: 10:11: illegal character U+003A ':'<br/>... controllermanager.go:131] Cloud provider could not be initialized: could not init cloud provider "openstack": 10:11: illegal character U+003A ':'</span></pre><p id="6ccb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个例子中，<em class="km"> cloud.conf </em>在第10行包含了一个冒号而不是等号。通过移除秘密、更正<em class="km"> cloud.conf </em>、重新创建秘密并启动新的daemonset，修复了此问题:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="083e" class="mn lc iq mj b gy mo mp l mq mr">$ kubectl -n kube-system delete secret cloud-config<br/>$ kubectl create secret -n kube-system generic cloud-config --from-file=cloud.conf<br/>$ kubectl -n kube-system delete daemonset.apps/openstack-cloud-controller-manager<br/># wait a moment for this to settle...<br/>$ kubectl apply -f https://raw.githubusercontent.com/kubernetes/cloud-provider-openstack/master/manifests/controller-manager/openstack-cloud-controller-manager-ds.yaml</span></pre><p id="107c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果日志没有足够的信息，请提高日志级别。这是通过<em class="km"> daemonset </em>清单中的选项<code class="fe ms mt mu mj b"> --v</code>完成的。详细级别6包括对OpenStack云的请求的详细信息，在身份验证或其他云操作失败时非常有用。将货单复制到主机，将<em class="km"> </em> <code class="fe ms mt mu mj b"><em class="km">--v=1</em></code>替换为<code class="fe ms mt mu mj b"><em class="km">--v=6</em></code>，并重新应用货单。</p><h1 id="7c34" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">安装CSI Cinder插件</h1><p id="355e" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">Cinder的CSI(云存储接口)允许创建持久卷和由Cinder卷支持的持久卷声明。以下说明基于<a class="ae kl" href="https://github.com/kubernetes/cloud-provider-openstack/blob/master/docs/using-cinder-csi-plugin.md#using-the-manifests" rel="noopener ugc nofollow" target="_blank"> OpenStack云提供商文档</a>。</p><h2 id="9b58" class="mn lc iq bd ld mv mw dn lh mx my dp ll jy mz na lp kc nb nc lt kg nd ne lx nf bi translated">将Cinder CSI清单复制到主机</h2><p id="0757" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">将原始的<a class="ae kl" href="https://github.com/kubernetes/cloud-provider-openstack/tree/release-1.19/manifests/cinder-csi-plugin" rel="noopener ugc nofollow" target="_blank">煤渣CSI清单</a>复制到主机。您可以一个文件一个文件地下载，或者更好的方法是，简单地克隆整个回购协议，或者将回购协议下载为ZIP文件(大约0.5MB)。</p><p id="3014" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<strong class="jp ir">主机</strong>上执行的以下代码下载ZIP文件，并将相关清单复制到一个新的<code class="fe ms mt mu mj b">manifest</code>目录中。不要复制<code class="fe ms mt mu mj b">csi-secret-cinderplugin.yaml</code>，因为云配置秘密已经存在。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="6e9d" class="mn lc iq mj b gy mo mp l mq mr">$ cd<br/>$ mkdir manifests<br/>$ wget https://github.com/kubernetes/cloud-provider-openstack/archive/release-1.19.zip<br/>$ unzip release-1.19.zip<br/>$ cd cloud-provider-openstack-release-1.19/manifests/cinder-csi-plugin<br/>$ cp cinder* csi-cinder-driver.yaml ~/manifests/</span></pre><h2 id="5e61" class="mn lc iq bd ld mv mw dn lh mx my dp ll jy mz na lp kc nb nc lt kg nd ne lx nf bi translated">应用煤渣CSI清单</h2><p id="41f0" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">转到清单目录。如果您想提高容器的日志记录级别，请将<code class="fe ms mt mu mj b"><em class="km">--v=6</em></code>选项添加到<em class="km"> controllerplugin </em>和<em class="km"> nodeplugin </em>清单中的所有容器中。该选项生成大量日志消息，包括插件发布给OpenStack cloud的API的详细信息。</p><p id="928e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用所有清单。这将创建必要的RBAC角色，并启动控制器插件，节点插件和Cinder驱动程序。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="cacd" class="mn lc iq mj b gy mo mp l mq mr">$ cd ~/manifests <br/>$ kubectl apply -f .</span></pre><p id="d77d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">确认所有pod都已启动并运行。如果没有，请参见上面的故障排除部分。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="ae76" class="mn lc iq mj b gy mo mp l mq mr">$ kubectl get pod -n kube-system<br/>NAME                                       READY   STATUS    RESTARTS   AGE<br/>coredns-f9fd979d6-hwmpf                    1/1     Running   0          6h13m<br/>coredns-f9fd979d6-kht96                    1/1     Running   0          6h13m<br/>csi-cinder-controllerplugin-0              5/5     Running   0          7m12s<br/>csi-cinder-nodeplugin-vrczm                2/2     Running   0          7m11s<br/>etcd-master1                               1/1     Running   0          6h14m<br/>kube-apiserver-master1                     1/1     Running   0          6h14m<br/>kube-controller-manager-master1            1/1     Running   0          6h14m<br/>kube-flannel-ds-c27nb                      1/1     Running   0          6h7m<br/>kube-flannel-ds-zpbkr                      1/1     Running   0          6h8m<br/>kube-proxy-dxnck                           1/1     Running   0          6h13m<br/>kube-proxy-hl62l                           1/1     Running   0          6h7m<br/>kube-scheduler-master1                     1/1     Running   0          6h14m<br/>openstack-cloud-controller-manager-t8kfj   1/1     Running   0          5h10m</span></pre><p id="e7d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您应该可以在该集群上启动利用OpenStack负载平衡器和卷服务的应用程序了。</p></div></div>    
</body>
</html>