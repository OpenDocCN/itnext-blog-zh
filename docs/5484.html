<html>
<head>
<title>How to setup CI CD pipelines for Android with Azure DevOps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Azure DevOps为Android设置CI CD管道</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-setup-ci-cd-pipelines-for-android-with-azure-devops-2a4ded0de0e7?source=collection_archive---------0-----------------------#2021-03-16">https://itnext.io/how-to-setup-ci-cd-pipelines-for-android-with-azure-devops-2a4ded0de0e7?source=collection_archive---------0-----------------------#2021-03-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/8056c2ca2b0135a1132c6163f8300f70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bg-tGk-THT_FaGUxbgCL9g.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">CI CD AAB (Android应用捆绑包)到Google Play控制台</figcaption></figure><p id="3911" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">DevOps &amp; CI/CD是一段时间以来的热门词汇，它们已经在当今快速发展的世界和敏捷开发过程中证明了它们的价值。只有当他们真正经历了这一过程，亲眼看到它节省了大量的时间和令人头痛的事情时，他们才能理解真正的价值。</p><p id="b7a8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在<a class="ae la" href="https://royalecheese.com/" rel="noopener ugc nofollow" target="_blank"> Royale Cheese </a>最初我们通过微软的Visual Studio应用中心(曲棍球应用的升级)为Android设置CI/CD，但去年他们宣布<a class="ae la" href="https://devblogs.microsoft.com/appcenter/app-center-mbaas-retirement/" rel="noopener ugc nofollow" target="_blank">的MBaas </a>退休，这让我们担心VS应用中心的整体未来。这是我们想放弃它的原因之一。其次，免费层为每个帐户每月提供大约400分钟的构建时间，这对于其他技术来说已经足够了，但Android需要大约15分钟来创建一个单独的构建和部署。我们都知道格雷能做什么😉。因此，在同一个账户中拥有多个应用程序(包括iOS和Android)并不太好。</p><p id="2384" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们已经将<a class="ae la" href="https://dev.azure.com/" rel="noopener ugc nofollow" target="_blank"> Azure DevOps </a>用于其他技术的CI/CD，这看起来很有前景。它的未来计划没有关闭的问题，它提供了大约1800分钟的免费构建时间。我们决定试一试，到目前为止没有任何抱怨。我们已经开始热爱和崇拜Azure DevOps，并希望它保持这种状态。</p><p id="0f8e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">好吧！问题已经说得够多了，让我们看看如何进行构建和部署。在本教程中，我们将制作更新的<a class="ae la" href="https://developer.android.com/platform/technology/app-bundle" rel="noopener ugc nofollow" target="_blank"> Android应用捆绑包</a>(。aab)而不是。apk上传到Google Play控制台。</p><h1 id="670d" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">先决条件</h1><ul class=""><li id="fef5" class="lz ma iq ke b kf mb kj mc kn md kr me kv mf kz mg mh mi mj bi translated">付费<a class="ae la" href="http://play.google.com/apps/publish/" rel="noopener ugc nofollow" target="_blank">谷歌开发者账号</a>，Play主机上增加的一个应用。</li><li id="ea20" class="lz ma iq ke b kf mk kj ml kn mm kr mn kv mo kz mg mh mi mj bi translated">创建了Android存储库的Azure DevOps帐户</li><li id="4556" class="lz ma iq ke b kf mk kj ml kn mm kr mn kv mo kz mg mh mi mj bi translated">用于签署构建的jks文件</li></ul><h1 id="c72f" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">连续累计</h1><p id="1014" class="pw-post-body-paragraph kc kd iq ke b kf mb kh ki kj mc kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ij bi translated">持续集成是每次变更被推送到存储库时运行构建和测试套件的过程。由于Android构建确实需要大量的时间，并且通常云CI/CD工具会随着构建时间的增加而变得昂贵，因此最好每周安排一次CI管道。我将使用在我的devops帐户中创建的名为<em class="ms"> Android </em>的演示项目来创建ci cd管道。项目有一个空白活动，支持棒棒糖5.0及以上版本。</p><p id="cb67" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">打开您的项目并导航到左侧面板上的<em class="ms">管道</em>部分，如下图所示。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/1a2d632f6d4f0e6aae763ca0a9d9c989.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hSDlfAbBetvjuQa5"/></div></div></figure><p id="3fac" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">点击<em class="ms">创建管道</em>，将打开以下页面。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/34048f42ccc0b8ed39d1875853d030d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0q_Ad3JpZi1pyw-0"/></div></div></figure><p id="8bcc" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这里我们将选择<em class="ms">使用经典编辑器</em>，这比其他选项更容易。其他选项将最终导致编写yaml文件来配置您的管道。</p><p id="1741" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">通常，您可能有开发、qa和/或uat分支要上传到Google Play控制台上的内部或测试频道，并且您只想从您的Google Play控制台将应用程序升级到生产。因此，选择您想要运行构建的分支，然后单击Continue。对我来说，一切都在主枝上。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/54b2d236e213037c54f0d5a5de3ec656.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TcmdzORIH4YBHWqO"/></div></div></figure><p id="a8a5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">理想情况下，我们会被诱惑选择<em class="ms"> Android </em>模板，继续我们的生活；不要这样做。因为<em class="ms"> Android </em>模板没有提供生成。aab文件，我们不打算使用它。请选择一个空作业。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/f41493ba28c71331d39008e5886b0579.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Lf_tLOXkvXTHcBD0"/></div></div></figure><p id="a670" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们现在将有一个空的<em class="ms">代理作业1 </em>，我们将向其中添加任务。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi my"><img src="../Images/71ea90eee8415434d847e60f1dd25405.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nwOfD9DUbyB2eEzL"/></div></div></figure><p id="0d00" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们将不得不执行以下任务来创建我们的CI渠道:</p><ul class=""><li id="9bb9" class="lz ma iq ke b kf kg kj kk kn mz kr na kv nb kz mg mh mi mj bi translated">设置jks文件</li><li id="39e5" class="lz ma iq ke b kf mk kj ml kn mm kr mn kv mo kz mg mh mi mj bi translated">通过gradle进行未签名的构建</li><li id="8dab" class="lz ma iq ke b kf mk kj ml kn mm kr mn kv mo kz mg mh mi mj bi translated">生成。aab文件</li><li id="079b" class="lz ma iq ke b kf mk kj ml kn mm kr mn kv mo kz mg mh mi mj bi translated">创造一件艺术品</li></ul><p id="5fd4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">让我们一步一步地开始。</p><h2 id="0883" class="nc lc iq bd ld nd ne dn lh nf ng dp ll kn nh ni lp kr nj nk lt kv nl nm lx nn bi translated">设置jks文件</h2><p id="6051" class="pw-post-body-paragraph kc kd iq ke b kf mb kh ki kj mc kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ij bi translated">如果你在过去已经上传了一个apk或者aab到play store，你必须使用一个jks文件来签署版本。在这一步中，您应该使用相同的jks文件。如果你还没有生成文件<a class="ae la" href="https://developer.android.com/studio/publish/app-signing#generate-key" rel="noopener ugc nofollow" target="_blank">，这里的</a>是一个很好的文档。</p><p id="2f6b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">得到你的jks文件，因为我们现在要上传它。点击<em class="ms">代理作业1 </em>旁边的<em class="ms"> + </em>符号，将打开要添加的任务列表。搜索<em class="ms">下载安全文件</em>。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/a3fd4f03d8bfc0c528c92ec0000fabd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*js4r4NaNu36Ip2mK"/></div></div></figure><p id="a9f1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">点击<em class="ms">添加</em>按钮添加任务。它会给出一个错误提示<em class="ms">一些设置需要注意</em>。它要求上传一个安全文件。点击<em class="ms">安全文件</em>栏旁边的档位/设置图标，上传您的jks。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/d06e77a53671bf5aed696cafdc56cbe0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lpeO0g0yvTjSmM5D"/></div></div></figure><p id="8841" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们现在将为该文件提供一个名称，以便可以从签名任务中引用它。点击<em class="ms">输出变量</em>下拉菜单，在<em class="ms">参考名称</em>中输入<em class="ms">密钥存储文件</em>。这将更新<em class="ms">变量列表</em>以反映变量名称。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/ff8f513c3140435b7d41c93ac853a1e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QKqaCRFhLjL_0lHi"/></div></div></figure><h2 id="421e" class="nc lc iq bd ld nd ne dn lh nf ng dp ll kn nh ni lp kr nj nk lt kv nl nm lx nn bi translated">未签名的梯度文件</h2><p id="e6ec" class="pw-post-body-paragraph kc kd iq ke b kf mb kh ki kj mc kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ij bi translated">点击<em class="ms">代理作业1 </em>旁边的<em class="ms"> + </em>符号，将打开要添加的任务列表。搜索<em class="ms"> gradle </em>。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/20ab8a7016b4d62c70d4534d215c1dbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WKQ3X-gp-YOEanuC"/></div></div></figure><p id="7b50" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">点击<em class="ms">添加</em>按钮添加任务。我们将关闭<em class="ms"> JUnit测试结果</em>部分下的<em class="ms">发布到Azure管道</em>。你可以根据需要一直戴着它。其次，我们将更新任务名称。因为我们要发布一个构建版本，所以将您的任务名称更新为<em class="ms"> buildRelease </em>。如果你想用一种特殊的风格来建造，你可以相应地更新你的任务名称。例如，如果您使用dev作为风格名称，请将您的任务名称更新为<em class="ms"> buildDevRelease </em>。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/daa1d8e3cc35ac9d3d6cb4ce2869b9db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vB-cVpTtuHPm2K2g"/></div></div></figure><h2 id="0b9e" class="nc lc iq bd ld nd ne dn lh nf ng dp ll kn nh ni lp kr nj nk lt kv nl nm lx nn bi translated">生成。aab文件</h2><p id="ea77" class="pw-post-body-paragraph kc kd iq ke b kf mb kh ki kj mc kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ij bi translated">点击<em class="ms">代理作业1 </em>旁边的<em class="ms"> + </em>符号，将打开要添加的任务列表。搜索<em class="ms">命令行</em>。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi np"><img src="../Images/d33796e64a6868c6de6e18161e12b6cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*F0jFeLEoCuti6noI"/></div></div></figure><p id="dd8e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在<em class="ms">脚本</em>部分，清除该字段并设置以下文本。</p><p id="127f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">复制</p><pre class="mt mu mv mw gt nq nr ns nt aw nu bi"><span id="13ad" class="nc lc iq nr b gy nv nw l nx ny">jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 -keystore $(KeyStoreFile.secureFilePath) -storepass $(StorePassword) -keypass $(KeyPassword) $(system.defaultworkingdirectory)/app/build/outputs/bundle/release/*.aab $(KeyStoreAlias)</span></pre><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/37d133eb1d12c3934b944d5e6800f0e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mjHyZdjLsYu7GEOp"/></div></div></figure><p id="ab79" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">脚本中有4个变量，其中我们已经设置了<em class="ms">keystorefile . securefilepath</em>。设置其他3个变量<em class="ms">存储密码</em>、<em class="ms">密钥密码</em>和<em class="ms">密钥存储别名</em>的时间。导航到点击的<em class="ms">变量</em>选项卡，添加变量及其值，如下图所示。一旦您确定这些值是正确的，您可以单击锁图标来保护它。一旦您锁定并保存，包括您在内的任何人都无法查看它，因此请确保您仍然有详细信息的备份，以防您想在其他地方使用它。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/128a81bc449338c5922550131865b728.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RXtgjzdszOiAPyzO"/></div></div></figure><h2 id="71cd" class="nc lc iq bd ld nd ne dn lh nf ng dp ll kn nh ni lp kr nj nk lt kv nl nm lx nn bi translated">创造一件艺术品</h2><p id="d1b5" class="pw-post-body-paragraph kc kd iq ke b kf mb kh ki kj mc kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ij bi translated">上面的步骤创建了一个。aab文件，但是仍然需要转换成工件，以便它可以用于CD管道的发布。</p><p id="485b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">到现在为止，您已经是向代理作业1 添加任务的专家了。将以下两个任务添加到<em class="ms">代理作业1 </em> : <em class="ms">复制文件</em> &amp; <em class="ms">发布构建工件</em>。为了避免混淆选择哪个任务，我添加了下面的截图。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/d41a0e98e202d748e41c7b07accc8730.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*J0VBMSmY9aUxf2TM"/></div></div></figure><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/ae08f9871218e484cc67bfbffff253cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WuNlP-rAB-nnUdwQ"/></div></div></figure><p id="7b25" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在选择<em class="ms">复制文件</em>任务，在<em class="ms">源文件夹</em>字段中设置<em class="ms">$(system . defaultworkingdirectory)</em>，<em class="ms"> **/ </em>。内容<em class="ms">中的aab <em class="ms">和</em>目标文件夹*中的</em>$(build . artifactstaging directory)<em class="ms">。</em></p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/b5258a832f33fe20bc12c2175cd3f902.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*o0Jud4N-jNeY-kEf"/></div></div></figure><p id="8139" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">点击<em class="ms">保存&amp;队列</em>，点击<em class="ms">保存</em>保存我们的CI管道。</p><p id="e902" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">对于<em class="ms">持续集成</em>就是这样。我们现在将前往<em class="ms">连续部署</em>以了解如何将生成的工件发布到游戏控制台上的<em class="ms">内部测试</em>通道。</p><h1 id="8c4e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">持续部署</h1><p id="ff4c" class="pw-post-body-paragraph kc kd iq ke b kf mb kh ki kj mc kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ij bi translated">持续集成处理的是在机器本身上创建构建，<em class="ms">持续部署</em>关注的是如何将构建发布到Play Store、App Store、自托管或云服务器。为了部署到Play Store，您需要一个Google Play控制台帐户和一个在Play控制台中创建的具有相同捆绑id的应用程序。</p><p id="78aa" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">接下来，我们将回到我们的Azure DevOps项目，并选择pipeline部分下的<em class="ms">版本</em>。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/3618bf09c3efcdfbf30e724d42c7a4b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9tTBUwRDsZCbyxH_"/></div></div></figure><p id="657f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">由于没有用于将构建上传到Play Store的预定义模板，我们将选择一个空作业。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/2d8dae49ad7185d53291f17ee83e0521.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QK9HVpkAXRcPEtJy"/></div></div></figure><p id="26d8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们现在将输入部署的阶段名称。你想叫它什么都可以。我已经把它作为<em class="ms">播放商店部署</em></p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/32e6d06cc4b25a8810eb24d61b3991cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tfKXfMZ2CZwlIfJu"/></div></div></figure><p id="d5f5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">让我们将CI工件与我们当前的CD管道连接起来。选择<em class="ms">从工件中添加一个工件</em>。这将在右侧打开一个对话框，我们将在其中选择我们的工件。单击<em class="ms"> Source (build pipeline) </em>的下拉菜单，您将看到<em class="ms"> Android-CI </em>是唯一的选项(除非您添加了更多CI管道或更改了CI名称)。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/0634444e990565c3dd1349038b021ac0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NdrdwF-kiq0YoBcz"/></div></div></figure><p id="a9ab" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">选择<em class="ms"> Android-CI </em>并点击<em class="ms">添加</em>。添加工件后，我们的发布管道将看起来像下面这样。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/f17c59abcd06f77f6dcf0fa41a04f6db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xl8qU9f_b-nd8cHu"/></div></div></figure><p id="e39d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">由于CI和CD管道是分开的，我们应该设置一种方法，在CI成功时自动触发CD管道。为了实现这一点，为我们刚刚添加的工件选择闪电图标。这将在右侧打开一个对话框，其中包含启用/禁用持续部署触发器的设置。当构建触发器启用时，当我们的构建(CI)管道完成一个新的构建时，我们的发布管道将自动启动。我们不会启用拉取请求触发器。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/13c86265c80fe29c9cc8072abd3c505a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MkAc5NSKqXW0W0IN"/></div></div></figure><p id="a957" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">到目前为止，我们已经将管道设置为在我们的构建管道中有新的构建可用时自动启动。我们还设置了一个Play Store部署阶段，我们将在下一节中为实际部署添加任务。</p><h2 id="f91a" class="nc lc iq bd ld nd ne dn lh nf ng dp ll kn nh ni lp kr nj nk lt kv nl nm lx nn bi translated">部署任务</h2><p id="d74c" class="pw-post-body-paragraph kc kd iq ke b kf mb kh ki kj mc kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ij bi translated">选择1作业0任务超链接，该超链接将切换到“任务”选项卡。选择<em class="ms">代理作业</em>旁边的+号，打开新任务列表。当你搜索<em class="ms"> Google Play </em>时。你会看到微软的Google Play 。如果尚未安装，请安装该项。一旦安装完毕，当你再次搜索谷歌应用程序时，你会看到如下几个新任务。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/3c3c1869e54a3fcb64bfc97a3c7b365b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PfqqsZjPtbGYrqtA"/></div></div></figure><p id="730f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">选择显示Google Play-Release Bundle的任务，点击<em class="ms">添加</em>按钮(不要选择<em class="ms">Google Play-Release</em>)。有些设置需要注意，我们会逐一处理。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/9c24776694998d3b41f922cc31a06d72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*E8fUwWHHkwcVUe7C"/></div></div></figure><h2 id="a33a" class="nc lc iq bd ld nd ne dn lh nf ng dp ll kn nh ni lp kr nj nk lt kv nl nm lx nn bi translated">添加服务连接</h2><p id="3f8d" class="pw-post-body-paragraph kc kd iq ke b kf mb kh ki kj mc kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ij bi translated">首先，我们需要创建一个新的服务连接。点击<em class="ms">服务连接</em>字段旁边的<em class="ms">新建</em>按钮。它将弹出一个对话框，主要要求输入一个<em class="ms">服务账户电子邮件</em>和一个<em class="ms">私钥</em>。我们将在Google Play控制台上创建一个服务帐户来上传版本。出于身份验证的目的，该帐户还会附带一个私钥。</p><p id="1dbf" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">要创建帐户，请访问<a class="ae la" href="https://play.google.com/apps/publish/" rel="noopener ugc nofollow" target="_blank"> Google Play控制台</a>，并在<em class="ms">设置</em>下的<em class="ms">开发者帐户</em>下选择<em class="ms"> API访问</em>。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/73c6a4ec3ff82a40a85ae7d763406fb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*V9ihLum9HOgX9_Hp"/></div></div></figure><p id="86ac" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">点击<em class="ms">新建服务账户</em>按钮，弹出如下对话框。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/abf2fe87b3e5f57505905953335447b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_LicgckUrLSoIz_T"/></div></div></figure><p id="c2f2" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">点击步骤1中的链接，这将把您重定向到<em class="ms">谷歌云控制台</em>的一个新标签。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/bab9833397af95698a7792db8832f17f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*h_M8S_NlmB4UPlpZ"/></div></div></figure><p id="891c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">点击顶部的<em class="ms"> +创建服务账户</em>，开始创建新账户。在新打开的页面中，我在服务帐户名称中输入了<em class="ms"> Google Play控制台</em>，但是它可以是你想要的任何名称。如果需要，输入<em class="ms">服务账户描述</em>。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/30f4e2e4a6c56862a22ce0cf5c1bdcae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fCBiJBjbHAfm_RMf"/></div></div></figure><p id="c268" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">点击<em class="ms">创建</em>继续。然后，它会询问您希望为该用户分配什么权限。点击角色下拉菜单，搜索<em class="ms">所有者</em>。选择<em class="ms">所有者</em>，拥有<em class="ms">对所有资源</em>的完全访问权。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/b312d30f380cc66d9ff794d92f76fcb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JOGBN8ZtZAkHgm6g"/></div></div></figure><p id="9ebb" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">单击<em class="ms">继续</em>按钮，并在步骤3中选择<em class="ms">完成</em>，因为我们不想添加任何可以作为该服务帐户执行操作的用户或组。您将被重定向到密钥列表页面。现在选择新创建的帐户并转到<em class="ms">键</em>选项卡。这里我们将为我们的服务连接添加一个新的<em class="ms">私有密钥</em>。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/5a9c19ea49697c1d3684e66e2753a226.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EOc-Vwho6LxS9uWb"/></div></div></figure><p id="14c2" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">选择<em class="ms">添加密钥</em>，并从下拉菜单中选择<em class="ms">创建新密钥</em>。它将显示一个弹出窗口，显示您想要创建的密钥类型。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oe"><img src="../Images/fb92555c151c1b5ab881a6cfef51a8cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SPdWsj6kVSzQWWkT"/></div></div></figure><p id="a346" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">选择<em class="ms"> JSON </em>选项，点击<em class="ms">创建</em>按钮。这将要求您下载文件。把它存放在一个安全的地方，我们不会照原样使用整个文件，如果你打开文件，它会有一个名为<em class="ms"> private_key </em>的密钥。</p><p id="3bc7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在我们使用这个值之前，回到我们的google play控制台的<em class="ms"> API访问</em>页面，点击<em class="ms">完成</em>按钮。它将刷新服务帐户列表，将您的服务帐户添加到列表中。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/9193d7a0ac40a86eede1ee23982acb78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RBa2fWgCRaUgL105"/></div></div></figure><p id="16c0" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">对于新创建的服务帐户，该行将有<em class="ms">授权访问</em>按钮。点击按钮将打开一个页面邀请用户。不要与术语<em class="ms"> invite </em>混淆，因为Google可能会重用一个页面来显示服务帐户的相同信息。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/64edc35ae60ee4ec1fb44c1844406e6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ehS3Rn7_I70OKUo_"/></div></div></figure><p id="ec39" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">点击右下角的<em class="ms">邀请用户</em>，在弹出的对话框中点击<em class="ms">发送邀请</em>。此操作会将您重定向到<em class="ms">用户和权限</em>页面，其中服务帐户被添加为新用户。</p><p id="e4df" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们现在将在Azure DevOps中设置<em class="ms">服务电子邮件</em>和<em class="ms">私钥</em>。首先，将新创建的服务帐户的电子邮件复制到Azure DevOps选项卡中的<em class="ms">服务帐户电子邮件</em>中。接下来打开私钥json文件，并将<em class="ms"> private_key </em>的值复制到<em class="ms">私钥</em>字段。这是它的样子。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi of"><img src="../Images/c8bb2e49ad10f72c32e29b7d669aca2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cMzFIeIwQdMpwFL0"/></div></div></figure><p id="035c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">点击<em class="ms">保存</em>，将服务连接添加到<em class="ms">服务连接</em>字段。接下来，在<em class="ms">应用程序id (com.google.MyApp) </em>字段中输入您的包id。最后，在<em class="ms">捆绑路径</em>中，您可以浏览选择。aab文件，方法是单击右边的3个点。通常，aab将位于</p><pre class="mt mu mv mw gt nq nr ns nt aw nu bi"><span id="9cc1" class="nc lc iq nr b gy nv nw l nx ny">&lt;your CI name&gt;/drop/app/build/outputs/bundle/release/*.aab</span></pre><p id="4b6f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果您还没有运行CI管道，您可以将路径设置为</p><pre class="mt mu mv mw gt nq nr ns nt aw nu bi"><span id="72f8" class="nc lc iq nr b gy nv nw l nx ny">$(System.DefaultWorkingDirectory)/_Android-CI/drop/app/build/outputs/bundle/release/*.aab</span></pre><p id="c66d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果您正在使用风味前缀<em class="ms">,请在路径中发布带有您的风味名称的</em>。例如，路径应该是</p><pre class="mt mu mv mw gt nq nr ns nt aw nu bi"><span id="d669" class="nc lc iq nr b gy nv nw l nx ny">$(System.DefaultWorkingDirectory)/_Android-CI/drop/app/build/outputs/bundle/devRelease/*.aab</span></pre><p id="d73a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">您可以从下拉列表中选择要启动的曲目。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi og"><img src="../Images/f69e11d44fa9da36cb3a764d8aa0272e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BIjU95XM9XOIkvvx"/></div></div></figure><p id="4495" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这就是你需要的所有设置。您现在可以<em class="ms">保存</em>管道并运行CI管道来构建aab并将其上传到Play控制台。</p><h1 id="b49b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="4eec" class="pw-post-body-paragraph kc kd iq ke b kf mb kh ki kj mc kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ij bi translated">这似乎是一个很长的教程，但是一旦你成功地设置了CI/CD管道，它将为你的开发者节省大量的时间。其次，它将在云上运行，因此不需要物理机器。您可以通过登录Azure DevOps从手机触发构建。希望你喜欢这篇文章，也希望它能帮助你团队中的其他人。</p><p id="816f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">要了解如何为iOS设置CI CD管道，您可以访问本教程。</p><p id="e718" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如有任何疑问，您可以在下方留言。请关注我的页面，了解更多即将到来的教程。</p></div></div>    
</body>
</html>