# 在 React 中编写可控组件

> 原文：<https://itnext.io/writing-controllable-components-in-react-c9cccf41b48c?source=collection_archive---------3----------------------->

## 有导游的旅行

![](img/07794b2e98fbf6aa5a8accf4b99419a2.png)

可控组件是任何 React 开发人员的重要组成部分。它们是什么？它们是期望来自两个不同来源的变化的组件:组件内的道具**或**用户交互。这两种版本的可控组件分别被称为**受控**和**非受控**。由于那些名字并不完全直观，所以把*受控*想象成*外控*(通过道具)，把*非受控*想象成*内控*(通过组件状态)。最后一个控制途径，用户输入，是可控组件的独特之处。只有期望或接受用户输入*的组件才能被*控制。编写和使用这些组件的困难在于管理外部和内部控制机制之间的相互作用。

最常见的可控组件是 React 自带的`<input>`。这几乎是每个人第一次体验这种组件模式和它抛出的警告。由于这是一篇关于*编写*一个可控组件的帖子，我将使用计数器元素的旧备用示例。它简洁地说明了受控值(保存在内部状态或作为属性传入)和控制器(在用户交互中调用并修改受控属性的函数)之间的相互作用。虽然该组件有一个受控值和两个控制器，但对此没有限制:控制器和受控值可以有多对多的关系。也可以使单个部件具有多组不重叠的控制器和受控值。

> 步骤 1 —编写一个没有内部状态的哑组件

目前这是一个简单的哑组件，由两个按钮(用于递增和递减计数器)和一个计数的只读显示组成。下面是编写可控组件的第一步:**编写一个没有内部状态的哑组件**。任何不允许外部控件的组件都是不可控的，所以从编写一个完全依赖于外部控件的组件开始。

> 步骤 2 —添加内部状态管理作为默认设置

现在已经有了清晰的(外部)控件和受控值，添加组件状态来管理它。这里的技巧是使用内部组件状态作为默认的*，允许任何消费的父节点通过传入道具来覆盖它们。*

*在这个例子中，我使用 props 的对象解构在第 8–12 行中插入内部状态管理片段作为默认值。也就是说，如果使用者没有传入控制机制(`inc`和`dec`)或受控值(`count`)，那么就使用组件自己的方法和状态。*

*这对于任何完全不受控制(没有传入任何属性，使用所有默认值)或完全受控制(传入每个预期的属性，不使用默认值)的计数器组件都非常有效。但是，当组件仅被部分控制时，会出现奇怪的行为。*

*部分控制可以有几种方式:
**永久部分控制:**一些但不是全部的控制器和受控值作为道具传入，并且在组件的生命周期中不会改变。
**切换完全受控到完全不受控:**所有的控制器和受控道具有时(但同时)作为道具传入，有时(也同时)作废。这可能发生在任一方向上(受控到不受控，反之亦然)，并可能在组件的生命周期内多次发生。 **切换部分控制:**部分或全部控制器和受控值在部件寿命期内在`undefined`(或`null`)和实际值之间切换。*

> *步骤 3 —同步受控值的内部和外部表示*

*当组件接收一些而不是所有的控制器和受控值作为道具时，无论是在初始化期间还是在组件生命周期的后期，实际上都没有什么可做的。控制器和它们控制的值必须通信。外部控制器不能影响内部状态，内部控制器也不允许覆盖外部值，因为我们规定内部管理是默认由 props 覆盖的。我们最多能做的就是向开发者发出警告，告诉他们正在从事的行为将会产生意想不到的后果。*

*那么，我们应该担心的唯一部分控制是在完全控制和完全不控制之间切换。这里的问题是，当组件被控制时，受控值的内部表示没有保持最新，因此当它变得不受控制时，用户将看到值的意外变化。同步受控值的内部状态和外部属性可以在`componentWillReceiveProps`中管理(在以后的 React 版本中使用`getDerivedStateFromProps`)。*

*那里。在**三个简单的步骤**中，你制作了一个可控的组件。*

> *额外积分——传达变化*

*作为额外的奖励，你应该考虑可控组件的另一个方面:交流变化。有时消费者并不关心组件如何管理自己，并且消费者也不想参与组件的管理。相反，它希望被告知受控值的变化。可以在`componentDidUpdate`中通知消费者受控道具的变化。*

*我推荐命名约定“on*DidChange ”,并传入新值和旧值。对组件 API 的这种添加对于其可控性来说是不必要的，所以按照您认为合适的方式实现它。*

> *额外的额外信用——一个高阶元件，使哑元件可控*

> ***编辑**:我已经为这个特别的
> [https://www.npmjs.com/package/@ngard/react-controllable](https://www.npmjs.com/package/@ngard/react-controllable)发布了一个 NPM 包*

*只是为了好玩，我写了一个 HOC，自动把哑组件变成可控组件。随便偷代码。*