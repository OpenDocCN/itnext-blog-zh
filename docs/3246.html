<html>
<head>
<title>ASP.NET Core 3: Add Entity Framework Core to Existing Project</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ASP.NET核心3:向现有项目添加实体框架核心</h1>
<blockquote>原文：<a href="https://itnext.io/asp-net-core-3-add-entity-framework-core-to-existing-project-ee4f08ff261a?source=collection_archive---------0-----------------------#2019-11-04">https://itnext.io/asp-net-core-3-add-entity-framework-core-to-existing-project-ee4f08ff261a?source=collection_archive---------0-----------------------#2019-11-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="262d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上周，一个非官方的发布了一系列帖子，这些帖子与本博客中经常提到的<a class="ae kl" href="https://github.com/elanderson/ASP.NET-Core-Basics" rel="noopener ugc nofollow" target="_blank">ASP.NET基础报告</a>的更新有关，以反映现在的事态。网芯3已经发布。新的回购协议是【ASP.NET T2】基础更新，因为命名很难。</p><p id="dc28" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章将采用上周为带有NSwag和ASP.NET核心3 文章的<a class="ae kl" href="https://elanderson.net/2019/10/swagger-openapi-with-nswag-and-asp-net-core-3/" rel="noopener ugc nofollow" target="_blank"> Swagger/OpenAPI创建的API项目，并将生成的数据替换为使用实体框架核心的数据库。如果你想继续关注这篇文章，可以在</a><a class="ae kl" href="https://github.com/elanderson/ASP.NET-Core-Basics-Refresh/tree/dbf8b0bb46811a7589fb0c1d6f1c591a86123b83" rel="noopener ugc nofollow" target="_blank">这里</a>找到之前的文件。</p><h2 id="68d9" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">添加NuGet包</h2><p id="49cb" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">实体框架核心不再包含在中。NET核心，所以我们安装了几个NuGet包来开始。我要给。NET CLI命令，但这也可以使用Visual Studio NuGet包管理器UI来完成。这篇文章也将使用SQLite，但是Entity Framework Core支持多个数据库，您需要为您感兴趣使用的数据库安装软件包。</p><p id="5f03" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是安装我们将使用的软件包的命令。这还假设您的终端与项目文件位于同一个目录中。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="3467" class="km kn iq lp b gy lt lu l lv lw">dotnet add package Microsoft.EntityFrameworkCore.Sqlite<br/>dotnet add package Microsoft.EntityFrameworkCore.Design</span></pre><h2 id="9b94" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">添加DbContext</h2><p id="2815" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">提醒一下，我们在Models目录中已经有了一个Contact类，其定义如下。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="e6aa" class="km kn iq lp b gy lt lu l lv lw">public class Contact<br/>{<br/>    public int Id { get; set; }<br/>    public string Name { get; set; }<br/>    public string Address { get; set; }<br/>    public string City { get; set; }<br/>    public string State { get; set; }<br/>    public string PostalCode { get; set; }<br/>    public string Phone { get; set; }<br/>    public string Email { get; set; }<br/>}</span></pre><p id="eb67" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我向项目添加了一个<strong class="jp ir">数据</strong>目录，然后添加了一个名为<strong class="jp ir"> ContactedDbContext </strong>的新类。DbContext只为联系人公开一个DbSet。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="4d3f" class="km kn iq lp b gy lt lu l lv lw">public class ContactsDbContext : DbContext<br/>{<br/>    public DbSet&lt;Contact&gt; Contacts { get; set; }<br/><br/>    public ContactsDbContext(DbContextOptions&lt;ContactsDbContext&gt; options) <br/>        : base(options)<br/>    { }<br/>}</span></pre><h2 id="89e5" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">连接字符串的配置</h2><p id="adca" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">在<strong class="jp ir"> appsettings.json </strong>文件中，我们将添加一个连接字符串部分来保存我们的默认连接。下面是我完整的appsettings.json，带有SQLite的连接字符串。如果您使用不同的数据库提供程序，您的连接字符串可能会有很大的不同。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="76f6" class="km kn iq lp b gy lt lu l lv lw">{<br/>  "ConnectionStrings": {<br/>    "DefaultConnection": "DataSource=app.db"<br/>  },<br/>  "Logging": {<br/>    "LogLevel": {<br/>      "Default": "Information",<br/>      "Microsoft": "Warning",<br/>      "Microsoft.Hosting.Lifetime": "Information"<br/>    }<br/>  },<br/>  "AllowedHosts": "*"<br/>}</span></pre><p id="f0ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查看ASP.NET核心中的<a class="ae kl" href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration" rel="noopener ugc nofollow" target="_blank">配置，了解处理配置的不同方式的更多详细信息。</a></p><h2 id="d89c" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">向服务容器注册DbContext</h2><p id="d05c" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">打开<strong class="jp ir"> Startup.cs </strong>，在<strong class="jp ir"> ConfigureServices </strong>函数中，我们将使用<strong class="jp ir"> AddDbContext </strong>扩展方法添加我们的新DbContext，并告诉它使用SQLite和来自我们<strong class="jp ir"> appsettings.json </strong>的连接字符串。下面是完整的函数，前两行是我们添加的。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="530f" class="km kn iq lp b gy lt lu l lv lw">public void ConfigureServices(IServiceCollection services)<br/>{<br/>    services.AddDbContext&lt;ContactsDbContext&gt;(options =&gt;<br/>        options.UseSqlite(Configuration.GetConnectionString("DefaultConnection")));<br/><br/>    services.AddControllers();<br/>    services.AddOpenApiDocument(document =&gt; <br/>        document.PostProcess = d =&gt; d.Info.Title = "Contacts API");<br/>}</span></pre><p id="e003" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查看官方文档了解更多关于ASP.NET核心中<a class="ae kl" href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection" rel="noopener ugc nofollow" target="_blank">依赖注入的信息。</a></p><h2 id="775d" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">创建并应用初始迁移</h2><p id="eecc" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">对于这一点，我们将回到命令行，打开包含我们正在处理的项目的csproj的目录。我们需要做的第一件事是使用下面的命令安装实体框架核心工具，该命令将全局安装该工具。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="60a7" class="km kn iq lp b gy lt lu l lv lw">dotnet tool install --global dotnet-ef</span></pre><p id="29c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们将使用以下命令在Data/Migrations目录中创建一个名为Initial的迁移。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="6c8e" class="km kn iq lp b gy lt lu l lv lw">dotnet ef migrations add Initial -o Data/Migrations</span></pre><p id="f56e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们有了一个迁移，让我们用它来创建我们的数据库。请注意，将来将迁移应用到现有数据库时，将使用相同的命令。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="8392" class="km kn iq lp b gy lt lu l lv lw">dotnet ef database update</span></pre><p id="43d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查看官方文档，了解关于<a class="ae kl" href="https://docs.microsoft.com/en-us/ef/core/miscellaneous/cli/dotnet" rel="noopener ugc nofollow" target="_blank">实体框架核心工具</a>或<a class="ae kl" href="https://docs.microsoft.com/en-us/dotnet/core/tools/global-tools" rel="noopener ugc nofollow" target="_blank">全局工具</a>的更多信息。</p><h2 id="a570" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">搭建新的控制器</h2><p id="3a15" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">如果此时您正在使用来自GitHub的代码，您将需要删除<strong class="jp ir"> ContactsController </strong>，因为它将使用Visual Studio的工具重新创建。</p><p id="ff82" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">右键点击应该创建控制器的目录，本例中为<strong class="jp ir">控制器</strong>目录，选择<strong class="jp ir">添加</strong>，然后选择<strong class="jp ir">控制器</strong>。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/d03fc13f371e9ec352b20468e623516a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/0*F0pXXMsqd_PB8fDY.png"/></div></figure><p id="5911" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在弹出的对话框中，我们要使用实体框架选择<strong class="jp ir">带动作的API控制器，然后点击<strong class="jp ir">添加</strong>。</strong></p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mb"><img src="../Images/05343d84fc5031b27f7301fb113ba9ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PYYhjahDP2KMm5_Z.png"/></div></div></figure><p id="6ada" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在下一个屏幕上，在点击<strong class="jp ir">添加</strong>之前，指定<strong class="jp ir">模型类别</strong>、<strong class="jp ir">数据上下文</strong>和<strong class="jp ir">控制器名称</strong>。在示例案例中，我们将使用模型的<strong class="jp ir"> Contact </strong>类，数据上下文的<strong class="jp ir"> ContactDbContext </strong>来生成名为<strong class="jp ir"> ContactController </strong>的控制器。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/7b18265f4c850e571772e72d03ed4e5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1172/format:webp/0*6JV4H2Rl91pQX9qk.png"/></div></figure><p id="3c19" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击添加后，所请求的控制器将生成，并带有所选模型类的<a class="ae kl" href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete" rel="noopener ugc nofollow" target="_blank"> CRUD操作</a>所需的所有功能。我们示例控制器的代码可以在<a class="ae kl" href="https://github.com/elanderson/ASP.NET-Core-Basics-Refresh/blob/14d130df7102c0603d532a2aef4d459292359b9d/src/ContactsApi/Controllers/ContactsController.cs" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h2 id="ee65" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">尝试一下</h2><p id="9bfd" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">在NSwag 的帮助下，运行应用程序并点击我们的<a class="ae kl" href="https://elanderson.net/2019/10/swagger-openapi-with-nswag-and-asp-net-core-3/" rel="noopener ugc nofollow" target="_blank"> swagger UI，我们可以看到我们的API可用的所有选项，甚至可以尝试它们，这将点击我们应用程序的数据库。</a></p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mh"><img src="../Images/5a1506c7da5e6baf14319e1d5fa30976.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EVzbh3ihR5HCURZ5.png"/></div></div></figure><p id="e25d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">测试API的另一个很好的选择是<a class="ae kl" href="https://www.getpostman.com/" rel="noopener ugc nofollow" target="_blank"> Postman </a>，它有很多非常棒的特性。这两种选择都允许您在不构建客户端的情况下尝试API。</p><h2 id="cf6d" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">包扎</h2><p id="7a20" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">希望这篇文章能帮助你在ASP.NET Core 3应用程序中集成实体框架核心。提醒一下，实体框架核心支持许多不同的<a class="ae kl" href="https://docs.microsoft.com/en-us/ef/core/providers/" rel="noopener ugc nofollow" target="_blank">数据库提供商</a>。如果你有任何问题，我推荐你查看微软官方文档<a class="ae kl" href="https://docs.microsoft.com/en-us/ef/core/get-started" rel="noopener ugc nofollow" target="_blank">实体框架核心</a>入门。</p><p id="9313" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以上所有修改的代码可以在<a class="ae kl" href="https://github.com/elanderson/ASP.NET-Core-Basics-Refresh/tree/14d130df7102c0603d532a2aef4d459292359b9d" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p></div><div class="ab cl mi mj hu mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ij ik il im in"><p id="c66e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mp">最初发表于</em> <a class="ae kl" href="https://elanderson.net/2019/11/asp-net-core-3-add-entity-framework-core-to-existing-project/" rel="noopener ugc nofollow" target="_blank"> <em class="mp">埃里克·安德森</em> </a> <em class="mp">。</em></p></div></div>    
</body>
</html>