<html>
<head>
<title>Kubernetes monitoring with Prometheus in 15 minutes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">15分钟后库伯内特和普罗米修斯一起监控</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-monitoring-with-prometheus-in-15-minutes-8e54d1de2e13?source=collection_archive---------0-----------------------#2017-10-12">https://itnext.io/kubernetes-monitoring-with-prometheus-in-15-minutes-8e54d1de2e13?source=collection_archive---------0-----------------------#2017-10-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/124f0c21507e6948a8b826666306f573.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*zwH6_X8uWpXAzLt4FLdyOw.png"/></div></figure><p id="363e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果你没有听说过Kubernetes(或者它的俗称K8s)，是时候走出你的洞穴了。K8s是一个开源的自我修复平台，用于部署、扩展和操作容器。最初由谷歌设计(灵感来自<a class="ae ks" href="https://research.google.com/pubs/pub43438.html" rel="noopener ugc nofollow" target="_blank">博格</a>，后来捐赠给<a class="ae ks" href="http://cncf.io" rel="noopener ugc nofollow" target="_blank"> CNCF </a>。</p><p id="1178" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">理解k8s的所有组件并不容易，要完全控制这样一个复杂而强大的平台需要时间。同样重要的是，要意识到节点、应用程序或网络可能会在特定时间发生故障——就像其中的所有东西一样。因此，拥有警报、日志、指标和监控仪表板对于避免停机和其他问题至关重要。</p><p id="2503" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在我的上一个项目中，从裸机服务器转移到云，我有时间研究k8s的主动监控。在一些基准测试和撞墙之后，我终于找到了普罗米修斯。k8s项目已经接受了这一惊人的工具，在几乎所有的组件中公开了普罗米修斯度量标准。</p><p id="46e0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">监控您的k8s集群将帮助您的团队:</p><ul class=""><li id="03be" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ky kz la lb bi translated">主动监控</li><li id="fa9b" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">集群可见性和容量规划</li><li id="24a1" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">触发警报和通知</li><li id="0deb" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">度量仪表板</li></ul><p id="b9d7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在我研究Prometheus如何与k8s整合的时候，Coreos推出了<a class="ae ks" href="http://github.com/coreos/prometheus-operator" rel="noopener ugc nofollow" target="_blank">Prometheus-Operator</a>；它完全符合我的需要，使所有的设置配置变得容易。</p><h1 id="c747" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">Kubernetes算子</h1><blockquote class="mf mg mh"><p id="bc62" class="ju jv mi jw b jx jy jz ka kb kc kd ke mj kg kh ki mk kk kl km ml ko kp kq kr ij bi translated">“我们称这种新的软件操作人员类别。操作者是特定于应用程序的控制器，它扩展了Kubernetes API，代表Kubernetes用户创建、配置和管理复杂的有状态应用程序的实例。它建立在基本的Kubernetes资源和控制器概念的基础上，但包括领域或应用特定的知识，以自动化常见任务。”</p><p id="8105" class="ju jv mi jw b jx jy jz ka kb kc kd ke mj kg kh ki mk kk kl km ml ko kp kq kr ij bi translated">布兰登·飞利浦，由<a class="ae ks" href="https://coreos.com/blog/introducing-operators.html" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> Coreos </em> </a></p></blockquote><p id="01e6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Kubernetes Operators是由<a class="ae ks" href="https://coreos.com/blog/introducing-operators.html" rel="noopener ugc nofollow" target="_blank"> <em class="mi"> Coreos </em> </a> <em class="mi">在</em> 2016年推出的，它拥有抽象部署和配置应用的能力。就个人而言，我一直在使用大量的<a class="ae ks" href="http://github.com/upmc-enterprises/elasticsearch-operator/" rel="noopener ugc nofollow" target="_blank">弹性搜索操作符</a>和<a class="ae ks" href="https://github.com/coreos/prometheus-operator/" rel="noopener ugc nofollow" target="_blank">普罗米修斯操作符</a>。扩展k8s操作符并不是本文的重点，但是如果您感兴趣，您可以在这里看到其他k8s操作符<a class="ae ks" href="https://github.com/coreos/awesome-kubernetes-extensions" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="df4f" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">普罗米修斯</h1><p id="d119" class="pw-post-body-paragraph ju jv iq jw b jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated"><a class="ae ks" href="http://prometheus.io" rel="noopener ugc nofollow" target="_blank"> Prometheus </a>是一个开源的监控和警报工具包，灵感来自于<a class="ae ks" href="https://research.google.com/pubs/pub43438.html" rel="noopener ugc nofollow" target="_blank"> Google Borg </a> Monitor。它之前是由<a class="ae ks" href="https://soundcloud.com/" rel="noopener ugc nofollow" target="_blank"> SoundCloud </a>开发的，后来捐赠给了<a class="ae ks" href="http://cncf.io" rel="noopener ugc nofollow" target="_blank"> CNCF </a>。</p><p id="6bc6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Prometheus支持多种语言的<a class="ae ks" href="https://prometheus.io/docs/instrumenting/clientlibs/" rel="noopener ugc nofollow" target="_blank">仪器应用</a>。它还提供了<a class="ae ks" href="https://prometheus.io/docs/instrumenting/exporters/" rel="noopener ugc nofollow" target="_blank">导出器</a>来连接应用程序(Postgresql、Mysql、AWS Cloudwatch、ETCD和K8s)，同时仍然是监控基础设施和应用程序的优秀解决方案。</p><h1 id="74b2" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">普罗米修斯算子</h1><blockquote class="mf mg mh"><p id="0b72" class="ju jv mi jw b jx jy jz ka kb kc kd ke mj kg kh ki mk kk kl km ml ko kp kq kr ij bi translated">Prometheus操作符的任务是尽可能容易地在Kubernetes上运行Prometheus，同时保持可配置性并使配置成为Kubernetes本地的。<a class="ae ks" href="https://coreos.com/operators/prometheus/docs/latest/user-guides/getting-started.html" rel="noopener ugc nofollow" target="_blank">https://core OS . com/operators/Prometheus/docs/latest/user-guides/getting-started . html</a></p></blockquote><p id="ae4c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">除了管理Prometheus、Alertmanager和Grafana配置之外，Prometheus操作员还可以轻松监控k8s服务和部署。</p><h2 id="6925" class="mr li iq bd lj ms mt dn ln mu mv dp lr kf mw mx lv kj my mz lz kn na nb md nc bi translated">它是如何工作的？</h2><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi nd"><img src="../Images/3390c0717219cfd348a992e41e7748be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6KI8wlyWwLwPYgt_SP1CCA.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">普罗米修斯算子体系结构。来源:<a class="ae ks" href="https://raw.githubusercontent.com/coreos/prometheus-operator/master/Documentation/user-guides/images/architecture.png" rel="noopener ugc nofollow" target="_blank">普罗米修斯-操作者</a></figcaption></figure><p id="f30c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">当您部署新版本的应用程序时，k8s会创建一个新的pod(容器),在pod准备就绪后，k8s会销毁旧的pod。Prometheus一直在监视k8s api，当检测到变化时，它会根据服务(pod)的变化创建一个新的Prometheus配置。</p><h1 id="a583" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">服务监视器</h1><p id="8421" class="pw-post-body-paragraph ju jv iq jw b jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated">Prometheus-operator使用一个名为<a class="ae ks" href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#servicemonitorspec" rel="noopener ugc nofollow" target="_blank"> ServiceMonito </a> r的<a class="ae ks" href="https://kubernetes.io/docs/concepts/api-extension/custom-resources/" rel="noopener ugc nofollow" target="_blank">定制资源定义</a> (CRD)将配置抽象到目标。作为下面的例子，让我们看看如何使用ServiceMonitor监控NGINX pod。ServiceMonitor将使用<a class="ae ks" href="https://github.com/coreos/prometheus-operator/blob/8384c90c455d18e02ecd26ccfe1738a0c8865407/Documentation/api.md#servicemonitorspec" rel="noopener ugc nofollow" target="_blank">匹配标签选择器</a>选择NGINX pod。prometheus-operator将根据标签选择器搜索pod，并创建一个prometheus目标，以便prometheus收集指标端点。</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="nq nr l"/></div></figure><h1 id="ceb1" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">你自己试试</h1><p id="29c0" class="pw-post-body-paragraph ju jv iq jw b jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated">本教程可以在不到15分钟的时间内完成，因为您已经登录了:</p><ul class=""><li id="de25" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ky kz la lb bi translated">Kubernetes集群启动和运行(1.7.6版)</li><li id="392d" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><a class="ae ks" href="https://github.com/kubernetes/helm/blob/master/docs/install.md" rel="noopener ugc nofollow" target="_blank">舵</a>已安装并工作(2.6.1)</li></ul><h1 id="000b" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated"><strong class="ak">安装</strong></h1><pre class="ne nf ng nh gt ns nt nu nv aw nw bi"><span id="8359" class="mr li iq nt b gy nx ny l nz oa">$ helm install stable/prometheus-operator --name prometheus-operator --namespace monitoring</span></pre><p id="23fc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">假设一切正常，您可以运行下面的命令来列出我们将在下一节课中深入研究的应用程序。</p><pre class="ne nf ng nh gt ns nt nu nv aw nw bi"><span id="0334" class="mr li iq nt b gy nx ny l nz oa">$ kubectl get pods  -n monitoring<br/>NAME                                                       READY     STATUS    RESTARTS   AGE<br/>alertmanager-prometheus-operator-alertmanager-0                  2/2     Running   0          13h</span><span id="93ec" class="mr li iq nt b gy ob ny l nz oa">prometheus-operator-grafana-74dfcc6697-2z9bh                     3/3     Running   0          13h</span><span id="b056" class="mr li iq nt b gy ob ny l nz oa">prometheus-operator-kube-state-metrics-76999bd456-26r55          1/1     Running   0          13h</span><span id="fd1a" class="mr li iq nt b gy ob ny l nz oa">prometheus-operator-operator-69fd4db6d6-ccpb8                    1/1     Running   0          14d</span><span id="a49a" class="mr li iq nt b gy ob ny l nz oa">prometheus-operator-prometheus-node-exporter-2np5f               1/1     Running   2          14d</span><span id="584a" class="mr li iq nt b gy ob ny l nz oa">prometheus-operator-prometheus-node-exporter-2svbj               1/1     Running   0          13h</span><span id="f0b9" class="mr li iq nt b gy ob ny l nz oa">prometheus-operator-prometheus-node-exporter-jcq7z               1/1     Running   0          18d</span><span id="9d12" class="mr li iq nt b gy ob ny l nz oa">prometheus-operator-prometheus-node-exporter-jlmgw               1/1     Running   0          13h</span><span id="f7cb" class="mr li iq nt b gy ob ny l nz oa">prometheus-operator-prometheus-node-exporter-k4dlh               1/1     Running   0          14h</span><span id="c6a4" class="mr li iq nt b gy ob ny l nz oa">prometheus-operator-prometheus-node-exporter-rwgsw               1/1     Running   0          13h</span><span id="2f36" class="mr li iq nt b gy ob ny l nz oa">prometheus-operator-prometheus-node-exporter-t9z9x               1/1     Running   0          18d</span><span id="8c8d" class="mr li iq nt b gy ob ny l nz oa">prometheus-operator-prometheus-node-exporter-vfk69               1/1     Running   0          13h</span><span id="9df0" class="mr li iq nt b gy ob ny l nz oa">prometheus-operator-prometheus-node-exporter-xldfq               1/1     Running   0          18d</span><span id="e23b" class="mr li iq nt b gy ob ny l nz oa">prometheus-prometheus-operator-prometheus-0                      3/3     Running   0          18d</span></pre><h1 id="dd4f" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">普罗米修斯</h1><p id="c1c8" class="pw-post-body-paragraph ju jv iq jw b jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated">将Prometheus服务器转发到您的机器，这样您就可以通过打开<a class="ae ks" href="http://localhost:9090/" rel="noopener ugc nofollow" target="_blank"> http://localhost:9090 </a>更好地查看仪表板</p><pre class="ne nf ng nh gt ns nt nu nv aw nw bi"><span id="0312" class="mr li iq nt b gy nx ny l nz oa">$ kubectl port-forward -n monitoring prometheus-prometheus-operator-prometheus-0 9090</span></pre><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi oc"><img src="../Images/89ac4c1fec89535916ab8c1908e7e35e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vLWHW897LIADU0oLVe7wiA.png"/></div></div></figure><p id="0aa0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在Prometheus仪表板中，您可以:查询度量，查看所有预定义的预警和Prometheus目标。</p><blockquote class="mf mg mh"><p id="10dd" class="ju jv mi jw b jx jy jz ka kb kc kd ke mj kg kh ki mk kk kl km ml ko kp kq kr ij bi translated">注意:如果某些目标因无法到达的错误而失败，请检查安全组或防火墙规则。如果您没有与上图相同的目标，请检查k8s pods的标签，有时您用来部署集群的工具不符合k8s标签模式。</p></blockquote><h1 id="e3ea" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">格拉夫纳</h1><p id="d230" class="pw-post-body-paragraph ju jv iq jw b jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated">普罗米修斯有一个<a class="ae ks" href="https://prometheus.io/docs/visualization/browser/" rel="noopener ugc nofollow" target="_blank">表达式浏览器</a>用于调试目的。为了有一个好看的仪表板，使用Grafana，它有一个数据源可以在Prometheus上查询。</p><pre class="ne nf ng nh gt ns nt nu nv aw nw bi"><span id="b2c9" class="mr li iq nt b gy nx ny l nz oa">$ kubectl port-forward $(kubectl get  pods --selector=app=grafana -n  monitoring --output=jsonpath="{.items..metadata.name}") -n monitoring  3000</span></pre><p id="5c3b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">等待几秒钟，直到grafana加载仪表板，在<a class="ae ks" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000 </a>打开您的浏览器，使用密码prom-operator作为管理员登录，查看您全新的令人敬畏的仪表板！！！</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi od"><img src="../Images/9f4739b23ecabc0f2810d874ffd6c702.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T0MTK5aEpxA8YPWZ1l4Yxw.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">grafana-Kubernetes仪表板</figcaption></figure><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi oe"><img src="../Images/3a3091bd49e28f14756584d23ad141f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jqp7apB7bbkPlHFkoA6B1A.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">grafana-Kubernetes容量规划仪表板</figcaption></figure><h1 id="4b58" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">警报管理器</h1><blockquote class="mf mg mh"><p id="38dc" class="ju jv mi jw b jx jy jz ka kb kc kd ke mj kg kh ki mk kk kl km ml ko kp kq kr ij bi translated"><a class="ae ks" href="https://prometheus.io/docs/alerting/alertmanager/" rel="noopener ugc nofollow" target="_blank">警报管理器</a>处理客户端应用程序(如Prometheus服务器)发送的警报。它负责重复数据删除、分组，并将其路由到正确的接收方集成，如email、PagerDuty或OpsGenie。它还负责警报的静音和抑制。</p></blockquote><p id="f75e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们已经安装了Alertmanager，现在是下面的命令，将端口转发到您的机器，并在您的浏览器中打开URL<a class="ae ks" href="http://localhost:9093" rel="noopener ugc nofollow" target="_blank">http://localhost:9093</a></p><pre class="ne nf ng nh gt ns nt nu nv aw nw bi"><span id="e375" class="mr li iq nt b gy nx ny l nz oa">$ kubectl port-forward -n monitoring alertmanager-prometheus-operator-alertmanager-0 9093</span></pre><h1 id="772f" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">后续步骤</h1><p id="e58c" class="pw-post-body-paragraph ju jv iq jw b jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated">耶！！！现在您已经监控了所有k8s组件！！如果你注意到我遗漏了什么，请分享组件名称和具体的ServiceMonitor来覆盖它——我会更新帖子。</p><p id="bd66" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在我的下一篇文章中，我将介绍如何使用Alertmanager检测应用程序并触发通知。我还建议您观看下面的视频，以便更清楚地了解普罗米修斯操作员是如何工作的。</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="of nr l"/></div></figure></div></div>    
</body>
</html>