# S3 交叉帐户复制

> 原文：<https://itnext.io/s3-cross-account-replication-42dd83f42492?source=collection_archive---------1----------------------->

![](img/6223eee34568f7950ec3ab01c3097b35.png)

托尔加·乌尔坎在 [Unsplash](https://unsplash.com/@tolga__?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上拍摄的照片

# 什么是 S3 复制？

S3 复制是指在设置过程后，无需任何手动干预，自动将 S3 存储桶的内容复制到另一个 S3 存储桶的过程。目标时段可以与源时段位于同一区域，甚至可以与源时段位于不同区域

# 什么是 S3 交叉帐户复制？

S3 交叉帐户复制是指将 S3 存储桶的内容从一个帐户复制到不同帐户的另一个 S3 存储桶。这两个账户可能属于也可能不属于同一个个人或组织。

下面是执行 S3 交叉帐户复制的实践教程

# 要求

将'*数据*账户中的源桶→ ' *五月中桶*的内容复制到下面的目的桶中:

*   *五月-中桶-副本-开发*，*开发*账户
*   *五月-中桶-副本-测试*，*测试*账户

# 先决条件

1.  所有存储桶—源和目标应启用'**存储桶版本控制**'(这可以在创建存储桶时设置)
2.  在各自的帐户中创建以下 S3 时段:

*   *五月-中桶*中的*数据*账户
*   *may-medium-bucket-replica-Dev*中的 *Dev* 账户
*   *五月-中桶-副本-测试*中的*测试*账户

# 变更—高级别

配置 S3 交叉帐户复制所需的更改包括:

1.  在源帐户中为跨帐户复制创建一个角色(在本例中是'*数据*帐户)
2.  根据源帐户(“数据”帐户)中的源存储桶创建复制规则，复制到目标帐户(“开发”和“测试”帐户)中的目标存储桶
3.  在目标帐户(“开发”和“测试”帐户)中的目标存储桶上应用存储桶策略

# #1 —在源帐户中为跨帐户复制创建一个角色

1.  导航到“数据”帐户中的 IAM 控制台

2.创建一个策略。为策略提供一个名称(比如“交叉帐户-存储桶-复制-策略”)，并根据以下语法添加策略内容

3.关于上述规定的政策声明，需要注意以下要点:

*   第 17 行和第 18 行指的是“数据”帐户中的源存储桶
*   第 32、33、42、43 行指的是“开发”帐户和“生产”帐户中的目标存储桶

4.上述政策有 3 条声明:

*   sid—“GetSourceBucketConfiguration”→提供获取复制配置和获取源存储桶上复制的对象版本的访问权限
*   sid—‘ReplicateToDestinationBuckets’→提供复制到目标存储桶的访问。可以在数组中指定多个目标存储桶
*   sid—' PermissionToOverrideBucketOwner '→提供对 ObjectOwnerOverrideToBucketOwner 的访问，以便目标存储桶可以拥有从源帐户复制的目标帐户中的复制对象

5.保存策略

6.使用以下信息创建角色:

7.选择服务为 S3

8.选择用例为“允许 S3 代表您呼叫 AWS 服务”

9.选择上面创建的策略

10.为角色提供一个名称(比如“交叉帐户-存储桶-复制-角色”)并保存角色

# #2 —根据源帐户中的源存储桶创建复制规则

1.  导航至“数据”账户中的源桶→“原始-桶-可能”,然后转到“管理”

2.创建一个复制规则，输入以下内容:

*   提供规则名称→示例:“复制到开发”
*   将状态设置为“启用”
*   将规则范围选择为“此规则应用于存储桶中的所有对象”(根据需要选择)
*   选择目标作为另一个帐户中的存储桶。输入目标帐户号和目标时段名称。在这种情况下，输入“Dev”帐户#和目标存储桶名称“original-bucket-may-replica-Dev”
*   选择将对象所有权更改为目标存储桶所有者的选项
*   选择 IAM 角色作为在步骤' # 1-在源帐户中创建角色'中创建的角色
*   选择所有可用的附加复制选项。它们提供了快速复制内容、通过 cloudwatch 指标监控复制进度、复制删除标记和复制元数据更改的能力
*   救援

3.如果有多个目标存储桶，请创建另一个复制规则，但这次是复制到“生产”帐户，目标存储桶为“原始存储桶-可能-复制-生产”

# #3 —在目标存储桶上应用存储桶策略

1.  必须为每个帐户中的每个目的地时段单独执行此步骤

2.导航到相应帐户中的目标存储桶→在“开发”帐户中说出“原始存储桶-可能-副本-开发”

3.导航到“permissions”选项卡，通过提供以下内容来编辑存储桶策略，然后保存策略:

4.关于上述规定的政策声明，需要注意以下要点:

*   第 9 行引用作为 **#1 的一部分创建的角色 arn 在源帐户**中创建一个角色
*   第 19、# 20 和#30 行指的是目的地时段。在这种特定情况下，它的目标存储桶在“开发”帐户中

5.上述政策有两项声明:

*   Sid —“对象和存储桶的权限”→表示第 19，20 行指定的目标存储桶可以根据第 9 行源帐户中定义的角色复制内容。该角色将拥有源存储桶
*   Sid —“允许覆盖存储桶所有者”→表示第 30 行指定的目标存储桶有权覆盖第 34 行提到的源帐户的所有权

6.如果不同帐户中有多个要复制的目标存储桶，请重复上述步骤。在本例中，对“prod”帐户中的“original-bucket-may-replica-Prod”重复上述步骤。下面是特定于此目标存储桶的策略—“原始存储桶可能副本生产”

**验证测试**

*   在源存储桶中添加对象
*   添加的对象将反映在各自帐户下的目标存储桶中
*   要观察云观察指标，请转到源桶→选择“指标”选项卡
*   向下滚动到“复制指标”子部分，并选择一个复制规则
*   选择“显示图表”选项。这将显示→操作挂起复制、复制延迟和字节挂起复制的图表。这将有助于反映复制的状态