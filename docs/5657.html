<html>
<head>
<title>Kubernetes Operator for Hyperledger Fabric</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">超分类帐结构的Kubernetes运算符</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-operator-for-hyperledger-fabric-8bd13fa20a2a?source=collection_archive---------5-----------------------#2021-04-26">https://itnext.io/kubernetes-operator-for-hyperledger-fabric-8bd13fa20a2a?source=collection_archive---------5-----------------------#2021-04-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/797f6a96d4c663c0bd4de33990c67426.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*V-0MCir_RN8lihfT"/></div></div></figure><h1 id="8b78" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">摘要</h1><p id="1aff" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我来介绍一下Hyperledger Fabric的Kubernetes算子:【https://github.com/raftAtGit/hl-fabric-operator】T5<br/></p><p id="6bae" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">它是我们之前工作<a class="ae lu" href="https://github.com/hyfen-nl/PIVT" rel="noopener ugc nofollow" target="_blank"> PIVT Helm charts </a>的包装，使在Kubernetes中运行和操作Hyperledger Fabric更加容易。</p><p id="a9c0" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">它允许通过<em class="ma">光纤网络</em> CRD(自定义资源定义)以声明方式管理整个或部分HL光纤网络。</p><p id="4c19" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">特别是，它允许:</p><ul class=""><li id="bf26" class="mb mc iq ky b kz lv ld lw lh md ll me lp mf lt mg mh mi mj bi translated">配置和启动整个HL结构网络或其一部分</li><li id="b7fa" class="mb mc iq ky b kz mk ld ml lh mm ll mn lp mo lt mg mh mi mj bi translated">创建信道、将对等体加入信道、更新锚定对等体的信道</li><li id="0201" class="mb mc iq ky b kz mk ld ml lh mm ll mn lp mo lt mg mh mi mj bi translated">安装/实例化所有链码，或其中一些，或将其升级到较新的版本</li><li id="bc8a" class="mb mc iq ky b kz mk ld ml lh mm ll mn lp mo lt mg mh mi mj bi translated">将新的对等组织添加到已经运行的网络中</li></ul><p id="2ea2" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">这项工作最初是我自己的一个实验性/概念验证爱好项目，但后来证明相当完整和实用。</p><h1 id="4a05" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">内容</h1><ul class=""><li id="92b0" class="mb mc iq ky b kz la ld le lh mp ll mq lp mr lt mg mh mi mj bi translated">动机</li><li id="6bf5" class="mb mc iq ky b kz mk ld ml lh mm ll mn lp mo lt mg mh mi mj bi translated">概观</li><li id="fd58" class="mb mc iq ky b kz mk ld ml lh mm ll mn lp mo lt mg mh mi mj bi translated">CRD的FabricNetwork</li><li id="f1bd" class="mb mc iq ky b kz mk ld ml lh mm ll mn lp mo lt mg mh mi mj bi translated">硬币指示器 （coin-levelindicator的缩写）命令行界面（Command Line Interface for batch scripting）</li><li id="be53" class="mb mc iq ky b kz mk ld ml lh mm ll mn lp mo lt mg mh mi mj bi translated">用法示例</li><li id="e687" class="mb mc iq ky b kz mk ld ml lh mm ll mn lp mo lt mg mh mi mj bi translated">状态机</li><li id="98e0" class="mb mc iq ky b kz mk ld ml lh mm ll mn lp mo lt mg mh mi mj bi translated">结论</li></ul><h1 id="9763" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">动机</h1><p id="a1e1" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">将HL Fabric正确地配置和部署到Kubernetes并不是一项简单的任务。这也只是谜题的一部分。关于信道和链码填充结构网络与启动结构网络同样重要。感觉上，这第二部分被高度忽视了。</p><p id="7bb2" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">我们之前的工作，在行业中仍然是无与伦比的，极大地简化和自动化了上述任务，甚至更多。</p><p id="f071" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">然而，它仍然需要一定程度的专业知识。</p><p id="1749" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">因此，我们的目标是将一切都打包到Kubernetes操作器中，以实现更进一步的自动化，并尽可能消除对专业知识的需求。</p><h1 id="2b1e" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">概观</h1><p id="11fe" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">以下是HL织物操作员的示意图:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/06a343c5ab4682079934d75b94e5a15d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*z4zcDOlNaeUhb6Sn"/></div></div></figure><p id="46b3" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">1.<em class="ma"> FabricNetwork </em>是一个CRD(自定义资源定义),是与Fabric Operator交互的主要输入</p><p id="6651" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">2.<code class="fe mx my mz na b">configtx.yaml</code>和<code class="fe mx my mz na b">chaincode sources</code>是FabricNetwork CRD的补充输入。</p><p id="76f6" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">3.<code class="fe mx my mz na b">Crypto materials</code>和<code class="fe mx my mz na b">genesis block</code>是可选的辅助输入。如果用户未提供，将由结构操作员动态创建。</p><p id="e9c7" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">4.用户向Kubernetes集群提交输入。</p><p id="5dae" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">5.Fabric controller pod(Fabric operator)监听类型为<em class="ma"> FabricNetwork </em>的CRD，并相应地管理组件。</p><p id="9f66" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">6.每个<em class="ma"> FabricNetwork </em> CRD应该提交到一个单独的名称空间。</p><p id="658e" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">7.由结构运营商管理的Hyperledger结构网络组件可以是完整的网络，包括所有对等节点和订购者节点。</p><p id="cea9" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">8.或者它可以是与位于Kubernetes集群之外的其他对等节点和订购节点通信的部分网络</p><p id="a2c8" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">9.对于许多功能，Fabric Operator使用Argo控制器，该控制器本身也是一个运算符。</p><h1 id="29d0" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">CRD纺织网络公司</h1><p id="ce6e" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated"><em class="ma"> FabricNetwork </em> CRD(自定义资源定义)规范由四部分组成:</p><h2 id="7b2a" class="nb jz iq bd ka nc nd dn ke ne nf dp ki lh ng nh km ll ni nj kq lp nk nl ku nm bi translated">最高级的</h2><p id="89de" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">这里定义了<code class="fe mx my mz na b">configtx</code>、<code class="fe mx my mz na b">chaincode</code>、<code class="fe mx my mz na b">genesis block</code>和<code class="fe mx my mz na b">crypto material</code>的来源。它们可以是Kubernetes <code class="fe mx my mz na b">Secrets</code>和/或<code class="fe mx my mz na b">ConfigMaps</code>或者是对本地文件系统的引用。只有在使用CLI工具时，才能引用本地文件系统。</p><p id="d316" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><code class="fe mx my mz na b">hostAliases</code>用于与外部同行/订购者沟通。如果<code class="fe mx my mz na b">useActualDomains</code>为真，Fabric Operator仍然会创建内部<code class="fe mx my mz na b">hostAliases</code>并附加到这个。</p><pre class="mt mu mv mw gt nn na no np aw nq bi"><span id="4ff6" class="nb jz iq na b gy nr ns l nt nu"># source of the configtx.yaml file. either a Kubernetes Secret or a file.<br/>  configtx:<br/>    file: configtx.yaml # see CLI for usage<br/>    # secret: hlf-configtx.yaml</span><span id="bce8" class="nb jz iq na b gy nv ns l nt nu">  chaincode:<br/>    version: "1.0"<br/>    language: node<br/>    folder: ../chaincode # see CLI for usage<br/>    # configMaps: implied list</span><span id="e7ad" class="nb jz iq na b gy nv ns l nt nu">  # source of the genesis block. either a Kubernetes Secret or a file.<br/>  # if none provided Fabric Operator will create the genesis block<br/>  genesis: {}<br/>    # file: # see CLI for usage<br/>    # secret: hlf-genesis.block</span><span id="fc34" class="nb jz iq na b gy nv ns l nt nu">  # source of the crypto materials. either a Kubernetes Secret or a folder.<br/>  # if none provided Fabric Operator will create the crypto materials via cryptogen tool.<br/>  # the secret contains TAR archived crypto material<br/>  crypto-config: {}<br/>    # folder: ./crypto-config<br/>    # secret: hlf-crypto-config</span><span id="1351" class="nb jz iq na b gy nv ns l nt nu">  # adds additional DNS entries to /etc/hosts files of pods<br/>  # this is provided for communication with external peers/orderers<br/>  # if useActualDomains is true, Fabric Operator will still create internal hostAliases and append to this one<br/>  hostAliases: <br/>  <br/>  # forces Fabric Operator to set the the state of FabricNetwork to given state and continue. <br/>  # use with caution. see troubleshooting section for how to use.<br/>  forceState:</span></pre><h2 id="fd2b" class="nb jz iq bd ka nc nd dn ke ne nf dp ki lh ng nh km ll ni nj kq lp nk nl ku nm bi translated">拓扑学</h2><p id="5462" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">由结构运营商管理的结构网络的拓扑。这一部分还包含一些适用于整个网络的顶级属性。<code class="fe mx my mz na b">crypto-config.yaml</code>就是从这部分衍生出来的。</p><pre class="mt mu mv mw gt nn na no np aw nq bi"><span id="1c8d" class="nb jz iq na b gy nr ns l nt nu"># topology of the Fabric network managed by Fabric Operator<br/># also contains some top level properties which is applied to whole network<br/>  topology:<br/>    # Hyperledger Fabric Version<br/>    version: 1.4.9  <br/>    # TLS enabled?<br/>    tlsEnabled: true<br/>    # use actual domain names like peer0.atlantis.com instead of internal service names<br/>    useActualDomains: true</span><span id="1af9" class="nb jz iq na b gy nv ns l nt nu">    # Orderer and Peer organizations topology<br/>    # crypto-config.yaml will be derived from this part<br/>    ordererOrgs:<br/>      - name: Pivt<br/>        domain: pivt.nl<br/>        hosts:<br/>          - orderer0<br/>    peerOrgs:<br/>      - name: Karga<br/>        domain: aptalkarga.tr<br/>        peerCount: 1<br/>      - name: Nevergreen<br/>        domain: nevergreen.nl<br/>        peerCount: 1<br/>      - name: Atlantis<br/>        domain: atlantis.com<br/>        peerCount: 1</span></pre><h2 id="84a3" class="nb jz iq bd ka nc nd dn ke ne nf dp ki lh ng nh km ll ni nj kq lp nk nl ku nm bi translated">网络</h2><p id="eaba" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">本部分定义了如何根据信道和链码填充网络。该部分与PIVT舵图中的<a class="ae lu" href="https://github.com/hyfen-nl/PIVT#networkyaml" rel="noopener ugc nofollow" target="_blank"> network.yaml </a>相同。</p><pre class="mt mu mv mw gt nn na no np aw nq bi"><span id="76b3" class="nb jz iq na b gy nr ns l nt nu">network:<br/>    # used to create genesis block and by peer-org-flow to parse consortiums<br/>    genesisProfile: OrdererGenesis<br/>    # used to create genesis block <br/>    systemChannelID: testchainid</span><span id="3c37" class="nb jz iq na b gy nv ns l nt nu">    # defines which organizations will join to which channels<br/>    channels:<br/>      - name: common<br/>        # all peers in these organizations will join the channel<br/>        orgs: [Karga, Nevergreen, Atlantis]<br/>      - name: private-karga-atlantis<br/>        # all peers in these organizations will join the channel<br/>        orgs: [Karga, Atlantis]</span><span id="16c1" class="nb jz iq na b gy nv ns l nt nu">    # defines which chaincodes will be installed to which organizations<br/>    chaincodes:<br/>      - name: very-simple<br/>        # if defined, this will override the global chaincode.version value<br/>        # version: # "2.0" <br/>        # chaincode will be installed to all peers in these organizations<br/>        orgs: [Karga, Nevergreen, Atlantis]<br/>        # at which channels are we instantiating/upgrading chaincode?<br/>        channels:<br/>        - name: common<br/>          # chaincode will be instantiated/upgraded using the first peer in the first organization<br/>          # chaincode will be invoked on all peers in these organizations<br/>          orgs: [Karga, Nevergreen, Atlantis]<br/>          policy: OR('KargaMSP.member','NevergreenMSP.member','AtlantisMSP.member')<br/>          <br/>      - name: even-simpler<br/>        # if defined, this will override the global chaincode.language value<br/>        language: golang<br/>        orgs: [Karga, Atlantis]<br/>        channels:<br/>        - name: private-karga-atlantis<br/>          orgs: [Karga, Atlantis]<br/>          policy: OR('KargaMSP.member','AtlantisMSP.member')</span></pre><h2 id="b874" class="nb jz iq bd ka nc nd dn ke ne nf dp ki lh ng nh km ll ni nj kq lp nk nl ku nm bi translated">附加设置</h2><p id="ed74" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">此部分包含传递到相关PIVT舵图表的附加设置。详情见各图表的<code class="fe mx my mz na b">values.yaml</code>文件。</p><pre class="mt mu mv mw gt nn na no np aw nq bi"><span id="bdb2" class="nb jz iq na b gy nr ns l nt nu">hlf-kube: <br/>  peer:<br/>    docker:<br/>      dind: <br/>        # use a side car docker in docker container? <br/>        # required for Kubernetes versions 1.19+ <br/>        enabled: true<br/>channel-flow: {}<br/>chaincode-flow: {}<br/>peer-org-flow: {}</span></pre><h2 id="4cdc" class="nb jz iq bd ka nc nd dn ke ne nf dp ki lh ng nh km ll ni nj kq lp nk nl ku nm bi translated">样品</h2><p id="b315" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">有关完整样品，请参见Fabric Operator储存库中的<a class="ae lu" href="https://github.com/raftAtGit/hl-fabric-operator/tree/master/samples" rel="noopener ugc nofollow" target="_blank">样品</a>。</p><p id="e637" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><a class="ae lu" href="https://github.com/raftAtGit/hl-fabric-operator#go-over-samples" rel="noopener ugc nofollow" target="_blank">阅读自述文件中的样本</a>部分包含运行样本的完整说明。</p><h1 id="9140" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">硬币指示器 （coin-levelindicator的缩写）命令行界面（Command Line Interface for batch scripting）</h1><p id="50a9" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">Fabric Operator CLI是用于与Fabric Operator交互的辅助工具。</p><p id="61a3" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">这不是织物操作员正常操作所必需的，而是为了方便而提供的一种工具。</p><p id="dc8e" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">它执行客户端验证，并在Kubernetes中动态创建必要的资源。</p><p id="68b5" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">通过使用CLI，可以将补充输入指定为对本地文件系统的引用。例如，如果<code class="fe mx my mz na b">chaincode.folder</code>在如下的<em class="ma"> FabricNetwork </em> CRD中提供，CLI将在提交<em class="ma"> FabricNetwork </em>给Kubernetes之前创建链码<code class="fe mx my mz na b">ConfigMaps</code>。</p><pre class="mt mu mv mw gt nn na no np aw nq bi"><span id="f253" class="nb jz iq na b gy nr ns l nt nu">chaincode:<br/>  folder: ../chaincode</span></pre><p id="eae1" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">CLI使用本地<code class="fe mx my mz na b">kubectl</code>设置:如果设置了<code class="fe mx my mz na b">KUBECONFIG</code>环境变量，则使用该变量，否则使用<code class="fe mx my mz na b">~/.kube/config</code>。</p><p id="05c5" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">许多CLI命令使用与<code class="fe mx my mz na b">kubectl</code>相同的语义。例如:</p><pre class="mt mu mv mw gt nn na no np aw nq bi"><span id="1a4b" class="nb jz iq na b gy nr ns l nt nu">-n, --namespace string<br/>-A, --all-namespaces</span></pre><h1 id="e00f" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">用法示例</h1><p id="d3f5" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">假设使用CLI，以下命令将启动并配置一个组织Raft订购者网络，每个组织有一个对等点:</p><pre class="mt mu mv mw gt nn na no np aw nq bi"><span id="c733" class="nb jz iq na b gy nr ns l nt nu">rfabric create samples/simple-raft-tls/fabric-network.yaml</span></pre><p id="2a46" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">输出:</p><pre class="mt mu mv mw gt nn na no np aw nq bi"><span id="8790" class="nb jz iq na b gy nr ns l nt nu">created configtx Secret hlf-configtx.yaml<br/>created chaincode ConfigMap hlf-chaincode—-very-simple<br/>created chaincode ConfigMap hlf-chaincode—-even-simpler<br/>created new FabricNetwork simple-raft-tls in namespace default</span></pre><p id="4b06" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">发生了什么事？CLI注意到对configtx和chaincodes的引用是本地文件系统引用，它创建了相关的<code class="fe mx my mz na b">Secret</code>和<code class="fe mx my mz na b">ConfigMaps</code>，更新了<code class="fe mx my mz na b">FabricNetwork</code>以使用创建的Secret/ConfigMaps并提交给Kubernetes。</p><p id="507a" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">织物操作员现在将为<a class="ae lu" href="https://github.com/hyfen-nl/PIVT/tree/master/fabric-kube/hlf-kube" rel="noopener ugc nofollow" target="_blank"> hlf-kube </a>创建一个舵释放，等到它准备好，然后将启动<a class="ae lu" href="https://github.com/hyfen-nl/PIVT/tree/master/fabric-kube/channel-flow" rel="noopener ugc nofollow" target="_blank">通道Argo流</a>，等到它完成，然后将启动<a class="ae lu" href="https://github.com/hyfen-nl/PIVT/tree/master/fabric-kube/chaincode-flow" rel="noopener ugc nofollow" target="_blank">链码Argo流</a>，等到它完成，然后<em class="ma">织物网络</em>将准备好。</p><p id="28b4" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">在这个过程中，<em class="ma"> FabricNetwork </em>将经历几个状态:</p><pre class="mt mu mv mw gt nn na no np aw nq bi"><span id="d5ef" class="nb jz iq na b gy nr ns l nt nu">New<br/>HelmChartInstalled<br/>HelmChartNeedsUpdate<br/>HelmChartReady<br/>ChannelFlowSubmitted<br/>ChannelFlowCompleted<br/>ChaincodeFlowSubmitted<br/>ChaincodeFlowCompleted<br/>Ready</span></pre><p id="d1fd" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">该过程可遵循以下任一步骤:</p><pre class="mt mu mv mw gt nn na no np aw nq bi"><span id="825b" class="nb jz iq na b gy nr ns l nt nu">kubectl get FabricNetwork simple-raft-tls -o yaml --watch</span></pre><p id="893e" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">或者</p><pre class="mt mu mv mw gt nn na no np aw nq bi"><span id="c6cc" class="nb jz iq na b gy nr ns l nt nu">watch rfabric list</span></pre><h2 id="45ea" class="nb jz iq bd ka nc nd dn ke ne nf dp ki lh ng nh km ll ni nj kq lp nk nl ku nm bi translated">更新链码</h2><p id="9fa7" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">让我们假设您已经更新了链码源代码。无论如何，你都可以更新它们。</p><p id="a5c1" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">将顶级链码版本更新为<code class="fe mx my mz na b">2.0</code>。</p><pre class="mt mu mv mw gt nn na no np aw nq bi"><span id="2df5" class="nb jz iq na b gy nr ns l nt nu">chaincode:<br/>  version: "2.0"</span></pre><p id="c49d" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">然后用CLI更新<em class="ma"> FabricNetwork </em>:</p><pre class="mt mu mv mw gt nn na no np aw nq bi"><span id="e046" class="nb jz iq na b gy nr ns l nt nu">rfabric update <!-- -->samples/simple-raft-tls/fabric-network.yaml</span></pre><p id="cb34" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">Fabric操作员将启动链码Argo流程，两个链码都将更新至版本<code class="fe mx my mz na b">2.0</code>。</p><p id="2185" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">您也可以更新个人链码。例如，以下更改将仅将链码<code class="fe mx my mz na b">very-simple</code>更新为版本<code class="fe mx my mz na b">3.0</code>。</p><pre class="mt mu mv mw gt nn na no np aw nq bi"><span id="e357" class="nb jz iq na b gy nr ns l nt nu">chaincodes:<br/>  - name: very-simple<br/>    version: "3.0"</span></pre><h2 id="e741" class="nb jz iq bd ka nc nd dn ke ne nf dp ki lh ng nh km ll ni nj kq lp nk nl ku nm bi translated">更新频道</h2><p id="c894" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">让我们创建另一个名为<code class="fe mx my mz na b">common-2</code>的通道。</p><p id="6386" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">将以下配置文件添加到<code class="fe mx my mz na b">configtx.yaml</code>:</p><pre class="mt mu mv mw gt nn na no np aw nq bi"><span id="a87f" class="nb jz iq na b gy nr ns l nt nu">common-2:<br/>  Consortium: TheConsortium<br/>  &lt;&lt;: *ChannelDefaults<br/>  Application:<br/>     &lt;&lt;: *ApplicationDefaults<br/>     Organizations:<br/>       - *Karga<br/>       - *Nevergreen<br/>       - *Atlantis</span></pre><p id="75c3" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">下面来看CRD<em class="ma">fabric network</em>的<code class="fe mx my mz na b">channels</code>部分:</p><pre class="mt mu mv mw gt nn na no np aw nq bi"><span id="48c8" class="nb jz iq na b gy nr ns l nt nu">channels:<br/>  - name: common-2<br/>    # all peers in these organizations will join the channel<br/>    orgs: [Karga, Nevergreen, Atlantis]</span></pre><p id="74ef" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">然后用CLI更新<em class="ma"> FabricNetwork </em>:</p><pre class="mt mu mv mw gt nn na no np aw nq bi"><span id="83c8" class="nb jz iq na b gy nr ns l nt nu">rfabric update <!-- -->samples/simple-raft-tls/fabric-network.yaml</span></pre><p id="b4fe" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">Fabric Operator将启动通道Argo流，该流将创建通道<code class="fe mx my mz na b">common-2</code>并将上述组织中的所有对等体添加到通道<code class="fe mx my mz na b">common-2</code>。</p><h2 id="ef63" class="nb jz iq bd ka nc nd dn ke ne nf dp ki lh ng nh km ll ni nj kq lp nk nl ku nm bi translated">添加新的对等组织</h2><p id="b06c" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">相应地更新您的<code class="fe mx my mz na b">configtx.yaml</code>和<em class="ma"> FabricNetwork </em> CRD。所提供的样本已经在<code class="fe mx my mz na b">extended</code>文件夹中进行了配置。</p><p id="81f9" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">然后用CLI更新<em class="ma"> FabricNetwork </em>:</p><pre class="mt mu mv mw gt nn na no np aw nq bi"><span id="42ec" class="nb jz iq na b gy nr ns l nt nu">rfabric update <!-- -->samples/simple-raft-tls/extended/fabric-network.yaml</span></pre><p id="8213" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">Fabric Operator将首先更新Helm图表，然后启动peer-org Argo流程，将缺失的组织添加到联合体，并将缺失的组织添加到现有渠道，如<code class="fe mx my mz na b">network</code>部分所述。那么通道Argo流将被启动并创建丢失的通道。最后将运行链码Argo流。</p><p id="4bf1" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">详情请参见PIVT Helm charts repo中的<a class="ae lu" href="https://github.com/hyfen-nl/PIVT#adding-new-peer-organizations" rel="noopener ugc nofollow" target="_blank">添加新的同级组织</a>部分。</p><p id="3a44" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">请注意，如果您没有运行多数组织，并且策略要求多数，则添加新的对等组织将会失败。但是，您仍然可以使用Fabric Operator来完成繁重的工作:</p><ul class=""><li id="4868" class="mb mc iq ky b kz lv ld lw lh md ll me lp mf lt mg mh mi mj bi translated">您可以让Fabric Operator为用户和订购者通道准备和签署配置更新，但防止将更新发送到订购者节点(因此，您可以将配置更新发送到其他方，他们可以继续)</li><li id="3d41" class="mb mc iq ky b kz mk ld ml lh mm ll mn lp mo lt mg mh mi mj bi translated">您可以让Fabric Operator从提供的签名配置更新开始</li><li id="4279" class="mb mc iq ky b kz mk ld ml lh mm ll mn lp mo lt mg mh mi mj bi translated">或者你可以两者都做</li></ul><p id="a1ee" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><strong class="ky ir">注意:</strong>您需要启用<code class="fe mx my mz na b">persistence </code>来扩展Raft订购者网络，(更准确地说，如果<code class="fe mx my mz na b">useActualDomains</code>为真)。由于<code class="fe mx my mz na b">hostAliases</code>的更新，pod将重新启动，如果<code class="fe mx my mz na b">persistence</code>未启用，它们将丢失所有数据。</p><h1 id="aa36" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">状态机</h1><p id="4610" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">下图显示了HL Fabric Operator的状态机:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/ea1d3c7cc47cf6c2fb504e64ed4b897a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JAE8SWbb1FccpE_y"/></div></div></figure><h1 id="bb1b" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">结论</h1><p id="2111" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">祝Kubernetes区块链快乐:)</p><p id="79bd" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">别忘了区块链俱乐部的第一条规则:</p><p id="7eb9" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><strong class="ky ir">“除非绝对必要，否则不要使用区块链！”</strong></p><p id="1371" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><em class="ma">哈坎·埃里亚吉</em></p></div></div>    
</body>
</html>