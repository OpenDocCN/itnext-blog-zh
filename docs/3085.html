<html>
<head>
<title>Quick Kubernetes Helm Learnings on Chart Backward Compatibility</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">关于图表向后兼容性的Kubernetes Helm快速学习</h1>
<blockquote>原文：<a href="https://itnext.io/quick-helm-learnings-on-chart-backward-compatibility-75799e34d381?source=collection_archive---------6-----------------------#2019-09-30">https://itnext.io/quick-helm-learnings-on-chart-backward-compatibility-75799e34d381?source=collection_archive---------6-----------------------#2019-09-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/6a915ee877aa258c01cdb428fd793e2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:440/format:webp/1*phvmHMQvoJ6AwvKGmRNhBg.png"/></div></div></figure><p id="fc9d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Buffer，我们利用<a class="ae kw" href="https://github.com/jtblin/kube2iam" rel="noopener ugc nofollow" target="_blank"> kube2iam </a>获得AWS权限。它通过<a class="ae kw" href="https://github.com/helm/charts/tree/master/stable/kube2iam" rel="noopener ugc nofollow" target="_blank">稳定舵图表库</a>进行部署、升级和管理。</p><p id="05c6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它一直工作得很好，直到上周由于我的疏忽。这种情况在30分钟内得到解决，没有用户受到影响。尽管如此，我还是很乐意与社区分享我的经验。</p><p id="ab62" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了升级<code class="fe kx ky kz la b">kube2iam</code>,我一直在使用这个命令</p><p id="8571" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kx ky kz la b">helm upgrade kube2iam --install stable/kube2iam --namespace default -f ./values.yaml</code></p><p id="b42f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">其中的<code class="fe kx ky kz la b">values.yaml</code>文件包含一堆被覆盖的变量。在我们的例子中，它看起来像</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="1867" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该命令会将<code class="fe kx ky kz la b">kube2iam</code>升级到包含升级后的<code class="fe kx ky kz la b">kube2iam</code>图像的最新图表。至少，这是我所希望的。</p><p id="c89f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">令我惊讶的是，返回了一条错误消息。它抱怨一些新标签没有被认可。然后我检查了头盔的展开状态，发现展开失败了。</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lh"><img src="../Images/c08e9dc490b8dd9f590842037afc062e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lt7qCmcVo3PwIEGqA4FdCw.png"/></div></div></figure><p id="0549" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">即使部署失败，已经运行的pod仍继续正常运行。这类似于你的桌面应用程序升级失败，不应该删除旧的。因此没有生产服务受到影响。尽管如此，这是我需要尽快弄清楚的事情。让这个失败的部署持续太久感觉不太好，因为可能会有一些负面影响。</p><p id="f41e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我很快研究了这个问题，发现有问题的标签就在几个月前被添加到了kube2iam头盔图中。在<a class="ae kw" href="https://github.com/helm/charts/commit/520dee4464c62ce4ab341f9ecdb638261716e87e#diff-86128f9a45e1fe4ea0dac1fc5378d5c1" rel="noopener ugc nofollow" target="_blank">提交</a>中，我们可以看到海图维护者试图遵循<a class="ae kw" href="https://helm.sh/docs/chart_best_practices/#standard-labels" rel="noopener ugc nofollow" target="_blank">新舵手海图标准</a>(我相信是源于k8s 的<a class="ae kw" href="https://kubernetes.io/docs/concepts/overview/working-with-objects/common-labels/" rel="noopener ugc nofollow" target="_blank">)并对这一突破性变化发出警告。</a></p><p id="a2ef" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe kx ky kz la b">kube2iam</code>的例子中，删除部署并重新创建不是一个选项，因为我们的许多生产服务都需要它。我只需要找到一种新的方法来升级<code class="fe kx ky kz la b">kube2iam</code>版本，而不更新图表版本。</p><p id="452f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">幸运的是，我用这个命令找到了一个很好的方法</p><p id="dd8b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kx ky kz la b">helm upgrade kube2iam --install stable/kube2iam --namespace default -f ./values.yaml --version 1.1.0</code></p><p id="244e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它告诉Helm安装版本1.1.0，而不是2.0.1。这解决了头盔升级的问题。</p><p id="1bae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">关于<code class="fe kx ky kz la b">kube2iam</code>镜像升级，我给<code class="fe kx ky kz la b">values.yaml</code>添加了一个新的镜像标签(0.10.7)，如下所示。</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="3ef7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这两种方法的结合帮助我们在升级了<code class="fe kx ky kz la b">kube2iam</code>映像的情况下成功部署了头盔。</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi li"><img src="../Images/7ad33e9a15eb31d13257c07ed13ac845.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*btc9lLUh3bYne8Wdr3Me9Q.png"/></div></div></figure></div><div class="ab cl lj lk hu ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ij ik il im in"><h1 id="75fa" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">关键学习点</h1><ul class=""><li id="b72b" class="mo mp iq ka b kb mq kf mr kj ms kn mt kr mu kv mv mw mx my bi translated">舵图不一定是向后兼容的</li><li id="18ee" class="mo mp iq ka b kb mz kf na kj nb kn nc kr nd kv mv mw mx my bi translated">由于上述原因，在掌舵命令中使用<code class="fe kx ky kz la b">--dry-run</code>旗来看看会发生什么总是好的</li><li id="75e0" class="mo mp iq ka b kb mz kf na kj nb kn nc kr nd kv mv mw mx my bi translated">如果出现向后兼容问题，使用<code class="fe kx ky kz la b">--version</code>找到一个可用的版本</li><li id="2c0c" class="mo mp iq ka b kb mz kf na kj nb kn nc kr nd kv mv mw mx my bi translated">由于新标签推荐(<code class="fe kx ky kz la b">app</code> → <code class="fe kx ky kz la b">app.kubernetes.io/name</code>和<code class="fe kx ky kz la b">release</code> → <code class="fe kx ky kz la b">app.kubernetes.io/instance</code>)，期待更多突破性的舵图</li><li id="b9be" class="mo mp iq ka b kb mz kf na kj nb kn nc kr nd kv mv mw mx my bi translated">失败的头盔部署不会移除现有的头盔</li></ul><p id="1de3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">快乐驾驶！</p></div><div class="ab cl lj lk hu ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ij ik il im in"><p id="9fc2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ne">原载于</em><a class="ae kw" href="https://gist.github.com/stevenc81/584c8ad382d614375a81452037057ced" rel="noopener ugc nofollow" target="_blank"><em class="ne">http://github.com</em></a><em class="ne">。</em></p></div></div>    
</body>
</html>