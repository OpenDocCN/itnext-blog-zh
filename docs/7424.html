<html>
<head>
<title>Journey Of A Microservice Application In The Kubernetes World</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes世界的微服务应用之旅</h1>
<blockquote>原文：<a href="https://itnext.io/journey-of-a-microservice-application-in-the-kubernetes-world-e2f6475ddde1?source=collection_archive---------1-----------------------#2022-09-19">https://itnext.io/journey-of-a-microservice-application-in-the-kubernetes-world-e2f6475ddde1?source=collection_archive---------1-----------------------#2022-09-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3346" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">当webhooks应用遇到Acorn</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/60828c1e9a01494dccae0f2bdaccf5bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ww0sBsjZBDXH-3xF0Ulxbg.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">在<a class="ae ky" href="https://unsplash.com/s/photos/acorn?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ky" href="https://unsplash.com/ja/@calebdlucas?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Caleb Lucas </a>拍照</figcaption></figure><h2 id="626b" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">TL；速度三角形定位法(dead reckoning)</h2><p id="bf44" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">在<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/journey-of-a-microservice-application-in-the-kubernetes-world-3c2a9e701e9f">的上一篇文章</a>中，我们解释了如何使用Helm / Helmfile在Kubernetes集群中部署webhooks应用程序。在本文中，我们将解释如何使用Kubernetes的应用程序部署框架Acorn 运行、打包和分发这个应用程序。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h2 id="29e7" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">本系列文章</h2><ul class=""><li id="5a94" class="mv mw it lx b ly lz mb mc li mx lm my lq mz mn na nb nc nd bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/journey-of-a-microservice-application-in-the-kubernetes-world-bdfe795532ef">web hooks . app的展示</a></li><li id="87a5" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/journey-of-a-microservice-application-in-the-kubernetes-world-3c2a9e701e9f">使用Helm在本地单节点Kubernetes上运行应用</a></li><li id="aa4c" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/journey-of-a-microservice-application-in-the-kubernetes-world-e800579f0be3#0174-87b0e3c1fcd3">在Civo Kubernetes集群上运行应用</a></li><li id="8029" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/journey-of-a-microservice-application-in-the-kubernetes-world-d9493b19edff">使用GitOps和Argo CD进行连续部署</a></li><li id="c5c3" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/journey-of-a-microservice-application-in-the-kubernetes-world-876f72ce1681">使用Loki堆栈的可观察性</a></li><li id="c7c1" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated">使用Acorn定义应用程序(本文)</li><li id="db1c" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/journey-of-a-microservice-application-in-the-kubernetes-world-6abd625c60fe">安全注意事项:安全相关工具</a></li><li id="7bea" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/journey-of-a-microservice-application-in-the-kubernetes-world-eb0fb52e1bf0">安全考虑:修复错误配置</a></li><li id="3c61" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/journey-of-a-microservice-application-in-the-kubernetes-world-f760cba7600f">安全考虑:策略实施</a></li><li id="24c3" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated">安全考虑:漏洞扫描(即将推出)</li></ul></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h2 id="f5f3" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">关于这篇文章</h2><p id="3743" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">当这个系列的第二篇文章发表后，我在Twitter上收到了来自T2的一条消息，建议我给T4一个机会。当时我只知道Acorn的名字，对这项技术了解不多。在webhooks应用程序上演示Acorn的用法似乎是一个了解更多的好主意。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h2 id="d5fd" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">关于橡子</h2><p id="7307" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">当您开发一个微服务应用程序时，您可能已经熟悉Docker，并且可能使用Docker Compose在您的本地机器上部署整个应用程序。当您需要在Kubernetes上部署应用程序时，这可能会令人望而生畏，尤其是如果您不熟悉这个orchestrator的话。事实上，在了解如何在yaml文件中指定您的应用程序或者甚至将其作为一个导航图之前，首先需要理解许多Kubernetes的概念，了解现有的资源(Pod、部署、服务等等)。</p><p id="c013" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">Acorn 是一个新项目(在撰写本文时版本为0.2)，被定义为Kubernetes的一个简单的应用程序部署框架。它使用一种简单的格式来指定在容器中运行的应用程序，允许应用程序在任何环境中运行、打包和分发，并部署到Kubernetes，而不需要了解太多。</p><p id="1e99" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">来自<a class="ae ky" href="https://docs.acorn.io" rel="noopener ugc nofollow" target="_blank"> Acorn文档</a>的以下模式给出了Acorn内部的高级视图:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/9a3e84e8a6f09847d97fb060d6e49b0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VX1vQ5W5zBp0EsIBEp09Ig.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://docs.acorn.io/architecture/ten-thousand-foot-view" rel="noopener ugc nofollow" target="_blank">橡子架构</a></figcaption></figure><p id="b15d" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">它定义了4个组件:</p><ul class=""><li id="5d0d" class="mv mw it lx b ly nl mb nm li nr lm ns lq nt mn na nb nc nd bi translated">acorn cli是针对acorn服务器端组件运行命令的客户端二进制文件</li><li id="61eb" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated"><strong class="lx iu"> api服务器</strong>根据CLI收到的请求管理应用生命周期</li><li id="9410" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated"><strong class="lx iu">控制器</strong>将Acorn应用程序转换成Kubernetes资源</li><li id="74bb" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated"><strong class="lx iu"> buildkit和内部注册表</strong>用于构建图像并将其存储在内部</li></ul><p id="f3a4" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">在用acorn部署应用程序之前，我们需要在一个【acorn文件中指定这个应用程序。这个文件描述了如何构建、开发和运行容器化的应用程序。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/7cbf423ccd150ad074ef9d0fe22d46e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YNT3Op22g-R9kZMt.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Acorn工作流</figcaption></figure><p id="52f2" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">如文档中的<a class="ae ky" href="https://docs.acorn.io/authoring/structure" rel="noopener ugc nofollow" target="_blank">所述，一个<em class="nu">acorn文件</em>包含以下顶级元素:</a></p><ul class=""><li id="f8b5" class="mv mw it lx b ly nl mb nm li nr lm ns lq nt mn na nb nc nd bi translated"><strong class="lx iu"> args </strong>:定义消费者可以提供的参数</li><li id="33d7" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated"><strong class="lx iu">概要文件</strong>:为不同的部署类型定义了一组默认参数</li><li id="db31" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated"><strong class="lx iu">容器</strong>:定义运行应用程序的容器</li><li id="f8e1" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated"><strong class="lx iu"> volumes </strong>:定义容器要消耗的持久存储容量</li><li id="bd9d" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated"><strong class="lx iu">作业</strong>:定义在变更时或通过cron运行的任务</li><li id="9df4" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated"><strong class="lx iu"> acorns </strong>:其他需要和你的app一起部署的Acorn应用</li><li id="d68d" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated"><strong class="lx iu">机密</strong>:定义由用户自动生成或传递的数据的机密位</li><li id="6933" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated"><strong class="lx iu"> localData </strong>:默认数据和配置变量</li></ul><p id="afb9" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">注意:一个新的<strong class="lx iu">路由器</strong>功能已经实现，它可以在<strong class="lx iu">路由器</strong>键下的<em class="nu"> Acornfile </em>中获得(我们将在下面看到一个这样的例子),并将很快被记录下来。</p><p id="317e" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">创作Acornfile文档给出了所有可用字段的例子。一个<em class="nu"> Acornfile </em>可以非常简单，例如下面的定义了一个运行ghost镜像的简单容器。</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="0b36" class="kz la it nx b gy ob oc l od oe">containers: {<br/> ghost: {<br/>  image: "ghost:4"<br/>  ports: publish: "2368/http"<br/> }<br/>}</span></pre><p id="ccef" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">当然，<em class="nu"> Acornfile </em>格式可以使用上面列出的高级元素轻松包含现实世界多容器应用程序的复杂性。</p><p id="129a" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">在接下来的步骤中，我们将安装Acorn，使用<em class="nu"> Acornfile </em>来定义webhooks应用程序，并通过<em class="nu"> acorn </em> cli来管理它。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h2 id="66c2" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">安装Acorn</h2><p id="9361" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">为了说明本文，我们将使用一个安装了Traefik入口控制器的单节点k3s集群。Acorn需要一个入口控制器来公开应用程序，Acorn还需要一个存储类来为需要它的容器提供存储。</p><p id="77de" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">首先，我们按照安装文档安装Acorn CLI。在MacOS和Linux上，可以使用这个方便的安装脚本:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="1ce5" class="kz la it nx b gy ob oc l od oe">$ curl https://get.acorn.io | sh</span></pre><p id="22b6" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">不带任何参数运行<em class="nu"> acorn </em>命令会返回可用于管理acorn应用程序的命令的完整列表。我们将在接下来的步骤中使用其中的几个命令。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/1f34f81dffcf6220697b3feb808061cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iJOZxdh-BM37UwjaWJ8wKw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">acorn cli中可用的命令</figcaption></figure><p id="ada1" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">接下来，我们在集群中安装Acorn服务器端组件:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="fff1" class="kz la it nx b gy ob oc l od oe">$ acorn install</span></pre><p id="20f6" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">这将产生如下所示的结果:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="f856" class="kz la it nx b gy ob oc l od oe">  ✔  Running Pre-install Checks<br/>  ✔  Installing ClusterRoles<br/>  ✔  Installing APIServer and Controller (image ghcr.io/acorn-io/acorn:v0.2.1)<br/>  ✔  Waiting for controller deployment to be available<br/>  ✔  Waiting for API server deployment to be available<br/>  ✔  Installation done</span></pre><p id="1fde" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">Acorn已经安装完毕，可以管理容器化的应用程序了！</p><p id="5c89" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">下一步，我们将在一个<em class="nu"> Acornfile </em>中定义webhooks应用程序，在集群中部署它，打包它，并通过DockerHub分发它。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h2 id="b71b" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">用Acorn指定webhooks应用程序</h2><p id="529e" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">webhooks应用程序具有以下架构(您可以查看<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/journey-of-a-microservice-application-in-the-kubernetes-world-bdfe795532ef">系列的第一篇文章</a>以了解关于这个示例应用程序的更多细节):</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/3a977a7932d80f216608f0c00891c92f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1266/format:webp/1*nl0lkSZ68akJntJ5GgPnrQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">webhooks应用程序的架构</figcaption></figure><p id="d3a0" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">在以前的文章中，我们展示了如何定义这个应用程序:</p><ul class=""><li id="b181" class="mv mw it lx b ly nl mb nm li nr lm ns lq nt mn na nb nc nd bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/journey-of-a-microservice-application-in-the-kubernetes-world-bdfe795532ef">与码头工人缀</a></li><li id="a2fd" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated">作为<a class="ae ky" href="https://gitlab.com/web-hook/config/-/tree/main/apps/webhooks" rel="noopener ugc nofollow" target="_blank">在Kubernetes上运行的掌舵图</a></li></ul><p id="7755" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">现在是时候看看如何用Acorn管理这个应用程序了，这将从描述应用程序的Acornfile 的定义开始。</p><p id="86dd" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">以下<em class="nu"> Acornfile </em>是<a class="nj nk ep" href="https://medium.com/u/175a56629d3f?source=post_page-----e2f6475ddde1--------------------------------" rel="noopener" target="_blank">Darren Shepherd</a>(k3s的创造者，现Acorn Labs首席架构师兼联合创始人)在Acorn Slack频道给我的，感谢Darren！</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="521a" class="kz la it nx b gy ob oc l od oe">args: {<br/>    // Run tests<br/>    tests: false<br/>}<br/><br/>containers: {<br/>    api: {<br/>        build: {<br/>            context: "../api"<br/>            if args.dev {<br/>                dockerfile: "../api/Dockerfile.dev"<br/>            }<br/>        }<br/>        if args.dev {<br/>            dirs: "/app": "../api/"<br/>        }<br/>        probe: "http://localhost:5000/app/healthz"<br/>        ports: "5000/http"<br/>        dependsOn: ["nats", "mongo"]<br/>    }<br/><br/>    ws: {<br/>        build: "../ws"<br/>        probes: {}<br/>        ports: "8080/http"<br/>        dependsOn: ["nats", "mongo"]<br/>    }<br/><br/>    mongo: {<br/>        image: "mongo:4.4"<br/>        ports: 27017<br/>        dirs: "/data/db": "mongo-data"<br/>    }<br/><br/>    nats: {<br/>        image: "nats:2.8-alpine"<br/>        ports: 4222<br/>    }<br/><br/>    www: {<br/>        build: "../www"<br/>        dependsOn: ["nats", "mongo"]<br/>        probe: "http://localhost:3000"<br/>        ports: "3000/http"<br/>    }<br/>}<br/><br/>routers: {<br/>    default: {<br/>        routes: {<br/>            "/": "www:3000"<br/>            "/ws": "ws:8080"<br/>            "/wh": "api:5000"<br/>            "/data": "api:5000"<br/>            "/stats": "api:5000"<br/>        }<br/>    }<br/>}<br/><br/>if args.tests {<br/>    jobs: test: {<br/>        build: {<br/>            context: "../api"<br/>            dockerfile: "../api/Dockerfile.test"<br/>        }<br/>        dependsOn: ["www", "api", "ws"]<br/>    }<br/>}</span></pre><p id="0eae" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">在<em class="nu">容器</em>顶层键下，它定义了组成应用程序的容器。每个容器可以定义:</p><ul class=""><li id="7bec" class="mv mw it lx b ly nl mb nm li nr lm ns lq nt mn na nb nc nd bi translated">要使用的图像或构建图像的docker文件的路径</li><li id="46f2" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated">它所依赖的其他容器</li><li id="bdc0" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated">检查其状态的探测器</li><li id="6d20" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated">暴露集群内部容器的端口</li><li id="485e" class="mv mw it lx b ly ne mb nf li ng lm nh lq ni mn na nb nc nd bi translated">必须持久化的文件夹列表(例如:mongo容器的<em class="nu"> /data/db </em>)</li></ul><p id="70df" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">在<em class="nu"> routers </em>键下定义了用于将传入请求路由到正确容器的条目。这将用于通过入口资源配置入口控制器(稍后将详细介绍)。</p><p id="988a" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">在运行应用程序时，也有可以传递给acorn的参数的引用。</p><p id="41b9" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">注意:我已经将这个文件添加到了webhooks库的根目录下(在<em class="nu"> docker-compose.yaml </em>旁边)，并将确保它能够跟上webhooks应用程序的未来发展。</p><p id="a6af" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">从这个acorn文件中，我们可以运行应用程序:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="d3a8" class="kz la it nx b gy ob oc l od oe">acorn run -n webhooks .</span></pre><p id="a7f2" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">几秒钟后，我们返回访问应用程序的URL。这是一个自动生成的域，可解析为集群入口控制器正在侦听的IP地址。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/9f12f4de106d1039e1abeba20735bd32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SciHq3sxcwr-yQvXfPvhAA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">应用程序的URL</figcaption></figure><p id="4cf2" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">使用<em class="nu"> acorn all </em>命令，我们可以看到流程中创建的组件:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/fc87c3331f7c1f3cfa4e922ccb56f5f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r9ONYxUY2rz-fyAfZHhP7g.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">列出应用程序的组件</figcaption></figure><p id="f083" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">检查在幕后创建的Kubernetes资源，我们可以看到一个根据应用程序名称命名的新名称空间:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/a8843bcdc6dbd64943c9959bdb48b207.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cw32rTOIfUKWj_i0ExBC_A.png"/></div></div></figure><p id="a76e" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">查看该命名空间，我们可以看到应用程序的每个微服务的部署和服务。此外，还创建了一个额外的PVC来存储Mongo数据库的数据:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/6a44000986ac6f28a091c903d58699c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IV74x7WJmZ6oCtdX2naB7g.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">由Acorn的控制器在幕后创建的Kubernetes资源</figcaption></figure><p id="f94d" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">为了公开应用程序，Acorn创建了一个入口资源用于配置集群的入口控制器(在我们的示例中为Traefik):</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/2aac7b53a36e333567807bc3a5d551ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-MnD-HNXfM3CtbXKJOsw4A.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">创建了一个入口资源来公开应用程序</figcaption></figure><p id="5749" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">这个入口资源是从<em class="nu"> Acornfile </em>的<em class="nu">路由器</em>部分中定义的条目配置的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ol"><img src="../Images/fafe286ad9430fc86612eb28089a4607.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bsyA2NlMBYw74B05MzFw0A.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">入口资源中定义的规则</figcaption></figure><p id="eb83" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">为了访问应用程序，我们首先在<em class="nu"> /etc/hosts </em>中添加以下条目，这样我们的浏览器就可以将域名解析为入口控制器监听的IP地址:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="dae9" class="kz la it nx b gy ob oc l od oe">192.168.205.69 webhooks.61p6qj.alpha.on-acorn.io</span></pre><p id="0865" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">接下来，我们可以使用以下域名访问webhooks应用程序:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/2f2cd7735d309c023b5c65889912a619.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XHs7uNveKkHd3KnYoG0uYQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">该应用程序可通过专用域名访问</figcaption></figure><p id="eb64" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">然后，我们确保应用程序运行良好:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/21af81d0b8291730936ad2d9a52bbe48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PEPSFN59bHkas-VDLPVCNw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">作为Acorn应用程序创建的webhooks应用程序运行良好</figcaption></figure><p id="ab66" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">从acorn cli中，我们可以使用几个命令来管理应用程序，仅举几个例子:</p><ul class=""><li id="96b5" class="mv mw it lx b ly nl mb nm li nr lm ns lq nt mn na nb nc nd bi translated">列出正在运行的应用程序</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/e2432f88ecb5c2fd56c1e74d33a37c9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qd1c1Mt-ElY2wqSTZR3CLQ.png"/></div></div></figure><ul class=""><li id="66fc" class="mv mw it lx b ly nl mb nm li nr lm ns lq nt mn na nb nc nd bi translated">列出正在运行的容器</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/516b8d941f58cd76574047a82367d71f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6JdxWwx0O8yXOYul17Yfng.png"/></div></div></figure><ul class=""><li id="a76f" class="mv mw it lx b ly nl mb nm li nr lm ns lq nt mn na nb nc nd bi translated">在容器中运行外壳(如用于调试目的)</li></ul><div class="kj kk kl km gt ab cb"><figure class="op kn oq or os ot ou paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/21d625311d90d2d693f26b38e62bc58a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*pSkC4srq4od0WincjYXvCQ.png"/></div></figure><figure class="op kn oq or os ot ou paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/212602c8d20a27952d72c25da229387d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*pF8jZWW1AFMsqd_yB76z_g.png"/></div></figure></div><ul class=""><li id="dd6c" class="mv mw it lx b ly nl mb nm li nr lm ns lq nt mn na nb nc nd bi translated">获取应用程序容器的日志</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ov"><img src="../Images/1e5ce0d758c78d67db820390c2f9c0d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-GAqW8doe6En0H5gmSP8AA.png"/></div></div></figure><p id="fd0d" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">一旦我们使用完应用程序，我们就可以停止它:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="686e" class="kz la it nx b gy ob oc l od oe">$ acorn stop webhooks</span></pre><p id="6cfa" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">并完全移除了它:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="f266" class="kz la it nx b gy ob oc l od oe">$ acorn rm webhooks</span></pre><p id="ede7" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">我们还需要确保删除在此过程中创建的关联卷:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ow"><img src="../Images/77fa7a13a1449acbc4eba781f4f24999.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iG93anFzpUQNDyTnouOPXA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">删除为保存mongo容器的数据而创建的卷Acorn</figcaption></figure><p id="9fd5" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">既然我们已经看到该应用程序与Acorn配合得很好，我们将使用Acorn的另一个特性，它允许我们将应用程序打包成一个单独的工件，并将其推送到Docker Hub。</p><p id="afe2" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">首先，我们登录Docker Hub:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="8fd4" class="kz la it nx b gy ob oc l od oe">$ <strong class="nx iu">acorn login docker.io</strong><br/>? Username lucj<br/>? Password **************<br/>index.docker.io</span></pre><p id="1b48" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">接下来，我们构建应用程序，这将导致创建单个OCI图像:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="7eaf" class="kz la it nx b gy ob oc l od oe">$ acorn build -t docker.io/lucj/webhooks:v1.0.0 .</span></pre><p id="d639" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">然后我们将它推送到注册中心(docker.io与Docker Hub相关)</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="20ff" class="kz la it nx b gy ob oc l od oe">$ acorn push docker.io/lucj/webhooks:v1.0.0</span></pre><p id="6552" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">从Docker Hub，我们验证新映像是否存在:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ox"><img src="../Images/38fc854233fd53ec644c0825d7980ec4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YT7537XJ0y2BqixAcNt9lg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">webhooks应用程序打包成Docker Hub中的单个映像</figcaption></figure><p id="8509" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">现在，任何人都可以使用以下命令运行webhooks应用程序:</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="d40d" class="kz la it nx b gy ob oc l od oe">acorn run --name webhooks <!-- -->docker.io/lucj/webhooks:v1.0.0</span></pre></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><p id="32db" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">当我开始这一系列与webhooks应用程序相关的文章时，我并不知道Acorn。我现在真的很高兴认识了Acorn，因为它真的是一个伟大的项目。从现在起，我将密切关注Acorn，并在未来的文章中分享我的想法。使用webhooks应用程序测试它真的很有趣，对于更好地理解它在Kubernetes生态系统中的作用非常有用。</p><p id="5e59" class="pw-post-body-paragraph lv lw it lx b ly nl ju ma mb nm jx md li nn mf mg lm no mi mj lq np ml mm mn im bi translated">在本系列的下一篇文章中，我们将看看如何改进webhooks应用程序，确保安全最佳实践到位。</p></div></div>    
</body>
</html>