<html>
<head>
<title>Serverless webhook transformation (DockerHub to Slack)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无服务器webhook转换(DockerHub到Slack)</h1>
<blockquote>原文：<a href="https://itnext.io/serverless-webhook-transformation-dockerhub-to-slack-a2fc40a4cfff?source=collection_archive---------3-----------------------#2020-02-28">https://itnext.io/serverless-webhook-transformation-dockerhub-to-slack-a2fc40a4cfff?source=collection_archive---------3-----------------------#2020-02-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/373b9ae89fc112af8050ba6bc80c0a38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BorG6fXRcF0QtZuGLWcROw.png"/></div></div></figure><p id="560b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">许多Docker注册表提供了一种方式，当新的图像被推送时(如果你正在等待构建完成)，可以在聊天频道中通知团队。让我们将这一功能添加到官方DockerHub注册表中！:)</p><p id="1b91" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将使用新发布的<a class="ae kw" href="https://webhookrelay.com/v1/guide/functions.html" rel="noopener ugc nofollow" target="_blank"> Webhook中继函数</a>来转换正在通过服务的Webhook。</p><p id="1c14" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">先决条件:</p><ul class=""><li id="1a4d" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated"><a class="ae kw" href="https://my.webhookrelay.com/" rel="noopener ugc nofollow" target="_blank"> Webhook中继账户</a></li><li id="1c73" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://hub.docker.com/" rel="noopener ugc nofollow" target="_blank"> DockerHub账户</a></li><li id="e0fc" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">码头工人</li></ul><h1 id="0a3c" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">创建存储桶并配置DockerHub通知</h1><ol class=""><li id="36bd" class="kx ky iq ka b kb mj kf mk kj ml kn mm kr mn kv mo ld le lf bi translated">在这里创建一个桶<a class="ae kw" href="https://my.webhookrelay.com/buckets" rel="noopener ugc nofollow" target="_blank">https://my.webhookrelay.com/buckets</a></li><li id="1366" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv mo ld le lf bi translated">一旦你有了它，在输入部分你会找到你的公共输入端点，复制它:</li></ol><figure class="mq mr ms mt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mp"><img src="../Images/ebb56e3dc7ee751baa1c9970270f8c21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ifLL4HXyc97R9bn2.png"/></div></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk translated">输入端点</figcaption></figure><p id="0e0b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.添加一个指向公共输入端点(<a class="ae kw" href="https://docs.docker.com/docker-hub/webhooks/" rel="noopener ugc nofollow" target="_blank"> DockerHub docs </a>)的新DockerHub webhook设置:</p><figure class="mq mr ms mt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mp"><img src="../Images/dbe9fae2c0f864df40016eb222c071cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ej2_FCOkZnLIj2Vv.png"/></div></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk translated">dockerhub webhook配置</figcaption></figure><h1 id="7c09" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">获取DockerHub webhook的示例</h1><p id="fce0" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj my kl km kn mz kp kq kr na kt ku kv ij bi translated">推送新的Docker图像:</p><pre class="mq mr ms mt gt nb nc nd ne aw nf bi"><span id="fc06" class="ng lm iq nc b gy nh ni l nj nk">$ docker push karolisr/demo-webhook:latest The push refers to repository [docker.io/karolisr/demo-webhook] 48bd38e03c42: Mounted from karolisr/webhook-demo fd9f9fbd5947: Mounted from karolisr/webhook-demo 5216338b40a7: Mounted from karolisr/webhook-demo latest: digest: sha256:703f2bab2ce8df0c5ec4e45e26718954b09bf4a625ab831c6556fd27d60f1325 size: 949</span></pre><p id="4a16" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们应该可以看到一个新的webhook。看起来是这样的:</p><pre class="mq mr ms mt gt nb nc nd ne aw nf bi"><span id="15f4" class="ng lm iq nc b gy nh ni l nj nk">{<br/>    "push_data": {<br/>        "pushed_at": 1582839308,<br/>        "images": [],<br/>        "tag": "latest",<br/>        "pusher": "karolisr"<br/>    },<br/>    "callback_url": "https://registry.hub.docker.com/u/karolisr/demo-webhook/hook/242ii4ddc2jji4a0cc44fbcdbcdecj1ab/",<br/>    "repository": {<br/>        "status": "Active",<br/>        "description": "",<br/>        "is_trusted": false,<br/>        "full_description": "",<br/>        "repo_url": "https://hub.docker.com/r/karolisr/demo-webhook",<br/>        "owner": "karolisr",<br/>        "is_official": false,<br/>        "is_private": true,<br/>        "name": "demo-webhook",<br/>        "namespace": "karolisr",<br/>        "star_count": 0,<br/>        "comment_count": 0,<br/>        "date_created": 1524557040,<br/>        "repo_name": "karolisr/demo-webhook"<br/>    }<br/>}</span></pre><h1 id="3ee6" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">创建一个函数来转换webhook</h1><p id="0e95" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj my kl km kn mz kp kq kr na kt ku kv ij bi translated">转到<a class="ae kw" href="https://my.webhookrelay.com/functions" rel="noopener ugc nofollow" target="_blank">功能页面</a>并点击“创建功能”按钮。输入名称，例如“dockerhub-to-slack ”,然后单击“提交”。</p><blockquote class="nl nm nn"><p id="bd67" class="jy jz no ka b kb kc kd ke kf kg kh ki np kk kl km nq ko kp kq nr ks kt ku kv ij bi translated"><em class="iq">对于这个例子，我们使用的是</em> <a class="ae kw" href="https://www.lua.org/start.html" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> Lua语言</em> </a> <em class="iq">，它提供了一种解析、转换有效载荷的简单方法。Webhook中继函数也支持WebAssembly模块，但是它们目前正在开发中，只能使用中继CLI添加/更新。</em></p></blockquote><p id="b7bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，您可以将webhook有效负载复制/粘贴到“请求正文”区域，以供以后测试使用。在代码编辑器中，让我们添加一个函数来获取存储库名称并准备一个Slack webhook有效负载:</p><pre class="mq mr ms mt gt nb nc nd ne aw nf bi"><span id="ebfc" class="ng lm iq nc b gy nh ni l nj nk">local json = require("json")<br/><br/>local body, err = json.decode(r.RequestBody)<br/>if err then error(err) end<br/><br/>local message = "New image pushed at: " .. body["repository"]["repo_name"] .. ":" .. body["push_data"]["tag"]<br/><br/>-- Preparing Slack payload<br/>local slack = {<br/>    response_type= "in_channel", <br/>    text= message}<br/><br/>local result, err = json.encode(slack)<br/><br/>-- Set request header to application/json<br/>r:SetRequestHeader("Content-Type", "application/json")<br/>-- Set request method to PUT<br/>r:SetRequestMethod("POST")<br/>-- Set modified request body<br/>r:SetRequestBody(result)</span></pre><p id="af4f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">点击“保存”,然后尝试用“发送”按钮进行测试:</p><figure class="mq mr ms mt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mp"><img src="../Images/f6f33c0f8fae3c9ad09ff20aacdc43a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ff3sJ4qRmpwAW87a.png"/></div></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk translated">函数执行响应</figcaption></figure><h1 id="a5ab" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">将一切联系在一起</h1><ol class=""><li id="93d8" class="kx ky iq ka b kb mj kf mk kj ml kn mm kr mn kv mo ld le lf bi translated">导航到https://api.slack.com/messaging/webhooks的<a class="ae kw" href="https://api.slack.com/messaging/webhooks" rel="noopener ugc nofollow" target="_blank">并点击“创建你的Slack应用程序”。选择您的工作区，输入一个您会记住的名称。</a></li><li id="f2a6" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv mo ld le lf bi translated">创建一个新的传入webhook配置，复制“Webhook URL”(它以<code class="fe ns nt nu nc b">https://hooks.slack.com/services/T3...</code>开头)，我们需要将它提供给Webhook中继。</li><li id="bd57" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv mo ld le lf bi translated">打开您的存储桶详情(通过<a class="ae kw" href="https://my.webhookrelay.com/buckets" rel="noopener ugc nofollow" target="_blank">https://my.webhookrelay.com/buckets</a></li><li id="280e" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv mo ld le lf bi translated">打开“OUTPUT DESTINATIONS”选项卡，使用步骤2中的Slack URL创建一个名为“Slack”的新输出:</li></ol><figure class="mq mr ms mt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mp"><img src="../Images/fc05cfcbe65003091352fd466725346f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XGdZIZgX8gcyFa56.png"/></div></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk translated">webhook目的地为Slack</figcaption></figure><p id="a58a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">5.创建完成后，点击“代码”符号，并从下拉菜单中选择<code class="fe ns nt nu nc b">dockerhub_to_slack</code>功能:</p><figure class="mq mr ms mt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mp"><img src="../Images/d8d45654569279674415bdf2df4c3a40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ath0BLt0YrzWA-7n.png"/></div></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk translated">选择我们新创建的函数</figcaption></figure><p id="f2de" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将新图像推送到DockerHub，您应该会在Slack频道中看到新的通知:</p><figure class="mq mr ms mt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mp"><img src="../Images/7b7db4cb3119c79cda8b974438252faf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*b6ouNv1c0PWxOfRY.png"/></div></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk translated">收到你的信息</figcaption></figure><p id="bc53" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就是这样，可以随意继续修改Lua函数，加入pusher的名字和消息格式。按照这个过程，你可以将任何一个webhook转换成任何其他的webhook。</p><p id="295e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">玩得开心！</p><p id="f232" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="no">原发布于</em><a class="ae kw" href="https://webhookrelay.com/v1/examples/convert-dockerhub-webhook-to-slack.html" rel="noopener ugc nofollow" target="_blank"><em class="no">https://webhook relay . com/v1/examples/convert-docker hub-web hook-to-slack . html</em></a></p></div></div>    
</body>
</html>