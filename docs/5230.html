<html>
<head>
<title>Azure Resource Manager template specs. Proactive application monitoring using Azure alerts.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure资源管理器模板规范。使用Azure alerts进行主动应用程序监控。</h1>
<blockquote>原文：<a href="https://itnext.io/azure-resource-manager-template-specs-proactive-application-monitoring-using-azure-alerts-bc09099c5e81?source=collection_archive---------3-----------------------#2021-01-17">https://itnext.io/azure-resource-manager-template-specs-proactive-application-monitoring-using-azure-alerts-bc09099c5e81?source=collection_archive---------3-----------------------#2021-01-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/a1d66cd3de777e1188cf3c6fab151be0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1136/format:webp/1*A8XShrI8G0xpjv7UpU9jsQ.png"/></div></figure><p id="7ec8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这篇文章中，我想告诉你关于<strong class="jw ir"> Azure资源管理器模板规格</strong>——Azure中的一个新功能，它允许你存储ARM模板供以后部署，轻松修改它们，并使用Azure RBAC在你的团队/组织内共享。我们还假设你熟悉Azure资源管理器模板。为了让这篇文章更实际一点，我还将分享一个工作Arm模板，它允许将主动应用程序监控与通知消息一起部署到MS团队或您可能选择的任何其他渠道，作为Azure Resource Manager模板规范的工作演示。</p><p id="a7ab" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">那么，Azure资源管理器模板规范，我们为什么要关心呢？我很确定，每个使用ARM模板的DevOps工程师迟早都会遇到这样的问题，当有一个巨大的ARM模板时，它很难维护，因为它有很多参数、变量和依赖项。这个问题的显而易见的答案是模块化，将一个巨大的模板分割成多个较小的模板，这里微软友好地为我们提供链接和嵌套的模板，将我们的ARM模板分割成许多相关的模板，然后通过一个主模板将它们部署在一起。这是一个非常强大的工具，它很有效，很多人都在使用它。然而，我自己和我的同事们经历过的一个缺点是，链接模板必须总是在外部可用。这时，共享访问签名(SAS)令牌的所有麻烦就开始了，因为您希望模板是安全的，而且对于团队或您的组织也是可访问的。</p><p id="e21f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是我们谈论Azure <a class="ae ks" href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/template-specs" rel="noopener ugc nofollow" target="_blank">模板规范</a>是有原因的，对吗？在上述情况下，我们可以做的是创建一个模板规范，而不是搞乱SAS令牌。template-spec真正酷的地方在于它允许使用相对路径将子模板链接到主模板。在我看来，这将模板管理带到了不同的层次。我们可以在一个repo中使用模板，而不必担心本地或远程存储副本最终会偏离原始模板。</p><blockquote class="kt ku kv"><p id="6449" class="ju jv kw jw b jx jy jz ka kb kc kd ke kx kg kh ki ky kk kl km kz ko kp kq kr ij bi translated">记住:<code class="fe la lb lc ld b"><em class="iq">Microsoft.Resources/deployments</em></code>资源的apiVersion必须是2020-06-01或更高版本，才能使用相对路径选项</p></blockquote><p id="be5f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">查看下面的JSON，在<code class="fe la lb lc ld b">templateLink</code>属性中，我们只指定了我们驱动器上本地文件夹中文件的<code class="fe la lb lc ld b">relativePath</code>:</p><figure class="le lf lg lh gt jr"><div class="bz fp l di"><div class="li lj l"/></div></figure><p id="c3e2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们的整个监控和警报解决方案由几个组件组成，例如:<code class="fe la lb lc ld b">Logic app</code>解析来自动作的数据，并调用具有必要负载的webhook端点，<code class="fe la lb lc ld b">Action group</code>负责在警报规则触发时通知或动作，<code class="fe la lb lc ld b">Alert rules</code>本身，以及<code class="fe la lb lc ld b">Application Insights</code>实例，在该实例中，我们从应用程序和服务收集日志&amp;跟踪信息。仅部署这4种资源的monolith模板占用了497行，当我们将logic app和操作组拆分为子模板时，主模板就变成了148行，非常小，对吗？另一个优点是，你仍然可以在本地看到所有的子模板，并用<a class="ae ks" href="https://marketplace.visualstudio.com/items?itemName=bencoleman.armview" rel="noopener ugc nofollow" target="_blank"> Azure template viewer </a>构建可视化效果。</p><figure class="le lf lg lh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lk"><img src="../Images/1358c3f05b79a3c3404c66c5b07ba7af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cFe93kfFSXKzFydkcA1LoQ.png"/></div></div></figure><p id="6f17" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">当我们的主模板和子模板被细化并准备好时，我们可以用azure cli或powershel命令创建我们的模板规范。</p><pre class="le lf lg lh gt lp ld lq lr aw ls bi"><span id="7c20" class="lt lu iq ld b gy lv lw l lx ly"><strong class="ld ir">az ts create</strong> --name monitorSpec --version "1.0.0.0" --resource-group templateSpec --location "westeurope" --template-file .\deploy.json</span></pre><blockquote class="kt ku kv"><p id="3fc8" class="ju jv kw jw b jx jy jz ka kb kc kd ke kx kg kh ki ky kk kl km kz ko kp kq kr ij bi translated">模板规格目前正在预览中。要配合Azure PowerShell使用，必须安装<a class="ae ks" href="https://docs.microsoft.com/en-us/powershell/azure/install-az-ps" rel="noopener ugc nofollow" target="_blank">5 . 0 . 0版或更高版本</a>。要在Azure CLI中使用它，请使用<a class="ae ks" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" rel="noopener ugc nofollow" target="_blank">2 . 14 . 2版或更高版本</a>。</p></blockquote><p id="3579" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建模板规范后，您可以在Azure门户中查看<em class="kw">(需要在预览功能中启用)</em>并从访问控制选项卡管理对模板规范的访问。</p><figure class="le lf lg lh gt jr gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/d24a70ec693055987442289f813036fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1268/format:webp/1*Ak0r_Fdrfv7cIT0weX2NyQ.png"/></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">门户中的模板规范示例</figcaption></figure><p id="c63a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们可以看到，我们已经创建了一个名为<code class="fe la lb lc ld b">monitorSpec</code>的模板规范，它保存了我们的主模板和两个子模板— <code class="fe la lb lc ld b">logicapp.json</code>和<code class="fe la lb lc ld b">actiongroup.json</code>。</p><p id="d0b6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在您可以部署模板规范了。部署模板规范就像部署它所包含的模板一样，只是您要传入模板规范的资源ID。您使用相同的部署命令，如果需要，为模板规范传入参数值。例如:</p><pre class="le lf lg lh gt lp ld lq lr aw ls bi"><span id="b4fd" class="lt lu iq ld b gy lv lw l lx ly"><strong class="ld ir">$id</strong> = $(az ts show --name monitorSpec --resource-group templateSpec --query "id" --version '1.0.0.0')</span><span id="5404" class="lt lu iq ld b gy me lw l lx ly">az deployment group create --resource-group monitorRG --template-spec <strong class="ld ir">$id</strong> --parameters .\parameters.json</span></pre><p id="1d41" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">就是这样—非常类似于使用标准的链接模板，对吗？。</p><h1 id="a2c9" class="mf lu iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">监控和警报设置是如何工作的？</h1><p id="159b" class="pw-post-body-paragraph ju jv iq jw b jx nc jz ka kb nd kd ke kf ne kh ki kj nf kl km kn ng kp kq kr ij bi translated">监控算法本身相当简单:我们创建一个Azure alert，它每5分钟在Application insights实例上执行一次特定的日志查询，如果满足警报条件，那么我们调用一个动作，将查询结果发送到逻辑应用程序。逻辑应用程序根据传入的数据<em class="kw">(在本例中，我们有两种类型的查询:超出异常计数和检测到慢速请求)</em>决定将什么类型的有效负载发送给MS Teams，并使用必要的有效负载调用MS Teams webhook。下面您可以看到一个在微软团队中收到的警报示例。</p><figure class="le lf lg lh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nh"><img src="../Images/85a4f6ddedd2c74148d4789f51e8770d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xpBHVic4qDLKBBnUd7P2jA.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">监控MS团队中的警报</figcaption></figure><p id="9be8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一如既往，你可以在<a class="ae ks" href="https://github.com/f1xxxer/infra_azure_specs_demo" rel="noopener ugc nofollow" target="_blank">我的Github库</a>找到ARM模板的完整版本。在部署了来自存储库的ARM模板之后，您的订阅中应该有功能齐全的监控和警报基础设施，只是不要忘记用正确的值替换parameters.json文件中的<code class="fe la lb lc ld b">WebHookUrl</code>。</p><p id="b01a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在下一篇文章中，我们将把整个模板规范管理与Azure管道集成在一起。</p><p id="bf84" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> GL &amp; HF！</strong></p></div></div>    
</body>
</html>