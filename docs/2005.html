<html>
<head>
<title>Continuous Spring Boot deployment in Kubernetes using Jib and Skaffold</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Jib和Skaffold在Kubernetes持续部署Spring Boot</h1>
<blockquote>原文：<a href="https://itnext.io/continuous-spring-boot-deployment-in-kubernetes-using-jib-and-skaffold-11fd3c71d941?source=collection_archive---------1-----------------------#2019-03-14">https://itnext.io/continuous-spring-boot-deployment-in-kubernetes-using-jib-and-skaffold-11fd3c71d941?source=collection_archive---------1-----------------------#2019-03-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><blockquote class="jq jr js"><p id="8b8e" class="jt ju jv jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr im bi translated">在本教程中，我将解释如何在Kubernetes中实现连续的Spring Boot部署。一个小的代码更改将触发一个新的Docker映像构建，并在您的集群中即时部署一个新的pod。本教程在macOs上执行。</p></blockquote><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ks"><img src="../Images/5a6d7e62edb00d81ad3c9c0f266ac737.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qtmqzzXuPLz3hfqY6O527w.png"/></div></div></figure><p id="2111" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke le kg kh ki lf kk kl km lg ko kp kq kr im bi translated">Jib是一个来自Google的开源、快速、简单的Java容器映像构建器，它处理将应用程序打包成容器映像的所有步骤。它不需要您编写does文件。</p><p id="2f50" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke le kg kh ki lf kk kl km lg ko kp kq kr im bi translated">我们将使用<a class="ae lh" href="https://github.com/GoogleContainerTools/jib/tree/master/jib-maven-plugin" rel="noopener ugc nofollow" target="_blank"> jib-maven-plugin </a>为我们的应用程序创建一个Docker映像。<br/>接下来，我们将设置一个本地<a class="ae lh" href="https://kubernetes.io/docs/setup/minikube/" rel="noopener ugc nofollow" target="_blank"> minikube </a>集群，并创建一个Kubernetes部署。斯卡福德将帮助使这一部署持续进行。</p><p id="44eb" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke le kg kh ki lf kk kl km lg ko kp kq kr im bi translated">首先安装minikube、kubectl和Skaffold并启动您的minikube集群:</p><pre class="kt ku kv kw gt li lj lk ll aw lm bi"><span id="5266" class="ln lo it lj b gy lp lq l lr ls">$ brew cask install minikube<br/>$ minikube start<br/>$ brew install skaffold<br/>$ brew install kubernetes-cli</span></pre><p id="e14d" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke le kg kh ki lf kk kl km lg ko kp kq kr im bi translated">检查您的minikube实例的IP，并验证您是否可以访问minikube仪表板:</p><pre class="kt ku kv kw gt li lj lk ll aw lm bi"><span id="5f36" class="ln lo it lj b gy lp lq l lr ls">$ minikube ip<br/>192.168.99.101 # most of the time it's 192.168.99.100<br/>$ minikube dashboard</span></pre><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi lt"><img src="../Images/2322a984c3b161b5f5df3cb1884a15bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZjexE2B612BAvnHA43BK9g.png"/></div></div></figure><p id="c2ee" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke le kg kh ki lf kk kl km lg ko kp kq kr im bi translated">现在创建您的Spring Boot项目。你可以使用<a class="ae lh" href="https://github.com/lvthillo/spring-boot-hello-world-jib" rel="noopener ugc nofollow" target="_blank">这个示例项目</a>来开始。在您最喜欢的IDE中打开项目，并尝试构建它:</p><pre class="kt ku kv kw gt li lj lk ll aw lm bi"><span id="5264" class="ln lo it lj b gy lp lq l lr ls">$ mvn clean install</span></pre><p id="ea42" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke le kg kh ki lf kk kl km lg ko kp kq kr im bi translated">转到<code class="fe lu lv lw lj b">pom.xml</code>并验证<code class="fe lu lv lw lj b">jib-maven-plugin</code>的配置。我们将使用<code class="fe lu lv lw lj b">registry.hub.docker.com/openjdk:8-jdk-alpine</code>作为基础图像。</p><p id="88c5" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke le kg kh ki lf kk kl km lg ko kp kq kr im bi translated">访问IDE的终端并执行以下命令来指向minikube的远程Docker守护进程:</p><pre class="kt ku kv kw gt li lj lk ll aw lm bi"><span id="a6be" class="ln lo it lj b gy lp lq l lr ls">$ eval $(minikube docker-env)</span></pre><p id="7cef" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke le kg kh ki lf kk kl km lg ko kp kq kr im bi translated">我们将使用minikube守护进程，这样我们就可以构建我们的Docker映像，minikube可以访问它，而不需要推送映像，或者从Docker注册表中提取映像。</p><p id="68ab" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke le kg kh ki lf kk kl km lg ko kp kq kr im bi translated">使用jib插件构建Docker映像:</p><pre class="kt ku kv kw gt li lj lk ll aw lm bi"><span id="5866" class="ln lo it lj b gy lp lq l lr ls">$ mvn compile jib:dockerBuild</span></pre><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi lx"><img src="../Images/2c480f87cc3f1d5fe02d64f4176fcb71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AHdpxPv3zw5ktKelhDyO6Q.png"/></div></div></figure><p id="fb7b" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke le kg kh ki lf kk kl km lg ko kp kq kr im bi translated">这个Docker映像可以在我们的minikube节点上访问，因为我们使用了远程守护进程。我们将使用<code class="fe lu lv lw lj b">kubernetes/deployment.yml</code>在minikube上创建一个部署</p><pre class="kt ku kv kw gt li lj lk ll aw lm bi"><span id="49da" class="ln lo it lj b gy lp lq l lr ls"><strong class="lj iu">apiVersion</strong>: apps/v1<br/><strong class="lj iu">kind</strong>: Deployment<br/><strong class="lj iu">metadata</strong>:<br/>  <strong class="lj iu">name</strong>: spring-deployment<br/><strong class="lj iu">spec</strong>:<br/>  <strong class="lj iu">replicas</strong>: 1<br/>  <strong class="lj iu">selector</strong>:<br/>    <strong class="lj iu">matchLabels</strong>:<br/>      <strong class="lj iu">app</strong>: spring-boot-jib<br/>  <strong class="lj iu">template</strong>:<br/>    <strong class="lj iu">metadata</strong>:<br/>      <strong class="lj iu">labels</strong>:<br/>        <strong class="lj iu">app</strong>: spring-boot-jib<br/>    <strong class="lj iu">spec</strong>:<br/>      <strong class="lj iu">containers</strong>:<br/>        - <strong class="lj iu">name</strong>: spring-boot-jib-pod<br/>          <strong class="lj iu">image</strong>: lvthillo/my-app<br/>          <strong class="lj iu">imagePullPolicy</strong>: IfNotPresent<br/>          <strong class="lj iu">ports</strong>:<br/>            - <strong class="lj iu">name</strong>: http<br/>              <strong class="lj iu">containerPort</strong>: 8080<br/>---<br/><strong class="lj iu">apiVersion</strong>: v1<br/><strong class="lj iu">kind</strong>: Service<br/><strong class="lj iu">metadata</strong>:<br/>  <strong class="lj iu">name</strong>: spring-boot-jib-service<br/><strong class="lj iu">spec</strong>:<br/>  <strong class="lj iu">type</strong>: NodePort<br/>  <strong class="lj iu">ports</strong>:<br/>    - <strong class="lj iu">protocol</strong>: TCP<br/>      <strong class="lj iu">port</strong>: 8080<br/>      <strong class="lj iu">nodePort</strong>: 32321<br/>  <strong class="lj iu">selector</strong>:<br/>    <strong class="lj iu">app</strong>: spring-boot-jib</span></pre><p id="8c05" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke le kg kh ki lf kk kl km lg ko kp kq kr im bi translated">该模板将从我们的<code class="fe lu lv lw lj b">lvthillo/my-app</code>映像部署一个pod，pod的端口8080将被暴露。该模板还将创建一个NodePort类型的服务，该服务将端口8080映射到NodePort 32321。</p><pre class="kt ku kv kw gt li lj lk ll aw lm bi"><span id="ce57" class="ln lo it lj b gy lp lq l lr ls">$ kubectl create -f kubernetes/deployment.yml <br/>deployment.apps/spring-deployment created<br/>service/spring-boot-jib-service created</span><span id="09a0" class="ln lo it lj b gy ly lq l lr ls">$ kubectl get pods<br/>NAME                                 READY   STATUS    RESTARTS   AGE<br/>spring-deployment679-rhmzn   1/1     Running   0          18s</span></pre><p id="7ccf" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke le kg kh ki lf kk kl km lg ko kp kq kr im bi translated">访问minikube ip上的应用程序和我们定义为节点端口的端口:<code class="fe lu lv lw lj b">192.168.99.101:32321</code></p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi lz"><img src="../Images/ed6ba8cb876fe3a4c27491f6cc8ed41b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-swDFrUattLJWtnrjyII4g.png"/></div></div></figure><p id="584d" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke le kg kh ki lf kk kl km lg ko kp kq kr im bi translated">我们已经在minikube中部署了我们的Spring Boot应用程序！我们将使用Google开发的另一个很棒的工具来自动化minikube的部署。这个工具叫做<a class="ae lh" href="https://github.com/GoogleContainerTools/skaffold" rel="noopener ugc nofollow" target="_blank">斯卡福德</a>。</p><p id="3726" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke le kg kh ki lf kk kl km lg ko kp kq kr im bi translated">在项目的根目录中写一个<code class="fe lu lv lw lj b">skaffold.yml</code>。</p><pre class="kt ku kv kw gt li lj lk ll aw lm bi"><span id="4eec" class="ln lo it lj b gy lp lq l lr ls"><strong class="lj iu">apiVersion</strong>: skaffold/v1beta4<br/><strong class="lj iu">kind</strong>: Config<br/><em class="jv"># Enforce SKaffold to use Jib<br/></em><strong class="lj iu">build</strong>:<br/>  <strong class="lj iu">local</strong>:<br/>    <strong class="lj iu">push</strong>: false<br/><em class="jv"># Generated artifact<br/>  </em><strong class="lj iu">artifacts</strong>:<br/>    - <strong class="lj iu">image</strong>: lvthillo/my-app<br/><em class="jv"># Use jibMaven<br/>      </em><strong class="lj iu">jibMaven</strong>: {}<br/><em class="jv"># Execute deployment.yml<br/></em><strong class="lj iu">deploy</strong>:<br/>  <strong class="lj iu">kubectl</strong>:<br/>    <strong class="lj iu">manifests</strong>:<br/>      - kubernetes/deployment.yml</span></pre><p id="770f" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke le kg kh ki lf kk kl km lg ko kp kq kr im bi translated">在开发模式下运行Skaffold。这将建立我们的形象，并部署到minikube的每一个变化，我们在我们的项目。</p><pre class="kt ku kv kw gt li lj lk ll aw lm bi"><span id="2fdc" class="ln lo it lj b gy lp lq l lr ls">$ skaffold dev --trigger notify</span></pre><p id="6c38" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke le kg kh ki lf kk kl km lg ko kp kq kr im bi translated">一个小的变化将被选中，Skaffold将自动触发Docker映像的新构建:</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ma"><img src="../Images/183262bdfab2623e9d5dde8c2d29efa5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*unr1bICCDTppbuF0ZRWl6A.png"/></div></div></figure><p id="5497" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke le kg kh ki lf kk kl km lg ko kp kq kr im bi translated">创建了一个新的pod:</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi lz"><img src="../Images/1adecd89bb382c515069c394977e8036.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Csj5ol_EO78jC3sFCfzc2w.png"/></div></div></figure><p id="2dac" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke le kg kh ki lf kk kl km lg ko kp kq kr im bi translated">并且部署了更改:</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi mb"><img src="../Images/30518a876f01ef24b9073e1aab8205ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4WZhtTssdaHe6gp2YhC35Q.png"/></div></div></figure><h1 id="1759" class="mc lo it bd md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my bi translated">结论</h1><p id="4aa1" class="pw-post-body-paragraph jt ju it jw b jx mz jz ka kb na kd ke le nb kh ki lf nc kl km lg nd kp kq kr im bi translated">我们使用了Google开发的两个非常酷的工具，这两个工具使得我们的项目能够持续部署到minikube。您还可以使用jib自动将映像推送到Docker注册中心，甚至可以持续部署到云中托管的Kubernetes集群。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><a href="https://www.buymeacoffee.com/dZb8fLN"><div class="gh gi ne"><img src="../Images/83dc7212ef8502659c81086ad58b8d96.png" data-original-src="https://miro.medium.com/v2/resize:fit:340/format:webp/1*bk_C8Um34KavCkO2yzMCZg.png"/></div></a><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">如果真的对你有帮助…:)</figcaption></figure></div></div>    
</body>
</html>