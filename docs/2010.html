<html>
<head>
<title>Update Feature Toggles in a React App without Redeploying</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">更新功能在React应用程序中切换，无需重新部署</h1>
<blockquote>原文：<a href="https://itnext.io/update-feature-toggles-in-a-react-app-without-redeploying-5b95674a5bb1?source=collection_archive---------2-----------------------#2019-03-15">https://itnext.io/update-feature-toggles-in-a-react-app-without-redeploying-5b95674a5bb1?source=collection_archive---------2-----------------------#2019-03-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><h1 id="8251" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">Spring Cloud Config使特性切换变得容易，Node.js端点使重新部署JavaScript应用程序变得不必要</h1><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/959a8d2d6eddf7aee96101b3ba970018.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AagcrfIIloXZgFKWpr6D_g.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">在<a class="ae le" href="https://unsplash.com/search/photos/developer?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae le" href="https://unsplash.com/photos/t1bz9XpJ2-Y?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">米米·蒂安</a>拍摄的照片</figcaption></figure><h1 id="4d0e" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">特性切换:测试新UI特性的首选方式</h1><p id="9082" class="pw-post-body-paragraph lf lg it lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi md translated"><span class="l me mf mg bm mh mi mj mk ml di"> H </span>你有没有对自己说过:“哎呀，我希望我能一次只给我的几个用户部署这个新功能。我想在向整个用户群开放之前，测试一下他们是否喜欢它，它是否运行良好。”？</p><p id="3bb2" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">然后你耸耸肩，部署到产品中，当250个用户发现一个你甚至没有想到的不愉快的路径时，网站崩溃了，这远远超出了如何合理地使用网站的范围(因为这是用户擅长的)。</p><p id="fd04" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">这种情况(以及随之而来的疯狂编码快速修复)可以通过特性切换来避免。</p><h2 id="ace0" class="mr jr it bd js ms mt dn jw mu mv dp ka lq mw mx ke lu my mz ki ly na nb km nc bi translated">什么是特征切换？</h2><p id="ed0f" class="pw-post-body-paragraph lf lg it lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">除了我上面描述的场景，根据维基百科:</p><blockquote class="nd ne nf"><p id="a9ae" class="lf lg ng lh b li mm lk ll lm mn lo lp nh mo ls lt ni mp lw lx nj mq ma mb mc im bi translated"><strong class="lh iu">特性切换</strong>是<a class="ae le" href="https://en.wikipedia.org/wiki/Software_development" rel="noopener ugc nofollow" target="_blank">软件开发</a>中的一项技术，它试图提供一种维护多个<a class="ae le" href="https://en.wikipedia.org/wiki/Source_code" rel="noopener ugc nofollow" target="_blank">源代码</a>分支(称为特性分支)的替代方法，这样一个特性甚至可以在完成并准备发布之前就被测试。功能切换用于在运行时隐藏、启用或禁用功能。例如，在开发过程中，开发人员可以为测试启用该特性，并为其他用户禁用它。</p><p id="6726" class="lf lg ng lh b li mm lk ll lm mn lo lp nh mo ls lt ni mp lw lx nj mq ma mb mc im bi translated">— <a class="ae le" href="https://en.wikipedia.org/wiki/Feature_toggle" rel="noopener ugc nofollow" target="_blank">维基百科，功能切换</a></p></blockquote><p id="f890" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">特性切换允许开发人员向一小组用户(beta测试人员)介绍新的特性，确保所有的问题和缺陷都解决了，并且在让每个人访问之前，特性是可靠的并且受到用户的欢迎。</p><p id="60fc" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">它还允许一个应用程序同时存在多个版本。虽然特性切换通常被认为是暂时的，用于测试特性，然后在通过审查后向公众发布，但是它们也可以用于维护应用程序的多个版本，不同的用户可以使用不同的版本。</p><p id="f93f" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">如果你想了解更多关于如何设置配置服务器的信息，你可以阅读我不久前写的一篇关于借助Spring Boot的云配置包设置配置服务器的文章。</p><p id="6d1c" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">如果你想看看在稍微老一点的JavaScript应用程序中设置特性切换的另一种方式，我也写了一篇关于这个的<a class="ae le" href="https://medium.com/@paigen11/leveraging-a-spring-cloud-config-server-in-a-nodejs-application-for-feature-toggles-pt-2-f331c08dfdb6" rel="noopener">文章</a>。不过，这种实现需要在每次添加新的用户或组时使用特性切换来重新部署整个应用程序，但是有了这种新的解决方案，这就没有必要了。</p><blockquote class="nk"><p id="fc9f" class="nl nm it bd nn no np nq nr ns nt mc dk translated">在这篇博客中，我将向您展示如何在React UI中向现有功能切换添加新信息，而不必重新部署整个应用程序。</p></blockquote><p id="e742" class="pw-post-body-paragraph lf lg it lh b li nu lk ll lm nv lo lp lq nw ls lt lu nx lw lx ly ny ma mb mc im bi translated">最精彩的部分？这并不复杂。</p><p id="bf63" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated"><strong class="lh iu">请注意:</strong></p><h1 id="6702" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">重建和重新部署ui并不总是必须的</h1><p id="9677" class="pw-post-body-paragraph lf lg it lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">回到JavaScript开发的早期，当Grunt和Gulp任务重新构建jQuery驱动的应用程序时，如果您想用新信息修改UI中的特性切换，整个应用程序必须从Node.js服务器重新构建。重新编译、重新缩小、重新美化、重新构建并重新部署到服务器或云。</p><p id="9e64" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">这并没有花费太长的时间，但仍然是一个痛苦。对于我的商业伙伴来说，他们想要相对容易地点击一个按钮来启用或禁用某些用户组的功能切换，这使之成为不可能。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nz oa l"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">这就是我的商业伙伴希望功能切换变得多么简单:只需按下按钮。</figcaption></figure><p id="8ec4" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">现在，有了Webpack这样的新工具和React这样的框架，浏览器中的热重装功能就不再是那样了。</p><p id="6864" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">您可以简单地更新从配置服务器提供给UI的信息，通过Node.js服务器刷新它，瞧——修改在浏览器中获得。</p><h1 id="321c" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">功能切换设置</h1><h2 id="1465" class="mr jr it bd js ms mt dn jw mu mv dp ka lq mw mx ke lu my mz ki ly na nb km nc bi translated">启用功能与云配置客户端NPM包切换</h2><p id="9e29" class="pw-post-body-paragraph lf lg it lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">为了设置我们的JavaScript应用程序连接到Spring Cloud Config服务器，我使用了来自NPM的名为<a class="ae le" href="https://www.npmjs.com/package/cloud-config-client" rel="noopener ugc nofollow" target="_blank"> cloud-config-client </a>的包。</p><p id="af46" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">有十几个这样的包用于将Node.js应用程序连接到Spring Boot云配置服务器，但这个包是NPM上更受欢迎、记录良好的包之一，所以这是我这次选择使用的包。</p><p id="802c" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">我将这些步骤分为服务器端和客户端，这样您就可以看到Node.js文件与React文件的区别。</p><h2 id="d0e4" class="mr jr it bd js ms mt dn jw mu mv dp ka lq mw mx ke lu my mz ki ly na nb km nc bi translated">服务器端:在Server.js中配置</h2><p id="ada6" class="pw-post-body-paragraph lf lg it lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在最初用<code class="fe ob oc od oe b">npm i --save cloud-config-client</code>安装了cloud-config-client包之后，是时候配置节点的<code class="fe ob oc od oe b">server.js</code>文件了。每个优秀的Express powered节点应用的起点。</p><p id="f993" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">我的<code class="fe ob oc od oe b">server.js</code>文件相对较小，因为许多路由、日志程序和其他节点服务器附加程序已经被分离到它们自己的文件夹中，以保持更有组织性。</p><p id="192f" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">对该文件唯一需要的调整是需要文件顶部的配置服务器路径:</p><p id="d12f" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated"><code class="fe ob oc od oe b">const configServerRouter = require('./routes/configServer');</code></p><p id="5937" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">然后确保当React客户端的请求到达节点服务器并在URL路径中包含<code class="fe ob oc od oe b">/configserver/</code>时，它会路由到<code class="fe ob oc od oe b">configServer.js</code>文件，在那里存储了访问Spring Cloud配置服务器的逻辑。像这样:</p><p id="e3cd" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated"><code class="fe ob oc od oe b">app.use('/configserver', configServerRouter);</code></p><p id="7b7f" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated"><strong class="lh iu"> server.js </strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi of"><img src="../Images/716aeb81d1baebb7ff8040e8d76e1bb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9bqJrMmhWT3V10lYvjHbpg.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">节点的server.js文件中没有太多需要更新的内容，因此可以访问云配置服务器。</figcaption></figure><p id="1f53" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">接下来，我转到<code class="fe ob oc od oe b">configServer.js</code>文件，它位于服务器端我的<code class="fe ob oc od oe b">routes/</code>文件夹中。</p><h2 id="1a7a" class="mr jr it bd js ms mt dn jw mu mv dp ka lq mw mx ke lu my mz ki ly na nb km nc bi translated">服务器端:连接到Spring Cloud并创建两个节点配置服务器端点</h2><p id="bedd" class="pw-post-body-paragraph lf lg it lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><code class="fe ob oc od oe b">configServer.js</code>文件包含了运行在云中的Spring Cloud config服务器的大部分连接信息。</p><p id="b253" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">下面是整个文件的截屏——我将详细介绍每个部分，但在较高层次上，它包含一个函数调用，用于最初连接到配置服务器并加载任何可能存在的特性切换信息:<code class="fe ob oc od oe b">loadConfig()</code>。</p><p id="4526" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">有一个端点用<code class="fe ob oc od oe b">/refresh</code>端点刷新提供给配置服务器的信息——这是启用或禁用特性切换的关键，而不必每次都重新构建和重新部署整个JavaScript应用程序。</p><p id="2cdb" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">最后，还有实际的<code class="fe ob oc od oe b">/featureToggles/:feature</code>端点，React UI就是这样调用Node.js服务器来确定哪些特性可用。</p><p id="16a9" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">好了，现在让我们进入每个功能的细节。</p><p id="5411" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated"><strong class="lh iu"> configServer.js </strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi og"><img src="../Images/5b5201f7c6f531e9e2c6dc8bb4bd27da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vXYxl9fi1NJvSkY6-P2WTA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">这是我的整个configServer.js文件，用于检查/刷新特性切换。</figcaption></figure><h2 id="c094" class="mr jr it bd js ms mt dn jw mu mv dp ka lq mw mx ke lu my mz ki ly na nb km nc bi translated">服务器端:功能切换端点</h2><p id="108b" class="pw-post-body-paragraph lf lg it lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">这里是用于以下目的的<code class="fe ob oc od oe b">loadConfig()</code>和<code class="fe ob oc od oe b">/featureToggles/:feature</code>功能的特写:</p><ol class=""><li id="c3bc" class="oh oi it lh b li mm lm mn lq oj lu ok ly ol mc om on oo op bi translated">从Spring Cloud配置服务器获取任何特性切换信息，并</li><li id="a597" class="oh oi it lh b li oq lm or lq os lu ot ly ou mc om on oo op bi translated">处理来自UI的调用，以检查某些功能切换是否对用户组可用。</li></ol><p id="5ecc" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">对于实际的<code class="fe ob oc od oe b">loadConfig()</code>功能，我只是遵循了<a class="ae le" href="https://www.npmjs.com/package/cloud-config-client" rel="noopener ugc nofollow" target="_blank">云配置客户端</a>提供的文档。</p><p id="5904" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">一旦从该函数建立了初始连接，就有一个很好的<a class="ae le" href="https://lodash.com/" rel="noopener ugc nofollow" target="_blank"> Lodash </a>用于将配置服务器数据传递到每个单独特性切换的键和值的映射中。如果这有点难以理解，那么当我展示一个功能切换的实际例子时，可能会更有意义。现在，请继续阅读。</p><p id="f778" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated"><code class="fe ob oc od oe b">router.get(/featureToggles/:feature)</code>函数是处理来自React客户端的调用的端点，检查<code class="fe ob oc od oe b">:feature</code>是否作为一个键存在于先前创建的<code class="fe ob oc od oe b">configServerMap</code>中，如果是，则向客户端返回一个肯定的200响应。</p><p id="0982" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">这就是这部分的全部内容，实际上并不复杂。</p><p id="67df" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated"><strong class="lh iu"> configServer.js </strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ov"><img src="../Images/316bd564f2e1ddbf196c9b3128c093c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aoUQAQizkGWD_LewJSS7Yw.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">从Spring Cloud服务器获取信息的初始loadConfig()调用和从客户端检查configServerMap发送的特性切换调用的特写。</figcaption></figure><h2 id="cc68" class="mr jr it bd js ms mt dn jw mu mv dp ka lq mw mx ke lu my mz ki ly na nb km nc bi translated">服务器端:功能切换刷新端点</h2><p id="bfbc" class="pw-post-body-paragraph lf lg it lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">这里需要注意的另一个函数是<code class="fe ob oc od oe b">router.post(/refresh)</code>端点。这个端点既可以从浏览器调用，也可以(更有可能)从API REST客户端调用，比如<a class="ae le" href="https://www.getpostman.com/" rel="noopener ugc nofollow" target="_blank"> Postman </a>或<a class="ae le" href="https://insomnia.rest/" rel="noopener ugc nofollow" target="_blank">失眠症</a>。</p><p id="8648" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">这就是对配置服务器文件所做的更改被更新并被拉入UI的方式。</p><blockquote class="nk"><p id="291f" class="nl nm it bd nn no np nq nr ns nt mc dk translated">这个“/refresh”端点是修改提供给React UI中现有功能切换的信息的关键。</p></blockquote><p id="09f4" class="pw-post-body-paragraph lf lg it lh b li nu lk ll lm nv lo lp lq nw ls lt lu nx lw lx ly ny ma mb mc im bi translated">如您所见，Node.js服务器第一次启动时调用的同一个<code class="fe ob oc od oe b">loadConfig()</code>函数，在<code class="fe ob oc od oe b">/refresh</code>端点被触发时再次被调用。为了让用户知道刷新成功了，当POST成功时，会发回一条简单的JSON消息:<code class="fe ob oc od oe b">res.send('Refreshed Config Server.');</code></p><p id="ae19" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated"><strong class="lh iu"> configServer.js </strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ow"><img src="../Images/7a35a6a6d202fcc1a99532d1b61801a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zcm_Z7lXG6ozSDtz6JP7Fg.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">触发刷新端点以引入与UI应用程序中已经实现的功能切换相关的新信息。这是关键。</figcaption></figure><h2 id="71eb" class="mr jr it bd js ms mt dn jw mu mv dp ka lq mw mx ke lu my mz ki ly na nb km nc bi translated">客户端:功能切换调用</h2><p id="5173" class="pw-post-body-paragraph lf lg it lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">现在，我们在React UI中进入客户端，这非常简单。在UI方面，我在React中有一个名为<code class="fe ob oc od oe b">/services</code>的文件夹，所有共享的业务逻辑文件都在其中，还有一个文件与配置服务器有关，名为<code class="fe ob oc od oe b">configServerService.js</code>。</p><p id="5ea5" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">这充当React UI客户机和Node.js服务器之间的连接点。</p><p id="a90e" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">正如您可能从下面的截图中看到的那样，这个示例特性开关被称为<code class="fe ob oc od oe b">'status-pilot'</code>，它检查用户的<code class="fe ob oc od oe b">ldap</code>(用户名)，这是由Spring Cloud config server通过<code class="fe ob oc od oe b">/configServer/featureToggles/status-pilot</code>端点提供的。然后，它根据来自配置服务器的用户列表检查客户端提供的<code class="fe ob oc od oe b">ldap</code>，如果其中一个用户与列表中的名字匹配，它将返回一个true boolean。</p><p id="0c01" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">通过这种确认，用户可以看到应用程序中目前正在测试的某些功能，这些功能由一小组选定的用户使用。仅此而已。</p><p id="f6fa" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">只要React应用程序在UI中检查用户权限时调用<code class="fe ob oc od oe b">isStatusPilotUser()</code>函数，并在节点服务器根据来自配置服务器的信息给出响应后，将<code class="fe ob oc od oe b">isStatusPilotUser</code>的布尔值设置为<code class="fe ob oc od oe b">true</code>或<code class="fe ob oc od oe b">false</code>。</p><p id="6ac8" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">这种相同类型的功能设置也可以被添加到这个服务文件中，用于同时切换多个特征。</p><p id="c0bc" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated"><strong class="lh iu"> configServerService.js </strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ox"><img src="../Images/c3b23a39f7160d3606556d6d57b8413b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6ejOFWjXO53a1ukndIHXtw.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">这是客户端的函数:isStatusPilotUser()，它与节点服务器通信，节点服务器保存配置服务器提供的特性切换信息。</figcaption></figure><h1 id="5dc0" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">功能在动作中切换</h1><p id="ea28" class="pw-post-body-paragraph lf lg it lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">好了，现在我已经介绍了如何将节点服务器连接到Spring Cloud配置服务器，以及如何将React客户端连接到节点服务器，是时候展示一个功能切换了。</p><p id="8f6f" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">首先需要一个简单的、更新的配置YAML文件，供Spring Cloud config server使用。</p><p id="7593" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">继续上面的<code class="fe ob oc od oe b">'status-pilot'</code>例子，这里有一个<code class="fe ob oc od oe b">.yml</code>文件，带有一个LDAPs(用户名)列表。突出显示的用户名“AM00002”是Node.js服务器还不知道的列表中的新成员。</p><p id="b672" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">配置服务器本身不会立即注册这一更改，我将不得不手动触发它来更新(或设置一个cron作业)并从文件中获取新信息，但我稍后会谈到这一点。</p><h2 id="7b91" class="mr jr it bd js ms mt dn jw mu mv dp ka lq mw mx ke lu my mz ki ly na nb km nc bi translated">更新Spring Cloud配置服务器的配置文件</h2><p id="b3bd" class="pw-post-body-paragraph lf lg it lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">这是我上面提到的简单的YAML文件。突出显示的用户“AM00002”是文件(和状态试点列表)的新成员。</p><p id="f1fc" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated"><strong class="lh iu">status-pilot-example . yml</strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oy"><img src="../Images/d8b3e5bff75391427dfb61677c7438c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-Lm63zawpkox060kH7XjfQ.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">这里有一个YAML文件的例子。“AM00002”是添加到“状态-试点”功能切换的新用户。</figcaption></figure><h2 id="a8e6" class="mr jr it bd js ms mt dn jw mu mv dp ka lq mw mx ke lu my mz ki ly na nb km nc bi translated">验证发送到节点服务器的配置信息</h2><p id="e448" class="pw-post-body-paragraph lf lg it lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">目前，当我启动连接到Spring Cloud服务器和React UI客户端的节点服务器时，它会从Spring Cloud config服务器获取之前存在的信息列表。因为Spring服务器不知道它提供的信息已经改变，所以它继续向客户机提供以前缓存的配置信息。</p><p id="fce2" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">如果您仔细观察右边的截图，您会发现用户‘am 00002’不在<code class="fe ob oc od oe b">pilotUserList</code>中。没关系，这个问题很快就会得到解决。</p><p id="c4a2" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated"><strong class="lh iu"> configServer.js </strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oz"><img src="../Images/bd99fbc8cb6e07c17b994b3d621371fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qsp1P8FTfi4U9SNB34xWPA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">只是确认UI的节点服务器当前是否将谁视为pilotUserList的一部分。请注意，“AM00002”还不在该列表中…</figcaption></figure><h2 id="e386" class="mr jr it bd js ms mt dn jw mu mv dp ka lq mw mx ke lu my mz ki ly na nb km nc bi translated"><strong class="ak">通过邮递员</strong>命中节点服务器的 <code class="fe ob oc od oe b"><strong class="ak">/refresh’</strong></code> <strong class="ak">端点</strong></h2><p id="10b9" class="pw-post-body-paragraph lf lg it lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">是时候告诉Spring服务器更新它提供的文件了。打开Postman REST客户端，输入应用程序的<code class="fe ob oc od oe b">/refresh</code>端点的URL，并向其发送一个<code class="fe ob oc od oe b">POST</code>请求。</p><p id="9852" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">如果刷新触发器成功，下面的成功消息将作为服务器端的响应出现。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pa"><img src="../Images/4e16d84e75e65449b1e6ea89cb93ca28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6T7PAzp6EylB97n_3AzzzQ.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">这是Postman对配置服务器端点的成功调用。</figcaption></figure><h2 id="8272" class="mr jr it bd js ms mt dn jw mu mv dp ka lq mw mx ke lu my mz ki ly na nb km nc bi translated">检查React UI现在是否将“AM00002”视为状态试点用户</h2><p id="a67b" class="pw-post-body-paragraph lf lg it lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">最后，在通过Postman刷新Spring Cloud服务器的信息之后，我可以通过在客户端的<code class="fe ob oc od oe b">isStatusPilotUser()</code>函数上的Chrome DevTools中放置一个断点来验证这些更改是否已经生效。</p><p id="09ed" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">当浏览器在断点处暂停时，我可以看到包含在从Spring config服务器提供给节点服务器的<code class="fe ob oc od oe b">ldapList</code>中的用户名。如果你仔细观察，你会发现<code class="fe ob oc od oe b">'am00002'</code>现在就在那里；一清二楚。</p><p id="c688" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">对UI特性切换信息的刷新起作用了，而且不需要重新构建或重新部署JavaScript应用程序。我完成了，现在这个用户也是这个特殊UI特性切换中的<code class="fe ob oc od oe b">status-pilot</code>程序的一部分。</p><p id="79d5" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated"><strong class="lh iu"> configServerService.js </strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pb"><img src="../Images/aaa69b1d9ba88cee28c93f2833e9c283.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3_ZrsS0gisasbi9YR59ZqA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">通过使用这些断点，我可以看出对状态引导功能切换的修改生效了，现在‘am 00002’也是状态引导的一部分。</figcaption></figure><h1 id="5a92" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">结论</h1><p id="1a98" class="pw-post-body-paragraph lf lg it lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">对现有功能切换“状态-试点”的更新起作用了，而且所有这些都无需重新构建或重新部署JavaScript应用程序。</p><p id="e9f4" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">只需对使用cloud-config-client的节点服务器进行一些添加，并调用一个<code class="fe ob oc od oe b">/refresh</code> REST端点，React UI的现有特性就可以在短时间内进行修改和更新。</p><p id="e6bf" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">过几周再来看看，我会写一些关于React或者其他与web开发相关的东西，所以请关注我，这样你就不会错过。</p><p id="90e5" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated">感谢您的阅读，我希望您可以使用这个实现来更新您自己的JavaScript应用程序的特性切换，并且能够用您自己的用户子集更容易地测试新特性。</p><p id="c4c1" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated"><strong class="lh iu">如果你喜欢读这篇文章，你可能也会喜欢我的其他博客:</strong></p><ul class=""><li id="d5da" class="oh oi it lh b li mm lm mn lq oj lu ok ly ol mc pc on oo op bi translated"><a class="ae le" href="https://medium.com/@paigen11/why-a-cloud-config-server-is-crucial-to-a-good-ci-cd-pipeline-and-how-to-set-it-up-pt-1-fa628a125776" rel="noopener">为什么Spring Cloud配置服务器对一个好的CI/CD管道至关重要，以及如何设置它(第1部分)</a></li><li id="11ae" class="oh oi it lh b li oq lm or lq os lu ot ly ou mc pc on oo op bi translated"><a class="ae le" href="https://medium.com/@paigen11/leveraging-a-spring-cloud-config-server-in-a-nodejs-application-for-feature-toggles-pt-2-f331c08dfdb6" rel="noopener">利用NodeJS应用程序中的Spring Cloud配置服务器实现特性切换(Pt 2) </a></li><li id="0216" class="oh oi it lh b li oq lm or lq os lu ot ly ou mc pc on oo op bi translated"><a class="ae le" rel="noopener ugc nofollow" target="_blank" href="/the-absolute-easiest-way-to-debug-node-js-with-vscode-2e02ef5b1bad">调试Node.js最简单的方法——使用VS代码</a></li></ul><p id="4ed8" class="pw-post-body-paragraph lf lg it lh b li mm lk ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc im bi translated"><strong class="lh iu">参考资料和更多资源:</strong></p><ul class=""><li id="c417" class="oh oi it lh b li mm lm mn lq oj lu ok ly ol mc pc on oo op bi translated">维基百科，功能切换:<a class="ae le" href="https://en.wikipedia.org/wiki/Feature_toggle" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/Feature_toggle</a></li><li id="cc6c" class="oh oi it lh b li oq lm or lq os lu ot ly ou mc pc on oo op bi translated">云配置客户端，https://www.npmjs.com/package/cloud-config-client NPM:<a class="ae le" href="https://www.npmjs.com/package/cloud-config-client" rel="noopener ugc nofollow" target="_blank"/></li><li id="6ca4" class="oh oi it lh b li oq lm or lq os lu ot ly ou mc pc on oo op bi translated">云配置客户端，Github:<a class="ae le" href="https://github.com/victorherraiz/cloud-config-client#readme" rel="noopener ugc nofollow" target="_blank">https://github.com/victorherraiz/cloud-config-client#readme</a></li><li id="ee6d" class="oh oi it lh b li oq lm or lq os lu ot ly ou mc pc on oo op bi translated">洛达什:<a class="ae le" href="https://lodash.com/" rel="noopener ugc nofollow" target="_blank">https://lodash.com/</a></li><li id="50f8" class="oh oi it lh b li oq lm or lq os lu ot ly ou mc pc on oo op bi translated">邮递员休息客户端:<a class="ae le" href="https://www.getpostman.com/" rel="noopener ugc nofollow" target="_blank">https://www.getpostman.com/</a></li><li id="488e" class="oh oi it lh b li oq lm or lq os lu ot ly ou mc pc on oo op bi translated">失眠休息委托人:【https://insomnia.rest/ T21】</li></ul></div></div>    
</body>
</html>