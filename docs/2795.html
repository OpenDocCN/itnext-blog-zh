<html>
<head>
<title>How I Build My Own Amazon S3 Storage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何构建自己的亚马逊S3存储</h1>
<blockquote>原文：<a href="https://itnext.io/how-i-build-my-own-amazon-s3-storage-5de56b4c6612?source=collection_archive---------0-----------------------#2019-08-05">https://itnext.io/how-i-build-my-own-amazon-s3-storage-5de56b4c6612?source=collection_archive---------0-----------------------#2019-08-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="378e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最近我决定把我的副业转移到Heroku。但是Heroku没有提供托管媒体文件的方法。你需要使用外部存储(亚马逊S3或类似的)。</p><p id="d19a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">不幸的是，没有免费的解决方案，我的亚马逊免费等级已经过期。所以我决定使用Python/Django创建我自己的<a class="ae ko" href="https://github.com/slyapustin/django-s3-like-storage" rel="noopener ugc nofollow" target="_blank">亚马逊S3式存储</a>。</p><p id="ffbb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">嘿，这很容易实现。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/f7d2162477dc1782e54a1d7cf4511777.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xqQSNl-ig29l9PECdQ5ahg.jpeg"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">全栈后端开发人员</figcaption></figure><h2 id="986a" class="lf lg it bd lh li lj dn lk ll lm dp ln kb lo lp lq kf lr ls lt kj lu lv lw lx bi translated">TL；DR；</h2><p id="5803" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">这里是<a class="ae ko" href="https://github.com/slyapustin/django-s3-like-storage" rel="noopener ugc nofollow" target="_blank"> Github库</a>。如果你想要一个生产就绪的系统——使用<a class="ae ko" href="https://min.io?utm_source=lyapustin" rel="noopener ugc nofollow" target="_blank"> MinIO </a>。</p><h2 id="bee0" class="lf lg it bd lh li lj dn lk ll lm dp ln kb lo lp lq kf lr ls lt kj lu lv lw lx bi translated">计划</h2><p id="e3dd" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">我想有一个应用程序，将复制基本的亚马逊S3功能，所以我可以在我的<a class="ae ko" href="https://github.com/slyapustin?tab=repositories&amp;q=django" rel="noopener ugc nofollow" target="_blank"> Django项目</a>(通过<code class="fe md me mf mg b"><a class="ae ko" href="https://django-storages.readthedocs.io/en/latest/backends/amazon-S3.html" rel="noopener ugc nofollow" target="_blank">django-storages</a></code>)使用它。</p><p id="6579" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我不需要它很复杂，我只需要亚马逊S3上的一小部分:</p><ul class=""><li id="3638" class="mh mi it js b jt ju jx jy kb mj kf mk kj ml kn mm mn mo mp bi translated">文件上传</li><li id="f716" class="mh mi it js b jt mq jx mr kb ms kf mt kj mu kn mm mn mo mp bi translated">提供公共文件</li><li id="d930" class="mh mi it js b jt mq jx mr kb ms kf mt kj mu kn mm mn mo mp bi translated">能够拥有多个拥有自己证书的<a class="ae ko" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingBucket.html" rel="noopener ugc nofollow" target="_blank">桶</a>,所以我可以为我的大多数项目使用该服务</li></ul><p id="1e47" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我想通过单个<code class="fe md me mf mg b">docker-compose.yml</code>在Docker中运行它，这样我就可以将它部署到我的<a class="ae ko" href="https://m.do.co/c/08ce1ee690de" rel="noopener ugc nofollow" target="_blank">数字海洋</a> 5美元的25Gb存储的droplet中。</p><h1 id="61ab" class="mv lg it bd lh mw mx my lk mz na nb ln nc nd ne lq nf ng nh lt ni nj nk lw nl bi translated">开始吧！</h1><p id="5b40" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">应用程序模板应该非常简单。我不需要Django管理页面之外的UI，因为我不想以SAAS的形式提供该解决方案，也不想与Amazon竞争。</p><h2 id="2267" class="lf lg it bd lh li lj dn lk ll lm dp ln kb lo lp lq kf lr ls lt kj lu lv lw lx bi translated">视图</h2><p id="b75a" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">将只有一个视图，处理所有的请求。</p><p id="8f02" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我的服务将只处理以下格式的请求:</p><p id="50fc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe md me mf mg b">/&lt;bucket_name&gt;/&lt;content-path&gt;</code></p><p id="6e6c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们需要处理这些方法:</p><ul class=""><li id="3940" class="mh mi it js b jt ju jx jy kb mj kf mk kj ml kn mm mn mo mp bi translated"><code class="fe md me mf mg b">PUT</code> —向存储器发送新文件</li><li id="1fc6" class="mh mi it js b jt mq jx mr kb ms kf mt kj mu kn mm mn mo mp bi translated"><code class="fe md me mf mg b">GET</code> —获取文件</li><li id="583a" class="mh mi it js b jt mq jx mr kb ms kf mt kj mu kn mm mn mo mp bi translated"><code class="fe md me mf mg b">HEAD</code> —检查文件是否已经存在于存储器中</li></ul><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nm nn l"/></div></figure><h2 id="0bb3" class="lf lg it bd lh li lj dn lk ll lm dp ln kb lo lp lq kf lr ls lt kj lu lv lw lx bi translated">模型</h2><p id="871a" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">我现在有两种型号:</p><ul class=""><li id="3e23" class="mh mi it js b jt ju jx jy kb mj kf mk kj ml kn mm mn mo mp bi translated"><code class="fe md me mf mg b">Bucket</code> —定义存储桶名称和凭证</li><li id="282a" class="mh mi it js b jt mq jx mr kb ms kf mt kj mu kn mm mn mo mp bi translated"><code class="fe md me mf mg b">Blob</code> —存储用户上传和一些元数据(大小、内容类型)的模型</li></ul><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nm nn l"/></div></figure><h2 id="dd49" class="lf lg it bd lh li lj dn lk ll lm dp ln kb lo lp lq kf lr ls lt kj lu lv lw lx bi translated">验证请求</h2><p id="4347" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">我们需要验证用户请求，因此只有拥有正确凭证的用户才能将文件上传到我们的服务中。</p><p id="8512" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是最棘手的部分，因为我们需要计算头和内容散列，并用请求中收到的来验证它们。你可以在亚马逊网站的<a class="ae ko" href="https://docs.aws.amazon.com/general/latest/gr/sigv4-signed-request-examples.html" rel="noopener ugc nofollow" target="_blank">上查看如何用Python做这件事的例子。</a></p><p id="3933" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有一个由大卫·库斯伯特制作的包，所以我们不需要自己做那部分。</p><p id="fa2e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该包使用秘密密钥为接收到的请求内容和报头计算签名，并将其与请求中提供的签名进行比较。因此，只有拥有正确密钥的用户才能上传内容。</p><p id="ab20" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该软件包目前缺少的一项功能是处理HTTPS请求，这是一个特例。有一个<a class="ae ko" href="https://github.com/dacut/python-aws-sig/pull/3" rel="noopener ugc nofollow" target="_blank"> PR可用</a>，来解决这个问题。现在，我们将使用该包的定制版本，我们可以直接从Github安装它:</p><pre class="kq kr ks kt gt no mg np nq aw nr bi"><span id="6bb5" class="lf lg it mg b gy ns nt l nu nv">pip install git+git://github.com/slyapustin/python-aws-sig.git#egg=awssig</span></pre><p id="d91f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">每次我们收到<code class="fe md me mf mg b">PUT</code>请求时，我们将检查该请求是否具有有效的签名，因为桶与以下内容相关联:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="d934" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们将把所有东西都存储在Django的<code class="fe md me mf mg b">FileField</code>中，并附带一些元数据，我们可能需要这些元数据来在以后适当地提供内容:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="83d8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我存储内容类型，以便为图像提供正确的内容类型，这样它们就可以直接插入到HTML页面中:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nm nn l"/></div></figure><h1 id="67bf" class="mv lg it bd lh mw mx my lk mz na nb ln nc nd ne lq nf ng nh lt ni nj nk lw nl bi translated">部署</h1><p id="d58a" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">我想有一个Docker组合配置，这样我就可以将一切部署到我的<a class="ae ko" href="https://m.do.co/c/08ce1ee690de" rel="noopener ugc nofollow" target="_blank">数字海洋</a> droplet。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="2eac" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">几个注意事项:</p><ul class=""><li id="3e75" class="mh mi it js b jt ju jx jy kb mj kf mk kj ml kn mm mn mo mp bi translated">我使用一个单独的<code class="fe md me mf mg b">docker.env</code>文件，其中包含Docker部署所需的所有环境变量</li><li id="197e" class="mh mi it js b jt mq jx mr kb ms kf mt kj mu kn mm mn mo mp bi translated">Docker卷指向本地文件系统，所以我没有任何开销。</li><li id="205b" class="mh mi it js b jt mq jx mr kb ms kf mt kj mu kn mm mn mo mp bi translated">我在我的服务器上使用Nginx作为反向代理，这个应用程序将监听从Nginx发送到端口<code class="fe md me mf mg b">8005</code>的请求。您可能有不同的配置，所以请记住这一点。</li></ul><h1 id="cdbd" class="mv lg it bd lh mw mx my lk mz na nb ln nc nd ne lq nf ng nh lt ni nj nk lw nl bi translated">怎么用那个？</h1><p id="73f9" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">在您将它部署到您的服务器并使用新的凭证创建Bucket之后，您可以在您的Django应用程序中使用它，就像通常的带有<code class="fe md me mf mg b">django-storages</code>包的AWS S3存储一样。</p><p id="99af" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">以下是您应该提供的设置:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="afef" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">就是这样。</p><h2 id="8ae2" class="lf lg it bd lh li lj dn lk ll lm dp ln kb lo lp lq kf lr ls lt kj lu lv lw lx bi translated">演示</h2><p id="f46d" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">这里有一个<a class="ae ko" href="https://github.com/slyapustin/django-classified-demo" rel="noopener ugc nofollow" target="_blank"> Django分类的演示</a>项目，它使用了那个<code class="fe md me mf mg b"><a class="ae ko" href="https://github.com/slyapustin/django-s3-like-storage" rel="noopener ugc nofollow" target="_blank">Django-S3-Like-Storage</a></code>。</p></div></div>    
</body>
</html>