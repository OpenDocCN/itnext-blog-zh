<html>
<head>
<title>Automating tagging and versioning of Terraform modules (or any language!)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terraform模块的自动化标记和版本控制(或任何语言！)</h1>
<blockquote>原文：<a href="https://itnext.io/automating-tagging-and-versioning-of-terraform-modules-or-any-language-3a271966c63c?source=collection_archive---------1-----------------------#2021-02-11">https://itnext.io/automating-tagging-and-versioning-of-terraform-modules-or-any-language-3a271966c63c?source=collection_archive---------1-----------------------#2021-02-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/3d0fef1a54635d89ff36e282a43e1a85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1048/format:webp/0*cespWjYTJVzHiYnR.png"/></div></figure><p id="9ea1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">最近，我们的一些模块需要突破性的变化，我们没有一个好的方法来传达给用户的影响，并允许他们固定到一个特定的版本。虽然精明的Terraform用户可以锁定Git SHA，但这不是理想的方法。因此，我研究了如何对Terraform模块进行版本控制，并确保方法的一致性…希望是自动化的。</p><p id="92c0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在深入研究方法和工具之前，有必要快速回顾一下什么是语义版本化。<a class="ae ks" href="http://semver.org/" rel="noopener ugc nofollow" target="_blank">semver.org</a>将语义版本定义为:</p><blockquote class="kt ku kv"><p id="bbbe" class="ju jv kw jw b jx jy jz ka kb kc kd ke kx kg kh ki ky kk kl km kz ko kp kq kr ij bi translated">给定主要版本号。小调。补丁，增加:</p><p id="eb7c" class="ju jv kw jw b jx jy jz ka kb kc kd ke kx kg kh ki ky kk kl km kz ko kp kq kr ij bi translated">主要版本当您进行不兼容的API更改时，</p><p id="0a9b" class="ju jv kw jw b jx jy jz ka kb kc kd ke kx kg kh ki ky kk kl km kz ko kp kq kr ij bi translated">以向后兼容的方式添加功能时的次要版本，以及</p><p id="d885" class="ju jv kw jw b jx jy jz ka kb kc kd ke kx kg kh ki ky kk kl km kz ko kp kq kr ij bi translated">补丁版本，当你做向后兼容的错误修正。</p><p id="abd2" class="ju jv kw jw b jx jy jz ka kb kc kd ke kx kg kh ki ky kk kl km kz ko kp kq kr ij bi translated">预发布和构建元数据的附加标签可作为主标签的扩展。小调。补丁格式。</p></blockquote><p id="4d39" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Terraform已经利用了语义版本化并提供了版本约束。作为一个快速回顾，这里有一些如何使用语义版本并锁定特定或某个范围的版本的例子。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="5e35" class="lj lk iq lf b gy ll lm l ln lo">version = "~&gt; 1.0.4" # Allows from 1.0.4 to 1.0.xxxx. Only the rightmost component can increment<br/><br/>version = "~&gt; 1.0"   # Allows from 1.0 to 1.xxxxx. Only the rightmost component can increment. Slight variation on previous example.<br/><br/>version = "= 1.0.4"  # Allows only a single version 1.0.4<br/><br/>version = "&gt;= 1.2.0, &lt; 2.0.0" # Ensure to not bump to major revision 2.0.0</span></pre><p id="d04b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Terraform推荐以下模块版本:</p><ul class=""><li id="f3c0" class="lp lq iq jw b jx jy kb kc kf lr kj ls kn lt kr lu lv lw lx bi translated">当依赖于第三方模块时，需要特定的版本，以确保仅在您方便时进行更新。</li><li id="df6a" class="lp lq iq jw b jx ly kb lz kf ma kj mb kn mc kr lu lv lw lx bi translated">对于在您的组织内维护的模块，如果一致地使用语义版本控制，或者如果有明确定义的发布过程来避免不必要的更新，则指定版本范围可能是合适的。</li></ul><p id="f6bc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Terraform还在<a class="ae ks" href="https://www.terraform.io/docs/extend/best-practices/versioning.html" rel="noopener ugc nofollow" target="_blank">https://www . terra form . io/docs/extend/best-practices/versioning . html</a>上为模块开发人员提供了关于语义版本化的使用指南。我强烈推荐遵循这个建议，因为它将与超越您的组织的实践保持一致。</p><h1 id="3b2f" class="md lk iq bd me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz bi translated">工具作业</h1><p id="69e2" class="pw-post-body-paragraph ju jv iq jw b jx na jz ka kb nb kd ke kf nc kh ki kj nd kl km kn ne kp kq kr ij bi translated">我查看了开源工具和Azure DevOps的插件。因为我想要一个可移植的方法，不管CI/CD工具如何，我很早就选择了Azure DevOps插件。</p><p id="35cd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从开源的角度，我发现了一个叫做语义发布的工具。这是一个NodeJS应用程序，使用基于插件的架构，非常灵活。semantic-release有十几个插件可以与不同的源代码管理系统、模块注册表(PyPi和npm)集成，并且能够在版本控制和标记过程中添加/删除步骤。多个插件的使用将在这个博客中演示。</p><p id="9e10" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了总结这篇文章，我分享了一个集成了语义发布的<a class="ae ks" href="https://github.com/patpicos/terraform_module_versioning" rel="noopener ugc nofollow" target="_blank">样本库</a>。该回购包括:</p><ul class=""><li id="80ce" class="lp lq iq jw b jx jy kb kc kf lr kj ls kn lt kr lu lv lw lx bi translated">单个虚拟模块(.根目录下的tf文件)。这些文件是空的，但是有助于展示模块组件分解成不同的。tf文件。</li><li id="0bf2" class="lp lq iq jw b jx ly kb lz kf ma kj mb kn mc kr lu lv lw lx bi translated">单元测试框架(测试/和示例/)</li><li id="bcbe" class="lp lq iq jw b jx ly kb lz kf ma kj mb kn mc kr lu lv lw lx bi translated">语义发布配置(。releaserc)</li><li id="d970" class="lp lq iq jw b jx ly kb lz kf ma kj mb kn mc kr lu lv lw lx bi translated">azure devo PS(azure-pipelines . YAML)管道，执行静态代码分析、自动化测试和版本控制/标记(本博客的主题)。静态代码分析部分受到了Adin Ermie关于这个主题的博客的启发。</li><li id="7944" class="lp lq iq jw b jx ly kb lz kf ma kj mb kn mc kr lu lv lw lx bi translated">提交前配置，在每次提交时自动执行代码林挺，并生成文档。参考这篇<a class="ae ks" rel="noopener ugc nofollow" target="_blank" href="/terraform-enforcing-doc-generation-and-code-formatting-e7dc6098b3a0">博客文章</a>了解更多细节。</li></ul><p id="f6c6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">本次回购的目的不是展示任何重要的Terraform代码；重点是结构和支持Terraform模块开发周期。</p><h1 id="9af0" class="md lk iq bd me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz bi translated">提交约定</h1><p id="1b0a" class="pw-post-body-paragraph ju jv iq jw b jx na jz ka kb nb kd ke kf nc kh ki kj nd kl km kn ne kp kq kr ij bi translated">首先，语义发布基于遵循特定约定的提交消息的使用。提交分析器插件将解析自上一个模块版本/标签以来的提交，并将确定要生成的版本(主要版本、次要版本、补丁)。<strong class="jw ir">最高影响</strong>提交消息将驱动凸起。</p><p id="aa18" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">提交分析器插件可以解析多种约定。在本文中，我主要关注默认的角度<a class="ae ks" href="https://github.com/angular/angular.js/blob/master/DEVELOPERS.md#-git-commit-guidelines." rel="noopener ugc nofollow" target="_blank">约定</a>。</p><p id="62d1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">提交消息格式:</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="f9e7" class="lj lk iq lf b gy ll lm l ln lo">&lt;type&gt;(&lt;scope&gt;): &lt;subject&gt;<br/>&lt;BLANK LINE&gt;<br/>&lt;body&gt;<br/>&lt;BLANK LINE&gt;<br/>&lt;footer&gt;</span></pre><p id="3923" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">类型必须是以下类型之一:</p><ul class=""><li id="9379" class="lp lq iq jw b jx jy kb kc kf lr kj ls kn lt kr lu lv lw lx bi translated">专长:新功能</li><li id="8f56" class="lp lq iq jw b jx ly kb lz kf ma kj mb kn mc kr lu lv lw lx bi translated"><strong class="jw ir">修复</strong>:一个bug修复</li><li id="7c50" class="lp lq iq jw b jx ly kb lz kf ma kj mb kn mc kr lu lv lw lx bi translated"><strong class="jw ir">文档</strong>:仅文档变更</li><li id="01ea" class="lp lq iq jw b jx ly kb lz kf ma kj mb kn mc kr lu lv lw lx bi translated"><strong class="jw ir">样式</strong>:不影响代码含义的更改(空白、格式、缺少分号等)</li><li id="fd9f" class="lp lq iq jw b jx ly kb lz kf ma kj mb kn mc kr lu lv lw lx bi translated"><strong class="jw ir">重构</strong>:既不修复bug也不增加特性的代码变更</li><li id="6dec" class="lp lq iq jw b jx ly kb lz kf ma kj mb kn mc kr lu lv lw lx bi translated"><strong class="jw ir"> perf </strong>:提高性能的代码更改</li><li id="6efa" class="lp lq iq jw b jx ly kb lz kf ma kj mb kn mc kr lu lv lw lx bi translated"><strong class="jw ir">测试</strong>:添加缺失或修正现有测试</li><li id="07df" class="lp lq iq jw b jx ly kb lz kf ma kj mb kn mc kr lu lv lw lx bi translated"><strong class="jw ir">杂务</strong>:对构建过程或者辅助工具和库的变更，比如文档生成</li></ul><p id="028c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从上面的列表中，semantic-release(提交分析器插件)解析以下提交类型。也可以使用其他类型来驱动版本增量。这将在后面的语义发布配置中解释。主要/突破性发布需要一点澄清。要触发一个主要版本，提交主体需要有单词<strong class="jw ir">中断</strong>或<strong class="jw ir">中断变更</strong>(不区分大小写)。如果在主题中，我重复一遍，需要在提交的主体中，这些关键字将不会触发一个主要的发布。</p><figure class="la lb lc ld gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi nf"><img src="../Images/c42a775af6c9a12f75d7d0ac2f756be4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1EIKIpsgn63h9_WU0tzVnw.png"/></div></div></figure><h1 id="d981" class="md lk iq bd me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz bi translated">提交示例</h1><p id="5c97" class="pw-post-body-paragraph ju jv iq jw b jx na jz ka kb nb kd ke kf nc kh ki kj nd kl km kn ne kp kq kr ij bi translated">让我们来看看我在示例存储库中所做的一些提交。您可以看到标记是由管道自动添加的(使用gerry()commits)。</p><p id="7c37" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">提交f93b9f8需要一些解释。虽然提交类型是fix()，这将触发补丁发布，但提交的内容包括单词“<strong class="jw ir"> breaking </strong>”，这将触发提交分析器将更改提升到主要/重大发布。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="c96a" class="lj lk iq lf b gy ll lm l ln lo">commit f93b9f85dc4d2cba1b9f97eca95d3c284a468dfe (origin/master)<br/>Author: Patrick Picard &lt;patrick.picard@xxxxx.ca&gt;<br/>Date:   Wed Feb 10 12:10:12 2021 -0500<br/><br/>    fix(azureboard-7): testing behavior for breaking in lowercase<br/>    <br/>    breaking change attempt</span></pre><p id="9bc5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，如果您查看标记的提交消息，您将看到由提交消息驱动的完整的changelog。此更改日志数据也将包含在版本中，也将包含在CHANGELOG.md中</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="0fae" class="lj lk iq lf b gy ll lm l ln lo">ddb91c7 (HEAD -&gt; main, tag: 4.0.0, origin/main, origin/HEAD) chore(release): 4.0.0 [skip ci]<br/>f93b9f8 (origin/master) fix(azureboard-7): testing behavior for breaking in lowercase<br/>36e7e23 docs(azureboard-7) add known issues<br/>388b670 (origin/final_update) feat(azureboard-7): cleaned up repo and expanded documentation<br/>d1f3d1b fix(azureboard-7): fix tag stage condition<br/>aa03bbd removed unused files<br/>44d692d fix(azureboard-7): only run pipeline on main branch<br/>220e883 Merge branch 'master' of github.com:patpicos/tagging_test<br/>68416ac feat(azureboard-7): Combine pipeline stages<br/>b7fada0 (tag: 3.0.1) chore(release): 3.0.1 [skip ci]<br/>eff59f0 Merge branch 'master' of github.com:patpicos/tagging_test</span></pre><p id="6d97" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">简单回顾一下，这种使用提交消息约定的方法需要工程师的训练来创建高质量的提交消息。只有遵循约定的提交才会驱动版本控制和变更日志文档。一种方法是在合并和进行清理/措辞改进之前压缩您的提交。</p><p id="89d9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">纪律严明，回报丰厚！自动化的变更日志生成、明确的提交意图以及自动化的标记和版本控制。</p><h1 id="dac0" class="md lk iq bd me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz bi translated">将语义发布集成到CI管道中</h1><p id="e4b4" class="pw-post-body-paragraph ju jv iq jw b jx na jz ka kb nb kd ke kf nc kh ki kj nd kl km kn ne kp kq kr ij bi translated">为了演示CI管道的语义释放，我使用了Azure DevOps。管道以两种模式运行:</p><ul class=""><li id="fe17" class="lp lq iq jw b jx jy kb kc kf lr kj ls kn lt kr lu lv lw lx bi translated"><strong class="jw ir">拉请求</strong> —用Checkov运行静态代码分析，用Terratest运行单元测试</li><li id="9889" class="lp lq iq jw b jx ly kb lz kf ma kj mb kn mc kr lu lv lw lx bi translated"><strong class="jw ir">提交到主分支</strong> —在拉请求之后，合并到主分支、版本、标签，并发布模块版本</li></ul><p id="0ae7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要在单个管道中完成这两种模式，需要使用管道级上的条件。管道代码可从以下网址获得</p><p id="d4ca" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><a class="ae ks" href="https://github.com/patpicos/terraform_module_versioning/blob/main/azure-pipelines.yaml" rel="noopener ugc nofollow" target="_blank">https://github . com/pat picos/terra form _ module _ versioning/blob/main/azure-pipelines . YAML</a></p><p id="2182" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">除了管道，还有一个用于语义发布的配置文件，<a class="ae ks" href="https://github.com/patpicos/terraform_module_versioning/blob/main/.releaserc" rel="noopener ugc nofollow" target="_blank">。需要releaserc </a>。我没有在这里复制完整的配置，而是包含了一个到GitHub的链接，并且将说明它的功能。</p><p id="0376" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">首先，您定义了语义发布将作用于哪些分支。在我们的例子中，只有主分支会触发版本控制。可以修改标记格式，但至少必须包括语义版本值${version}。</p><p id="4b27" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后，配置一个插件列表。插件的顺序很重要。</p><ol class=""><li id="03b7" class="lp lq iq jw b jx jy kb kc kf lr kj ls kn lt kr nk lv lw lx bi translated"><strong class="jw ir">提交分析器</strong> —定义提交约定(角度)并指定对提交类型的任何覆盖</li><li id="901d" class="lp lq iq jw b jx ly kb lz kf ma kj mb kn mc kr nk lv lw lx bi translated"><strong class="jw ir">发布说明生成器</strong> —生成发布说明/变更日志的内容</li><li id="6dc7" class="lp lq iq jw b jx ly kb lz kf ma kj mb kn mc kr nk lv lw lx bi translated"><strong class="jw ir"> changelog </strong> —将发布说明写入指定文件</li><li id="e2c8" class="lp lq iq jw b jx ly kb lz kf ma kj mb kn mc kr nk lv lw lx bi translated"><strong class="jw ir"> git </strong> —提交对<a class="ae ks" href="http://changelog.md/" rel="noopener ugc nofollow" target="_blank"> CHANGELOG.md </a>文件的更改</li><li id="91ca" class="lp lq iq jw b jx ly kb lz kf ma kj mb kn mc kr nk lv lw lx bi translated"><strong class="jw ir"> github </strong> —发布标签，生成发布，推送变更。</li></ol><p id="ea88" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果您正在打包Node或Python代码，您还可以包含其他插件来自动化发布。在这种情况下，除了Git repo，我们不会在任何地方发布这个版本。</p><p id="8cd3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">语义发布非常强大，因为它可以版本化任何语言。这种方法不依赖于CI工具和语言平台。</p><h1 id="6279" class="md lk iq bd me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz bi translated">更改日志生成</h1><p id="39fd" class="pw-post-body-paragraph ju jv iq jw b jx na jz ka kb nb kd ke kf nc kh ki kj nd kl km kn ne kp kq kr ij bi translated">正如前面提交日志中所演示的，更改日志是从提交消息中生成的。使用当前配置，将生成更改日志:</p><ul class=""><li id="13a0" class="lp lq iq jw b jx jy kb kc kf lr kj ls kn lt kr lu lv lw lx bi translated">通过解析提交历史并将提交分类为错误修复/功能/重大变更，自动提交到<a class="ae ks" href="http://changelog.md/" rel="noopener ugc nofollow" target="_blank"> CHANGELOG.md </a>。</li><li id="f8f1" class="lp lq iq jw b jx ly kb lz kf ma kj mb kn mc kr lu lv lw lx bi translated">将变更日志信息包含到发布本身中(在主体和资产中)。</li></ul><p id="9421" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><a class="ae ks" href="http://changelog.md/" rel="noopener ugc nofollow" target="_blank"> CHANGELOG.md </a>示例:</p><figure class="la lb lc ld gt jr gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/acfbb3e15a54cfa430d0eaa983f626cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1374/format:webp/1*ag0UFuWkiyZHh-AFOm3CXw.png"/></div></figure><h1 id="b6a0" class="md lk iq bd me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz bi translated">结论</h1><p id="979f" class="pw-post-body-paragraph ju jv iq jw b jx na jz ka kb nb kd ke kf nc kh ki kj nd kl km kn ne kp kq kr ij bi translated">我希望你喜欢这个较长的条目。我真的很喜欢寻找像语义发布项目这样的开源宝石。它解决了一个经常手工完成的过程；因此容易出错。</p><p id="c4ce" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">语义发布可以用于任何编程语言。此外，它有专门针对某些语言的插件来定制流程。</p></div></div>    
</body>
</html>