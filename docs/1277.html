<html>
<head>
<title>Setup Jenkins with Google Container Registry</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Google容器注册表设置Jenkins</h1>
<blockquote>原文：<a href="https://itnext.io/setup-jenkins-with-google-container-registry-2f8d39aaa275?source=collection_archive---------0-----------------------#2018-08-28">https://itnext.io/setup-jenkins-with-google-container-registry-2f8d39aaa275?source=collection_archive---------0-----------------------#2018-08-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="f751" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最近<a class="ae kl" href="https://hackernoon.com/8-tips-for-containerizing-django-apps-5340647632a4" rel="noopener ugc nofollow" target="_blank">我开始用Docker做我的兼职项目</a>。在部署过程中有两个任务:一个是构建docker映像并将其推送到我的私有容器注册表中，另一个是从注册表中提取docker映像并从中创建一个容器。</p><p id="15b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于私有注册，我使用的是<a class="ae kl" href="https://cloud.google.com/container-registry/" rel="noopener ugc nofollow" target="_blank">谷歌云容器注册</a> (GCR)。我也有自己的詹金斯服务，所以我想从詹金斯自动做这两个任务。经过一番调查，我终于使一切工作。以下是方法。</p><h1 id="c435" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">环境</h1><p id="a264" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">以下是我正在使用的软件和操作系统列表:</p><ul class=""><li id="1032" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx bi translated">Ubuntu 18.04</li><li id="d5aa" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">詹金斯版本。2.121.3</li><li id="ce32" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">Docker 17.12.1-ce，安装有<code class="fe md me mf mg b">apt install docker.io</code></li></ul><h1 id="1bcb" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">基础</h1><p id="61d2" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">要从jenkins访问GCR，我们需要安装以下插件。</p><ul class=""><li id="36a4" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx bi translated">docker-build-step :这个插件允许添加各种docker命令作为构建步骤。最新版本2.0。</li><li id="af97" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated"><a class="ae kl" href="https://plugins.jenkins.io/google-oauth-plugin" rel="noopener ugc nofollow" target="_blank"> Google OAuth凭证</a>:提供Google凭证。最新版本0.6。</li><li id="884b" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated"><a class="ae kl" href="https://plugins.jenkins.io/google-container-registry-auth" rel="noopener ugc nofollow" target="_blank">Google Container Registry Auth</a>:该插件从Google OAuth凭证插件中检索Google凭证，并为docker-build-step插件提供认证。最新版本0.3。</li></ul><p id="5c88" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">工作流程有点麻烦，但还是可以理解的:</p><ol class=""><li id="8319" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk mh lv lw lx bi translated">创建一个服务帐户，该帐户可以完全访问谷歌云中的GCR。</li><li id="b17d" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk mh lv lw lx bi translated">在jenkins中，使用Google OAuth凭据插件为该服务帐户创建一个凭据。</li><li id="3a02" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk mh lv lw lx bi translated">使用docker-build-step插件创建一个拉/推构建步骤，并将注册表url设置为GCR。</li><li id="6e57" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk mh lv lw lx bi translated">当执行构建步骤时，Google容器注册认证插件将向docker提供在步骤2中创建的凭证。</li></ol><p id="3bc1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">详情请继续阅读。</p><h1 id="447e" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">步骤1:创建服务帐户</h1><p id="de77" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">我假设您已经在Google Cloud中创建了容器注册表。如果你还没有这样做，不要担心，只要登录到你的谷歌云控制台，从边栏中选择“容器注册表”，然后按照说明进行操作。您将在几分钟内完成设置。让我们假设注册表URL是<code class="fe md me mf mg b"><a class="ae kl" href="https://gcr.io/myregistry," rel="noopener ugc nofollow" target="_blank">https://gcr.io/myregistry</a></code> <a class="ae kl" href="https://gcr.io/myregistry," rel="noopener ugc nofollow" target="_blank">，</a>，其中<code class="fe md me mf mg b">myregistry</code>是Google Cloud中的项目名称。</p><p id="bf77" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要创建一个服务帐户，以便詹金斯可以访问GCR。从侧边栏打开“IAM &amp; admin”，然后打开“服务帐户”。点击“+创建服务帐户”按钮并输入您的帐户名称。</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi mi"><img src="../Images/61578bf6b97045b022302bd06259c529.png" data-original-src="https://miro.medium.com/v2/resize:fit:1138/format:webp/1*IWEWdxYWQqh5apGKufVh6g.png"/></div></div></figure><p id="a2b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里的“服务帐户名”是一个便于阅读的描述性名称，因此可以是任何名称。我们不需要添加任何角色。不要忘记检查“提供一个新的私钥”并选择“JSON”格式。</p><p id="4c85" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在点击保存之前，请记下生成的“服务帐户ID”，在本例中为<code class="fe md me mf mg b">my-jenkins-gcr-account@myregistry.iam.gserviceaccount.com</code>。我们以后需要这个。</p><p id="dabe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">单击Save按钮，将下载一个包含私钥的JSON文件。请将此文件保存在安全的地方，我们在下一步中需要此文件。</p><p id="dfc3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从侧边栏切换到“存储”。你应该能看到GCR的一个桶，可能命名为<code class="fe md me mf mg b">artifacts.myregistry.appspot.com</code>。打开此桶并切换到“权限”选项卡。</p><p id="0419" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击“添加成员”。输入我们刚刚创建的服务帐户ID，并在“Roles”中选择“Storage Admin”。单击添加。</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/70253eecb70d56deea101b194770af04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/1*VJpSsLOcBtBe0itdBxWdjQ.png"/></div></figure><h1 id="c0f8" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">设置Jenkins凭据</h1><p id="c193" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">回到你的詹金斯服务，并确保登录与管理帐户。从边栏中选择“凭据”，然后选择“全局凭据”(您也可以选择其他域)，并单击“添加凭据”。</p><p id="0f15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为“种类”字段选择“来自私钥的Google服务帐户”，并输入您的项目名称(在本例中为<code class="fe md me mf mg b">myregistry</code>)。然后上传我们在上一步中刚刚下载的JSON私钥。</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/d1eaa9b793bb270d78e3ba74614fa0c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*lLMv13b7uqzkCdv2afAK-w.png"/></div></figure><h1 id="be03" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">设置Docker</h1><p id="c8f9" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">如果你的docker已经和Jenkins合作过，你可以跳过这一步。还要注意，因为我只有一个jenkins服务器，它既充当主服务器又充当从服务器，所以我决定从命令行手动安装Docker。如果您想为jenkins集群配置Docker，“管理Jenkins”→“全局工具配置”→“Docker安装”可能会有所帮助。</p><p id="eb27" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我从jenkins服务器命令行安装了docker:</p><pre class="mj mk ml mm gt mw mg mx my aw mz bi"><span id="8a9f" class="na kn iq mg b gy nb nc l nd ne">$ sudo apt install docker.io</span></pre><p id="ae1a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">默认情况下，Docker只公开Jenkins无法访问的unix套接字上的API。我们需要为jenkins公开一个TCP端口。键入以下命令:</p><pre class="mj mk ml mm gt mw mg mx my aw mz bi"><span id="dd62" class="na kn iq mg b gy nb nc l nd ne">$ sudo systemctl edit docker</span></pre><p id="0efb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">并键入以下内容以覆盖Docker配置:</p><pre class="mj mk ml mm gt mw mg mx my aw mz bi"><span id="6a27" class="na kn iq mg b gy nb nc l nd ne">[Service]<br/>ExecStart=<br/>ExecStart=/usr/bin/dockerd -H fd:// -H tcp://127.0.0.1:2375</span></pre><p id="ea5a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">重启docker，使docker在<code class="fe md me mf mg b">127.0.0.1:2375</code>上公开API:</p><pre class="mj mk ml mm gt mw mg mx my aw mz bi"><span id="3af0" class="na kn iq mg b gy nb nc l nd ne">$ sudo systemctl restart docker.service</span></pre><p id="1112" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后回到jenkins，选择“管理Jenkins”→“配置系统”。在“Docker Builder”部分，用<code class="fe md me mf mg b">tcp://127.0.0.1:2375</code>填充“Docker URL ”,然后点击“测试连接”以确保它正常工作。</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi nf"><img src="../Images/0be118f36e0f14f541e8a9270744dc13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JqzEjzAsDsWmRR81BDH80A.png"/></div></div></figure><h1 id="b1c8" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">设置Jenkins作业以推送映像</h1><p id="2865" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">现在是时候创建詹金斯职位了。创建一个自由式jenkins作业，并根据您的需要填充其他设置(如git存储库、参数等。).在构建步骤中，您可以添加docker命令来构建和推/拉Docker映像。</p><p id="43db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于推/拉命令，按如下方式填充参数:</p><ul class=""><li id="066a" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx bi translated">要推/拉的图像名称:图像名称，例如<code class="fe md me mf mg b">myapp</code></li><li id="904d" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">Tag:图像标签，可以使用jenkins变量，例如<code class="fe md me mf mg b">build-$BUILD_NUMBER</code></li><li id="7e5a" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">注册表:GCR上不带<code class="fe md me mf mg b">https</code>的注册表名称，如<code class="fe md me mf mg b">gcr.io/myregistry</code></li><li id="ea8a" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">Docker注册网址:GCR网址，使用<code class="fe md me mf mg b"><a class="ae kl" href="https://gcr.io" rel="noopener ugc nofollow" target="_blank">https://gcr.io</a></code></li><li id="dc82" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">注册表凭据:选择我们在“设置Jenkins凭据”部分创建的凭据</li></ul><p id="b7b8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是一个包含构建步骤和推送步骤的示例:</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi ng"><img src="../Images/6f18489035a09f85d0f48f287a324c3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_sl-BbAlFhZ-bTaWp1qHHg.png"/></div></div></figure><p id="831a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就这些了！现在，您可以尝试构建这个jenkins作业，它会自动将映像推送到GCR。</p></div><div class="ab cl nh ni hu nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="ij ik il im in"><p id="5c5f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">詹金斯插件设置总是很麻烦，所以有一些现成的“配方”总是好的。希望这篇文章对你有所帮助，感谢你的阅读！</p></div></div>    
</body>
</html>