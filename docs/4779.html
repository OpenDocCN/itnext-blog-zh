<html>
<head>
<title>Managing Kubernetes Secrets Securely with GitOps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GitOps安全管理Kubernetes机密</h1>
<blockquote>原文：<a href="https://itnext.io/managing-kubernetes-secrets-securely-with-gitops-b8174b4f4d30?source=collection_archive---------1-----------------------#2020-09-16">https://itnext.io/managing-kubernetes-secrets-securely-with-gitops-b8174b4f4d30?source=collection_archive---------1-----------------------#2020-09-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/06bb91d94fb73c7b0fc2cb6fb2624638.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YxKIoa-5eiTI-oCi18zwHA.png"/></div></div></figure><p id="118d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">你可以用GitOps管理秘密，你应该这样做。使用GitOps，您可以安全地完成它，并且可以大规模地完成它，而且它是自动化的！</p><p id="1618" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">GitOps只是一个不断演变的流行语景观中的最新流行语。它的核心是以一种表示当前状态的声明性方式管理资源，以便随时了解git中的情况，并将声明性状态解析到集群。</p><p id="7f31" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">人们在GitOps上犯的最大错误是结构。存储库的结构至关重要。你如何选择在你的公司组织GitOps将决定它的成败。</p><p id="4ec3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一旦你解决了结构问题，人们面临的下一个最大问题是如何保护秘密。一般来说，它最终会损害不需要访问权限的人的利益，或者通过Slack或1Password传播共享的秘密。</p><p id="8659" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae kz" href="https://github.com/bitnami-labs/sealed-secrets" rel="noopener ugc nofollow" target="_blank">密封的秘密</a>是Kubernetes上解决秘密的一种流行方法，这是一种体面的解决方案，它依赖于PKI和共享公钥来加密，并在群集上安装私钥，但归根结底，<strong class="kd iu">还有更好的方法。</strong></p><h1 id="1624" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">保护秘密的更好方法</h1><p id="489f" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated"><a class="ae kz" href="https://github.com/mozilla/sops" rel="noopener ugc nofollow" target="_blank"> Mozilla的SOPS </a>。SOPS支持关键材料的多种来源，包括AWS KMS、GCE、Vault、PGP等。它提供了使用来自AWS KMS的外部密钥材料来加密和解密秘密的能力，但它也支持Shamir的秘密共享和密钥组，本质上允许关于需要什么密钥和需要解密多少密钥的策略。</p><p id="c29c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">由于SOPS使我们能够使用像AWS KMS这样的服务，我们可以控制谁有权加密和解密，但这也意味着我们可以利用AWS的实例配置文件，让机器做它们被设计为最好的事情，通过自动化使我们的生活更加轻松。</p><p id="000c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我想提请注意的最后一个特征是，一旦文件被加密，关于它如何被加密的所有元数据都是文件本身的<strong class="kd iu">部分</strong>，不需要第三方服务、数据库、隐藏目录或二级文件来知道如何解密文件。</p><p id="58b9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">最好的消息是，Flux对sop有一流的支持。</strong></p><h1 id="ce7f" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">结构</h1><p id="8220" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">在开始时，我说过适当地构建您的存储库是至关重要的。我不是自己意识到这一点的。感谢<a class="md me ep" href="https://medium.com/u/ce76492ff8b8?source=post_page-----b8174b4f4d30--------------------------------" rel="noopener" target="_blank">史蒂文·韦德</a>与我合作并分享他一路走来学到的经验。</p><p id="91e7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">结构化有两个部分。存储库中内容的布局以及要使用的存储库数量。我个人用3。一个用于定义集群运行所需的每个基础资源，一个用于处理工程团队负责的产品的所有发布，一个用于机密。我只使用专用秘密储存库的标准操作程序。</p><p id="78ea" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">使用Flux和SOPS为我们提供了前所未有的灵活性。</p><h2 id="0e0c" class="mf lb it bd lc mg mh dn lg mi mj dp lk km mk ml lo kq mm mn ls ku mo mp lw mq bi translated">存储形式</h2><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="c9fd" class="mf lb it mw b gy na nb l nc nd">|-- .sops.yaml<br/>|-- secrets<br/>    |-- dev (environment/cluster)<br/>        |-- database.yaml<br/>    |-- stg (environment/cluster)<br/>        |-- database.yaml<br/>    |-- prd (environment/cluster)<br/>        |-- database.yaml</span></pre><p id="531b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这个文件布局给了我们使用<a class="ae kz" href="https://github.com/mozilla/sops#id19" rel="noopener ugc nofollow" target="_blank"> SOPS创建规则</a>来控制文件如何加密的基础。我们可以使用不同的密钥、密钥组和阈值。它还允许我们告诉Flux在克隆和解析需要在群集上的内容时只关心特定的路径。这里有一个例子，但它不是一个工作。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="8b48" class="mf lb it mw b gy na nb l nc nd">creation_rules:<br/>- path_regex: secrets/dev/.*<br/>  encrypted_regex: "^(data|stringData)$"<br/>  kms:<br/>    arn: kms-arn<br/>    role: ksm-role<br/>- path_regex: secrets/stg/.*<br/>  encrypted_regex: "^(data|stringData)$"<br/>  kms:<br/>    arn: kms-arn<br/>    role: ksm-role<br/>- path_regex: secrets/prd/.*<br/>  encrypted_regex: "^(data|stringData)$"<br/>  kms:<br/>    arn: kms-arn<br/>    role: ksm-role</span></pre><h1 id="e608" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">缩放比例</h1><p id="c610" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">使用这种设置，我们几乎可以无限扩展这种设置。它只受存储在存储库中的数据量和为其提供服务的git服务器的限制。秘密通常不会频繁改变，但它们确实会发生变化，这就是像<a class="ae kz" href="https://github.com/stakater/Reloader" rel="noopener ugc nofollow" target="_blank"> Reloader </a>这样的额外工具的用武之地，但那是另一篇文章的内容。(感谢史蒂文·韦德<a class="md me ep" href="https://medium.com/u/ce76492ff8b8?source=post_page-----b8174b4f4d30--------------------------------" rel="noopener" target="_blank"/></p><h1 id="01ef" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">设置sop</h1><p id="74ef" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">既然我们已经讨论了布局和设计的原则，我们可以把它付诸行动了。利用sop有多种方法，但我将只介绍其中一种。将AWS KMS与多个键和一个AWS实例概要一起使用，Flux可以利用这个概要。</p><h2 id="e64a" class="mf lb it bd lc mg mh dn lg mi mj dp lk km mk ml lo kq mm mn ls ku mo mp lw mq bi translated">设置AWS</h2><p id="5ef2" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">在现实世界中，我会建议使用多个AWS帐户，并假设角色权限，但对于像这样的文章来说，这可能会变得不必要的复杂，所以我们将假设单个AWS帐户，但仍然使用3个密钥。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="68c6" class="mf lb it mw b gy na nb l nc nd">aws kms create-key</span></pre><p id="37f0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">确保你收集了ARNs以备后用。</p><p id="68ab" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">接下来，我们需要用创建规则创建我们的<code class="fe ne nf ng mw b">.sops.yaml</code>文件。在现实世界中，您希望阈值为2或更多，并且您的键至少比阈值高N+1。</p><p id="f29a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们从创建一个基本目录开始，用下面的内容创建<code class="fe ne nf ng mw b">.sops.yaml</code>文件，确保用有效的ARNs替换掉ARNs。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="6e0c" class="mf lb it mw b gy na nb l nc nd">creation_rules:<br/>- path_regex: secrets/dev/.*<br/>  encrypted_regex: "^(data|stringData)$"<br/>  shamir_threshold: 2<br/>  key_groups:<br/>    - kms:<br/>        - arn: arn:aws:kms:us-west-2:000000000000:key/b5d44bf0-7ec5-49a9-b404-bc4d8b4036fb<br/>    - kms:<br/>        - arn: arn:aws:kms:us-west-2:000000000000:key/16d44186-2393-40d9-90e1-9a2f92fd5863<br/>    - kms:<br/>        - arn: arn:aws:kms:us-west-2:000000000000:key/2120d2c1-a89e-4aeb-844f-f17ae2abd210</span></pre><p id="f7ff" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这个创建规则声明所有在<code class="fe ne nf ng mw b">secrets/dev</code>目录中的文件都将使用3个不同的密钥加密，解密阈值为2。</p><p id="974d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">接下来创建您的目录<code class="fe ne nf ng mw b">secrets/dev</code>并创建一个包含以下内容的<code class="fe ne nf ng mw b">example.yaml</code>文件</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="d3ac" class="mf lb it mw b gy na nb l nc nd">apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  name: example<br/>type: Opaque<br/>data:<br/>  username: bXktdXNlcm5hbWU=<br/>  password: bXktcGFzc3dvcmQ=</span></pre><p id="3d5f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要加密此文件，请运行以下命令</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="9d29" class="mf lb it mw b gy na nb l nc nd">sops -e -i secrets/dev/example.yaml</span></pre><p id="e187" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe ne nf ng mw b">-e</code>用于加密，<code class="fe ne nf ng mw b">-i</code>用于文件的就地修改。如果您想保持文件不变并看到加密的输出，只需省略<code class="fe ne nf ng mw b">-i</code>参数。</p><p id="46ef" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在您可以将这个设置提交到您的存储库中。</p><h1 id="19f5" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">AWS实例配置文件</h1><p id="d552" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">这个系统的好处在于Flux可以简单地利用AWS实例概要文件，通过STS来承担角色，并获得短期密钥，以便能够在集群本身上运行时解密秘密。</p><p id="4f9f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要做到这一点，您需要设置一个角色，该角色根据您使用的密钥类型拥有加密/解密和可能的生成权限，并设置您的<a class="ae kz" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html" rel="noopener ugc nofollow" target="_blank"> AWS实例来使用概要文件</a>。</p><p id="4139" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">完成此设置后，只需使用正确的CLI选项将Flux安装到集群中，然后高枕无忧，让Flux保持集群最新状态。</p><h1 id="c091" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">设置流量</h1><p id="e1b4" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">只有几件事你需要做，以确保通量运行正常。您需要启用sop，这取决于您的部署方法，可能是配置选项或CLI标志<code class="fe ne nf ng mw b">--sops</code>。您还需要指示您的Flux实例只关心默认分支中的特定路径。<code class="fe ne nf ng mw b">--git-path</code>需要被设置为secrets下的一个目录，比如<code class="fe ne nf ng mw b">--git-path=secrets/dev</code></p><h1 id="b139" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">结论</h1><p id="e1ef" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">使用这种方法可以让您更好地控制密钥材料和谁可以访问。它允许您允许AWS处理提供密钥的困难部分，以通过自动化和短期秘密来访问要解密的密钥。您可以将所有秘密保存在一个地方，以便于管理和轮换。</p></div></div>    
</body>
</html>