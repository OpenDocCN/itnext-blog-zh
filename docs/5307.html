<html>
<head>
<title>Writing Kubernetes Sample Controller in Java</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Java编写Kubernetes示例控制器</h1>
<blockquote>原文：<a href="https://itnext.io/writing-kubernetes-sample-controller-in-java-c8edc38f348f?source=collection_archive---------1-----------------------#2021-02-06">https://itnext.io/writing-kubernetes-sample-controller-in-java-c8edc38f348f?source=collection_archive---------1-----------------------#2021-02-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/35a2004ed626337e4b9343fd60bef2f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/format:webp/1*r5wTpjYqHg0wdpaGavBCKw.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">用Java编写Kubernetes示例控制器</figcaption></figure><p id="da79" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我最近在kubernetes Github repository上看到了这个示例控制器存储库。这只是实现了一个简单的控制器，用于监视CustomResourceDefinition中定义的名为<code class="fe kw kx ky kz b">Foo</code>的CustomResource。</p><div class="la lb gp gr lc ld"><a href="https://github.com/kubernetes/sample-controller" rel="noopener  ugc nofollow" target="_blank"><div class="le ab fo"><div class="lf ab lg cl cj lh"><h2 class="bd ir gy z fp li fr fs lj fu fw ip bi translated">kubernetes/样品控制器</h2><div class="lk l"><h3 class="bd b gy z fp li fr fs lj fu fw dk translated">这个库实现了一个简单的控制器，用于监视用CustomResourceDefinition定义的Foo资源…</h3></div><div class="ll l"><p class="bd b dl z fp li fr fs lj fu fw dk translated">github.com</p></div></div><div class="lm l"><div class="ln l lo lp lq lm lr js ld"/></div></div></a></div><p id="b54f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我认为使用<a class="ae ls" href="https://github.com/fabric8io/kubernetes-client" rel="noopener ugc nofollow" target="_blank">fabric 8 Kubernetes Client</a>将这个用GoLang编写的示例移植到Java是一个好主意，以便了解如何用Java来执行这些操作:</p><ul class=""><li id="bd65" class="lt lu iq ka b kb kc kf kg kj lv kn lw kr lx kv ly lz ma mb bi translated">如何使用CustomResourceDefinition注册一个类型为<code class="fe kw kx ky kz b">Foo</code>的新定制资源(定制资源类型)。</li><li id="c435" class="lt lu iq ka b kb mc kf md kj me kn mf kr mg kv ly lz ma mb bi translated">如何创建/获取/列出新资源类型<code class="fe kw kx ky kz b">Foo</code>的实例。</li><li id="98f9" class="lt lu iq ka b kb mc kf md kj me kn mf kr mg kv ly lz ma mb bi translated">如何在处理创建/更新/删除事件的资源上设置控制器。</li></ul><h1 id="ae84" class="mh mi iq bd mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne bi translated">我们要建造什么？</h1><p id="4061" class="pw-post-body-paragraph jy jz iq ka b kb nf kd ke kf ng kh ki kj nh kl km kn ni kp kq kr nj kt ku kv ij bi translated">如果你还不熟悉<code class="fe kw kx ky kz b">kubernetes/sample-controller</code>；让我给你介绍一下它的功能。我们将为CustomResource <code class="fe kw kx ky kz b">Foo</code>构建一个简单的控制器，如下所示:</p><pre class="nk nl nm nn gt no kz np nq aw nr bi"><span id="0192" class="ns mi iq kz b gy nt nu l nv nw"><strong class="kz ir">apiVersion:</strong> samplecontroller.k8s.io/v1alpha1<br/><strong class="kz ir">kind:</strong> Foo<br/><strong class="kz ir">metadata:</strong><br/>  <strong class="kz ir">name:</strong> example-bar<br/><strong class="kz ir">spec:</strong><br/>  <strong class="kz ir">deploymentName:</strong> example-bar-deploy<br/>  <strong class="kz ir">replicas:</strong> 1</span></pre><p id="364c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">每当创建一个<code class="fe kw kx ky kz b">Foo</code>资源时，它会在<code class="fe kw kx ky kz b">Foo</code> CustomResource的规范中创建一个子<code class="fe kw kx ky kz b">Deployment.</code>,我们指定希望创建的子<code class="fe kw kx ky kz b">Deployment</code>的名称以及这个<code class="fe kw kx ky kz b">Deployment</code>应该拥有的副本数量。当我们删除资源<code class="fe kw kx ky kz b">Foo</code>时，子资源<code class="fe kw kx ky kz b">Deployment</code>也应该被删除。</p><p id="a860" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">每当<code class="fe kw kx ky kz b">Foo</code>资源的规格发生变化，子<code class="fe kw kx ky kz b">Deployment</code>就会相应地更新。</p><h1 id="85e5" class="mh mi iq bd mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne bi translated">项目结构:</h1><p id="06b1" class="pw-post-body-paragraph jy jz iq ka b kb nf kd ke kf ng kh ki kj nh kl km kn ni kp kq kr nj kt ku kv ij bi translated">让我们看看我们的项目结构。你可以在<a class="ae ls" href="https://github.com/rohanKanojia/sample-controller-java" rel="noopener ugc nofollow" target="_blank">rohankanojia/sample-controller-Java</a>找到完整的源代码。这是它的样子:</p><pre class="nk nl nm nn gt no kz np nq aw nr bi"><span id="acac" class="ns mi iq kz b gy nt nu l nv nw"><strong class="kz ir">.</strong> <br/>├── <a class="ae ls" href="https://github.com/rohanKanojia/sample-controller-java/blob/master/pom.xml" rel="noopener ugc nofollow" target="_blank">pom.xml</a> <br/>├── README.md <br/>└── <strong class="kz ir">src</strong> <br/>    ├── <strong class="kz ir">main</strong> <br/>    │   ├── <strong class="kz ir">java</strong> <br/>    │   │   └── <strong class="kz ir">io</strong> <br/>    │   │       └── <strong class="kz ir">fabric8</strong> <br/>    │   │           └── <strong class="kz ir">samplecontroller</strong> <br/>    │   │               ├── <strong class="kz ir">api</strong> <br/>    │   │               │   └── <strong class="kz ir">model</strong> <br/>    │   │               │       └── <strong class="kz ir">v1alpha1</strong> <br/>    │   │               │           ├── <a class="ae ls" href="https://github.com/rohanKanojia/sample-controller-java/blob/master/src/main/java/io/fabric8/samplecontroller/api/model/v1alpha1/Foo.java" rel="noopener ugc nofollow" target="_blank">Foo.java</a><br/>    │   │               │           ├── <a class="ae ls" href="https://github.com/rohanKanojia/sample-controller-java/blob/master/src/main/java/io/fabric8/samplecontroller/api/model/v1alpha1/FooSpec.java" rel="noopener ugc nofollow" target="_blank">FooSpec.java</a> <br/>    │   │               │           └── <a class="ae ls" href="https://github.com/rohanKanojia/sample-controller-java/blob/master/src/main/java/io/fabric8/samplecontroller/api/model/v1alpha1/FooStatus.java" rel="noopener ugc nofollow" target="_blank">FooStatus.java</a> <br/>    │   │               ├── <strong class="kz ir">controller</strong> <br/>    │   │               │   └── <a class="ae ls" href="https://github.com/rohanKanojia/sample-controller-java/blob/master/src/main/java/io/fabric8/samplecontroller/controller/SampleController.java" rel="noopener ugc nofollow" target="_blank">SampleController.java</a> <br/>    │   │               └── <a class="ae ls" href="https://github.com/rohanKanojia/sample-controller-java/blob/master/src/main/java/io/fabric8/samplecontroller/SampleControllerMain.java" rel="noopener ugc nofollow" target="_blank">SampleControllerMain.java</a> <br/>    │   └── <strong class="kz ir">resources</strong> <br/>    │       ├── crd.yaml <br/>    │       ├── cr.yaml <br/>    │       └── example-foo.yml <br/>    └── <strong class="kz ir">test</strong> <br/>        └── <strong class="kz ir">java</strong> <br/>            └── <strong class="kz ir">io</strong> <br/>                └── <strong class="kz ir">fabric8</strong> <br/>                    └── <strong class="kz ir">samplecontroller</strong> <br/>                        └── <strong class="kz ir">controller</strong> <br/>                            └── SampleControllerTest.java <br/> <br/>17 directories, 14 files</span></pre><p id="886f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kw kx ky kz b">Foo.java</code>、<code class="fe kw kx ky kz b">FooList.java</code>、<code class="fe kw kx ky kz b">FooSpec.java</code>和<code class="fe kw kx ky kz b">FooStatus.java</code>是我们<code class="fe kw kx ky kz b">Foo</code> CustomResource的模型类。你唯一需要关心的类是<code class="fe kw kx ky kz b">SampleController</code>，它包含了控制器的主要逻辑。<code class="fe kw kx ky kz b">SampleControllerMain</code>是这个项目的驱动程序类，它初始化<code class="fe kw kx ky kz b">KubernetesClient</code>并委托给<code class="fe kw kx ky kz b">SampleController</code>。</p><p id="5231" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们看一下project的<code class="fe kw kx ky kz b">pom.xml</code>，看看我使用的依赖项和其他插件:</p><figure class="nk nl nm nn gt jr"><div class="bz fp l di"><div class="nx ny l"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">pom.xml for project</figcaption></figure><p id="6f27" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以看到我使用的唯一主要依赖项是<a class="ae ls" href="https://search.maven.org/artifact/io.fabric8/kubernetes-client/5.0.1/jar" rel="noopener ugc nofollow" target="_blank"> Fabric8 Kubernetes客户端</a>和slf4j-simple(用于日志记录)。其余的依赖项是JUnit5测试依赖项和<a class="ae ls" href="https://search.maven.org/artifact/io.fabric8/kubernetes-server-mock/5.0.1/jar" rel="noopener ugc nofollow" target="_blank"> Fabric8 Kubernetes模拟服务器</a>，我在编写测试时用它来模拟Kubernetes API。</p><p id="8ff4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我使用Maven Assembly插件来创建一个包含所有依赖项的可执行jar。对于部署到Kubernetes，我使用的是<a class="ae ls" href="https://github.com/eclipse/jkube" rel="noopener ugc nofollow" target="_blank">Eclipse JKube</a>T25】Kubernetes Maven插件。</p><h1 id="f784" class="mh mi iq bd mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne bi translated">正在为<code class="fe kw kx ky kz b">Foo</code>资源编写POJOs:</h1><p id="4e95" class="pw-post-body-paragraph jy jz iq ka b kb nf kd ke kf ng kh ki kj nh kl km kn ni kp kq kr nj kt ku kv ij bi translated">在编写控制器之前，我们需要有一个模型，控制器需要基于这个模型。在使用Fabric8 Kubernetes客户端时，我们需要为<code class="fe kw kx ky kz b">Foo</code> CustomResource提供POJOs，用于Kubernetes API服务器请求和响应的序列化/反序列化。</p><p id="d556" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们来看看它们，您可以看到使用Fabric8 Kubernetes客户端创建CustomResource模型是多么容易。我们正在通过注释提供<code class="fe kw kx ky kz b">Foo</code>customresourcedinfinition相关信息，如<code class="fe kw kx ky kz b">apiGroup</code>、<code class="fe kw kx ky kz b">apiVersion</code>、<code class="fe kw kx ky kz b">plural</code>等。</p><ul class=""><li id="9899" class="lt lu iq ka b kb kc kf kg kj lv kn lw kr lx kv ly lz ma mb bi translated"><code class="fe kw kx ky kz b">Foo.java</code>:</li></ul><figure class="nk nl nm nn gt jr"><div class="bz fp l di"><div class="nx ny l"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">CustomResource的Foo类</figcaption></figure><ul class=""><li id="1cff" class="lt lu iq ka b kb kc kf kg kj lv kn lw kr lx kv ly lz ma mb bi translated"><code class="fe kw kx ky kz b">FooSpec.java</code>:</li></ul><figure class="nk nl nm nn gt jr"><div class="bz fp l di"><div class="nx ny l"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">代表Foo CustomResource规范的FooSpec类</figcaption></figure><ul class=""><li id="1cd4" class="lt lu iq ka b kb kc kf kg kj lv kn lw kr lx kv ly lz ma mb bi translated"><code class="fe kw kx ky kz b">FooStatus.java</code>:</li></ul><figure class="nk nl nm nn gt jr"><div class="bz fp l di"><div class="nx ny l"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">代表Foo CustomResource状态的FooStatus类</figcaption></figure><h1 id="98ca" class="mh mi iq bd mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne bi translated">正在为应用程序编写主类以进行初始化:</h1><p id="ca51" class="pw-post-body-paragraph jy jz iq ka b kb nf kd ke kf ng kh ki kj nh kl km kn ni kp kq kr nj kt ku kv ij bi translated">我们将拥有<code class="fe kw kx ky kz b">SampleControllerMain</code>，它将创建一个<code class="fe kw kx ky kz b">KubernetesClient</code>的实例(为了与Kubernetes API交互)并为<code class="fe kw kx ky kz b">Foo</code>和<code class="fe kw kx ky kz b">Deployment</code>资源创建<code class="fe kw kx ky kz b">SharedIndexInformer</code>实例。它还将为<code class="fe kw kx ky kz b">Foo</code>资源设置专门的类型化客户端。</p><p id="00e4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成所有初始化后，它将创建一个<code class="fe kw kx ky kz b">SampleController</code>类的实例，并调用<code class="fe kw kx ky kz b">sampleController.create()</code>为<code class="fe kw kx ky kz b">Foo </code>或<code class="fe kw kx ky kz b">Deployment</code> SharedIndexInformer实例设置事件处理程序。然后它会调用<code class="fe kw kx ky kz b">sampleController.run()</code>来启动控制器。</p><figure class="nk nl nm nn gt jr"><div class="bz fp l di"><div class="nx ny l"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">SampleControllerMain:我们的应用程序的驱动类</figcaption></figure><h1 id="e681" class="mh mi iq bd mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne bi translated">正在编写SampleController类:</h1><p id="664e" class="pw-post-body-paragraph jy jz iq ka b kb nf kd ke kf ng kh ki kj nh kl km kn ni kp kq kr nj kt ku kv ij bi translated">现在我们来看看这个控制器的主类:<code class="fe kw kx ky kz b">SampleController</code>。让我们来看一看，稍后我会解释重要的方法。它看起来是这样的:</p><figure class="nk nl nm nn gt jr"><div class="bz fp l di"><div class="nx ny l"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">SampleController:包含控制器逻辑的主类</figcaption></figure><p id="1b72" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好的，让我们试着理解这门课在做什么。我们有一个<code class="fe kw kx ky kz b">BlockingQueue&lt;String&gt;</code>，它为控制器需要处理的所有项目维护一个队列。<code class="fe kw kx ky kz b">SharedIndexInformer</code>方法中的事件处理程序在添加、更新或删除事件时填充该队列。</p><p id="ec12" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe kw kx ky kz b">run()</code>方法中，我们检查队列是否包含一个条目。如果它包含一个项目，我们尝试获取与从队列中检索的项目相对应的<code class="fe kw kx ky kz b">Foo</code>资源。如果项目似乎是有效的，它被发送到<code class="fe kw kx ky kz b">reconcile()</code>方法进行处理。</p><p id="0809" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kw kx ky kz b">reconcile()</code>是这个类的核心方法，它基本上包含了这个控制器的核心逻辑。如果你浏览它，它似乎在做以下事情:</p><ol class=""><li id="5d55" class="lt lu iq ka b kb kc kf kg kj lv kn lw kr lx kv nz lz ma mb bi translated">检查<code class="fe kw kx ky kz b">Deployment</code>名称并验证它是否为空</li><li id="ba47" class="lt lu iq ka b kb mc kf md kj me kn mf kr mg kv nz lz ma mb bi translated">从Kubernetes APIServer获取与该名称对应的<code class="fe kw kx ky kz b">Deployment</code>。如果没有这样的<code class="fe kw kx ky kz b">Deployment</code>；通过调用<code class="fe kw kx ky kz b">createDeployments()</code>方法创建一个新的<code class="fe kw kx ky kz b">Deployment</code>。</li><li id="81b8" class="lt lu iq ka b kb mc kf md kj me kn mf kr mg kv nz lz ma mb bi translated">检查从Kubernetes APIServer接收的<code class="fe kw kx ky kz b">Deployment</code>是否实际上属于<code class="fe kw kx ky kz b">Foo</code>资源。如果没有，抛出警告。</li><li id="4d74" class="lt lu iq ka b kb mc kf md kj me kn mf kr mg kv nz lz ma mb bi translated">检查收到的<code class="fe kw kx ky kz b">Deployment</code>是否与<code class="fe kw kx ky kz b">foo.getSpec().getReplicas()</code>中提供的副本数量相同。如果没有，更新<code class="fe kw kx ky kz b">Deployment</code>以获得与<code class="fe kw kx ky kz b">Foo</code>中提供的相同数量的副本</li><li id="e166" class="lt lu iq ka b kb mc kf md kj me kn mf kr mg kv nz lz ma mb bi translated">一旦一切完成，更新<code class="fe kw kx ky kz b">Foo</code>资源的<code class="fe kw kx ky kz b">.status</code>域以反映当前状态。</li></ol><p id="838e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">其余的方法只是各种操作的辅助方法，比如创建子<code class="fe kw kx ky kz b">Deployment</code>，更新<code class="fe kw kx ky kz b">Foo</code>状态等等。</p><h1 id="7a09" class="mh mi iq bd mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne bi translated">在Kubernetes外部运行样品控制器:</h1><p id="e42b" class="pw-post-body-paragraph jy jz iq ka b kb nf kd ke kf ng kh ki kj nh kl km kn ni kp kq kr nj kt ku kv ij bi translated">您可以用这个简单的命令编译这个项目:</p><pre class="nk nl nm nn gt no kz np nq aw nr bi"><span id="45a8" class="ns mi iq kz b gy nt nu l nv nw"><strong class="kz ir"><em class="oa">sample-controller-java : $</em></strong> mvn clean install</span></pre><p id="2219" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了运行控制器，您需要能够访问Kubernetes集群。您既可以登录到您的Kubernetes集群，也可以使用一些本地的Kubernetes集群。我用的是<a class="ae ls" href="https://minikube.sigs.k8s.io/docs/" rel="noopener ugc nofollow" target="_blank">minikube；</a>我使用以下命令启动了Kubernetes集群:</p><pre class="nk nl nm nn gt no kz np nq aw nr bi"><span id="1795" class="ns mi iq kz b gy nt nu l nv nw"><strong class="kz ir"><em class="oa">sample-controller-java : $</em></strong> minikube start <br/>  minikube v1.15.0 on Fedora 33 <br/>✨  Using the kvm2 driver based on existing profile <br/>  Starting control plane node minikube in cluster minikube <br/>  Restarting existing kvm2 VM for "minikube" ... <br/>  Preparing Kubernetes v1.19.4 on Docker 19.03.13 ... <br/>  Verifying Kubernetes components... <br/>  Enabled addons: storage-provisioner, default-storageclass <br/>  Done! kubectl is now configured to use "minikube" cluster and "default" namespace by default</span></pre><p id="398c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您需要将<code class="fe kw kx ky kz b">Foo</code>CustomResourceDefinition(CRD)安装到您的Kubernetes集群中(您需要有ClusterAdmin特权来完成这项工作):</p><pre class="nk nl nm nn gt no kz np nq aw nr bi"><span id="ebb8" class="ns mi iq kz b gy nt nu l nv nw"><strong class="kz ir"><em class="oa">sample-controller-java : $</em></strong> kubectl create -f src/main/resources/crd.yaml  <br/><strong class="kz ir">Warning:</strong> apiextensions.k8s.io/v1beta1 CustomResourceDefinition is deprecated in v1.16+, unavailable in v1.22+; <br/>use apiextensions.k8s.io/v1 CustomResourceDefinition <br/>customresourcedefinition.apiextensions.k8s.io/foos.samplecontroller.k8s.io created</span></pre><p id="c657" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦你创造了CRD。您可以通过执行jar来简单地运行控制器:</p><pre class="nk nl nm nn gt no kz np nq aw nr bi"><span id="7d09" class="ns mi iq kz b gy nt nu l nv nw"><strong class="kz ir"><em class="oa">sample-controller-java : $</em></strong> java -jar target/sample-controller-java-1.0-SNAPSHOT-jar-with-dependencies.jar<br/>[main] INFO io.fabric8.samplecontroller.SampleControllerMain - Using namespace : default <br/>[main] INFO io.fabric8.samplecontroller.SampleControllerMain - Starting Foo Controller <br/>[main] INFO io.fabric8.samplecontroller.controller.SampleController - Starting Foo controller <br/>[main] INFO io.fabric8.samplecontroller.controller.SampleController - Waiting for informer caches to sync <br/>[informer-controller-Foo] INFO io.fabric8.kubernetes.client.informers.cache.Controller - informer#Controller: ready to run resync and reflector runnable <br/>[informer-controller-Deployment] INFO io.fabric8.kubernetes.client.informers.cache.Controller - informer#Controller: ready to run resync and reflector runnable <br/>[informer-controller-Foo] INFO io.fabric8.kubernetes.client.informers.cache.Reflector - Started ReflectorRunnable watch for class io.fabric8.samplecontroller.api.model.v1alpha1.Foo <br/>[informer-controller-Deployment] INFO io.fabric8.kubernetes.client.informers.cache.Reflector - Started ReflectorRunnable watch for class io.fabric8.kubernetes.api.model.apps.Deployment <br/>[informer-controller-Foo] WARN io.fabric8.kubernetes.client.internal.VersionUsageUtils - The client is using resource type 'foos' with unstable version 'v1alpha1' <br/>[pool-1-thread-1] INFO io.fabric8.samplecontroller.controller.SampleController - handleDeploymentObject(coredns) <br/>[main] INFO io.fabric8.samplecontroller.controller.SampleController - trying to fetch item from workqueue... <br/>[main] INFO io.fabric8.samplecontroller.controller.SampleController - Work Queue is empty <br/>[pool-1-thread-1] ERROR io.fabric8.kubernetes.client.informers.cache.ProcessorListener - Failed invoking null event handler: null</span></pre><p id="8bf0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尝试创建一个<code class="fe kw kx ky kz b">Foo</code>资源，看看是否创建了一些部署:</p><pre class="nk nl nm nn gt no kz np nq aw nr bi"><span id="6d97" class="ns mi iq kz b gy nt nu l nv nw"><strong class="kz ir"><em class="oa">sample-controller-java : $</em></strong> kubectl create -f src/main/resources/ex<br/>ample-foo.yml  <br/>foo.samplecontroller.k8s.io/example-bar created</span></pre><p id="e247" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就我而言，我能够看到它。下面是我的结果截图:</p><figure class="nk nl nm nn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="oc od di oe bf of"><div class="gh gi ob"><img src="../Images/d28c9f9800f9386db35e7beb4acf3c03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NBqNAINgPdGEjNu5piTgTQ.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">创建Foo CustomResource的演示输出</figcaption></figure><h1 id="e369" class="mh mi iq bd mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne bi translated">将样品控制器作为Kubernetes Pod运行:</h1><p id="cbb5" class="pw-post-body-paragraph jy jz iq ka b kb nf kd ke kf ng kh ki kj nh kl km kn ni kp kq kr nj kt ku kv ij bi translated">为了在一个容器里运行我们的控制器。我们将使用<a class="ae ls" href="https://www.eclipse.org/jkube/" rel="noopener ugc nofollow" target="_blank">Eclipse JKube；</a>它允许我们将应用程序封装到映像中，并允许根据项目的依赖关系或配置生成个性化的Kubernetes清单。</p><p id="662c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将使用<code class="fe kw kx ky kz b">default</code> <code class="fe kw kx ky kz b">ServiceAccount</code>从Pod内部与Kubernetes API进行交互。我们需要为<code class="fe kw kx ky kz b">ServiceAccount</code>提供必要的特权。我只是用这个命令给<code class="fe kw kx ky kz b">ServiceAccount</code>授予集群管理员权限:</p><pre class="nk nl nm nn gt no kz np nq aw nr bi"><span id="033a" class="ns mi iq kz b gy nt nu l nv nw"><strong class="kz ir"><em class="oa">sample-controller-java : $ </em></strong>kubectl create clusterrolebinding default-pod --clusterrole cluster-admin --servicea<br/>ccount=default:default <br/>clusterrolebinding.rbac.authorization.k8s.io/default-pod created</span></pre><p id="821c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您想使用自己的<code class="fe kw kx ky kz b">ServiceAccount</code>，您可能需要配置Eclipse JKube来使用不同的<code class="fe kw kx ky kz b">ServiceAccount</code>，方法是提供一个部署<a class="ae ls" href="https://www.eclipse.org/jkube/docs/kubernetes-maven-plugin#_resource_fragments" rel="noopener ugc nofollow" target="_blank">资源片段</a>，并根据您的用例为这个不同的<code class="fe kw kx ky kz b">ServiceAccount</code>编写<code class="fe kw kx ky kz b">Role</code> / <code class="fe kw kx ky kz b">RoleBinding</code>或<code class="fe kw kx ky kz b">ClusterRole</code> / <code class="fe kw kx ky kz b">ClusterRoleBinding</code>。</p><p id="f5fd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为，我用的是minikube。我将在minikube的本地docker守护进程中创建一个docker映像。我将公开本地docker守护进程，并发布Eclipse JKube将应用程序部署到minikube的目标:</p><pre class="nk nl nm nn gt no kz np nq aw nr bi"><span id="d176" class="ns mi iq kz b gy nt nu l nv nw"><strong class="kz ir"><em class="oa">sample-controller-java : $</em></strong> eval $(minikube -p minikube docker-env) <br/><strong class="kz ir"><em class="oa">sample-controller-java : $ </em></strong>mvn k8s:build k8s:resource k8s:apply</span></pre><p id="20d8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你没有使用minikube，你可能需要做一些额外的步骤来把这个图像推送到一些外部注册表。您需要根据注册表和您在maven属性中的用户名来更改图像名称，如下所示:</p><pre class="nk nl nm nn gt no kz np nq aw nr bi"><span id="58e9" class="ns mi iq kz b gy nt nu l nv nw"><strong class="kz ir">&lt;jkube.generator.name&gt;</strong><br/>  quay.io/rohankanojia/sample-controller-java:${project.version}<strong class="kz ir">&lt;/jkube.generator.name&gt;</strong></span></pre><p id="08b5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后使用以下目标构建映像并将其推送到注册表:</p><pre class="nk nl nm nn gt no kz np nq aw nr bi"><span id="953b" class="ns mi iq kz b gy nt nu l nv nw">mvn k8s:build k8s:push</span></pre><p id="2ac9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦构建并推送映像，您就可以简单地发布资源并应用目标来部署应用程序:</p><pre class="nk nl nm nn gt no kz np nq aw nr bi"><span id="13f4" class="ns mi iq kz b gy nt nu l nv nw">mvn k8s:resource k8s:apply</span></pre><p id="65d8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后你可以用<code class="fe kw kx ky kz b">kubectl get pods -w</code>检查你的控制器是否在运行。如果一切正常，它将处于运行状态。之后，您可以尝试创建一个<code class="fe kw kx ky kz b">Foo</code> CustomResource实例，就像我们在上面的外部Kubernetes小节中所做的那样。对我来说，一切都如预期的那样:</p><figure class="nk nl nm nn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="oc od di oe bf of"><div class="gh gi og"><img src="../Images/f874c2d4861d41c3252d41df15c350e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*31--LZBeMBIw6mIjBRp3Ow.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">使用<a class="ae ls" href="https://github.com/eclipse/jkube" rel="noopener ugc nofollow" target="_blank">Eclipse jbuibe</a>将样本控制器部署到Kubernetes</figcaption></figure><h1 id="7990" class="mh mi iq bd mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne bi translated">结论:</h1><p id="fb35" class="pw-post-body-paragraph jy jz iq ka b kb nf kd ke kf ng kh ki kj nh kl km kn ni kp kq kr nj kt ku kv ij bi translated">再次感谢你花时间阅读这篇博客！我希望我能够帮助您了解如何使用Fabric8 Kubernetes客户端用Java编写Kubernetes控制器。您可以在这个资源库中找到关于这个博客的所有源代码:</p><div class="la lb gp gr lc ld"><a href="https://github.com/rohanKanojia/sample-controller-java" rel="noopener  ugc nofollow" target="_blank"><div class="le ab fo"><div class="lf ab lg cl cj lh"><h2 class="bd ir gy z fp li fr fs lj fu fw ip bi translated">rohanKanojia/sample-controller-Java</h2><div class="lk l"><h3 class="bd b gy z fp li fr fs lj fu fw dk translated">这个库实现了一个简单的控制器，用于监视用CustomResourceDefinition定义的Foo资源…</h3></div><div class="ll l"><p class="bd b dl z fp li fr fs lj fu fw dk translated">github.com</p></div></div><div class="lm l"><div class="oh l lo lp lq lm lr js ld"/></div></div></a></div><h2 id="1707" class="ns mi iq bd mj oi oj dn mn ok ol dp mr kj om on mv kn oo op mz kr oq or nd os bi translated">加入我们:</h2><p id="f555" class="pw-post-body-paragraph jy jz iq ka b kb nf kd ke kf ng kh ki kj nh kl km kn ni kp kq kr nj kt ku kv ij bi translated">如果您喜欢我们的项目，请随时通过以下渠道加入我们，成为我们不断发展的社区中的一员:</p><ul class=""><li id="f083" class="lt lu iq ka b kb kc kf kg kj lv kn lw kr lx kv ly lz ma mb bi translated">当某些东西不能按预期工作时，创建<a class="ae ls" href="https://github.com/fabric8io/kubernetes-client/issues" rel="noopener ugc nofollow" target="_blank"> Github问题</a></li><li id="f4c9" class="lt lu iq ka b kb mc kf md kj me kn mf kr mg kv ly lz ma mb bi translated">向我们发送<a class="ae ls" href="https://github.com/fabric8io/kubernetes-client/pulls" rel="noopener ugc nofollow" target="_blank">拉请求</a>以修复错误/添加增强功能</li><li id="f3a2" class="lt lu iq ka b kb mc kf md kj me kn mf kr mg kv ly lz ma mb bi translated">如有疑问，请通过我们的<a class="ae ls" href="https://gitter.im/fabric8io/kubernetes-client?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge" rel="noopener ugc nofollow" target="_blank"> Gitter频道</a>与我们聊天</li><li id="0a70" class="lt lu iq ka b kb mc kf md kj me kn mf kr mg kv ly lz ma mb bi translated">在<a class="ae ls" href="https://twitter.com/fabric8io/" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上关注我们</li></ul></div></div>    
</body>
</html>