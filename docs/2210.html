<html>
<head>
<title>I cho, cho, choose you container image Part 2.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我秋，秋，选择你集装箱图像第2部分。</h1>
<blockquote>原文：<a href="https://itnext.io/i-cho-cho-choose-you-container-image-part-2-44b45e47a1f7?source=collection_archive---------8-----------------------#2019-04-16">https://itnext.io/i-cho-cho-choose-you-container-image-part-2-44b45e47a1f7?source=collection_archive---------8-----------------------#2019-04-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/d26efe9dc7b708cc3d83ec467012910d.png" data-original-src="https://miro.medium.com/v2/resize:fit:916/format:webp/1*hylJ1hGCcixiY4ubbhpkGA.jpeg"/></div></figure><p id="1b5d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这个系列的第一部分<a class="ae ks" href="https://medium.com/@scott.coulton/i-cho-cho-chose-you-container-image-part-1-fa6671d9ae1f" rel="noopener">中，我们看了可以用作基本容器图像的不同类型的图像。在这个系列的第二篇文章中，我们将在我们的基础图片上添加一个真实的应用程序。正如我们之前的帖子中提到的，我们将选择一种编译语言，在这种情况下，它将是</a><a class="ae ks" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Golang </a>。在本系列的下一篇文章中，我们将探讨一种动态语言(Python)。</p><p id="188e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以我们将采用一个非常简单的Golang应用程序,它基本上是为一个静态HTML文件服务的。不要太沉迷于应用程序的构造。最重要的是，它可以编译，体积小，构建速度快，所以我们可以看到什么样的容器基础映像最适合使用。</p><p id="721f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在我们选择从哪种操作系统开始之前，对于编译语言来说，一个最佳实践是Docker多阶段构建。多阶段构建给我们的是在一个容器中构建二进制文件的能力。这通常也包括所有的构建工具。然后将二进制文件复制到一个新的容器中。因此，抛弃运行生产应用程序所需的所有构建工具和不需要的包。有关多阶段构建的更多信息，请访问<a class="ae ks" href="https://docs.docker.com/develop/develop-images/multistage-build/" rel="noopener ugc nofollow" target="_blank">此处</a></p><p id="5717" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于所有不同的基础映像，我们将使用多阶段构建来尽量保持我们的可部署映像尽可能小。因此，在每个docker文件中，我们将在构建容器中编译Go二进制文件，然后使用多阶段构建将其移动到最后一个容器，这将是我们的部署工件。</p><p id="9df9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，我们将选择的第一个基本容器映像是完整的操作系统，因为如果您不熟悉容器，这将是最容易启动和运行的。</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="d0a4" class="lc ld iq ky b gy le lf l lg lh">FROM golang:1.11-stretch as build<br/><br/>WORKDIR /go/src/github.com/scottyc/webapp<br/><br/>COPY web.go web.go<br/><br/>RUN CGO_ENABLED=0 GOOS=linux go build -o ./bin/webapp github.com/scottyc/webapp<br/><br/><br/>FROM debian:stretch<br/><br/>RUN mkdir -p /web/static/ <br/><br/>COPY --from=build /go/src/github.com/scottyc/webapp/bin/webapp /usr/bin<br/>COPY index.html /web/static/index.html<br/><br/>WORKDIR /web<br/><br/>EXPOSE 3000<br/><br/>ENTRYPOINT ["webapp"]</span></pre><p id="fa82" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这个docker文件将生成一个图像，该图像是<code class="fe li lj lk ky b">107mb</code>并且记得在第一个帖子中图像中有一些严重的漏洞。现在让我们来看看超薄操作系统映像。</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="9a64" class="lc ld iq ky b gy le lf l lg lh">FROM golang:1.11-stretch as build<br/><br/>WORKDIR /go/src/github.com/scottyc/webapp<br/><br/>COPY web.go web.go<br/><br/>RUN CGO_ENABLED=0 GOOS=linux go build -o ./bin/webapp github.com/scottyc/webapp<br/><br/><br/>FROM debian:stretch-slim<br/><br/>RUN mkdir -p /web/static/ <br/><br/>COPY --from=build /go/src/github.com/scottyc/webapp/bin/webapp /usr/bin<br/>COPY index.html /web/static/index.html<br/><br/>WORKDIR /web<br/><br/>EXPOSE 3000<br/><br/>ENTRYPOINT ["webapp"]</span></pre><p id="36d4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在你会注意到，我们使用完整的操作系统作为构建映像，这完全没问题，因为我们将丢弃它，这个构建将产生一个大小为<code class="fe li lj lk ky b">61.9mb</code>的映像。因此，在不改变任何应用程序代码的情况下，这是一个相当大的减少。我们仍然需要记住映像中有易受攻击的包。现在让我们试试Alpine Linux。</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="61d7" class="lc ld iq ky b gy le lf l lg lh">FROM golang:1.11.2-alpine3.8 as build<br/><br/>WORKDIR /go/src/github.com/scottyc/webapp<br/><br/>COPY web.go web.go<br/><br/>RUN CGO_ENABLED=0 GOOS=linux go build -o ./bin/webapp github.com/scottyc/webapp<br/><br/><br/>FROM alpine:3.8<br/><br/>RUN mkdir -p /web/static/ <br/><br/>COPY --from=build /go/src/github.com/scottyc/webapp/bin/webapp /usr/bin<br/>COPY index.html /web/static/index.html<br/><br/>WORKDIR /web<br/><br/>EXPOSE 3000<br/><br/>ENTRYPOINT ["webapp"]</span></pre><p id="3873" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在这个构建产生了一个大小为<code class="fe li lj lk ky b">11mb</code>的映像，并且在映像中没有易受攻击的包。如您所见，迁移到Alpine极大地减小了图像大小，并增强了我们的安全态势。最后但同样重要的是，让我们看看scratch。</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="a104" class="lc ld iq ky b gy le lf l lg lh">FROM golang:1.11.2-alpine3.8 as build</span><span id="40a7" class="lc ld iq ky b gy ll lf l lg lh">WORKDIR /go/src/github.com/scottyc/webapp</span><span id="aa5e" class="lc ld iq ky b gy ll lf l lg lh">COPY web.go web.go<br/>COPY index.html /web/static/index.html</span><span id="0616" class="lc ld iq ky b gy ll lf l lg lh">RUN CGO_ENABLED=0 GOOS=linux go build -o ./bin/webapp github.com/scottyc/webapp</span><span id="0194" class="lc ld iq ky b gy ll lf l lg lh">FROM scratch</span><span id="3b9c" class="lc ld iq ky b gy ll lf l lg lh">COPY --from=build /go/src/github.com/scottyc/webapp/bin/webapp /usr/bin/webapp<br/>COPY --from=build /web/static/index.html /web/static/index.html</span><span id="d1be" class="lc ld iq ky b gy ll lf l lg lh">EXPOSE 3000</span><span id="3e63" class="lc ld iq ky b gy ll lf l lg lh">ENTRYPOINT ["/usr/bin/webapp"]</span></pre><p id="dd8f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在你会注意到我们使用Alpine来构建我们的二进制文件，因为scratch没有工具或包管理器。因此，我们将使用Alpine中的构建工具，然后将二进制文件移动到暂存容器中。暂存容器将只包含Go二进制文件。这将产生具有最佳安全状态的图像尺寸<code class="fe li lj lk ky b">6.59mb</code>。因此，正如您所看到的，通过选择不同的容器基础映像，我们用相同的应用程序代码产生了非常不同的结果。如果你想试驾这些图片，请访问我的<a class="ae ks" href="https://github.com/scotty-c/container-image-examples" rel="noopener ugc nofollow" target="_blank"> Github页面</a>。在本系列的下一篇文章中，我们将关注动态语言并使用Python。</p><p id="9f67" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了进一步了解容器或Kubernetes，请查看<a class="ae ks" href="https://github.com/scotty-c/kubernetes-on-azure-workshop" rel="noopener ugc nofollow" target="_blank">我的OSS工作室</a></p></div></div>    
</body>
</html>