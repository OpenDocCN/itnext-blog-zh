<html>
<head>
<title>Handling “Failure at scale” in Azure Functions triggered by IoT Hub.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">处理物联网中心触发的Azure功能中的“大规模故障”。</h1>
<blockquote>原文：<a href="https://itnext.io/handling-failures-in-azure-functions-5ac6ef6e0e34?source=collection_archive---------2-----------------------#2019-10-15">https://itnext.io/handling-failures-in-azure-functions-5ac6ef6e0e34?source=collection_archive---------2-----------------------#2019-10-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a6aa" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">或者如何处理异常并重新运行失败的消息。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4221d8beb462a07deea58dc0bdfc7e38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ihM52tFuQRrchngsGanMZw.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://twitter.com/SlonPics" rel="noopener ugc nofollow" target="_blank">https://twitter.com/SlonPics</a></figcaption></figure><p id="455a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">无服务器解决方案的优势之一是“规模化性能”因此，如果出现问题，你可能会得到“大规模失败”。因此，尽早为Azure Functions项目引入错误处理至关重要。</p><blockquote class="lv lw lx"><p id="4caf" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated"><em class="it">TL；DR；我将解释如何处理Azure IoT Hub触发的Azure函数中的异常和错误。以及如何设置适当的通知和重新运行失败的消息。</em></p></blockquote></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h2 id="8d88" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">问题是</h2><p id="7a3f" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">有了无服务器，事情会变得非常混乱。在几分钟内，5k消息可以触发相同数量的异常。在我的案例中，这是一个PoC项目，它具有来自物联网设备的意外消息格式。该项目的主要需求是以敏捷的方式进行开发，并即时引入变更。</p><p id="5ac3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了基本的错误处理，我还需要得到通知，并且能够根据需要重新运行错误消息。</p><p id="c6ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">解决方案设置:</p><ul class=""><li id="1e07" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu nm nn no np bi translated">Azure存储队列。</li><li id="0275" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated">带有物联网中心(事件中心)消息端点输入触发器和存储队列输出触发器的Azure函数。</li><li id="43a6" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated">30分钟内队列事务计数触发通知警报。</li><li id="7bb8" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated">Azure函数，用于重播存储在存储队列中的消息。</li></ul><p id="0f85" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个解决方案被证明对于生产使用来说足够健壮，所以我决定与在线社区分享它。</p></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h2 id="c543" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">死信队列还是毒药队列？</h2><p id="62c5" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">术语是最基本的东西。那么“死信队列”和“有毒队列”有什么区别呢？让我们引用微软文档。</p><blockquote class="lv lw lx"><p id="ddf5" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">死信队列(DLQ)的目的是保存无法传递给任何接收者的消息，或者无法处理的消息。<a class="ae ky" href="https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-dead-letter-queues" rel="noopener ugc nofollow" target="_blank">链接</a>到Azure服务总线队列文档。</p></blockquote><p id="1d96" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">关于毒药队列。</p><blockquote class="lv lw lx"><p id="65ed" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">一条<em class="it">有害消息</em>是一条已经超过应用程序最大传递尝试次数的消息。当基于队列的应用程序由于错误而无法处理消息时，就会出现这种情况。为了满足可靠性要求，排队的应用程序在事务下接收消息。<a class="ae ky" href="https://docs.microsoft.com/en-us/azure/storage/queues/storage-queues-introduction" rel="noopener ugc nofollow" target="_blank">将</a>链接到Azure存储队列文档。</p></blockquote><p id="f0ce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不幸的是，物联网中心和活动中心功能需要定制解决方案。</p></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h2 id="48e7" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">通过Azure存储队列处理错误。</h2><p id="a6b4" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">Azure中有两种竞争的队列解决方案——Azure存储队列和服务总线队列。你可以通过<a class="ae ky" href="https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-azure-and-service-bus-queues-compared-contrasted" rel="noopener ugc nofollow" target="_blank">链接</a>阅读一篇深入的对比文章。</p><p id="c490" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了简单起见，我认为Azure存储队列是一个足够好的解决方案。这是一个轻量级的服务，用于存储大量的消息，易于通过Azure Function和HTTPS的输出绑定来使用。它还有一个额外的故障保护，通过嵌入式毒药队列。</p><blockquote class="lv lw lx"><p id="9d2f" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated"><strong class="lb iu">请注意。存储队列消息不能超过64 KB，而Azure IoT hub设备到云的消息最高可达256 KB。<br/>默认消息生存期为7天，但您可以更改此设置。</strong></p></blockquote><p id="49d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是几个行动步骤。</p><ul class=""><li id="df30" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu nm nn no np bi translated">通过Azure CLI创建Azure存储和队列。</li><li id="b685" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated">为IoT Hub Azure函数添加输出绑定。</li><li id="36c1" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated">创建一个带有存储队列触发器的Azure函数并禁用它。</li><li id="67a7" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated">创建通知您存储队列中有新邮件的警报。</li></ul></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h2 id="a787" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">Azure基础设施和功能。</h2><p id="4a18" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">所以，让我们从通过Azure CLI设置的Azure存储队列开始。我选择了Standard_LRS的版本2热存储，因为死信队列在大多数时间应该是空的。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/4f668d882ca1a807e2306b36c75308e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l3OjDRTtSoOKId5ycOnEUg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">您可以通过门户查看存储队列中的消息。</figcaption></figure><p id="f5a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是调整Azure功能。这个输出触发器不同于MS docs，因为里面有异步代码。因此，您需要向<em class="ly"> IAsyncCollector </em>消息添加一条消息，以防出现错误事件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">具有物联网集线器触发器和输出绑定到存储队列的功能代码。</figcaption></figure><p id="51b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">并使用Azure存储队列触发器重新运行函数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">带有Azure存储队列触发器的功能代码。</figcaption></figure><blockquote class="lv lw lx"><p id="c7c7" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">如果某个由<code class="fe ny nz oa ob b"><em class="it">QueueTrigger</em></code>触发的函数失败，Azure Functions运行时会自动为该特定队列消息重试该函数五次。如果消息继续失败，那么坏消息将被移动到“有毒”队列。队列的名称将基于原来的+ "-poison "。<br/> https:// &lt;存储帐户&gt;. queue . core . windows . net/&lt;队列&gt;</p></blockquote></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h2 id="94cb" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">通知设置</h2><p id="37eb" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">存储警报设置与Azure Monitor中的功能和步骤相同。</p><ul class=""><li id="2194" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu nm nn no np bi translated">打开存储帐户并检查诊断设置。如果需要更快的警报响应，请启用分钟度量。</li><li id="8d15" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated">选择警报部分并添加新警报。</li><li id="9d3c" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated">为30分钟内大于零的事务计数创建一个条件。</li><li id="4a1f" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated">使用电子邮件或任何其他通知类型添加操作组。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/e510d9f807cbfab1deeb541e4f418c0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4Lkr4Sf2qZ9eHXqKZFE1GQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">存储帐户的诊断设置。</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/6ee13486996f25dc7f339f7efa30c3f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o_OxwbkqgGKBQe4lWTnh0w.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">具有所选事务处理度量的预警部分。</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/9343c3fccb9107730bcbf7629b8fa837.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*de2xwy5zZrhWkoSOr_TorA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">电子邮件订阅行动小组。</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/0ccce4911f4fb1409ca77941e593151f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2jTpBJXXg580qiWViHzzUA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">已配置警报的视图。</figcaption></figure><p id="c698" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们有每月警报执行的估计成本，这是Azure的一个小而简洁的细节，这很好。你可以使用这个设置来调试Azure函数的复杂问题。例如，从Application Insights获取失败的POST请求数据可能是一件棘手的事情。我希望您会发现这个解决方案很有用。</p><h2 id="da56" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">就这样，感谢阅读。干杯！</h2><h2 id="c324" class="mj mk it bd ml mm mn dn mo mp mq dp mr li ms mt mu lm mv mw mx lq my mz na nb bi translated">有用的链接。</h2><ul class=""><li id="33f5" class="nh ni it lb b lc nc lf nd li og lm oh lq oi lu nm nn no np bi translated">Mikhail Shilkov著Azure活动中心的可靠消费者。</li><li id="e4bb" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated"><a class="ae ky" href="https://hackernoon.com/azure-functions-choosing-between-queues-and-event-hubs-dac4157eee1c" rel="noopener ugc nofollow" target="_blank"> Azure Functions:在队列和活动中心之间选择。</a></li><li id="a309" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated"><a class="ae ky" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-error-pages" rel="noopener ugc nofollow" target="_blank"> Azure函数错误处理指南</a>。</li></ul></div></div>    
</body>
</html>