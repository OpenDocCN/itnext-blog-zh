<html>
<head>
<title>Setting Up a NATS Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">设置NATS集群</h1>
<blockquote>原文：<a href="https://itnext.io/setting-up-a-nats-cluster-92ca8fd6a6e1?source=collection_archive---------11-----------------------#2019-11-26">https://itnext.io/setting-up-a-nats-cluster-92ca8fd6a6e1?source=collection_archive---------11-----------------------#2019-11-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c0e6" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用3个Ubuntu虚拟机的简单示例</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/99ecde02763ee95a171fd1b7807e3edb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3V93JXKZ1R_TJfObM_-aRQ.png"/></div></div></figure><p id="09aa" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">运行NATS服务器非常简单，既可以直接从Go二进制文件中运行，也可以通过官方容器映像来运行。设置NATS集群需要运行第一个NATS服务器，然后加入其他服务器以形成集群。在这篇短文中，我们将演示一个3节点集群的设置，每个服务器运行在一个专用的虚拟机上。</p><h2 id="cc36" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">启动3台虚拟机</h2><p id="b37d" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">首先，为了简单起见，我们使用<a class="ae lq" href="https://multipass.run/" rel="noopener ugc nofollow" target="_blank">多路</a>在本地创建3个虚拟机。</p><p id="0e3e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意:根据您的操作系统，Multipass使用Hyper-V、HyperKit、KVM或VirtualBox来实现最快的启动时间。例如，在MacOS上，它使用HyperKit作为底层管理程序来启动Ubuntu虚拟机。</p><pre class="kj kk kl km gt mp mq mr ms aw mt bi"><span id="6384" class="lr ls it mq b gy mu mv l mw mx">luc@saturn:~$ multipass launch -n node1<br/>luc@saturn:~$ multipass launch -n node2<br/>luc@saturn:~$ multipass launch -n node3<br/>luc@saturn:~$ multipass list<br/>Name         State             IPv4             Image<br/>node3        Running           192.168.64.13    Ubuntu 18.04 LTS<br/>node2        Running           192.168.64.12    Ubuntu 18.04 LTS<br/>node1        Running           192.168.64.11    Ubuntu 18.04 LTS</span></pre><h2 id="4ca4" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">在每个服务器上安装Go</h2><p id="1576" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">接下来，我们在每个虚拟机上安装go，因为我们将从Go二进制文件运行NATS服务器:</p><pre class="kj kk kl km gt mp mq mr ms aw mt bi"><span id="5ce2" class="lr ls it mq b gy mu mv l mw mx">sudo apt-get update<br/>sudo apt-get -y upgrade<br/>wget <a class="ae lq" href="https://dl.google.com/go/go1.13.3.linux-amd64.tar.gz" rel="noopener ugc nofollow" target="_blank">https://dl.google.com/go/go1.13.3.linux-amd64.tar.gz</a><br/>sudo tar -xvf go1.13.3.linux-amd64.tar.gz<br/>sudo mv go /usr/local<br/>export GOROOT=/usr/local/go<br/>export GOPATH=$HOME/Projects<br/>export PATH=$GOPATH/bin:$GOROOT/bin:$PATH</span></pre><h2 id="f557" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">正在初始化集群</h2><p id="c42e" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">一旦节点准备就绪，我们就从节点1初始化集群:</p><pre class="kj kk kl km gt mp mq mr ms aw mt bi"><span id="8b73" class="lr ls it mq b gy mu mv l mw mx">multipass@<strong class="mq iu">node1</strong>:~$ nats-server -D \<br/>                   -p 4222 \<br/>                   --cluster nats://0.0.0.0:6222</span></pre><ul class=""><li id="2566" class="my mz it kw b kx ky la lb ld na lh nb ll nc lp nd ne nf ng bi translated">-p定义客户端将用于通过节点1连接到群集的端口</li><li id="e9c3" class="my mz it kw b kx nh la ni ld nj lh nk ll nl lp nd ne nf ng bi translated">- cluster定义了其他节点将用来加入集群的URL，在本例中，它们可以使用node1的任何网络接口上的端口6222</li></ul><h2 id="c646" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">加入其他节点</h2><p id="a4d1" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">然后，从节点2和节点3，我们可以运行额外的NATS服务器:</p><pre class="kj kk kl km gt mp mq mr ms aw mt bi"><span id="c91a" class="lr ls it mq b gy mu mv l mw mx">multipass@<strong class="mq iu">node2</strong>:~$ nats-server -D \<br/>                   -p 4222 \<br/>                   --cluster nats://0.0.0.0:6222 \<br/>                   --routes nats://192.168.64.11:6222</span><span id="efcd" class="lr ls it mq b gy nm mv l mw mx">multipass@<strong class="mq iu">node3</strong>:~$ nats-server -D \<br/>                   -p 4222 \<br/>                   --cluster nats://0.0.0.0:6222 \<br/>                   --routes nats://192.168.64.11:6222</span></pre><ul class=""><li id="9d3a" class="my mz it kw b kx ky la lb ld na lh nb ll nc lp nd ne nf ng bi translated">-p定义客户端将用于通过当前节点连接到群集的端口</li><li id="83e4" class="my mz it kw b kx nh la ni ld nj lh nk ll nl lp nd ne nf ng bi translated">- cluster定义了其他节点可以用来加入集群的URL，在这些示例中，每个节点都在任何网络接口上显示端口6222</li><li id="b425" class="my mz it kw b kx nh la ni ld nj lh nk ll nl lp nd ne nf ng bi translated">- routes定义了当前节点用于加入集群的URL，在这些示例中，两个服务器都通过节点1(如我们指定的节点1的IP地址)加入集群</li></ul><p id="853f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">下面的屏幕截图显示了集群设置期间服务器的日志。从上到下:</p><ul class=""><li id="3f45" class="my mz it kw b kx ky la lb ld na lh nb ll nc lp nd ne nf ng bi translated">从节点1初始化集群</li><li id="11e7" class="my mz it kw b kx nh la ni ld nj lh nk ll nl lp nd ne nf ng bi translated">节点2加入节点1</li><li id="0f38" class="my mz it kw b kx nh la ni ld nj lh nk ll nl lp nd ne nf ng bi translated">节点3加入节点1</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/457b67cfb61a929af5358fef28ad5040.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5Fvv4nqb5e2Na-QO8hYicw.png"/></div></div><figcaption class="no np gj gh gi nq nr bd b be z dk translated">设置3节点NATS集群</figcaption></figure><p id="5490" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">从日志中的IP地址可以看出，集群的每个节点都知道其他节点(<em class="ns">路由连接已创建</em>)</p><h2 id="7679" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">酒吧/订阅示例</h2><p id="5ba4" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">现在让我们使用nats-sub和nats-pub客户端(在<a class="ae lq" href="https://github.com/nats-io/go-nats-examples/tree/master/tools" rel="noopener ugc nofollow" target="_blank">https://github . com/NATs-io/go-NATs-examples/tree/master/tools</a>中都有)连接到集群。</p><p id="9204" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">下面的屏幕截图说明了以下流程:</p><ul class=""><li id="76c9" class="my mz it kw b kx ky la lb ld na lh nb ll nc lp nd ne nf ng bi translated">一个消费者(上图)连接到node1并订阅了<em class="ns"> nats.demo </em>主题</li><li id="6138" class="my mz it kw b kx nh la ni ld nj lh nk ll nl lp nd ne nf ng bi translated">一个发布者(底部面板)连接到节点3，并向主题<em class="ns">发送消息</em></li><li id="003b" class="my mz it kw b kx nh la ni ld nj lh nk ll nl lp nd ne nf ng bi translated">消费者(上图)从节点1接收消息</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/6fd275581ed9170018c57d5ed74106bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VuFhhTFDDFZCddCro2DNag.png"/></div></div><figcaption class="no np gj gh gi nq nr bd b be z dk translated">订户接收从另一个节点发布的消息</figcaption></figure><p id="27b9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在让我们停止在node1上运行的NATS服务器，看看会发生什么。下面的截图说明了这一点:</p><ul class=""><li id="d391" class="my mz it kw b kx ky la lb ld na lh nb ll nc lp nd ne nf ng bi translated">用户(顶部面板)断开，因为节点1不再可用(<em class="ns">断开:将尝试重新连接10m </em>)。但是，由于该客户端知道其他集群的节点(信息通过NATS协议传播到客户端)，因此它会自动重新连接到另一个节点(从IP地址可以看到节点2)</li><li id="d2df" class="my mz it kw b kx nh la ni ld nj lh nk ll nl lp nd ne nf ng bi translated">发布者(底部面板)在<em class="ns"> nats.demo </em>上发送另一条消息</li><li id="50f7" class="my mz it kw b kx nh la ni ld nj lh nk ll nl lp nd ne nf ng bi translated">消费者(顶部面板)从节点2接收该消息</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/4e9972e9e23bc15b079dbe2bf2235845.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nz0c5DLYZ7UrgqpIuZ-WAw.png"/></div></div><figcaption class="no np gj gh gi nq nr bd b be z dk translated">自动重新连接到集群的另一个节点</figcaption></figure><h2 id="8fef" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">摘要</h2><p id="c238" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">这篇短文展示了一个3节点NATS集群的创建过程。接下来的步骤是创建TLS证书来保护节点之间以及客户端和节点之间的通信。此外，NATS 2.0安全功能可用于对客户端进行身份验证/授权。</p></div></div>    
</body>
</html>