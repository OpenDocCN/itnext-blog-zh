<html>
<head>
<title>Extend Terraform json/yaml templates with qbec and jsonnet</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用qbec和jsonnet扩展Terraform json/yaml模板</h1>
<blockquote>原文：<a href="https://itnext.io/extend-terraform-json-yaml-templates-with-qbec-and-jsonnet-aac372602a7d?source=collection_archive---------5-----------------------#2021-10-18">https://itnext.io/extend-terraform-json-yaml-templates-with-qbec-and-jsonnet-aac372602a7d?source=collection_archive---------5-----------------------#2021-10-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="5e17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Terraform对<a class="ae kl" href="https://www.terraform.io/docs/language/functions/templatefile.html" rel="noopener ugc nofollow" target="_blank">模板</a>有原生支持，但在模板化复杂的json或yaml文档时有所限制。通常，配置需要基于多种因素生成，如目标环境、外部约束(如API调用)或在某些情况下需要基于一些可用输入值的复杂计算。Terraform模板适合一般的字符串模板用例，json/yaml是其中的特例。通常，随着大小和复杂性的增加，字符串模板变得难以阅读和管理。很少支持可以跨模板和配置使用的模块化或可重用组件。</p><p id="8bcc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">进入<a class="ae kl" href="https://registry.terraform.io/providers/splunk/qbec/latest/docs?pollNotifications=true" rel="noopener ugc nofollow" target="_blank"> qbec Terraform provider </a>，这是一种为Terraform编写json和yaml模板的强大而便捷的方式。它利用<a class="ae kl" href="https://qbec.io" rel="noopener ugc nofollow" target="_blank"> qbec </a>的力量，让管理Terraform复杂的json和yaml数据变得轻而易举。qbec实现了一个自以为是的<a class="ae kl" href="https://jsonnet.org/" rel="noopener ugc nofollow" target="_blank"> Jsonnet </a> VM，它提供了一些额外的特性，比如<a class="ae kl" href="https://qbec.io/reference/jsonnet-native-funcs/" rel="noopener ugc nofollow" target="_blank">额外的本地函数</a>、<a class="ae kl" href="https://qbec.io/reference/jsonnet-glob-importer/" rel="noopener ugc nofollow" target="_blank">一个全球导入器</a>和<a class="ae kl" href="https://qbec.io/reference/jsonnet-external-data/" rel="noopener ugc nofollow" target="_blank">一个数据源导入器</a>。我们将在接下来的章节中研究这些特性。</p><p id="969a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想了解更多关于qbec的知识，可以看看我之前的文章-<a class="ae kl" href="https://harsimranmaan.medium.com/qbec-the-deployment-tool-for-multiple-kubernetes-environments-c39b6bd7ea07?source=your_stories_page-------------------------------------" rel="noopener">qbec——多kubernetes环境的部署工具</a>。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="5973" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">设置</h1><p id="1a58" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">为了更好地理解qbec Terraform提供者必须提供什么，让我们实现一个完全虚构的场景。想象一下，编写一个AWS S3存储桶策略，拒绝对存储桶的访问，除非调用者驻留在某个公司网络上。有一些测试系统的IP不会随时间而改变。动态公司IP的列表随时间而变化，并由API服务公开。最终的策略如下所示</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="mb mc l"/></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">最终的AWS S3存储桶策略</figcaption></figure><p id="20ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将看看qbec provider如何使编写模块化代码变得更容易(想象一种情况，您想要使用相同的策略，但是来自Terraform之外的某个工具，比如aws CLI)，查询外部API，然后生成json策略。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="ef2e" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">履行</h1><p id="188d" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">在这一节中，我们将使用qbec Terraform provider逐步构建端到端解决方案。在第一步中，我们将编写一个Jsonnet库，它接受一个bucket名称和一个企业IP列表，并公开一个方法<code class="fe mh mi mj mk b">s3DenyNonCorpPolicy</code>,该方法返回一个代表最终策略的Jsonnet对象。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="mb mc l"/></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">Jsonnet lib公开了一个助手来呈现s3存储桶策略</figcaption></figure><p id="b290" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们编写一个Jsonnet文件，使用这个库来呈现最终的策略。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="mb mc l"/></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">用硬编码值呈现s3策略</figcaption></figure><p id="7c0c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以使用qbec CLI快速测试到目前为止的设置。</p><pre class="lw lx ly lz gt ml mk mm mn aw mo bi"><span id="4455" class="mp ku iq mk b gy mq mr l ms mt">$ qbec eval policy-v1.jsonnet # try -o yaml to test yaml rendering<br/>{<br/>  "Statement": [<br/>    {<br/>      "Action": "s3:*",<br/>      "Condition": {<br/>        "NotIpAddress": {<br/>          "aws:SourceIp": [<br/>            "11.11.11.11/32",<br/>            "22.22.22.22/32",<br/>            "33.33.33.33/32",<br/>            "44.44.44.44/32"<br/>          ]<br/>        }<br/>      },<br/>      "Effect": "Deny",<br/>      "Principal": "*",<br/>      "Resource": [<br/>        "arn:aws:s3:::the-bucket",<br/>        "arn:aws:s3:::the-bucket/*"<br/>      ],<br/>      "Sid": "SourceIP"<br/>    }<br/>  ],<br/>  "Version": "2012-10-17"<br/>}</span></pre><p id="8ecf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步是获取作为静态配置提供的众所周知的IP列表。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="mb mc l"/></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">包含必须允许访问的已知IP列表的静态JSON文件</figcaption></figure><p id="878c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用<a class="ae kl" href="https://qbec.io/reference/jsonnet-glob-importer/" rel="noopener ugc nofollow" target="_blank"> qbec glob importer </a>来导入所有静态定义的IP。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="mb mc l"/></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">使用qbec glob importer从多个json文件导入静态IP列表</figcaption></figure><p id="ae71" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mh mi mj mk b">qbec eval policy-v2.jsonnet</code>将显示与最终所需策略相同的结果。</p><p id="cb1c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后一个需求是从外部服务获取企业IP的动态列表。我们将使用<a class="ae kl" href="https://qbec.io/reference/jsonnet-external-data/" rel="noopener ugc nofollow" target="_blank"> qbec jsonnet数据源</a>来完成这项工作。qbec允许运行外部命令，然后无缝地使用jsonnet中的输出。</p><p id="a6a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">编写一个自定义程序，从API获取公司IP。更有趣的是，程序以YAML的形式返回输出(显然是由某个热爱k8的开发人员编写的)。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="mb mc l"/></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">获取公司IP的自定义程序</figcaption></figure><pre class="lw lx ly lz gt ml mk mm mn aw mo bi"><span id="58da" class="mp ku iq mk b gy mq mr l ms mt">$ ./fetch-dynamic-corp-ips.sh corpIPs # output key is based on input<br/>corpIPs:<br/>  - '33.33.33.33/32' <br/>  - '44.44.44.44/32'</span></pre><p id="63c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们准备使用qbec数据源合并上述程序的输出，并使用qbec提供的本地jsonnet函数<code class="fe mh mi mj mk b">parseYaml</code>读取jsonnet中的值</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="mb mc l"/></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">最终的policy.jsonnet获取动态IP，并与静态列表结合生成s3策略</figcaption></figure></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="2b71" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">将它与Terraform结合在一起</h1><p id="ea58" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">到目前为止，我们一直在terraform之外工作，准备我们的动态生成的策略用于terraform。</p><p id="9a7a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">qbec Terraform provider公开了一个简单的接口，以便将qbec的功能与Terraform结合使用，并无缝集成到现有的Terraform代码中。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="mb mc l"/></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">Terraform片段展示了由qbec支持的Jsonnet动态生成的JSON</figcaption></figure><p id="b023" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们现在可以运行一个terraform计划来查看上面代码片段中提出的更改。</p><pre class="lw lx ly lz gt ml mk mm mn aw mo bi"><span id="661a" class="mp ku iq mk b gy mq mr l ms mt">$ terraform plan</span><span id="0f89" class="mp ku iq mk b gy mu mr l ms mt">Changes to Outputs:<br/>  + result = {<br/>      + Statement = [<br/>          + {<br/>              + Action    = "s3:*"<br/>              + Condition = {<br/>                  + NotIpAddress = {<br/>                      + aws:SourceIp = [<br/>                          + "11.11.11.11/32",<br/>                          + "22.22.22.22/32",<br/>                          + "33.33.33.33/32",<br/>                          + "44.44.44.44/32",<br/>                        ]<br/>                    }<br/>                }<br/>              + Effect    = "Deny"<br/>              + Principal = "*"<br/>              + Resource  = [<br/>                  + "arn:aws:s3:::the-bucket",<br/>                  + "arn:aws:s3:::the-bucket/*",<br/>                ]<br/>              + Sid       = "SourceIP"<br/>            },<br/>        ]<br/>      + Version   = "2012-10-17"<br/>    }</span><span id="5f3f" class="mp ku iq mk b gy mu mr l ms mt">You can apply this plan to save these new output values to the Terraform state, without changing any real infrastructure.</span><span id="17fd" class="mp ku iq mk b gy mu mr l ms mt">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><span id="d131" class="mp ku iq mk b gy mu mr l ms mt">Note: You didn't use the -out option to save this plan, so Terraform can't guarantee to take exactly these actions if you run "terraform apply" now.</span></pre><p id="eca2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就这样，我们现在可以将这个程序扩展到高级用例，这些用例需要生成复杂的JSON/YAML文档，以便与terraform一起使用。使用与AWS CLI相同的策略(提示:<code class="fe mh mi mj mk b">qbec eval</code>)留给读者作为练习。还可以探索qbec的其他强大功能，参见<a class="ae kl" href="https://qbec.io/getting-started/" rel="noopener ugc nofollow" target="_blank"> qbec文档</a>。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="7d38" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">概述</h1><p id="04a0" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">在本文中，我们学习了如何编写用于Terraform的Jsonnet片段。我们使用qbec的特性，如<a class="ae kl" href="https://qbec.io/reference/jsonnet-native-funcs/" rel="noopener ugc nofollow" target="_blank">附加的本地函数</a>、<a class="ae kl" href="https://qbec.io/reference/jsonnet-glob-importer/" rel="noopener ugc nofollow" target="_blank">一个全局导入器</a>和<a class="ae kl" href="https://qbec.io/reference/jsonnet-external-data/" rel="noopener ugc nofollow" target="_blank">一个数据源导入器</a>来丰富模板化体验。</p><p id="162a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本文中示例的完整源代码可以在github.com/harsimranmaan的<a class="ae kl" href="https://github.com/harsimranmaan/medium.com/tree/main/terraform-provider-qbec" rel="noopener ugc nofollow" target="_blank">网站</a>找到</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi mv"><img src="../Images/3e026de92816e6d7428e24be29240464.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bE_gogKJVxyjIVxy.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">qbec徽标(鸣谢:https//qbec.io)</figcaption></figure></div></div>    
</body>
</html>