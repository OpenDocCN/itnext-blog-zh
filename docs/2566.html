<html>
<head>
<title>Private PowerShell Modules</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">私有PowerShell模块</h1>
<blockquote>原文：<a href="https://itnext.io/private-powershell-modules-76f51a1bf893?source=collection_archive---------1-----------------------#2019-06-16">https://itnext.io/private-powershell-modules-76f51a1bf893?source=collection_archive---------1-----------------------#2019-06-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5e71" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">打包和部署您的DevOps微框架</h2></div><p id="fabe" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le">第四部分</em> <a class="ae lf" href="https://medium.com/@cjkuech/declarative-devops-microframeworks-9908c8d05332" rel="noopener"> <em class="le">声明性DevOps微框架</em> </a></p><p id="9a55" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">PowerShell模块(如果设计正确)是完全模块化和可移植的——打包DevOps微框架的理想解决方案。虽然您<em class="le">可以</em>尝试使用私有的PowerShell Gallery实例或<a class="ae lf" href="https://github.com/PowerShell/PowerShellGet/issues/492" rel="noopener ugc nofollow" target="_blank"> Azure工件</a>来托管您的模块，但是开发和发布您的模块以供私人使用的最简单和最容易的方式是将它们存储在<code class="fe lg lh li lj b">git</code>中，并在部署时复制文件。</p><p id="25aa" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">本指南将向您展示如何构建PowerShell模块，在您的其他项目中引用它，以及私下部署它。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi lk"><img src="../Images/3b9d5cced46c9299952d1e80411e2f85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pGWgRpalBr_v2ZtI"/></div></div><figcaption class="lw lx gj gh gi ly lz bd b be z dk translated">模块化、独立、可移植的代码是最好的代码</figcaption></figure><h1 id="4a3f" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">创建PowerShell模块</h1><h2 id="c3d3" class="ms mb it bd mc mt mu dn mg mv mw dp mk kr mx my mm kv mz na mo kz nb nc mq nd bi translated">创建一个文件夹，并将光盘放入该文件夹</h2><pre class="ll lm ln lo gt ne lj nf ng aw nh bi"><span id="dfe2" class="ms mb it lj b gy ni nj l nk nl">PS /projects&gt; mkdir MyModule<br/>PS /projects&gt; cd MyModule<br/>PS /projects/MyModule&gt;</span></pre><h2 id="a459" class="ms mb it bd mc mt mu dn mg mv mw dp mk kr mx my mm kv mz na mo kz nb nc mq nd bi translated">添加所需的文件</h2><p id="ed5e" class="pw-post-body-paragraph ki kj it kk b kl nm ju kn ko nn jx kq kr no kt ku kv np kx ky kz nq lb lc ld im bi translated">我们将添加以下文件:</p><ul class=""><li id="19e1" class="nr ns it kk b kl km ko kp kr nt kv nu kz nv ld nw nx ny nz bi translated"><code class="fe lg lh li lj b">MyModule.psd1</code>，模块清单。</li><li id="42af" class="nr ns it kk b kl oa ko ob kr oc kv od kz oe ld nw nx ny nz bi translated"><code class="fe lg lh li lj b">MyModule.psm1</code>，这个脚本包含了我们导出的所有变量、函数、别名等。</li><li id="d067" class="nr ns it kk b kl oa ko ob kr oc kv od kz oe ld nw nx ny nz bi translated"><code class="fe lg lh li lj b">MyModule.tests.ps1</code>，我们的<a class="ae lf" href="https://github.com/pester/Pester" rel="noopener ugc nofollow" target="_blank">纠缠</a>单元测试。</li><li id="0b62" class="nr ns it kk b kl oa ko ob kr oc kv od kz oe ld nw nx ny nz bi translated"><code class="fe lg lh li lj b">README.md</code>，我们的文档模块。这个文档是给我们的队友<em class="le">开发</em>模块的。使用模块的人<em class="le">将转而参考嵌入在我们模块中的<a class="ae lf" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_comment_based_help" rel="noopener ugc nofollow" target="_blank">基于注释的帮助</a>。</em></li><li id="1066" class="nr ns it kk b kl oa ko ob kr oc kv od kz oe ld nw nx ny nz bi translated"><code class="fe lg lh li lj b">.gitignore</code>，告诉<code class="fe lg lh li lj b">git</code>不要跟踪我们的<code class="fe lg lh li lj b">.vscode</code>文件夹，因为VS代码可能会在你不知情的情况下将工作站特定的设置放到文件夹中。</li></ul><pre class="ll lm ln lo gt ne lj nf ng aw nh bi"><span id="c1f5" class="ms mb it lj b gy ni nj l nk nl">PS /projects/MyModule&gt; New-ModuleManifest ./MyModule.psd1<br/>PS /projects/MyModule&gt; "" &gt; ./MyModule.psm1<br/>PS /projects/MyModule&gt; "" &gt; ./MyModule.tests.ps1<br/>PS /projects/MyModule&gt; "" &gt; ./README.md<br/>PS /projects/MyModule&gt; ".vscode" &gt; ./.gitignore</span></pre><h2 id="3015" class="ms mb it bd mc mt mu dn mg mv mw dp mk kr mx my mm kv mz na mo kz nb nc mq nd bi translated">向文件中添加内容</h2><p id="7604" class="pw-post-body-paragraph ki kj it kk b kl nm ju kn ko nn jx kq kr no kt ku kv np kx ky kz nq lb lc ld im bi translated">向每个文件添加相关内容。</p><p id="210a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于模块清单，</p><ul class=""><li id="1200" class="nr ns it kk b kl km ko kp kr nt kv nu kz nv ld nw nx ny nz bi translated">将<code class="fe lg lh li lj b">RootModule</code>设置为<code class="fe lg lh li lj b">'MyModule.psm1'</code></li><li id="0717" class="nr ns it kk b kl oa ko ob kr oc kv od kz oe ld nw nx ny nz bi translated">将<code class="fe lg lh li lj b">FunctionsToExport</code>、<code class="fe lg lh li lj b">CmdletsToExport</code>、<code class="fe lg lh li lj b">VariablesToExport</code>和<code class="fe lg lh li lj b">AliasesToExport</code>设置为从模块中导出的项目名称</li><li id="1fb5" class="nr ns it kk b kl oa ko ob kr oc kv od kz oe ld nw nx ny nz bi translated">将<code class="fe lg lh li lj b">ScriptsToProcess</code>设置为包含<code class="fe lg lh li lj b">class</code>和<code class="fe lg lh li lj b">enum</code>定义的脚本(如果有)</li><li id="fdea" class="nr ns it kk b kl oa ko ob kr oc kv od kz oe ld nw nx ny nz bi translated">如果您的模块有PowerShell版本约束，设置<code class="fe lg lh li lj b">CompatiblePSEditions</code>以限制支持的<a class="ae lf" href="https://docs.microsoft.com/en-us/windows-server/get-started/powershell-on-nano-server" rel="noopener ugc nofollow" target="_blank">版本</a></li><li id="1b67" class="nr ns it kk b kl oa ko ob kr oc kv od kz oe ld nw nx ny nz bi translated">如果您的模块需要依赖关系，则设置<code class="fe lg lh li lj b">RequiredModules</code>。</li><li id="a8f3" class="nr ns it kk b kl oa ko ob kr oc kv od kz oe ld nw nx ny nz bi translated">有关配置模块清单的更多信息，请参见<a class="ae lf" href="http://• https://docs.microsoft.com/en-us/powershell/developer/module/how-to-write-a-powershell-module-manifest" rel="noopener ugc nofollow" target="_blank">官方指南</a>。</li></ul><h1 id="33d9" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">引用模块</h1><h2 id="5128" class="ms mb it bd mc mt mu dn mg mv mw dp mk kr mx my mm kv mz na mo kz nb nc mq nd bi translated">按名称引用</h2><p id="c6a7" class="pw-post-body-paragraph ki kj it kk b kl nm ju kn ko nn jx kq kr no kt ku kv np kx ky kz nq lb lc ld im bi translated">您总是希望通过名称而不是路径来引用模块，以避免不必要地将模块耦合到它在磁盘上的路径。</p><figure class="ll lm ln lo gt lp"><div class="bz fp l di"><div class="of og l"/></div></figure><h2 id="3302" class="ms mb it bd mc mt mu dn mg mv mw dp mk kr mx my mm kv mz na mo kz nb nc mq nd bi translated">告诉<code class="fe lg lh li lj b">Import-Module</code>如何找到你的模块</h2><p id="1b23" class="pw-post-body-paragraph ki kj it kk b kl nm ju kn ko nn jx kq kr no kt ku kv np kx ky kz nq lb lc ld im bi translated">PowerShell使用<code class="fe lg lh li lj b">PSModulePath</code>环境变量来确定在哪个文件夹中查找模块，因此我们必须修改这个环境变量。如果你使用Windows，<code class="fe lg lh li lj b">PSModulePath</code>包含一个用<code class="fe lg lh li lj b">;</code>分隔的路径列表；如果使用*NIX，<code class="fe lg lh li lj b">PSModulePath</code>包含一个用<code class="fe lg lh li lj b">:</code>分隔的路径列表。在本指南中，我们将使用*NIX分隔符。</p><p id="46e8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要将路径<code class="fe lg lh li lj b">$Path</code>添加到我们的<code class="fe lg lh li lj b">PSModulePath</code>中，我们可以将<code class="fe lg lh li lj b">":$Path"</code>添加到<code class="fe lg lh li lj b">PSModulePath</code>字符串中；每当您在<code class="fe lg lh li lj b">$Path</code>开始开发需要该模块的项目时，在您的PowerShell会话中运行<code class="fe lg lh li lj b">$env:PSModulePath += ":$Path"</code>。在修改环境变量后，您可以通过在同一个会话中从命令行启动VS代码<a class="ae lf" href="https://code.visualstudio.com/docs/editor/command-line" rel="noopener ugc nofollow" target="_blank">来确保VS代码使用正确的路径。注意，我们可以全局地修改我们的环境变量，但是为开发独立的项目而进行全局工作站更改是不好的做法。</a></p><h1 id="4b0f" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">部署模块</h1><h2 id="a192" class="ms mb it bd mc mt mu dn mg mv mw dp mk kr mx my mm kv mz na mo kz nb nc mq nd bi translated">通常</h2><p id="4912" class="pw-post-body-paragraph ki kj it kk b kl nm ju kn ko nn jx kq kr no kt ku kv np kx ky kz nq lb lc ld im bi translated">部署模块就像将文件夹复制到目标机器的一个模块文件夹中一样简单。</p><figure class="ll lm ln lo gt lp"><div class="bz fp l di"><div class="of og l"/></div></figure><h2 id="fc32" class="ms mb it bd mc mt mu dn mg mv mw dp mk kr mx my mm kv mz na mo kz nb nc mq nd bi translated">码头工人</h2><p id="4853" class="pw-post-body-paragraph ki kj it kk b kl nm ju kn ko nn jx kq kr no kt ku kv np kx ky kz nq lb lc ld im bi translated">您可以在Dockerfile文件中轻松实现这一点。</p><figure class="ll lm ln lo gt lp"><div class="bz fp l di"><div class="of og l"/></div></figure><h2 id="5e58" class="ms mb it bd mc mt mu dn mg mv mw dp mk kr mx my mm kv mz na mo kz nb nc mq nd bi translated">安装依赖项</h2><p id="6817" class="pw-post-body-paragraph ki kj it kk b kl nm ju kn ko nn jx kq kr no kt ku kv np kx ky kz nq lb lc ld im bi translated">如果您在模块清单的<code class="fe lg lh li lj b">RequiredModules</code>中指定了依赖项，那么您可以使用这个代码片段来安装所有的依赖项。</p><figure class="ll lm ln lo gt lp"><div class="bz fp l di"><div class="of og l"/></div></figure><h1 id="518f" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">后续步骤</h1><h2 id="f8b0" class="ms mb it bd mc mt mu dn mg mv mw dp mk kr mx my mm kv mz na mo kz nb nc mq nd bi translated">了解有关扩展PowerShell的更多信息</h2><p id="ef6a" class="pw-post-body-paragraph ki kj it kk b kl nm ju kn ko nn jx kq kr no kt ku kv np kx ky kz nq lb lc ld im bi translated">本文是关于大规模管理PowerShell代码库的系列文章的一部分。阅读本系列的<a class="ae lf" href="https://medium.com/@cjkuech/declarative-devops-microframeworks-9908c8d05332" rel="noopener">部分，了解更多关于为大型DevOps代码库设计和编写更少代码的信息。</a></p></div></div>    
</body>
</html>