<html>
<head>
<title>One Domain — Multiple Next.js Apps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个域—多个Next.js应用程序</h1>
<blockquote>原文：<a href="https://itnext.io/one-domain-multiple-next-js-apps-5e39b0ffa1bf?source=collection_archive---------2-----------------------#2020-01-19">https://itnext.io/one-domain-multiple-next-js-apps-5e39b0ffa1bf?source=collection_archive---------2-----------------------#2020-01-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="8fea" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">关于如何使用Nginx在一个域上使用子目录服务多个Next.js应用程序的快速教程。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/5ef15b69a08f8aed498f5b510529eae1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HmtFs_luIiMB7s98nHOtNg.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">照片由<a class="ae le" href="https://unsplash.com/@dsalcius?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">丹尼尔·萨尔西乌斯</a>在<a class="ae le" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><p id="aa06" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">默认情况下，如果你使用<code class="fe lf lg lh li b">create-next-app</code>来启动一个Next.js项目，它会假设你正在运行一个大型的网站。最近，我遇到了一个小用例，其目标是托管多个Next。JS项目，并使用单个域和子目录提供服务。</p><p id="ea17" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">假设我们有三个Next.js项目，即<code class="fe lf lg lh li b">bikes</code>、<code class="fe lf lg lh li b">cars</code>和<code class="fe lf lg lh li b">trucks</code>，它们都是具有独立git库的独立项目。我们希望在单个服务器实例上为这三个项目提供子目录。</p><ol class=""><li id="bab0" class="lj lk it js b jt ju jx jy kb ll kf lm kj ln kn lo lp lq lr bi translated"><code class="fe lf lg lh li b">bikes</code>应该在<code class="fe lf lg lh li b">yourdomain.com/bikes</code>上菜</li><li id="ed05" class="lj lk it js b jt ls jx lt kb lu kf lv kj lw kn lo lp lq lr bi translated"><code class="fe lf lg lh li b">cars</code>应该在<code class="fe lf lg lh li b">yourdomain.com/cars</code>上菜</li><li id="d99a" class="lj lk it js b jt ls jx lt kb lu kf lv kj lw kn lo lp lq lr bi translated"><code class="fe lf lg lh li b">trucks</code>应在<code class="fe lf lg lh li b">yourdomain.com/trucks</code>送达</li></ol><p id="cbfc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我个人在生产中使用Nginx作为反向代理来服务我的Next.js应用程序。我让PM2担任流程经理。但是因为Next.js假设你总是把它作为一个单独的网站来提供服务，所以加载构建的资产会有问题。通常你所有的静态资产都会得到404分。为了达到上述要求，我们需要做一些调整。</p><h1 id="271f" class="lx ly it bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">将所有路由放在一个文件夹中，子目录名称为</h1><p id="00f8" class="pw-post-body-paragraph jq jr it js b jt mv jv jw jx mw jz ka kb mx kd ke kf my kh ki kj mz kl km kn im bi translated">例如，如果您实例中的项目目录在<code class="fe lf lg lh li b">/home/ubuntu/bikes</code>中，那么您在<code class="fe lf lg lh li b">pages</code>中创建一个<code class="fe lf lg lh li b">bikes</code>文件夹。然后在这里创建你所有的其他路线。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi na"><img src="../Images/910fbc579496868a51aefa94370505c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:716/format:webp/1*NK8VDPsELX8tCj3wmyIaSA.png"/></div></figure><h1 id="c712" class="lx ly it bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">2.将assetPrefix添加到next.config .文件中</h1><p id="dd30" class="pw-post-body-paragraph jq jr it js b jt mv jv jw jx mw jz ka kb mx kd ke kf my kh ki kj mz kl km kn im bi translated"><code class="fe lf lg lh li b">assetPrefix</code>选项允许从不同的目录中提供静态文件。默认情况下，从<code class="fe lf lg lh li b">/_next</code>开始供应。但是因为我们使用子目录，我们需要从示例<code class="fe lf lg lh li b">/bikes/_next</code>中提供这些资产。但是如果您在构建Next.js之后查看项目文件夹，您会注意到没有<code class="fe lf lg lh li b">/next</code>文件夹。但是它叫做<code class="fe lf lg lh li b">/.next</code>我们将在下一步解决这个问题。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nb"><img src="../Images/f66278163728841a79ad1372a5d7404e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MdfNYCcNduVCmUVGjniL0w.png"/></div></div></figure><h1 id="e8ae" class="lx ly it bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">3.修改Nginx反向代理</h1><p id="0b1d" class="pw-post-body-paragraph jq jr it js b jt mv jv jw jx mw jz ka kb mx kd ke kf my kh ki kj mz kl km kn im bi translated">我们需要确保为项目、它的公共目录和<code class="fe lf lg lh li b">/pages/api</code>路由设置了反向代理。我把我的项目文件放在<code class="fe lf lg lh li b">/home/ubuntu</code>里，因为我在一台Ubuntu机器上。这可能会有所不同。请注意，我们将_next路径别名化为每个路径。改为下一个文件夹。确保重启Nginx。</p><p id="50d8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae le" href="https://gist.github.com/skolhustick/dcbec823ad78c43380112d3136e028cf" rel="noopener ugc nofollow" target="_blank">要诀在此</a></p><pre class="kp kq kr ks gt nc li nd ne aw nf bi"><span id="db88" class="ng ly it li b gy nh ni l nj nk">server {</span><span id="ff23" class="ng ly it li b gy nl ni l nj nk">  listen 80 default_server;<br/>  listen [::]:80 default_server;</span><span id="1f6b" class="ng ly it li b gy nl ni l nj nk">  server_name _;</span><span id="4309" class="ng ly it li b gy nl ni l nj nk">  #ONE FOR EACH NEXTJS APP AND SUBDOMAIN</span><span id="f358" class="ng ly it li b gy nl ni l nj nk"> #BIKES - PORT 3001</span><span id="f06d" class="ng ly it li b gy nl ni l nj nk">  location /bikes/_next/static {<br/>    autoindex on;<br/>    alias /home/ubuntu/bikes/.next/static;<br/>  }</span><span id="fb4c" class="ng ly it li b gy nl ni l nj nk">location /bikes/api {<br/>    proxy_pass <a class="ae le" href="http://localhost:3001/api" rel="noopener ugc nofollow" target="_blank">http://localhost:3001/api</a>;<br/>    proxy_http_version 1.1;<br/>    proxy_set_header Upgrade $http_upgrade;<br/>    proxy_set_header Connection 'upgrade';<br/>    proxy_set_header Host $host;proxy_cache_bypass $http_upgrade;<br/>  }</span><span id="83a5" class="ng ly it li b gy nl ni l nj nk">location /bikes {<br/>    proxy_pass <a class="ae le" href="http://localhost:3001" rel="noopener ugc nofollow" target="_blank">http://localhost:3001</a>;<br/>    proxy_http_version 1.1;<br/>    proxy_set_header Upgrade $http_upgrade;<br/>    proxy_set_header Connection 'upgrade';<br/>    proxy_set_header Host $host;<br/>    proxy_cache_bypass $http_upgrade;<br/>  }</span><span id="105f" class="ng ly it li b gy nl ni l nj nk">#CARS - PORT 3002<br/>  location /cars/_next/static {<br/>    autoindex on;<br/>    alias /home/ubuntu/cars/.next/static;<br/>  }</span><span id="4b19" class="ng ly it li b gy nl ni l nj nk">location /cars/api {<br/>    proxy_pass <a class="ae le" href="http://localhost:3002/api" rel="noopener ugc nofollow" target="_blank">http://localhost:3002/api</a>;<br/>    proxy_http_version 1.1;<br/>    proxy_set_header Upgrade $http_upgrade;<br/>    proxy_set_header Connection 'upgrade';<br/>    proxy_set_header Host $host;proxy_cache_bypass $http_upgrade;<br/>  }</span><span id="fa64" class="ng ly it li b gy nl ni l nj nk">location /cars {<br/>    proxy_pass <a class="ae le" href="http://localhost:3002" rel="noopener ugc nofollow" target="_blank">http://localhost:3002</a>;<br/>    proxy_http_version 1.1;<br/>    proxy_set_header Upgrade $http_upgrade;<br/>    proxy_set_header Connection 'upgrade';<br/>    proxy_set_header Host $host;<br/>    proxy_cache_bypass $http_upgrade;<br/>  }</span><span id="43f6" class="ng ly it li b gy nl ni l nj nk">#TRUCKS - PORT 3003<br/>  location /trucks/_next/static {<br/>    autoindex on;<br/>    alias /home/ubuntu/trucks/.next/static;<br/>  }</span><span id="32f0" class="ng ly it li b gy nl ni l nj nk">location /trucks/api {<br/>    proxy_pass <a class="ae le" href="http://localhost:3003/api" rel="noopener ugc nofollow" target="_blank">http://localhost:3003/api</a>;<br/>    proxy_http_version 1.1;<br/>    proxy_set_header Upgrade $http_upgrade;<br/>    proxy_set_header Connection 'upgrade';<br/>    proxy_set_header Host $host;proxy_cache_bypass $http_upgrade;<br/>  }</span><span id="d741" class="ng ly it li b gy nl ni l nj nk">location /trucks {<br/>    proxy_pass <a class="ae le" href="http://localhost:3003" rel="noopener ugc nofollow" target="_blank">http://localhost:3003</a>;<br/>    proxy_http_version 1.1;<br/>    proxy_set_header Upgrade $http_upgrade;<br/>    proxy_set_header Connection 'upgrade';<br/>    proxy_set_header Host $host;<br/>    proxy_cache_bypass $http_upgrade;<br/>  }</span><span id="e4dd" class="ng ly it li b gy nl ni l nj nk">}</span></pre><p id="2fd6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">就是这样！</p></div></div>    
</body>
</html>