<html>
<head>
<title>Running K3S workload in a restricted environment</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在受限环境中运行K3S工作负载</h1>
<blockquote>原文：<a href="https://itnext.io/running-k3s-workload-in-a-restricted-environment-c2f593d19005?source=collection_archive---------1-----------------------#2021-05-26">https://itnext.io/running-k3s-workload-in-a-restricted-environment-c2f593d19005?source=collection_archive---------1-----------------------#2021-05-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/a9dd9311162296bda4e71f7dda451779.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*48NPqKBHxQGfTZ97.jpg"/></div></div></figure><p id="3c2c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我需要在受限环境中运行一些监控。它是受限制的，首先，它有气隙，没有互联网连接。其次，环境是锁定的，不能安装额外的依赖模块。</p><p id="7950" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">轻量级的Kubernetes发行版K3s及其独立的依赖项完美地满足了这一需求。本文将展示我是如何在上述受限环境中设置普罗米修斯的。</p><h2 id="0765" class="kz la it bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">在airgap服务器中安装K3s</h2><p id="4f48" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">K3s的气隙设置在<a class="ae lx" href="https://rancher.com/docs/k3s/latest/en/installation/airgap/" rel="noopener ugc nofollow" target="_blank">有很好的记录</a>。下面是需要下载到面向internet的服务器上的包和脚本的快速命令列表。</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="d14e" class="kz la it md b gy mh mi l mj mk">curl -LO <a class="ae lx" href="https://github.com/k3s-io/k3s/releases/download/v1.21.1%2Bk3s1/k3s-airgap-images-amd64.tar.gz" rel="noopener ugc nofollow" target="_blank">https://github.com/k3s-io/k3s/releases/download/v1.21.1%2Bk3s1/k3s-airgap-images-amd64.tar.gz</a></span><span id="a19c" class="kz la it md b gy ml mi l mj mk">curl -LO <a class="ae lx" href="https://github.com/k3s-io/k3s/releases/download/v1.21.1%2Bk3s1/k3s" rel="noopener ugc nofollow" target="_blank">https://github.com/k3s-io/k3s/releases/download/v1.21.1%2Bk3s1/k3s</a></span><span id="688b" class="kz la it md b gy ml mi l mj mk">curl -sfL <a class="ae lx" href="https://get.k3s.io" rel="noopener ugc nofollow" target="_blank">https://get.k3s.io</a> &gt; install.sh<br/>chmod a+rx install.sh</span></pre><p id="f874" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">将这些文件复制到受限节点。我的K3s设置在一个节点中。运行以下命令准备文件，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="75b6" class="kz la it md b gy mh mi l mj mk">sudo mkdir -p /var/lib/rancher/k3s/agent/images/<br/>sudo cp k3s-airgap-images-amd64.tar.gz /var/lib/rancher/k3s/agent/images/<br/>    <br/>sudo cp k3s /usr/local/bin<br/>sudo chmod a+rx /usr/local/bin/k3s</span><span id="4e0d" class="kz la it md b gy ml mi l mj mk">cd /var/lib/rancher/k3s/agent/images/<br/>sudo gunzip k3s-airgap-images-amd64.tar.gz</span></pre><p id="27cc" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">安装K3s，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="080d" class="kz la it md b gy mh mi l mj mk">INSTALL_K3S_SKIP_DOWNLOAD=true INSTALL_K3S_EXEC="--write-kubeconfig-mode 644"  INSTALL_K3S_SKIP_SELINUX_RPM=true INSTALL_K3S_SELINUX_WARN=true ./install.sh</span></pre><p id="4163" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">请注意，底层CentOS禁用了SELinux，因此我们安装K3s时没有SELinux选项。这避免了安装额外的rpm。</p><p id="6079" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">K3s现在已经上线运行了，就这么简单。</p><h2 id="eba8" class="kz la it bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">填充注册表容器图像</h2><p id="59a9" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">让我们为airgap K3s映像使用一个更通用的解决方案，为K3s设置一个私有注册表。</p><p id="b695" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然而，这似乎是一个鸡和蛋的问题。注册表本身需要首先填充容器映像…</p><p id="49a4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们在这里可以做的是使用containerd命令行工具<code class="fe mm mn mo md b">ctr</code>，将容器映像导入本地文件系统。</p><p id="0a13" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在没有设置Docker守护进程的情况下，在面向互联网的服务器上安装<code class="fe mm mn mo md b">skopeo</code>工具，下载私有注册中心的容器映像，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="231b" class="kz la it md b gy mh mi l mj mk">skopeo copy docker://docker.io/library/registry:2 docker-archive:./registry.tar:library/registry:2</span></pre><p id="2145" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">上面的命令基本上将容器映像从docker hub复制到docker tar格式文件中。请注意，我们在tar文件名后面附加了图像名称，以便让tar文件内容具有图像的名称，否则在稍后导入containerd时，未命名的图像将被忽略。</p><p id="3a87" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">将tar文件传输到受限的K3s服务器，将其加载到containerd文件系统中</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="b4a3" class="kz la it md b gy mh mi l mj mk">sudo $(which k3s) ctr images import registry.tar</span></pre><p id="5b73" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您列出图像，您将看到注册表图像现在是可用的。</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="fddb" class="kz la it md b gy mh mi l mj mk">sudo $(which k3s) crictl images | grep registry</span><span id="3edf" class="kz la it md b gy ml mi l mj mk">docker.io/library/registry                               2                      1fd8e1b0bb7ef       26.8MB</span></pre><p id="f944" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们准备在K3s中运行私有注册表。但在此之前，让我们准备必要的工具。</p><h2 id="e211" class="kz la it bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">填充工具图像</h2><p id="c4ab" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">我们需要工具，比如<code class="fe mm mn mo md b">skopeo</code>，将工作负载映像加载到私有注册表中。</p><p id="e760" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">由于环境是封闭的和受限制的，我们不能自由地安装所需的工具和所有的依赖模块或库。然而，事实上，我们不一定需要搞乱主机OS，我们可以将容器映像用于我们的工具。</p><p id="db44" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们将图像工具构建为一个容器图像。创建以下Dockerfile文件，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="53af" class="kz la it md b gy mh mi l mj mk">FROM alpine<br/>RUN  apk --no-cache add curl &amp;&amp; \<br/>     apk --no-cache add skopeo --repository=<a class="ae lx" href="http://dl-cdn.alpinelinux.org/alpine/edge/community" rel="noopener ugc nofollow" target="_blank">http://dl-cdn.alpinelinux.org/alpine/edge/community</a></span></pre><p id="f3c4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">选择alpine作为基础映像，添加来自edge社区repo的<code class="fe mm mn mo md b">skopeo</code>包。</p><p id="f1e4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">用podman来构建，不需要后台像Docker一样运行守护进程。</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="f7f5" class="kz la it md b gy mh mi l mj mk">podman build -t tools:v1.0 .</span></pre><p id="2d4f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">使用相同的方法将本地映像复制到一个tar文件中，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="2daa" class="kz la it md b gy mh mi l mj mk">skopeo copy containers-storage:localhost/tools:v1.0 docker-archive:./tools.tar:tools:v1.0</span></pre><p id="c492" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">传输文件，并导入到容器中，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="f919" class="kz la it md b gy mh mi l mj mk">sudo $(which k3s) ctr images import tools.tar</span></pre><p id="7cad" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，注册表和工具的容器映像都准备好了。</p><h2 id="b8cb" class="kz la it bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">在K3s中运行私有注册表</h2><p id="a6cb" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">我们将使用htpasswd身份验证、启用https、持久化部署来运行私有注册表。</p><p id="a656" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu"> <em class="mp">创建命名空间</em> </strong></p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="caf3" class="kz la it md b gy mh mi l mj mk">kubectl create ns registry</span></pre><p id="5280" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu"> <em class="mp">创建htpasswd秘密</em> </strong></p><p id="6f90" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在您拥有完全控制权的服务器上安装htpasswd工具，或者使用以下golang代码片段来准备htpasswd.txt文件</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="d5c6" class="kz la it md b gy mh mi l mj mk">encrypted, err := bcrypt.GenerateFromPassword([]byte("password"), bcrypt.DefaultCost)</span></pre><p id="2cb3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">htpasswd.txt文件应该如下所示，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="5d5f" class="kz la it md b gy mh mi l mj mk">admin:{{ .encrypted }}</span></pre><p id="5665" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">将htpasswd文件传输到K3s节点，创建密码</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="10ec" class="kz la it md b gy mh mi l mj mk">kubectl -n registry create secret generic htpasswd --from-file=htpasswd=htpasswd.txt</span></pre><p id="f774" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu"> <em class="mp">创建证书和秘密</em> </strong></p><p id="184e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">使用cfssl创建证书和密钥对，如<a class="ae lx" rel="noopener ugc nofollow" target="_blank" href="/setup-a-private-registry-on-k3s-f30404f8e4d3">我过去的论文</a>中所述，或者使用您最喜欢的工具。请注意，证书中的SAN需要包括K3s节点的主机名。您还可以考虑将K8s服务名称添加为SAN名称的一部分。</p><p id="8e41" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">创造K8s秘密，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="d4ec" class="kz la it md b gy mh mi l mj mk">kubectl -n registry create secret tls tls-registry --cert=registry.pem --key=registry-key.pem</span></pre><p id="c2b0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu"> <em class="mp">创建PVC </em> </strong></p><p id="a6b7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">应用以下YAML创建PVC</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="c940" class="kz la it md b gy mh mi l mj mk">apiVersion: v1<br/>kind: PersistentVolumeClaim<br/>metadata:<br/>  name: pvc-registry<br/>  namespace: registry<br/>spec:<br/>  accessModes:<br/>    - ReadWriteOnce<br/>  resources:<br/>    requests:<br/>      storage: 20Gi</span></pre><p id="5ae9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu"> <em class="mp">创建部署</em> </strong></p><p id="8846" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">应用以下部署，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="60af" class="kz la it md b gy mh mi l mj mk">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: registry<br/>  namespace: registry<br/>  labels:<br/>    app: registry<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: registry<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: registry<br/>    spec:<br/>      containers:<br/>      - name: registry<br/>        image: registry:2<br/>        <strong class="md iu">imagePullPolicy: IfNotPresent</strong><br/>        ports:<br/>        - containerPort: 5000<br/>        env:<br/>        - name: REGISTRY_AUTH<br/>          value: htpasswd<br/>        - name: REGISTRY_AUTH_HTPASSWD_REALM<br/>          value: Registry Realm<br/>        - name: REGISTRY_AUTH_HTPASSWD_PATH<br/>          value: /auth/htpasswd<br/>        - name: REGISTRY_HTTP_TLS_CERTIFICATE<br/>          value: /certs/tls.crt<br/>        - name: REGISTRY_HTTP_TLS_KEY<br/>          value: /certs/tls.key<br/>        volumeMounts:<br/>        - name: registry<br/>          mountPath: /var/lib/registry<br/>        - name: tls-registry<br/>          mountPath: /certs<br/>        - name: htpasswd<br/>          mountPath: /auth<br/>      volumes:<br/>      - name: registry<br/>        persistentVolumeClaim:<br/>          claimName: pvc-registry<br/>      - name: tls-registry<br/>        secret:<br/>          secretName: tls-registry<br/>      - name: htpasswd<br/>        secret:<br/>          secretName: htpasswd</span></pre><p id="773c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">查看环境变量如何用于注册表配置。</p><p id="3752" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">注意，我们将imagePullPolicy设置为IfNotPresent。由于我们已经将图像填充到文件系统中，kubelet不会从互联网上获取图像。</p><p id="acd4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu"> <em class="mp">揭露服务</em> </strong></p><p id="312d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">应用以下K3s负载平衡器服务，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="ad78" class="kz la it md b gy mh mi l mj mk">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: svc-registry<br/>  namespace: registry<br/>spec:<br/>  type: LoadBalancer<br/>  ports:<br/>    - name: http<br/>      port: 5000<br/>      targetPort: 5000<br/>  selector:<br/>    app: registry</span></pre><p id="7c4b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu"> <em class="mp">信任CA </em> </strong></p><p id="597e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让操作系统信任注册表的CA，myca.pem</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="5d26" class="kz la it md b gy mh mi l mj mk">sudo cp myca.pem /etc/pki/ca-trust/source/anchors/myca.crt<br/>sudo update-ca-trust</span></pre><p id="e1b3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，如果您对注册表进行curl操作，您应该会看到一个空的图像列表，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="139f" class="kz la it md b gy mh mi l mj mk">curl -u admin:password <a class="ae lx" href="https://centos7:5000/v2/_catalog" rel="noopener ugc nofollow" target="_blank">https://centos7:5000/v2/_catalog</a><br/>{"repositories":[]}</span></pre><h2 id="2eec" class="kz la it bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">配置专用K3S注册表</h2><p id="a74b" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">一旦注册表开始运行，我们就可以像在配置文件<code class="fe mm mn mo md b">/etc/rancher/k3s/registries.yaml</code>中一样更新k3s注册表设置，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="1cff" class="kz la it md b gy mh mi l mj mk">mirrors:<br/>  quay.io:<br/>    endpoint:<br/>      - "<a class="ae lx" href="https://centos7:5000" rel="noopener ugc nofollow" target="_blank">https://centos7:5000</a>"<br/>  docker.io:<br/>    endpoint:<br/>      - "<a class="ae lx" href="https://centos7:5000" rel="noopener ugc nofollow" target="_blank">https://centos7:5000</a>"<br/>  k8s.gcr.io:<br/>    endpoint:<br/>      - "<a class="ae lx" href="https://centos7:5000" rel="noopener ugc nofollow" target="_blank">https://centos7:5000</a>"<br/>configs:<br/>  "centos7:5000":<br/>    auth:<br/>      username: admin<br/>      password: password<br/>    tls:<br/>      cert_file: /etc/rancher/k3s/certs/registry.pem<br/>      key_file: /etc/rancher/k3s/certs/registry-key.pem<br/>      ca_file: /etc/rancher/k3s/certs/myca.pem</span></pre><p id="e7f4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">请注意镜像是如何定义的，以便将外部注册表映射到K3s私有注册表。重新启动K3s服务以使更改生效。</p><h2 id="5077" class="kz la it bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">填充工作负载映像</h2><p id="a449" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">以Prometheus-operator为例，我们需要以下图像</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="3043" class="kz la it md b gy mh mi l mj mk">quay.io/prometheus/prometheus:v2.26.0<br/>quay.io/prometheus/node-exporter:v1.1.2<br/>quay.io/prometheus/blackbox-exporter:v0.18.0<br/>quay.io/prometheus/alertmanager:v0.21.0<br/>quay.io/prometheus-operator/prometheus-operator:v0.47.0<br/>quay.io/prometheus-operator/prometheus-config-reloader:v0.47.0<br/>quay.io/brancz/kube-rbac-proxy:v0.8.0<br/>k8s.gcr.io/kube-state-metrics/kube-state-metrics:v2.0.0<br/>jimmidyson/configmap-reload:v0.5.0<br/>grafana/grafana:7.5.4<br/>directxman12/k8s-prometheus-adapter:v0.8.4</span></pre><p id="ba0e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下载skopeo作为tar文件的图像。举个例子，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="9c4c" class="kz la it md b gy mh mi l mj mk">skopeo copy docker://quay.io/prometheus/prometheus:v2.26.0 docker-archive:./prometheus.tar:prometheus:v2.26.0</span></pre><p id="a4ab" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">将tar文件传输到K3s节点。首先，将工具映像作为Pod运行，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="982d" class="kz la it md b gy mh mi l mj mk">kubectl run loader --image=tools:v1.0 --command -- sh -c 'while true; do sleep 10; done'</span></pre><p id="a177" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">将镜像加载到K3s中运行的私有注册表中。举个例子，</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="1921" class="kz la it md b gy mh mi l mj mk">kubectl cp prometheus.tar loader:/tmp</span><span id="4cf3" class="kz la it md b gy ml mi l mj mk">kubectl exec -i loader -- skopeo copy --dest-creds admin:password --dest-tls-verify=false --insecure-policy docker-archive:/tmp/prometheus-operator.tar docker://centos7:5000/prometheus-operator/prometheus-operator:v0.47.0</span></pre><p id="deba" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一旦所有映像都被填充到K3s私有注册表中，您就可以开始部署Prometheus operator网站中记录的工作负载。</p></div></div>    
</body>
</html>