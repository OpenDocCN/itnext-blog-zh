<html>
<head>
<title>How We Improved our Node.js Application Security Grade from F to A</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我们如何将Node.js应用程序的安全等级从F级提高到A级</h1>
<blockquote>原文：<a href="https://itnext.io/how-we-improved-our-node-js-application-security-grade-from-f-to-a-cd42b48192e3?source=collection_archive---------0-----------------------#2019-05-25">https://itnext.io/how-we-improved-our-node-js-application-security-grade-from-f-to-a-cd42b48192e3?source=collection_archive---------0-----------------------#2019-05-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="734d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在客户端和服务器端安全地配置应用程序与开发应用程序一样重要，甚至更重要。因此，我和我的队友开始着手解决应用程序中的安全基础问题。像<a class="ae kl" href="https://www.ssllabs.com/" rel="noopener ugc nofollow" target="_blank"> SSL实验室</a>、<a class="ae kl" href="https://securityheaders.com/" rel="noopener ugc nofollow" target="_blank">安全头</a>和<a class="ae kl" href="https://observatory.mozilla.org/" rel="noopener ugc nofollow" target="_blank">观察站</a>这样的在线服务是测试你的应用的好地方，这也是我们开始的地方。全副武装，精神饱满，我们一头扎了进去！</p><h1 id="075e" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">标杆管理</h1><p id="0f44" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">我们的第一次考试分数高得惊人！SSL实验室的A+。🎉 🎉 🎉</p><blockquote class="lp lq lr"><p id="796f" class="jn jo ls jp b jq jr js jt ju jv jw jx lt jz ka kb lu kd ke kf lv kh ki kj kk ij bi translated">SSL实验室是一项免费的在线服务，它对公共互联网上的任何SSL web服务器的配置进行深度分析。</p></blockquote><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi lw"><img src="../Images/28a3bb0ffae87a424e3f4c610cec7a22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A9OP2HOJ4blmIRPIWqWdAA.png"/></div></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">来自SSL实验室的SSL报告</figcaption></figure><p id="156b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">SSL证书创建加密连接，并在服务器和客户端之间建立信任。为了向网站用户保证他们的连接是安全的，浏览器会提供某些提示，例如绿色挂锁。SSL实验室验证所提供的证书是有效的和可信的。它们扫描服务器配置，如协议支持、密码支持和密钥交换支持。作为最佳实践，建议从可靠的证书颁发机构(CA)获取证书。</p><p id="67eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以回到安全测试…</p><p id="a3b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">到目前为止我们做得很好。我们非常高兴。下一步是扫描我们的应用程序的响应头…结果是惊人的！！！😱😱😱</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mm"><img src="../Images/6ee67c3552e5f209687fd3aef67a7dc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AJs24k2Gs3Czk-rJ8SCH9A.png"/></div></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">扫描摘要</figcaption></figure><p id="023b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个F！一个骇人听闻的F！这几乎是可笑的。但抛开骄傲不谈，这将是一次很好的学习机会。幸运的是，扫描总结结果详细分析了我们的应用程序在每个单独的安全测试中的表现。</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mn"><img src="../Images/9875036a8a24ec93f36a1ef0e45ba0c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7DlxGKpioHAAopxE4vYhlQ.png"/></div></div></figure><h1 id="7ffd" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">理解问题</h1><p id="2e1f" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">要找到解决方法，你必须知道问题。所以我们开始这样做。我们首先必须理解所有这些响应头的重要性。以下是我们调查结果的总结:</p><ol class=""><li id="036e" class="mo mp iq jp b jq jr ju jv jy mq kc mr kg ms kk mt mu mv mw bi translated"><strong class="jp ir">内容安全策略(CSP) </strong>:授权网站运营商控制从何处加载他们网站上的资源。通过这种方式，它可以防止跨站点脚本(XSS)漏洞。也可用于将HTTP升级到HTTPS。</li><li id="68d8" class="mo mp iq jp b jq mx ju my jy mz kc na kg nb kk mt mu mv mw bi translated"><strong class="jp ir"> Cookies </strong>:所有的Cookies都应该尽可能地限制访问。这有助于将跨站点脚本(XSS)漏洞造成的损害降至最低，因为这些cookies通常包含会话标识符或其他敏感信息。</li><li id="880a" class="mo mp iq jp b jq mx ju my jy mz kc na kg nb kk mt mu mv mw bi translated"><strong class="jp ir">跨源资源共享</strong>:限制哪些外来源被允许通过脚本访问您的域上的页面内容。用例包括为JavaScript/CSS库和公共API端点提供托管的内容交付网络(cdn)</li><li id="5639" class="mo mp iq jp b jq mx ju my jy mz kc na kg nb kk mt mu mv mw bi translated"><strong class="jp ir"> HTTP公钥密码(HPKP) </strong>:小心！这个响应头应该在非常小心的情况下实现，并且只有在你真的需要的时候。HPKP指示用户代理将站点绑定到特定的根证书颁发机构、中间证书颁发机构或终端实体公钥。这可以防止证书颁发机构为给定域颁发未经授权的证书，而该域仍然是浏览器信任的。</li><li id="5fd1" class="mo mp iq jp b jq mx ju my jy mz kc na kg nb kk mt mu mv mw bi translated"><strong class="jp ir"> HTTP严格传输安全(HSTS) </strong>:指示web浏览器仅通过HTTPS访问您的站点，即使选择的方案是HTTP。</li><li id="8e31" class="mo mp iq jp b jq mx ju my jy mz kc na kg nb kk mt mu mv mw bi translated"><strong class="jp ir">重定向</strong>:指示通过HTTP侦听的站点重定向到HTTPS。一旦发生重定向，CSP/HSTS应该确保以后所有通过HTTP访问该站点的尝试都直接发送到安全的站点。</li><li id="ef28" class="mo mp iq jp b jq mx ju my jy mz kc na kg nb kk mt mu mv mw bi translated">Referrer策略:授权站点运营商控制浏览器如何以及何时通知目标站点请求的来源。</li><li id="15ec" class="mo mp iq jp b jq mx ju my jy mz kc na kg nb kk mt mu mv mw bi translated"><strong class="jp ir">子资源完整性(SRI) </strong>:防止远程资源文件的内容修改，最常见的是内容交付网络(cdn)。这种修改的主要原因可能是在所有使用该托管资源的网站中产生漏洞。</li><li id="7097" class="mo mp iq jp b jq mx ju my jy mz kc na kg nb kk mt mu mv mw bi translated"><strong class="jp ir"> X-Content-Type-Options </strong>:指示浏览器不要猜测web服务器正在传送的文件的MIME类型。如果没有这个响应头，浏览器可能会错误地将文件检测为脚本和样式表，从而导致XSS攻击。</li><li id="8d32" class="mo mp iq jp b jq mx ju my jy mz kc na kg nb kk mt mu mv mw bi translated"><strong class="jp ir"> X-Frame-Options </strong>:通过控制如何在iframe中构建站点来保护站点免受点击劫持攻击。点击劫持是一种实用的攻击，它允许恶意站点欺骗用户点击您站点上的链接，即使这些链接看起来根本不在您的站点上。值得注意的是，这是在CSP的祖先指令之前。</li><li id="02ae" class="mo mp iq jp b jq mx ju my jy mz kc na kg nb kk mt mu mv mw bi translated"><strong class="jp ir"> X-XSS保护</strong>:防止反射跨站脚本(XSS)攻击。这也已经被CSP取代。</li></ol><h1 id="754d" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">样本Node.js条目文件</h1><p id="d3b6" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">下面是starter Express应用程序入口文件的精简代码。这将是我们研究各种解决方案的起点。</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi nc"><img src="../Images/b4acf8e48ee5a744134f903d78ad25c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IY-4hP6UXxjhjEEmzQs9kQ.png"/></div></div></figure><h1 id="0dd0" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">解决方案1 — response.setHeader(名称，值)</h1><p id="8bb8" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">这是一个绑定到Node.js中请求的response对象的函数，它为隐式头设置了一个头值。需要注意的是，如果这个头已经存在于待发送的头中，它的值将被覆盖。</p><p id="e023" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">示例:</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi nd"><img src="../Images/3260aa21a6ce2722586ad284639e01a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ShdGkhv_DkCv75tQKmXyMg.png"/></div></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">手动设置响应标头</figcaption></figure><p id="1cbf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以很容易地使用这种方法，并像这样设置所有的响应头。它让我们能够更好地控制我们有意声明的响应头。</p><h1 id="f79c" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">解决方案2 —头盔</h1><blockquote class="lp lq lr"><p id="9b12" class="jn jo ls jp b jq jr js jt ju jv jw jx lt jz ka kb lu kd ke kf lv kh ki kj kk ij bi translated">头盔通过设置各种HTTP头来帮助您保护您的Express应用程序。<em class="iq">不是银弹</em>，但是能帮上忙！</p></blockquote><p id="7673" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">头盔是一个NPM库，它提供了中间件功能，自动为我们设置一些现成的HTTP响应头。很容易覆盖这些头的默认值，或者扩展它们以包含额外的值。</p><p id="9c91" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将头盔库安装到Node.js应用程序中。</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi ne"><img src="../Images/51c8beefae644f27a4b7189cdaff38e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nerXnd9sz70odDAlgYqf6A.png"/></div></div></figure><p id="8023" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">导入库并应用它。</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi nf"><img src="../Images/ee52f6a184d8ab06374349443f508ecb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8SxX1_XQqIr5Q_mWlmVesg.png"/></div></div></figure><p id="c6af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">开箱即用，这个简单的两步程序将扫描结果从F级提高到b级。考虑到头盔几乎为我们做了所有的事情，这还不算太坏。</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mm"><img src="../Images/87838d3d9dfa54a1e6e4ed76151604b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1dklsI0FgGG5PKVboYdoWw.png"/></div></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">扫描结果</figcaption></figure><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi ng"><img src="../Images/1e57976a3c179925b5f7f807b9316e51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8UABoZh8pOugUuZI6kVnUg.png"/></div></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">回应标题测试分数</figcaption></figure><p id="2137" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">默认情况下，头盔不会包含所有这些中间件功能。我们现在可以将扫描结果从B级提升到A级，方法是根据上面的分数确定缺少的标题，并扩展头盔配置以包含它们。在这种情况下，最引人注目的是CSP报头。下面是一个如何将额外的响应头传递给头盔的例子。</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi nh"><img src="../Images/dd3270377063a153d43b49b9c8b79d18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lltgb4s3M0LKFawyGliT0g.png"/></div></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">将额外的响应头传递给中间件</figcaption></figure><h1 id="10c0" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">喜悦</h1><p id="9453" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">女士们先生们，这就是我们从F到a的过程。</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi ni"><img src="../Images/d6473c25c58211efe81b0fd5bca89306.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HKgRjHuFES_ICGdsg1XStw.png"/></div></div></figure><h1 id="d461" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">收拾东西</h1><p id="177e" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">关于应用程序的安全性，还有很多内容没有在本文中介绍。编写安全的应用程序必须是有意识的。有许多库提供现成的安全实现，但是要真正控制漏洞攻击，必须清楚地了解它们所防范的威胁的种类和性质。</p></div></div>    
</body>
</html>