# 有空 10 分钟吗？让我们回顾一下 AWS IAM！

> 原文：<https://itnext.io/got-10-minutes-lets-recap-aws-iam-b8c50f77d21?source=collection_archive---------8----------------------->

![](img/0993cf1530a1c3f798b9408ccc31a153.png)

开始和 AWS 合作已经有一段时间了。我很喜欢它，但有几件事曾经对我特别有挑战性，我就是其中之一。我经常遇到由于权限设置不正确而导致服务拒绝协同工作的问题。

目前，我正在准备 AWS 解决方案架构师助理考试。这篇博文是我关于 IAM 的笔记的汇编。我现在知道得更多了，这篇博文是我希望一年前就能看到的。如果您需要快速复习 IAM，这是浏览文章并获得服务功能概述的好地方。

鉴于所有这些，我在这篇文章中主要关注理论和定义。我认为在深入研究之前，知道自己在做什么是至关重要的。因此，如果您想加深对该服务的理解，请阅读它！然后，进行大量的知识和实践😉

# 🤔我思故我在

IAM 代表身份和访问管理。大多数 AWS 服务都是地区性的，但 IAM 是全球性的服务。这意味着所有用户、角色等将在您的帐户可访问的所有区域可用。

IAM 的职责主要围绕两个方面:

*   它允许您创建用户，管理他们对各种服务的访问，并将他们组织成组。
*   它控制 AWS 应用程序和服务之间的通信，以便只有系统中需要的组件才能相互通信。

**默认情况下，您在系统中创建的所有实体都不能访问 AWS 中的任何其他内容。**这意味着作为管理员，您可以完全控制 AWS 帐户的访问权限。最好只给用户和服务分配最低限度的权限，以便他们只能执行您希望他们执行的操作。对权限限制采取过于宽松的方法会在系统遭到破坏时带来额外的麻烦。

让我们看看 IAM 的各个组件，从用户开始。

# 👥用户和组

IAM 有一套强大的工具来管理属于您的应用程序的用户和组。让我们进一步定义这些概念。

**用户**是来自你的组织的人，负责管理你的 AWS 账户中的应用程序。您可以通过直接向它们分配权限来单独管理它们。然而，通常情况下，最好将它们组织成组。

群组将帮助你把你的组织分成易于管理的实体。将权限分配给组时，所有组成员都可以访问这些权限。有一点很重要，一个组只能包含用户；您不能将组嵌套在其他组中。另一方面，一个用户可以属于多个组。发生这种情况时，这样的用户可以享受所有组的访问权限。

# 🚦权限和策略

**权限控制对 AWS 服务的访问。**它们是细粒度的，这意味着您可以非常具体地指定想要授予用户或服务的访问权限级别。例如，您可以允许用户读取 S3 存储桶，但阻止他们上传新文件。您还可以更进一步，允许访问存储桶的子集，防止删除项目，等等。可能性实际上是无限的。

**您可以在 JSON 文档中存储称为策略的权限集。**下面的示例显示了授予对 S3 服务的完全访问权限的策略。

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "FullAccess",
            "Principal": "*",
            "Effect": "Allow",
            "Action": ["s3:*"],
            "Resource": ["*"]
        }
    ]
}
```

**让我们看看策略的各个部分**并描述它们各自的作用:

## 🔸版本[必需]

*   应始终等于“2012–10–17”。

## 🔸id[可选]

*   策略的自定义 ID。

## 🔸语句[必需]

*   该元素可以包含单个语句，也可以包含一组语句。每个人都可以为不同的资源授予不同的权限集。

**语句也有其模式。**我们来看看，试着描述一下每个元素。

## 🔸sid[可选]

*   语句的可选 ID。

## 🔸效果[必需]

*   可以将`Allow`或`Deny`作为值。因此，语句中提到的主体将(或不)能够访问资源。

## 🔸委托人[必填]

*   描述谁将受到此策略的影响。您可以提供`*`来允许每个人使用该策略或将其限制到特定的实体。对于用户，您可以提供他们的 arn，arn 是以`arn:aws`开头的标识符，例如`arn:aws:iam::123456789012:root`。对于 AWS 服务，您可以用`service-name.amazonaws.com`格式提供它们的标识符，例如`ecs.amazonaws.com`。当策略附加到用户时，您可以省略主体字段。

## 🔸操作[必需]

*   它描述了主体能够在引用的资源上执行的一组操作。例如，如果您希望策略控制谁可以从 S3 存储桶中读取项目，那么您应该使用`s3:GetObject`。这里列出了您可以使用的所有动作标识符及其功能:[docs.aws.amazon.com/service-authorization/l..](https://docs.aws.amazon.com/service-authorization/latest/reference/reference_policies_actions-resources-contextkeys.html)您可以在这个元素中放置多个动作。

## 🔸资源[必需]

*   主体能够访问的资源列表。通常，您应该在这里提供一个 ARNs 列表，例如`"arn:aws:s3:::example-bucket"`。

## 🔸条件[可选]

*   该元素可以将策略的有效性限制在某些条件下。例如，您可能希望通过指定日期使权限成为临时权限，如下所示:

```
"Condition" :  {
      "DateGreaterThan" : {
         "aws:CurrentTime" : "2021-10-16T12:00:00Z"
       },
      "DateLessThan": {
         "aws:CurrentTime" : "2021-10-16T15:00:00Z"
       }
}
```

# 🔍我们来看一个例子！

现在，我们试着自己构建一个策略来磨练对题目的理解。我们将从允许每个人做所有事情的那个开始。然后我们会在各个层面上限制政策，我会解释这是怎么回事。话不多说，这是每个 AWS 用户最糟糕的噩梦，尽管很不安全！👏

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Principal": "*",
            "Effect": "Allow",
            "Action": ["*"],
            "Resource": ["*"]
        }
    ]
}
```

**假设我们想要限制使用该策略执行的动作数量**。AWS 提供了两个动作来授予对 S3 存储桶的读访问权限:`s3:GetObject`和`s3:GetObjectVersion`。因此，如果我们想要更改策略以允许每个人都可以读取所有 S3 存储桶中的项目，它将如下所示。请注意，您可以使用通配符，这样就不需要列出每个权限。

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Principal": "*",
            "Effect": "Allow",
            "Action": ["s3:GetObject*"],
            "Resource": ["*"]
        }
    ]
}
```

太好了！**现在我们可以更加严格地限制用户可以读取的存储桶**。让我们假设我们所有的桶名都有一个`my-awesome-app`前缀。要将策略仅应用于这些存储桶，我们应该修改`Resource`元素:

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Principal": "*",
            "Effect": "Allow",
            "Action": ["s3:GetObject", "s3:GetObjectVersion"],
            "Resource": ["arn:aws:s3:::my-awesome-app*"]
        }
    ]
}
```

看起来更好！**最后一步，让我们只允许托管在 EC2 中的服务器访问存储桶。这意味着我们应该改变`Principal`元素:**

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Principal": "ec2.amazonaws.com",
            "Effect": "Allow",
            "Action": ["s3:GetObject", "s3:GetObjectVersion"],
            "Resource": ["arn:aws:s3:::my-awesome-app*"]
        }
    ]
}
```

瞧啊。您刚刚建立了一个策略🎉我希望这个例子阐明了每个元素的责任，并给你更多的信心来创建你的策略。

# 😎三件额外的事情

**第一件事！**在上面的例子中，您可能已经注意到了，我使用了一个巧妙的技巧——您的策略可以利用通配符，使得构建策略更加容易。它适用于动作和资源。比如我们来看看这三个权限:`s3:GetObject`、`s3:GetBucketLocation`、`s3:ListBucket`。如果您想将所有这些权限应用于一个资源，您可以在策略中使用`s3:*`。如果只想应用`s3:GetObject`和`s3:GetBucketLocation`，可以使用`s3:Get*`。

**第二件事**是您可以将策略附加到个人用户和组。分配给组后，所有组成员都将访问策略中引用的资源。

**最后一件事** -您不必为每个新用户或组创建新的内联策略。相反，您可以将它们存储为客户管理的策略，并随意将其附加到所有实体！

现在，让我们进入角色。它们将这个已经很复杂的系统提升到了一个全新的高度😉

# 🎭角色

角色是 IAM 权限管理中更抽象的一层。虽然 IAM 角色可以访问特定的策略文档，但是它们不会绑定到特定的用户。相反，AWS 提供的任何用户或服务都可以使用它们。

**用户通常在想要访问账户之间的资源时使用角色。**然而，一个更常见的用例是**将一个 IAM 角色分配给一个服务，以与另一个服务进行交互**。默认情况下，AWS 服务不能相互通信，除非通过策略明确允许。但是，例如，如果您需要您的 Lambdas 将文件上传到 S3 存储桶，您可以创建一个具有允许您这样做的权限的角色。

每当您尝试使用一个角色访问另一个服务时，AWS 将提供一组临时凭证来在服务之间进行通信。这意味着您不需要(也不应该)在任何地方上传您的凭证来使 AWS 工作。

# ✋权限边界

您可能仍然希望为您的帐户引入更高级别的安全性。**权限边界是一种特殊的策略，允许您指定用户或角色可以拥有的最大权限。**正如我上面提到的，如果一个用户属于几个组，他们将可以访问所有组的策略。尽管如此，在某些情况下，设置一些界限是合理的。让我们看一个例子。

让我们假设我们的组织中有两个组:软件工程师，他们有一些权限，以及 DevOps，他们有不同的访问级别，包括 EC2 实例删除权限。我们的一名软件工程师 Bob 将从这两个组中获益匪浅。然而，我们不希望他能够摧毁我们的基础设施。为了解决这个问题，我们可以将 Bob 分配给两个组，并附加一个权限边界，禁止他删除 EC2 实例。权限边界是一个策略，这意味着您可以通过 JSON 文档将其附加到用户。因此，为了实现上述结果，我们可以使用这样的策略将 Bob 与 EC2 交互的能力限制为只读访问:

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ec2:DescribeInstances", 
                "ec2:DescribeImages",
                "ec2:DescribeTags", 
                "ec2:DescribeSnapshots"
            ],
            "Resource": "*"
        }
    ]
}
```

# 🔑资格证书

最后，我想重点谈谈用户如何在 AWS 中验证自己。你可以通过两种方式做到这一点——通过你的电子邮件或使用 AWS 提供的密钥。

**要通过您的网络浏览器登录 AWS 管理控制台，**您可以使用电子邮件和密码的组合。帐户管理员可以设置密码策略，强制用户以特定的方式设置密码。例如，它们可能需要大写和小写字母以及特殊字符。帐户管理员也可以设置 SSO 来代替密码。

帐户管理员可以通过打开多因素身份验证来加强安全性。它要求用户拥有第二台设备来为登录过程的第二步提供令牌。AWS 允许使用虚拟和物理 MFA 设备。虚拟设备通常是智能手机上的一个应用程序，如 Google Authenticator。物理设备通常是 USB 加密狗。

**AWS 访问密钥用于使用 CLI 或从您构建的应用程序连接 AWS。**它们由两部分组成:访问密钥 ID 和秘密访问密钥。它们看起来像这样:

*   访问密钥 ID: `AKIAIOSFODNN7EXAMPLE`
*   秘密访问密钥:`wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY`

您必须同时提供两个密钥才能与 AWS 交互。就像你的用户名和密码一样，你不应该和任何人分享。如果密钥遭到破坏，可以在 IAM 控制台中禁用它们。此外，您的秘密访问密钥仅在创建过程中可见。这意味着如果它们丢失了，您将无法恢复它们，因此您需要生成一个新的密钥对来使用 AWS。

AWS IAM 是一个复杂的服务，但幸运的是，在您花时间了解它如何运行之后，它非常有意义。我希望这篇文章有助于将 IAM 中的各种概念组织成易于管理的类别。无论您是想尝试 AWS 中的身份验证和授权，还是需要快速复习 IAM，这都是一本不错的读物！

如果你有任何问题或反馈，请在评论中与我分享！这篇文章最初是我的笔记的集合，我尽我所能对其进行了提炼，但是如果你有任何见解，欢迎让我知道。如果你愿意，你也可以在推特上找到我: [@kampikd](https://twitter.com/kampikd) 。祝您在 AWS 之旅中好运！🙂