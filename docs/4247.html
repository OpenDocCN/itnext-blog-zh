<html>
<head>
<title>Cache HTTP response with Dio-Flutter (http caching)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Dio-Flutter缓存http响应(HTTP缓存)</h1>
<blockquote>原文：<a href="https://itnext.io/cache-your-json-response-with-dio-flutter-http-caching-1fa819776d7d?source=collection_archive---------0-----------------------#2020-05-24">https://itnext.io/cache-your-json-response-with-dio-flutter-http-caching-1fa819776d7d?source=collection_archive---------0-----------------------#2020-05-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/1d6c58fa258045cbf36c984c46d2b2ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*10RECXGTH5NyaeBg5yD1pw.png"/></div></div></figure><p id="6f37" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先将<a class="ae kw" href="https://pub.dev/packages/dio" rel="noopener ugc nofollow" target="_blank"> dio </a>和<a class="ae kw" href="https://github.com/hurshi/dio-http-cache" rel="noopener ugc nofollow" target="_blank"> dio http缓存</a>添加到您的发布中:</p><blockquote class="kx ky kz"><p id="1f0e" class="jy jz la ka b kb kc kd ke kf kg kh ki lb kk kl km lc ko kp kq ld ks kt ku kv ij bi translated">戴奥:^3.0.9</p><p id="ba56" class="jy jz la ka b kb kc kd ke kf kg kh ki lb kk kl km lc ko kp kq ld ks kt ku kv ij bi translated">dio_http_cache: ^0.2.6</p></blockquote><blockquote class="le"><p id="94bd" class="lf lg iq bd lh li lj lk ll lm ln kv dk translated">你可以在故事的结尾看到一个完整的例子</p></blockquote><p id="90fc" class="pw-post-body-paragraph jy jz iq ka b kb lo kd ke kf lp kh ki kj lq kl km kn lr kp kq kr ls kt ku kv ij bi translated">初始化您的<strong class="ka ir"> DioCacheManager </strong>，我们稍后将使用它作为我们的拦截器</p><p id="fd28" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ps:如果需要，我们需要这个对象的一个实例来管理(删除)我们的缓存</p><blockquote class="kx ky kz"><p id="96cd" class="jy jz la ka b kb kc kd ke kf kg kh ki lb kk kl km lc ko kp kq ld ks kt ku kv ij bi translated"><strong class="ka ir">DioCacheManager</strong>_ DioCacheManager = DioCacheManager(CacheConfig())；</p></blockquote><p id="48f4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后从<strong class="ka ir"> buildCacheOptions </strong>()构造函数中创建您的<strong class="ka ir"> Options </strong>对象。</p><p id="e3c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">确保添加maxAge持续时间，它决定了系统应该保留你的缓存多长时间。</p><blockquote class="kx ky kz"><p id="5f21" class="jy jz la ka b kb kc kd ke kf kg kh ki lb kk kl km lc ko kp kq ld ks kt ku kv ij bi translated"><strong class="ka ir">选项</strong>_ cache Options = buildCacheOptions(持续时间(天数:7))；</p></blockquote><p id="771c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以添加forceRefrsh，它将使dio做出如下反应</p><ol class=""><li id="ae61" class="lt lu iq ka b kb kc kf kg kj lv kn lw kr lx kv ly lz ma mb bi translated">首先从网络获取数据。</li><li id="f9d5" class="lt lu iq ka b kb mc kf md kj me kn mf kr mg kv ly lz ma mb bi translated">如果从网络获取数据成功，存储或刷新缓存。</li><li id="b746" class="lt lu iq ka b kb mc kf md kj me kn mf kr mg kv ly lz ma mb bi translated">如果从网络获取数据失败或没有可用的网络，<strong class="ka ir">尝试</strong>从缓存获取数据，而不是错误。</li></ol><blockquote class="kx ky kz"><p id="57df" class="jy jz la ka b kb kc kd ke kf kg kh ki lb kk kl km lc ko kp kq ld ks kt ku kv ij bi translated"><strong class="ka ir">选项</strong>_ cache Options = buildCacheOptions(持续时间(天数:7)，force refresh:true)；</p></blockquote><h2 id="7ba6" class="mh mi iq bd mj mk ml dn mm mn mo dp mp kj mq mr ms kn mt mu mv kr mw mx my mz bi translated">默认值为FALSE，因此dio将检查缓存中是否有旧的响应，如果有，则完成，如果没有，则尝试从网络获取数据。</h2><h2 id="1bf1" class="mh mi iq bd mj mk ml dn mm mn mo dp mp kj mq mr ms kn mt mu mv kr mw mx my mz bi translated">如果您想检查后端是否有新的更新数据，这可能是个问题，所以请考虑将foreceRefresh改为true</h2><p id="c4d2" class="pw-post-body-paragraph jy jz iq ka b kb na kd ke kf nb kh ki kj nc kl km kn nd kp kq kr ne kt ku kv ij bi translated">在<code class="fe nf ng nh ni b">buildCacheOptions</code>中添加的其他参数:</p><ol class=""><li id="70e0" class="lt lu iq ka b kb kc kf kg kj lv kn lw kr lx kv ly lz ma mb bi translated"><strong class="ka ir"> primaryKey: </strong>默认使用<code class="fe nf ng nh ni b">host + path</code>作为主键，也可以自定义。</li><li id="4b40" class="lt lu iq ka b kb mc kf md kj me kn mf kr mg kv ly lz ma mb bi translated"><strong class="ka ir">子项:</strong>默认情况下，query ( data或queryParameters)用作子项，您可以在必要时指定子项，例如:</li></ol><ul class=""><li id="30dd" class="lt lu iq ka b kb kc kf kg kj lv kn lw kr lx kv nj lz ma mb bi translated"><code class="fe nf ng nh ni b">buildCacheOptions(Duration(days: 7), subKey: "page=1"</code></li></ul><p id="0e3c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> 3。maxAge: </strong>设置缓存时间。如果值为null或未设置，它将尝试从响应头中获取maxAge和maxStale。</p><p id="8be6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> 4。maxStale: </strong>设置陈旧时间。当maxStale之前发生错误(比如500，404)时，尝试返回缓存。</p><ul class=""><li id="48b2" class="lt lu iq ka b kb kc kf kg kj lv kn lw kr lx kv nj lz ma mb bi translated"><code class="fe nf ng nh ni b">buildCacheOptions(Duration(days: 7), maxStale: Duration(days: 10))</code></li></ul><p id="8b13" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">是时候对<strong class="ka ir"> Dio </strong>对象添加<strong class="ka ir">拦截器</strong>了，如下所示:</p><blockquote class="kx ky kz"><p id="f17d" class="jy jz la ka b kb kc kd ke kf kg kh ki lb kk kl km lc ko kp kq ld ks kt ku kv ij bi translated">Dio _ Dio = Dio()；</p><p id="911a" class="jy jz la ka b kb kc kd ke kf kg kh ki lb kk kl km lc ko kp kq ld ks kt ku kv ij bi translated">_ dio . interceptors . add(_ diocachemanager . interceptor)；</p></blockquote><p id="f9dd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，将<strong class="ka ir"> _cacheOptions </strong>添加到get http请求中。</p><blockquote class="kx ky kz"><p id="4276" class="jy jz la ka b kb kc kd ke kf kg kh ki lb kk kl km lc ko kp kq ld ks kt ku kv ij bi translated"><strong class="ka ir">响应</strong>响应= <em class="iq">等待</em> _dio.get(</p><p id="8600" class="jy jz la ka b kb kc kd ke kf kg kh ki lb kk kl km lc ko kp kq ld ks kt ku kv ij bi translated">'您的网址'，</p><p id="093a" class="jy jz la ka b kb kc kd ke kf kg kh ki lb kk kl km lc ko kp kq ld ks kt ku kv ij bi translated">options:_ cache options)；</p></blockquote><p id="b49d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就这样…</p><p id="3552" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以通过一次清除所有缓存来删除缓存:</p><blockquote class="kx ky kz"><p id="7a55" class="jy jz la ka b kb kc kd ke kf kg kh ki lb kk kl km lc ko kp kq ld ks kt ku kv ij bi translated">_ diocachemanager . clear all()；</p></blockquote><p id="8e79" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者使用默认的<strong class="ka ir">路径</strong>的<code class="fe nf ng nh ni b">PrimaryKey</code>的特定缓存，或者您可以在缓存选项中自定义它，如下所示:</p><blockquote class="kx ky kz"><p id="8d57" class="jy jz la ka b kb kc kd ke kf kg kh ki lb kk kl km lc ko kp kq ld ks kt ku kv ij bi translated">options _ cache options = buildcache options(持续时间(天数:7)，forceRefresh: true，primary key:' myPrimaryKey ')；</p></blockquote><p id="f2e1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在用这个<strong class="ka ir">主键</strong>删除缓存，我们使用:</p><blockquote class="kx ky kz"><p id="072f" class="jy jz la ka b kb kc kd ke kf kg kh ki lb kk kl km lc ko kp kq ld ks kt ku kv ij bi translated">_ diocachemanager . deletebyprimarykey(' myPrimaryKey ')；</p></blockquote><p id="333d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意，您可以等待结果，因为前面的方法返回一个<strong class="ka ir"><em class="la">Future&lt;bool&gt;</em></strong></p><p id="83ce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以使用这个完整的工作示例来研究它:</p><figure class="nk nl nm nn gt jr"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="6ca8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您也可以从这里下载:</p><div class="nq nr gp gr ns nt"><a href="https://github.com/obadajasm/dio_cache_example" rel="noopener  ugc nofollow" target="_blank"><div class="nu ab fo"><div class="nv ab nw cl cj nx"><h2 class="bd ir gy z fp ny fr fs nz fu fw ip bi translated">obadajasm/dio_cache_example</h2><div class="oa l"><h3 class="bd b gy z fp ny fr fs nz fu fw dk translated">一个新的颤振项目。这个项目是颤振应用的起点。一些帮助您入门的资源…</h3></div><div class="ob l"><p class="bd b dl z fp ny fr fs nz fu fw dk translated">github.com</p></div></div><div class="oc l"><div class="od l oe of og oc oh jw nt"/></div></div></a></div><figure class="nk nl nm nn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oi"><img src="../Images/d605d47ac51ea8761961ed5d27396da4.png" data-original-src="https://miro.medium.com/v2/resize:fit:788/format:webp/1*mrtS828CbnvsVk11F_uU0A.jpeg"/></div></div></figure><p id="b697" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过点击<strong class="ka ir"> getData </strong>按钮，我们从这个URL“https://jsonplaceholder . typicode . com/users”获取JSON数据</p><p id="6b58" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并在将dio请求与dio缓存集成后缓存它，如我们所学</p><p id="1b13" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在你可以退出应用程序，关闭互联网，重新获取数据。</p><p id="9026" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您也可以点击<strong class="ka ir">删除缓存</strong>按钮删除缓存数据。</p><blockquote class="le"><p id="135b" class="lf lg iq bd lh li oj ok ol om on kv dk translated"><strong class="ak">奖励提示</strong>:</p></blockquote><p id="12f3" class="pw-post-body-paragraph jy jz iq ka b kb lo kd ke kf lp kh ki kj lq kl km kn lr kp kq kr ls kt ku kv ij bi translated">数据存储过程将由dio自动处理</p><p id="f264" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是如果你想知道发生了什么</p><p id="d011" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">数据将存储在sqlite数据库中(默认名称为DioCache.db ),您可以使用<strong class="ka ir"> DioCacheManager </strong>中<strong class="ka ir"> CacheConfig </strong>中的<strong class="ka ir"> DatabaseName </strong>参数对其进行定制。</p><p id="f290" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该数据库由两个表组成:</p><ol class=""><li id="997a" class="lt lu iq ka b kb kc kf kg kj lv kn lw kr lx kv ly lz ma mb bi translated">android _元数据</li><li id="16ad" class="lt lu iq ka b kb mc kf md kj me kn mf kr mg kv ly lz ma mb bi translated">缓存_dio</li></ol><figure class="nk nl nm nn gt jr gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/87cd82f848163dd6d38188cb65084bc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:794/format:webp/1*2n8tr3Ohm3Fc7EL8zLVW0w.png"/></div></figure><p id="969d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这些列基本上是不言自明的，但是我们感兴趣的部分是保存属于特定键的<strong class="ka ir">响应</strong>对象的<strong class="ka ir">内容</strong>表。在我们的示例中，只有一个<strong class="ka ir">响应</strong>，因为<strong class="ka ir"> cache_dio </strong>表看起来像这样:</p><figure class="nk nl nm nn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi op"><img src="../Images/9ceb5d98de9e6ee82b9221c35ce1c98b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ojALm_DU4U4bkcZGLAdITQ.png"/></div></div></figure></div></div>    
</body>
</html>