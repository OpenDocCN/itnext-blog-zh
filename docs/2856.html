<html>
<head>
<title>What Are Jenkins Shared Libraries And Why You Should Use Them</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">什么是Jenkins共享库，为什么你应该使用它们</h1>
<blockquote>原文：<a href="https://itnext.io/jenkins-shared-libraries-part-1-5ba3d072536a?source=collection_archive---------2-----------------------#2019-08-15">https://itnext.io/jenkins-shared-libraries-part-1-5ba3d072536a?source=collection_archive---------2-----------------------#2019-08-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="31fc" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Jenkins共享库系列文章的第一部分</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/2bd26feac6a62d72b43262eceec17ed8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s8mwAOWdb2choX4pj9ozvw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://jenkins.io/" rel="noopener ugc nofollow" target="_blank">https://jenkins.io/</a></figcaption></figure></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="e9d8" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">Jenkins是目前最常用的持续集成/部署服务器之一。Jenkins可以将持续集成或部署任务表示为由一个或多个“阶段”组成的“管道”,并且通常被写入一个通常名为“Jenkinsfile”的文件中。Jenkinsfile包含阶段执行的顺序，并且可以包含这些阶段的逻辑。Jenkinsfile也可以签入源代码管理。</p><p id="aa39" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">编写Jenkinsfile时，它很容易变得臃肿，最终可能会变成数百行代码。Jenkinsfile没有层次或继承的概念，因此任何公共函数或逻辑都必须从一个文件复制到另一个文件，以便共享该逻辑。希望这一切听起来很可怕。别担心，我将向您展示如何使用Jenkins共享库来解决这个问题。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="b277" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">什么是詹金斯共享库？</h1><p id="a577" class="pw-post-body-paragraph ld le iq lf b lg mr jr li lj ms ju ll lm mt lo lp lq mu ls lt lu mv lw lx ly ij bi translated">Jenkins共享库是用<a class="ae kv" href="https://groovy-lang.org/" rel="noopener ugc nofollow" target="_blank"> Groovy </a>编写的，允许你创建通用的逻辑集，并在团队/项目/组织之间共享。您不必从其他Jenkins文件中“复制和粘贴”代码，只需将一个库加载到Jenkins中，Jenkins主服务器上的每个管道作业都可以访问该共享库。</p><p id="10bd" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">当编写共享库时，代码必须以一种<a class="ae kv" href="https://jenkins.io/doc/book/pipeline/shared-libraries/#directory-structure" rel="noopener ugc nofollow" target="_blank">特定的方式</a>构建。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mw"><img src="../Images/b9230e460052ec78c59867a5ced5285a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YXEY9RIxW5RnWHACZFbNeA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://jenkins.io/doc/book/pipeline/shared-libraries/#directory-structure" rel="noopener ugc nofollow" target="_blank">https://Jenkins . io/doc/book/pipeline/shared-libraries/# directory-structure</a></figcaption></figure><p id="23e7" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">“vars”目录包含groovy脚本，按照Jenkins的说法，这些脚本被称为“全局vars”。这些是您希望在Jenkinsfile文件中公开使用的步骤。假设您希望创建一个共享步骤来处理一些代码的部署，您可以将名为“deploy.groovy”的文件添加到“vars”目录中。</p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="ce02" class="nc ma iq my b gy nd ne l nf ng">(root)<br/>src/<br/>    ...<br/>vars/<br/>    deploy.groovy<br/>    deploy.txt</span></pre><p id="f270" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">这将允许像这样调用部署步骤</p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="2fca" class="nc ma iq my b gy nd ne l nf ng">node() {<br/>    stage(‘deploy’){<br/>        deploy()  // deploy var from shared library<br/>    }<br/>}</span></pre></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="b2c6" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">为什么应该在管道中使用Jenkins共享库</h1><p id="1f00" class="pw-post-body-paragraph ld le iq lf b lg mr jr li lj ms ju ll lm mt lo lp lq mu ls lt lu mv lw lx ly ij bi translated">假设您的团队中有三个项目，它们都以相同的方式部署代码。你不会想把这个逻辑写三遍。这违反了DRY(不要重复youreslf)原则。这意味着，如果过程发生了变化，那么每个团队都必须更新他们的Jenkinsfile来适应这些变化。这通常包括复制其他人所做的，然后将代码粘贴到他们的项目中，然后进行小的调整以适应他们的项目。</p><p id="fa6e" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">使用共享库，部署项目的代码只需编写一次，然后作为库版本的简单更新提供给所有其他团队。这种关注点的分离将允许团队将他们所有的注意力放在编写代码上，而不是担心如何编写代码来部署代码、进行自动发布等，这反过来节省了时间和金钱。</p><p id="69ba" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">共享库的另一个优点是它们促进了团队之间的协作。有时候团队会低着头，不知道其他人在做什么。这通常会导致相同的代码被多次编写。共享库可以在做类似事情的团队之间架起一座桥梁，并允许这些团队在一段共享的代码上一起工作，这对他们以及任何其他团队都有好处。</p><p id="7a2d" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">让我们看一下部署javascript应用程序的Jenkinsfile。</p><h2 id="a440" class="nc ma iq bd mb nh ni dn mf nj nk dp mj lm nl nm ml lq nn no mn lu np nq mp nr bi translated">原始Jenkinsfile</h2><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="122f" class="nc ma iq my b gy nd ne l nf ng">node {<br/>    checkout scm</span><span id="63bf" class="nc ma iq my b gy ns ne l nf ng">    stage('Install') {<br/>        sh 'npm install'<br/>    }</span><span id="ad01" class="nc ma iq my b gy ns ne l nf ng">    stage('Test') {<br/>        sh 'npm test'<br/>    }</span><span id="c76d" class="nc ma iq my b gy ns ne l nf ng">    stage('Deploy') {<br/>        if (deploy == true) {<br/>            sh 'npm publish'<br/>        }<br/>    }<br/>}</span></pre><p id="afaa" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">现在单单这一点看起来还不算太糟。当您的团队有3个不同的项目，并且都以相同的方式部署一个javascript应用程序时，问题就来了。因此，我们可以利用共享库，而不仅仅是在3个项目之间复制和粘贴代码。</p><p id="917a" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">我们可以从Jenkinsfile中取出代码，并将其包装在一个全局变量中，这样整个管道就可以作为Jenkins的一个名为“buildJavascriptApp”的步骤，供其他任何人在他们自己的Jenkinsfile中使用。</p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="a2e3" class="nc ma iq my b gy nd ne l nf ng">def call() {<br/>    node {<br/>        checkout scm</span><span id="58a4" class="nc ma iq my b gy ns ne l nf ng">        stage('Install') {<br/>            sh 'npm install'<br/>        }</span><span id="a0d9" class="nc ma iq my b gy ns ne l nf ng">        stage('Test') {<br/>            sh 'npm test'<br/>        }</span><span id="75d9" class="nc ma iq my b gy ns ne l nf ng">        stage('Deploy') {<br/>            if (deploy == true) {<br/>                sh 'npm publish'<br/>            }<br/>        }<br/>    }<br/>}</span></pre><p id="3ee5" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">使用这个全局变量将原来的Jenkinsfile变成:</p><h2 id="6baa" class="nc ma iq bd mb nh ni dn mf nj nk dp mj lm nl nm ml lq nn no mn lu np nq mp nr bi translated">新Jenkinsfile</h2><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="9e96" class="nc ma iq my b gy nd ne l nf ng">buildJavascriptApp deploy: true</span></pre><p id="b7f2" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">我们刚刚把一个14行的Jenkinsfile变成了一个1行的Jenkinsfile。这在现在看起来可能没什么，但是当Jenkinsfiles开始变大时，共享库的优势就变得很明显了。</p><p id="8764" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">另一种方法是利用<a class="ae kv" href="http://www.groovy-lang.org/closures.html" rel="noopener ugc nofollow" target="_blank"> Groovy闭包</a>。这允许一个项目使用全局共享管道，同时也增加了它。因此，如果您的项目执行javascript构建过程，同时还向slack发送一条消息来通知构建成功或失败，那么您可以扩展库步骤，并在公共逻辑完成后传递您想要执行的逻辑。</p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="96f1" class="nc ma iq my b gy nd ne l nf ng">def call(Closure body) {<br/>    node {<br/>        checkout scm</span><span id="98fc" class="nc ma iq my b gy ns ne l nf ng">        stage('Install') {<br/>            sh 'npm install'<br/>        }</span><span id="f398" class="nc ma iq my b gy ns ne l nf ng">        stage('Test') {<br/>            sh 'npm test'<br/>        }</span><span id="c318" class="nc ma iq my b gy ns ne l nf ng">        stage('Deploy') {<br/>            if (deploy == true) {<br/>                sh 'npm publish'<br/>            }<br/>        }</span><span id="645f" class="nc ma iq my b gy ns ne l nf ng">        body()<br/>    }<br/>}</span></pre><p id="0e30" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">我们看到这个全局变量接受闭包作为参数。这是您希望在公共阶段之后执行的额外代码块。有了这样的共享变量，我们可以像这样使用它:</p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="a7bc" class="nc ma iq my b gy nd ne l nf ng">buildJavascriptApp deply: true {<br/>    stage('Notify') {<br/>        slackSend(...)  // send a message to slack<br/>    }<br/>}</span></pre><p id="0499" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">希望这些例子显示了共享库的强大，以及它们为团队提供的灵活性和使用Jenkins的持续集成工作。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="0d7e" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">警告</h1><p id="6dc1" class="pw-post-body-paragraph ld le iq lf b lg mr jr li lj ms ju ll lm mt lo lp lq mu ls lt lu mv lw lx ly ij bi translated">编写Jenkins共享库的一个缺点是代码是专门为Jenkins编写的。理由是，如果在某个时候您或您的团队想要转移到另一个CI系统，就需要重写包含在共享库中的代码。如果转移到一个新的系统，这个过程很可能会发生。有一种观点认为，编写共享逻辑的方式更容易被其他系统使用，比如shell脚本、Ansible playbooks或CLI工具。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="b3b0" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">结论</h1><p id="1a02" class="pw-post-body-paragraph ld le iq lf b lg mr jr li lj ms ju ll lm mt lo lp lq mu ls lt lu mv lw lx ly ij bi translated">Jenkins共享库是帮助保持Jenkinsfile简洁易读的好方法。当某个过程中可能发生变化时，这些库减少了手动更新多个Jenkinsfiles的麻烦和时间。它们还允许每个项目的Jenkinsfile关注“什么”需要发生，并让共享库负责“如何”发生。</p><p id="b467" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">感谢您阅读我的Jenkins共享库系列的第1部分。</p><p id="ed7a" class="pw-post-body-paragraph ld le iq lf b lg lh jr li lj lk ju ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">在我的Jenkins共享库系列的第二部分中，我将通过一步一步的教程向你展示如何创建你自己的共享库。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="661b" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">我的詹金斯共享图书馆系列</h1><div class="nt nu gp gr nv nw"><a href="https://medium.com/@werne2j/jenkins-shared-libraries-part-1-5ba3d072536a" rel="noopener follow" target="_blank"><div class="nx ab fo"><div class="ny ab nz cl cj oa"><h2 class="bd ir gy z fp ob fr fs oc fu fw ip bi translated">什么是Jenkins共享库，为什么你应该使用它们</h2><div class="od l"><h3 class="bd b gy z fp ob fr fs oc fu fw dk translated">Jenkins共享库系列文章的第1部分</h3></div><div class="oe l"><p class="bd b dl z fp ob fr fs oc fu fw dk translated">medium.com</p></div></div><div class="of l"><div class="og l oh oi oj of ok kp nw"/></div></div></a></div><div class="nt nu gp gr nv nw"><a href="https://medium.com/@werne2j/how-to-build-your-own-jenkins-shared-library-9dc129db260c" rel="noopener follow" target="_blank"><div class="nx ab fo"><div class="ny ab nz cl cj oa"><h2 class="bd ir gy z fp ob fr fs oc fu fw ip bi translated">如何构建自己的Jenkins共享库</h2><div class="od l"><h3 class="bd b gy z fp ob fr fs oc fu fw dk translated">我的Jenkins共享库系列的第二部分</h3></div><div class="oe l"><p class="bd b dl z fp ob fr fs oc fu fw dk translated">medium.com</p></div></div><div class="of l"><div class="ol l oh oi oj of ok kp nw"/></div></div></a></div><div class="nt nu gp gr nv nw"><a href="https://medium.com/@werne2j/unit-testing-a-jenkins-shared-library-9bfb6b599748" rel="noopener follow" target="_blank"><div class="nx ab fo"><div class="ny ab nz cl cj oa"><h2 class="bd ir gy z fp ob fr fs oc fu fw ip bi translated">Jenkins共享库的单元测试</h2><div class="od l"><h3 class="bd b gy z fp ob fr fs oc fu fw dk translated">Jenkins共享库系列文章的第三部分</h3></div><div class="oe l"><p class="bd b dl z fp ob fr fs oc fu fw dk translated">medium.com</p></div></div><div class="of l"><div class="ol l oh oi oj of ok kp nw"/></div></div></a></div><div class="nt nu gp gr nv nw"><a href="https://medium.com/@werne2j/collecting-code-coverage-for-a-jenkins-shared-library-c2d8f502732e" rel="noopener follow" target="_blank"><div class="nx ab fo"><div class="ny ab nz cl cj oa"><h2 class="bd ir gy z fp ob fr fs oc fu fw ip bi translated">收集Jenkins共享库的代码覆盖率</h2><div class="od l"><h3 class="bd b gy z fp ob fr fs oc fu fw dk translated">我的Jenkins共享库系列的第四部分</h3></div><div class="oe l"><p class="bd b dl z fp ob fr fs oc fu fw dk translated">medium.com</p></div></div><div class="of l"><div class="ol l oh oi oj of ok kp nw"/></div></div></a></div></div></div>    
</body>
</html>