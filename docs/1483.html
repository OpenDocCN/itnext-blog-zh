<html>
<head>
<title>Immutable Infrastructure Using Packer, Ansible, and Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Packer、Ansible和Terraform的不可变基础设施</h1>
<blockquote>原文：<a href="https://itnext.io/immutable-infrastructure-using-packer-ansible-and-terraform-7ca6f79582b8?source=collection_archive---------0-----------------------#2018-10-29">https://itnext.io/immutable-infrastructure-using-packer-ansible-and-terraform-7ca6f79582b8?source=collection_archive---------0-----------------------#2018-10-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c77e98743772d2c07de659867db5ef60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wg0yegLT3nK00lfi"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">奥利弗·帕斯克在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的“五彩岩石地段”</figcaption></figure><p id="5303" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">不可变基础设施是关于不可变组件的，这些组件在基础设施创建后被重新创建和替换，而不是更新。不可变的基础设施减少了出错的地方。这有助于减少部署过程中的不一致性并提高可靠性。更新服务器可能会很漫长、痛苦，而且很容易出错。当不可变的基础设施需要更新时，新的服务器被提供预配置的映像，旧的服务器被销毁。我们创建一个为部署而构建的新机器映像，并使用它来创建新的服务器。在不可变基础设施中，我们将服务器创建过程之后的配置设置转移到构建过程。由于所有部署都是由新映像完成的，因此我们可以保留以前版本的历史记录，以防恢复到旧版本。这使我们能够减少部署时间、配置故障和大规模部署等。</p><p id="5052" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">正常流量</strong></p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lb"><img src="../Images/6525de41c132aeeea0d52d939fda2029.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_b-Z5w1MRkQkBC_EKWb7tQ.png"/></div></div></figure><p id="93ee" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">不可变流程</strong></p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lg"><img src="../Images/db96dfcc255b57b85d4d289521d7d4eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CwvxrT2MqAH0mIwaq6_PCA.png"/></div></div></figure><p id="42c0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用terraform来供应我们的服务器，然后在实例上进行配置管理。这增加了调配服务器的时间，因为我们必须等到配置完成。我们应该使用<a class="ae kc" href="https://packer.io/" rel="noopener ugc nofollow" target="_blank">封隔器</a>预先进行配置。打包程序有助于在映像创建期间将配置烘焙到机器映像中。这有助于在出现问题时创建相同的服务器。如果你是packer新手，请在这里阅读我关于Packer的博客<a class="ae kc" rel="noopener ugc nofollow" target="_blank" href="/packer-machine-image-as-a-code-3d02729d82ca"/>。</p><p id="2aea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这篇文章中，我们将使用Packer烘焙一个AMI，并在烘焙过程中使用ansible进行配置。我们将部署一个静态网站，就像我们在<a class="ae kc" href="https://medium.com/@mitesh_shamra/deploying-website-on-aws-using-terraform-and-ansible-f0251ae71f42" rel="noopener">这里</a>所做的一样(代码可以在<a class="ae kc" href="https://github.com/MiteshSharma/TerraformAnsibleWebsite" rel="noopener ugc nofollow" target="_blank">这里</a>找到)。我们将使用相同的ansible代码在烘焙过程中使用nginx提供我们的静态网站。我们需要确保nginx在<a class="ae kc" href="https://www.freedesktop.org/software/systemd/man/systemctl.html" rel="noopener ugc nofollow" target="_blank">系统ctl </a>中启用，并且在每次启动时启动，以便它准备好立即处理。我们将在烘焙过程中为AMI分配标签。terraform可以使用这个标记来标识最新的可用AMI，并将其用于EC2实例创建。我们需要向packer builder提供子网id，这样它就可以在创建AMI时使用这个子网id。我们将把terraform代码分成两部分，一部分包含所有网络细节:创建VPC、子网和其他网络细节。另一部分使用打包程序生成的AMI在我们的网络中生成EC2实例。</p><p id="804b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">步骤1:使用Terraform建立网络</strong></p><p id="7bf8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这一步中，我们将创建一个带有公共子网的VPC，以及我们在所有EC2实例中用于ssh的密钥对。我们输出子网id，我们需要把它放在packer builder中，使用它packer可以创建一个在这个VPC中使用的AMI。</p><pre class="lc ld le lf gt lh li lj lk aw ll bi"><span id="47ba" class="lm ln iq li b gy lo lp l lq lr">provider "aws" {<br/>  access_key = "${var.access_key}"<br/>  secret_key = "${var.secret_key}"<br/>  region     = "${var.region}"<br/>}</span><span id="882e" class="lm ln iq li b gy ls lp l lq lr">#resources<br/>resource "aws_vpc" "vpc" {<br/>  cidr_block = "${var.cidr_block_range}"<br/>  enable_dns_support   = true<br/>  enable_dns_hostnames = true<br/>  tags {<br/>    "Environment" = "${var.environment_tag}"<br/>  }<br/>}</span><span id="7a24" class="lm ln iq li b gy ls lp l lq lr">resource "aws_internet_gateway" "igw" {<br/>  vpc_id = "${aws_vpc.vpc.id}"<br/>  tags {<br/>    "Environment" = "${var.environment_tag}"<br/>  }<br/>}</span><span id="4bcf" class="lm ln iq li b gy ls lp l lq lr">resource "aws_subnet" "subnet_public" {<br/>  vpc_id = "${aws_vpc.vpc.id}"<br/>  cidr_block = "${var.subnet1_cidr_block_range}"<br/>  map_public_ip_on_launch = "true"<br/>  availability_zone = "${var.availability_zone}"<br/>  tags {<br/>    "Environment" = "${var.environment_tag}"<br/>    "Type" = "Public"<br/>  }<br/>}</span><span id="e9a9" class="lm ln iq li b gy ls lp l lq lr">resource "aws_route_table" "rtb_public" {<br/>  vpc_id = "${aws_vpc.vpc.id}"</span><span id="fc3c" class="lm ln iq li b gy ls lp l lq lr">route {<br/>      cidr_block = "0.0.0.0/0"<br/>      gateway_id = "${aws_internet_gateway.igw.id}"<br/>  }</span><span id="9e59" class="lm ln iq li b gy ls lp l lq lr">tags {<br/>    "Environment" = "${var.environment_tag}"<br/>  }<br/>}</span><span id="576b" class="lm ln iq li b gy ls lp l lq lr">resource "aws_route_table_association" "rta_subnet_public" {<br/>  subnet_id      = "${aws_subnet.subnet_public.id}"<br/>  route_table_id = "${aws_route_table.rtb_public.id}"<br/>}</span><span id="d0b2" class="lm ln iq li b gy ls lp l lq lr">resource "aws_key_pair" "ec2key" {<br/>  key_name = "publicKey"<br/>  public_key = "${file(var.public_key_path)}"<br/>}</span></pre><p id="0b0d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">步骤2:在上面创建的网络中使用packer和ansible创建AMI</strong></p><p id="2d21" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将使用ansible配置来安装nginx并设置静态页面。我们使用systemctl启用nginx，因此当使用这个AMI创建EC2实例时，我们已经启动nginx并准备好处理传入的HTTP请求。</p><pre class="lc ld le lf gt lh li lj lk aw ll bi"><span id="aa10" class="lm ln iq li b gy lo lp l lq lr">{<br/>  "variables": {<br/>    "aws_access_key": "{{env `AWS_ACCESS_KEY_ID`}}",<br/>    "aws_secret_key": "{{env `AWS_SECRET_ACCESS_KEY`}}",<br/>    "region": "us-east-2",<br/>    "ssh_username": "ec2-user",<br/>    "base_ami": "ami-0303c7b2e7066b60d",<br/>    "instance_type": "t2.micro",<br/>    "subnet_id": "subnet-0553e12f46221b5b7" // <strong class="li ir">Created during network terraform execution</strong><br/>  },<br/>  "builders": [<br/>    {<br/>      "type": "amazon-ebs",<br/>      "access_key": "{{user `aws_access_key`}}",<br/>      "secret_key": "{{user `aws_secret_key` }}",<br/>      "region": "{{user `region` }}",<br/>      "subnet_id": "{{user `subnet_id` }}",<br/>      "source_ami": "{{user `base_ami`}}",<br/>      "instance_type": "{{user `instance_type` }}",<br/>      "ssh_username": "{{user `ssh_username`}}",<br/>      "ami_name": "packer-base-{{timestamp}}",<br/>      "associate_public_ip_address": true,<br/>      "tags": {<br/>        "Name": "Packer-Ansible" // <strong class="li ir">Tag used by terraform during instance creation</strong><br/>      }<br/>    }<br/>  ],<br/>  "provisioners": [<br/>    {<br/>      "type": "ansible",<br/>      "playbook_file": "../ansible/playbook.yml"<br/>    }<br/>  ]<br/>}</span></pre><p id="d2f0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">步骤3:使用packer AMI在网络内部设置EC2实例</strong></p><p id="532d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将使用数据资源读取网络状态文件，以便我们可以在实例创建期间使用网络创建的资源。</p><pre class="lc ld le lf gt lh li lj lk aw ll bi"><span id="760b" class="lm ln iq li b gy lo lp l lq lr">data "terraform_remote_state" "network" {<br/>  backend = "local"</span><span id="199e" class="lm ln iq li b gy ls lp l lq lr">  config {<br/>    path = "../networkTerraform/terraform.tfstate"<br/>  }<br/>}</span></pre><p id="5468" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们需要找到最近创建的AMI，它可以与我们创建的标记一起使用，以便可以在实例创建期间使用它。</p><pre class="lc ld le lf gt lh li lj lk aw ll bi"><span id="ba7c" class="lm ln iq li b gy lo lp l lq lr">data "aws_ami" "ec2-ami" {<br/>  filter {<br/>    name   = "state"<br/>    values = ["available"]<br/>  }</span><span id="33a8" class="lm ln iq li b gy ls lp l lq lr">  filter {<br/>    name   = "tag:Name"<br/>    values = ["Packer-Ansible"]<br/>  }</span><span id="4527" class="lm ln iq li b gy ls lp l lq lr">  most_recent = true<br/>}</span></pre><p id="2a37" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦我们有了所有这些信息，我们就可以在EC2实例创建期间简单地使用这些信息。</p><pre class="lc ld le lf gt lh li lj lk aw ll bi"><span id="45d9" class="lm ln iq li b gy lo lp l lq lr">provider "aws" {<br/>  access_key = "${var.access_key}"<br/>  secret_key = "${var.secret_key}"<br/>  region     = "${var.region}"<br/>}</span><span id="6ef1" class="lm ln iq li b gy ls lp l lq lr">data "aws_ami" "ec2-ami" {<br/>  filter {<br/>    name   = "state"<br/>    values = ["available"]<br/>  }</span><span id="91c0" class="lm ln iq li b gy ls lp l lq lr">  filter {<br/>    name   = "tag:Name"<br/>    values = ["Packer-Ansible"]<br/>  }</span><span id="dcac" class="lm ln iq li b gy ls lp l lq lr">  most_recent = true<br/>}</span><span id="65ee" class="lm ln iq li b gy ls lp l lq lr">data "terraform_remote_state" "network" {<br/>  backend = "local"</span><span id="eb49" class="lm ln iq li b gy ls lp l lq lr">  config {<br/>    path = "../networkTerraform/terraform.tfstate"<br/>  }<br/>}</span><span id="ab93" class="lm ln iq li b gy ls lp l lq lr">module "securityGroupModule" {<br/>  source   = "./modules/securityGroup"<br/>  access_key  = "${var.access_key}"<br/>  secret_key  = "${var.secret_key}"<br/>  region   = "${var.region}"<br/>  vpc_id   = "${data.terraform_remote_state.network.vpc_id}"<br/>  environment_tag = "${var.environment_tag}"<br/>}</span><span id="a055" class="lm ln iq li b gy ls lp l lq lr">module "instanceModule" {<br/>  source     = "./modules/instance"<br/>  access_key    = "${var.access_key}"<br/>  secret_key    = "${var.secret_key}"<br/>  region        = "${var.region}"<br/>  instance_ami  = "${data.aws_ami.ec2-ami.id}"<br/>  vpc_id     = "${data.terraform_remote_state.network.vpc_id}"<br/>  subnet_public_id = "${data.terraform_remote_state.network.public_subnets[0]}"<br/>  key_pair_name  = "${data.terraform_remote_state.network.ec2keyName}"<br/>  security_group_ids  = ["${module.securityGroupModule.sg_22}", "${module.securityGroupModule.sg_80}"]<br/>  environment_tag  = "${var.environment_tag}"<br/>}</span></pre><p id="5a9a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦执行了这段代码，我们就输出分配给EC2实例的弹性IP地址。我们在浏览器中使用这个IP地址来确认我们的静态网站工作正常。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lt"><img src="../Images/ae39baccc4eba6da9022fe12c1209e62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iV5UNkH-btLlQDOAxjrcZw.png"/></div></div></figure><p id="caf1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">完整的代码可以在这个git资源库中找到:<a class="ae kc" href="https://github.com/MiteshSharma/ImmutableInfrastructure" rel="noopener ugc nofollow" target="_blank">https://github.com/MiteshSharma/ImmutableInfrastructure</a></p><p id="865c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> <em class="lu"> PS:如果你喜欢这篇文章，请鼓掌支持。欢呼</em> </strong></p></div></div>    
</body>
</html>