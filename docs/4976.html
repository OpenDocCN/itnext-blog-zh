<html>
<head>
<title>Linux: LEMP set up — NGINX, PHP, MySQL, SSL, monitoring, logs, and a WordPress blog migration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Linux: LEMP设置——NGINX、PHP、MySQL、SSL、监控、日志和WordPress博客迁移</h1>
<blockquote>原文：<a href="https://itnext.io/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration-a6bd86090df6?source=collection_archive---------5-----------------------#2020-11-06">https://itnext.io/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration-a6bd86090df6?source=collection_archive---------5-----------------------#2020-11-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/814eff936bf78d298f6a9ee1143ce376.png" data-original-src="https://miro.medium.com/v2/resize:fit:1234/format:webp/1*No9mRAOft9Zah6zERro7Xw.png"/></div></figure><p id="4968" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">终于有时间用Debian 10把RTFM.CO.UA的博客迁移到新的服务器上了。这一次手动，没有任何自动化将建立一个LEMP堆栈</p><p id="bbc9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在2016年写了一篇类似的文章——<a class="ae ks" href="https://rtfm.co.ua/debian-ustanovka-lamp-nginx-php-fpm-mariadb/" rel="noopener ugc nofollow" target="_blank">Debian:установкаLEMP——NGINX+PHP-FPM+Maria db</a>(<em class="kt">Rus</em>)，但在时间上，这篇文章更完整地描述了用于托管网站的现成Linux服务器的过程和工具，实际上是一个WordPress博客。</p><p id="895c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">再一次，它计划作为一个关于安装NGINX + PHP + MySQL的快速笔记，但结果是，我描述了LEMP、Linux监控、日志、电子邮件等设置过程和配置。</p><p id="1da4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以，在这篇文章中我们要做的是:</p><ul class=""><li id="4c29" class="ku kv iq jw b jx jy kb kc kf kw kj kx kn ky kr kz la lb lc bi translated">在数字海洋中创建一个水滴</li><li id="e59c" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">来自“让我们加密”的SSL</li><li id="900d" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">NGINX</li><li id="9569" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">PHP-FPM</li><li id="c754" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">MySQL (MariaDB)作为数据库服务器</li><li id="d607" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">NGINX Amplify agent——监控和警报(我试过Grafana и Loki，但他们使用了太多的资源，但这仍然是一个非常有趣的自动化设置，请查看用ansi ble——Grafana、Loki和promtail 设置的Prometheus: RTFM博客监控)</li><li id="b284" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">WordPress备份脚本——一个自己写的Python脚本，查看<a class="ae ks" href="https://rtfm.co.ua/python-skript-bekapa-fajlov-i-baz-mysql-v-aws-s3/" rel="noopener ugc nofollow" target="_blank">Python:скрииптбекапатарловибазMySQLвAWS S3</a>(<em class="kt">Rus</em></li><li id="5c68" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">Logz.io —将日志收集到ELK-stack</li><li id="c523" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">Debian和已安装的软件包自动升级</li><li id="ee7e" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><code class="fe li lj lk ll b">logrotate</code> -日志旋转</li></ul><h1 id="7dae" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">内容</h1><ul class=""><li id="bfb7" class="ku kv iq jw b jx mk kb ml kf mm kj mn kn mo kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#DigitalOceal_create_a_droplet" rel="noopener ugc nofollow" target="_blank">数字耳蜗:创建一个液滴</a></li><li id="d615" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#Create_an_RSA_key_for_SSH" rel="noopener ugc nofollow" target="_blank">为SSH创建一个RSA密钥</a></li><li id="1263" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#Firewall" rel="noopener ugc nofollow" target="_blank">防火墙</a></li><li id="66dd" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#Floating_IP" rel="noopener ugc nofollow" target="_blank">浮动IP </a></li><li id="161b" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#LEMP_%E2%80%93_Linux,_NGINX,_PHP,_MySQL" rel="noopener ugc nofollow" target="_blank">LEMP——Linux，NGINX，PHP，MySQL </a></li><li id="9118" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#Let%E2%80%99s_Encrypt_SSL" rel="noopener ugc nofollow" target="_blank">让我们加密SSL </a></li><li id="ea7c" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#Let%E2%80%99s_Encrypt_DNS_validation" rel="noopener ugc nofollow" target="_blank">让我们加密DNS验证</a></li><li id="9a5e" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#NGINX" rel="noopener ugc nofollow" target="_blank"> NGINX </a></li><li id="69f1" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#PHPFPM" rel="noopener ugc nofollow" target="_blank">FPM PHP</a></li><li id="22a0" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#Linux_nonlogin_user" rel="noopener ugc nofollow" target="_blank"> Linux:非登录用户</a></li><li id="169d" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#MySQL" rel="noopener ugc nofollow" target="_blank"> MySQL </a></li><li id="8102" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#WordPress_blog_migration" rel="noopener ugc nofollow" target="_blank"> WordPress博客迁移</a></li><li id="b099" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#Archiving_files" rel="noopener ugc nofollow" target="_blank">归档文件</a></li><li id="b567" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#MySQL_database_dump" rel="noopener ugc nofollow" target="_blank"> MySQL数据库转储</a></li><li id="6d3e" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">建立数据库连接出错</li><li id="264b" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">PHP:检查MySQL连接</li><li id="f297" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">WP_ALLOW_REPAIR </li><li id="ac0b" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#The_%E2%80%9CError_establishing_a_database_connection%E2%80%9D_cause" rel="noopener ugc nofollow" target="_blank">“建立数据库连接时出错”原因</a></li><li id="0db3" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#SSL_webroot_validation" rel="noopener ugc nofollow" target="_blank"> SSL: webroot验证</a></li><li id="92a9" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#Let%E2%80%99s_Encrypt_webroot_validation" rel="noopener ugc nofollow" target="_blank">让我们加密:webroot验证</a></li><li id="243a" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#certbot_renew_%E2%80%93_autoupdate_certificates" rel="noopener ugc nofollow" target="_blank">证书更新—自动更新证书</a></li><li id="8636" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#Let%E2%80%99s_Encrypt_hook_%E2%80%93_NGINX_reload" rel="noopener ugc nofollow" target="_blank">让我们加密hook — NGINX reload </a></li><li id="f5c5" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#Amplify_%E2%80%93_NGINX,_PHP,_and_server_monitoring" rel="noopener ugc nofollow" target="_blank"> Amplify — NGINX、PHP和服务器监控</a></li><li id="afc4" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#Backup_script_for_websites" rel="noopener ugc nofollow" target="_blank">网站备份脚本</a></li><li id="f42a" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#DigitalOcean_Volume" rel="noopener ugc nofollow" target="_blank">数字海洋卷</a></li><li id="8bbe" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#Linux_mount_a_volume" rel="noopener ugc nofollow" target="_blank"> Linux:挂载一个卷</a></li><li id="2f3e" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#Logz_io,_Filebeat_%D0%B8_%D0%BB%D0%BE%D0%B3%D0%B8_NGINX" rel="noopener ugc nofollow" target="_blank"> Logz.io，Filebeat и логи NGINX </a></li><li id="1457" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#Install_unattendedupgrades" rel="noopener ugc nofollow" target="_blank">安装无人值守升级</a></li><li id="939f" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#logrotate" rel="noopener ugc nofollow" target="_blank">日志旋转</a></li><li id="f17f" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#mailx_and_msmtp_%E2%80%93_sending_emails_from_the_server" rel="noopener ugc nofollow" target="_blank"> mailx和msmtp —从服务器发送电子邮件</a></li><li id="18d7" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#550_001_RDNS/PTR_error_Rejected" rel="noopener ugc nofollow" target="_blank">550 001.RDNS/PTR错误。被拒</a></li><li id="e358" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/#mailx_cannot_send_message_process_exited_with_a_nonzero_status" rel="noopener ugc nofollow" target="_blank"> mailx:无法发送消息:进程以非零状态退出</a></li></ul><h1 id="246a" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">数字电路:创建一个液滴</h1><p id="6b7f" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">RTFM的博客是在AWS上托管的，但去年因为价格较低，我把它移到了数字海洋。</p><p id="3ab0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建新的droplet:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/06679b3ea8ba39e484ea9415c1e720e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:690/format:webp/0*nIFLcl60ZRqSa3-y.png"/></div></figure><p id="6121" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将在2个CPU，2 GB RAM的虚拟服务器上使用Debian 10。</p><p id="ccd8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，在当前使用的具有相同配置的droplet上，CPU和内存的使用情况如下(图来自NGINX Amplify):</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi mx"><img src="../Images/3a84dabdc002644ca0e858396d0af3e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*KQCqDM7BZkyO1zja.png"/></div></div></figure><p id="0f88" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">选择操作系统和实例类型:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi nc"><img src="../Images/fc78e750383facf4989417a43ec39dec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NIXGIYzC1VHSs7rY.png"/></div></div></figure><p id="6f41" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我正在使用法兰克福地区，将启用对水滴的监控—它将由数字海洋代理创建，以便在DO的控制面板中有更多图表:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi nc"><img src="../Images/f804ea514ffc6dec021a5f4f0de88d13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6T9TKIxNzUE2bB2j.png"/></div></div></figure><h2 id="5cd5" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated">为SSH创建RSA密钥</h2><p id="cde3" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">在工作站上创建一个ket对:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="abe4" class="nd ln iq ll b gy nt nu l nv nw">$ ssh-keygen -f ~/Dropbox/AWS/setevoy-do-nextcloud-production-d10–03–11<br/>Generating public/private rsa key pair.<br/>Enter passphrase (empty for no passphrase):<br/>Enter same passphrase again:<br/>Your identification has been saved in /home/setevoy/Dropbox/AWS/setevoy-do-nextcloud-production-d10–03–11<br/>Your public key has been saved in /home/setevoy/Dropbox/AWS/setevoy-do-nextcloud-production-d10–03–11.pub<br/>…</span></pre><p id="b5d5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">复制其公共部分:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="424d" class="nd ln iq ll b gy nt nu l nv nw">$ cat /home/setevoy/Dropbox/AWS/setevoy-do-nextcloud-production-d10–03–11.pub<br/>ssh-rsa AAAAB3NzaC1***Ht3UEYuGtdQgc0= setevoy@setevoy-arch-work</span></pre><p id="2f44" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在DO:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi nx"><img src="../Images/4e830911342cc230fa7f6b4b7986edd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Buav0ixJkX5j7Xsu.png"/></div></div></figure><p id="9ab8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">选择droplets number-one，并将其主机名设置为<em class="kt"> rtfm-do-production-d10 </em>:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi ny"><img src="../Images/672a1a5c2a5e954da1d1af1c532ef307.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ao0XuasDIc_nkTww.png"/></div></div></figure><p id="c405" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">或者，启用备份并创建droplet:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi nz"><img src="../Images/63f7bed268179bab923c8da4c4dcf224.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*t8aw7aVeeIw7hi4C.png"/></div></div></figure><h2 id="6de5" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated">防火墙</h2><p id="1b2f" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">创建droplet时，让我们为它配置一个防火墙:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi oa"><img src="../Images/b6d2f4ddcdd598dfc3d887555ab5ebdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rQpr6_xoR_0yiZGH.png"/></div></div></figure><p id="044c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加规则:SSH、ICMP——受我当前IP的限制，以及来自任何地方的HTTP/S，尽管限制它也是一个好主意，因此Google不会在迁移期间将博客索引为原始站点的副本:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi ny"><img src="../Images/7e7d7bc8e0b7bd3ce4e99044ded66168.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DAjEith6T8hub3_e.png"/></div></div></figure><p id="5d28" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将防火墙连接到droplet:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi ob"><img src="../Images/b13a33634af9bbbb4e29a633468e3459.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7IhzrYLncKN6IDFr.png"/></div></div></figure><h2 id="c5b2" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated">浮动IP</h2><p id="cb67" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">模拟AWS中的弹性IP，为新服务器创建一个新IP:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi oc"><img src="../Images/0764926d88fed42d683b5984d3046f8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Til7RGy2FQtR506d.png"/></div></div></figure><p id="d6ec" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">其实都在这里了。</p><p id="272e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们转到服务器配置。</p><h1 id="c6dd" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">LEMP——Linux，NGINX，PHP，MySQL</h1><p id="b07d" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">好吧，再问一次——我们需要什么？</p><ul class=""><li id="d67f" class="ku kv iq jw b jx jy kb kc kf kw kj kx kn ky kr kz la lb lc bi translated">nginx</li><li id="ee32" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">php-fpm</li><li id="d11e" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">让加密</li><li id="d325" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">关系型数据库</li><li id="5fcb" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">放大剂—монитоиинг</li><li id="5b92" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">备份脚本</li><li id="db25" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">logz . io——有一个免费层，但是将只存储一天的日志，不过，这对我来说已经足够了，因为我只需要一个漂亮的web-UI来检查它们</li><li id="40a5" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">无人值守升级—操作系统和软件包自动升级</li><li id="0fa9" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">log rotate——默认情况下已经安装在Debian上，只是会检查它的配置</li><li id="0c96" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">msmtp —发送电子邮件</li></ul><p id="d439" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">连接到主机:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="eabf" class="nd ln iq ll b gy nt nu l nv nw">$ chmod 400 Dropbox/AWS/setevoy-do-nextcloud-production-d10–03–11<br/>ssh -i Dropbox/AWS/setevoy-do-nextcloud-production-d10–03–11 root@139.59.205.180<br/>root@rtfm-do-production-d10:~#</span></pre><p id="4d08" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更新系统并重新启动:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="cffd" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:~# apt update &amp;&amp; apt -y upgrade<br/>root@rtfm-do-production-d10:~# reboot</span></pre><p id="beab" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为LEMP安装软件包:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="0990" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:~# apt -y install certbot nginx php php-xml php-curl php-gd php-zip php-mysql php-mbstring php-fpm mariadb-server</span></pre><p id="f1fe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查NGINX是否工作:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="0942" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:~# curl localhost<br/>&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>&lt;title&gt;Welcome to nginx!&lt;/title&gt;<br/>…</span></pre><p id="1f8f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">安装其他必要的软件包:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="3878" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/data# apt -y install htop git wget unzip unattended-upgrades apt-listchanges dnsutils telnet python-pip python-boto3 mailutils</span></pre><p id="b422" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">当使用<code class="fe li lj lk ll b">mailx</code>和<code class="fe li lj lk ll b">msmtp</code>时<code class="fe li lj lk ll b">mailutils</code>有问题，所以我不得不用<code class="fe li lj lk ll b">bsd-mailx</code>替换它，参见<a class="ae ks" href="https://rtfm.co.ua/en/?p=25142#mailx_and_msmtp_%E2%80%93_sending_emails_from_the_server" rel="noopener ugc nofollow" target="_blank"> mailx和msmtp从服务器发送电子邮件</a>。</p><h2 id="aaf3" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated">让我们加密SSL</h2><p id="33cd" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">将使用Let's Encrypt来获取博客的SSL证书。</p><h2 id="5f60" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated">让我们加密DNS验证</h2><p id="6e34" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">这里有一个关于验证过程的问题，因为<em class="kt">rtfm.co.ua</em>域仍然指向旧服务器，我们不能对<code class="fe li lj lk ll b">.well-known</code>目录使用通用方法。</p><p id="8072" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们在这里可以做的是，在获得新证书时使用DNS验证，然后当我们已经配置了NGINX和PHP时，将重新配置<code class="fe li lj lk ll b">certbot</code>以使用webroot验证，因为DNS验证似乎不支持证书<code class="fe li lj lk ll b">renew</code>(但我不确定这一点)。</p><p id="a34e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">获取证书:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="a417" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:~# certbot certonly — preferred-challenges dns -d rtfm.co.ua — manual — email user@example.com — agree-tos<br/>Saving debug log to /var/log/letsencrypt/letsencrypt.log<br/>Plugins selected: Authenticator manual, Installer None<br/>Obtaining a new certificate<br/>Performing the following challenges:<br/>dns-01 challenge for rtfm.co.ua<br/>- — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — -<br/>NOTE: The IP of this machine will be publicly logged as having requested this<br/>certificate. If you’re running certbot in manual mode on a machine that is not<br/>your server, please ensure you’re okay with that.<br/>Are you OK with your IP being logged?<br/>- — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — -<br/>(Y)es/(N)o: Y<br/>- — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — -<br/>Please deploy a DNS TXT record under the name<br/>_acme-challenge.rtfm.co.ua with the following value:<br/>ORWOP6KR4C3csx-ngoSWbqVAJuVo8kFDgV8AqNFUemg<br/>Before continuing, verify the record is deployed.<br/>- — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — -<br/>Press Enter to Continue</span></pre><p id="4d6e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在域的DNS上添加新记录:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi od"><img src="../Images/6999377250f9c9925d460038bc3174d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1316/format:webp/0*f5beJQO9AjdUZllS.png"/></div></div></figure><p id="5d8b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="46fd" class="nd ln iq ll b gy nt nu l nv nw">$ dig _acme-challenge.rtfm.co.ua TXT +short<br/>“ORWOP6KR4C3csx-ngoSWbqVAJuVo8kFDgV8AqNFUemg”</span></pre><p id="b75b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">回到服务器，按<em class="kt">回车</em>——就完成了:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="9885" class="nd ln iq ll b gy nt nu l nv nw">…<br/>Press Enter to Continue<br/>Waiting for verification…<br/>Cleaning up challenges<br/>IMPORTANT NOTES:<br/>- Congratulations! Your certificate and chain have been saved at:<br/>/etc/letsencrypt/live/rtfm.co.ua/fullchain.pem<br/>Your key file has been saved at:<br/>/etc/letsencrypt/live/rtfm.co.ua/privkey.pem<br/>Your cert will expire on 2021–02–01. To obtain a new or tweaked<br/>version of this certificate in the future, simply run certbot<br/>again. To non-interactively renew *all* of your certificates, run<br/>“certbot renew”</span></pre><h2 id="4bff" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated">NGINX</h2><p id="54ba" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">为NGINX生成Diffie-Hellman密钥(检查<code class="fe li lj lk ll b"><a class="ae ks" href="https://rtfm.co.ua/what-is-ssl-tls-v-detalyax/#ClientKeyExchange" rel="noopener ugc nofollow" target="_blank">ClientKeyExchange</a></code>):</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="2b51" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:~# openssl dhparam -out /etc/nginx/dhparams.pem 2048</span></pre><p id="c244" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">删除<code class="fe li lj lk ll b">default</code>配置——这里RTFM将是默认主机:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="426c" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:~# rm /etc/nginx/sites-enabled/default</span></pre><p id="5769" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为RTFM虚拟主机创建一个配置文件— <code class="fe li lj lk ll b">/etc/nginx/conf.d/rtfm.co.ua.conf</code>。我只是从旧服务器上下载的。</p><p id="65c2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">它足够长了，我过去几年没有改变它，只是一些SLS设置。</p><p id="a2b7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">https://www.ssllabs.com上一次检查还是给了我A+的等级，所以可以用。</p><p id="3f4b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">另外，看看NGINX配置生成器，例如，Mozilla的【https://www.serverion.com/nginx-config】的或<a class="ae ks" href="https://ssl-config.mozilla.org/" rel="noopener ugc nofollow" target="_blank"> SSL配置生成器</a>。</p><p id="b127" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在我的配置中，我限制对<code class="fe li lj lk ll b">/wp-admin</code>和<code class="fe li lj lk ll b">wp-login.php</code>的访问，因为我是唯一使用它的人:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="74b6" class="nd ln iq ll b gy nt nu l nv nw">server {<br/><br/>    listen 80 default_server;<br/>    server_name rtfm.co.ua <a class="ae ks" href="http://www.rtfm.co.ua;" rel="noopener ugc nofollow" target="_blank">www.rtfm.co.ua;</a><br/><br/>    server_tokens off;<br/>    return 301 <a class="ae ks" href="https://rtfm.co.ua$request_uri;" rel="noopener ugc nofollow" target="_blank">https://rtfm.co.ua$request_uri;</a><br/>}<br/><br/>server {<br/><br/>    listen 443 ssl default_server;<br/>    server_name rtfm.co.ua;<br/><br/>    root /data/www/rtfm/rtfm.co.ua;<br/><br/>    add_header Strict-Transport-Security "max-age=31536000; includeSubdomains" always;<br/>    server_tokens off;<br/><br/>#    access_log /var/log/nginx/rtfm.co.ua-access.log main_ext;<br/>    error_log /var/log/nginx/rtfm.co.ua-error.log warn;<br/><br/>    ssl_certificate /etc/letsencrypt/live/rtfm.co.ua/fullchain.pem;<br/>    ssl_certificate_key /etc/letsencrypt/live/rtfm.co.ua/privkey.pem;<br/><br/>    ssl_protocols TLSv1.2;<br/>    ssl_prefer_server_ciphers on;<br/>    ssl_dhparam /etc/nginx/dhparams.pem;<br/>    ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:ECDHE-RSA-AES128-GCM-SHA256:AES256+EECDH:DHE-RSA-AES128-GCM-SHA256:AES256+EDH:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4";<br/>    ssl_session_timeout 1d;<br/>    ssl_session_cache shared:SSL:50m;<br/>    ssl_stapling on;<br/>    ssl_stapling_verify on;<br/><br/>    error_page 500 502 503 504 /50x.html;<br/>        location = /50x.html {<br/>        root /usr/share/nginx/html;<br/>    }<br/><br/>    client_max_body_size 1024m;<br/><br/>    location ~ /\.ht {<br/>        deny all;<br/>    }<br/><br/>    location ~* \.(jpg|swf|jpeg|gif|png|css|js|ico)$ {<br/>        root /data/www/rtfm/rtfm.co.ua;<br/>        expires 24h;<br/>    }<br/><br/>    location /wp-admin/admin-ajax.php {<br/><br/>    location ~ \.php$ {<br/>        include /etc/nginx/fastcgi_params;<br/>        fastcgi_pass unix:/var/run/rtfm.co.ua-php-fpm.sock;<br/>        fastcgi_index index.php;<br/>        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;<br/>        }<br/>    }<br/><br/>    location /wp-admin/ {<br/><br/>        index index.php, index.html;<br/><br/>        auth_basic_user_file /data/www/rtfm/.htpasswd_rtfm;<br/>        auth_basic "Password-protected Area";<br/><br/>        # office<br/>        allow 194.***.***.24/29;<br/>        # home 397 LocalNet<br/>        allow 31.***.***.117/32;<br/>        # home 397 Lanet<br/>        allow 176.***.***.237;<br/>        deny all;<br/><br/>        location ~ \.php$ {<br/>            include /etc/nginx/fastcgi_params;<br/>            fastcgi_pass unix:/var/run/rtfm.co.ua-php-fpm.sock;<br/>            fastcgi_index index.php;<br/>            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;<br/>        }<br/>    }<br/><br/>    location /wp-config.php {<br/>        deny all;<br/>    }<br/><br/>    location /.user.ini {<br/>        deny all;<br/>    }<br/><br/>    location /wp-login.php {<br/><br/>        auth_basic_user_file /data/www/rtfm/.htpasswd_rtfm;<br/>        auth_basic "Password-protected Area";<br/><br/>        # office<br/>        allow 194.***.***.24/29;<br/>        # home 397 LocalNet<br/>        allow 31.***.***.117/32;<br/>        # home 397 Lanet<br/>        allow 176.***.***.237;<br/>        deny all;<br/><br/>        location ~ \.php$ {<br/>            include /etc/nginx/fastcgi_params;<br/>            fastcgi_pass unix:/var/run/rtfm.co.ua-php-fpm.sock;<br/>            fastcgi_index index.php;<br/>            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;<br/>        }<br/>    }<br/><br/>    location /uploads/noindex {<br/>        auth_basic_user_file /data/www/rtfm/.htpasswd_rtfm;<br/>        auth_basic "Password-protected Area";<br/>    }<br/><br/>    location = /favicon.ico {<br/>        access_log     off;<br/>        log_not_found  off;<br/>    }<br/><br/>    location / {<br/><br/>        try_files $uri =404;<br/><br/>        index index.php;<br/>        proxy_read_timeout 3000;<br/><br/>        rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.xml$ "/index.php?xml_sitemap=params=$2" last;<br/>        rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.xml\.gz$ "/index.php?xml_sitemap=params=$2;zip=true" last;<br/>        rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.html$ "/index.php?xml_sitemap=params=$2;html=true" last;<br/>        rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.html.gz$ "/index.php?xml_sitemap=params=$2;html=true;zip=true" last;<br/><br/>        if (!-f $request_filename){<br/>            set $rule_1 1$rule_1;<br/>        }<br/><br/>        if (!-d $request_filename){<br/>            set $rule_1 2$rule_1;<br/>        }<br/><br/>        if ($rule_1 = "21"){<br/>            rewrite /. /index.php last;<br/>       }<br/>    }<br/><br/>    location ~ \.php$ {<br/><br/>        try_files $uri =404;<br/><br/>        proxy_read_timeout 3000;<br/>        include /etc/nginx/fastcgi_params;<br/>        fastcgi_pass unix:/var/run/rtfm.co.ua-php-fpm.sock;<br/>        fastcgi_index index.php;<br/>        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;<br/>    }<br/><br/>    location /nginx_status {<br/>        stub_status on;<br/>        access_log   off;<br/>        allow 127.0.0.1;<br/>        deny all;<br/>    }<br/>}</span></pre><p id="e2cd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查并重新加载:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="550a" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:~# nginx -t &amp;&amp; systemctl reload nginx<br/>nginx: the configuration file /etc/nginx/nginx.conf syntax is ok<br/>nginx: configuration file /etc/nginx/nginx.conf test is successful</span></pre><p id="bd08" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们检查一下。</p><p id="9570" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在工作的笔记本电脑上，更新<code class="fe li lj lk ll b">/etc/hosts</code>来为<em class="kt">rtfm.co.ua</em>域设置新的droplet的IP:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="8717" class="nd ln iq ll b gy nt nu l nv nw">139.59.205.180 rtfm.co.ua</span></pre><p id="42b3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">试着打开它:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi oe"><img src="../Images/5a6702dff61b09960119bcd124ca6133.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TyXez1WKB9b2YV2H.png"/></div></div></figure><p id="897e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好— SSL正在工作，NGINX正在运行。</p><h2 id="7f41" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated">PHP-FPM</h2><p id="dfc7" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">与NGINX配置类似，我将从旧服务器上复制PHP-FPM配置。</p><p id="f9de" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下面是使用的FPM池，每个池都在自己的系统用户下运行。</p><p id="fe6d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">另见<a class="ae ks" href="https://rtfm.co.ua/php-fpm-process-manager-dynamic-vs-ondemand-vs-static/" rel="noopener ugc nofollow" target="_blank"> PHP-FPM:流程管理器——动态vs按需vs静态</a> ( <em class="kt"> Rus </em>)。</p><h2 id="abcb" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated">Linux:非登录用户</h2><p id="00be" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">添加非登录用户:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="1b66" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:~# adduser — system — no-create-home — group rtfm<br/>Adding system user `rtfm’ (UID 109) …<br/>Adding new group `rtfm’ (GID 115) …<br/>Adding new user `rtfm’ (UID 109) with group `rtfm’ …<br/>Not creating home directory `/home/rtfm’.</span></pre><p id="63aa" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建一个<code class="fe li lj lk ll b">/etc/php/7.3/fpm/pool.d/rtfm.co.ua.conf</code>文件:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="5004" class="nd ln iq ll b gy nt nu l nv nw">[rtfm.co.ua]<br/><br/>user = rtfm<br/>group = rtfm<br/><br/>listen = /var/run/rtfm.co.ua-php-fpm.sock<br/><br/>listen.owner = www-data<br/>listen.group = www-data<br/><br/>pm = dynamic<br/>pm.max_children = 5<br/>pm.start_servers = 2<br/>pm.min_spare_servers = 1<br/>pm.max_spare_servers = 3<br/>;pm.process_idle_timeout = 10s;<br/>;pm.max_requests = 500<br/>catch_workers_output = yes<br/>chdir = /<br/>pm.status_path = /status<br/> <br/>slowlog = /var/log/nginx/rtfm.co.ua-slow.log<br/>php_flag[display_errors] = off<br/>;php_admin_value[display_errors] = 'stderr'<br/>php_admin_value[display_errors] = off<br/>php_admin_value[error_log] = /var/log/nginx/rtfm.co.ua-php-error.log<br/>php_admin_flag[log_errors] = on<br/>php_admin_value[session.save_path] = /var/lib/php/session/rtfm<br/>php_value[session.save_handler] = files<br/>php_value[session.save_path] = /var/lib/php/session<br/>php_admin_value[upload_max_filesize] = 128M<br/>php_admin_value[post_max_size] = 128M</span></pre><p id="0612" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查PHP-FPM配置:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="8697" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:~# php-fpm7.3 -t<br/>[03-Nov-2020 11:45:24] NOTICE: configuration file /etc/php/7.3/fpm/php-fpm.conf test is successful</span></pre><p id="41e1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">重新加载配置:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="c9ee" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:~# systemctl reload php7.3-fpm.service</span></pre><p id="d16b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">找到博客的NIGNX根目录:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="ac2b" class="nd ln iq ll b gy nt nu l nv nw">...<br/>root /data/www/rtfm/rtfm.co.ua;<br/>...</span></pre><p id="1f8a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建目录:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="9cd6" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:~# mkdir -p /data/www/rtfm/rtfm.co.ua</span></pre><p id="6fc7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">用<code class="fe li lj lk ll b"><a class="ae ks" href="https://www.php.net/manual/en/function.phpinfo.php" rel="noopener ugc nofollow" target="_blank">phpinfo()</a></code>函数添加一个测试文件来检查NGINX + PHP:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="b5ee" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:~# echo “&lt;?php phpinfo(); ?&gt;” &gt; /data/www/rtfm/rtfm.co.ua/info.php</span></pre><p id="2608" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查它(再次通过更新<code class="fe li lj lk ll b">/etc/hosts</code>):</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi of"><img src="../Images/3392ef1d6b87dac52c4951db8b4df87f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ez83gXBAcUyQk8SR.png"/></div></div></figure><p id="5479" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">很好——一切正常。</p><h2 id="74ed" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated">关系型数据库</h2><p id="e173" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">Debian默认有MariaDB而不是MySQL。配置上差别不大，实际上MariaDB运行速度更快。</p><p id="8678" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行初始配置脚本:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="3c85" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:~# mysql_secure_installation<br/>…<br/>Set root password? [Y/n] y<br/>New password:<br/>Re-enter new password:<br/>Password updated successfully!<br/>Reloading privilege tables..<br/>… Success!<br/>…<br/>Remove anonymous users? [Y/n] y<br/>… Success!<br/>…<br/>Disallow root login remotely? [Y/n] y<br/>… Success!<br/>…<br/>Remove test database and access to it? [Y/n] y<br/>- Dropping test database…<br/>… Success!<br/>- Removing privileges on test database…<br/>… Success!<br/>…<br/>Reload privilege tables now? [Y/n] y<br/>… Success!<br/>Cleaning up…<br/>All done! If you’ve completed all of the above steps, your MariaDB<br/>installation should now be secure.<br/>Thanks for using MariaDB!</span></pre><p id="52ce" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为RTFM创建数据库:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="f3dd" class="nd ln iq ll b gy nt nu l nv nw">MariaDB [(none)]&gt; create database rtfm_db1_production;<br/>Query OK, 1 row affected (0.000 sec)</span></pre><p id="a506" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建一个用户<em class="kt"> rtfm </em>，该用户只能使用<em class="kt">密码</em>从<em class="kt"> localhost </em>访问<em class="kt"> rtfm_db1_production </em>数据库:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="22a6" class="nd ln iq ll b gy nt nu l nv nw">MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON rtfm_db1_production.* TO ‘rtfm’@’localhost’ IDENTIFIED BY ‘password’;<br/>Query OK, 0 rows affected (0.001 sec)</span></pre><p id="52ab" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="6715" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:~# mysql -u rtfm -p -e ‘show databases;’<br/>Enter password:<br/>+ — — — — — — — — — — +<br/>| Database |<br/>+ — — — — — — — — — — +<br/>| information_schema |<br/>| rtfm_db1_production|<br/>+ — — — — — — — — — — +</span></pre><p id="a670" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，迁移的一切都准备好了。</p><h1 id="938b" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">WordPress博客迁移</h1><p id="9d8b" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">在这里，我不得不暂停写这篇文章来创建数据库的转储和移动博客的文件。</p><p id="5e65" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">之后，迁移将从新服务器开始。</p><p id="c8d3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">需要做什么:</p><ol class=""><li id="99df" class="ku kv iq jw b jx jy kb kc kf kw kj kx kn ky kr og la lb lc bi translated">板条箱文件存档</li><li id="51f9" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr og la lb lc bi translated">数据库转储</li><li id="167e" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr og la lb lc bi translated">将它们移至新主机</li><li id="82f3" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr og la lb lc bi translated">更改DNS条目以将域指向新的IP</li></ol><p id="4053" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将文章保存为草稿——WordPress会将其保存在数据库中，我会将其转储到新的服务器上，然后从这个地方继续写作。</p><h2 id="2756" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated">存档文件</h2><p id="1e1d" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">用博客文件创建一个存档，检查它们:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="1d57" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production:/home/setevoy# cd /data/www/rtfm/<br/>root@rtfm-do-production:/data/www/rtfm# ll<br/>total 20<br/>drwxr-xr-x 8 rtfm rtfm 20480 Nov 3 12:11 rtfm.co.ua</span></pre><p id="6332" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建带压缩的TAR-archive:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="7333" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production:/data/www/rtfm# tar cvpfz rtfm.co.ua.tar.gz rtfm.co.ua/</span></pre><p id="db0e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查文件:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="b80f" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production:/data/www/rtfm# ls -lh<br/>total 2.4G<br/>drwxr-xr-x 8 rtfm rtfm 20K Nov 3 12:11 rtfm.co.ua<br/>-rw-r — r — 1 root root 2.4G Nov 3 14:05 rtfm.co.ua.tar.gz</span></pre><h2 id="d491" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated">MySQL数据库转储</h2><p id="1814" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">创建转储(首先，阅读关于<code class="fe li lj lk ll b">-d</code>选项的<a class="ae ks" href="https://rtfm.co.ua/en/?p=25142#WordPress_Error_establishing_a_database_connection" rel="noopener ugc nofollow" target="_blank"> WordPress:错误建立数据库连接</a>):</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="f961" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production:/data/www/rtfm# mysqldump -u rtfm -p -d rtfm_db1_production &gt; rtfm_db1_production.sql<br/>Enter password:</span></pre><p id="d268" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="59b8" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production:/data/www/rtfm# head rtfm_db1_production.sql<br/> — MySQL dump 10.16 Distrib 10.1.47-MariaDB, for debian-linux-gnu (x86_64)<br/> — <br/>— Host: localhost Database: rtfm_db1_production<br/> — — — — — — — — — — — — — — — — — — — — — — — — — — — — <br/>— Server version 10.1.47-MariaDB-0+deb9u1<br/>/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;<br/>/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;<br/>/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;<br/>/*!40101 SET NAMES utf8mb4 */;</span></pre><p id="6a66" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在旧服务器的防火墙上，打开新服务器的SSH连接端口，并复制文件:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="dc76" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/data# scp -i /root/.ssh/rtfm-do-old setevoy@67.207.75.202:/data/www/rtfm/rtfm.co.ua.tar.gz .<br/>setevoy@67.207.75.202’s password:<br/>rtfm.co.ua.tar.gz 100% 2409MB 101.3MB/s 00:23<br/>root@rtfm-do-production-d10:/data# scp -i /root/.ssh/rtfm-do-old setevoy@67.207.75.202:/data/www/rtfm/rtfm_db1_production.sql .<br/>setevoy@67.207.75.202’s password:<br/>rtfm_db1_production.sql</span></pre><p id="ee28" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">解压缩文件:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="95d0" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/data# tar xfpzv rtfm.co.ua.tar.gz</span></pre><p id="c77a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查它们:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="257f" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/data# ll<br/>total 2466844<br/>drwxr-xr-x 8 rtfm rtfm 4096 Nov 3 10:11 rtfm.co.ua<br/>-rw-r — r — 1 root root 2525973949 Nov 3 12:14 rtfm.co.ua.tar.gz<br/>-rw-r — r — 1 root root 59424 Nov 3 12:14 rtfm_db1_production.sql<br/>drwxr-xr-x 3 root root 4096 Nov 3 11:47 www</span></pre><p id="e574" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将<code class="fe li lj lk ll b">rtfm.co.ua</code>目录移动到<code class="fe li lj lk ll b">/data/www/rtfm</code>目录:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="42c0" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/data# rm -rf www/rtfm/rtfm.co.ua/<br/>root@rtfm-do-production-d10:/data# mv rtfm.co.ua www/rtfm/</span></pre><p id="172d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查文件:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="0df0" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/data# ll www/rtfm/rtfm.co.ua/<br/>total 388<br/>-rw-r — r — 1 rtfm rtfm 64 Nov 6 2018 1a24c4e2948b4047d3d1ed8516b5ca39e452ccfdb2f81a46a8984b921261bd1e.txt<br/>-rw-r — r — 1 rtfm rtfm 24 Nov 6 2018 404.html<br/>-rw-r — r — 1 root root 58 Jul 25 2019 ads.txt<br/>-rw-r — r — 1 rtfm rtfm 28522 Nov 6 2018 bin_dec.html<br/>-rw-r — r — 1 rtfm rtfm 30682 Nov 6 2018 favicon.ico<br/>-rw-r — r — 1 rtfm rtfm 405 Apr 1 2020 index.php<br/>-rw-r — r — 1 rtfm rtfm 3080 Nov 6 2018 keybase.txt<br/>-rw-r — r — 1 rtfm rtfm 19915 Aug 12 07:46 license.txt<br/>-rw-r — r — 1 rtfm rtfm 20 Nov 6 2018 live-4d939769.tx<br/>…</span></pre><p id="8652" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将转储上传到新数据库:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="de27" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/data# mysql -u rtfm -p rtfm_db1_production &lt; rtfm_db1_production.sql</span></pre><p id="8b6d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">输入密码:</p><p id="ffc7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更新本地<code class="fe li lj lk ll b">/etc/hosts</code> -和:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi oh"><img src="../Images/96e122c3cb0d08b90a583c287ef1ac06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*P9JDEyxmmv0q80mR.png"/></div></div></figure><p id="fd78" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">呃… WTF？</p><h2 id="2ae9" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated">建立数据库连接时出错</h2><p id="ec1e" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">检查数据库中的数据——似乎一切都在它的位置上:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="e112" class="nd ln iq ll b gy nt nu l nv nw">MariaDB [rtfm_db1_production]&gt; show tables;<br/>+ — — — — — — — — — — — — — — — — +<br/>| Tables_in_rtfm_db1_production |<br/>+ — — — — — — — — — — — — — — — — +<br/>| b2s_posts |<br/>| b2s_posts_network_details |<br/>| b2s_posts_sched_details |<br/>| b2s_user |<br/>| b2s_user_contact |<br/>| b2s_user_network_settings |<br/>…</span></pre><h2 id="5614" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated">PHP:检查MySQL连接</h2><p id="cdf1" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">让我们用一个简单的脚本来检查PHP  MySQL是否在工作，我们是否已经安装了所有必要的库:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="4e35" class="nd ln iq ll b gy nt nu l nv nw">&lt;?php <br/> <br/>$link = @mysqli_connect('localhost', 'rtfm', 'Ta6paidie7Ie'); <br/> <br/>if(!$link) { <br/>   die("Failed to connect to the server: " . mysqli_connect_error()); <br/>} else { <br/>   echo "Connected\n"; <br/>} <br/> <br/> <br/>if(!@mysqli_select_db($link, 'rtfm_db1_production')) { <br/>   die("Failed to connect to the database: " . mysqli_error($link)); <br/>} else { <br/>   echo "DB found\n"; <br/>} <br/> <br/>?&gt;</span></pre><p id="30cc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行它:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="4379" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/data/www/rtfm/rtfm.co.ua# php mysql.php<br/>Connected<br/>DB found</span></pre><p id="80a4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一切都好。</p><h2 id="f1fa" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated">WordPress: <code class="fe li lj lk ll b">WP_ALLOW_REPAIR</code></h2><p id="7629" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">尽量使用WordPress数据库<code class="fe li lj lk ll b">repair</code>——在<code class="fe li lj lk ll b">wp-config.php</code>前的“‘<em class="kt">就这样，停止编辑！快乐博客</em>’”行添加以下内容:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="979f" class="nd ln iq ll b gy nt nu l nv nw">define('WP_ALLOW_REPAIR', true);</span></pre><p id="74fd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并打开<a class="ae ks" href="https://rtfm.co.ua/wp-admin/maint/repair.php" rel="noopener ugc nofollow" target="_blank">https://rtfm.co.ua/wp-admin/maint/repair.php</a>网址:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi oi"><img src="../Images/208e21f62ef0805b8a90d70f95b1a5fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Oa-nsob2yNTKaSfT.png"/></div></div></figure><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi oj"><img src="../Images/bb1f06a73ae824d5e2fe5668cb53fa67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Uaw_1z2tZSg-trVm.png"/></div></div></figure><p id="cb6f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">似乎可以，但还是不行:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi ok"><img src="../Images/39265d8869abbf3c31b89a178f2743b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VFB7UvlGywN8KHBM.png"/></div></div></figure><p id="0753" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">最后一件事是安装一个干净的WordPress安装，它工作得很好</p><p id="6b90" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以，这确实是垃圾场本身的问题——但是是什么问题呢？</p><h2 id="d703" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated">“建立数据库连接时出错”原因</h2><p id="4292" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">于是，我去查了一下<code class="fe li lj lk ll b"><a class="ae ks" href="https://mariadb.com/kb/en/mysqldump/" rel="noopener ugc nofollow" target="_blank">mysqldump options</a></code>，终于得到了问题:</p><p id="b9f9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe li lj lk ll b">-d</code>、<code class="fe li lj lk ll b">--no-data</code>不写任何表格行信息(即不转储表格内容)。如果您只想转储表的<a class="ae ks" href="https://mariadb.com/kb/en/create-table/" rel="noopener ugc nofollow" target="_blank"> CREATE TABLE </a>语句(例如，通过加载转储文件创建表的空副本)，这将非常有用。请参见-忽略-表格-数据。</p><p id="2554" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">:-D</p><p id="ee95" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">不知道为什么我在创建转储时添加了<code class="fe li lj lk ll b">-d</code>，可能是在<a class="ae ks" href="https://rtfm.co.ua/aws-database-migration-service-obzor-i-primer-migracii-self-hosted-mariadb-v-aws-aurora-rds/" rel="noopener ugc nofollow" target="_blank"> AWS数据库迁移服务</a>陷入困境后，我不得不创建一个干净的数据库方案，没有数据。</p><p id="3fa3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以，这次不用<code class="fe li lj lk ll b">-d</code>再次创建转储:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="c3f3" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production:/home/setevoy# mysqldump -u rtfm -p rtfm_db1_production &gt; rtfm_db1_production.sql<br/>Enter password:</span></pre><p id="8540" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">重复所有的操作，现在一切都正常了——现在从新服务器写这篇文章:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="13e3" class="nd ln iq ll b gy nt nu l nv nw">13:59:52 [setevoy@setevoy-arch-work ~] $ dig rtfm.co.ua +short<br/>139.59.205.180</span></pre><p id="188b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下一步是什么？</p><p id="df81" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">需要配置<code class="fe li lj lk ll b">certbot</code>用于未来续订的webroot验证，并将其添加到cron进行自动更新。</p><p id="4cee" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">其余服务的收尾工作:</p><ul class=""><li id="9644" class="ku kv iq jw b jx jy kb kc kf kw kj kx kn ky kr kz la lb lc bi translated">放大剂</li><li id="eba3" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">备份脚本</li><li id="22f1" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">logz.io</li><li id="5d4d" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">无人值守升级</li><li id="2646" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">msmtp</li></ul><h1 id="61df" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">SSL: webroot验证</h1><p id="0c50" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">因此，我们已经有了一个证书，但它是通过DNS记录验证的。</p><p id="deeb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">据我所知，这将不会在<code class="fe li lj lk ll b">renew</code>工作，所以需要改变它的webroot。</p><h2 id="4d25" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated">让我们加密:webroot验证</h2><p id="3c9e" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">为<em class="kt">rtfm.co.ua</em>调用<code class="fe li lj lk ll b">certbot</code>，设置<code class="fe li lj lk ll b">--webroot-path</code>而不是<code class="fe li lj lk ll b">dns</code>——它必须找到一个已经存在的证书，并请求使用它或创建一个新的。</p><p id="fc1e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">关于第一个问题"<em class="kt">您希望如何向ACME CA进行认证？</em>【答案】<em class="kt">将文件放入webroot目录(webroot) </em>”，在第二个—“<em class="kt">您有一个现有的证书[…]</em>”—“<em class="kt">续订&amp;替换证书(限制每7天5个)</em>”，为域生成一个新的加密配置文件:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="7a1b" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/data# certbot certonly -d rtfm.co.ua — email user@example.com — agree-tos — webroot-path /data/www/rtfm/rtfm.co.ua/.well-known/<br/>Saving debug log to /var/log/letsencrypt/letsencrypt.log<br/>How would you like to authenticate with the ACME CA?<br/>- — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — -<br/>1: Spin up a temporary webserver (standalone)<br/>2: Place files in webroot directory (webroot)<br/>- — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — -<br/>Select the appropriate number [1–2] then [enter] (press ‘c’ to cancel): 2<br/>Plugins selected: Authenticator webroot, Installer None<br/>Cert not yet due for renewal<br/>You have an existing certificate that has exactly the same domains or certificate name you requested and isn’t close to expiry.<br/>(ref: /etc/letsencrypt/renewal/rtfm.co.ua.conf)<br/>What would you like to do?<br/>- — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — -<br/>1: Keep the existing certificate for now<br/>2: Renew &amp; replace the cert (limit ~5 per 7 days)<br/>- — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — -<br/>Select the appropriate number [1–2] then [enter] (press ‘c’ to cancel): 2<br/>Renewing an existing certificate<br/>IMPORTANT NOTES:<br/>- Congratulations! Your certificate and chain have been saved at:<br/>/etc/letsencrypt/live/rtfm.co.ua/fullchain.pem<br/>Your key file has been saved at:<br/>/etc/letsencrypt/live/rtfm.co.ua/privkey.pem<br/>…</span></pre><p id="ccf0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好了，一切正常，现在检查将在更新过程中使用的配置文件:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="86b7" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/data# cat /etc/letsencrypt/renewal/rtfm.co.ua.conf<br/>renew_before_expiry = 30 days<br/>version = 0.31.0<br/>archive_dir = /etc/letsencrypt/archive/rtfm.co.ua<br/>cert = /etc/letsencrypt/live/rtfm.co.ua/cert.pem<br/>privkey = /etc/letsencrypt/live/rtfm.co.ua/privkey.pem<br/>chain = /etc/letsencrypt/live/rtfm.co.ua/chain.pem<br/>fullchain = /etc/letsencrypt/live/rtfm.co.ua/fullchain.pem<br/># Options used in the renewal process<br/>[renewalparams]<br/>account = 868c8164304408984fefbbff845d4f48<br/>authenticator = webroot<br/>server = <a class="ae ks" href="https://acme-v02.api.letsencrypt.org/directory" rel="noopener ugc nofollow" target="_blank">https://acme-v02.api.letsencrypt.org/directory</a><br/>webroot_path = /data/www/rtfm/rtfm.co.ua/.well-known,<br/>[[webroot_map]]</span></pre><p id="020b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">很好——我们可以在这里添加一个<code class="fe li lj lk ll b">cronjob</code>。</p><h2 id="f889" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated"><code class="fe li lj lk ll b">certbot renew</code> -自动更新证书</h2><p id="23e3" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">添加一个crontask，每周运行一次<code class="fe li lj lk ll b">certbot renew</code>。</p><p id="b0de" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">编辑<code class="fe li lj lk ll b">crontab</code>:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="6992" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/data# crontab -e</span></pre><p id="5a6a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="6cf8" class="nd ln iq ll b gy nt nu l nv nw">@weekly certbot renew &amp;&gt; /var/log/letsencrypt/letsencrypt.log</span></pre><h2 id="8cdb" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated">让我们加密hook — NGINX重载</h2><p id="4410" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">这里的最后一件事是在证书更新后重新加载NGINX。</p><p id="ac14" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">它可以直接添加到crontask中，如下所示:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="d4f1" class="nd ln iq ll b gy nt nu l nv nw">@weekly certbot renew &amp;&gt; /var/log/letsencrypt/letsencrypt.log &amp;&amp; service nginx reload</span></pre><p id="44ee" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是在这种情况下，如果任何证书都不会更新，那么NGINX将被重新加载。</p><p id="c230" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以更好的方法是对域使用一个钩子——将它添加到<code class="fe li lj lk ll b">/etc/letsencrypt/renewal/rtfm.co.ua.conf</code>中。</p><p id="e642" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<code class="fe li lj lk ll b">renewalparams</code>中添加<code class="fe li lj lk ll b">renew_hook</code>，如下图所示:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="101e" class="nd ln iq ll b gy nt nu l nv nw">[renewalparams]<br/>account = 868c8164304408984fefbbff845d4f48<br/>authenticator = webroot<br/>server = <a class="ae ks" href="https://acme-v02.api.letsencrypt.org/directory" rel="noopener ugc nofollow" target="_blank">https://acme-v02.api.letsencrypt.org/directory</a><br/>webroot_path = /data/www/rtfm/rtfm.co.ua/.well-known,<br/>renew_hook = systemctl reload nginx</span></pre><p id="fae1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">实际上，我们已经完成了SSL设置，с SSL мы закончили.</p><h1 id="7a3e" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">Amplify — NGINX、PHP和服务器监控</h1><p id="c6e9" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">基层监控，但有一个漂亮的网络用户界面，可以在几分钟内添加，见<a class="ae ks" href="https://rtfm.co.ua/nginx-amplify-saas-monitoring-ot-nginx/" rel="noopener ugc nofollow" target="_blank">NGINX:Amplify—SaaSмониторинготNGINX</a>(<em class="kt">俄罗斯</em>)。</p><p id="32be" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">官方的文献记载是<a class="ae ks" href="https://amplify.nginx.com/docs/guide-installing-and-managing-nginx-amplify-agent.html" rel="noopener ugc nofollow" target="_blank">这里&gt; &gt; &gt; </a>。</p><p id="17ab" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下载安装脚本:</p><p id="b3e4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在变量中设置API-key并运行脚本:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="e377" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/tmp# API_KEY=’967***e31' sh ./install.sh</span></pre><p id="5c12" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">几分钟后，新主机出现在Amplify仪表盘上:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi ol"><img src="../Images/4181c6155c9021189d3957d133ed15da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*209wwh_vHRRfSsxl.png"/></div></div></figure><p id="48a6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">出于兴趣—在rtfm.co.ua的<em class="kt">域切换到新主机后，加载到旧主机上:</em></p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi om"><img src="../Images/44a4df00a74a76a4ceeb44a78c80d0a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fXyrl7h7x_40p291.png"/></div></div></figure><h1 id="f4a3" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">网站的备份脚本</h1><p id="ecac" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">我用的是我自己三年前写的Python脚本——<a class="ae ks" href="https://github.com/setevoy2/simple-backup" rel="noopener ugc nofollow" target="_blank">https://github.com/setevoy2/simple-backup</a>。它将归档文件，创建数据库转储，并可以将它们上传到AWS S3存储桶。</p><p id="d8ea" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">实际上，对于WordPress，有很多备份插件，但是我仍然没有时间去检查它们，所以我会用我的老方法。</p><p id="ac21" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">克隆工具:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="82a3" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/tmp# cd /opt/<br/>root@rtfm-do-production-d10:/opt# git clone <a class="ae ks" href="https://github.com/setevoy2/simple-backup" rel="noopener ugc nofollow" target="_blank">https://github.com/setevoy2/simple-backup</a></span></pre><p id="221d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">仍然不确定Github中的副本是否还能工作…</p><p id="f4a8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我记得，自动气象站S3上传系统在某个时候坏了，我没有修好它。</p><p id="4af5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们照原样试试:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="8798" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/opt# python simple-backup/sitebackup.py -h<br/>usage: sitebackup.py [-h] [-c CONFIG]<br/>optional arguments:<br/>-h, — help show this help message and exit<br/>-c CONFIG, — config CONFIG</span></pre><p id="a559" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">嗯，也许会有用。</p><p id="5fc8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于备份数据，它使用一个作为专用磁盘和配置文件挂载的<code class="fe li lj lk ll b">/backups</code>目录。</p><p id="ca54" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">首先，添加一个新卷。</p><p id="ed65" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在主机上的磁盘和分区:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="8198" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/opt# lsblk<br/>NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT<br/>vda 254:0 0 60G 0 disk<br/>├─vda1 254:1 0 60G 0 part /<br/>└─vda2 254:2 0 2M 0 part<br/>vdb 254:16 0 466K 1 disk</span></pre><h2 id="621b" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated">数字海洋体积</h2><p id="be3f" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">转到数字海洋，创建一个卷:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi on"><img src="../Images/c754b35c31f82362f99b644c98840944.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2Ho9l4ikWlBoSgsp.png"/></div></div></figure><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi oo"><img src="../Images/c676309abf916f3dd7e8522ea8bf95b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eKuqdt9OdeoeVRBy.png"/></div></div></figure><p id="be14" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在主机上检查它:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="b6c9" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/opt# lsblk<br/>NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT<br/>sda 8:0 0 50G 0 disk /mnt/rtfm_do_production_d10_backups<br/>vda 254:0 0 60G 0 disk<br/>├─vda1 254:1 0 60G 0 part /<br/>└─vda2 254:2 0 2M 0 part<br/>vdb 254:16 0 466K 1 disk</span></pre><h2 id="0128" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated">Linux:挂载一个卷</h2><p id="5298" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">DigitalOcean Volume默认安装在<code class="fe li lj lk ll b">/mnt/rtfm_do_production_d10_backups</code>上，并且没有在<code class="fe li lj lk ll b">fstab</code>中创建记录:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="0346" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/opt# cat /etc/fstab<br/>/etc/fstab: static file system information.<br/>UUID=4e8b8101–6a06–429a-aaca-0ccd7ff14aa1 / ext4 errors=remount-ro 0 1</span></pre><p id="0096" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">卸载它:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="8f25" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/opt# umount /mnt/rtfm_do_production_d10_backups</span></pre><p id="94bc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建<code class="fe li lj lk ll b">/backups</code>目录:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="440c" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/opt# mkdir /backups</span></pre><p id="33f8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">获取新磁盘的UUID:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="ac58" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/opt# blkid /dev/sda<br/>/dev/sda: UUID=”a6e27193–4079–4d9d-812e-6ba29c702b75" TYPE=”ext4"</span></pre><p id="65ec" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更新<code class="fe li lj lk ll b">/etc/fstab</code>——将该卷挂载添加到<code class="fe li lj lk ll b">/backups</code>中，在opts中用<code class="fe li lj lk ll b">nofail</code>选项设置该磁盘不需要存在，这样系统可以在没有它的情况下启动:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="519f" class="nd ln iq ll b gy nt nu l nv nw"># /etc/fstab: static file system information.<br/>UUID=4e8b8101-6a06-429a-aaca-0ccd7ff14aa1   /   ext4    errors=remount-ro   0   1<br/>UUID=a6e27193-4079-4d9d-812e-6ba29c702b75   /backups ext4 nofail 0 0</span></pre><p id="c54b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">尝试挂载<code class="fe li lj lk ll b">/etc/fstab</code>中指定的所有卷:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="c0d8" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/opt# mount -a</span></pre><p id="8744" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="29ee" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/opt# lsblk<br/>NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT<br/>sda 8:0 0 50G 0 disk /backups<br/>vda 254:0 0 60G 0 disk<br/>├─vda1 254:1 0 60G 0 part /<br/>└─vda2 254:2 0 2M 0 part<br/>vdb 254:16 0 466K 1 disk</span></pre><p id="812a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">看起来不错，数据在这里:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="b3a1" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/opt# ll /backups/<br/>total 16<br/>drwx — — — 2 root root 16384 Nov 4 12:44 lost+found</span></pre><p id="1baf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">重新启动服务器以确保一切正常也是好的，但会在完成这篇文章后再做。</p><p id="1f89" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">可以从旧主机上获取<code class="fe li lj lk ll b">simple-backup</code>的配置文件，让我们试着运行它:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="1b35" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/opt# /opt/simple-backup/sitebackup.py -c /usr/local/etc/production-simple-backup.ini<br/>Got own settings:<br/>backup_root_path = /backups<br/>backup_files_dir = /backups/files<br/>backup_db_dir = /backups/databases<br/>Checking directories:<br/>/backups — found, OK.<br/>/backups/files — found, OK.<br/>/backups/databases — found, OK.<br/>Creating WWW backup for:<br/>site: rtfm<br/>from: /data/www/rtfm/rtfm.co.ua/<br/>to: /backups/files/04–11–2020–12–58_rtfm_rtfm.co.ua.gz<br/>WWW backup done.<br/>Creating DB backup for:<br/>site: rtfm<br/>host: localhost<br/>database: rtfm_db1_production<br/>user: rtfm<br/>to: /backups/databases/04–11–2020–12–58_rtfm_rtfm_db1_production.sql<br/>DB backup done.<br/>Checking for dependencies:<br/>boto3 library already installed — OK.<br/>Uploading /backups/files/04–11–2020–12–58_rtfm_rtfm.co.ua.gz to S3 bucket setevoy-rtfm-simple-backups-production as 04–11–2020–12–58_rtfm_rtfm.co.ua.gz<br/>Uploading /backups/databases/04–11–2020–12–58_rtfm_rtfm_db1_production.sql to S3 bucket setevoy-rtfm-simple-backups-production as 04–11–2020–12–58_rtfm_rtfm_db1_production.sql<br/>Existing data in the setevoy-rtfm-simple-backups-production bucket:<br/>04–11–2020–12–58_rtfm_rtfm.co.ua.gz<br/>04–11–2020–12–58_rtfm_rtfm_db1_production.sql<br/>…<br/>Starting local backups storage cleanup…<br/>Keeping local data: /backups/files/04–11–2020–12–52_rtfm_rtfm.co.ua.gz<br/>Keeping local data: /backups/files/04–11–2020–12–58_rtfm_rtfm.co.ua.gz<br/>Keeping local data: /backups/databases/04–11–2020–12–58_rtfm_rtfm_db1_production.sql<br/>Keeping local data: /backups/databases/04–11–2020–12–52_rtfm_rtfm_db1_production.sql</span></pre><p id="d9a2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">哈！</p><p id="03c4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">甚至AWS S4上传再次工作！</p><p id="c19b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">太好了，我们到此为止。</p><p id="ccaa" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下一步是什么？</p><ul class=""><li id="be2d" class="ku kv iq jw b jx jy kb kc kf kw kj kx kn ky kr kz la lb lc bi translated">logz.io</li><li id="0c47" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">无人值守升级</li><li id="ec49" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">对数旋转</li><li id="1e70" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">msmtp</li></ul><h1 id="ccba" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">Logz.io，Filebeat и логи NGINX</h1><p id="a3b6" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">让我们将NGINX日志收集添加到Logz.io中。</p><p id="5038" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">注册一个账户，然后进入文档—<a class="ae ks" href="https://app.logz.io/#/dashboard/data-sources/nginx" rel="noopener ugc nofollow" target="_blank">https://app.logz.io/#/dashboard/data-sources/nginx</a>。</p><p id="fca2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">需要安装<a class="ae ks" href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation-configuration.html" rel="noopener ugc nofollow" target="_blank"> Filebeat </a>，添加它:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="327d" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/opt# cd /tmp/<br/>root@rtfm-do-production-d10:/tmp# curl -L -O <a class="ae ks" href="https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.9.3-amd64.deb" rel="noopener ugc nofollow" target="_blank">https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.9.3-amd64.deb</a><br/>root@rtfm-do-production-d10:/tmp# dpkg -i filebeat-7.9.3-amd64.deb</span></pre><p id="46bd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">获取Logz.io的公共证书:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="8bbf" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/tmp# sudo curl <a class="ae ks" href="https://raw.githubusercontent.com/logzio/public-certificates/master/AAACertificateServices.crt" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/logzio/public-certificates/master/AAACertificateServices.crt</a> — create-dirs -o /etc/pki/tls/certs/COMODORSADomainValidationSecureServerCA.crt</span></pre><p id="c28f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">配置文件节拍。</p><p id="1a61" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">备份配置:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="79d4" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/tmp# cp /etc/filebeat/filebeat.yml /etc/filebeat/filebeat.yml-origin</span></pre><p id="45ac" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">根据文档更新它—只需复制粘贴即可:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi op"><img src="../Images/86683e3080e4a464b6a44d00372fe9d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:762/format:webp/0*oRda1RZAZb447vDV.png"/></div></figure><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="97fa" class="nd ln iq ll b gy nt nu l nv nw">...<br/>- type: log<br/>  paths:<br/>  - /var/log/nginx/access.log<br/>  - /var/log/nginx/rtfm.co.ua-access.log<br/>  fields:<br/>    logzio_codec: plain<br/>    token: JzR***ZmW<br/>    type: nginx_access<br/>  fields_under_root: true<br/>  encoding: utf-8<br/>  ignore_older: 3h<br/>- type: log<br/>  paths:<br/>  - /var/log/nginx/error.log<br/>  - /var/log/nginx/rtfm.co.ua-error.log<br/>  fields:<br/>    logzio_codec: plain<br/>    token: JzR***ZmW<br/>    type: nginx_error<br/>  fields_under_root: true<br/>  encoding: utf-8<br/>  ignore_older: 3h<br/><br/>...</span></pre><p id="03a3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<code class="fe li lj lk ll b">outputs</code>中注释掉<code class="fe li lj lk ll b">output.elasticsearch</code>块，并添加<code class="fe li lj lk ll b">output.logstash</code>:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi oq"><img src="../Images/ccc31dcb7fc1ba9996ac49da028d5d3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*J2yUqCS0cSEDdHhZ.png"/></div></div></figure><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="8d10" class="nd ln iq ll b gy nt nu l nv nw">...<br/># ------------------------------ Logstash Output -------------------------------<br/># ...<br/>output.logstash:<br/>  hosts: ["listener.logz.io:5015"]<br/>  ssl:<br/>    certificate_authorities: ['/etc/pki/tls/certs/COMODORSADomainValidationSecureServerCA.crt'<br/>...</span></pre><p id="45b9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查其语法:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="78e3" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/tmp# filebeat test config<br/>Config OK</span></pre><p id="1441" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查与Logz.io的连接:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="b81c" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/tmp# filebeat test output<br/>logstash: listener.logz.io:5015…<br/>connection…<br/>parse host… OK<br/>dns lookup… OK<br/>addresses: 23.22.183.192<br/>dial up… OK<br/>TLS…<br/>security: server’s certificate chain verification is enabled<br/>handshake… OK<br/>TLS version: TLSv1.2<br/>dial up… OK<br/>talk to server… OK</span></pre><p id="b467" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">重新启动服务:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="b377" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/tmp# systemctl restart filebeat</span></pre><p id="954e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查日志:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi or"><img src="../Images/767034adf76faa5bffe13a01109b82cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yXI3F96VSYJ9q4yp.png"/></div></div></figure><p id="ff54" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">数据在这里。</p><p id="78c7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">于是，只剩下了<code class="fe li lj lk ll b">unattended-upgrades</code>、<code class="fe li lj lk ll b">logrotate</code>和<code class="fe li lj lk ll b">msmtp</code>。</p><h1 id="c9fa" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">安装<code class="fe li lj lk ll b">unattended-upgrades</code></h1><p id="1805" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">已经在<a class="ae ks" href="https://rtfm.co.ua/debian-avtomaticheskie-obnovleniya-s-pomoshhyu-unattended-upgrades-i-otpravka-pochty-cherez-aws-ses/" rel="noopener ugc nofollow" target="_blank">debian:автоматическиеобновленияспомощью无人值守-升级иотправкапочтычерезAWS SES</a>(<em class="kt">RUS</em>)中描述过了，让我们在没有AWS ses的情况下在这里做吧。</p><p id="64e8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里的文档是<a class="ae ks" href="https://wiki.debian.org/UnattendedUpgrades" rel="noopener ugc nofollow" target="_blank">&gt;&gt;&gt;</a>。</p><p id="b1a7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe li lj lk ll b">unattended-upgrades</code>和<code class="fe li lj lk ll b">apt-listchanges</code>已经安装，只需要配置一下。</p><p id="7992" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">跑<code class="fe li lj lk ll b">dpkg-reconfigure unattended-upgrades</code>:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi os"><img src="../Images/40a7f85ae92bbe4a0007a236f13ba258.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*83U8tzSy6jVyqqfY.png"/></div></div></figure><p id="ce7c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">回答<em class="kt">是</em>。</p><p id="5854" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查<code class="fe li lj lk ll b">/etc/apt/apt.conf.d/20auto-upgrades</code>:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="5989" class="nd ln iq ll b gy nt nu l nv nw">APT::Periodic::Update-Package-Lists "1";<br/>APT::Periodic::Unattended-Upgrade "1";</span></pre><p id="932a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在不需要在<code class="fe li lj lk ll b">APT::Periodic::Enable</code>选项中启用更新，这两行就足够了。</p><p id="e244" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来，检查<code class="fe li lj lk ll b">/etc/apt/apt.conf.d/50unattended-upgrades</code>。</p><p id="3504" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一般来说，您可以在这里保留所有的默认值，但是值得设置:</p><ul class=""><li id="ee2b" class="ku kv iq jw b jx jy kb kc kf kw kj kx kn ky kr kz la lb lc bi translated"><code class="fe li lj lk ll b">Unattended-Upgrade::Mail</code> -获取关于已安装更新的电子邮件</li><li id="c200" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><code class="fe li lj lk ll b">Unattended-Upgrade::Automatic-Reboot</code> -由你决定，现在，可以把它留给<em class="kt">假</em>，以后再启用</li><li id="fbe2" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><code class="fe li lj lk ll b">Unattended-Upgrade::Automatic-Reboot-Time</code> -如果前面的选项将被启用，值得设置重启时间</li></ul><p id="59c2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行测试升级:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="07c7" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/tmp# unattended-upgrade -v -d — dry-run<br/>…<br/>No packages found that can be upgraded unattended and no pending auto-removals</span></pre><p id="032a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好吧。</p><p id="8c75" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，让我们来看看<code class="fe li lj lk ll b">logrotate</code>配置。</p><h1 id="06a4" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated"><code class="fe li lj lk ll b">logrotate</code></h1><p id="7cf6" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">实际上，那里也是万事俱备。</p><p id="059a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所有<code class="fe li lj lk ll b">logrotate</code>配置文件:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="4d7f" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/tmp# ll /etc/logrotate.d/<br/>total 60<br/>-rw-r — r — 1 root root 120 Apr 19 2019 alternatives<br/>-rw-r — r — 1 root root 122 Sep 23 2019 amplify-agent<br/>-rw-r — r — 1 root root 173 May 12 09:57 apt<br/>-rw-r — r — 1 root root 79 Feb 13 2019 aptitude<br/>-rw-r — r — 1 root root 130 Aug 28 2018 btmp<br/>-rw-r — r — 1 root root 82 May 26 2018 certbot<br/>-rw-r — r — 1 root root 112 Apr 19 2019 dpkg<br/>-rw-r — r — 1 root root 146 May 13 16:01 exim4-base<br/>-rw-r — r — 1 root root 126 May 13 16:01 exim4-paniclog<br/>-rw-r — r — 1 root root 802 Oct 12 17:46 mysql-server<br/>-rw-r — r — 1 root root 329 Aug 24 10:18 nginx<br/>-rw-r — r — 1 root root 155 Jul 5 06:46 php7.3-fpm<br/>-rw-r — r — 1 root root 501 Feb 26 2019 rsyslog<br/>-rw-r — r — 1 root root 235 Jun 8 2019 unattended-upgrades<br/>-rw-r — r — 1 root root 145 Feb 19 2018 wtmp</span></pre><p id="3899" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">NGINX日志循环配置:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="9441" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/tmp# cat /etc/logrotate.d/nginx<br/>/var/log/nginx/*.log {<br/>daily<br/>missingok<br/>rotate 14<br/>compress<br/>delaycompress<br/>notifempty<br/>create 0640 www-data adm<br/>sharedscripts<br/>prerotate<br/>if [ -d /etc/logrotate.d/httpd-prerotate ]; then \<br/>run-parts /etc/logrotate.d/httpd-prerotate; \<br/>fi \<br/>endscript<br/>postrotate<br/>invoke-rc.d nginx rotate &gt;/dev/null 2&gt;&amp;1<br/>endscript<br/>}</span></pre><p id="e337" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">也许，以后会添加<code class="fe li lj lk ll b"><a class="ae ks" href="https://linux.die.net/man/8/logrotate" rel="noopener ugc nofollow" target="_blank">size</a></code>参数。</p><p id="68a6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查其工作:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="f8c3" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/tmp# logrotate -f -v /etc/logrotate.conf<br/>…<br/>considering log /var/log/kern.log<br/>Now: 2020–11–04 14:25<br/>Last rotated at 2020–11–04 00:00<br/>log needs rotating<br/>…</span></pre><p id="fc68" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一些日志已经可以旋转。</p><h1 id="897b" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated"><code class="fe li lj lk ll b">mailx</code>和<code class="fe li lj lk ll b">msmtp</code> -从服务器发送电子邮件</h1><p id="24ff" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">根用户将收到关于服务器状态的电子邮件，最好是在外部电子邮箱中接收。</p><p id="b0a0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">首先，检查<code class="fe li lj lk ll b">/etc/aliases</code>以了解哪个电子邮件用于root用户:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="86ee" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/tmp# cat /etc/aliases<br/>/etc/aliases<br/>mailer-daemon: postmaster<br/>postmaster: root<br/>nobody: root<br/>hostmaster: root<br/>usenet: root<br/>news: root<br/>webmaster: root<br/>www: root<br/>ftp: root<br/>abuse: root<br/>noc: root<br/>security: root<br/>root: root@example.com</span></pre><p id="da04" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果在此进行任何更新，请运行:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="a4d4" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/tmp# newaliases</span></pre><h2 id="5af2" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated">550 001.RDNS/PTR错误。拒绝</h2><p id="8842" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">因此，给root用户的电子邮件将被发送到<em class="kt">root@example.com</em>，但是如果现在尝试发送电子邮件，它将不会被发送:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="05cd" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/tmp# echo Test | mailx -s Test root@example.com</span></pre><p id="fffe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这是因为它通过MTA进出口银行发送，查看其日志:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="adad" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/tmp# tail /var/log/exim4/mainlog<br/>…<br/>2020–11–04 14:38:16 1kaJvU-00032w-7q &lt;= root@rtfm-do-production-d10 U=root P=local S=405<br/>…<br/>2020–11–04 14:39:08 1kaJvI-00032T-Dx ** root@example.com &lt;root@rtfm-do-production-d10&gt; R=dnslookup T=remote_smtp H=mx1.mail7.freehost.com.ua [194.0.200.210] X=TLS1.2:ECDHE_RSA_AES_256_GCM_SHA384:256 CV=no DN=”CN=*.freehost.com.ua”: SMTP error from remote mail server after RCPT TO:&lt;root@example.com&gt;: 550 001.RDNS/PTR error. Rejected</span></pre><p id="e894" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"><em class="kt">“550 001.RDNS/PTR错误。拒绝</em></strong>”—这是因为我们还没有为服务器的FloatinIP配置PTR记录，在DigitalOcean上我们不能轻易更新它。</p><p id="ea8b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了缓解这个问题，请安装<code class="fe li lj lk ll b"><a class="ae ks" href="https://wiki.archlinux.org/index.php/msmtp" rel="noopener ugc nofollow" target="_blank">msmtp</a></code>，因此我们将通过外部SMTP服务器而不是本地服务器发送电子邮件:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="07c2" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/tmp# apt -y install msmtp msmtp-mta</span></pre><p id="dade" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe li lj lk ll b">msmtp-mta</code>将从<code class="fe li lj lk ll b">/usr/sbin/sendmail</code>创建一个符号链接，当<code class="fe li lj lk ll b">mailx</code>试图通过<code class="fe li lj lk ll b">sendmail</code>发送电子邮件时，它将实际使用<code class="fe li lj lk ll b">msmtp</code>:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="14a8" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/tmp# ls -l /usr/sbin/sendmail<br/>lrwxrwxrwx 1 root root 12 Feb 15 2019 /usr/sbin/sendmail -&gt; ../bin/msmtp</span></pre><p id="7cee" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">配置<code class="fe li lj lk ll b">/etc/msmtprc</code>:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="8648" class="nd ln iq ll b gy nt nu l nv nw">defaults<br/>port 25<br/>tls on<br/>tls_trust_file /etc/ssl/certs/ca-certificates.crt<br/><br/>account freehost<br/>host freemail.freehost.com.ua<br/>from user@example.com<br/>auth on<br/>user user@example.com<br/>password password<br/><br/># Set a default account<br/>account default : freehost</span></pre><p id="7316" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="db7e" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/tmp# echo “test username.” | msmtp -a default myuser@google.com</span></pre><h2 id="5ae2" class="nd ln iq bd lo ne nf dn ls ng nh dp lw kf ni nj ma kj nk nl me kn nm nn mi no bi translated">mailx:无法发送消息:进程以非零状态退出</h2><p id="f2e1" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">通过<code class="fe li lj lk ll b">msmtp</code>用<code class="fe li lj lk ll b">mailx</code>发送电子邮件——安装<code class="fe li lj lk ll b">bsd-mailx</code>而不是<code class="fe li lj lk ll b">mailutils</code>:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="5d83" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/tmp# apt -y purge mailutils<br/>root@rtfm-do-production-d10:/tmp# apt -y install bsd-mailx</span></pre><p id="9543" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">否则，您会得到“<strong class="jw ir"> <em class="kt"> mailx:无法发送消息:进程以非零状态</em> </strong>”和“<strong class="jw ir"> <em class="kt"> msmtp:未找到收件人</em> </strong>”错误。</p><p id="bbd4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">尝试用<code class="fe li lj lk ll b">mailx</code>发送:</p><pre class="mt mu mv mw gt np ll nq nr aw ns bi"><span id="7b69" class="nd ln iq ll b gy nt nu l nv nw">root@rtfm-do-production-d10:/tmp# echo Test | mailx -s Test myuser@google.com</span></pre><p id="8a87" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，来自<code class="fe li lj lk ll b">unattended-upgrades</code>的邮件必须发送到<code class="fe li lj lk ll b">Unattended-Upgrade::Mail</code>中指定的邮箱。</p><p id="126b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">嗯，就这些。</p></div><div class="ab cl ot ou hu ov" role="separator"><span class="ow bw bk ox oy oz"/><span class="ow bw bk ox oy oz"/><span class="ow bw bk ox oy"/></div><div class="ij ik il im in"><p id="7542" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="kt">最初发布于</em> <a class="ae ks" href="https://rtfm.co.ua/en/linux-lemp-set-up-nginx-php-mysql-ssl-monitoring-logs-and-a-wordpress-blog-migration/" rel="noopener ugc nofollow" target="_blank"> <em class="kt"> RTFM: Linux、DevOps和系统管理</em> </a> <em class="kt">。</em></p></div></div>    
</body>
</html>