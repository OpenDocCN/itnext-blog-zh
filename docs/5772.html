<html>
<head>
<title>Trino on Nomad</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">特里诺论游牧</h1>
<blockquote>原文：<a href="https://itnext.io/trino-on-nomad-79cb398a826?source=collection_archive---------3-----------------------#2021-05-21">https://itnext.io/trino-on-nomad-79cb398a826?source=collection_archive---------3-----------------------#2021-05-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/931c24a1e80e442c9a02a9e2d8bbd94c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jViMo7OoWqLDdbYM"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">克里斯·莱贾拉祖在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="d866" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://trino.io/" rel="noopener ugc nofollow" target="_blank"> Trino(原PrestoSQL) </a>是数据湖中流行的分布式交互查询引擎。Trino不仅可以作为查询引擎，还可以作为数据湖中的数据准备引擎。作为数据平台组件，Trino是我在data lake中最喜欢使用的组件之一。在这里，我将向您展示如何在Nomad上部署Trino。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="89f8" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">先决条件</h1><p id="e513" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">在开始之前，您应该可以使用以下组件。</p><ul class=""><li id="faf4" class="ml mm iq kf b kg kh kk kl ko mn ks mo kw mp la mq mr ms mt bi translated">Hive Metastore:在这篇文章中，Hive目录将被添加到Trino。如果您没有可用的Hive Metastore，您可以在Nomad 上看到<a class="ae kc" rel="noopener ugc nofollow" target="_blank" href="/hive-metastore-on-nomad-5378bf1e0a2c"> Hive Metastore。</a></li><li id="dd45" class="ml mm iq kf b kg mu kk mv ko mw ks mx kw my la mq mr ms mt bi translated">S3或迷你S3对象存储</li><li id="bec9" class="ml mm iq kf b kg mu kk mv ko mw ks mx kw my la mq mr ms mt bi translated">nomad 1 . 0 . 4版</li><li id="feb5" class="ml mm iq kf b kg mu kk mv ko mw ks mx kw my la mq mr ms mt bi translated">咨询模板v0.22.1</li></ul><h1 id="e646" class="li lj iq bd lk ll mz ln lo lp na lr ls lt nb lv lw lx nc lz ma mb nd md me mf bi translated">构建Trino docker映像</h1><p id="bab8" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">因为我将使用运行在Nomad上的Trino服务器和Trino CLI的映像，所以我们应该首先构建它们。</p><h2 id="7fed" class="ne lj iq bd lk nf ng dn lo nh ni dp ls ko nj nk lw ks nl nm ma kw nn no me np bi translated">构建Trino服务器docker映像</h2><p id="42e8" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">Trino服务器的<code class="fe nq nr ns nt b">Dockerfile</code>看起来如下:</p><pre class="nu nv nw nx gt ny nt nz oa aw ob bi"><span id="da4e" class="ne lj iq nt b gy oc od l oe of">FROM openjdk:11-slim<br/><br/>ENV APP_HOME /opt/trino-server<br/>ENV TRINO_USER trino<br/>ARG TRINO_VER<br/><br/>RUN useradd -ms /bin/bash -d ${APP_HOME} ${TRINO_USER}<br/><br/>RUN apt-get update &amp;&amp; apt-get install -y curl dnsutils netcat python --no-install-recommends \<br/>   &amp;&amp; rm -rf /var/lib/apt/lists/*<br/><br/>RUN set -ex \<br/>    &amp;&amp; PACK_NAME=trino-server-${TRINO_VER} \<br/>    &amp;&amp; FILE_NAME=${PACK_NAME}.tar.gz \<br/>    &amp;&amp; curl -O https://repo1.maven.org/maven2/io/trino/trino-server/${TRINO_VER}/${FILE_NAME} \<br/>    &amp;&amp; tar -zxf ${FILE_NAME} \<br/>    &amp;&amp; cp -R ${PACK_NAME}/* ${APP_HOME} \<br/>    &amp;&amp; mkdir -p ${APP_HOME}/etc/catalog \<br/>    &amp;&amp; rm -rf ${FILE_NAME} \<br/>    &amp;&amp; rm -rf ${PACK_NAME}<br/><br/>RUN ls -al ${APP_HOME}<br/><br/>RUN chmod a+x -R ${APP_HOME}/bin<br/>RUN chown ${TRINO_USER}: -R ${APP_HOME}<br/><br/>RUN set -ex \<br/>    &amp;&amp; echo 'trino soft nofile 131072' &gt;&gt; /etc/security/limits.d/trino.conf \<br/>    &amp;&amp; echo 'trino hard nofile 131072' &gt;&gt; /etc/security/limits.d/trino.conf<br/>RUN cat /etc/security/limits.d/trino.conf<br/><br/>USER ${TRINO_USER}<br/>WORKDIR ${APP_HOME}</span></pre><p id="bf5c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Trino <code class="fe nq nr ns nt b">356</code>将用于构建图像。创建并推送Trino服务器映像。</p><pre class="nu nv nw nx gt ny nt nz oa aw ob bi"><span id="2756" class="ne lj iq nt b gy oc od l oe of"># image.<br/>export TRINO_VERSION=356<br/>export TRINO_IMAGE=mykidong/trino:${TRINO_VERSION}</span><span id="5bd3" class="ne lj iq nt b gy og od l oe of"># build.<br/>docker build . --build-arg TRINO_VER=${TRINO_VERSION} -t ${TRINO_IMAGE};</span><span id="2df5" class="ne lj iq nt b gy og od l oe of">## push.<br/>docker push ${TRINO_IMAGE};</span></pre><h2 id="a5a9" class="ne lj iq bd lk nf ng dn lo nh ni dp ls ko nj nk lw ks nl nm ma kw nn no me np bi translated">构建Trino CLI docker映像</h2><p id="2cf8" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">Trino CLI将用于查询Nomad上Trino服务器中的数据。让我们创造它的<code class="fe nq nr ns nt b">Dockerfile</code>。</p><pre class="nu nv nw nx gt ny nt nz oa aw ob bi"><span id="05b2" class="ne lj iq nt b gy oc od l oe of">FROM openjdk:8-slim<br/><br/>RUN apt-get update &amp;&amp; apt-get install -y curl less --no-install-recommends \<br/>   &amp;&amp; rm -rf /var/lib/apt/lists/*<br/><br/>ARG TRINO_VER<br/>RUN curl -o /opt/trino-cli https://repo1.maven.org/maven2/io/trino/trino-cli/${TRINO_VER}/trino-cli-${TRINO_VER}-executable.jar \<br/>   &amp;&amp; chmod +x /opt/trino-cli<br/><br/># Remove curl.<br/>RUN apt-get --purge remove -y curl &amp;&amp; apt-get autoremove -y</span></pre><p id="344d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并建设推送Trino CLI的形象。</p><pre class="nu nv nw nx gt ny nt nz oa aw ob bi"><span id="4926" class="ne lj iq nt b gy oc od l oe of"># image.<br/>export TRINO_VERSION=356<br/>export TRINO_CLI_IMAGE=mykidong/trino-cli:${TRINO_VERSION}</span><span id="409a" class="ne lj iq nt b gy og od l oe of"># build.<br/>docker build . --build-arg TRINO_VER=${TRINO_VERSION} -t ${TRINO_CLI_IMAGE};</span><span id="6d17" class="ne lj iq nt b gy og od l oe of">## push.<br/>docker push ${TRINO_CLI_IMAGE};</span></pre><h1 id="05d2" class="li lj iq bd lk ll mz ln lo lp na lr ls lt nb lv lw lx nc lz ma mb nd md me mf bi translated">在游牧者身上部署崔诺</h1><p id="2c1c" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">我们将在Nomad上部署一名Trino协调员、三名Trino工作人员和一名Trino CLI，因此Trino工作概述如下。</p><pre class="nu nv nw nx gt ny nt nz oa aw ob bi"><span id="5f45" class="ne lj iq nt b gy oc od l oe of">job "trino" {<br/>  namespace = "trino"<br/>  ...<br/>  group "coordinator" {<br/>    count = 1<br/>    ...<br/>  } <br/>  group "worker" {<br/>    count = 3<br/>    ...<br/>  } <br/>  group "cli" {<br/>    count = 1<br/>    ...<br/>  }<br/>}</span></pre><p id="bce7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们来看看小组的详细情况<code class="fe nq nr ns nt b">coordinator .</code></p><pre class="nu nv nw nx gt ny nt nz oa aw ob bi"><span id="6185" class="ne lj iq nt b gy oc od l oe of">group "coordinator" {<br/>    count = 1<br/>    restart {<br/>      attempts = 3<br/>      delay = "30s"<br/>      interval = "5m"<br/>      mode = "fail"<br/>    }<br/>    network {<br/>      port "http" {<br/>      }<br/>    }<br/>    task "trino-server" {<br/>      driver = "docker"<br/>      kill_timeout = "300s"<br/>      kill_signal = "SIGTERM"<br/>      template {<br/>        data = &lt;&lt;EOF<br/>coordinator=true<br/>node-scheduler.include-coordinator=false<br/>http-server.http.port={{ env "NOMAD_HOST_PORT_http" }}<br/>query.max-memory=5GB<br/>query.max-memory-per-node=1GB<br/>query.max-total-memory-per-node=2GB<br/>query.max-stage-count=200<br/>task.writer-count=4<br/>discovery-server.enabled=true<br/>discovery.uri=<a class="ae kc" rel="noopener ugc nofollow" target="_blank" href="/{{">http://{{</a> env "NOMAD_IP_http" }}:{{ env "NOMAD_HOST_PORT_http" }}<br/>EOF<br/>        destination = "local/config.properties"<br/>      }<br/>      template {<br/>        data = &lt;&lt;EOF<br/>node.id={{ env "NOMAD_NAMESPACE" }}-{{ env "NOMAD_JOB_NAME" }}-{{ env "NOMAD_GROUP_NAME" }}-{{ env "NOMAD_ALLOC_ID" }}<br/>node.environment=production<br/>node.data-dir=/opt/trino-server/data<br/>spiller-spill-path=/tmp<br/>max-spill-per-node=4TB<br/>query-max-spill-per-node=1TB<br/>EOF<br/>        destination = "local/node.properties"<br/>      }<br/>      template {<br/>        data = &lt;&lt;EOF<br/>-server<br/>-Xmx16G<br/>-XX:-UseBiasedLocking<br/>-XX:+UseG1GC<br/>-XX:G1HeapRegionSize=32M<br/>-XX:+ExplicitGCInvokesConcurrent<br/>-XX:+ExitOnOutOfMemoryError<br/>-XX:+HeapDumpOnOutOfMemoryError<br/>-XX:ReservedCodeCacheSize=512M<br/>-XX:PerMethodRecompilationCutoff=10000<br/>-XX:PerBytecodeRecompilationCutoff=10000<br/>-Djdk.attach.allowAttachSelf=true<br/>-Djdk.nio.maxCachedBufferSize=2000000<br/>EOF<br/>        destination = "local/jvm.config"<br/>      }<br/>      template {<br/>        data = &lt;&lt;EOF<br/>connector.name=hive-hadoop2<br/>hive.metastore.uri=thrift://{{range $index, $element := service "hive-metastore"}}{{if eq $index 0}}{{ .Address }}:{{ .Port }}{{end}}{{end}}<br/>hive.allow-drop-table=true<br/>hive.max-partitions-per-scan=1000000<br/>hive.compression-codec=NONE<br/>hive.s3.endpoint=<a class="ae kc" href="https://nginx-test.cloudchef-labs.com" rel="noopener ugc nofollow" target="_blank">https://nginx-test.cloudchef-labs.com</a><br/>hive.s3.path-style-access=true<br/>hive.s3.ssl.enabled=true<br/>hive.s3.max-connections=100<br/>hive.s3.aws-access-key=cclminio<br/>hive.s3.aws-secret-key=rhksflja!@#<br/>EOF<br/>        destination = "local/catalog/hive.properties"<br/>      }<br/>      config {<br/>        image = "mykidong/trino:356"<br/>        force_pull = false<br/>        volumes = [<br/>          "./local/config.properties:/opt/trino-server/etc/config.properties",<br/>          "./local/node.properties:/opt/trino-server/etc/node.properties",<br/>          "./local/jvm.config:/opt/trino-server/etc/jvm.config",<br/>          "./local/catalog/hive.properties:/opt/trino-server/etc/catalog/hive.properties"<br/>        ]<br/>        command = "bin/launcher"<br/>        args = [<br/>          "run"<br/>        ]<br/>        ports = [<br/>          "http"<br/>        ]<br/>        ulimit {<br/>          nofile = "131072"<br/>          nproc = "65536"<br/>        }<br/>      }<br/>      resources {<br/>        cpu = 200<br/>        memory = 4096<br/>      }<br/>      service {<br/>        name = "trino-coordinator"<br/>        port = "http"<br/>        check {<br/>          name = "rest-tcp"<br/>          type = "tcp"<br/>          interval = "10s"<br/>          timeout = "2s"<br/>        }<br/>      }<br/>    }<br/>  }</span></pre><p id="8f61" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Trino协调员任务将在该组中运行。该组中有四个模板。这些模板将生成Trino配置<code class="fe nq nr ns nt b">config.properties, node.properties, jvm.config</code>和Hive目录配置<code class="fe nq nr ns nt b">hive.properties</code>，它们将被安装到容器中的配置路径。在service节中，服务<code class="fe nq nr ns nt b">trino-coordinator</code>将被注册到Consul。这个<code class="fe nq nr ns nt b">trino-coordinator</code>服务将被用作查询SQL的发现路径和接口。</p><p id="d2c4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">且看第二组<code class="fe nq nr ns nt b">worker</code>小节。</p><pre class="nu nv nw nx gt ny nt nz oa aw ob bi"><span id="11c0" class="ne lj iq nt b gy oc od l oe of">  group "worker" {<br/>    count = 3<br/>    restart {<br/>      attempts = 3<br/>      delay = "30s"<br/>      interval = "5m"<br/>      mode = "fail"<br/>    }<br/>    network {<br/>      port "http" {<br/>      }<br/>    }<br/>    task "await-coordinator" {<br/>      driver = "docker"<br/>      config {<br/>        image        = "busybox:1.28"<br/>        command      = "sh"<br/>        args         = ["-c", "echo -n 'Waiting for service'; until nslookup trino-coordinator.service.consul 2&gt;&amp;1 &gt;/dev/null; do echo '.'; sleep 2; done"]<br/>        network_mode = "host"<br/>      }<br/>      resources {<br/>        cpu    = 100<br/>        memory = 128<br/>      }<br/>      lifecycle {<br/>        hook    = "prestart"<br/>        sidecar = false<br/>      }<br/>    }<br/>    task "trino-server" {<br/>      driver = "docker"<br/>      kill_timeout = "300s"<br/>      kill_signal = "SIGTERM"<br/>      template {<br/>        data = &lt;&lt;EOF<br/>coordinator=false<br/>http-server.http.port={{ env "NOMAD_HOST_PORT_http" }}<br/>query.max-memory=5GB<br/>query.max-memory-per-node=1GB<br/>query.max-total-memory-per-node=2GB<br/>query.max-stage-count=200<br/>task.writer-count=4<br/>discovery.uri=http://{{range $index, $element := service "trino-coordinator"}}{{if eq $index 0}}{{ .Address }}:{{ .Port }}{{end}}{{end}}<br/>EOF<br/>        destination = "local/config.properties"<br/>      }<br/>      template {<br/>        data = &lt;&lt;EOF<br/>node.id={{ env "NOMAD_NAMESPACE" }}-{{ env "NOMAD_JOB_NAME" }}-{{ env "NOMAD_GROUP_NAME" }}-{{ env "NOMAD_ALLOC_ID" }}<br/>node.environment=production<br/>node.data-dir=/opt/trino-server/data<br/>spiller-spill-path=/tmp<br/>max-spill-per-node=4TB<br/>query-max-spill-per-node=1TB<br/>EOF<br/>        destination = "local/node.properties"<br/>      }<br/>      template {<br/>        data = &lt;&lt;EOF<br/>-server<br/>-Xmx16G<br/>-XX:-UseBiasedLocking<br/>-XX:+UseG1GC<br/>-XX:G1HeapRegionSize=32M<br/>-XX:+ExplicitGCInvokesConcurrent<br/>-XX:+ExitOnOutOfMemoryError<br/>-XX:+HeapDumpOnOutOfMemoryError<br/>-XX:ReservedCodeCacheSize=512M<br/>-XX:PerMethodRecompilationCutoff=10000<br/>-XX:PerBytecodeRecompilationCutoff=10000<br/>-Djdk.attach.allowAttachSelf=true<br/>-Djdk.nio.maxCachedBufferSize=2000000<br/>EOF<br/>        destination = "local/jvm.config"<br/>      }<br/>      template {<br/>        data = &lt;&lt;EOF<br/>connector.name=hive-hadoop2<br/>hive.metastore.uri=thrift://{{range $index, $element := service "hive-metastore"}}{{if eq $index 0}}{{ .Address }}:{{ .Port }}{{end}}{{end}}<br/>hive.allow-drop-table=true<br/>hive.max-partitions-per-scan=1000000<br/>hive.compression-codec=NONE<br/>hive.s3.endpoint=https://nginx-test.cloudchef-labs.com<br/>hive.s3.path-style-access=true<br/>hive.s3.ssl.enabled=true<br/>hive.s3.max-connections=100<br/>hive.s3.aws-access-key=cclminio<br/>hive.s3.aws-secret-key=rhksflja!@#<br/>EOF<br/>        destination = "local/catalog/hive.properties"<br/>      }<br/>      config {<br/>        image = "mykidong/trino:356"<br/>        force_pull = false<br/>        volumes = [<br/>          "./local/config.properties:/opt/trino-server/etc/config.properties",<br/>          "./local/node.properties:/opt/trino-server/etc/node.properties",<br/>          "./local/jvm.config:/opt/trino-server/etc/jvm.config",<br/>          "./local/catalog/hive.properties:/opt/trino-server/etc/catalog/hive.properties"<br/>        ]<br/>        command = "bin/launcher"<br/>        args = [<br/>          "run"<br/>        ]<br/>        ports = [<br/>          "http"<br/>        ]<br/>        ulimit {<br/>          nofile = "131072"<br/>          nproc = "65536"<br/>        }<br/>      }<br/>      resources {<br/>        cpu = 200<br/>        memory = 4096<br/>      }<br/>      service {<br/>        name = "trino-worker"<br/>        port = "http"<br/>        check {<br/>          name = "rest-tcp"<br/>          type = "tcp"<br/>          interval = "10s"<br/>          timeout = "2s"<br/>        }<br/>      }<br/>    }<br/>  }</span></pre><p id="e1ad" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">任务<code class="fe nq nr ns nt b">await-coordinator</code>是一个预启动任务，将在任务<code class="fe nq nr ns nt b">trino-server</code>之前运行。这个<code class="fe nq nr ns nt b">await-coordinator</code>任务将等待服务<code class="fe nq nr ns nt b">trino-coordinator</code>准备就绪。三名Trino工人将在该组中运行。</p><p id="6da8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，让我们看看<code class="fe nq nr ns nt b">cli</code>这个群体。</p><pre class="nu nv nw nx gt ny nt nz oa aw ob bi"><span id="eb27" class="ne lj iq nt b gy oc od l oe of">group "cli" {<br/>  count = 1<br/>  restart {<br/>    attempts = 3<br/>    delay = "30s"<br/>    interval = "5m"<br/>    mode = "fail"<br/>  }<br/>  task "await-coordinator" {<br/>    driver = "docker"<br/>    config {<br/>      image        = "busybox:1.28"<br/>      command      = "sh"<br/>      args         = ["-c", "echo -n 'Waiting for service'; until nslookup trino-coordinator.service.consul 2&gt;&amp;1 &gt;/dev/null; do echo '.'; sleep 2; done"]<br/>      network_mode = "host"<br/>    }<br/>    resources {<br/>      cpu    = 100<br/>      memory = 128<br/>    }<br/>    lifecycle {<br/>      hook    = "prestart"<br/>      sidecar = false<br/>    }<br/>  }<br/>  task "trino-cli" {<br/>    driver = "docker"<br/>    kill_timeout = "300s"<br/>    kill_signal = "SIGTERM"<br/>    config {<br/>      image = "mykidong/trino-cli:356"<br/>      force_pull = true<br/>      command = "tail"<br/>      args = [<br/>        "-f",<br/>        "/dev/null"<br/>      ]<br/>    }<br/>    resources {<br/>      cpu = 100<br/>      memory = 256<br/>    }<br/>  }<br/>}</span></pre><p id="d49a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Trino CLI任务将在该组中运行。使用Trino CLI，您可以访问Trino集群并查询数据。</p><p id="a457" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">完整的<code class="fe nq nr ns nt b">trino.nomad</code>可以看这里:<a class="ae kc" href="https://gist.github.com/mykidong/37e22e66026a7850b6b8f65a8f6457ce" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/myki dong/37e 22 e 66026 a 7850 b 6 b 8 f 65 A8 f 6457 ce</a></p><p id="eb0d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，为trino集群创建一个名称空间。</p><pre class="nu nv nw nx gt ny nt nz oa aw ob bi"><span id="c18e" class="ne lj iq nt b gy oc od l oe of">nomad namespace apply -description "Trino Cluster" trino;</span></pre><p id="bfec" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，运行Trino nomad作业。</p><pre class="nu nv nw nx gt ny nt nz oa aw ob bi"><span id="0b7e" class="ne lj iq nt b gy oc od l oe of">nomad job run trino.nomad;</span></pre><p id="c0e0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Nomad上成功提交作业后，您将看到trino作业的状态。</p><pre class="nu nv nw nx gt ny nt nz oa aw ob bi"><span id="c887" class="ne lj iq nt b gy oc od l oe of">nomad job status -namespace trino trino<br/>...</span><span id="8e96" class="ne lj iq nt b gy og od l oe of">Allocations<br/>ID        Node ID   Task Group   Version  Desired  Status   Created    Modified<br/>81eaef50  457a8291  worker       0        run      running  2h26s ago  1h59m ago<br/>c014f467  457a8291  coordinator  0        run      running  2h26s ago  1h59m ago<br/>c1dcb51e  709ee9cc  worker       0        run      running  2h26s ago  1h59m ago<br/>cf006809  457a8291  cli          0        run      running  2h26s ago  1h59m ago<br/>d83876e0  457a8291  worker       0        run      running  2h26s ago  1h59m ago</span></pre><p id="8b06" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们现在在Nomad上运行Trino集群。</p><h1 id="35fd" class="li lj iq bd lk ll mz ln lo lp na lr ls lt nb lv lw lx nc lz ma mb nd md me mf bi translated">使用Trino CLI查询Trino中的数据</h1><p id="ec8e" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">可以用Trino CLI查询Trino中的数据。为了在Trino中查询一些数据，我将在MinIO中创建示例表。您可以使用与S3兼容的另一个对象存储来存储数据。</p><p id="770c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面的<code class="fe nq nr ns nt b">test.json</code>将被用作使用spark在MinIO中创建表格的源数据。</p><pre class="nu nv nw nx gt ny nt nz oa aw ob bi"><span id="f3eb" class="ne lj iq nt b gy oc od l oe of">{"itemId":"any-item-id0","quantity":2,"price":1000,"baseProperties":{"uid":"any-uid0","eventType":"cart-event","version":"7.0","ts":1527304486873}}<br/>{"itemId":"any-item-id0","quantity":2,"price":1000,"baseProperties":{"uid":"any-uid0","eventType":"cart-event","version":"7.0","ts":1527304486873}}<br/>{"itemId":"any-item-id0","quantity":2,"price":1000,"baseProperties":{"uid":"any-uid0","eventType":"cart-event","version":"7.0","ts":1527304486873}}<br/>{"itemId":"any-item-id0","quantity":2,"price":1000,"baseProperties":{"uid":"any-uid0","eventType":"cart-event","version":"7.0","ts":1527304486873}}<br/>{"itemId":"any-item-id0","quantity":2,"price":1000,"baseProperties":{"uid":"any-uid0","eventType":"cart-event","version":"7.0","ts":1527304486873}}<br/>{"itemId":"any-item-id0","quantity":2,"price":1000,"baseProperties":{"uid":"any-uid0","eventType":"cart-event","version":"7.0","ts":1527304486873}}<br/>{"itemId":"any-item-id0","quantity":2,"price":1000,"baseProperties":{"uid":"any-uid0","eventType":"cart-event","version":"7.0","ts":1527304486873}}<br/>{"itemId":"any-item-id0","quantity":2,"price":1000,"baseProperties":{"uid":"any-uid0","eventType":"cart-event","version":"7.0","ts":1527304486873}}</span></pre><p id="2626" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要在MinIO中创建表，请编写如下spark作业。</p><pre class="nu nv nw nx gt ny nt nz oa aw ob bi"><span id="7ff7" class="ne lj iq nt b gy oc od l oe of">...<br/>String metastoreUrl = System.<em class="oh">getProperty</em>("metastoreUrl");<br/><br/>SparkConf sparkConf = new SparkConf().setAppName("create sample table");<br/>sparkConf.setMaster("local[2]");<br/><br/>// delta lake log store for s3.<br/>sparkConf.set("spark.delta.logStore.class", "org.apache.spark.sql.delta.storage.S3SingleDriverLogStore");<br/><br/>SparkSession spark = SparkSession<br/>        .<em class="oh">builder</em>()<br/>        .config(sparkConf)<br/>        .enableHiveSupport()<br/>        .getOrCreate();<br/><br/><br/>Configuration hadoopConfiguration = spark.sparkContext().hadoopConfiguration();<br/>hadoopConfiguration.set("fs.defaultFS", "s3a://mykidong");<br/>hadoopConfiguration.set("fs.s3a.endpoint", "https://nginx-test.cloudchef-labs.com");<br/>hadoopConfiguration.set("fs.s3a.access.key", "cclminio");<br/>hadoopConfiguration.set("fs.s3a.secret.key", "rhksflja!@#");<br/>hadoopConfiguration.set("fs.s3a.path.style.access", "true");<br/>hadoopConfiguration.set("fs.s3a.impl", "org.apache.hadoop.fs.s3a.S3AFileSystem");<br/>hadoopConfiguration.set("hive.metastore.uris", "thrift://" + metastoreUrl);<br/>hadoopConfiguration.set("hive.server2.enable.doAs", "false");<br/>hadoopConfiguration.set("hive.metastore.client.socket.timeout", "1800");<br/>hadoopConfiguration.set("hive.execution.engine", "spark");<br/><br/><br/>// read json.<br/>String json = StringUtils.<em class="oh">fileToString</em>("data/test.json");<br/>String lines[] = json.split("\\r?\\n");<br/>Dataset&lt;Row&gt; df = spark.read().json(new JavaSparkContext(spark.sparkContext()).parallelize(Arrays.<em class="oh">asList</em>(lines)));<br/><br/>df.show(10);<br/><br/>// write delta.<br/>df.write().format("delta")<br/>        .option("path", "s3a://mykidong/test-delta")<br/>        .mode(SaveMode.<em class="oh">Overwrite</em>)<br/>        .save();<br/><br/>// create delta table.<br/>spark.sql("CREATE TABLE IF NOT EXISTS test_delta USING DELTA LOCATION 's3a://mykidong/test-delta'");<br/><br/>// read delta.<br/>Dataset&lt;Row&gt; delta = spark.sql("select * from test_delta");<br/><br/>delta.show(10);<br/><br/>// create persistent parquet table with external path.<br/>delta.write().format("parquet")<br/>        .option("path", "s3a://mykidong/test-parquet")<br/>        .mode(SaveMode.<em class="oh">Overwrite</em>)<br/>        .saveAsTable("test_parquet");<br/><br/>// read parquet from table.<br/>Dataset&lt;Row&gt; parquet = spark.sql("select * from test_parquet");<br/><br/>parquet.show(10);</span></pre><p id="6190" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">运行spark作业后，将在Hive Metastore中创建delta lake表和基于parquet的表。</p><p id="dbac" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们需要Trino协调器的ip地址和端口以及Trino CLI任务的分配id，以便使用Trino CLI查询Trino中的数据。</p><p id="e7ca" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">获取Trino协调器的ip地址和端口。</p><pre class="nu nv nw nx gt ny nt nz oa aw ob bi"><span id="b1f1" class="ne lj iq nt b gy oc od l oe of">cat &lt;&lt;EOF &gt; service.tpl<br/>{{range \$index, \$element := service "trino-coordinator"}}{{if eq \$index 0}}{{ .Address }}:{{ .Port }}{{end}}{{end}}<br/>EOF<br/>consul-template -template service.tpl -dry;<br/>&gt;<br/>10.0.0.200:21409</span></pre><p id="1599" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Trino协调器地址作为<code class="fe nq nr ns nt b">10.0.0.200:21409</code>返回。</p><p id="83a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们来获取Nomad上Trino CLI任务的分配id。</p><pre class="nu nv nw nx gt ny nt nz oa aw ob bi"><span id="32ce" class="ne lj iq nt b gy oc od l oe of">nomad job status -namespace trino trino;<br/>...<br/>Allocations<br/>ID        Node ID   Task Group   Version  Desired  Status   Created     Modified<br/>81eaef50  457a8291  worker       0        run      running  30m50s ago  29m50s ago<br/>c014f467  457a8291  coordinator  0        run      running  30m50s ago  30m8s ago<br/>c1dcb51e  709ee9cc  worker       0        run      running  30m50s ago  29m56s ago<br/>cf006809  457a8291  cli          0        run      running  30m50s ago  29m37s ago<br/>d83876e0  457a8291  worker       0        run      running  30m50s ago  29m52s ago</span></pre><p id="1603" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">任务组<code class="fe nq nr ns nt b">cli</code>的分配id为<code class="fe nq nr ns nt b">cf006809</code>。</p><p id="d1be" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，使用运行在Nomad上的Trino CLI运行以下命令来访问Trino中的配置单元目录。</p><pre class="nu nv nw nx gt ny nt nz oa aw ob bi"><span id="3bdf" class="ne lj iq nt b gy oc od l oe of">export ALLOC_ID=cf006809;<br/>export COORDINATOR=10.0.0.200:21409;<br/>nomad alloc exec -namespace trino -task trino-cli ${ALLOC_ID} /opt/trino-cli --server ${COORDINATOR} --catalog hive --schema default;</span></pre><p id="448a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您在Trino中查询数据，您将从Trino中得到如下结果。</p><pre class="nu nv nw nx gt ny nt nz oa aw ob bi"><span id="c54e" class="ne lj iq nt b gy oc od l oe of">...</span><span id="0bf7" class="ne lj iq nt b gy og od l oe of">trino:default&gt; show tables;<br/>    Table<br/>--------------<br/> test_delta<br/> test_parquet<br/>(2 rows)</span><span id="b2bf" class="ne lj iq nt b gy og od l oe of">Query 20210521_102401_00001_ufy36, FINISHED, 3 nodes<br/>Splits: 36 total, 36 done (100.00%)<br/>4.63 [2 rows, 56B] [0 rows/s, 12B/s]</span><span id="d8d6" class="ne lj iq nt b gy og od l oe of">trino:default&gt; select * from test_parquet;<br/>                           baseproperties                            |    itemid    | price | quantity<br/>---------------------------------------------------------------------+--------------+-------+----------<br/> {eventtype=cart-event, ts=1527304486873, uid=any-uid0, version=7.0} | any-item-id0 |  1000 |        2<br/> {eventtype=cart-event, ts=1527304486873, uid=any-uid0, version=7.0} | any-item-id0 |  1000 |        2<br/> {eventtype=cart-event, ts=1527304486873, uid=any-uid0, version=7.0} | any-item-id0 |  1000 |        2<br/> {eventtype=cart-event, ts=1527304486873, uid=any-uid0, version=7.0} | any-item-id0 |  1000 |        2<br/> {eventtype=cart-event, ts=1527304486873, uid=any-uid0, version=7.0} | any-item-id0 |  1000 |        2<br/> {eventtype=cart-event, ts=1527304486873, uid=any-uid0, version=7.0} | any-item-id0 |  1000 |        2<br/> {eventtype=cart-event, ts=1527304486873, uid=any-uid0, version=7.0} | any-item-id0 |  1000 |        2<br/> {eventtype=cart-event, ts=1527304486873, uid=any-uid0, version=7.0} | any-item-id0 |  1000 |        2<br/>(8 rows)</span><span id="c7bf" class="ne lj iq nt b gy og od l oe of">Query 20210521_102415_00003_ufy36, FINISHED, 2 nodes<br/>Splits: 18 total, 18 done (100.00%)<br/>5.13 [8 rows, 5.85KB] [1 rows/s, 1.14KB/s]</span></pre></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><p id="0ee1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就是这样。</p></div></div>    
</body>
</html>