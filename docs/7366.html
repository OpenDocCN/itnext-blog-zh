<html>
<head>
<title>Using the Azure Application gateway WAF with Istio-2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Azure应用程序网关WAF与Istio-2一起使用</h1>
<blockquote>原文：<a href="https://itnext.io/using-the-azure-application-gateway-waf-with-istio-2-eb5af5b697c6?source=collection_archive---------5-----------------------#2022-09-01">https://itnext.io/using-the-azure-application-gateway-waf-with-istio-2-eb5af5b697c6?source=collection_archive---------5-----------------------#2022-09-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="5728" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">简介和先决条件</h1><p id="f08b" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在你开始之前，我想让你浏览一下<a class="ae lj" href="https://harinderjitss.medium.com/using-application-gateway-waf-with-istio-315b907b8ed7" rel="noopener">我之前的帖子</a>关于相同的主题，在那里我用Istio使用了典型的AKS-AGIC配置。这篇文章将提供你想要达到的目标的背景，以及你为什么考虑尝试另一种方法。这种配置可以工作，但<strong class="kn ir">你无法享受到</strong> <a class="ae lj" href="https://istio.io/latest/docs/reference/config/networking/gateway/" rel="noopener ugc nofollow" target="_blank"> <strong class="kn ir"> Istio网关的特性</strong> </a> <strong class="kn ir">加上入口流量在第一次访问时直接到达pod后进入服务网格</strong>。您可以查看上一篇<a class="ae lj" rel="noopener ugc nofollow" target="_blank" href="/using-application-gateway-waf-with-istio-315b907b8ed7">帖子</a>中的“入口请求流”图来理解它。</p><h1 id="6a22" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">替代配置</h1><p id="9e2c" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kn ir">您可以避免使用应用网关入口控制器，而是使用Istio入口网关。您可以手动配置应用程序网关，使其像普通的第4层TCP负载平衡器一样工作，同时仍然利用应用程序网关的优势。您可以在“后端池”中将AKS VMSS私有IP配置为后端，并在应用网关的“后端设置”中将istio-ingress服务的端口80对应的“节点端口”配置为目标端口，以进行此配置。</strong></p><p id="1d1f" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">为此，您需要执行以下步骤:</p><h2 id="972d" class="lp jo iq bd jp lq lr dn jt ls lt dp jx kw lu lv kb la lw lx kf le ly lz kj ma bi translated">创建和配置应用程序网关</h2><ul class=""><li id="af05" class="mb mc iq kn b ko kp ks kt kw md la me le mf li mg mh mi mj bi translated">假设AKS和Istiod按照前一篇文章中<a class="ae lj" rel="noopener ugc nofollow" target="_blank" href="/using-application-gateway-waf-with-istio-315b907b8ed7">描述的设置工作。</a></li><li id="fe8c" class="mb mc iq kn b ko mk ks ml kw mm la mn le mo li mg mh mi mj bi translated">如果在AKS上启用了AGIC，请将其禁用，并删除现有的应用程序网关实例。</li><li id="a2af" class="mb mc iq kn b ko mk ks ml kw mm la mn le mo li mg mh mi mj bi translated">应用程序网关必须有不同的子网。创建并配置<a class="ae lj" href="https://docs.microsoft.com/en-us/azure/application-gateway/quick-create-portal" rel="noopener ugc nofollow" target="_blank">应用网关实例</a>，以便它使用我们在后端池的上一步中配置的AKS节点的私有IP。</li></ul><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi mp"><img src="../Images/429934ac1d2d3e6a59d66efefda6b67a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X3-n3RkHgEpQssXVMAdiow.png"/></div></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">图2后端池</figcaption></figure><ul class=""><li id="f325" class="mb mc iq kn b ko lk ks ll kw nf la ng le nh li mg mh mi mj bi translated">配置后端健康设置，以便目标端口是对应于istio-ingress名称空间中istio-ingress服务的端口80的节点端口</li></ul><pre class="mq mr ms mt gt ni nj nk nl aw nm bi"><span id="869f" class="lp jo iq nj b gy nn no l np nq">kubectl get svc istio-ingress -n istio-ingress</span></pre><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nr"><img src="../Images/708985c120c32439fd10754a90bf7065.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3RvnU2EOW8aQG-gWnL1TZg.png"/></div></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">图2后端设置</figcaption></figure><ul class=""><li id="c0f7" class="mb mc iq kn b ko lk ks ll kw nf la ng le nh li mg mh mi mj bi translated">配置一个使用您之前配置的后端池和后端设置的规则</li></ul><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi ns"><img src="../Images/71ba49644743f0abe393f0cc6c74d505.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rj0VKiddBEwt0D1-t-GFkw.png"/></div></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">图3规则</figcaption></figure><ul class=""><li id="fee9" class="mb mc iq kn b ko lk ks ll kw nf la ng le nh li mg mh mi mj bi translated">相应地配置健康探测器。</li></ul><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nt"><img src="../Images/55ccd8b65f14548c7ad3168d94e639ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-QG2nra8xJMCcTHov298mQ.png"/></div></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">图4健康探针</figcaption></figure><h2 id="43d7" class="lp jo iq bd jp lq lr dn jt ls lt dp jx kw lu lv kb la lw lx kf le ly lz kj ma bi translated">安装和配置Istio-ingress网关</h2><ul class=""><li id="6b77" class="mb mc iq kn b ko kp ks kt kw md la me le mf li mg mh mi mj bi translated">运行以下命令，使用helm安装istio gateway</li></ul><pre class="mq mr ms mt gt ni nj nk nl aw nm bi"><span id="1825" class="lp jo iq nj b gy nn no l np nq">kubectl create namespace istio-ingress<br/>kubectl label namespace istio-ingress istio-injection=enabled<br/>## helm install istio-ingress for traffic management<br/>helm install istio-ingress istio/gateway -n istio-ingress --wait</span></pre><ul class=""><li id="8c61" class="mb mc iq kn b ko lk ks ll kw nf la ng le nh li mg mh mi mj bi translated">通过执行以下命令来配置网关和虚拟服务</li></ul><figure class="mq mr ms mt gt mu"><div class="bz fp l di"><div class="nu nv l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">bookinfo-gateway-v2.yaml</figcaption></figure><pre class="mq mr ms mt gt ni nj nk nl aw nm bi"><span id="95c3" class="lp jo iq nj b gy nn no l np nq">kubectl apply -f bookinfo-gateway-v2.yaml -n appbi</span></pre><h1 id="f579" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">测试</h1><ul class=""><li id="d500" class="mb mc iq kn b ko kp ks kt kw md la me le mf li mg mh mi mj bi translated">获取应用程序网关的公共IP，并将其作为“bookinfo.app.io”添加到客户机上的hosts文件中。观察书评区显示不同的“书评”用户界面，即v1没有星星，v2有黑星，v3有红星。经常查看刷新应用程序页面时显示的UI。</li><li id="4374" class="mb mc iq kn b ko mk ks ml kw mm la mn le mo li mg mh mi mj bi translated">您可以添加故障注入(参考我的旧帖子来了解这一点),并看看它如何影响应用程序</li></ul><h1 id="ef0b" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">入口请求流</h1><p id="5301" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">下图显示了流量如何通过应用程序网关、Istio入口网关和服务于web应用程序的服务网格从客户端流向pods。</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nw"><img src="../Images/3210e17db3a728cc055b2b71f5e0a71c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OpqGtjPYscgaN2BIMJG9Zw.png"/></div></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">图5不带标签的应用程序</figcaption></figure><p id="5602" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><strong class="kn ir">观察流量通过Istio入口网关通过服务网格到达productpage应用的端点pod。</strong></p><h1 id="c5cc" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">结果呢</h1><ul class=""><li id="1a68" class="mb mc iq kn b ko kp ks kt kw md la me le mf li mg mh mi mj bi translated">将应用网关(无AGIC)与带有Istio服务网格的WAF配合使用是一种有效的配置。</li><li id="e0c6" class="mb mc iq kn b ko mk ks ml kw mm la mn le mo li mg mh mi mj bi translated">一旦到达Istio入口网关，您就可以进入Istio服务网格。</li><li id="dff1" class="mb mc iq kn b ko mk ks ml kw mm la mn le mo li mg mh mi mj bi translated">在我看来，这种配置比以前更好，因为我们也可以利用Istio网关的优势。</li><li id="cd16" class="mb mc iq kn b ko mk ks ml kw mm la mn le mo li mg mh mi mj bi translated">您使用<a class="ae lj" href="https://docs.microsoft.com/en-us/azure/web-application-firewall/ag/ag-overview" rel="noopener ugc nofollow" target="_blank">应用网关WAF </a>保护了流量。</li></ul><h2 id="d0de" class="lp jo iq bd jp lq lr dn jt ls lt dp jx kw lu lv kb la lw lx kf le ly lz kj ma bi translated">阻滞剂</h2><ul class=""><li id="fbb1" class="mb mc iq kn b ko kp ks kt kw md la me le mf li mg mh mi mj bi translated">如果您注意到bookinfo-gateway-v2.yaml、gateway.spec.servers.hosts和VirtualService.spec.hosts列表的值为“*”，而不是域名。如果设置为“bookinfo.app.io”(域名)，理想情况下应该可以，但实际上不行。您将在Istio入口网关日志中遇到类似下面的内容。</li></ul><pre class="mq mr ms mt gt ni nj nk nl aw nm bi"><span id="b29b" class="lp jo iq nj b gy nn no l np nq">[2022-09-01T21:40:23.309Z] "GET /productpage HTTP/1.1" 404 NR route_not_found - "-" 0 0 0 - "10.244.0.1" "-" "00d34de6-39fe-4b2d-ac36-7fd30f31b599" "10.224.0.5" "-" - - 10.244.0.12:80 10.244.0.1:10634 - -<br/>[2022-09-01T21:40:23.314Z] "GET /productpage HTTP/1.1" 404 NR route_not_found - "-" 0 0 0 - "10.224.0.4" "-" "87ae7407-7671-4bed-b523-0d8065ec76be" "10.224.0.5" "-" - - 10.244.0.12:80 10.224.0.4:50552 -</span></pre><ul class=""><li id="c1f1" class="mb mc iq kn b ko lk ks ll kw nf la ng le nh li mg mh mi mj bi translated">在使用Istio 101  post的<a class="ae lj" rel="noopener ugc nofollow" target="_blank" href="/traffic-management-using-istio-b49663da3e8d">流量管理中，当您将TCP负载平衡器与Istio入口网关一起使用时，您没有观察到此行为。</a></li><li id="4473" class="mb mc iq kn b ko mk ks ml kw mm la mn le mo li mg mh mi mj bi translated">不幸的是，这限制了我们使用Istio的大多数网关功能。</li></ul><h2 id="0407" class="lp jo iq bd jp lq lr dn jt ls lt dp jx kw lu lv kb la lw lx kf le ly lz kj ma bi translated">周围的工作</h2><ul class=""><li id="0757" class="mb mc iq kn b ko kp ks kt kw md la me le mf li mg mh mi mj bi translated">我在GCP测试了相同的配置，遇到了相同的问题，即每当我在gateway.spec.server.hosts中使用特定的主机名时，应用程序都无法访问。</li><li id="46ae" class="mb mc iq kn b ko mk ks ml kw mm la mn le mo li mg mh mi mj bi translated">我按照与不同拓扑相关的<a class="ae lj" href="https://istio.io/latest/docs/ops/configuration/traffic-management/network-topologies/" rel="noopener ugc nofollow" target="_blank">文档应用了建议的配置，问题仍然存在。</a></li><li id="fb0b" class="mb mc iq kn b ko mk ks ml kw mm la mn le mo li mg mh mi mj bi translated">然后我在GCP 使用了TCP(不是HTTP)作为<strong class="kn ir">健康检查类型，并且工作正常。我能够在Istio入口网关前使用<a class="ae lj" href="https://cloud.google.com/blog/products/identity-security/new-waf-capabilities-in-cloud-armor" rel="noopener ugc nofollow" target="_blank"> GCP装甲</a>和GCP HTTP负载平衡器(OSI第7层)。</strong></li><li id="028e" class="mb mc iq kn b ko mk ks ml kw mm la mn le mo li mg mh mi mj bi translated">Azure应用程序网关没有给我们设置TCP类型的健康探测器的选项，所以我创建了一个简单的nginx节点端口服务来服务nginx pod。然后，我在Health Probe(应用程序网关)中使用了nginx服务的节点端口，而不是Istio Ingress服务的节点端口。</li><li id="29ed" class="mb mc iq kn b ko mk ks ml kw mm la mn le mo li mg mh mi mj bi translated"><strong class="kn ir">因此，问题出在健康探测器上，显然Istio网关会检查每个请求的主机报头，如果不是针对网关中定义的主机之一，就会拒绝。应用网关健康探测器设置为使用AKS节点的IP，这就是为什么网关会拒绝来自健康探测器的请求，一旦健康探测器失败，就不会将来自应用网关的请求路由到Istio入口网关。现在，您可以将bookinfo-gateway-v2.yaml中的“*”替换为“bookinfo.app.io ”,应用配置并重新测试。</strong></li><li id="f679" class="mb mc iq kn b ko mk ks ml kw mm la mn le mo li mg mh mi mj bi translated">我在Gateway中对多台主机进行了进一步测试，一切正常。</li></ul></div><div class="ab cl nx ny hu nz" role="separator"><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc"/></div><div class="ij ik il im in"><p id="f9ea" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">请阅读我的其他文章，并分享您的反馈。如果你喜欢分享的内容，请点赞、评论并订阅新文章。</p></div></div>    
</body>
</html>