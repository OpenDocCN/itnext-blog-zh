<html>
<head>
<title>How to get your Kubernetes cluster service principal and use it to access other Azure services?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何获取你的Kubernetes集群服务主体，并使用它访问其他Azure服务？</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-get-your-kubernetes-cluster-service-principal-and-use-it-to-access-other-azure-services-637f185a5112?source=collection_archive---------0-----------------------#2019-09-13">https://itnext.io/how-to-get-your-kubernetes-cluster-service-principal-and-use-it-to-access-other-azure-services-637f185a5112?source=collection_archive---------0-----------------------#2019-09-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/c3fa427f3be4f8b44c7ba4bd744d378d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RyIo6zl5GEI7h8kXZ_JFEw.jpeg"/></div></div></figure><div class=""/><p id="696e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以，你在Azure上有一个<a class="ae kw" href="https://docs.microsoft.com/azure/aks/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Kubernetes集群(AKS) </a>需要访问其他Azure服务，比如<a class="ae kw" href="https://azure.microsoft.com/services/container-registry/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">Azure Container Registry(ACR)</a>？为此，您可以使用AKS群集服务主体。</p><p id="aaca" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你所需要做的就是将对所需Azure资源的访问委托给服务主体。只需使用<code class="fe kx ky kz la b"><a class="ae kw" href="https://docs.microsoft.com/cli/azure/role/assignment?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">az role assignment create</a></code>创建一个角色分配，执行以下操作:</p><ul class=""><li id="e554" class="lb lc jb ka b kb kc kf kg kj ld kn le kr lf kv lg lh li lj bi translated">指定特定范围，如资源组</li><li id="bd53" class="lb lc jb ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated">然后分配一个角色，该角色定义服务主体对资源拥有的权限</li></ul><p id="9cac" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它看起来像这样:</p><pre class="lp lq lr ls gt lt la lu lv aw lw bi"><span id="1fd5" class="lx ly jb la b gy lz ma l mb mc">az role assignment create --assignee $AKS_SERVICE_PRINCIPAL_APPID --scope $ACR_RESOURCE_ID --role $SERVICE_ROLE</span></pre><blockquote class="md me mf"><p id="ffd7" class="jy jz mg ka b kb kc kd ke kf kg kh ki mh kk kl km mi ko kp kq mj ks kt ku kv ij bi translated"><em class="jb">请注意，这里的</em> <code class="fe kx ky kz la b"><em class="jb">--assignee</em></code> <em class="jb">只不过是服务主体，您将需要它。</em></p></blockquote><p id="f1cf" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当你<a class="ae kw" href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough-portal?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">在Azure门户</a>中创建一个AKS集群，或者从Azure CLI 中使用<code class="fe kx ky kz la b"><a class="ae kw" href="https://docs.microsoft.com/cli/azure/aks?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-aks-create" rel="noopener ugc nofollow" target="_blank">az aks create</a></code>命令，Azure可以自动生成一个服务主体。或者，您可以使用<code class="fe kx ky kz la b"><a class="ae kw" href="https://docs.microsoft.com/cli/azure/ad/sp?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-ad-sp-create-for-rbac" rel="noopener ugc nofollow" target="_blank">az ad sp create-for-rbac --skip-assignment</a></code>自己创建一个，然后使用<code class="fe kx ky kz la b">--service-principal</code>中的服务主体<code class="fe kx ky kz la b">appId</code>和<code class="fe kx ky kz la b">az aks create</code>命令中的<code class="fe kx ky kz la b">--client-secret</code>(密码)参数。</p><p id="e3ea" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以在<code class="fe kx ky kz la b"><a class="ae kw" href="https://docs.microsoft.com/cli/azure/aks?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-aks-show" rel="noopener ugc nofollow" target="_blank">az aks show</a></code>命令中使用一个方便的小查询来快速定位服务主体！</p><pre class="lp lq lr ls gt lt la lu lv aw lw bi"><span id="49b6" class="lx ly jb la b gy lz ma l mb mc">az aks show --name $AKS_CLUSTER_NAME --resource-group $AKS_CLUSTER_RESOURCE_GROUP --query servicePrincipalProfile.clientId -o tsv</span></pre><p id="c175" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这将服务校长<code class="fe kx ky kz la b">appId</code>！您可以使用它来授予权限。例如，如果您希望AKS与ACR合作，您可以授予<code class="fe kx ky kz la b">acrpull</code>角色:</p><pre class="lp lq lr ls gt lt la lu lv aw lw bi"><span id="b51b" class="lx ly jb la b gy lz ma l mb mc">az role assignment create --assignee $AKS_SERVICE_PRINCIPAL_APPID --scope $ACR_RESOURCE_ID --role acrpull</span></pre><h2 id="bdd6" class="lx ly jb bd mk ml mm dn mn mo mp dp mq kj mr ms mt kn mu mv mw kr mx my mz na bi translated">以下是供您参考的命令列表:</h2><ul class=""><li id="1c4e" class="lb lc jb ka b kb nb kf nc kj nd kn ne kr nf kv lg lh li lj bi translated"><code class="fe kx ky kz la b"><a class="ae kw" href="https://docs.microsoft.com/cli/azure/aks?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-aks-create" rel="noopener ugc nofollow" target="_blank">az aks create</a></code>创建AKS集群</li><li id="a5f8" class="lb lc jb ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated"><code class="fe kx ky kz la b"><a class="ae kw" href="https://docs.microsoft.com/cli/azure/role/assignment?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">az role assignment create</a></code>将服务特定的角色分配给服务主体</li><li id="ce3d" class="lb lc jb ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated"><code class="fe kx ky kz la b"><a class="ae kw" href="https://docs.microsoft.com/cli/azure/aks?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-aks-show" rel="noopener ugc nofollow" target="_blank">az aks show</a></code>获取有关您的AKS集群的信息</li></ul><p id="e5ef" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你觉得这篇文章有帮助，请喜欢并关注！很高兴通过Twitter获得反馈或发表评论:-)</p><div class="ip iq gp gr ir ng"><a href="https://twitter.com/abhi_tweeter" rel="noopener  ugc nofollow" target="_blank"><div class="nh ab fo"><div class="ni ab nj cl cj nk"><h2 class="bd jc gy z fp nl fr fs nm fu fw ja bi translated">阿布舍克</h2><div class="nn l"><h3 class="bd b gy z fp nl fr fs nm fu fw dk translated">Abhishek的最新推文(@abhi_tweeter)。云开发者🥑@Microsoft @azureadvocates |…</h3></div><div class="no l"><p class="bd b dl z fp nl fr fs nm fu fw dk translated">twitter.com</p></div></div><div class="np l"><div class="nq l nr ns nt np nu ix ng"/></div></div></a></div></div></div>    
</body>
</html>