<html>
<head>
<title>A Perfect Match: NestJs &amp; Cloud Functions (2nd gen) &amp; Nx WorkSpace</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">完美匹配:NestJs和云功能(第二代)和Nx WorkSpace</h1>
<blockquote>原文：<a href="https://itnext.io/a-perfect-match-nestjs-cloud-functions-2nd-gen-nx-workspace-f13fb044e9a4?source=collection_archive---------0-----------------------#2022-04-01">https://itnext.io/a-perfect-match-nestjs-cloud-functions-2nd-gen-nx-workspace-f13fb044e9a4?source=collection_archive---------0-----------------------#2022-04-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/693de462e56ea9327b7a7f267363556c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rb5s1zmIwKGgmdjbOinHtQ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">梦之队(NestJS + GCP + Nx WorkSpace)</figcaption></figure><blockquote class="kf kg kh"><p id="c3f4" class="ki kj kk kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg im bi translated">注意:第二代包含在谷歌云服务条款的<a class="ae lh" href="https://cloud.google.com/terms/service-terms#1" rel="noopener ugc nofollow" target="_blank">预发布条款</a>中。请避免在产品中使用它，直到它完全发布。</p></blockquote><p id="e9c0" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated"><a class="ae lh" rel="noopener ugc nofollow" target="_blank" href="/deploy-2nd-gen-gcp-cloud-functions-with-nx-workspace-5d75fcf21566">快速浏览:部署第二代GCP云函数与Nx Workspace </a> <strong class="kl iu"> <br/> </strong> <a class="ae lh" href="https://dalenguyen.medium.com/2nd-gen-cloud-functions-local-testing-development-7c518f7bd0b1" rel="noopener">云函数本地测试&amp;开发</a> <br/> <a class="ae lh" href="https://dalenguyen.medium.com/create-rest-apis-with-express-2nd-gen-gcp-cloud-functions-d244dd9a4717" rel="noopener">创建REST APIs与Express &amp;第二代GCP云函数</a> <br/> <a class="ae lh" href="https://dalenguyen.medium.com/a-perfect-match-nestjs-cloud-functions-2nd-gen-nx-workspace-f13fb044e9a4" rel="noopener"> <strong class="kl iu">完美匹配:NestJs &amp;云函数(第二代)&amp;Nx Workspace</strong></a><strong class="kl iu"><br/></strong><a class="ae lh" href="https://dalenguyen.medium.com/gcp-cloud-functions-gen-2nd-pub-sub-development-testing-2c498fa4464e" rel="noopener">GCP云函数(第二代)发布/订阅</a></p><h2 id="c6ed" class="ll lm it bd ln lo lp dn lq lr ls dp lt li lu lv lw lj lx ly lz lk ma mb mc md bi translated">创建一个新的NestJS项目</h2><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="3272" class="ll lm it mj b gy mn mo l mp mq">npx nx g <a class="ae lh" href="http://twitter.com/nrwl/nest" rel="noopener ugc nofollow" target="_blank">@nrwl/nest</a>:application api-nest</span></pre><p id="0d1b" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">确保NestJS项目正确运行。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="01d8" class="ll lm it mj b gy mn mo l mp mq">npx nx serve api-nest</span></pre><figure class="me mf mg mh gt ju gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/ace9b3539334c61be3e36af59b4e9ed0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/format:webp/1*rn3B7Yw1uHT04OnqbqRy-A.png"/></div></figure><h2 id="9b20" class="ll lm it bd ln lo lp dn lq lr ls dp lt li lu lv lw lj lx ly lz lk ma mb mc md bi translated">添加对云功能的支持(第二代)</h2><p id="7bad" class="pw-post-body-paragraph ki kj it kl b km ms ko kp kq mt ks kt li mu kw kx lj mv la lb lk mw le lf lg im bi translated">为了将NestJS应用集成到无服务器云函数中，我们需要创建一个包装器Express函数，并将其传递给<code class="fe mx my mz mj b">functions-framework</code></p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="492f" class="ll lm it mj b gy mn mo l mp mq">// main.ts</span><span id="026c" class="ll lm it mj b gy na mo l mp mq">const server = express()</span><span id="aacd" class="ll lm it mj b gy na mo l mp mq">import { http } from '@google-cloud/functions-framework'</span><span id="adde" class="ll lm it mj b gy na mo l mp mq">export const createNestServer = async (expressInstance) =&gt; {<br/>  const app = await NestFactory.create(AppModule, new ExpressAdapter(expressInstance))</span><span id="e3a4" class="ll lm it mj b gy na mo l mp mq">const globalPrefix = 'api'<br/>  app.setGlobalPrefix(globalPrefix)<br/>  app.enableCors()</span><span id="3858" class="ll lm it mj b gy na mo l mp mq">return app.init()<br/>}</span><span id="3fb8" class="ll lm it mj b gy na mo l mp mq">createNestServer(server)<br/>  .then((v) =&gt; {<br/>    if (environment.production) {<br/>      Logger.log('🚀 Starting production server...')<br/>    } else {<br/>      Logger.log(`🚀 Starting development server on <a class="ae lh" href="http://localhost:${process.env.PORT" rel="noopener ugc nofollow" target="_blank">http://localhost:${process.env.PORT</a> || 3333}`)<br/>      v.listen(process.env.PORT || 3333)<br/>    }<br/>  })<br/>  .catch((err) =&gt; Logger.error('Nest broken', err))</span><span id="c976" class="ll lm it mj b gy na mo l mp mq"><strong class="mj iu">http('apiNEST', server)</strong></span></pre><p id="a626" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">我发现本地开发非常方便，只需一个命令就可以在本地提供应用程序。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="921d" class="ll lm it mj b gy mn mo l mp mq">npx nx serve api-nest</span></pre><p id="0ce8" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">还记得你开发Firebase云功能的时候，要有两个分别运行watch &amp; serve app的终端吗？现在已经不是这样了。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="d75f" class="ll lm it mj b gy mn mo l mp mq">dale:dalenguyen.github.io dalenguyen$ npx nx serve api-nest</span><span id="3d2c" class="ll lm it mj b gy na mo l mp mq">&gt; nx run api-nest:serve</span><span id="6aa0" class="ll lm it mj b gy na mo l mp mq">chunk (runtime: main) index.js (main) 4.15 KiB [entry] [rendered]<br/>webpack compiled successfully (62dc22cb30f1fb81)<br/>Debugger listening on ws://localhost:9229/4361ab8a-b560-4409-b445-922c55fe3d8b<br/>Debugger listening on ws://localhost:9229/4361ab8a-b560-4409-b445-922c55fe3d8b<br/>For help, see: <a class="ae lh" href="https://nodejs.org/en/docs/inspector" rel="noopener ugc nofollow" target="_blank">https://nodejs.org/en/docs/inspector</a><br/>[Nest] 13168   - 04/01/2022, 10:14:12 AM   [NestFactory] Starting Nest application...<br/>[Nest] 13168   - 04/01/2022, 10:14:12 AM   [InstanceLoader] AppModule dependencies initialized +50ms<br/>[Nest] 13168   - 04/01/2022, 10:14:12 AM   [RoutesResolver] AppController {/api}: +5ms<br/>[Nest] 13168   - 04/01/2022, 10:14:12 AM   [RouterExplorer] Mapped {/api, GET} route +2ms<br/>[Nest] 13168   - 04/01/2022, 10:14:12 AM   [NestApplication] Nest application successfully started +1ms<br/>[Nest] 13168   - 04/01/2022, 10:14:12 AM   🚀 Starting development server on <a class="ae lh" href="http://localhost:3333" rel="noopener ugc nofollow" target="_blank">http://localhost:3333</a> +0ms</span></pre><figure class="me mf mg mh gt ju gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/12b914d4f13cfd47cdb94287cac2d51e.png" data-original-src="https://miro.medium.com/v2/resize:fit:662/format:webp/1*b_V8T2H8IdMw1bccspAJiw.png"/></div></figure><h2 id="83d4" class="ll lm it bd ln lo lp dn lq lr ls dp lt li lu lv lw lj lx ly lz lk ma mb mc md bi translated">部署NestJS和云功能</h2><p id="1e15" class="pw-post-body-paragraph ki kj it kl b km ms ko kp kq mt ks kt li mu kw kx lj mv la lb lk mw le lf lg im bi translated">为了支持部署，我们必须在project.json中做一些调整。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="82cc" class="ll lm it mj b gy mn mo l mp mq">// project.json</span><span id="2b81" class="ll lm it mj b gy na mo l mp mq">// change the compiled file &amp; expose package.json</span><span id="7f43" class="ll lm it mj b gy na mo l mp mq">"options": {<br/>    "outputPath": "dist/apps/api-nest",<br/>    "main": "apps/api-nest/src/main.ts",<br/>    "tsConfig": "apps/api-nest/tsconfig.app.json",<br/>    "assets": ["apps/api-nest/src/assets"],<br/><strong class="mj iu">    "externalDependencies": "all",<br/>    "outputFileName": "index.js",<br/>    "generatePackageJson": true</strong><br/>  },</span><span id="6342" class="ll lm it mj b gy na mo l mp mq">// add deployment script for cloud functions</span><span id="5dad" class="ll lm it mj b gy na mo l mp mq">"deploy": {<br/>    "executor": "<a class="ae lh" href="http://twitter.com/nrwl/workspace" rel="noopener ugc nofollow" target="_blank">@nrwl/workspace</a>:run-commands",<br/>    "options": {<br/>      "commands": [<br/><strong class="mj iu">        "gcloud beta functions deploy api-nest --region us-central1 --gen2 --runtime nodejs16 --trigger-http --entry-point apiNEST --source ./dist/apps/api-nest --allow-unauthenticated --project {args.gcpProject}"</strong><br/>      ],<br/>      "color": true,<br/>      "parallel": false<br/>    }<br/>  }</span></pre><p id="ffe3" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">完成调整之后，在部署之前，我们需要构建它。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="aae1" class="ll lm it mj b gy mn mo l mp mq">// make sure that you have production, in order to update the environment file for production</span><span id="98d2" class="ll lm it mj b gy na mo l mp mq">yarn nx build api-nest <strong class="mj iu">--configuration production</strong></span></pre><p id="173e" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">然后，您可以运行到GCP的部署</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="e22d" class="ll lm it mj b gy mn mo l mp mq">dale:dalenguyen.github.io dalenguyen$ <strong class="mj iu">npx nx deploy api-nest --gcpProject your-project</strong></span><span id="da5e" class="ll lm it mj b gy na mo l mp mq">&gt; nx run api-nest:deploy --gcpProject=your-project</span><span id="30c7" class="ll lm it mj b gy na mo l mp mq">Preparing function...<br/><br/>serviceAccountEmail: <a class="ae lh" href="mailto:150192836944-compute@developer.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">000-compute@developer.gserviceaccount.com</a><br/>timeoutSeconds: 60<br/>uri: <a class="ae lh" href="https://api-nest-eyoojzj54q-uc.a.run.app" rel="noopener ugc nofollow" target="_blank">https://api-nest-000-uc.a.run.app</a><br/>state: ACTIVE<br/>updateTime: '2022-04-01T13:56:42.849632548Z'</span><span id="6699" class="ll lm it mj b gy na mo l mp mq">——————————————————————————————————————————————————————————————————</span><span id="b53d" class="ll lm it mj b gy na mo l mp mq">&gt;  NX   Successfully ran target deploy for project api-nest</span></pre><p id="a421" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">之后，你的NestJS云函数(第二代)就可以使用了<a class="ae lh" href="https://emojipedia.org/party-popper/" rel="noopener ugc nofollow" target="_blank">🎉</a></p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/afb1f7dff0593e31cb49c6848fe18706.png" data-original-src="https://miro.medium.com/v2/resize:fit:884/format:webp/1*C-eswlcTy-VVwzjOUBtdNA.png"/></div></figure></div></div>    
</body>
</html>