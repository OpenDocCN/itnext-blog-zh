<html>
<head>
<title>The concept of “Monitoring Tests”</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">“监控测试”的概念</h1>
<blockquote>原文：<a href="https://itnext.io/the-concept-of-monitoring-tests-d7cb5af514e5?source=collection_archive---------7-----------------------#2019-07-30">https://itnext.io/the-concept-of-monitoring-tests-d7cb5af514e5?source=collection_archive---------7-----------------------#2019-07-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="aea4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">小E2E测试检查很少(但至关重要)的技术细节。阅读此处或<a class="ae kl" href="https://dev.to/noriste/the-concept-of-monitoring-tests-4l5j" rel="noopener ugc nofollow" target="_blank">dev .</a>上的内容。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/a5d11c3408009f63fd0cf913bc49f7a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nk_T9eZ441HVkDrIbycQFQ.jpeg"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">由<a class="ae kl" href="https://unsplash.com/@brain1966?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Rainer Bleek </a>在<a class="ae kl" href="https://unsplash.com/?source=post_page---------------------------" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="5103" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我正在GitHub上做一个大的<a class="ae kl" href="https://github.com/NoriSte/ui-testing-best-practices?source=post_page---------------------------" rel="noopener ugc nofollow" target="_blank"> UI测试最佳实践</a>项目，我分享这个帖子来传播它并有直接的反馈。</p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><p id="1f50" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">几个月前，我在基于《盖茨比》的business.conio.com网站工作。除了分享一些我写的插件之外，我想尽可能地提高网站的性能。幸运的是，盖茨比在谈到性能时表现突出，但你知道，这永远不够。</p><p id="74df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我推了推科诺的DevOps👋)尽可能地利用AWS/S3的能力，为网站用户提供<a class="ae kl" href="https://www.wikiwand.com/en/Brotli" rel="noopener ugc nofollow" target="_blank"> Brotli </a>压缩的和永久缓存的静态资产。结果是一个超高性能的产品，但道路并不容易，因为由于铲斗配置，有时<strong class="jp ir"> Brotli压缩被打破</strong>。</p><p id="596d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个错误很微妙，因为该网站使用了大量JavaScript特性。网站<strong class="jp ir">看起来</strong>可以工作，但是如果压缩设置不正确，联系表单就不会工作。错误的症状只是控制台中显示的一个错误。</p><p id="4338" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种错误很容易用检查表单是否工作的E2E测试识别出来(显然是从用户的角度来看)，但是我不能依赖这样的测试，因为测试套件非常慢。毕竟，每个E2E测试都很慢。<br/>更多:DevOps需要频繁的反馈，他改变了S3配置很多次，在几秒钟内<strong class="jp ir">而不是几分钟内</strong>收到反馈会很好。</p><p id="3a5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为检查非常简单，而且我讨厌手工测试，所以我写了一个简单的测试来检查Brotli压缩。我使用了<a class="ae kl" href="https://www.cypress.io" rel="noopener ugc nofollow" target="_blank"> Cypress </a>，并编写了如下测试</p><pre class="kn ko kp kq gt lj lk ll lm aw ln bi"><span id="46ef" class="lo lp iq lk b gy lq lr l ls lt">// extract the main JS file from the source code of the page. I removed the regex matching part<br/>const getMainJsUrl = pageSource =&gt; "/app-&lt;example-hash&gt;.js"</span><span id="a875" class="lo lp iq lk b gy lu lr l ls lt">context("The Brotli-compressed assets should be served with the correct content encoding", () <em class="lv">=&gt;</em> {<br/>  <em class="lv">const</em> test = <em class="lv">url</em> <em class="lv">=&gt;</em> {<br/>   cy.request(url)<br/>    .its("body")<br/>    .then(getMainJsUrl) // retrieves the app.js URL<br/>    .then(<em class="lv">appUrl</em> <em class="lv">=&gt;</em> cy.request({url: url + appUrl, headers: {"Accept-Encoding": "br"}})<br/>    .its("headers.content-encoding")<br/>    .should("equal", "br"))<br/>  }</span><span id="808e" class="lo lp iq lk b gy lu lr l ls lt">  it("staging", () <em class="lv">=&gt;</em> test(urls.staging))<br/>  it("production", () <em class="lv">=&gt;</em> test(urls.production))<br/>})</span></pre><p id="db4d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦写好，我可以提供一个专门的脚本，只启动这个测试(排除所有标准的E2E测试)。Et voilà:我可以通过一个超快速的测试来持续监控Brotli压缩！</p><p id="5232" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">缓存管理呢？我们也遇到了一些麻烦，我添加了一些专门的测试</p><pre class="kn ko kp kq gt lj lk ll lm aw ln bi"><span id="7e85" class="lo lp iq lk b gy lq lr l ls lt">const shouldNotBeCached = (xhr) =&gt; cy.wrap(xhr)<br/>  .its("headers.cache-control")<br/>  .should("equal", "public,max-age=0,must-revalidate")</span><span id="2b52" class="lo lp iq lk b gy lu lr l ls lt">const shouldBeCached = (xhr) =&gt; cy.wrap(xhr)<br/>  .its("headers.cache-control")<br/>  .should("equal", "public,max-age=31536000,immutable")</span><span id="65ab" class="lo lp iq lk b gy lu lr l ls lt">context('Site monitoring', () =&gt; {<br/>  context('The HTML should not be cached', () =&gt; {<br/>    const test = url =&gt;<br/>      cy.request(url)<br/>        .then(shouldNotBeCached)<br/><br/>    it("staging", () =&gt; test(urls.staging))<br/>    it("production", () =&gt; test(urls.production))<br/>  })<br/><br/>  context('The static assets should be cached', () =&gt; {<br/>    const test = url =&gt;<br/>      cy.request(url)<br/>        .its("body")<br/>        .then(getMainJsUrl)<br/>        .then(appUrl =&gt; url+appUrl)<br/>        .then(cy.request)<br/>        .then(shouldBeCached)<br/><br/>    it('staging', () =&gt; test(urls.staging))<br/>    it('production', () =&gt; test(urls.production))<br/>  })<br/>}</span></pre><p id="29a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我喜欢这些小测试，因为在几秒钟内，它们就能检查出对用户体验至关重要的东西。我可以睡得很好，我们<strong class="jp ir">永远</strong>免受这些问题<strong class="jp ir"/>。</p><h1 id="0926" class="lw lp iq bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">监控测试还能检查什么？</h1><p id="4a6f" class="pw-post-body-paragraph jn jo iq jp b jq mt js jt ju mu jw jx jy mv ka kb kc mw ke kf kg mx ki kj kk ij bi translated">用Gatsby配置(针对不同的环境有许多条件和定制)制造混乱太容易了。第一个，也是最关键的，需要监控的东西是最简单的:robots.txt和sitemap.xml文件。</p><p id="5372" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lv"> robots.txt </em>文件必须禁止暂存站点抓取并允许生产站点抓取:</p><pre class="kn ko kp kq gt lj lk ll lm aw ln bi"><span id="7127" class="lo lp iq lk b gy lq lr l ls lt">context('The robots.txt file should disallow the crawling of the staging site and allow the production one', () <em class="lv">=&gt;</em> {<br/>  <em class="lv">const</em> test = (<em class="lv">url</em>, <em class="lv">content</em>) <em class="lv">=&gt;<br/>    </em>cy.request(`${url}/robots.txt`)<br/>      .its("body")<br/>      .should("contain", content)</span><span id="927f" class="lo lp iq lk b gy lu lr l ls lt">  it('staging', () <em class="lv">=&gt;</em> test(urls.staging, "Disallow: /"))<br/>  it('production', () <em class="lv">=&gt;</em> test(urls.production, "Allow: /"))<br/>})</span></pre><p id="5ef3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与静态资产一样，sitemap.xml文件不能被缓存:</p><pre class="kn ko kp kq gt lj lk ll lm aw ln bi"><span id="260c" class="lo lp iq lk b gy lq lr l ls lt">context('The sitemap.xml should not be cached', () <em class="lv">=&gt;</em> {<br/>  <em class="lv">const</em> test = <em class="lv">url</em> <em class="lv">=&gt;<br/>    </em>cy.request(`${url}/sitemap.xml`)<br/>      .then(shouldNotBeCached)</span><span id="9ba7" class="lo lp iq lk b gy lu lr l ls lt">  it('staging', () <em class="lv">=&gt;</em> test(urls.staging))<br/>  it('production', () <em class="lv">=&gt;</em> test(urls.production))<br/>})</span></pre><p id="f4a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于一个错误的构建过程而出现的错误，我又编写了一个监控测试:有时除了主页之外，所有页面都包含404页面的相同内容。测试如下:</p><pre class="kn ko kp kq gt lj lk ll lm aw ln bi"><span id="f604" class="lo lp iq lk b gy lq lr l ls lt">context('An internal page should not contain the same content of the 404 page', () <em class="lv">=&gt;</em> {<br/>  <em class="lv">const</em> pageNotFoundContent = "Page not found"<br/>  <em class="lv">const</em> test = <em class="lv">url</em> <em class="lv">=&gt;</em> {<br/>    cy.request(`${url}/not-found-page`)<br/>      .its("body")<br/>      .should("contain", pageNotFoundContent)<br/>    cy.request(`${url}/about`)<br/>      .its("body")<br/>      .should("not.contain", pageNotFoundContent)<br/>  }</span><span id="0b91" class="lo lp iq lk b gy lu lr l ls lt">  it('staging', () <em class="lv">=&gt;</em> test(urls.staging))<br/>  it('production', () <em class="lv">=&gt;</em> test(urls.production))<br/>})</span></pre><h1 id="8c59" class="lw lp iq bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">运行它们</h1><p id="4c01" class="pw-post-body-paragraph jn jo iq jp b jq mt js jt ju mu jw jx jy mv ka kb kc mw ke kf kg mx ki kj kk ij bi translated">我用<a class="ae kl" href="https://www.cypress.io" rel="noopener ugc nofollow" target="_blank"> Cypress </a>编写了测试并运行它们——如果你将文件命名为<em class="lv"> xxx，那么运行起来会非常简单。</em> <strong class="jp ir"> <em class="lv">监控</em> </strong> <em class="lv"> .test.js: </em></p><pre class="kn ko kp kq gt lj lk ll lm aw ln bi"><span id="ea20" class="lo lp iq lk b gy lq lr l ls lt">cypress run — spec \"cypress/integration/**/*.<strong class="lk ir">monitoring</strong>.*\"</span></pre><h1 id="d6fe" class="lw lp iq bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">为什么把它们和标准的E2E测试分开？</h1><p id="db3b" class="pw-post-body-paragraph jn jo iq jp b jq mt js jt ju mu jw jx jy mv ka kb kc mw ke kf kg mx ki kj kk ij bi translated">嗯，因为:</p><ul class=""><li id="1c56" class="my mz iq jp b jq jr ju jv jy na kc nb kg nc kk nd ne nf ng bi translated">监控测试不是从用户的角度编写的，E2E测试是。但是对于E2E测试，我可能会有一个“联系人表单应该工作”的失败测试，而对于监控测试，我可能会有一个“brotli压缩应该工作”的失败测试(越来越有用)。我总是更喜欢面向用户的测试，但是，当某些东西经常失败时，我希望保持检查</li><li id="8b2c" class="my mz iq jp b jq nh ju ni jy nj kc nk kg nl kk nd ne nf ng bi translated">监控测试不贵，E2E测试不贵:E2E测试非常慢，它们会堵塞你的管道队列，而且基于你如何实施它们，它们会影响你的分析。这就是为什么我通常不对<code class="fe nm nn no lk b">production</code>环境运行它们，而只对<code class="fe nm nn no lk b">staging</code>环境运行它们。监控测试在两种环境下运行，没有缺点</li></ul><p id="a643" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在我的这个要点中找到所有的测试</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="991c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你有更多的想法或问题，请留下评论👍</p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><p id="ce7b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你好👋我是Stefano Magni，我是一名热情的JavaScript开发人员和T2赛普拉斯大使。<br/>我喜欢创造高质量的产品，测试和自动化一切，学习和分享我的知识，帮助别人，在会议上发言和面对新的挑战。<br/>我在意大利比特币初创公司<a class="ae kl" href="https://conio.com/it/?source=post_page---------------------------" rel="noopener ugc nofollow" target="_blank"> Conio </a>工作。<br/>你可以在<a class="ae kl" href="https://twitter.com/NoriSte?source=post_page---------------------------" rel="noopener ugc nofollow" target="_blank"> Twitter </a>、<a class="ae kl" href="https://github.com/NoriSte?source=post_page---------------------------" rel="noopener ugc nofollow" target="_blank"> GitHub </a>、<a class="ae kl" href="https://www.linkedin.com/in/noriste/?source=post_page---------------------------" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上找到我。你可以找到我最近所有的文章/演讲等等。这里。</p></div></div>    
</body>
</html>