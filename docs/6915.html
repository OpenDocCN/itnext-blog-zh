<html>
<head>
<title>Setting up Scalr with Azure DevOps — how to execute your Terraform code and create a workspace</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure DevOps设置Scalr如何执行Terraform代码并创建工作空间</h1>
<blockquote>原文：<a href="https://itnext.io/setting-up-scalr-with-azure-devops-how-to-execute-your-terraform-code-and-create-a-workspace-6b54fa686fd3?source=collection_archive---------4-----------------------#2022-04-11">https://itnext.io/setting-up-scalr-with-azure-devops-how-to-execute-your-terraform-code-and-create-a-workspace-6b54fa686fd3?source=collection_archive---------4-----------------------#2022-04-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="4b04" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要开始在Azure DevOps中使用Scalr，需要经历3个初始阶段。在这一系列3篇关于使用Scalr和Azure DevOps的文章中，我将一步一步地介绍每个阶段。</p><p id="a9a4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是该系列的第三篇也是最后一篇文章，将重点关注如何使用PR automation和通过将CLI插入Azure DevOps来执行Terraform代码和创建工作空间。注意，还有第三种方法可以使用模块注册表来创建工作区，但是这仍然使用VCS连接。</p><p id="1592" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">如果你错过了这个系列的第一篇文章，</strong> <a class="ae ko" rel="noopener ugc nofollow" target="_blank" href="/setting-up-scalr-with-azure-devops-picking-a-workflow-d91124a4748c"> <strong class="js iu">在这里查看一下</strong></a><strong class="js iu">——挑选一个工作流程。</strong></p><p id="4b0b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">和这里的</strong> <a class="ae ko" rel="noopener ugc nofollow" target="_blank" href="/setting-up-scalr-with-azure-devops-add-azure-credentials-979ddc17d90d"> <strong class="js iu">第二篇</strong> </a> <strong class="js iu"> —如何添加Azure凭证并链接到环境。</strong></p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/098468f3dede67997b31f0e3d47b3d88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3wzkUvvtbqEKQtDi.png"/></div></div></figure><h1 id="f908" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">执行Terraform代码并创建工作空间</h1><h2 id="6bbf" class="lz lc it bd ld ma mb dn lh mc md dp ll kb me mf lp kf mg mh lt kj mi mj lx mk bi translated">现有环境</h2><p id="fa85" class="pw-post-body-paragraph jq jr it js b jt ml jv jw jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn im bi translated">在前两篇文章中，我们将Azure DevOps实例和Azure订阅链接到我们的Scalr环境。让我们探索一下当前的环境设置！</p><p id="9db1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">选择提供商凭据将显示我们链接的Azure帐户。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/30f089ba961a58c6eb9fa41b0045cc27.png" data-original-src="https://miro.medium.com/v2/resize:fit:954/format:webp/1*3oy9wU-6vDdKVekehcwg4Q.png"/></div></figure><p id="b911" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">选择“VCS ”,我们看到我们的Azure DevOps项目已链接。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi mr"><img src="../Images/ddac3e6bee658789add5dabcaf6614b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hQkzv-XEW1DjdxKC4kpjiA.png"/></div></div></figure><p id="8383" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">选择变量将显示从之前设置的云凭据继承的变量。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ms"><img src="../Images/86a4db0109c6ed1ae5cd2f3bd90d8bc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*irOZS8jNR1IlU_QgFdRaLg.png"/></div></div></figure><h2 id="b046" class="lz lc it bd ld ma mb dn lh mc md dp ll kb me mf lp kf mg mh lt kj mi mj lx mk bi translated">Terraform代码示例</h2><p id="f5f6" class="pw-post-body-paragraph jq jr it js b jt ml jv jw jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn im bi translated">我的Github页面上包含的Terraform代码包含了向Azure Active Directory添加一些组的配置文件。如果你想继续学习，可以在这里下载！欢迎在GitHub上关注我！</p><div class="mt mu gp gr mv mw"><a href="https://github.com/jackwesleyroper/az-ad-group-module" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">GitHub-jackwesleyroper/az-ad-组-模块</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">github.com</p></div></div><div class="nf l"><div class="ng l nh ni nj nf nk kz mw"/></div></div></a></div><h2 id="0633" class="lz lc it bd ld ma mb dn lh mc md dp ll kb me mf lp kf mg mh lt kj mi mj lx mk bi translated">创建VCS集成工作区</h2><p id="c79e" class="pw-post-body-paragraph jq jr it js b jt ml jv jw jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn im bi translated">下一步是创建一个<strong class="js iu">工作空间</strong>。工作区是存储和管理与Terraform托管资源相关的所有对象的地方。</p><ol class=""><li id="2ef8" class="nl nm it js b jt ju jx jy kb nn kf no kj np kn nq nr ns nt bi translated">在环境中，选择“创建工作区”按钮。</li></ol><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/c1b817227c7140ab67dd03ff552ed16b.png" data-original-src="https://miro.medium.com/v2/resize:fit:824/format:webp/1*wYVL70lhqdNPSEf20Kbq5g.png"/></div></figure><p id="5681" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2.我们将创建一个链接到我们的Azure DevOps VCS提供商的工作区。从下拉列表中选择它，选择保存代码的适当回购和分支机构。您可以在此指定Terraform版本，并在terraform计划运行成功时自动应用更改(如果需要)。</p><p id="c60c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">启用VCS驱动的试运行使Scalr能够在检测到针对分支打开的拉请求时自动开始试运行。</p><p id="4fbe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Terraform目录设置了Terraform实际运行和执行命令的位置。它是一个相对路径，必须是存储库顶层的子目录，或者是子目录(如果指定)的子目录。</p><p id="feb6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">也可以只在某些子目录上触发运行，要启用此选项，需要设置工作目录。</p><p id="202d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，自定义挂钩选项可用于在Terraform工作流程的不同阶段调用自定义操作。这些可以在计划阶段之前或之后设置，也可以在应用阶段之前或之后设置。</p><p id="6579" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">例如，定制脚本或API调用可以在应用阶段之后执行，或者<code class="fe nv nw nx ny b">terraform validate</code>命令可以在计划阶段之前执行。我将把<code class="fe nv nw nx ny b">terraform fmt --check</code>命令添加到我的工作流中，以验证我的代码的格式是一致的。甚至可以使用<code class="fe nv nw nx ny b">wget</code>在这里下载脚本，或者使用<code class="fe nv nw nx ny b">curl</code>运行测试。相当酷！</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi nz"><img src="../Images/c6714cebe53476589fb764285447b8f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PAaWXKYdCOiUkifp-0hs7Q.png"/></div></div></figure><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi oa"><img src="../Images/450b2f5a2cc783cef5362d1d574582b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XJ5LeUnM2hqEbqx85Ozigg.png"/></div></div></figure><p id="31b2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3.填写完所有选项后，按创建。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ob"><img src="../Images/2e97b797e7560a45a7495d329f0b6709.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YWGDh-20QaFWMFTWhaAfEg.png"/></div></div></figure><p id="d045" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请注意，我们现在需要设置一些变量。Scalr检测Terraform代码中哪些变量是需要设置的(那些没有值的)，并将自动创建它们。变量可以在Terraform代码或Scalr UI中设置。对于我的例子，我需要填写ad_group_names变量。</p><blockquote class="oc od oe"><p id="7b1f" class="jq jr of js b jt ju jv jw jx jy jz ka og kc kd ke oh kg kh ki oi kk kl km kn im bi translated">如果本地工作空间包含任何<code class="fe nv nw nx ny b">*.auto.tfvars</code>文件，这些文件将提供Terraform将自动使用的默认变量值。如果<code class="fe nv nw nx ny b">*.auto.tfvars</code>文件中的变量与工作空间中指定的变量同名，将使用预定义的工作空间值。对于地图变量，<code class="fe nv nw nx ny b">*.auto.tfvars</code>中的值与工作空间中相同命名变量的值合并。</p></blockquote><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi oj"><img src="../Images/ccde7a110dd3e7d2fbd755561172b959.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rOsV_pLcTFQILdPl9blFmg.png"/></div></div></figure><p id="7a65" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您的Terraform配置需要使用Shell变量，也可以在这里添加。请注意，我们之前用来为Azure订阅设置云凭据的变量是自动继承的。</p><blockquote class="oc od oe"><p id="3612" class="jq jr of js b jt ju jv jw jx jy jz ka og kc kd ke oh kg kh ki oi kk kl km kn im bi translated">如果Terraform配置使用外壳变量(<code class="fe nv nw nx ny b">export var=value</code>)，例如用于凭证或使用<code class="fe nv nw nx ny b">TF_VAR_{variable_name}={value}</code> (-parallelism，-var-file等)设置Terraform输入变量的值。</p><p id="065d" class="jq jr of js b jt ju jv jw jx jy jz ka og kc kd ke oh kg kh ki oi kk kl km kn im bi translated">Shell变量可以在Scalr中的所有级别设置，并由较低级别继承。对多个工作区或环境中需要的shell变量使用环境或帐户级别。将工作空间级别用于特定于单个Terraform配置的外壳变量。</p><p id="7aa7" class="jq jr of js b jt ju jv jw jx jy jz ka og kc kd ke oh kg kh ki oi kk kl km kn im bi translated">还可以使用Scalr provider从一个工作区中提取输出，并将其作为环境或account shell变量发布，以便其他所有工作区都能轻松使用。</p></blockquote><h2 id="6a29" class="lz lc it bd ld ma mb dn lh mc md dp ll kb me mf lp kf mg mh lt kj mi mj lx mk bi translated">执行地形代码</h2><p id="7d87" class="pw-post-body-paragraph jq jr it js b jt ml jv jw jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn im bi translated">现在一切就绪，我们可以继续运行代码了。</p><p id="57a1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">导航至运行-&gt;队列运行，输入运行原因，然后点击队列运行。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/e56adcb494f39b0e9b439d8151fe0881.png" data-original-src="https://miro.medium.com/v2/resize:fit:276/format:webp/1*2QEWgNMRq5eOy-z8JCQrlQ.png"/></div></figure><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/eb1901a8741be79d88bead4f879b3e9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:664/format:webp/1*Am6dZ7j2bhnMJrLEMWA2UQ.png"/></div></figure><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi om"><img src="../Images/ffd2bbe1ca8a80a2fb4ed975f53cdbb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/1*Glebx7KF2dPnKD2_AtHwyA.png"/></div></div></figure><p id="a0ca" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我的第一次跑步出错了！我之前设置的自定义挂钩检测到我的代码格式不正确，并以错误代码3退出。如果配置被格式化，我使用的检查选项以代码0退出。</p><blockquote class="oc od oe"><p id="fa63" class="jq jr of js b jt ju jv jw jx jy jz ka og kc kd ke oh kg kh ki oi kk kl km kn im bi translated">-check检查输入是否格式化。如果所有的<br/>输入被正确格式化，退出状态将为0，否则为非零。</p></blockquote><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi on"><img src="../Images/ed3125c184e8bba5dca497eca3896fe7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uAyENOKAyBLWF45RYTh9VQ.png"/></div></div></figure><p id="ccf0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在Azure DevOps上，我还注意到我的repo上有一条错误消息:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/b4aae26bd42749168b1ca51510ea33ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:210/format:webp/1*b3q2etCa4jDhTCZhWyIvJg.png"/></div></figure><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi op"><img src="../Images/058f30c33298b2a79ae116e8f63e4626.png" data-original-src="https://miro.medium.com/v2/resize:fit:706/format:webp/1*qm76f0GNcFZlsW5LCKzCeg.png"/></div></figure><p id="441c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我在我的代码上运行了<code class="fe nv nw nx ny b">terraform fmt</code>并执行了运行。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/279a36369c43527363316c32805ee1ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:666/format:webp/1*JdfHlaRRlcqaJwB1aBDlKA.png"/></div></figure><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi or"><img src="../Images/ada8bc8ad9a795d6b7c8c33c276780cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:846/format:webp/1*6iBVlX2l3EtBJD7foq1Gvw.png"/></div></figure><p id="795e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">运行确认了我的3个组将在AzureAD中创建，并且配置格式正确。在Azure DevOps，我可以看到正在进行的计划:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi os"><img src="../Images/5712555b8b791e62aaa56db838e28964.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*-IV5ojdu3oR_lLCNWYXL8g.png"/></div></div></figure><p id="30a4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">显示“需要确认”警告，在运行屏幕的底部，我点击“批准”</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/6fa66a31dc461f761d3b15163e13806a.png" data-original-src="https://miro.medium.com/v2/resize:fit:632/format:webp/1*Lo9YE7m8zFUsh3uYl1DYMg.png"/></div></figure><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/ddea72f44ca3c64ffef645fa1588a446.png" data-original-src="https://miro.medium.com/v2/resize:fit:1226/format:webp/1*1-o7W8Rkco_bgnTxU320Wg.png"/></div></figure><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ov"><img src="../Images/976e6f79bb3e5277a724f66bd135564c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8B62y6awWXS7HZ6Z-uifbg.png"/></div></div></figure><p id="1eec" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请注意，存储库链接和提交链接会将您带到Azure DevOps中的适当位置。</p><p id="a7f6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">工作区经历以下阶段:</p><blockquote class="oc od oe"><p id="d740" class="jq jr of js b jt ju jv jw jx jy jz ka og kc kd ke oh kg kh ki oi kk kl km kn im bi translated"><strong class="js iu">计划</strong>，允许用户通过标准的控制台输出或详细的计划视图查看资源的计划创建、更新或销毁。详细计划将提醒用户破坏性的变化，并在有许多资源受到影响时使搜索计划变得更容易。它也是检查谁批准了申请以及与批准相关的备注的部分。</p><p id="8545" class="jq jr of js b jt ju jv jw jx jy jz ka og kc kd ke oh kg kh ki oi kk kl km kn im bi translated"><strong class="js iu">成本估计</strong>，它将显示正在创建的资源的估计成本。该信息可用于将策略写入<a class="ae ko" href="https://github.com/Scalr/sample-tf-opa-policies/blob/master/cost/limit_monthly_cost.rego" rel="noopener ugc nofollow" target="_blank">检查成本</a></p><p id="cad0" class="jq jr of js b jt ju jv jw jx jy jz ka og kc kd ke oh kg kh ki oi kk kl km kn im bi translated"><strong class="js iu">策略检查</strong>，用于对照开放策略代理策略检查Terraform plan JSON输出。这一步可以用来执行你的公司标准。</p><p id="1bfa" class="jq jr of js b jt ju jv jw jx jy jz ka og kc kd ke oh kg kh ki oi kk kl km kn im bi translated"><strong class="js iu">应用</strong>，它将根据Terraform配置文件实际创建、更新或销毁资源。</p></blockquote><p id="5e5d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">注意，在我的例子中，我创建的Azure广告组不会产生任何成本，所以Scalr只是报告说它没有检测到任何资源。此外，我还没有定义任何策略，因此跳过了这一阶段。</p><h2 id="157f" class="lz lc it bd ld ma mb dn lh mc md dp ll kb me mf lp kf mg mh lt kj mi mj lx mk bi translated">创建CLI驱动的工作区</h2><p id="4497" class="pw-post-body-paragraph jq jr it js b jt ml jv jw jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn im bi translated">考虑到我在Azure DevOps中已经有了一个工作流设置，它使用了我想与Scalr一起使用的Terraform CLI。Scalr将在Scalr后端的容器中执行运行，但是日志和输出将被发送回控制台。</p><p id="9371" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在第1篇文章中，我们展示了如何使用本地Terraform CLI获得一个API令牌来利用Scalr作为远程支持。这是交互完成的。当使用Azure DevOps Pipeline时，这是一个自动化的过程，因此登录阶段需要自动化，而不是交互式的。</p><ol class=""><li id="f54a" class="nl nm it js b jt ju jx jy kb nn kf no kj np kn nq nr ns nt bi translated">生成一个API令牌。如果您没有保存第一篇文章中生成的文件，那么继续从Scalr UI生成一个新的文件。</li></ol><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ot"><img src="../Images/672be8a859308cdfb9c21d7a98f1bc63.png" data-original-src="https://miro.medium.com/v2/resize:fit:632/format:webp/1*6FJLQjqCN_bLLAuOHcbYFg.png"/></div></div></figure><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ow"><img src="../Images/0c287b4f6fb2685b5af3eb03f7766fab.png" data-original-src="https://miro.medium.com/v2/resize:fit:338/format:webp/1*kDtcd2TWIx4rgTi869Q59w.png"/></div></div></figure><p id="c2d2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2.创建新的工作区。单击新建工作区，然后选择CLI。配置所需选项，然后按创建。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/5b2ef78947670300e70c80c05bfe2dec.png" data-original-src="https://miro.medium.com/v2/resize:fit:276/format:webp/1*Vuk02eAA-j8_kVJKAxHeMg.png"/></div></figure><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ox"><img src="../Images/23ba0df30179ab1f074464b8c48f5ac3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xfj0sYTGURi45EAmra_N5g.png"/></div></div></figure><p id="53d4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3.单击“基本后端配置”。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/ce1eecb33a56326220df110fa7232582.png" data-original-src="https://miro.medium.com/v2/resize:fit:644/format:webp/1*0w0qRpBWP0v2G2g5x_r3Yg.png"/></div></figure><p id="3cd5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这将显示Terraform配置使用Scalr作为远程后端所需的配置。更新配置文件，将Scalr设置为远程后端。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi oz"><img src="../Images/d867d0e0874bd824439169108d1bc1a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:962/format:webp/1*z5jmiIPgToHnEoPO03Z5VQ.png"/></div></figure><p id="935a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">4.接下来，为了连接到Scalr，我们需要提供API令牌。根据<a class="ae ko" href="https://www.terraform.io/cli/config/config-file#credentials-1" rel="noopener ugc nofollow" target="_blank">平台文档</a>，这必须是用户令牌或团队令牌，不能是组织令牌。</p><p id="555c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在Azure DevOps中，在管道-&gt;库-&gt;添加一个新的变量组。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi pa"><img src="../Images/9881ec4c0097cf60f624b02d5a6902ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:646/format:webp/1*RPlvrSoQ9yHtYRgmH2gnqw.png"/></div></figure><p id="85cb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将令牌作为秘密值添加，名称为scalr-api-token。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi pb"><img src="../Images/3470cc5f2692b08c0fd1faeffb9b4f2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*82BZ0964YnwKQMAYYmnLMA.png"/></div></div></figure><p id="dead" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">5.在管道YAML文件的开头添加一个步骤，用于生成CLI配置文件。可以使用<code class="fe nv nw nx ny b">TF_CLI_CONFIG_FILE</code>环境变量指定文件的位置。这将创建一个名为<code class="fe nv nw nx ny b">terraformrc</code>的文件，其中包含API令牌。这正是使用CLI与Scalr交互认证时发生的情况，这里这个过程是自动的。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="pc pd l"/></div></figure><p id="5279" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦通过认证，管道继续运行<code class="fe nv nw nx ny b">terraform init</code>、<code class="fe nv nw nx ny b">terraform plan</code>和<code class="fe nv nw nx ny b">terraform apply.</code></p><p id="237d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请注意，在使用远程后端时，当前不支持“运行”变量(即，您不能使用-var= <variable>或-var-file= <file>选项。如果您指定这些，将会收到以下错误:</file></variable></p><blockquote class="oc od oe"><p id="e799" class="jq jr of js b jt ju jv jw jx jy jz ka og kc kd ke oh kg kh ki oi kk kl km kn im bi translated">“远程”后端此时不支持设置运行变量。目前，将变量传递到远程后端的唯一方法是创建一个“*.auto.tfvars”变量文件。当工作空间配置为使用Terraform v0.10.0或更高版本时，该文件将由“远程”后端自动加载。</p></blockquote><p id="bd56" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在执行过程中，您将看到管道贯穿每个阶段，另外还可以在应用阶段结束时为您提供成本估算。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi pe"><img src="../Images/b9412c28a9be2ce257e8bf175c9f64ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:750/format:webp/1*k0ydYV9de3JUzFHkv6YTpg.png"/></div></figure><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi pf"><img src="../Images/dd3174baafbbfd3863e49b84b7ef75db.png" data-original-src="https://miro.medium.com/v2/resize:fit:438/format:webp/1*4pJ9uin2GCZuV-c6H5ybZw.png"/></div></figure><h2 id="3f85" class="lz lc it bd ld ma mb dn lh mc md dp ll kb me mf lp kf mg mh lt kj mi mj lx mk bi translated">摘要</h2><p id="00bb" class="pw-post-body-paragraph jq jr it js b jt ml jv jw jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn im bi translated">在这一系列的最后一篇文章中，我们展示了如何创建一个工作场所，包括VCS集成的和CLI驱动的，并执行了我们的Terraform代码。我们使用Azure DevOps管道来自动化CLI驱动的工作区上的工作流，使用Scalr作为远程后端。</p><p id="85c8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请注意，工作区和变量可以使用Scalr Terraform提供程序来创建！</p><p id="0c33" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">干杯！🍻</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi pg"><img src="../Images/7719a662c95d837aa94b3f1836514491.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*5oqdPMWKmEFsEDQxV68oSA.png"/></div></figure><div class="mt mu gp gr mv mw"><a href="https://www.buymeacoffee.com/jackwesleyroper" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">Jack Roper正在Azure、Azure DevOps、Terraform、Kubernetes和Cloud tech上写博客！</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">希望我的博客能帮到你，你会喜欢它的内容！我真的很喜欢写技术内容和分享…</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">www.buymeacoffee.com</p></div></div><div class="nf l"><div class="ph l nh ni nj nf nk kz mw"/></div></div></a></div></div></div>    
</body>
</html>