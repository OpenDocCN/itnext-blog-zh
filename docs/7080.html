<html>
<head>
<title>Is K0s an Alternative to K3s as an Always Free Kubernetes Cluster on Oracle Cloud Infrastructure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">K0s作为Oracle云基础设施上的一个始终免费的Kubernetes集群，是K3s的替代方案吗</h1>
<blockquote>原文：<a href="https://itnext.io/is-k0s-an-alternative-to-k3s-as-an-always-free-kubernetes-cluster-on-oracle-cloud-infrastructure-9d76ffe18d21?source=collection_archive---------0-----------------------#2022-06-06">https://itnext.io/is-k0s-an-alternative-to-k3s-as-an-always-free-kubernetes-cluster-on-oracle-cloud-infrastructure-9d76ffe18d21?source=collection_archive---------0-----------------------#2022-06-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/e66a5eaad0b5ec2a135693d3b93c3a18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*37hVdp4SHM6S1OHeheJJsg.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">来自<a class="ae kf" href="https://pixabay.com/de/photos/hafen-container-export-ladung-4602964/" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae kf" href="https://pixabay.com/de/users/postcardtrip-11490472/" rel="noopener ugc nofollow" target="_blank"> postcardtrip </a>拍摄的照片</figcaption></figure><p id="da8e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">由于微服务在物联网和边缘领域的普及，提供轻量级Kubernetes集群的解决方案越来越受欢迎。由于这个原因，像<a class="ae kf" href="https://k3s.io" rel="noopener ugc nofollow" target="_blank"> K3s </a>和<a class="ae kf" href="https://k0sproject.io" rel="noopener ugc nofollow" target="_blank"> k0s </a>这样的解决方案变得越来越流行。</p><p id="c705" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我的上一篇文章中，我展示了如何在Oracle云基础设施(OCI) 上使用<a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/how-to-deploy-an-always-free-k3s-cluster-on-the-oracle-cloud-infrastructure-4aed6d6d8604">始终免费资源自动部署k3s集群。我采用了这个部署思想，并在本文中使用它来创建一个基于k0s的Kubernetes集群。</a></p><h1 id="1378" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">体系结构</h1><p id="c02c" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">集群基础架构由四个节点、两个控制器和两个工作节点组成。所有系统都使用Ubuntu 20.04操作系统。还有一个负载平衡器，作为我们部署的服务的入口。控制器节点位于可用性域2 (AD-2)中，工作节点在AD-1中创建。它们由<a class="ae kf" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>提供。第二步将通过<a class="ae kf" href="https://github.com/k0sproject/k0sctl" rel="noopener ugc nofollow" target="_blank"> k0sctl </a> cli安装集群软件k0s。集群使用存储解决方案<a class="ae kf" href="https://longhorn.io/" rel="noopener ugc nofollow" target="_blank"> Longhorn </a>，该解决方案将使用OCI实例的块存储，并在它们之间共享Kubernetes卷。并且<a class="ae kf" href="https://traefik.io/" rel="noopener ugc nofollow" target="_blank"> Traefik </a>将被用作入口控制器。下图给出了基础设施的概述。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/57367f04eab9b6bd39db1096ddf4f69a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1218/format:webp/1*9HX056UQRauRPmMO8dgHhg.png"/></div></figure><h1 id="32b8" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">配置</h1><p id="c95e" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">正如我在上一篇文章中所描述的，有必要设置以下环境变量，以便Terraform可以访问OCI。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="658b" class="mr lf it mn b gy ms mt l mu mv">export TF_VAR_compartment_id="&lt;COMPARTMENT_ID&gt;"<br/>export TF_VAR_region="&lt;REGION_NAME&gt;"<br/>export TF_VAR_tenancy_ocid="&lt;TENANCY_OICD&gt;"<br/>export TF_VAR_user_ocid="&lt;USER_OICD&gt;"<br/>export TF_VAR_fingerprint="&lt;RSA_FINGERPRINT&gt;"<br/>export TF_VAR_private_key_path="&lt;PATH_TO_YOUR_PRIVATE_KEY&gt;"<br/>export TF_VAR_ssh_authorized_keys='["&lt;SSH_PUBLIC_KEY&gt;"]'</span></pre><h1 id="2ede" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">部署</h1><p id="0de3" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">部署基于两个步骤，第一步是通过Terraform部署基础设施，第二步是通过k0sctl部署集群。</p><p id="d4d1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，从Terraform init开始:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="35b8" class="mr lf it mn b gy ms mt l mu mv">terraform init</span></pre><p id="9aba" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">其次，您必须通过以下命令创建一个地形平面图:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="eb1a" class="mr lf it mn b gy ms mt l mu mv">terraform plan -out .tfplan</span></pre><p id="625e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后应用计划:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="e186" class="mr lf it mn b gy ms mt l mu mv">terraform apply ".tfplan"</span></pre><p id="17c8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">几分钟后，OCI实例创建完毕，集群启动并运行。现在我们可以从k0s部署开始。Terraform代码创建一个输出，该输出可用作自动k0sctl部署的配置。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="7a33" class="mr lf it mn b gy ms mt l mu mv">terraform output -raw k0s_cluster | k0sctl apply --config -</span></pre><p id="69af" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">K0sctl显示了部署进度，如下所示。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mw"><img src="../Images/0b3c74735fd85c7d4da2263b1b8615cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dl5mpl3GkRv3r1oiRJ5EdA.png"/></div></div></figure><p id="f6da" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，我们已经准备好通过下面的命令获得集群的“kubeconfig”。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="c3d3" class="mr lf it mn b gy ms mt l mu mv">terraform output -raw k0s_cluster | k0sctl kubeconfig --config - &gt; ~/.kube/config</span></pre><p id="4023" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在您可以使用<code class="fe mx my mz mn b">kubectl</code>来管理您的集群并检查节点:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="fc40" class="mr lf it mn b gy ms mt l mu mv">kubectl get nodes</span></pre><p id="f634" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">部署同时完成两项任务，首先安装k0s，其次安装入口控制器Traefik。Traefik提供了一个可以通过端口转发访问的仪表板，并且需要以下命令。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="38df" class="mr lf it mn b gy ms mt l mu mv">kubectl port-forward deployment/traefik 9000:9000 -n traefik-system</span></pre><p id="c16f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要访问仪表板，您可以在浏览器中打开以下页面。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="72c3" class="mr lf it mn b gy ms mt l mu mv"><a class="ae kf" href="http://localhost:9000/dashboard/" rel="noopener ugc nofollow" target="_blank">http://localhost:9000/dashboard/</a></span></pre><h1 id="bd60" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">长角牛装置</h1><p id="d33a" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">在下一步中，您必须通过<code class="fe mx my mz mn b">kubectl</code>或<code class="fe mx my mz mn b">helm</code>方法的以下命令将<a class="ae kf" href="https://longhorn.io/" rel="noopener ugc nofollow" target="_blank"> Longhorn </a>部署为分布式块存储提供者:</p><p id="8190" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">方法一通过<code class="fe mx my mz mn b">kubectl</code>:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="1154" class="mr lf it mn b gy ms mt l mu mv">kubectl apply -f <a class="ae kf" href="https://raw.githubusercontent.com/longhorn/longhorn/v1.2.3/deploy/longhorn.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/longhorn/longhorn/v1.2.4/deploy/longhorn.yaml</a></span></pre><p id="6136" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe mx my mz mn b">helm</code>方法二:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="0f5a" class="mr lf it mn b gy ms mt l mu mv">helm repo add longhorn <a class="ae kf" href="https://charts.longhorn.io" rel="noopener ugc nofollow" target="_blank">https://charts.longhorn.io</a><br/>helm repo update<br/>kubectl create namespace longhorn-system<br/>helm install longhorn longhorn/longhorn --namespace longhorn-system</span></pre><p id="c7ec" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">几分钟后，所有pod应该都在运行，并且应该可以通过端口转发访问控制面板。不幸的是，事实并非如此，仪表盘没有显示任何数据，所以我开始寻找错误。</p><h1 id="1d1a" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">排除故障</h1><p id="a012" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">调试表明，k0s、Traefik和Longhorn的工作量对于工作节点来说太大了。他们没有足够的内存。出于这个原因，我创建了一个cronjob来定期清理缓存。不幸的是，这不足以用这两个组件稳定地运行集群。</p><p id="9d79" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">调试表明，k0s、Traefik和Longhorn的工作量对于工作节点来说太大了。他们没有足够的内存。出于这个原因，我创建了一个cronjob来定期清理缓存。不幸的是，这不足以用这两个组件稳定地运行集群。</p><p id="3aa7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了验证这一点，我再次部署了没有两个组件Traefik和Longhorn的集群，以确定工作人员的空闲状态。这表明在k0s安装之后，worker节点上平均有220MB的可用内存。如果没有k0s，在部署基础架构后，平均有650MB的内存可用。</p><h1 id="55b8" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="6539" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">工作节点1GB的内存限制对于所有Kubernetes集群部署来说都是一个挑战，对于许多人来说也是一个不可逾越的障碍。部署表明，与K3s相比，k0s不一定适合使用Traefik和Longhorn的OCI上的始终自由集群。出于这个原因，我目前只能推荐K3s作为Kubernetes集群部署在OCI，作为一个总是免费的解决方案。</p><h1 id="d788" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">链接</h1><p id="c2d5" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated"><em class="na"> Gitlab资源库:</em><a class="ae kf" href="https://github.com/r0b2g1t/k0s-oracle-cloud-infrastructure-cluster" rel="noopener ugc nofollow" target="_blank">https://github . com/r0 B2 G1 t/k0s-Oracle-cloud-infra structure-cluster</a></p><p id="ba29" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="na">k0s:</em><a class="ae kf" href="https://k0sproject.io/" rel="noopener ugc nofollow" target="_blank">https://k0s project . io</a></p><p id="aae6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="na">K3s:</em>T2】https://K3s . io</p><p id="7695" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="na">terra form:</em><a class="ae kf" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank">https://www . terra form . io</a></p></div></div>    
</body>
</html>