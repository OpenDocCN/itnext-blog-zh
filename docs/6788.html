<html>
<head>
<title>Reference Other Values in Helm Chart Values File</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">参考舵图表值文件中的其他值</h1>
<blockquote>原文：<a href="https://itnext.io/reference-other-values-in-helm-chart-values-file-19d44d9276c7?source=collection_archive---------0-----------------------#2022-02-27">https://itnext.io/reference-other-values-in-helm-chart-values-file-19d44d9276c7?source=collection_archive---------0-----------------------#2022-02-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/351e51b48167e4ed50c19b6d038f591c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Hs_oJUmnD5PUhGKV"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">由<a class="ae kc" href="https://unsplash.com/@varpap?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Vardan Papikyan </a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="be74" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">背景</h1><p id="2edf" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">Helm提供了一种简单的模板语言，允许我们轻松地引用在“值文件”中定义的配置值。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="3b3d" class="mi ke iq me b gy mj mk l ml mm"><strong class="me ir">apiVersion</strong>: v1<br/><strong class="me ir">kind</strong>: ConfigMap<br/><strong class="me ir">metadata</strong>:<br/>  <strong class="me ir">name</strong>: my-configmap<br/><strong class="me ir">data</strong>:<br/>  <strong class="me ir">myvalue</strong>: "Hello {{ .Values.name }}"</span></pre><p id="83e5" class="pw-post-body-paragraph lb lc iq ld b le mn lg lh li mo lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">例如，在上面的舵图模板中，我们引用了在“值文件”中定义的配置值“名称”。假设配置字段“name”的值是一个字符串“world”，模板最终将呈现如下:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="880d" class="mi ke iq me b gy mj mk l ml mm"><strong class="me ir">apiVersion</strong>: v1<br/><strong class="me ir">kind</strong>: ConfigMap<br/><strong class="me ir">metadata</strong>:<br/>  <strong class="me ir">name</strong>: my-configmap<br/><strong class="me ir">data</strong>:<br/>  <strong class="me ir">myvalue</strong>: "Hello world"</span></pre><p id="f93c" class="pw-post-body-paragraph lb lc iq ld b le mn lg lh li mo lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">在舵图模板中引用一个“值”看起来简洁明了。但是我们如何引用舵图“值文件”中的其他值呢？</p><h1 id="af68" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">为什么？</h1><p id="d37b" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">下面是一个示例“值文件”,它提供了一个API端点URL列表:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="5089" class="mi ke iq me b gy mj mk l ml mm"><strong class="me ir">apiOneUrl</strong>: http://example.com/apiOne/v0<br/><strong class="me ir">apiTwoUrl</strong>: http://example.com/apiTwo/v3<br/><strong class="me ir">apiThreeUrl</strong>: http://example.com/apiThree/v7</span></pre><p id="e36c" class="pw-post-body-paragraph lb lc iq ld b le mn lg lh li mo lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">您可能会发现所有配置字段都包含字符串“http://example.com/”。如果我们能提供如下“值文件”就好了:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="c4f2" class="mi ke iq me b gy mj mk l ml mm"><strong class="me ir">baseUrl</strong>: http://example.com<br/><strong class="me ir">apiOneUrl</strong>: "{{ .Values.baseUrl }}/apiOne/v0"<br/><strong class="me ir">apiTwoUrl</strong>: "{{ .Values.baseUrl }}/apiTwo/v3"<br/><strong class="me ir">apiThreeUrl</strong>: "{{ .Values.baseUrl }}/apiThree/v7"</span></pre><p id="ba44" class="pw-post-body-paragraph lb lc iq ld b le mn lg lh li mo lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">这不仅会减少冗余，节省大量的打字时间，而且会使将来更新配置值变得更加容易。然而，由于Helm的模板引擎不会处理“值文件”,如果您试图在您的模板中引用<code class="fe ms mt mu me b">.Values.apiOneUrl</code>,您将只能获得原始字符串<code class="fe ms mt mu me b">{{ .Values.baseUrl }}/apiOne/v0</code>作为结果。</p><h1 id="511b" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated"><code class="fe ms mt mu me b">tpl</code>功能营救</h1><p id="9c1d" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">Helm chart <code class="fe ms mt mu me b">tpl</code>函数允许开发人员将字符串作为模板中的模板进行评估，这只是我们这里的保护程序。该函数需要两个参数:</p><ul class=""><li id="ac57" class="mv mw iq ld b le mn li mo lm mx lq my lu mz ly na nb nc nd bi translated">第一个参数是要处理的模板字符串。</li><li id="767d" class="mv mw iq ld b le ne li nf lm ng lq nh lu ni ly na nb nc nd bi translated">最后一个参数是在模板字符串处理过程中使用的上下文数据。我们通常可以传递当前上下文数据<code class="fe ms mt mu me b">.</code>,以使所有配置值在模板处理期间可用。</li></ul><p id="e2ed" class="pw-post-body-paragraph lb lc iq ld b le mn lg lh li mo lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">如果您在模板中尝试以下操作:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="4eee" class="mi ke iq me b gy mj mk l ml mm"><strong class="me ir">MyApiOneUrl</strong>: {{ tpl .Values.apiOneUrl . }}</span></pre><p id="8a4a" class="pw-post-body-paragraph lb lc iq ld b le mn lg lh li mo lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">你会发现<code class="fe ms mt mu me b">.Values.apiOneUrl</code>的值<code class="fe ms mt mu me b">"{{ .Values.baseUrl }}/apiOne/v0"</code>会被转换成<code class="fe ms mt mu me b">"http://example.com//apiOne/v0”</code>，上面的模板会被渲染成:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="fe6d" class="mi ke iq me b gy mj mk l ml mm"><strong class="me ir">MyApiOneUrl</strong>: <!-- -->http://example.com/apiOne/v0</span></pre><h1 id="9500" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">非字符串类型的问题</h1><p id="9a6e" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">该解决方案适用于简单的字符串类型配置值。但是，如果配置值是非字符串类型的值(例如“map”或“list”)该怎么办呢？</p><p id="a67b" class="pw-post-body-paragraph lb lc iq ld b le mn lg lh li mo lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">考虑以下“值文件”:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="28a7" class="mi ke iq me b gy mj mk l ml mm"><strong class="me ir">baseUrl: </strong>http://example.com<strong class="me ir"><br/>apiUrls:</strong><br/>  <strong class="me ir">apiOneUrl</strong>: "{{ .Values.baseUrl }}/apiOne/v0"<br/>  <strong class="me ir">apiTwoUrl</strong>: "{{ .Values.baseUrl }}/apiTwo/v3"<br/>  <strong class="me ir">apiThreeUrl</strong>: "{{ .Values.baseUrl }}/apiThree/v7"</span></pre><p id="3d7c" class="pw-post-body-paragraph lb lc iq ld b le mn lg lh li mo lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">如果您在模板中尝试以下操作:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="f955" class="mi ke iq me b gy mj mk l ml mm"><strong class="me ir">MyApiUrls: {{ </strong>tpl .Values.apiUrls .<strong class="me ir"> }}</strong></span></pre><p id="30b5" class="pw-post-body-paragraph lb lc iq ld b le mn lg lh li mo lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">您将得到以下模板错误:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="60ae" class="mi ke iq me b gy mj mk l ml mm">wrong type for value; expected string; got map[string]interface {}</span></pre><p id="558d" class="pw-post-body-paragraph lb lc iq ld b le mn lg lh li mo lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">由于<code class="fe ms mt mu me b">tpl</code>函数期望一个模板字符串作为第一个参数，这个错误消息是有意义的。但是，我们如何解决这个问题并将我们的解决方案扩展到这个常见的用例呢？</p><p id="d4d8" class="pw-post-body-paragraph lb lc iq ld b le mn lg lh li mo lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">一种解决方案是在传递给<code class="fe ms mt mu me b">tpl</code>函数之前，使用<code class="fe ms mt mu me b">toYaml</code>函数将非字符串类型值(本例中为“map”)转换为“YAML”字符串:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="79bc" class="mi ke iq me b gy mj mk l ml mm"><strong class="me ir">MyApiUrls:<br/>{{ </strong>tpl (.Values.apiUrls | toYaml) .<strong class="me ir"> | </strong>indent 2 <strong class="me ir">}}</strong></span></pre><p id="1306" class="pw-post-body-paragraph lb lc iq ld b le mn lg lh li mo lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">如果您尝试上面的模板，您会发现它会正确地呈现为:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="051b" class="mi ke iq me b gy mj mk l ml mm"><strong class="me ir"><br/>MyApiUrls:<br/>  apiOneUrl</strong>: http://example.com/apiOne/v0<br/>  <strong class="me ir">apiTwoUrl</strong>: http://example.com/apiTwo/v3<br/>  <strong class="me ir">apiThreeUrl</strong>: http://example.com/apiThree/v7</span></pre><h1 id="df38" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">完整的解决方案</h1><p id="7a9b" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">为了使解决方案具有可移植性，我们可以定义一个<a class="ae kc" href="https://helm.sh/docs/chart_template_guide/named_templates/" rel="noopener ugc nofollow" target="_blank">“命名模板”</a>来检测配置值类型&amp;并相应地应用不同的逻辑:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="622d" class="mi ke iq me b gy mj mk l ml mm">{{ <!-- -->define "render-value" <!-- -->}}<br/>  <!-- -->{{- if kindIs "string" .value }}<br/>    <!-- -->{{- tpl .value .context }}<br/>  <!-- -->{{- else }}<br/>    <!-- -->{{- tpl (.value | toYaml) .context }}     <br/>  {{- end }}<br/>{{- end }}</span></pre><p id="0833" class="pw-post-body-paragraph lb lc iq ld b le mn lg lh li mo lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">要在模板中使用，可以使用<code class="fe ms mt mu me b">include</code>函数调用“命名模板”:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="4462" class="mi ke iq me b gy mj mk l ml mm"><strong class="me ir">MyApiOneUrl</strong>: {{ include "render-value" ( dict "value" .Values.apiOneUrl "context" .) }}<br/><strong class="me ir">MyApiUrls:<br/></strong>{{ include "render-value" ( dict "value" .Values.apiUrls "context" .) | indent 2}}</span></pre><p id="3e03" class="pw-post-body-paragraph lb lc iq ld b le mn lg lh li mo lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">上面的模板将呈现如下:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="da1c" class="mi ke iq me b gy mj mk l ml mm"><strong class="me ir">MyApiOneUrl</strong>: <!-- -->http://example.com/apiOne/v0<br/><strong class="me ir">MyApiUrls:<br/>  apiOneUrl</strong>: http://example.com/apiOne/v0<br/>  <strong class="me ir">apiTwoUrl</strong>: http://example.com/apiTwo/v3<br/>  <strong class="me ir">apiThreeUrl</strong>: http://example.com/apiThree/v7</span></pre><p id="ae5c" class="pw-post-body-paragraph lb lc iq ld b le mn lg lh li mo lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">如果你想省去自己定义“命名模板”的功夫，也可以使用<a class="ae kc" href="https://github.com/bitnami/charts/tree/master/bitnami/common" rel="noopener ugc nofollow" target="_blank"> Bitnami的“通用”库图</a>。要使用它，只需将以下依赖项添加到您的<code class="fe ms mt mu me b">Chart.yaml</code>中:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="7ba9" class="mi ke iq me b gy mj mk l ml mm">dependencies:<br/>  - name: common<br/>    version: 1.11.1<br/>    repository: https://charts.bitnami.com/bitnami</span></pre><p id="9cad" class="pw-post-body-paragraph lb lc iq ld b le mn lg lh li mo lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">然后，您将能够调用包含的“命名模板”,其逻辑类似于以下内容:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="dc9d" class="mi ke iq me b gy mj mk l ml mm"><strong class="me ir">MyApiOneUrl</strong>: {{ include "common.tplvalues.render" ( dict "value" .Values.apiOneUrl "context" .) }}</span></pre><h1 id="425f" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">摘要</h1><p id="1b1a" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">Helm提供了一个简单而强大的模板引擎，允许我们将配置值合并到模板中。然而，有时我们可能希望将这种能力扩展到配置文件:也就是掌舵人的“值文件”。本文介绍了一个基于<code class="fe ms mt mu me b">tpl</code>函数的解决方案及其更通用的“命名模板”实现。</p><p id="f5f3" class="pw-post-body-paragraph lb lc iq ld b le mn lg lh li mo lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly ij bi translated">如果你不熟悉Helm的“命名模板”功能，你可能也想看看<a class="ae kc" rel="noopener ugc nofollow" target="_blank" href="/use-named-templates-like-functions-in-helm-charts-641fbcec38da">我的相关博客</a>来了解更多关于“命名模板”可以实现的功能。</p></div></div>    
</body>
</html>