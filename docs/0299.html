<html>
<head>
<title>Idea to App Part 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">应用第3部分的想法</h1>
<blockquote>原文：<a href="https://itnext.io/idea-to-app-part-3-76de38bb692f?source=collection_archive---------2-----------------------#2018-02-12">https://itnext.io/idea-to-app-part-3-76de38bb692f?source=collection_archive---------2-----------------------#2018-02-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d4193627b2c0c71f4431249f759011a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ofMfrqFMfpaTH_RMvI_RQA.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/photos/95YRwf6CNw8?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">克莱门特·H</a>在<a class="ae kc" href="https://unsplash.com/search/photos/javascript?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h1 id="56de" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">介绍</h1><p id="e1f2" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">在本系列的前两部分中，我们启动了我们的想法，并为响应式webapp准备好了基本的UI。老实说，由于在新的工作中分心，完成这个部分花费的时间比我希望的要长……:-)我觉得我想分享的一些观点已经被遗忘了，所以这将是一个比我希望的更快的旅程。</p><p id="d5e0" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated"><a class="ae kc" href="https://www.linkedin.com/cws/share?url=https%3A%2F%2Fitnext.io%2Fidea-to-app-part-3–76de38bb692f" rel="noopener ugc nofollow" target="_blank"> <em class="me">点击这里在LinkedIn上分享这篇文章</em> </a></p><p id="6f32" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">以防您忘记，以下是我们对App 系列的<em class="me">想法的概述:</em></p><ul class=""><li id="329c" class="mf mg iq ld b le lz li ma lm mh lq mi lu mj ly mk ml mm mn bi translated"><a class="ae kc" href="https://medium.com/@deadlysyn/idea-to-app-part-1-42ca01aba91d" rel="noopener">构思</a></li><li id="66c3" class="mf mg iq ld b le mo li mp lm mq lq mr lu ms ly mk ml mm mn bi translated"><a class="ae kc" href="https://medium.com/@deadlysyn/idea-to-app-part-2-ad040109ba97" rel="noopener"> UI、UX和客户端关注点</a></li><li id="8da2" class="mf mg iq ld b le mo li mp lm mq lq mr lu ms ly mk ml mm mn bi translated">后端和API(你在这里)</li></ul><p id="0fda" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">我原本也计划了一个<em class="me">部署</em>部分…但是我决定这将是这个系列的最后一部分。也许我会在以后的系列文章中谈到典型的web和移动应用程序的部署方面。ChowChow是一个部署在Heroku上的简单应用程序，所以没有太多的内容可以分享，除非是在<a class="ae kc" href="https://devcenter.heroku.com/categories/reference" rel="noopener ugc nofollow" target="_blank">他们的优秀文档</a>！</p><p id="525f" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">为了弥补这一点，基于我在工作中分配时间的方式(SRE很有趣，经常让人难以割舍！)，实际编码，学习新东西和博客…一个更有趣的话题可能是围绕我们完成的应用和重构(添加更多的错误处理，更好地利用新的ES功能，如承诺，基于<a class="ae kc" href="http://airbnb.io/javascript" rel="noopener ugc nofollow" target="_blank"> Airbnb的风格指南</a>的清理，等等。).</p><p id="ad35" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated"><strong class="ld ir">记住</strong> <a class="ae kc" href="https://github.com/deadlysyn/chowchow" rel="noopener ugc nofollow" target="_blank"> <strong class="ld ir">克隆资源库</strong> </a> <strong class="ld ir">跟着一起走……</strong></p><h1 id="3f31" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">利用环境</h1><p id="b19d" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">在设计最现代的应用程序时，我们需要注意的第一件事就是管理敏感数据。通常的做法是从环境中读取这些值，然后可以通过凭证管理实用程序注入这些值，通过构建工具配置等进行设置。</p><p id="26e4" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">利用环境不仅限于您不希望检查到版本控制中的敏感信息…它还可以被传递到控制行为(例如dev vs prod)或读取动态信息，如监听地址。对于<a class="ae kc" href="https://nodejs.org" rel="noopener ugc nofollow" target="_blank"> Node.js </a>，我们使用<code class="fe mt mu mv mw b">process.env</code>来实现。</p><p id="c6c3" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">ChowChow非常简单，我们没有太多的担心，但我们确实需要从环境中读取IP地址和端口(所以我的笔记本电脑和我的主机提供商都可以正常工作)。我们还有一个由<a class="ae kc" href="https://www.npmjs.com/package/express-session" rel="noopener ugc nofollow" target="_blank">快速会话</a>使用的秘密密钥(提供轻量级会话管理)。</p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">从Node.js中的环境读取值</figcaption></figure><p id="f77a" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">这个特殊的地址<code class="fe mt mu mv mw b">0.0.0.0</code>只是监听所有可用的接口(可能是我家里笔记本电脑的回环或以太网地址，或者是像Heroku这样的平台上的容器的虚拟网卡)。我可以将它设置为<code class="fe mt mu mv mw b">127.0.0.1</code>，让它在家里也能轻松工作，但在发布应用程序时通常会中断，所以<code class="fe mt mu mv mw b">0.0.0.0</code>更容易管理。如果您担心绑定到笔记本电脑上所有可用的接口(希望您运行了防火墙)，您可以使用<code class="fe mt mu mv mw b">127.0.0.1</code>，然后在启动时设置<code class="fe mt mu mv mw b">IP</code>环境变量。<code class="fe mt mu mv mw b">PORT</code>非常相似，所以我不会详述，只需注意如何传入一个<code class="fe mt mu mv mw b">PORT</code>环境变量或者让它默认为<code class="fe mt mu mv mw b">3000</code>。您可以通过shell将这些设置为<code class="fe mt mu mv mw b">export NAME = value</code>或者像Heroku的<a class="ae kc" href="https://devcenter.heroku.com/articles/config-vars" rel="noopener ugc nofollow" target="_blank">配置变量</a>这样的机制。</p><p id="549b" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">最后但同样重要的是，<code class="fe mt mu mv mw b">secret</code>将默认为<code class="fe mt mu mv mw b">some random string</code>只是为了使开发更容易，但对于生产，我们将在我们的环境、容器、构建工具或托管提供者中设置<code class="fe mt mu mv mw b">SECRET</code>环境变量…这样真正的秘密就不会被签入GitHub。很简单，对吧？</p><h1 id="081b" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">开发与生产</h1><p id="69da" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">我真的很喜欢学习<a class="ae kc" href="https://expressjs.com" rel="noopener ugc nofollow" target="_blank"> Express </a>，但是如果你要发布一个真正的应用程序，你首先需要改变的事情之一(这不是秘密，所有的文档都明确说明了这一点！)是<a class="ae kc" href="https://www.npmjs.com/package/express-session" rel="noopener ugc nofollow" target="_blank">快速会话的</a>T0。这是原型开发的一个很好的起点，但是会在生产中泄漏内存(据我所知，它根本不关心到期)。</p><p id="7c27" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated"><a class="ae kc" href="https://www.npmjs.com/package/express-session#compatible-session-stores" rel="noopener ugc nofollow" target="_blank">后备存储有很多选择</a>(例如，您可能希望会话存储在MongoDB或SQL数据库中)，但是坚持我们简单的主题，<a class="ae kc" href="https://www.npmjs.com/package/memorystore" rel="noopener ugc nofollow" target="_blank"> memorystore </a>的工作方式与默认方式非常相似，没有内存泄漏。完美！让我们为ChowChow配置它:</p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">配置备用会话存储</figcaption></figure><p id="9d23" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated"><code class="fe mt mu mv mw b">secret</code>是我们从上面的环境中读取的值。根据<a class="ae kc" href="https://www.npmjs.com/package/memorystore" rel="noopener ugc nofollow" target="_blank">存储库文件</a>和<a class="ae kc" href="https://www.npmjs.com/package/express-session" rel="noopener ugc nofollow" target="_blank">快速会议文件</a>调整其他文件。</p><h1 id="c156" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">中间件</h1><p id="df1e" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">正如本系列前面提到的，我们为这个实验选择的技术栈是Node.js和Express……在这个生态系统中，一个共同的主题是通过将执行繁重任务的功能分解到<a class="ae kc" href="https://expressjs.com/en/guide/writing-middleware.html" rel="noopener ugc nofollow" target="_blank">中间件</a>中来保持负责路由的代码整洁。</p><p id="93d3" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">您可以将中间件功能链接在一起以获得灵活性，通过会话或返回值传递结果。让我们在我们的应用程序中看到一个简单的例子……首先，在<code class="fe mt mu mv mw b">app.js</code>，负责显示用户附近随机选择的餐馆的<code class="fe mt mu mv mw b">/random</code>路线看起来相当干净:</p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">将繁重的逻辑转移到中间件可以保持路线的整洁</figcaption></figure><p id="d0c1" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">我们可以让我们的<code class="fe mt mu mv mw b">app.post</code>路径包含<code class="fe mt mu mv mw b">m.logRequest</code>和<code class="fe mt mu mv mw b">m.parseRequest</code>中的所有逻辑，但是这将使代码更难阅读，并导致大量的重复(不是很<a class="ae kc" href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself" rel="noopener ugc nofollow" target="_blank">干</a>！)像<code class="fe mt mu mv mw b">logRequest</code>这样的东西，我们所有的航线目前都共享。</p><p id="ae97" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">让我们深入了解一下<code class="fe mt mu mv mw b">parseRequest</code> …</p><h1 id="d31d" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">API争论</h1><p id="e2c3" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">我们的大部分功能来自于<a class="ae kc" href="https://www.yelp.com/developers/documentation" rel="noopener ugc nofollow" target="_blank"> Yelp融合API </a>。名字起得不好的<code class="fe mt mu mv mw b">parseRequest</code>(老实说，出于代码<em class="me">可能会</em>弄清楚的原因，当时感觉这是个好名字；如果没有，请在我们的重构列表中添加一项！)是不是<em class="me">中间件</em>负责按摩我们app的输入(从<a class="ae kc" href="http://deadlysyn.com/blog/2018/01/20/idea-to-app-part-2" rel="noopener ugc nofollow" target="_blank">本系列前一部分</a>中讨论的<code class="fe mt mu mv mw b">geolocation</code>获得的经纬度之类的东西)并获得API结果。</p><p id="51b5" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">这仍然比我想要的要长，即使去掉了几行helper函数，但是这里有一个<code class="fe mt mu mv mw b">parseRequest</code>的例子:</p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">想象一下，如果这是你的路线代码？！？</figcaption></figure><p id="c33e" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">这建立了Yelp的API搜索用户附近的食物所需的查询字符串…值得注意的是，通过使用<a class="ae kc" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals" rel="noopener ugc nofollow" target="_blank">模板文字</a>，使得<code class="fe mt mu mv mw b">q</code>赋值<em class="me">稍微</em>更易于管理。</p><p id="eb4c" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">一旦我们有了合适的查询，我们就用回调函数调用<code class="fe mt mu mv mw b">searchYelp</code>(这可能需要一段时间)来检索我们的结果……如果发生了意想不到的事情，我们使用事实上的<a class="ae kc" href="https://www.npmjs.com/package/connect-flash" rel="noopener ugc nofollow" target="_blank"> connect-flash </a>通过写入会话向用户显示消息(如果您克隆了repo，您可以在<code class="fe mt mu mv mw b">error</code> div的<code class="fe mt mu mv mw b">home.ejs</code>中看到一个如何显示消息的示例)。</p><p id="e74d" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">这都是非常标准的(唯一的<em class="me">技巧</em>是使用<a class="ae kc" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter" rel="noopener ugc nofollow" target="_blank">滤镜</a>)，所以让我们通过看一下<code class="fe mt mu mv mw b">searchYelp</code>来总结一下:</p><figure class="mx my mz na gt jr"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">“发出HTTP请求的方法不止一种…”</figcaption></figure><p id="c4c0" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">首先，我们构建一个<code class="fe mt mu mv mw b">options</code>对象来控制<code class="fe mt mu mv mw b">https.get</code>的行为。大多数都是简单的<code class="fe mt mu mv mw b">const</code>文件，但是<code class="fe mt mu mv mw b">APIKEY</code>是从环境中读取的(毕竟，这是我们不想签入git的敏感数据！)经由熟悉的<code class="fe mt mu mv mw b">process.env.API_KEY</code>。</p><p id="a778" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">最有趣的(也许？)这其中有一部分是使用了<code class="fe mt mu mv mw b">https.get</code>。对于这个请求，我们可以使用任何数量的选项……我的第一直觉是使用熟悉的东西(在课堂上学到的)；<a class="ae kc" href="https://www.npmjs.com/package/request" rel="noopener ugc nofollow" target="_blank">请求模块</a>。除了最熟悉它之外，它还类似于Python的请求库。我们的应用程序的一个真正的缺点(试图优化简单性)是依赖的绝对数量。</p><p id="a5f5" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">其他一些选项有<a class="ae kc" href="https://www.npmjs.com/package/axios" rel="noopener ugc nofollow" target="_blank"> Axios </a>、<a class="ae kc" href="https://www.npmjs.com/package/request-promise-native" rel="noopener ugc nofollow" target="_blank">将承诺包装在请求周围</a>或<a class="ae kc" href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch" rel="noopener ugc nofollow" target="_blank">fetch</a>…我选择<code class="fe mt mu mv mw b">https.get</code>是因为它是标准库的一部分，我发现它将响应视为流的方式很有趣！你会用什么？</p><p id="0ded" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">由于<code class="fe mt mu mv mw b">https.get</code>响应是一个流，我们将<code class="fe mt mu mv mw b">body</code>声明为一个块级变量，并向其追加数据，直到我们接收到<code class="fe mt mu mv mw b">end</code>事件。然后我们用准备好的响应数据回电。</p><p id="38bc" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">注意:我们甚至没有触及用Javascript/Node发出HTTP请求的许多方式……<a class="ae kc" href="https://www.twilio.com/blog/2017/08/http-requests-in-node-js.html" rel="noopener ugc nofollow" target="_blank">看看这个</a>。</p><h1 id="8435" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">摘要</h1><p id="ee48" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">诚然，这是一次闪电之旅，但现在我们已经正式窥视了幕后，看到了负责与Yelp对话和检索数据的中间件，这使我们的应用程序变得有用(或至少比无用略多)…我们还看到了如何快速解决默认<code class="fe mt mu mv mw b">MemoryStore</code>的缺点，并利用Node的<code class="fe mt mu mv mw b">process.env</code>轻松控制应用程序行为和保护敏感信息。</p><p id="767b" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">正如我前面所说，这可能是本系列的最后一篇正式文章……Heroku简单地将部署做得如此简单，以至于没有什么值得写的，他们的文档已经比我希望改进的更好了！也就是说，我正在试验一个新的开发环境，包括<a class="ae kc" href="https://code.visualstudio.com" rel="noopener ugc nofollow" target="_blank"> VSCode </a>、<a class="ae kc" href="https://www.npmjs.com/package/eslint" rel="noopener ugc nofollow" target="_blank"> ESLint </a>和<a class="ae kc" href="http://airbnb.io/javascript" rel="noopener ugc nofollow" target="_blank"> Airbnb的风格指南</a>……所以可能会重新讨论这个项目，以涵盖重构。</p><p id="a19c" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">让这款应用成为真正的应用的最后一步将是更接近于原生的或渐进式的网络应用……这对我来说需要一点时间，因为我还在学习<a class="ae kc" href="https://facebook.github.io/react-native" rel="noopener ugc nofollow" target="_blank"> React-Native </a>(这不是唯一的路要走，只是我目前正在学习的一条路)。如果运气好的话，我会想出一个更有趣的前提来一起探索，一旦我走得更远并准备好合并其他技术。:-)</p><p id="4341" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">感谢阅读！</p><p id="6846" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">PS:如果你喜欢，一定要<a class="ae kc" href="https://medium.com/@deadlysyn/idea-to-app-part-1-42ca01aba91d" rel="noopener">看完整个系列</a>！:-)</p><p id="446f" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">PPS:最初发布的<a class="ae kc" href="http://deadlysyn.com/blog" rel="noopener ugc nofollow" target="_blank">在这里</a>。</p></div></div>    
</body>
</html>