<html>
<head>
<title>I cho, cho, choose you container image Part 3.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我秋，秋，选择你的容器图像第3部分。</h1>
<blockquote>原文：<a href="https://itnext.io/i-cho-cho-choose-you-container-image-part-3-b4eadb4f1573?source=collection_archive---------11-----------------------#2019-05-07">https://itnext.io/i-cho-cho-choose-you-container-image-part-3-b4eadb4f1573?source=collection_archive---------11-----------------------#2019-05-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/28ac750b9dff7af2dd05a029bde4ac3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tb63R5ixxprjZ9oKs3eHFA.png"/></div></div></figure><p id="0282" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本系列的前两篇文章(<a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/i-cho-cho-chose-you-container-image-part-1-fa6671d9ae1f">第一部分</a>和<a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/i-cho-cho-choose-you-container-image-part-2-44b45e47a1f7">第二部分</a>)中，我们已经了解了作为开发人员我们可以使用哪些基础映像。然后我们用Golang处理编译语言。现在，在这篇文章中，我们将使用动态语言来看看我们可用的选项。在我们开始之前，我们应该弄清楚一些事情。如果你一直在关注这个系列，我们已经讨论过了scratch base图像。我有一些坏消息，如果你使用动态语言，你将不能使用scratch，因为你需要安装运行时，不像编译语言。所以在这篇文章中，我们将使用完整的操作系统，超薄操作系统和Alpine Linux映像。</p><p id="f062" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你想利用动态语言的多阶段构建，那就有点微妙了。因为我们不需要复制一个二进制文件，所以我们仍然可以使用多阶段构建。Python实际上非常适合在多阶段构建中使用，因为它有<a class="ae kw" href="https://packaging.python.org/guides/installing-using-pip-and-virtualenv/" rel="noopener ugc nofollow" target="_blank"> virtualenv </a>提供了运行应用程序所需的依赖关系的逻辑分离。要使用多阶段构建，您需要将virtualenv目录从构建容器复制到最终映像。与Golang示例一样，我们使用的应用程序相当轻量级。只是一个简单的Python web服务器托管静态HMTL文件。如果您想查看代码，请点击<a class="ae kw" href="https://github.com/scotty-c/container-image-examples/blob/master/python/web.py" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="44b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如前所述，对于动态语言，我们有三种选择，因此我们将从完整的操作系统映像开始。</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="7a8d" class="lg lh iq lc b gy li lj l lk ll">FROM python:3.8.0a2-stretch as build<br/><br/>RUN python3 -m venv /web<br/><br/>COPY . /web<br/><br/>FROM python:3.8.0a2-stretch<br/><br/>COPY --from=build /web /web<br/><br/>WORKDIR /web<br/><br/>EXPOSE 8080<br/><br/>ENTRYPOINT [ "python", "web.py" ]</span></pre><p id="0d2f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦我们使用多阶段构建用上面的docker文件构建了我们的基本映像，我们就有了一个映像<code class="fe lm ln lo lc b">945mb</code>,所以你可以看到由于需要运行时，动态语言容器映像比编译语言要大得多。现在记住我们的第一个帖子，这张图片也包含关键的漏洞。因此，让我们来看看这个苗条的图像，看看我们能节省多少图像尺寸。</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="a089" class="lg lh iq lc b gy li lj l lk ll">FROM python:3.8.0a2-slim-stretch as build<br/><br/>RUN python3 -m venv /web<br/><br/>COPY . /web<br/><br/>FROM python:3.8.0a2-slim-stretch<br/><br/>COPY --from=build /web /web<br/><br/>WORKDIR /web<br/><br/>EXPOSE 8080<br/><br/>ENTRYPOINT [ "python", "web.py" ]</span></pre><p id="12c1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在使用精简操作系统作为基础映像的构建中，我们得到了一个大小为<code class="fe lm ln lo lc b">159mb</code>的映像，因此您可以看到，通过从完整的操作系统映像交换到相同操作系统的精简版本，可以节省大量空间。不幸的是，这种图像仍然带有易受攻击的包。那么，如果我们将应用程序迁移到Alpine Linux，我们会得到什么好处呢？</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="b907" class="lg lh iq lc b gy li lj l lk ll">FROM python:3.8.0a2-alpine3.9 as build<br/><br/>RUN python3 -m venv /web<br/><br/>COPY . /web<br/><br/>FROM python:3.8.0a2-alpine3.9<br/><br/>COPY --from=build /web /web<br/><br/>WORKDIR /web<br/><br/>EXPOSE 8080<br/><br/>ENTRYPOINT [ "python", "web.py" ]</span></pre><p id="9c29" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，迁移到Alpine Linux给我们带来了最小的映像大小，没有严重的漏洞。现在我们在<a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/i-cho-cho-chose-you-container-image-part-1-fa6671d9ae1f">第一部</a>中简要谈到了这个问题。Alpine没有使用<code class="fe lm ln lo lc b">glibc</code>，而是使用了<code class="fe lm ln lo lc b"><a class="ae kw" href="https://www.musl-libc.org/" rel="noopener ugc nofollow" target="_blank">musl li</a>bc</code>,这对于动态语言来说更加重要，如果你有依赖于<code class="fe lm ln lo lc b">glibc</code>的依赖关系，你可能会遇到Alpine的问题。</p><p id="62f4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你想看看这一系列文章的代码，请访问我的GitHub页面。要进一步了解容器或Kubernetes，请访问我的OSS工作室，或者你也可以通过twitter @scottcoulton联系我</p></div></div>    
</body>
</html>