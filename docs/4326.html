<html>
<head>
<title>Build Gunicorn from Scratch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从头开始建造Gunicorn</h1>
<blockquote>原文：<a href="https://itnext.io/build-gunicorn-from-scratch-d75870960b9b?source=collection_archive---------6-----------------------#2020-06-08">https://itnext.io/build-gunicorn-from-scratch-d75870960b9b?source=collection_archive---------6-----------------------#2020-06-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/0e8270b8da341b22398a919f35c73298.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b-QgzkWQx9_aBiubjQPoEA.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图片来自<a class="ae kc" href="https://www.pexels.com/photo/boston-terrier-wearing-unicorn-pet-costume-1564506/" rel="noopener ugc nofollow" target="_blank">Pexels</a>的马克·格兰西</figcaption></figure><p id="8153" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">许多python开发者使用gunicorn来部署他们的python应用程序，它是使用最多的python WSGI服务器之一。为了更好地理解这些服务器是如何工作的，我决定自己创建一个！</p><p id="f730" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该服务器具有以下主要特性:</p><ul class=""><li id="27cd" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated"><strong class="kf ir">干净的代码:</strong>该项目具有教育目的，为了展示wsgi规范如何在幕后工作，代码尽可能清晰，代码在三个不同的层中解耦:网络服务器、WSGI (wsgi规范)、http2(域实体)</li><li id="8bbe" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><strong class="kf ir">它必须工作！:</strong>服务器必须能够接收传入的请求，加载python应用程序并返回有效的响应。</li></ul><p id="9ae1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个项目还没有做好生产准备，它可能会包含bug。此外，该项目并没有满足所有的用例以及所有可能的极限情况，使用它来部署我们的应用程序是不安全的。</p><h1 id="7ccf" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">伏尼康</h1><p id="eda8" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">我决定创建Funicorn作为Gunicorn 的非生产版本。</p><h1 id="4421" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">整体架构</h1><p id="c296" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">该项目的架构非常简单，它包含三个组件:</p><ul class=""><li id="8048" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated"><strong class="kf ir">网络组件</strong>(服务器和请求处理器)，处理与操作系统的底层交互。</li><li id="ab1a" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><strong class="kf ir"> WSGI层。:</strong>它遵循wsgi规范，<strong class="kf ir">它能够与python应用程序对话。</strong></li><li id="64cb" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><strong class="kf ir"> Python应用:</strong>它包含了你想用你的应用执行的业务逻辑，它通常使用一个框架，比如Flask或者Django</li></ul><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/794fbcfc0434306e1f1a7fb4a97f47ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wo66EFtgWvjW2RvXus2YuA.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">整体架构——富尼科恩</figcaption></figure><h1 id="cbb0" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">主要应用</h1><p id="f85b" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">主应用程序是我们的服务器入口点，它接收所有必要的配置以正确处理您的应用程序。此外，它也是处理服务器生命的地方。</p><p id="e053" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">funicorn类只接收必要的信息来正常工作。它将application_path参数传递给处理程序，并包装服务器特性。</p><figure class="mt mu mv mw gt jr"><div class="bz fp l di"><div class="mx my l"/></div></figure><h1 id="7fb3" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">计算机网络服务器</h1><p id="1311" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">网络服务器处理底层网络需求。它成功地建立、保持和完成网络连接，例如打开网络套接字，将套接字绑定到特定的主机和端口，还将信息传递给处理程序。</p><p id="f8a8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了防止我从零开始构建服务器并自己处理网络连接，我使用了来自<a class="ae kc" href="https://docs.python.org/3.8/library/socketserver.html" rel="noopener ugc nofollow" target="_blank"> socketserver python模块</a>的<code class="fe mz na nb nc b">TCPServer</code>，这个模块提供了一些服务器类，它们具有您需要的基本特性。</p><h1 id="139b" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">请求处理程序</h1><p id="f3d5" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">Funicorn处理程序恰当地处理服务器收到的每个请求。它加载python应用程序，处理服务器收到的数据，并返回适当的响应。</p><p id="66ce" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我的处理程序继承自BaseRequestHandler，它是python的套接字库提供的基类。</p><figure class="mt mu mv mw gt jr"><div class="bz fp l di"><div class="mx my l"/></div></figure><h1 id="0d45" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">请求和响应</h1><p id="df72" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">为了轻松地处理HTTP和网络实体，我创建了一个请求和响应类，其中包含所有必要的信息。</p><p id="308c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些类只隔离请求和响应信息，比如消息头、使用的方法和消息体。</p><p id="db72" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">主体必须是一个类似文件的对象，它被传递给应用程序，并且它必须至少实现方法read和write。我已经用BytesIO建模了。</p><figure class="mt mu mv mw gt jr"><div class="bz fp l di"><div class="mx my l"/></div></figure><h1 id="a85a" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">WSGI</h1><p id="5831" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">WSGI应用程序实体是为服务器的其余部分包装python应用程序和WSGI规范的层。它接收请求实体，将其传递给python应用程序，并返回处理后的响应。</p><p id="d1a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">主要方法是<code class="fe mz na nb nc b">process_request</code>，在这里处理请求，并通过环境变量传递给应用程序。最后，通过<code class="fe mz na nb nc b">start_response</code>方法(在<a class="ae kc" href="https://www.python.org/dev/peps/pep-3333/#the-start-response-callable" rel="noopener ugc nofollow" target="_blank">规范</a>中定义)构建响应，并返回给处理程序。</p><figure class="mt mu mv mw gt jr"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="43d7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请求提供的所有信息，都以下面的方式包装在环境变量中。</p><p id="a1a7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了正确工作，你需要向Python应用程序提供许多环境变量，这些变量在<a class="ae kc" href="https://www.python.org/dev/peps/pep-3333/#environ-variables" rel="noopener ugc nofollow" target="_blank"> python提案</a>中有定义，其中大部分是强制性的。</p><p id="0fe8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，这些变量中有许多是由<a class="ae kc" href="https://tools.ietf.org/html/rfc7231#section-5" rel="noopener ugc nofollow" target="_blank"> HTTP协议</a>定义的，每一个都为应用程序提供重要的信息。我只实现了强制变量。</p><p id="c504" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我不会更详细地解释这些变量，因为我认为在<a class="ae kc" href="https://www.python.org/dev/peps/pep-3333/#environ-variables" rel="noopener ugc nofollow" target="_blank">网</a>上已经有足够的关于它的信息了。</p><figure class="mt mu mv mw gt jr"><div class="bz fp l di"><div class="mx my l"/></div></figure><h1 id="f847" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">Python应用程序</h1><p id="32fe" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">我们的服务器执行的python应用程序是一个简单的Flask示例。应用程序能够接收GET和POST请求。</p><ul class=""><li id="0ef0" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated"><strong class="kf ir"> GET: </strong>应用程序返回“Hello World”</li><li id="07ae" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><strong class="kf ir"> POST: </strong>应用程序从请求中返回相同的主体(回送应用程序)</li></ul><figure class="mt mu mv mw gt jr"><div class="bz fp l di"><div class="mx my l"/></div></figure><h1 id="b3ad" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">结论</h1><p id="b479" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">实施这个项目是一个很好的练习，因为它迫使你了解你不知道的关于python社区最常用的一些标准的许多细节，以及它实际上是如何工作的，它不是魔术，它实际上是代码！</p><p id="4d37" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我建议任何人看一看<a class="ae kc" href="https://github.com/juanbenitopr/funicorn" rel="noopener ugc nofollow" target="_blank">库</a>，在那里你可以看到整个代码，以便更好地了解我无法在这里总结的许多细节。你可以克隆它并使用它，就像我之前评论的那样，我尽量说得更清楚，但是如果你有任何疑问，请告诉我:)</p><p id="0f79" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，如果你喜欢这篇文章，让我在评论区知道，它会帮助你了解这种项目是如何工作的。</p><h1 id="9016" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">资源</h1><div class="nd ne gp gr nf ng"><a href="https://github.com/juanbenitopr/funicorn" rel="noopener  ugc nofollow" target="_blank"><div class="nh ab fo"><div class="ni ab nj cl cj nk"><h2 class="bd ir gy z fp nl fr fs nm fu fw ip bi translated">Juan benitopr/富尼科恩</h2><div class="nn l"><h3 class="bd b gy z fp nl fr fs nm fu fw dk translated">这个项目模拟了任何WSGI服务器的基本行为。该项目有教育目的，它的目的是…</h3></div><div class="no l"><p class="bd b dl z fp nl fr fs nm fu fw dk translated">github.com</p></div></div><div class="np l"><div class="nq l nr ns nt np nu jw ng"/></div></div></a></div><div class="nd ne gp gr nf ng"><a href="https://medium.com/@juanbenito.pr/build-gunicorn-from-scratch-d75870960b9b" rel="noopener follow" target="_blank"><div class="nh ab fo"><div class="ni ab nj cl cj nk"><h2 class="bd ir gy z fp nl fr fs nm fu fw ip bi translated">加入中等。</h2><div class="nn l"><h3 class="bd b gy z fp nl fr fs nm fu fw dk translated">加入中等。</h3></div><div class="no l"><p class="bd b dl z fp nl fr fs nm fu fw dk translated">加入Medium.medium.com</p></div></div></div></a></div><div class="nd ne gp gr nf ng"><a href="https://docs.python.org/3.8/library/socketserver.html" rel="noopener  ugc nofollow" target="_blank"><div class="nh ab fo"><div class="ni ab nj cl cj nk"><h2 class="bd ir gy z fp nl fr fs nm fu fw ip bi translated">socketserver -网络服务器的框架- Python 3.8.3文档</h2><div class="nn l"><h3 class="bd b gy z fp nl fr fs nm fu fw dk translated">源代码:Lib/socketserver.py该模块简化了编写网络服务器的任务。有四个基本的…</h3></div><div class="no l"><p class="bd b dl z fp nl fr fs nm fu fw dk translated">docs.python.org</p></div></div></div></a></div><div class="nd ne gp gr nf ng"><a href="https://gunicorn.org" rel="noopener  ugc nofollow" target="_blank"><div class="nh ab fo"><div class="ni ab nj cl cj nk"><h2 class="bd ir gy z fp nl fr fs nm fu fw ip bi translated">用于UNIX的Python WSGI HTTP服务器</h2><div class="nn l"><h3 class="bd b gy z fp nl fr fs nm fu fw dk translated">这里有一个如何开始使用Gunicorn的快速纲要。有关更多详细信息，请阅读文档。</h3></div><div class="no l"><p class="bd b dl z fp nl fr fs nm fu fw dk translated">gunicorn.org</p></div></div><div class="np l"><div class="nv l nr ns nt np nu jw ng"/></div></div></a></div><div class="nd ne gp gr nf ng"><a href="https://tools.ietf.org/html/rfc7231#section-5" rel="noopener  ugc nofollow" target="_blank"><div class="nh ab fo"><div class="ni ab nj cl cj nk"><h2 class="bd ir gy z fp nl fr fs nm fu fw ip bi translated">RFC 7231 -超文本传输协议(HTTP/1.1):语义和内容</h2><div class="nn l"><h3 class="bd b gy z fp nl fr fs nm fu fw dk translated">互联网工程任务组。征求意见:7231 Adobe Obsoletes:2616j . resch ke…</h3></div><div class="no l"><p class="bd b dl z fp nl fr fs nm fu fw dk translated">tools.ietf.org</p></div></div></div></a></div><div class="nd ne gp gr nf ng"><a href="https://www.python.org/dev/peps/pep-3333/#environ-variables" rel="noopener  ugc nofollow" target="_blank"><div class="nh ab fo"><div class="ni ab nj cl cj nk"><h2 class="bd ir gy z fp nl fr fs nm fu fw ip bi translated">PEP 3333 - Python Web服务器网关接口1.0.1版</h2><div class="nn l"><h3 class="bd b gy z fp nl fr fs nm fu fw dk translated">这是PEP 333的更新版本，略微修改以提高Python 3下的可用性，并加入了…</h3></div><div class="no l"><p class="bd b dl z fp nl fr fs nm fu fw dk translated">www.python.org</p></div></div><div class="np l"><div class="nw l nr ns nt np nu jw ng"/></div></div></a></div></div></div>    
</body>
</html>