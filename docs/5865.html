<html>
<head>
<title>Continuous Integration and Deployment of Docker Images using GitHub Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GitHub操作持续集成和部署Docker映像</h1>
<blockquote>原文：<a href="https://itnext.io/continuous-integration-and-deployment-of-docker-images-using-github-actions-7077991bcfde?source=collection_archive---------1-----------------------#2021-06-15">https://itnext.io/continuous-integration-and-deployment-of-docker-images-using-github-actions-7077991bcfde?source=collection_archive---------1-----------------------#2021-06-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="56ee" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用GitHub操作自动构建Docker映像并将其推送到Docker Hub</h2></div><p id="7d88" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据<a class="ae le" href="https://docs.github.com/en/actions" rel="noopener ugc nofollow" target="_blank"> GitHub </a>的说法，GitHub Actions允许你在你的存储库中自动化、定制和执行你的软件开发工作流程。您可以发现、创建和共享操作，以执行您喜欢的任何工作，包括持续集成(CI)和持续部署(CD)，并将操作组合到完全定制的工作流中。</p><p id="9508" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这篇简短的帖子将研究GitHub操作的一个简单用例——自动构建一个新的Docker映像并推送到Docker Hub。每当一个新的Git标签被推送到GitHub存储库时，就会触发一个GitHub Actions工作流。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/cabcd26a8808a1eb3f1cea0e336b0958.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B0BBIsPtEWer7FBSmuVQ0Q.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">GitHub Actions工作流运行，基于新的git标签的推送</figcaption></figure><h1 id="1496" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">GitHub项目资源库</h1><p id="1097" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">为了演示，我们将使用公共的<a class="ae le" href="https://github.com/garystafford/nlp-client" rel="noopener ugc nofollow" target="_blank"> NLP客户端</a>微服务GitHub项目存储库。用Go编写的NLP客户端是组成自然语言处理(NLP) API的五个微服务的一部分。我开发这个API是为了演示架构原则和DevOps实践。API的微服务旨在作为分布式系统运行，使用容器编排平台，如Docker Swarm、Red Hat OpenShift、Amazon ECS和Kubernetes (EKS、GKE、阿拉斯加)。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/972885ee5cb3fa24ddd3a0f5cb1674fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FJ2bYVpiMQFcdtoCBqhjxQ.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">公共NLP客户端GitHub项目存储库</figcaption></figure><h1 id="5ada" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">加密的秘密</h1><p id="4091" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">要将新图像推送到Docker Hub，工作流程必须登录到您的Docker Hub帐户。GitHub建议将您的Docker Hub用户名和密码存储为<a class="ae le" href="https://docs.github.com/en/actions/reference/encrypted-secrets" rel="noopener ugc nofollow" target="_blank">加密机密</a>，这样它们就不会暴露在您的工作流文件中。加密机密允许您将敏感信息作为加密的环境变量存储在您的组织、存储库或存储库环境中。您创建的机密将可在GitHub操作工作流程中使用。为了允许工作流登录Docker Hub，我使用我的组织的凭证创建了两个秘密，<code class="fe ms mt mu mv b">DOCKERHUB_USERNAME</code>和<code class="fe ms mt mu mv b">DOCKERHUB_PASSWORD</code>，然后在工作流中引用它们。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/06ac57f19bb054bf8b590e92a9c5075c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JsDdtPYmD8v8Oi0yAkUgIg.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">GitHub项目的“机密”标签中显示的操作机密</figcaption></figure><h1 id="661c" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">GitHub操作工作流程</h1><p id="9538" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">根据<a class="ae le" href="https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions" rel="noopener ugc nofollow" target="_blank"> GitHub </a>的说法，工作流是由一个或多个工作组成的可配置的自动化流程。您可以创建一个YAML文件来定义您的工作流配置。GitHub包含许多可搜索的<a class="ae le" href="https://docs.github.com/en/actions#code-examples" rel="noopener ugc nofollow" target="_blank">代码示例</a>，您可以使用它们来引导您的工作流开发。对于这个演示，我从GitHub操作指南中显示的例子开始，<a class="ae le" href="https://docs.github.com/en/actions/guides/publishing-docker-images" rel="noopener ugc nofollow" target="_blank">发布Docker图像</a>，并修改它以满足我的需要。工作流文件被检入到项目存储库的<code class="fe ms mt mu mv b"><a class="ae le" href="https://github.com/garystafford/nlp-client/tree/master/.github/workflows" rel="noopener ugc nofollow" target="_blank">.github/workflows</a></code>目录中。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="mw mx l"/></div></figure><h2 id="d9ee" class="my lw it bd lx mz na dn mb nb nc dp mf kr nd ne mh kv nf ng mj kz nh ni ml nj bi translated">工作流开发</h2><p id="23a2" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated"><a class="ae le" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank">Visual Studio Code</a>(VS Code)是一个全功能、可扩展、开源的IDE，用于软件开发和编写基础设施as Code (IaC)。VS代码有一个庞大的扩展生态系统，包括GitHub动作。目前，我正在使用Christopher Schleiden的GitHub Actions扩展。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nk"><img src="../Images/c664da3de14c3777a768ff26d4ee589f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BOJMagXckZI-3odBSqoG9A.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated"><a class="ae le" href="https://github.com/cschleiden/vscode-github-actions" rel="noopener ugc nofollow" target="_blank"> GitHub动作细节</a>扩展</figcaption></figure><p id="4199" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该扩展具有自动完成功能，如下图GitHub操作工作流YAML文件所示。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nk"><img src="../Images/5cc8e169ad72c401faf0d75a1df9c228.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gCtWO2M2wYrERGc1iv-MVg.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">使用<a class="ae le" href="https://github.com/cschleiden/vscode-github-actions" rel="noopener ugc nofollow" target="_blank"> GitHub Actions </a>扩展的自动完成示例</figcaption></figure><h1 id="6b3d" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">Git标签</h1><p id="9e68" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">该演示的工作流被设计为当一个新的Git标签被推送到NLP客户端项目存储库时被触发。使用该工作流，您可以在不触发该工作流的情况下执行到存储库的推送(<code class="fe ms mt mu mv b">git push</code>)。例如，在更新项目的自述文件时，您通常不希望触发新的映像构建和推送。因此，我们使用新的Git标签作为工作流触发器。对存储库的推送由运行一组单元测试的独立工作流来处理。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nl"><img src="../Images/a72e3fec8cb834907dbd90d0146de37f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tx7I2TP_ZM2Gz7_dABKPMQ.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">向GitHub推送新标签</figcaption></figure><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/18f97108c0e6a17253d30fae0d4f3d9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oRM8FxGafumn_SDE8LAlKw.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">GitHub项目资源库中显示的Git标签</figcaption></figure><p id="7803" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了一致性，我还将工作流设计为只有当Git标签的格式遵循版本号MAJOR的通用<a class="ae le" href="https://semver.org/" rel="noopener ugc nofollow" target="_blank">语义版本化</a> (SemVer)约定时才被触发。小调.补丁(<code class="fe ms mt mu mv b">v*.*.*</code>)。</p><pre class="lg lh li lj gt nm mv nn no aw np bi"><span id="873e" class="my lw it mv b gy nq nr l ns nt">on:<br/>  push:<br/>    tags:<br/><strong class="mv iu">      - 'v*.*.*'</strong></span></pre><p id="35c7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此外，遵循工作流中常见的Docker约定，Git标签(例如，<code class="fe ms mt mu mv b">v1.2.3</code>)被截断以移除字母‘v’并用作Docker图像的标签(例如，<code class="fe ms mt mu mv b">1.2.3</code>)。在工作流中，shell命令的<code class="fe ms mt mu mv b">GITHUB_REF:11</code>部分将<code class="fe ms mt mu mv b">refs/tags/v1.2.3</code>的Git标签引用截断为仅<code class="fe ms mt mu mv b">1.2.3</code>。</p><pre class="lg lh li lj gt nm mv nn no aw np bi"><span id="5da2" class="my lw it mv b gy nq nr l ns nt">run: echo "RELEASE_VERSION=${<strong class="mv iu">GITHUB_REF:11</strong>}" &gt;&gt; $GITHUB_ENV</span></pre><p id="acc8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">由于我的GitHub帐户和存储库名称与我的Docker Hub帐户和映像名称<code class="fe ms mt mu mv b">garystafford/nlp-client</code>匹配，我可以引用<code class="fe ms mt mu mv b">github.repository</code> <a class="ae le" href="https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#contexts" rel="noopener ugc nofollow" target="_blank">上下文</a>来标记工作流中的Docker映像。</p><pre class="lg lh li lj gt nm mv nn no aw np bi"><span id="11d2" class="my lw it mv b gy nq nr l ns nt">- name: Build image and push to Docker Hub<br/>        uses: docker/build-push-action@v2<br/>        with:<br/>          push: true<br/>          tags: <strong class="mv iu">${{ github.repository }}</strong>:${{ env.RELEASE_VERSION }}</span></pre><h1 id="0147" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">工作流运行</h1><p id="6a93" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">按下Git标签会触发工作流自动运行，如<strong class="kk iu">动作</strong>选项卡所示。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nu"><img src="../Images/e0c05c01e9279b7821564862914be7e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ovgh7bqNrqOigE_TFtw6Pg.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">GitHub Actions工作流运行，基于新的git标签的推送</figcaption></figure><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/076b42764951376b7d6279bd144b1979.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cMSxcPEijsE2J7r5FeGZbw.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">GitHub Actions工作流运行，基于新的git标签的推送</figcaption></figure><p id="868e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">详细的日志向您显示工作流中的每个步骤是如何处理的。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/cabcd26a8808a1eb3f1cea0e336b0958.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B0BBIsPtEWer7FBSmuVQ0Q.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">GitHub Actions工作流运行，基于新的git标签的推送</figcaption></figure><p id="64a2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面的示例显示，工作流已经成功地为NLP客户端微服务构建了一个新的Docker映像并将其推送到Docker Hub。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/db1768168997b7a345cb1dc39551e752.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*he639F533edqjQ99aa_lDg.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">已完成GitHub操作工作流运行</figcaption></figure><h2 id="280f" class="my lw it bd lx mz na dn mb nb nc dp mf kr nd ne mh kv nf ng mj kz nh ni ml nj bi translated">失败通知</h2><p id="c260" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">您可以选择在工作流失败时接收通知。GitHub动作通知是一个<a class="ae le" href="https://docs.github.com/en/github/managing-subscriptions-and-notifications-on-github/setting-up-notifications/configuring-notifications#github-actions-notification-options" rel="noopener ugc nofollow" target="_blank">可配置选项</a>，位于GitHub账户所有者的设置选项卡中。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nv"><img src="../Images/27ae8f6aafbe9455b8b839a1c76ccaf0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SDUUCLtUBtQpdCmcEuvpFw.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">工作流运行失败的电子邮件通知示例</figcaption></figure><h2 id="4adf" class="my lw it bd lx mz na dn mb nb nc dp mf kr nd ne mh kv nf ng mj kz nh ni ml nj bi translated">状态徽章</h2><p id="d743" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">您可以在存储库中显示一个<a class="ae le" href="https://docs.github.com/en/actions/managing-workflow-runs/adding-a-workflow-status-badge" rel="noopener ugc nofollow" target="_blank">状态标记</a>来指示您的工作流的状态。徽章可以作为Markdown添加到您的自述文件中。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nk"><img src="../Images/064dc67439a644b4a742ce35fc009f2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rTMKu41cc37frQkcxqr0-g.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">显示状态徽章的公共NLP客户端GitHub项目的自述文件</figcaption></figure><h1 id="1e13" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">码头枢纽</h1><p id="713c" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">由于工作流的成功完成，我们现在在NLP客户端Docker Hub存储库中有了一个标记为<code class="fe ms mt mu mv b">1.2.3</code>的新图像:<a class="ae le" href="https://hub.docker.com/repository/docker/garystafford/nlp-client" rel="noopener ugc nofollow" target="_blank">garystafter/NLP客户端</a>。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nk"><img src="../Images/ef87cc128fffe09e9b2f96d8c2d33c70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AFqcNWU4wB-MG-B0HV7Rtw.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">显示新图像标签的NLP客户端Docker Hub存储库</figcaption></figure><h1 id="2460" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论</h1><p id="2528" class="pw-post-body-paragraph ki kj it kk b kl mn ju kn ko mo jx kq kr mp kt ku kv mq kx ky kz mr lb lc ld im bi translated">在这篇简短的帖子中，我们看到了一个简单的例子，GitHub Actions允许您在GitHub存储库中自动化、定制和执行您的软件开发工作流。我们可以很容易地扩展本文的GitHub Actions示例，将服务的Kubernetes部署资源文件更新为Docker Hub中的最新图像标签。此外，我们可以使用诸如Weaveworks的<a class="ae le" href="https://www.weave.works/oss/flux/" rel="noopener ugc nofollow" target="_blank"> Flux </a>或<a class="ae le" href="https://argoproj.github.io/argo-cd/" rel="noopener ugc nofollow" target="_blank"> Argo CD </a>之类的工具触发<a class="ae le" href="https://www.weave.works/technologies/gitops/" rel="noopener ugc nofollow" target="_blank"> GitOps </a>工作流，以将修改后的工作负载部署到Kubernetes集群。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nu"><img src="../Images/2bc57cffbbac671fd5e684eaa3e8e22a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S4Zaj9GKZozEx57_AQPSLw.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">从<a class="ae le" href="https://argoproj.github.io/argo-cd/" rel="noopener ugc nofollow" target="_blank"> Argo CD </a>中可以看到部署的NLP API</figcaption></figure></div><div class="ab cl nw nx hx ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="im in io ip iq"><p id="3404" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">本博客代表我自己的观点，而非我的雇主亚马逊网络服务公司(AWS)的观点。所有产品名称、徽标和品牌都是其各自所有者的财产。</p></div></div>    
</body>
</html>