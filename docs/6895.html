<html>
<head>
<title>Jenkins + k8s: Building Docker Image without Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">詹金斯+ k8s:不用Docker打造Docker形象</h1>
<blockquote>原文：<a href="https://itnext.io/jenkins-k8s-building-docker-image-without-docker-d41cffdbda5a?source=collection_archive---------0-----------------------#2022-04-06">https://itnext.io/jenkins-k8s-building-docker-image-without-docker-d41cffdbda5a?source=collection_archive---------0-----------------------#2022-04-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e1ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如2020年宣布的那样，Kubernetes在1.20版中反对Docker作为容器运行时，它将从即将发布的1.24版中删除。如果您的Jenkins pipelines使用Kubernetes插件，则很可能pipelines使用底层Docker来构建图像，因此您可能会遇到问题。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/438e55b559ccbf424dade21cca6b00fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DeA-BD2EUWJ3aB-zXF5I8A.jpeg"/></div></div></figure><p id="34bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您仍然希望使用Kubernetes插件来构建Docker映像，1.24版本之后有哪些选项？</p><h1 id="1579" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">用户Docker</h1><p id="a310" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">最明显的一种方法是继续使用docker来构建图像。</p><p id="9a58" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">是的，您仍然可以在Kubernetes Worker节点上安装Docker，即使它没有被kubelet用作容器运行时。在这种情况下，不需要对管道进行任何更改。</p><p id="9f11" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，请记住，这仅适用于自我管理的集群，在这种集群中，您可以完全控制工作节点。</p><p id="66f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您不想使用Docker或者您正在使用托管的Kubernetes，那么容器运行时的选择就超出了您的控制范围，该怎么办呢？</p><h1 id="8c3e" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">使用构建工具包</h1><p id="5679" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">使用<a class="ae kl" href="https://github.com/moby/buildkit" rel="noopener ugc nofollow" target="_blank"> BuildKit </a>将需要对管道Jenkinsfile做一些小的修改。</p><p id="475c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们来看一下所需的更改。</p><p id="ead8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设我们有以下渠道:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="3493" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它是真实管道的简化版本，其中所有的测试、静态代码分析和标记步骤都被删除了。因此，只剩下两个阶段:构建docker映像并将其部署到kubernetes集群。</p><p id="2cb3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了使用BuildKit，你必须用<code class="fe md me mf mg b">moby/buildkit:master</code>替换<code class="fe md me mf mg b">docker:dind</code>容器。在这种情况下，不再需要安装<code class="fe md me mf mg b">/var/run/docker.sock</code>。</p><p id="6eb3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，为了让BuildKit将您的映像推送到注册表，首先您需要为Docker配置文件创建一个新的secret(如果您的注册表需要认证)。在下面的例子中，我们假设我们正在将图像推送到Docker Hub，我们的凭证如下:用户名= <code class="fe md me mf mg b">user</code>和密码= <code class="fe md me mf mg b">password</code>。</p><p id="e5ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，将用户名/密码对编码成base64字符串。为此，请运行以下命令:</p><p id="0271" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe md me mf mg b">echo -n user:password | base64 -w 0</code>假设你在Linux上运行或者<code class="fe md me mf mg b">echo -n user:password | base64</code>在Mac上运行。复制结果字符串(<code class="fe md me mf mg b">dXNlcjpwYXNzd29yZA==</code>)并将其添加到以下json文件(config.json)的“auth”属性中:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="205c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行以下命令将config.json文件的内容转换成base64字符串:<code class="fe md me mf mg b">cat config.json | base64 -w 0</code>并将结果字符串添加到kubernetes秘密清单<code class="fe md me mf mg b">secret.yaml</code>。我们假设您的Jenkins Kubernetes插件将Jenkins名称空间用于管道容器。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="a902" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后将其应用到Kubernetes集群:<code class="fe md me mf mg b">kubectl apply -f secret.yaml</code>。</p><p id="25fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们准备修改podTemplate。它应该如下所示:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="7785" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意，我们将容器从docker重命名为buildkit，并且还删除了命令定义。</p><p id="80ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，我们将Docker的config.json中的一个秘密挂载到/root/中。docker目录，因此它将作为/root/在buildkit容器中可用。docker/config.json。</p><p id="9726" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们用以下内容替换<code class="fe md me mf mg b">Build Docker Image</code>阶段:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="550f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">差不多就是这样。</p><h1 id="f0f3" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">使用AWS ECR</h1><p id="685e" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">最后一点，万一你用AWS ECR。在这种情况下，您的Docker config.json文件会有所不同:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="69b8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此配置文件没有机密，因此可以存储为ConfigMap。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="5045" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果使用ConfigMap，podTemplate中的卷挂载应该从:<code class="fe md me mf mg b">secretVolume(secretName: 'docker-config', mountPath: '/root/.docker')</code>更改为<code class="fe md me mf mg b">configMapVolume(configMapName: 'docker-config', mountPath: '/root/.docker').</code></p><p id="51d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，在这种情况下，您需要在路径中提供ECR登录助手，这样<code class="fe md me mf mg b">Build Docker Image</code>阶段将如下所示:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="12fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有许多边缘情况，如代理或容器注册服务器后面的K8S集群使用自签名证书，需要稍微复杂一些的配置，我们将在后面讨论<a class="ae kl" href="https://medium.com/p/cb052bd7f969" rel="noopener"/>。</p></div></div>    
</body>
</html>