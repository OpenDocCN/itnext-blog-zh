<html>
<head>
<title>Migrations in Transactions with DbUp</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用DbUp在事务中迁移</h1>
<blockquote>原文：<a href="https://itnext.io/migrations-in-transactions-with-dbup-4ee0c2839c14?source=collection_archive---------5-----------------------#2020-09-07">https://itnext.io/migrations-in-transactions-with-dbup-4ee0c2839c14?source=collection_archive---------5-----------------------#2020-09-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="86a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章将继续我们对DbUp的探索，并在迁移执行中添加事务。如果您是DbUp的新手，可以看看下面的帖子来了解这个系列。</p><p id="4eed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://elanderson.net/2020/08/database-migrations-with-dbup/" rel="noopener ugc nofollow" target="_blank">使用DbUp进行数据库迁移</a> <br/> <a class="ae kl" href="https://elanderson.net/2020/08/code-based-database-migrations-with-dbup/" rel="noopener ugc nofollow" target="_blank">使用DbUp进行基于代码的数据库迁移</a> <br/> <a class="ae kl" href="https://elanderson.net/2020/08/always-run-migrations-with-dbup/" rel="noopener ugc nofollow" target="_blank">始终使用DbUp运行迁移</a> <br/> <a class="ae kl" href="https://elanderson.net/2020/08/logging-script-output-with-dbup/" rel="noopener ugc nofollow" target="_blank">使用DbUp输出日志脚本</a></p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/890c25520b5057cac99acdd86fc80b95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0zkaaPD9jOfdD8E0.jpg"/></div></div></figure><h2 id="fd02" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">交易类型和限制</h2><p id="22c5" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">DbUp有三个不同的事务选项。缺省值是no transaction，这是我们到目前为止一直使用的。其他两个选项是每次迁移一个事务，最后是在单个升级程序中对所有迁移执行一个事务。据我所知，目前还没有办法在多个升级者之间使用相同的事务，这意味着在我们的示例应用程序中，我们可以让正常的迁移正常工作并提交，但在我们始终运行的迁移中会出现问题。要记住的另一件事是，当改变数据库的结构时，一些数据库提供者不支持事务。正如DbUp文档所指出的，Postgres文档很好地总结了不同数据库提供者对DDL的事务支持。</p><h2 id="beea" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">添加交易</h2><p id="a68c" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">在下面的示例中，我们已经将升级程序更改为使用单个事务。这是升级程序的完整代码，突出显示了更改。</p><pre class="kn ko kp kq gt lw lx ly lz aw ma bi"><span id="0591" class="ky kz iq lx b gy mb mc l md me">var upgrader =<br/>    DeployChanges.To<br/>                 .SqlDatabase(connectionString)<br/>                 .WithScriptsAndCodeEmbeddedInAssembly(Assembly.GetExecutingAssembly(),<br/>                                                       f =&gt; !f.Contains(".AlwaysRun."))<br/>                 .LogToConsole()<br/>                 .WithTransaction()<br/>                 .Build();</span></pre><p id="c8aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其他选项有<strong class="jp ir">with transaction perscript</strong>用于每次迁移处理一个事务，以及<strong class="jp ir">with not transaction</strong>用于不处理任何事务(或者忽略它，因为这是默认值)。下面是两个不同的升级者进行事务处理时的输出示例，突出显示了begin事务处理。</p><pre class="kn ko kp kq gt lw lx ly lz aw ma bi"><span id="99e2" class="ky kz iq lx b gy mb mc l md me">Beginning transaction<br/>Beginning database upgrade<br/>Checking whether journal table exists..<br/>Fetching list of already executed scripts.<br/>No new scripts need to be executed - completing.<br/>Beginning transaction<br/>Beginning database upgrade<br/>Executing Database Server script 'DbupTest.Scripts.AlwaysRun.01-EverytimeNoPrints.sql'<br/>Executing Database Server script 'DbupTest.Scripts.AlwaysRun.02-EverytimeNoPrintsNoCountOn.sql'<br/>Executing Database Server script 'DbupTest.Scripts.AlwaysRun.03-EverytimePrints.sql'<br/>Executing Database Server script 'DbupTest.Scripts.AlwaysRun.04-EverytimePrintNoCountOn.sql'<br/>Upgrade successful<br/>Success!</span></pre><h2 id="9a0e" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">包扎</h2><p id="64cc" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">DbUp使得向迁移中添加事务变得非常简单，所以这是一篇非常短的文章。如果有一个跨多个升级者使用事务的选项就好了。关于交易的官方DbUp文档可以在<a class="ae kl" href="https://dbup.readthedocs.io/en/latest/more-info/transactions/" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p></div><div class="ab cl mf mg hu mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ij ik il im in"><p id="2505" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mm">原载于</em><a class="ae kl" href="https://elanderson.net/2020/09/migrations-in-transactions-with-dbup/" rel="noopener ugc nofollow" target="_blank"><em class="mm"/></a><em class="mm">。</em></p></div></div>    
</body>
</html>