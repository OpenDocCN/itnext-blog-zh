<html>
<head>
<title>Mock Kubernetes API server in Java using Fabric8 Kubernetes Mock Server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Fabric8 Kubernetes模拟服务器在Java中模拟Kubernetes API服务器</h1>
<blockquote>原文：<a href="https://itnext.io/mock-kubernetes-api-server-in-java-using-fabric8-kubernetes-mock-server-81a75cf6c47c?source=collection_archive---------1-----------------------#2020-05-17">https://itnext.io/mock-kubernetes-api-server-in-java-using-fabric8-kubernetes-mock-server-81a75cf6c47c?source=collection_archive---------1-----------------------#2020-05-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="bd49" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在处理编写Kubernetes操作符时，我们经常需要为操纵Kubernetes APIs并希望验证Kubernetes控制器的行为的场景编写测试。每次在Kubernetes集群上运行您的测试都是非常乏味和耗费资源的。<a class="ae kl" href="https://github.com/fabric8io/kubernetes-client" rel="noopener ugc nofollow" target="_blank"> Fabric8 Kubernetes Client </a>为我们提供了一个扩展，您可以用它来模仿Kubernetes API服务器并完成您的工作。在这篇博客中，我将向你概述使用<a class="ae kl" href="https://github.com/fabric8io/kubernetes-client/tree/master/kubernetes-server-mock" rel="noopener ugc nofollow" target="_blank"> Fabric8 Kubernetes模拟服务器</a>为你的Kubernetes控制器模拟和编写测试。这是一个基于<a class="ae kl" href="https://github.com/fabric8io/kubernetes-client" rel="noopener ugc nofollow" target="_blank">fabric 8 Kubernetes Client</a>和<a class="ae kl" href="https://github.com/fabric8io/mockwebserver" rel="noopener ugc nofollow" target="_blank">fabric 8 mock web server</a>(ok http的mockwebserver 的扩展)的库，为我们提供了平滑的模拟操作dsl。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/6f8fc6c970d4c4727c35fbb5b811bc63.png" data-original-src="https://miro.medium.com/v2/resize:fit:512/format:webp/1*-58gIpXpeckgKtH8jJPUfA.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Fabric8 Kubenetes Java库</figcaption></figure><div class="ky kz gp gr la lb"><a href="https://github.com/fabric8io/kubernetes-client" rel="noopener  ugc nofollow" target="_blank"><div class="lc ab fo"><div class="ld ab le cl cj lf"><h2 class="bd ir gy z fp lg fr fs lh fu fw ip bi translated">fabric 8 io/kubernetes-客户端</h2><div class="li l"><h3 class="bd b gy z fp lg fr fs lh fu fw dk translated">这个客户端通过一个流畅的DSL提供对完整的Kubernetes和OpenShift REST APIs的访问。</h3></div><div class="lj l"><p class="bd b dl z fp lg fr fs lh fu fw dk translated">github.com</p></div></div><div class="lk l"><div class="ll l lm ln lo lk lp ks lb"/></div></div></a></div><h2 id="6146" class="lq lr iq bd ls lt lu dn lv lw lx dp ly jy lz ma mb kc mc md me kg mf mg mh mi bi translated">在项目中安装Fabric8 Kubernetes模拟服务器:</h2><p id="b559" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">您可以将Fabric8 Kubernetes模拟服务器作为依赖项添加到您的项目中:</p><pre class="kn ko kp kq gt ms mr mt mu aw mv bi"><span id="9ea0" class="lq lr iq mr b gy mw mx l my mz">&lt;<strong class="mr ir">dependency</strong>&gt;<br/>    &lt;<strong class="mr ir">groupId</strong>&gt;io.fabric8&lt;/<strong class="mr ir">groupId</strong>&gt;<br/>    &lt;<strong class="mr ir">artifactId</strong>&gt;kubernetes-server-mock&lt;/<strong class="mr ir">artifactId</strong>&gt;<br/>    &lt;<strong class="mr ir">version</strong>&gt;${kubernetes-server-mock.version}&lt;/<strong class="mr ir">version</strong>&gt;<br/>&lt;/<strong class="mr ir">dependency</strong>&gt;</span></pre><p id="f56f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦作为依赖项添加，您就可以开始在测试中使用Kubernetes mockwebserver了。下面是如何初始化Kubernetes mockserver:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="na nb l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">正在初始化Kubernetes模拟web服务器</figcaption></figure><p id="13a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它有两个选项:第一个是检查<code class="fe mo mp mq mr b">Https</code>是否应该启用，第二个是<code class="fe mo mp mq mr b">CRUD</code>模式是否应该启用。默认情况下，它用<code class="fe mo mp mq mr b">https=true</code>和<code class="fe mo mp mq mr b">crudMode=false</code>初始化，就像上面的场景一样。</p><p id="6320" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们已经初始化了<code class="fe mo mp mq mr b">KubernetesServer</code>，让我们开始模拟一个简单的场景，列出所有名称空间中的所有<code class="fe mo mp mq mr b">Pod</code>对象。这就是使用Fabric8 Kubernetes Mockserver实现这一目标的方法:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="na nb l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">嘲讽列表窗格中的所有名称空间，<strong class="ak">参见</strong> <a class="ae kl" href="https://github.com/r0haaaan/kubernetes-mockserver-demo/blob/master/src/test/java/io/fabric8/demo/kubernetes/mockserver/PodMockTest.java#L24-L44" rel="noopener ugc nofollow" target="_blank"> <strong class="ak"> Github </strong> </a>中的代码</figcaption></figure><p id="2e39" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您想稍微改变一下，模拟Kubernetes API服务器调用来列出某个名称空间中的所有pod(比如<code class="fe mo mp mq mr b">default</code>)。你可以这样做:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="na nb l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">在默认名称空间中列出窗格，<strong class="ak">参见</strong> <a class="ae kl" href="https://github.com/r0haaaan/kubernetes-mockserver-demo/blob/master/src/test/java/io/fabric8/demo/kubernetes/mockserver/PodMockTest.java#L47-L61" rel="noopener ugc nofollow" target="_blank"> <strong class="ak"> Github </strong> </a>中的代码</figcaption></figure><p id="5c40" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用Kubernetes mockserver，您可以模拟所有涉及<code class="fe mo mp mq mr b">GET</code>、<code class="fe mo mp mq mr b">POST</code>、<code class="fe mo mp mq mr b">UPDATE</code>、<code class="fe mo mp mq mr b">DELETE</code>调用的操作。下面是一个创建更新然后删除<code class="fe mo mp mq mr b">Deployment</code>对象的简单例子:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="na nb l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><strong class="ak">嘲讽创建、更新和删除操作，参见</strong> <a class="ae kl" href="https://github.com/r0haaaan/kubernetes-mockserver-demo/blob/master/src/test/java/io/fabric8/demo/kubernetes/mockserver/DeploymentMockTest.java" rel="noopener ugc nofollow" target="_blank"> <strong class="ak"> Github </strong> </a>中的代码</figcaption></figure><h2 id="18b5" class="lq lr iq bd ls lt lu dn lv lw lx dp ly jy lz ma mb kc mc md me kg mf mg mh mi bi translated">模拟自定义资源的API响应:</h2><p id="d26e" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">模仿定制资源的API响应与模仿常规API对象没有什么不同。下面是一个Kubernetes官方文档中提到的对定制资源的嘲讽响应的例子:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="na nb l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><strong class="ak">模拟自定义资源的基本列表操作，参见</strong> <a class="ae kl" href="https://github.com/r0haaaan/kubernetes-mockserver-demo/blob/master/src/test/java/io/fabric8/demo/kubernetes/mockserver/CustomResourceMockTest.java#L38-L57" rel="noopener ugc nofollow" target="_blank"> <strong class="ak"> Github </strong> </a>中的代码</figcaption></figure><p id="223b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您还可以通过模拟协议何时应该升级到websocket以及应该在何时发出什么事件来模拟稍微复杂的操作，如watch。您需要向KubernetesDeserializer注册您的CustomResource，以便能够在类型化API中进行监视。这里有一个监视<code class="fe mo mp mq mr b">CronTab</code>定制资源的小例子:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="na nb l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><strong class="ak">自定义资源的嘲讽观察操作，参见</strong> <a class="ae kl" href="https://github.com/r0haaaan/kubernetes-mockserver-demo/blob/master/src/test/java/io/fabric8/demo/kubernetes/mockserver/CustomResourceMockTest.java#L59-L100" rel="noopener ugc nofollow" target="_blank"> <strong class="ak"> Github </strong> </a>中的代码</figcaption></figure><p id="6b5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Mockserver还提供了一种<code class="fe mo mp mq mr b">CRUD</code>模式，在这种模式下，您不必提供任何期望；它的行为就像一个普通的Kubernetes API服务器，并将对象保存在它的临时存储器中。以下是在启用<code class="fe mo mp mq mr b">CRUD</code>模式的情况下，如何执行上述列表操作:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="na nb l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">使用CRUD模式模仿Kubernetes API服务器，<strong class="ak">参见</strong> <a class="ae kl" href="https://github.com/r0haaaan/kubernetes-mockserver-demo/blob/master/src/test/java/io/fabric8/demo/kubernetes/mockserver/CustomResourceCrudMockTest.java" rel="noopener ugc nofollow" target="_blank"> <strong class="ak"> Github </strong> </a>中的代码</figcaption></figure><h2 id="764e" class="lq lr iq bd ls lt lu dn lv lw lx dp ly jy lz ma mb kc mc md me kg mf mg mh mi bi translated">为一个非常基本的Kubernetes操作符编写测试:</h2><p id="fc76" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">最后，让我们为一个非常基本的Kubernetes操作符编写一个测试，它将利用Mockserver来模拟真实的Kubernetes API服务器的响应。</p><p id="80b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将为一个简单的操作符编写测试，该操作符克隆了名称空间中的每个新的<code class="fe mo mp mq mr b">Pod</code>-<a class="ae kl" href="https://github.com/r0haaaan/kubernetes-mockserver-demo/blob/master/src/main/java/io/fabric8/demo/controller/PodCloneController.java" rel="noopener ugc nofollow" target="_blank">PodCloneController</a>。它的代码在这个博客的演示库中。请参见下图，以便更好地理解该操作员会怎么做:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nc"><img src="../Images/2d53969e3d805e552fd54b8dc5613808.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oeef_JkYVUB0dh178cCSrA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">PodClone控制器将为每个pod创建一个克隆pod</figcaption></figure><p id="eae1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，为了编写这个操作符的测试，我们可以编写某种测试来断言<code class="fe mo mp mq mr b">reconcile()</code>方法的逻辑。在我们的例子中，它只是检查操作员是否能够根据传递的参数创建克隆pod。下面是它的样子:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="na nb l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">测试协调()。<strong class="ak">参见</strong> <a class="ae kl" href="https://github.com/r0haaaan/kubernetes-mockserver-demo/blob/master/src/test/java/io/fabric8/demo/controller/PodCloneControllerTest.java" rel="noopener ugc nofollow" target="_blank"> <strong class="ak"> Github </strong> </a>中的代码</figcaption></figure><p id="39ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意，我们只测试了控制器的一部分(最关键的一部分)。我们也可以为操作符的其他组件做类似的事情。如果所有的功能组件都被适当地分离，我们也可以为它们创建测试。</p><p id="0bed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">今天关于Kubernetes MockServer的博客到此结束。与今天的博客相关的所有代码都可以在这个资源库中找到:</p><div class="ky kz gp gr la lb"><a href="https://github.com/r0haaaan/kubernetes-mockserver-demo" rel="noopener  ugc nofollow" target="_blank"><div class="lc ab fo"><div class="ld ab le cl cj lf"><h2 class="bd ir gy z fp lg fr fs lh fu fw ip bi translated">r0haaaan/kubernetes-mock server-demo</h2><div class="li l"><h3 class="bd b gy z fp lg fr fs lh fu fw dk translated">Fabric8 Kubernetes MockServer的演示项目。通过…为r0haaaan/kubernetes-mock server-demo开发做出贡献</h3></div><div class="lj l"><p class="bd b dl z fp lg fr fs lh fu fw dk translated">github.com</p></div></div><div class="lk l"><div class="nh l lm ln lo lk lp ks lb"/></div></div></a></div><p id="aad8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请试用Fabric8 Kubernetes客户端，如果您喜欢我们的库，请通过传播消息和🌟美国在<a class="ae kl" href="https://github.com/fabric8io/kubernetes-client" rel="noopener ugc nofollow" target="_blank"> Github </a>上。</p></div></div>    
</body>
</html>