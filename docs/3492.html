<html>
<head>
<title>Dynamic Vault Secrets — Agent Sidecar on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">动态保险库秘密Kubernetes上的代理边车</h1>
<blockquote>原文：<a href="https://itnext.io/dynamic-vault-secrets-agent-sidecar-on-kubernetes-cc0ce3e54a94?source=collection_archive---------3-----------------------#2019-12-26">https://itnext.io/dynamic-vault-secrets-agent-sidecar-on-kubernetes-cc0ce3e54a94?source=collection_archive---------3-----------------------#2019-12-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/fb7bb69ee9a654a27b33dbe4bc47a9d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dAdzAkGdXF9-ES_No5iyuA.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">通过边车把保险库的秘密注入到库本内特的豆荚里</figcaption></figure><div class=""/><p id="7ab5" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Kubernetes具有内置的机密功能，使用户能够存储和管理敏感信息，这方面有一些明显的缺点，最明显的是它们在默认情况下没有加密，系统中没有内置旋转或撤销的概念，也没有跨集群存储和分发机密的概念。Vault作为一个秘密管理工具，可以通过以各种配置直接在Kubernetes上运行来解决所有这些问题。对于纯Kubernetes工作负载，这使得Vault也可以完全存在于Kubernetes中。</p><p id="ded3" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Vault已经为Kubernetes提供了强大的内置支持，并且可以使用Kubernetes APIs来验证在集群上运行的应用程序的身份，Vault预先配置为与Kubernetes进行对话，使用允许其使用令牌审阅者角色的凭据，并验证由应用程序pod提供的JWT (JSON Web令牌)。Vault使用来自服务帐户的JWT来验证自身并请求命名角色。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi la"><img src="../Images/21b0f5de1ba3da9846de0dadc313580f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0vY1SFpR7vSyC948"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">跳马-库伯内特斯</figcaption></figure><p id="685b" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">应用程序中提供的JWT包含信息服务帐户名称和应用程序窗格的命名空间名称。Vault会验证JWT是否有效，以及请求的角色是否配置为允许访问服务帐户名和命名空间名。然后，Vault返回一个访问令牌，应用程序可以使用该令牌通过一个或多个策略请求该角色允许的机密。</p><p id="53fa" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这种方法要求用户将Vault逻辑添加到应用程序代码中。新的<a class="ae lf" href="https://www.vaultproject.io/docs/platform/k8s/injector/index.html" rel="noopener ugc nofollow" target="_blank"> vault-k8s </a>利用Kubernetes <a class="ae lf" href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/" rel="noopener ugc nofollow" target="_blank">变异许可Webhook </a>来拦截和增强专门注释的pod配置，以便使用Init和Sidecar容器进行机密注入，这使得没有内置本机HashiCorp vault逻辑的应用程序能够利用来自Vault的静态和动态机密。</p><p id="493f" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Kubernetes提供了许多扩展其内置功能的方法。除了经常使用的扩展点:定制资源类型和定制控制器之外，准入控制器是强大的Kubernetes-native特性，便于用户定义和定制允许在集群上运行的内容。准入控制器在对象持久化之前，但在请求被认证和授权之后，拦截并处理对Kubernetes API的请求。</p><p id="b605" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在创造资源之前进行技术变异。一个典型的例子是Istio，它将一个Envoy sidecar容器注入到target pods来实现流量管理和策略执行。Vault-K8s使用一个变异的webhook准入控制器来启用一种边斗方法，该方法将秘密直接注入到Kubernetes pod中。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi lg"><img src="../Images/de77a532220c847e40e05a5b91f62851.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IlQKiWsasj0IJBhd"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">跳马-k8s-边车-变异入场网钩</figcaption></figure><p id="c6fe" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">使用保险库-试剂边车注射器，试剂容器被注入到由特定注释指示的Kubernetes容器中(vault.hashicorp.com/agent-inject:“正确”)。Vault-k8s webhook截取带有基于Vault的注释的pod，并包括一个Init容器来预填充机密，以及一个Vault Agent Sidecar来在应用程序的整个生命周期中保持机密数据同步。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi lh"><img src="../Images/3d6fe16405fbe1c4632c914ab8af0552.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ULSfLBO3QG65p2f8"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Vault-K8s —代理边车注射模型</figcaption></figure><h1 id="d2e3" class="li lj jf bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">机密注入工作流</h1><p id="494f" class="pw-post-body-paragraph kc kd jf ke b kf mg kh ki kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ij bi translated">除了Vault服务器部署之外，这种新方法还添加了一个Vault代理注入器。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ml"><img src="../Images/5aecca971f8aae9d221664f0e983bd8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lY2XjB0uzl3HAjdP"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">库贝内特斯的K8s跳马</figcaption></figure><h2 id="4cb5" class="mm lj jf bd lk mn mo dn lo mp mq dp ls kn mr ms lw kr mt mu ma kv mv mw me mx bi translated">Vault服务器:</h2><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi lh"><img src="../Images/4a4f7df25b4e024dc8e800211ef96e43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*m_BFrhOHumbGQljd"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Vault服务器</figcaption></figure><h2 id="d6d0" class="mm lj jf bd lk mn mo dn lo mp mq dp ls kn mr ms lw kr mt mu ma kv mv mw me mx bi translated">保险库边车药剂注射器:</h2><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi lh"><img src="../Images/2c2ff3129d36317dc95c74c9427e51e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NWF3IBGIkjlZgR1h"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">存储库代理-边车注射器</figcaption></figure><h2 id="ae2b" class="mm lj jf bd lk mn mo dn lo mp mq dp ls kn mr ms lw kr mt mu ma kv mv mw me mx bi translated">存储库代理注入器逻辑:</h2><figure class="lb lc ld le gt is gh gi paragraph-image"><div class="gh gi my"><img src="../Images/e23d2e1cd63295a22d3ed74c62d19294.png" data-original-src="https://miro.medium.com/v2/resize:fit:1368/0*pLZS2FpI4tOouTiK"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">存储库代理边车-边车注入逻辑</figcaption></figure><h2 id="133f" class="mm lj jf bd lk mn mo dn lo mp mq dp ls kn mr ms lw kr mt mu ma kv mv mw me mx bi translated">在Vault服务器上配置策略和验证方法:</h2><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi lh"><img src="../Images/9d64ce1edc6301728e28a0160c0fd315.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bknZ23YTfx42lQP2"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Vault服务器-策略</figcaption></figure><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi lh"><img src="../Images/41835a94e89061b214fd34018406734f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fVxfZRJgucMbqzZ5"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Vault服务器-验证方法</figcaption></figure><p id="3c5f" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">部署了一个示例应用程序，并关联了一个服务帐户，但没有特定于vault的注释。此应用程序是一个简单的web服务器，其中没有包含机密管理/保险库信息的特定应用程序代码:</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/882c9f029a66e89edb701be7762dd4b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*u_T8DrW52ZS46wS7"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Kubernetes部署示例</figcaption></figure><figure class="lb lc ld le gt is gh gi paragraph-image"><div class="gh gi na"><img src="../Images/40728220fcc49c79d7d805e4af828670.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*mrrqHFPXbhwVlwVO"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">示例应用程序—不带注释</figcaption></figure><p id="2cda" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如上所述，除了服务帐户，没有额外的挂载。</p><p id="44db" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">通过注释pod规范，在部署上启用了存储库代理注入。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nb"><img src="../Images/7023ce8c60473baeddc4499442efe388.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rx-INnypCW2l_2db"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">拱顶-边车注射器-注释</figcaption></figure><p id="f5bc" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Vault-K8s webhook截获pod规范中的更改，Vault agent injector收到一个向pod添加init容器和sidecar代理容器的请求。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/548b8ff55e821daed74a7c84ea0922af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Zx5AhuDT7MZ-vufo"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">保险库代理边车注射器</figcaption></figure><p id="5af5" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">init容器通过添加包含实际秘密的额外挂载(/vault/secrets/)来填充秘密。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nd"><img src="../Images/16bf1243afed5dd0ecb41d7e25c674ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JAW1cHqUypOVI9br"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">保险库机密装载</figcaption></figure><p id="7c01" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">应用程序旁边的额外代理容器被添加到pod，并且在特定间隔建立入站连接，以保持机密信息与Vault服务器同步。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ne"><img src="../Images/937ac6dfbe51e5d1a7d90fba8cee5ba9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ybi6x52ccv4GgZmC"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">保险库代理侧柜容器</figcaption></figure><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nf"><img src="../Images/bd13b96b0905d4c7007baee8682c4f81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Zn4lUYibEYHQXQtz"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Vault代理-Vault服务器-机密同步</figcaption></figure><p id="31ed" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">通过上述步骤，应用程序现在将挂载一个密码(tmpfs: /vault/secrets ),而无需在应用程序逻辑中进行任何特定的vault配置。应用程序可以从文件系统路径直接访问所需格式的秘密。</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ng"><img src="../Images/48d25f1e6d51bb6f45a49cba3c5a07e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*p21AtWGsI8STZHC0"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">保险库秘密安装在Kubernetes Pod上—保险库边车—秘密安装</figcaption></figure><p id="db76" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">不同的特定于应用程序的秘密需要特定的格式。要控制格式以便应用程序可以以本机格式读取它，可以使用注释“vault . hashi corp . com/Agent-inject-Template-[filename]”来定义自定义模板，该模板使用Vault代理模板功能，允许使用Consul模板标记(Go Template)将Vault机密渲染到文件中。例如，Postgres需要秘密格式:“PostgreSQL://user:pass @ Postgres:5432/wizard”，可以使用下面的批注对其进行格式化:</p><figure class="lb lc ld le gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nh"><img src="../Images/def492649daa494b7f68074bf5e10cde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lHy-JLZ3ZMoBtS5l"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">存储库代理模板</figcaption></figure><p id="3e7a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi">__________________________________________________________</p><p id="d3c3" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">从历史上看，秘密管理一直是一个非常复杂的过程，无意中引入安全问题太容易了。Vault使这个过程变得更简单，而且这种集成使用户能够在Kubernetes上开发应用程序，而不需要任何额外的秘密管理逻辑。机密在文件系统路径下自动对应用程序可用，并且不需要内置本机Vault逻辑。</p></div></div>    
</body>
</html>