<html>
<head>
<title>Routing external traffic into your Kubernetes services (Part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将外部流量路由到您的Kubernetes服务(第2部分)</h1>
<blockquote>原文：<a href="https://itnext.io/routing-external-traffic-into-your-kubernetes-services-part-2-7d1289178671?source=collection_archive---------3-----------------------#2019-06-28">https://itnext.io/routing-external-traffic-into-your-kubernetes-services-part-2-7d1289178671?source=collection_archive---------3-----------------------#2019-06-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/5d0b8fb8a8b592ccd73e014b2ec449ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1366/format:webp/1*m8IBzfGRINZvHUVYzpJUgg.png"/></div></figure><p id="92a9" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在本文的第1部分中，我解释了将外部流量路由到Kubernetes集群的三种可能方式。在那里，我向您展示了将ClusterIP作为应用程序的服务类型的好处。现在，我将向您展示如何使用Nginx代理将流量路由到CuslterIP服务。</p><p id="aa04" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">让我们使用helm图表在您的Kubernetes集群中部署以下部署。如果你不熟悉helm，请在阅读本文其余部分之前参考这个<a class="ae kv" href="https://medium.com/@madeeshafernando/deploying-to-kubernetes-using-helm-313af95eadf2" rel="noopener">博客</a>。</p><figure class="kx ky kz la gt ju gh gi paragraph-image"><div class="gh gi kw"><img src="../Images/fe5dd6f3999a436f30f47af88580ee22.png" data-original-src="https://miro.medium.com/v2/resize:fit:896/format:webp/1*POpfR5CwPPlY_ZsZou5fuw.png"/></div></figure><p id="93c1" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">Helm是Kubernetes的包管理器，它允许您使用一个“helm install”命令来部署上述部署。</p><p id="6ed7" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在执行以下步骤之前，请确保您已经拥有从您的机器对k8s集群的“kubectl”访问权限，并在其中安装helm。然后，您可以执行以下步骤，</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="baf9" class="lg lh it lc b gy li lj l lk ll">1. git clone <a class="ae kv" href="https://github.com/madeesha/helm-charts.git" rel="noopener ugc nofollow" target="_blank">https://github.com/madeesha/helm-charts.git</a></span><span id="a13c" class="lg lh it lc b gy lm lj l lk ll">2. cd helm-charts/</span><span id="5690" class="lg lh it lc b gy lm lj l lk ll">3. helm init</span><span id="306f" class="lg lh it lc b gy lm lj l lk ll">4. helm install --name my-kube-deployment .</span></pre><p id="75e7" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">如果部署成功，您将能够在终端中看到下面的输出。</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="a7a8" class="lg lh it lc b gy li lj l lk ll">NAME: my-kube-deployment<br/>LAST DEPLOYED: Fri Jun 28 14:25:12 2019<br/>NAMESPACE: default<br/>STATUS: <strong class="lc iu">DEPLOYED<br/>........................</strong></span></pre><blockquote class="ln lo lp"><p id="df3f" class="jx jy lq jz b ka kb kc kd ke kf kg kh lr kj kk kl ls kn ko kp lt kr ks kt ku im bi translated"><strong class="jz iu">注意:</strong>如果你在运行helm init命令时遇到以下错误，请使用<a class="ae kv" href="https://medium.com/@madeeshafernando/error-release-name-failed-namespaces-default-is-forbidden-user-99b3b6cb2720" rel="noopener">博客</a>中提到的步骤来修复。</p><p id="8736" class="jx jy lq jz b ka kb kc kd ke kf kg kh lr kj kk kl ls kn ko kp lt kr ks kt ku im bi translated">"错误:释放nginx-ingress失败:命名空间" default "被禁止:用户" system:service account:kube-system:default "无法在命名空间" default "中的API组""中获取资源" namespaces " "</p></blockquote><p id="50a5" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">现在，您已经使用<a class="ae kv" href="https://github.com/madeesha/helm-charts.git" rel="noopener ugc nofollow" target="_blank">舵图</a>在k8s集群中成功创建了以下资源，</p><figure class="kx ky kz la gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lu"><img src="../Images/f31937eb49f74b04b1d22371f270537f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UTkXKOsGiZ9DwlRUt4NxfQ.png"/></div></div></figure><p id="b5f1" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这里我们只将Nginx服务公开为负载平衡器服务类型，而Hello-world应用程序公开为ClusterIP服务。我们现在将从Nginx访问这个ClusterIP服务。同样，我们可以使用ClusterIP服务类型公开集群中的多个应用程序，并使用相同的Nginx主机名访问它们。一旦你浏览了helm repo<a class="ae kv" href="https://github.com/madeesha/helm-charts.git" rel="noopener ugc nofollow" target="_blank">https://github.com/madeesha/helm-charts.git</a>中的所有YAML模板文件，你就可以对部署有一个清晰的想法。让我们看看如何从web浏览器访问上面的hello-world应用程序。</p><p id="2fb2" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">如果使用“kubectl get svc”命令检查集群中部署的服务，可以看到下面的输出。</p><figure class="kx ky kz la gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lz"><img src="../Images/a0c5306b41b86d20f245b38461bfbcee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xqcsmDuc582I-Qtu1-FGKw.png"/></div></div></figure><p id="2d91" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">如上所示,“my-kube-deployment-my-app-service”的服务类型是ClusterIP。现在，我们将通过Nginx负载平衡器来访问这个ClusterIP服务，我们已经使用helm创建了这个负载平衡器。因为正如我在本系列的第1部分中提到的，如果没有代理，就不能从web浏览器直接访问ClusterIP服务。在这种情况下，我们的代理是Nginx负载平衡器。</p><p id="3984" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">执行下面的命令来获得你的Nginx负载平衡器的主机名。因为我们将从这个Nginx主机名访问我们所有的Kubernetes服务。</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="1590" class="lg lh it lc b gy li lj l lk ll">kubectl get svc my-kube-deployment-my-app-nginx-controller -o yaml</span></pre><p id="6a5b" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这将给出如下带有nginx-hostname的输出，(注意，这里我使用AWS作为我的云提供商，因为当公开nginx-service作为负载平衡器服务类型时，它已经创建了一个AWS ELB)</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="4f3e" class="lg lh it lc b gy li lj l lk ll">............<br/>status:<br/>  loadBalancer:<br/>    ingress:<br/>    - hostname: <strong class="lc iu">a709a4984998211e9b3780a6f8db7040-700681555.us-west-2.elb.amazonaws.com</strong></span></pre><p id="06b4" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">现在，您可以在您最喜欢的浏览器中使用此URL来访问我们的hello-world应用程序，它会在您的浏览器中给出以下输出。</p><figure class="kx ky kz la gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ma"><img src="../Images/57e35f56f2c6ad909d12d4bb8b210a14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RFtoNp40Only_EtfUc8K6A.png"/></div></div></figure><p id="9629" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">现在，您可以尝试对Nginx入口控制器进行相关的配置更改，以访问Kubernetes集群中的多个应用程序。</p><p id="2d9b" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">干杯！！！</p></div></div>    
</body>
</html>