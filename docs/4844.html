<html>
<head>
<title>Building ML Componentes on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Kubernetes上构建ML组件</h1>
<blockquote>原文：<a href="https://itnext.io/building-ml-componentes-on-kubernetes-fc7e24cb9269?source=collection_archive---------2-----------------------#2020-10-04">https://itnext.io/building-ml-componentes-on-kubernetes-fc7e24cb9269?source=collection_archive---------2-----------------------#2020-10-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="8740" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你好！</p><p id="42b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<a class="ae kl" href="https://kona.tech" rel="noopener ugc nofollow" target="_blank"> KONA </a>这里，我们建造的一切都是一个组件，这个概念改变了我们、我们的工作方式和我们的产品策略！</p><p id="1536" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">每当我们讨论产品特性或新产品时，我们首先会想到我们需要什么，以及我们可以从目录中重复使用哪些组件。</p><h1 id="5b73" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">我们如何做到这一点</h1><p id="afb5" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">每个项目或功能都从Jupyter笔记本或直接从python代码开始，无论哪种方式，我们都可以将其打包成一个组件(Pod)并部署到我们的集群中进行培训和服务。</p><p id="025b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设最复杂的场景(从Jupyter开始)，我们可以把笔记本放在左边，然后是整流罩、火车和服务的构建过程。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/ba8554fb1cfb90a3f70698e4435736a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8RgVkoJY9Z5sXNfS.png"/></div></div></figure><p id="daad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kubeflow整流罩简化了在Kubernetes中构建、培训和部署机器学习(ML)培训工作的流程。通过使用光顺并添加一些代码行，您可以直接从Python代码或Jupyter笔记本在本地或云中运行ML训练作业。训练工作完成后，您可以使用kube flow strength将训练好的模型部署为预测端点。</p><p id="71df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，您从一个想法开始，在笔记本电脑上进行测试，并部署到Kubernetes上的可扩展集群，实现自动扩展。</p><h1 id="7e02" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">步伐</h1><p id="ff6e" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">打开木星笔记本。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi mb"><img src="../Images/c83897f7dfec590281a861fb260c9497.png" data-original-src="https://miro.medium.com/v2/resize:fit:1156/format:webp/1*sCQpKZCnAotvrUfDtK7W9w.png"/></div></figure><p id="e10e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击新建-&gt;终端并安装整流罩。</p><pre class="lq lr ls lt gt mc md me mf aw mg bi"><span id="f3d4" class="mh kn iq md b gy mi mj l mk ml">git clone <a class="ae kl" href="https://github.com/kubeflow/fairing" rel="noopener ugc nofollow" target="_blank">https://github.com/kubeflow/fairing</a><br/>cd fairing/examples/prediction<br/>pip3 install -r requirements.txt</span></pre><p id="a566" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们可以看到整流罩目录。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/c0bfd27d5f5d5ab48a4d1b3354b5c966.png" data-original-src="https://miro.medium.com/v2/resize:fit:1064/format:webp/1*fr7TCCLJkKm7TWHBdZiaNA.png"/></div></figure><p id="f17c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一些注意事项:</p><ul class=""><li id="aeb7" class="mn mo iq jp b jq jr ju jv jy mp kc mq kg mr kk ms mt mu mv bi translated">要执行小型测试，请使用笔记本电脑服务器进行训练，使用少量数据</li><li id="cb72" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk ms mt mu mv bi translated">当笔记本电脑准备好进行大型测试或生产时，切换到那里(在群集上)进行测试和培训</li></ul><p id="3d17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">房屋预测示例:</p><ul class=""><li id="3254" class="mn mo iq jp b jq jr ju jv jy mp kc mq kg mr kk ms mt mu mv bi translated">在本地笔记本中训练XGBoost模型，</li><li id="2822" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk ms mt mu mv bi translated">使用光顺远程训练模型</li><li id="234b" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk ms mt mu mv bi translated">使用整流罩将训练好的模型部署到Kubeflow</li></ul><h1 id="9e54" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">设置笔记本</h1><pre class="lq lr ls lt gt mc md me mf aw mg bi"><span id="3b1b" class="mh kn iq md b gy mi mj l mk ml">!pip install --user -r requirements.txt</span><span id="c148" class="mh kn iq md b gy nb mj l mk ml"><strong class="md ir">import</strong> <strong class="md ir">argparse</strong><br/><strong class="md ir">import</strong> <strong class="md ir">logging</strong><br/><strong class="md ir">import</strong> <strong class="md ir">joblib</strong><br/><strong class="md ir">import</strong> <strong class="md ir">sys</strong><br/><strong class="md ir">import</strong> <strong class="md ir">pandas</strong> <strong class="md ir">as</strong> <strong class="md ir">pd</strong><br/><strong class="md ir">from</strong> <strong class="md ir">sklearn.metrics</strong> <strong class="md ir">import</strong> mean_absolute_error<br/><strong class="md ir">from</strong> <strong class="md ir">sklearn.model_selection</strong> <strong class="md ir">import</strong> train_test_split<br/><strong class="md ir">from</strong> <strong class="md ir">sklearn.impute</strong> <strong class="md ir">import</strong> SimpleImputer<br/><strong class="md ir">from</strong> <strong class="md ir">xgboost</strong> <strong class="md ir">import</strong> XGBRegressor</span></pre><p id="48ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">定义一个函数来分割培训文件</p><pre class="lq lr ls lt gt mc md me mf aw mg bi"><span id="74f2" class="mh kn iq md b gy mi mj l mk ml"><strong class="md ir">def</strong> read_input(file_name, test_size=0.25):<br/>    <em class="nc">"""Read input data and split it into train and test."""</em><br/>    data = pd.read_csv(file_name)<br/>    data.dropna(axis=0, subset=['SalePrice'], inplace=<strong class="md ir">True</strong>)<br/><br/>    y = data.SalePrice<br/>    X = data.drop(['SalePrice'], axis=1).select_dtypes(exclude=['object'])<br/><br/>    train_X, test_X, train_y, test_y = train_test_split(X.values,<br/>                                                      y.values,<br/>                                                      test_size=test_size,<br/>                                                      shuffle=<strong class="md ir">False</strong>)<br/><br/>    imputer = SimpleImputer()<br/>    train_X = imputer.fit_transform(train_X)<br/>    test_X = imputer.transform(test_X)<br/><br/>    <strong class="md ir">return</strong> (train_X, train_y), (test_X, test_y)</span></pre><p id="3749" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">定义执行培训和评估的功能</p><pre class="lq lr ls lt gt mc md me mf aw mg bi"><span id="1cb6" class="mh kn iq md b gy mi mj l mk ml"><strong class="md ir">def</strong> train_model(train_X,<br/>                train_y,<br/>                test_X,<br/>                test_y,<br/>                n_estimators,<br/>                learning_rate):<br/>    <em class="nc">"""Train the model using XGBRegressor."""</em><br/>    model = XGBRegressor(n_estimators=n_estimators, learning_rate=learning_rate)<br/><br/>    model.fit(train_X,<br/>            train_y,<br/>            early_stopping_rounds=40,<br/>            eval_set=[(test_X, test_y)])<br/><br/>    print("Best RMSE on eval: <strong class="md ir">%.2f</strong> with <strong class="md ir">%d</strong> rounds" %<br/>               (model.best_score,<br/>                model.best_iteration+1))<br/>    <strong class="md ir">return</strong> model<br/><br/><strong class="md ir">def</strong> eval_model(model, test_X, test_y):<br/>    <em class="nc">"""Evaluate the model performance."""</em><br/>    predictions = model.predict(test_X)<br/>    logging.info("mean_absolute_error=<strong class="md ir">%.2f</strong>", mean_absolute_error(predictions, test_y))<br/><br/><strong class="md ir">def</strong> save_model(model, model_file):<br/>    <em class="nc">"""Save XGBoost model for serving."""</em><br/>    joblib.dump(model, model_file)<br/>    logging.info("Model export success: <strong class="md ir">%s</strong>", model_file)</span></pre><p id="d5e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">定义类别</p><pre class="lq lr ls lt gt mc md me mf aw mg bi"><span id="8810" class="mh kn iq md b gy mi mj l mk ml"><strong class="md ir">class</strong> <strong class="md ir">HousingServe</strong>(object):<br/>    <br/>    <strong class="md ir">def</strong> __init__(self):<br/>        self.train_input = "ames_dataset/train.csv"<br/>        self.n_estimators = 50<br/>        self.learning_rate = 0.1<br/>        self.model_file = "trained_ames_model.dat"<br/>        self.model = <strong class="md ir">None</strong><br/><br/>    <strong class="md ir">def</strong> train(self):<br/>        (train_X, train_y), (test_X, test_y) = read_input(self.train_input)<br/>        model = train_model(train_X,<br/>                          train_y,<br/>                          test_X,<br/>                          test_y,<br/>                          self.n_estimators,<br/>                          self.learning_rate)<br/><br/>        eval_model(model, test_X, test_y)<br/>        save_model(model, self.model_file)<br/><br/>    <strong class="md ir">def</strong> predict(self, X, feature_names=<strong class="md ir">None</strong>):<br/>        <em class="nc">"""Predict using the model for given ndarray."""</em><br/>        <strong class="md ir">if</strong> <strong class="md ir">not</strong> self.model:<br/>            self.model = joblib.load(self.model_file)<br/>        <em class="nc"># Do any preprocessing</em><br/>        prediction = self.model.predict(data=X)<br/>        <em class="nc"># Do any postprocessing</em><br/>        <strong class="md ir">return</strong> prediction</span></pre><p id="712a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">火车</p><pre class="lq lr ls lt gt mc md me mf aw mg bi"><span id="efbc" class="mh kn iq md b gy mi mj l mk ml">HousingServe().train()</span></pre><p id="525a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里，培训是在笔记本上进行的。</p><h1 id="ba5e" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">设置Kubeflow整流罩</h1><pre class="lq lr ls lt gt mc md me mf aw mg bi"><span id="43b4" class="mh kn iq md b gy mi mj l mk ml"><strong class="md ir">from</strong> <strong class="md ir">kubeflow</strong> <strong class="md ir">import</strong> fairing</span><span id="5f36" class="mh kn iq md b gy nb mj l mk ml">FAIRING_BACKEND = 'KubeflowGKEBackend'</span></pre><h1 id="5d6a" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">远程训练模型</h1><pre class="lq lr ls lt gt mc md me mf aw mg bi"><span id="186e" class="mh kn iq md b gy mi mj l mk ml"><strong class="md ir">from</strong> <strong class="md ir">kubeflow.fairing</strong> <strong class="md ir">import</strong> TrainJob<br/>train_job = TrainJob(HousingServe, input_files=['ames_dataset/train.csv', "requirements.txt"],<br/>                     docker_registry=DOCKER_REGISTRY,<br/>                     backend=BackendClass(build_context_source=BuildContext))<br/>train_job.submit()</span></pre><h1 id="8a27" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">部署预测模型</h1><pre class="lq lr ls lt gt mc md me mf aw mg bi"><span id="c595" class="mh kn iq md b gy mi mj l mk ml"><strong class="md ir">from</strong> <strong class="md ir">kubeflow.fairing</strong> <strong class="md ir">import</strong> PredictionEndpoint<br/>endpoint = PredictionEndpoint(HousingServe, input_files=['trained_ames_model.dat', "requirements.txt"],<br/>                              service_type='LoadBalancer',<br/>                              docker_registry=DOCKER_REGISTRY,<br/>                              backend=BackendClass(build_context_source=BuildContext))<br/>endpoint.create()</span></pre><p id="ac01" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样:)</p><p id="092b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您从笔记本电脑变成了运行在Kubernetes集群上的组件。</p></div></div>    
</body>
</html>