<html>
<head>
<title>TDD in Flutter - Special: Golden tests with Alchemist 🧙🏼</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">颤振中的tdd特殊:炼金术士🧙的黄金测试🏼</h1>
<blockquote>原文：<a href="https://itnext.io/tdd-in-flutter-special-golden-tests-with-alchemist-ea8c96ff4dfe?source=collection_archive---------2-----------------------#2022-04-04">https://itnext.io/tdd-in-flutter-special-golden-tests-with-alchemist-ea8c96ff4dfe?source=collection_archive---------2-----------------------#2022-04-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/8d86239268090316ddb2997da442d57f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cnOxe4bps8i07G-atX2c0w.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">超级特别版！</figcaption></figure><p id="3712" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">几个月前，我发布了这篇文章:</p><div class="ld le gp gr lf lg"><a rel="noopener  ugc nofollow" target="_blank" href="/tdd-in-flutter-part-3-testing-your-widgets-c5e87d76a864"><div class="lh ab fo"><div class="li ab lj cl cj lk"><h2 class="bd iu gy z fp ll fr fs lm fu fw is bi translated">Flutter中的TDD第3部分:测试小部件</h2><div class="ln l"><h3 class="bd b gy z fp ll fr fs lm fu fw dk translated">大家好，距离上一集已经有一段时间了，但终于来了，我准备向你们解释如何…</h3></div><div class="lo l"><p class="bd b dl z fp ll fr fs lm fu fw dk translated">itnext.io</p></div></div><div class="lp l"><div class="lq l lr ls lt lp lu jz lg"/></div></div></a></div><p id="32b7" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">其中一个主题是“黄金测试”，使用包<a class="ae lv" href="https://pub.dev/packages/golden_toolkit" rel="noopener ugc nofollow" target="_blank"> golden_toolkit </a>制作了一个例子。这是一个在测试中执行快照比较的很好的包，但是它有一个主要的警告，即根据所使用的平台，生成的文件之间不一致。</p><p id="e123" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">2022年2月23日，<a class="ae lv" href="https://verygood.ventures/" rel="noopener ugc nofollow" target="_blank"> Very Good Ventures </a>联合<a class="ae lv" href="https://www.betterment.com/" rel="noopener ugc nofollow" target="_blank"> Betterment </a>发布了一个名为<a class="ae lv" href="https://github.com/Betterment/alchemist" rel="noopener ugc nofollow" target="_blank">炼金术师</a>的包，旨在简化黄金测试的处理方式，并提高生成的快照之间的一致性。</p><p id="c699" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">背后的解决方案实际上非常简单，软件包将生成两组快照，一组特定于您的平台(Linux、MacOS或Windows ),另一组专门为您的配置项制作。通过这样做，作为一名开发人员，您将拥有一组人类可读的快照，以确认使用<a class="ae lv" href="https://web-platform-tests.org/writing-tests/ahem.html" rel="noopener ugc nofollow" target="_blank">咳咳字体</a>为您的CI生成的渲染和黄金文件，无论操作系统如何，这些文件都应该保持不变。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><p id="bdbb" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">既然解释了基本概念，让我们看看如何用这个包编写测试:</p><h2 id="1638" class="md me it bd mf mg mh dn mi mj mk dp ml kq mm mn mo ku mp mq mr ky ms mt mu mv bi translated">导入包</h2><p id="2ea7" class="pw-post-body-paragraph kf kg it kh b ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky na la lb lc im bi translated">这似乎是显而易见的，但是，您必须将包添加到您的<code class="fe nb nc nd ne b">pubspec.yaml</code>文件中。您可以直接编写导入，如下所示:</p><pre class="nf ng nh ni gt nj ne nk nl aw nm bi"><span id="9aed" class="md me it ne b gy nn no l np nq">dev_dependencies:<br/>  alchemist: ^0.3.2 # Latest version at the time of this article</span></pre><p id="6458" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">或者只运行命令:</p><pre class="nf ng nh ni gt nj ne nk nl aw nm bi"><span id="412d" class="md me it ne b gy nn no l np nq">$&gt; flutter pub add --dev alchemist</span></pre><h2 id="b781" class="md me it bd mf mg mh dn mi mj mk dp ml kq mm mn mo ku mp mq mr ky ms mt mu mv bi translated">添加字体</h2><p id="5852" class="pw-post-body-paragraph kf kg it kh b ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky na la lb lc im bi translated">现在你已经添加了这个包，你将需要从你的资源中添加一些字体，如果你还没有使用的话，这将需要渲染人类可读的快照。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h2 id="0e22" class="md me it bd mf mg mh dn mi mj mk dp ml kq mm mn mo ku mp mq mr ky ms mt mu mv bi translated">更新的软件包v0.3.3 —推荐</h2><p id="1de2" class="pw-post-body-paragraph kf kg it kh b ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky na la lb lc im bi translated">Roboto字体直接包含在包的<a class="ae lv" href="https://github.com/Betterment/alchemist/tree/main/assets/fonts/Roboto" rel="noopener ugc nofollow" target="_blank">资产中，你可以用<code class="fe nb nc nd ne b">FontLoader</code>加载它。我写了一个实用程序来帮助我:</a></p><figure class="nf ng nh ni gt ju"><div class="bz fp l di"><div class="nr ns l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">测试/utils/font_loader.dart</figcaption></figure><p id="6c1a" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">然后，在测试之前，您可以用一个<code class="fe nb nc nd ne b">setUpAll</code>来设置对方法<code class="fe nb nc nd ne b">loadDefaultTestFont()</code>的调用。这是一个更好的方法，因为炼金术士是一个<code class="fe nb nc nd ne b">dev_dependency</code>，所以它不会捆绑你的应用程序中的字体文件。</p><pre class="nf ng nh ni gt nj ne nk nl aw nm bi"><span id="3a89" class="md me it ne b gy nn no l np nq">void main() {<br/>  setUpAll(() async {<br/>    await loadDefaultTestFont();<br/>  });</span><span id="cb79" class="md me it ne b gy nt no l np nq">  // your golden test<br/>}</span></pre><h2 id="ce1b" class="md me it bd mf mg mh dn mi mj mk dp ml kq mm mn mo ku mp mq mr ky ms mt mu mv bi translated">旧方法—不推荐</h2><p id="a5a6" class="pw-post-body-paragraph kf kg it kh b ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky na la lb lc im bi translated">基本的<a class="ae lv" href="https://fonts.google.com/specimen/Roboto" rel="noopener ugc nofollow" target="_blank"> Roboto font </a>应该可以完美地完成这项工作，只需下载并复制项目中的文件即可。</p><p id="de9c" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我个人喜欢创建一个<code class="fe nb nc nd ne b">assets/fonts/</code>文件夹:</p><pre class="nf ng nh ni gt nj ne nk nl aw nm bi"><span id="4ad2" class="md me it ne b gy nn no l np nq">+-- assets/<br/>|   +-- fonts/<br/>|   |   +-- Roboto/<br/>|   |   |   +-- LICENSE.txt<br/>|   |   |   +-- Roboto-Black.ttf<br/>|   |   |   +-- Roboto-Bold.ttf<br/>|   |   |   +-- Roboto-Light.ttf<br/>|   |   |   +-- Roboto-Medium.ttf<br/>|   |   |   +-- Roboto-Regular.ttf<br/>|   |   |   +-- Roboto-Thin.ttf</span></pre><p id="496c" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">不要忘记在<code class="fe nb nc nd ne b">pubspec.yaml</code>中声明你的字体:</p><pre class="nf ng nh ni gt nj ne nk nl aw nm bi"><span id="ed52" class="md me it ne b gy nn no l np nq">flutter:<br/>  fonts:<br/>    - family: Roboto<br/>      fonts:<br/>        - asset: assets/fonts/Roboto/Roboto-Thin.ttf<br/>          weight: 100<br/>        - asset: assets/fonts/Roboto/Roboto-Light.ttf<br/>          weight: 300<br/>        - asset: assets/fonts/Roboto/Roboto-Regular.ttf<br/>          weight: 400<br/>        - asset: assets/fonts/Roboto/Roboto-Medium.ttf<br/>          weight: 500<br/>        - asset: assets/fonts/Roboto/Roboto-Bold.ttf<br/>          weight: 700<br/>        - asset: assets/fonts/Roboto/Roboto-Black.ttf<br/>          weight: 900</span></pre><p id="77df" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">你所有声明的字体都将被这个包加载，这样你就不需要在编写测试时使用像<code class="fe nb nc nd ne b">loadAppFonts</code>这样的方法。</p><p id="37b1" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><strong class="kh iu">不再推荐这种方式，因为您必须将Roboto文件与您的应用程序捆绑在一起。</strong></p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h2 id="6e6b" class="md me it bd mf mg mh dn mi mj mk dp ml kq mm mn mo ku mp mq mr ky ms mt mu mv bi translated">将非CI黄金文件添加到gitignore</h2><p id="b4ae" class="pw-post-body-paragraph kf kg it kh b ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky na la lb lc im bi translated">只需将以下内容添加到您的<code class="fe nb nc nd ne b">.gitignore</code>文件中:</p><pre class="nf ng nh ni gt nj ne nk nl aw nm bi"><span id="d364" class="md me it ne b gy nn no l np nq">test/**/goldens/**/*.*<br/>test/**/failures/**/*.*<br/>!test/**/goldens/ci/*.*</span></pre><h2 id="0903" class="md me it bd mf mg mh dn mi mj mk dp ml kq mm mn mo ku mp mq mr ky ms mt mu mv bi translated">创建黄金测试标签</h2><p id="dd27" class="pw-post-body-paragraph kf kg it kh b ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky na la lb lc im bi translated">创建一个<code class="fe nb nc nd ne b">dart_test.yaml</code>文件，如果你还没有的话，并添加以下属性:</p><figure class="nf ng nh ni gt ju"><div class="bz fp l di"><div class="nr ns l"/></div></figure><h2 id="facd" class="md me it bd mf mg mh dn mi mj mk dp ml kq mm mn mo ku mp mq mr ky ms mt mu mv bi translated">配置您的测试</h2><p id="9135" class="pw-post-body-paragraph kf kg it kh b ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky na la lb lc im bi translated">在您的<code class="fe nb nc nd ne b">test/</code>文件夹中创建一个<code class="fe nb nc nd ne b">flutter_test_config.dart</code>文件，并添加以下代码:</p><figure class="nf ng nh ni gt ju"><div class="bz fp l di"><div class="nr ns l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">测试/颤振_测试_配置.飞镖</figcaption></figure><p id="a826" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">这将允许您通过使用命令<code class="fe nb nc nd ne b">flutter test --dart-define=CI=true</code>对CI黄金文件运行测试。该参数添加了一个名为“CI”的<a class="ae lv" href="https://stackoverflow.com/a/61725261/9942346" rel="noopener ugc nofollow" target="_blank">环境变量</a>，可通过以下方法访问:</p><pre class="nf ng nh ni gt nj ne nk nl aw nm bi"><span id="b76e" class="md me it ne b gy nn no l np nq">bool.fromEnvironment('CI', defaultValue: false)</span></pre><p id="a1d9" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">这就是了！你的设置应该完成了，现在你可以用炼金术士编写并运行你的第一个黄金测试了。</p><h2 id="42e9" class="md me it bd mf mg mh dn mi mj mk dp ml kq mm mn mo ku mp mq mr ky ms mt mu mv bi translated">写一个黄金测试</h2><p id="b0a5" class="pw-post-body-paragraph kf kg it kh b ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky na la lb lc im bi translated">让我们看看上一篇文章中制作的<code class="fe nb nc nd ne b">SimpleText</code>小部件:</p><figure class="nf ng nh ni gt ju"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="11ba" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我想检查默认情况下文本是红色的，当改变<code class="fe nb nc nd ne b">color</code>属性时，它将更新我的文本的颜色。</p><p id="5f5d" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">因此，让我们使用炼金术士来重构旧的测试文件:</p><figure class="nf ng nh ni gt ju"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="b330" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">和<a class="ae lv" href="https://pub.dev/packages/golden_toolkit" rel="noopener ugc nofollow" target="_blank"> golden_toolkit </a>一样，你有一个<code class="fe nb nc nd ne b">goldenTest</code>方法可以调用，这个包也提供了一个<code class="fe nb nc nd ne b">GoldenTestGroup</code>小部件，它的行为有点像<code class="fe nb nc nd ne b">group</code>方法。然后，您可以使用<code class="fe nb nc nd ne b">GoldenTestScenario</code>小部件在您的快照上添加一个标签，并帮助将多个快照合并到一个文件中。</p><p id="5f32" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">现在，您已经准备好运行命令了:</p><pre class="nf ng nh ni gt nj ne nk nl aw nm bi"><span id="e30e" class="md me it ne b gy nn no l np nq">$&gt; flutter test --update-goldens </span></pre><p id="8057" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">您应该获得两个包含您的平台和CI快照的文件夹:</p><figure class="nf ng nh ni gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nu"><img src="../Images/268656de4cc41e2540b9ba920cf205db.png" data-original-src="https://miro.medium.com/v2/resize:fit:554/format:webp/1*1Hzu5liX1P_Dwaj8sA8awQ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">平台快照</figcaption></figure><figure class="nf ng nh ni gt ju gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/ed4de33ddfbfb6dc56641079bbcaa774.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/format:webp/1*6WLqxrNP_qmlLwiIJWKxLg.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">CI快照</figcaption></figure><p id="6f35" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">当您丢失CI测试的细节时，您并不总是需要确认一个<code class="fe nb nc nd ne b">Text</code>小部件被正确渲染，但是，您可能想要确保您正在用正确的颜色渲染您的小部件。</p><p id="d7ff" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">这就是如何编写与您的CI兼容的黄金测试。请不要犹豫，在<a class="ae lv" href="https://pub.dev/documentation/alchemist/latest/" rel="noopener ugc nofollow" target="_blank"> Pub.dev </a>或<a class="ae lv" href="https://github.com/Betterment/alchemist" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上查看该软件包的文档，了解该软件包支持的功能的更多详细信息，或者在需要时提出问题。由于这个包还很年轻，我相信任何贡献将非常感谢。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h2 id="1f6f" class="md me it bd mf mg mh dn mi mj mk dp ml kq mm mn mo ku mp mq mr ky ms mt mu mv bi translated">结论</h2><p id="ff57" class="pw-post-body-paragraph kf kg it kh b ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky na la lb lc im bi translated">我希望这篇文章能帮助你更好地理解炼金术士包。我想欢迎所有最近来的追随者。你们是我写这个系列的主要动力来源。</p><p id="213d" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">一如既往，如果你喜欢这篇文章，请不要犹豫发表评论、分享和鼓掌。你可以在它自己的阅读列表中找到“TDD in Flutter”之前的所有文章:</p><p id="179f" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><a class="ae lv" href="https://rouxguillaume.medium.com/list/tdd-in-flutter-64d0d5f07854" rel="noopener">https://rouxguillaume . medium . com/list/TDD-in-flutter-64d 0 D5 f 07854</a></p><p id="9f11" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">祝你有美好的一天和快乐的编码！</p></div></div>    
</body>
</html>