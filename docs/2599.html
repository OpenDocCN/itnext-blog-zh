<html>
<head>
<title>Build and Deploy Spring Boot Web Service using Azure DevOps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure DevOps构建和部署Spring Boot Web服务</h1>
<blockquote>原文：<a href="https://itnext.io/build-and-deploy-spring-boot-web-service-using-azure-devops-28d745ad086f?source=collection_archive---------2-----------------------#2019-06-21">https://itnext.io/build-and-deploy-spring-boot-web-service-using-azure-devops-28d745ad086f?source=collection_archive---------2-----------------------#2019-06-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="4ae2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我最近试用了Azure DevOps管道，惊讶于它的设置和使用如此简单。</p><p id="aaa0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我想记录所做的事情，以便将来当我想做类似的事情时可以参考。</p><p id="d3be" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我希望有人发现这也很有用。</p><p id="1e03" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在开始这次冒险之前，我决定设定一个我想通过这次实验达到的目标。</p><blockquote class="ko kp kq"><p id="9ec3" class="jq jr kr js b jt ju jv jw jx jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kn im bi translated">目标<br/>“我想要一个真实世界的spring boot web服务，并使用Kubernetes将其部署在Azure基础设施中。”</p></blockquote><p id="9a87" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有几件事我假设你已经有了，如果你跟随:<br/> *你已经有一个Azure帐户。<br/> *您拥有Azure Dev Ops帐户。</p><p id="0787" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有几件事我想你已经知道了:<br/> *你知道如何在Azure Web控制台上工作。<br/> *你知道如何使用Terraform，并且你已经为Azure配置了它。</p><p id="8c5b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本文中，我将展示创建基础设施的步骤，然后是设置Azure DevOps管道的步骤。</p><h1 id="302b" class="kv kw it bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">使用Terrafrom创建基础设施</h1><p id="a056" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">首先，我们必须准备好基础设施来保存从Azure DevOps管道推送的Docker映像。</p><p id="8750" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了准备这个基础设施，我使用了Terraform，并在Azure存储容器中远程保存我的状态。</p><ol class=""><li id="4298" class="ly lz it js b jt ju jx jy kb ma kf mb kj mc kn md me mf mg bi translated">查看以下报告中的地形代码:<a class="ae mh" href="https://github.com/juliuscanute/azure-infrastructure" rel="noopener ugc nofollow" target="_blank">https://github.com/juliuscanute/azure-infrastructure</a>。</li></ol><p id="eb2c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2.在state目录中创建'<strong class="js iu"> terraform.tvars </strong>'。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="f871" class="mr kw it mn b gy ms mt l mu mv">storage_account_name = "exampleaccount"<br/>container_name = "examplecontainer"<br/>location = "australiasoutheast"<br/>resource_group_name = "example"</span></pre><p id="5af1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3.现在对<strong class="js iu"> 'state/main.tf' </strong>中的以下行进行注释。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="bc01" class="mr kw it mn b gy ms mt l mu mv"># terraform {<br/># backend “azurerm” {}<br/># }</span></pre><p id="2986" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">4.执行以下terraform命令来规划和应用对基础架构的更改。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="49d7" class="mr kw it mn b gy ms mt l mu mv">terraform init<br/>terraform plan --var-file="terraform.tvars"<br/>terraform apply --var-file="terraform.tvars"</span></pre><p id="0336" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在应用步骤之后，Terraform输出变量，我们在后续步骤中使用这些变量将状态文件上传到容器。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="f828" class="mr kw it mn b gy ms mt l mu mv">Apply complete! Resources: 0 added, 0 changed, 0 destroyed.</span><span id="6309" class="mr kw it mn b gy mw mt l mu mv">Outputs:<br/>container_name = ####<br/>resource_group_location = ####<br/>resource_group_name = ####<br/>storage_account_name = ####<br/>storage_id = ####<br/>storage_key = ####</span></pre><p id="87aa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">5.我们将使用上面的信息将状态文件上传到容器(远程)。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="7332" class="mr kw it mn b gy ms mt l mu mv">export AZURE_STORAGE_ACCOUNT=&lt;storage_account_name&gt;<br/>export AZURE_STORAGE_KEY=&lt;storage_key&gt;</span><span id="4b09" class="mr kw it mn b gy mw mt l mu mv">az storage blob upload --container-name &lt;container_name&gt; --file terraform.tfstate --name &lt;example&gt;.tfstate</span></pre><p id="a519" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">6.创建state/terraform.cfg并取消步骤3中注释的行。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="8245" class="mr kw it mn b gy ms mt l mu mv">storage_account_name = "&lt;storage_account_name&gt;"<br/>container_name = "&lt;container_name&gt;"<br/>key = "&lt;example&gt;.tfstate"<br/>access_key = "&lt;storage_key&gt;"</span></pre><p id="9d70" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">7.让我们验证一下Terraform是否能读写远程状态文件。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="34f5" class="mr kw it mn b gy ms mt l mu mv">terraform init --backend-config="terraform.cfg"<br/>terraform apply --var-file="terraform.tvars"</span><span id="84bb" class="mr kw it mn b gy mw mt l mu mv">Apply complete! Resources: 0 added, 0 changed, 0 destroyed.</span></pre><p id="317f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">8.让我们添加deploy/terraform.tvars并确保'<example>。“tfstate”与前面步骤中创建的状态文件相匹配。</example></p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="8959" class="mr kw it mn b gy ms mt l mu mv">registry_name = "examplerepo"<br/>storage_account_name = "&lt;storage_account_name&gt;"<br/>container_name = "&lt;container_name&gt;"<br/>key = "&lt;example&gt;.tfstate"<br/>accesss_key = "&lt;storage_key&gt;"</span></pre><p id="a7d0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">9.让我们添加deploy/terraform.cfg，并确保您为该键指定了一个不同的名称。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="9ca3" class="mr kw it mn b gy ms mt l mu mv">storage_account_name = "&lt;storage_account_name&gt;"<br/>container_name = "&lt;container_name&gt;"<br/>key = "&lt;different&gt;.tfstate"<br/>access_key = "&lt;storage_key&gt;"</span></pre><p id="5dac" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">10.让我们通过切换到deploy目录并执行下面显示的命令来完成保存docker映像的基础设施设置。请记下用户名和密码，因为我们将使用它们来设置推送docker映像的管道。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="4bc9" class="mr kw it mn b gy ms mt l mu mv">cd ../deploy/<br/>terraform init --backend-config="terraform.cfg"<br/>terraform apply --var-file="terraform.tvars"</span><span id="a8c5" class="mr kw it mn b gy mw mt l mu mv">...<br/>Apply complete! Resources: 1 added, 0 changed, 0 destroyed.</span><span id="85d0" class="mr kw it mn b gy mw mt l mu mv">Outputs:</span><span id="8eb8" class="mr kw it mn b gy mw mt l mu mv">login_server = ####<br/>password = ####<br/>username = ####</span></pre><h1 id="410f" class="kv kw it bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">使用Azure管道构建</h1><p id="84e2" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">对于这个管道构建，我将使用以下存储库中的代码:<br/><a class="ae mh" href="https://github.com/juliuscanute/kotlin-spring-realworld-example-app" rel="noopener ugc nofollow" target="_blank">https://github . com/Julius Canute/kot Lin-spring-real world-example-app</a></p><ol class=""><li id="3383" class="ly lz it js b jt ju jx jy kb ma kf mb kj mc kn md me mf mg bi translated">从导航抽屉中选择Pipelines，然后单击create New Pipeline，如图所示。</li></ol><figure class="mi mj mk ml gt my gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/1047d1e53752388ece6a66001c87e963.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/1*WcwSlExARvwqFP2BhiBsmg.png"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">创建新管道</figcaption></figure><p id="208b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2.选择您承载代码的位置；就我而言，它驻留在GitHub中。</p><figure class="mi mj mk ml gt my gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/e794b0b1c23ddb1b26d29ca98e78adb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:884/format:webp/1*kJnqbPpgfQUZeIaJlnc0uw.png"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">源代码托管提供商</figcaption></figure><p id="47ff" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3.选择包含Spring代码的存储库。</p><figure class="mi mj mk ml gt my gh gi paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="gh gi ng"><img src="../Images/1431a17c5c2a516ebc987a8ad7cd1069.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MurYqdQD-PGSJ62y5zQuIw.png"/></div></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated"><a class="ae mh" href="https://github.com/juliuscanute/kotlin-spring-realworld-example-app" rel="noopener ugc nofollow" target="_blank">https://github . com/Julius Canute/kot Lin-spring-real world-example-app</a></figcaption></figure><p id="b916" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">4.确保您的存储库有一个Dockerfile，它知道如何打包构建的JAR。</p><figure class="mi mj mk ml gt my"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="c724" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">5.使用以下步骤配置Azure管道并完成配置，虽然这会自动触发管道作业，但您可以暂时停止它，因为没有凭据它将会失败。</p><figure class="mi mj mk ml gt my"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="8f22" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">6.现在是添加秘密的时候了，点击所示的菜单并选择编辑管道。</p><figure class="mi mj mk ml gt my gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/181db4e1bb8510c2fcf7cee0d93d7386.png" data-original-src="https://miro.medium.com/v2/resize:fit:664/format:webp/1*IA3q9iE9yOcX3Hj1fTthsw.png"/></div></figure><p id="95d4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">7.在“编辑管道”中，再次选择菜单，并选择变量。</p><figure class="mi mj mk ml gt my gh gi paragraph-image"><div class="gh gi no"><img src="../Images/d86a1fff061820c90e4cd420170e6f09.png" data-original-src="https://miro.medium.com/v2/resize:fit:578/format:webp/1*KOMxwaPBS-lD4eLZa4K9bw.png"/></div></figure><p id="3544" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">8.创建新的变量组。</p><figure class="mi mj mk ml gt my gh gi paragraph-image"><div class="gh gi np"><img src="../Images/ae6e66404b0f3a084c88f59ab115fdff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1170/format:webp/1*xJcW-BYB4xH7nI_5AN1rCQ.png"/></div></figure><p id="c7e2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">9.输入您从Terraform输出中获得的用户名和密码，并保存创建的变量组。</p><figure class="mi mj mk ml gt my gh gi paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="gh gi nq"><img src="../Images/7cea6958285155cda8f0ed46cba0ec33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H8zXP-R7hgbF_oJYmMobUg.png"/></div></div></figure><p id="b220" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">10.将变量组与现有管道链接。</p><figure class="mi mj mk ml gt my gh gi paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="gh gi nr"><img src="../Images/4fe1fb900b515f786d6c0feb8ba19720.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KHG9Q8YWli3skgNvj23JpQ.png"/></div></div></figure><p id="66cd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">11.再次触发构建，但这一次，它应该成功完成。</p><figure class="mi mj mk ml gt my gh gi paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="gh gi ns"><img src="../Images/fe3f0b5189c4ae6c5de13e8636b1bdc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l7PJHkkC6a2uQyQTRWezQg.png"/></div></div></figure><p id="c430" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">12.您可以通过从Azure Web门户登录和查看来验证Docker映像是否被成功地推送到存储库。</p><figure class="mi mj mk ml gt my gh gi paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="gh gi nt"><img src="../Images/ab18341450c2747b593949eaf4fdcfaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9LYk8zrgF8FAfr-UWSxfpQ.png"/></div></div></figure><p id="5738" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在<a class="ae mh" rel="noopener ugc nofollow" target="_blank" href="/build-and-deploy-spring-boot-web-service-using-azure-devops-part-2-9252e247d140">的下一篇文章</a>中，我将向您展示如何使用存储库中的Docker映像，并将其部署到Azure中的Kubernetes集群。</p></div></div>    
</body>
</html>