<html>
<head>
<title>Portable Kubernetes management with kubectl in Docker container</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Docker容器中的kubectl进行可移植的Kubernetes管理</h1>
<blockquote>原文：<a href="https://itnext.io/portable-kubernetes-management-with-kubectl-in-docker-cb861a2c3c02?source=collection_archive---------1-----------------------#2020-01-25">https://itnext.io/portable-kubernetes-management-with-kubectl-in-docker-cb861a2c3c02?source=collection_archive---------1-----------------------#2020-01-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/b789dacdf045adcfa95ebcebfc784b99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FpbN0Vh5rTCtJnj-cBAs1g.jpeg"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">图片来自<a class="ae jg" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3021820" rel="noopener ugc nofollow" target="_blank">皮克斯拜</a></figcaption></figure><div class=""/><p id="69fc" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">说Kubernetes正在成为主流是一种保守的说法。事实上，它已经影响了现代分布式系统的设计和操作。通过将基础设施问题抽象化，我们能够将Kubernetes作为一个“构建平台的平台”或“云操作系统”来利用，这带来了许多明显的好处，但也带来了开发和运营挑战。</p><p id="c87a" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">围绕Kubernetes的整个生态系统正在蓬勃发展，现在开源社区有大量令人惊叹的工具和项目，其中一些在CNCF的保护下，一些由爱好者或各种规模和影响力的公司设计。可以说，有很多事情正在发生，很难跟上这种不断变化的形势。</p><p id="e979" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">今天，我们将重点关注一个既具体又非常实用的领域:即Kubernetes对kubectl的管理。<a class="ae jg" href="https://kubectl.docs.kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubectl </a>是一个命令行工具(CLI ),用于管理Kubernetes集群。Kubernetes社区中一个众所周知的争论是:“kubectl到底是怎么发音的？”。有很多观点，本页提供了一些最常见的观点，所以你可以自由选择，甚至创造你自己的观点。</p><p id="b6a6" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当我们不忙着搞清楚世界饥饿或kubectl发音时，我们经常花大量时间手工制作我们运行kubectl的环境，我们创建别名，添加自动完成，安装插件和其他诊断和集群管理工具。如果我们能够随身携带这种诊断/管理环境，并对每个集群使用相同的工具、脚本、别名和快捷方式，会怎么样？</p><p id="2841" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对我来说，用kubectl创建映像的动机是，我必须在没有<a class="ae jg" href="https://docs.microsoft.com/en-us/windows/wsl/install-on-server" rel="noopener ugc nofollow" target="_blank">wsl 2</a>(Lunix的Windows子系统)的情况下，在Azure上运行的Windows Server VM中使用新的Kubernetes集群，我不想使用cygwin或git-bash。我已经习惯了在Ubuntu上运行的环境，在一个图像中重建是一个快速解决这个挑战的方法。</p><p id="792c" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这篇博客的第二部分，我将解释如何在Docker容器中使用定制和个性化的kubectl。您可以使用我现有的kubectl映像，或者克隆我的<a class="ae jg" href="https://github.com/Piotr1215/kubectl-container" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>，并根据您的喜好进行更改。毕竟，Kubernetes是为管理容器而设计的，所以从容器中管理Kubernetes才是公平的！</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h1 id="fb8f" class="ll lm jj bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">使用kubectl创建和使用您自己的图像</h1><p id="a05f" class="pw-post-body-paragraph kg kh jj ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">这一章和下一章并不打算成为Docker教程，而是实践指导。如果你感兴趣的话，有很多关于Docker的资源。好的起点是https://www.docker.com/的<a class="ae jg" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="16d3" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您想尝试创建自己定制的kubectl容器，下面是要遵循的步骤。你也可以克隆/分叉我的GitHub库【https://github.com/Piotr1215/kubectl-container<a class="ae jg" href="https://github.com/Piotr1215/kubectl-container" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="e157" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你也可以直接从Docker Hub使用我的图片，如果你想测试它是如何工作的:<a class="ae jg" href="https://hub.docker.com/repository/docker/piotrzan/kubectl-comp" rel="noopener ugc nofollow" target="_blank">https://Hub . Docker . com/repository/Docker/piotrzan/ku bectl-comp</a>。</p><h2 id="a412" class="mo lm jj bd ln mp mq dn lr mr ms dp lv kr mt mu lz kv mv mw md kz mx my mh mz bi translated">创建Dockerfile文件</h2><p id="8ade" class="pw-post-body-paragraph kg kh jj ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">创建一个新的git存储库，并向其中添加Dockerfile。这是基于我的存储库的示例文件。</p><figure class="na nb nc nd gt iv"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="869a" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以将所有内容添加到一个docker文件中，我选择将配置部分拆分到一个bootstrap.sh中。配置脚本被复制到映像目录中，并作为运行步骤之一运行。另一种常见的做法是将供应脚本用作Dockerfile入口点。</p><figure class="na nb nc nd gt iv"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h2 id="5f4c" class="mo lm jj bd ln mp mq dn lr mr ms dp lv kr mt mu lz kv mv mw md kz mx my mh mz bi translated">构建和发布图像</h2><p id="fcc1" class="pw-post-body-paragraph kg kh jj ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">一旦所有的程序和配置都准备好了，就构建映像并用docker用户名标记它，这样就可以发布它了。</p><pre class="na nb nc nd gt ng nh ni nj aw nk bi"><span id="f237" class="mo lm jj nh b gy nl nm l nn no"><strong class="nh jk">docker build --rm -f “Dockerfile” -t dockeruser/image-name “.”</strong></span></pre><p id="e4fe" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将图像发布到docker存储库中。</p><pre class="na nb nc nd gt ng nh ni nj aw nk bi"><span id="42ca" class="mo lm jj nh b gy nl nm l nn no"><strong class="nh jk">docker publish dockeruser/image-name</strong></span></pre><h2 id="2413" class="mo lm jj bd ln mp mq dn lr mr ms dp lv kr mt mu lz kv mv mw md kz mx my mh mz bi translated">在任何环境下运行您的映像</h2><p id="1538" class="pw-post-body-paragraph kg kh jj ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">当您需要使用新集群时，只需运行您的映像。注意，我们命名容器是为了更容易管理它，并将<em class="np"> network设置为“host”</em>，这将使kubectl能够通过它访问主机网络和集群。</p><pre class="na nb nc nd gt ng nh ni nj aw nk bi"><span id="a0c7" class="mo lm jj nh b gy nl nm l nn no"><strong class="nh jk">docker run --network=host --name=kubectl-host --rm -it piotrzan/kubectl-comp</strong></span></pre></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h1 id="98be" class="ll lm jj bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">潜得更深</h1><p id="a10d" class="pw-post-body-paragraph kg kh jj ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">继续阅读，如果你想了解更多，理解我的形象以及我所做的设计选择。</p><h2 id="0ef1" class="mo lm jj bd ln mp mq dn lr mr ms dp lv kr mt mu lz kv mv mw md kz mx my mh mz bi translated">图像中包含什么</h2><ul class=""><li id="bc96" class="nq nr jj ki b kj mj kn mk kr ns kv nt kz nu ld nv nw nx ny bi translated">具有bash/zsh完成功能的kubectl 1 . 17 . 2版</li><li id="ecc8" class="nq nr jj ki b kj nz kn oa kr ob kv oc kz od ld nv nw nx ny bi translated"><strong class="ki jk">zsh-zsh外壳的自动建议</strong></li><li id="78b2" class="nq nr jj ki b kj nz kn oa kr ob kv oc kz od ld nv nw nx ny bi translated"><strong class="ki jk"> k9s </strong>出色的集群可观察性和基于终端的管理工具</li><li id="2efe" class="nq nr jj ki b kj nz kn oa kr ob kv oc kz od ld nv nw nx ny bi translated">流行工具:<strong class="ki jk"> curl，wget，git </strong></li><li id="8f40" class="nq nr jj ki b kj nz kn oa kr ob kv oc kz od ld nv nw nx ny bi translated">有用。bashrc/。zshrc别名</li></ul><pre class="na nb nc nd gt ng nh ni nj aw nk bi"><span id="bbf0" class="mo lm jj nh b gy nl nm l nn no"># Instead of typing kubectl all the time, abbreviate it to just “k”<br/><strong class="nh jk">alias k=kubectl</strong></span><span id="3274" class="mo lm jj nh b gy oe nm l nn no"># Check what is running on the cluster<br/><strong class="nh jk">alias kdump=’kubectl get all — all-namespaces’</strong></span><span id="46e4" class="mo lm jj nh b gy oe nm l nn no"># Display helpful info for creating k8s resources imperatively<br/><strong class="nh jk">alias krun=’k run -h | grep “# “ -A2'</strong></span><span id="9a86" class="mo lm jj nh b gy oe nm l nn no"># Quickly spin up busybox pod for diagnostic purposes<br/><strong class="nh jk">alias kdiag=’kubectl run -it — rm debug — image=busybox — restart=Never — sh’</strong></span></pre><h2 id="db1e" class="mo lm jj bd ln mp mq dn lr mr ms dp lv kr mt mu lz kv mv mw md kz mx my mh mz bi translated">如何使用它</h2><p id="2281" class="pw-post-body-paragraph kg kh jj ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">我的库包含了下面描述的所有脚本和命令，所以你可以直接使用它，而不是从这里复制。</p><p id="d9eb" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用映像最简单的方法是用下面的命令运行它。您可以选择运行任一bash shell</p><pre class="na nb nc nd gt ng nh ni nj aw nk bi"><span id="1ce0" class="mo lm jj nh b gy nl nm l nn no"><strong class="nh jk">docker run --network=host --name=kubectl-host --rm -it piotrzan/kubectl-comp</strong></span></pre><p id="511e" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">或者你喜欢zsh shell，还有另外一个形象</p><pre class="na nb nc nd gt ng nh ni nj aw nk bi"><span id="ab94" class="mo lm jj nh b gy nl nm l nn no"><strong class="nh jk">docker run --network=host --name=kubectl-host --rm -it piotrzan/kubectl-comp:zsh</strong></span></pre><p id="44cc" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这将启动一个名为<em class="np"> kubectl-host </em>的新容器，并使您能够使用kubectl，但是它不包含关于您的集群的信息。为了做到这一点，你需要确保。kube/config文件在容器中可用。最简单的方法是以分离模式运行容器，复制文件并附加回容器，如下所示:</p><pre class="na nb nc nd gt ng nh ni nj aw nk bi"><span id="4323" class="mo lm jj nh b gy nl nm l nn no"><em class="np"># Run container with pass-through to local network</em></span><span id="ea78" class="mo lm jj nh b gy oe nm l nn no"><strong class="nh jk">docker run -d — network=host — name=kubectl-host — rm -it piotrzan/kubectl-comp</strong></span><span id="df8b" class="mo lm jj nh b gy oe nm l nn no"><em class="np"># Generate raw config from kubectl on localhost and copy the config to the container</em></span><span id="0cc1" class="mo lm jj nh b gy oe nm l nn no"><strong class="nh jk">kubectl config view — raw &gt; config</strong></span><span id="a5b1" class="mo lm jj nh b gy oe nm l nn no"><strong class="nh jk">docker cp config kubectl-host:./root/.kube</strong></span><span id="3581" class="mo lm jj nh b gy oe nm l nn no"><strong class="nh jk">docker attach kubectl-host</strong></span></pre><p id="d8e1" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">或者，您可以使用<code class="fe of og oh nh b">docker-compose</code>旋转容器并附加一个卷</p><figure class="na nb nc nd gt iv"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h2 id="d619" class="mo lm jj bd ln mp mq dn lr mr ms dp lv kr mt mu lz kv mv mw md kz mx my mh mz bi translated">扩展图像</h2><p id="343b" class="pw-post-body-paragraph kg kh jj ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">假设您想要添加自己的别名或安装额外的软件等。Docker通过使用<code class="fe of og oh nh b">docker commit</code>命令实现简单的图像扩展。</p><ol class=""><li id="eaeb" class="nq nr jj ki b kj kk kn ko kr oi kv oj kz ok ld ol nw nx ny bi translated">运行容器</li><li id="c668" class="nq nr jj ki b kj nz kn oa kr ob kv oc kz od ld ol nw nx ny bi translated">配置和定制</li><li id="1b6e" class="nq nr jj ki b kj nz kn oa kr ob kv oc kz od ld ol nw nx ny bi translated">打开另一个shell会话并运行:</li></ol><pre class="na nb nc nd gt ng nh ni nj aw nk bi"><span id="c4c7" class="mo lm jj nh b gy nl nm l nn no">docker commit CONTAINER_ID new-contianer-tag</span></pre><p id="3305" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这之后，当你运行<code class="fe of og oh nh b">docker images</code>时，你将会看到你的新图像和你所做的改变一起被列出。你可以把它发布到Docker Hub上，或者只是在修改后使用它。</p><h2 id="d5a6" class="mo lm jj bd ln mp mq dn lr mr ms dp lv kr mt mu lz kv mv mw md kz mx my mh mz bi translated">结论</h2><p id="e85b" class="pw-post-body-paragraph kg kh jj ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">Kubernetes和容器化的工作负载提供了极大的灵活性，并开辟了以前很难实现的新的可能性。我希望，通过创建一个专用的、完全可移植的和定制的kubectl映像的例子，我已经启发了您尝试用您最喜欢的命令行工具创建一个Docker映像。</p><p id="1f65" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们最终创建了一个定制的、个性化的、完全可移植的kubectl CLI体验。无论如何，我的形象是唯一的，有很多伟大的想法。一个值得一提的图片是Bitnami为kubectl策划的图片，你可以在这里找到它:<a class="ae jg" href="https://hub.docker.com/r/bitnami/kubectl" rel="noopener ugc nofollow" target="_blank">https://hub.docker.com/r/bitnami/kubectl</a></p><p id="55e0" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">和往常一样，还有很多要说的，我们还没有谈到构建自动化CI/CD管道、缩小映像、围绕安全性实现最佳实践等等。其中一些话题非常复杂，以至于可以有自己的博客。</p><p id="d0cb" class="pw-post-body-paragraph kg kh jj ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">感谢您的阅读，下次博客再见！</p></div></div>    
</body>
</html>