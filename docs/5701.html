<html>
<head>
<title>Lifecycle of Kubernetes Network Policies and Best Practices</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes网络策略和最佳实践的生命周期</h1>
<blockquote>原文：<a href="https://itnext.io/lifecycle-of-kubernetes-network-policies-749b5218f684?source=collection_archive---------3-----------------------#2021-05-06">https://itnext.io/lifecycle-of-kubernetes-network-policies-749b5218f684?source=collection_archive---------3-----------------------#2021-05-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d989" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇博文中，我们将讨论Kubernetes网络策略的整个生命周期，包括创建、编辑、治理、调试等主题，我们还将分享在处理网络策略时可以创造更好用户体验的最佳实践和见解。</p><p id="a318" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安迪·纳普  <em class="km">对这篇文章进行了评论，并提出了一些修改建议。非常感谢安迪！</em></p><h2 id="ebf8" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">输入网络策略</h2><p id="91ea" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">随着Kubernetes适应在大型企业中的不断发展，Kubernetes的安全相关方面变得更加重要，例如网络策略，它允许您控制哪些网络资源允许从/到Pods访问。</p><p id="f89a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kubernetes是一个非常强大的平台，在强大的同时也引入了一些复杂性。尤其是那些刚刚开始了解Kubernetes的人，很容易被淹没，因为他们需要接触和掌握所有的新事物。Kubernetes毕竟应该帮助公司变得更加灵活，但单靠一个平台无法解决企业的大多数典型问题，如文化、流程和孤岛。即使你的公司有最好的Kubernetes平台，如果你没有很好地将其集成到企业的it生态系统的其余部分，你将永远无法获得Kubernetes的全部好处。</p><p id="2d0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不幸的是，许多采用Kubernetes的大型企业都面临着组织整体不够敏捷的问题。不幸的是，在当今的一般大型企业中，仍然需要进行大量的手动工作来完成任何与IT相关的订单/变更。从组织的角度来看，网络/安全团队通常与平台和应用团队相隔离，这种“孤岛”心态加上每个组织单位都有自己的目标和激励措施，与安全相关的话题通常会成为问题和缓慢的主要来源。</p><p id="8aae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">网络策略是网络安全的一个非常重要的组成部分，它的好坏取决于用户的体验，比如创建它们有多容易？批准和应用它们有多容易？在这篇博文的剩余部分，我们将讨论一些针对网络策略不同阶段的想法，这些想法应该有助于您围绕使用网络策略创建最佳的用户体验。</p><h2 id="8b51" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">一种模式:网络边界安全委托给Kubernetes</h2><p id="62f8" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">在许多企业中非常有用的一种模式是开放通信(至少对于一些公共服务，如日志服务、监控服务),一直到Kubernetes集群的外围，然后让网络策略控制网络流量。当一个团队需要管理网络策略，同时通过不同的机制(如ServiceNow或一些其他工作流/票证系统)请求新的防火墙规则时，获得网络访问的总周转时间太长了。这种模式背后的主要动机是在Kubernetes平台级别上只做一次冗长的防火墙更改，并依赖网络策略进行细粒度控制。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div class="ab gu cl lq"><img src="../Images/303e078e99ee9b0d223a58909e33fa41.png" data-original-src="https://miro.medium.com/v2/0*UkXk06aRhOc1dy0g"/></div></figure><p id="285a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当在Kubernetes集群级别上控制网络边界安全时，需要小心控制默认允许的流量，也就是说，您可能希望限制默认情况下允许的入/出网络流量。应该记住，当没有在名称空间上应用网络策略时，Kubernetes不会对网络流量进行控制。这可以根据Kubernetes集群中使用的<a class="ae kl" href="https://github.com/containernetworking/cni" rel="noopener ugc nofollow" target="_blank"> CNI(容器网络接口)</a>插件以不同的方式完成。一种方法是应用一个网络策略来阻止所有名称空间的大部分流出/流入流量，并控制RBAC(基于角色的访问控制),使得Kubernetes集群的非管理员用户在没有某种管理的情况下不能自己创建/编辑/删除网络策略对象。基于实现集群使用的CNI插件的软件，您可能还需要限制每个名称空间默认获得的网络访问。使用<a class="ae kl" href="https://www.vmware.com/products/nsx.html" rel="noopener ugc nofollow" target="_blank"> NSX </a>防火墙规则来实现这个想法是我们从VMware Tanzu实验室的领域中了解到的。</p><p id="1a85" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">同时，为了使这种模式成功工作，应用网络策略的周转时间应该尽可能短。在这篇文章的治理部分，有几个关于如何形成治理的想法，使得网络政策可以尽快地被接受或拒绝。</p><h2 id="6829" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">创建网络策略</h2><h2 id="5765" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">基础</h2><p id="9312" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">对网络策略有一个基本的了解是很重要的，下面的两个文档是很好的起点:</p><ul class=""><li id="fd2d" class="lt lu iq jp b jq jr ju jv jy lv kc lw kg lx kk ly lz ma mb bi translated"><a class="ae kl" href="https://kubernetes.io/docs/concepts/services-networking/network-policies/" rel="noopener ugc nofollow" target="_blank"> Kubernetes关于网络政策的官方文件</a></li><li id="4ccf" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">来自Kubernetes网络政策社区的教程</li></ul><p id="c316" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦你理解了基础知识，可能是时候获得一些实践经验了。看看你是否能在<a class="ae kl" href="https://minikube.sigs.k8s.io/docs/" rel="noopener ugc nofollow" target="_blank"> minikube </a>或另一个你能访问的Kubernetes集群上安装你最喜欢的支持网络策略的CNI插件。如果你必须自己安装一个CNI插件，你需要管理员权限。这里需要注意的是，尽管网络策略是Kubernetes的官方部分，也是标准的Kubernetes资源，但实际上是CNI插件“实现”了网络策略，所以只要CNI工具支持网络策略，你就应该能够测试网络策略的基本功能。也就是说，普通的Kubernetes网络策略有一定的局限性，正如这里的<a class="ae kl" href="https://kubernetes.io/docs/concepts/services-networking/network-policies/#what-you-can-t-do-with-network-policies-at-least-not-yet" rel="noopener ugc nofollow" target="_blank">所解释的那样</a>，所以如果可能的话，使用您将在生产中使用的实际CNI插件来测试网络策略是非常有意义的。</p><p id="d24d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您希望看到一个涵盖大多数用例的示例网络策略的良好目录，请查看这个github repo 。</p><p id="152f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一个需要考虑的要点是如何处理网络策略的pod选择器。名为<code class="fe mh mi mj mk b">spec.podSelector</code>的键控制网络策略将应用于哪些策略。当密钥为空时，即<code class="fe mh mi mj mk b">podSelector: {}</code>，它适用于创建网络策略的名称空间中的所有pod。如果您想要定位特定的窗格，可以使用窗格选择器来实现，例如:</p><pre class="ll lm ln lo gt ml mk mm mn aw mo bi"><span id="5aeb" class="kn ko iq mk b gy mp mq l mr ms">podSelector:<br/>    matchLabels:<br/>      app: bookstore</span></pre><p id="2d02" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您有许多网络策略要编写，因为您的应用程序有许多组件，如果您想编写一个尽可能精确地控制流量的策略，这意味着编写只针对需要特定出口/入口规则的pod的pod选择器，您可以使用一个名为<strong class="jp ir"> matchExpressions </strong>的键。参见下面的示例，该示例可帮助您通过标签<em class="km">app =书店</em>或<em class="km">app =数据库</em>定位两种不同的pod:</p><pre class="ll lm ln lo gt ml mk mm mn aw mo bi"><span id="fc86" class="kn ko iq mk b gy mp mq l mr ms">podSelector:<br/>    matchExpressions:<br/>      - {key: app, operator: In, values: [bookstore, database]}</span></pre><h2 id="53e6" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">域名服务器(Domain Name Server)</h2><p id="91a1" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">忘记为DNS 调用添加<strong class="jp ir">网络策略是另一个常见错误。根据您的pod如何配置，如这里的<a class="ae kl" href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#pod-s-dns-policy" rel="noopener ugc nofollow" target="_blank">所述</a>，应用程序pod可能需要与运行在您的集群上的DNS服务器或运行在外部的DNS服务器通信。确保添加一个网络策略，以满足您的命名空间的DNS通信需求。如果你的CNI插件允许的话，你也可以在集群层面上应用DNS策略，比如使用<a class="ae kl" href="https://github.com/vmware-tanzu/antrea/blob/28ef522ced7045f567c22b916cb29d9272f9c92b/docs/antrea-network-policy.md" rel="noopener ugc nofollow" target="_blank"> Antrea的ClusterNetworkPolicy </a>。</strong></p><h2 id="53f6" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">A舱的出口是B舱的入口</h2><p id="7fb7" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">如果<strong class="jp ir"> Pod A </strong>需要调用<strong class="jp ir"> Pod B </strong>，您将需要创建一个具有针对<strong class="jp ir"> Pod A </strong>的<strong class="jp ir">出口</strong>规则的网络策略，以及另一个具有针对<strong class="jp ir"> Pod B </strong>的<strong class="jp ir">入口</strong>规则的网络策略。对于pod之间的通信，经常会忘记出口&amp;入口规则之间的对称要求。</p><h2 id="601a" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">编辑网络策略</h2><p id="5e70" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">“在每个人的心目中，Kubernetes和YAML真的是不可分割的，”Kubernetes的联合创始人之一Joe Beda在本次演讲中说道。他是对的，这是编写配置文件的推荐方式，正如你在这里看到的<a class="ae kl" href="https://kubernetes.io/docs/concepts/configuration/overview/" rel="noopener ugc nofollow" target="_blank"/>，我合作过的大多数人都使用YAML(而不是JSON)。如果我每次看到有人弄坏YAML文件都能得到一便士，我现在应该很富有了:)。所以帮你自己一个忙，使用一个带有插件的编辑器来帮助你容易地注意/修复这些问题。基本的YAML语法支持肯定会有很大帮助，如果你能得到一个插件，也能更好地理解Kubernetes YAML语法！改进的Kubernetes YAML编辑体验显然不仅有助于网络策略，您还可以通过更愉快的资源编辑体验来改善整个Kubernetes体验。以下是一些建议:</p><ul class=""><li id="a3ac" class="lt lu iq jp b jq jr ju jv jy lv kc lw kg lx kk ly lz ma mb bi translated"><a class="ae kl" href="https://www.youtube.com/watch?v=eSAzGx34gUE" rel="noopener ugc nofollow" target="_blank">这里的</a>是一个视频，这里的<a class="ae kl" href="https://octetz.com/docs/2020/2020-01-06-vim-k8s-yaml-support/" rel="noopener ugc nofollow" target="_blank">这里的</a>是一篇博文，展示了如何使用Vim做到这一点。</li><li id="c177" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">如果Visual Studio代码是你的编辑器选择，你可能想看看这个插件</li><li id="d43d" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">对于大多数编辑器，你至少应该能够获得YAML语法支持，所以继续安装插件或更新你的编辑器配置，以便激活YAML支持。</li></ul><p id="c0ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://editor.cilium.io/" rel="noopener ugc nofollow" target="_blank"> Cilium editor </a>是一个用图形编辑器创建网络策略的工具。尤其是在开始编写网络策略时，可视化交互可能非常有帮助。以下是纤毛编辑器的快照:</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div class="ab gu cl lq"><img src="../Images/29ef4a73ba895b386484b50f6bd6b5ed.png" data-original-src="https://miro.medium.com/v2/0*yq10Q226BJ3CwdbU"/></div></figure><p id="71f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于包括许多不同种类组件的应用程序，例如微服务应用程序，手动编写大量网络策略可能相当麻烦。如果您的应用程序是COTS(商用现货)软件，也许该软件应该提供所有的网络策略，并随着软件及其组件的发展而不断更新。</p><p id="69c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" rel="noopener ugc nofollow" target="_blank" href="/generating-kubernetes-network-policies-by-sniffing-network-traffic-6d5135fe77db">这篇博客</a>讲述了一个关于如何根据实际应用网络流量自动生成网络策略的想法。</p><h2 id="37b2" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">管理</h2><p id="4f77" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">尽管网络策略是定义良好的Kubernetes资源，但出于监管/审计的目的，您的公司可能希望实施特定于他们的某些事情。例如，某些可能提供关于网络策略上下文的更多信息的注释可能是安全部门想要强制执行的，例如网络策略的元数据部分中的<em class="km">k8s.example.com/projectId</em>这样的注释。在这种情况下，记录期望、提供良好网络策略的示例并让平台用户了解文档就变得至关重要。</p><h2 id="ad14" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">Git拉请求救援</h2><p id="a413" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">在大多数需要网络策略的环境中，通常会有一个在kubernetes集群上应用网络策略的过程。这种过程可以是某种批准/审核过程，并且用户不会被授权直接编辑网络策略。一种非常常见的方法是基于Git存储库实现审计流程。这种设置中的典型流程如下所示:</p><ul class=""><li id="63dc" class="lt lu iq jp b jq jr ju jv jy lv kc lw kg lx kk ly lz ma mb bi translated">开发人员检查网络策略所在的Git repo</li><li id="c37a" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">开发人员创建一个新分支，并编辑/创建网络策略</li><li id="2637" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">开发人员基于他的分支创建一个拉请求</li><li id="98d5" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">安全专家需要批准或拒绝拉取请求，并提供足够的信息，说明拒绝拉取请求的原因</li><li id="023f" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">如果一个pull请求被批准，一个管道将获得更改并将其应用到集群上，开发人员将得到通知。</li></ul><p id="690c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的步骤抓住了Git拉请求过程的要点。与传统模式(在ServiceNow等系统中打开票证)相比，可能会有一些改进。例如，用户不再使用一些自由文本或其他格式来捕获数据，而是以一种可以直接在Kubernetes集群上使用的方式来创建网络策略。理想情况下，应该尽可能多地使用自动化来确保网络策略请求得到尽可能正确和快速的处理。</p><p id="1192" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在下一节中，我们将详细介绍如何在没有任何人工交互和GIT的情况下完全自动地创建网络策略。使用类似<a class="ae kl" href="https://github.com/open-policy-agent/gatekeeper" rel="noopener ugc nofollow" target="_blank">看门人</a>和安全人员让整个过程完全自动化，有时是一个太大的概念变化，即负责安全的人员必须理解并可能在这种自动化的实施中合作。使用基于Git的方法，至少有一些自动化，可能已经给你带来了很多好处，并大大缩短了生产时间。以下想法可以嵌入到基于Git拉取请求的流程中:</p><ul class=""><li id="4f31" class="lt lu iq jp b jq jr ju jv jy lv kc lw kg lx kk ly lz ma mb bi translated">编写yaml文件时很容易出错，所以首先要确保传入的Pull请求包含有效的网络策略。使用带有<code class="fe mh mi mj mk b">kubectl apply</code>或<code class="fe mh mi mj mk b">kubectl create</code>的<code class="fe mh mi mj mk b">--dry-run</code>参数，查看网络策略资源文件是否有效。越早发现流程中的验证错误，修复的成本就越低。</li><li id="07ce" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">也许您不能通过自动化自动批准所有传入的网络策略，但您至少可以通过检查IP范围是否被允许、是否有任何跨名称空间的请求等，来使用一些关于传入网络配置文件的有用见解。因此，可能需要一个人来最终批准网络策略，但他的工作可以通过相对便宜的自动化来简化。<a class="ae kl" href="https://www.openpolicyagent.org/docs/latest/" rel="noopener ugc nofollow" target="_blank"> OPA(开放策略代理)</a>及其<a class="ae kl" href="https://www.openpolicyagent.org/docs/latest/#rego" rel="noopener ugc nofollow" target="_blank">减压阀</a> DSL可以帮助您编写一些自动化程序，或者简单地使用您最喜欢的(脚本)语言来解析网络策略文件，并根据您根据组织需求创建的一系列规则对其进行评估。</li></ul><h2 id="1fb8" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">基于OPA/网守的全自动网络策略创建控制</h2><p id="0beb" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated"><a class="ae kl" href="https://www.openpolicyagent.org/" rel="noopener ugc nofollow" target="_blank">开放策略代理(OPA) </a>是一个云本地计算基础项目，旨在解决跨云本地堆栈(Kubernetes、Docker、Envoy、Terraform等)的“策略执行”问题。).OPA附带了一种叫做<a class="ae kl" href="https://www.openpolicyagent.org/docs/latest/policy-language/" rel="noopener ugc nofollow" target="_blank">减压阀</a>的语言来有效地创作策略，除了减压阀，OPA中还有许多工具&amp;组件来更容易&amp;有效地使用策略。</p><p id="a7be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">自动审核网络策略的最快方法是直接在K8S集群上实现。OPA附带了一个叫做<a class="ae kl" href="https://www.openpolicyagent.org/docs/latest/kubernetes-introduction/" rel="noopener ugc nofollow" target="_blank">看门人</a>的组件。Gatekeeper是一个准入控制器，它的目标是在K8S集群上方便地管理和实施策略。也就是说，可以挂钩到Kubernetes的<a class="ae kl" href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/" rel="noopener ugc nofollow" target="_blank">准入控制器</a>机制来拒绝策略不允许的K8S资源修改。通过编写<em class="km">减压阀</em>策略来控制哪些网络策略被允许和拒绝，开发人员将很快得到关于哪些网络流量被允许的反馈。OPA和Gatekeeper是非常有趣的技术，在Kubernetes生态系统中越来越受欢迎，绝对值得花一点时间来更好地理解它。我们计划在另一篇文章中提供一个更实际的例子，说明如何使用减压阀来控制网络策略。</p><h2 id="4322" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">排除故障</h2><p id="1edb" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">使用网络策略的另一个重要阶段是调试网络策略。复杂的应用程序通常通过网络与许多端点进行通信，这有时可能非常耗时&amp;当应用程序出错时，很难找出哪个缺失或配置错误的网络策略是罪魁祸首。在这种情况下，应用程序日志应该提供一些见解。然而，根据应用程序日志的质量或日志搜索工具的可用性，仅有日志可能是不够的。在这种情况下，网络工具可能会提供最大的帮助。</p><p id="564f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在运行目标应用程序pods的Kubernetes节点上运行tcpdump这样的工具可能会非常方便。您可以将tcpdump作为应用程序pods的附属程序运行，或者在Kubernetes节点的界面上运行tcpdump并应用必要的过滤器。这篇文章和<a class="ae kl" href="https://xxradar.medium.com/how-to-tcpdump-effectively-in-kubernetes-part-1-a1546b683d2f" rel="noopener">这篇文章</a>应该会给你一个关于如何做的想法。</p><p id="d87a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，根据你使用的CNI工具，你可以直接从CNI软件中提取有用的信息。对于NSX-T用户来说，<a class="ae kl" href="https://blogs.vmware.com/management/2019/06/kubernetes-insights-using-vrealize-network-insight-part-1.html" rel="noopener ugc nofollow" target="_blank">这个</a>可能会派上用场，对于Cilium也有一些不错的工具，见<a class="ae kl" href="https://docs.cilium.io/en/v1.9/policy/troubleshooting/#policy-tracing" rel="noopener ugc nofollow" target="_blank">这里</a>和<a class="ae kl" href="https://github.com/cilium/hubble" rel="noopener ugc nofollow" target="_blank">这里</a>。对于Antrea，您可能想要检查<a class="ae kl" href="https://github.com/vmware-tanzu/antrea/blob/main/docs/network-flow-visibility.md" rel="noopener ugc nofollow" target="_blank">这个</a>和<a class="ae kl" href="https://en.wikipedia.org/wiki/Iptables" rel="noopener ugc nofollow" target="_blank"> iptables </a>相关问题<a class="ae kl" href="https://github.com/box/kube-iptables-tailer" rel="noopener ugc nofollow" target="_blank">这个</a>。</p></div></div>    
</body>
</html>