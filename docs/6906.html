<html>
<head>
<title>Faster .NET development with Skaffold</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">更快。Skaffold的网络开发</h1>
<blockquote>原文：<a href="https://itnext.io/faster-net-development-on-kubernetes-with-skaffold-38b1d261eed5?source=collection_archive---------1-----------------------#2022-04-09">https://itnext.io/faster-net-development-on-kubernetes-with-skaffold-38b1d261eed5?source=collection_archive---------1-----------------------#2022-04-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/a09c070c41ed59808f874b68fc160b23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xdxkenswOeafaQEC"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">由<a class="ae kc" href="https://unsplash.com/@clark_fransa?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">阿诺·弗朗西斯卡</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="a691" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您现在正在阅读这篇文章，那么您可能已经在部署了。NET应用程序，并寻找提高自己或团队生产率的方法。</p><p id="d228" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尽管我很喜欢Kubernetes作为一个部署平台，但它给开发周期增加了一些摩擦。对于第一次接触基于容器的开发的开发人员来说尤其如此，但不应该是这样。理想情况下，应该有一种方法可以轻松快速地建立一个廉价的Kubernetes集群，并以最快的方式将我们的代码部署到该集群。</p><p id="33b3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">今天，我们将看到如何使用<strong class="kf ir">Skaffold</strong>来实现这一点，ska fold是一个很好的工具，能够在任何Kubernetes集群中构建和部署我们的应用程序。我们将特别关注。NET应用程序，试图在保持简单的同时尽可能减少构建时间。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="688a" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">示例web API项目</h1><p id="1bac" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">虽然Kubernetes可以托管任何类型的工作负载，但最常见的用例之一是托管公开RESTful APIs的服务。还有什么项目比ASP.NET核心的最小API模板更适合这个目的呢？让我们启动我们最喜欢的终端，并基于该模板创建一个新的应用程序:</p><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="57fd" class="mu lj iq mq b gy mv mw l mx my">mkdir SkaffoldDemo<br/>cd SkaffoldDemo<br/>dotnet new webapi -minimal -o SkaffoldDemo --no-https</span></pre><p id="3b20" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们也创建一个解决方案，它很适合包含多个项目的应用程序。</p><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="dbe6" class="mu lj iq mq b gy mv mw l mx my">dotnet new sln<br/>dotnet sln add SkaffoldDemo</span></pre><p id="48a0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">酷，我们现在有了经典的API示例，其中也包括Swagger。我们现在可以为我们的应用程序编写一个合适的docker文件。由于<strong class="kf ir">开发时间是本文<strong class="kf ir"/>的主要关注点，</strong>我们将对其进行优化以减少构建时间。为此，我们将:</p><ul class=""><li id="7d8d" class="mz na iq kf b kg kh kk kl ko nb ks nc kw nd la ne nf ng nh bi translated">小心地放置层，以避免每次都重新构建整个应用程序</li><li id="eeb7" class="mz na iq kf b kg ni kk nj ko nk ks nl kw nm la ne nf ng nh bi translated">利用BuildKit提供的一些缓存技巧</li></ul><p id="1ebf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">除此之外，我们想要构建两个不同的映像:一个适用于<strong class="kf ir">调试</strong>，它运行非优化代码并包含调试符号。另一个将是运行优化代码的<strong class="kf ir">生产就绪</strong>映像。</p><p id="51ba" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您从未听说过BuildKit，它是一个用于构建容器映像的工具包，很像Docker中历史上包含的那个。BuildKit是Docker构建引擎的发展，它采用了许多简洁的技术来加速构建过程。Docker已经包含了这个新的引擎，尽管默认情况下并不使用它。要用BuildKit构建一个图像，只需在标准docker构建命令前面加上<code class="fe nn no np mq b">buildx</code>参数，比如<code class="fe nn no np mq b">docker buildx build .</code>。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="d5c4" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">编写优化的Dockerfile文件</h1><p id="2ed0" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">让我们创建Dockerfile文件。每个片段将在同一个文件中按顺序排列，但是为了方便起见，我们将分别讨论每个片段。</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="f658" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先需要从dotnet SDK镜像说起。这个映像非常大，因为它包含了构建代码所需的一切(比如编译器)，所以我们将只使用这个映像来构建我们的应用程序，这个应用程序稍后将在一个更小的基础映像上发布。</p><p id="3172" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们只复制解决方案/项目文件，因为这些是恢复我们的应用程序的依赖项唯一需要的文件。这并不是说这些步骤要在其他事情之前完成:BuildKit(和Docker)将每个指令放在不同的层中。每次重建映像时，都会检查每一层的依赖关系。在这种情况下，只有当解决方案和项目文件发生更改时，restore命令才会运行。</p><p id="6c25" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以使用BuildKit中包含的另一个简洁的特性:我们可以让它缓存包含所有由<code class="fe nn no np mq b">dotnet restore</code>(位于<em class="ns"> /root/)下载的包的目录。nuget/packages </em>。如果我们添加/升级一个引用，只有丢失的包会被下载，<strong class="kf ir">加速构建过程</strong>。</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="2d89" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以在这里定义一个基础层:</p><ul class=""><li id="0798" class="mz na iq kf b kg kh kk kl ko nb ks nc kw nd la ne nf ng nh bi translated">继承自aspnet <strong class="kf ir">运行时</strong>映像(不包括编译器)，</li><li id="23b5" class="mz na iq kf b kg ni kk nj ko nk ks nl kw nm la ne nf ng nh bi translated">定义调试和生产映像共享的所有公共方面。</li></ul><p id="efb7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦我们有了这个基础层，我们就可以将我们的生产应用程序构建为一个新层(<em class="ns"> publish-release </em>)，然后将最后一层定义为<em class="ns"> release。</em>该层继承自<em class="ns">基础</em>层，并从<em class="ns">发布-发布</em>层复制构建工件。</p><p id="eab5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意，为了构建我们的应用程序，我们需要再次挂载之前添加的NuGet缓存层，否则编译器将找不到包(因为它们被有效地存储在缓存层中)。</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="34d4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以对调试映像重复相同的过程，只需做一些调整，比如安装一些基本的调试工具，这些工具将在本文后面用到。</p><p id="9dbf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在尝试构建我们的应用程序之前，让我们创建一个<code class="fe nn no np mq b">.dockerignore</code>文件，以避免构建文件污染我们的图像。</p><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="cb06" class="mu lj iq mq b gy mv mw l mx my">**/bin<br/>**/obj</span></pre><p id="8ad8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以通过运行以下命令来测试Dockerfile文件:</p><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="21f6" class="mu lj iq mq b gy mv mw l mx my">docker buildx build . --target debug -t skaffold-demo-debug<br/><br/>docker buildx build . --target release -t skaffold-demo-release</span></pre><p id="3a10" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们已经成功地容器化了我们的应用程序，让我们将它部署到Kubernetes集群吧！</p><h1 id="87eb" class="li lj iq bd lk ll nt ln lo lp nu lr ls lt nv lv lw lx nw lz ma mb nx md me mf bi translated">具有种类的本地集群设置</h1><p id="f109" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">不用说，要在Kubernetes上部署，我们需要一个集群。更好的是，它能够在您的开发机器上运行。我们可以借助<strong class="kf ir"> Kind、Minikube、</strong>等工具来实现这一点。我将使用Kind，因为它安装起来非常快，并且只需要Docker启动并运行。</p><p id="8a36" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Kind的安装方式有很多种，都是从官方<a class="ae kc" href="https://kind.sigs.k8s.io/docs/user/quick-start/" rel="noopener ugc nofollow" target="_blank">文档</a>中轻松跟随。要创建集群，只需运行以下命令:</p><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="782d" class="mu lj iq mq b gy mv mw l mx my">kind create cluster --name skaffold-demo</span></pre><p id="e8e4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个命令将启动一个只由一个节点组成的Kubernetes集群。它还配置我们的。kube config有一个新的上下文叫做<strong class="kf ir"> kind-skaffold-demo </strong>。让我们通过运行来测试它:</p><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="4b20" class="mu lj iq mq b gy mv mw l mx my">kubectl get pods -A</span></pre><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/493c9c130a139313e2765ad29c8ea42f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DfFpP_tV7T0zQMQiPjY5Yw.png"/></div></div></figure><p id="7f75" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果一切顺利，您应该会看到一些控制面板吊舱正在启动或运行。现在我们有了一个工作集群和一个到它的连接，我们终于可以谈论Skaffold了。</p><h1 id="6e4d" class="li lj iq bd lk ll nt ln lo lp nu lr ls lt nv lv lw lx nw lz ma mb nx md me mf bi translated">配置斯卡福德</h1><p id="0ed7" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">要安装Skaffold，您可以按照<a class="ae kc" href="https://skaffold.dev/docs/install/" rel="noopener ugc nofollow" target="_blank">官方文档</a>中针对您的操作系统的说明进行操作。安装完成后，我们可以继续配置它。</p><p id="5d2a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">不管你喜不喜欢，Kubernetes生态系统中的许多工具都依赖YAML文件进行配置，Skaffold也不例外。skaffold.yaml文件包含了构建和部署我们的应用程序所需的一切。在我们的例子中，运行它的最低要求是:</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="449e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个文件非常简单明了，除了两件事:</p><ul class=""><li id="fe03" class="mz na iq kf b kg kh kk kl ko nb ks nc kw nd la ne nf ng nh bi translated">我们希望部署调试映像，并指定目标</li><li id="bda3" class="mz na iq kf b kg ni kk nj ko nk ks nl kw nm la ne nf ng nh bi translated">我们还需要向集群部署一些Kubernetes资源</li></ul><p id="68f5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在最后一行，引用了另一个<strong class="kf ir"> yaml </strong>文件。这个文件将包含在集群上部署应用程序所必需的Kubernetes资源，比如一个<em class="ns">部署</em>。将第二个文件放在哪里是一个偏好问题。我喜欢将它们与代码分开，所以我会将它们放在<strong class="kf ir"> deploy </strong>目录中。</p><figure class="ml mm mn mo gt jr"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="0003" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">每次我们要求Skaffold运行我们的应用程序时，它都会:</p><ul class=""><li id="9832" class="mz na iq kf b kg kh kk kl ko nb ks nc kw nd la ne nf ng nh bi translated">建立我们的docker文件</li><li id="a9a8" class="mz na iq kf b kg ni kk nj ko nk ks nl kw nm la ne nf ng nh bi translated">在集群上部署映像(直接部署或部署到存储库中)</li><li id="b56e" class="mz na iq kf b kg ni kk nj ko nk ks nl kw nm la ne nf ng nh bi translated">在<strong class="kf ir">deploy/ska fold-demo . YAML</strong>中创建Kubernetes资源</li><li id="12cb" class="mz na iq kf b kg ni kk nj ko nk ks nl kw nm la ne nf ng nh bi translated">(可选)向新创建的pod打开端口转发</li></ul><p id="8e3e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们通过运行以下命令来看看它的运行情况:</p><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="ebba" class="mu lj iq mq b gy mv mw l mx my">skaffold dev --port-forward</span></pre><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/5cf27bd5311e6a270e8210b795a3e4ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*leMuJpMiMYOqyu1xvEbzWw.png"/></div></div></figure><p id="4696" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将需要更长的时间，我们第一次运行它，因为斯卡福德将需要重建的形象。后续运行会快很多。</p><p id="1d1e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以通过打开浏览器到<a class="ae kc" href="http://localhost:8080/swagger" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/swagger</a>URL来浏览我们的API。</p><p id="b635" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请注意，Skaffold正在监视(Dockerfile使用的每个文件/目录上的)更改。每次我们修改代码，斯卡福德都会在几秒钟内重建并重新启动它。在我的机器上，在对代码做了小的更改后重新部署应用程序只需要11秒钟，这比我以前需要至少40秒钟的工作流程有了很大的改进。</p><p id="7ddb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">停止Skaffold(通过按CTRL-C)也会删除它创建的资源。为了保持部署在集群中运行，我们可以运行以下命令:</p><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="73ff" class="mu lj iq mq b gy mv mw l mx my">skaffold run</span></pre><p id="92ea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们在这里看到的一切也适用于远程Kubernetes集群，但是有一个警告。在<a class="ae kc" href="https://skaffold.dev/docs/environment/local-cluster/" rel="noopener ugc nofollow" target="_blank">许多本地集群</a>上，Skaffold能够将构建的映像直接推送到节点上。在远程集群上，这不仅不受支持，甚至是不可取的，因为这会带来安全风险。在这种情况下，我们需要将映像推送到外部映像存储库，并适当地配置部署。这本来就比较慢，因为映像将被推送到注册表中，然后由群集再次提取来运行它。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><p id="4fe6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我希望这篇文章能够帮助您克服在Kubernetes上构建应用程序时遇到的一些麻烦。Skaffold只是一种方式，但它是一种成熟的、被广泛采用的工具，可以完成工作。</p><p id="5334" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像其他好的技术文章一样，你可以在GitHub上找到这个示例项目。</p><div class="oa ob gp gr oc od"><a href="https://github.com/meronz/skaffold-demo-dotnet" rel="noopener  ugc nofollow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd ir gy z fp oi fr fs oj fu fw ip bi translated">GitHub-meronz/ska ffold-demo-dot net</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">Kubernetes with Skaffold的ASP.NET API服务开发示例。Docker图像有两种版本…</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">github.com</p></div></div><div class="om l"><div class="on l oo op oq om or jw od"/></div></div></a></div><p id="0a36" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你做到了这一步，你可能会喜欢这个教程。如果你愿意，可以考虑跟着我。NET、Docker和Kubernetes。我会尽力分享有用的技巧和窍门！</p><p id="fe8f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">👋🏻直到下一个！</p></div></div>    
</body>
</html>