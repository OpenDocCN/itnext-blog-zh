<html>
<head>
<title>How to restore a failed Azure Service Fabric cluster.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何恢复出现故障的Azure服务结构群集。</h1>
<blockquote>原文：<a href="https://itnext.io/azure-service-fabric-cluster-recovery-33886f1bf44f?source=collection_archive---------3-----------------------#2020-03-25">https://itnext.io/azure-service-fabric-cluster-recovery-33886f1bf44f?source=collection_archive---------3-----------------------#2020-03-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="05ae" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">群集证书到期后。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/ead97b6629b2678124fd583b4401edd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WzW7Om3ynOwxoHT1jqW5Hg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">来自<a class="ae kv" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=362150" rel="noopener ugc nofollow" target="_blank">皮克斯拜</a>的赖安·麦奎尔的图像</figcaption></figure><p id="1288" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">发生了一些事情，尤其是在证书过期的情况下。这种情况最近发生在我身上，我得到了恢复故障集群的任务。本文致力于恢复具有无状态工作负载的基于Windows的Azure服务结构(ASF)集群。</p><blockquote class="ls"><p id="bdf8" class="lt lu iq bd lv lw lx ly lz ma mb lr dk translated">最快的恢复方法是创建一个新的集群并在那里部署无状态服务☺，但是…</p></blockquote><figure class="md me mf mg mh kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mc"><img src="../Images/8d1d5dc1201dcd01399d974a825549ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/0*cbSPT79zK7KOJqbY.jpg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">Azure服务结构群集的手动恢复正在进行中()。</figcaption></figure><blockquote class="mi mj mk"><p id="92f2" class="kw kx ml ky b kz la jr lb lc ld ju le mm lg lh li mn lk ll lm mo lo lp lq lr ij bi translated">TL；灾难恢复；您将获得一个逐步的操作计划，以使用新的主证书来恢复失败的无状态的基于Windows的Azure服务结构群集。群集恢复后，您可以继续KeyVault集成和辅助证书配置。</p></blockquote><p id="1519" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">事实证明，ASF可以在管理证书过期的情况下生存一段时间。因为这些证书(一个主证书和一个辅助证书)用于保护集群通信(升级服务和管理访问)——下一次ASF升级展期将会非常失败。</p><p id="27ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">虽然微软的文档很好，但有些地方明显缺失，所以我决定填补这个空白。有两种官方方式来解决这个问题- <a class="ae kv" href="https://github.com/Azure/Service-Fabric-Troubleshooting-Guides/blob/master/Security/How%20to%20recover%20from%20an%20Expired%20Cluster%20Certificate.md" rel="noopener ugc nofollow" target="_blank">自动</a>和<a class="ae kv" href="https://github.com/Azure/Service-Fabric-Troubleshooting-Guides/blob/master/Security/Fix%20Expired%20Cluster%20Certificate%20Manual%20Steps.md" rel="noopener ugc nofollow" target="_blank">半手动</a>两种方式对我都不起作用。</p><p id="39a0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第一课是使用证书通用名称创建一个ASF集群。不要使用在Azure Key Vault中使用自动生成的证书创建群集的Azure CLI命令。</p><p id="a710" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里的第二个教训是，您必须使用PowerShell脚本自动执行证书过期验证。您还应该将配置参数accept expired pinnedcluster certificate设置为trues，这样即使证书过期，ASF群集也能正常工作。</p><blockquote class="ls"><p id="7465" class="lt lu iq bd lv lw lx ly lz ma mb lr dk translated">警告！不要为有状态服务这样做。</p></blockquote></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><h2 id="7f29" class="mw mx iq bd my mz na dn nb nc nd dp ne lf nf ng nh lj ni nj nk ln nl nm nn no bi translated">找到根本原因。</h2><p id="ee01" class="pw-post-body-paragraph kw kx iq ky b kz np jr lb lc nq ju le lf nr lh li lj ns ll lm ln nt lp lq lr ij bi translated">但首先，让我们深入探讨症状诊断。出现问题的第一个线索是以下Azure Portal视图，该视图显示了一个包含零个节点和零个应用程序的故障集群。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/06201f46b9238ebade617536b18cc47a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1386/format:webp/1*V0RAj1B1RcKHcCVwSAxNMQ.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">Azure门户中的服务结构群集失败。</figcaption></figure><p id="7f9d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">需要以下步骤来检测根本原因。</p><ul class=""><li id="1316" class="nv nw iq ky b kz la lc ld lf nx lj ny ln nz lr oa ob oc od bi translated">打开群集资源组，导航到带有种子节点的虚拟机规模集。通常，它被命名为<code class="fe oe of og oh b">nt1vm_0</code>。</li><li id="66a6" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">打开<code class="fe oe of og oh b">nt1vm_0</code>并通过连接按钮下载RDP连接。节点的示例路径是<code class="fe oe of og oh b"><em class="ml">your-cluster\nt1vm | Instances\nt1vm_0</em></code>。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi on"><img src="../Images/d38f358160605e11fbc8bc7c965c1e04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2AhS6M2P62E2QBgwsNNwww.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">在虚拟机门户刀片中单击此按钮。</figcaption></figure><ul class=""><li id="3c78" class="nv nw iq ky b kz la lc ld lf nx lj ny ln nz lr oa ob oc od bi translated">使用集群虚拟机管理员登录名和密码连接到一台计算机。如果出现连接问题，请仔细检查ASF负载平衡器是否有打开的端口。</li><li id="dc0f" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">如果VM非常慢，并且CPU使用率很高，那么打开任务管理器，将空闲优先级设置为抑制性最强的进程。</li><li id="4402" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">打开服务器事件日志，导航到管理事件部分并搜索ASF错误。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oo"><img src="../Images/88c0d31e3b28a47dbf13c1d5c7ac2411.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sMEJy1kSES6GB3KdqKA0aA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">包含管理事件的Windows server事件日志</figcaption></figure><ul class=""><li id="237f" class="nv nw iq ky b kz la lc ld lf nx lj ny ln nz lr oa ob oc od bi translated">查找位于以下文件夹中的服务结构状态和日志。</li></ul><pre class="kg kh ki kj gt op oh oq or aw os bi"><span id="61c4" class="mw mx iq oh b gy ot ou l ov ow">"C:\WindowsAzure\Logs\AggregateStatus\aggregatestatus.json"</span><span id="c9f9" class="mw mx iq oh b gy ox ou l ov ow">"C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.ServiceFabric.ServiceFabricNode\[extension version]\CommandExecution.log"</span></pre><ul class=""><li id="0aba" class="nv nw iq ky b kz la lc ld lf nx lj ny ln nz lr oa ob oc od bi translated">尝试在此虚拟机上重新安装群集时，服务结构可能处于死循环中。主要症状是服务结构安装程序和引导代理系统服务消耗大量CPU。</li></ul></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><h2 id="aa28" class="mw mx iq bd my mz na dn nb nc nd dp ne lf nf ng nh lj ni nj nk ln nl nm nn no bi translated">短期计划。</h2><p id="d7ad" class="pw-post-body-paragraph kw kx iq ky b kz np jr lb lc nq ju le lf nr lh li lj ns ll lm ln nt lp lq lr ij bi translated">我将从一个没有截图的简短计划开始，并在下一节继续详细的计划。我将用粗体突出显示微软官方文档<a class="ae kv" href="https://github.com/Azure/Service-Fabric-Troubleshooting-Guides/blob/master/Security/Fix%20Expired%20Cluster%20Certificate%20Manual%20Steps.md" rel="noopener ugc nofollow" target="_blank"> GitHub文档</a>中缺失的部分。</p><p id="85bf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我的建议是先修复零种子节点，测试是否有效，再进行剩下的。</p><ul class=""><li id="be75" class="nv nw iq ky b kz la lc ld lf nx lj ny ln nz lr oa ob oc od bi translated">修复“死循环”,打开任务管理器，按CPU使用率对进程进行排序，将最高进程优先级改为空闲，然后立即停止。</li><li id="4315" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">官方文档中的上述步骤对我不起作用，所以我必须重新分配种子节点，一次一个。ASF Windows服务器安装过程大约需要15分钟，另外还需要20分钟。</li><li id="818c" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">停止目标机器上的以下服务<code class="fe oe of og oh b">FabricInstallerService, FabricHostService, ServiceFabricNodeBootstrapAgent</code>。</li><li id="f944" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">将新的群集证书安装到虚拟机根目录。</li><li id="c9b2" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">更改文件中的证书指纹<code class="fe oe of og oh b">D:\SvcFab\_sys_0\Fabric\ClusterManifest.current.xml</code></li><li id="0300" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">将该文件备份到驱动器上的新文件夹<code class="fe oe of og oh b">C:\ClusterFix</code></li><li id="4a0b" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">替换文件<code class="fe oe of og oh b">D:\SvcFab_sys_0\Fabric\Fabric.Data\InfrastructureManifest.xml</code>中的证书指纹</li><li id="71ff" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">在命令提示符下运行以下Powershell命令(不是在PS ISE中)。</li></ul><pre class="kg kh ki kj gt op oh oq or aw os bi"><span id="2a98" class="mw mx iq oh b gy ot ou l ov ow">New-ServiceFabricNodeConfiguration -FabricDataRoot "D:\SvcFab" -FabricLogRoot "D:\SvcFab\Log" -ClusterManifestPath "C:\ClusterFix\clusterManifest.xml" -InfrastructureManifestPath "D:\SvcFab\_sys_0\Fabric\Fabric.Data\InfrastructureManifest.xml"</span></pre><ul class=""><li id="2edd" class="nv nw iq ky b kz la lc ld lf nx lj ny ln nz lr oa ob oc od bi translated">打开文件<code class="fe oe of og oh b">D:\SvcFab\_sys_0\Fabric\Fabric.Package.current.xml</code>并寻找<code class="fe oe of og oh b">ManifestVersion</code>属性，它将指向带有活动集群配置的文件夹。</li><li id="85a9" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">在我的例子中，它是下面的文件夹:<code class="fe oe of og oh b">D:\SvcFab\_sys_0\Fabric\Fabric.Config.4.131473098266979018</code></li><li id="fd65" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">从文件夹中删除只读属性。</li><li id="bf36" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">打开该文件夹中的<code class="fe oe of og oh b">Settings.xml</code>，用新的证书指纹条目替换所有证书指纹条目。</li><li id="63da" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">从Windows服务启动服务结构主机和代理。</li><li id="ce9a" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">打开Azure资源管理器，找到一个群集，单击编辑和更新以重置Azure门户中的ASF群集状态。</li><li id="70bd" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">使用正确的证书URL连接到ASF管理门户。</li></ul><p id="00c6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe oe of og oh b"><a class="ae kv" href="https://your-cluster.northeurope.cloudapp.azure.com:19080/Explorer" rel="noopener ugc nofollow" target="_blank">https://your-cluster.northeurope.cloudapp.azure.com:19080/Explorer</a></code></p></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><h2 id="e77d" class="mw mx iq bd my mz na dn nb nc nd dp ne lf nf ng nh lj ni nj nk ln nl nm nn no bi translated">详细的行动计划。</h2><p id="b781" class="pw-post-body-paragraph kw kx iq ky b kz np jr lb lc nq ju le lf nr lh li lj ns ll lm ln nt lp lq lr ij bi translated">现在让我们深入了解细节。</p><ul class=""><li id="cd98" class="nv nw iq ky b kz la lc ld lf nx lj ny ln nz lr oa ob oc od bi translated">修复“死循环”的方法是打开任务管理器，按CPU使用率对进程进行排序，将最高进程优先级改为空闲优先级，然后完全停止。为了终止进程，使用以下CMD命令获取PID和kill。</li></ul><pre class="kg kh ki kj gt op oh oq or aw os bi"><span id="202b" class="mw mx iq oh b gy ot ou l ov ow">sc queryex FabricHostSvc<br/>taskkill /pid 5364 /f</span></pre><ul class=""><li id="5aed" class="nv nw iq ky b kz la lc ld lf nx lj ny ln nz lr oa ob oc od bi translated">重新分配种子节点，一次一个。ASF设置过程大约需要15分钟到20分钟。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oy"><img src="../Images/cb5fc1f456395a2bf2d0bd1b3be45aa4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7zNbPiQowvgc-8dyd0C9VQ.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">重新成像按钮</figcaption></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oz"><img src="../Images/13ab55ce165c84630043038437393b8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gqdzKTX_SsxVGTejtDgYCg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">如果您没有看到服务结构主机正在运行，并看到以下跟踪错误，请让虚拟机保持20分钟。</figcaption></figure><ul class=""><li id="db77" class="nv nw iq ky b kz la lc ld lf nx lj ny ln nz lr oa ob oc od bi translated">通过RDP连接到目标虚拟机，并检查以下服务是否正在运行。那就阻止他们。<br/>T3。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pa"><img src="../Images/a972244228fde831ac0cec9f464a1b1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AKOqS_tGTMQ9bJO21YhdDw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">停止安装程序。然后是织物主机。</figcaption></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pb"><img src="../Images/31ae5896e1fc870704e1bdac8d1749bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6klhwc768d7axQ2ifWreNA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">停止节点引导升级，然后停止引导代理。</figcaption></figure><ul class=""><li id="97b8" class="nv nw iq ky b kz la lc ld lf nx lj ny ln nz lr oa ob oc od bi translated">将新的群集证书安装到虚拟机根目录。</li><li id="b02f" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">更改文件中的证书指纹<code class="fe oe of og oh b">D:\SvcFab\_sys_0\Fabric\ClusterManifest.current.xml</code></li><li id="5481" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">将该文件复制到新文件夹<code class="fe oe of og oh b">C:\ClusterFix</code></li><li id="195d" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">用新的证书指纹条目替换证书指纹条目<code class="fe oe of og oh b">D:\SvcFab_sys_0\Fabric\Fabric.Data\InfrastructureManifest.xml</code></li><li id="3e9a" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">在PS命令提示符下(不是在PS ISE中)运行以下Powershell命令。由于目标基础结构清单文件上的旧Powershell版本或只读访问属性，该命令可能会失败。</li></ul><pre class="kg kh ki kj gt op oh oq or aw os bi"><span id="4090" class="mw mx iq oh b gy ot ou l ov ow">New-ServiceFabricNodeConfiguration -FabricDataRoot "D:\SvcFab" -FabricLogRoot "D:\SvcFab\Log" -ClusterManifestPath "C:\ClusterFix\clusterManifest.xml" -InfrastructureManifestPath "D:\SvcFab\_sys_0\Fabric\Fabric.Data\InfrastructureManifest.xml"</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pc"><img src="../Images/a6bae27b3039a7dd0621f272fc9f996f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bpJ9uB6FioDViD1R00XMJg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">导航到目标文件夹并删除只读属性。</figcaption></figure><p id="0bb4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用脚本安装最新的PowerShell版本:</p><pre class="kg kh ki kj gt op oh oq or aw os bi"><span id="0a8b" class="mw mx iq oh b gy ot ou l ov ow">iex “&amp; { $(irm <a class="ae kv" href="https://aka.ms/install-powershell.ps1" rel="noopener ugc nofollow" target="_blank">https://aka.ms/install-powershell.ps1</a>) } -UseMSI”<br/>$PSVersionTable.PSVersion</span></pre><ul class=""><li id="5865" class="nv nw iq ky b kz la lc ld lf nx lj ny ln nz lr oa ob oc od bi translated">打开文件<code class="fe oe of og oh b">D:\SvcFab\_sys_0\Fabric\Fabric.Package.current.xml</code>并寻找<code class="fe oe of og oh b">ManifestVersion</code>属性，它将指向带有活动集群配置的文件夹。要小心，要选择正确的文件夹来编辑。</li><li id="5576" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">在我的例子中，它是下面的文件夹:<code class="fe oe of og oh b">D:\SvcFab\_sys_0\Fabric\Fabric.Config.4.131473098266979018</code></li><li id="5f13" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">打开此文件夹内的<code class="fe oe of og oh b">Settings.xml</code>，用新的证书指纹条目替换所有证书指纹条目。</li><li id="9aff" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated">从Windows服务启动服务结构主机和代理:</li></ul><pre class="kg kh ki kj gt op oh oq or aw os bi"><span id="cfed" class="mw mx iq oh b gy ot ou l ov ow">net start FabricHostSvc <br/>net start ServiceFabricNodeBootstrapAgent</span></pre><ul class=""><li id="3ff4" class="nv nw iq ky b kz la lc ld lf nx lj ny ln nz lr oa ob oc od bi translated">10分钟后使用以下PowerShell脚本测试连接，确保证书安装在您的计算机上。</li></ul><pre class="kg kh ki kj gt op oh oq or aw os bi"><span id="c5e4" class="mw mx iq oh b gy ot ou l ov ow">$ClusterName= "your-cluster.northeurope.cloudapp.azure.com:19000"</span><span id="7e37" class="mw mx iq oh b gy ox ou l ov ow">$Certthumprint = "AAAAAAAAAAAAAAAAAAAAAAA"</span><span id="9e7e" class="mw mx iq oh b gy ox ou l ov ow">Connect-ServiceFabricCluster -ConnectionEndpoint $ClusterName -KeepAliveIntervalInSec 10 `</span><span id="6d32" class="mw mx iq oh b gy ox ou l ov ow">-X509Credential `</span><span id="7bdf" class="mw mx iq oh b gy ox ou l ov ow">-ServerCertThumbprint $Certthumprint  `</span><span id="266c" class="mw mx iq oh b gy ox ou l ov ow">-FindType FindByThumbprint `</span><span id="f3af" class="mw mx iq oh b gy ox ou l ov ow">-FindValue $Certthumprint `</span><span id="c7be" class="mw mx iq oh b gy ox ou l ov ow">-StoreLocation CurrentUser `</span><span id="c39b" class="mw mx iq oh b gy ox ou l ov ow">-StoreName My</span></pre><ul class=""><li id="8f54" class="nv nw iq ky b kz la lc ld lf nx lj ny ln nz lr oa ob oc od bi translated">打开Azure资源管理器，找到一个群集，单击编辑和更新以重置Azure门户中的ASF群集状态。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pd"><img src="../Images/d7976919d0f08ce13ddd083032a8fcaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dPiLk1tBOne50X4z7SxEWA.png"/></div></div></figure><ul class=""><li id="4ec3" class="nv nw iq ky b kz la lc ld lf nx lj ny ln nz lr oa ob oc od bi translated">使用正确的证书URL连接到ASF管理门户。</li></ul><p id="1b4b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe oe of og oh b"><a class="ae kv" href="https://your-cluster.northeurope.cloudapp.azure.com:19080/Explorer" rel="noopener ugc nofollow" target="_blank">https://your-cluster.northeurope.cloudapp.azure.com:19080/Explorer</a></code></p></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><h2 id="c1d8" class="mw mx iq bd my mz na dn nb nc nd dp ne lf nf ng nh lj ni nj nk ln nl nm nn no bi translated">总结。</h2><p id="f4bd" class="pw-post-body-paragraph kw kx iq ky b kz np jr lb lc nq ju le lf nr lh li lj ns ll lm ln nt lp lq lr ij bi translated">因此，最简单的解决方案是创建一个集群副本，忘记恢复，下一个乐观的场景是使用PowerShell脚本进行自动恢复。而如果你有我这种极其不幸的案例，那么这篇文章就达到了目的。</p><p id="3db9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我知道这是一个无聊的教程，但它可以拯救你的一天:)。</p><p id="b34d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">就这样，感谢阅读。干杯！</strong></p></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><h1 id="8d70" class="pe mx iq bd my pf pg ph nb pi pj pk ne jw pl jx nh jz pm ka nk kc pn kd nn po bi translated">有用的链接。</h1><ul class=""><li id="0a77" class="nv nw iq ky b kz np lc nq lf pp lj pq ln pr lr oa ob oc od bi translated"><a class="ae kv" href="https://github.com/Azure/Service-Fabric-Troubleshooting-Guides/blob/master/Security/How%20to%20recover%20from%20an%20Expired%20Cluster%20Certificate.md" rel="noopener ugc nofollow" target="_blank">如何从过期的集群证书中自动恢复</a>。</li><li id="0590" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated"><a class="ae kv" href="https://github.com/Azure/Service-Fabric-Troubleshooting-Guides/blob/master/Security/Fix%20Expired%20Cluster%20Certificate%20Manual%20Steps.md" rel="noopener ugc nofollow" target="_blank">如何修复过期的集群证书？手动步骤</a>。</li><li id="5c69" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated"><a class="ae kv" href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-security-update-certs-azure" rel="noopener ugc nofollow" target="_blank">在ASF中添加或删除证书。MS docs。</a></li><li id="5d88" class="nv nw iq ky b kz oi lc oj lf ok lj ol ln om lr oa ob oc od bi translated"><a class="ae kv" href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-security" rel="noopener ugc nofollow" target="_blank"> Azure服务架构集群安全场景。</a></li></ul></div></div>    
</body>
</html>