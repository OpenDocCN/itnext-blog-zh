<html>
<head>
<title>FFmpeg.wasm, a pure WebAssembly / Javascript port of FFmpeg</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">FFmpeg.wasm，FFmpeg的纯WebAssembly / Javascript端口</h1>
<blockquote>原文：<a href="https://itnext.io/ffmpeg-wasm-a-pure-webassembly-javascript-port-of-ffmpeg-f13de6402452?source=collection_archive---------0-----------------------#2020-11-04">https://itnext.io/ffmpeg-wasm-a-pure-webassembly-javascript-port-of-ffmpeg-f13de6402452?source=collection_archive---------0-----------------------#2020-11-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/f69d28612d7cc814cb0ddb8f4a4dbd6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*40PV9XbaxN75GHtraxoO6A.png"/></div></div></figure><p id="7fbd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">官方网站:<a class="ae kz" href="https://ffmpegwasm.github.io/" rel="noopener ugc nofollow" target="_blank">https://ffmpegwasm.github.io/</a></p><p id="58bc" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当谈到视频/音频处理时，ffmpeg是一个著名的框架/工具，现在有了ffmpeg.wasm，你可以在浏览器中使用FFmpeg，而无需安装或将文件上传到服务器。虽然ffmpeg.wasm没有ffmpeg快，但对于某些用例来说，它可能会派上用场。</p><p id="5a8f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这篇文章中，我想分享如何安装和使用ffmpeg.wasm，以及支持你使用的技术细节。</p><h1 id="05e0" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">安装ffmpeg.wasm</h1><p id="ea8a" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">要安装和使用ffmpeg.wasm，只需要使用npm/yarn:</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="0614" class="mm lb it mi b gy mn mo l mp mq">$ npm install @ffmepg/ffmpeg<br/># or<br/>$ yarn add @ffmpeg/ffmpeg</span></pre><p id="35cd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要在节点环境下使用ffmpeg.wasm，还需要安装<code class="fe mr ms mt mi b">@ffmpeg/core</code>。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="fda7" class="mm lb it mi b gy mn mo l mp mq">$ npm install @ffmepg/core<br/># or<br/>$ yarn add @ffmpeg/core</span></pre><p id="a685" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">或者你可以使用CDN</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="b8fc" class="mm lb it mi b gy mn mo l mp mq">&lt;script src='https://unpkg.com/@ffmpeg/ffmpeg@0.9.3/dist/ffmpeg.min.js'&gt;&lt;/script&gt;</span></pre><h1 id="c374" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">使用ffmpeg.wasm</h1><p id="4f1b" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">要使用ffmpeg.wasm，只需要几行代码:</p><figure class="md me mf mg gt ju"><div class="bz fp l di"><div class="mu mv l"/></div></figure><blockquote class="mw mx my"><p id="0167" class="kb kc mz kd b ke kf kg kh ki kj kk kl na kn ko kp nb kr ks kt nc kv kw kx ky im bi translated">在node中执行脚本时，不要忘记添加<code class="fe mr ms mt mi b">--experimental-wasm-threads</code>和<code class="fe mr ms mt mi b">--experimental-wasm-bulk-memory</code>。</p></blockquote><p id="d597" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">你也可以在官方网站尝试现场演示:<a class="ae kz" href="https://ffmpegwasm.github.io/#demo" rel="noopener ugc nofollow" target="_blank">https://ffmpegwasm.github.io/#demo</a></p><figure class="md me mf mg gt ju gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/96b1a80bdb59308b0eae5472d518d1c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*gV8HwSk-3ombFWxZfjJO1g.gif"/></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">将AVI转码为x264 MP4的演示</figcaption></figure><h1 id="cb6d" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">幕后</h1><p id="f164" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">为了充分利用/理解ffmpeg.wasm的强大功能(对于大多数WebAssembly库也是如此)，您可能想知道一些技术细节:</p><h2 id="7830" class="mm lb it bd lc ni nj dn lg nk nl dp lk km nm nn lo kq no np ls ku nq nr lw ns bi translated">ffmpeg.load()内部</h2><p id="e01a" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated"><code class="fe mr ms mt mi b">ffmpeg.load()</code>是在调用其他API之前需要调用的API。这个API内部的情况是:</p><ol class=""><li id="323a" class="nt nu it kd b ke kf ki kj km nv kq nw ku nx ky ny nz oa ob bi translated">从远程服务器下载ffmpeg-core.js(大约25MB)</li><li id="bd57" class="nt nu it kd b ke oc ki od km oe kq of ku og ky ny nz oa ob bi translated">实例化ffmpeg.wasm wasm代码</li></ol><p id="7fff" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">根据您的网络速度和主机硬件，此操作可能需要几分钟才能完成。</p><h2 id="efd0" class="mm lb it bd lc ni nj dn lg nk nl dp lk km nm nn lo kq no np ls ku nq nr lw ns bi translated">文件系统</h2><p id="cf41" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">当你查看ffmpeg.wasm的API时，你可能会发现一个叫做<code class="fe mr ms mt mi b">ffmpeg.FS()</code>的API来处理文件系统操作。(在ffmpeg.wasm中我们使用MEMFS / Memory文件系统)你可以把这个FS想象成一个硬盘，你可以把输入文件放在那里，从ffmpeg.wasm命令中拉出输出文件。这是必不可少的，因为我们希望保持FFmpeg源代码的最小变化，并保留其与原始命令行界面的最大相似性。您可能会使用的一些命令操作:</p><ul class=""><li id="bf54" class="nt nu it kd b ke kf ki kj km nv kq nw ku nx ky oh nz oa ob bi translated"><code class="fe mr ms mt mi b">ffmpeg.FS('writeFile', 'filename', data)</code>:将文件写入MEMFS，作为ffmpeg.wasm的输入</li><li id="322a" class="nt nu it kd b ke oc ki od km oe kq of ku og ky oh nz oa ob bi translated"><code class="fe mr ms mt mi b">ffmpeg.FS('readFile', 'filename')</code>:从MEMFS中读取文件作为ffmpeg.wasm的输出</li><li id="e13f" class="nt nu it kd b ke oc ki od km oe kq of ku og ky oh nz oa ob bi translated"><code class="fe mr ms mt mi b">ffmpeg.FS('unlink', 'filename')</code>:删除MEMFS中的文件</li><li id="8f4b" class="nt nu it kd b ke oc ki od km oe kq of ku og ky oh nz oa ob bi translated"><code class="fe mr ms mt mi b">ffmpeg.FS('readdir', '/')</code>:列出特定路径下的文件</li></ul><p id="3ebb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">完整的api列表，可以查看:<a class="ae kz" href="https://emscripten.org/docs/api_reference/Filesystem-API.html" rel="noopener ugc nofollow" target="_blank">https://EMS cripten . org/docs/API _ reference/file system-API . html</a></p><h2 id="7da5" class="mm lb it bd lc ni nj dn lg nk nl dp lk km nm nn lo kq no np ls ku nq nr lw ns bi translated">SharedArrayBuffer</h2><p id="072c" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">SharedArrayBuffer是JavaScript中一个非常新的数据类型，目前大多数浏览器由于安全问题仍然缺乏完全的支持。但是在ffmpeg.wasm中，要使pthread /多线程支持加速，它是一个必须使用的数据类型。</p><ul class=""><li id="05e8" class="nt nu it kd b ke kf ki kj km nv kq nw ku nx ky oh nz oa ob bi translated">SharedArrayBuffer简介:<a class="ae kz" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer" rel="noopener ugc nofollow" target="_blank">https://developer . Mozilla . org/en-US/docs/Web/JavaScript/Reference/Global _ Objects/SharedArrayBuffer</a></li><li id="aca1" class="nt nu it kd b ke oc ki od km oe kq of ku og ky oh nz oa ob bi translated">可以用SharedArrayBuffer吗？:<a class="ae kz" href="https://caniuse.com/sharedarraybuffer" rel="noopener ugc nofollow" target="_blank">https://caniuse.com/sharedarraybuffer</a></li></ul><h2 id="f7d1" class="mm lb it bd lc ni nj dn lg nk nl dp lk km nm nn lo kq no np ls ku nq nr lw ns bi translated">网络工作者</h2><p id="7e99" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">当你运行<code class="fe mr ms mt mi b">ffmpeg.run()</code>时，你可能会发现大量的网络工作者产生了。这是一个正常的情况，因为web工作人员在FFmpeg中模拟线程，这很好，因为我们不希望ffmpeg.wasm阻塞我们的主线程。</p><h2 id="7145" class="mm lb it bd lc ni nj dn lg nk nl dp lk km nm nn lo kq no np ls ku nq nr lw ns bi translated">利用CPU能力</h2><p id="3124" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">因为大多数库都使用ffmpeg(例如x264)，他们使用类似x86的汇编语言来加快进程。但遗憾的是，WebAssembly不能直接使用这些x86汇编代码，因为它不兼容或者不支持某些指令。因此，将x86程序集移植到SIMD程序集以使其工作需要时间。</p></div><div class="ab cl oi oj hx ok" role="separator"><span class="ol bw bk om on oo"/><span class="ol bw bk om on oo"/><span class="ol bw bk om on"/></div><div class="im in io ip iq"><p id="4b94" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">它还有很长的路要走，因为ffmpeg.wasm仍然处于早期阶段(现在只有v0.9)，虽然与原始版本相比它仍然非常慢，但随着WebAssembly的增长和发展，我相信它会变得越来越有用。😃</p><p id="db6d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">欢迎随时尝试和评论，问题或/和公关！</p><p id="99a7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">github:<a class="ae kz" href="https://github.com/ffmpegwasm/ffmpeg.wasm" rel="noopener ugc nofollow" target="_blank">https://github.com/ffmpegwasm/ffmpeg.wasm</a></p></div></div>    
</body>
</html>