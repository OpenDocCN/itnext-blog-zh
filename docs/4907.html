<html>
<head>
<title>Airgap Image Mirroring for OpenShift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">OpenShift的Airgap镜像</h1>
<blockquote>原文：<a href="https://itnext.io/airgap-image-mirroring-for-openshift-5dc56b464c64?source=collection_archive---------2-----------------------#2020-10-21">https://itnext.io/airgap-image-mirroring-for-openshift-5dc56b464c64?source=collection_archive---------2-----------------------#2020-10-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="758b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在气隙开放移位环境中的Rook Ceph算子设置</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/1f135b982f054b07a1cb85b560bff050.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nf6t9owTVR1E40lzswG-Uw.png"/></div></div></figure><p id="2270" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在airgap环境中，获取容器图像的挑战始终存在。您可以直接填充到<a class="ae lq" href="https://medium.com/@zhimin.wen/loading-of-oci-images-in-an-airgap-environment-a9c9ec01cbfe" rel="noopener">本地容器存储</a>中，或者更完整的解决方案是建立一个镜像注册表，让OpenShift从那里获取图像。</p><p id="7678" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">本文以Rook Ceph算子为例，记录了气隙镜像的步骤。</p><h2 id="ebff" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">设置本地注册表</h2><p id="0ab9" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">本地注册表用于托管从互联网下载的所有图像，供airgap OpenShift使用。很可能您已经准备好了这个用来设置OpenShift的注册表。您可以参考<a class="ae lq" href="https://medium.com/@zhimin.wen/airgap-disconnected-installation-of-openshift-4-2-abd7794fc7fe" rel="noopener">本</a>了解当地注册表的更多详情。</p><p id="ca36" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你有OpenShift注册表，你可以把它用于本地注册表*。然而，由于我设置Rook Ceph是为了满足注册表的持久容量需求，这是一个先有鸡还是先有蛋的问题，所以我将使用在OpenShift之外运行的本地注册表。</p><p id="a32c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><em class="mp"> * OpenShift注册表实际上是基于docker注册表API V2的。设置好车之后，我用Skopeo工具测试了镜像图像。我没有一个问题来推动一个单拱图像。然而，如果是多拱图像，我在使用Skopeo复制图像时会遇到500 HTTP错误。测试在OCP 4.5.15上进行。</em></p><h2 id="bb29" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated"><strong class="ak">使用Skopeo下载图像文件</strong></h2><p id="bfdd" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">确定所需的图像。然后在面向互联网的服务器上，使用Skopeo将图像镜像到一个目录中。</p><p id="a3f4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">对于当前车，需要以下图像。</p><pre class="kj kk kl km gt mq mr ms mt aw mu bi"><span id="e850" class="lr ls it mr b gy mv mw l mx my">docker.io/ceph/ceph:v15.2.4<br/>docker.io/rook/ceph:master<br/>quay.io/cephcsi/cephcsi:v3.1.1<br/>k8s.gcr.io/sig-storage/csi-node-driver-registrar:v2.0.1<br/>k8s.gcr.io/sig-storage/csi-resizer:v1.0.0<br/>k8s.gcr.io/sig-storage/csi-provisioner:v2.0.0<br/>k8s.gcr.io/sig-storage/csi-snapshotter:v3.0.0<br/>k8s.gcr.io/sig-storage/csi-attacher:v3.0.0</span></pre><p id="2383" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">对于其中的每一个，请执行以下操作:</p><pre class="kj kk kl km gt mq mr ms mt aw mu bi"><span id="5fe3" class="lr ls it mr b gy mv mw l mx my">mkdir -p $HOME/rookImages/ceph-v15.2.4</span><span id="d38f" class="lr ls it mr b gy mz mw l mx my">skopeo copy --all docker://docker.io/ceph/ceph:v15.2.4 dir://$HOME/rookImages/ceph-v15.2.4</span></pre><p id="62c5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我使用标记名作为目录名的一部分。请注意“— all”标志，如果是多拱图像，它将下载所有图像，以便匹配正确的图像摘要值。</p><p id="bd33" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在我们已经下载了所有的图像，然后我们可以复制并将其传输到本地注册表中。</p><h2 id="e4f7" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">将图像加载到airgap本地注册表</h2><p id="58d7" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">移动到本地注册服务器(<code class="fe na nb nc mr b">airgap-45-lb.airgap-ocp45.ibmcloud.io.cpak:5000)</code>)，将图像加载到其中。</p><pre class="kj kk kl km gt mq mr ms mt aw mu bi"><span id="f2fd" class="lr ls it mr b gy mv mw l mx my">skopeo login -u admin -p xxxxx airgap-45-lb.airgap-ocp45.ibmcloud.io.cpak:5000</span></pre><p id="f572" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">对每一幅图像将其加载到注册表中，例如，</p><pre class="kj kk kl km gt mq mr ms mt aw mu bi"><span id="af4a" class="lr ls it mr b gy mv mw l mx my">skopeo copy --all  dir:$HOME/rookImages/ceph-v15.2.4 docker://airgap-45-lb.airgap-ocp45.ibmcloud.io.cpak:5000/ceph/ceph:v15.2.4</span></pre><h2 id="8ad8" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">创建open shift ImageContentSourcePolicy</h2><p id="b63a" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">用<code class="fe na nb nc mr b">oc apply</code>将下面的YAML文件应用到OpenShift中，</p><pre class="kj kk kl km gt mq mr ms mt aw mu bi"><span id="6f94" class="lr ls it mr b gy mv mw l mx my">apiVersion: operator.openshift.io/v1alpha1<br/>kind: ImageContentSourcePolicy<br/>metadata:<br/>  name: rook-ceph-images<br/>spec:<br/>  repositoryDigestMirrors:<br/>  - mirrors:<br/>    - airgap-45-lb.airgap-ocp45.ibmcloud.io.cpak:5000/ceph<br/>    source: docker.io/ceph<br/>  - mirrors:<br/>    - airgap-45-lb.airgap-ocp45.ibmcloud.io.cpak:5000/rook<br/>    source: docker.io/rook<br/>  - mirrors:<br/>    - airgap-45-lb.airgap-ocp45.ibmcloud.io.cpak:5000/sig-storage<br/>    source: k8s.gcr.io/sig-storage<br/>  - mirrors:<br/>    - airgap-45-lb.airgap-ocp45.ibmcloud.io.cpak:5000/cephcsi<br/>    source: quay.io/cephcsi</span></pre><p id="b870" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">对于每个图像存储库，图像内容源策略定义了本地注册表的镜像。例如，docker.io/ceph报告中的原始图像将映射到airgap-45-lb.airgap-ocp45.ibmcloud.io.cpak:5000/ceph,，因此图像docker.io/ceph/ceph:v15.2.4将从airgap-45-lb . airgap-OCP 45 . IBM cloud . io . cpak:5000/ceph:v 15 . 2 . 4的镜像中提取</p><p id="a3a6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">一旦应用了YAML，OpenShift machine-config集群操作符将更新每个节点上的crio注册表配置设置，并让它重新加载配置。在此过程中，节点被标记为不可调度，直到它完成此过程。</p><p id="3c1b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">自动生成并更新的<code class="fe na nb nc mr b">/etc/container/registries.conf</code>文件如下:</p><pre class="kj kk kl km gt mq mr ms mt aw mu bi"><span id="6b5c" class="lr ls it mr b gy mv mw l mx my">unqualified-search-registries = ["registry.access.redhat.com", "docker.io"]</span><span id="fcd5" class="lr ls it mr b gy mz mw l mx my">[[registry]]<br/>  prefix = ""<br/>  location = "docker.io/ceph"<br/>  mirror-by-digest-only = true</span><span id="963f" class="lr ls it mr b gy mz mw l mx my">  [[registry.mirror]]<br/>    location = "airgap-45-lb.airgap-ocp45.ibmcloud.io.cpak:5000/ceph"</span><span id="478b" class="lr ls it mr b gy mz mw l mx my">[[registry]]<br/>  prefix = ""<br/>  location = "docker.io/rook"<br/>  mirror-by-digest-only = true</span><span id="9060" class="lr ls it mr b gy mz mw l mx my">  [[registry.mirror]]<br/>    location = "airgap-45-lb.airgap-ocp45.ibmcloud.io.cpak:5000/rook"</span><span id="4f63" class="lr ls it mr b gy mz mw l mx my">[[registry]]<br/>  prefix = ""<br/>  location = "k8s.gcr.io/sig-storage"<br/>  mirror-by-digest-only = true</span><span id="00a0" class="lr ls it mr b gy mz mw l mx my">  [[registry.mirror]]<br/>    location = "airgap-45-lb.airgap-ocp45.ibmcloud.io.cpak:5000/sig-storage"</span><span id="5ca7" class="lr ls it mr b gy mz mw l mx my">[[registry]]<br/>  prefix = ""<br/>  location = "quay.io/cephcsi"<br/>  mirror-by-digest-only = true</span><span id="f418" class="lr ls it mr b gy mz mw l mx my">  [[registry.mirror]]<br/>    location = "airgap-45-lb.airgap-ocp45.ibmcloud.io.cpak:5000/cephcsi"</span><span id="a6bc" class="lr ls it mr b gy mz mw l mx my">[[registry]]<br/>  prefix = ""<br/>  location = "quay.io/openshift-release-dev/ocp-release"<br/>  mirror-by-digest-only = true</span><span id="ca37" class="lr ls it mr b gy mz mw l mx my">  [[registry.mirror]]<br/>    location = "airgap-45-lb.airgap-ocp45.ibmcloud.io.cpak:5000/ocp4/openshift4"</span><span id="3609" class="lr ls it mr b gy mz mw l mx my">[[registry]]<br/>  prefix = ""<br/>  location = "quay.io/openshift-release-dev/ocp-v4.0-art-dev"<br/>  mirror-by-digest-only = true</span><span id="547f" class="lr ls it mr b gy mz mw l mx my">  [[registry.mirror]]<br/>    location = "airgap-45-lb.airgap-ocp45.ibmcloud.io.cpak:5000/ocp4/openshift4"</span></pre><p id="abf5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在这个TOML格式文件中，为每个源注册表定义了一个指向本地注册表的镜像。除了安装过程中定义的OCP回购协议之外，还包括新车回购协议。</p><p id="2bfb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意标志<strong class="kw iu"> mirror-by-digest-only </strong>被设置为true，这告诉我们图像必须被摘要值引用，只有这样，图像才会从它的镜像(本地注册表)中取出。</p><h2 id="fb09" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">引用部署中的映像</h2><p id="0e18" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">为了部署Rook操作符，我们需要更新它的对象定义，以使用SHA256摘要格式的图像。例如，原始图像</p><p id="2c3b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe na nb nc mr b">docker.io/rook/ceph:master</code></p><p id="00c8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">需要更新为</p><p id="ca6d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe na nb nc mr b"><em class="mp">docker.io/ceph/ceph@sha256:</em>637a92f1b356674a434b13299077ec40cf23f70e0b000b944f4954bdec4eaca8</code></p><p id="da49" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们使用其原始YAML设置部署操作符，然后更新映像，</p><pre class="kj kk kl km gt mq mr ms mt aw mu bi"><span id="e376" class="lr ls it mr b gy mv mw l mx my">kubectl -n rook-ceph set image deploy/rook-ceph-operator rook-ceph-operator=docker.io/rook/ceph@sha256:637a92f1b356674a434b13299077ec40cf23f70e0b000b944f4954bdec4eaca8</span></pre><p id="ef94" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">对于CSI相关的图像，我们可以修补设置图像版本的配置图，</p><pre class="kj kk kl km gt mq mr ms mt aw mu bi"><span id="ca3f" class="lr ls it mr b gy mv mw l mx my">kubectl -n rook-ceph patch cm/rook-ceph-operator-config --type merge -p '{"data":{"ROOK_CSI_ATTACHER_IMAGE":"k8s.gcr.io/sig-storage/csi-attacher@sha256:bc6d3ca87c62a2587470ba7adca84e9e5e7db61be1a35176084cc9ec3b4a87d5","ROOK_CSI_CEPH_IMAGE":"quay.io/cephcsi/cephcsi@sha256:afd643c2805029f14862bf8976916ce6ec894b172334eae7c4a74bd717df8f2d","ROOK_CSI_PROVISIONER_IMAGE":"k8s.gcr.io/sig-storage/csi-provisioner@sha256:271b0049ba7885e536d575a72ef56ab3b94c6989f36812d3fe4d886c4d8aed96","ROOK_CSI_REGISTRAR_IMAGE":"k8s.gcr.io/sig-storage/csi-node-driver-registrar@sha256:e07f914c32f0505e4c470a62a40ee43f84cbf8dc46ff861f31b14457ccbad108","ROOK_CSI_RESIZER_IMAGE":"k8s.gcr.io/sig-storage/csi-resizer@sha256:5a8d85cdd1c80f43fb8fe6dcde1fae707a3177aaf0a786ff4b9f6f20247ec3ff","ROOK_CSI_SNAPSHOTTER_IMAGE":"k8s.gcr.io/sig-storage/csi-snapshotter@sha256:ece29e2217e0faf87973565c062c8508c2b78039169e855032bb357acefa3c98"}}'</span></pre><p id="0a04" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当你定义车群CR时，也用摘要格式更新Ceph图像。</p><p id="6fc6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在你将有气隙车Ceph设置和运行。</p></div></div>    
</body>
</html>