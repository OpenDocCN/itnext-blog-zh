<html>
<head>
<title>Getting Started with GitOps with Flux and Gitlab</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Flux和Gitlab开始使用GitOps</h1>
<blockquote>原文：<a href="https://itnext.io/getting-started-with-gitops-with-flux-and-gitlab-9d8ac2cec0cc?source=collection_archive---------4-----------------------#2020-10-26">https://itnext.io/getting-started-with-gitops-with-flux-and-gitlab-9d8ac2cec0cc?source=collection_archive---------4-----------------------#2020-10-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6fd0" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解如何使用GitOps方法来简化您的Kubernetes部署。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e5fe54f5e73792cb132147a7609de104.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dxV-8VfQJXqhxi30.png"/></div></div></figure><p id="476b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">GitOps是一种Kubernetes应用交付方法。它旨在简化Kubernetes应用程序的部署和操作。</p><p id="df35" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在本文中，我们将使用<a class="ae lq" href="https://fluxcd.io/" rel="noopener ugc nofollow" target="_blank"> Flux </a>，它可以作为Kubernetes操作器安装。</p><p id="1035" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Flux操作符保持集群状态和存储库同步。存储库中的任何配置更改都会自动应用到<a class="ae lq" href="https://codersociety.com/blog/articles/terraform-azure-kubernetes" rel="noopener ugc nofollow" target="_blank"> Kubernetes集群</a>中。</p><p id="4343" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在本指南中，我们将通过Git库设置Flux并部署一个演示应用程序。</p><h2 id="428b" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">先决条件</h2><p id="1bee" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">首先，我们需要<code class="fe mp mq mr ms b">kubectl</code>连接到一个Kubernetes集群和Gitlab中的一个Git存储库。</p><h2 id="0275" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">安装fluxctl</h2><p id="6055" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated"><code class="fe mp mq mr ms b">fluxctl</code>是与Flux交互的命令行工具。在macOS上，你可以用自制软件安装<code class="fe mp mq mr ms b">fluxctl</code>。</p><pre class="kj kk kl km gt mt ms mu mv aw mw bi"><span id="2962" class="lr ls it ms b gy mx my l mz na">brew install fluxctl</span></pre><p id="8550" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">您可以在这里找到其他平台的安装说明:<a class="ae lq" href="https://docs.fluxcd.io/en/1.17.1/references/fluxctl.html" rel="noopener ugc nofollow" target="_blank">https://docs.fluxcd.io/en/1.17.1/references/fluxctl.html</a></p><h2 id="af3e" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">为Flux创建一个Kubernetes名称空间</h2><p id="933a" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">让我们首先为Flux操作符创建一个名称空间。</p><pre class="kj kk kl km gt mt ms mu mv aw mw bi"><span id="4794" class="lr ls it ms b gy mx my l mz na">kubectl create namespace flux</span></pre><h2 id="bc0e" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">生成通量清单文件</h2><p id="6678" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">我们使用<code class="fe mp mq mr ms b">fluxctl</code>工具为Flux操作符生成Kubernetes清单文件。您需要指定存储库url，Git用户信息。您还需要提供保存Kubernetes清单的文件夹的路径，以及应该部署操作员的名称空间。</p><pre class="kj kk kl km gt mt ms mu mv aw mw bi"><span id="9ee2" class="lr ls it ms b gy mx my l mz na">fluxctl install <br/>--git-url=git@gitlab.com:$tom-code/example-gitops-flux <br/>--git-user=flux <br/>--git-email=flux@tomcode.com <br/>--git-path=namespaces,workloads <br/>--namespace=flux &gt; flux.yaml</span></pre><h2 id="1b34" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">应用清单文件</h2><p id="2987" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">让我们使用<code class="fe mp mq mr ms b">kubectl</code>来应用通量算子。</p><pre class="kj kk kl km gt mt ms mu mv aw mw bi"><span id="07c9" class="lr ls it ms b gy mx my l mz na">kubectl apply -f flux.yaml</span></pre><h2 id="8bda" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">验证部署</h2><p id="2f3a" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">通过检查flux名称空间中的状态Kubernetes pods来验证部署。应该有Flux操作符和一个Memchached实例，操作符用它来保存一些内部状态。</p><pre class="kj kk kl km gt mt ms mu mv aw mw bi"><span id="92b2" class="lr ls it ms b gy mx my l mz na">kubectl get pods -n flux</span><span id="1f14" class="lr ls it ms b gy nb my l mz na">NAME                         READY   STATUS    RESTARTS   AGE<br/>flux-5dd6d54f5b-2gbws        1/1     Running   0          67s<br/>memcached-5fd8f56fc5-qlpsc   1/1     Running   0          67s</span></pre><h2 id="f27e" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">通过fluxctl检索SSH密钥</h2><p id="868d" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">Flux使用SSH密钥连接到Git存储库。它在初始启动时生成密钥。您可以通过<code class="fe mp mq mr ms b">fluxctl</code> cli检索公共SSH密钥。</p><pre class="kj kk kl km gt mt ms mu mv aw mw bi"><span id="d23e" class="lr ls it ms b gy mx my l mz na">fluxctl identity --k8s-fwd-ns flux</span></pre><h2 id="df04" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">将SSH密钥添加到Gitlab存储库的部署密钥中</h2><p id="cd73" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">打开Gitlab，导航到您的项目，转到<code class="fe mp mq mr ms b">Settings -&gt; Repository -&gt; Deploy Keys</code>并添加从fluxctl检索的SSH密钥。确保您选中了允许写访问。</p><h2 id="bb6d" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">克隆存储库</h2><p id="8042" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">使用Git将存储库克隆到您的本地机器上，并将<code class="fe mp mq mr ms b">cd</code>克隆到目录中。</p><pre class="kj kk kl km gt mt ms mu mv aw mw bi"><span id="5738" class="lr ls it ms b gy mx my l mz na">git clone https://gitlab.com/tom-code/example-gitops-flux.git<br/>cd example-flux-gitops</span></pre><h2 id="4958" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">为清单文件创建文件夹</h2><p id="9513" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">让我们创建两个文件夹来保存我们的Kubernetes清单文件。</p><pre class="kj kk kl km gt mt ms mu mv aw mw bi"><span id="e5a8" class="lr ls it ms b gy mx my l mz na">mkdir namespaces workloads</span></pre><h2 id="6363" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">为演示命名空间创建Kubernetes清单文件</h2><p id="6aec" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">我们首先添加一个Kubernetes名称空间资源。复制下面的代码片段，并将其作为<code class="fe mp mq mr ms b">demo-ns.yaml</code>保存在名称空间目录中。</p><pre class="kj kk kl km gt mt ms mu mv aw mw bi"><span id="07e6" class="lr ls it ms b gy mx my l mz na">apiVersion: v1<br/>kind: Namespace<br/>metadata:<br/>  labels:<br/>    name: demo<br/>  name: demo</span></pre><h2 id="ea01" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">为nginx部署创建Kubernetes清单文件</h2><p id="31e3" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">接下来，我们将添加一个演示nginx部署。复制下面的代码片段，并将其作为<code class="fe mp mq mr ms b">nginx-deploy.yaml</code>保存在workloads目录中。</p><pre class="kj kk kl km gt mt ms mu mv aw mw bi"><span id="5f59" class="lr ls it ms b gy mx my l mz na">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: nginx-deployment<br/>  namespace: demo<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app: nginx<br/>  replicas: 2<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: nginx<br/>    spec:<br/>      containers:<br/>        - name: nginx<br/>          image: nginx:1.14.2<br/>          ports:<br/>            - containerPort: 80</span></pre><h2 id="3188" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">提交和推送更改</h2><p id="c3a7" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">使用Git将新文件添加到存储库中。之后，提交更改并将其推送到Gitlab存储库。</p><pre class="kj kk kl km gt mt ms mu mv aw mw bi"><span id="0255" class="lr ls it ms b gy mx my l mz na">git add namespaces workloads<br/>git commit -m 'Add demo resources'<br/>git push</span></pre><h2 id="e8cc" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">验证部署</h2><p id="e876" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">通过检查演示名称空间中的状态Kubernetes pods来验证部署。应该有两个nginx pods在运行。</p><pre class="kj kk kl km gt mt ms mu mv aw mw bi"><span id="f619" class="lr ls it ms b gy mx my l mz na">kubectl get pods -n demo</span><span id="144d" class="lr ls it ms b gy nb my l mz na">NAME                                                   READY   STATUS    RESTARTS   AGE<br/>nginx-deployment-6b6bc59c57-fd2w5              1/1     Running   0          57s<br/>nginx-deployment-6b6bc59c57-vh8bh              1/1     Running   0          52s</span></pre><h2 id="1d8e" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">摘要</h2><p id="2059" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">我们部署了Flux，并将其配置为与Gitlab库一起工作。对Git存储库的更改会自动部署到集群中。</p><p id="e38f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">正如您所看到的，没有外部客户端需要访问Kubernetes集群，这使得该过程非常安全，非常适合在高度监管的环境中部署，如保险和金融科技行业。</p><p id="b843" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">有一个中央存储库来管理Kubernetes清单文件使得部署更容易操作，并且消除了Kubernetes从存储库和服务管道带来的复杂性。</p></div><div class="ab cl nc nd hx ne" role="separator"><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh"/></div><div class="im in io ip iq"><p id="9346" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><em class="nj">最初发表于</em><a class="ae lq" href="https://tomcode.com/blog/getting-started-with-gitops-with-flux-and-gitlab" rel="noopener ugc nofollow" target="_blank">T5【https://tomcode.com】</a><em class="nj">。</em></p></div></div>    
</body>
</html>