<html>
<head>
<title>Deploying Kubernetes Resources with CDK8s</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用CDK8s部署Kubernetes资源</h1>
<blockquote>原文：<a href="https://itnext.io/deploying-kubernetes-resources-with-cdk8s-2c8b07bc45b1?source=collection_archive---------1-----------------------#2021-07-13">https://itnext.io/deploying-kubernetes-resources-with-cdk8s-2c8b07bc45b1?source=collection_archive---------1-----------------------#2021-07-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/b5a9fe66ae19399156a913d54c948b44.png" data-original-src="https://miro.medium.com/v2/resize:fit:520/format:webp/1*hRKN1gx2ePdptBcVlLXjMg.png"/></div></figure><p id="c209" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在之前的帖子中，我讨论了:</p><ul class=""><li id="c245" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated"><a class="ae lb" href="https://jimmy-ray.medium.com/aws-cdk-where-imperative-meets-declarative-3d23fd4a4dbd" rel="noopener">使用AWS CDK构建亚马逊EKS集群</a></li><li id="65b6" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" rel="noopener ugc nofollow" target="_blank" href="/aws-cdk-for-eks-kubernetes-manifest-handling-ebdec52e7f01">使用Kubernetes清单通过AWS CDK部署Kubernetes应用</a></li><li id="e241" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" rel="noopener ugc nofollow" target="_blank" href="/aws-cdk-for-eks-handling-helm-charts-aa002afedde4">使用舵轮图通过AWS CDK部署Kubernetes应用</a></li></ul><p id="88b0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这篇文章中，我将展示如何使用Java的<a class="ae lb" href="https://cdk8s.io/" rel="noopener ugc nofollow" target="_blank">Kubernetes云开发工具包(CDK8s) </a>来生成Kubernetes资源(YAML)。</p><h1 id="acb9" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">CDK8s</h1><p id="b037" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">根据项目文件:</p><blockquote class="mk ml mm"><p id="b7e0" class="ju jv mn jw b jx jy jz ka kb kc kd ke mo kg kh ki mp kk kl km mq ko kp kq kr ij bi translated">CDK8s是一个软件开发框架，使用熟悉的编程语言和丰富的面向对象API来定义Kubernetes应用程序和可重用的抽象。CDK8s生成纯Kubernetes YAML —您可以使用CDK8s为任何地方运行的任何Kubernetes集群定义应用程序。</p></blockquote><p id="3d20" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">CDK8s类似于AWS CDK。它使用代表Kubernetes资源及其特性的结构。</p><blockquote class="mk ml mm"><p id="4967" class="ju jv mn jw b jx jy jz ka kb kc kd ke mo kg kh ki mp kk kl km mq ko kp kq kr ij bi translated">CDK8s应用程序是用受支持的编程语言之一编写的程序。它们被构造成一个构造树。</p></blockquote><p id="0a62" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在本文撰写之时，CDK8s支持<em class="mn"> TypeScript、Python、</em>和<em class="mn"> Java </em>。像以前使用AWS CDK一样，我使用Java和CDK8s。</p><h1 id="22f0" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">使用jsii的多语言</h1><p id="4266" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">像AWS CDK一样，CDK8s构建在TypeScript和<a class="ae lb" href="https://github.com/aws/jsii" rel="noopener ugc nofollow" target="_blank"> jsii </a>之上。使用jsii，开发人员可以从typescript模块中创建带类型注释的包，这些包可以用来自动生成各种目标语言的惯用包。生成的类型代理对嵌入式javascript VM的调用，有效地允许jsii模块“一次编写，随处运行”。</p><h1 id="18a6" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">装置</h1><p id="f41c" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">为了使用CDK8s，我用以下命令安装了它:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="38c3" class="na li iq mw b gy nb nc l nd ne">$ npm install -g cdk8s-cli</span></pre><blockquote class="mk ml mm"><p id="ccfb" class="ju jv mn jw b jx jy jz ka kb kc kd ke mo kg kh ki mp kk kl km mq ko kp kq kr ij bi translated">该命令也可用于升级CDK8s CLI。</p></blockquote><p id="58af" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">安装完成后，我用下面的CDK8s CLI命令在一个空的目录中创建了一个新的CDK8s项目:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="df9d" class="na li iq mw b gy nb nc l nd ne">$ cdk8s init java-app</span></pre><p id="9807" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以下输出表明该项目是为Java初始化的:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="5fd1" class="na li iq mw b gy nb nc l nd ne">cdk8s --version<br/>1.0.0-beta.26</span><span id="9d25" class="na li iq mw b gy nf nc l nd ne">Initializing a project from the java-app template<br/>====================================================================</span><span id="a75e" class="na li iq mw b gy nf nc l nd ne">Your cdk8s Java project is ready!</span><span id="6455" class="na li iq mw b gy nf nc l nd ne">cat help      Prints this message<br/>   cdk8s synth   Synthesize k8s manifests to dist/<br/>   cdk8s import  Imports k8s API objects to "src/main/java/imports/"<br/>   mvn compile   Compiles your java packages</span><span id="767b" class="na li iq mw b gy nf nc l nd ne">Deploy:<br/>   kubectl apply -f dist/*.k8s.yaml</span><span id="a089" class="na li iq mw b gy nf nc l nd ne">====================================================================</span></pre><h1 id="a024" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">CDK8s代码</h1><p id="8fa8" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">我的CDK8s Java代码是一个单独的Java类，它扩展了<em class="mn"> org.cdk8s.Chart </em>类。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="3599" class="na li iq mw b gy nb nc l nd ne">package io.jimmyray.app;</span><span id="30f3" class="na li iq mw b gy nf nc l nd ne">import imports.k8s.*;<br/>import software.constructs.Construct;</span><span id="f743" class="na li iq mw b gy nf nc l nd ne">import org.cdk8s.App;<br/>import org.cdk8s.Chart;<br/>import org.cdk8s.ChartProps;</span><span id="c294" class="na li iq mw b gy nf nc l nd ne">import java.util.ArrayList;<br/>import java.util.HashMap;<br/>import java.util.List;<br/>import java.util.Map;</span><span id="e93d" class="na li iq mw b gy nf nc l nd ne">public class Main extends Chart {</span><span id="2aad" class="na li iq mw b gy nf nc l nd ne">public Main(final Construct scope, final String id) {<br/>        this(scope, id, null);<br/>    }</span><span id="feaf" class="na li iq mw b gy nf nc l nd ne">public Main(final Construct scope, final String id, final ChartProps options) {<br/>        super(scope, id, options);</span><span id="c8bf" class="na li iq mw b gy nf nc l nd ne">Map&lt;String,String&gt; labelsMap = Map.of("app","cdk8s-read-only","env","dev", "owner", "jimmy");</span><span id="52e8" class="na li iq mw b gy nf nc l nd ne">ObjectMeta nsMeta = ObjectMeta.builder()<br/>                .name("cdk8s-read-only")<br/>                .labels(labelsMap)<br/>                .build();</span><span id="7f5a" class="na li iq mw b gy nf nc l nd ne">KubeNamespace.Builder.create(this,"cdk8s-ns")<br/>                .metadata(nsMeta)<br/>                .build();</span><span id="8b67" class="na li iq mw b gy nf nc l nd ne">// LoadBalancer Service<br/>        final String serviceType = "LoadBalancer";<br/>        final Map&lt;String, String&gt; selector = new HashMap&lt;&gt;();<br/>        selector.put("app", "cdk8s-read-only");<br/>        final List&lt;ServicePort&gt; servicePorts = new ArrayList&lt;&gt;();<br/>        final ServicePort servicePort = new ServicePort.Builder()<br/>                .port(80)<br/>                .targetPort(IntOrString.fromNumber(8080))<br/>                .build();<br/>        servicePorts.add(servicePort);<br/>        final ServiceSpec serviceSpec = new ServiceSpec.Builder()<br/>                .type(serviceType)<br/>                .selector(selector)<br/>                .ports(servicePorts)<br/>                .build();<br/>        final KubeServiceProps serviceProps = new KubeServiceProps.Builder()<br/>                .metadata(<br/>                        ObjectMeta.builder().name("cdk8s-read-only")<br/>                        .namespace("cdk8s-read-only")<br/>                        .labels(labelsMap)<br/>                        .build()<br/>                )<br/>                .spec(serviceSpec)<br/>                .build();</span><span id="c278" class="na li iq mw b gy nf nc l nd ne">new KubeService(this, "service", serviceProps);</span><span id="956b" class="na li iq mw b gy nf nc l nd ne">// Deployment<br/>        final LabelSelector labelSelector = new LabelSelector.Builder().matchLabels(selector).build();<br/>        final ObjectMeta templateMeta = new ObjectMeta.Builder()<br/>                .labels(labelsMap).build();<br/>        final ObjectMeta deployMeta = new ObjectMeta.Builder().namespace("cdk8s-read-only")<br/>                .labels(labelsMap).name("cdk8s-read-only").build();<br/>        final List&lt;ContainerPort&gt; containerPorts = new ArrayList&lt;&gt;();<br/>        final ContainerPort containerPort = new ContainerPort.Builder()<br/>                .containerPort(8080)<br/>                .build();<br/>        containerPorts.add(containerPort);<br/>        final List&lt;Container&gt; containers = new ArrayList&lt;&gt;();<br/>        final Container container = new Container.Builder()<br/>                .name("cdk8s-read-only")<br/>                .image("public.ecr.aws/r2l1x4g2/go-http-server:v0.1.0-23ffe0a715")<br/>                .ports(containerPorts)<br/>                .build();<br/>        containers.add(container);<br/>        final PodSpec podSpec = new PodSpec.Builder()<br/>                .containers(containers)<br/>                .build();<br/>        final PodTemplateSpec podTemplateSpec = new PodTemplateSpec.Builder()<br/>                .metadata(templateMeta)<br/>                .spec(podSpec)<br/>                .build();<br/>        final DeploymentSpec deploymentSpec = new DeploymentSpec.Builder()<br/>                .replicas(1)<br/>                .selector(labelSelector)<br/>                .template(podTemplateSpec)<br/>                .revisionHistoryLimit(3)<br/>                .build();<br/>        final KubeDeploymentProps deploymentProps = new KubeDeploymentProps.Builder()<br/>                .metadata(deployMeta)<br/>                .spec(deploymentSpec)<br/>                .build();</span><span id="4a72" class="na li iq mw b gy nf nc l nd ne">new KubeDeployment(this, "deployment", deploymentProps);<br/>    }</span><span id="eb15" class="na li iq mw b gy nf nc l nd ne">public static void main(String[] args) {<br/>        final App app = new App();<br/>        new Main(app, "tmp");<br/>        app.synth();<br/>    }<br/>}</span></pre><p id="8af0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在前面的代码中，我使用来自<a class="ae lb" href="https://cdk8s.io/docs/latest/reference/index.html" rel="noopener ugc nofollow" target="_blank"> CDK8s API </a>的<a class="ae lb" href="https://cdk8s.io/docs/latest/concepts/constructs.html" rel="noopener ugc nofollow" target="_blank">构造</a>创建了三个Kubernetes资源(<em class="mn">名称空间、服务、部署</em>)。</p><h2 id="9701" class="na li iq bd lj ng nh dn ln ni nj dp lr kf nk nl lv kj nm nn lz kn no np md nq bi translated">命名空间</h2><p id="646d" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">名称空间是最简单的。首先，我为想要包含在所有资源中的公共标签创建了一个map对象。然后，我创建了一个元数据对象(<em class="mn"> ObjectMeta </em>)来存放标签映射。最后，我使用了<em class="mn"> KubeNamespace的流畅界面。构建器</em>通过<a class="ae lb" href="https://www.geeksforgeeks.org/composition-in-java/" rel="noopener ugc nofollow" target="_blank">组合</a>构建Kubernetes名称空间，类似于AWS CDK。</p><h2 id="db84" class="na li iq bd lj ng nh dn ln ni nj dp lr kf nk nl lv kj nm nn lz kn no np md nq bi translated">服务</h2><p id="59b3" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">服务资源type <a class="ae lb" href="https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer" rel="noopener ugc nofollow" target="_blank"> LoadBalancer </a>稍微复杂一些，但是我也使用了规定的组合方法来构建一个对象图，该图表示服务规范和相关属性。在这个过程中，我创建了包含在<em class="mn"> KubeServiceProps </em>中的<em class="mn"> ServiceSpec </em>，它被添加到<em class="mn"> KubeService </em>顶级对象中。</p><p id="d50a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">需要指出的是，我指定了一个可重用的地图对象(<em class="mn">选择器</em>)，用于定义服务如何选择窗格。接下来，这个映射将在部署规范中重用。</p><h2 id="c387" class="na li iq bd lj ng nh dn ln ni nj dp lr kf nk nl lv kj nm nn lz kn no np md nq bi translated">部署</h2><p id="0531" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">部署资源构建过程与服务非常相似，尽管更复杂。我首先使用fluent接口和组合构建了部署的各个部分，例如<em class="mn"> ObjectMeta </em>、<em class="mn"> Container </em>、<em class="mn"> PodSpec </em>、<em class="mn"> PodTemplateSpec </em>、<em class="mn"> DeploymentSpec </em>和<em class="mn"> KubeDeploymentProps </em>对象。我用这些来组成KubeDeployment对象。</p><h1 id="a56b" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">生成YAML</h1><p id="bb25" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">代码编写完成后，我使用CDK8s CLI <em class="mn"> synth </em>命令生成了YAML文件。为了让<em class="mn"> cdk8s synth </em>命令工作，生成的Java类必须存在于<em class="mn">目标</em>文件夹树中。我选择运行Maven命令来清理和编译Java类，然后运行CDK8s CLI命令:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="6318" class="na li iq mw b gy nb nc l nd ne">mvn clean compile &amp;&amp; cdk8s synth</span></pre><p id="3f1e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这种方法也确保了我总是使用最新版本的Java源代码。</p><p id="f237" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">生成的YAML文件位于以下路径:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="cc2f" class="na li iq mw b gy nb nc l nd ne">dist/tmp.k8s.yaml</span></pre><p id="77ea" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">YAML文件中定义了以下资源:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="9f78" class="na li iq mw b gy nb nc l nd ne">apiVersion: v1<br/>kind: Namespace<br/>metadata:<br/>  labels:<br/>    app: cdk8s-read-only<br/>    env: dev<br/>    owner: jimmy<br/>  name: cdk8s-read-only<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  labels:<br/>    app: cdk8s-read-only<br/>    env: dev<br/>    owner: jimmy<br/>  name: cdk8s-read-only<br/>  namespace: cdk8s-read-only<br/>spec:<br/>  ports:<br/>    - port: 80<br/>      targetPort: 8080<br/>  selector:<br/>    app: cdk8s-read-only<br/>  type: LoadBalancer<br/>---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  labels:<br/>    app: cdk8s-read-only<br/>    env: dev<br/>    owner: jimmy<br/>  name: cdk8s-read-only<br/>  namespace: cdk8s-read-only<br/>spec:<br/>  replicas: 1<br/>  revisionHistoryLimit: 3<br/>  selector:<br/>    matchLabels:<br/>      app: cdk8s-read-only<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: cdk8s-read-only<br/>        env: dev<br/>        owner: jimmy<br/>    spec:<br/>      containers:<br/>        - image: public.ecr.aws/r2l1x4g2/go-http-server:v0.1.0-23ffe0a715<br/>          name: cdk8s-read-only<br/>          ports:<br/>            - containerPort: 8080</span></pre><h1 id="4e99" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">适用于Kubernetes</h1><p id="bad6" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">现在生成了之前的YAML，我可以使用下面的<em class="mn"> kubectl </em>命令来应用YAML中定义的集群更改:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="1c6d" class="na li iq mw b gy nb nc l nd ne">kubectl apply -f dist/tmp.k8s.yaml</span></pre><p id="0fc1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">结果是目标Kubernetes集群中的名称空间、部署和服务。</p><h1 id="acfb" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">摘要</h1><p id="a83d" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">像<a class="ae lb" href="https://aws.amazon.com/cdk/" rel="noopener ugc nofollow" target="_blank"> AWS CDK </a>一样，CDK8s使开发人员能够使用编程语言生成声明性配置。在CDK8s的情况下，包含资源清单的YAML文件被创建，以在对<em class="mn"> kubectl </em>的单独调用中应用于Kubernetes。</p><p id="fdb2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">支持GitHub库:</strong>【https://github.com/jimmyraywv/cdk8s-java T2】</p></div></div>    
</body>
</html>