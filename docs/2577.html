<html>
<head>
<title>Integrating Uppy with Doka a JavaScript Image Editor</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">集成Uppy和多卡一个JavaScript图像编辑器</h1>
<blockquote>原文：<a href="https://itnext.io/integrating-uppy-with-doka-a-javascript-image-editor-2bd8821f6adc?source=collection_archive---------5-----------------------#2019-06-17">https://itnext.io/integrating-uppy-with-doka-a-javascript-image-editor-2bd8821f6adc?source=collection_archive---------5-----------------------#2019-06-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="62d8" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Transloadit最近发布了他们的Uppy文件上传程序的1.0版本。在本教程中，我们将整合Uppy和多卡视觉优化和压缩图像数据，然后再上传到服务器。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d9d10508bfed7e59463245d2b8664a95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1d2Q-mUpjJFb8OcHr-cj8g.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">多卡图像编辑器</figcaption></figure><p id="1c55" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在将图像发送到服务器之前对其进行压缩和裁剪可以节省带宽，节省手动裁剪工作，并允许用户对自己的内容进行更多的控制。使用本文中描述的技术，使您的用户能够编辑他们上传到服务器的个人资料图片、相册或任何其他图像。同时仍然能够设置内容限制，如裁剪纵横比、最小图像大小和可用的过滤器。</p><p id="433b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们将从默认的<a class="ae lr" href="https://uppy.io/" rel="noopener ugc nofollow" target="_blank"> Uppy </a>实现开始。一旦我们启动并运行，我们将添加<a class="ae lr" href="https://pqina.nl/doka/" rel="noopener ugc nofollow" target="_blank">多卡</a>集成。</p><h1 id="dba0" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">设置Uppy</h1><p id="45ba" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">让我们从向页面添加Uppy样式表和脚本开始。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="fff9" class="mu lt iq mq b gy mv mw l mx my">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>    &lt;meta charset="UTF-8"&gt;<br/>    &lt;title&gt;Uppy&lt;/title&gt;</span><span id="6f0b" class="mu lt iq mq b gy mz mw l mx my">    <strong class="mq ir">&lt;!-- add the Uppy styles to the head --&gt;<br/>    &lt;link href="</strong><a class="ae lr" href="https://transloadit.edgly.net/releases/uppy/v1.2.0/uppy.min.css" rel="noopener ugc nofollow" target="_blank"><strong class="mq ir">https://transloadit.edgly.net/releases/uppy/v1.2.0/uppy.min.css</strong></a><strong class="mq ir">" rel="stylesheet"&gt;</strong><br/>  <br/>&lt;/head&gt;<br/>&lt;body&gt;</span><span id="3b8a" class="mu lt iq mq b gy mz mw l mx my">    <strong class="mq ir">&lt;!-- add the Uppy script to right before the closing body element --&gt;<br/>    &lt;script src="</strong><a class="ae lr" href="https://transloadit.edgly.net/releases/uppy/v1.2.0/uppy.min.js" rel="noopener ugc nofollow" target="_blank"><strong class="mq ir">https://transloadit.edgly.net/releases/uppy/v1.2.0/uppy.min.js</strong></a><strong class="mq ir">"&gt;&lt;/script&gt;</strong></span><span id="344e" class="mu lt iq mq b gy mz mw l mx my">&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="5296" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在我们将添加包含Uppy实例的HTML元素。</p><p id="ae61" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">请注意，我已经缩短了样式和脚本标记，以保持代码片段的可读性。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="9014" class="mu lt iq mq b gy mv mw l mx my">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>    &lt;meta charset="UTF-8"&gt;<br/>    &lt;title&gt;Uppy&lt;/title&gt;<br/>    &lt;link href="uppy.min.css" rel="stylesheet"&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>    <strong class="mq ir">&lt;!-- add the Uppy HTML element --&gt;<br/>    &lt;div id="drag-drop-area"&gt;&lt;/div&gt;</strong></span><span id="21ec" class="mu lt iq mq b gy mz mw l mx my">    &lt;script src="uppy.min.js"&gt;&lt;/script&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="1551" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">好了，让我们扩展<code class="fe na nb nc mq b">script</code>来加载Uppy。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="53aa" class="mu lt iq mq b gy mv mw l mx my">&lt;body&gt;<br/>    &lt;div id="drag-drop-area"&gt;&lt;/div&gt;<br/>    &lt;script src="uppy.min.js"&gt;&lt;/script&gt;</span><span id="3393" class="mu lt iq mq b gy mz mw l mx my">    <strong class="mq ir">&lt;!-- add the Uppy script init logic --&gt;<br/>    &lt;script&gt;<br/>      var uppy = Uppy.Core()<br/>        .use(Uppy.Dashboard, {<br/>          inline: true,<br/>          target: '#drag-drop-area'<br/>        })<br/>        .use(Uppy.Tus, {endpoint: '</strong><a class="ae lr" href="https://master.tus.io/files/'" rel="noopener ugc nofollow" target="_blank"><strong class="mq ir">https://master.tus.io/files/'</strong></a><strong class="mq ir">})</strong></span><span id="1193" class="mu lt iq mq b gy mz mw l mx my"><strong class="mq ir">uppy.on('complete', (result) =&gt; {<br/>        console.log('Upload complete! We’ve uploaded these files:', result.successful)<br/>      })<br/>    &lt;/script&gt;</strong><br/>&lt;/body&gt;</span></pre><p id="4ab7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">刷新您的浏览器窗口，Uppy现在应该如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nd"><img src="../Images/bd2777f2d5f78b5ba1456ee689bc6aa4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_esqyyHeQa0UhShoDPrI3Q.png"/></div></div></figure><p id="7555" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你可以放下文件，也可以上传，这一切都会自动运行。</p><p id="feba" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们继续多卡集成。</p><h1 id="213f" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">整合多卡和Uppy</h1><p id="202a" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">为了允许编辑图像，我们需要在图像被删除时加载多卡。我们可以通过利用<code class="fe na nb nc mq b">onBeforeFileAdded</code>函数来做到这一点。</p><p id="5301" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然而，首先我们需要添加多卡脚本和样式。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="7bcc" class="mu lt iq mq b gy mv mw l mx my">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>    &lt;meta charset="UTF-8"&gt;<br/>    &lt;title&gt;Uppy&lt;/title&gt;<br/>    &lt;link href="uppy.min.css" rel="stylesheet"&gt;</span><span id="62a1" class="mu lt iq mq b gy mz mw l mx my"><strong class="mq ir">    &lt;!-- add the Doka style tag --&gt;<br/>    &lt;link href="doka.min.css" rel="stylesheet"&gt;</strong><br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>    &lt;div id="drag-drop-area"&gt;&lt;/div&gt;<br/>    &lt;script src="uppy.min.js"&gt;&lt;/script&gt;</span><span id="2e3c" class="mu lt iq mq b gy mz mw l mx my">    <strong class="mq ir">&lt;!-- add the Doka script tag --&gt;<br/>    &lt;script src="doka.min.js"&gt;&lt;/script&gt;</strong><br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="c7c9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在我们将连接Uppy <code class="fe na nb nc mq b">onBeforeFileAdded</code>函数。我们将放大JavaScript代码，使其更易于阅读。</p><p id="5510" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe na nb nc mq b">onBeforeFileAdded</code>功能允许我们验证丢弃的文件。如果我们返回<code class="fe na nb nc mq b">false</code>，文件将被拒绝，如果我们返回<code class="fe na nb nc mq b">true</code>，它将被添加到列表中。我们需要编辑文件，然后将用户编辑的结果添加到文件列表中。</p><p id="a441" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们需要做的是:</p><ol class=""><li id="885f" class="ne nf iq kx b ky kz lb lc le ng li nh lm ni lq nj nk nl nm bi translated">防止添加原始文件</li><li id="bbb8" class="ne nf iq kx b ky nn lb no le np li nq lm nr lq nj nk nl nm bi translated">用多卡编辑原始文件</li><li id="a550" class="ne nf iq kx b ky nn lb no le np li nq lm nr lq nj nk nl nm bi translated">将多卡返回的文件添加到列表中</li></ol><p id="5a89" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们从防止文件被添加开始。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="6cd7" class="mu lt iq mq b gy mv mw l mx my"><strong class="mq ir">// our uppy options object<br/>var uppyOptions = {<br/>    onBeforeFileAdded: function(file) {</strong></span><span id="b0b1" class="mu lt iq mq b gy mz mw l mx my"><strong class="mq ir">        // prevent the file from being added<br/>        return false;</strong></span><span id="7737" class="mu lt iq mq b gy mz mw l mx my"><strong class="mq ir">    }<br/>}</strong></span><span id="cc27" class="mu lt iq mq b gy mz mw l mx my">// initialise Uppy<br/>var uppy = Uppy.Core(<strong class="mq ir">uppyOptions</strong>)<br/>    .use(Uppy.Dashboard, {<br/>        inline: true,<br/>        target: '#drag-drop-area'<br/>    })<br/>    .use(Uppy.Tus, {endpoint: '<a class="ae lr" href="https://master.tus.io/files/'" rel="noopener ugc nofollow" target="_blank">https://master.tus.io/files/'</a>})</span></pre><p id="25f7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在我们需要编辑刚刚被多卡拒绝的文件。我们将放大<code class="fe na nb nc mq b">uppyOptions</code>对象。</p><p id="c032" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们创建我们的多卡实例，然后我们用多卡<code class="fe na nb nc mq b">edit</code>文件数据。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="c830" class="mu lt iq mq b gy mv mw l mx my"><strong class="mq ir">// create our Doka instance<br/>var doka = Doka.create({<br/>    utils: ['crop', 'filter', 'color']<br/>});</strong></span><span id="7166" class="mu lt iq mq b gy mz mw l mx my">var uppyOptions = {<br/>    onBeforeFileAdded: function(file) {</span><span id="8fc9" class="mu lt iq mq b gy mz mw l mx my"><strong class="mq ir">        // edit the file data with Doka<br/>        doka.edit(file.data);</strong></span><span id="32c5" class="mu lt iq mq b gy mz mw l mx my">        return false;<br/>    }<br/>}</span></pre><p id="2e27" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">太好了，多卡图像编辑器现在可以在拖放文件时打开。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/8ee3ada141e1a60bd87207773e258555.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vS8RBC2KhLCL_cy-N7efIQ.png"/></div></div></figure><p id="9938" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当在多卡编辑器中按下Done按钮时，<code class="fe na nb nc mq b">Doka.edit</code>函数返回一个用file对象解析的<code class="fe na nb nc mq b">Promise</code>。当这种情况发生时，我们希望将结果文件返回给Uppy。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="d514" class="mu lt iq mq b gy mv mw l mx my">var uppyOptions = {<br/>    onBeforeFileAdded: function(file) {</span><span id="9290" class="mu lt iq mq b gy mz mw l mx my">        doka.edit(file.data).then(output =&gt; {</span><span id="a72c" class="mu lt iq mq b gy mz mw l mx my">            <strong class="mq ir">// add the Doka edit result back to Uppy<br/>            uppy.addFile({<br/>                ...file,<br/>                data: output.file<br/>            });</strong><br/>            <br/>        });</span><span id="3757" class="mu lt iq mq b gy mz mw l mx my">        return false;<br/>    }<br/>}</span></pre><p id="c56f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这很好，但现在我们在兜圈子。当文件被多卡编辑时，输出文件被添加到Uppy，然后再次被多卡编辑，这样继续下去，直到没有字节可编辑为止。不太好。</p><p id="a298" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们需要告诉Uppy，正在添加的文件已经被编辑过了。让我们通过向文件添加一个特殊属性来实现这一点。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="458e" class="mu lt iq mq b gy mv mw l mx my">var uppyOptions = {<br/>    onBeforeFileAdded: function(file) {</span><span id="22a2" class="mu lt iq mq b gy mz mw l mx my">        <strong class="mq ir">// only allow file if special boolean property is present<br/>        if (file.handledByDoka) return true;</strong></span><span id="46ed" class="mu lt iq mq b gy mz mw l mx my">        doka.edit(file.data).then(output =&gt; {<br/>            uppy.addFile({<br/>                ...file,<br/>                data: output.file,<br/>                <br/>                <strong class="mq ir">// add a special boolean to the file<br/>                handledByDoka: true</strong><br/>            });<br/>        });</span><span id="7e84" class="mu lt iq mq b gy mz mw l mx my">        return false;<br/>    }<br/>}</span></pre><p id="57a2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">就是这样！</p><p id="7c9c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当用户放下一个图像时，该图像现在被发送到多卡，然后用户可以编辑该图像，结果数据被发送到Uppy。我们通过将<code class="fe na nb nc mq b">handledByDoka</code>属性设置为<code class="fe na nb nc mq b">true</code>来记住这个编辑。</p><p id="b6ee" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">通过设置裁剪纵横比、最小图像大小、可用的实用程序，您现在可以控制在图像数据上传到服务器之前允许用户编辑多少图像数据。</p><p id="a6c4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">请注意，上面的例子不处理多个文件，这将触发一次多个图像编辑。多卡图书馆附带了一个方便的<code class="fe na nb nc mq b">useDokaWithUppy</code>功能，可以将图像排队，让它们很好地等待被编辑。</p><p id="60ef" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">使用这个函数，JavaScript代码片段现在看起来像这样:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="0a94" class="mu lt iq mq b gy mv mw l mx my">// connect with `useDokaWithUppy` and pass Doka properties<br/>var uppyOptions = {<br/>    <strong class="mq ir">onBeforeFileAdded: useDokaWithUppy({<br/>        utils: ['crop', 'filter', 'color']<br/>    })</strong><br/>};</span><span id="aeee" class="mu lt iq mq b gy mz mw l mx my">// initialise Uppy<br/>var uppy = Uppy.Core(uppyOptions)<br/>    .use(Uppy.Dashboard, {<br/>        inline: true,<br/>        target: '#drag-drop-area'<br/>    })<br/>    .use(Uppy.Tus, {endpoint: '<a class="ae lr" href="https://master.tus.io/files/'" rel="noopener ugc nofollow" target="_blank">https://master.tus.io/files/'</a>})</span></pre><p id="3f2d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您现在可以使用Uppy文件上传库和多卡一起处理图像上传。</p><p id="e477" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">请看下面的结果。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nd"><img src="../Images/b57341b223edde5399f04629b8758e8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*Eqac_NOrJFTzizOGxwOSJA.gif"/></div></div></figure><p id="e356" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><a class="ae lr" href="https://pqina.nl/doka/" rel="noopener ugc nofollow" target="_blank">在产品网站上了解更多关于多卡的信息</a></p><p id="f721" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你正在使用DropZoneJS，你可能也会对<a class="ae lr" rel="noopener ugc nofollow" target="_blank" href="/integrating-dropzone-with-javascript-image-cropper-optimise-image-upload-e22b12ac0d8a">将DropzoneJS与JavaScript图像裁剪器集成以优化图像上传感兴趣</a></p></div></div>    
</body>
</html>