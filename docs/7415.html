<html>
<head>
<title>Argo CD on Rancher Desktop as a local GitOps K8s lab</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">牧场主桌面上的Argo CD作为本地GitOps K8s实验室</h1>
<blockquote>原文：<a href="https://itnext.io/argo-cd-rancher-desktop-for-a-local-gitops-lab-8d044089f50a?source=collection_archive---------2-----------------------#2022-09-16">https://itnext.io/argo-cd-rancher-desktop-for-a-local-gitops-lab-8d044089f50a?source=collection_archive---------2-----------------------#2022-09-16</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><figure class="gm go js jt ju jv gi gj paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="gi gj jr"><img src="../Images/42bc6cdc3d44560cbe690124d90cda72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*-jNajPVe3AQZVhixKj1aqQ.gif"/></div></div></figure><p id="d744" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">Argo CD启用了GitOps，其中实际部署的状态与源代码控制中的代码相匹配。对于DevOps工程师来说，这是令人惊讶的，因为在故障排除时您必须更改的所有配置都在<strong class="ke iv">一个位置</strong>，即您已经获得配置的repo(通常是Helm chart的values.yaml)。在本文中，我们将在本地K8s实验室上实现GitOps个步骤)并配置&amp;部署一个基于Github repo的应用程序(3个步骤)。</p><p id="dc08" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">Argo CD有很棒的UX和很棒的文档(特别是关于如何用像Keycloak这样的IdAM配置它)。为了更熟悉它，首先安装一个由Rancher Desktop提供的本地K8s集群(参见下面关于如何安装的链接)。</p><div class="la lb gq gs lc ld"><a href="https://medium.com/macoclock/rancher-desktop-setup-for-k8s-on-your-macos-laptop-6f1c576ceb48" rel="noopener follow" target="_blank"><div class="le ab fp"><div class="lf ab lg cl cj lh"><h2 class="bd iv gz z fq li fs ft lj fv fx it bi translated">macOS笔记本电脑上K8s的Rancher桌面设置</h2><div class="lk l"><h3 class="bd b gz z fq li fs ft lj fv fx dk translated">对于我在MacBook上的个人K8s测试实验室，我使用的是Rancher Desktop。我试过MiniKube(牛逼)和K3d(也…</h3></div><div class="ll l"><p class="bd b dl z fq li fs ft lj fv fx dk translated">medium.com</p></div></div><div class="lm l"><div class="ln l lo lp lq lm lr ka ld"/></div></div></a></div><h2 id="3d96" class="ls lt iu bd lu lv lw dn lx ly lz dp ma kn mb mc md kr me mf mg kv mh mi mj mk bi translated">1/4安装Argo光盘</h2><p id="8d65" class="pw-post-body-paragraph kc kd iu ke b kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv mp kx ky kz in bi translated">遵循Argo CD网站上的入门说明(<a class="ae mq" href="https://argo-cd.readthedocs.io/en/stable/getting_started/" rel="noopener ugc nofollow" target="_blank">https://argo-cd.readthedocs.io/en/stable/getting_started/</a>)。第一步是创建一个新的名称空间(<code class="fe mr ms mt mu b">argocd</code>)，Argo CD的资源将驻留在其中。</p><pre class="mv mw mx my gu mz mu na nb aw nc bi"><span id="7f58" class="ls lt iu mu b gz nd ne l nf ng">$ <strong class="mu iv">kubectl create namespace argocd</strong><br/>namespace/argocd created</span><span id="6633" class="ls lt iu mu b gz nh ne l nf ng">$ <strong class="mu iv">kubectl apply -n argocd -f </strong><a class="ae mq" href="https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml" rel="noopener ugc nofollow" target="_blank"><strong class="mu iv">https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml</strong></a><strong class="mu iv"><br/></strong>customresourcedefinition.apiextensions.k8s.io/applications.argoproj.io created<br/>...<br/>serviceaccount/argocd-application-controller created<br/>...<br/>serviceaccount/argocd-server created<br/>role.rbac.authorization.k8s.io/argocd-application-controller created<br/>...<br/>networkpolicy.networking.k8s.io/argocd-server-network-policy created</span></pre><h2 id="ef00" class="ls lt iu bd lu lv lw dn lx ly lz dp ma kn mb mc md kr me mf mg kv mh mi mj mk bi translated">2/4部署额外的配置图并重新部署应用程序</h2><blockquote class="ni nj nk"><p id="4dce" class="kc kd nl ke b kf kg kh ki kj kk kl km nm ko kp kq nn ks kt ku no kw kx ky kz in bi translated"><strong class="ke iv">在这里获得本教程的源代码:</strong><a class="ae mq" href="https://github.com/jwsy/argocd-rd" rel="noopener ugc nofollow" target="_blank"><strong class="ke iv">https://github.com/jwsy/argocd-rd</strong></a></p></blockquote><p id="e50d" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">提供的配置映射将服务器设置为不安全模式(因此我们不需要配置证书)，如Argo CD文档(<a class="ae mq" href="https://argo-cd.readthedocs.io/en/stable/operator-manual/ingress/" rel="noopener ugc nofollow" target="_blank">https://Argo-CD . readthedocs . io/en/stable/operator-manual/ingress/</a>)中所述。然后，重新启动Argo光盘服务器。您可以使用<code class="fe mr ms mt mu b">rollout status</code>命令来跟踪重新部署。</p><pre class="mv mw mx my gu mz mu na nb aw nc bi"><span id="51a5" class="ls lt iu mu b gz nd ne l nf ng">$ <strong class="mu iv">git clone </strong><a class="ae mq" href="https://github.com/jwsy/argocd-rd.git" rel="noopener ugc nofollow" target="_blank"><strong class="mu iv">https://github.com/jwsy/argocd-rd.git</strong></a><br/>Cloning into 'argocd-rd'...<br/>...<br/>Resolving deltas: 100% (1/1), done.</span><span id="bdb2" class="ls lt iu mu b gz nh ne l nf ng">$ <strong class="mu iv">cd argocd-rd</strong></span><span id="0a85" class="ls lt iu mu b gz nh ne l nf ng">$ <strong class="mu iv">kubectl -n argocd apply -f argocd-cmd-params-cm.yaml</strong><br/>configmap/argocd-cmd-params-cm configured<br/> <br/>$ <strong class="mu iv">kubectl -n argocd rollout restart deployment argocd-server<br/></strong>deployment.apps/argocd-server restarted</span><span id="e9fe" class="ls lt iu mu b gz nh ne l nf ng">$ <strong class="mu iv">kubectl -n argocd rollout status deployment argocd-server</strong><br/>Waiting for deployment "argocd-server" rollout to finish: 1 old replicas are pending termination...<br/>Waiting for deployment "argocd-server" rollout to finish: 1 old replicas are pending termination...<br/>deployment "argocd-server" successfully rolled out</span></pre><h2 id="2507" class="ls lt iu bd lu lv lw dn lx ly lz dp ma kn mb mc md kr me mf mg kv mh mi mj mk bi translated">3/4部署入口</h2><p id="5054" class="pw-post-body-paragraph kc kd iu ke b kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv mp kx ky kz in bi translated">部署入口有两种选择</p><p id="f9f2" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated"><strong class="ke iv">选项1 </strong> : <strong class="ke iv"> </strong>使用正常入口。我喜欢这个，因为当我运行<code class="fe mr ms mt mu b">kubectl get all,ing</code>时，它很好地显示了主机名</p><p id="c008" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">在<code class="fe mr ms mt mu b">argocd-ingress-server.yaml</code>中，我使用了Argo CD文档提供的例子，并使用了主机名<code class="fe mr ms mt mu b">argocd.rancher.localhost</code></p><pre class="mv mw mx my gu mz mu na nb aw nc bi"><span id="a247" class="ls lt iu mu b gz nd ne l nf ng">$ <strong class="mu iv">kubectl -n argocd apply -f argocd-ingress-server.yaml<br/></strong>ingress.networking.k8s.io/argocd-server-ingress created</span></pre><p id="cf7a" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated"><strong class="ke iv">选项二</strong> : <strong class="ke iv"> </strong>如果你用的是Rancher Desktop，可以用Traefik ingress。我用<code class="fe mr ms mt mu b">argocd.rancher.localhost</code>替换了默认的网址</p><pre class="mv mw mx my gu mz mu na nb aw nc bi"><span id="303d" class="ls lt iu mu b gz nd ne l nf ng">$ <strong class="mu iv">kubectl -n argocd apply -f traefik/argocd-ingress-server-traefik.yaml</strong><br/>ingressroute.traefik.containo.us/argocd-server created</span></pre><h2 id="9c7d" class="ls lt iu bd lu lv lw dn lx ly lz dp ma kn mb mc md kr me mf mg kv mh mi mj mk bi translated">4/4登录并了解ArgoCD</h2><p id="6358" class="pw-post-body-paragraph kc kd iu ke b kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv mp kx ky kz in bi translated">使用用户名<code class="fe mr ms mt mu b">admin</code>和密码<code class="fe mr ms mt mu b">argocd-initial-admin-secret</code>登录应用程序。您可以从下面显示的文档(<a class="ae mq" href="https://argo-cd.readthedocs.io/en/stable/getting_started/#4-login-using-the-cli" rel="noopener ugc nofollow" target="_blank">https://Argo-CD . readthedocs . io/en/stable/getting _ started/# 4-log in-using-the-CLI</a>)中提供的命令中获得该信息</p><pre class="mv mw mx my gu mz mu na nb aw nc bi"><span id="05d6" class="ls lt iu mu b gz nd ne l nf ng">$ <strong class="mu iv">kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath=”{.data.password}” | base64 -d</strong><br/>khDCDlbb3nXQ7IKE%</span><span id="6d7f" class="ls lt iu mu b gz nh ne l nf ng"># I ignored the trailing `%` sign<br/></span></pre><p id="e127" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">在Powershell中，您需要这两个命令</p><pre class="mv mw mx my gu mz mu na nb aw nc bi"><span id="1d3a" class="ls lt iu mu b gz nd ne l nf ng">PS C:\Users\jyee\code\argocd-rd&gt; <strong class="mu iv">$argocdPasswd = kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}"</strong></span><span id="d1d3" class="ls lt iu mu b gz nh ne l nf ng">PS C:\Users\jyee\code\argocd-rd&gt; <strong class="mu iv">[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($argocdPasswd))</strong><br/>khDCDlbb3nXQ7IKE </span></pre><p id="b416" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated"><strong class="ke iv">开始Argo CD吧！</strong></p><p id="6227" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">当你浏览到位于<a class="ae mq" href="https://argocd.rancher.localhost/login?return_url=https%3A%2F%2Fargocd.rancher.localhost%2Fapplications" rel="noopener ugc nofollow" target="_blank">https://argocd . rancher . localhost</a>的GUI时，输入用户名<code class="fe mr ms mt mu b">admin</code>和你刚刚得到的K8s秘密的密码。</p><blockquote class="ni nj nk"><p id="b0be" class="kc kd nl ke b kf kg kh ki kj kk kl km nm ko kp kq nn ks kt ku no kw kx ky kz in bi translated"><em class="iu">你做</em> <strong class="ke iv"> <em class="iu">不是</em> </strong> <em class="iu">必须改变你的</em> <code class="fe mr ms mt mu b"><em class="iu">/etc/hosts</em></code> <em class="iu">如果你</em> <strong class="ke iv"> <em class="iu">使用基于Chrome或Firefox的浏览器像Brave/Canary </em> </strong> <em class="iu">(即不是Safari)因为我们会使用</em><code class="fe mr ms mt mu b"><em class="iu">.localhost</em></code><em class="iu"/><a class="ae mq" href="https://en.wikipedia.org/wiki/.localhost" rel="noopener ugc nofollow" target="_blank"><em class="iu">DNS magic</em></a><em class="iu">让你的浏览器自动路由任何否则，你需要更新</em> <code class="fe mr ms mt mu b"><em class="iu">/etc/hosts </em></code> <em class="iu">来拥有条目</em> <code class="fe mr ms mt mu b"><em class="iu"> 127.0.0.1 jade-shooter.rancher.localhost</em></code></p></blockquote><figure class="mv mw mx my gu jv gi gj paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="gi gj np"><img src="../Images/9c6b236a8db31cdacc5295578a372449.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M2rJwEVjgm0gtkCVuJNjkQ.png"/></div></div></figure><h2 id="80ca" class="ls lt iu bd lu lv lw dn lx ly lz dp ma kn mb mc md kr me mf mg kv mh mi mj mk bi translated">使用Argo CD部署应用程序</h2><p id="6f70" class="pw-post-body-paragraph kc kd iu ke b kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv mp kx ky kz in bi translated">就像阿尔戈吉祥物说的，让我们把东西部署好！我将从本文中找到的最简单的K8s部署开始部署玩具射击游戏，并在GitHub<a class="ae mq" href="https://github.com/jwsy/simplest-k8s" rel="noopener ugc nofollow" target="_blank">https://github.com/jwsy/simplest-k8s</a>托管</p><div class="la lb gq gs lc ld"><a rel="noopener  ugc nofollow" target="_blank" href="/simplest-minimal-k8s-app-tutorial-with-rancher-desktop-in-5-min-5481edb9a4a5"><div class="le ab fp"><div class="lf ab lg cl cj lh"><h2 class="bd iv gz z fq li fs ft lj fv fx it bi translated">最简单的K8s应用程序教程，5分钟内完成</h2><div class="lk l"><h3 class="bd b gz z fq li fs ft lj fv fx dk translated">本文为一个应用程序提供了最简单、最容易、最小化的Kubernetes (K8s)集群和清单，您可以…</h3></div><div class="ll l"><p class="bd b dl z fq li fs ft lj fv fx dk translated">itnext.io</p></div></div><div class="lm l"><div class="nq l lo lp lq lm lr ka ld"/></div></div></a></div><h2 id="ccdb" class="ls lt iu bd lu lv lw dn lx ly lz dp ma kn mb mc md kr me mf mg kv mh mi mj mk bi translated">1/3配置应用程序</h2><p id="3ba1" class="pw-post-body-paragraph kc kd iu ke b kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv mp kx ky kz in bi translated">我需要将应用程序名称设置为有效的K8s名称，如<code class="fe mr ms mt mu b">simplest-k8s</code>，然后选择一个项目，在本教程中是<code class="fe mr ms mt mu b">default</code>(漂亮的智能下拉菜单！).我会将其余的复选框留空。</p><figure class="mv mw mx my gu jv gi gj paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="gi gj nr"><img src="../Images/cc9e4314b2f3d509078ff61a63dc49c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_ffRDBCJbQc1qUfrR8nY2A.png"/></div></div></figure><p id="6a04" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">接下来，我将存储库的URL设置为<a class="ae mq" href="https://github.com/jwsy/simplest-k8s" rel="noopener ugc nofollow" target="_blank">https://github.com/jwsy/simplest-k8s</a>，这样做之后，分支就会自动为我填充。我可以手动输入<code class="fe mr ms mt mu b">main</code>或删除默认值<code class="fe mr ms mt mu b">HEAD</code>，然后使用下拉菜单选择<code class="fe mr ms mt mu b">main</code>分支。</p><figure class="mv mw mx my gu jv gi gj paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="gi gj ns"><img src="../Images/dccc0ae3ed0f9b63c6dd74087266770f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eeD9zngoM54zT5Cwg3wYGg.png"/></div></div></figure><p id="9032" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">由于清单文件在repo的根目录下，所以路径是<code class="fe mr ms mt mu b">.</code>。</p><figure class="mv mw mx my gu jv gi gj paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="gi gj nt"><img src="../Images/074eed1f397cd4c161d7c40020d7262c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mv9nvAP7y07ueTaRiAIMlw.png"/></div></div></figure><p id="b7f2" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">通过从下拉菜单(<code class="fe mr ms mt mu b">https://kubernetes.default.svc</code>)中选择缺省值来选择目标集群URL，并为此部署指定名称空间<code class="fe mr ms mt mu b">default</code>(因为我们知道名称空间已经存在)。将其余部分留空，然后单击顶部的“创建”按钮</p><figure class="mv mw mx my gu jv gi gj paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="gi gj nu"><img src="../Images/100fb50697c37929350ac14c72edb940.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7WKIQXRtqzwNnslCMFIJdQ.png"/></div></div></figure><h2 id="dcae" class="ls lt iu bd lu lv lw dn lx ly lz dp ma kn mb mc md kr me mf mg kv mh mi mj mk bi translated">2/3将应用程序同步到Argo的“工作目录”</h2><p id="b842" class="pw-post-body-paragraph kc kd iu ke b kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv mp kx ky kz in bi translated">您将被带到应用程序平铺视图，在那里您将看到您刚刚配置的应用程序。单击图标，您将进入应用程序详细信息网络视图。一旦应用程序被部署，这个视图是惊人的，所以点击同步按钮将你的清单拷贝到Argo的“工作目录”,在那里它将自动为你运行一个<code class="fe mr ms mt mu b">helm install</code>或<code class="fe mr ms mt mu b">kubectl apply -f .</code>。</p><figure class="mv mw mx my gu jv gi gj paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="gi gj nv"><img src="../Images/1ae770dc5eeba8b4e8db1449159bc458.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ij_vr6X13LYRoMsOEImobg.png"/></div></div></figure><p id="d2ec" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">一个窗格从右侧滑入，让您选择想要同步的内容。在这种情况下，我选择了“模拟运行”复选框，以便Argo CD simulates使用部署的实际值生成模板清单。</p><figure class="mv mw mx my gu jv gi gj paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="gi gj nv"><img src="../Images/0e82df23e02f7b35f583fe6974e3bbd7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ObrI-8y1RKDLIllKhGeTTQ.png"/></div></div></figure><p id="d3ff" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">点击同步按钮后，你会在右边看到最新的同步结果“同步”，然后显示“同步成功”。这意味着清单看起来不错，我们已经准备好部署了！</p><figure class="mv mw mx my gu jv gi gj paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="gi gj nw"><img src="../Images/eaa0fd188561d85243cf669ce349af80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vxp_-cm324AKy1f_vCO1nA.png"/></div></div></figure><h2 id="e01f" class="ls lt iu bd lu lv lw dn lx ly lz dp ma kn mb mc md kr me mf mg kv mh mi mj mk bi translated">3/3同步！</h2><p id="285a" class="pw-post-body-paragraph kc kd iu ke b kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv mp kx ky kz in bi translated">单击同步，然后在滑出的面板中单击同步，观看魔术！我想不出更方便的方法来可视化所有不同类型的K8s资源。</p><figure class="mv mw mx my gu jv gi gj paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="gi gj jr"><img src="../Images/42bc6cdc3d44560cbe690124d90cda72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*-jNajPVe3AQZVhixKj1aqQ.gif"/></div></div></figure><p id="18f9" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">如果你和我一样，从其他人写的Medium文章中受益匪浅，也可以考虑加入Medium，并使用我下面的推荐链接。</p><div class="la lb gq gs lc ld"><a href="https://jyeee.medium.com/membership" rel="noopener follow" target="_blank"><div class="le ab fp"><div class="lf ab lg cl cj lh"><h2 class="bd iv gz z fq li fs ft lj fv fx it bi translated">通过我的推荐链接加入Medium-Jason Yee</h2><div class="lk l"><h3 class="bd b gz z fq li fs ft lj fv fx dk translated">看别人的媒介文章我学到了很多，你也可以！你的会员资格直接支持我和其他…</h3></div><div class="ll l"><p class="bd b dl z fq li fs ft lj fv fx dk translated">jyeee.medium.com</p></div></div><div class="lm l"><div class="nx l lo lp lq lm lr ka ld"/></div></div></a></div></div></div>    
</body>
</html>