<html>
<head>
<title>Testing GitHub Actions and Ruby on Rails app with parallel jobs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用并行作业测试GitHub操作和Ruby on Rails应用程序</h1>
<blockquote>原文：<a href="https://itnext.io/testing-github-actions-and-ruby-on-rails-app-with-parallel-jobs-426f1274ace4?source=collection_archive---------9-----------------------#2019-09-16">https://itnext.io/testing-github-actions-and-ruby-on-rails-app-with-parallel-jobs-426f1274ace4?source=collection_archive---------9-----------------------#2019-09-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="0d86" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">GitHub推出了他们自己的CI服务器解决方案，名为GitHub Actions。您将学习如何使用YAML配置文件在GitHub Actions上设置Ruby on Rails应用程序。为了更快地运行RSpec测试套件，您将在GitHub操作上使用矩阵策略配置并行作业。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/054668fba51942e3663aa7039fda2a18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4cSQkXW2rICArgPx.jpeg"/></div></div></figure><h1 id="39e4" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">自动化GitHub操作的工作流程</h1><p id="9f96" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">GitHub Actions利用世界一流的CI/CD，轻松实现所有软件工作流程的自动化。通过简单的YAML配置，就可以直接从GitHub构建、测试和部署您的代码。</p><p id="a8f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您甚至可以创建几个YAML配置文件，在您的配置项上运行一组不同的规则，如计划每日配置项构建。但是让我们严格关注如何在GitHub操作上运行Rails应用程序的测试。</p><h1 id="3064" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">用YAML配置在GitHub上设置Ruby on Rails动作</h1><p id="ab8c" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">在您的项目存储库中，您需要创建文件<code class="fe ma mb mc md b">.github/workflows/main.yaml</code>,感谢它GitHub将运行您的CI构建。您可以在GitHub存储库的<em class="me"> Actions </em>选项卡中找到CI构建的结果。</p><p id="676f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们的例子中，Rails应用程序有Postgres数据库，所以您需要用docker容器设置服务来运行Postgres DB。</p><pre class="km kn ko kp gt mf md mg mh aw mi bi"><span id="bf3e" class="mj ky iq md b gy mk ml l mm mn"><em class="me"># If you need DB like PostgreSQL then define service below.</em><br/><em class="me"># Example for Redis can be found here:</em><br/><em class="me"># https://github.com/actions/example-services/tree/master/.github/workflows</em><br/>services:<br/>  postgres:<br/>    image: postgres:10.8<br/>    env:<br/>      POSTGRES_USER: postgres<br/>      POSTGRES_PASSWORD: ""<br/>      POSTGRES_DB: postgres<br/>    ports:<br/>    <em class="me"># will assign a random free host port</em><br/>    - 5432/tcp<br/>    <em class="me"># needed because the postgres container does not provide a healthcheck</em><br/>    options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5</span></pre><p id="8252" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了能够安装来自项目<code class="fe ma mb mc md b">Gemfile</code>的<code class="fe ma mb mc md b">pg</code> ruby gem，你将需要Ubuntu系统中的<code class="fe ma mb mc md b">libpq-dev</code>库，因此需要安装它。<code class="fe ma mb mc md b">libpq</code>是一组库函数，允许客户端程序向PostgreSQL后端服务器传递查询并接收这些查询的结果。我们需要它来编译<code class="fe ma mb mc md b">pg</code>宝石。下一步将是安装我们的红宝石宝石。</p><pre class="km kn ko kp gt mf md mg mh aw mi bi"><span id="0a3d" class="mj ky iq md b gy mk ml l mm mn"><em class="me"># required to compile pg ruby gem</em><br/>- name: install PostgreSQL client<br/>  run: sudo apt-get install libpq-dev<br/><br/>- name: Build and create DB<br/>  env:<br/>    <em class="me"># use localhost for the host here because we have specified a container for the job.</em><br/>    <em class="me"># If we were running the job on the VM this would be postgres</em><br/>    PGHOST: localhost<br/>    PGUSER: postgres<br/>    PGPORT: ${{ job.services.postgres.ports[5432] }} <em class="me"># get randomly assigned published port</em><br/>    RAILS_ENV: test<br/>  run: |<br/>    gem install bundler<br/>    bundle install --jobs 4 --retry 3<br/>    bin/rails db:setup</span></pre><p id="2508" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要跨并行作业运行RSpec测试，您需要设置矩阵特性，并因此运行跨作业分布的整个测试套件。</p><h1 id="6e35" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">配置构建矩阵</h1><p id="551e" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">构建矩阵为要测试的虚拟环境提供了不同的配置。例如，一个工作流可以为一种语言、操作系统等的多个支持版本运行一个作业。对于每个配置，都会有一个作业副本运行并报告状态。</p><p id="3067" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在运行并行测试的情况下，您希望在相同的Ruby版本和Ubuntu系统上运行Rails应用程序。但是您希望将RSpec测试套件分成2组，这样一半的测试将进行到第一个并行作业，另一半将进行到另一个作业。</p><p id="58bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了分割测试，你可以使用Ruby gem<a class="ae mo" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=how-to-run-rspec-on-github-actions-for-ruby-on-rails-app-using-parallel-jobs" rel="noopener ugc nofollow" target="_blank">backpack Pro</a>来动态分割并行GitHub任务中的测试。由于每个并行作业将消耗一组从backpack Pro API队列获取的测试，以确保每个并行作业在相似的时间完成工作。这允许均匀分布的测试，并且在并行作业中没有瓶颈(没有缓慢的作业)。您的配置项构建将尽可能快。</p><p id="fa3c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们的例子中，您将测试分成两个并行的任务，因此您需要将2设置为<code class="fe ma mb mc md b">matrix.ci_node_total</code>。那么每个并行作业应该从0开始为<code class="fe ma mb mc md b">matrix.ci_node_index</code>分配索引。第一个并行作业的索引为0，第二个作业的索引为1。这允许<a class="ae mo" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=how-to-run-rspec-on-github-actions-for-ruby-on-rails-app-using-parallel-jobs" rel="noopener ugc nofollow" target="_blank">backpackage Pro</a>知道在一个特定的任务上应该执行什么样的测试。</p><pre class="km kn ko kp gt mf md mg mh aw mi bi"><span id="e207" class="mj ky iq md b gy mk ml l mm mn"><em class="me"># https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idstrategymatrix</em><br/>strategy:<br/>  fail-fast: false<br/>  matrix:<br/>    <em class="me"># Set N number of parallel jobs you want to run tests on.</em><br/>    <em class="me"># Use higher number if you have slow tests to split them on more parallel jobs.</em><br/>    <em class="me"># Remember to update ci_node_index below to 0..N-1</em><br/>    ci_node_total: [2]<br/>    <em class="me"># set N-1 indexes for parallel jobs</em><br/>    <em class="me"># When you run 2 parallel jobs then first job will have index 0,</em><br/>    <em class="me"># the second job will have index 1 etc</em><br/>    ci_node_index: [0, 1]</span></pre><p id="dc18" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您还需要为<a class="ae mo" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=how-to-run-rspec-on-github-actions-for-ruby-on-rails-app-using-parallel-jobs" rel="noopener ugc nofollow" target="_blank">背包Pro </a>指定API令牌，对于RSpec，它将是<code class="fe ma mb mc md b">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC</code>。</p><p id="b4bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，您可以使用backpack Pro在队列模式下为RSpec运行测试:</p><p id="be47" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ma mb mc md b">bundle exec rake knapsack_pro:queue:rspec</code></p><h1 id="065f" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Rails测试的完整GitHub动作配置文件</h1><p id="1160" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">在这里你可以找到GitHub动作和Ruby on Rails项目的完整YAML配置文件。</p><p id="1a9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我还录制了一段视频，展示了它是如何工作的，以及如何在GitHub Actions上配置CI构建并行作业。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mp mq l"/></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk translated">GitHub Actions + Rails app并行测试</figcaption></figure><pre class="km kn ko kp gt mf md mg mh aw mi bi"><span id="3fe1" class="mj ky iq md b gy mk ml l mm mn"><br/># .github/workflows/main.yaml<br/>name: Main<br/><br/>on: [push]<br/><br/>jobs:<br/>  vm-job:<br/>    runs-on: ubuntu-latest<br/><br/>    # If you need DB like PostgreSQL then define service below.<br/>    # Example for Redis can be found here:<br/>    # https://github.com/actions/example-services/tree/master/.github/workflows<br/>    services:<br/>      postgres:<br/>        image: postgres:10.8<br/>        env:<br/>          POSTGRES_USER: postgres<br/>          POSTGRES_PASSWORD: ""<br/>          POSTGRES_DB: postgres<br/>        ports:<br/>        # will assign a random free host port<br/>        - 5432/tcp<br/>        # needed because the postgres container does not provide a healthcheck<br/>        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5<br/><br/>    # https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idstrategymatrix<br/>    strategy:<br/>      fail-fast: false<br/>      matrix:<br/>        # Set N number of parallel jobs you want to run tests on.<br/>        # Use higher number if you have slow tests to split them on more parallel jobs.<br/>        # Remember to update ci_node_index below to 0..N-1<br/>        ci_node_total: [2]<br/>        # set N-1 indexes for parallel jobs<br/>        # When you run 2 parallel jobs then first job will have index 0, the second job will have index 1 etc<br/>        ci_node_index: [0, 1]<br/><br/>    steps:<br/>    - uses: actions/checkout@v1<br/><br/>    - name: Set up Ruby 2.6<br/>      uses: actions/setup-ruby@v1<br/>      with:<br/>        ruby-version: 2.6.3<br/><br/>    # required to compile pg ruby gem<br/>    - name: install PostgreSQL client<br/>      run: sudo apt-get install libpq-dev<br/><br/>    - name: Build and create DB<br/>      env:<br/>        # use localhost for the host here because we have specified a container for the job.<br/>        # If we were running the job on the VM this would be postgres<br/>        PGHOST: localhost<br/>        PGUSER: postgres<br/>        PGPORT: ${{ job.services.postgres.ports[5432] }} # get randomly assigned published port<br/>        RAILS_ENV: test<br/>      run: |<br/>        gem install bundler<br/>        bundle install --jobs 4 --retry 3<br/>        bin/rails db:setup<br/><br/>    - name: Run tests<br/>      env:<br/>        PGHOST: localhost<br/>        PGUSER: postgres<br/>        PGPORT: ${{ job.services.postgres.ports[5432] }} # get randomly assigned published port<br/>        RAILS_ENV: test<br/>        KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC: ${{ secrets.KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC }}<br/>        KNAPSACK_PRO_TEST_SUITE_TOKEN_CUCUMBER: ${{ secrets.KNAPSACK_PRO_TEST_SUITE_TOKEN_CUCUMBER }}<br/>        KNAPSACK_PRO_TEST_SUITE_TOKEN_MINITEST: ${{ secrets.KNAPSACK_PRO_TEST_SUITE_TOKEN_MINITEST }}<br/>        KNAPSACK_PRO_TEST_SUITE_TEST_UNIT: ${{ secrets.KNAPSACK_PRO_TEST_SUITE_TOKEN_TEST_UNIT }}<br/>        KNAPSACK_PRO_TEST_SUITE_TOKEN_SPINACH: ${{ secrets.KNAPSACK_PRO_TEST_SUITE_TOKEN_SPINACH }}<br/>        KNAPSACK_PRO_CI_NODE_TOTAL: ${{ matrix.ci_node_total }}<br/>        KNAPSACK_PRO_CI_NODE_INDEX: ${{ matrix.ci_node_index }}<br/>      run: |<br/>        # run tests in Knapsack Pro Regular Mode<br/>        bundle exec rake knapsack_pro:rspec<br/>        bundle exec rake knapsack_pro:cucumber<br/>        bundle exec rake knapsack_pro:minitest<br/>        bundle exec rake knapsack_pro:test_unit<br/>        bundle exec rake knapsack_pro:spinach<br/><br/>        # you can use Knapsack Pro in Queue Mode once recorded first CI build with Regular Mode<br/>        bundle exec rake knapsack_pro:queue:rspec<br/>        bundle exec rake knapsack_pro:queue:cucumber<br/>        bundle exec rake knapsack_pro:queue:minitest</span></pre><p id="2d21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">源代码:<a class="ae mo" href="https://gist.github.com/ArturT/a35284f34c2dc0b61a0ad2b4dd4bacae" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/ArturT/a 35284 f 34 c 2d c0b 61 a0ad 2 B4 DD 4 bacae</a></p><h1 id="a9fa" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">队列模式下的动态测试套件拆分</h1><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mv mq l"/></div></figure><p id="e59a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想更好地理解背包Pro中的队列模式是如何工作的，以及它还能解决什么问题，你可以在下面的视频中找到一些有用的信息。</p><p id="e5b8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望这对你有所帮助。</p></div><div class="ab cl mw mx hu my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="ij ik il im in"><p id="85ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="me">原载于2019年9月16日</em><a class="ae mo" href="https://docs.knapsackpro.com/2019/how-to-run-rspec-on-github-actions-for-ruby-on-rails-app-using-parallel-jobs" rel="noopener ugc nofollow" target="_blank"><em class="me">https://docs.knapsackpro.com</em></a><em class="me">。</em></p></div></div>    
</body>
</html>