<html>
<head>
<title>6 Easy Ways to Manage and Harden VM Images in Azure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Azure中管理和强化虚拟机映像的6种简单方法</h1>
<blockquote>原文：<a href="https://itnext.io/6-easy-ways-to-manage-and-harden-vm-images-in-azure-1ab933099e7e?source=collection_archive---------3-----------------------#2020-08-23">https://itnext.io/6-easy-ways-to-manage-and-harden-vm-images-in-azure-1ab933099e7e?source=collection_archive---------3-----------------------#2020-08-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/855f61d9e2178ab1a19ebe1e674d6988.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AeUYi7TT4Xvmy5-qI0KVhA.png"/></div></div></figure><div class=""/><p id="b177" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">管理虚拟机映像可能是一场噩梦。这里有6个简单的方法来说明如何在Azure中无缝地构建、共享、测试和复制图像。另外，您还可以了解如何基于事件驱动架构构建图像通知。</p><h1 id="067c" class="kz la je bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated"><strong class="ak">问题</strong></h1><p id="03c8" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">无论您管理100台虚拟机还是1000多台构建和强化虚拟机映像的虚拟机，您是否手动管理映像？如果您这样做了，您就会知道这是非常昂贵的，并且会导致难以检测的错误和潜在的安全漏洞。</p><p id="ac2f" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面是我如何为我的客户解决这个问题。我为Azure创建图像管理的过程。</p></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h1 id="327d" class="kz la je bd lb lc mj le lf lg mk li lj lk ml lm ln lo mm lq lr ls mn lu lv lw bi translated">1.使用Azure Image Builder构建映像</h1><p id="c456" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">Azure Image Builder是一项允许您使用Azure CLI创建自定义映像的服务。基于JSON模板的图像创建，示例如下。</p><figure class="mo mp mq mr gt iv"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="1dce" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我必须把原来的模板剪下来，因为它太长了。<a class="ae mu" href="https://github.com/danielsollondon/azvmimagebuilder/blob/master/quickquickstarts/0_Creating_a_Custom_Linux_Managed_Image/helloImageTemplateLinux.json" rel="noopener ugc nofollow" target="_blank">在这里</a>你可以找到完整的例子。</p><p id="5cee" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">ARM模板非常简单，它包含以下属性:</p><ul class=""><li id="b19c" class="mv mw je kd b ke kf ki kj km mx kq my ku mz ky na nb nc nd bi translated"><em class="ne">身份</em>部分是必需的，您必须为image builder创建托管身份，以获得创建和编辑图像的权限</li><li id="720e" class="mv mw je kd b ke nf ki ng km nh kq ni ku nj ky na nb nc nd bi translated"><em class="ne"> VmProfile </em>用于设置虚拟机配置计划</li><li id="52fc" class="mv mw je kd b ke nf ki ng km nh kq ni ku nj ky na nb nc nd bi translated"><em class="ne">源</em>允许您指定基本图像参数。我使用最新的Ubuntu Server 18.04 LTS从Canonical <br/>定制部分允许您指定虚拟机加固脚本。</li><li id="6d96" class="mv mw je kd b ke nf ki ng km nh kq ni ku nj ky na nb nc nd bi translated"><em class="ne">定制</em>部分允许您指定虚拟机强化脚本。</li></ul><p id="cd77" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae mu" href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/image-builder-json" rel="noopener ugc nofollow" target="_blank">在这里</a>您可以看到图像生成器选项的完整列表。</p><p id="46c4" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面您可以找到基于提到的JSON模板构建映像的CLI命令。</p><figure class="mo mp mq mr gt iv"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="3e48" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在运行此模板之前，您应该启用Azure Image Builder，设置权限，创建资源组，并创建托管身份。<a class="ae mu" href="https://github.com/danielsollondon/azvmimagebuilder/blob/master/quickquickstarts/0_Creating_a_Custom_Linux_Managed_Image/readme.md" rel="noopener ugc nofollow" target="_blank">在这里</a>你可以找到一个循序渐进的过程。</p><h2 id="9995" class="nk la je bd lb nl nm dn lf nn no dp lj km np nq ln kq nr ns lr ku nt nu lv nv bi translated">优势</h2><p id="2d03" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">模板和流程本身很容易理解，可以很容易地与Azure DevOps集成。</p><h2 id="20c3" class="nk la je bd lb nl nm dn lf nn no dp lj km np nq ln kq nr ns lr ku nt nu lv nv bi translated">不足之处</h2><p id="041f" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">image builder仍在审查中，因此不建议在生产中使用它。与Hashicorp Packer相比，设置可能有点困难。(在下一节解释如何使用封隔器)。</p></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h1 id="ac9d" class="kz la je bd lb lc mj le lf lg mk li lj lk ml lm ln lo mm lq lr ls mn lu lv lw bi translated">2.使用Hashicorp打包程序构建图像</h1><p id="4d8b" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">Hashicorp Packer是一个多平台解决方案，允许基于JSON模板构建定制图像。JSON模板结构良好，基于易于理解的对象模型。JSON模板只有三个根对象:<a class="ae mu" href="https://www.packer.io/docs/communicators" rel="noopener ugc nofollow" target="_blank">通信器</a>、<a class="ae mu" href="https://www.packer.io/docs/builders" rel="noopener ugc nofollow" target="_blank">构建器</a>、<a class="ae mu" href="https://www.packer.io/docs/provisioners" rel="noopener ugc nofollow" target="_blank">供应器</a>和<a class="ae mu" href="https://www.packer.io/docs/post-processors" rel="noopener ugc nofollow" target="_blank">后处理器</a>。下面你可以找到JSON模板。</p><figure class="mo mp mq mr gt iv"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="f361" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">JSON模板创建了Ubuntu的VHD映像，并预装了NGINX web服务器和其他更新。在这里你可以找到很多其他的模板。</p><p id="b431" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要设置包装机，您可以使用<a class="ae mu" href="https://chocolatey.org/" rel="noopener ugc nofollow" target="_blank">巧克力</a>包装管理器:</p><pre class="mo mp mq mr gt nw nx ny nz aw oa bi"><span id="ba08" class="nk la je nx b gy ob oc l od oe">choco install packer -y</span></pre><p id="9f4e" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您可以使用以下命令运行JSON模板:</p><pre class="mo mp mq mr gt nw nx ny nz aw oa bi"><span id="4556" class="nk la je nx b gy ob oc l od oe">packer build &lt;path/your/template.json&gt;</span></pre><p id="020f" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf">在</strong>运行模板之前，您需要创建具有适当权限的管理身份或服务主体，例如:</p><pre class="mo mp mq mr gt nw nx ny nz aw oa bi"><span id="0a41" class="nk la je nx b gy ob oc l od oe">az ad sp create-for-rbac -n "ImageContributor" <br/> --role contributor `    <br/> --scopes /subscriptions/&lt;subscription_id&gt; `     <br/> --sdk-auth &gt; az-principal.auth</span></pre><p id="18e9" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">该命令自动创建带有<code class="fe of og oh nx b">clientId</code>、<code class="fe of og oh nx b">clientSecret</code>、<code class="fe of og oh nx b">tenantId</code>、<code class="fe of og oh nx b">subscriptionId</code>等字段的JSON文件。</p><p id="37be" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae mu" href="https://www.packer.io/docs/builders/azure-arm.html" rel="noopener ugc nofollow" target="_blank">在这里</a>你可以找到设置和运行封隔器模板的其他细节。</p><h2 id="1d01" class="nk la je bd lb nl nm dn lf nn no dp lj km np nq ln kq nr ns lr ku nt nu lv nv bi translated">优势</h2><p id="ef6f" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">Packer和JSON模板简单易懂。它们允许您快速设置环境并开始构建映像。还有一个强大的社区。此外，打包程序支持多个云提供商。</p><h2 id="de7d" class="nk la je bd lb nl nm dn lf nn no dp lj km np nq ln kq nr ns lr ku nt nu lv nv bi translated">不足之处</h2><p id="ffbd" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">我没有发现任何严重的缺点。但是，在构建映像时，打包程序总是会移除一些映像操作所需的磁盘。例如，用于复制图像。</p></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h1 id="6adf" class="kz la je bd lb lc mj le lf lg mk li lj lk ml lm ln lo mm lq lr ls mn lu lv lw bi translated">3.共享图像</h1><p id="6f77" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">若要在Azure中共享图像，您可以使用共享图像库。它可以:</p><ul class=""><li id="c277" class="mv mw je kd b ke kf ki kj km mx kq my ku mz ky na nb nc nd bi translated">创建图像定义</li><li id="556a" class="mv mw je kd b ke nf ki ng km nh kq ni ku nj ky na nb nc nd bi translated">保留图像的版本</li><li id="bdea" class="mv mw je kd b ke nf ki ng km nh kq ni ku nj ky na nb nc nd bi translated">共享图像</li></ul><p id="3e0b" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">例如，您可以在您的Azure订阅、资源组和租户之间共享图像。</p><figure class="mo mp mq mr gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oi"><img src="../Images/0804a9ba4b61b71558f275c072bae410.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iw6io89o7n0kquGB0DpY2g.png"/></div></div></figure><p id="4a82" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在当前情况下，您可以创建一个用户组或单个用户/服务主体，仅为该共享图库分配参与者权限。</p><pre class="mo mp mq mr gt nw nx ny nz aw oa bi"><span id="bd34" class="nk la je nx b gy ob oc l od oe">az ad sp create-for-rbac -n "ImageContributor" <br/> --role contributor `    <br/> --scopes <!-- -->/subscriptions/&lt;subscr-id&gt;/resourceGroups/sig-we-rg/providers/Microsoft.Compute/galleries/testsig</span></pre><p id="5bde" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">因此，来自该组的用户可以在不同的订阅中基于这个共享映像库中的Ubuntu映像创建虚拟机。</p><pre class="mo mp mq mr gt nw nx ny nz aw oa bi"><span id="a09a" class="nk la je nx b gy ob oc l od oe">az vm create `<br/>  --resource-group myResourceGroup `<br/>  --name UbuntuVM`<br/>  --image "/subscriptions/&lt;subscr-id&gt;/resourceGroups/sig-we-rg/providers/Microsoft.Compute/galleries/testsig/images/ubuntu-server-image-def/versions/1.0.0" \<br/>  --admin-username azureuser \<br/>  --generate-ssh-keys</span></pre><h2 id="1bbe" class="nk la je bd lb nl nm dn lf nn no dp lj km np nq ln kq nr ns lr ku nt nu lv nv bi translated">优势</h2><p id="643a" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">Azure共享图片库允许您在组织内轻松构建、共享、管理和自定义图片。SIG拥有Azure CLI，因此您可以轻松地自动化图像分发。</p><h2 id="6815" class="nk la je bd lb nl nm dn lf nn no dp lj km np nq ln kq nr ns lr ku nt nu lv nv bi translated">不足之处</h2><p id="a72e" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">该图像保留在共享的访问画廊中。因此，它在物理上停留在那里。因此，当您在订阅之间共享它时，您不能单独为每个订阅更改或删除它。</p></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h1 id="a931" class="kz la je bd lb lc mj le lf lg mk li lj lk ml lm ln lo mm lq lr ls mn lu lv lw bi translated">4.复制图像</h1><p id="1454" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">通过复制图像，您可以将图像从一个订阅传递到另一个订阅，或者从一个资源组传递到另一个资源组。所有复制的图像都是相互独立的。您可以使用<a class="ae mu" href="https://docs.microsoft.com/en-us/cli/azure/ext/image-copy-extension/image?view=azure-cli-latest" rel="noopener ugc nofollow" target="_blank"><em class="ne">Azure Image Copy extension</em></a>复制图像，或者使用Go实现手动复制。让我们看看下面的例子。</p><h2 id="b7a2" class="nk la je bd lb nl nm dn lf nn no dp lj km np nq ln kq nr ns lr ku nt nu lv nv bi translated">使用Az复制扩展复制图像</h2><figure class="mo mp mq mr gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oj"><img src="../Images/74273361fd82ed3d2cd3227ffd4390e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s1IjvLgobxhjP5COfQrRdg.png"/></div></div></figure><p id="433b" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了在订阅之间复制图像，我使用了<em class="ne"> Az图像复制扩展</em>。它在资源组a中创建了一个新的映像(来自源映像)。<br/>安装复制扩展:</p><pre class="mo mp mq mr gt nw nx ny nz aw oa bi"><span id="1e47" class="nk la je nx b gy ob oc l od oe">az extension add --name image-copy-extension</span></pre><p id="c51b" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">复制命令:</p><figure class="mo mp mq mr gt iv"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="115e" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf">重要的</strong>。创建托管映像后，打包程序会自动移除磁盘。</p><h2 id="2d38" class="nk la je bd lb nl nm dn lf nn no dp lj km np nq ln kq nr ns lr ku nt nu lv nv bi translated">优势</h2><p id="4679" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">Az图像复制扩展易于使用和自动化。</p><h2 id="5b63" class="nk la je bd lb nl nm dn lf nn no dp lj km np nq ln kq nr ns lr ku nt nu lv nv bi translated">不足之处</h2><p id="01d1" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">映像必须包含被管理的光盘，否则复制过程将失败，并显示“未找到资源”错误消息。</p><h2 id="377c" class="nk la je bd lb nl nm dn lf nn no dp lj km np nq ln kq nr ns lr ku nt nu lv nv bi translated">手动复制图像</h2><figure class="mo mp mq mr gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ok"><img src="../Images/1f1ac0f5189bd07ea71326eb8ecad892.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u4v0hRO0Ej_wAflvnImvcQ.png"/></div></div></figure><p id="40b3" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果Az复制映像扩展对您不起作用，您可以在存储帐户中创建一个VHD映像，并将其复制到另一个目标存储帐户。</p><p id="c471" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">流程工作流:</p><ol class=""><li id="06fe" class="mv mw je kd b ke kf ki kj km mx kq my ku mz ky ol nb nc nd bi translated">创建两个存储帐户，源和目标</li><li id="b844" class="mv mw je kd b ke nf ki ng km nh kq ni ku nj ky ol nb nc nd bi translated">在源存储帐户中创建VHD映像。您可以使用第一部分中的打包脚本。</li><li id="0dbd" class="mv mw je kd b ke nf ki ng km nh kq ni ku nj ky ol nb nc nd bi translated">为VHD源映像生成共享访问签名。在这里你可以找到一个如何使用Azure CLI的例子。</li></ol><p id="0bfc" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">4.并复制图像。为了演示，我使用了下面的Go脚本。您还可以使用<strong class="kd jf">中的</strong>、<a class="ae mu" href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/disks-upload-vhd-to-managed-disk-powershell" rel="noopener ugc nofollow" target="_blank">、<strong class="kd jf">工具，这里有</strong>、</a>、<strong class="kd jf">的例子说明如何操作。</strong></p><figure class="mo mp mq mr gt iv"><div class="bz fp l di"><div class="ms mt l"/></div></figure><h2 id="b2f3" class="nk la je bd lb nl nm dn lf nn no dp lj km np nq ln kq nr ns lr ku nt nu lv nv bi translated">优势</h2><p id="7f7f" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">当前的图像处理工作流程是完全自定义的。所以，可以随时更改。此外，它可以是有用的，当Az图像复制扩展不适合你。例如，在创建映像时删除被管理的磁盘。</p><h2 id="294f" class="nk la je bd lb nl nm dn lf nn no dp lj km np nq ln kq nr ns lr ku nt nu lv nv bi translated">不足之处</h2><p id="a668" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">您必须实施所有工作流程步骤，包括:</p><ul class=""><li id="c708" class="mv mw je kd b ke kf ki kj km mx kq my ku mz ky na nb nc nd bi translated">创造VHD</li><li id="31b8" class="mv mw je kd b ke nf ki ng km nh kq ni ku nj ky na nb nc nd bi translated">生成和管理SAS令牌</li><li id="6cf2" class="mv mw je kd b ke nf ki ng km nh kq ni ku nj ky na nb nc nd bi translated">复制图像</li><li id="afed" class="mv mw je kd b ke nf ki ng km nh kq ni ku nj ky na nb nc nd bi translated">清理</li><li id="6467" class="mv mw je kd b ke nf ki ng km nh kq ni ku nj ky na nb nc nd bi translated">转换图像</li></ul></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h1 id="5125" class="kz la je bd lb lc mj le lf lg mk li lj lk ml lm ln lo mm lq lr ls mn lu lv lw bi translated">5.图像和磁盘转换</h1><p id="074e" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">将VHD映像转换为托管磁盘，或将托管磁盘转换为VHD映像的操作。当您需要在映像复制过程中使用Azure Shared Image Gallery在整个组织中分发映像时，以及当您需要启动新的虚拟机时，这非常有用。</p><p id="321a" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">此外，当您有一些旧的VHD，并且想要支持它、安装更新、设置自动备份、使用可用性和可用性区域时，它也很有用。</p><p id="1d7b" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae mu" href="https://docs.microsoft.com/en-us/azure/virtual-machines/managed-disks-overview" rel="noopener ugc nofollow" target="_blank">这里的</a>是托管映像的优势列表。</p><h2 id="db5d" class="nk la je bd lb nl nm dn lf nn no dp lj km np nq ln kq nr ns lr ku nt nu lv nv bi translated">将VHD映像转换到被管理的磁盘</h2><figure class="mo mp mq mr gt iv"><div class="bz fp l di"><div class="ms mt l"/></div></figure><h2 id="ce43" class="nk la je bd lb nl nm dn lf nn no dp lj km np nq ln kq nr ns lr ku nt nu lv nv bi translated">将托管磁盘转换为托管映像</h2><figure class="mo mp mq mr gt iv"><div class="bz fp l di"><div class="ms mt l"/></div></figure><h2 id="699b" class="nk la je bd lb nl nm dn lf nn no dp lj km np nq ln kq nr ns lr ku nt nu lv nv bi translated">优势</h2><p id="c816" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">通过这两个cmdlets，您可以跨不同的订阅和资源组向您的Azure共享映像交付映像。</p><h2 id="fc96" class="nk la je bd lb nl nm dn lf nn no dp lj km np nq ln kq nr ns lr ku nt nu lv nv bi translated">不足之处</h2><p id="0c29" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">转换过程可能会很复杂，因为有些图像可能会过时，并且转换过程可能会失败。</p></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h1 id="bf78" class="kz la je bd lb lc mj le lf lg mk li lj lk ml lm ln lo mm lq lr ls mn lu lv lw bi translated">6.测试图像</h1><p id="0dbe" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">要测试映像，您可以简单地从映像库中启动新的虚拟机，并使用映像定义。</p><figure class="mo mp mq mr gt iv"><div class="bz fp l di"><div class="ms mt l"/></div></figure><h2 id="4094" class="nk la je bd lb nl nm dn lf nn no dp lj km np nq ln kq nr ns lr ku nt nu lv nv bi translated">优势</h2><p id="5781" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">命令和过程本身相当简单。</p><h2 id="5280" class="nk la je bd lb nl nm dn lf nn no dp lj km np nq ln kq nr ns lr ku nt nu lv nv bi translated">不足之处</h2><p id="f3fa" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">它不检查JSON配置中是否正确安装了特定的软件和服务。所以这个逻辑必须单独实现。</p></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h1 id="1f1f" class="kz la je bd lb lc mj le lf lg mk li lj lk ml lm ln lo mm lq lr ls mn lu lv lw bi translated">图像发布/订阅子系统概念(奖金)</h1><p id="c7c0" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">跨多个订阅或资源组管理映像可能会很困难，尤其是当您不断生成新版本的映像，或者您有一些自动化流程来启动新的虚拟机时。</p><p id="43c7" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这种情况下，您需要构建一个通知系统，用于在创建新图像、新版本或图像定义出现在Azure共享图像库中等等时通知不同的组件。您可以使用带有过滤器的Azure Event Grid轻松创建它。</p><p id="c1e0" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面你可以看到如何用事件网格来完成。你可以使用Queue、Webhook，甚至<em class="ne"> Azure Service Bus </em>向目标组件传递消息。</p><figure class="mo mp mq mr gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi om"><img src="../Images/609087314ce802b15551e79752a0dc28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H8HTj07NNpLBrqpKy4eIjw.png"/></div></div></figure><p id="2184" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面的例子演示了如何用<em class="ne">图像过滤器</em>创建事件网格。</p><figure class="mo mp mq mr gt iv"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="1ea1" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae mu" href="https://github.com/Boriszn/AzureValidationMiddleware/blob/master/src/Deployment/AzureValidationMiddlewareFunctionAppDeployResources.yaml#L65" rel="noopener ugc nofollow" target="_blank">在这里</a>你可以找到完整的Azure DevOps pipeline，以及如何部署该事件网格和链接其他所需资源的步骤。</p><h1 id="3317" class="kz la je bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">结论</h1><p id="2c31" class="pw-post-body-paragraph kb kc je kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">就是这样。基于这些方法，您可以轻松地在Azure DevOps中设置映像强化和管理管道。</p></div></div>    
</body>
</html>