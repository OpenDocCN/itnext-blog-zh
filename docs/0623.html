<html>
<head>
<title>Automate deployment with Github Web Hooks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Github Web Hooks自动部署</h1>
<blockquote>原文：<a href="https://itnext.io/automate-deployment-with-webhooks-18735f1c7f84?source=collection_archive---------1-----------------------#2018-04-19">https://itnext.io/automate-deployment-with-webhooks-18735f1c7f84?source=collection_archive---------1-----------------------#2018-04-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><blockquote class="jn jo jp"><p id="2159" class="jq jr js jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated"><a class="ae kp" href="https://www.linkedin.com/cws/share?url=https%3A%2F%2Fitnext.io%2Fautomate-deployment-with-webhooks-18735f1c7f84%3Futm_source%3Dmedium_sharelink%26utm_medium%3Dsocial%26utm_campaign%3Dbuffer" rel="noopener ugc nofollow" target="_blank">点击这里在LinkedIn上分享这篇文章</a></p></blockquote><p id="237a" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">我最近在做我的作品集网站，我不得不在我的<a class="ae kp" href="http://digitalocean.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="jt ir">数字海洋</strong> </a>机器上做很多DevOps的东西。我用<a class="ae kp" href="https://www.nginx.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="jt ir"> nginx </strong> </a>的反向代理来运行我的节点应用程序。在这样做的时候，我不得不四处搜索nginx配置，我碰到有人在谈论这些叫做Github Web hooks的东西。这听起来很新奇，所以我去官方的Github网页查看了一下。一开始，我很困惑。我听说过网络挂钩，但我想不出为什么有人会使用它。当我继续阅读时，我逐渐意识到我可以在我的投资组合网站中使用它来自动化我的部署。这怎么可能呢？用Web钩子实现自动化部署意味着什么？是新的Javascript框架吗？</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi kt"><img src="../Images/1e4dca8f46c12c1b2f016f1929191c24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JUc2pMFVx44__HXuG7NTIA.jpeg"/></div></div></figure><h1 id="01d7" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">自动化部署</h1><p id="cd18" class="pw-post-body-paragraph jq jr iq jt b ju md jw jx jy me ka kb kq mf ke kf kr mg ki kj ks mh km kn ko ij bi translated">简而言之，当您对repo的主分支进行提交时，您的网站服务器会自动拉出主分支，关闭服务器并使用您的新提交重新启动它。<br/>这意味着在提交到主分支后，您不必手动SSH到您的服务器并运行shell命令。<br/>这是一个过于简化的自动化版本。所有公司都在他们的生产版本中使用它，在部署之前运行测试、版本、A/B测试。如今基本上一切都是自动化的。如果你想在自己的项目中开始这样做，请继续阅读。</p><h1 id="700b" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">网钩</h1><p id="b85b" class="pw-post-body-paragraph jq jr iq jt b ju md jw jx jy me ka kb kq mf ke kf kr mg ki kj ks mh km kn ko ij bi translated">当您将提交从本地机器推送到在线存储库(Github、BitBucket等)时，您实际上是将文件发送到Github管理的服务器。当你进行推送时，Github的人可以为你提供一个进入他们服务器的管道/峰值。<br/>所以你可以想到Github办公室的Bob ，他一生中唯一的工作就是当你的存储库中有推送时得到提醒。Github让你与Bob进行对话，并与他达成协议，无论何时进行推送，他都会向你的端点发送一个带有推送数据的请求。因此，您现在需要做的就是创建一个接受post请求的简单端点。然后你可以把这个端点交给鲍勃。这就是网络钩子的全部。它是鲍勃。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/670cb3fe9067a2766ecbabe00cacd12a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*J47dkj0-Q66-F9d_iflgIw.jpeg"/></div></figure><h1 id="cac1" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">创建您的端点</h1><figure class="ku kv kw kx gt ky"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="7012" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">如果你熟悉Node和Express，这对你来说会很简单。只要用你使用的任何语言创建一个端点就可以了。</p><h1 id="4fe5" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">告诉鲍勃这件事</h1><ol class=""><li id="fdb5" class="ml mm iq jt b ju md jy me kq mn kr mo ks mp ko mq mr ms mt bi translated">转到您的回购设置</li></ol><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi mu"><img src="../Images/555c83c293345d1534c971d18d0ab3a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7eTgKXMMunGxF5PgcEZh5Q.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">存储库设置</figcaption></figure><p id="7216" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">2.单击Webhooks选项卡</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi mz"><img src="../Images/e99758de2b12ed0f74881c14cd13d651.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PrxfOYFiuG2hFqG7QH8Nxg.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">Webhooks选项卡</figcaption></figure><p id="f370" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">然后添加一个webhook。</p><p id="6658" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">您将被问到以下问题:</p><ol class=""><li id="c6b1" class="ml mm iq jt b ju jv jy jz kq na kr nb ks nc ko mq mr ms mt bi translated">有效负载URL</li><li id="384d" class="ml mm iq jt b ju nd jy ne kq nf kr ng ks nh ko mq mr ms mt bi translated">内容类型</li><li id="7a88" class="ml mm iq jt b ju nd jy ne kq nf kr ng ks nh ko mq mr ms mt bi translated">您希望哪个事件触发此webhook？</li></ol><p id="a620" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">对于有效负载url，只需添加您的网站的URL，后跟您的端点。所以在我的例子中，我使用subhannaeem.com/webhooks/github作为我的有效载荷URL。</p><blockquote class="jn jo jp"><p id="84dc" class="jq jr js jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">本地主机在这里不起作用。Github需要一个唯一的URL。</p></blockquote><p id="af3e" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">对于内容类型，选择适合您的内容。我使用Node，所以我选择了JSON。</p><p id="8077" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">最后一个问题，我选择的选项:<strong class="jt ir">只是</strong> <code class="fe ni nj nk nl b"><strong class="jt ir">push</strong></code> <strong class="jt ir">事件。<br/> </strong>如果有人对我的回购提出提取请求或其他操作，我不想收到通知。我只想知道是否对我的回购主分支进行了推送。我们一会儿就会谈到这一点。</p><p id="bcc1" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">点击保存，你就可以开始了！</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi nm"><img src="../Images/f8ed1324cc6ac949a2951d1a3146e3ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gh6QFzlGOOWH8wm8Tnvovw.jpeg"/></div></div></figure><h1 id="55f1" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">设置部署脚本</h1><p id="9d39" class="pw-post-body-paragraph jq jr iq jt b ju md jw jx jy me ka kb kq mf ke kf kr mg ki kj ks mh km kn ko ij bi translated">现在我们已经设置了端点和WebHook，我们需要对Github发送给我们的数据做些什么。<br/>让我们在这里回顾一下。<br/>我们推动回购。Github的Bob接收我们的推送，并向我们的端点发送请求。然后我们检查请求是否包含正确的数据。如果是，那么我们重新启动服务器，通过向bob发送一个<strong class="jt ir"> 200响应</strong>来告诉他一切正常。如果数据无效，我们向他发送一个<strong class="jt ir"> 500响应</strong>。</p><p id="516b" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">如何重启服务器？让我们创建一个部署脚本。它会存在于我们的服务器上。它将负责拉动我们的分支并重新启动我们的web应用程序。我们将从我们的web应用程序代码中执行这个脚本。</p><figure class="ku kv kw kx gt ky"><div class="bz fp l di"><div class="mj mk l"/></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">deploy.sh</figcaption></figure><p id="468d" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">我将这个部署脚本放在我的<code class="fe ni nj nk nl b">/home</code>目录中。我确保它有足够的权限来执行。如果你在执行这个文件时收到一个错误，使用<code class="fe ni nj nk nl b">chmod</code>给它权限。<br/>我的web应用程序位于<code class="fe ni nj nk nl b">/home/portfolio-website </code>目录中。</p><p id="beea" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">这个脚本只是一组shell命令，您应该非常熟悉。<br/>我们进入<em class="js">/首页/作品集-网站</em>目录。我们从主分支提取。然后我们使用<a class="ae kp" href="https://www.npmjs.com/package/pm2" rel="noopener ugc nofollow" target="_blank"> <strong class="jt ir"> pm2 </strong> </a>模块在后台运行一个守护进程来运行我们的节点服务器。如果你使用node那么你一定熟悉<a class="ae kp" href="https://www.npmjs.com/package/pm2" rel="noopener ugc nofollow" target="_blank"> <strong class="jt ir"> pm2 </strong> </a>。如果没有，那么就使用您用来启动服务器的命令。</p><p id="0c91" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">现在我们需要从我们的web应用程序代码中调用这个脚本。在NodeJs中有一个叫做<a class="ae kp" href="https://nodejs.org/api/child_process.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jt ir">的子进程</strong> </a>。您的节点代码可以旋转虚拟终端窗口，然后在其中运行命令。当然，这是一种简化的思考方式。实际上，子进程提供了很多特性。如果你想了解更多关于子进程的信息，请阅读这篇文章。如果您现在只想运行一些命令，那么请继续阅读。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi nn"><img src="../Images/610800c8d0be704f87bc61be9c4be1e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zYX3Vv-tWanZwRc5iHa_JA.jpeg"/></div></div></figure><figure class="ku kv kw kx gt ky"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="a411" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">所以这里我们首先检查发送方和分支。如果推送的发送者确实是<em class="js"> Donald </em>(这里使用您的Github用户名)，并且如果分支是Master，那么运行<code class="fe ni nj nk nl b">deploy()</code>函数。<br/><code class="fe ni nj nk nl b">deploy()</code>函数启动一个子进程并执行一个命令。该命令转到<code class="fe ni nj nk nl b">/home</code>目录并执行部署脚本。在执行时，如果我收到某种错误，我会发送一个500。否则我发200。</p><p id="c8d4" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">现在，每当您对repo的主分支进行提交时，您将运行部署脚本，该脚本将依次在您的服务器上提取主分支并重启web应用程序。<br/>所以从现在开始，如果你想在你的网站上有所改变，你所要做的就是推送到主分支。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div class="gh gi no"><img src="../Images/7d7f14e85d7c9bbdca1c781f1374f94f.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/1*RkSSc_uY7CQDchk-TP10rA.gif"/></div></figure><p id="982b" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">就是这样。很酷吧？您可以根据自己的需求轻松扩展这一功能。执行shell命令时不再有SSH和错误。干杯！</p></div></div>    
</body>
</html>