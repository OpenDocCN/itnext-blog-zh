<html>
<head>
<title>How not to despair while setting up Puppeteer and Jest on a create-react-app (plus CI on Travis)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在创建-反应-应用程序上设置木偶和笑话时不绝望</h1>
<blockquote>原文：<a href="https://itnext.io/how-not-to-despair-while-setting-up-puppeteer-and-jest-on-a-create-react-app-plus-ci-on-travis-b25f387ee00f?source=collection_archive---------3-----------------------#2018-08-21">https://itnext.io/how-not-to-despair-while-setting-up-puppeteer-and-jest-on-a-create-react-app-plus-ci-on-travis-b25f387ee00f?source=collection_archive---------3-----------------------#2018-08-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="dc2a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">似乎我没有一篇文章是以悲伤的故事开始的。下面是今天的悲惨故事:设置我的create-react-app进行端到端测试。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/3b225d6ffaf20c6d3f57334233a2a0d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cA8YV3_fM2w79l0e0pvIKg.jpeg"/></div></div></figure><h1 id="5bf7" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">背景</h1><p id="f376" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">我们的生态系统中有许多React客户端，但其中只有一个面向公众(除了登录屏幕):一个应用程序表单。现在，我们希望将其他一些东西公开，因此我们需要制作一系列其他应用程序(令人讨厌),或者清理应用程序，使其成为面向公众的内容的一个家园。</p><p id="268a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但阻碍我们的是，这份申请表首先是我写的，因为我学会了反应，然后是我们的新员工写的，因为她学会了反应。也就是说，代码是一个该死的噩梦，而且完全没有经过测试。</p><p id="044a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以，第一步:建立测试框架，这样我们就可以像这个人一样进行一千次测试。第二步是重构，但那是另一天的悲惨故事。</p><h1 id="5d90" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">设置</h1><p id="a580" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">首先要做的是:依赖性。你需要<code class="fe mb mc md me b">puppeteer</code> : <code class="fe mb mc md me b">yarn add -dev puppeteer</code>。Create-react-app(从现在开始我只说CRA)预装了jest的东西，所以不要安装，即使教程这么说。</p><p id="e2a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在设置您的测试在<code class="fe mb mc md me b">package.json</code>中作为脚本运行，除非它们已经存在(我的曾经存在)。你在找这条线:</p><pre class="km kn ko kp gt mf me mg mh aw mi bi"><span id="582a" class="mj ky iq me b gy mk ml l mm mn">"test": "react-scripts test --env=jsdom",</span></pre><p id="136e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我在网上到处寻找合适的东西放在这里。坚持你已经拥有的。</p><h2 id="2186" class="mj ky iq bd kz mo mp dn ld mq mr dp lh jy ms mt ll kc mu mv lp kg mw mx lt my bi translated">港口</h2><p id="4793" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">我们有很多应用程序，所以它们都需要在不同的端口上运行。我的配置将我们的端口设置为3030，因此我们在<code class="fe mb mc md me b">scripts</code>中有这样一行:</p><pre class="km kn ko kp gt mf me mg mh aw mi bi"><span id="caac" class="mj ky iq me b gy mk ml l mm mn">"start": "PORT=3030 react-scripts start",</span></pre><p id="1311" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我不敢相信这就是所有需要的设置，但它是。</p><h1 id="affd" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">编写第一个测试</h1><p id="7571" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">是的，标准的“不崩溃地渲染应用程序”测试对我来说失败了。我不知道为什么，如果你不知道，这是一个令人沮丧的过程。这对我来说已经足够好了，可以运行一个测试来加载应用程序。这是代码。在<code class="fe mb mc md me b">App.test.js</code>:</p><pre class="km kn ko kp gt mf me mg mh aw mi bi"><span id="6262" class="mj ky iq me b gy mk ml l mm mn">import React from 'react';<br/>import puppeteer from 'puppeteer';<br/><br/>describe('renders without crashing', () =&gt; {<br/>  test(<br/>    'we view the welcome h1 header',<br/>    async () =&gt; {<br/>      let browser = await puppeteer.<em class="ma">launch</em>({<br/>        headless: true,<br/>      });<br/>      let page = await browser.newPage();<br/><br/>      await page.goto('http://localhost:3030');<br/>      await page.waitForSelector('.welcome-message');<br/><br/>      const header = await page.$eval('h1', e =&gt; e.innerHTML);<br/>      expect(header).toEqual('Awesome that you want to apply!');<br/><br/>      browser.close();<br/>    },<br/>    16000<br/>  );<br/>});</span></pre><p id="a217" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这真的很贴心。我们可以使用所有这些<code class="fe mb mc md me b">async / await</code>函数，这样我们就可以等待无头浏览器来定位页面中我们关心的点。在这一点上，我只是测试我们的头已经加载了一个欢迎我们的申请人的消息。</p><p id="3f06" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">(顺便说一下，将<code class="fe mb mc md me b">headless</code>切换到<code class="fe mb mc md me b">false</code>，浏览器将实际打开，这样您就可以看到您的测试正在运行。)</p><p id="cf48" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你也可以设置浏览器的大小，但这不是必须的。你可以在这里查看<a class="ae mz" href="https://github.com/yomete/react-puppeteer" rel="noopener ugc nofollow" target="_blank">木偶师文档。</a></p><p id="a41c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在开始吧。如果你和我一样，你已经运行了你的本地服务器，并且测试通过了，你非常高兴！是时候开始编写大量的测试了。</p><h1 id="8da6" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">和特拉维斯一起安排线人</h1><p id="1abd" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">别急，我的朋友们。事实证明，本地服务器对于运行无头浏览器至关重要，这是我在Travis上用<code class="fe mb mc md me b">net::ERR_CONNECTION_REFUSED at http://localhost</code>观察一个又一个构建失败时发现的。这是我最后的<code class="fe mb mc md me b">.travis.yml</code>配置:</p><pre class="km kn ko kp gt mf me mg mh aw mi bi"><span id="b169" class="mj ky iq me b gy mk ml l mm mn">language: node_js<br/>node_js:<br/>  - "9"<br/>dist: trusty<br/>sudo: required<br/>addons:<br/>  chrome: stable<br/>  hostname: localhost<br/>before_install:<br/>  - google-chrome-stable --headless --disable-gpu --remote-debugging-port=9222 http://localhost &amp;<br/>before_script:<br/>  - yarn start &amp;<br/>cache:<br/>  yarn: true<br/>  directories:<br/>    - node_modules<br/>install:<br/>  - yarn install<br/>script:<br/>  - yarn test</span></pre><p id="6949" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">需要的两件事不会立即突出:<code class="fe mb mc md me b">sudo: required</code>否则您会得到其他一些奇怪的错误。还有那个<code class="fe mb mc md me b">before_script</code>钩子。我向上帝发誓，我没有在网上看到任何人告诉我必须这么做。我意识到的唯一原因是因为我关闭了我的本地服务器，在本地得到了同样的错误。“等一下……”我说。我还了解到命令末尾的<code class="fe mb mc md me b">&amp;</code>意味着在后台运行它们。</p><p id="c307" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我的本地服务器正在Travis中愉快地运行，只是等待一些测试的到来，并好好利用它。</p><h1 id="03a4" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">参考</h1><p id="d05c" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated"><a class="ae mz" href="https://blog.logrocket.com/end-to-end-testing-react-apps-with-puppeteer-and-jest-ce2f414b4fd7" rel="noopener ugc nofollow" target="_blank">这个教程</a>，很抱歉的说是一个好的开始但是已经过时了，因为这篇文章毫无疑问基本上马上就会。</p></div></div>    
</body>
</html>