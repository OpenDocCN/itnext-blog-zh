<html>
<head>
<title>How-to: Kubernetes Application Deployment with DNS management</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">How-to:使用DNS管理部署Kubernetes应用程序</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-kubernetes-application-deployment-with-dns-management-ddf63b559b67?source=collection_archive---------5-----------------------#2019-09-27">https://itnext.io/how-to-kubernetes-application-deployment-with-dns-management-ddf63b559b67?source=collection_archive---------5-----------------------#2019-09-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="7d55" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当涉及到GitOps的工作时，在配置时要注意许多警告和各种障碍，其中之一就是DNS的麻烦。我已经拖了很久才得到这个https://github.com/kubernetes-incubator/external-dns<a class="ae kl" href="https://github.com/kubernetes-incubator/external-dns" rel="noopener ugc nofollow" target="_blank">外部DNS</a>的运行演示，唉，现在它终于来了。</p><p id="7f7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它是如此的直截了当。</p><p id="a901" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">外部DNS承担所有的管理工作，将<strong class="jp ir"> FQDN </strong>映射到服务和入口。尽管Kubernetes服务的DNS管理将需要一个公共IP地址，提供一个<code class="fe km kn ko kp b">loadBalancer</code>类型。这简化了DNS管理—随着您的K8服务的部署和删除，自动添加和删除记录。您可能不希望将K8服务与“external IP”DNS映射一起使用，因为这将导致此类服务的IP供应成本。因此，我建议重用入口，主机路径路由，因为你会发现更合适。</p><p id="0c3d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于大多数基础架构环境设计来说，这在很大程度上是<code class="fe km kn ko kp b">development</code>环境，也许<code class="fe km kn ko kp b">Staging</code>环境可以从版本控制和自动化的基础架构即代码供应流程中受益。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi kq"><img src="../Images/bebd142930fe47920d623a1459b94fbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4F_itrFj8AS6joG1starYA.png"/></div></div></figure><p id="bf99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们来评估我们正在解决的问题— <strong class="jp ir">解决我们的应用</strong>的动态DNS映射配置需求。这可能是开发团队在部署和测试新的应用程序特性时所需要的。这在<em class="lc"> #GitOps </em>环境中味道更好——在这里，您的Git Repo是所有自动供应的<code class="fe km kn ko kp b">"source of truth"</code>。这与<strong class="jp ir">Weaveworks Flux</strong>(<a class="ae kl" href="https://github.com/fluxcd/flux" rel="noopener ugc nofollow" target="_blank">https://github.com/fluxcd/flux</a>)相结合，可以自动应用你的Kubernetes YAML货单，为发布过程提供了很大程度的<strong class="jp ir"> CD* </strong>。</p><p id="3b40" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望“解释它，就像对一个10岁的“”——用一个相当直接的演示。呃……</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi ld"><img src="../Images/cfc1c5ddd14e2135db7270228bffec6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nySFxPioCWFZRg_SmzqJSg.png"/></div></div><figcaption class="le lf gj gh gi lg lh bd b be z dk translated">你会想，wowzers，对吧？别担心，其实也没那么糟:)</figcaption></figure><p id="7585" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望你们这些亲身实践的读者能够复制这一成功，前提是你们确实在谷歌云DNS服务中映射和配置了自己的DNS。如果是这样，尽一切办法，复制粘贴你心中的内容，并喜欢分享这些虚拟的<em class="lc">啤酒荣誉</em>。</p><h1 id="4e6e" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">您的系统要求</h1><p id="d19e" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">这可能是显而易见的，但是您将需要在运行它的系统上安装<code class="fe km kn ko kp b">git</code>、<code class="fe km kn ko kp b">google-cloud-sdk</code>和<code class="fe km kn ko kp b">kubectl</code></p><p id="a373" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">已经尝试过了，现在设置这个。它相当简单，在服务供应方面有一些预期的K8和GCP延迟。当你自己进行复制粘贴测试时，请记住这一点。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi ml"><img src="../Images/ac4a0baac64e732e2a07d386761ae0a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y74B4edR4X6vtbck83AZ9g.png"/></div></div><figcaption class="le lf gj gh gi lg lh bd b be z dk translated">展示一下YAML的魔力吧！</figcaption></figure><h1 id="4210" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">飞行前计划和健全性检查</h1><p id="b9d2" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">我希望你有一个由谷歌云DNS管理的DNS名称，并在你复制的项目中启用云DNS API。此外，我们将首先设置DNS区域管理，然后继续全新的集群设置。详情请关注进度。</p><ul class=""><li id="c08c" class="mm mn iq jp b jq jr ju jv jy mo kc mp kg mq kk mr ms mt mu bi translated">我的测试域区域是<code class="fe km kn ko kp b">jpworks.squadzero.io</code></li><li id="0791" class="mm mn iq jp b jq mv ju mw jy mx kc my kg mz kk mr ms mt mu bi translated">确保正确的NS服务器映射到<code class="fe km kn ko kp b">jpworks.squadzero.io</code>区域的google Cloud DNS区域。</li></ul><h1 id="b1a1" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">该过程</h1><p id="ae24" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">然而，这是一个工作演示，基于我的GCP项目名和我的域区域。您的设置会有所不同，因此请确保更新全局变量以及外部DNS部署参数列表。</p><h1 id="4423" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">设置全局VAR</h1><pre class="kr ks kt ku gt na kp nb nc aw nd bi"><span id="ffcb" class="ne lj iq kp b gy nf ng l nh ni">## This global will be used throughout the copy-paste scripts<br/>## CHANGE THIS as required<br/>PROJECT=jaroslav-pantsjoha-contino <br/>CLUSTER_NAME=jpworks-cluster</span></pre><h1 id="249d" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">DNS区域</h1><p id="4a5b" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">如果您还没有手动设置它，您可以通过编程方式创建一个我们希望外部DNS管理的区域，这对于让多个集群环境管理自己的独立区域来说是一个明显的好处。</p><pre class="kr ks kt ku gt na kp nb nc aw nd bi"><span id="32a0" class="ne lj iq kp b gy nf ng l nh ni">cloud dns managed-zones create "jpworks-demo-squadzero-io"  \<br/>   --dns-name "jpworks.squadzero.io."  \<br/>   --description "Automatically managed zone by kubernetes.io/external-dns"</span><span id="528f" class="ne lj iq kp b gy nj ng l nh ni">Created [https://dns.googleapis.com/dns/v1/projects/jaroslav-pantsjoha-contino/managedZones/jpworks-demo-squadzero-io].</span></pre><h2 id="48ea" class="ne lj iq bd lk nk nl dn lo nm nn dp ls jy no np lw kc nq nr ma kg ns nt me nu bi translated">DNS注册商更新</h2><p id="f6f9" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">用您的<strong class="jp ir">注册器</strong>更新NS记录，如果可能的话，更早地放弃TTL，或者只是等待通常的24小时，直到记录更新传播。</p><p id="1312" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">再次检查，查看它们是否被正确传播并反映在<code class="fe km kn ko kp b">dig</code>查询中。</p><pre class="kr ks kt ku gt na kp nb nc aw nd bi"><span id="d2db" class="ne lj iq kp b gy nf ng l nh ni">dig NS jpworks.squadzero.io<br/>...<br/>;; ANSWER SECTION:<br/>jpworks.squadzero.io.	21600	IN	NS	ns-cloud-c1.googledomains.com.<br/>jpworks.squadzero.io.	21600	IN	NS	ns-cloud-c2.googledomains.com.<br/>jpworks.squadzero.io.	21600	IN	NS	ns-cloud-c3.googledomains.com.<br/>jpworks.squadzero.io.	21600	IN	NS	ns-cloud-c4.googledomains.com.<br/>...</span></pre><h2 id="3fa4" class="ne lj iq bd lk nk nl dn lo nm nn dp ls jy no np lw kc nq nr ma kg ns nt me nu bi translated">DNS —附加区域和验证</h2><p id="b932" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">默认视图应该包含大约2条记录</p><pre class="kr ks kt ku gt na kp nb nc aw nd bi"><span id="32fd" class="ne lj iq kp b gy nf ng l nh ni">jp$ gcloud dns record-sets list --zone "jpworks-demo-squadzero-io" <br/>NAME                        TYPE  TTL    DATA<br/>jpworks.squadzero.io.       NS    21600  ns-cloud-c1.googledomains.com.,ns-cloud-c2.googledomains.com.,ns-cloud-c3.googledomains.com.,ns-cloud-c4.googledomains.com.<br/>jpworks.squadzero.io.       SOA   21600  ns-cloud-c1.googledomains.com. cloud-dns-hostmaster.google.com. 1 21600 3600 259200 300</span></pre><p id="00c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> Subzone Side Note </strong>:如果您在主zone中有一个<strong class="jp ir">子zone </strong>，您也需要告诉根zone在哪里可以找到这些记录。</p><p id="eba0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过在父区域添加相应的DNS记录，告诉父区域在哪里可以找到该区域的DNS记录。假设新的区域是<code class="fe km kn ko kp b">demo.jpworks.squadzero.io</code>,域名是<code class="fe km kn ko kp b">jpworks.squadzero.io</code>,并且它也托管在Google上，我们将做以下事情；</p><pre class="kr ks kt ku gt na kp nb nc aw nd bi"><span id="2169" class="ne lj iq kp b gy nf ng l nh ni">$ gcloud dns record-sets transaction start --zone "$PROJECT"<br/>$ gcloud dns record-sets transaction add ns-cloud-e{1..4}.googledomains.com. \<br/>    --name "jpworks.squadzero.io." --ttl 300 --type NS --zone $PROJECT"<br/>$ gcloud dns record-sets transaction execute --zone "$PROJECT"</span></pre><h1 id="bb76" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">演示集群设置</h1><p id="1119" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">创建默认集群-演示集群。请注意您的潜在当前群集节点池附带的范围权限—需要CloudDNS RW —如果您没有，您将被迫创建一个新的节点池。祝你好运。</p><p id="1557" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，为了演示的简单，我允许所有的权限范围，但是您应该根据您的需要将权限减少到“最低特权要求”。</p><p id="0ab4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe km kn ko kp b">A basic, default spec 2 node cluster with preemptible nodes</code></p><pre class="kr ks kt ku gt na kp nb nc aw nd bi"><span id="970d" class="ne lj iq kp b gy nf ng l nh ni">gcloud beta container --project "$PROJECT" clusters create "$CLUSTER_NAME" \<br/>--zone "us-central1-a" --no-enable-basic-auth \<br/>--cluster-version "<!-- -->1.14.6-gke.2<!-- -->" --machine-type "n1-standard-2" \<br/>--image-type "COS" --disk-type "pd-ssd" --disk-size "50" \<br/>--metadata disable-legacy-endpoints=true \<br/>--scopes "https://www.googleapis.com/auth/cloud-platform" \<br/>--preemptible --num-nodes "2" \<br/>--enable-cloud-logging \<br/>--enable-stackdriver-kubernetes --enable-ip-alias \<br/>--network "projects/$PROJECT/global/networks/default" \<br/>--subnetwork "projects/$PROJECT/regions/us-central1/subnetworks/default" \<br/>--default-max-pods-per-node "110" --addons HorizontalPodAutoscaling,HttpLoadBalancing \<br/>--enable-autoupgrade \<br/>--enable-autorepair</span></pre><p id="05fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">示例创建的集群</p><pre class="kr ks kt ku gt na kp nb nc aw nd bi"><span id="67d2" class="ne lj iq kp b gy nf ng l nh ni">Creating cluster jpworks-cluster in us-central1-a... Cluster is being deployed...⠼</span><span id="b1df" class="ne lj iq kp b gy nj ng l nh ni">kubeconfig entry generated for jpworks-cluster.<br/>NAME             LOCATION       MASTER_VERSION  MASTER_IP      MACHINE_TYPE   NODE_VERSION  NUM_NODES  STATUS<br/>jpworks-cluster  us-central1-a  1.13.7-gke.8    34.70.157.163  n1-standard-2  1.13.7-gke.8  2          RUNNING</span></pre><h2 id="8272" class="ne lj iq bd lk nk nl dn lo nm nn dp ls jy no np lw kc nq nr ma kg ns nt me nu bi translated">连接到群集</h2><p id="6ae8" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">配置本地环境以使用正确的项目，并获取用于登录的群集凭据。</p><pre class="kr ks kt ku gt na kp nb nc aw nd bi"><span id="edf1" class="ne lj iq kp b gy nf ng l nh ni">gcloud config set project $PROJECT<br/>gcloud container clusters get-credentials $CLUSTER_NAME --zone us-central1-a --project $PROJECT</span></pre><h1 id="7736" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">准备部署应用程序</h1><p id="a0c0" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">开始:下面的完整演示YAML应该是你所需要的。</p><p id="3da6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个文件夹，将所有这些YAML清单复制粘贴到该文件夹中。然后恰当地<code class="fe km kn ko kp b">kubectl apply -f .</code></p><p id="d795" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，组件；</p><h2 id="25c0" class="ne lj iq bd lk nk nl dn lo nm nn dp ls jy no np lw kc nq nr ma kg ns nt me nu bi translated">进入</h2><p id="f7be" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">重要的一点——这是入口<code class="fe km kn ko kp b">host</code>记录将被<code class="fe km kn ko kp b">external-DNS</code>应用获取的地方。这将尝试执行A记录映射到分配给该入口(在GCP上)的所提供的IP。</p><pre class="kr ks kt ku gt na kp nb nc aw nd bi"><span id="5536" class="ne lj iq kp b gy nf ng l nh ni">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: nginx-ingress-default<br/>  annotations:<br/>    nginx.ingress.kubernetes.io/rewrite-target: /<br/>spec:<br/>  rules:<br/>  - host: nginx.jpworks.squadzero.io<br/>    http:<br/>      paths:<br/>      - backend:<br/>          serviceName: nginx-service<br/>          servicePort: 80</span></pre><h2 id="ddf8" class="ne lj iq bd lk nk nl dn lo nm nn dp ls jy no np lw kc nq nr ma kg ns nt me nu bi translated">Nginx演示应用部署+服务</h2><pre class="kr ks kt ku gt na kp nb nc aw nd bi"><span id="cc20" class="ne lj iq kp b gy nf ng l nh ni">apiVersion: extensions/v1beta1<br/>kind: Deployment<br/>metadata:<br/>  labels:<br/>    run: nginx-app<br/>  name: nginx-app<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      run: nginx-app<br/>  template:<br/>    metadata:<br/>      labels:<br/>        run: nginx-app<br/>    spec:<br/>      containers:<br/>        - name: nginx<br/>          image: nginx:1.15.7-perl<br/>          lifecycle:<br/>            postStart:<br/>              exec:<br/>                command:<br/>                  - "sh"<br/>                  - "-c"<br/>                  - &gt;<br/>                    mkdir -p /usr/share/nginx/html/ &amp;&amp; echo '&lt;h1&gt;hello world&lt;/h1&gt;&lt;p&gt;flux-kubernetes-demos/nginx&lt;/p&gt;' &gt; /usr/share/nginx/html/index.html;<br/>          ports:<br/>          - containerPort: 80</span><span id="c324" class="ne lj iq kp b gy nj ng l nh ni">---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  labels:<br/>    run: nginx-app<br/>  name: nginx-service<br/>  annotations:<br/>    cloud.google.com/load-balancer-type: "Internal"<br/>    external-dns.alpha.kubernetes.io/hostname: 'nginx-svc.jpworks.squadzero.io'<br/>spec:<br/>  type: LoadBalancer<br/>  ports:<br/>  - port: 80<br/>  selector:<br/>    run: nginx-app</span></pre><p id="5802" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">服务组件就是一个例子——需要<code class="fe km kn ko kp b">annotation</code>,但允许您考虑相同的DNS管理。我特意用“<strong class="jp ir"> type=loadbalancer </strong>”而不是<code class="fe km kn ko kp b">internal</code> loadbalancer子类型来维护服务，所以没有<code class="fe km kn ko kp b">externalIP</code>开销。</p><h2 id="9d48" class="ne lj iq bd lk nk nl dn lo nm nn dp ls jy no np lw kc nq nr ma kg ns nt me nu bi translated">外部-DNS部署+ rbac +服务帐户</h2><p id="b62f" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">这个演示的最后一个关键部分。</p><pre class="kr ks kt ku gt na kp nb nc aw nd bi"><span id="910c" class="ne lj iq kp b gy nf ng l nh ni">apiVersion: extensions/v1beta1<br/>kind: Deployment<br/>metadata:<br/>  name: external-dns<br/>spec:<br/>  strategy:<br/>    type: Recreate<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: external-dns<br/>    spec:<br/>      serviceAccountName: external-dns<br/>      containers:<br/>      - name: external-dns<br/>        image: registry.opensource.zalan.do/teapot/external-dns:latest<br/>        args:<br/>        - --source=service<br/>        - --source=ingress<br/>        - --domain-filter=jpworks.squadzero.io # will make ExternalDNS see only the hosted zones matching provided domain, omit to process all available hosted zones<br/>        - --provider=google<br/>        - --google-project=jaroslav-pantsjoha-contino # Use this to specify a project different from the one external-dns is running inside<br/>        # - --policy=upsert-only # would prevent ExternalDNS from deleting any records, omit to enable full synchronization<br/>        - --registry=txt<br/>        - --txt-owner-id=my-jpworks-demo-domain</span><span id="2f53" class="ne lj iq kp b gy nj ng l nh ni">apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: external-dns<br/>---<br/>apiVersion: rbac.authorization.k8s.io/v1beta1<br/>kind: ClusterRole<br/>metadata:<br/>  name: external-dns<br/>rules:<br/>- apiGroups: [""]<br/>  resources: ["services"]<br/>  verbs: ["get","watch","list"]<br/>- apiGroups: [""]<br/>  resources: ["pods"]<br/>  verbs: ["get","watch","list"]<br/>- apiGroups: ["extensions"]<br/>  resources: ["ingresses"]<br/>  verbs: ["get","watch","list"]<br/>- apiGroups: [""]<br/>  resources: ["nodes"]<br/>  verbs: ["list"]<br/>---<br/>apiVersion: rbac.authorization.k8s.io/v1beta1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  name: external-dns-viewer<br/>roleRef:<br/>  apiGroup: rbac.authorization.k8s.io<br/>  kind: ClusterRole<br/>  name: external-dns<br/>subjects:<br/>- kind: ServiceAccount<br/>  name: external-dns<br/>  namespace: default<br/>---</span></pre><p id="723e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在下面的代码片段中，再次展示了<code class="fe km kn ko kp b">external-DNS</code>部署值得注意的特性。</p><p id="4ae1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">您的待办事项</strong>:您至少需要<strong class="jp ir">指定</strong>您自己的<strong class="jp ir">域区域</strong>和<strong class="jp ir">项目名称</strong>。</p><pre class="kr ks kt ku gt na kp nb nc aw nd bi"><span id="d9b0" class="ne lj iq kp b gy nf ng l nh ni">args:<br/>        - --source=service # explicitly select your sources<br/>        - --source=ingress</span><span id="2d5d" class="ne lj iq kp b gy nj ng l nh ni">        - --domain-filter=jpworks.squadzero.io # will make ExternalDNS see only the hosted zones matching provided domain, omit to process all available hosted zones</span><span id="5b12" class="ne lj iq kp b gy nj ng l nh ni">        - --provider=google # can be aws,azure and many others</span><span id="c5e1" class="ne lj iq kp b gy nj ng l nh ni">        - --google-project=jaroslav-pantsjoha-contino # Use this to specify a project different from the one external-dns is running inside<br/>        - --policy=upsert-only # would prevent ExternalDNS from deleting any records, omit to enable full synchronization</span><span id="c2e0" class="ne lj iq kp b gy nj ng l nh ni">        - --registry=txt<br/>        - --txt-owner-id=my-jpworks-demo-domain</span></pre><h2 id="017d" class="ne lj iq bd lk nk nl dn lo nm nn dp ls jy no np lw kc nq nr ma kg ns nt me nu bi translated">让我们开始吧！</h2><p id="f04e" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated"><code class="fe km kn ko kp b">jp$ kubectl apply -f .</code></p><p id="2f33" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">更好的是，如果你采用<strong class="jp ir"> #GitOps CICD发布-部署方法论</strong>，你可以让<a class="ae kl" href="https://github.com/fluxcd/flux" rel="noopener ugc nofollow" target="_blank"> weaveworks flux </a>这样的<strong class="jp ir">自动</strong> - <strong class="jp ir">发布</strong>。</p><p id="ca1c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想了解更多，请联系我们！</p><p id="3b4f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">回到演示，让我们看看前面提到的在群集上“全部应用”的结果。</p><pre class="kr ks kt ku gt na kp nb nc aw nd bi"><span id="cb00" class="ne lj iq kp b gy nf ng l nh ni">jp$ kubectl apply -f .<br/>configmap/nginx-configuration configured<br/>deployment.extensions/nginx-app configured<br/>service/nginx-service configured<br/>deployment.extensions/external-dns configured<br/>serviceaccount/external-dns configured<br/>clusterrole.rbac.authorization.k8s.io/external-dns configured<br/>clusterrolebinding.rbac.authorization.k8s.io/external-dns-viewer configured</span></pre><h1 id="041f" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">现在怎么办</h1><p id="b042" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated"><code class="fe km kn ko kp b">external-dns</code>演示的完全成功展示大约需要3-5分钟，主要是因为GCP控制面板上的入口IP设置需要一些时间。服务和入口完全配置后，您可以在上观看演示；</p><p id="8307" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">同时，您可以通过以下方式监控部署进度:</p><pre class="kr ks kt ku gt na kp nb nc aw nd bi"><span id="1d2f" class="ne lj iq kp b gy nf ng l nh ni">kubectl get po -w</span></pre><p id="a3bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后是服务和入口</p><pre class="kr ks kt ku gt na kp nb nc aw nd bi"><span id="0448" class="ne lj iq kp b gy nf ng l nh ni">kubectl get svc,ing</span></pre><p id="8f4a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您应该在服务和入口的<code class="fe km kn ko kp b">External IP</code>上查看IP地址。</p><p id="cb1c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">例如:</strong></p><pre class="kr ks kt ku gt na kp nb nc aw nd bi"><span id="e8bd" class="ne lj iq kp b gy nf ng l nh ni">kubectl get svc,ing<br/>NAME                    TYPE           CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE<br/>service/kubernetes      ClusterIP      10.0.0.1     &lt;none&gt;        443/TCP        28m<br/>service/memcached       ClusterIP      None         &lt;none&gt;        11211/TCP      6m49s<br/>service/nginx-service   LoadBalancer   10.0.1.243   10.128.0.16   80:30903/TCP   26m</span><span id="a2c2" class="ne lj iq kp b gy nj ng l nh ni">NAME                                       HOSTS                        ADDRESS        PORTS   AGE<br/>ingress.extensions/nginx-ingress-default   nginx.jpworks.squadzero.io   34.96.92.237   80      26m</span></pre><p id="6862" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们确认一下<code class="fe km kn ko kp b">external-DNS</code>是否也按预期工作。</p><pre class="kr ks kt ku gt na kp nb nc aw nd bi"><span id="dca1" class="ne lj iq kp b gy nf ng l nh ni">time="2019-09-27T10:06:40Z" level=info msg="Change zone: jpworks-demo-squadzero-io"</span><span id="155e" class="ne lj iq kp b gy nj ng l nh ni">time="2019-09-27T10:06:40Z" level=info msg="Add records: nginx.jpworks.squadzero.io. A [<!-- -->34.96.92.237<!-- -->] 300"</span><span id="db5e" class="ne lj iq kp b gy nj ng l nh ni">time="2019-09-27T10:06:40Z" level=info msg="Add records: nginx.jpworks.squadzero.io. TXT [\"heritage=external-dns,external-dns/owner=my-jpworks-demo-domain,external-dns/resource=ingress/default/nginx-ingress-default\"] 300"</span><span id="f257" class="ne lj iq kp b gy nj ng l nh ni">time="2019-09-27T10:07:40Z" level=info msg="Change zone: jpworks-demo-squadzero-io"</span><span id="8992" class="ne lj iq kp b gy nj ng l nh ni">time="2019-09-27T10:07:40Z" level=info msg="Add records: nginx-svc.jpworks.squadzero.io. A [<!-- -->10.128.0.16<!-- -->] 300"</span><span id="a465" class="ne lj iq kp b gy nj ng l nh ni">time="2019-09-27T10:07:40Z" level=info msg="Add records: nginx-svc.jpworks.squadzero.io. TXT [\"heritage=external-dns,external-dns/owner=my-jpworks-demo-domain,external-dns/resource=service/default/nginx-service\"] 300"</span></pre><p id="91ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们也确认一下域zone是否得到了所有相关的更新，就像<code class="fe km kn ko kp b">external-dns</code>所说的那样。</p><pre class="kr ks kt ku gt na kp nb nc aw nd bi"><span id="9e98" class="ne lj iq kp b gy nf ng l nh ni">gcloud dns record-sets list     --zone "jpworks-demo-squadzero-io"<br/></span><span id="faa7" class="ne lj iq kp b gy nj ng l nh ni">NAME                             TYPE  TTL    DATA</span><span id="e7d5" class="ne lj iq kp b gy nj ng l nh ni">jpworks.squadzero.io.            NS    21600  ns-cloud-c1.googledomains.com.,ns-cloud-c2.googledomains.com.,ns-cloud-c3.googledomains.com.,ns-cloud-c4.googledomains.com.</span><span id="7d97" class="ne lj iq kp b gy nj ng l nh ni">jpworks.squadzero.io.            SOA   21600  ns-cloud-c1.googledomains.com. cloud-dns-hostmaster.google.com. 1 21600 3600 259200 300</span><span id="6b6f" class="ne lj iq kp b gy nj ng l nh ni">nginx.jpworks.squadzero.io.      A     300    34.96.92.237</span><span id="c121" class="ne lj iq kp b gy nj ng l nh ni">nginx.jpworks.squadzero.io.      TXT   300    "heritage=external-dns,external-dns/owner=my-jpworks-demo-domain,external-dns/resource=ingress/default/nginx-ingress-default"</span><span id="82bc" class="ne lj iq kp b gy nj ng l nh ni">nginx-svc.jpworks.squadzero.io.  A     300    10.128.0.16</span><span id="2ac8" class="ne lj iq kp b gy nj ng l nh ni">nginx-svc.jpworks.squadzero.io.  TXT   300    "heritage=external-dns,external-dns/owner=my-jpworks-demo-domain,external-dns/resource=service/default/nginx-service"</span></pre><h1 id="f150" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">看起来不错，但是可以访问吗？</h1><p id="c093" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">不幸的是，有些出乎意料的是，第一次进行入口设置和完全配置确实需要一段时间。在后台启动了许多进程，如IP请求和预订，以及后端映射、IP转发规则等等。实际上，考虑到这种方法提供了生产级可伸缩架构，这种时间延迟真的没有那么糟糕。</p><p id="e758" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了明确和公平地对待入口供应延迟，如果您确实想将一个“普通的”服务<code class="fe km kn ko kp b">externalIP</code>映射到一个记录，这将立即可用和可访问。</p><p id="8dfa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，外部流量将直接影响您的k8服务，在部署配置的任意数量的pod上负载平衡<code class="fe km kn ko kp b">rr</code>这样的流量。就是这样。没有高级功能或逻辑；没有流量路由分割、WAF或SSL卸载。</p><p id="5fbf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">只需一分钟就可以添加一个记录。</p><p id="5552" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦ingress完全准备就绪，这个nginx应用程序将可以公开访问<code class="fe km kn ko kp b"><a class="ae kl" href="http://nginx.jpworks.squadzero.io" rel="noopener ugc nofollow" target="_blank">http://nginx.jpworks.squadzero.io</a></code></p><pre class="kr ks kt ku gt na kp nb nc aw nd bi"><span id="80b4" class="ne lj iq kp b gy nf ng l nh ni">curl nginx.jpworks.squadzero.io</span><span id="d4a0" class="ne lj iq kp b gy nj ng l nh ni">&lt;h1&gt;hello world&lt;/h1&gt;&lt;p&gt;flux-kubernetes-demos/nginx&lt;/p&gt;</span></pre><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi nv"><img src="../Images/1cfd77ca80c1231c7f366ff1c1f8ab3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2VWlUDa3OaNSvASoRBxlxA.png"/></div></div><figcaption class="le lf gj gh gi lg lh bd b be z dk translated">是的，它就像魔术一样，拉里欣喜若狂！大家拉里·戴快乐！</figcaption></figure><p id="d09c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，Nginx服务A记录也被记录，但那只是<code class="fe km kn ko kp b">internal</code> DNS。通过dig验证基于服务的DNS映射以进行确认。</p><pre class="kr ks kt ku gt na kp nb nc aw nd bi"><span id="de31" class="ne lj iq kp b gy nf ng l nh ni">jp$ dig A <!-- -->nginx-svc.jpworks.squadzero.io<br/>...</span><span id="4def" class="ne lj iq kp b gy nj ng l nh ni">;; ANSWER SECTION:<br/>;nginx-svc.jpworks.squadzero.io.   111 IN  A   10.128.0.16</span></pre><h1 id="7f0c" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">希望你喜欢这个演示</h1><p id="52ed" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">如果你觉得有用，给个赞，分享一下，给点好印象*</p><p id="2eda" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lc">下次见，</em></p><p id="e417" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">雅罗斯拉夫·潘特乔哈</p><h2 id="7592" class="ne lj iq bd lk nk nl dn lo nm nn dp ls jy no np lw kc nq nr ma kg ns nt me nu bi translated">可选:清理</h2><pre class="kr ks kt ku gt na kp nb nc aw nd bi"><span id="200e" class="ne lj iq kp b gy nf ng l nh ni">Nuking cluster. Be careful not to nuke anything else by accident. <em class="lc">“Don’t do anything I would do”</em></span><span id="d60b" class="ne lj iq kp b gy nj ng l nh ni">jp$ gcloud container clusters list<br/>NAME             LOCATION       MASTER_VERSION  MASTER_IP      MACHINE_TYPE   NODE_VERSION  NUM_NODES  STATUS<br/>jpworks-cluster  us-central1-a  1.13.7-gke.8    34.70.157.163  n1-standard-2  1.13.7-gke.8  2          RUNNING<br/></span><span id="e3d7" class="ne lj iq kp b gy nj ng l nh ni">jp$ gcloud container clusters delete jpworks-cluster --zone us-central1-a<br/></span><span id="4958" class="ne lj iq kp b gy nj ng l nh ni">The following clusters will be deleted.</span><span id="137e" class="ne lj iq kp b gy nj ng l nh ni">- [jpworks-cluster] in [us-central1-a]</span><span id="52df" class="ne lj iq kp b gy nj ng l nh ni">Do you want to continue (Y/n)?  y</span><span id="9a2a" class="ne lj iq kp b gy nj ng l nh ni">Deleting cluster jpworks-cluster...⠏</span></pre><p id="9a03" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Contino正在开展一系列激动人心的Kubernetes项目。如果您正在寻找最新最棒的基础架构堆栈，或者正在寻找挑战，请联系我们！我们正在招聘！</p><p id="5071" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在各个层面寻找聪明的人。在Contino，我们自豪地为中型企业和大型企业提供最佳实践云转型项目。</p><p id="1a7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://www.linkedin.com/in/johas/" rel="noopener ugc nofollow" target="_blank"> JP </a></p><h1 id="f4b5" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">顺便说一下，👏🏻*鼓掌*👏🏻如果你喜欢这篇文章，请举手(高达50倍)。它鼓励我继续写作，并帮助其他人找到它:)</h1></div></div>    
</body>
</html>