<html>
<head>
<title>Create an awesome background running Music Player like Amazon Music in Flutter</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">创建一个可怕的背景运行音乐播放器像亚马逊音乐在颤振</h1>
<blockquote>原文：<a href="https://itnext.io/create-an-awesome-background-running-music-player-like-amazon-music-in-flutter-341a59efa936?source=collection_archive---------0-----------------------#2020-06-23">https://itnext.io/create-an-awesome-background-running-music-player-like-amazon-music-in-flutter-341a59efa936?source=collection_archive---------0-----------------------#2020-06-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="2856" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们有时都会在应用程序中播放音频，对吗？</p><p id="c12b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，我们可能还没有创建一个完整的音乐播放器，即使应用程序不在前台运行，它也能运行，对吗？</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/4e208e05b345ac7af9bacc0b6177744e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PN09XAfSqKEobEv1.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">Android中的音乐播放器</figcaption></figure><h1 id="18b5" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">观看视频教程</h1><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="lz ma l"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">Android中的音乐播放器</figcaption></figure><p id="cde4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，在这篇文章中，我们将看到如何轻松地创建这样一个音乐播放器。</p><p id="36e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的要求是</p><ol class=""><li id="6b6a" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mg mh mi mj bi translated"><em class="mk">即使应用程序没有运行，也应连续播放音频</em></li><li id="8df8" class="mb mc iq jp b jq ml ju mm jy mn kc mo kg mp kk mg mh mi mj bi translated"><em class="mk">我应该可以通过锁屏或者耳机来控制音乐。</em></li></ol><p id="0f0d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果应用程序不在前台，正常的音频播放器会停止，对吗？</p><p id="769a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么我们该怎么做才能让它一直运行，直到应用程序被终止。</p><p id="e256" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们有解决办法</p><p id="6ffe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Flutter中，我们有一些方便的库来实现这个功能。</p><p id="ea95" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以让我们开始…</p><p id="e4d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我假设你有一个简单的颤振项目准备好了。</p><p id="014e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果是，那么继续打开'<em class="mk"> pubspec.yaml </em>'文件。</p><h1 id="b9f7" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">添加依赖关系</h1><p id="9f5a" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy ms ka kb kc mt ke kf kg mu ki kj kk ij bi translated">在依赖项部分添加下面的依赖项</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="a710" class="na lc iq mw b gy nb nc l nd ne">http: ^0.12.1<br/>audio_service: ^0.11.0<br/>just_audio: ^0.2.1</span></pre><p id="c5da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行'<strong class="jp ir"><em class="mk">flutter packages get</em></strong>'在终端中安装软件包，如果你的IDE没有自动安装的话。</p><p id="2a90" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里是<a class="ae nf" href="https://pub.dev/packages/audio_service/versions/0.11.0#-readme-tab-" rel="noopener ugc nofollow" target="_blank">插件</a>的链接。</p><p id="5d43" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请确保遵循read me，并在AndroidManifest.xml和info.plist文件中进行适当的更改。</p><p id="a4c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们先创建AudioPlayer类。</p><p id="7b05" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">音频播放器</strong></p><p id="d889" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">AudioPlayer是一个独立的隔离，扩展了<strong class="jp ir"><em class="mk">background audio task</em></strong>。这意味着它将在独立的<em class="mk">线程/隔离</em>中运行，而不是在主隔离中运行。</p><p id="1d5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们从创建一些显示在锁定屏幕上的媒体按钮开始。</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="7d07" class="na lc iq mw b gy nb nc l nd ne">MediaControl playControl = MediaControl(<br/>  androidIcon: 'drawable/ic_action_play_arrow',<br/>  label: 'Play',<br/>  action: MediaAction.play,<br/>);<br/>MediaControl pauseControl = MediaControl(<br/>  androidIcon: 'drawable/ic_action_pause',<br/>  label: 'Pause',<br/>  action: MediaAction.pause,<br/>);<br/>MediaControl skipToNextControl = MediaControl(<br/>  androidIcon: 'drawable/ic_action_skip_next',<br/>  label: 'Next',<br/>  action: MediaAction.skipToNext,<br/>);<br/>MediaControl skipToPreviousControl = MediaControl(<br/>  androidIcon: 'drawable/ic_action_skip_previous',<br/>  label: 'Previous',<br/>  action: MediaAction.skipToPrevious,<br/>);<br/>MediaControl stopControl = MediaControl(<br/>  androidIcon: 'drawable/ic_action_stop',<br/>  label: 'Stop',<br/>  action: MediaAction.stop,<br/>);</span></pre><p id="30d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请确保在您的android项目的drawable文件夹中添加相应的Android图像。</p><p id="7790" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里是完整的音频播放器类代码。</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="e01f" class="na lc iq mw b gy nb nc l nd ne">class AudioPlayerTask extends BackgroundAudioTask {<br/>  //<br/>  var _queue = &lt;MediaItem&gt;[];<br/>  int _queueIndex = -1;<br/>  AudioPlayer _audioPlayer = new AudioPlayer();<br/>  AudioProcessingState _skipState;<br/>  bool _playing;<br/>  bool get hasNext =&gt; _queueIndex + 1 &lt; _queue.length;<br/>  bool get hasPrevious =&gt; _queueIndex &gt; 0;<br/>  MediaItem get mediaItem =&gt; _queue[_queueIndex];<br/>  StreamSubscription&lt;AudioPlaybackState&gt; _playerStateSubscription;<br/>  StreamSubscription&lt;AudioPlaybackEvent&gt; _eventSubscription;</span><span id="d18a" class="na lc iq mw b gy ng nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  void onStart(Map&lt;String, dynamic&gt; params) {<br/>    //<br/>  }</span><span id="807e" class="na lc iq mw b gy ng nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  void onPlay() {<br/>    //<br/>  }</span><span id="d4c5" class="na lc iq mw b gy ng nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  void onPause() {<br/>    //<br/>  }</span><span id="90b8" class="na lc iq mw b gy ng nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  void onSkipToNext() async {<br/>    //<br/>  }</span><span id="3fb2" class="na lc iq mw b gy ng nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  void onSkipToPrevious() {<br/>    //<br/>  }</span><span id="fbe2" class="na lc iq mw b gy ng nc l nd ne">void skip(int offset) async {<br/>    //<br/>  }<br/>  <br/>  <a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  Future&lt;void&gt; onStop() async {<br/>    //<br/>  }</span><span id="e724" class="na lc iq mw b gy ng nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a> <br/>  void onSeekTo(Duration position) {<br/>    //<br/>  }</span><span id="9fa5" class="na lc iq mw b gy ng nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  void onClick(MediaButton button) {<br/>    //<br/>  }</span><span id="8acd" class="na lc iq mw b gy ng nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  Future&lt;void&gt; onFastForward() async {<br/>    //<br/>  }</span><span id="1e6b" class="na lc iq mw b gy ng nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  Future&lt;void&gt; onRewind() async {<br/>    //<br/>  }<br/>  <br/>}</span></pre><p id="7e5c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们看看它能做什么。</p><p id="ff5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我们声明了一个_queue，它实际上是我们将在音频播放器中播放的音频数据或媒体项队列。</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="c883" class="na lc iq mw b gy nb nc l nd ne">_queueIndex - takes care of the index of the item that is playing<br/>_audioPlayer - Plays the audio.<br/>_skipState - state of the audio, like Audio is connecting or ready..<br/>mediaItem - current media item to play.</span></pre><p id="f5a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一件事是在AudioPlayerTask中设置队列。</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="220a" class="na lc iq mw b gy nb nc l nd ne">AudioServiceBackground.setQueue(_queue);</span></pre><p id="54dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当UI调用AudioService.play时，相应的onPlay()被覆盖的函数将被调用，您可以让您的逻辑在那里播放音频。这同样适用于所有其他被重写的方法，如onPause、onSkipToNext等。</p><p id="2155" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，onPlay可能是这样的…</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="08f6" class="na lc iq mw b gy nb nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  void onPlay() {<br/>    if (_skipState == null) {<br/>      _playing = true;<br/>      _audioPlayer.play();<br/>    }<br/>  }</span></pre><p id="2c4c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">同样，您可以为所有其他方法实现。</p><p id="875e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在开始音频服务。</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="40d5" class="na lc iq mw b gy nb nc l nd ne">await AudioService.start(<br/>          backgroundTaskEntrypoint: _audioPlayerTaskEntrypoint,<br/>          androidNotificationChannelName: 'Audio Player',<br/>          androidNotificationColor: 0xFF2196f3,<br/>          androidNotificationIcon: 'mipmap/ic_launcher',<br/>          params: params,<br/>        );</span></pre><p id="e976" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里'<em class="mk">_ audioPlayerTaskEntrypoint</em>'是音频播放器的入口点。</p><p id="2b30" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你注意到这里有一个额外的参数叫做“params”。这是从外部向AudioTask发送数据。确保它是基本数据类型。</p><p id="8622" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您想发送自定义事件，您甚至可以这样做。</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="b1b1" class="na lc iq mw b gy nb nc l nd ne">await AudioService.customEvent('key',&lt;DATA&gt;</span></pre><p id="a914" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果要在AudioPlayer中获取自定义数据，请重写onCustomEvent方法。</p><p id="3701" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您还可以像这样向UI发送自定义事件。</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="8b8a" class="na lc iq mw b gy nb nc l nd ne">AudioServiceBackground.sendCustomEvent('just played');</span></pre><p id="a1c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mk">因此，在AudioService.dtart中，' _ audioPlayerTaskEntrypoint '【T1]应该是一个顶级函数或静态函数，因为它是一个单独的隔离。这是一个简单的函数，看起来像这样。</em></p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="9a86" class="na lc iq mw b gy nb nc l nd ne">void _audioPlayerTaskEntrypoint() async {<br/>  AudioServiceBackground.run(() =&gt; AudioPlayerTask());<br/>}</span></pre><h1 id="0577" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">在用户界面中监听状态变化</h1><p id="73a1" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy ms ka kb kc mt ke kf kg mu ki kj kk ij bi translated">那么我们如何在UI中监听音频播放器的状态变化呢？</p><p id="30e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">AudioPlayer使用<strong class="jp ir">流</strong>向UI发送数据。</p><p id="8130" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">AudioService包公开了一个名为<strong class="jp ir"><em class="mk">audioservicebackground . setstate</em></strong>的方法，向UI发送数据。</p><p id="0713" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，AudioPlayer类中的setState方法可能如下所示。</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="68f1" class="na lc iq mw b gy nb nc l nd ne">Future&lt;void&gt; _setState({<br/>    AudioProcessingState processingState,<br/>    Duration position,<br/>    Duration bufferedPosition,<br/>  }) async {<br/>    print('SetState $processingState');<br/>    if (position == null) {<br/>      position = _audioPlayer.playbackEvent.position;<br/>    }<br/>    await AudioServiceBackground.setState(<br/>      controls: getControls(),<br/>      systemActions: [MediaAction.seekTo],<br/>      processingState:<br/>          processingState ?? AudioServiceBackground.state.processingState,<br/>      playing: _playing,<br/>      position: position,<br/>      bufferedPosition: bufferedPosition ?? position,<br/>      speed: _audioPlayer.speed,<br/>    );<br/>}</span></pre><p id="f222" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了让它出现在UI中以更新我们的显示，我们需要在UI中有一个StreamBuilder。</p><p id="4ee6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">音频播放器输出不同类型的数据，例如</p><blockquote class="nh ni nj"><p id="b94f" class="jn jo mk jp b jq jr js jt ju jv jw jx nk jz ka kb nl kd ke kf nm kh ki kj kk ij bi translated"><em class="iq">媒体项目列表— AudioService.queueStream </em></p><p id="9288" class="jn jo mk jp b jq jr js jt ju jv jw jx nk jz ka kb nl kd ke kf nm kh ki kj kk ij bi translated"><em class="iq">当前播放的媒体项—audioservice . currentmediaitemstream</em></p><p id="bf79" class="jn jo mk jp b jq jr js jt ju jv jw jx nk jz ka kb nl kd ke kf nm kh ki kj kk ij bi translated"><em class="iq">播放状态—audioservice . playbackstatestream</em></p></blockquote><p id="318b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以使用RX dart将三个不同的流构建器合并成一个，而不是在UI中创建三个不同的流构建器。</p><p id="eca9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们创建一个简单的类来保存3个流数据，我将它命名为AudioState。</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="13c7" class="na lc iq mw b gy nb nc l nd ne">class AudioState {<br/>  final List&lt;MediaItem&gt; queue;<br/>  final MediaItem mediaItem;<br/>  final PlaybackState playbackState;   AudioState(this.queue, this.mediaItem, this.playbackState);<br/>}</span></pre><p id="4a34" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以及创建该流的方法。</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="c8c9" class="na lc iq mw b gy nb nc l nd ne">Stream&lt;AudioState&gt; get _audioStateStream {<br/>  return Rx.combineLatest3&lt;List&lt;MediaItem&gt;, MediaItem, PlaybackState,<br/>      AudioState&gt;(<br/>    AudioService.queueStream,<br/>    AudioService.currentMediaItemStream,<br/>    AudioService.playbackStateStream,<br/>    (queue, mediaItem, playbackState) =&gt; AudioState(<br/>      queue,<br/>      mediaItem,<br/>      playbackState,<br/>    ),<br/>  );<br/>}</span></pre><p id="e980" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在用户界面中</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="0ff7" class="na lc iq mw b gy nb nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  Widget build(BuildContext context) {<br/>    return Scaffold(<br/>      appBar: AppBar(<br/>        title: Text('Audio Player'),<br/>      ),<br/>      body: Container(<br/>        padding: EdgeInsets.all(20.0),<br/>        color: Colors.white,<br/>        child: StreamBuilder&lt;AudioState&gt;(<br/>          stream: _audioStateStream,<br/>          builder: (context, snapshot) {<br/>            final audioState = snapshot.data;<br/>            final queue = audioState?.queue;<br/>            final mediaItem = audioState?.mediaItem;<br/>            final playbackState = audioState?.playbackState;<br/>            final processingState =<br/>                playbackState?.processingState ?? AudioProcessingState.none;<br/>            final playing = playbackState?.playing ?? false;</span></pre><p id="8844" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我们有所有要在UI中处理的数据。</p><p id="3633" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是完整的AudioPlayer.dart的样子。</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="79ba" class="na lc iq mw b gy nb nc l nd ne">import 'dart:async';import 'package:audio_service/audio_service.dart';<br/>import 'package:just_audio/just_audio.dart';MediaControl playControl = MediaControl(<br/>  androidIcon: 'drawable/ic_action_play_arrow',<br/>  label: 'Play',<br/>  action: MediaAction.play,<br/>);<br/>MediaControl pauseControl = MediaControl(<br/>  androidIcon: 'drawable/ic_action_pause',<br/>  label: 'Pause',<br/>  action: MediaAction.pause,<br/>);<br/>MediaControl skipToNextControl = MediaControl(<br/>  androidIcon: 'drawable/ic_action_skip_next',<br/>  label: 'Next',<br/>  action: MediaAction.skipToNext,<br/>);<br/>MediaControl skipToPreviousControl = MediaControl(<br/>  androidIcon: 'drawable/ic_action_skip_previous',<br/>  label: 'Previous',<br/>  action: MediaAction.skipToPrevious,<br/>);<br/>MediaControl stopControl = MediaControl(<br/>  androidIcon: 'drawable/ic_action_stop',<br/>  label: 'Stop',<br/>  action: MediaAction.stop,<br/>);</span><span id="aa6d" class="na lc iq mw b gy ng nc l nd ne">class AudioPlayerTask extends BackgroundAudioTask {<br/>  //<br/>  var _queue = &lt;MediaItem&gt;[];<br/>  int _queueIndex = -1;<br/>  AudioPlayer _audioPlayer = new AudioPlayer();<br/>  AudioProcessingState _skipState;<br/>  bool _playing;<br/>  bool get hasNext =&gt; _queueIndex + 1 &lt; _queue.length;<br/>  bool get hasPrevious =&gt; _queueIndex &gt; 0;<br/>  MediaItem get mediaItem =&gt;    _queue[_queueIndex];<br/>  StreamSubscription&lt;AudioPlaybackState&gt; _playerStateSubscription;<br/>  StreamSubscription&lt;AudioPlaybackEvent&gt; _eventSubscription;</span><span id="ad2b" class="na lc iq mw b gy ng nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">  @override</a><br/>  void onStart(Map&lt;String, dynamic&gt; params) {<br/>    _queue.clear();<br/>    List mediaItems = params['data'];<br/>    for (int i = 0; i &lt; mediaItems.length; i++) {<br/>      MediaItem mediaItem = MediaItem.fromJson(mediaItems[i]);<br/>      _queue.add(mediaItem);<br/>    }<br/>    _playerStateSubscription = _audioPlayer.playbackStateStream<br/>        .where((state) =&gt; state == AudioPlaybackState.completed)<br/>        .listen((state) {<br/>      _handlePlaybackCompleted();<br/>    });<br/>    _eventSubscription = _audioPlayer.playbackEventStream.listen((event) {<br/>      final bufferingState =<br/>          event.buffering ? AudioProcessingState.buffering : null;<br/>      switch (event.state) {<br/>        case AudioPlaybackState.paused:<br/>          _setState(<br/>              processingState: bufferingState ?? AudioProcessingState.ready,<br/>              position: event.position);<br/>          break;<br/>        case AudioPlaybackState.playing:<br/>          _setState(<br/>              processingState: bufferingState ?? AudioProcessingState.ready,<br/>              position: event.position);<br/>          break;<br/>        case AudioPlaybackState.connecting:<br/>          _setState(<br/>              processingState: _skipState ?? AudioProcessingState.connecting,<br/>              position: event.position);<br/>          break;<br/>        default:<br/>      }<br/>    });<br/>    AudioServiceBackground.setQueue(_queue);<br/>    onSkipToNext();<br/>  }</span><span id="3dc7" class="na lc iq mw b gy ng nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  void onPlay() {<br/>    if (_skipState == null) {<br/>      _playing = true;<br/>      _audioPlayer.play();<br/>    }<br/>  }</span><span id="2125" class="na lc iq mw b gy ng nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  void onPause() {<br/>    _playing = false;<br/>    _audioPlayer.pause();<br/>  }</span><span id="b6cb" class="na lc iq mw b gy ng nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  void onSkipToNext() async {<br/>    skip(1);<br/>  }</span><span id="dbd3" class="na lc iq mw b gy ng nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  void onSkipToPrevious() {<br/>    skip(-1);<br/>  }void skip(int offset) async {<br/>    int newPos = _queueIndex + offset;<br/>    if (!(newPos &gt;= 0 &amp;&amp; newPos &lt; _queue.length)) {<br/>      return;<br/>    }<br/>    if (null == _playing) {<br/>      _playing = true;<br/>    } else if (_playing) {<br/>      await _audioPlayer.stop();<br/>    }<br/>    _queueIndex = newPos;<br/>    _skipState = offset &gt; 0<br/>        ? AudioProcessingState.skippingToNext<br/>        : AudioProcessingState.skippingToPrevious;<br/>    AudioServiceBackground.setMediaItem(mediaItem);<br/>    await _audioPlayer.setUrl(mediaItem.id);<br/>    print(mediaItem.id);<br/>    _skipState = null;<br/>    if (_playing) {<br/>      onPlay();<br/>    } else {<br/>      _setState(processingState: AudioProcessingState.ready);<br/>    }<br/>  }</span><span id="645d" class="na lc iq mw b gy ng nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  Future&lt;void&gt; onStop() async {<br/>    _playing = false;<br/>    await _audioPlayer.stop();<br/>    await _audioPlayer.dispose();<br/>    _playerStateSubscription.cancel();<br/>    _eventSubscription.cancel();<br/>    return await super.onStop();<br/>  }</span><span id="90be" class="na lc iq mw b gy ng nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank"> @override</a><br/>  void onSeekTo(Duration position) {<br/>    _audioPlayer.seek(position);<br/>  }</span><span id="5df6" class="na lc iq mw b gy ng nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank"> @override</a><br/>  void onClick(MediaButton button) {<br/>    playPause();<br/>  }</span><span id="c4c7" class="na lc iq mw b gy ng nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  Future&lt;void&gt; onFastForward() async {<br/>    await _seekRelative(fastForwardInterval);<br/>  }</span><span id="6d6c" class="na lc iq mw b gy ng nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  Future&lt;void&gt; onRewind() async {<br/>    await _seekRelative(rewindInterval);<br/>  }Future&lt;void&gt; _seekRelative(Duration offset) async {<br/>    var newPosition = _audioPlayer.playbackEvent.position + offset;<br/>    if (newPosition &lt; Duration.zero) {<br/>      newPosition = Duration.zero;<br/>    }<br/>    if (newPosition &gt; mediaItem.duration) {<br/>      newPosition = mediaItem.duration;<br/>    }<br/>    await _audioPlayer.seek(_audioPlayer.playbackEvent.position + offset);<br/>  }_handlePlaybackCompleted() {<br/>    if (hasNext) {<br/>      onSkipToNext();<br/>    } else {<br/>      onStop();<br/>    }<br/>  }void playPause() {<br/>    if (AudioServiceBackground.state.playing)<br/>      onPause();<br/>    else<br/>      onPlay();<br/>  }Future&lt;void&gt; _setState({<br/>    AudioProcessingState processingState,<br/>    Duration position,<br/>    Duration bufferedPosition,<br/>  }) async {<br/>    print('SetState $processingState');<br/>    if (position == null) {<br/>      position = _audioPlayer.playbackEvent.position;<br/>    }<br/>    await AudioServiceBackground.setState(<br/>      controls: getControls(),<br/>      systemActions: [MediaAction.seekTo],<br/>      processingState:<br/>          processingState ?? AudioServiceBackground.state.processingState,<br/>      playing: _playing,<br/>      position: position,<br/>      bufferedPosition: bufferedPosition ?? position,<br/>      speed: _audioPlayer.speed,<br/>    );<br/>  }List&lt;MediaControl&gt; getControls() {<br/>    if (_playing) {<br/>      return [<br/>        skipToPreviousControl,<br/>        pauseControl,<br/>        stopControl,<br/>        skipToNextControl<br/>      ];<br/>    } else {<br/>      return [<br/>        skipToPreviousControl,<br/>        playControl,<br/>        stopControl,<br/>        skipToNextControl<br/>      ];<br/>    }<br/>  }<br/>}</span><span id="b649" class="na lc iq mw b gy ng nc l nd ne">class AudioState {<br/>  final List&lt;MediaItem&gt; queue;<br/>  final MediaItem mediaItem;<br/>  final PlaybackState playbackState;AudioState(this.queue,       this.mediaItem, this.playbackState);<br/>}</span></pre><p id="8e1e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">而我们的主UI会是这样的。</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="2a4a" class="na lc iq mw b gy nb nc l nd ne">import 'dart:math';<br/>import 'package:audio_service/audio_service.dart';<br/>import 'package:flutter/material.dart';<br/>import 'package:rxdart/rxdart.dart';</span><span id="8488" class="na lc iq mw b gy ng nc l nd ne">import 'AudioPlayerTask.dart';class BGAudioPlayerScreen extends StatefulWidget {<br/>  <a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  _BGAudioPlayerScreenState createState() =&gt; _BGAudioPlayerScreenState();<br/>}</span><span id="e089" class="na lc iq mw b gy ng nc l nd ne">class _BGAudioPlayerScreenState extends State&lt;BGAudioPlayerScreen&gt; {<br/>  final BehaviorSubject&lt;double&gt; _dragPositionSubject =<br/>      BehaviorSubject.seeded(null);final _queue = &lt;MediaItem&gt;[<br/>    MediaItem(<br/>      id: "<a class="ae nf" href="https://s3.amazonaws.com/scifri-episodes/scifri20181123-episode.mp3" rel="noopener ugc nofollow" target="_blank">https://s3.amazonaws.com/scifri-episodes/scifri20181123-episode.mp3</a>",<br/>      album: "Science Friday",<br/>      title: "A Salute To Head-Scratching Science",<br/>      artist: "Science Friday and WNYC Studios",<br/>      duration: Duration(milliseconds: 5739820),<br/>      artUri:<br/>          "<a class="ae nf" href="https://media.wnyc.org/i/1400/1400/l/80/1/ScienceFriday_WNYCStudios_1400.jpg" rel="noopener ugc nofollow" target="_blank">https://media.wnyc.org/i/1400/1400/l/80/1/ScienceFriday_WNYCStudios_1400.jpg</a>",<br/>    ),<br/>    MediaItem(<br/>      id: "<a class="ae nf" href="https://s3.amazonaws.com/scifri-segments/scifri201711241.mp3" rel="noopener ugc nofollow" target="_blank">https://s3.amazonaws.com/scifri-segments/scifri201711241.mp3</a>",<br/>      album: "Science Friday",<br/>      title: "From Cat Rheology To Operatic Incompetence",<br/>      artist: "Science Friday and WNYC Studios",<br/>      duration: Duration(milliseconds: 2856950),<br/>      artUri:<br/>          "<a class="ae nf" href="https://media.wnyc.org/i/1400/1400/l/80/1/ScienceFriday_WNYCStudios_1400.jpg" rel="noopener ugc nofollow" target="_blank">https://media.wnyc.org/i/1400/1400/l/80/1/ScienceFriday_WNYCStudios_1400.jpg</a>",<br/>    ),<br/>  ];</span><span id="0880" class="na lc iq mw b gy ng nc l nd ne">  bool _loading;</span><span id="1627" class="na lc iq mw b gy ng nc l nd ne"><a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">  @override</a><br/>  void initState() {<br/>    super.initState();<br/>    _loading = false;<br/>  }<a class="ae nf" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  Widget build(BuildContext context) {<br/>    return Scaffold(<br/>      appBar: AppBar(<br/>        title: Text('Audio Player'),<br/>      ),<br/>      body: Container(<br/>        padding: EdgeInsets.all(20.0),<br/>        color: Colors.white,<br/>        child: StreamBuilder&lt;AudioState&gt;(<br/>          stream: _audioStateStream,<br/>          builder: (context, snapshot) {<br/>            final audioState = snapshot.data;<br/>            final queue = audioState?.queue;<br/>            final mediaItem = audioState?.mediaItem;<br/>            final playbackState = audioState?.playbackState;<br/>            final processingState =<br/>                playbackState?.processingState ?? AudioProcessingState.none;<br/>            final playing = playbackState?.playing ?? false;<br/>            return Container(<br/>              width: MediaQuery.of(context).size.width,<br/>              child: Column(<br/>                mainAxisAlignment: MainAxisAlignment.center,<br/>                crossAxisAlignment: CrossAxisAlignment.center,<br/>                mainAxisSize: MainAxisSize.max,<br/>                children: [<br/>                  if (processingState == AudioProcessingState.none) ...[<br/>                    _startAudioPlayerBtn(),<br/>                  ] else ...[<br/>                    //positionIndicator(mediaItem, playbackState),<br/>                    SizedBox(height: 20),<br/>                    if (mediaItem?.title != null) Text(mediaItem.title),<br/>                    SizedBox(height: 20),<br/>                    Row(<br/>                      mainAxisAlignment: MainAxisAlignment.center,<br/>                      children: [<br/>                        !playing<br/>                            ? IconButton(<br/>                                icon: Icon(Icons.play_arrow),<br/>                                iconSize: 64.0,<br/>                                onPressed: AudioService.play,<br/>                              )<br/>                            : IconButton(<br/>                                icon: Icon(Icons.pause),<br/>                                iconSize: 64.0,<br/>                                onPressed: AudioService.pause,<br/>                              ),<br/>                        IconButton(<br/>                        //   icon: Icon(Icons.stop),<br/>                        //   iconSize: 64.0,<br/>                        //   onPressed: AudioService.stop,<br/>                        // ),<br/>                        Row(<br/>                          mainAxisAlignment: MainAxisAlignment.center,<br/>                          children: [<br/>                            IconButton(<br/>                              icon: Icon(Icons.skip_previous),<br/>                              iconSize: 64,<br/>                              onPressed: () {<br/>                                if (mediaItem == queue.first) {<br/>                                  return;<br/>                                }<br/>                                AudioService.skipToPrevious();<br/>                              },<br/>                            ),<br/>                            IconButton(<br/>                              icon: Icon(Icons.skip_next),<br/>                              iconSize: 64,<br/>                              onPressed: () {<br/>                                if (mediaItem == queue.last) {<br/>                                  return;<br/>                                }<br/>                                AudioService.skipToNext();<br/>                              },<br/>                            )<br/>                          ],<br/>                        ),<br/>                      ],<br/>                    )<br/>                  ]<br/>                ],<br/>              ),<br/>            );<br/>          },<br/>        ),<br/>      ),<br/>    );<br/>  }</span><span id="7c73" class="na lc iq mw b gy ng nc l nd ne"><br/>_startAudioPlayerBtn() {<br/>    List&lt;dynamic&gt; list = List();<br/>    for (int i = 0; i &lt; 2; i++) {<br/>      var m = _queue[i].toJson();<br/>      list.add(m);<br/>    }<br/>    var params = {"data": list};<br/>    return MaterialButton(<br/>      child: Text(_loading ? "Loading..." : 'Start Audio Player'),<br/>      onPressed: () async {<br/>        setState(() {<br/>          _loading = true;<br/>        });<br/>        await AudioService.start(<br/>          backgroundTaskEntrypoint: _audioPlayerTaskEntrypoint,<br/>          androidNotificationChannelName: 'Audio Player',<br/>          androidNotificationColor: 0xFF2196f3,<br/>          androidNotificationIcon: 'mipmap/ic_launcher',<br/>          params: params,<br/>        );<br/>        setState(() {<br/>          _loading = false;<br/>        });<br/>      },<br/>    );<br/>  }</span><span id="6e46" class="na lc iq mw b gy ng nc l nd ne">Widget positionIndicator(MediaItem mediaItem, PlaybackState state) {<br/>    double seekPos;<br/>    return StreamBuilder(<br/>      stream: Rx.combineLatest2&lt;double, double, double&gt;(<br/>          _dragPositionSubject.stream,<br/>          Stream.periodic(Duration(milliseconds: 200)),<br/>          (dragPosition, _) =&gt; dragPosition),<br/>      builder: (context, snapshot) {<br/>        double position =<br/>            snapshot.data ?? state.currentPosition.inMilliseconds.toDouble();<br/>        double duration = mediaItem?.duration?.inMilliseconds?.toDouble();<br/>        return Column(<br/>          children: [<br/>            if (duration != null)<br/>              Slider(<br/>                min: 0.0,<br/>                max: duration,<br/>                value: seekPos ?? max(0.0, min(position, duration)),<br/>                onChanged: (value) {<br/>                  _dragPositionSubject.add(value);<br/>                },<br/>                onChangeEnd: (value) {<br/>                  AudioService.seekTo(Duration(milliseconds: value.toInt()));<br/>                  // Due to a delay in platform channel communication, there is<br/>                  // a brief moment after releasing the Slider thumb before the<br/>                  // new position is broadcast from the platform side. This<br/>                  // hack is to hold onto seekPos until the next state update<br/>                  // comes through.<br/>                  // TODO: Improve this code.<br/>                  seekPos = value;<br/>                  _dragPositionSubject.add(null);<br/>                },<br/>              ),<br/>            Text("${state.currentPosition}"),<br/>          ],<br/>        );<br/>      },<br/>    );<br/>  }<br/>}</span><span id="930a" class="na lc iq mw b gy ng nc l nd ne">Stream&lt;AudioState&gt; get _audioStateStream {<br/>  return Rx.combineLatest3&lt;List&lt;MediaItem&gt;, MediaItem, PlaybackState,<br/>      AudioState&gt;(<br/>    AudioService.queueStream,<br/>    AudioService.currentMediaItemStream,<br/>    AudioService.playbackStateStream,<br/>    (queue, mediaItem, playbackState) =&gt; AudioState(<br/>      queue,<br/>      mediaItem,<br/>      playbackState,<br/>    ),<br/>  );<br/>}</span><span id="6026" class="na lc iq mw b gy ng nc l nd ne">void _audioPlayerTaskEntrypoint() async {<br/>  AudioServiceBackground.run(() =&gt; AudioPlayerTask());<br/>}</span></pre><p id="8026" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在AudioPlayer.dart的完整示例中，您可以看到数据是作为参数从主UI发送的。</p><h1 id="b6a5" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">完整的源代码</strong></h1><p id="bfb6" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy ms ka kb kc mt ke kf kg mu ki kj kk ij bi translated"><a class="ae nf" href="https://bitbucket.org/vipinvijayan1987/tutorialprojects/src/BGMusicPlayer/FlutterTutorialProjects/flutter_demos/" rel="noopener ugc nofollow" target="_blank">https://bit bucket . org/vipinvijayan 1987/tutorial projects/src/BGMusicPlayer/fluttertutorial projects/flutter _ demos/</a></p></div></div>    
</body>
</html>