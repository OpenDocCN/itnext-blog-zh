<html>
<head>
<title>Do You Need Multi-Clusters?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">您需要多集群吗？</h1>
<blockquote>原文：<a href="https://itnext.io/do-you-need-multi-clusters-6e58556f7f06?source=collection_archive---------0-----------------------#2022-03-15">https://itnext.io/do-you-need-multi-clusters-6e58556f7f06?source=collection_archive---------0-----------------------#2022-03-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7918" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">评估CNCF多集群解决方案，走我们自己的路</h2></div><p id="33ba" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当部署在云上的服务达到一定水平时，所有公司都应该采用多集群。根据VMware 2020的Kubernetes报告的<a class="ae le" href="https://tanzu.s3.us-east-2.amazonaws.com/campaigns/pdfs/VMware_State_Of_Kubernetes_2020_eBook.pdf" rel="noopener ugc nofollow" target="_blank">状态，33%的Kubernetes采用者运行26个或更多集群，20%运行50个以上集群。</a></p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi lf"><img src="../Images/c7159abe288e8acab1087c41ab6e2fb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1026/0*7SiiiJWT-JYBv-g7"/></div></figure><p id="f746" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">无论使用AWS、GKE还是其他云提供商，无论是否自己构建Kubernetes平台，无论是否使用自动扩展功能，您都会发现单个集群的容量是有限的。由<a class="ae le" href="https://kubernetes.io/docs/setup/best-practices/cluster-large/#:~:text=A%20cluster%20is%20a%20set%20of%20nodes%20%28physical,configurations%20that%20meet%20all%20of%20the%20following%20criteria%3A" rel="noopener ugc nofollow" target="_blank"> Kubernetes官方</a>推荐的“最大”集群应该是</p><blockquote class="ln lo lp"><p id="72ba" class="ki kj lq kk b kl km ju kn ko kp jx kq lr ks kt ku ls kw kx ky lt la lb lc ld im bi translated">每个节点不超过110个机架</p><p id="d289" class="ki kj lq kk b kl km ju kn ko kp jx kq lr ks kt ku ls kw kx ky lt la lb lc ld im bi translated">不超过5000个节点</p><p id="b44b" class="ki kj lq kk b kl km ju kn ko kp jx kq lr ks kt ku ls kw kx ky lt la lb lc ld im bi translated">总共不超过150000个豆荚</p><p id="a3de" class="ki kj lq kk b kl km ju kn ko kp jx kq lr ks kt ku ls kw kx ky lt la lb lc ld im bi translated">总集装箱数不超过300000</p></blockquote><p id="12f4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">许多人可能认为他们当前的集群性能很好，对多集群的需求还很遥远。然而，他们很快就会走向多集群。</p><h1 id="e994" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">动机</h1><p id="64aa" class="pw-post-body-paragraph ki kj it kk b kl mm ju kn ko mn jx kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">我们采用的单个集群负担很重:它包含大约<em class="lq"> 2000个名称空间，3000个pod</em>，但是集群中的大多数资源都是GCP相关的，包括<strong class="kk iu"><em class="lq">10000</em></strong><em class="lq">more storage bucket，</em><strong class="kk iu"><em class="lq">10000</em></strong><em class="lq">more IAM资源</em>，以及相当数量的Bigtable和BigQuery相关的资源。与此同时，这50家运营商正在运行数十个内部或开源控制器。</p><p id="84aa" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">就性能而言，GKE自动缩放器目前工作良好。但我们仍然开始寻求多集群战略，将我们的资源和服务迁移到多集群，以解决以下问题。</p><ul class=""><li id="7f2c" class="mr ms it kk b kl km ko kp kr mt kv mu kz mv ld mw mx my mz bi translated"><strong class="kk iu">扩展性</strong>。当部署或升级某个运营商时，依赖于该运营商的pod必须重新启动，这导致整个集群中的羊群效应，因为这些pod可能管理每个名称空间中的大量资源。当APIServer无法响应请求时，就会出现错误。由于Kubernetes的故障重启机制，所有吊舱在数小时内重复重启。因此，单一群集不再能够满足我们快速升级、引入新用户和部署新资源的需求。</li></ul><pre class="lg lh li lj gt na nb nc nd aw ne bi"><span id="1dce" class="nf lv it nb b gy ng nh l ni nj">"error": "Get "https://10.1.1.1:443/apis?timeout=32s": context deadline exceeded</span><span id="bd33" class="nf lv it nb b gy nk nh l ni nj">"Failed to get API Group-Resources", "error": "context deadline exceeded"</span></pre><ul class=""><li id="7df1" class="mr ms it kk b kl km ko kp kr mt kv mu kz mv ld mw mx my mz bi translated"><strong class="kk iu">可用性和用户体验。</strong>作为全公司CI/CD管道的一部分，我们的服务将影响几乎所有正在或将要部署的服务，如PR合并或主建筑。单个集群的爆炸半径太大，如果一项服务需要紧急部署，就需要付出很大努力来绕过我们的单个节点故障。</li><li id="7aef" class="mr ms it kk b kl nl ko nm kr nn kv no kz np ld mw mx my mz bi translated"><strong class="kk iu">隔离</strong>。集群中的资源可以根据它们的变化频率分成两类:稳定的和不稳定的。我们可以将那些稳定的资源(P99)转移到一个相对稳定的环境中，使其免受其他操作员或资源的影响。</li><li id="0c36" class="mr ms it kk b kl nl ko nm kr nn kv no kz np ld mw mx my mz bi translated"><strong class="kk iu">表演</strong>。随着一些集群级别的操作员管理的资源数量增加到10k，他们会遇到各种性能问题。有必要减少他们的pod使用开销并改善用户体验。</li><li id="7837" class="mr ms it kk b kl nl ko nm kr nn kv no kz np ld mw mx my mz bi translated"><strong class="kk iu">多环境</strong>。我们集群中运行的几十个运营商超出了我们的管理范围，大部分运营商维护人员都有自己的发布和部署权限。一旦其中一个出现问题，整个集群都将面临可用性问题。然而，由于当前测试环境和生产之间的巨大差距，很难预测生产中可能出现的问题。因此，我们需要一个更安全的解决方案来测试和释放这些操作符。</li></ul><p id="5524" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">多集群拯救一切，<strong class="kk iu">大大减轻了当前APIServer的压力，加快了我们新功能的升级和部署，减轻了对用户的影响，缩小了爆炸半径，提升了用户体验。</strong></p><p id="94ac" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">另外，<em class="lq">“不要把鸡蛋放在一个篮子里”</em>似乎也是云战略中的趋势。在VMware最新的<a class="ae le" href="https://tanzu.vmware.com/content/ebooks/the-state-of-kubernetes-2021" rel="noopener ugc nofollow" target="_blank"> 2021年报告</a>中，36%的用户已经在推动多云战略，这也是许多公司的计划之一。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/5cf3f1baa3a71d8ea1de4b5022d7b489.png" data-original-src="https://miro.medium.com/v2/resize:fit:632/0*dmuCCIliAOD7C498"/></div></figure><p id="8dae" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">由于深受GCP的影响，我们更接近多云战略是明智的，部署多集群将是第一步。</p><h1 id="a4cc" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">如何设置多集群</h1><p id="09be" class="pw-post-body-paragraph ki kj it kk b kl mm ju kn ko mn jx kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">我们的研究从CNCF现有的能够支持和满足我们需求的工具开始。除了上面列出的痛苦，我们现在应该关注我们实际需要的东西。</p><ul class=""><li id="872a" class="mr ms it kk b kl km ko kp kr mt kv mu kz mv ld mw mx my mz bi translated"><strong class="kk iu">集群部署</strong>，可以快速部署多个集群，解决网络问题。</li><li id="4fc9" class="mr ms it kk b kl nl ko nm kr nn kv no kz np ld mw mx my mz bi translated"><strong class="kk iu">集群发现</strong>，在用户资源分散到多个集群的情况下，搜索当前需要操作的集群的中心服务。它还应该提供类似于一致性散列的功能，以避免当集群随后增加时将资源重新部署到不同的集群。</li><li id="42b0" class="mr ms it kk b kl nl ko nm kr nn kv no kz np ld mw mx my mz bi translated">GCP资源和自定义CRD支持。我们需要更多支持那些由谷歌<a class="ae le" href="https://cloud.google.com/config-connector/docs/overview" rel="noopener ugc nofollow" target="_blank">配置连接器</a>定义的GCP资源，以及由公司内部CRD定义的资源。</li></ul><p id="1ff1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">同时，我们还需要适应许多地方的多集群变化。</p><ul class=""><li id="6b84" class="mr ms it kk b kl km ko kp kr mt kv mu kz mv ld mw mx my mz bi translated">根据CI/CD中的当前请求对资源进行分组。有时，我们需要同时在多个集群上启动操作。</li><li id="7945" class="mr ms it kk b kl nl ko nm kr nn kv no kz np ld mw mx my mz bi translated">确保每个运营商都支持多集群。</li><li id="b555" class="mr ms it kk b kl nl ko nm kr nn kv no kz np ld mw mx my mz bi translated">为用户提供UX或CLI工具，以发现他们用于CLI操作的资源。</li></ul><p id="7314" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">考虑到所有这些需求，让我们看看社区中的用户是如何实现多集群的，用什么策略，用什么工具。</p><h2 id="7519" class="nf lv it bd lw nr ns dn ma nt nu dp me kr nv nw mg kv nx ny mi kz nz oa mk ob bi translated">战略</h2><p id="7891" class="pw-post-body-paragraph ki kj it kk b kl mm ju kn ko mn jx kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">通常，有两种多集群策略，以Kubernetes为中心和以网络为中心。</p><ul class=""><li id="2ad5" class="mr ms it kk b kl km ko kp kr mt kv mu kz mv ld mw mx my mz bi translated"><strong class="kk iu">以Kubernetes为中心的</strong>，管理多个集群，通过在多个集群上构建控制平面层来分发和调度资源管理请求，这些集群是孤立的，每个集群管理不同的资源。</li><li id="61a9" class="mr ms it kk b kl nl ko nm kr nn kv no kz np ld mw mx my mz bi translated"><strong class="kk iu">以网络为中心</strong>，通过网络配置实现不同集群之间的通信，实现资源复制，保持每个集群上的资源一致。</li></ul><p id="d71a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可能会发现这两种策略类似于克服我们在数据库中遇到的瓶颈的传统方法。没错。以Kubernetes为中心的模式类似于主-主模式，它依赖于一个数据库中间件(控制平面)来处理和分发请求，而以网络为中心的模式是主-从模式，主和从之间的通信最终保持数据一致。</p><p id="b91d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我们的例子中，以网络为中心的策略不适用，但是以Kubernetes为中心的策略可以减轻每个集群的负担。</p><h2 id="3ec8" class="nf lv it bd lw nr ns dn ma nt nu dp me kr nv nw mg kv nx ny mi kz nz oa mk ob bi translated">工具</h2><p id="2bc1" class="pw-post-body-paragraph ki kj it kk b kl mm ju kn ko mn jx kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">那些来自云提供商的工具，比如GKE的<a class="ae le" href="https://cloud.google.com/kubernetes-engine/docs/how-to/multi-cluster-services" rel="noopener ugc nofollow" target="_blank">多集群支持</a>，已经过时。它们基本上都是以网络为中心，并伴随着两大问题。</p><ul class=""><li id="5fd9" class="mr ms it kk b kl km ko kp kr mt kv mu kz mv ld mw mx my mz bi translated">不那么开源，很难定制或者二次开发。</li><li id="d31e" class="mr ms it kk b kl nl ko nm kr nn kv no kz np ld mw mx my mz bi translated">与云提供商本身高度耦合，不利于未来的多云或混合云战略。</li></ul><p id="5708" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在来看看社区中有哪些流行的工具可供我们选择。</p><p id="b188" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">库伯菲德</strong></p><p id="6414" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个流行的多集群工具有两个版本，v1 <code class="fe oc od oe nb b">kube-federation</code>(已经废弃)和v2 <code class="fe oc od oe nb b"><a class="ae le" href="https://github.com/kubernetes-sigs/kubefed" rel="noopener ugc nofollow" target="_blank">kubefed</a></code>。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="og oh di oi bf oj"><div class="gh gi of"><img src="../Images/4ad0ccdbc275f22865a28018b026a7bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UkrB-5s6qD9OhgK0"/></div></div><figcaption class="ok ol gj gh gi om on bd b be z dk translated">来自https://github.com/kubernetes-sigs/kubefed的库伯菲德</figcaption></figure><p id="a444" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从kubefed的整体架构我们可以看到，它本质上是由两个CRD，<code class="fe oc od oe nb b">Type Configuration</code>和<code class="fe oc od oe nb b">Cluster Configuration</code>组成，通过CRD各自的控制器和准入webhooks实现两个主要功能。</p><ul class=""><li id="ded5" class="mr ms it kk b kl km ko kp kr mt kv mu kz mv ld mw mx my mz bi translated"><strong class="kk iu">跨集群分布</strong>。通过抽象出<code class="fe oc od oe nb b">Templates</code>、<code class="fe oc od oe nb b">Placement</code>、<code class="fe oc od oe nb b">Overrides</code>三个概念，可以将资源(如<code class="fe oc od oe nb b">Deployment</code>)部署到不同的集群，实现多集群的扩展。</li><li id="4336" class="mr ms it kk b kl nl ko nm kr nn kv no kz np ld mw mx my mz bi translated"><strong class="kk iu">调度</strong>，用<code class="fe oc od oe nb b">clusterSelector</code>和<code class="fe oc od oe nb b">ReplicaSchedulingPreference</code>实现资源调度。</li></ul><p id="9bf6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此外，<code class="fe oc od oe nb b">kubefed</code>还支持许多特性，如高可用性、更容易的资源迁移、多云和混合云部署等。</p><p id="e7bc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然而，它不是我们要找的那个。</p><ul class=""><li id="cf7e" class="mr ms it kk b kl km ko kp kr mt kv mu kz mv ld mw mx my mz bi translated">对于大多数开发人员来说，这是一个复杂的工具，有着陡峭的学习曲线。</li><li id="7f74" class="mr ms it kk b kl nl ko nm kr nn kv no kz np ld mw mx my mz bi translated">它不支持定制分发策略，不能满足我们隔离不同稳定性资源的要求。比如<code class="fe oc od oe nb b">ReplicaSchedulingPreference</code>只能支持<code class="fe oc od oe nb b">Deployments</code>和<code class="fe oc od oe nb b">Replicasets</code>。</li><li id="23f3" class="mr ms it kk b kl nl ko nm kr nn kv no kz np ld mw mx my mz bi translated">它不支持自定义CRD。我们需要额外的努力来管理来自<code class="fe oc od oe nb b">Config Connector</code>的GCP资源。</li></ul><p id="725c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> Gitops </strong></p><p id="fe49" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Gitops已经是一个非常流行的将Kubernetes资源部署到集群的CI/CD标准，比如<a class="ae le" href="https://fluxcd.io/" rel="noopener ugc nofollow" target="_blank"> FluxCD </a>、<a class="ae le" href="https://rancher.com/docs/rancher/v2.x/en/deploy-across-clusters/fleet/" rel="noopener ugc nofollow" target="_blank"> Fleet </a>、<a class="ae le" href="https://argoproj.github.io/argo-cd/" rel="noopener ugc nofollow" target="_blank"> ArgoCD </a>，大部分都支持多集群。是我们可以依靠的吗？</p><p id="7b64" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">FluxCD支持<a class="ae le" href="https://github.com/fluxcd/flux2-kustomize-helm-example" rel="noopener ugc nofollow" target="_blank">多集群</a>和<a class="ae le" href="https://github.com/fluxcd/flux2-multi-tenancy" rel="noopener ugc nofollow" target="_blank">多租户</a>，使用<code class="fe oc od oe nb b">kustomization</code>和<code class="fe oc od oe nb b">helm</code>添加新集群，支持资源隔离。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="og oh di oi bf oj"><div class="gh gi oo"><img src="../Images/48f7661d1f5d8ea809333b2982aeede0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*G62IYBj7AXcoTy_K"/></div></div></figure><p id="e12e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">经过评估，也不是那个。</p><ul class=""><li id="26a0" class="mr ms it kk b kl km ko kp kr mt kv mu kz mv ld mw mx my mz bi translated">无动态分布。资源分配需要以类似<code class="fe oc od oe nb b">go template</code>的方式提前注入，而不是动态分配。而且我们自己的CI/CD工具也无法与之无缝集成。</li><li id="5d2f" class="mr ms it kk b kl nl ko nm kr nn kv no kz np ld mw mx my mz bi translated">副作用。应用<code class="fe oc od oe nb b">helm</code>和<code class="fe oc od oe nb b">kustomize</code>的开销太高。</li></ul><p id="4beb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这些缺点是其他Gitops所共有的，也是不适用的。</p><p id="b176" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">卡玛达</strong></p><p id="47e5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae le" href="https://github.com/karmada-io/karmada" rel="noopener ugc nofollow" target="_blank"> Karmada </a>来自CNCF沙盒，支持多集群和多云策略。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="og oh di oi bf oj"><div class="gh gi op"><img src="../Images/e107cb65b6f12dde5aaaa61580ccc92d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1bQ8tiREcJEcz0Ju"/></div></div><figcaption class="ok ol gj gh gi om on bd b be z dk translated">来自https://github.com/karmada-io/karmada的卡玛达</figcaption></figure><p id="ac09" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">其设计部分继承了<code class="fe oc od oe nb b">kubefed</code> v1和v2，与<code class="fe oc od oe nb b">APIServer</code>、<code class="fe oc od oe nb b">Scheduler</code>和<code class="fe oc od oe nb b">controller-manager</code>组成控制平面，通过<code class="fe oc od oe nb b">PropagationPolicy</code>和<code class="fe oc od oe nb b">OverridePolicy</code>两个CRD实现资源调度和分配。</p><p id="9b88" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Karmada有许多优势，包括但不限于:</p><ul class=""><li id="cfb8" class="mr ms it kk b kl km ko kp kr mt kv mu kz mv ld mw mx my mz bi translated"><strong class="kk iu">集群管理</strong>。统一API支持集群注册和生命周期管理。</li><li id="c78b" class="mr ms it kk b kl nl ko nm kr nn kv no kz np ld mw mx my mz bi translated"><strong class="kk iu">声明式资源调度。</strong>支持定制的调度策略，根据标签和状态动态调度资源到合适的集群。</li></ul><p id="6db4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Karmada的主要优势在于本土的Kubernetes资源加工，但它并不天然支持CRD。</p><blockquote class="ln lo lp"><p id="fb92" class="ki kj lq kk b kl km ju kn ko kp jx kq lr ks kt ku ls kw kx ky lt la lb lc ld im bi translated">对于Kubernetes的原生资源，Karmada知道如何解析它们，但是对于由CRD定义的自定义资源(或由aggregated-apiserver之类的东西扩展的资源)，由于缺乏资源结构的知识，它们只能被视为普通资源。因此，高级调度算法不能用于它们。</p></blockquote><p id="a397" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">也就是说，需要<a class="ae le" href="https://github.com/karmada-io/karmada/blob/master/docs/userguide/customizing-resource-interpreter.md" rel="noopener ugc nofollow" target="_blank">资源解释器</a>开发来实现那些功能，比如动态调度。我们不挑的最大原因。</p><h2 id="f9c3" class="nf lv it bd lw nr ns dn ma nt nu dp me kr nv nw mg kv nx ny mi kz nz oa mk ob bi translated">我们自己的方式</h2><p id="a2bb" class="pw-post-body-paragraph ki kj it kk b kl mm ju kn ko mn jx kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">意识到我们正在以一种非常“独特”的方式使用Kubernetes，这不同于社区中的大多数场景，我们决定定制我们自己的实现来完全满足我们的需求。</p><p id="e133" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从目前的单集群过渡到多集群没有太多的事情要做。</p><ul class=""><li id="359e" class="mr ms it kk b kl km ko kp kr mt kv mu kz mv ld mw mx my mz bi translated"><strong class="kk iu">集群管理</strong>。我们已经使用terraform创建了当前集群，因此在解决网络问题并拥有足够的IP后，我们可以使用<code class="fe oc od oe nb b">terraform</code>快速创建额外的集群。</li><li id="54c8" class="mr ms it kk b kl nl ko nm kr nn kv no kz np ld mw mx my mz bi translated"><strong class="kk iu">调度</strong>。当我们决定根据名称空间将资源分布到不同的集群时，我们需要一个中央调度服务:当一个名称空间被传入时，该服务可以返回相应的集群上下文，以便我们可以将资源部署到CI/CD服务中的相应集群。该服务还应支持GRPC，以便与公司内的分销战略相统一。</li><li id="4a83" class="mr ms it kk b kl nl ko nm kr nn kv no kz np ld mw mx my mz bi translated"><strong class="kk iu"> Golang支持</strong>。我们有许多自主开发的操作程序，因此操作程序维护人员将需要Golang包的支持。当然，这是一个不错的选择，因为他们可以通过RPC接口获得集群信息。</li><li id="c458" class="mr ms it kk b kl nl ko nm kr nn kv no kz np ld mw mx my mz bi translated"><strong class="kk iu">自动化</strong>。对于单个集群，我们通过CLI或简单的脚本手动完成构建集群、安装工具、安装和部署各种操作员。现在有了多集群，当手动一个接一个地部署集群显得低效且容易出错时，我们需要升级。因此，自动化相关的工具和完整的脚本是必要的。</li><li id="0421" class="mr ms it kk b kl nl ko nm kr nn kv no kz np ld mw mx my mz bi translated">CLI工具。我们希望为用户提供与在单集群场景中相同的多集群体验，用户可以登录我们的集群来查看他们的资源。为此，我们需要实现一个kubectl插件来封装相关的逻辑，只要用户传入名称空间，kubectl请求就可以被转发到相应的上下文。</li></ul><p id="00ad" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">基本上，从单集群到多集群的架构变化如下。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="og oh di oi bf oj"><div class="gh gi oq"><img src="../Images/53acb4ac4e8163b3a21d57ff9855132f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5wz60QPBh7AVOqsz"/></div></div></figure><p id="53db" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正如所见，它比任何现有的工具都更有效，并且更适合我们当前的情况。</p><h1 id="db1e" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">结束了</h1><p id="8bbd" class="pw-post-body-paragraph ki kj it kk b kl mm ju kn ko mn jx kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated">本文回顾了我们在实现多集群时遇到的问题、进行的讨论以及引发的思考。我们没有使用社区中的任何工具，但是我们通过研究它们的特性、优点和缺点，为自己铺平了道路。</p><p id="3632" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">希望它还能让您对多集群的实现有一个大致的了解，并在您处于十字路口时有所启发。</p><p id="6c05" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">感谢阅读！</p><h1 id="98c5" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">参考</h1><p id="f8fc" class="pw-post-body-paragraph ki kj it kk b kl mm ju kn ko mn jx kq kr mo kt ku kv mp kx ky kz mq lb lc ld im bi translated"><a class="ae le" href="https://kubernetes.io/blog/2018/12/12/kubernetes-federation-evolution/" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/blog/2018/12/12/kubernetes-Federation-evolution/</a></p><p id="7c16" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae le" href="https://www.getambassador.io/learn/multi-cluster-kubernetes/" rel="noopener ugc nofollow" target="_blank">了解多集群Kubernetes | Ambassador Labs(getambassador . io)</a></p><p id="0bf4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae le" href="https://www.cncf.io/blog/2021/04/12/simplifying-multi-clusters-in-kubernetes/" rel="noopener ugc nofollow" target="_blank">简化Kubernetes |云计算本地计算基础(cncf.io)中的多集群</a></p><p id="db5d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">【github.com】flux CD/Flux 2-多租户:使用Flux管理多租户集群</p><p id="d489" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">【github.com T4】karmada-io/karmada:开放、多云、多集群Kubernetes Orchestration</p><p id="5b98" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae le" href="https://www.bmc.com/blogs/kubernetes-multi-clusters/" rel="noopener ugc nofollow" target="_blank"> Kubernetes多集群:如何&amp;为什么使用它们— BMC软件|博客</a></p></div></div>    
</body>
</html>