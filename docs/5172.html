<html>
<head>
<title>Create a Front App immediately with Next.js on Google Cloud Run</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Google Cloud Run上使用Next.js立即创建前台应用程序</h1>
<blockquote>原文：<a href="https://itnext.io/create-a-front-app-immediately-with-next-js-on-google-cloud-run-d0cfde795ce3?source=collection_archive---------1-----------------------#2021-01-02">https://itnext.io/create-a-front-app-immediately-with-next-js-on-google-cloud-run-d0cfde795ce3?source=collection_archive---------1-----------------------#2021-01-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/814811b2d44b5e8564905e9a5d2e76dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*raWme1wi7uWXT1lTdlLrog.png"/></div></div></figure><p id="cdf6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当你创建一个原型时，速度和金钱是非常重要的。你需要以低成本尽快展示给用户。</p><p id="25f4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">js是一个流行的前端框架，它使用简单的lambda api进行静态生成和服务器端渲染。因为它很容易设置，但仍然非常灵活，它是前端原型的最佳候选之一。</p><p id="3f57" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">另一方面，Google Cloud Run是一个无服务器的容器平台。因为它是无服务器的，你不需要维护基础设施，而且一开始就很便宜。如果您的应用程序是dockernized化的，您可能会获得低成本的高效开发体验。</p><p id="0c5a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">所以这篇文章解释了Google Cloud Run上Next.js app的闪电般快速设置。它包括以下3个步骤。</p><ol class=""><li id="7ccc" class="kz la it kd b ke kf ki kj km lb kq lc ku ld ky le lf lg lh bi translated">创建Next.js应用程序</li><li id="6a42" class="kz la it kd b ke li ki lj km lk kq ll ku lm ky le lf lg lh bi translated">Dockernize Next.js应用程序</li><li id="a6fb" class="kz la it kd b ke li ki lj km lk kq ll ku lm ky le lf lg lh bi translated">部署到Google云运行</li></ol><h1 id="4047" class="ln lo it bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">开始前你需要什么</h1><ul class=""><li id="999f" class="kz la it kd b ke ml ki mm km mn kq mo ku mp ky mq lf lg lh bi translated"><a class="ae mr" href="https://docs.docker.com/docker-for-mac/install/" rel="noopener ugc nofollow" target="_blank"> Docker桌面</a></li><li id="c401" class="kz la it kd b ke li ki lj km lk kq ll ku lm ky mq lf lg lh bi translated"><a class="ae mr" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云账号</a>:请创建一个项目</li><li id="b060" class="kz la it kd b ke li ki lj km lk kq ll ku lm ky mq lf lg lh bi translated"><a class="ae mr" href="https://cloud.google.com/sdk/docs/install" rel="noopener ugc nofollow" target="_blank">谷歌云SDK </a></li></ul><h1 id="63e7" class="ln lo it bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">创建Next.js应用程序</h1><p id="3585" class="pw-post-body-paragraph kb kc it kd b ke ml kg kh ki mm kk kl km ms ko kp kq mt ks kt ku mu kw kx ky im bi translated">创建Next.js应用程序最简单的方法是使用<code class="fe mv mw mx my b">create-next-app</code>。cli会为您进行初始设置。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="1d10" class="nh lo it my b gy ni nj l nk nl">// with yarn<br/>$ yarn create next-app</span><span id="d96a" class="nh lo it my b gy nm nj l nk nl">// with npm<br/>$ <!-- -->npx create-next-app</span></pre><p id="5534" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">说完了，我们先来检查一下应用。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="5e49" class="nh lo it my b gy ni nj l nk nl">$ cd &lt;your app name&gt;<br/>$ yarn dev</span></pre><p id="92f3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">可以在<code class="fe mv mw mx my b">localhost:3000</code>看到Next.js的Hello World如下图。</p><figure class="mz na nb nc gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nn"><img src="../Images/0dfab1cbc99e0748b085142c6598a235.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bUgwMdg9bEDtmZSyzO89Qg.png"/></div></div><figcaption class="no np gj gh gi nq nr bd b be z dk translated">Next.js主页</figcaption></figure><h1 id="c770" class="ln lo it bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">Dockernize Nextjs应用程序</h1><p id="123e" class="pw-post-body-paragraph kb kc it kd b ke ml kg kh ki mm kk kl km ms ko kp kq mt ks kt ku mu kw kx ky im bi translated">因为云运行是docker平台，所以你的应用必须docker化。要注册您的Next.js应用程序，请遵循以下3个步骤。</p><ol class=""><li id="efdf" class="kz la it kd b ke kf ki kj km lb kq lc ku ld ky le lf lg lh bi translated">创造<code class="fe mv mw mx my b">Dockerfile</code></li><li id="6c84" class="kz la it kd b ke li ki lj km lk kq ll ku lm ky le lf lg lh bi translated">创建<code class="fe mv mw mx my b">.dockerignore</code></li><li id="22a0" class="kz la it kd b ke li ki lj km lk kq ll ku lm ky le lf lg lh bi translated">配置端口设置</li></ol><h2 id="2235" class="nh lo it bd lp ns nt dn lt nu nv dp lx km nw nx mb kq ny nz mf ku oa ob mj oc bi translated">1.创造<code class="fe mv mw mx my b">Dockerfile</code></h2><p id="9c85" class="pw-post-body-paragraph kb kc it kd b ke ml kg kh ki mm kk kl km ms ko kp kq mt ks kt ku mu kw kx ky im bi translated">还有像<code class="fe mv mw mx my b">node:15.0.1</code>这样的base docker镜像，但是对于你的应用来说还不够。它缺少你自己的包，设置等等。这就是<code class="fe mv mw mx my b">Dockerfile</code>进来的原因。您应该编写一些进程来将自定义设置包含到docker映像中。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="e35b" class="nh lo it my b gy ni nj l nk nl">$ touch Dockerfile</span></pre><p id="7bb7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mv mw mx my b">Dockerfile</code>可能会像下面这样。请选择适合您的不同节点版本(最好使用与本地版本相同的版本)。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="2611" class="nh lo it my b gy ni nj l nk nl">// base image<br/>FROM node:15.2.1-alpine</span><span id="c27d" class="nh lo it my b gy nm nj l nk nl">// working directory<br/>WORKDIR /app</span><span id="d141" class="nh lo it my b gy nm nj l nk nl">// add binaries to $PATH<br/>ENV PATH /app/node_modules/.bin:$PATH</span><span id="6570" class="nh lo it my b gy nm nj l nk nl">// install and cache app dependencies<br/>COPY package.json /app/<br/>COPY yarn.lock /app/<br/>RUN yarn install</span><span id="e076" class="nh lo it my b gy nm nj l nk nl">// copy app files and build<br/>COPY . /app<br/>RUN yarn build</span><span id="5c87" class="nh lo it my b gy nm nj l nk nl"># start app<br/>CMD [ "yarn", "start" ]</span></pre><h2 id="e5a0" class="nh lo it bd lp ns nt dn lt nu nv dp lx km nw nx mb kq ny nz mf ku oa ob mj oc bi translated">2.创造。dockerignore</h2><p id="65b7" class="pw-post-body-paragraph kb kc it kd b ke ml kg kh ki mm kk kl km ms ko kp kq mt ks kt ku mu kw kx ky im bi translated">为了使你的DX更好，docker镜像必须尽可能的小，因为这样可以减少构建时间。要让docker形象苗条，请打造<code class="fe mv mw mx my b">.dockerignore</code>。它从docker映像中删除不必要的文件。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="c67f" class="nh lo it my b gy ni nj l nk nl">$ touch .dockerignore</span></pre><p id="b75e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mv mw mx my b">.dockerignore</code>可能会像下面这样。不得包含node_modules，因为npm软件包将在您构建docker映像时安装。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="c849" class="nh lo it my b gy ni nj l nk nl">node_modules<br/>yarn-error.log</span><span id="19e1" class="nh lo it my b gy nm nj l nk nl">Dockerfile<br/>.dockerignore</span><span id="735b" class="nh lo it my b gy nm nj l nk nl">.git<br/>.gitignore</span></pre><p id="c6da" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">因此，让我们建立docker图像来检查设置。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="1e84" class="nh lo it my b gy ni nj l nk nl">// docker build &lt;PATH&gt; -t &lt;REPO_NAME&gt;:&lt;TAG&gt;</span><span id="0382" class="nh lo it my b gy nm nj l nk nl">$ docker build . -t next-app:latest</span></pre><p id="8888" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">创建后，您可以通过docker images命令检查它。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="598e" class="nh lo it my b gy ni nj l nk nl">$ docker images</span><span id="c5d7" class="nh lo it my b gy nm nj l nk nl">REPOSITORY  TAG     IMAGE ID       CREATED             SIZE<br/>next-app    latest  f834c5ae4f9a   6 minutes ago       117MB</span></pre><h2 id="5e4c" class="nh lo it bd lp ns nt dn lt nu nv dp lx km nw nx mb kq ny nz mf ku oa ob mj oc bi translated">3.配置端口设置</h2><p id="105d" class="pw-post-body-paragraph kb kc it kd b ke ml kg kh ki mm kk kl km ms ko kp kq mt ks kt ku mu kw kx ky im bi translated">您自己的docker映像已经创建，您需要通过运行应用程序来检查您的docker映像是否良好。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="584a" class="nh lo it my b gy ni nj l nk nl">$ docker run -p4000:3000 next-app</span><span id="1011" class="nh lo it my b gy nm nj l nk nl">yarn run v1.22.5<br/>$ next start<br/>ready - started server on <a class="ae mr" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank">http://localhost:3000</a></span></pre><p id="11fd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mv mw mx my b">-p</code>选项是关于端口转发的。浏览器请求接受端口号<code class="fe mv mw mx my b">4000</code>并转发给<code class="fe mv mw mx my b">3000</code>。因为Next.js默认端口设置是<code class="fe mv mw mx my b">3000</code>，转发的请求到达Next.js app。所以如果你在浏览器中打开<code class="fe mv mw mx my b">localhost:4000</code>，</p><figure class="mz na nb nc gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi od"><img src="../Images/87fbfc7efffac3a150495faf1e0b8dad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bLKbb0oXRY10KAknFGbK4A.png"/></div></div><figcaption class="no np gj gh gi nq nr bd b be z dk translated">本地主机:4000</figcaption></figure><p id="186c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">看起来非常好🎉</p><p id="1af0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然而，因为Google Cloud Run要求应用程序在通过<code class="fe mv mw mx my b">PORT</code>环境变量给定的特定端口上运行，所以您的启动脚本必须接受端口设置。如果没有端口设置，当您将映像部署到Google Cloud Run时，会出现如下错误。</p><figure class="mz na nb nc gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oe"><img src="../Images/13a92547863bb0103acaad8bc8e90a89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qcjKpmT8ClPRTpHhi12Vbw.png"/></div></div></figure><p id="855b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">所以请打开<code class="fe mv mw mx my b">package.json</code>编辑启动脚本。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="e4a8" class="nh lo it my b gy ni nj l nk nl">{<br/>  ...<br/>  "scripts": {<br/>    "dev": "next dev",<br/>    "build": "next build",<br/>    "start": "next start -p $PORT"  // accept $PORT here<br/>  },<br/>  ...<br/>}</span></pre><p id="0e7b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">所以现在，启动脚本接受<code class="fe mv mw mx my b">PORT</code>环境变量。因为<code class="fe mv mw mx my b">PORT</code>是Google Cloud Run注入的，所以这个应用在Google Cloud Run中运行良好。另一方面，你要小心当地的环境。</p><p id="db69" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">例如，如果您想通过<code class="fe mv mw mx my b">yarn start</code>运行生产构建Next.js应用程序，您需要传递环境变量。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="be64" class="nh lo it my b gy ni nj l nk nl">$ PORT=8080 yarn start</span></pre><p id="9bdc" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你想运行本地docker机器，你的运行命令应该像下面这样。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="08e1" class="nh lo it my b gy ni nj l nk nl">$ docker run -e PORT=8080 -p 4000:8080 next-app</span></pre><p id="440c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">它通过<code class="fe mv mw mx my b">-e</code>选项传递环境变量。浏览器请求接受<code class="fe mv mw mx my b">4000</code>并转发给<code class="fe mv mw mx my b">8080</code>并在<code class="fe mv mw mx my b">8080</code>中启动Next.js app。</p><h1 id="9aec" class="ln lo it bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">部署到Google云运行</h1><p id="3f11" class="pw-post-body-paragraph kb kc it kd b ke ml kg kh ki mm kk kl km ms ko kp kq mt ks kt ku mu kw kx ky im bi translated">因为你已经做了Next.js app的dockernization，是时候部署了！</p><p id="90c4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要部署云运行应用程序，有以下3个步骤。</p><ol class=""><li id="9151" class="kz la it kd b ke kf ki kj km lb kq lc ku ld ky le lf lg lh bi translated">创建不同的名称空间docker图像标记</li><li id="c2f2" class="kz la it kd b ke li ki lj km lk kq ll ku lm ky le lf lg lh bi translated">将docker图像推送到Google容器注册表(GCR)</li><li id="c660" class="kz la it kd b ke li ki lj km lk kq ll ku lm ky le lf lg lh bi translated">将推送的映像部署到云运行</li></ol><p id="58b7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在继续之前，请启用<code class="fe mv mw mx my b">Cloud Run API</code>、<code class="fe mv mw mx my b">Container Registry API</code>、<code class="fe mv mw mx my b">Cloud Deployment Manager V2 API</code>的Google Cloud API使用cli。</p><h2 id="a69a" class="nh lo it bd lp ns nt dn lt nu nv dp lx km nw nx mb kq ny nz mf ku oa ob mj oc bi translated">1.创建不同的名称空间docker图像标记</h2><p id="543c" class="pw-post-body-paragraph kb kc it kd b ke ml kg kh ki mm kk kl km ms ko kp kq mt ks kt ku mu kw kx ky im bi translated">当您检查上面的docker映像时，您的docker映像的存储库是<code class="fe mv mw mx my b">next-app</code>。但是要部署到Cloud Run，您的映像应该放在GCR。这意味着你的图像必须存放在GCR。所以还是先改库吧！</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="b961" class="nh lo it my b gy ni nj l nk nl">// docker tag &lt;SOURCE_REPO_NAME&gt; gcr.io/&lt;GCP_PROJECT_NAME&gt;/&lt;GCR_REPO_NAME&gt;:&lt;GCR_TAG&gt;</span><span id="c242" class="nh lo it my b gy nm nj l nk nl">$ docker tag next-app gcr.io/test-project/next-app:latest</span></pre><p id="164b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在你的图像可以像下面这样推送到GCR了。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="6ff5" class="nh lo it my b gy ni nj l nk nl">$ docker images</span><span id="a07c" class="nh lo it my b gy nm nj l nk nl">REPOSITORY  TAG  IMAGE ID  CREATED  SIZE<br/>gcr.io/test-project/next-app:latest  2b51c1d11422  43 minutes ago  276MB</span></pre><h2 id="015a" class="nh lo it bd lp ns nt dn lt nu nv dp lx km nw nx mb kq ny nz mf ku oa ob mj oc bi translated">2.将docker图像推送到Google容器注册表(GCR)</h2><p id="6d50" class="pw-post-body-paragraph kb kc it kd b ke ml kg kh ki mm kk kl km ms ko kp kq mt ks kt ku mu kw kx ky im bi translated">因为Google Cloud Run会把你的docker镜像从GCR拉过来，所以你必须把你的docker镜像推送到GCR。但是，如果您没有推送至GCR，您将面临身份验证错误。所以请创建一个gcloud命令的<code class="fe mv mw mx my b">credHelper</code>来docker配置。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="3c76" class="nh lo it my b gy ni nj l nk nl">$ gcloud auth configure-docker</span></pre><p id="dab3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">最后，让我们把你的码头工人形象推向GCR。因为整个图像是通过互联网推送的，所以需要一些时间。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="e7b3" class="nh lo it my b gy ni nj l nk nl">// docker push gcr.io/&lt;GCP_PROJECT_NAME&gt;/&lt;GCR_REPO_NAME&gt;:&lt;GCR_TAG&gt;</span><span id="cc90" class="nh lo it my b gy nm nj l nk nl">$ docker push gcr.io/test-project/next-app:latest<br/>The push refers to repository [gcr.io/test-project/next-app]<br/>f01fa31cf258: Layer already exists<br/>22ce882451cc: Layer already exists<br/>970e4e2ffa6f: Layer already exists<br/>65f238554c45: Layer already exists<br/>053b1bdff0c1: Layer already exists<br/>970feb8565a1: Layer already exists<br/>78efe26eefc0: Layer already exists<br/>1b2a921893cb: Layer already exists<br/>92cab300fc69: Layer already exists<br/>3e207b409db3: Layer already exists<br/>latest: digest: sha256:5229e6386b3410a46d9771b8d863dd63ebeac620fe67c2c78f6cae67abd89bd1 size: 2413<br/>~</span></pre><p id="2a91" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你查看谷歌云控制台的GCR，推送的图片会在那里。</p><h2 id="a720" class="nh lo it bd lp ns nt dn lt nu nv dp lx km nw nx mb kq ny nz mf ku oa ob mj oc bi translated">3.将推送的映像部署到云运行</h2><p id="b6c4" class="pw-post-body-paragraph kb kc it kd b ke ml kg kh ki mm kk kl km ms ko kp kq mt ks kt ku mu kw kx ky im bi translated">到目前为止，你已经在GCR注册了你自己的docker图片。因此，您只需使用映像部署云运行。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="26ef" class="nh lo it my b gy ni nj l nk nl">$ gcloud beta run deploy --image gcr.io/test-project/next-app:latest --project test-project --platform managed --region asia-northeast1 --allow-unauthenticated</span><span id="b1ae" class="nh lo it my b gy nm nj l nk nl">Service name (next-app):<br/>Deploying container to Cloud Run service [next-app] in project [test-project] region [asia-northeast1]<br/>✓ Deploying... Done.<br/>  ✓ Creating Revision...<br/>  ✓ Routing traffic...<br/>  ✓ Setting IAM Policy...<br/>Done.<br/>Service [test-project] revision [test-project-00001-cej] has been deployed and is serving 100 percent of traffic.<br/>Service URL: <a class="ae mr" href="https://ham-media-liff-stg-5eabyjeviq-an.a.run.app" rel="noopener ugc nofollow" target="_blank">https://next-app-5eabyjeviq-an.a.run.app</a></span></pre><p id="09d7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mv mw mx my b">--platform</code>选项有三个值<code class="fe mv mw mx my b">managed</code>、<code class="fe mv mw mx my b">gke</code>和<code class="fe mv mw mx my b">kubernetes</code>。如果您更想要基础设施的灵活性，请选择<code class="fe mv mw mx my b">gke</code>和<code class="fe mv mw mx my b">kubernetes</code>。使用<code class="fe mv mw mx my b">--allow-unauthenticated</code>选项，可以对服务进行未经验证的访问。详情请看<a class="ae mr" href="https://cloud.google.com/sdk/gcloud/reference/beta/run/deploy" rel="noopener ugc nofollow" target="_blank">官网</a>。</p><p id="7bae" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">因为您已经部署了服务，请转到服务URL。可以看Next.js hello world。</p><figure class="mz na nb nc gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nn"><img src="../Images/0dfab1cbc99e0748b085142c6598a235.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bUgwMdg9bEDtmZSyzO89Qg.png"/></div></div><figcaption class="no np gj gh gi nq nr bd b be z dk translated">部署的服务</figcaption></figure><p id="cb08" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">就是这样！最后，您完成了将Next.js应用程序部署到Google Cloud Run。</p><h1 id="62a2" class="ln lo it bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">技巧</h1><p id="0b1b" class="pw-post-body-paragraph kb kc it kd b ke ml kg kh ki mm kk kl km ms ko kp kq mt ks kt ku mu kw kx ky im bi translated">每次部署时输入每个步骤非常耗时。所以我建议您创建如下所示的部署脚本。</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="f8c1" class="nh lo it my b gy ni nj l nk nl">// deploy.sh<br/>#!/bin/bash<br/>set -e</span><span id="6ecc" class="nh lo it my b gy nm nj l nk nl">// Image tag is the last commit hash<br/>IMAGE_TAG=`git rev-parse HEAD`<br/>REPO_NAME="Foo"<br/>GCP_PROJECT_NAME="Bar"</span><span id="5e06" class="nh lo it my b gy nm nj l nk nl">docker build . -t $REPO_NAME:$IMAGE_TAG</span><span id="e089" class="nh lo it my b gy nm nj l nk nl">docker tag $REPO_NAME gcr.io/$GCP_PROJECT_NAME/$REPO_NAME:$IMAGE_TAG</span><span id="8614" class="nh lo it my b gy nm nj l nk nl">docker push gcr.io/$GCP_PROJECT_NAME/$REPO_NAME:$IMAGE_TAG</span><span id="e55f" class="nh lo it my b gy nm nj l nk nl">gcloud beta run deploy $REPO_NAME --image gcr.io/$GCP_PROJECT_NAME/$REPO_NAME:$IMAGE_TAG \<br/>  --project $GCP_PROJECT_NAME \<br/>  --platform managed \<br/>  --region asia-northeast1 \<br/>  --allow-unauthenticated</span></pre><p id="7e1c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">有了这个脚本，您只需要做的是</p><pre class="mz na nb nc gt nd my ne nf aw ng bi"><span id="e77b" class="nh lo it my b gy ni nj l nk nl">sh deploy.sh</span></pre><p id="7823" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">嘣！自动进行构建和部署！</p></div><div class="ab cl of og hx oh" role="separator"><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok"/></div><div class="im in io ip iq"><p id="e9ab" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这篇文章解释了Google Cloud Run上Next.js应用程序的快速设置。因为你完成了基础设施，你可以从现在开始专注于应用程序代码！尽情享受吧！</p><h1 id="c325" class="ln lo it bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">参考文献</h1><ul class=""><li id="3133" class="kz la it kd b ke ml ki mm km mn kq mo ku mp ky mq lf lg lh bi translated"><a class="ae mr" href="https://nextjs.org/" rel="noopener ugc nofollow" target="_blank"> Next.js </a></li><li id="abda" class="kz la it kd b ke li ki lj km lk kq ll ku lm ky mq lf lg lh bi translated"><a class="ae mr" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云</a></li></ul></div></div>    
</body>
</html>