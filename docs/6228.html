<html>
<head>
<title>Deploying ML models to the edge with Lightning Flash</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用闪电将ML模型部署到边缘</h1>
<blockquote>原文：<a href="https://itnext.io/deploying-ml-models-to-the-edge-with-lightning-flash-9dbfeac9fdf6?source=collection_archive---------3-----------------------#2021-09-23">https://itnext.io/deploying-ml-models-to-the-edge-with-lightning-flash-9dbfeac9fdf6?source=collection_archive---------3-----------------------#2021-09-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="0bb7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本教程中，我们将打包并部署一个简单的模型，该模型公开一个HTTP API，并为Synpse管理的设备提供预测。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/72b0f39a3403cf82fc735d145215efbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*K9HWfeHyHqsMkJAw.png"/></div></div></figure><h1 id="5095" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">闪电是什么？</h1><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/f6d527b2732ceef071ea9661fbdba6cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/0*MsegKcPSFuAIZUa2.png"/></div></figure><p id="8f3d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Flash是一个高级深度学习框架，用于快速原型化、基线化、微调和解决深度学习问题。它提供了一组任务供您进行推断和微调，并且提供了一个易于实现的API来定制该过程的每一步，以获得充分的灵活性。</p><p id="b5b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Flash是为初学者构建的，具有简单的API，需要很少的深度学习背景，并适合数据科学家，Kagglers，应用ML从业者和深度学习研究人员，他们希望快速获得具有高级功能<a class="ae lw" href="https://github.com/PyTorchLightning/pytorch-lightning" rel="noopener ugc nofollow" target="_blank"> PyTorch Lightning </a>提供的深度学习基线。</p><p id="f3ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可以在这里查看PyTorch Lightning的快速入门:<a class="ae lw" href="https://lightning-flash.readthedocs.io/en/latest/quickstart.html" rel="noopener ugc nofollow" target="_blank">https://Lightning-flash . readthe docs . io/en/latest/quick start . html</a>。</p><h1 id="feda" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">先决条件</h1><ul class=""><li id="cd58" class="lx ly iq jp b jq lz ju ma jy mb kc mc kg md kk me mf mg mh bi translated"><a class="ae lw" href="https://cloud.synpse.net/" rel="noopener ugc nofollow" target="_blank"> Synpse账户</a> —最多5台设备免费</li><li id="9f5f" class="lx ly iq jp b jq mi ju mj jy mk kc ml kg mm kk me mf mg mh bi translated">至少有一台设备<a class="ae lw" href="https://docs.synpse.net/synpse-core/devices/provisioning" rel="noopener ugc nofollow" target="_blank">注册到您的Synpse帐户</a></li><li id="4ab1" class="lx ly iq jp b jq mi ju mj jy mk kc ml kg mm kk me mf mg mh bi translated"><a class="ae lw" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank">码头工人</a></li><li id="2033" class="lx ly iq jp b jq mi ju mj jy mk kc ml kg mm kk me mf mg mh bi translated">Python环境</li></ul><h1 id="698e" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">构建模型</h1><p id="ce68" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">Lightning Flash公共知识库在这里有大量的例子:<a class="ae lw" href="https://github.com/PyTorchLightning/lightning-flash/tree/master/flash_examples/serve" rel="noopener ugc nofollow" target="_blank">https://github . com/PyTorchLightning/lightning-Flash/tree/master/Flash _ examples/serve</a>。我决定选择<code class="fe mq mr ms mt b">image_classification</code>，因为拥有某种可以区分蚂蚁和蜜蜂的服务对我来说很重要。您可以在<a class="ae lw" href="https://lightning-flash.readthedocs.io/en/latest/reference/image_classification.html" rel="noopener ugc nofollow" target="_blank">图像分类</a>部分了解更多关于该型号的信息。</p><blockquote class="mu mv mw"><p id="e8d3" class="jn jo mx jp b jq jr js jt ju jv jw jx my jz ka kb mz kd ke kf na kh ki kj kk ij bi translated"><em class="iq">储存库与代码可以在这里找到:</em><a class="ae lw" href="https://github.com/synpse-hq/synpse-lightning-flash-example" rel="noopener ugc nofollow" target="_blank"><em class="iq"/></a><em class="iq">。</em></p></blockquote><h1 id="329f" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">步骤1:复制示例回购</h1><pre class="km kn ko kp gt nb mt nc nd aw ne bi"><span id="82bb" class="nf ky iq mt b gy ng nh l ni nj">git clone <a class="ae lw" href="https://github.com/synpse-hq/synpse-lightning-flash-example.git" rel="noopener ugc nofollow" target="_blank">https://github.com/synpse-hq/synpse-lightning-flash-example.git</a></span></pre><p id="38e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">在本地运行服务器</strong></p><p id="59f9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我非常惊讶的是，开始使用Flash是多么容易。在您喜欢的编辑器中打开<code class="fe mq mr ms mt b">image_classifier.py</code>文件:</p><pre class="km kn ko kp gt nb mt nc nd aw ne bi"><span id="7f49" class="nf ky iq mt b gy ng nh l ni nj">from flash.image import ImageClassifier</span><span id="4be1" class="nf ky iq mt b gy nk nh l ni nj"># Our downloaded weights<br/>model = ImageClassifier.load_from_checkpoint("./image_classification_model.pt")<br/># Binding to all interfaces (we will need that so it works in Docker container)<br/>model.serve(host="0.0.0.0")</span></pre><p id="7ce0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，开始之前，我们需要安装几个有助于图像分类和服务的依赖项:</p><pre class="km kn ko kp gt nb mt nc nd aw ne bi"><span id="9a74" class="nf ky iq mt b gy ng nh l ni nj">pip install -r requirements.txt</span></pre><p id="3783" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要在本地启动服务器:</p><pre class="km kn ko kp gt nb mt nc nd aw ne bi"><span id="d5aa" class="nf ky iq mt b gy ng nh l ni nj">python image_classifier.py</span></pre><h1 id="ac84" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">第二步:与客户一起尝试</h1><p id="642b" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">当服务器运行时，使用客户端发出HTTP请求:</p><pre class="km kn ko kp gt nb mt nc nd aw ne bi"><span id="2587" class="nf ky iq mt b gy ng nh l ni nj">import base64<br/>from pathlib import Path</span><span id="8e4d" class="nf ky iq mt b gy nk nh l ni nj">import requests</span><span id="96e8" class="nf ky iq mt b gy nk nh l ni nj">import flash</span><span id="3652" class="nf ky iq mt b gy nk nh l ni nj">with (Path("./assets") / "ant.jpg").open("rb") as f:<br/>    imgstr = base64.b64encode(f.read()).decode("UTF-8")</span><span id="dbd9" class="nf ky iq mt b gy nk nh l ni nj">body = {"session": "UUID", "payload": {"inputs": {"data": imgstr}}}<br/>resp = requests.post("<a class="ae lw" href="http://127.0.0.1:8000/predict" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8000/predict</a>", json=body)<br/>print(resp.json())</span></pre><p id="c86a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要运行它:</p><pre class="km kn ko kp gt nb mt nc nd aw ne bi"><span id="2d04" class="nf ky iq mt b gy ng nh l ni nj">python client.py {'session': 'UUID', 'result': {'outputs': 'ants'}}</span></pre><p id="ae5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我已经将bee.jpg和ant.jpg的文件都添加到了资产/目录中，所以请随意尝试这两个文件:)</p><h1 id="a224" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">步骤3:用模型构建和发布Docker图像</h1><p id="3f85" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">我们可以简单地将带有数据的代码嵌入到Docker映像中。您可以使用以下工具构建自己的工具:</p><pre class="km kn ko kp gt nb mt nc nd aw ne bi"><span id="2d00" class="nf ky iq mt b gy ng nh l ni nj">docker build -t &lt;your docker username&gt;/synpse-lighning-flash:latest -f Dockerfile .</span></pre><p id="4abc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">推动它:</p><pre class="km kn ko kp gt nb mt nc nd aw ne bi"><span id="8743" class="nf ky iq mt b gy ng nh l ni nj">docker push &lt;your docker username&gt;/synpse-lighning-flash:latest</span></pre><p id="3f90" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者你可以直接用我自己建的发布的:<code class="fe mq mr ms mt b">karolisr/synpse-lighning-flash:latest</code>。</p><h1 id="1d7b" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">步骤4:准备设备</h1><p id="5631" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">几年来，我一直使用RaspberryPis和英特尔NUC的组合来运行各种后台服务，如家庭助理、NodeRED、无人机、PiHole等。这是一台非常安静的机器，实际上性能非常好:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nl"><img src="../Images/fb212e40e42f224de85cd8bdb42ce27b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wHbudTMdcFs0byMj.png"/></div></div></figure><p id="eb15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装说明可以在<a class="ae lw" href="https://docs.synpse.net/synpse-core/devices/provisioning" rel="noopener ugc nofollow" target="_blank">这里</a>找到，但简短的版本是:</p><ol class=""><li id="aaa5" class="lx ly iq jp b jq jr ju jv jy nm kc nn kg no kk np mf mg mh bi translated">在<a class="ae lw" href="https://cloud.synpse.net" rel="noopener ugc nofollow" target="_blank"> Synpse主页</a>创建一个项目</li><li id="9b15" class="lx ly iq jp b jq mi ju mj jy mk kc ml kg mm kk np mf mg mh bi translated">转到<strong class="jp ir">设备</strong></li><li id="f0f7" class="lx ly iq jp b jq mi ju mj jy mk kc ml kg mm kk np mf mg mh bi translated">点击<strong class="jp ir">供应设备</strong></li><li id="b97f" class="lx ly iq jp b jq mi ju mj jy mk kc ml kg mm kk np mf mg mh bi translated">将命令复制粘贴到您的设备上</li></ol><p id="c718" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该命令将找出设备架构，下载正确的二进制文件，并将您的设备注册到服务中。注册后，您的设备将出现在列表中:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nl"><img src="../Images/b587f781352e0b790dda6808cdde3159.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PP0jRJLEG7jVPqNq.png"/></div></div></figure><p id="f4b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击设备菜单或设备详细信息并添加标签<code class="fe mq mr ms mt b">type: controller</code>，您可以在此处添加任何您喜欢的内容，但稍后它必须符合应用规范。</p><h1 id="6393" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">步骤5:将闪存服务部署到设备</h1><p id="5217" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">部署时，它将类似于您在Docker Compose文件中看到的内容(如果您以前使用过):</p><pre class="km kn ko kp gt nb mt nc nd aw ne bi"><span id="7377" class="nf ky iq mt b gy ng nh l ni nj">name: synpse-flash<br/>scheduling:<br/>  type: Conditional<br/>  # Selecting my device. This could be targeting hundreds or thousands<br/>  # of devices in industrial applications<br/>  selectors:<br/>    type: controller<br/>spec:<br/>  containers:<br/>    - name: classifier<br/>      # Docker image name<br/>      image: karolisr/synpse-lighning-flash:latest<br/>      # Optionally create a secret with your DockerHub password. I need this<br/>      # as my IP pulls a lot of images. This can also be used if you are using<br/>      # a private registry<br/>      auth:<br/>        username: karolisr<br/>        fromSecret: dockerPassword<br/>      # This time, we are exposing a custom port and not the default 8000<br/>      ports:<br/>        - 9950:8000</span></pre><p id="7e80" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">部署后，您可以查看应用程序状态和日志:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nq"><img src="../Images/b38664ec847fa9dcabd8cf4a76509b8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*S4Qsscjs6IJQEa6k.gif"/></div></div></figure><h1 id="d67c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">步骤6:对已部署的模型运行预测</h1><p id="1bb8" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">一种方法是在http://:9950上调用模型。但是，我想演示Synpse提供的另一个功能——您的计算机和任何边缘设备之间的TCP隧道。</p><p id="77a3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要打开代理通道，请在一个终端中运行:</p><pre class="km kn ko kp gt nb mt nc nd aw ne bi"><span id="e5c7" class="nf ky iq mt b gy ng nh l ni nj">synpse device proxy nuc 8000:9950</span></pre><p id="06bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，您可以再次运行我们的客户端进行预测，就像它在您自己的机器上运行一样:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nr"><img src="../Images/c84b4a8a7a848ce77764f0ee40b4c474.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZjRwLLV3wbEI0NJz.png"/></div></div></figure><p id="6869" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还可以看到Synpse仪表板中记录的预测:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nl"><img src="../Images/e3a0dbf4b243973439a6d8659838f524.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OcVrNm2Og6oayK86.png"/></div></div></figure><h1 id="5f4e" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">后续步骤</h1><p id="b828" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">请随意查看PyTorch Flash的其他功能，如他们的新<a class="ae lw" href="https://lightning-flash.readthedocs.io/en/latest/general/flash_zero.html" rel="noopener ugc nofollow" target="_blank"> Flash Zero </a>，它非常容易使用(在使用Tensorflow一段时间后，我真的很欣赏它的简单性)。</p><p id="0f68" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于模型培训，你绝对应该看看<a class="ae lw" href="https://grid.ai" rel="noopener ugc nofollow" target="_blank"> grid.ai </a>，那里有关于<a class="ae lw" href="https://towardsdatascience.com/hyperparameter-optimization-with-grid-ai-and-no-code-change-b89218d4ff49" rel="noopener" target="_blank">设置环境的好文章</a>，因为他们提供一些免费学分以及预装GPU依赖等内容的会话。</p></div><div class="ab cl ns nt hu nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ij ik il im in"><p id="b740" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">【https://synpse.net】最初发表于<a class="ae lw" href="https://synpse.net" rel="noopener ugc nofollow" target="_blank"><em class="mx"/></a><em class="mx">。</em></p></div></div>    
</body>
</html>