<html>
<head>
<title>Deploy Ceph, integrate with Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">部署Ceph，与Kubernetes集成</h1>
<blockquote>原文：<a href="https://itnext.io/deploy-ceph-integrate-with-kubernetes-9f88097e605?source=collection_archive---------0-----------------------#2022-02-16">https://itnext.io/deploy-ceph-integrate-with-kubernetes-9f88097e605?source=collection_archive---------0-----------------------#2022-02-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/537247825ffd1363b96334c1bf915af2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1198/format:webp/1*2Tv4AgkUyuHqtcnge66JDg.png"/></div></figure><p id="e9a0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为每个pod手动创建卷是一项困难的工作，因此Kubernetes上的存储类为我们提供了自动声明持久卷的能力。</p><p id="20f2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为此，我们应该部署Ceph、GlusterFS和其他工具。我在这里部署我们的Ceph集群，然后将它作为一个存储类逐步集成到我们的Kubernetes集群中。</p><p id="a2a4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在我的<a class="ae ks" href="https://github.com/hosein-yousefii/Ceph-Kuberentes.git" rel="noopener ugc nofollow" target="_blank"> <strong class="jw ir"> GITHUB </strong> </a>上找到这篇文章的资源库。</p><h1 id="4e9a" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">介绍</h1><p id="1d3d" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated"><strong class="jw ir">什么是Ceph？</strong> <br/> Ceph是一款开源软件定义存储解决方案，旨在满足现代企业的数据块、文件和对象存储需求。其高度可扩展的架构使其成为高增长块存储、对象存储和数据湖的新标准。Ceph提供可靠且可扩展的存储，同时将资本支出和OPEX成本控制在基本商品硬件价格范围内。</p><p id="7c2b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">什么是Ceph RBD？<br/>RADOS Block Device(RBD)是一款软件，用于在开源Ceph分布式存储系统中存储基于块的数据。</p><p id="04c3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">RBD软件将基于块的应用程序数据分解成小块。数据块随后作为对象存储在可靠的自治分布式对象存储(RADOS)中。RBD在整个Ceph存储集群中协调虚拟块设备中的对象存储。这些块设备在虚拟上相当于物理磁盘驱动器。</p><p id="66b5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">什么是StorageClass？</strong> <br/>存储类别为管理员提供了一种描述他们提供的存储“类别”的方式。</p><p id="6502" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">什么是PVC？</strong><br/>PVC是为永久存储提供特定类型和配置的请求。要指定您想要的持久存储风格，您可以使用Kubernetes存储类。</p><h1 id="9a96" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">开始部署的时间:</h1><p id="5d0a" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated"><strong class="jw ir">要求:</strong></p><p id="8a4f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">3个Ubuntu 20–04节点。<br/>每个节点上1个原始磁盘。</p><p id="dc37" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我的情况:<br/>192 . 168 . 100 . 201 ceph 1<br/>192 . 168 . 100 . 202 ceph 2<br/>192 . 168 . 100 . 203 ceph 3</p><p id="e32f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">完美地遵循这些步骤:</strong></p><p id="7c7d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">2)将这3个节点添加到每个/etc/hosts文件中:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="1dc3" class="mf ku iq mb b gy mg mh l mi mj">echo “””<br/>127.0.0.1 localhost<br/># Ceph nodes<br/>192.168.100.201 ceph1<br/>192.168.100.202 ceph2<br/>192.168.100.203 ceph3<br/>“”” &gt; /etc/hosts</span></pre><p id="fbbc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">3)设置每个节点的主机名:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="599c" class="mf ku iq mb b gy mg mh l mi mj">hostnamectl set-hostname ceph1<br/>exec bash</span></pre><p id="7e03" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">4)安装一些依赖项(在ceph1上):</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="aa0a" class="mf ku iq mb b gy mg mh l mi mj">apt -y install software-properties-common git curl vim bash-completion ansible</span></pre><p id="212c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">5)安装Cephadm(在ceph1上):</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="92be" class="mf ku iq mb b gy mg mh l mi mj">curl — silent — remote-name — location <a class="ae ks" href="https://github.com/ceph/ceph/raw/octopus/src/cephadm/cephadm" rel="noopener ugc nofollow" target="_blank">https://github.com/ceph/ceph/raw/octopus/src/cephadm/cephadm</a><br/>chmod +x cephadm<br/>mv cephadm /usr/local/bin/</span></pre><p id="6793" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">6)生成密钥并复制到您的节点(在ceph1上):</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="9619" class="mf ku iq mb b gy mg mh l mi mj">ssh-keygen<br/>ssh-copy-id root@ceph1<br/>ssh-copy-id root@ceph2<br/>ssh-copy-id root@ceph3</span></pre><p id="fcea" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">7)克隆此存储库(在ceph1上):</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="d8f2" class="mf ku iq mb b gy mg mh l mi mj">mkdir ceph<br/>cd ceph<br/>git clone <a class="ae ks" href="https://github.com/hosein-yousefii/Ceph-Kuberentes.git" rel="noopener ugc nofollow" target="_blank">https://github.com/hosein-yousefii/Ceph-Kuberentes.git</a><br/>cd Ceph-Kuberentes</span></pre><p id="ccdc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">8)更改ssh配置(在ceph1上):</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="1d0f" class="mf ku iq mb b gy mg mh l mi mj">tee -a ~/.ssh/config&lt;&lt;EOF<br/>Host *<br/> UserKnownHostsFile /dev/null<br/> StrictHostKeyChecking no<br/> IdentitiesOnly yes<br/> ConnectTimeout 0<br/> ServerAliveInterval 300<br/>EOF</span></pre><p id="e102" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">9)创建可行库存(在ceph1上):</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="f4ef" class="mf ku iq mb b gy mg mh l mi mj">echo “””<br/>[ceph_nodes]<br/>ceph1<br/>ceph2<br/>ceph3<br/>“”” &gt; hosts-inventory.yaml</span></pre><p id="b385" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">10)运行行动手册以安装软件包(在ceph1上):</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="6c1c" class="mf ku iq mb b gy mg mh l mi mj">ansible-playbook -i hosts-inventory.yaml prepare-ceph-nodes.yml — user root</span></pre><p id="7176" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">11)重新启动所有节点。</p><p id="f67b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">12)在ceph1上，通过添加节点和监视器来配置ceph集群:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="5f3c" class="mf ku iq mb b gy mg mh l mi mj">cephadm bootstrap — mon-ip 192.168.100.201 — initial-dashboard-user admin — initial-dashboard-password qazwsx</span><span id="a0f6" class="mf ku iq mb b gy mk mh l mi mj">ceph orch host add ceph2 192.168.100.202<br/>ceph orch host add ceph3 192.168.100.203</span></pre><p id="a511" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为监视器添加标签(在ceph1上):</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="b471" class="mf ku iq mb b gy mg mh l mi mj">ceph orch host label add ceph1 mon<br/>ceph orch host label add ceph2 mon<br/>ceph orch host label add ceph3 mon</span></pre><p id="38f6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">应用配置(在ceph1上):</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="2c02" class="mf ku iq mb b gy mg mh l mi mj">ceph orch apply mon ceph2<br/>ceph orch apply mon ceph3</span></pre><p id="5479" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">列出主机(在ceph1上):</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="afaa" class="mf ku iq mb b gy mg mh l mi mj">ceph orch host ls</span></pre><p id="fce9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为osd添加标签(在ceph1上):</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="90a6" class="mf ku iq mb b gy mg mh l mi mj">ceph orch host label add ceph1 osd<br/>ceph orch host label add ceph2 osd<br/>ceph orch host label add ceph3 osd</span></pre><p id="a565" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">几分钟后，您应该可以通过执行以下命令(在ceph1上)看到原始磁盘:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="88b9" class="mf ku iq mb b gy mg mh l mi mj">ceph orch device ls</span></pre><p id="bf65" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">向osd添加磁盘的时间(在ceph1上):</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="a256" class="mf ku iq mb b gy mg mh l mi mj">ceph orch daemon add osd ceph1:/dev/sdb<br/>ceph orch daemon add osd ceph2:/dev/sdb<br/>ceph orch daemon add osd ceph3:/dev/sdb</span></pre><p id="dc86" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">13)等待直到所有docker容器在所有节点上启动并运行:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="0073" class="mf ku iq mb b gy mg mh l mi mj">docker ps</span></pre><p id="db99" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">14)然后您将能够在Ceph dashboard上找到您的磁盘。<a class="ae ks" href="https://ceph1:8443" rel="noopener ugc nofollow" target="_blank"> https://ceph1:8443 </a></p><p id="8f0a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">15)为kubernetes创建一个池(在ceph1上):</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="9279" class="mf ku iq mb b gy mg mh l mi mj">ceph osd pool create k8s<br/>rbd pool init k8s</span></pre><p id="3a63" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">16)创建一个用户从kubernetes(在ceph1上)访问Ceph集群:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="3f5f" class="mf ku iq mb b gy mg mh l mi mj">ceph auth get-or-create client.kube mon ‘profile rbd’ osd ‘profile rbd pool=k8s’ mgr ‘profile rbd pool=k8s’</span></pre><p id="19b8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">17)查找您的显示器IP地址(在ceph1上):</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="6100" class="mf ku iq mb b gy mg mh l mi mj">ceph mon dump</span></pre><p id="a569" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">18)找到您的Ceph集群ID(在ceph1上):</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="f236" class="mf ku iq mb b gy mg mh l mi mj">ceph -s</span></pre><p id="7019" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">19)登录到您的kubernetes集群或您可以访问kubectl的地方，然后复制或克隆*。yaml文件到它。</p><p id="8f78" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">20)根据您的Ceph集群监视器和ID更改csi-config-map.yaml。</p><p id="25cc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">21)根据稍后在ceph1上为kubernetes集群创建的用户和密钥，更改csi-rbd-secret.yaml</p><p id="fe98" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">22)根据您的ceph集群ID和池名称(k8s)更改csi-rbd-sc.yaml</p><p id="9d6f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">23)部署清单:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="9019" class="mf ku iq mb b gy mg mh l mi mj">kubectl apply -f csi-config-map.yaml<br/>kubectl apply -f csi-kms-config-map.yaml<br/>kubectl apply -f ceph-config-map.yaml<br/>kubectl apply -f csi-rbd-secret.yaml<br/>kubectl apply -f <a class="ae ks" href="https://raw.githubusercontent.com/ceph/ceph-csi/master/deploy/rbd/kubernetes/csi-provisioner-rbac.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/ceph/ceph-csi/master/deploy/rbd/kubernetes/csi-provisioner-rbac.yaml</a><br/>kubectl apply -f <a class="ae ks" href="https://raw.githubusercontent.com/ceph/ceph-csi/master/deploy/rbd/kubernetes/csi-nodeplugin-rbac.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/ceph/ceph-csi/master/deploy/rbd/kubernetes/csi-nodeplugin-rbac.yaml</a><br/>kubectl apply -f csi-rbdplugin-provisioner.yaml<br/>kubectl apply -f csi-rbdplugin.yaml<br/>kubectl apply -f csi-rbd-sc.yaml</span></pre><p id="4c84" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">24)检查csi pods是否正在运行:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="55a7" class="mf ku iq mb b gy mg mh l mi mj">kubectl get po</span></pre><p id="c41f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">25)创建一个PVC以检查存储类是否正常运行:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="3df1" class="mf ku iq mb b gy mg mh l mi mj">kubectl apply -f raw-block-pvc.yaml<br/>kubectl apply -f fs-pvc.yaml</span></pre><p id="51bd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">这就是你要做的一切。尽情享受吧！</strong></p><p id="413c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如有任何问题，请与我联系。</p></div></div>    
</body>
</html>