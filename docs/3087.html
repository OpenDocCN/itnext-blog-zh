<html>
<head>
<title>Using HTTP/2 with Next.js &amp; Express</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用HTTP/2和Next.js &amp; Express</h1>
<blockquote>原文：<a href="https://itnext.io/using-http-2-with-next-js-express-917791ca249b?source=collection_archive---------1-----------------------#2019-10-01">https://itnext.io/using-http-2-with-next-js-express-917791ca249b?source=collection_archive---------1-----------------------#2019-10-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/63637d94a622d392131c53f0060d0480.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-gTIBRleuE7zvFrGMJAmmw.png"/></div></div></figure><h2 id="5e5c" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated"><strong class="ak">关于HTTP/2 </strong></h2><p id="d165" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated">HTTP/2或H2是万维网使用的HTTP协议的主要修订版。它基于Google开发的实验协议SPDY，旨在加速客户机和服务器之间的互联网交换。<br/>所有主流浏览器都支持HTTP/2已经好几年了，你可以在<a class="ae lp" href="https://caniuse.com/#feat=http2" rel="noopener ugc nofollow" target="_blank">上看到我能使用</a>。2019年，大多数GAFA/NATU现代SAAS创业公司已经将它用于其产品和服务(截至2019年9月，前1000万网站中有41.0%支持HTTP/2)。</p><p id="e0ad" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated">谷歌和IETF甚至已经在研究基于UDP的协议QUIC，最近被重新命名为HTTP/3或H3。Chrome和Mozilla Firefox已经支持它，但现在让我们把注意力集中在H2上。</p><h2 id="41c3" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated"><strong class="ak">HTTP/2的优势</strong></h2><p id="6946" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated">在大多数情况下，HTTP/2比HTTP/1.1要快得多，谷歌强烈推荐它进行性能和SEM优化，正如你在<a class="ae lp" href="https://developers.google.com/web/tools/lighthouse/" rel="noopener ugc nofollow" target="_blank"> Lighthouse </a>中看到的。其原因是:</p><ul class=""><li id="fe43" class="lv lw iq kw b kx lq lb lr kh lx kl ly kp lz lo ma mb mc md bi translated"><strong class="kw ir"> HTTP/2是TCP上的二进制协议，</strong>因此数据传输比基于文本的协议(如HTTP/1.1)更紧凑，更不容易出错</li><li id="50db" class="lv lw iq kw b kx me lb mf kh mg kl mh kp mi lo ma mb mc md bi translated"><strong class="kw ir"> HTTP/2是多路复用的，</strong>这意味着它支持单个连接上的多个请求，从而减少了服务器和客户端之间的握手操作。HTTP/1.1被限制为每个连接只能有一个请求。</li><li id="9284" class="lv lw iq kw b kx me lb mf kh mg kl mh kp mi lo ma mb mc md bi translated"><strong class="kw ir"> HTTP/2使用defacto报头压缩，</strong>使用<a class="ae lp" href="https://tools.ietf.org/html/rfc7541" rel="noopener ugc nofollow" target="_blank"> HPACK </a>作为有效表示HTTP报头的压缩格式。</li><li id="f87f" class="lv lw iq kw b kx me lb mf kh mg kl mh kp mi lo ma mb mc md bi translated"><strong class="kw ir"> HTTP/2引入了HTTP/2-Push，</strong>，它允许服务器自动将页面所需的资源推送到客户端缓存，而无需客户端发出额外的请求。</li></ul><h2 id="3e6d" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated"><strong class="ak">next . js&amp;Express怎么样？</strong></h2><p id="eab0" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated"><strong class="kw ir"> Node.js </strong>在其2017年7月的第8版中通过<code class="fe mj mk ml mm b">http2</code>内置包引入了原生HTTP/2支持，作为一个实验性的特性，并作为一个稳定的特性进入Node.js 10 LTS。</p><p id="536f" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated"><strong class="kw ir"> Next.js </strong>是一个著名的服务器端渲染框架，使用Node.js和React来制作快速、预渲染和优化的基于React的网站或web应用。不幸的是，从第9版开始，Next.js还不支持HTTP/2。</p><p id="5ec8" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated">我们的HTTP/2解决方案将使用Next.js的功能来定义一个定制的后端应用程序:</p><ul class=""><li id="4241" class="lv lw iq kw b kx lq lb lr kh lx kl ly kp lz lo ma mb mc md bi translated">使用<code class="fe mj mk ml mm b">express</code>拥有灵活的路由框架</li><li id="cd63" class="lv lw iq kw b kx me lb mf kh mg kl mh kp mi lo ma mb mc md bi translated">与<code class="fe mj mk ml mm b">spdy</code>结合产生一个HTTP/2服务器</li></ul><p id="c19c" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated">除了它的名字，<code class="fe mj mk ml mm b">spdy</code>包提供对HTTP/2 (H2)和spdy (2，3，3.1)的支持，与Express兼容，并为常规https提供自然的<code class="fe mj mk ml mm b">http </code>模块接口和后备。</p><h2 id="1974" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated"><strong class="ak">让我们深入实施</strong></h2><p id="6779" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated">以下是我们将要采取的步骤:</p><ul class=""><li id="59d9" class="lv lw iq kw b kx lq lb lr kh lx kl ly kp lz lo ma mb mc md bi translated">1.设置项目，并用两个简单的页面创建前端</li><li id="828a" class="lv lw iq kw b kx me lb mf kh mg kl mh kp mi lo ma mb mc md bi translated">2.生成本地开发SSL证书</li><li id="3068" class="lv lw iq kw b kx me lb mf kh mg kl mh kp mi lo ma mb mc md bi translated">3.用next.js + express + spdy创建自定义后端</li></ul><ol class=""><li id="5b55" class="lv lw iq kw b kx lq lb lr kh lx kl ly kp lz lo mn mb mc md bi translated"><strong class="kw ir">设置项目&amp;前端<br/> </strong>首先初始化一个npm包并创建一个next.js应用程序，其中包含两个基本静态页面:</li></ol><pre class="mo mp mq mr gt ms mm mt mu aw mv bi"><span id="1bd2" class="jy jz iq mm b gy mw mx l my mz">mkdir next-express-h2-app<br/>cd next-express-h2-app<br/>npm init<br/>npm install next react react-dom express spdy compression --save<br/>npm install cross-env --save-dev</span></pre><p id="899b" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated">创建一个<code class="fe mj mk ml mm b">pages</code>文件夹，里面有两个文件，index.js和about.js</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="na nb l"/></div></figure><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="24d8" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated"><strong class="kw ir"> 2。生成本地开发SSL证书<br/> </strong>由于没有哪种主流浏览器支持不加密的HTTP/2，所以即使是开发也需要生成本地SSL证书。用OpenSSL做到这一点相当简单。</p><p id="0723" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated">移动到项目的根目录，使用该命令生成两个文件，我们将使用这两个文件来运行开发中的服务器:</p><pre class="mo mp mq mr gt ms mm mt mu aw mv bi"><span id="b52b" class="jy jz iq mm b gy mw mx l my mz">openssl req -x509 -newkey rsa:2048 -nodes -sha256 -keyout privateKey.key -out certificate.crt</span></pre><p id="3419" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated"><strong class="kw ir"> 3。创建自定义后端<br/> </strong>现在在项目的根目录下创建一个<code class="fe mj mk ml mm b">server.js</code>文件，并从生成一个经典的Next.js应用程序开始:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="a48c" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated">然后配置您的私钥和证书，我们很快会将它们配置到<code class="fe mj mk ml mm b">spdy</code>中:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="1860" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated">我们现在将使用<code class="fe mj mk ml mm b">compression</code>包来设置请求体的压缩。HTTP/2提供了对HTTP头压缩的本机支持，但通常也压缩请求的正文是一个好的做法，因为它通常由文本或可压缩数据组成:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="3c64" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated">然后我们将使用Next.js API来准备应用程序，并用它来设置<code class="fe mj mk ml mm b">express</code>和<code class="fe mj mk ml mm b">spdy</code>:</p><pre class="mo mp mq mr gt ms mm mt mu aw mv bi"><span id="1717" class="jy jz iq mm b gy mw mx l my mz">app.prepare().then(() =&gt; {<br/>  // express setup<br/>  // spdy setup<br/>}</span></pre><p id="72fa" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated">对于<code class="fe mj mk ml mm b">express</code>配置，我们将在本例中使用一个相当简单的路由策略，但使用<code class="fe mj mk ml mm b">express</code>的意义在于，您显然可以根据自己的需求使用更高级的快速路由策略和快速功能:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="a92e" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated">最后，我们配置<code class="fe mj mk ml mm b">spdy</code>服务器:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="na nb l"/></div></figure><h2 id="a1b0" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">结论</h2><p id="094b" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated">现在，您可以使用npm脚本运行您的应用程序:</p><ul class=""><li id="d3df" class="lv lw iq kw b kx lq lb lr kh lx kl ly kp lz lo ma mb mc md bi translated">首先，用<code class="fe mj mk ml mm b">npm run build</code>构建它</li><li id="fe9b" class="lv lw iq kw b kx me lb mf kh mg kl mh kp mi lo ma mb mc md bi translated">并从<code class="fe mj mk ml mm b">npm run dev</code>开始</li></ul><p id="eab6" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated">如果您想用生产优化版本测试它，只需用</p><ul class=""><li id="a3d9" class="lv lw iq kw b kx lq lb lr kh lx kl ly kp lz lo ma mb mc md bi translated"><code class="fe mj mk ml mm b">npm run release</code></li><li id="8fb0" class="lv lw iq kw b kx me lb mf kh mg kl mh kp mi lo ma mb mc md bi translated"><code class="fe mj mk ml mm b">npm run start</code></li></ul><p id="d8c1" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated">在<code class="fe mj mk ml mm b">https://localhost:3000</code>上打开你的chrome开发者控制台，你会看到用于提供内容的协议现在显示为<code class="fe mj mk ml mm b">h2</code>:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/c479683249f7a0743c408addf12f1bf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jiZpnL4SCvmMsmfs_lTWlQ.jpeg"/></div></div></figure><p id="eab1" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated">完整代码可在此处找到:</p><div class="nd ne gp gr nf ng"><a href="https://github.com/typedef42/nextjs-express-http2-example" rel="noopener  ugc nofollow" target="_blank"><div class="nh ab fo"><div class="ni ab nj cl cj nk"><h2 class="bd ir gy z fp nl fr fs nm fu fw ip bi translated">typedef 42/nextjs-express-http 2-示例</h2><div class="nn l"><h3 class="bd b gy z fp nl fr fs nm fu fw dk translated">下载示例:git clone https://github . com/typedef 42/nextjs-express-http 2-example . git CD…</h3></div><div class="no l"><p class="bd b dl z fp nl fr fs nm fu fw dk translated">github.com</p></div></div><div class="np l"><div class="nq l nr ns nt np nu jw ng"/></div></div></a></div><p id="bd5c" class="pw-post-body-paragraph ku kv iq kw b kx lq kz la lb lr ld le kh ls lg lh kl lt lj lk kp lu lm ln lo ij bi translated"><em class="nv">感谢</em> <a class="ae lp" href="https://medium.com/@chabou_82202" rel="noopener"> <em class="nv"> @chabou </em> </a> <em class="nv">和@</em><a class="nw nx ep" href="https://medium.com/u/ea339d23b0b?source=post_page-----917791ca249b--------------------------------" rel="noopener" target="_blank"><em class="nv">Jule Marcoueille</em></a><em class="nv">回顾这个故事。</em></p></div></div>    
</body>
</html>