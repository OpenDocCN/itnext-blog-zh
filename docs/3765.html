<html>
<head>
<title>Kubernetes Multi-Cloud and Multi-Cluster Connectivity with Submariner — Test CockroachDB Geo-Distribution/Geo-Replication</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes与Submariner的多云和多集群连接—测试CockroachDB地理分布/地理复制</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-multi-cloud-and-multi-cluster-connectivity-with-submariner-test-cockroachdb-b79662209bd7?source=collection_archive---------1-----------------------#2020-02-20">https://itnext.io/kubernetes-multi-cloud-and-multi-cluster-connectivity-with-submariner-test-cockroachdb-b79662209bd7?source=collection_archive---------1-----------------------#2020-02-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/50ac17e8d995d39a43d63d804330743a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UyZPC3T4gbdfJWsoGGUDmw.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">通过IPsec实现跨云和跨集群互连— Submariner —测试跨区域和跨云的CockroachDB地理复制</figcaption></figure><div class=""/><p id="e934" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">基于Kubernetes平台的最初趋势是构建大型多租户Kubernetes集群。现在，越来越普遍的做法是构建特定于一个区域/云甚至同一数据中心的单个集群，以实现多区域分区、可用性、全球分布、边缘功能、减少供应商依赖性、供应商特定功能的优势等。在不同的地理区域复制和分布基础架构是相对常见的，特别是在受监管的环境中，以满足具有较低延迟的内容。</p><p id="b57e" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">无论Kubernetes集群是如何部署的，跨集群网络在多集群或多云部署策略的成功中起着至关重要的作用。</p><p id="4fcc" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><a class="ae la" href="https://submariner.io/" rel="noopener ugc nofollow" target="_blank"> Rancher的潜艇</a>可用于通过第三层网络连接集群，促进集群间的通信。Submariner在Kubernetes集群之间创建必要的隧道和路线，允许直接连接，而不管它们的位置是在本地还是在云中。Submariner不是服务网格。它仅提供第3层网络连接。它与Istio等服务网格相集成，可以提供跨集群网络，这是共享控制平面(单一网络)等特定部署模式所必需的。</p><h1 id="c5cd" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">试用配置/拓扑</h1><p id="13d6" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">下面的拓扑包含五个不同/独立的Kubernetes集群，跨越多个云提供商的多个区域:AWS、Oracle、Vultr、Packet、Civo，并具有不同的pod和服务子网。所有集群都单独安装在具有法兰绒CNI的虚拟机上(可以部署在具有任何CNI的环境中)。Submariner可以安装在云提供商特定的Kubernetes服务上，如EKS、AKS、Civo的托管K3s等。唯一的要求是为标有节点的网关提供一个公共/弹性ip。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi me"><img src="../Images/e50154fd53c01eca4ba1289c256acdf0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xUTc6qPzPH4WcUjp"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">不同公共云提供商上的Kubernetes集群</figcaption></figure><p id="206a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">下面显示的是云提供商和部署上述集群的各个区域。所有群集都有可公开访问的IP。在这种情况下，可以根据群集和连接的空间设置修改拓扑。每个集群可以有多个节点，用户可以标记特定的节点，使其成为潜艇网关，只有启用网关的节点才需要公共IP。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi me"><img src="../Images/588ab38d03be430d0fe4eb663438c4da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HTZYGspflW0l9cWh"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Kubernetes集群— Vultr、Civo、Packet</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi me"><img src="../Images/879728223aef1b57f8c4032f8083bbd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mUDe6kIjpOlyXD_J"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Kubernetes集群— AWS、Oracle</figcaption></figure><p id="f0e0" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">每个集群都有唯一的Pod和服务CIDR，并带有独特的DNS后缀，如下所示:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi me"><img src="../Images/5fa53a47691a2e6e642b272106944b8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZlSxMdK-h5zKuVSS"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">群集特定的网络信息</figcaption></figure><h1 id="40c1" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">潜艇的多集群连接</h1><p id="c497" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">Submariner可以部署在具有任何CNI的环境中，并利用现成的组件(如strongSwan/Charon)在每个Kubernetes集群之间建立IPsec隧道。Charon是一个IPsec IKEv2守护程序，它可以充当发起方(发起IKE VPN隧道协商请求的设备)或响应方(接收建立IKE VPN隧道请求的设备)。默认情况下，Charon使用正常的重新传输机制和超时来检查对等体的活性。</p><p id="d111" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Submariner可以通过L3网络连接集群，至少需要3个Kubernetes集群。从技术上讲，可以部署在两个集群上，其中一个集群可以被选为“代理”，但这不会弹性地扩展到两个集群之外，因为同时充当代理和网关的集群中的故障会导致网络中断。Submariner可以部署到现有的Kubernetes集群中，并在不同集群中的pod之间添加第3层网络连接。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mj"><img src="../Images/fc35097543804cd53ca297cb6ce52d42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jJB9jqFQfNVXthnC"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">潜艇兵——建筑</figcaption></figure><p id="372f" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">组件:</p><h1 id="7457" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">经纪人(CRD的)</h1><p id="0808" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">代理是一个Kubernetes集群，需要CRD来将集群信息存储在其etcd中，该集群仅保存集群资源定义:<em class="mk"> clusters.submariner.io </em>和<em class="mk"> endpoints.submariner.io </em>，后者定义了submariner的其他集群部分。Submariner网关利用代理在集群之间交换连接信息的元数据信息，并将本地集群信息更新到中央代理中。</p><p id="e9ad" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">每个启用了Submariner的集群都使用服务帐户令牌和代理集群API信息加入代理。如下所示，代理集群在“submariner-k8s-broker”命名空间中存储没有其他Submariner组件的CRD。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi me"><img src="../Images/27dd8600bdf50108d5772ba78131667b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*H1pnWLWKBVyLW4FH"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">代理群集-自定义资源定义</figcaption></figure><p id="0e40" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">每个对象类型“群集”包含群集特定的Pod和服务子网信息。在IPsec术语中，特定Kubernetes集群(在IPsec配置中用作左右子网)后面的LAN的网络地址，在本例中是由CNI-法兰绒提供的覆盖网络。</p><p id="8778" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">对于上面显示的拓扑，有四个集群对象(不包括代理):</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi me"><img src="../Images/89f15ad94b02f80562b25834608105ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BlLD9mXipR2EtLJU"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">代理集群—集群对象</figcaption></figure><p id="d1bd" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">每个群集对象都包含有关群集网络信息(Pod和服务子网)和cluster_id(在IPsec配置中用作左id和右ID)的信息:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ml"><img src="../Images/91f98997b3c41c8293bb9cc3e201d985.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-BLDiuS-2Zgc2BGh"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">代理集群—集群配置</figcaption></figure><p id="aea9" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">每个对象类型“端点”保存群集的公共地址(传统IPsec配置中的“左”和“右”声明)。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi me"><img src="../Images/5c41bb0659ae090429016c551f8a88d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KUbmwgDM4hyQfkDo"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">代理群集—端点对象</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mm"><img src="../Images/36079538e61b5470d914c00888406083.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5YJatkWN5ETaRnj2"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">代理群集—端点配置</figcaption></figure><p id="e08a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">代理还拥有集群成员资格所需的其他秘密:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi me"><img src="../Images/4874fe3945c54f93d152d61945cd16c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-AlMDLJ-Del5ZXTO"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">代理集群-秘密</figcaption></figure><p id="3d3a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><em class="mk"> datastoresyncer </em>作为领导者选举的submariner pod内的控制器运行，并负责执行数据存储和Submariner CRDs的本地集群之间的双向同步。<em class="mk"> datastoresyncer </em>只会将CRD数据推送到本地集群的中央代理(基于集群ID)，并在数据与本地集群不匹配时将所有数据从代理同步到本地集群(以防止循环)。</p><p id="787e" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">所有其他部署了潜艇的Kubernetes集群也拥有与代理同步的CRD以上版本。这些集群包含一个网关、路由代理和一个操作员(如果使用<a class="ae la" href="https://github.com/submariner-io/submariner#installation-using-operator" rel="noopener ugc nofollow" target="_blank"> subctl </a>部署Submariner)。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/89c5222cee524bdbbe0555a2fc6e8ea1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/0*YeXTMvxziJgigivh"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">潜艇——Kubernetes组件</figcaption></figure><h1 id="e159" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">潜艇通道(DaemonSet)</h1><p id="8171" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">网关荚在主机网络上的所有网关标记的节点上运行，并且在多个网关标记的节点之间执行领导者选举以选举活动的IPsec端点。在启动和失败时，被选为领导者的submariner-gateway pod将执行协调过程，以确保它是该集群的唯一端点，并且远程集群将协调IPsec端点和新端点，并且将相应地重新建立连接。这个实体运行charon守护进程。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mo"><img src="../Images/3886e6f8ef26559598e77149de4ea05e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YBv8GFIRXJX7Uobi"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">潜艇——网关引擎</figcaption></figure><p id="ec21" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">网关不断从代理集群轮询存储为CRD的任何新集群信息(代理连接信息-在创建网关时提供url)以配置端点(ipsec-peers):</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi me"><img src="../Images/7abbddc0031d117bc6a72c3b00acc1b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LAqlfpHsItlgzqWe"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Submariner —网关引擎与代理的交互</figcaption></figure><p id="10cb" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">按照规定，每个submariner引擎使用API服务器令牌加入代理，如下所示:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi me"><img src="../Images/c41907f885282041c294addca32b5d00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GWZui2QpMdkZpPHm"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Submariner —网关引擎—代理</figcaption></figure><h1 id="1e2a" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">潜航员-航线-代理人</h1><p id="7dfb" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">submariner-route-agent被部署为daemonset(在每个节点上运行),并且知道集群上当前活动的网关。在活动网关节点上运行的路由代理创建VXLAN VTEP接口，通过建立与活动网关节点的VTEP的VXLAN隧道，在其他工作节点上运行的submariner-route-agent实例连接到该接口。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/9e76fbe06c9cb3ea59b1814aa61f6e96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bIcuM2SrpLdr7g4E"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">潜航员——航线代理人</figcaption></figure><p id="0797" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Submariner-route-agent还配置路由，并对必要的iptable规则进行编程，以实现与远程集群的完全连接。Submariner VXLAN隧道的MTU是根据主机上默认接口的MTU减去VXLAN开销来配置的。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mq"><img src="../Images/29b5b7abbd4832f4df9f6b2d9215435d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vNabk8jlqXkcPXYM"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">潜航员—航线代理— VXLAN</figcaption></figure><p id="c4ef" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">从这个场景中提取拓扑，所需的iptables由潜艇艇员编程。每个集群pod和子网CIDR的编程如下所示:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/4de782a9c5252aa660938237e50e565b.png" data-original-src="https://miro.medium.com/v2/resize:fit:786/0*Lymtj4gJjkGAsWqD"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">潜航员—编程iptables</figcaption></figure><p id="5394" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">两个集群之间的所有流量都将通过ip xfrm规则在(每个集群中)选出的主网关节点之间传输。每个网关节点都有一个正在运行的Charon守护进程，它将执行IPsec密钥和策略管理。xfrm是一个IP框架，用于转换数据包(比如加密它们的有效载荷)。该框架用于实现IPsec协议组(状态对象在安全关联数据库上操作，策略对象在安全策略数据库上操作)。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi me"><img src="../Images/dece4f13c21c21685f93ba47f939abe3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mLpAg_FOt1dU_I6D"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">潜航员— xfrm</figcaption></figure><h1 id="90ce" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用潜艇连接集群测试CockroachDB的地理分布/地理复制</h1><p id="dfc6" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">通过在所有集群(London-Civo、Ashburn-Oracle、Oregon-AWS和Tokyo-Packet)上部署Submariner，可以访问跨集群的所有pod和服务子网，并且流量通过互联网上的IPsec进行隧道传输。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ms"><img src="../Images/6fced863aeac5d99f2d3fdbb32ae96df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-64Wtp_UHSoa8dlE"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">潜艇—跨集群连接— IPsec</figcaption></figure><p id="1572" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">CockroachDB支持地理分区，这允许将用户数据保存在用户附近，从而减少数据需要传输的距离，从而减少延迟并改善用户体验。cocroach db架构的复制层在节点之间复制数据，并确保这些副本之间的一致性，在这个场景中，跨上面指定的使用Submariner互连的Kubernetes集群部署多集群cocroach db(一个集群化的cocroach db)。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi me"><img src="../Images/13d4f0b197882feb49bb08eaf49b6361.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SytcOx3Vpxc4-Z2h"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">跨地区、跨云平台的CockroachDB</figcaption></figure><p id="bd56" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">拓扑中的每个集群都包含三个部署为statefulset的CockroachDB副本，具有不同的Pod和服务IP，如上所示。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mt"><img src="../Images/ad12cbdd9e7b2bdbe2cdcdf6da8c199d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qeAJmtwftfEgHs1C"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Kubernetes集群上的CockroachDB</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mu"><img src="../Images/5f9b8ae83e54494438168152f1fb8a50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PFnxClaRXtoL_RQf"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Kubernetes集群上的CockroachDB</figcaption></figure><p id="51a2" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">集群智能CockroachDB寻址:</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mv"><img src="../Images/5a16e08f291013ae0b9186b396ca8a94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Vkqdm3fvE1Hzkdoz"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">cocroach db—特定于群集的网络信息</figcaption></figure><p id="1ef8" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">由于所有集群都是使用Submariner相互连接的，CockroachDB是全局集群化的，其中写入任何区域的数据都分布在各个集群中。所有数据库pod都通过IPsec互连。如下图所示，london-cluster上的cocroach db与Ashburn、Tokyo和Oregon上的所有其他CockroachDB pods都有入站/出站连接。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mw"><img src="../Images/5a6f8f3475e51795b10aecc9012a2056.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WJH1wbAdwAwFhuzC"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">通过互联网与跨集群副本进行交互</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mx"><img src="../Images/55079526f233e9de8994aea1d058c4dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fck8TSEqypMNjjj-"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">通过互联网与跨集群副本进行交互</figcaption></figure><h1 id="1ee9" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">跨集群服务的DNS解析</h1><p id="1cce" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">在这种情况下，可以通过多种方式启用服务解析。Submariner计划使用<a class="ae la" href="https://github.com/submariner-io/lighthouse" rel="noopener ugc nofollow" target="_blank"> Lighthouse </a>(仍在开发中):中央发现控制器，它从集群中收集信息，决定要共享哪些信息，并将信息作为新定义的CRD进行分发。在上面的场景中，这是使用<a class="ae la" href="https://coredns.io/plugins/forward/" rel="noopener ugc nofollow" target="_blank"> CoreDNS-Forward </a>插件完成的，该插件要求每个集群上的“CoreDNS”服务公开为负载平衡器或节点端口。由于集群之间的服务子网是可达的，用户也可以将转发配置直接发送到coredns服务IP。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi me"><img src="../Images/63e0883b991208255d4a730e90ef57eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gzN_NQCr7vLZnJab"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CoreDNS —用于跨集群DNS解析的转发插件</figcaption></figure><h1 id="91e4" class="lb lc jf bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">多集群、多云和地理复制CockroachDB</h1><p id="bcd6" class="pw-post-body-paragraph kc kd jf ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">集群之间的互连使CockroachDB能够通过互联网进行全球集群。如果用户提供SQL查询-读取，那么CockroachDB可以使用附近的副本承租人进行响应，并且任何写入都将在所有集群中复制。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi my"><img src="../Images/cd9ed870a182b4e80b56733532f32938.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*u-XhDnPeix2clIhY"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">跨云平台的CockroachDB节点形成了一个地理分布式集群</figcaption></figure><p id="d1e1" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如上所示，访问dashboard服务会显示来自跨云和跨区域的不同Kubernetes集群的集群节点。</p><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/cfcc2bc3b3d942e888727612af4d444c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SXIi3txy6Wu6dpC-"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">跨云平台的CockroachDB节点形成了一个地理分布式集群</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi na"><img src="../Images/6a3289316bfe34b1dcff2520cd9194b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qRJSFa8UrtNSLE8U"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CockroachDB节点—延迟信息</figcaption></figure><figure class="mf mg mh mi gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nb"><img src="../Images/8f65b2e724cb7c59edfcd27c347a4616.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*X7KtWwBKNxeAY8pT"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">地理分布和地理复制的CockroachDB</figcaption></figure><p id="5320" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">面向应用的多云和多集群架构是云计算的必然趋势。随着用户跨集群和云部署应用和服务，跨集群网络连接成为应用部署的基本要求。跨集群网络连接简化了应用部署，因为运营商不再需要在应用组件之间设置复杂的网络路由或负载平衡器规则。像Submariner这样的解决方案可以通过实现不同Kubernetes集群中的pods和服务之间的直接联网来简化跨集群联网，并且还可以在战略边缘计划中发挥重要作用。</p></div></div>    
</body>
</html>