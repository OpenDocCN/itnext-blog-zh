<html>
<head>
<title/>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1/>
<blockquote>原文：<a href="https://itnext.io/how-to-integrate-aws-secret-manager-to-azure-devops-pipeline-1aafd59f4869?source=collection_archive---------0-----------------------#2020-02-14">https://itnext.io/how-to-integrate-aws-secret-manager-to-azure-devops-pipeline-1aafd59f4869?source=collection_archive---------0-----------------------#2020-02-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="ae33" class="io ip iq bd ir is it dn iu iv iw dp ix iy iz ja jb jc jd je jf jg jh ji jj jk bi translated"><strong class="ak">如何将AWS Secret Manager集成到Azure DevOps管道中</strong></h2><p id="be1c" class="pw-post-body-paragraph jl jm iq jn b jo jp jq jr js jt ju jv iy jw jx jy jc jz ka kb jg kc kd ke kf ij bi translated">你想使用AWS secret manager来存储你的秘密，但是如果你需要在其他地方使用这些秘密值，比如GCP，Azure，该怎么办呢？<br/> <br/>在本文中，我将向您展示如何将Azure DevOps管道集成到AWS secret manager中，以使用Azure管道中的那些秘密值。</p><h2 id="646c" class="io ip iq bd ir is it dn iu iv iw dp ix iy iz ja jb jc jd je jf jg jh ji jj jk bi translated">先决条件</h2><p id="3af8" class="pw-post-body-paragraph jl jm iq jn b jo jp jq jr js jt ju jv iy jw jx jy jc jz ka kb jg kc kd ke kf ij bi translated">您需要有一个Azure DevOps帐户和一个AWS帐户。</p></div><div class="ab cl kg kh hu ki" role="separator"><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl"/></div><div class="ij ik il im in"><h2 id="5597" class="io ip iq bd ir is it dn iu iv iw dp ix iy iz ja jb jc jd je jf jg jh ji jj jk bi translated">在AWS Secret Manager中存储机密</h2><p id="16de" class="pw-post-body-paragraph jl jm iq jn b jo jp jq jr js jt ju jv iy jw jx jy jc jz ka kb jg kc kd ke kf ij bi translated">搜索秘密管理器并点击“存储新秘密”你有三个选择:</p><p id="dfbd" class="pw-post-body-paragraph jl jm iq jn b jo kn jq jr js ko ju jv iy kp jx jy jc kq ka kb jg kr kd ke kf ij bi translated">1.RDS数据库的凭据</p><p id="d1c2" class="pw-post-body-paragraph jl jm iq jn b jo kn jq jr js ko ju jv iy kp jx jy jc kq ka kb jg kr kd ke kf ij bi translated">2.其他数据库的凭据</p><p id="cbcd" class="pw-post-body-paragraph jl jm iq jn b jo kn jq jr js ko ju jv iy kp jx jy jc kq ka kb jg kr kd ke kf ij bi translated">3.其他类型的秘密。</p><p id="2371" class="pw-post-body-paragraph jl jm iq jn b jo kn jq jr js ko ju jv iy kp jx jy jc kq ka kb jg kr kd ke kf ij bi translated">对于本教程，我们将采用第三个选项。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ks"><img src="../Images/304a09e179c0ea7bcfd0348d9023b2e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9lUwNXDduxlILvBtk1VgcQ.png"/></div></div></figure><p id="bb42" class="pw-post-body-paragraph jl jm iq jn b jo kn jq jr js ko ju jv iy kp jx jy jc kq ka kb jg kr kd ke kf ij bi translated">在密钥/值部分输入你的秘密，点击下一步，为“秘密名称”添加一个有意义的名称我们将使用这个名字来检索azure管道中的秘密。其他选项是可选的，您可以继续。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi le"><img src="../Images/0e5813c35f45e138f1954c6a17460bc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ptyb097nyLXFHtDFoYYkyA.png"/></div></div></figure><p id="5c91" class="pw-post-body-paragraph jl jm iq jn b jo kn jq jr js ko ju jv iy kp jx jy jc kq ka kb jg kr kd ke kf ij bi translated">然后点击下一步，你可以在列表中看到你的新秘密。现在我们的秘密是安全的，由AWS secret manager加密。</p><h2 id="d364" class="io ip iq bd ir is it dn iu iv iw dp ix iy iz ja jb jc jd je jf jg jh ji jj jk bi translated">创建一个IAM用户并对其应用secret manager读/写策略</h2><p id="e1e9" class="pw-post-body-paragraph jl jm iq jn b jo jp jq jr js jt ju jv iy jw jx jy jc jz ka kb jg kc kd ke kf ij bi translated">为了从Azure DevOps管道中检索机密，我们需要创建一个具有secret manager策略访问权限的IAM用户。</p><p id="7717" class="pw-post-body-paragraph jl jm iq jn b jo kn jq jr js ko ju jv iy kp jx jy jc kq ka kb jg kr kd ke kf ij bi translated">填写名称，并为访问类型选择<strong class="jn lf">编程访问。</strong></p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi lg"><img src="../Images/e48ccfc363878c81fab02d4f0f35d8b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3ZicjbhG_bFTz9ZADjwCWg.png"/></div></div></figure><p id="7540" class="pw-post-body-paragraph jl jm iq jn b jo kn jq jr js ko ju jv iy kp jx jy jc kq ka kb jg kr kd ke kf ij bi translated">为了简单起见，我们可以选择<code class="fe lh li lj lk b"><strong class="jn lf">Attach existing policies directly</strong></code>作为权限。用户应该能够从秘密管理器中读取和写入，因此我们将分配<code class="fe lh li lj lk b"><strong class="jn lf">SecretsManagerReadWrite</strong></code>策略。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ll"><img src="../Images/8cfb95842d210bce8b0b5eb2aa6ec630.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iA-pgdCKo7oaOeLr-Fbw1A.png"/></div></div></figure><p id="dae0" class="pw-post-body-paragraph jl jm iq jn b jo kn jq jr js ko ju jv iy kp jx jy jc kq ka kb jg kr kd ke kf ij bi translated">这一步之后，你可以选择一些有意义的标签，也可以跳过。查看更改并创建用户。</p><p id="3954" class="pw-post-body-paragraph jl jm iq jn b jo kn jq jr js ko ju jv iy kp jx jy jc kq ka kb jg kr kd ke kf ij bi translated">在这一步中，您需要记下访问密钥和秘密密钥以备将来使用。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi lm"><img src="../Images/8faa7caa27c9240fcaa7e85718a1354d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5uMe7YTAPRdAht9w33l2Mg.png"/></div></div></figure><h2 id="221d" class="io ip iq bd ir is it dn iu iv iw dp ix iy iz ja jb jc jd je jf jg jh ji jj jk bi translated">将Azure DevOps与AWS集成</h2><p id="a356" class="pw-post-body-paragraph jl jm iq jn b jo jp jq jr js jt ju jv iy jw jx jy jc jz ka kb jg kc kd ke kf ij bi translated">现在我们可以离开AWS控制台，打开Azure DevOps面板。<br/> Azure DevOps有一个很好的特性，叫做<strong class="jn lf">服务连接</strong>，可以将一堆服务集成到你的Azure环境中。</p><p id="a279" class="pw-post-body-paragraph jl jm iq jn b jo kn jq jr js ko ju jv iy kp jx jy jc kq ka kb jg kr kd ke kf ij bi translated">转到您的azure面板并选择一个组织，然后单击<strong class="jn lf">项目设置。</strong></p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="gh gi ln"><img src="../Images/48fabbc7bac7400fcf4699edd0c0dd91.png" data-original-src="https://miro.medium.com/v2/resize:fit:258/format:webp/1*VmMlwIJbNMVH_tLUuGPh_A.png"/></div></figure><p id="81c6" class="pw-post-body-paragraph jl jm iq jn b jo kn jq jr js ko ju jv iy kp jx jy jc kq ka kb jg kr kd ke kf ij bi translated">你可以在<strong class="jn lf">管线</strong>部分下的左侧面板中找到<strong class="jn lf">服务接口</strong>。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="gh gi lo"><img src="../Images/ab7a5a2aa62da67343541ef758dd9fa3.png" data-original-src="https://miro.medium.com/v2/resize:fit:652/format:webp/1*Zp0dySxclUQAaFDyQWBXJg.png"/></div></figure><p id="9b71" class="pw-post-body-paragraph jl jm iq jn b jo kn jq jr js ko ju jv iy kp jx jy jc kq ka kb jg kr kd ke kf ij bi translated">在这里，您可以看到之前添加的所有服务。<br/>点击<strong class="jn lf">新建服务连接。</strong>这是我们可以轻松与Azure DevOps集成的服务列表。我们选择AWS。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="gh gi lp"><img src="../Images/4b73f0cd2b6e4900e4e6009b49c6f33e.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/format:webp/1*KxG1JllrBqbpRniBiZCWAg.png"/></div></figure><p id="5374" class="pw-post-body-paragraph jl jm iq jn b jo kn jq jr js ko ju jv iy kp jx jy jc kq ka kb jg kr kd ke kf ij bi translated">在这一步中，我们需要在预览步骤中创建的访问密钥和秘密密钥(注意:如果您想承担一个角色，您可以将角色的ARN传递给<strong class="jn lf">角色，以承担</strong>输入)。对于<strong class="jn lf">服务连接名称</strong>，我们应该保留该名称以备将来使用，因为我们将在管道中使用该名称。我们可以跳过可选输入(注意:检查<strong class="jn lf">授予对所有管道的访问权限</strong>)现在我们可以点击保存。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="gh gi lq"><img src="../Images/2fb62691cb7be132403a4400d5122e56.png" data-original-src="https://miro.medium.com/v2/resize:fit:964/format:webp/1*N7VtqqWS-7vd8Z1M7t3d5A.png"/></div></figure><p id="c372" class="pw-post-body-paragraph jl jm iq jn b jo kn jq jr js ko ju jv iy kp jx jy jc kq ka kb jg kr kd ke kf ij bi translated">我们可以看到AWS服务连接。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi lr"><img src="../Images/a930205356536063ee0d0b2e41bea4ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MNa6FtUAW9HYE_N3iiFSow.png"/></div></div></figure><h2 id="2dd5" class="io ip iq bd ir is it dn iu iv iw dp ix iy iz ja jb jc jd je jf jg jh ji jj jk bi translated">创建一个repo并编写azure-pipeline.yml</h2><p id="2d5d" class="pw-post-body-paragraph jl jm iq jn b jo jp jq jr js jt ju jv iy jw jx jy jc jz ka kb jg kc kd ke kf ij bi translated">现在，如果您在azure DevOps中没有回购，您需要在我们继续之前创建它。<br/>创建回购后，我们需要编写azure-pipeline.yml，在这里我们可以从AWS secret manager中检索我们的秘密，并在我们的管道中使用该值。<strong class="jn lf"> azure-pipeline.yml </strong>文件可以是这样的:</p><pre class="kt ku kv kw gt ls lk lt lu aw lv bi"><span id="4955" class="io ip iq lk b gy lw lx l ly lz">name: Test<br/>variables:<br/>  var1: value1<br/>trigger:<br/>- master<br/>jobs:<br/>- job: One<br/>  steps:<br/>  - script: |<br/>      sudo apt-get update<br/>      sudo apt-get install -y jq<br/>      python -m pip install --upgrade pip==9.0.3 setuptools wheel<br/>      pip install awscli --user<br/>    displayName: 'Install tools'<br/>  - task: AWSShellScript@1<br/>    inputs:<br/>      awsCredentials: 'Access To AWS' # Serivce connection name<br/>      regionName: 'eu-west-1'<br/>      scriptType: 'inline'<br/>      inlineScript: |<br/>        /home/vsts/.local/bin/aws secretsmanager get-secret-value --secret-id dev/pass | jq -r '.SecretString' | jq -r '.password'</span></pre><p id="f3d4" class="pw-post-body-paragraph jl jm iq jn b jo kn jq jr js ko ju jv iy kp jx jy jc kq ka kb jg kr kd ke kf ij bi translated">注意:我们将管道配置为在将代码推送到主分支后触发。如果您想将其更改为特定的分支，您需要更改<code class="fe lh li lj lk b">trigger</code>指令。</p><p id="1f2a" class="pw-post-body-paragraph jl jm iq jn b jo kn jq jr js ko ju jv iy kp jx jy jc kq ka kb jg kr kd ke kf ij bi translated">神奇的事情发生在<strong class="jn lf">输入</strong>部分，在这里我们可以使用CLI <br/>访问AWS secret manager。在我们将代码推送到主分支后，管道将自动启动，我们可以在stdout中看到安全值。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ma"><img src="../Images/93dc0108617ec4871d6ff3bc4e8ebfc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ekaIHF7kO7rQlcOV7c5z0Q.png"/></div></div></figure><p id="3e01" class="pw-post-body-paragraph jl jm iq jn b jo kn jq jr js ko ju jv iy kp jx jy jc kq ka kb jg kr kd ke kf ij bi translated">如果您需要将机密值分配给变量，以便在管道的同一作业的后续步骤中使用它，您可以像这样使用它:</p><pre class="kt ku kv kw gt ls lk lt lu aw lv bi"><span id="2e8f" class="io ip iq lk b gy lw lx l ly lz">name: Test<br/>variables:<br/>  var1: value1<br/>trigger:<br/>- master<br/>jobs:<br/>- job: One<br/>  steps:<br/>  - script: |<br/>      sudo apt-get update<br/>      sudo apt-get install -y jq<br/>      python -m pip install --upgrade pip==9.0.3 setuptools wheel<br/>      sudo pip install awscli --user<br/>    displayName: 'Install tools'<br/>  - task: AWSShellScript@1<br/>    name: SecretVariable<br/>    inputs:<br/>      awsCredentials: 'Access To AWS'<br/>      regionName: 'eu-west-1'<br/>      scriptType: 'inline'<br/>      inlineScript: |<br/>        SECRET=$(aws secretsmanager get-secret-value --secret-id test/pass | jq -r '.SecretString' | jq -r '.password')<br/>        echo "##vso[task.setvariable variable=SECRET]$SECRET"</span><span id="b59e" class="io ip iq lk b gy mb lx l ly lz">  - script: |<br/>      echo $SECRET</span></pre><p id="91c3" class="pw-post-body-paragraph jl jm iq jn b jo kn jq jr js ko ju jv iy kp jx jy jc kq ka kb jg kr kd ke kf ij bi translated">基本上，我们可以使用<strong class="jn lf"> SECRET </strong>变量在后续步骤中获取秘密值。</p></div></div>    
</body>
</html>