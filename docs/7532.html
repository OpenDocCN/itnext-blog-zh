<html>
<head>
<title>Testing Tekton to build and push images for my K3S ARM Oracle cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">测试Tekton为我的K3S ARM Oracle集群构建和推送映像</h1>
<blockquote>原文：<a href="https://itnext.io/testing-tekton-to-build-and-push-images-for-my-k3s-arm-oracle-cluster-cfdf8a225301?source=collection_archive---------4-----------------------#2022-10-25">https://itnext.io/testing-tekton-to-build-and-push-images-for-my-k3s-arm-oracle-cluster-cfdf8a225301?source=collection_archive---------4-----------------------#2022-10-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/0cc94176c15eca7675cebee0b8eeb916.png" data-original-src="https://miro.medium.com/v2/resize:fit:794/format:webp/1*q7XN5Hm-UcVoDDbLJTzp6Q.png"/></div></div></figure><h2 id="4b98" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">介绍</h2><p id="ea34" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated">在本文中，我们将探讨如何部署和配置tekton来构建映像并将其推送到您的注册表，以便从您的集群中使用，我们还将在另一篇文章中了解如何部署这些映像。在这篇文章中，我想向您展示如何准备好使用映像，以及一个无需依赖外部因素的CI系统的便捷解决方案，在我的案例中，我在docker构建跨架构映像时遇到了问题，在设置tekton后，一切都变得更快、更简单，跨架构默认情况下很慢，但也不能如您所预期的那样100%地工作。 通过使用这种方法，我们可以忘记架构，只构建我们运行的东西，它肯定更快，甚至你的一些节点已经有可用的映像，这意味着更少的带宽消耗<br/>从长远来看也是如此。</p><p id="ab60" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">下面列出了我们将要测试的项目的源代码和/或文档:</p><ul class=""><li id="f2e6" class="lu lv iq kw b kx lp lb lq kh lw kl lx kp ly lo lz ma mb mc bi translated"><a class="ae md" href="https://github.com/kainlite/tr" rel="noopener ugc nofollow" target="_blank"> tr </a>，去看看吧，我的新博客就在那里:<a class="ae md" href="https://tr.techsquad.rocks" rel="noopener ugc nofollow" target="_blank">https://tr . tech squad . rocks</a>你可以在<code class="fe me mf mg mh b">manifests</code>文件夹中查看这里使用的清单。</li></ul><p id="1fce" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">下面列出了我们将要测试的项目的源代码和/或文档:</p><ul class=""><li id="e4d3" class="lu lv iq kw b kx lp lb lq kh lw kl lx kp ly lo lz ma mb mc bi translated"><a class="ae md" href="https://tekton.dev/docs/" rel="noopener ugc nofollow" target="_blank">泰克顿</a></li><li id="4b9e" class="lu lv iq kw b kx mi lb mj kh mk kl ml kp mm lo lz ma mb mc bi translated">tekton-tri公司</li><li id="bdec" class="lu lv iq kw b kx mi lb mj kh mk kl ml kp mm lo lz ma mb mc bi translated"><a class="ae md" href="https://github.com/GoogleContainerTools/kaniko" rel="noopener ugc nofollow" target="_blank"> kaniko </a></li></ul><h2 id="2e2d" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">安装tekton管道和tekton触发器</h2><p id="3716" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated">为什么我们还需要泰克顿管道或泰克顿触发器？管道允许你按顺序运行多个任务并传递东西(这是tekton和任何CI/CD系统的基础)，然后我们需要做一些事情，例如当我们推送到我们的git库时，这就是tekton-triggers变得方便的时候，让我们对变化做出反应并触发一个构建或一些过程，拦截器是tekton-triggers的一部分，让我们说它给你使用事件的灵活性。</p><figure class="mn mo mp mq gt jr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="44c8" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">然后我们需要在本地安装<code class="fe me mf mg mh b">tkn</code>,并从hub配置一些包</p><figure class="mn mo mp mq gt jr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="601d" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">在我的部署中，我使用了推荐用于任何“生产”部署的固定版本，你可以在这里看到自述文件<a class="ae md" href="https://github.com/kainlite/tr/blob/master/manifests/tekton/README.md" rel="noopener ugc nofollow" target="_blank"/>。</p><h2 id="9eb2" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">让我们进入正题</h2><p id="d74d" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated"><strong class="kw ir">泰克顿管道</strong></p><p id="bdb7" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">好了，我们已经安装了tekton和friends，可以开始工作了，但是现在呢？嗯，这有点棘手，需要一些清单才能开始，所以我将尝试解释每个文件发生了什么，以及我们为什么需要它们。</p><p id="4b3b" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">你也可以在github中看到这个文件<a class="ae md" href="https://github.com/kainlite/tr/blob/master/manifests/tekton/pipelines/01-pipeline.yaml" rel="noopener ugc nofollow" target="_blank"> 01-pipeline.yaml </a>，基本上我们需要定义一个管道来定义步骤和将要发生的事情，这里我们正在克隆存储库，然后用kaniko构建它，然后将其推送到docker注册表，请注意，脚本是硬编码的，可以是动态的，但对我的用例来说并不是真正必要的。</p><figure class="mn mo mp mq gt jr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="31a6" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">你也可以在github中看到这个文件<a class="ae md" href="https://github.com/kainlite/tr/blob/master/manifests/tekton/pipelines/02-pipeline-run.yaml" rel="noopener ugc nofollow" target="_blank"> 02-pipeline-run.yaml </a>，这基本上是运行我们定义的具有特定值的管道，我们将使用触发器中非常类似的东西来自动运行，当我们将提交推送到我们的repo时，docker secret是一个常规的dockercfg secret挂载，因此我们可以推送到那个注册表。</p><figure class="mn mo mp mq gt jr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="951e" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">有了所有这些，我们有了一个基本的管道，但我们需要手动触发或运行它，让我们为它添加必要的清单，以对github存储库中的更改做出反应</p><p id="f2b0" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated"><strong class="kw ir"> tekton触发器</strong></p><p id="7b05" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">你也可以在github中看到这个文件<a class="ae md" href="https://github.com/kainlite/tr/blob/master/manifests/tekton/triggers/01-rbac.yaml" rel="noopener ugc nofollow" target="_blank"> 01-rbac.yaml </a>，让我们给tekton-triggers一些权限</p><figure class="mn mo mp mq gt jr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="bcdc" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">你也可以在github上看到这个文件<a class="ae md" href="https://github.com/kainlite/tr/blob/master/manifests/tekton/triggers/02-eventlistener.yaml" rel="noopener ugc nofollow" target="_blank"> 02-eventlistener.yaml </a>，这是事情变得有点棘手的地方，理论上你不需要一个秘密来读取你的回购，如果它是公开的，但当我开始测试它时，它是私有的，然后它是公开的，如果你对这个yaml下面的秘密检查的格式感兴趣，但是它只“监听”我们回购中的事件，并使用我们的管道触发事件，我们仍然需要一个webhook和其他配置的入口，正如我们将在</p><figure class="mn mo mp mq gt jr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="6b1a" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">这个秘密类似于下面描述的，用你生成的令牌替换<code class="fe me mf mg mh b">secretToken</code>这将用于webhook配置，所以把它保存在一个安全的地方，直到它在那里被配置。</p><figure class="mn mo mp mq gt jr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="04a3" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">你也可以在github上看到这个文件<a class="ae md" href="https://github.com/kainlite/tr/blob/master/manifests/tekton/triggers/04-triggerbinding.yaml" rel="noopener ugc nofollow" target="_blank"> 04-triggerbinding.yaml </a>，当我们收到webhook时，我们可以从中获得一些信息，基本上我们感兴趣的是回购URL和提交SHA。</p><figure class="mn mo mp mq gt jr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="ff70" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">你也可以在github中看到这个文件<a class="ae md" href="https://github.com/kainlite/tr/blob/master/manifests/tekton/triggers/05-triggertemplate.yaml" rel="noopener ugc nofollow" target="_blank"> 05-triggertemplate.yaml </a>，这相当于我们手动运行的pipelinerun，但是它使用触发器和模板来自动触发，因此有相似之处。</p><figure class="mn mo mp mq gt jr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="ad03" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">你也可以在github上看到这个文件<a class="ae md" href="https://github.com/kainlite/tr/blob/master/manifests/tekton/triggers/06-ingress.yaml" rel="noopener ugc nofollow" target="_blank"> 06-ingress.yaml </a>，最后但并非最不重要的是ingress配置，没有它它不会工作，因为我们需要从github接收一个请求，要配置它，只需转到存储库上的设置，点击webhooks并使用你生成的秘密令牌创建一个新的，并将你的URL设为<code class="fe me mf mg mh b">https://subdomain.domain/hooks</code>，然后将TLS标记为on，仅push和active。</p><figure class="mn mo mp mq gt jr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="30e4" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">咻！这需要大量的工作，但相信我，这是值得的，现在您可以从您的集群中构建、推送和运行您的映像，无需外部或奇怪的CI/CD系统，一切都遵循GitOps模型，因为一切都可以从您的存储库中提交和应用，在我的情况下，我使用ArgoCD和Kustomize来应用一切，但这将是另一个章节。</p><p id="2d4e" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">我们已经准备好了事件监听器:</p><figure class="mn mo mp mq gt jr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="2345" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">我们有管道，请注意它说失败，这是因为ARM有一个问题尚未解决，但实际上一切都按预期工作:</p><figure class="mn mo mp mq gt jr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="c21a" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">我们可以看到pipelinerun被触发，与之前描述的问题相同，请参见github问题的注释:</p><figure class="mn mo mp mq gt jr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="b508" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">我们还可以看到为tekton创建的一些其他资源:</p><figure class="mn mo mp mq gt jr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="8d72" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">您还可以使用<code class="fe me mf mg mh b">kubectl</code>或<code class="fe me mf mg mh b">tkn</code>查看创建的窗格或日志:</p><figure class="mn mo mp mq gt jr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="dd42" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">我希望这对某些人有用，如果您的CI/CD系统有问题，请尝试tekton，您会喜欢它，在我的特定情况下，我在ARM和构建它时遇到了许多问题，它很慢，有很多奇怪的错误，所有这些都通过构建我运行的映像而消失了，它更快，还利用了空闲的计算能力。</p><h2 id="4881" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">一些来源和已知问题</h2><p id="e24f" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated">这篇文章深受这些文章的启发，并按照以下示例进行了配置和测试:</p><div class="mt mu gp gr mv mw"><a href="https://github.com/tektoncd/triggers/blob/main/docs/getting-started/README.md" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd ir gy z fp nb fr fs nc fu fw ip bi translated">主tektoncd/triggers上的triggers/README.md</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">下面的教程将引导您使用Tekton触发器来构建和部署Docker映像，以检测GitHub…</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">github.com</p></div></div><div class="nf l"><div class="ng l nh ni nj nf nk jw mw"/></div></div></a></div><div class="mt mu gp gr mv mw"><a href="https://tekton.dev/docs/how-to-guides/kaniko-build-push/#full-code-samples" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd ir gy z fp nb fr fs nc fu fw ip bi translated">使用Tekton构建和推送映像</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">使用Kaniko和Tekton创建一个管道来获取源代码、构建和推送图像。本指南将向您展示如何…</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">tekton.dev</p></div></div></div></a></div><div class="mt mu gp gr mv mw"><a href="https://www.arthurkoziel.com/tutorial-tekton-triggers-with-github-integration/" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd ir gy z fp nb fr fs nc fu fw ip bi translated">教程:Tekton触发器与GitHub集成</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">在之前的博客文章中，我们已经使用Tekton管道建立了一个简单的管道来运行测试，构建docker映像…</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">www.arthurkoziel.com</p></div></div><div class="nf l"><div class="nl l nh ni nj nf nk jw mw"/></div></div></a></div><p id="e61c" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">在ARM上运行会有一些问题，在其他架构上它只是工作，查看更多:</p><div class="mt mu gp gr mv mw"><a href="https://github.com/tektoncd/pipeline/issues/4247" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd ir gy z fp nb fr fs nc fu fw ip bi translated">fork/exec /busybox/mkdir: exec格式错误问题#4247 tektoncd/pipeline</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">github.com</p></div></div><div class="nf l"><div class="nm l nh ni nj nf nk jw mw"/></div></div></a></div><div class="mt mu gp gr mv mw"><a href="https://github.com/tektoncd/pipeline/issues/5233" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd ir gy z fp nb fr fs nc fu fw ip bi translated">docker-build任务失败，出现exec格式错误问题#5233 tektoncd/pipeline</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">预期行为能够构建docker映像实际行为无法运行docker-2022/07/28构建步骤失败…</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">github.com</p></div></div><div class="nf l"><div class="nn l nh ni nj nf nk jw mw"/></div></div></a></div><p id="d19a" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">但是一切都应该正常工作。</p><h1 id="d3d4" class="no jz iq bd ka np nq nr kd ns nt nu kg nv nw nx kk ny nz oa ko ob oc od ks oe bi translated">正误表</h1><p id="1c68" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated">如果您发现任何错误或有任何建议，请给我发消息，以便解决问题。</p><p id="bc10" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">此外，您还可以在这里查看源代码以及<a class="ae md" href="https://github.com/kainlite/kainlite.github.io" rel="noopener ugc nofollow" target="_blank">生成代码</a>和<a class="ae md" href="https://github.com/kainlite/blog" rel="noopener ugc nofollow" target="_blank">源代码</a>的变化。</p></div><div class="ab cl of og hu oh" role="separator"><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok"/></div><div class="ij ik il im in"><p id="5388" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated"><em class="om">原载于2022年10月25日</em><a class="ae md" href="https://techsquad.rocks/blog/testing_tekton_to_build_and_push_images_for_my_k3s_arm_oracle_cluster/" rel="noopener ugc nofollow" target="_blank"><em class="om">https://tech squad . rocks</em></a><em class="om">。</em></p></div></div>    
</body>
</html>