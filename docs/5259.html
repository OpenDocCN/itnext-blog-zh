<html>
<head>
<title>Build Serverless API with GraphQL and Azure— Part I</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用GraphQL和Azure构建无服务器API第一部分</h1>
<blockquote>原文：<a href="https://itnext.io/build-serverless-api-with-graphql-and-azure-part-i-e9e7f4be0200?source=collection_archive---------2-----------------------#2021-01-25">https://itnext.io/build-serverless-api-with-graphql-and-azure-part-i-e9e7f4be0200?source=collection_archive---------2-----------------------#2021-01-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="ad0b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">无服务器架构是软件行业的当前趋势，它允许您在经济高效的短期服务中运行应用程序。使用GraphQL，您可以减少对单个端点的服务调用数量。使用这两种技术，我们可以构建经济高效的API。</p><p id="9cf6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本系列文章中，我将指导您如何将GraphQL API和Azure函数集成在一起(第一部分)。此外，我们如何使用oAuth2身份验证来保护这个API(第二部分)。</p><p id="6f8b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是我们将在本文中涉及的内容的概要图，</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/9438b7a6d67a207f9bb7deb0a66d57ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iCTOcLM0WWYQMlG6rsNMFQ.jpeg"/></div></div></figure><p id="e6ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我假设你已经与Azure技术和GraphQL合作过。因此，我不打算详细解释每一部分的每一个术语。</p><h1 id="4af6" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">先决条件</h1><ul class=""><li id="1fd9" class="lv lw iq jp b jq lx ju ly jy lz kc ma kg mb kk mc md me mf bi translated">Azure技术、Azure CLI命令和<a class="ae mg" href="https://graphql.org/" rel="noopener ugc nofollow" target="_blank"> GraphQL </a>的基础知识</li><li id="1940" class="lv lw iq jp b jq mh ju mi jy mj kc mk kg ml kk mc md me mf bi translated">Azure帐户(您可以使用Azure免费订阅)</li><li id="6c87" class="lv lw iq jp b jq mh ju mi jy mj kc mk kg ml kk mc md me mf bi translated">安装<a class="ae mg" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local?tabs=macos%2Ccsharp%2Cbash#v2" rel="noopener ugc nofollow" target="_blank"> Azure Functions核心工具CLI版本2.x </a></li><li id="6226" class="lv lw iq jp b jq mh ju mi jy mj kc mk kg ml kk mc md me mf bi translated">安装<a class="ae mg" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a></li><li id="8272" class="lv lw iq jp b jq mh ju mi jy mj kc mk kg ml kk mc md me mf bi translated"><a class="ae mg" href="https://www.postman.com/" rel="noopener ugc nofollow" target="_blank">邮递员</a>工具</li></ul><h1 id="1bdb" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">在本地创建Azure函数</h1><p id="5fcc" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">我们可以选择用C#、NodeJS、python等不同语言编写Azure函数。我将在本文中选择NodeJS。</p><p id="88c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，让我们创建我们的Azure函数项目。打开控制台，运行以下命令:</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="c5ef" class="mu ky iq mq b gy mv mw l mx my">func init graphql-functions --worker-runtime node<br/>cd graphql-functions</span></pre><p id="1f63" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，运行以下命令来生成HTTP触发器模板。</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="1cee" class="mu ky iq mq b gy mv mw l mx my">func new --template "Http Trigger" --name graphql</span></pre><p id="428e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将在“graphql”文件夹中生成两个预构建的模板，分别为<code class="fe mz na nb mq b">function.json</code>和<code class="fe mz na nb mq b">index.js</code>。我们将在这个<code class="fe mz na nb mq b">index.js</code>中编写我们的业务逻辑。</p><p id="de6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在用VS代码或者你喜欢的IDE打开这个函数项目，编辑<code class="fe mz na nb mq b">function.json</code>。这里，我们需要将“HTTP out”绑定替换为“$return”，如下所示:</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="b6b3" class="mu ky iq mq b gy mv mw l mx my">{<br/>  "bindings": [<br/>    {<br/>      "authLevel": "function",<br/>      "type": "httpTrigger",<br/>      "direction": "in",<br/>      "name": "req",<br/>      "methods": [<br/>        "get",<br/>        "post"<br/>      ]<br/>    },<br/>    {<br/>      "type": "http",<br/>      "direction": "out",<br/>      <strong class="mq ir">"name": "$return"</strong><br/>    }<br/>  ]<br/>}</span></pre><h2 id="648b" class="mu ky iq bd kz nc nd dn ld ne nf dp lh jy ng nh ll kc ni nj lp kg nk nl lt nm bi translated">设置GraphQL端点</h2><p id="d2ff" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">让我们使用npm为Azure函数安装Apollo服务器集成:</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="d1c6" class="mu ky iq mq b gy mv mw l mx my">npm install --save apollo-server-azure-functions</span></pre><p id="dd0e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在打开“graphql/index.js”文件。我们将在这个文件中编写我们的逻辑。首先，让我们编写一个简单的带有“Hello World”响应的GraphQL模式。</p><p id="6305" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用以下代码替换现有代码:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="9ac7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，我们的初始GraphQL设置完成了。让我们运行这个函数:</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="5ebc" class="mu ky iq mq b gy mv mw l mx my">func host start</span></pre><p id="285d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您应该在控制台中看到类似的输出。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi np"><img src="../Images/be971e5b922ab4d846f71133513fc564.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T82ApxwWu4TsPmg3bxdjfQ.png"/></div></div></figure><p id="b4e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">复制图表并粘贴到浏览器中。您应该看到下面的GraphQL操场如下:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nq"><img src="../Images/b92fdc5e2fe6255b7fab14c3cade421d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B00WFeymhA-_-1F3zfirbg.png"/></div></div></figure><p id="b175" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，现在我们已经把Azure函数和GraphQL集成在一起了。现在我们可以开始编写实际的业务逻辑了。对于这篇文章，我将使用<a class="ae mg" href="https://azure.microsoft.com/en-us/services/cosmos-db/" rel="noopener ugc nofollow" target="_blank">宇宙数据库</a>。</p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><h2 id="f726" class="mu ky iq bd kz nc nd dn ld ne nf dp lh jy ng nh ll kc ni nj lp kg nk nl lt nm bi translated">在Azure中设置Cosmos DB</h2><p id="423e" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">我已经在我的Azure订阅中设置了一个简单的Cosmos DB。</p><blockquote class="ny nz oa"><p id="0fe2" class="jn jo ob jp b jq jr js jt ju jv jw jx oc jz ka kb od kd ke kf oe kh ki kj kk ij bi translated"><strong class="jp ir">注意:</strong>更好的在一个资源组中维护你所有的资源(cosmos DB，function app)。这样就更容易在最后清理了。</p></blockquote><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi of"><img src="../Images/3ae2f702c42e2236af486636d729b86e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*URDVN3V7gSE5AByWdG2acg.png"/></div></div></figure><p id="a5f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是文档的结构。您可以在您的Cosmos容器中添加一些如下结构的虚拟记录。</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="d90e" class="mu ky iq mq b gy mv mw l mx my">{<br/>    "id": "1",<br/>    "first_name": "Tony",<br/>    "last_name": "Stark",<br/>    "email": "<a class="ae mg" href="mailto:tonystark@shield.com" rel="noopener ugc nofollow" target="_blank">tonystark@shield.com</a>"<br/>}</span></pre><p id="402d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">设置好Azure Cosmo数据库后，复制连接字符串:</p><ul class=""><li id="9dbc" class="lv lw iq jp b jq jr ju jv jy og kc oh kg oi kk mc md me mf bi translated">登录Azure门户并导航到您的Cosmos DB</li><li id="b1ce" class="lv lw iq jp b jq mh ju mi jy mj kc mk kg ml kk mc md me mf bi translated">从左侧面板中选择“钥匙”</li><li id="6177" class="lv lw iq jp b jq mh ju mi jy mj kc mk kg ml kk mc md me mf bi translated">复制主连接字符串并将其粘贴到记事本中。</li></ul><h2 id="27dc" class="mu ky iq bd kz nc nd dn ld ne nf dp lh jy ng nh ll kc ni nj lp kg nk nl lt nm bi translated">为宇宙编写代码</h2><p id="6f4a" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">为我们的项目安装Cosmo DB npm包。在控制台中运行以下命令:</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="e091" class="mu ky iq mq b gy mv mw l mx my">npm install --save @azure/cosmos</span></pre><p id="e8c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，打开<code class="fe mz na nb mq b">index.js</code>文件，导入Cosmos客户端。</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="5f74" class="mu ky iq mq b gy mv mw l mx my">const { CosmosClient } = require('@azure/cosmos');</span></pre><p id="69db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后定义以下变量并设置值。</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="a630" class="mu ky iq mq b gy mv mw l mx my">const connectionString = "ADD_YOUR_CONNECTION_STRING";<br/>const databaseName = "ADD_DATABASE_NAME";<br/>const containerName = "ADD_CONTAINER_NAME";</span></pre><blockquote class="ny nz oa"><p id="ba24" class="jn jo ob jp b jq jr js jt ju jv jw jx oc jz ka kb od kd ke kf oe kh ki kj kk ij bi translated"><strong class="jp ir">注意:</strong>由于这只是一个演示，所以在代码中添加连接字符串。推荐的方法是将连接字符串存储在配置文件中或存储在密钥库中。</p></blockquote><p id="4a09" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，让我们创建到Cosmo数据库的连接。</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="439f" class="mu ky iq mq b gy mv mw l mx my">const client = new CosmosClient(<!-- -->connectionString<!-- -->);</span></pre><p id="3a94" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后用以下模式替换现有的GraphQL模式:</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="e955" class="mu ky iq mq b gy mv mw l mx my">const typeDefs = gql`<br/>  type User {<br/>    id: Int,<br/>    first_name: String<br/>    last_name: String,<br/>    email: String<br/>  },</span><span id="3f13" class="mu ky iq mq b gy oj mw l mx my">type Query {<br/>    user(id: Int!): User,<br/>    users: [User]<br/>  }<br/>`;</span></pre><p id="75a3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所见，我们用id、名字、姓氏和电子邮件定义了用户模式，这与我们的Cosmos文档结构相似。此外，我们引入了两个查询。一个查询是通过Id获取用户，另一个方法是检索数据库中的所有用户。</p><p id="5519" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，让我们用下面的方法替换我们的解析器方法:</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="ae49" class="mu ky iq mq b gy mv mw l mx my">const resolvers = {<br/>  Query: {<br/>    user: getUser,<br/>    users: getAllUser<br/>  }<br/>};</span></pre><p id="a53e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们已经为解析器中的每个查询分配了相关的函数。现在，我们可以编写getUser和getAllUser业务方法。</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="b154" class="mu ky iq mq b gy mv mw l mx my">getUser = async (_, { id }) =&gt; {<br/>  let query = "SELECT * FROM c WHERE c.id = <a class="ae mg" href="http://twitter.com/userId" rel="noopener ugc nofollow" target="_blank">@userId</a>";<br/>  let params = [{ name: "<a class="ae mg" href="http://twitter.com/userId" rel="noopener ugc nofollow" target="_blank">@userId</a>", value: id.toString() }];</span><span id="9fa5" class="mu ky iq mq b gy oj mw l mx my">  let { resources: items } = await client.database("gql-db").container("gql-container")<br/>    .items.query({ query: query, parameters: params }).fetchAll();</span><span id="8dcc" class="mu ky iq mq b gy oj mw l mx my">if (items.length &gt; 0) {<br/>    return items[0];<br/>  }</span><span id="9f7a" class="mu ky iq mq b gy oj mw l mx my">return null;<br/>};</span><span id="1758" class="mu ky iq mq b gy oj mw l mx my">getAllUser = async () =&gt; {<br/>  let { resources: items } = await client.database("gql-db").container("gql-container")<br/>    .items.query({ query: "SELECT * from c" }).fetchAll();<br/>  return items;<br/>};</span></pre><p id="161d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完成上述步骤后，您的完整代码应该如下所示:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="304f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在在本地再次运行这个函数&amp;在操场上执行一些查询。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ok"><img src="../Images/2971754b0be1b3d95a614fb5d4f78a15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rpiBqKSOvkB2PBWliBreAg.png"/></div></div></figure><p id="d165" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果该功能工作正常，就可以发货了！！！</p><p id="f063" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们在第二部分中进一步讨论如何将这个无服务器应用程序部署到云中并应用身份验证。</p><div class="ol om gp gr on oo"><a rel="noopener  ugc nofollow" target="_blank" href="/build-serverless-api-with-graphql-and-azure-part-ii-3ae427763ccc"><div class="op ab fo"><div class="oq ab or cl cj os"><h2 class="bd ir gy z fp ot fr fs ou fu fw ip bi translated">用GraphQL和Azure构建无服务器API第二部分</h2><div class="ov l"><h3 class="bd b gy z fp ot fr fs ou fu fw dk translated">使用oAuth2保护API</h3></div><div class="ow l"><p class="bd b dl z fp ot fr fs ou fu fw dk translated">itnext.io</p></div></div><div class="ox l"><div class="oy l oz pa pb ox pc kv oo"/></div></div></a></div></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><p id="7157" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以从这里获得本文的源代码:</p><div class="ol om gp gr on oo"><a href="https://github.com/shamique/GraphQL-AzureFunction" rel="noopener  ugc nofollow" target="_blank"><div class="op ab fo"><div class="oq ab or cl cj os"><h2 class="bd ir gy z fp ot fr fs ou fu fw ip bi translated">shamique/GraphQL-AzureFunction</h2><div class="ov l"><h3 class="bd b gy z fp ot fr fs ou fu fw dk translated">在GitHub上创建一个帐户，为shamique/GraphQL-AzureFunction的开发做出贡献。</h3></div><div class="ow l"><p class="bd b dl z fp ot fr fs ou fu fw dk translated">github.com</p></div></div><div class="ox l"><div class="pd l oz pa pb ox pc kv oo"/></div></div></a></div></div></div>    
</body>
</html>