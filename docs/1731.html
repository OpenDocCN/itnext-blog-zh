<html>
<head>
<title>Kubernetes networking deep dive: Did you make the right choice?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes网络深潜:你做了正确的选择吗？</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-network-deep-dive-7492341e0ab5?source=collection_archive---------0-----------------------#2019-01-14">https://itnext.io/kubernetes-network-deep-dive-7492341e0ab5?source=collection_archive---------0-----------------------#2019-01-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="77e3" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Kubernetes的网络设计可能令人生畏，尤其是当您是集群级网络选择的决策者时。在本节中，我们将讨论这些选择将如何影响集群路由和负载平衡，重点是KubeProxy模式(iptables vs IPVS)和网络解决方案。</h2></div><h1 id="7782" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">更新:</h1><p id="968d" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">这是我在Medium上的第一个Kubernetes博客，我很高兴看到它得到了Kubernetes官方账户的认可，太令人鼓舞了！感谢<a class="lt lu ep" href="https://medium.com/u/11ff85587fd4?source=post_page-----7492341e0ab5--------------------------------" rel="noopener" target="_blank">伊夫·辛克莱文</a>和<a class="lt lu ep" href="https://medium.com/u/cb3f1b710e82?source=post_page-----7492341e0ab5--------------------------------" rel="noopener" target="_blank">基亚拉什·伊朗人</a>邀请我来到这个伟大的社区<a class="lt lu ep" href="https://medium.com/u/5db23d2304f9?source=post_page-----7492341e0ab5--------------------------------" rel="noopener" target="_blank"> ITNEXT </a>。</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi lv"><img src="../Images/f57b32b9f9d20d5c4a68771a17e20d14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cc57C-15a6NWrWq8xXDs-g.png"/></div></div></figure></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><p id="1c8d" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated">这个博客的主要目的是帮助Kubernetes用户熟悉K8S的主要网络组件、常见的使用模式和相应的故障排除工具。这将为您设计下一个集群或分析现有的集群网络问题并提出改进建议提供良好的基础。</p><p id="168f" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated">第一个问题，KubeProxy是所有K8S集群中关键且必需的组件，哪种模式最适合你？iptable还是IPVS？</p><p id="ba58" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated">接下来，如何选择最佳的L2/L3网络解决方案？KubeRouter，Calico，法兰绒还是其他？</p><p id="0324" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated">部署集群并使网络正常运行后。我可以使用什么工具来验证路由和负载平衡的预期行为？</p><p id="2323" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated">为了回答上述所有问题，我们提供了如下3种网络组合，试图涵盖最常见的场景。</p><h2 id="45d2" class="mt kg iq bd kh mu mv dn kl mw mx dp kp lg my mz kr lk na nb kt lo nc nd kv ne bi translated">网络插件和KubeProxy模式组合</h2><ul class=""><li id="15af" class="nf ng iq kz b la lb ld le lg nh lk ni lo nj ls nk nl nm nn bi translated">集群A: Calico(ipip跨子网)+ KubeProxy(IPVS模式)</li><li id="2bf4" class="nf ng iq kz b la no ld np lg nq lk nr lo ns ls nk nl nm nn bi translated">集群B:Calico(ipip always)+kube proxy(iptables模式)</li><li id="aca7" class="nf ng iq kz b la no ld np lg nq lk nr lo ns ls nk nl nm nn bi translated">集群C:Kube-router+Kube proxy(iptables模式)</li></ul><h2 id="49d8" class="mt kg iq bd kh mu mv dn kl mw mx dp kp lg my mz kr lk na nb kt lo nc nd kv ne bi translated">集群A: Calico(ipip跨子网)+ KubeProxy(IPVS模式)</h2><p id="72a2" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在该集群中，Calico被选为网络插件，KubeProxy启用了IPVS模式。</p><p id="b5bd" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated">IP-in-IP封装使用跨子网模式，这意味着它仅用于跨越子网边界的流量。这在AWS多AZ部署中提供了更好的性能。</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi nt"><img src="../Images/dfd61fe9af473a69581eac94e8816c28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SdkhXKx0rvjM3e19stfOkg.png"/></div></div></figure><p id="c386" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated">让我们看一下工作节点路由表</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="nu nv l"/></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">Calico跨子网模式路由表</figcaption></figure><ul class=""><li id="e07c" class="nf ng iq kz b la mo ld mp lg oa lk ob lo oc ls nk nl nm nn bi translated">tunel0用于节点之间的跨子网通信</li><li id="0186" class="nf ng iq kz b la no ld np lg nq lk nr lo ns ls nk nl nm nn bi translated">虚拟机eth0用于子网内节点通信。</li><li id="4be6" class="nf ng iq kz b la no ld np lg nq lk nr lo ns ls nk nl nm nn bi translated">请注意，这里有一个10.0.7.0/24黑洞，该子网由工作节点上的本地pod使用，使用cali接口进行通信</li></ul><p id="4eac" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated">对于路由表中的所有3种接口类型，我们也可以在下面的<code class="fe od oe of og b">ip addr</code>结果中找到相应的匹配</p><p id="35e4" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated"><strong class="kz ir">工作节点网络接口</strong> <br/>命令:<em class="oh"> ip地址</em></p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="nu nv l"/></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">Calico跨子网模式网络接口</figcaption></figure><p id="4249" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated">从上面的结果中，我们可以看到IPVS代理创建了一个虚拟接口kube-ipvs0，并将服务IP地址绑定到这个接口。</p><p id="4949" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated">请注意，kube-ipvs0接口下的服务IP在ipvs负载均衡结果中将有一个相应的匹配记录，如下面的ipvsadm输出所示。</p><p id="21ea" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated"><strong class="kz ir">基于IPVS的负载平衡</strong> <em class="oh"> <br/> </em> IPVS (IP虚拟服务器)构建在Netfilter之上，作为Linux内核的一部分实现传输层负载平衡。<br/> Kube-proxy可以配置IPVS来处理虚拟服务IP到pod IPs的转换。<em class="oh"> <br/> </em>从下面的片段中，我们可以发现匹配的服务集群IPs负载均衡在pods IPs之上。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="nu nv l"/></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">ipvsadm -ln</figcaption></figure><ul class=""><li id="1722" class="nf ng iq kz b la mo ld mp lg oa lk ob lo oc ls nk nl nm nn bi translated">10.1.0.1:443是指Kube-Controller-Manager服务，pod ips是主节点IP</li><li id="fcd8" class="nf ng iq kz b la no ld np lg nq lk nr lo ns ls nk nl nm nn bi translated">10.1.0.10:53指的是CoreDNS服务，pods ips指向2个coredns pods</li></ul><p id="cda8" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated">IPVS支持比iptables模式更多的负载平衡算法(仅支持循环调度)，这些调度算法是作为内核模块实现的。Linux虚拟服务器附带了10个。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="nu nv l"/></div></figure><h2 id="a7e0" class="mt kg iq bd kh mu mv dn kl mw mx dp kp lg my mz kr lk na nb kt lo nc nd kv ne bi translated">集群B:Calico(ipip always)+kube proxy(iptables模式)</h2><p id="d7d0" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在此群集中，IP-in-IP模式设置为Always，Calico将使用IP-in-IP将来自Calico启用节点的所有流量路由到所有Calico网络容器和节点。</p><p id="e4cd" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated">请注意下面的路由表</p><ul class=""><li id="cd3d" class="nf ng iq kz b la mo ld mp lg oa lk ob lo oc ls nk nl nm nn bi translated">calico网络不使用虚拟机eth0。</li><li id="ee43" class="nf ng iq kz b la no ld np lg nq lk nr lo ns ls nk nl nm nn bi translated">只有tunl0用于节点间通信。</li><li id="0ab3" class="nf ng iq kz b la no ld np lg nq lk nr lo ns ls nk nl nm nn bi translated">对于虚拟机上的pod，正在使用cali接口。</li></ul><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="nu nv l"/></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">Calico ipip始终模式路由表</figcaption></figure><p id="ae9a" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated"><strong class="kz ir">网络接口</strong> <br/>接口设置与路由表匹配，仅使用eth0、tunl0和cali接口。由于Kube-proxy使用iptables模式，因此不涉及kube-ipvs0</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="1fbd" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated">K8S服务和pod负载均衡怎么样？<br/>让我们看看K8S入口控制器的iptables输出。</p><p id="3f0c" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated">KUBE-SVC-3C2I2DNJ4VWZY5PF指的是集群IP为10.1.60.159的入口控制器服务(在要点中向右滚动以查看更多信息)</p><ul class=""><li id="70f7" class="nf ng iq kz b la mo ld mp lg oa lk ob lo oc ls nk nl nm nn bi translated">SVC IP以循环方式在3个pod上进行负载平衡</li><li id="9521" class="nf ng iq kz b la no ld np lg nq lk nr lo ns ls nk nl nm nn bi translated">tcp dpt:30998的iptables中的第一条记录代表AWS ELB使用的节点端口，它指向入口控制器服务。</li></ul><p id="10a0" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated">KUBE-SEP-xxxxxxxxxxx涉及入口控制器盒，其属于大小为3的副本集</p><ul class=""><li id="44b2" class="nf ng iq kz b la mo ld mp lg oa lk ob lo oc ls nk nl nm nn bi translated">KUBE-SEP-P6JNEFEXMECE2WS6，带pod IP 10.0.11.27</li><li id="18ae" class="nf ng iq kz b la no ld np lg nq lk nr lo ns ls nk nl nm nn bi translated">KUBE-SEP-DX25GZBAXCASAQMI，带pod IP 10.0.35.21</li><li id="d5e5" class="nf ng iq kz b la no ld np lg nq lk nr lo ns ls nk nl nm nn bi translated">KUBE-SEP-HI43CU4ZL6YUQHDB，带pod IP 10.0.11.26</li></ul><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="nu nv l"/></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">k8s svc和pod的iptables</figcaption></figure><h2 id="2f66" class="mt kg iq bd kh mu mv dn kl mw mx dp kp lg my mz kr lk na nb kt lo nc nd kv ne bi translated">集群C:Kube-router+Kube proxy(iptables模式)</h2><p id="bf7b" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">与Calico跨子网模式类似，kube-router将eth0用于子网内流量，将隧道用于节点之间的子网间流量。</p><p id="a6bd" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated">对于节点上的pod，kube-bridge用于容器流量，然后它们到达eth0或tun接口。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="67ce" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated"><strong class="kz ir">网络接口</strong></p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="47d5" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated">从网络接口输出可以看出，有两种有趣的类型</p><ul class=""><li id="5552" class="nf ng iq kz b la mo ld mp lg oa lk ob lo oc ls nk nl nm nn bi translated">kube-虚拟机eth0和pod veth0之间的桥梁</li><li id="250a" class="nf ng iq kz b la no ld np lg nq lk nr lo ns ls nk nl nm nn bi translated">在每个机架和虚拟机之间创建veth对</li></ul><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/e96614d766c301d668c663d8f1c21097.png" data-original-src="https://miro.medium.com/v2/resize:fit:1058/format:webp/1*DjaZLNHC9IAklttj4-JXpg.png"/></div></figure><h2 id="74f4" class="mt kg iq bd kh mu mv dn kl mw mx dp kp lg my mz kr lk na nb kt lo nc nd kv ne bi translated">更有用的工具</h2><p id="5f6d" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">kubelet CRI的CLI。<strong class="kz ir"> <br/> </strong>对于工作者节点上的k8s网络故障排除，crictl比docker更k8s友好。与<code class="fe od oe of og b">docker ps</code>输出相比，<br/> <code class="fe od oe of og b">crictl ps</code>不显示不相关的暂停容器或极长的容器名称。此外，它将输出容器所属的pod ID。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="nu nv l"/></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">crictl ps</figcaption></figure><p id="065c" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated">在集群B中调试时，为了确认本地pod使用了cali接口和10.0.104.0/24黑洞，使用crictl命令获取本地pod ips非常方便。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="cef4" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated"><strong class="kz ir">netshot</strong>:Kubernetes网络故障排除瑞士军队容器<br/>在几种情况下，当您试图了解您的网络基础设施中正在发生什么时，安装缺失的工具不是一个选项。</p><ul class=""><li id="9cf2" class="nf ng iq kz b la mo ld mp lg oa lk ob lo oc ls nk nl nm nn bi translated">当遵循不可变的基础设施时，不能在VM上安装任何工具。</li><li id="af60" class="nf ng iq kz b la no ld np lg nq lk nr lo ns ls nk nl nm nn bi translated">当您没有足够的权限安装工具时</li><li id="f923" class="nf ng iq kz b la no ld np lg nq lk nr lo ns ls nk nl nm nn bi translated">虚拟机磁盘不可写</li></ul><p id="5be1" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated"><code class="fe od oe of og b">netshoot</code>容器有一套强大的网络调试工具，可以用来解决Docker和Kubernetes的网络问题</p><pre class="lw lx ly lz gt oj og ok ol aw om bi"><span id="6ced" class="mt kg iq og b gy on oo l op oq">apache2-utils <br/>bash<br/>bird <br/>bridge-utils <br/>busybox-extras <br/>calicoctl<br/>conntrack-tools <br/>curl <br/>dhcping <br/>drill <br/>ethtool<br/>file <br/>fping <br/>iftop <br/>iperf <br/>iproute2 <br/>iptables <br/>iptraf-ng <br/>iputils <br/>ipvsadm<br/>libc6-compat <br/>liboping <br/>mtr <br/>net-snmp-tools <br/>netcat-openbsd <br/>ngrep <br/>nmap <br/>nmap-nping <br/>nmap-nping <br/>py-crypto <br/>py2-virtualenv <br/>python2 <br/>scapy <br/>socat <br/>strace <br/>tcpdump <br/>tcptraceroute <br/>util-linux <br/>vim</span></pre><p id="f495" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated">在下面的例子中，它使用特权模式和主机的网络名称空间，这将为您提供从容器内部所需的几乎所有访问权限。</p><pre class="lw lx ly lz gt oj og ok ol aw om bi"><span id="316b" class="mt kg iq og b gy on oo l op oq">docker run -it --privileged --net host nicolaka/netshoot</span></pre><p id="b649" class="pw-post-body-paragraph kx ky iq kz b la mo jr lc ld mp ju lf lg mq li lj lk mr lm ln lo ms lq lr ls ij bi translated">就这样，这应该为探索其他网络解决方案和故障排除工具提供了良好的基础。希望有帮助！</p></div></div>    
</body>
</html>