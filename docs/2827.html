<html>
<head>
<title>A decentralized approach to API Gateways for OpenShift on your way to service mesh</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在通向服务网格的道路上实现OpenShift的API网关的分散方法</h1>
<blockquote>原文：<a href="https://itnext.io/a-decentralized-approach-to-api-gateways-for-openshift-on-your-way-to-service-mesh-58c11f45044d?source=collection_archive---------7-----------------------#2019-08-09">https://itnext.io/a-decentralized-approach-to-api-gateways-for-openshift-on-your-way-to-service-mesh-58c11f45044d?source=collection_archive---------7-----------------------#2019-08-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="1258" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我遇到过很多客户，他们试图在自己的云原生架构中解决服务到服务的通信挑战。我特别感兴趣的是服务网格技术(<a class="ae kl" href="https://www.manning.com/books/istio-in-action" rel="noopener ugc nofollow" target="_blank">我正在编写Istio in Action </a>以便全面披露)，比如<a class="ae kl" href="https://linkerd.io" rel="noopener ugc nofollow" target="_blank"> LinkerD </a>、<a class="ae kl" href="https://istio.io" rel="noopener ugc nofollow" target="_blank"> Istio </a>或<a class="ae kl" href="https://www.consul.io" rel="noopener ugc nofollow" target="_blank">consult</a>。在我工作的地方，我们帮助组织成功地采用和管理这些系统，但是我们注意到我们的客户有一个有趣的趋势:</p><blockquote class="km kn ko"><p id="28c5" class="jn jo kp jp b jq jr js jt ju jv jw jx kq jz ka kb kr kd ke kf ks kh ki kj kk ij bi translated"><em class="iq">传统API管理解决方案正被用于解决一些相同的服务到服务的通信挑战，而服务网格现在可以更好地解决这些挑战。</em></p><p id="ac52" class="jn jo kp jp b jq jr js jt ju jv jw jx kq jz ka kb kr kd ke kf ks kh ki kj kk ij bi translated"><em class="iq">传统API管理已成为其架构和流程的瓶颈，因此需要一种分散的方法。</em></p></blockquote><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi kt"><img src="../Images/8560b90ac2536e1885a5fc1ff41a8db1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_LcpMKrH625qug29D92r5g.png"/></div></div></figure><p id="a691" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，我们最终看到人们构建他们的策略来采用服务网格来取代他们的遗留API管理解决方案，以应对这些服务到服务的通信挑战。</p><p id="dd87" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这些人没有错——但是，服务网格不是API管理解决方案。虽然服务网格可以很好地解决困难的服务到服务的通信挑战，但它仍然留下一些空白需要填补。例如，我们仍然需要处理最终用户认证和授权。我们可能需要整合现有的安全流程。我们可能需要某种轻量级协议或消息转换。我们可能需要更多特定领域的速率限制，以及许多其他限制。为此，我们的架构中仍然需要API网关功能— <a class="ae kl" href="https://medium.com/solo-io/api-gateways-are-going-through-an-identity-crisis-d1d833a313d7" rel="noopener">但是我们不希望像我们在旧的API管理解决方案中遇到的那样，只是重新创建相同的旧的集中式、类似ESB的瓶颈</a>。为此，<a class="ae kl" href="https://gloo.solo.io" rel="noopener ugc nofollow" target="_blank">我们需要一些Gloo </a>:一个API网关，它很好地补充了服务网格(当你准备好采用服务网格时),并解决这些问题，允许你抛弃臃肿的API中间件。</p><p id="e92b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的许多客户将他们的微服务部署到<a class="ae kl" href="https://www.openshift.com" rel="noopener ugc nofollow" target="_blank"> OpenShift </a>作为他们的Kubernetes。有时候，大型企业组织的<em class="kp">现实</em>决定了容器平台(即基于Kubernetes的平台)的哪些特性和流程会被使用，以及它们如何被使用。你们OpenShift用户知道我在说什么:)</p><p id="dc27" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，OpenShift有一个很好的开箱即用的<a class="ae kl" href="https://blog.openshift.com/create-s2i-builder-image/" rel="noopener ugc nofollow" target="_blank">源代码到docker容器构建</a>管道。根据我的经验，组织更喜欢对构建如何完成和供应链看起来如何有更多的控制，所以他们禁用了这个特性。还有其他一些场景，安全团队或网络团队会根据现有的网络规则和策略来强制执行OpenShift安装。一个这样的例子是，当一个团队部署一个应用程序(通常是一组服务)时，他们将应用程序部署到一个名称空间，并完全锁定对该名称空间的网络访问入口/出口。他们使用OpenShift的<a class="ae kl" href="https://docs.openshift.com/container-platform/3.5/architecture/additional_concepts/sdn.html" rel="noopener ugc nofollow" target="_blank">多租户SDN插件</a>来做到这一点。在某些情况下，去往集群内另一服务的流量会被强制带出集群，到达外部负载平衡器或API管理软件，然后返回集群。在很多方面都不理想，但这让网络和安全人员很高兴。</p><p id="22c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以使用<a class="ae kl" href="https://gloo.solo.io" rel="noopener ugc nofollow" target="_blank"> Gloo，一个基于Envoy Proxy </a>构建的API网关，即使在这些【有时】令人不舒服的约束<em class="kp">中，它也可以很好地适应分散式API网关，并且</em>可以充当您最喜欢的服务网格的垫脚石。</p><p id="e040" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">明确地说，本文的其余部分将集中在如何:</p><ul class=""><li id="22b7" class="lf lg iq jp b jq jr ju jv jy lh kc li kg lj kk lk ll lm ln bi translated">构建一个分散的API网关基础设施</li><li id="2077" class="lf lg iq jp b jq lo ju lp jy lq kc lr kg ls kk lk ll lm ln bi translated">很好地适应了这些不方便的现实</li><li id="8c92" class="lf lg iq jp b jq lo ju lp jy lq kc lr kg ls kk lk ll lm ln bi translated">支持传统API管理通常不支持的新协议</li><li id="210e" class="lf lg iq jp b jq lo ju lp jy lq kc lr kg ls kk lk ll lm ln bi translated">按照您自己的步调，提供通向全面服务网状网络的踏脚石</li></ul><h1 id="9407" class="lt lu iq bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">直接Gloo部署</h1><p id="1031" class="pw-post-body-paragraph jn jo iq jp b jq mr js jt ju ms jw jx jy mt ka kb kc mu ke kf kg mv ki kj kk ij bi translated">OpenShift自带一个<a class="ae kl" href="https://docs.openshift.com/container-platform/3.9/install_config/router/index.html" rel="noopener ugc nofollow" target="_blank">路由器</a>组件，它是集群的主要入口点。该路由器基于HAProxy，基本上充当L4反向代理和连接负载平衡器。它可以完成TLS终止并收集基本指标。对于Gloo的基本部署，我们可以将其添加到OpenShift路由器的后面。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/4a1a6bfab18301a747501796dfee16ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:948/format:webp/1*NrP9ycR52QYbUZ2YETQmbg.png"/></div></figure><p id="e8d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，尽管我们采取了额外的跳跃，但我们可以访问API网关功能，如最终用户身份验证/授权、请求缓存、请求/响应转换等，以及重要的L7网络控制，以执行流量阴影、流量转移和金丝雀部署等操作。这是一个巨大的收获，也是向服务网格所提供的更近了一步。另一方面，在集群中，这仍然是一个共享网关。在接下来的部分中，我们将看到如何部署更加分散的。</p><p id="da21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还要注意，虽然在这种情况下Gloo运行在OpenShift(一种Kubernetes)中，但Gloo仍然可以路由到不在OpenShift中托管的外部API，包括路由到像Lambda和Cloud函数这样的服务。</p><p id="a7b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除了在OpenShift路由器后面运行之外，我们还可以在基础设施节点上运行Gloo作为NodePort。这有直接暴露API网关和消除HAProxy跳跃的优点，但是有网络人员通常不喜欢NodePort的缺点。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/ea096995cd14fd528586386aedca210a.png" data-original-src="https://miro.medium.com/v2/resize:fit:918/format:webp/1*ehNSxG9THam-woOMI3-Snw.png"/></div></figure><p id="a01d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您还可以使用BGP路由或metallb之类的工具，通过负载均衡器直接公开Gloo。<a class="ae kl" href="https://medium.com/solo-io/running-gloo-as-a-kubernetes-ingress-for-bare-metal-clusters-with-metallb-35dd45d80629" rel="noopener">更多</a>请看本博客。</p><p id="2fe7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这一点上，这给了我们最简单的基本API网关功能，但是我们想探索分散部署的方法。目前，它仍然是相当集中和共享的，尽管从过程的角度来看不那么集中和共享，因为我们可以使用GitOps和其他声明性的、SCM驱动的方法来自助配置Gloo。Gloo的配置是声明性的，在Kubernetes/OpenShift中定义为CRDs。</p><p id="0279" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们需要进一步的隔离，我们也可以使用Gloo支持的代理分片，并将某些API分配给它们自己的网关。这涉及到少量的管理开销，但是允许您为更高价值的API分离故障域。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/3a3bc6bf445e105c3adab287a568e2fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:948/format:webp/1*Jt6HJW3leqfEwszsGXJfCA.png"/></div></figure><p id="fc09" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这解决了遗留API管理供应商遇到的一些问题，在这些问题中，单个API可能会关闭整个API集的网关，因为没有实施隔离或批量处理。</p><h1 id="a68a" class="lt lu iq bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">每个名称空间一个Gloo网关</h1><p id="bcbf" class="pw-post-body-paragraph jn jo iq jp b jq mr js jt ju ms jw jx jy mt ka kb kc mu ke kf kg mv ki kj kk ij bi translated">我们还可以为每个名称空间部署一个网关。正如我们所说，一些OpenShift环境不允许流量直接通过名称空间，除非通过众所周知的出口/入口点(通常由多租户SDN或网络策略控制)。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div class="gh gi my"><img src="../Images/85562312235b8e330c2dfb164d7e24f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:770/format:webp/1*41GkSkWic-LQLard5veCiQ.png"/></div></figure><p id="9406" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个场景中，每个代理都有自己的API网关配置，并由每个团队控制。我们可以访问API网关的全部功能，如速率限制、认证、缓存、流量路由/分流等。并且非常适合锁定的名称空间。请注意这是如何开始在集群中形成简单的路由网格的，但是是由各自的项目团队配置和控制的，而不是集中的配置存储。这种方法为API网关提供了很大的灵活性和团队所有权，并在组织内减少了争用点。</p><h1 id="6a48" class="lt lu iq bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">每个命名空间一个Gloo网关+控制平面</h1><p id="ff71" class="pw-post-body-paragraph jn jo iq jp b jq mr js jt ju ms jw jx jy mt ka kb kc mu ke kf kg mv ki kj kk ij bi translated">在前面的场景中，我们让每个OpenShift项目/名称空间都有自己的代理，但是Gloo控制平面仍然是共享的。对于更严格的环境，这可能并不理想，您可以只运行每个项目/名称空间的整个控制平面。Gloo的控制平面非常小，不占用太多资源，因此这可能是一种获得完全多租户并在强加的限制内舒适生活的好方法。当服务或用户与这些服务通信时，他们将通过OpenShift路由器(HAProxy)进入集群，然后路由到特定的应用程序及其API网关。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div class="gh gi my"><img src="../Images/227803039a5303f09932a940a2fce38e.png" data-original-src="https://miro.medium.com/v2/resize:fit:770/format:webp/1*u4y8LsVZwwwLE_CpJlsHlg.png"/></div></figure><h1 id="4e89" class="lt lu iq bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">摘要</h1><p id="ea1f" class="pw-post-body-paragraph jn jo iq jp b jq mr js jt ju ms jw jx jy mt ka kb kc mu ke kf kg mv ki kj kk ij bi translated">在这篇博客中，我们探讨了组织如何部署OpenShift Kubernetes以及如何利用遗留API管理基础设施的一些现实情况。我们还看到，由于一些OpenShift部署的现实，这些限制成为部署服务网格(如Istio)的高障碍，并有助于解释为什么OpenShift还不支持Istio。使用Gloo，我们不仅可以在这种环境中很好地发挥作用，让您更接近服务网格，而且我们可以解决现有API管理功能与您希望从服务网格中获得的东西之间的差距。最后，Gloo可以在任何服务网格中插入，并且可以在您的网格中扮演入口或共享网关的角色。我个人的建议一直是迭代地采用服务网格功能，这是使用Gloo(它基于与大多数服务网格相同的Envoy技术)来实现这一点的一个很好的例子。关注<a class="ae kl" href="https://twitter.com/soloio_inc" rel="noopener ugc nofollow" target="_blank">@ solio _ Inc</a>和<a class="ae kl" href="https://twitter.com/christianposta" rel="noopener ugc nofollow" target="_blank"> @christianposta </a>了解更多关于这些话题的信息！</p></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><p id="8e73" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kp">原载于2019年8月9日</em><a class="ae kl" href="https://medium.com/solo-io/decentralized-approach-to-api-gateways-for-openshift-on-your-way-to-service-mesh-cd3b4892c73f" rel="noopener"><em class="kp">https://medium.com</em></a><em class="kp">。</em></p></div></div>    
</body>
</html>