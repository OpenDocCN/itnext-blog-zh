<html>
<head>
<title>Generate Auto-Increment id on Azure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Azure上生成自动递增id</h1>
<blockquote>原文：<a href="https://itnext.io/generate-auto-increment-id-on-azure-62cc962b6fa6?source=collection_archive---------3-----------------------#2020-02-17">https://itnext.io/generate-auto-increment-id-on-azure-62cc962b6fa6?source=collection_archive---------3-----------------------#2020-02-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="b7be" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">AzureAutoNumber:用于Azure环境的高性能分布式唯一id生成器。</h2></div><p id="2d18" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你使用过<strong class="kh ir"> TableStorage </strong>或<strong class="kh ir"> Cosmos DB，</strong>你就会知道，由于一致性级别的原因，它们不提供自动增量id。但是在许多用例中，我们需要生成对人类友好的标识，以便于客户阅读。</p><p id="0232" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像GUID或UUID这样的ID太难看，太痛苦，记不住，想象一下下面的例子:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="b936" class="lk ll iq lg b gy lm ln l lo lp">Your order is on process. Please keep your invoice id for further tracking.</span><span id="128c" class="lk ll iq lg b gy lq ln l lo lp">Invoice id:<br/>e3a52fee-2ad5-4c35-b9c0-4edcf438bdff</span></pre><p id="1c19" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有一些变通方法可以在Azure上生成增量id，比如使用Azure SQL。但是，通过使用它，您可以将所有的写操作序列化到一个线程中，从而放弃了队列架构等所有可能的好处。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><p id="b378" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">投入一些时间后，我为它管理了一个图书馆；我把它叫做<a class="ae ly" href="https://www.nuget.org/packages/AzureAutoNumber/" rel="noopener ugc nofollow" target="_blank"> Azure AutoNumber </a>。该项目使用的是最新版本的Azure NuGet包，它支持<strong class="kh ir">。网标2.0 </strong>和<strong class="kh ir"> 2.1 </strong>。</p><figure class="lb lc ld le gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi lz"><img src="../Images/dde83a9c1d296cef72896125df9112f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2aH8ZTDZa1Koy1EOZTfB7g.png"/></div></div></figure><h2 id="6651" class="lk ll iq bd mh mi mj dn mk ml mm dp mn ko mo mp mq ks mr ms mt kw mu mv mw mx bi translated">如何使用自动号码</h2><p id="43fe" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">首先，通过NuGet安装它:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="afdc" class="lk ll iq lg b gy lm ln l lo lp">dotnet add package AzureAutoNumber --version 1.0.0</span></pre><p id="91fa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了生成id，您需要创建一个<code class="fe nd ne nf lg b">UniqueIdGenerator</code>类的<strong class="kh ir">单例</strong>实例。这个类依赖于<code class="fe nd ne nf lg b">BlobOptimisitcDataStorage</code>类。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="a3de" class="lk ll iq lg b gy lm ln l lo lp">var blobStorageAccount = Microsoft.WindowsAzure.Storage.CloudStorageAccount.Parse(connectionString);</span><span id="ce7c" class="lk ll iq lg b gy lq ln l lo lp">var blobOptimisticDataStore = new BlobOptimisticDataStore(blobStorageAccount, "unique-ids");</span><span id="3c48" class="lk ll iq lg b gy lq ln l lo lp">var idGenerator = new UniqueIdGenerator(blobOptimisticDataStore);</span></pre><p id="4092" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">BlobOptimisitcDataStorage将在blob存储上创建一个名为“unique-ids”的新容器。如前所述，UniqueIdGenerator的实例应该是每个应用程序域中的单例。</p><p id="a331" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在通过调用<strong class="kh ir"> NextId </strong>方法，很容易生成Id。NextId方法需要一个名为ScopeName的参数。通过ScopeName，您可以为不同的作用域创建不同的id。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="1f19" class="lk ll iq lg b gy lm ln l lo lp">var orderId = idGenerator.NextId("orders");<br/>var invoiceId = idGenerator.NextId("invoices");</span></pre><p id="a55a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你更喜欢在<a class="ae ly" href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-3.1" rel="noopener ugc nofollow" target="_blank">微软依赖注入</a>中注册<code class="fe nd ne nf lg b">IUniqueIdGenerator</code>及其依赖，你可以像下面的例子一样使用这个包的服务扩展。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="274d" class="lk ll iq lg b gy lm ln l lo lp">// configure the services<br/>services.AddAutoNumber();</span><span id="fda5" class="lk ll iq lg b gy lq ln l lo lp">// Inject `IUniqueIdGenerator` in constructor</span><span id="1df0" class="lk ll iq lg b gy lq ln l lo lp">public class Foo<br/>{<br/>  public Foo(IUniqueIdGenerator idGenerator)<br/>  {<br/>      _idGenerator = idGenerator;<br/>  }<br/>}</span></pre><p id="2fbf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">唯一的警告是你需要在注册<code class="fe nd ne nf lg b">AutoNumber</code>之前在DI中注册<code class="fe nd ne nf lg b">CloudStorageAccount</code>。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h2 id="0e8a" class="lk ll iq bd mh mi mj dn mk ml mm dp mn ko mo mp mq ks mr ms mt kw mu mv mw mx bi translated">它是如何工作的？</h2><p id="1928" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">首先，它为每个正在运行的实例分配一批id。Azure Blob存储用于协调这些批处理。Azure Blob存储通过标准HTTP头进行乐观并发检查。在持久化层面上，自动编号为每个id <strong class="kh ir">作用域</strong>创建一个小的文本文件。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="819a" class="lk ll iq lg b gy lm ln l lo lp">var orderId = idGenerator.NextId("orders");<br/>var invoiceId = idGenerator.NextId("invoices");</span></pre><p id="0396" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">考虑上面的例子；这两个调用将在容器上创建或修改两个新的文本文件。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="964e" class="lk ll iq lg b gy lm ln l lo lp">- unique-ids<br/>--- orders -&gt; contains "1"<br/>--- invoices -&gt; contains "2"</span></pre><p id="77ec" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以基本上，对于每个作用域，我们将有一个纯文本文件来存储该作用域最新生成的id。在第一次调用时，它会保留一批id，以备将来在应用程序域中使用。批量中的那些id，你不用就浪费了。为了更好地理解它，请看这张图表:</p><figure class="lb lc ld le gt ma gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/e15b7947f3c0758aa121a5418c788bef.png" data-original-src="https://miro.medium.com/v2/resize:fit:958/format:webp/1*2dR8Qb7RYxppOH5qhdLMVw.jpeg"/></div></figure><p id="c005" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您喜欢服务注册扩展方法，您可以通过<code class="fe nd ne nf lg b">appsettings.json</code>轻松设置批量大小。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="d061" class="lk ll iq lg b gy lm ln l lo lp">{<br/>  "AutoNumber": {<br/>    "BatchSize": 50,<br/>    "MaxWriteAttempts": 25,<br/>    "StorageContainerName": "unique-urls"<br/>  }<br/>}</span></pre><p id="5de2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者您可以通过<code class="fe nd ne nf lg b">BatchSize</code>属性进行更改:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="a128" class="lk ll iq lg b gy lm ln l lo lp">idGenerator.BatchSize = 25;</span></pre></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h2 id="c831" class="lk ll iq bd mh mi mj dn mk ml mm dp mn ko mo mp mq ks mr ms mt kw mu mv mw mx bi translated">源代码</h2><p id="a56f" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">你可以在<a class="ae ly" href="https://github.com/0x414c49/AzureAutoNumber" rel="noopener ugc nofollow" target="_blank"> GitHub </a>中访问源代码。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h2 id="54a3" class="lk ll iq bd mh mi mj dn mk ml mm dp mn ko mo mp mq ks mr ms mt kw mu mv mw mx bi translated">很高兴知道</h2><p id="d1c6" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">几年过去了<a class="ae ly" href="https://tatham.blog/2011/07/14/released-snowmaker-a-unique-id-generator-for-azure-or-any-other-cloud-hosting-environment/" rel="noopener ugc nofollow" target="_blank"> Tatham Oddie </a>发布了一个名为<strong class="kh ir"> SnowMaker </strong>的库。我分取了他的作品，并做了很多修改，以便在<strong class="kh ir">上发布。网标(2.0和2.1) </strong>。SnowMaker 已经过时了，使用的是非常旧版本的Azure包。这个项目的所有荣誉都归于他。</p></div></div>    
</body>
</html>