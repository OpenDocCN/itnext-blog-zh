<html>
<head>
<title>Telegram bot in Go: speak human</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">围棋中的电报机器人:说人话</h1>
<blockquote>原文：<a href="https://itnext.io/telegram-bot-in-go-speak-human-b2b4547cad29?source=collection_archive---------4-----------------------#2019-04-04">https://itnext.io/telegram-bot-in-go-speak-human-b2b4547cad29?source=collection_archive---------4-----------------------#2019-04-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/157357d80dc4783a173837edb9cb45ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*drTPwe0plVns6dfk9yhF9w.jpeg"/></div></div></figure><p id="7f46" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://medium.com/@detunized/telegram-bot-in-go-concurrent-sqlite-e6176fac088e" rel="noopener">上次</a>我对我的SQLite access基础进行了防弹测试。让我们看看它在生产中是否成立。太糟糕了，我永远也不会有那么高的负荷去打碎东西。哦，好吧，让我们拭目以待。也许我很幸运，两个可悲的并发请求最终会使我的Go二进制崩溃。</p><p id="714c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">今天，我将重点介绍特性。我想让我的机器人变得智能。不太喜欢，只是当你输入错误的命令时，听起来比<code class="fe ky kz la lb b">cmd.exe</code>好一点。我不会把事情搞大，更像是把脚趾浸在水里看看怎么样。</p><p id="35a8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，我想找到同名的最后一个事件，因为我将它们存储在数据库中，并发回事件的日期。想象这样的互动:</p><pre class="lc ld le lf gt lg lb lh li aw lj bi"><span id="7774" class="lk ll iq lb b gy lm ln l lo lp">me: eat<br/>bot: Previous 'eat' happened 6 hours ago</span></pre><p id="e7d1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要找到同名的事件，我必须让SQLite给我用户相同的那一行，事件的名称也相同，并且我想要按日期排序后的最后一行。将英语转换成SQL，我得到:</p><pre class="lc ld le lf gt lg lb lh li aw lj bi"><span id="705f" class="lk ll iq lb b gy lm ln l lo lp">SELECT date FROM events<br/>    WHERE user = ? AND name = ?<br/>    ORDER BY date<br/>    DESC LIMIT 1</span></pre><p id="0cbf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">很简单，是吧？现在，把它转换成Go和<code class="fe ky kz la lb b">crawshaw.io/sqlite</code>,我得到如下结果:</p><pre class="lc ld le lf gt lg lb lh li aw lj bi"><span id="4472" class="lk ll iq lb b gy lm ln l lo lp">// Default response<br/>response := fmt.Sprintf("Fist time for '%s'", name)<br/><br/>// Get the last event with the same name and format the response<br/>err := sqlitex.Exec(connection,<br/>    "SELECT date FROM events "+<br/>        "WHERE user = ? AND name = ? "+<br/>        "ORDER BY date "+<br/>        "DESC LIMIT 1",<br/>    func(s *sqlite.Stmt) error {<br/>        response = formatResponse(s.GetInt64("date"), name)<br/>        return nil<br/>    },<br/>    message.From.ID,<br/>    name)<br/><br/>// Send the message back to the user<br/>go func() {<br/>    bot.Send(tgbotapi.NewMessage(message.Chat.ID, response))<br/>}()</span></pre><p id="e1d7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">那里<code class="fe ky kz la lb b">formatResponse</code>非常简陋:</p><pre class="lc ld le lf gt lg lb lh li aw lj bi"><span id="f36a" class="lk ll iq lb b gy lm ln l lo lp">func formatResponse(date int64, name string) string {<br/>    last := time.Unix(date, 0)<br/>    return fmt.Sprintf("Previous '%s' happened on '%v'", name, last)<br/>}</span></pre><p id="4ca6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在交互看起来像这样:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lq"><img src="../Images/2ea9d579e143ccf27df55d3e92b46152.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hjvMPxUPQsB8HKqp.png"/></div></div></figure><p id="aff3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不完全是地球上最聪明的机器人，但我们要去某个地方。</p><p id="d177" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我想让它听起来少一点愚蠢，多一点人性，这两者并不总是一致的。在这种情况下，他们是。我不希望机器人说像<code class="fe ky kz la lb b">happened on '2019-04-04 14:13:57 +0200 CEST'</code>这样的话，而是像<code class="fe ky kz la lb b">8 minutes since</code>或<code class="fe ky kz la lb b">1 year since</code>这样的话。信不信由你，但是有一个专门的包装。欢迎<a class="ae kw" href="https://github.com/hako/durafmt" rel="noopener ugc nofollow" target="_blank"> hako/durafmt </a>。在它的帮助下，很容易将对话变成这样:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lr"><img src="../Images/260283a2f15aa3361995d565d3975117.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fTMsj0ZZKdjIKbgb.png"/></div></div></figure><p id="623c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">可读性要好得多。为了让它工作，我只需稍微修改一下<code class="fe ky kz la lb b">formatResponse</code>函数(现在它还必须接受当前的消息日期):</p><pre class="lc ld le lf gt lg lb lh li aw lj bi"><span id="9a59" class="lk ll iq lb b gy lm ln l lo lp">func formatResponse(name string, date int64, prevDate int64) string {<br/>    prev := time.Unix(prevDate, 0)<br/>    now := time.Unix(date, 0)<br/>    duration := durafmt.ParseShort(now.Sub(prev))<br/>    return fmt.Sprintf("%s since last '%s'", duration, name)<br/>}</span></pre><p id="dea6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">很简单。没有那么多台词，不到一个小时的工作，我就有了一个会说人话的机器人，它能告诉我上次发生了什么。装运它！🚢</p><p id="84fe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你好奇，可以在GitHub 上找到代码<a class="ae kw" href="https://github.com/detunized/since-bot/tree/day-4" rel="noopener ugc nofollow" target="_blank">。这个版本被标记为<code class="fe ky kz la lb b">day-4</code>。</a></p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="6915" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kx">原载于2019年4月4日</em><a class="ae kw" href="https://detunized.net/posts/2019-04-04-telegram-bot-in-go-speak-human/" rel="noopener ugc nofollow" target="_blank"><em class="kx">detunized.net</em></a>T22</p></div></div>    
</body>
</html>