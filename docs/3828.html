<html>
<head>
<title>A Kubefed tutorial to synchronise k8s clusters!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">同步k8s集群的Kubefed教程！</h1>
<blockquote>原文：<a href="https://itnext.io/a-kubefed-tutorial-to-synchronise-k8s-clusters-86108194ed79?source=collection_archive---------1-----------------------#2020-03-05">https://itnext.io/a-kubefed-tutorial-to-synchronise-k8s-clusters-86108194ed79?source=collection_archive---------1-----------------------#2020-03-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/cd4ef70ac367cccfcb2471df6ba33daa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i4h5AlFycPsfgH64NE_IGQ.png"/></div></div></figure><figure class="ja jb jc jd gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi iz"><img src="../Images/ead4fcd2cd9e68c4604c7a5b0aeead0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o76q3K8UoWjwU8unfuOe1Q.png"/></div></div></figure><div class=""/><p id="6121" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你接受的话，你的任务就是组装库伯菲德武器并联合联邦的集群！愿原力与你同在！</p><h1 id="5edf" class="lb lc jg bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">概念</h1><p id="8010" class="pw-post-body-paragraph kd ke jg kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">联邦在两个遥远的星球上安装了两个库本内特星团。</p><figure class="ja jb jc jd gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi me"><img src="../Images/f3055cc389a6eeb43452a4fc721afa97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-BvWE8QCU_SoQ4Ae3SSwlQ.png"/></div></div></figure><p id="d8ee" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，他们不得不乘坐航天飞机从一个星球旅行到另一个星球，以同步他们的部署。这需要太多的时间，船员们都筋疲力尽了。幸运的是，在一些前反叛者的帮助下，一项新技术被创造出来了！它可用于将一个集群的内容立即复制到另一个集群。</p><p id="54b6" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh">您为什么应该使用Kubefed？</strong></p><ul class=""><li id="b357" class="mf mg jg kf b kg kh kk kl ko mh ks mi kw mj la mk ml mm mn bi translated">如果你的星球被原子化，它将为你提供灾难恢复。</li><li id="ddb6" class="mf mg jg kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">动态调整部署了工作负载的集群中的副本。</li><li id="67eb" class="mf mg jg kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">通过在集群间分散负载实现高可用性。给那些反叛者一些工作！</li><li id="a701" class="mf mg jg kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">低延迟:在多个星球上部署集群，通过从离用户最近的集群为用户提供服务，最大限度地降低了延迟。这将有利于木星上的家伙！</li><li id="5fd3" class="mf mg jg kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">故障隔离:最好有多个小集群，而不是单个大集群来进行故障隔离。十个卫星上的小星团比主行星上的一个大星团要好！</li><li id="13d7" class="mf mg jg kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">混合云:不同云提供商或内部数据中心上的多个集群。与弗林斯人分享你的集群？</li><li id="96da" class="mf mg jg kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">因为这很酷，而且联邦需要你。</li></ul><p id="0efb" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它是如何工作的？<br/>kube fed控制平面由运行在其中一个联合集群上的操作符组成。该操作员负责一些必须在主集群上部署的定制资源定义。如果您想在所有列出的集群上复制一个资源，那么您只需应用一个CRD:当操作员看到它时，它将为您在任何地方部署您的应用程序。您甚至可以覆盖特定集群的一些值！</p><p id="023b" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh">我们将在这里讨论什么？</strong></p><ul class=""><li id="8917" class="mf mg jg kf b kg kh kk kl ko mh ks mi kw mj la mk ml mm mn bi translated">使用RBAC(和空间继电器)连接两个集群。</li><li id="dbc3" class="mf mg jg kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">允许复制特定的资源类型。例如，您必须激活“服务”使其成为联盟的一部分。否则，同步将会失败，以帝国的胜利而告终。:-(</li><li id="f44b" class="mf mg jg kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">通过在应用程序上创建包装器来开始联合资源。</li><li id="4fe3" class="mf mg jg kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">拯救银河系。</li></ul><p id="40bb" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将把安装在联邦总部的集群称为“主”集群，把安装在侦察哨站的集群称为“从”集群。</p><p id="17c5" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">寻找真实的东西？<a class="ae mt" href="https://github.com/kubernetes-sigs/kubefed" rel="noopener ugc nofollow" target="_blank">点击这里</a>访问github！</p><h1 id="e997" class="lb lc jg bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">Kubefed装置</h1><h2 id="859f" class="mu lc jg bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated">第一步:安装库伯菲德武器</h2><p id="a594" class="pw-post-body-paragraph kd ke jg kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">该武器只需在你决定作为主集群的集群上安装一次。在本教程中，我们将只使用两个集群，一个称为主集群，另一个称为从集群。</p><p id="74be" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你需要一个工作舵来安装库伯菲德海图:</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="df11" class="mu lc jg nh b gy nl nm l nn no">##On the master##<br/>helm init<br/>helm repo add kubefed-charts <a class="ae mt" href="https://raw.githubusercontent.com/kubernetes-sigs/kubefed/master/charts" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kubernetes-sigs/kubefed/master/charts</a><br/>helm install kubefed-charts/kubefed --version 0.1.0-rc6 --name kubefed --namespace kube-federation-system</span></pre><p id="3946" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">稍后，您还将需要二进制文件“kubefedctl ”,所以现在就从Kubefed资源库下载它。本教程使用的是版本<a class="ae mt" href="https://github.com/kubernetes-sigs/kubefed/releases/tag/v0.1.0-rc6" rel="noopener ugc nofollow" target="_blank"> v0.1.0-rc6 </a>。</p><h2 id="afc8" class="mu lc jg bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated">第二步:使用RBAC激活空间继电器</h2><p id="6d00" class="pw-post-body-paragraph kd ke jg kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated"><strong class="kf jh"> <em class="np">设置RBAC </em> </strong> <br/>为了让Kubefed武器联合您在主集群和从集群上的部署，它必须能够与它们进行交互。<br/>为此，您可以使用以下RBAC配置/命令来创建相应的配置。<strong class="kf jh">这与Kubefed没有直接关系，但本指南内容广泛，提出这一点很重要。</strong> <br/>以下内容必须应用于从机，但<strong class="kf jh">不能应用于主机。</strong></p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="358e" class="mu lc jg nh b gy nl nm l nn no">##On the slave##<br/>apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  labels:<br/>    name: &lt;REPLACE_ME&gt;<br/>  name: &lt;REPLACE_ME&gt;<br/>---<br/>apiVersion: rbac.authorization.k8s.io/v1beta1<br/>kind: ClusterRole<br/>metadata:<br/>  labels:<br/>    name: &lt;REPLACE_ME&gt;<br/>  name: &lt;REPLACE_ME&gt;<br/>rules:<br/>  - apiGroups: ['*']<br/>    resources: ['*']<br/>    verbs: ['*']<br/>  - nonResourceURLs: ['*']<br/>    verbs: ['*']<br/>---<br/>apiVersion: rbac.authorization.k8s.io/v1beta1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  labels:<br/>    name: &lt;REPLACE_ME&gt;<br/>  name: &lt;REPLACE_ME&gt;<br/>roleRef:<br/>  apiGroup: rbac.authorization.k8s.io<br/>  kind: ClusterRole<br/>  name: &lt;REPLACE_ME&gt;<br/>subjects:<br/>  - kind: ServiceAccount<br/>    name: &lt;REPLACE_ME&gt;<br/>    namespace: default</span></pre><p id="4545" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">用集群的名称替换所有的<replace_me>标签。为简单起见，姑且称之为“奴隶”。稍后您将使用相同的名称在主服务器上创建上下文。</replace_me></p><p id="3099" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后检索新创建的服务帐户的令牌:</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="d4f5" class="mu lc jg nh b gy nl nm l nn no">##On the slave##<br/>kubectl get secrets<br/>kubectl describe secret &lt;REPLACE_ME&gt;-token-XXXX</span></pre><p id="354c" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将令牌保存在某个地方，我们将在下一步中需要它。如果你有更多的奴隶，重复上述步骤。<br/>从服务器上的最后一步:在<code class="fe nq nr ns nh b">/etc/kubernetes/ssl/ca.crt</code>获取证书，并将其复制到主服务器上您想要的任何位置。</p><p id="38c4" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh"> <em class="np">设置库贝语境</em> </strong></p><p id="3f8e" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，登录到主服务器。从那里，您将使用上面的令牌连接到从设备。</p><p id="2673" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要链接集群，请执行以下操作:</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="4ab1" class="mu lc jg nh b gy nl nm l nn no">##On the master##<br/>kubectl config set-credentials kubefed-user --token="&lt;TOKEN_FROM_SLAVE&gt;"</span><span id="5b90" class="mu lc jg nh b gy nt nm l nn no">kubectl config set-cluster kubefedRemote --server=https://&lt;IP_FROM_SLAVE&gt;:6443 #This is the IP of one the kubernetes "master" nodes of your slave cluster</span><span id="9633" class="mu lc jg nh b gy nt nm l nn no">kubectl config set-context &lt;REPLACE_ME&gt; --cluster=kubefedRemote --user=kubefed-user --namespace="default" #Better to use the same name as the one you chose for the RBAC yaml previoulsy. I called it "slave".</span></pre><blockquote class="nu nv nw"><p id="6b0f" class="kd ke np kf b kg kh ki kj kk kl km kn nx kp kq kr ny kt ku kv nz kx ky kz la ij bi translated">如果您有多个从属服务器，不要忘记定制凭证和集群名称！</p></blockquote><p id="f88c" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在您已经设置了上下文并加载了证书，您只需要编辑<code class="fe nq nr ns nh b">~/kube/config</code>文件并添加以下密钥:</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="34ac" class="mu lc jg nh b gy nl nm l nn no">##On the master##<br/>certificate-authority: &lt;path-to-copied-cert-from-slave&gt;</span></pre><p id="2f55" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将上述键添加到之前使用<code class="fe nq nr ns nh b">set-cluster</code>命令创建的<code class="fe nq nr ns nh b">cluster </code>部分。如果您使用与前面提到的完全相同的命令，那么您正在寻找的部分具有键“name: kubefedRemote”。</p><p id="a9ad" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，它应该看起来像下面这样:</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="9cdf" class="mu lc jg nh b gy nl nm l nn no">##On the master##<br/>- cluster:<br/>    server: <a class="ae mt" href="https://IP_OF_SLAVE:6443" rel="noopener ugc nofollow" target="_blank">https://IP_OF_SLAVE:6443</a><br/>    certificate-authority: /PATH_OF_CERT_FROM_SLAVE/ca.crt<br/>  name: kubefedRemote</span></pre><p id="9aa2" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后一步！用更轻松的东西更新你当前的背景。一般来说，创建的默认上下文是<code class="fe nq nr ns nh b">kubernetes-admin@cluster.local</code>。将所有这些文档替换为“主文档”。Kubefed不喜欢“@”之类的东西，当以后加入集群时，这将是一个问题。只要用你想要的任何东西更新默认值。看在本教程的份上，我建议你选择“大师”。</p><blockquote class="nu nv nw"><p id="6eae" class="kd ke np kf b kg kh ki kj kk kl km kn nx kp kq kr ny kt ku kv nz kx ky kz la ij bi translated">如果您做的一切都是正确的，用您创建的从上下文更新键<code class="fe nq nr ns nh b">current-context</code>应该允许您直接从主上下文与从上下文交互。试试<code class="fe nq nr ns nh b">kubectl get pod</code>应该显示出奴隶的豆荚。当你的测试完成时，不要忘记恢复<code class="fe nq nr ns nh b">current-context</code>的值。</p></blockquote><h2 id="c77c" class="mu lc jg bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated">步骤3:加入集群</h2><p id="0579" class="pw-post-body-paragraph kd ke jg kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">现在，我们两个遥远星球上的两个星团之间的通信正常了，我们终于可以使用Kubefed让他们都加入联邦了。</p><p id="6411" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，您需要从git存储库中下载_kubefedctl_ binary。将其添加到您的主人的<strong class="kf jh"> $PATH </strong>中。<br/>然后使用join命令将它们连接起来:</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="8c47" class="mu lc jg nh b gy nl nm l nn no">##On the master##<br/>kubefedctl join &lt;CTX_MASTER&gt; --v=2 --host-cluster-context &lt;CTX_MASTER&gt; --kubefed-namespace=kube-federation-system</span><span id="aec1" class="mu lc jg nh b gy nt nm l nn no">kubefedctl join &lt;CTX_SLAVE&gt; --v=2 --host-cluster-context &lt;CTX_MASTER&gt; --kubefed-namespace=kube-federation-system</span></pre><ul class=""><li id="b08c" class="mf mg jg kf b kg kh kk kl ko mh ks mi kw mj la mk ml mm mn bi translated"><code class="fe nq nr ns nh b">&lt;CTX_MASTER&gt;</code>是代表主人的上下文的名称(如果你不知道在哪里可以找到它，它就写在你的<code class="fe nq nr ns nh b">~/.kube/config</code>文件中)。</li><li id="289c" class="mf mg jg kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated"><code class="fe nq nr ns nh b">&lt;CTX_SLAVE&gt;</code>是您在前面的步骤中创建的上下文的名称(它也在您的<code class="fe nq nr ns nh b">~/.kube/config</code>文件中，因为您的每个从设备都有一个条目)。</li><li id="600b" class="mf mg jg kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated"><code class="fe nq nr ns nh b">host-cluster-context</code>总是主上下文的名称。因此，这两个命令是相同的。</li></ul><p id="59a5" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要检查连接是否正常工作以及武器是否准备好用于摧毁帝国，您可以使用以下命令检查联邦的状态:</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="4ee8" class="mu lc jg nh b gy nl nm l nn no">##On the master##<br/>kubectl -n kube-federation-system get kubefedclusters<br/>NAME READY AGE<br/>master True 22m<br/>slave True 19m</span></pre><p id="09b4" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它应该为每一行返回“真”。</p><p id="9823" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您想要停止一个或多个集群的联合，请使用<code class="fe nq nr ns nh b">unjoin</code>命令:</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="4b68" class="mu lc jg nh b gy nl nm l nn no">##On the master##<br/>kubefedctl unjoin ctx1<br/>kubefedctl unjoin ctx2</span></pre><h1 id="e35a" class="lb lc jg bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">开始联盟！</h1><h2 id="0555" class="mu lc jg bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated">步骤A:授权联合资源</h2><p id="9442" class="pw-post-body-paragraph kd ke jg kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">只有在您首先启用了要部署的特定资源的“kind: xx”时，联合资源才会起作用。每个资源只需执行一次，并将创建一个描述它的CRD。</p><p id="7962" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为此，您必须使用<code class="fe nq nr ns nh b">kubefedctl enable</code>命令。它的参数是资源的种类，后跟API组:</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="6696" class="mu lc jg nh b gy nl nm l nn no">kubefedctl enable &lt;kind.api&gt; --kubefed-namespace &lt;NAMESPACE_INSTALL_KUBEFED&gt; kube-federation-system</span></pre><p id="4581" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，要启用部署，您必须将“部署”与其API组“应用程序”连接起来</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="dd43" class="mu lc jg nh b gy nl nm l nn no">##On the master##<br/>kubefedctl enable deployments.apps --kubefed-namespace kube-federation-system</span></pre><p id="fa4e" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">服务业也是如此。它的API组是" "(空引号)，所以你不必在那里附加任何东西。</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="8211" class="mu lc jg nh b gy nl nm l nn no">##On the master##<br/>kubefedctl enable services --kubefed-namespace kube-federation-system</span></pre><p id="41ea" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要获得所有kubernetes资源及其相应API组的列表，请使用:</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="cfff" class="mu lc jg nh b gy nl nm l nn no">##On the master##<br/>kubectl api-resources -o wide</span></pre><blockquote class="nu nv nw"><p id="9f83" class="kd ke np kf b kg kh ki kj kk kl km kn nx kp kq kr ny kt ku kv nz kx ky kz la ij bi translated"><strong class="kf jh">警告</strong>除非您知道自己在做什么，否则不要联合“kind: pod”资源。在这种情况下，联合整个名称空间将同时联合pod和部署。部署将创建副本集，副本集又会创建pod。这将导致圆荚体资源的复制，并创造一个黑洞，将你的星团和整个地球一起吸走。</p></blockquote><p id="469b" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要停止联合资源，请使用disable命令将其禁用:</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="bd1a" class="mu lc jg nh b gy nl nm l nn no">##On the master##<br/>kubefedctl disable &lt;resource&gt;</span></pre><p id="8be1" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，要停用服务:</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="e9dd" class="mu lc jg nh b gy nl nm l nn no">kubefedctl disable service</span></pre><p id="b471" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">kubefed的所有服务操作都将停止。创建federatedServices不会创建任何服务。删除federatedServices也不会删除任何服务。<br/>你必须使用<code class="fe nq nr ns nh b">kubefedctl enable</code>恢复联盟，以夺回你的资源控制权。</p><h2 id="cb89" class="mu lc jg bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated">步骤B:联合资源</h2><p id="4185" class="pw-post-body-paragraph kd ke jg kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated"><strong class="kf jh"> <em class="np">从哪里开始</em> </strong></p><p id="106b" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在是联合资源并赢得战争的时候了。</p><p id="3ef8" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您要做的第一件事是创建一个名称空间。<br/> <code class="fe nq nr ns nh b">kubectl create ns stars</code></p><p id="d9b7" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后创建一个联合名称空间:</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="6761" class="mu lc jg nh b gy nl nm l nn no">##On the master##<br/>apiVersion: types.kubefed.io/v1beta1<br/>kind: FederatedNamespace<br/>metadata:<br/>  name: stars #&lt;= must be identical to the kubernetes namespace you created with kubectl<br/>  namespace: stars #&lt;= same<br/>spec:<br/>  placement:<br/>    clusters:<br/>    - name: &lt;REPLACE_ME&gt; #Replace this with the name of your master's context name<br/>    - name: &lt;REPLACE_ME&gt; #Replace this with the name of your slave's context name<br/>    - name: … #If you have more slaves then add more elements</span></pre><p id="2c07" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在只应用这个…它会在接下来的步骤中变得更清晰。请记住，为了创建federatedNamespace资源，您首先必须有一个存在的名称空间(它必须存储在某个地方……)。</p><p id="29a7" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果一切正常，您应该会看到这个名称空间立即在您的所有奴隶上生成！神奇！或者是？</p><p id="825f" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所见即所得:</p><figure class="ja jb jc jd gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oa"><img src="../Images/f898bf0895c99e979d922a10e9658139.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X1gMzk4sxc0BHjVcMnvoGQ.png"/></div></div></figure><p id="0bc9" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh"> <em class="np">学习如何使用模板</em> </strong></p><p id="2141" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们进入问题的核心。<strong class="kf jh">如何联合资源？</strong></p><p id="716c" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">嗯……这很容易。您必须用一些Kubefed来包装您现有的yaml。<br/>这是要使用的包装模板:</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="50be" class="mu lc jg nh b gy nl nm l nn no">apiVersion: types.kubefed.io/v1beta1<br/>kind: FederatedDeployment<br/>metadata:<br/>  name: some-federated-deployment<br/>  namespace: &lt;FEDERATED_NS&gt;<br/>spec:<br/>  template:<br/>    &lt;&lt; DEPLOYMENT SPEC &gt;&gt;<br/>  placement:<br/>    clusters: #List of your clusters : master + slave<br/>    - name: master<br/>    - name: slave <br/>  overrides: #This is given as an example but is an optionnal section<br/>  - clusterName: master<br/>    clusterOverrides:<br/>    - path: "/spec/replicas"<br/>      value: 2</span></pre><p id="5d23" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是什么？</p><ul class=""><li id="2e4c" class="mf mg jg kf b kg kh kk kl ko mh ks mi kw mj la mk ml mm mn bi translated">“位置”部分告诉您的应用程序必须部署在哪里。在上面的例子中，它将被部署在主服务器(联邦资源附带位于这里)和从服务器上。你可以拥有更多的奴隶而不把他们列入名单。如果您愿意，也可以从列表中删除主服务器。<br/>一切尽在掌握！</li><li id="e431" class="mf mg jg kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">“覆盖”部分允许您覆盖特定集群上的一些值。在上面的示例中，名为“master”的群集的副本计数被覆盖为2。这意味着该应用程序将在这个特定的集群上产生两次。在所有其他集群上，部署中设置的默认值仍然适用。<strong class="kf jh">该部分是可选的，如果没有要覆盖的内容，可以删除</strong>。</li></ul><blockquote class="nu nv nw"><p id="df61" class="kd ke np kf b kg kh ki kj kk kl km kn nx kp kq kr ny kt ku kv nz kx ky kz la ij bi translated">如何将您的应用程序与该模板合并？<br/>很简单，取你的应用程序的yaml，去掉前两行(kind + api)。将模板中的其余部分复制到“&lt; &lt;部署规范&gt; &gt;”标签中。通常应该是从左边4个空格。你可能不得不重新缩进所有其他行的4个空格，因为大多数复制粘贴引擎将无法保持缩进。</p></blockquote><p id="a0cf" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh"> <em class="np">联邦成员部署</em> </strong></p><p id="fc72" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了保卫地球，我们使用X翼应用程序。让我们用Kubefed模板包装它。</p><p id="1f02" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">原始应用程序:</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="ede8" class="mu lc jg nh b gy nl nm l nn no">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: xwings<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: httpbin<br/>      version: v1<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: httpbin<br/>        version: v1<br/>    spec:<br/>      containers:<br/>      - image: docker.io/kennethreitz/httpbin #Even 2000 years from now we will still use HttpBin<br/>        imagePullPolicy: IfNotPresent<br/>        name: httpbin<br/>        ports:<br/>        - containerPort: 80</span></pre><p id="7ebd" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们将X翼的“规格”合并到模板中:</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="eba4" class="mu lc jg nh b gy nl nm l nn no">##On the master##<br/>apiVersion: types.kubefed.io/v1beta1<br/>kind: FederatedDeployment<br/>metadata:<br/>  name: federated-xwings<br/>  namespace: stars<br/>spec:<br/>  template:<br/>    metadata:<br/>      name: xwings<br/>    spec:<br/>      replicas: 1<br/>      selector:<br/>        matchLabels:<br/>          app: httpbin<br/>          version: v1<br/>      template:<br/>        metadata:<br/>          labels:<br/>            app: httpbin<br/>            version: v1<br/>        spec:<br/>          containers:<br/>          - image: docker.io/kennethreitz/httpbin #Even 2000 years from now we will still use HttpBin<br/>            imagePullPolicy: IfNotPresent<br/>            name: httpbin<br/>            ports:<br/>            - containerPort: 80<br/>  placement:<br/>    clusters:<br/>    - name: master<br/>    - name: slave<br/>  overrides:<br/>    - clusterName: master<br/>      clusterOverrides:<br/>      - path: "/spec/replicas"<br/>        value: 2</span></pre><p id="a7ef" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">“kind: xx”是字符串“federated”的串联&amp;要联合的资源。这里是一个部署，所以资源是“federatedDeployment”。如果它是一个服务，那么它将是“联邦服务”。入口可以是“federatedIngress”等。</p><p id="ea45" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这就是所有人…现在你几乎可以摆脱只包含X-Wings应用程序的yaml，因为从现在起你将只使用联邦版本。</p><p id="cd5d" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以在主服务器上应用我们创建的<strong class="kf jh">联邦部署，但前提是您已经使用<code class="fe nq nr ns nh b">kubefedctl enable …</code>启用了“部署”资源(参见上文)。Kubefed将在所有列出的集群上为您创建应用程序。看看吧！</strong></p><p id="3679" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们的主星球上，由于集群覆盖，我们将有两个X翼应用程序，而在从星球上只有一个。我们安全了，骑兵来了！</p><figure class="ja jb jc jd gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi me"><img src="../Images/a1f6360eaa3eede4f6683041fd168e4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4ymhv9s6XlBag6_EX8CwIQ.png"/></div></div></figure><p id="2334" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">需要明确的是，从现在开始，您将永远不必处理X-Wings应用程序本身，而只需处理联邦应用程序。<br/>例如，要删除您的X-Wings，只需删除我们创建的federatedDeployment，Kubefed就会从所有集群中删除该应用程序。如果你删除了应用程序本身，Kubefed会为你重新创建一个。好孩子！</p><p id="91ff" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是我们所做的:</p><figure class="ja jb jc jd gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ob"><img src="../Images/656363b00c405d8b44823e242c427536.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7NAWjps6ohiiXIDZPkYu5g.png"/></div></div></figure><p id="ccf6" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh"> <em class="np">联邦成员服务</em> </strong></p><p id="1e54" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们对X-Wings服务做同样的事情。如果能和中队沟通就更好了！</p><p id="89a7" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">原始服务:</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="4469" class="mu lc jg nh b gy nl nm l nn no">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: antenna<br/>  labels:<br/>    app: httpbin<br/>spec:<br/>  ports:<br/>  - name: http<br/>    port: 8000<br/>    targetPort: 80<br/>  selector:<br/>    app: httpbin</span></pre><p id="42c9" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们将它包装在模板中:</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="4ded" class="mu lc jg nh b gy nl nm l nn no">##On the master##<br/>apiVersion: types.kubefed.io/v1beta1<br/>kind: FederatedService<br/>metadata:<br/>  name: federated-antenna<br/>  namespace: stars<br/>spec:<br/>  template:<br/>    metadata:<br/>      name: antenna<br/>      labels:<br/>        app: httpbin<br/>    spec:<br/>      ports:<br/>      - name: http<br/>        port: 8000<br/>        targetPort: 80<br/>      selector:<br/>        app: httpbin<br/>  placement:<br/>    clusters:<br/>    - name: master<br/>    - name: slave</span></pre><p id="a9b4" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用<code class="fe nq nr ns nh b">kubefedctl enable...</code>启用“服务”资源后，在主机上应用服务。<br/>该服务现在应该出现在您列出的所有集群上，并且X-Wings应该可以通过antena访问(我们刚刚为那些感到失落的人提供的服务)。<br/>请注意，更改或删除federatedService几乎会立即反映在集群上。</p><figure class="ja jb jc jd gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi me"><img src="../Images/bb64a49814d6122d2eada12df2f9e8f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ahRVYQftiiZBVta8Bk9ATQ.png"/></div></div></figure><p id="248e" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">列出kubefed为我们创造的服务:</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="0fb1" class="mu lc jg nh b gy nl nm l nn no">$ kubectl get svc -n stars<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br/>federated-antenna ClusterIP 10.233.32.129 &lt;none&gt; 8000/TCP 22m</span></pre><p id="7c0b" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们尝试使用服务与我们的x翼通信:</p><pre class="ja jb jc jd gt ng nh ni nj aw nk bi"><span id="7866" class="mu lc jg nh b gy nl nm l nn no">$ curl 10.233.32.129:8000/status/200 -vv<br/>* About to connect() to 10.233.32.129 port 8000 (#0)<br/>* Trying 10.233.32.129…<br/>* Connected to 10.233.32.129 (10.233.32.129) port 8000 (#0)<br/>&gt; GET /status/200 HTTP/1.1<br/>&gt;<br/>&lt; HTTP/1.1 200 OK<br/>* Connection #0 to host 10.233.32.129 left intact</span></pre><p id="800d" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">成功了！行星得救了。</p><p id="ab71" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">事情是这样的:</p><figure class="ja jb jc jd gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oc"><img src="../Images/54da114ece0551cfbb290c2f7faabcaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SobEYfc1VMcHgrKGJwPaoQ.png"/></div></div></figure><h1 id="e9ec" class="lb lc jg bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">解决纷争</h1><p id="7c18" class="pw-post-body-paragraph kd ke jg kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">如果群集中没有任何变化，请检查以下可能的解决方案:</p><ul class=""><li id="cf48" class="mf mg jg kf b kg kh kk kl ko mh ks mi kw mj la mk ml mm mn bi translated">使用<code class="fe nq nr ns nh b">kubectl -n kube-federation-system get kubefedclusters</code>检查集群是否联合。</li><li id="de11" class="mf mg jg kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">检查“种类:xx”是否正确。“FederatedService”用于服务，而“FederatedDeployment”用于部署。对于任何其他资源，应用连接规则。</li><li id="6c7c" class="mf mg jg kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">尝试使用<code class="fe nq nr ns nh b">kubectl describe federatedXXXXX</code>描述联邦资源。事件部分有很多信息。</li><li id="121f" class="mf mg jg kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">首先使用<code class="fe nq nr ns nh b">kubefedctl enable XXXXXX</code>确保您想要部署的资源已经被启用。</li><li id="98fe" class="mf mg jg kf b kg mo kk mp ko mq ks mr kw ms la mk ml mm mn bi translated">检查yaml是否正确。使用模板，如果需要，更新“种类:xx”。然后，把你原来的yaml除了前两行(kind + api)之外，和模板合并。应该从左边粘贴4个空格。大多数复制粘贴引擎将无法正确粘贴其他行，所以你可能需要重新缩进4个空格。</li></ul><p id="2081" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们的旅程到此结束，年轻的学徒。现在，您可以联合任意数量的集群。正如我的一位绿色老朋友所说，“把你学到的东西传递下去”。</p></div></div>    
</body>
</html>