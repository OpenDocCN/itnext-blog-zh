<html>
<head>
<title>Secure MinIO At-Rest with Vault</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用保险库保护静态MinIO</h1>
<blockquote>原文：<a href="https://itnext.io/secure-minio-at-rest-with-vault-ce319f8b6274?source=collection_archive---------3-----------------------#2021-03-16">https://itnext.io/secure-minio-at-rest-with-vault-ce319f8b6274?source=collection_archive---------3-----------------------#2021-03-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/49aef4295077c14495398ef0416600ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZvTW19G8NyR6s58c"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@bist31?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Birger Strahl </a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="343a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您想使用MinIO公开S3服务，您应该考虑让MinIO数据在传输中和静态时都是安全的。在<a class="ae kc" href="https://mykidong.medium.com/secure-minio-not-on-kubernetes-46dd90ccb1c" rel="noopener">上一篇文章</a>中，我谈到了保护传输中的MinIO。在这篇文章中，我将展示如何使用Vault来保护MinIO的静态安全。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><p id="5a7f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有许多密钥管理系统(KMS ),如Hashicorp Vault、AWS Secrets Manager、GCP Secret Manager和金雅拓KeySecure等。在外面。在这里，金库将被用作KMS。</p><p id="29b5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们来看下图，看看如何用vault加密MinIO数据。</p><figure class="lj lk ll lm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi li"><img src="../Images/d265bf111f6fcb3a1931f8a3d097485f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6HujdLeNuWKXdcbg5u-I5Q.png"/></div></div></figure><p id="342c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了加密MinIO数据，我们需要一个KMS，但不是直接访问KMS，而是像Vault一样有<code class="fe ln lo lp lq b"><a class="ae kc" href="https://github.com/minio/kes" rel="noopener ugc nofollow" target="_blank">KES</a></code>作为MinIO服务器和KMS之间的桥梁。有了这个概念，KES可以处理KMS的所有复杂问题，MinIO可以轻松地通过REST访问KES。这里用作KMS的Vault将通过类似NGINX的TLS代理访问，Hashicorp的<code class="fe ln lo lp lq b">Consul</code>将用作Vault的存储。</p><h2 id="13ca" class="lr ls iq bd lt lu lv dn lw lx ly dp lz ko ma mb mc ks md me mf kw mg mh mi mj bi translated">安装领事作为保险库的存储</h2><p id="3dff" class="pw-post-body-paragraph kd ke iq kf b kg mk ki kj kk ml km kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">如上图所示，在安装Vault之前，我们先安装Consul cluster，用于Vault的存储。</p><p id="cad4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要安装consul二进制文件，请运行以下命令。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="32e6" class="lr ls iq lq b gy mt mu l mv mw"># Install yum-config-manager to manage your repositories.<br/>sudo yum install -y yum-utils;</span><span id="afe1" class="lr ls iq lq b gy mx mu l mv mw"># Use yum-config-manager to add the official HashiCorp Linux repository.<br/>sudo yum-config-manager --add-repo <a class="ae kc" href="https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo" rel="noopener ugc nofollow" target="_blank">https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo</a>;</span><span id="3029" class="lr ls iq lq b gy mx mu l mv mw"># Find available versions to install.<br/>yum --showduplicate list consul;</span><span id="87cc" class="lr ls iq lq b gy mx mu l mv mw"># Install a specific version.<br/>sudo yum install consul-1.9.3-1.x86_64 -y;</span><span id="2c1e" class="lr ls iq lq b gy mx mu l mv mw"># Verify the installation.<br/>consul;</span></pre><p id="7060" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">生成一个八卦加密密钥。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="ef4c" class="lr ls iq lq b gy mt mu l mv mw">consul keygen;<br/>+jqLwl3qx1FiOYS9+l1X4n8alHYXKy8ErTnpGiYs9gg=</span></pre><p id="6951" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并且，为RPC加密生成TLS证书。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="2fcf" class="lr ls iq lq b gy mt mu l mv mw">## Create the Certificate Authority.<br/>consul tls ca create;<br/>==&gt; Saved consul-agent-ca.pem<br/>==&gt; Saved consul-agent-ca-key.pem</span><span id="bd73" class="lr ls iq lq b gy mx mu l mv mw">## Create the certificates.<br/>consul tls cert create -server -dc dc1;<br/>==&gt; WARNING: Server Certificates grants authority to become a<br/>    server and access all state in the cluster including root keys<br/>    and all ACL tokens. Do not distribute them to production hosts<br/>    that are not server nodes. Store them as securely as CA keys.<br/>==&gt; Using consul-agent-ca.pem and consul-agent-ca-key.pem<br/>==&gt; Saved dc1-server-consul-0.pem<br/>==&gt; Saved dc1-server-consul-0-key.pem</span></pre><p id="12cd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建领事目录。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="b9ef" class="lr ls iq lq b gy mt mu l mv mw">sudo mkdir -p /etc/consul.d /export/consul-data;<br/>sudo chown -R consul:consul /etc/consul.d /export/consul-data;<br/>sudo chmod 777 /etc/consul.d /export/consul-data;</span></pre><p id="d39f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将所有生成的证书复制到所有consul节点。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="7193" class="lr ls iq lq b gy mt mu l mv mw">scp consul-agent-ca.pem consul-0:/etc/consul.d;<br/>scp consul-agent-ca.pem consul-1:/etc/consul.d;<br/>scp consul-agent-ca.pem consul-2:/etc/consul.d;</span><span id="955e" class="lr ls iq lq b gy mx mu l mv mw">scp dc1-server-consul-0.pem consul-0:/etc/consul.d<br/>scp dc1-server-consul-0.pem consul-1:/etc/consul.d<br/>scp dc1-server-consul-0.pem consul-2:/etc/consul.d</span><span id="a587" class="lr ls iq lq b gy mx mu l mv mw">scp dc1-server-consul-0-key.pem consul-0:/etc/consul.d<br/>scp dc1-server-consul-0-key.pem consul-1:/etc/consul.d<br/>scp dc1-server-consul-0-key.pem consul-2:/etc/consul.d</span></pre><p id="64be" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">不要忘记允许防火墙上的端口。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="8ddb" class="lr ls iq lq b gy mt mu l mv mw">sudo firewall-cmd  --add-port={8300,8301,8302,8400,8500,8600}/tcp --permanent<br/>sudo firewall-cmd  --add-port={8301,8302,8600}/udp --permanent<br/>sudo firewall-cmd --reload</span></pre><p id="c51a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，创建consul服务器配置。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="0563" class="lr ls iq lq b gy mt mu l mv mw">sudo su -;<br/>cat &lt;&lt;EOF &gt; /etc/consul.d/consul.hcl<br/>datacenter = "dc1"<br/>data_dir = "/export/consul-data"<br/>encrypt = "+jqLwl3qx1FiOYS9+l1X4n8alHYXKy8ErTnpGiYs9gg="<br/>ca_file = "/etc/consul.d/consul-agent-ca.pem"<br/>cert_file = "/etc/consul.d/dc1-server-consul-0.pem"<br/>key_file = "/etc/consul.d/dc1-server-consul-0-key.pem"<br/>verify_incoming = true<br/>verify_outgoing = true<br/>verify_server_hostname = true<br/>server = true<br/>enable_syslog = true<br/>bootstrap_expect = 3<br/>client_addr = "0.0.0.0"<br/>ui_config {<br/>  enabled = true<br/>}<br/>performance {<br/>  raft_multiplier = 1<br/>}<br/>acl = {<br/>  enabled = true<br/>  default_policy = "allow"<br/>  enable_token_persistence = true<br/>}<br/>auto_encrypt {<br/>  allow_tls = true<br/>}<br/>advertise_addr = "10.0.0.3"<br/>bind_addr = "10.0.0.3"<br/>retry_join = ["10.0.0.3", "10.0.0.4", "10.0.0.5"]<br/>EOF</span></pre><p id="1057" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ln lo lp lq b">advertise_addr</code>和<code class="fe ln lo lp lq b">bind_addr</code>是运行领事节点的主机ip。</p><p id="49bf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">可以验证配置。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="4f5d" class="lr ls iq lq b gy mt mu l mv mw">consul validate /etc/consul.d/consul.hcl;</span></pre><p id="14b2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在每个节点上创建咨询服务。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="6ee1" class="lr ls iq lq b gy mt mu l mv mw"># create consul service.<br/>sudo su -;<br/>cat &lt;&lt;EOF &gt; /usr/lib/systemd/system/consul.service<br/>[Unit]<br/>Description="HashiCorp Consul - A service mesh solution"<br/>Documentation=<a class="ae kc" href="https://www.consul.io/" rel="noopener ugc nofollow" target="_blank">https://www.consul.io/</a><br/>Requires=network-online.target<br/>After=network-online.target<br/>ConditionFileNotEmpty=/etc/consul.d/consul.hcl</span><span id="4999" class="lr ls iq lq b gy mx mu l mv mw">[Service]<br/>Type=notify<br/>User=consul<br/>Group=consul<br/>ExecStart=/usr/bin/consul agent -config-dir=/etc/consul.d/<br/>ExecReload=/bin/kill --signal HUP $MAINPID<br/>KillMode=process<br/>KillSignal=SIGTERM<br/>Restart=on-failure<br/>LimitNOFILE=65536</span><span id="a963" class="lr ls iq lq b gy mx mu l mv mw">[Install]<br/>WantedBy=multi-user.target<br/>EOF</span></pre><p id="a82c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好，开始在所有节点上协商。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="63c5" class="lr ls iq lq b gy mt mu l mv mw">sudo systemctl enable consul;<br/>sudo systemctl start consul;<br/>sudo systemctl status consul;</span></pre><p id="2b81" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">检查领事成员。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="7f27" class="lr ls iq lq b gy mt mu l mv mw"># check consul members.<br/>consul members;<br/>Node     Address        Status  Type    Build  Protocol  DC   Segment<br/>minio-0  10.0.0.3:8301  alive   server  1.9.3  2         dc1  &lt;all&gt;<br/>minio-1  10.0.0.4:8301  alive   server  1.9.3  2         dc1  &lt;all&gt;<br/>minio-2  10.0.0.5:8301  alive   server  1.9.3  2         dc1  &lt;all&gt;</span></pre><p id="648d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如你所见，我们有三名执政官还活着。</p><p id="61f2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">查看更多细节。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="fdb8" class="lr ls iq lq b gy mt mu l mv mw">consul members -detailed;</span></pre><p id="8d80" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建初始化。代币</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="7139" class="lr ls iq lq b gy mt mu l mv mw">consul acl bootstrap;<br/>AccessorID:       6cf6d785-38ae-57df-0628-66ee28077880<br/>SecretID:         2bf4d6a2-8249-1aa7-f0a3-7f85f80b2d8e<br/>Description:      Bootstrap Token (Global Management)<br/>Local:            false<br/>Create Time:      2021-03-02 07:58:54.514032484 +0000 UTC<br/>Policies:<br/>   00000000-0000-0000-0000-000000000001 - global-management</span></pre><p id="31ce" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，通过Web用户界面访问咨询。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="c305" class="lr ls iq lq b gy mt mu l mv mw">http://&lt;consul-node&gt;:8500</span></pre><p id="e2f1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">到目前为止，我们已经在三个节点上安装了Consul集群。</p><h2 id="2321" class="lr ls iq bd lt lu lv dn lw lx ly dp lz ko ma mb mc ks md me mf kw mg mh mi mj bi translated">将保管库安装为KMS</h2><p id="3f57" class="pw-post-body-paragraph kd ke iq kf b kg mk ki kj kk ml km kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">Vault可以在启用高可用性的模式下运行。在这里，Vault将通过TLS代理NGINX安装HA支持。</p><p id="a506" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">比方说，我们有三个保险库节点。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="a2d7" class="lr ls iq lq b gy mt mu l mv mw">vault-test.cloudchef-labs.com<br/>vault-test1.cloudchef-labs.com<br/>vault-test2.cloudchef-labs.com</span></pre><p id="9121" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们需要CA证书，就像加密一样。在每个节点上生成证书。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="6302" class="lr ls iq lq b gy mt mu l mv mw"># generate let's encrypt cert on vault node 0.<br/>sudo certbot certonly --standalone -d vault-test.cloudchef-labs.com --staple-ocsp -m <a class="ae kc" href="mailto:mykidong@cloudchef-labs.com" rel="noopener ugc nofollow" target="_blank">mykidong@cloudchef-labs.com</a> --agree-tos;</span><span id="1aed" class="lr ls iq lq b gy mx mu l mv mw"># generate let's encrypt cert on vault node 1.<br/>sudo certbot certonly --standalone -d vault-test1.cloudchef-labs.com --staple-ocsp -m <a class="ae kc" href="mailto:mykidong@cloudchef-labs.com" rel="noopener ugc nofollow" target="_blank">mykidong@cloudchef-labs.com</a> --agree-tos;</span><span id="10a5" class="lr ls iq lq b gy mx mu l mv mw"># generate let's encrypt cert on vault node 2.<br/>sudo certbot certonly --standalone -d vault-test2.cloudchef-labs.com --staple-ocsp -m <a class="ae kc" href="mailto:mykidong@cloudchef-labs.com" rel="noopener ugc nofollow" target="_blank">mykidong@cloudchef-labs.com</a> --agree-tos;</span></pre><p id="ac1f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，为vault节点0创建vault服务器配置。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="747c" class="lr ls iq lq b gy mt mu l mv mw">######################## vault configuration for node-0.<br/>sudo su -<br/>cat &lt;&lt;EOF &gt; /etc/vault.d/vault.hcl<br/>storage "consul" {<br/>  address = "127.0.0.1:8500"<br/>  path    = "vault/"<br/>  ha_enabled = "true"<br/>  redirect_addr = "<a class="ae kc" href="https://vault-nginx-test.cloudchef-labs.com" rel="noopener ugc nofollow" target="_blank">https://vault-nginx-test.cloudchef-labs.com</a>"<br/>  api_addr = "<a class="ae kc" href="https://vault-nginx-test.cloudchef-labs.com" rel="noopener ugc nofollow" target="_blank">https://vault-nginx-test.cloudchef-labs.com</a>"<br/>  cluster_addr = "<a class="ae kc" href="http://vault-test.cloudchef-labs.com:8201" rel="noopener ugc nofollow" target="_blank">http://vault-test.cloudchef-labs.com:8201</a>"<br/>}</span><span id="0703" class="lr ls iq lq b gy mx mu l mv mw">listener "tcp" {<br/>  address = "0.0.0.0:8200"<br/>  tls_cert_file = "/etc/letsencrypt/live/vault-test.cloudchef-labs.com/fullchain.pem"<br/>  tls_key_file = "/etc/letsencrypt/live/vault-test.cloudchef-labs.com/privkey.pem"<br/>}</span><span id="c794" class="lr ls iq lq b gy mx mu l mv mw">disable_mlock = true<br/>EOF</span></pre><p id="3155" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">看一看<code class="fe ln lo lp lq b">storage "consul"</code>部分。<code class="fe ln lo lp lq b">address</code>是领事地址。<code class="fe ln lo lp lq b">redirect_addr</code>和<code class="fe ln lo lp lq b">api_addr</code>是以后要安装的NGINX等TLS代理的地址。<code class="fe ln lo lp lq b">cluster_addr</code>是正在运行的vault节点的主机ip。</p><p id="a730" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<code class="fe ln lo lp lq b">listener "tcp"</code>部分，<code class="fe ln lo lp lq b">tls_cert_file</code>是由Let's Encrypt生成的证书的路径，<code class="fe ln lo lp lq b">tls_key_file</code>是私钥的路径。</p><p id="783a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，为其他节点创建配置。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="5b2f" class="lr ls iq lq b gy mt mu l mv mw">######################## vault configuration for node-1.<br/>sudo su -<br/>cat &lt;&lt;EOF &gt; /etc/vault.d/vault.hcl<br/>storage "consul" {<br/>  address = "127.0.0.1:8500"<br/>  path    = "vault/"<br/>  ha_enabled = "true"<br/>  redirect_addr = "<a class="ae kc" href="https://vault-nginx-test.cloudchef-labs.com" rel="noopener ugc nofollow" target="_blank">https://vault-nginx-test.cloudchef-labs.com</a>"<br/>  api_addr = "<a class="ae kc" href="https://vault-nginx-test.cloudchef-labs.com" rel="noopener ugc nofollow" target="_blank">https://vault-nginx-test.cloudchef-labs.com</a>"<br/>  cluster_addr = "<a class="ae kc" href="http://vault-test1.cloudchef-labs.com:8201" rel="noopener ugc nofollow" target="_blank">http://vault-test1.cloudchef-labs.com:8201</a>"<br/>}</span><span id="b150" class="lr ls iq lq b gy mx mu l mv mw">listener "tcp" {<br/>  address = "0.0.0.0:8200"<br/>  tls_cert_file = "/etc/letsencrypt/live/vault-test1.cloudchef-labs.com/fullchain.pem"<br/>  tls_key_file = "/etc/letsencrypt/live/vault-test1.cloudchef-labs.com/privkey.pem"<br/>}</span><span id="6dbd" class="lr ls iq lq b gy mx mu l mv mw">disable_mlock = true<br/>EOF</span><span id="078b" class="lr ls iq lq b gy mx mu l mv mw">######################## vault configuration for node-2.<br/>sudo su -<br/>cat &lt;&lt;EOF &gt; /etc/vault.d/vault.hcl<br/>storage "consul" {<br/>  address = "127.0.0.1:8500"<br/>  path    = "vault/"<br/>  ha_enabled = "true"<br/>  redirect_addr = "<a class="ae kc" href="https://vault-nginx-test.cloudchef-labs.com" rel="noopener ugc nofollow" target="_blank">https://vault-nginx-test.cloudchef-labs.com</a>"<br/>  api_addr = "<a class="ae kc" href="https://vault-nginx-test.cloudchef-labs.com" rel="noopener ugc nofollow" target="_blank">https://vault-nginx-test.cloudchef-labs.com</a>"<br/>  cluster_addr = "<a class="ae kc" href="http://vault-test2.cloudchef-labs.com:8201" rel="noopener ugc nofollow" target="_blank">http://vault-test2.cloudchef-labs.com:8201</a>"<br/>}</span><span id="3df6" class="lr ls iq lq b gy mx mu l mv mw">listener "tcp" {<br/>  address = "0.0.0.0:8200"<br/>  tls_cert_file = "/etc/letsencrypt/live/vault-test2.cloudchef-labs.com/fullchain.pem"<br/>  tls_key_file = "/etc/letsencrypt/live/vault-test2.cloudchef-labs.com/privkey.pem"<br/>}</span><span id="40e4" class="lr ls iq lq b gy mx mu l mv mw">disable_mlock = true<br/>EOF</span></pre><p id="dd66" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在每个vault节点上运行vault服务器。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="bba7" class="lr ls iq lq b gy mt mu l mv mw">sudo nohup vault server -config /etc/vault.d/vault.hcl &gt; vault.log &amp;</span></pre><p id="7518" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">初始化保险库。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="0c47" class="lr ls iq lq b gy mt mu l mv mw"># set vault env.<br/>export VAULT_ADDR="<a class="ae kc" href="https://vault-test.cloudchef-labs.com:8200" rel="noopener ugc nofollow" target="_blank">https://vault-test.cloudchef-labs.com:8200</a>";<br/>export VAULT_SKIP_VERIFY=true</span><span id="1ca8" class="lr ls iq lq b gy mx mu l mv mw"># init vault.<br/>vault operator init;<br/>Unseal Key 1: 4Jj3V/KLXFNLFnStJ0OzmLp0y7iQmZ31skyN9Uqgw9V4<br/>Unseal Key 2: Fy/qPJTYA1CRYeZP/YVGlLg9ly8u/KOpr2vK7yKP/LHP<br/>Unseal Key 3: lLIRESmYIvlF716SOyL0CW0m3jKm/hw1QuFlQtvd3aq0<br/>Unseal Key 4: j7p5pnH/t/sSFPSLUzrymjUU/P63lb6UG6j9bVrKaYv+<br/>Unseal Key 5: ri2WEmV2YX5WIby9hXOoeOGOeBIQkancYXfsQ3H3CdZI</span><span id="679a" class="lr ls iq lq b gy mx mu l mv mw">Initial Root Token: s.1ENJtfdmOUd8YCd9KRHbQfZz<br/>...</span></pre><p id="ea9a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">解封所有vault服务器的vault服务器，例如vault服务器节点<code class="fe ln lo lp lq b">vault-test.cloudchef-labs.com</code>。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="4817" class="lr ls iq lq b gy mt mu l mv mw">export VAULT_ADDR="<a class="ae kc" href="https://vault-test.cloudchef-labs.com:8200" rel="noopener ugc nofollow" target="_blank">https://vault-test.cloudchef-labs.com:8200</a>";<br/>export VAULT_SKIP_VERIFY=true <br/>export VAULT_TOKEN=s.1ENJtfdmOUd8YCd9KRHbQfZz</span><span id="6719" class="lr ls iq lq b gy mx mu l mv mw">vault operator unseal 4Jj3V/KLXFNLFnStJ0OzmLp0y7iQmZ31skyN9Uqgw9V4<br/>vault operator unseal Fy/qPJTYA1CRYeZP/YVGlLg9ly8u/KOpr2vK7yKP/LHP<br/>vault operator unseal lLIRESmYIvlF716SOyL0CW0m3jKm/hw1QuFlQtvd3aq0</span></pre><p id="995b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">随着<code class="fe ln lo lp lq b">VAULT_ADDR</code>的改变，运行其他vault服务器的解封命令。</p><p id="255c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们测试跳马是否有效。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="d982" class="lr ls iq lq b gy mt mu l mv mw"># set vault env.<br/>export VAULT_ADDR="<a class="ae kc" href="https://vault-test.cloudchef-labs.com:8200" rel="noopener ugc nofollow" target="_blank">https://vault-test.cloudchef-labs.com:8200</a>";<br/>export VAULT_SKIP_VERIFY=true <br/>export VAULT_TOKEN=s.1ENJtfdmOUd8YCd9KRHbQfZz</span><span id="9729" class="lr ls iq lq b gy mx mu l mv mw"># Enable the kv secrets engine at: secret/<br/>vault secrets enable -path=secret/ kv</span><span id="589b" class="lr ls iq lq b gy mx mu l mv mw"># put kv with path 'secret/fakebank'<br/>vault kv put secret/fakebank api_key=abc1234 api_secret=1a2b3c4d</span><span id="bdfe" class="lr ls iq lq b gy mx mu l mv mw"># get kv with path 'secret/fakebank'<br/>vault kv get secret/fakebank;<br/>======= Data =======<br/>Key           Value<br/>---           -----<br/>api_key       abc1234<br/>api_secret    1a2b3c4d</span></pre><p id="c3e6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要使Vault HA，我们需要类似NGINX的TLS代理。比方说，我们有一个nginx节点。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="1805" class="lr ls iq lq b gy mt mu l mv mw">vault-nginx-test.cloudchef-labs.com</span></pre><p id="be41" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为我们的Vault TLS代理NGINX创建证书。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="3989" class="lr ls iq lq b gy mt mu l mv mw">sudo certbot certonly --nginx -d vault-nginx-test.cloudchef-labs.com --staple-ocsp -m mykidong@cloudchef-labs.com --agree-tos;</span></pre><p id="c010" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，创建一个NGINX的反向代理配置。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="7159" class="lr ls iq lq b gy mt mu l mv mw">sudo su -;<br/>cat &lt;&lt;EOF &gt; /etc/nginx/conf.d/vault-nginx-test.cloudchef-labs.com.conf<br/>server {<br/>    #listen 80 default_server;<br/>    #listen [::]:80 default_server;<br/>    root /var/www/html;<br/>    server_name  vault-nginx-test.cloudchef-labs.com;</span><span id="b250" class="lr ls iq lq b gy mx mu l mv mw"># To allow special characters in headers<br/>    ignore_invalid_headers off;<br/>    # Allow any size file to be uploaded.<br/>    # Set to a value such as 1000m; to restrict file size to a specific value<br/>    client_max_body_size 0;<br/>    # To disable buffering<br/>    proxy_buffering off;</span><span id="4494" class="lr ls iq lq b gy mx mu l mv mw">listen 443 ssl; # managed by Certbot</span><span id="568b" class="lr ls iq lq b gy mx mu l mv mw"># RSA certificate<br/>    ssl_certificate /etc/letsencrypt/live/vault-nginx-test.cloudchef-labs.com/fullchain.pem; # managed by Certbot<br/>    ssl_certificate_key /etc/letsencrypt/live/vault-nginx-test.cloudchef-labs.com/privkey.pem; # managed by Certbot</span><span id="7b4a" class="lr ls iq lq b gy mx mu l mv mw">include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot</span><span id="9200" class="lr ls iq lq b gy mx mu l mv mw"># Redirect non-https traffic to https<br/>    if (\$scheme != "https") {<br/>        return 301 <a class="ae kc" href="https://" rel="noopener ugc nofollow" target="_blank">https://</a>;<br/>    } # managed by Certbot</span><span id="1708" class="lr ls iq lq b gy mx mu l mv mw">location / {<br/>        proxy_set_header X-Real-IP \$remote_addr;<br/>        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;<br/>        proxy_set_header X-Forwarded-Proto \$scheme;<br/>        proxy_set_header Host \$http_host;</span><span id="2931" class="lr ls iq lq b gy mx mu l mv mw">proxy_connect_timeout 300;      <br/>        proxy_http_version 1.1;<br/>        proxy_set_header Connection "";<br/>        chunked_transfer_encoding off;</span><span id="0db3" class="lr ls iq lq b gy mx mu l mv mw">proxy_pass <a class="ae kc" href="https://vault" rel="noopener ugc nofollow" target="_blank">https://vault</a>; <br/>   }<br/>}<br/>upstream vault {<br/>    server vault-test.cloudchef-labs.com:8200;<br/>    server vault-test1.cloudchef-labs.com:8200;<br/>    server vault-test2.cloudchef-labs.com:8200;<br/>}<br/>EOF</span></pre><p id="5386" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，重新加载NGINX配置。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="03a3" class="lr ls iq lq b gy mt mu l mv mw">sudo nginx -t &amp;&amp; sudo nginx -s reload;</span></pre><p id="9501" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要使用TLS代理NGINX访问vault，让我们测试一下。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="a54e" class="lr ls iq lq b gy mt mu l mv mw">## test vault<br/>export VAULT_ADDR="<a class="ae kc" href="https://vault-nginx-test.cloudchef-labs.com" rel="noopener ugc nofollow" target="_blank">https://vault-nginx-test.cloudchef-labs.com</a>";<br/>export VAULT_SKIP_VERIFY=true <br/>export VAULT_TOKEN=s.1ENJtfdmOUd8YCd9KRHbQfZz</span><span id="b21c" class="lr ls iq lq b gy mx mu l mv mw"># get value.<br/>vault kv get secret/fakebank;<br/>======= Data =======<br/>Key           Value<br/>---           -----<br/>api_key       abc1234<br/>api_secret    1a2b3c4d</span></pre><p id="d7f1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">看一下<code class="fe ln lo lp lq b">VAULT_ADDR</code>，它是TLS代理NGINX的地址。正如所见，它工作正常。</p><h2 id="97b2" class="lr ls iq bd lt lu lv dn lw lx ly dp lz ko ma mb mc ks md me mf kw mg mh mi mj bi translated">安装迷你KES</h2><p id="785c" class="pw-post-body-paragraph kd ke iq kf b kg mk ki kj kk ml km kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">要允许米尼奥·KES访问保险库，您必须运行以下命令。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="0175" class="lr ls iq lq b gy mt mu l mv mw">export VAULT_ADDR="<a class="ae kc" href="https://vault-nginx-test.cloudchef-labs.com" rel="noopener ugc nofollow" target="_blank">https://vault-nginx-test.cloudchef-labs.com</a>";<br/>export VAULT_SKIP_VERIFY=true <br/>export VAULT_TOKEN=s.1ENJtfdmOUd8YCd9KRHbQfZz</span><span id="ca60" class="lr ls iq lq b gy mx mu l mv mw">## Enable Vault's K/V backend<br/>vault secrets enable kv;</span><span id="8d56" class="lr ls iq lq b gy mx mu l mv mw">## Enable AppRole authentication.<br/>vault auth enable approle</span><span id="0687" class="lr ls iq lq b gy mx mu l mv mw">## Create an access policy for the K/V engine.<br/>cat &gt; kes-policy.hcl &lt;&lt;EOF<br/>path "kv/*" {<br/>     capabilities = [ "create", "read", "delete" ]<br/>}<br/>EOF</span><span id="4517" class="lr ls iq lq b gy mx mu l mv mw">### Then we upload the policy to Vault:<br/>vault policy write kes-policy ./kes-policy.hcl;</span><span id="6914" class="lr ls iq lq b gy mx mu l mv mw">## Create an new AppRole ID and bind it to a policy.<br/>vault write auth/approle/role/kes-role token_num_uses=0  secret_id_num_uses=0  period=5m;</span><span id="dd9f" class="lr ls iq lq b gy mx mu l mv mw">### Then we bind the kes-policy policy to the role:<br/>vault write auth/approle/role/kes-role policies=kes-policy;</span><span id="f40a" class="lr ls iq lq b gy mx mu l mv mw">### Finally, we request an AppRole role ID and secret ID from Vault.<br/>### First, the role ID:<br/>vault read auth/approle/role/kes-role/role-id;<br/>Key        Value<br/>---        -----<br/>role_id    6fcc2761-2be9-1f89-2dec-899f27b7faa9</span><span id="266c" class="lr ls iq lq b gy mx mu l mv mw">### Then, the secret ID:<br/>### We are only interested in the secret_id - not in the secret_id_accessor.<br/>vault write -f auth/approle/role/kes-role/secret-id;<br/>Key                   Value<br/>---                   -----<br/>secret_id             73e1d9ab-3b1a-cd83-10fd-d1ed49226c35<br/>secret_id_accessor    bcb8150a-0e5b-1a8b-5345-ea94948a8e49</span></pre><p id="9fbc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">比如说，我们的KES节点是。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="e231" class="lr ls iq lq b gy mt mu l mv mw">kes-test.cloudchef-labs.com</span></pre><p id="ce1f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">安装KES二进制文件。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="3ab6" class="lr ls iq lq b gy mt mu l mv mw">wget https://github.com/minio/kes/releases/download/v0.13.5/kes_0.13.5_linux_amd64.rpm; <em class="my">3</em>sudo rpm -Uvh ./kes_0.13.5_linux_amd64.rpm;</span></pre><p id="b520" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">以避免以root用户身份运行KES。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="ade0" class="lr ls iq lq b gy mt mu l mv mw">sudo setcap cap_ipc_lock=+ep $(readlink -f $(which kes));</span></pre><p id="dd6a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从让我们加密生成证书。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="be4d" class="lr ls iq lq b gy mt mu l mv mw">sudo certbot certonly --standalone -d kes-test.cloudchef-labs.com --staple-ocsp -m mykidong@cloudchef-labs.com --agree-tos;</span></pre><p id="ac8a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将生成的证书复制到KES主目录。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="f3d2" class="lr ls iq lq b gy mt mu l mv mw">mkdir -p kes;<br/>sudo cp /etc/letsencrypt/live/kes-test.cloudchef-labs.com/fullchain.pem /home/opc/kes/fullchain.pem<br/>sudo cp /etc/letsencrypt/live/kes-test.cloudchef-labs.com/privkey.pem /home/opc/kes/privkey.pem<br/>sudo chown opc:opc -R kes;</span></pre><p id="2993" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们使用KES CLI为应用程序创建私有证书。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="e88c" class="lr ls iq lq b gy mt mu l mv mw">kes tool identity new --key=app.key --cert=app.cert app;</span></pre><p id="9a94" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从生成的<code class="fe ln lo lp lq b">app.cert</code>中查看应用ID。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="99b2" class="lr ls iq lq b gy mt mu l mv mw">kes tool identity of app.cert;</span><span id="232c" class="lr ls iq lq b gy mx mu l mv mw">Identity:  8c0e61377339ee7f770b40719b80c5939e68904a07f9282fe5f8754597ce4dbf</span></pre><p id="f29d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">允许防火墙上的端口。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="de5e" class="lr ls iq lq b gy mt mu l mv mw">sudo firewall-cmd  --add-port=7373/tcp --permanent<br/>sudo firewall-cmd --reload</span></pre><p id="65aa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们创建KES配置。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="29f2" class="lr ls iq lq b gy mt mu l mv mw">cat &lt;&lt;EOF &gt; kes.yml<br/>address: 0.0.0.0:7373<br/>root:    disabled <br/>tls:<br/>  key:  /home/opc/kes/privkey.pem<br/>  cert: /home/opc/kes/fullchain.pem<br/>policy:<br/>  my-app:<br/>    paths:<br/>    - /v1/key/create/my-app*<br/>    - /v1/key/generate/my-app*<br/>    - /v1/key/decrypt/my-app*<br/>    identities:<br/>    - \${APP_IDENTITY}<br/>keys:<br/>  vault:<br/>    endpoint: <a class="ae kc" href="https://vault-nginx-test.cloudchef-labs.com" rel="noopener ugc nofollow" target="_blank">https://vault-nginx-test.cloudchef-labs.com</a><br/>    approle:<br/>      id:     "6fcc2761-2be9-1f89-2dec-899f27b7faa9" # Your AppRole ID<br/>      secret: "73e1d9ab-3b1a-cd83-10fd-d1ed49226c35" # Your AppRole Secret ID<br/>      retry:  15s<br/>    status:<br/>      ping: 10s  <br/>EOF</span></pre><p id="677d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">看一下<code class="fe ln lo lp lq b">keys.vault.endpoint </code>，这是金库的NGINX代理的地址。</p><p id="c67d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们运行KES服务器。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="4080" class="lr ls iq lq b gy mt mu l mv mw">export APP_IDENTITY=$(kes tool identity of /home/opc/app.cert);<br/>nohup kes server --mlock --config=kes.yml --auth=off &gt; kes.log &amp;</span></pre><p id="f6c1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建应用程序密钥。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="76e8" class="lr ls iq lq b gy mt mu l mv mw">export KES_SERVER=<a class="ae kc" href="https://kes-test.cloudchef-labs.com:7373" rel="noopener ugc nofollow" target="_blank">https://kes-test.cloudchef-labs.com:7373</a>;<br/>export KES_CLIENT_CERT=/home/opc/app.cert<br/>export KES_CLIENT_KEY=/home/opc/app.key</span><span id="2597" class="lr ls iq lq b gy mx mu l mv mw">kes key create -k my-app-key;</span></pre><p id="8bce" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以使用vault cli查看密钥。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="6753" class="lr ls iq lq b gy mt mu l mv mw">export VAULT_ADDR="<a class="ae kc" href="https://vault-nginx-test.cloudchef-labs.com" rel="noopener ugc nofollow" target="_blank">https://vault-nginx-test.cloudchef-labs.com</a>";<br/>export VAULT_SKIP_VERIFY=true <br/>export VAULT_TOKEN=s.1ENJtfdmOUd8YCd9KRHbQfZz</span><span id="969d" class="lr ls iq lq b gy mx mu l mv mw">vault kv list kv/;<br/>Keys<br/>----<br/>my-app-key</span></pre><p id="b521" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们用KES命令行界面导出数据密钥。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="9486" class="lr ls iq lq b gy mt mu l mv mw">kes key derive -k my-app-key;<br/>{<br/>  plaintext : AsVPauMZ1NTed4/fwybJJdJd3hWt+pI/NVrxLoj3nVw=<br/>  ciphertext: eyJhZWFkIjoiQUVTLTI1Ni1HQ00tSE1BQy1TSEEtMjU2IiwiaXYiOiJuM1FXbDVVSGpHZ2NFbFVvVmRWRW1RPT0iLCJub25jZSI6IjBtZXVYc1hEMkI2aXlmYnIiLCJieXRlcyI6InhtUWcyOThmVjd3L2hLZzR5MnpsVGlHZjlNUkRtd3ZrQ2lTaHpvSzBtZUQxTlVhQ2UyekFYVUcxOXJramYzRE4ifQ==<br/>}</span></pre><p id="67ea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像NGINX这样的TLS代理可以与KES服务器集成，你将在本文的最后一节看到这一点。</p><h2 id="6683" class="lr ls iq bd lt lu lv dn lw lx ly dp lz ko ma mb mc ks md me mf kw mg mh mi mj bi translated">配置MinIO</h2><p id="c444" class="pw-post-body-paragraph kd ke iq kf b kg mk ki kj kk ml km kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">要安装MinIO服务器，可以看<a class="ae kc" href="https://mykidong.medium.com/secure-minio-not-on-kubernetes-46dd90ccb1c" rel="noopener">之前的帖子</a>。</p><p id="2a53" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要从MinIO访问KES服务器，MinIO服务器将使用在前面部分生成的私有证书和证书。将KES CLI生成的所有私有证书和证书复制到所有MinIO节点。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="7f60" class="lr ls iq lq b gy mt mu l mv mw">scp app.* minio-0:/home/opc;<br/>scp app.* minio-1:/home/opc;<br/>scp app.* minio-2:/home/opc;</span></pre><p id="1a2f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">添加环境。minio节点上的MinIO变量。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="37d9" class="lr ls iq lq b gy mt mu l mv mw">export MINIO_KMS_KES_ENDPOINT=<a class="ae kc" href="https://kes-test.cloudchef-labs.com:7373" rel="noopener ugc nofollow" target="_blank">https://kes-test.cloudchef-labs.com:7373</a><br/>export MINIO_KMS_KES_KEY_FILE=/home/opc/app.key<br/>export MINIO_KMS_KES_CERT_FILE=/home/opc/app.cert<br/>export MINIO_KMS_KES_KEY_NAME=my-app-key</span></pre><p id="45a8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，重启所有的MinIO服务器。</p><p id="a89d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将自动加密设置为MinIO。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="24ef" class="lr ls iq lq b gy mt mu l mv mw">mc encrypt set sse-s3 minio-https/mykidong/</span></pre><p id="e0e9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">验证自动加密是否已启用。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="82d1" class="lr ls iq lq b gy mt mu l mv mw">mc encrypt info minio-https/mykidong/;<br/>Auto encryption 'sse-s3' is enabled</span></pre><p id="12f2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们复制一个文件到MinIO来验证上传的文件是加密的。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="2d1e" class="lr ls iq lq b gy mt mu l mv mw"># copy a file to minio.<br/>mc cp server-config.yml minio-https/mykidong;</span></pre><p id="5301" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">查看上传文件的对象信息。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="a981" class="lr ls iq lq b gy mt mu l mv mw">mc stat minio-https/mykidong/server-config.yml;<br/>Name      : server-config.yml<br/>Date      : 2021-03-04 06:06:11 GMT<br/>Size      : 643 B<br/>ETag      : 003d229d1701812e4df983db83135cc1<br/>Type      : file<br/>Metadata  :<br/>  Content-Type: text/yaml<br/>Encrypted :<br/>  X-Amz-Server-Side-Encryption: AES256</span></pre><p id="32af" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">不出所料，上传的文件会自动加密！</p><h2 id="34c1" class="lr ls iq bd lt lu lv dn lw lx ly dp lz ko ma mb mc ks md me mf kw mg mh mi mj bi translated">MinIO KES HA，带TLS代理NGINX</h2><p id="e4aa" class="pw-post-body-paragraph kd ke iq kf b kg mk ki kj kk ml km kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">MinIO KES服务器是一个无状态的应用程序，可以通过集成NGINX代理向外扩展。</p><figure class="lj lk ll lm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mz"><img src="../Images/56675c109adce093ca9299c27dfc7795.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D7i-dACz7ACeMHCsa-Mc6A.png"/></div></div></figure><p id="c103" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如图所示，NGINX代理位于KES服务器的前面，充当TLS代理。</p><p id="184b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们现在已经创建了一个KES服务器节点，让我们再添加两个KES服务器节点。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="87d2" class="lr ls iq lq b gy mt mu l mv mw">kes-test1.cloudchef-labs.com <br/>kes-test2.cloudchef-labs.com</span></pre><p id="388a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您必须像以前一样在新的KES服务器节点上创建证书并打开端口。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="fc49" class="lr ls iq lq b gy mt mu l mv mw">## create certs from let's encrypt on node-1.<br/>sudo certbot certonly --standalone -d kes-test1.cloudchef-labs.com --staple-ocsp -m <a class="ae kc" href="mailto:mykidong@cloudchef-labs.com" rel="noopener ugc nofollow" target="_blank">mykidong@cloudchef-labs.com</a> --agree-tos;</span><span id="8801" class="lr ls iq lq b gy mx mu l mv mw">## create certs from let's encrypt on node-2.<br/>sudo certbot certonly --standalone -d kes-test2.cloudchef-labs.com --staple-ocsp -m <a class="ae kc" href="mailto:mykidong@cloudchef-labs.com" rel="noopener ugc nofollow" target="_blank">mykidong@cloudchef-labs.com</a> --agree-tos;</span><span id="1977" class="lr ls iq lq b gy mx mu l mv mw">## copy let's encrypt certs on node-1<br/>mkdir -p kes;<br/>sudo cp /etc/letsencrypt/live/kes-test1.cloudchef-labs.com/fullchain.pem /home/opc/kes/fullchain.pem<br/>sudo cp /etc/letsencrypt/live/kes-test1.cloudchef-labs.com/privkey.pem /home/opc/kes/privkey.pem<br/>sudo chown opc:opc -R kes;</span><span id="c1cc" class="lr ls iq lq b gy mx mu l mv mw">## copy let's encrypt certs on node-2<br/>mkdir -p kes;<br/>sudo cp /etc/letsencrypt/live/kes-test2.cloudchef-labs.com/fullchain.pem /home/opc/kes/fullchain.pem<br/>sudo cp /etc/letsencrypt/live/kes-test2.cloudchef-labs.com/privkey.pem /home/opc/kes/privkey.pem<br/>sudo chown opc:opc -R kes;</span><span id="6b2b" class="lr ls iq lq b gy mx mu l mv mw">## allow port on firewall on kes server nodes.<br/>sudo firewall-cmd  --add-port=7373/tcp --permanent<br/>sudo firewall-cmd --reload</span></pre><p id="3de7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将应用程序证书复制到新的KES服务器节点。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="ec34" class="lr ls iq lq b gy mt mu l mv mw">## copy app certs to new kes server nodes.<br/>sudo scp app.* opc@kes-test1:/home/opc<br/>sudo scp app.* opc@kes-test2:/home/opc</span></pre><p id="57d9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，为NGINX创建私有证书。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="1673" class="lr ls iq lq b gy mt mu l mv mw">kes tool identity new --key=nginx.key --cert=nginx.cert nginx;</span></pre><p id="59c0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并将生成的证书复制到NGINX conf目录中。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="dff5" class="lr ls iq lq b gy mt mu l mv mw">sudo cp nginx.* /etc/nginx;</span></pre><p id="4578" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们打印nginx应用程序的id。这个NGINX应用ID将在KES注册。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="b7ba" class="lr ls iq lq b gy mt mu l mv mw">kes tool identity of nginx.cert;</span><span id="0e23" class="lr ls iq lq b gy mx mu l mv mw">Identity:  8d5cbaa02b6ad70abefc03d52cd5f6d9945457cf9a1da0516438eb96d91add2d</span></pre><p id="f06b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并在所有KES服务器节点上创建新的KES配置。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="075d" class="lr ls iq lq b gy mt mu l mv mw">cat &lt;&lt;EOF &gt; kes.yml<br/>address: 0.0.0.0:7373<br/>root: disabled<br/>tls:<br/>  key: /home/opc/kes/privkey.pem<br/>  cert: /home/opc/kes/fullchain.pem<br/>  proxy:<br/>    identities:<br/>      - 8d5cbaa02b6ad70abefc03d52cd5f6d9945457cf9a1da0516438eb96d91add2d<br/>    header:<br/>      cert: X-Tls-Client-Cert<br/>policy:<br/>  my-app:<br/>    paths:<br/>    - /v1/key/create/my-app*<br/>    - /v1/key/generate/my-app*<br/>    - /v1/key/decrypt/my-app*<br/>    identities:<br/>    - \${APP_IDENTITY}<br/>keys:<br/>  vault:<br/>    endpoint: <a class="ae kc" href="https://vault-nginx-test.cloudchef-labs.com" rel="noopener ugc nofollow" target="_blank">https://vault-nginx-test.cloudchef-labs.com</a><br/>    approle:<br/>      id:     "6fcc2761-2be9-1f89-2dec-899f27b7faa9" # Your AppRole ID<br/>      secret: "73e1d9ab-3b1a-cd83-10fd-d1ed49226c35" # Your AppRole Secret ID<br/>      retry:  15s<br/>    status:<br/>      ping: 10s<br/>log:<br/>  error: on<br/>  audit: on<br/>EOF</span></pre><p id="0cb2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">看一下<code class="fe ln lo lp lq b">tls</code>部分。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="fa1c" class="lr ls iq lq b gy mt mu l mv mw">tls:<br/>  key: /home/opc/kes/privkey.pem<br/>  cert: /home/opc/kes/fullchain.pem<br/>  proxy:<br/>    identities:<br/>      - 8d5cbaa02b6ad70abefc03d52cd5f6d9945457cf9a1da0516438eb96d91add2d<br/>    header:<br/>      cert: X-Tls-Client-Cert</span></pre><p id="927f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">之前打印的NGINX应用ID已添加到<code class="fe ln lo lp lq b">identities</code>中，并添加了标题<code class="fe ln lo lp lq b">cert</code>。</p><p id="c10e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们启动或重启KES服务器。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="11d7" class="lr ls iq lq b gy mt mu l mv mw">export APP_IDENTITY=$(kes tool identity of /home/opc/app.cert);<br/>nohup kes server --mlock --config=kes.yml --auth=off &gt; kes.log &amp;</span></pre><p id="008f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，您已经部署了三台KES服务器。</p><p id="47aa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们用Let's Encrypt为NGINX创建一个证书，服务器名为<code class="fe ln lo lp lq b">kes-nginx-test.cloudchef-labs.com</code>，之前应该在公共dns中注册。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="7950" class="lr ls iq lq b gy mt mu l mv mw">sudo certbot certonly --nginx -d kes-nginx-test.cloudchef-labs.com --staple-ocsp -m mykidong@cloudchef-labs.com --agree-tos;</span></pre><p id="09af" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建一个nginx配置来代理kes服务器。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="e5bb" class="lr ls iq lq b gy mt mu l mv mw">cat &lt;&lt;EOF &gt; /etc/nginx/conf.d/kes-nginx-test.cloudchef-labs.com.conf<br/>server {<br/>    listen         443 ssl http2;<br/>    server_name    kes-nginx-test.cloudchef-labs.com;<br/>    proxy_buffering off;<br/>    client_max_body_size 0;<br/>    ssl_certificate /etc/letsencrypt/live/kes-nginx-test.cloudchef-labs.com/fullchain.pem;<br/>    ssl_certificate_key /etc/letsencrypt/live/kes-nginx-test.cloudchef-labs.com/privkey.pem;<br/>    ssl_verify_client   optional_no_ca;        <br/>    location / {   <br/>       grpc_pass             grpcs://kes;<br/>       grpc_ssl_verify       off;<br/>       grpc_ssl_protocols    TLSv1.3;<br/>       grpc_ssl_certificate       /etc/nginx/nginx.cert;    <br/>       grpc_ssl_certificate_key   /etc/nginx/nginx.key;<br/>       grpc_set_header X-Tls-Client-Cert \$ssl_client_escaped_cert;<br/>    }<br/>}<br/>upstream kes {<br/>    server kes-test.cloudchef-labs.com:7373; <br/> server kes-test1.cloudchef-labs.com:7373; <br/> server kes-test2.cloudchef-labs.com:7373; <br/>}<br/>EOF</span></pre><p id="d364" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">确保<code class="fe ln lo lp lq b">ssl_certificate</code>、<code class="fe ln lo lp lq b">ssl_certificate_key</code>、<code class="fe ln lo lp lq b">grpc_ssl_certifiate</code>和<code class="fe ln lo lp lq b">grpc_ssl_certificate_key</code>的路径正确。<code class="fe ln lo lp lq b">ssl_certificate</code>、<code class="fe ln lo lp lq b">ssl_certificate_key</code>的值应该是Let's Encrypt生成的nginx证书的路径，<code class="fe ln lo lp lq b">grpc_ssl_certifiate</code>、<code class="fe ln lo lp lq b">grpc_ssl_certificate_key</code>的值应该是kes工具生成的nginx应用证书的路径。</p><p id="0be9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">测试并重新加载nginx配置。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="01f0" class="lr ls iq lq b gy mt mu l mv mw">sudo nginx -t &amp;&amp; sudo nginx -s reload;</span></pre><p id="6222" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们通过NGINX来检查key，派生的key应该是这样的。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="e2a2" class="lr ls iq lq b gy mt mu l mv mw">export KES_SERVER=https://kes-nginx-test.cloudchef-labs.com; <br/>export KES_CLIENT_CERT=/home/opc/app.cert <br/>export KES_CLIENT_KEY=/home/opc/app.key  </span><span id="dc95" class="lr ls iq lq b gy mx mu l mv mw">kes key derive -k my-app-key;</span><span id="5329" class="lr ls iq lq b gy mx mu l mv mw">{<br/>  plaintext : LlMBd14j7y6o4Z0/6o7JeR5Sdl9gCMwSPSlrcSQud9s=<br/>  ciphertext: eyJhZWFkIjoiQUVTLTI1Ni1HQ00tSE1BQy1TSEEtMjU2IiwiaXYiOiJHUStuSzg5WHNOZUowamkxS0RMcEZRPT0iLCJub25jZSI6Inp6bE01S21PUVpqSU90TDkiLCJieXRlcyI6ImFBWmhzUUlBQ28zZmNjNTA4NUg0OHBYM3hSblRGM0tTSDFPZzZsamdGQWZ2dTAvYWtueVhyanBrSHl5bVZYRzcifQ==<br/>}</span></pre><p id="962f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意<code class="fe ln lo lp lq b">KES_SERVER</code>被设置为NGINX的端点。</p><p id="1853" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们修改<code class="fe ln lo lp lq b">MINIO_KMS_KES_ENDPOINT</code>的环境变量并重启MinIO。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="a5b8" class="lr ls iq lq b gy mt mu l mv mw">export MINIO_KMS_KES_ENDPOINT=https://kes-nginx-test.cloudchef-labs.com</span></pre><p id="7613" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，MinIO服务器将通过TLS代理NGINX连接KES服务器。</p><p id="df3d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们再次验证数据加密。</p><pre class="lj lk ll lm gt mp lq mq mr aw ms bi"><span id="87ce" class="lr ls iq lq b gy mt mu l mv mw"># put an object.<br/>mc cp server.pem minio-https/mykidong;</span><span id="ad05" class="lr ls iq lq b gy mx mu l mv mw"># check object info.<br/>mc stat minio-https/mykidong/server.pem;<br/>Name      : server.pem<br/>Date      : 2021-04-30 03:21:14 GMT<br/>Size      : 753 B<br/>ETag      : 5b2b43f1939ea001a9949515aa281446<br/>Type      : file<br/>Metadata  :<br/>  Content-Type: application/x-x509-ca-cert<br/>Encrypted :<br/>  X-Amz-Server-Side-Encryption: AES256</span></pre><p id="120b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于KES服务器的TLS代理NGINX，静态数据加密运行良好。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><p id="6000" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">仅此而已。</p></div></div>    
</body>
</html>