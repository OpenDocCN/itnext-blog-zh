<html>
<head>
<title>Github Actions config for Ruby on Rails tests in RSpec</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">RSpec中Ruby on Rails测试的Github动作配置</h1>
<blockquote>原文：<a href="https://itnext.io/github-actions-config-for-ruby-on-rails-tests-in-rspec-46a5364f2fe9?source=collection_archive---------3-----------------------#2021-04-08">https://itnext.io/github-actions-config-for-ruby-on-rails-tests-in-rspec-46a5364f2fe9?source=collection_archive---------3-----------------------#2021-04-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="24a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您是否在考虑将Ruby on Rails项目CI管道迁移到Github Actions？您将学习如何配置Rails应用程序，以使用Github操作运行RSpec测试。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/006fe8c445c820cc659d6583646ef72e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ot8gHc1A4EQlhEUz.jpeg"/></div></div></figure><p id="9004" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本文介绍了Github操作YAML配置的一些内容:</p><ul class=""><li id="a9f4" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">如何使用<code class="fe lg lh li lj b">ruby/setup-ruby</code>动作用bundler安装Ruby gems并自动缓存gems？这样，您就可以从缓存中为您的项目加载Ruby gems，并快速运行CI构建。</li><li id="ae1d" class="kx ky iq jp b jq lk ju ll jy lm kc ln kg lo kk lc ld le lf bi translated">如何在Github动作上使用Postgres</li><li id="ce73" class="kx ky iq jp b jq lk ju ll jy lm kc ln kg lo kk lc ld le lf bi translated">如何在Github操作上使用Redis</li><li id="b017" class="kx ky iq jp b jq lk ju ll jy lm kc ln kg lo kk lc ld le lf bi translated">如何使用Github Actions build matrix运行并行作业，并跨多个作业执行RSpec测试以节省时间</li></ul><h1 id="96d0" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">Rails应用程序的Github操作YML配置</h1><h1 id="10c5" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">拼音/设置-拼音操作</h1><p id="d4b2" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated"><a class="ae ms" href="https://github.com/ruby/setup-ruby" rel="noopener ugc nofollow" target="_blank"> ruby/setup-ruby </a>是一个可以用来安装特定ruby编程语言版本的动作。它允许你根据你的Gemfile.lock开箱即用来缓存Ruby gems。</p><p id="ccfd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">建议<a class="ae ms" href="https://docs.knapsackpro.com/2021/how-to-load-ruby-gems-from-cache-on-github-actions" rel="noopener ugc nofollow" target="_blank">用</a> <code class="fe lg lh li lj b"><a class="ae ms" href="https://docs.knapsackpro.com/2021/how-to-load-ruby-gems-from-cache-on-github-actions" rel="noopener ugc nofollow" target="_blank">ruby/setup-ruby</a></code> <a class="ae ms" href="https://docs.knapsackpro.com/2021/how-to-load-ruby-gems-from-cache-on-github-actions" rel="noopener ugc nofollow" target="_blank">代替过时的</a> <code class="fe lg lh li lj b"><a class="ae ms" href="https://docs.knapsackpro.com/2021/how-to-load-ruby-gems-from-cache-on-github-actions" rel="noopener ugc nofollow" target="_blank">actions/setup-ruby</a></code>。</p><pre class="km kn ko kp gt mt lj mu mv aw mw bi"><span id="143e" class="mx lq iq lj b gy my mz l na nb">- name: Set up Ruby<br/>  uses: ruby/setup-ruby@v1<br/>  with:<br/>    <em class="nc"># Not needed with a .ruby-version file</em><br/>    ruby-version: 2.7<br/>    <em class="nc"># runs 'bundle install' and caches installed gems automatically</em><br/>    bundler-cache: true</span></pre><h1 id="2450" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">如何在Github操作上配置Postgres</h1><p id="f64f" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">要在Github操作上使用Postgres，您需要为Postgres设置一个服务。我推荐使用额外的选项来配置Postgres使用RAM而不是磁盘。这样，您的数据库可以在测试环境中运行得更快。</p><p id="a33d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在下面的配置中，我们还传递了进行健康检查的设置，以确保在开始运行测试之前数据库已经启动并运行。</p><pre class="km kn ko kp gt mt lj mu mv aw mw bi"><span id="0946" class="mx lq iq lj b gy my mz l na nb"><em class="nc"># If you need DB like PostgreSQL, Redis then define service below.</em><br/><em class="nc"># </em><a class="ae ms" href="https://github.com/actions/example-services/tree/master/.github/workflows" rel="noopener ugc nofollow" target="_blank"><em class="nc">https://github.com/actions/example-services/tree/master/.github/workflows</em></a><br/>services:<br/>  postgres:<br/>    image: postgres:10.8<br/>    env:<br/>      POSTGRES_USER: postgres<br/>      POSTGRES_PASSWORD: ""<br/>      POSTGRES_DB: postgres<br/>    ports:<br/>      - 5432:5432<br/>    <em class="nc"># needed because the postgres container does not provide a healthcheck</em><br/>    <em class="nc"># tmpfs makes DB faster by using RAM</em><br/>    options: &gt;-<br/>      --mount type=tmpfs,destination=/var/lib/postgresql/data<br/>      --health-cmd pg_isready<br/>      --health-interval 10s<br/>      --health-timeout 5s<br/>      --health-retries 5</span></pre><h1 id="bb54" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">如何在Github操作上配置Redis</h1><p id="59f3" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">您可以使用Redis Docker容器在Github操作上启动Redis服务器。看看这有多简单:</p><pre class="km kn ko kp gt mt lj mu mv aw mw bi"><span id="2474" class="mx lq iq lj b gy my mz l na nb">services:<br/>  redis:<br/>    image: redis<br/>    ports:<br/>      - 6379:6379<br/>    options: --entrypoint redis-server</span></pre><h1 id="a0b3" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">如何使用Github操作构建矩阵来运行并行作业测试</h1><p id="22ff" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">您可以在Github Actions中使用<a class="ae ms" href="https://docs.github.com/en/actions/learn-github-actions/managing-complex-workflows#using-a-build-matrix" rel="noopener ugc nofollow" target="_blank">构建矩阵</a>来同时运行多个作业。</p><p id="903e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将需要在这些并行作业之间分割测试文件。为此，您可以使用带有<a class="ae ms" href="https://docs.knapsackpro.com/2020/how-to-speed-up-ruby-and-javascript-tests-with-ci-parallelisation" rel="noopener ugc nofollow" target="_blank">队列模式的背包Pro在任务</a>之间平均分配测试。通过这种方式，您可以确保在每个作业上执行适当数量的测试，并且在作业之间很好地平衡工作量。简单地说，这种方式可以确保CI构建尽可能快—它有最佳的执行时间。</p><pre class="km kn ko kp gt mt lj mu mv aw mw bi"><span id="a64c" class="mx lq iq lj b gy my mz l na nb">- name: Run tests<br/>  env:<br/>    KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC: ${{ secrets.KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC }}<br/>    KNAPSACK_PRO_CI_NODE_TOTAL: ${{ matrix.ci_node_total }}<br/>    KNAPSACK_PRO_CI_NODE_INDEX: ${{ matrix.ci_node_index }}<br/>    KNAPSACK_PRO_FIXED_QUEUE_SPLIT: true<br/>    KNAPSACK_PRO_RSPEC_SPLIT_BY_TEST_EXAMPLES: true<br/>    KNAPSACK_PRO_LOG_LEVEL: info<br/>  run: |<br/>    bundle exec rake knapsack_pro:queue:rspec</span></pre><p id="b44b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以看到，对于RSpec，我们还使用了一个<code class="fe lg lh li lj b">knapsack_pro</code> Ruby gem标志<code class="fe lg lh li lj b">KNAPSACK_PRO_RSPEC_SPLIT_BY_TEST_EXAMPLES</code>。它允许自动<a class="ae ms" href="https://knapsackpro.com/faq/question/how-to-split-slow-rspec-test-files-by-test-examples-by-individual-it?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=medium-how-to-run-ruby-on-rails-tests-on-github-actions-using-rspec" rel="noopener ugc nofollow" target="_blank">检测缓慢的测试文件，并在并行作业之间分割它们</a>。</p><p id="d21f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以在另一篇文章中了解更多信息，这篇文章解释了<a class="ae ms" href="https://docs.knapsackpro.com/2020/how-to-run-slow-rspec-files-on-github-actions-with-parallel-jobs-by-doing-an-auto-split-of-the-spec-file-by-test-examples" rel="noopener ugc nofollow" target="_blank">如何通过测试示例</a>对Spec文件进行自动分割，在Github Actions上用并行作业运行慢速RSpec文件。</p><h1 id="2c23" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">Github动作和Ruby on Rails项目的完整YML配置</h1><p id="9c16" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">下面是Github操作的CI管道的完整配置。您可以使用它来运行Rails项目的测试。</p><pre class="km kn ko kp gt mt lj mu mv aw mw bi"><span id="d773" class="mx lq iq lj b gy my mz l na nb">name: Main<br/><br/>on: [push]<br/><br/>jobs:<br/>  test:<br/>    runs-on: ubuntu-latest<br/><br/>    <em class="nc"># If you need DB like PostgreSQL, Redis then define service below.</em><br/>    <em class="nc"># </em><a class="ae ms" href="https://github.com/actions/example-services/tree/master/.github/workflows" rel="noopener ugc nofollow" target="_blank"><em class="nc">https://github.com/actions/example-services/tree/master/.github/workflows</em></a><br/>    services:<br/>      postgres:<br/>        image: postgres:10.8<br/>        env:<br/>          POSTGRES_USER: postgres<br/>          POSTGRES_PASSWORD: ""<br/>          POSTGRES_DB: postgres<br/>        ports:<br/>          - 5432:5432<br/>        <em class="nc"># needed because the postgres container does not provide a healthcheck</em><br/>        <em class="nc"># tmpfs makes DB faster by using RAM</em><br/>        options: &gt;-<br/>          --mount type=tmpfs,destination=/var/lib/postgresql/data<br/>          --health-cmd pg_isready<br/>          --health-interval 10s<br/>          --health-timeout 5s<br/>          --health-retries 5<br/>      redis:<br/>        image: redis<br/>        ports:<br/>          - 6379:6379<br/>        options: --entrypoint redis-server<br/><br/>    <em class="nc"># </em><a class="ae ms" href="https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idstrategymatrix" rel="noopener ugc nofollow" target="_blank"><em class="nc">https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idstrategymatrix</em></a><br/>    strategy:<br/>      fail-fast: false<br/>      matrix:<br/>        <em class="nc"># [n] - where the n is a number of parallel jobs you want to run your tests on.</em><br/>        <em class="nc"># Use a higher number if you have slow tests to split them between more parallel jobs.</em><br/>        <em class="nc"># Remember to update the value of the `ci_node_index` below to (0..n-1).</em><br/>        ci_node_total: [8]<br/>        <em class="nc"># Indexes for parallel jobs (starting from zero).</em><br/>        <em class="nc"># E.g. use [0, 1] for 2 parallel jobs, [0, 1, 2] for 3 parallel jobs, etc.</em><br/>        ci_node_index: [0, 1, 2, 3, 4, 5, 6, 7]<br/><br/>    env:<br/>      RAILS_ENV: test<br/>      GEMFILE_RUBY_VERSION: 2.7.2<br/>      PGHOST: localhost<br/>      PGUSER: postgres<br/>      <em class="nc"># Rails verifies the time zone in DB is the same as the time zone of the Rails app</em><br/>      TZ: "Europe/Warsaw"<br/><br/>    steps:<br/>      - uses: actions/checkout@v2<br/><br/>      - name: Set up Ruby<br/>        uses: ruby/setup-ruby@v1<br/>        with:<br/>          <em class="nc"># Not needed with a .ruby-version file</em><br/>          ruby-version: 2.7<br/>          <em class="nc"># runs 'bundle install' and caches installed gems automatically</em><br/>          bundler-cache: true<br/><br/>      - name: Create DB<br/>        run: |<br/>          bin/rails db:prepare<br/>      - name: Run tests<br/>        env:<br/>          KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC: ${{ secrets.KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC }}<br/>          KNAPSACK_PRO_CI_NODE_TOTAL: ${{ matrix.ci_node_total }}<br/>          KNAPSACK_PRO_CI_NODE_INDEX: ${{ matrix.ci_node_index }}<br/>          KNAPSACK_PRO_LOG_LEVEL: info<br/>          <em class="nc"># if you use Knapsack Pro Queue Mode you must set below env variable</em><br/>          <em class="nc"># to be able to retry CI build and run previously recorded tests</em><br/>          <em class="nc"># </em><a class="ae ms" href="https://github.com/KnapsackPro/knapsack_pro-ruby#knapsack_pro_fixed_queue_split-remember-queue-split-on-retry-ci-node" rel="noopener ugc nofollow" target="_blank"><em class="nc">https://github.com/KnapsackPro/knapsack_pro-ruby#knapsack_pro_fixed_queue_split-remember-queue-split-on-retry-ci-node</em></a><br/>          KNAPSACK_PRO_FIXED_QUEUE_SPLIT: true<br/>          <em class="nc"># RSpec split test files by test examples feature - it's optional</em><br/>          <em class="nc"># </em><a class="ae ms" href="https://knapsackpro.com/faq/question/how-to-split-slow-rspec-test-files-by-test-examples-by-individual-it" rel="noopener ugc nofollow" target="_blank"><em class="nc">https://knapsackpro.com/faq/question/how-to-split-slow-rspec-test-files-by-test-examples-by-individual-it</em></a><br/>          KNAPSACK_PRO_RSPEC_SPLIT_BY_TEST_EXAMPLES: true<br/>        run: |<br/>          bundle exec rake knapsack_pro:queue:rspec</span></pre><h1 id="13ce" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">摘要</h1><p id="5902" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">您刚刚学习了如何在Github Actions上设置Rails应用程序。如果您将项目从不同的CI服务器迁移到Github Actions，我希望这能对您有所帮助。</p><p id="4a0c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以了解更多关于<a class="ae ms" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=medium-how-to-run-ruby-on-rails-tests-on-github-actions-using-rspec" rel="noopener ugc nofollow" target="_blank">backpack Pro</a>的内容，以及它如何帮助您在CI上使用并行作业快速运行测试。它可以与RSpec、Cucumber、Minitest和其他Ruby测试运行程序一起工作。<a class="ae ms" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=medium-how-to-run-ruby-on-rails-tests-on-github-actions-using-rspec" rel="noopener ugc nofollow" target="_blank">backpack Pro</a>也可以与JavaScript测试运行器一起工作，并具有原生API集成。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/836b68a76a3bc730b11c5ca28d82b0a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:160/format:webp/0*x2Z-HAawl-kPd9N3.png"/></div></figure></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><p id="0ae8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nc">原载于2021年4月8日https://docs.knapsackpro.com</em><a class="ae ms" href="https://docs.knapsackpro.com/2021/how-to-run-ruby-on-rails-tests-on-github-actions-using-rspec" rel="noopener ugc nofollow" target="_blank"><em class="nc"/></a><em class="nc">。</em></p></div></div>    
</body>
</html>