<html>
<head>
<title>How to increase CSS-in-JS performance by 175x</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将CSS-in-JS性能提高175倍</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-increase-css-in-js-performance-by-175x-f30ddeac6bce?source=collection_archive---------0-----------------------#2020-12-11">https://itnext.io/how-to-increase-css-in-js-performance-by-175x-f30ddeac6bce?source=collection_archive---------0-----------------------#2020-12-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="3d90" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我喜欢CSS-in-JS的便利性，尤其是在使用第三方组件时能够协同定位样式并提高易用性。但是我不相信一些事情:</p><ol class=""><li id="b76b" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">散列类是“必须的”,而不是命名空间类，当需要从第三方组件、营销和测试套件中选择元素时，散列类甚至可能是一个障碍。</li><li id="a1e4" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">在你的CSS中使用逻辑必然更好或者更可读，这也是一个<strong class="jp ir">性能杀手</strong>(下面将详细介绍)。</li><li id="a3aa" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">向10kb NPM组件添加25kb以上的小型JavaScript是一个好主意(不过对于应用程序来说没什么大不了的)。</li><li id="5b70" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">它可能会引入新的问题，例如因为Storybook使用另一个版本的emotion而中断，从UI库导入时主题提供程序中断，SSR中断，浏览器规则中断(在正文中插入<style>标签——有没有想过为什么emotion警告你不要使用:last-child？)等。&lt;/root&gt;</style></li></ol><p id="e6c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">起初，你可以尽情享受，不会注意到这些“极快”的运行时CSS解决方案的任何性能问题。直到你在<a class="ae kz" href="https://storybook.js.org/" rel="noopener ugc nofollow" target="_blank">故事书</a>的一页上写了一堆。</p><p id="1900" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们看看无处不在的按钮组件，因为它有各种样式和选项:</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi la"><img src="../Images/2fcee460684ca583b00bbde4d554a51a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RBiK7R5N9GyCCToOV2VJdg.png"/></div></div></figure><p id="01fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我们有一堆简单快速的函数来组成样式。我们甚至优化了静态css，使其成为自己的块(sharedStaticButtonStyles):</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi lm"><img src="../Images/9e6da04ba856b62ec121e45eb4192f91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_yDzF_drFKGmbj3xT2r8tQ.png"/></div></div></figure><p id="3edb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的按钮组件拥有Storybook中最动态的函数调用和最多的元素。让我们看看它如何执行加载。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi ln"><img src="../Images/c3e2faa9d88d3796ff60a42e1d363187.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7KEmRFEbH-hai-3tGbqnCQ.png"/></div></div></figure><p id="14d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这大约花费了<strong class="jp ir"> 36秒</strong>在情感解析上(见红色下划线)。性能工具使其长度增加了2到3倍，但仍然太长了。</p><h1 id="d3ff" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">情况变得更糟了</h1><p id="4777" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">我最初指责工具提示组件显示缓慢，后来意识到只有当它附加到按钮上时才出现。就在那时，我意识到Emotion在悬停时再次解析CSS，我猜是因为工具提示导致重新渲染，并在工具提示显示之前冻结主线程大约900毫秒。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi mr"><img src="../Images/15feb42f0eb810219e95edcc61901b5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j2yY6OeiKvqDgRFAbd8HMg.png"/></div></div></figure><p id="f418" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可能会想“我的组件并没有那么复杂或缓慢”。即使在一个页面上有许多组件的大型应用程序上，它们的速度是我的两倍，在CSS解析时花费1-2秒不必要的加载冻结时间也是不可接受的。尤其是在我开发的那种高度动态并且每秒接收很多更新的应用上(由于基于道具的风格的动态特性，这种情绪在每次渲染时都会重新解析<strong class="jp ir"/>就像在悬停时一样)。</p><h1 id="4fe5" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">那么，我们如何快速制作和保存东西呢？</h1><p id="35f7" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">首先，如果你要开始一个新项目，你可能要考虑编译时CSS-in-JS解决方案:</p><div class="ms mt gp gr mu mv"><a href="https://github.com/atlassian-labs/compiled" rel="noopener  ugc nofollow" target="_blank"><div class="mw ab fo"><div class="mx ab my cl cj mz"><h2 class="bd ir gy z fp na fr fs nb fu fw ip bi translated">大西洋实验室/编译</h2><div class="nc l"><h3 class="bd b gy z fp na fr fs nb fu fw dk translated">阅读文档→安装⚠️工作正在重新编写/设计一个新的巴别塔插件。在你自己的夜晚使用…</h3></div><div class="nd l"><p class="bd b dl z fp na fr fs nb fu fw dk translated">github.com</p></div></div><div class="ne l"><div class="nf l ng nh ni ne nj lk mv"/></div></div></a></div><div class="ms mt gp gr mu mv"><a href="https://github.com/callstack/linaria" rel="noopener  ugc nofollow" target="_blank"><div class="mw ab fo"><div class="mx ab my cl cj mz"><h2 class="bd ir gy z fp na fr fs nb fu fw ip bi translated">调用堆栈/linaria</h2><div class="nc l"><h3 class="bd b gy z fp na fr fs nb fu fw dk translated">JS库中的零运行时CSS。在GitHub上创建一个帐户，为callstack/linaria开发做贡献。</h3></div><div class="nd l"><p class="bd b dl z fp na fr fs nb fu fw dk translated">github.com</p></div></div><div class="ne l"><div class="nk l ng nh ni ne nj lk mv"/></div></div></a></div><div class="ms mt gp gr mu mv"><a href="https://vanilla-extract.style/" rel="noopener  ugc nofollow" target="_blank"><div class="mw ab fo"><div class="mx ab my cl cj mz"><h2 class="bd ir gy z fp na fr fs nb fu fw ip bi translated">vanilla-extract-Zero-runtime styles-in-TypeScript。</h2><div class="nc l"><h3 class="bd b gy z fp na fr fs nb fu fw dk translated">零运行时样式表-在类型脚本中。</h3></div><div class="nd l"><p class="bd b dl z fp na fr fs nb fu fw dk translated">零运行时样式表-in-type script . vanilla-extract . style</p></div></div></div></a></div><p id="0771" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你仍然想要一些动态的东西，你可以考虑Goober，它要小得多(1kb gzip)并且速度快两倍，或者是介于这两个选项之间的Stitches:</p><div class="ms mt gp gr mu mv"><a href="https://github.com/cristianbote/goober" rel="noopener  ugc nofollow" target="_blank"><div class="mw ab fo"><div class="mx ab my cl cj mz"><h2 class="bd ir gy z fp na fr fs nb fu fw ip bi translated">克里斯蒂安博特/古伯</h2><div class="nc l"><h3 class="bd b gy z fp na fr fs nb fu fw dk translated">🥜goober，不到1KB🎉带有熟悉API的css-in-js替代方案</h3></div><div class="nd l"><p class="bd b dl z fp na fr fs nb fu fw dk translated">github.com</p></div></div><div class="ne l"><div class="nl l ng nh ni ne nj lk mv"/></div></div></a></div><div class="ms mt gp gr mu mv"><a href="https://github.com/modulz/stitches" rel="noopener  ugc nofollow" target="_blank"><div class="mw ab fo"><div class="mx ab my cl cj mz"><h2 class="bd ir gy z fp na fr fs nb fu fw ip bi translated">GitHub-modulz/stitches:CSS-in-JS具有接近零的运行时间、SSR、多变体支持和一个…</h2><div class="nc l"><h3 class="bd b gy z fp na fr fs nb fu fw dk translated">CSS-in-JS具有接近零的运行时、SSR、多变体支持和一流的开发人员体验。针芯…</h3></div><div class="nd l"><p class="bd b dl z fp na fr fs nb fu fw dk translated">github.com</p></div></div><div class="ne l"><div class="nm l ng nh ni ne nj lk mv"/></div></div></a></div><p id="feae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是如果不担心的话，你可以通过使你的CSS更加静态来提高现有样式的性能达175倍。</p><p id="e0bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">已经有一些关于使用props主题化如何通过特设包装器来丰富您的应用程序的文章—<a class="ae kz" href="https://calendar.perfplanet.com/2019/the-unseen-performance-costs-of-css-in-js-in-react-apps/" rel="noopener ugc nofollow" target="_blank">https://calendar . perf planet . com/2019/the-unseen-performance-cost-of-CSS-in-js-in-react-apps/</a></p><p id="1249" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我开始一个新的项目，我会使用CSS变量来进行主题化，我已经写了如何做:<a class="ae kz" href="https://medium.com/@dominictobias/is-it-time-to-ditch-your-react-themeprovider-e8560dad2652" rel="noopener">https://medium . com/@ Dominic Tobias/is-it-time-to-ditch-your-react-theme provider-e 8560 dad 2652</a></p><h1 id="1ecf" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">但这不是您的性能瓶颈</h1><p id="332f" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">您的性能瓶颈在于css中的嵌套函数调用，这些调用接受主题以外的道具。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi nn"><img src="../Images/5c0b1242e073ddcd38bcf4d2ab58c134.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PUkOAEKjekpni3ddCLohPQ.png"/></div></div></figure><p id="144a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我没有深入研究运行时CSS代码，但是看起来如果你调用一个函数，它基本上是在说“我不知道这个函数会返回什么，所以我会在每次渲染时重新计算它”。</p><h1 id="c0e5" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">数据属性和CSS变量来拯救</h1><p id="f694" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">让我们改变按钮组件的工作方式:</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi no"><img src="../Images/9ac0a6242227c0903a641daa60ab6de6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o05NjSbgFn46BK4jqHVMzw.png"/></div></div></figure><p id="3fcc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里有趣的事情是CSS变量的使用，这也允许我们大幅减少我们需要编写的静态CSS的数量。</p><p id="9a0e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里有一个重构，我保留了旧的函数来获得颜色和大小，但是以几乎1:1的重构将它们从情感CSS移动到CSS变量:</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi np"><img src="../Images/98bc37583a7cb94aa9a1780b51434023.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xlC_mRjXPUT-oDaa-DIlMg.png"/></div></div></figure><p id="5ff1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个函数在大约0.002毫秒后第一次执行。不管怎样，让我们看看按钮CSS现在是什么样子:</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi nq"><img src="../Images/f6cf29061361338870fea2a8a53e5d11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SEANYCstXrqbxaFRAX3o8g.png"/></div></div></figure><p id="bae8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还记得花了<strong class="jp ir"> 36秒</strong>的解析时间吗？现在让我们看看:</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi nr"><img src="../Images/9b6931ad8347ad8e3b405434b31e2d4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RHAWU-g6Dsgrj1Rg7ecR-Q.png"/></div></div></figure><p id="7fa7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">是的，现在解析CSS花费了超过200毫秒的时间。请记住，关闭性能记录后，这些数字将会减少2到3倍。</p><p id="0eb3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以总而言之:</p><ul class=""><li id="194b" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk ns kr ks kt bi translated">在新项目中使用CSS变量进行主题化。</li><li id="1a8d" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk ns kr ks kt bi translated">保持你的CSS尽可能的静态变化(最重要的优化)。</li><li id="6501" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk ns kr ks kt bi translated">或者考虑在新项目中使用编译时CSS(上面有链接)。需要注意的是，设置它们可能会更麻烦，CSS-in-JS确实提供了无与伦比的开发者体验。</li></ul></div></div>    
</body>
</html>