<html>
<head>
<title>Extending the Ambassador/Java Distributed Tracing with LightStep</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用LightStep扩展Ambassador/Java分布式跟踪</h1>
<blockquote>原文：<a href="https://itnext.io/extending-the-ambassador-java-distributed-tracing-with-lightstep-40b7fc574c7?source=collection_archive---------2-----------------------#2018-10-17">https://itnext.io/extending-the-ambassador-java-distributed-tracing-with-lightstep-40b7fc574c7?source=collection_archive---------2-----------------------#2018-10-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="beec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上个月，我发表了一篇关于如何使用<a class="ae kl" href="https://blog.getambassador.io/distributed-tracing-with-java-microdonuts-kubernetes-and-the-ambassador-api-gateway-ace15b62a89e" rel="noopener ugc nofollow" target="_blank">kubernet-native Ambassador API gateway和Java open tracing‘micro donuts’</a>应用程序实现基于Zipkin的分布式跟踪的教程，在一些请求之后，我想现在返回并为此添加LightStep支持。</p><h1 id="b21d" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">介绍LightStep [x]PM</h1><p id="5f18" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">对于那些刚刚接触<a class="ae kl" href="https://lightstep.com/product/" rel="noopener ugc nofollow" target="_blank"> LightStep </a>的人来说，它是一个基于SaaS的分布式跟踪平台(以及更多)，旨在提供下一代应用程序性能监控(APM)——【x】PM。如果你感兴趣，我最近在InfoQ上的分布式跟踪和APM空间中写了一些关于<a class="ae kl" href="https://www.infoq.com/articles/distributed-tracing-microservices" rel="noopener ugc nofollow" target="_blank">的历史。LightStep平台基于卫星的架构很有趣，提供的UI和诊断工具也很有趣，我鼓励感兴趣的读者查看他们的</a><a class="ae kl" href="https://docs.lightstep.com/" rel="noopener ugc nofollow" target="_blank">综合文档</a>。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/ac2a2336a5e190ca2ec273c621bba2c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oEitg_x4aK_sXdMQAW8AAg.png"/></div></div></figure><p id="5ab9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本质上，LightStep [ <em class="mb"> x </em> ]PM数据处理管道有两个主要组件:卫星<em class="mb">、</em>和<em class="mb"> LightStep引擎，</em>SaaS组件。由被检测的客户端和服务器生成的所有跨度被发送到卫星池，在跟踪组装期间，它们在卫星池中被处理和临时存储。LightStep引擎查询卫星，记录跨度的综合信息，指导装配过程，并持久存储轨迹。</p><p id="f700" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以通过<a class="ae kl" href="https://go.lightstep.com/Try-xPM.html" rel="noopener ugc nofollow" target="_blank"> LightStep网站</a>试验SaaS平台，您将需要创建一个帐户并获得一个访问令牌，以便以编程方式向LightStep发送span数据。</p><h1 id="c141" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">配置OpenTracing Java“微节点”应用程序</h1><p id="edd4" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">如果您克隆我的GitHub repo的分支并列出目录内容，您应该会看到类似下面的内容:</p><pre class="lq lr ls lt gt mg mf mh mi aw mj bi"><span id="4e4b" class="mk kn iq mf b gy ml mm l mn mo">$ git clone <a class="ae kl" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>:danielbryantuk/java-opentracing-walkthrough.git<br/>...<br/>$ cd java-opentracing-walkthrough<br/>$ ls<br/>Dockerfile                      README.md                       kubernetes-ambassador           microdonuts<br/>LICENSE                         client                          kubernetes-ambassador-lightstep</span></pre><p id="00fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大部分内容和我原来的教程是一样的，如果你想了解更多细节，你可以看看这个。LightStep集成的主要附件位于<code class="fe mc md me mf b">kubernetes-ambassador-lightstep</code>文件夹中。如果您导航到此处并列出内容，您应该会看到类似如下的内容:</p><pre class="lq lr ls lt gt mg mf mh mi aw mj bi"><span id="a09a" class="mk kn iq mf b gy ml mm l mn mo">cd kubernetes-ambassador-lightstep/<br/>$ ls<br/>ambassador-rbac.yaml    ambassador-service.yaml lightstep-config.yaml   lightstep-tracing.yaml  microdonut.yaml         tracing-config.yaml</span></pre><p id="2124" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">光步跟踪配置位于<code class="fe mc md me mf b">lightstep-tracing.yaml</code>文件中。如果你在你最喜欢的编辑器中打开这个YAML文件，你会看到:</p><pre class="lq lr ls lt gt mg mf mh mi aw mj bi"><span id="81a4" class="mk kn iq mf b gy ml mm l mn mo">---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: lightstep<br/>  annotations:<br/>    getambassador.io/config: |<br/>      ---<br/>      apiVersion: ambassador/v0<br/>      kind: TracingService<br/>      name: tracing<br/>      service: "my-collector-grpc.mydomain.com:443"<br/>      driver: lightstep<br/>      config: {<br/>          access_token_file: /config/lightstep_api_key.txt<br/>      }<br/>spec:<br/>  type: ExternalName<br/>  externalName: my-collector-grpc.mydomain.com</span></pre><p id="39a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将会从上一教程中认出Ambassador注释和大多数TracingService细节，但是您还会注意到，除了将驱动程序从<code class="fe mc md me mf b">zipkin</code>更改为<code class="fe mc md me mf b">lightstep</code>之外，我还定义了TracingService以向外部URI(my-collector-grpc . mydomain . com，这是我的LightStep跟踪收集器在Kubernetes集群之外运行的地方)报告跟踪，并在TracingService配置中指定了一个<code class="fe mc md me mf b">access_token_file</code>属性。</p><p id="23d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你们当中善于观察的人很可能会思考，“我们如何将<code class="fe mc md me mf b">/config/lightstep_api_key.txt</code>文件提交给大使？问得好。Ambassador只是作为pod中的一个容器运行，而pod又是在部署中定义的，就像任何其他Kubernetes服务一样。因此，您可以将ConfigMap作为一个卷装载到包含相关数据的大使容器中。</p><p id="fcf7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们首先定义一个<a class="ae kl" href="https://kubernetes.io/docs/tutorials/configuration/" rel="noopener ugc nofollow" target="_blank">配置映射</a>，您可以在<code class="fe mc md me mf b">lightstep-config.yaml</code>文件中找到它的一个例子:</p><pre class="lq lr ls lt gt mg mf mh mi aw mj bi"><span id="2631" class="mk kn iq mf b gy ml mm l mn mo">---</span><span id="2988" class="mk kn iq mf b gy mp mm l mn mo">kind: ConfigMap<br/>apiVersion: v1<br/>metadata:<br/>    name: lightstep-config<br/>data:<br/>    lightstep_api_key.txt: &lt;your key here&gt;</span></pre><p id="5c87" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你正在跟进，并且有一个LightStep账户，那么用你实际的密钥文本替换<code class="fe mc md me mf b">&lt;your key here&gt;</code>。定义了ConfigMap之后，现在可以将它映射到大使容器中。如果您回头看一下<code class="fe mc md me mf b">ambassador-rbac.yaml</code>文件，您可以在配置的底部看到定义的<code class="fe mc md me mf b">volumeMounts</code>和<code class="fe mc md me mf b">volumes</code>(注意<code class="fe mc md me mf b">…</code>显示了我在哪里截断了配置以提高可读性):</p><pre class="lq lr ls lt gt mg mf mh mi aw mj bi"><span id="82e2" class="mk kn iq mf b gy ml mm l mn mo">---<br/>apiVersion: extensions/v1beta1<br/>kind: Deployment<br/>metadata:<br/>  name: ambassador<br/>spec:<br/>  replicas: 3<br/>  template:<br/>    ...<br/>    spec:<br/>      serviceAccountName: ambassador<br/>      ...<br/>        volumeMounts:<br/>        - name: lightstep-config-volume<br/>          mountPath: /config<br/>      restartPolicy: Always<br/>      volumes:<br/>      - name: lightstep-config-volume<br/>        configMap:<br/>          name: lightstep-config</span></pre><p id="52f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完成所有这些拼图后，现在您可以将带有LightStep Tracing的Ambassador部署到Kubernetes中。我将使用谷歌托管的GKE服务(有可抢占的虚拟机，只是为了保持低成本)，但你可以使用任何适合你的Kubernetes风格。</p><pre class="lq lr ls lt gt mg mf mh mi aw mj bi"><span id="c6bc" class="mk kn iq mf b gy ml mm l mn mo">$ gcloud container clusters create ambassador-tracing-demo --preemptible<br/>...<br/>Creating cluster ambassador-tracing-demo...done.<br/>...</span><span id="8b31" class="mk kn iq mf b gy mp mm l mn mo">$ kubectl create clusterrolebinding cluster-admin-binding-new \<br/>--clusterrole cluster-admin --user &lt; my GCP user name&gt;</span><span id="f600" class="mk kn iq mf b gy mp mm l mn mo">clusterrolebinding "cluster-admin-binding-new" created</span><span id="709d" class="mk kn iq mf b gy mp mm l mn mo">$ kubectl apply -f lightstep-config.yaml,ambassador-rbac.yaml<br/>configmap "lightstep-config" created<br/>service "ambassador-admin" created<br/>clusterrole "ambassador" created<br/>serviceaccount "ambassador" created<br/>clusterrolebinding "ambassador" created<br/>deployment "ambassador" created</span></pre><p id="9bdb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们继续部署LightStep跟踪配置:</p><pre class="lq lr ls lt gt mg mf mh mi aw mj bi"><span id="5550" class="mk kn iq mf b gy ml mm l mn mo">$ kubectl apply -f lightstep-tracing.yaml <br/>service "lightstep" created</span></pre><p id="2303" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您可以向集群部署一个简单的<code class="fe mc md me mf b">httpbin</code>服务，它指示大使代理从<code class="fe mc md me mf b">/httpbin/</code>路由到外部<code class="fe mc md me mf b">httpbin.org</code>网站的请求。</p><pre class="lq lr ls lt gt mg mf mh mi aw mj bi"><span id="5659" class="mk kn iq mf b gy ml mm l mn mo">$ kubectl apply -f ambassador-service.yaml <br/>service "ambassador" created</span></pre><p id="9993" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您可以向Kubernetes查询大使服务负载平衡器的外部IP地址。以下是我所看到的:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mq"><img src="../Images/1eee7f48bfbe503ba4c80af9beb71c9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x1-QuO2fL6q9lm2h65-RRg.png"/></div></div></figure><p id="2b19" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我可以看到Ambassador暴露在35.239.206.165的外部ip上，因此我可以向我的<code class="fe mc md me mf b">httpbin</code>服务发出请求，通过在httpbin API中指定“IP”端点来查询IP，如下所示:</p><pre class="lq lr ls lt gt mg mf mh mi aw mj bi"><span id="89e7" class="mk kn iq mf b gy ml mm l mn mo">$ curl 35.239.206.165/httpbin/ip<br/>{<br/>  "origin": "146.148.98.46"<br/>}</span></pre><p id="ca26" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以将Ambassador httpbin端点卷曲几次，以确保您已经创建了一些跟踪。如果您现在登录您的LightStep帐户并导航到LiveView，您应该会看到类似于以下内容的内容:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mr"><img src="../Images/2460f09033bfae752ac8015358e00607.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*liyK1AbdLXvPENUA_Jy2Ow.png"/></div></div></figure><p id="315a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此视图很好地概述了当前跟踪，包括页面上半部分的直方图中的延迟，以及页面下半部分的其他单个跟踪信息。您可以单击单个跟踪来获取有关跟踪的其他信息:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ms"><img src="../Images/4117877123cf31d7838461d0cd1e46be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AfDp_1TYLUBsnym9cv8D1Q.png"/></div></div></figure><p id="26b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，让我们部署MicroDonut应用程序以及与我们的配置跟踪相关的ConfigMap。现在您会注意到，我已经更新了Java应用程序的跟踪配置，以将其跟踪数据发送到LightStep，这与我们已经完成的配置Ambassador的工作是分开的。<code class="fe mc md me mf b">tracing-config.yaml</code>文件现在包含以下内容:</p><pre class="lq lr ls lt gt mg mf mh mi aw mj bi"><span id="e917" class="mk kn iq mf b gy ml mm l mn mo">---</span><span id="700d" class="mk kn iq mf b gy mp mm l mn mo">kind: ConfigMap<br/>apiVersion: v1<br/>metadata:<br/>    name: tracing-config<br/>data:<br/>    tracer_config.properties: |<br/>        public_directory=../client</span><span id="dbee" class="mk kn iq mf b gy mp mm l mn mo">// Selector for the below config blocks<br/>        tracer=<strong class="mf ir">lightstep</strong></span><span id="9633" class="mk kn iq mf b gy mp mm l mn mo">// Jaeger config<br/>        jaeger.reporter_host=localhost<br/>        jaeger.reporter_port=5775</span><span id="4cc7" class="mk kn iq mf b gy mp mm l mn mo">// Zipkin config<br/>        zipkin.reporter_host=zipkin<br/>        zipkin.reporter_port=9411</span><span id="85a8" class="mk kn iq mf b gy mp mm l mn mo">// LightStep config<br/>        <strong class="mf ir">lightstep.collector_host=&lt; your lightstep collector host &gt;<br/>        // The collector_protocol value is either "http" or "https"<br/>        lightstep.collector_protocol=http<br/>        lightstep.collector_port=8081<br/>        lightstep.access_token=&lt; your access token &gt;</strong></span></pre><p id="7f2f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你跟着做，你需要用你实际的文本令牌替换<code class="fe mc md me mf b">&lt;your access token &gt;</code>。</p><p id="64d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们将它部署到Kubernetes中:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mt"><img src="../Images/64a053499d53a8751e857ded00db906c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*47HNV3xdgCRUedgfqg1pmw.png"/></div></div></figure><p id="6bb0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您应该能够通过Ambassador外部IP和路线<code class="fe mc md me mf b">/microdonut/</code>通过您的网络浏览器访问MicroDonut应用程序，例如:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mu"><img src="../Images/668063740201461055868c7e4d7b4bfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*crNp4mtsclThFvluEd00vg.png"/></div></div></figure><p id="7dad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在你太饿之前，你可以通过点击图片，并按下显示在图片下方的“订购”按钮来订购一些虚拟甜甜圈。重复几次以生成一些轨迹，并导航到LightStep LiveView:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mv"><img src="../Images/4b334281ade90ddf999d2436588d3832.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mxq5FeyZU4kQF-Ojp29S8g.png"/></div></div></figure><p id="b440" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样！现在，您可以探索和试验大使、LightStep和微点。</p><h1 id="4a9c" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">结论</h1><p id="f1a3" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">您可以通过https://www.getambassador.io，了解更多关于大使的信息，并在大使文档中了解<a class="ae kl" href="https://www.getambassador.io/reference/services/tracing-service.html" rel="noopener ugc nofollow" target="_blank">大使分布式追踪</a>功能。今天就去https://go.lightstep.com/Try-xPM.html<a class="ae kl" href="https://go.lightstep.com/Try-xPM.html" rel="noopener ugc nofollow" target="_blank">试试轻盈舞步吧！如果你有任何问题，请加入我们的</a><a class="ae kl" href="http://d6e.co/slack" rel="noopener ugc nofollow" target="_blank"> Slack </a>，在下面的评论中给我们留言，或者在Twitter上发<a class="ae kl" href="https://www.twitter.com/getambassador.io" rel="noopener ugc nofollow" target="_blank"> @getambassadorio </a>。</p><h2 id="9c7e" class="mk kn iq bd ko mw mx dn ks my mz dp kw jy na nb la kc nc nd le kg ne nf li ng bi translated">鸣谢(非常感谢！)</h2><p id="9a9a" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">我想对AppDirect的Alex Gervais在这项工作中给予的所有帮助表示衷心的感谢。Alex不仅提供了指导，而且他之前已经完成了开源大使跟踪贡献的大部分工作，并且还修复了最近集成的一个bug。非常感谢LightStep团队，他们给了我们一个试用账户，并在文章撰写过程中提供了有用的反馈。</p><p id="8186" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mb">这篇文章是之前发表在getambassador.io博客</em>  <em class="mb">上的</em> <a class="ae kl" href="https://blog.getambassador.io/extending-the-ambassador-java-distributed-tracing-with-lightstep-89377b5c1f59" rel="noopener ugc nofollow" target="_blank"> <em class="mb">。</em></a></p></div></div>    
</body>
</html>