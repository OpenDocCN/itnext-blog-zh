<html>
<head>
<title>Wildcard Let’s Encrypt Certificate</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通配符让我们加密证书</h1>
<blockquote>原文：<a href="https://itnext.io/wildcard-lets-encrypt-certificate-2b6133a1acdf?source=collection_archive---------1-----------------------#2019-11-20">https://itnext.io/wildcard-lets-encrypt-certificate-2b6133a1acdf?source=collection_archive---------1-----------------------#2019-11-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f810" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用DNS-01挑战变得简单</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/1bf46fe09226224f997bba51cf51a875.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qyw0ADm95j8mYXC3oA5FVQ.png"/></div></div></figure><p id="fa27" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><a class="ae lq" href="https://letsencrypt.org/fr/" rel="noopener ugc nofollow" target="_blank"> Let's Encrypt </a>是一个免费的、自动化的、开放的认证机构，广泛用于创建TLS证书。它很好地集成在几个工具中，如Kubernetes Ingress控制器、<a class="ae lq" href="https://docs.cert-manager.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> Cert-Manager </a>，…但有时使用Let's Encrypt来生成TLS证书并以更手动的方式使用它也很方便。</p><p id="509e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当请求“让我们加密”证书时，需要回答一个质询，以便“让我们加密”可以确保请求者是域的所有者。几个挑战是可用的:HTTP-01，DNS-01，TLS-ASPN-01(每一个的细节可以在官方的Let's Encrypt文档中找到:【https://letsencrypt.org/fr/docs/challenge-types/】T4)。</p><p id="9dfe" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">HTTP-01挑战可能是最常用的，该挑战涉及的过程如下:</p><ul class=""><li id="379d" class="lr ls it kw b kx ky la lb ld lt lh lu ll lv lp lw lx ly lz bi translated">证书的请求需要从通过该域可到达的机器上完成</li><li id="a0d4" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">web服务器运行在端口80上，提供临时文本文件</li><li id="8c20" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">让我们加密验证它可以通过HTTP Get请求获得这个临时文件</li></ul><p id="b388" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这个挑战的一个限制是，在端口80上运行web服务器可能并不总是可行的，因为这个端口可能已经被另一个服务器使用。即使我们需要证书来保护在另一个端口上运行的服务器，也必须在端口80上回答挑战。</p><p id="6dda" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">因此，使用“让我们用DNS-01挑战加密”有时可能是一个不错的选择。让我们不运行web服务器，而是通过创建临时DNS条目来加密验证域的所有权，通过API调用DNS提供者的API。我们将会看到，使用一个<a class="ae lq" href="https://certbot.eff.org/" rel="noopener ugc nofollow" target="_blank"> Certbot </a>插件，这个任务变得非常简单。</p></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="103f" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">先决条件</h1><p id="19f5" class="pw-post-body-paragraph ku kv it kw b kx ne ju kz la nf jx lc ld ng lf lg lh nh lj lk ll ni ln lo lp im bi translated">我们首先需要完成几个步骤:</p><ul class=""><li id="10ed" class="lr ls it kw b kx ky la lb ld lt lh lu ll lv lp lw lx ly lz bi translated">从我们最喜欢的注册商那里购买域名。让我们考虑一下域名<em class="nj"> techwhale.io </em>(实际上是我前段时间在<a class="ae lq" href="https://gandi.net" rel="noopener ugc nofollow" target="_blank">gandi.net</a>上买的)。</li><li id="ded1" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">选择一个允许certbot DNS-01挑战的DNS提供商，<a class="ae lq" href="https://certbot.eff.org/docs/using.html#dns-plugins" rel="noopener ugc nofollow" target="_blank">有很多。在本文的例子中，我们将使用</a><a class="ae lq" href="https://cloudflare.com" rel="noopener ugc nofollow" target="_blank"> Cloudflare </a>。</li><li id="6eed" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">从我们购买域名的注册商那里，我们需要进入DNS设置并更改DNS条目，以便它使用您的DNS提供商提供的条目</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/724ec5a75799d3f35990087e9b8f11d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oiBwhHjaaY8RS0gYP1N1jA.png"/></div></div></figure><ul class=""><li id="effa" class="lr ls it kw b kx ky la lb ld lt lh lu ll lv lp lw lx ly lz bi translated">获取API密钥，允许API调用我们的DNS提供商</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/84a0e2b259eb4928dee28e1d5a7da223.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u2i-EnYU4hfvGek6nnCf1w.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">Cloudflare的API密钥(假的一个:)</figcaption></figure></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="5507" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">证书的创建</h1><p id="826a" class="pw-post-body-paragraph ku kv it kw b kx ne ju kz la nf jx lc ld ng lf lg lh nh lj lk ll ni ln lo lp im bi translated">首先，我们创建一个<em class="nj"> cf.ini </em>文件，其中包含Cloudflare API令牌和我们的电子邮件地址:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="5835" class="nv mn it nr b gy nw nx l ny nz"># Cloudflare API credentials used by Certbot<br/>dns_cloudflare_email = REPLACE_WITH_YOUR_EMAIL_ADDRESS<br/>dns_cloudflare_api_key = REPLACE_WITH_YOUR_API_TOKEN</span></pre><p id="ebad" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">接下来，我们设置以下环境变量:</p><ul class=""><li id="5f13" class="lr ls it kw b kx ky la lb ld lt lh lu ll lv lp lw lx ly lz bi translated">域，您需要为其获取证书的域名</li><li id="1faf" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">电子邮件，证书即将过期时将收到通知的电子邮件地址</li></ul><p id="9ff0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后，我们从本地机器上运行Cloudflare的Certbot插件(该插件在Docker Hub中作为容器映像提供),选项如下:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="7c73" class="nv mn it nr b gy nw nx l ny nz">$ docker run \<br/>  -v $PWD/cf.ini:/cloudflare.ini \<br/>  -v $PWD/etc/letsencrypt:/etc/letsencrypt \<br/>  certbot/dns-cloudflare \<br/>  certonly \<br/>  -d "$DOMAIN" \<br/>  -d "*.$DOMAIN" \<br/>  --preferred-challenges dns-01 \<br/>  --agree-tos \<br/>  -m $EMAIL \<br/>  --dns-cloudflare \<br/>  --dns-cloudflare-credentials /cloudflare.ini \<br/>  --non-interactive</span></pre><p id="775f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">下面的屏幕截图显示了这个命令为域<em class="nj"> techwhale.io </em>申请证书的过程。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/0bdd507a8ab76824a2d93fe3841d4cd7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W9hGQ6zutY20skr7LkXnEg.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">使用Certbot的Cloudflare插件获得一个使用DNS-01挑战的加密证书</figcaption></figure><p id="1388" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了验证域的所有权，DNS质询使用提供的凭据在DNS表中创建一个临时条目。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/54f99f8036b9553004414c61ab6f73e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OGq-7BkeojN6K9R4RmJCSA.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">由“让我们加密”创建的CNAME条目，用于回答DNS-01挑战</figcaption></figure><p id="2397" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">一旦创建了证书，就可以在本地的<em class="nj">etc/lets encrypt/live/tech whale . io/</em>文件夹中找到它(及其相关的私钥)。</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="9aa0" class="nv mn it nr b gy nw nx l ny nz">$ ls etc/letsencrypt/live/techwhale.io/<br/>README  cert.pem chain.pem <strong class="nr iu">fullchain.pem</strong> <strong class="nr iu">privkey.pem</strong></span></pre><p id="08fa" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">证书(<em class="nj"> fullchain.pem </em>)及其相关私钥(<em class="nj"> privkey.pem </em>)现在可用于为应用程序设置TLS终止。该证书是一个通配符证书，这意味着它可以用于所有子域。</p></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="4f6b" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">“证书”生命周期</h1><p id="5232" class="pw-post-body-paragraph ku kv it kw b kx ne ju kz la nf jx lc ld ng lf lg lh nh lj lk ll ni ln lo lp im bi translated">要检查关于我们已经创建的证书的信息，我们可以运行以下命令:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="047c" class="nv mn it nr b gy nw nx l ny nz">$ docker run \<br/>  -v $PWD/etc/letsencrypt:/etc/letsencrypt \<br/>  certbot/dns-cloudflare \<br/>  certificates</span></pre><p id="eaf8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">对于找到的每个证书，这将提供诸如文件位置(证书和相关私钥)和到期日期等信息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/9602063e868f62fac3a0ff2a537bde68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jmc22oaVvSkqEk0mGhDrDQ.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">列出可用的证书(这里只有一个)</figcaption></figure><p id="3538" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">一个加密证书将在3个月后过期。到期前几周，会发送一封类似以下内容的电子邮件:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/4d1133257b227f311ad9717c94f6bf9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_V3siQpT0x5KT1x8IUDpOg.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">由Let's Encrypt发送的通知证书即将过期的电子邮件示例</figcaption></figure><p id="9ab9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">要续订证书，我们只需运行以下命令:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="833e" class="nv mn it nr b gy nw nx l ny nz">$ docker run \<br/>  -v $PWD/cf.ini:/cloudflare.ini \<br/>  -v $PWD/etc/letsencrypt:/etc/letsencrypt \<br/>  -v $LOG_FOLDER:/var/log/letsencrypt \<br/>  certbot/dns-cloudflare \<br/>  renew</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/33d5c5505de2e299442d704f562591b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tj8CI-KUhQ4VKCRteGZ6lw.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">不需要续订证书，因为其到期日期离当前日期很远</figcaption></figure></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="ead2" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">摘要</h1><p id="bdc5" class="pw-post-body-paragraph ku kv it kw b kx ne ju kz la nf jx lc ld ng lf lg lh nh lj lk ll ni ln lo lp im bi translated">DNS-01挑战真的很容易使用，它没有与HTTP-01相同的限制，但需要使用提供API的DNS提供商。在本文中，我们将展示如何通过手动运行Certbot来实现这一点。我希望它有助于理解整个过程，以及一些可能的挑战，可以利用。当然，最好是使用额外的软件，使加密证书的整个生命周期、创建和定期更新自动化。</p></div></div>    
</body>
</html>