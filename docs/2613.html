<html>
<head>
<title>Deploying to Kubernetes using Helm2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Helm2部署到Kubernetes</h1>
<blockquote>原文：<a href="https://itnext.io/deploying-to-kubernetes-using-helm-313af95eadf2?source=collection_archive---------3-----------------------#2019-06-24">https://itnext.io/deploying-to-kubernetes-using-helm-313af95eadf2?source=collection_archive---------3-----------------------#2019-06-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="875e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这篇文章将指导您使用Helm创建Kubernetes资源并将其部署到集群中。如果你对赫尔姆一无所知，没关系。完全不会有问题。在这篇文章的结尾，你将会对如何使用helm有一个很好的了解。</p><p id="9500" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">什么是圣盔？</strong></p><p id="82f1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Helm是Kubernetes的包装经理。Helm允许您非常轻松地开发和维护最复杂的部署。相信我，这很容易。好吧，我们继续。Helm使用一种叫做<em class="ko">图表</em>的打包格式。一个<strong class="js iu">图表是描述一组Kubernetes资源的文件</strong>的集合。图表可用于部署单个资源或多个资源。</p><p id="6cee" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">假设您需要在集群中部署一个Kubernetes pod和一个服务。如果是，你做了什么？您将编写deployment.yaml和service.yaml文件，并使用下面的命令部署它们。</p><pre class="kp kq kr ks gt kt ku kv kw aw kx bi"><span id="3c3a" class="ky kz it ku b gy la lb l lc ld"><strong class="ku iu">kubectl apply -f &lt;file-name&gt;</strong></span></pre><p id="7224" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因为您有两个文件，所以您需要执行上述命令两次。在这种情况下，您需要部署50个Kubernetes资源，您必须对每个资源文件执行上述命令50次。然而，如果您有一个包含所有这50个资源文件的helm图表，您只需要<strong class="js iu">执行一个命令</strong>来部署所有这50个文件！！有多简单？</p><p id="dc6f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当我们谈论舵的时候，我们不能忘记舵杆。Tiller是运行在Kubernetes中的舵服务器，部署所有的舵图。因此，在使用helm在K8S集群中部署资源之前，还需要将helm安装到Kubernestes集群中。当您将helm安装到您的集群时，它将部署一个“<strong class="js iu">舵柄舱</strong>”，处理所有的helm包。</p><p id="21bb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">如何安装头盔？</strong></p><figure class="kp kq kr ks gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi le"><img src="../Images/686670606cf3c873fe85f51139622d50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*psU9zCFaaDEcNP34MG6lbA.png"/></div></div></figure><p id="faab" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在开始使用helm作为您的Kubernetes包管理器之前，您需要将Helm安装到您的本地机器上，并在您的Kubernetes集群中安装tiller pod，如上图所示。</p><p id="14ae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">安装舵</strong>:请使用<a class="ae lm" href="https://helm.sh/docs/using_helm/#installing-helm" rel="noopener ugc nofollow" target="_blank">舵公文</a>将舵安装到您的机器上。</p><p id="c091" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">部署Tiller </strong>:如果您可以在本地机器上使用“kubectl”命令连接到您的k8s集群，那么在您的Kubernetes集群上部署tiller pod就非常容易了。只需运行下面的命令在K8S集群中安装tiller，</p><pre class="kp kq kr ks gt kt ku kv kw aw kx bi"><span id="a8cb" class="ky kz it ku b gy la lb l lc ld">helm init</span></pre><blockquote class="ln lo lp"><p id="08db" class="jq jr ko js b jt ju jv jw jx jy jz ka lq kc kd ke lr kg kh ki ls kk kl km kn im bi translated"><strong class="js iu">注意:</strong>如果您在运行helm init命令时遇到以下错误，请使用<a class="ae lm" href="https://medium.com/@madeeshafernando/error-release-name-failed-namespaces-default-is-forbidden-user-99b3b6cb2720" rel="noopener">博客</a>中提到的步骤来修复它。</p><p id="8736" class="jq jr ko js b jt ju jv jw jx jy jz ka lq kc kd ke lr kg kh ki ls kk kl km kn im bi translated">"错误:释放nginx-ingress失败:命名空间" default "被禁止:用户" system:service account:kube-system:default "无法在命名空间" default "中的API组""中获取资源" namespaces " "</p></blockquote><p id="3466" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，您已经成功地配置了本地机器和Kubernetes集群来使用Helm。</p><p id="c0da" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">建造舵轮图</strong></p><p id="2994" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在你可以开始玩头盔了。图表被组织成一个目录中的文件集合。首先，使用下面的命令创建图表结构。</p><pre class="kp kq kr ks gt kt ku kv kw aw kx bi"><span id="1860" class="ky kz it ku b gy la lb l lc ld">helm create test-helm</span></pre><p id="fa32" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在进入“test-helm”目录，您可以看到下面的结构已经在该目录中创建。</p><pre class="kp kq kr ks gt kt ku kv kw aw kx bi"><span id="b55e" class="ky kz it ku b gy la lb l lc ld">├── charts<br/>├── Chart.yaml<br/>├── templates<br/>│   ├── deployment.yaml<br/>│   ├── _helpers.tpl<br/>│   ├── ingress.yaml<br/>│   ├── NOTES.txt<br/>│   ├── service.yaml<br/>│   └── tests<br/>│       └── test-connection.yaml<br/>└── values.yaml</span></pre><p id="936e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在templates文件夹中，您可以看到两个名为deployment.yaml和service.yaml的文件。如果您在集群中安装了这个helm chart，这两个文件将被部署到您的Kubernetes集群中。</p><p id="e636" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个目录中最重要的文件是values.yaml文件，因为它存储了模板目录中模板文件的变量。因此，让我们先看看values.yaml文件。下面显示了values.yaml文件的一部分，它位于我们之前刚刚创建的test-helm目录中。</p><pre class="kp kq kr ks gt kt ku kv kw aw kx bi"><span id="d9de" class="ky kz it ku b gy la lb l lc ld"># Default values for test-helm.<br/># This is a YAML-formatted file.<br/># Declare variables to be passed into your templates.</span><span id="6b9f" class="ky kz it ku b gy lt lb l lc ld">replicaCount: 1</span><span id="de20" class="ky kz it ku b gy lt lb l lc ld"><strong class="ku iu">image:<br/>  repository: nginx<br/>  tag: stable<br/>  pullPolicy: IfNotPresent</strong></span><span id="d501" class="ky kz it ku b gy lt lb l lc ld">nameOverride: ""<br/>fullnameOverride: ""</span><span id="d348" class="ky kz it ku b gy lt lb l lc ld">service:<br/>  type: ClusterIP<br/>  port: 80</span><span id="7d23" class="ky kz it ku b gy lt lb l lc ld">ingress:<br/>  enabled: false<br/>  annotations: {}<br/>    # kubernetes.io/ingress.class: nginx<br/>    # kubernetes.io/tls-acme: "true"<br/>  hosts:<br/>    - host: chart-example.local<br/>      paths: []</span></pre><p id="8b73" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当你看上面文件的“image”块时，你可以看到nginx:里面使用了stable image。如果需要更改deployment.yaml文件的映像，只需更改values.yaml文件的“image”块部分。因为图像细节是从values.yaml文件提取到deployment.yaml helm模板文件的，如下所示。</p><pre class="kp kq kr ks gt kt ku kv kw aw kx bi"><span id="b37c" class="ky kz it ku b gy la lb l lc ld">...<br/>.....<br/>spec:<br/> containers:<br/> - name: {{ .Chart.Name }}<br/> image: "<strong class="ku iu">{{ .Values.image.repository }}:{{ .Values.image.tag }}</strong>"<br/> imagePullPolicy: {{ .Values.image.pullPolicy }}<br/>.......<br/>...</span></pre><p id="18e3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如您所见，如果查看完整的deployment.yaml文件，您可以清楚地理解values.yaml文件中的变量在helm模板文件中是如何引用的。</p><p id="2c72" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">同样，如果您需要使用helm向集群部署更多的资源，只需将这些YAML文件插入到模板文件夹中。</p><figure class="kp kq kr ks gt lf gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/2de4a7c562efc25f672d71ea58fec5c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:430/format:webp/1*cEi6ZYoHkwayZGbeXUUjOQ.png"/></div></figure><p id="7645" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">正如您在上面看到的，您可以使用helm在集群中创建任何k8s资源。它可以是部署、服务、角色、服务帐户或任何可以在k8s集群中部署的资源。</p><p id="5f0e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">安装舵图</strong></p><p id="81d2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦创建了舵图，只需一个命令就可以将其安装到集群中。进入我们刚刚在上面创建的“test-helm”目录，运行下面的命令，</p><pre class="kp kq kr ks gt kt ku kv kw aw kx bi"><span id="bc43" class="ky kz it ku b gy la lb l lc ld">helm install --name my-helm-deployment .</span></pre><p id="3cec" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这将部署您放在模板文件夹中的所有YAML文件。这就是为什么我一开始就告诉你，你可以从一个helm命令部署任意数量的Kubernetes资源。</p><p id="cc87" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">希望这篇文章能消除你对helm的所有疑虑:)</p><p id="790a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">快乐驾驶！！！</p></div></div>    
</body>
</html>