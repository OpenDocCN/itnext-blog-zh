<html>
<head>
<title>Run Azure Self-hosted macOS Agents on Apple M1 Mac</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在苹果M1 Mac上运行Azure自托管macOS代理</h1>
<blockquote>原文：<a href="https://itnext.io/run-azure-self-hosted-macos-agents-on-apple-m1-mac-72726555d83b?source=collection_archive---------1-----------------------#2022-04-19">https://itnext.io/run-azure-self-hosted-macos-agents-on-apple-m1-mac-72726555d83b?source=collection_archive---------1-----------------------#2022-04-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="16fa" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">第1部分:使用M1 Mac来驱动您自己的iOS CI/CD管道</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/4113345909d1e824142e371580ac227d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kp9dB2jYr1tOpr1eWIns3g.png"/></div></div></figure><p id="e625" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">苹果在去年11月发布了基于ARM的M1芯片，明确表示最终将停止支持基于Intel的机器。M1驱动的机器已被证明比基于英特尔的机器更具性能和效率，截至目前，在微软Azure的DevOps CI/CD管道中利用这种性能的唯一方法是使用自托管代理。</p><p id="17fe" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在本帖中，我们将介绍如何使用基于M1的机器为自托管代理提高现有管道的性能和效率。如果你正在使用GitHub动作，你可以继续使用本系列的第2部分。</p><h1 id="a4f0" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">生成个人访问令牌</h1><p id="16cd" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">在开始之前，您需要为Azure DevOps组织内拥有足够权限的用户生成个人访问令牌(PAT)。对于范围，选择<strong class="kt ir">代理池(读取，管理)</strong>，并确保清除所有其他框。如果是一个<a class="ae ln" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/release/deployment-groups/?view=azure-devops" rel="noopener ugc nofollow" target="_blank">部署组</a>代理，对于范围选择<strong class="kt ir">部署组(读取，管理)</strong>并确保所有其他框都被清除。您可以选择窗口底部的<strong class="kt ir"> Show all scopes </strong>来查看要设置权限的可能范围的完整列表。</p><div class="kg kh ki kj gt ab cb"><figure class="ml kk mm mn mo mp mq paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/22dc7e7c91c5ae6602c638f69420ddac.png" data-original-src="https://miro.medium.com/v2/resize:fit:718/format:webp/1*zsVrANkI1NYEZEbxNFBa8A.jpeg"/></div></figure><figure class="ml kk mr mn mo mp mq paragraph-image"><img src="../Images/208d5d75714a621330f1cfc800cf3b21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1038/format:webp/1*XSSH8Mm-Cq4P-41IbTFYzw.png"/></figure></div><blockquote class="ms mt mu"><p id="9eb0" class="kr ks mv kt b ku kv jr kw kx ky ju kz mw lb lc ld mx lf lg lh my lj lk ll lm ij bi translated">注意:PAT至少需要代理池范围的读取和管理权限。您需要在哈希生成后复制PAT以备后用，因为它只能在生成后查看，并且在此步骤后不会再次显示。</p></blockquote><h1 id="7a9f" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">下载并配置代理</h1><p id="df34" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">在您的Azure DevOps项目中，您需要选择一个现有的代理池来添加您的基于M1的计算机，或者您可以创建一个新的代理池。为此，导航到Azure DevOps门户左侧栏上的<strong class="kt ir">项目设置</strong>或<strong class="kt ir">组织设置</strong>，这取决于您是要将代理分别添加到项目级别还是组织级别。</p><div class="kg kh ki kj gt ab cb"><figure class="ml kk mz mn mo mp mq paragraph-image"><img src="../Images/c22d997d5e49c3a7fef0cf2c1bb4396b.png" data-original-src="https://miro.medium.com/v2/resize:fit:498/format:webp/1*GJi7zfHbG8FIqJT-khWyuw.png"/></figure><figure class="ml kk na mn mo mp mq paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/8b2f0923fd7daf782f0beb2b675cbd26.png" data-original-src="https://miro.medium.com/v2/resize:fit:920/format:webp/1*B3jQbz7L8nEfvh_7gWqaKw.png"/></div></figure></div><p id="22d5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">接下来，选择或创建您打算用于iOS或macOS CI/CD工作流的代理池，首先单击左侧栏中的<strong class="kt ir">代理池</strong>，然后单击<strong class="kt ir">新建代理</strong>，如下所示。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/ccdfeb17039605c62c29ce266f61facf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/1*jyFGSw5l_ltaeCc_xQuykQ.png"/></div></figure><p id="a17e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然后，您需要点击<strong class="kt ir">下载</strong>将代理下载到您的M1代理上，如下图所示。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nc"><img src="../Images/5970cd42fdb4fd5390e81a083f707331.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3logUlUy63IibL1KbZUQzA.png"/></div></div></figure><p id="6adf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">之后，您只需要在您的M1机器上运行提供的命令来配置和启动代理，请参考上面的截图。</p><blockquote class="ms mt mu"><p id="1fee" class="kr ks mv kt b ku kv jr kw kx ky ju kz mw lb lc ld mx lf lg lh my lj lk ll lm ij bi translated">注意:如果你还没有这样做，你应该<a class="ae ln" href="https://support.apple.com/en-us/HT211861" rel="noopener ugc nofollow" target="_blank">在你的苹果M1机器</a>上安装Rosetta 2并安装<a class="ae ln" href="https://aka.ms/vstsagentosxsystem" rel="noopener ugc nofollow" target="_blank">系统必备</a>。</p></blockquote><h1 id="c0b0" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">交互配置和运行Azure DevOps代理</h1><p id="34f3" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">将代理提取到新创建的目录后，您需要运行<code class="fe nd ne nf ng b">./config.sh</code>，如上所示，将代理与您在Azure DevOps中的组织相关联。</p><p id="becf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当您这样做时，您将在终端中看到以下对话:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nh"><img src="../Images/53e1196008be470faf92707c8535be3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Wy5DeWyK_Tf-kMr2L2DPg.png"/></div></div></figure><p id="8556" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">首先，要连接您的服务器，您需要提供<code class="fe nd ne nf ng b">server URL</code>，也就是<code class="fe nd ne nf ng b">https://dev.azure.com/{organization name}</code>。接下来，您只需按Enter键选择PAT作为您的身份验证类型，最后在出现提示时将您之前收集的PAT粘贴到终端中。</p><p id="28aa" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在要配置您的代理，您需要提供代理池的名称来添加您的代理，并为您的代理命名。接下来，您必须提供一个工作文件夹或者接受默认选择<code class="fe nd ne nf ng b">_work</code>。</p><p id="6f34" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这样，您就可以通过运行<code class="fe nd ne nf ng b">./run.sh</code>来启动交互式代理了。</p><h1 id="0942" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">确认状态</h1><p id="4f4d" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">启动Azure DevOps自托管macOS代理后，您应该会在终端中看到一个<strong class="kt ir">“Listening for jobs】</strong>对话框。您还应该在Azure UI的相应代理池中看到新代理，如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ni"><img src="../Images/13c7d07f21219f0be96dfadcf986af47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4uzI9OlaaaQ3bfDw2v3J8w.png"/></div></div></figure><p id="57ea" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，您可以将管道的代理池名称更改为基于M1的机器池，并享受改进的管道性能:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/95cc195309be024ec88739c0c9fbf8a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r2FRWHeBfuG7RkiLTwSABA.png"/></div></div></figure><h1 id="86f5" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">配置工具缓存</h1><p id="ce7f" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">一些工具任务(即<code class="fe nd ne nf ng b"><a class="ae ln" href="https://docs.microsoft.com/en-in/azure/devops/pipelines/tasks/tool/use-ruby-version?view=azure-devops" rel="noopener ugc nofollow" target="_blank">Use Ruby Version</a></code>)要求您的工具缓存已经设置了所需的工具。您将在配置时提供的<code class="fe nd ne nf ng b">workFolder</code>(默认为<code class="fe nd ne nf ng b">_work</code>)内的<code class="fe nd ne nf ng b">_tool</code>目录中找到您的工具缓存。使用<a class="ae ln" href="https://brew.sh/" rel="noopener ugc nofollow" target="_blank"> homebrew </a>，您可以管理这些工具的不同版本，并且使用以下python脚本，您可以将已经安装的工具链接到您的<code class="fe nd ne nf ng b">_tool</code>文件夹。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><h1 id="403f" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">Sudoers构型</h1><p id="68b9" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">如果您的任务需要root权限，您可以通过键入<code class="fe nd ne nf ng b">sudo visudo</code>来配置您的<code class="fe nd ne nf ng b">sudoers</code>文件。您可以在该文件中添加以下行，以允许root权限，而不提示输入密码，但是，由于潜在的安全风险，这是不可取的:</p><pre class="kg kh ki kj gt nm ng nn no aw np bi"><span id="fef0" class="nq lp iq ng b gy nr ns l nt nu">your_username  ALL=(ALL) NOPASSWD: ALL</span></pre><p id="91a3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">或者，您可以添加限制应用程序级别，以便这些应用程序不需要密码提示。例如，默认的<strong class="kt ir">工具任务</strong>需要root权限才能在系统目录中创建符号链接，在这种情况下，您可以将<code class="fe nd ne nf ng b">ln</code>添加到无密码提示中，如下所示:</p><pre class="kg kh ki kj gt nm ng nn no aw np bi"><span id="c731" class="nq lp iq ng b gy nr ns l nt nu">your_username  ALL= NOPASSWD: <strong class="ng ir">/bin/ln<br/></strong># Or your additional applications with arguments:<strong class="ng ir"><br/></strong>your_username  ALL= NOPASSWD: <strong class="ng ir">/bin/ln</strong><strong class="ng ir">,</strong>/your_dir/your_bin your_args</span></pre></div></div>    
</body>
</html>