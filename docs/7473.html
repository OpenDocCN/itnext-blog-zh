<html>
<head>
<title>Pritunl: running VPN in Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Pritunl:在Kubernetes中运行VPN</h1>
<blockquote>原文：<a href="https://itnext.io/pritunl-running-vpn-in-kubernetes-55b260b27948?source=collection_archive---------4-----------------------#2022-10-05">https://itnext.io/pritunl-running-vpn-in-kubernetes-55b260b27948?source=collection_archive---------4-----------------------#2022-10-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/5ceee0bf6ef88cd7b8bbf8563302171b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/1*9vnYOuhADUBmLpbxaBqowg.png"/></div></figure><p id="5fc8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Pritunl是一个VPN服务器，具有一系列高级安全和访问控制功能。</p><p id="ed5b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">事实上，它只是OpenVPN的一个包装器，以组织、用户和路由的形式向它添加这样的访问控制列表。</p><p id="e96e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">任务是在Kubernetes中部署一个Pritunl测试实例，这样我们可以更仔细地观察它。</p><p id="a581" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，我们将使用免费版本，稍后将查看付费版本。差异和费用可以在<a class="ae ks" href="https://www.saasworthy.com/product/pritunl/pricing" rel="noopener ugc nofollow" target="_blank">这里找到&gt; &gt; &gt; </a>。</p><p id="0aae" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将在Minikube中运行它，对于安装，我们将使用来自Dysnix 的<a class="ae ks" href="https://www.datree.io/helm-chart/pritunl-dysnix" rel="noopener ugc nofollow" target="_blank">舵图。</a></p><h1 id="f289" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">在Kubernetes经营Pritunl</h1><p id="ab29" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">创建名称空间:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="a2e4" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl create ns pritunl-local<br/>namespace/pritunl-local created</span></pre><p id="b0ea" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加存储库:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="2162" class="mf ku iq mb b gy mg mh l mi mj">$ helm repo add dysnix <a class="ae ks" href="https://dysnix.github.io/charts" rel="noopener ugc nofollow" target="_blank">https://dysnix.github.io/charts</a></span></pre><p id="e01f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并使用Pritunl安装图表:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="b979" class="mf ku iq mb b gy mg mh l mi mj">$ helm -n pritunl-local install pritunl dysnix/pritunl…<br/>Pritunl default access credentials:<br/>export POD_ID=$(kubectl get pod — namespace pritunl-local -l app=pritunl,release=pritunl -o jsonpath=’{.items[0].metadata.name}’)<br/>kubectl exec -t -i — namespace pritunl-local $POD_ID pritunl default-password<br/>…<br/>export VPN_IP=$(kubectl get svc — namespace pritunl-local pritunl — template “{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}”)<br/>echo “VPN access IP address: ${VPN_IP}”</span></pre><p id="e839" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查豆荚:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="efa7" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl -n pritunl-local get pod<br/>NAME READY STATUS RESTARTS AGE<br/>pritunl-54dd47dc4d-672xw 1/1 Running 0 31s<br/>pritunl-mongodb-557b7cd849-d8zmj 1/1 Running 0 31s</span></pre><p id="fb0c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从主pod获取登录密码:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="dab6" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl exec -t -i — namespace pritunl-local pritunl-54dd47dc4d-672xw pritunl default-password<br/>…<br/>Administrator default password:<br/>username: “pritunl”<br/>password: “zZymAt1tH2If”</span></pre><p id="abe8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">查找其服务:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="fe60" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl -n pritunl-local get svc<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br/>pritunl LoadBalancer 10.104.33.93 &lt;pending&gt; 1194:32350/TCP 116s<br/>pritunl-mongodb ClusterIP 10.97.144.132 &lt;none&gt; 27017/TCP 116s<br/>pritunl-web ClusterIP 10.98.31.71 &lt;none&gt; 443/TCP 116s</span></pre><p id="d648" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里，负载平衡器<em class="mk"> pritunl </em>用于客户端访问VPN服务器，而<em class="mk">pri tunl-web</em>cluster IP服务用于访问web接口。</p><p id="6b57" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将端口转发到web:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="98b8" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl -n pritunl-local port-forward svc/pritunl-web 8443:443<br/>Forwarding from 127.0.0.1:8443 -&gt; 443<br/>Forwarding from [::1]:8443 -&gt; 443</span></pre><p id="f884" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">打开<a class="ae ks" href="https://localhost:8443" rel="noopener ugc nofollow" target="_blank"> https://localhost:8443 </a>:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/622666b6bf123dd99afc6c5b009638b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:990/format:webp/0*yX948G9jYOmf3egP.png"/></div></figure><p id="2cd5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">登录并进入初始设置:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi mm"><img src="../Images/c1961061f6b77354b08307eb72d2922d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WRK-d0-VbZHY0P0P.jpg"/></div></div></figure><p id="6983" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里，在公共地址中，运行Prytunl本身的主机的公共地址将被自动设置，然后它将被替换到客户端配置中作为VPN主机地址。</p><p id="83c9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">由于Pritunl在Kubernetes中工作，而Kubernetes运行在VirtualBox中，VirtualBox运行在普通家用PC上的Linux上，因此它不适合我们，但我们稍后会返回到它。现在，你可以让它保持原样。</p><p id="a392" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">其余的设定我们还不感兴趣。</p><h1 id="1c76" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">设置Pritunl VPN</h1><h2 id="98db" class="mf ku iq bd kv mr ms dn kz mt mu dp ld kf mv mw lh kj mx my ll kn mz na lp nb bi translated">组织，用户</h2><p id="84df" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">参见<a class="ae ks" href="https://docs.pritunl.com/docs/configuration-5#initial-setup" rel="noopener ugc nofollow" target="_blank">初始设置</a>。</p><p id="bd99" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Go群用户，Pritunl有群，但是有完全(付费)版本，我们以后再看。</p><p id="0a2f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，可以通过组织对用户进行分组。</p><p id="4815" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">转到用户，添加组织:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi nc"><img src="../Images/039f97d8b26eabd7d1b0eda23e97cc8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hkT10d6yGeYLzQLB.png"/></div></div></figure><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi nd"><img src="../Images/c0ffc6d9aa22951af7e107efa007a3ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MitBGKaBdD9cK_c6.png"/></div></div></figure><p id="ae6f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加用户:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi nd"><img src="../Images/5456d66be31d208c27e6130cb939885b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0O0ADyleO4A_oPJ-.png"/></div></div></figure><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/c3cc79bffadbc392593d48053d9345f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/0*Io7CaU944cu5ZiAq.png"/></div></figure><p id="643f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">PIN、电子邮件—可选，现在不需要。</p><h2 id="6716" class="mf ku iq bd kv mr ms dn kz mt mu dp ld kf mv mw lh kj mx my ll kn mz na lp nb bi translated">Pritunl服务器和路由</h2><p id="5ec9" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">参见<a class="ae ks" href="https://docs.pritunl.com/docs/configuration-3" rel="noopener ugc nofollow" target="_blank">服务器配置</a>。</p><p id="ff17" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">转到服务器，添加新服务器:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/59e37f3f44345e588ab7913328d886f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:980/format:webp/0*Mnsv0hIpBdemh-Cv.png"/></div></figure><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/ef2e17641ee625b29305da6266ef95d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/0*6PaKIzL46zcvaCKh.png"/></div></figure><p id="9f45" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里:</p><ul class=""><li id="deba" class="nh ni iq jw b jx jy kb kc kf nj kj nk kn nl kr nm nn no np bi translated"><strong class="jw ir"> DNS服务器</strong>:客户端的DNS服务器</li><li id="c3f8" class="nh ni iq jw b jx nq kb nr kf ns kj nt kn nu kr nm nn no np bi translated"><strong class="jw ir">端口，协议</strong>:OpenVPN的端口和协议，它将在Prytunl“内部”运行，并将接受来自我们用户的连接</li><li id="947d" class="nh ni iq jw b jx nq kb nr kf ns kj nt kn nu kr nm nn no np bi translated"><strong class="jw ir">虚拟网络</strong>:我们将从地址池中为客户端分配私有IP的网络</li></ul><p id="0a40" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我会挑出虚拟网络<em class="mk">172 . 16 . 0 . 0</em>——然后我们的家庭网络、俱吠罗的网络和客户端IP将有所不同——调试将更加简单，参见<a class="ae ks" href="https://www.arin.net/reference/research/statistics/address_filters/" rel="noopener ugc nofollow" target="_blank"> IPv4私有地址空间和过滤</a>。</p><p id="ca87" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">同时，这里的服务器端口必须与负载平衡器上的端口和协议相匹配，这一点很重要。</p><p id="a8d6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">即来自工作机器的请求将通过该路线:</p><ul class=""><li id="1619" class="nh ni iq jw b jx jy kb kc kf nj kj nk kn nl kr nm nn no np bi translated"><strong class="jw ir"> 192.168.3.0/24 </strong> —家庭网络</li><li id="c13f" class="nh ni iq jw b jx nq kb nr kf ns kj nt kn nu kr nm nn no np bi translated">点击VirtualBox网络<strong class="jw ir"> 192.168.59.1/24 </strong>(参见<a class="ae ks" href="https://minikube.sigs.k8s.io/docs/handbook/vpn_and_proxy/#proxy" rel="noopener ugc nofollow" target="_blank">代理</a>)</li><li id="bcae" class="nh ni iq jw b jx nq kb nr kf ns kj nt kn nu kr nm nn no np bi translated">将转到俱吠罗网络中的负载平衡器<strong class="jw ir"> 10.96.0.0/12 </strong></li><li id="b5eb" class="nh ni iq jw b jx nq kb nr kf ns kj nt kn nu kr nm nn no np bi translated">负载平衡器将向Kubernetes Pod发送一个请求，在那里我们让OpenVPN监听TCP端口1194</li></ul><p id="a3ed" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查负载平衡器本身:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="72bc" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl -n pritunl-local get svc pritunl<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE]<br/>pritunl LoadBalancer 10.104.33.93 &lt;pending&gt; 1194:32350/TCP 22m</span></pre><p id="021b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">端口1194 — TCP。稍后我们将处理<em class="mk">待定</em>状态。</p><p id="70be" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为服务器设置虚拟网络、端口和协议:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/5dd52b19f0dbd39462881eff6675f6b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1216/format:webp/0*rILQ7dkPuZJm4d-3.png"/></div></figure><p id="92d0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来，将组织与其所有用户联系起来:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/f26a857c1791bae353869455f184e1fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1286/format:webp/0*-ME-dm4ddSoo56SE.png"/></div></figure><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/3cfe4c353c921318e77f05929b1308a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1312/format:webp/0*ooX1LNT8bxejPidf.png"/></div></figure><p id="a0a0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">启动服务器:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi ny"><img src="../Images/509f88b14ab432830665d1ca1aaf362f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hNgO6S88YNAbclms.png"/></div></div></figure><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi nz"><img src="../Images/6e7bb1d36fa3f7203a9a74520e65bd13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6ZnlvACU-FMDq-dY.png"/></div></div></figure><p id="85cc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查Kubernetes Pod中的进程和端口—我们在端口1194上看到了我们的OpenVPN服务器:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="f520" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl -n pritunl-local exec -ti pritunl-54dd47dc4d-672xw — netstat -anp | grep 1194<br/>Defaulted container “pritunl” out of: pritunl, alpine (init)<br/>tcp6 0 0 :::1194 :::* LISTEN 1691/openvpn</span></pre><p id="ff64" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们去修理LoabBalancer。</p><h2 id="fe4a" class="mf ku iq bd kv mr ms dn kz mt mu dp ld kf mv mw lh kj mx my ll kn mz na lp nb bi translated">迷你库贝隧道</h2><p id="afbf" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">参见<a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-minikube-and-a-loadbalancer-in-the-pending-status/" rel="noopener ugc nofollow" target="_blank"> Kubernetes: Minikube，以及一个处于待定状态的负载平衡器</a>了解全部细节，现在只需调用<code class="fe oa ob oc mb b">minikube tunnel</code>:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="3449" class="mf ku iq mb b gy mg mh l mi mj">$ minikube tunnel<br/>[sudo] password for setevoy:<br/>Status:<br/>machine: minikube<br/>pid: 1467286<br/>route: 10.96.0.0/12 -&gt; 192.168.59.108<br/>minikube: Running<br/>services: [pritunl]<br/>errors:<br/>minikube: no errors<br/>router: no errors<br/>loadbalancer emulator: no errors<br/>…</span></pre><p id="80f3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查负载平衡器:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="be36" class="mf ku iq mb b gy mg mh l mi mj">$ kubectl -n pritunl-local get svc pritunl<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br/>pritunl LoadBalancer 10.104.33.93 10.104.33.93 1194:32350/TCP 139m</span></pre><p id="3f52" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe oa ob oc mb b">EXTERNAL-IP</code>现在具有正确的值，因此检查连接:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="f90c" class="mf ku iq mb b gy mg mh l mi mj">$ telnet 10.104.33.93 1194<br/>Trying 10.104.33.93…<br/>Connected to 10.104.33.93.<br/>Escape character is ‘^]’.</span></pre><p id="dc12" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">返回主设置，指定<em class="mk">公共地址</em> ==负载平衡器IP:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi od"><img src="../Images/fb013b30632e4ef0858fe2f0c40baf57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/0*R-fHAjTcHx68iRdX.png"/></div></figure><h2 id="56b2" class="mf ku iq bd kv mr ms dn kz mt mu dp ld kf mv mw lh kj mx my ll kn mz na lp nb bi translated">OpenVPN —连接到服务器</h2><p id="f7fb" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">转到用户，单击下载配置文件:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi oe"><img src="../Images/c7345c3fbfcd51aeba6a07396f23bf11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*r9QbTHUCFpGvB0AI.png"/></div></div></figure><p id="e59d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">解压缩归档文件:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="5327" class="mf ku iq mb b gy mg mh l mi mj">$ tar xfp local-user.tar</span></pre><p id="63ac" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并使用通用OpenVPN客户端进行连接:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="db1a" class="mf ku iq mb b gy mg mh l mi mj">$ sudo openvpn — config local-org_local-user_local-server.ovpn<br/>[sudo] password for setevoy:<br/>…<br/>2022–10–04 15:58:32 Attempting to establish TCP connection with [AF_INET]10.104.33.93:1194 [nonblock]<br/>2022–10–04 15:58:32 TCP connection established with [AF_INET]10.104.33.93:1194<br/>…<br/>2022–10–04 15:58:33 net_addr_v4_add: 172.16.0.2/24 dev tun0<br/>2022–10–04 15:58:33 WARNING: this configuration may cache passwords in memory — use the auth-nocache option to prevent this<br/>2022–10–04 15:58:33 Initialization Sequence Completed</span></pre><p id="cf47" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是现在网络不行了:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="9609" class="mf ku iq mb b gy mg mh l mi mj">$ traceroute 1.1.1.1<br/>traceroute to 1.1.1.1 (1.1.1.1), 30 hops max, 60 byte packets<br/>1 * * *<br/>2 * * *<br/>3 * * *<br/>…</span></pre><p id="bb77" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因为在我们的VPN中，到<em class="mk">0 . 0 . 0/0</em>的路由是通过VPN实际工作的同一个主机定向的，所以我们得到了一个“环”。</p><p id="38d4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">转到服务器，停止服务器并删除默认路由:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi of"><img src="../Images/0525554b8b14294384649a3452a8fd5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GQvsqCEvQUXRf6lj.png"/></div></div></figure><p id="b0e4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">点击<em class="mk">添加路由</em> —通过我们的VPN添加一条到1.1.1.1的路由，来自客户的所有其他请求将通过通常的路由:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi og"><img src="../Images/903da160480dfd9ed6eac474cc43da52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/0*171T5ayUVN6yyyby.png"/></div></figure><p id="dcc9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">重新启动连接:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="6946" class="mf ku iq mb b gy mg mh l mi mj">$ sudo openvpn — config local-org_local-user_local-server.ovpn</span></pre><p id="cdb7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在本地检查主机上的路由:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="54b7" class="mf ku iq mb b gy mg mh l mi mj">$ route -n<br/>Kernel IP routing table<br/>Destination Gateway Genmask Flags Metric Ref Use Iface<br/>0.0.0.0 192.168.3.1 0.0.0.0 UG 100 0 0 enp38s0<br/>1.1.1.1 172.16.0.1 255.255.255.255 UGH 0 0 0 tun0<br/>…</span></pre><p id="371e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并检查网络—请求通过了VPN:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="e7a2" class="mf ku iq mb b gy mg mh l mi mj">$ traceroute 1.1.1.1<br/>traceroute to 1.1.1.1 (1.1.1.1), 30 hops max, 60 byte packets<br/>1 172.16.0.1 (172.16.0.1) 0.211 ms 41.141 ms 41.146 ms<br/>2 * * *<br/>…</span></pre><p id="6ca6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="mk">“管用！”</em> (с)</p><p id="43d1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">完成了。</p></div><div class="ab cl oh oi hu oj" role="separator"><span class="ok bw bk ol om on"/><span class="ok bw bk ol om on"/><span class="ok bw bk ol om"/></div><div class="ij ik il im in"><p id="4624" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="mk">最初发布于</em> <a class="ae ks" href="https://rtfm.co.ua/en/pritunl-running-vpn-in-kubernetes/" rel="noopener ugc nofollow" target="_blank"> <em class="mk"> RTFM: Linux、DevOps、系统管理</em> </a> <em class="mk">。</em></p></div></div>    
</body>
</html>