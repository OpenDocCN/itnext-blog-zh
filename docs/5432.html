<html>
<head>
<title>Github Actions with Cucumber BDD browser parallel testing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Github Actions与Cucumber BDD浏览器并行测试</h1>
<blockquote>原文：<a href="https://itnext.io/github-actions-with-cucumber-bdd-browser-parallel-testing-1be62dda8fc4?source=collection_archive---------4-----------------------#2021-03-03">https://itnext.io/github-actions-with-cucumber-bdd-browser-parallel-testing-1be62dda8fc4?source=collection_archive---------4-----------------------#2021-03-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="853b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Cucumber采用行为驱动开发(BDD)来测试您的应用程序。在浏览器中运行时，这种类型的测试通常很耗时。您将学习如何使用并行作业在Github Actions上运行Cucumber测试，从而更快地执行测试套件。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/748af5afd3e72e4d31bb5047b4887efa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GNFZQ4V2zDhnlDbL.jpeg"/></div></div></figure><h1 id="06ef" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Github行动矩阵战略</h1><p id="5ae3" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">您可以使用<a class="ae ma" href="https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idstrategymatrix" rel="noopener ugc nofollow" target="_blank"> Github动作矩阵策略</a>来运行并行作业。您将需要在并行作业之间划分您的Cucumber测试文件，以便在作业之间平衡工作。</p><p id="1377" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这并不是那么简单，因为黄瓜测试通常需要不同的时间。一个测试文件可以有很多测试用例，另一个可以只有很少但非常复杂的测试用例，等等。</p><p id="f662" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">CI管道中通常有更多的步骤，如安装依赖项、从缓存中加载数据，甚至在Cucumber测试开始之前，每个并行作业的每个步骤都可能花费不同的时间。这些步骤会影响整体CI构建速度。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mb"><img src="../Images/1bb754ec8b3792654cacce7c54e2bdf5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Q1tWHEaMQDKGZ27f.png"/></div></div></figure><p id="bb23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您想要实现的是以这样一种方式运行并行作业，它们总是在相似的时间完成Cucumber测试的执行。由于这一点，您将避免可能成为CI构建瓶颈的滞后工作。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mc"><img src="../Images/094bdbafe6c738f1c4107e8da2371a9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7wPiWwG_DZM7-ogn.png"/></div></div></figure><h1 id="bd35" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">使用队列模式动态拆分黄瓜测试</h1><p id="ed34" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">为了获得最佳的CI构建执行时间，您需要确保并行作业之间的工作以这样的方式分割，以避免瓶颈缓慢的作业。为了实现这一点，您可以使用<a class="ae ma" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=cucumber-bdd-testing-using-github-actions-parallel-jobs-to-run-tests-quicker" rel="noopener ugc nofollow" target="_blank">backpack Pro</a>队列模式和<code class="fe md me mf mg b">knapsack_pro</code> ruby gem在并行作业之间动态分割Cucumber测试文件。</p><p id="fdbf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">backpack Pro API将负责协调如何在并行任务之间划分测试。在API端，有一个包含测试文件列表的队列，Github Actions上的每个并行作业都通过<code class="fe md me mf mg b">knapsack_pro</code> Ruby gem运行Cucumber测试。<code class="fe md me mf mg b">knapsack_pro</code> gem要求队列API运行一组测试文件，在它被执行后，gem要求另一组测试文件，直到队列被消耗。这确保了所有并行作业在非常相似的时间完成运行测试，以便您可以避免瓶颈作业。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/93fa5bccf789144aef38ca81953af9e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1358/format:webp/0*e_-QbLQoxx-GB9bs.png"/></div></figure><p id="7171" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以了解更多关于队列模式中的<a class="ae ma" href="https://docs.knapsackpro.com/2020/how-to-speed-up-ruby-and-javascript-tests-with-ci-parallelisation" rel="noopener ugc nofollow" target="_blank">动态测试套件分割的信息</a>或者查看下面的视频。</p><h1 id="ccce" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Cucumber的Github操作并行作业配置</h1><p id="a770" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">这里是一个Ruby on Rails项目中Cucumber测试套件的完整Github Actions YAML配置示例，使用<code class="fe md me mf mg b">knapsack_pro</code> gem在并行作业之间运行Cucumber测试。</p><pre class="km kn ko kp gt mi mg mj mk aw ml bi"><span id="7bfb" class="mm ky iq mg b gy mn mo l mp mq"><em class="mr"># .github/workflows/main.yml</em><br/>name: Main<br/><br/>on: [push]<br/><br/>jobs:<br/>  test:<br/>    runs-on: ubuntu-latest<br/><br/>    <em class="mr"># If you need DB like PostgreSQL, Redis then define service below.</em><br/>    <em class="mr"># </em><a class="ae ma" href="https://github.com/actions/example-services/tree/master/.github/workflows" rel="noopener ugc nofollow" target="_blank"><em class="mr">https://github.com/actions/example-services/tree/master/.github/workflows</em></a><br/>    services:<br/>      postgres:<br/>        image: postgres:10.8<br/>        env:<br/>          POSTGRES_USER: postgres<br/>          POSTGRES_PASSWORD: ""<br/>          POSTGRES_DB: postgres<br/>        ports:<br/>          - 5432:5432<br/>        <em class="mr"># needed because the postgres container does not provide a healthcheck</em><br/>        <em class="mr"># tmpfs makes DB faster by using RAM</em><br/>        options: &gt;-<br/>          --mount type=tmpfs,destination=/var/lib/postgresql/data<br/>          --health-cmd pg_isready<br/>          --health-interval 10s<br/>          --health-timeout 5s<br/>          --health-retries 5<br/><br/>      redis:<br/>        image: redis<br/>        ports:<br/>          - 6379:6379<br/>        options: --entrypoint redis-server<br/><br/>    <em class="mr"># </em><a class="ae ma" href="https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idstrategymatrix" rel="noopener ugc nofollow" target="_blank"><em class="mr">https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idstrategymatrix</em></a><br/>    strategy:<br/>      fail-fast: false<br/>      matrix:<br/>        <em class="mr"># Set N number of parallel jobs you want to run tests on.</em><br/>        <em class="mr"># Use higher number if you have slow tests to split them on more parallel jobs.</em><br/>        <em class="mr"># Remember to update ci_node_index below to 0..N-1</em><br/>        ci_node_total: [8]<br/>        <em class="mr"># set N-1 indexes for parallel jobs</em><br/>        <em class="mr"># When you run 2 parallel jobs then first job will have index 0, the second job will have index 1 etc</em><br/>        ci_node_index: [0, 1, 2, 3, 4, 5, 6, 7]<br/><br/>    steps:<br/>      - uses: actions/checkout@v2<br/><br/>      - name: Set up Ruby<br/>        uses: actions/setup-ruby@v1<br/>        with:<br/>          ruby-version: 2.7<br/><br/>      - uses: actions/cache@v2<br/>        with:<br/>          path: vendor/bundle<br/>          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}<br/>          restore-keys: |<br/>            ${{ runner.os }}-gems-<br/><br/>      - name: Bundle install<br/>        env:<br/>          RAILS_ENV: test<br/>        run: |<br/>          bundle config path vendor/bundle<br/>          bundle install --jobs 4 --retry 3<br/><br/>      - name: Create DB<br/>        env:<br/>          <em class="mr"># use localhost for the host here because we have specified a container for the job.</em><br/>          <em class="mr"># If we were running the job on the VM this would be postgres</em><br/>          PGHOST: localhost<br/>          PGUSER: postgres<br/>          RAILS_ENV: test<br/>        run: |<br/>          bin/rails db:prepare<br/><br/>      - name: Run tests<br/>        env:<br/>          PGHOST: localhost<br/>          PGUSER: postgres<br/>          RAILS_ENV: test<br/>          KNAPSACK_PRO_TEST_SUITE_TOKEN_CUCUMBER: ${{ secrets.KNAPSACK_PRO_TEST_SUITE_TOKEN_CUCUMBER }}<br/>          KNAPSACK_PRO_CI_NODE_TOTAL: ${{ matrix.ci_node_total }}<br/>          KNAPSACK_PRO_CI_NODE_INDEX: ${{ matrix.ci_node_index }}<br/>          KNAPSACK_PRO_FIXED_QUEUE_SPLIT: true<br/>          KNAPSACK_PRO_LOG_LEVEL: info<br/>        run: |<br/>          bundle exec rake knapsack_pro:queue:cucumber</span></pre><p id="f4a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里是来自Github Actions的视图，显示我们为CI构建运行8个并行作业。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ms"><img src="../Images/0b123ea3a4bd58f4a0e08be7ed3646de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JWwROCICyBtdwxi8.png"/></div></div></figure><h1 id="632f" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">摘要</h1><p id="2788" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">我希望这个例子对你有用。如果你想了解更多关于<a class="ae ma" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=cucumber-bdd-testing-using-github-actions-parallel-jobs-to-run-tests-quicker" rel="noopener ugc nofollow" target="_blank">backpack Pro的信息，请查看我们的主页</a>并查看一个列表，上面有<a class="ae ma" href="https://docs.knapsackpro.com/integration/" rel="noopener ugc nofollow" target="_blank">支持的Ruby、JavaScript等并行测试的测试运行程序</a>。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/d31efd3a09937f5ab3698f35b7e6c2d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:160/format:webp/0*RJNQAWF8I6wGvgOM.png"/></div></figure></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><p id="2963" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mr">原载于2021年3月3日</em><a class="ae ma" href="https://docs.knapsackpro.com/2021/cucumber-bdd-testing-using-github-actions-parallel-jobs-to-run-tests-quicker" rel="noopener ugc nofollow" target="_blank"><em class="mr">https://docs.knapsackpro.com</em></a><em class="mr">。</em></p></div></div>    
</body>
</html>