<html>
<head>
<title>Flexible and consistent configuration of Sequelize and Postgres</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Sequelize和Postgres灵活一致的配置</h1>
<blockquote>原文：<a href="https://itnext.io/flexible-and-consistent-configuration-of-sequelize-and-postgres-f17e3b650484?source=collection_archive---------2-----------------------#2018-08-13">https://itnext.io/flexible-and-consistent-configuration-of-sequelize-and-postgres-f17e3b650484?source=collection_archive---------2-----------------------#2018-08-13</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><figure class="iq ir gq gs is it gi gj paragraph-image"><div role="button" tabindex="0" class="iu iv di iw bf ix"><div class="gi gj ip"><img src="../Images/26d9ddd518cb3771a3fb2d2537e7d42a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hSlJBQcIHse32AMG_5Y_eQ.jpeg"/></div></div><figcaption class="ja jb gk gi gj jc jd bd b be z dk translated">一只快乐的狗(图片来源于作者的照片)</figcaption></figure><div class=""/><p id="a832" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated"><code class="fe lb lc ld le b"><a class="ae lf" href="https://www.postgresql.org" rel="noopener ugc nofollow" target="_blank">Postgresql</a></code>是一个非常受欢迎的<code class="fe lb lc ld le b">SQL</code>服务器，理由很充分；它做得很棒，它处理<code class="fe lb lc ld le b">JSON</code>和<code class="fe lb lc ld le b">HSTORE</code>数据结构，因此给你<code class="fe lb lc ld le b">MongoDB</code>的能力和健壮的<code class="fe lb lc ld le b">SQL</code>服务器的所有相关好处，它是免费和开源的，它得到很好的支持，并且它是由<code class="fe lb lc ld le b"><a class="ae lf" href="https://heroku.com" rel="noopener ugc nofollow" target="_blank">Heroku</a></code>提供的默认数据库。</p><p id="4884" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated"><code class="fe lb lc ld le b"><a class="ae lf" href="http://docs.sequelizejs.com" rel="noopener ugc nofollow" target="_blank">Sequelize</a></code>是最流行的<code class="fe lb lc ld le b">NodeJS</code>对象关系映射(<code class="fe lb lc ld le b">ORM</code>)库，也是有原因的。它是强大的，富有表现力的，成熟的。</p><p id="d779" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">当开发使用<code class="fe lb lc ld le b">Sequelize</code>和<code class="fe lb lc ld le b">Postgres</code>的应用程序时，我发现自己一遍又一遍地使用相同的基本模式来确保数据库连接可用。我已经发布了<code class="fe lb lc ld le b"><a class="ae lf" href="https://www.npmjs.com/package/sequelize-pg-utilities" rel="noopener ugc nofollow" target="_blank">sequelize-pg-utilities</a></code>来将这些模式整合到一个单独的库中。非常简单，它唯一的依赖项是<code class="fe lb lc ld le b"><a class="ae lf" href="https://www.npmjs.com/package/pgtools" rel="noopener ugc nofollow" target="_blank">pgtools</a></code>,如果需要的话，它使用这个依赖项来自动创建应用程序的数据库。</p><h1 id="3800" class="lg lh jg bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">配置</h1><p id="c3c8" class="pw-post-body-paragraph kd ke jg kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ik bi translated">首先，依赖数据库的应用程序需要一些配置。<code class="fe lb lc ld le b">Sequelize</code>方式是在<code class="fe lb lc ld le b">config/config.json</code>中坚持配置，这是相当有限的。为了允许定制配置，您需要将环境变量合并到标准配置文件选项中。此外，对于<code class="fe lb lc ld le b">config/config.json</code>文件中不存在的配置选项，您需要合理的默认值。</p><p id="9c03" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated"><code class="fe lb lc ld le b">configure</code>函数接受解析后的<code class="fe lb lc ld le b">config/config.json</code>文件，并返回一个配置对象，其值包括适当的环境变量值和合理的默认值。</p><p id="6674" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">因此，要创建一个已配置的<code class="fe lb lc ld le b">sequelize</code>实例，您可以:</p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="9ddf" class="mr lh jg le b gz ms mt l mu mv">const { configure } = require('sequelize-pg-utilities')<br/>const config = require('path/to/config/config.json')</span><span id="d48e" class="mr lh jg le b gz mw mt l mu mv"><strong class="le jh">const { name, user, password, options } = configure(config)</strong></span><span id="19ae" class="mr lh jg le b gz mw mt l mu mv">const sequelize = new Sequelize(name, user, password, options)</span></pre><p id="f3bc" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">以下环境变量优先于<code class="fe lb lc ld le b">config/config.json</code>中定义的变量。</p><ul class=""><li id="2c34" class="mx my jg kf b kg kh kk kl ko mz ks na kw nb la nc nd ne nf bi translated"><code class="fe lb lc ld le b">DATABASE_URL</code>如果提供了数据库url，它将覆盖下面的许多<code class="fe lb lc ld le b">DB</code>设置。</li><li id="bc5a" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b">DB_NAME</code>数据库名称——您也可以提供一个默认值(见下文)</li><li id="86f7" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b">DB_USER</code>数据库用户—无默认值</li><li id="71bd" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b">DB_PASS</code>数据库密码—无默认值</li><li id="770c" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b">DB_POOL_MAX</code>数据库连接的最大数量——默认为<code class="fe lb lc ld le b">5</code></li><li id="45a5" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b">DB_POOL_MIN</code>数据库连接的最小数量—默认为<code class="fe lb lc ld le b">1</code></li><li id="523c" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b">DB_POOL_IDLE</code>数据库空闲时间—默认为<code class="fe lb lc ld le b">10000</code>毫秒</li><li id="675b" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b">DB_HOST</code>数据库主机—默认为<code class="fe lb lc ld le b">‘localhost’</code></li><li id="40a8" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b">DB_PORT</code>数据库端口—默认为<code class="fe lb lc ld le b">5432</code></li><li id="7924" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b">DB_TYPE</code>数据库类型——默认为<code class="fe lb lc ld le b">‘postgres’</code>——这个库是用Postgres编写的，所以除非你知道你在做什么，否则请不要改变它。</li></ul><p id="e974" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">如果你提供<code class="fe lb lc ld le b">DATABASE_URL</code>环境变量，就像<code class="fe lb lc ld le b"><a class="ae lf" href="https://heroku.com" rel="noopener ugc nofollow" target="_blank">Heroku</a></code>和其他<code class="fe lb lc ld le b">paas</code>系统通常做的那样，那么<code class="fe lb lc ld le b">configure</code>函数将从中提取它所需要的大部分。提取的值将优先于后续值。</p><h1 id="bb8d" class="lg lh jg bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">初始化数据库</h1><p id="39e2" class="pw-post-body-paragraph kd ke jg kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ik bi translated">通常，您会希望应用程序在第一次运行时创建数据库，尤其是在<code class="fe lb lc ld le b">development</code>和<code class="fe lb lc ld le b">test</code>环境中。为此，您可以使用<code class="fe lb lc ld le b">makeInitialiser</code>功能对<code class="fe lb lc ld le b">initialiser</code>进行适当配置。</p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="bf2f" class="mr lh jg le b gz ms mt l mu mv">const { makeInitialiser } = require('sequelize-pg-utilities')<br/>const config = require('path/to/config/config.json')</span><span id="91c9" class="mr lh jg le b gz mw mt l mu mv"><strong class="le jh">const initialise = makeInitialiser(config)</strong></span><span id="2b81" class="mr lh jg le b gz mw mt l mu mv">const start = async () =&gt; {<br/>  try {<br/>    await initialise()</span><span id="4051" class="mr lh jg le b gz mw mt l mu mv">    // now do whatever else is needed<br/>    // to start your server<br/>  } catch (err) {<br/>    console.error(err)<br/>    process.exit(1)<br/>  }<br/>}</span></pre><p id="be56" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">您可以通过将重试次数作为参数传递给<code class="fe lb lc ld le b">initialise</code>来设置重试次数。默认是<code class="fe lb lc ld le b">5</code>。</p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="3a11" class="mr lh jg le b gz ms mt l mu mv">const result = await initialise(10)</span></pre><h1 id="80a4" class="lg lh jg bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">配置序列CLI</h1><p id="c969" class="pw-post-body-paragraph kd ke jg kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ik bi translated"><code class="fe lb lc ld le b">Sequelize CLI</code>要求您在项目的根目录下定义一个<code class="fe lb lc ld le b">.sequelizerc</code>文件，该文件导出诸如<code class="fe lb lc ld le b">config</code>、<code class="fe lb lc ld le b">migrations-path</code>和<code class="fe lb lc ld le b">models-path</code>之类的数据。</p><p id="4ad0" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">该配置的格式如下:</p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="538d" class="mr lh jg le b gz ms mt l mu mv">{<br/>  [env]: { username, password, database, options }<br/>}</span></pre><p id="12fc" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">您可以使用<code class="fe lb lc ld le b">migrationConfig</code>函数来生成配置细节，以满足<code class="fe lb lc ld le b">Sequelize CLI</code>的需求。</p><p id="7a94" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">在你的代码中，创建一个<code class="fe lb lc ld le b">migrationConfig.js</code>文件，如下所示:</p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="2814" class="mr lh jg le b gz ms mt l mu mv">const { migrationConfig } = require('sequelize-pg-utilities')<br/>const config = require('path/to/config/config.json')</span><span id="7817" class="mr lh jg le b gz mw mt l mu mv">module.exports = migrationConfig(config)</span></pre><p id="eca5" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">您的<code class="fe lb lc ld le b">.sequelizerc</code>文件变成:</p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="4019" class="mr lh jg le b gz ms mt l mu mv">const path = require('path')</span><span id="b1a6" class="mr lh jg le b gz mw mt l mu mv">module.exports = {<br/>  config: path.resolve(__dirname, 'path', 'to', 'migrationConfig.js'),<br/>  'migrations-path': path.resolve(__dirname, 'migrations'),<br/>  'models-path': path.resolve(__dirname, 'src', 'models')<br/>}</span></pre><h1 id="45ee" class="lg lh jg bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">选择</h1><p id="6d10" class="pw-post-body-paragraph kd ke jg kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ik bi translated"><code class="fe lb lc ld le b">configure</code>、<code class="fe lb lc ld le b">makeInitialiser</code>和<code class="fe lb lc ld le b">migrationConfig</code>功能都具有相同的签名。它们接受以下参数。</p><ul class=""><li id="35fe" class="mx my jg kf b kg kh kk kl ko mz ks na kw nb la nc nd ne nf bi translated"><code class="fe lb lc ld le b">config</code>:解析后的<code class="fe lb lc ld le b">config/config.json</code>文件。必需，无默认值。</li><li id="0fda" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b">defaultDbName</code>:如果数据库名称没有在环境变量中设置，并且如果<code class="fe lb lc ld le b">config</code>文件没有定义数据库名称，那么使用这个作为数据库名称。可选，无默认值。</li><li id="508a" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b">operatorsAliases</code> : Sequelize建议你不要使用<code class="fe lb lc ld le b"><a class="ae lf" href="http://docs.sequelizejs.com/manual/tutorial/querying.html#operators-aliases" rel="noopener ugc nofollow" target="_blank">operators aliases</a></code>，但是如果你想的话可以在这里设置。可选，默认为<code class="fe lb lc ld le b">false</code>。</li><li id="568c" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b">logger</code>:你可以在这里传递一个logger函数给Sequelize使用。可选，默认为<code class="fe lb lc ld le b">false</code>，表示不记录任何内容。</li></ul><h1 id="395a" class="lg lh jg bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">摘要</h1><p id="182a" class="pw-post-body-paragraph kd ke jg kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ik bi translated">您可以使用<code class="fe lb lc ld le b">sequelize-pg-utilities</code>简化并保持<code class="fe lb lc ld le b">Sequelize</code> / <code class="fe lb lc ld le b">Postgres</code>配置和初始化的一致性，这将公开以下功能:</p><ul class=""><li id="cef5" class="mx my jg kf b kg kh kk kl ko mz ks na kw nb la nc nd ne nf bi translated"><code class="fe lb lc ld le b">configure</code>:使用序列配置文件中的数据以及环境变量和合理的默认值来创建标准配置对象。</li><li id="840c" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated">创建一个配置好的、异步的、重试的数据库<code class="fe lb lc ld le b">initialise</code>函数，如果它不存在，你可以用它来创建你的数据库。</li><li id="ada3" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b">migrationConfig</code>:产生<code class="fe lb lc ld le b">.sequelizerc</code>文件所需的正确格式配置选项的功能。</li></ul><h1 id="602d" class="lg lh jg bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">链接</h1><ul class=""><li id="67a9" class="mx my jg kf b kg me kk mf ko nl ks nm kw nn la nc nd ne nf bi translated">一个非常流行和强大的SQL服务器。</li><li id="a04b" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b"><a class="ae lf" href="http://docs.sequelizejs.com" rel="noopener ugc nofollow" target="_blank">Sequelize</a></code>一个非常流行和强大的ORM工具</li><li id="5822" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b"><a class="ae lf" href="https://heroku.com" rel="noopener ugc nofollow" target="_blank">Heroku</a></code>一个非常流行的<code class="fe lb lc ld le b">platform-as-a-service</code>工具</li><li id="feef" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b"><a class="ae lf" href="https://www.npmjs.com/package/pgtools" rel="noopener ugc nofollow" target="_blank">pgtools</a></code>一个纯<code class="fe lb lc ld le b">NodeJS</code>实现的<code class="fe lb lc ld le b">Postgresql’s</code>和<code class="fe lb lc ld le b"><a class="ae lf" href="http://www.postgresql.org/docs/9.4/static/app-createdb.html" rel="noopener ugc nofollow" target="_blank">createdb</a></code>实用程序。</li><li id="44ea" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b"><a class="ae lf" href="https://www.npmjs.com/package/sequelize-pg-utilities" rel="noopener ugc nofollow" target="_blank">sequelize-pg-utilities</a></code>在NPM</li><li id="f54e" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated">GitHub中的<code class="fe lb lc ld le b"><a class="ae lf" href="https://github.com/davesag/sequelize-pg-utilities" rel="noopener ugc nofollow" target="_blank">sequelize-pg-utilities</a></code>源代码</li></ul><p id="6486" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi">—</p><p id="f5f2" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">像这样但不是订户？你可以通过<a class="ae lf" href="https://davesag.medium.com/membership" rel="noopener">davesag.medium.com</a>加入来支持作者。</p></div></div>    
</body>
</html>