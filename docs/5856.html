<html>
<head>
<title>How to use Database Sharding and Scale an ASP.NET Core Microservice Architecture</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用数据库分片和扩展ASP.NET核心微服务架构</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-use-database-sharding-and-scale-an-asp-net-core-microservice-architecture-22c24916590f?source=collection_archive---------0-----------------------#2021-06-12">https://itnext.io/how-to-use-database-sharding-and-scale-an-asp-net-core-microservice-architecture-22c24916590f?source=collection_archive---------0-----------------------#2021-06-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="67cb" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">对C # ASP.NET核心服务进行负载平衡，并使用MySql应用层分片。展示了同样适用于MongoDB等的概念。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/28644c646c0d3578ec58f95fb9706e21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qfNgu11fAZHUkZeohvUzzA.png"/></div></div></figure><p id="f428" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">微服务的<strong class="kt ir">大优势之一是，它们可以独立<strong class="kt ir">扩展</strong>。本文展示了扩展</strong> one <strong class="kt ir">微服务及其数据库</strong>的<strong class="kt ir">优势和挑战。</strong></p><p id="a4b6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您将创建一个<strong class="kt ir">工作示例应用</strong>并手动<strong class="kt ir">实现应用层分片</strong>。它展示了如何<strong class="kt ir">基于用例和数据模型选择一个分片键</strong>。这有助于将相同的原则应用于具有集成伸缩性的DBMS，如MongoDB等。</p><p id="f455" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="ln">延伸阅读:</em> <a class="ae lo" rel="noopener ugc nofollow" target="_blank" href="/scale-your-app-better-with-scaling-cube-1860930c4d57"> <em class="ln">用缩放立方体</em> </a> <em class="ln">按</em> <a class="lp lq ep" href="https://medium.com/u/3110c0425a2b?source=post_page-----22c24916590f--------------------------------" rel="noopener" target="_blank"> <em class="ln">伊斯坎德尔·萨马托夫</em> </a> <em class="ln">和</em> <a class="ae lo" href="https://betterprogramming.pub/what-exactly-is-database-sharding-ca618a2cbb9a" rel="noopener ugc nofollow" target="_blank"> <em class="ln">到底什么是数据库分片？</em> </a> <em class="ln">由</em> <a class="lp lq ep" href="https://medium.com/u/fbe24a4fdd7e?source=post_page-----22c24916590f--------------------------------" rel="noopener" target="_blank"> <em class="ln">哈里什V </em> </a></p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><p id="209f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是两部分中的第一部分。您将实现微服务并使用一个分片的数据库。</p><p id="90a0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在第二部分中，您将扩展并运行微服务和数据库的多个容器实例。您将使用docker compose和一个负载平衡器。最后，运行JMeter负载测试，查看应用程序在使用不同数量的实例时如何伸缩。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="74b8" class="ly lz iq bd ma mb mc md me mf mg mh mi jw mj jx mk jz ml ka mm kc mn kd mo mp bi translated">1.用例及数据模型</h1><p id="6533" class="pw-post-body-paragraph kr ks iq kt b ku mq jr kw kx mr ju kz la ms lc ld le mt lg lh li mu lk ll lm ij bi translated">示例应用程序由一个<strong class="kt ir">用户和一个post微服务</strong>组成。他们<strong class="kt ir">通过消息</strong>进行交流:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/e9261cb7ecdf9c3cb0bdd16eea23478d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1006/format:webp/1*DN2QzWP1oFpvFM0fh9gKrQ.png"/></div></figure><p id="66a8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">【参见我之前的文章 <a class="ae lo" rel="noopener ugc nofollow" target="_blank" href="/how-to-build-an-event-driven-asp-net-core-microservice-architecture-e0ef2976f33f"> <em class="ln">如何构建事件驱动的ASP.NET核心微服务架构</em></a><em class="ln"/></p><p id="3c52" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="ln">用户</em>微服务处理添加和修改用户。<em class="ln">帖子</em>微服务处理查看和添加帖子。与<em class="ln"> Post </em>微服务的交互要多得多。因此，当应用程序的负载增加<strong class="kt ir">时，<em class="ln"> Post </em>微服务将是第一个需要扩展的微服务</strong>。</p><p id="3c2f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">作者的名字是<em class="ln"> PostService </em>有界上下文的一部分，因此也是<em class="ln"> Post </em>微服务的一部分。添加和修改作者是在<em class="ln">用户</em>微服务中完成的。当添加新用户或更改用户名时,<em class="ln">用户</em>微服务发送事件。</p><h2 id="fb60" class="mw lz iq bd ma mx my dn me mz na dp mi la nb nc mk le nd ne mm li nf ng mo nh bi translated"><em class="ni">后期服务的逻辑数据模型</em></h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/7ca980f6090f5a6de7b031a13370b0a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N-i4KoRko3WrIakewYLykQ.png"/></div></div></figure><p id="fa76" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">用户可以分类写文章。他们也可以按类别阅读文章，包括作者姓名。最新的帖子在最上面。类别是固定的，很少改变。</p><p id="2ddf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">基于这些用例，我决定按类别划分:</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/7672f0da57dc1520524570fc2a0d95c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vBwiakd1uV_MnOKckNe-8A.png"/></div></div></figure></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="bcaf" class="ly lz iq bd ma mb mc md me mf mg mh mi jw mj jx mk jz ml ka mm kc mn kd mo mp bi translated">2.实施微服务</h1><p id="1026" class="pw-post-body-paragraph kr ks iq kt b ku mq jr kw kx mr ju kz la ms lc ld le mt lg lh li mu lk ll lm ij bi translated"><strong class="kt ir">用ASP.NET和web开发工作量安装</strong> <a class="ae lo" href="https://visualstudio.microsoft.com/en/vs/community/" rel="noopener ugc nofollow" target="_blank"> <strong class="kt ir"> Visual Studio社区</strong> </a>(免费)。</p><p id="1b1b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">创建一个解决方案</strong>，添加一个ASP.NET Core 5 Web API项目，名称为“<em class="ln"> PostService </em>”。禁用HTTPS并激活OpenAPI支持。</p><p id="7c2a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">安装以下NuGet包</strong>:</p><ul class=""><li id="8a91" class="nl nm iq kt b ku kv kx ky la nn le no li np lm nq nr ns nt bi translated">微软。实体框架工作核心工具</li><li id="c1d1" class="nl nm iq kt b ku nu kx nv la nw le nx li ny lm nq nr ns nt bi translated">MySql。实体框架工作核心</li><li id="6920" class="nl nm iq kt b ku nu kx nv la nw le nx li ny lm nq nr ns nt bi translated">纽顿软件。Json</li></ul><p id="6296" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">创建实体</strong></p><p id="272b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="ln">帖子</em>实体的索引应该加快对某个类别中最新帖子的检索:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="7f5b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="ln">用户</em>实体中的版本稍后将帮助处理无序消息:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="d880" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">创建<em class="ln">PostServiceContext</em>T35】</strong></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="a1d2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">在<em class="ln"> appsettings中为分片添加连接字符串。Development.json </em></strong></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="7baf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">添加<em class="ln">数据访问</em>代码</strong></p><p id="04e1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe ob oc od oe b">GetConnectionString(string category)</code>计算<code class="fe ob oc od oe b">CategoryId</code>的哈希。散列的第一部分以已配置碎片(连接字符串)的数量为模，确定给定类别的碎片。</p><p id="c698" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="ln"> InitDatabase </em>删除并重新创建所有碎片中的所有表，并插入虚拟用户和类别。</p><p id="e97d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">其他方法创建和加载文章。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="2401" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">在<em class="ln">startup . cs</em>T51】中注册<em class="ln"> DataAccess </em>为单例</strong></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="ab4b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">创建<em class="ln">后控制器</em>T55】</strong></p><p id="55a8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">它使用<em class="ln">数据访问</em>类</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="3db1" class="ly lz iq bd ma mb mc md me mf mg mh mi jw mj jx mk jz ml ka mm kc mn kd mo mp bi translated">3.从邮政服务访问数据库</h1><p id="3d13" class="pw-post-body-paragraph kr ks iq kt b ku mq jr kw kx mr ju kz la ms lc ld le mt lg lh li mu lk ll lm ij bi translated"><strong class="kt ir">安装</strong> <a class="ae lo" href="https://hub.docker.com/editions/community/docker-ce-desktop-windows" rel="noopener ugc nofollow" target="_blank"> <strong class="kt ir"> Docker桌面</strong> </a></p><p id="50dc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">创建两个MySql容器(每个命令占一行)</p><pre class="kg kh ki kj gt of oe og oh aw oi bi"><span id="1f31" class="mw lz iq oe b gy oj ok l ol om">C:\dev&gt;docker run -p 3310:3306 --name=mysql1 -e MYSQL_ROOT_PASSWORD=pw -d mysql:5.6</span><span id="5dcf" class="mw lz iq oe b gy on ok l ol om">C:\dev&gt;docker run -p 3311:3306 --name=mysql2 -e MYSQL_ROOT_PASSWORD=pw -d mysql:5.6</span></pre><p id="3a07" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在Visual Studio中启动<em class="ln"> Post </em>服务。浏览器在<code class="fe ob oc od oe b">http://localhost:5001/swagger/index.html</code>打开</p><p id="1c62" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">使用swagger UI与服务进行交互:</strong></p><p id="b65d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">用100个用户和10个类别初始化数据库:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oo"><img src="../Images/6e1872aee3991c11fcd1ad3cdf0b9901.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fBl-wzNlTuKb9U2O9eJuPA.png"/></div></div></figure><p id="e39e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">在“类别1”中添加一个帖子:</strong></p><pre class="kg kh ki kj gt of oe og oh aw oi bi"><span id="2e36" class="mw lz iq oe b gy oj ok l ol om">{<br/>  "title": "MyTitle",<br/>  "content": "MyContent",<br/>  "userId": 1,<br/>  "categoryId": "Category1"<br/>}</span></pre><p id="6e7c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">阅读“类别1”中排名前10的帖子</strong>以查看您的新帖子:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi op"><img src="../Images/4c08c5448041fa92d641b4799fbb288c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qrfNkc28IBcL-Lp7Qg3ONQ.png"/></div></div></figure><p id="2f89" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">连接到数据库容器并<strong class="kt ir">验证哪个数据库包含新的post </strong>。</p><pre class="kg kh ki kj gt of oe og oh aw oi bi"><span id="5784" class="mw lz iq oe b gy oj ok l ol om">C:\dev&gt;docker container exec -it mysql1 /bin/sh</span></pre><p id="8e96" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">使用密码“pw”登录MySql并阅读帖子:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/e1003103d546d350c6b660fd29314ce1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1014/format:webp/1*di3f8KF_WZBu0NY59Mno8w.png"/></div></figure><p id="3215" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">第二个实例不包含任何帖子:</p><pre class="kg kh ki kj gt of oe og oh aw oi bi"><span id="e27f" class="mw lz iq oe b gy oj ok l ol om">C:\dev&gt;docker container exec -it mysql2 /bin/sh</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi or"><img src="../Images/d1eb2fe9c8158c9b22dc7c4072ffeaa9.png" data-original-src="https://miro.medium.com/v2/resize:fit:580/format:webp/1*GVUXZpvsfZIjDcSTr8JM2Q.png"/></div></figure></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="3086" class="ly lz iq bd ma mb mc md me mf mg mh mi jw mj jx mk jz ml ka mm kc mn kd mo mp bi translated">4.最后的想法和展望</h1><p id="aa9c" class="pw-post-body-paragraph kr ks iq kt b ku mq jr kw kx mr ju kz la ms lc ld le mt lg lh li mu lk ll lm ij bi translated">您创建了一个<strong class="kt ir">工作应用程序，实现了应用层分片</strong>，并使用了分片键的概念。</p><p id="e1d3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这只是一个示例应用程序。您必须调整代码，以便在生产环境中使用它。</p><p id="5382" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在<a class="ae lo" rel="noopener ugc nofollow" target="_blank" href="/how-to-scale-an-asp-net-core-microservice-and-sharded-database-load-test-with-jmeter-1a8c7292e7e3"> <strong class="kt ir">第二部分</strong></a><strong class="kt ir"/>中，您将<strong class="kt ir">缩放</strong>和<a class="ae lo" rel="noopener ugc nofollow" target="_blank" href="/how-to-scale-an-asp-net-core-microservice-and-sharded-database-load-test-with-jmeter-1a8c7292e7e3">运行多个容器实例 </a>的微服务和数据库。您将使用<strong class="kt ir"> docker compose </strong>和一个<strong class="kt ir">负载平衡器</strong>。然后您将运行<a class="ae lo" rel="noopener ugc nofollow" target="_blank" href="/how-to-scale-an-asp-net-core-microservice-and-sharded-database-load-test-with-jmeter-1a8c7292e7e3"> <strong class="kt ir"> JMeter负载测试</strong> </a>来查看应用程序在使用不同数量的实例时是如何伸缩的。最后，您将通过<strong class="kt ir"> RabbitMQ </strong>从<em class="ln">用户</em>微服务中<a class="ae lo" rel="noopener ugc nofollow" target="_blank" href="/how-to-scale-an-asp-net-core-microservice-and-sharded-database-load-test-with-jmeter-1a8c7292e7e3"> <strong class="kt ir">模拟用户事件</strong> </a>。</p><p id="51f1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果您有任何问题、想法或建议，请联系我。</p></div></div>    
</body>
</html>