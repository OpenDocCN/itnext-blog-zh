<html>
<head>
<title>Kubernetes: PersistentVolume and PersistentVolumeClaim — an overview with examples</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes: PersistentVolume和PersistentVolumeClaim —示例概述</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-persistentvolume-and-persistentvolumeclaim-an-overview-with-examples-3c5688222f99?source=collection_archive---------4-----------------------#2020-08-05">https://itnext.io/kubernetes-persistentvolume-and-persistentvolumeclaim-an-overview-with-examples-3c5688222f99?source=collection_archive---------4-----------------------#2020-08-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/194f7c00055c0d75e23c5372361844e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cYMFCVQso7Rzqle2kBymYw.png"/></div></div></figure><p id="5999" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于持久数据，Kubernetes提供了两种主要类型的对象——persistent volume和PersistentVolumeClaim。</p><p id="7e82" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw"> PersistentVolume </em> —是一个存储设备和其上的文件系统卷，例如，它可以是连接到AWS EC2的AWS EBS，从群集的角度来看，PersistentVolume是一种类似的资源，比如说Kubernetes工作节点。</p><p id="9e98" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw"> PersistentVolumeClaim </em>依次请求使用这样的PersistentVolume资源，类似于Kubernetes pod——当Pod请求工作节点的资源时，PersistentVolumeClaim将从PersistentVolume请求资源:当Pod请求CPU、工作节点的内存时——PersistentVolumeClaim将请求必要的存储大小和访问类型— <code class="fe kx ky kz la b">ReadWriteOnce</code>、<code class="fe kx ky kz la b">ReadOnlyMany</code>或<code class="fe kx ky kz la b">ReadWriteMany</code>，请参见<a class="ae lb" href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes" rel="noopener ugc nofollow" target="_blank">访问模式</a>。</p><p id="53eb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">可以通过两种方式创建持久卷—静态和动态(推荐)。</p><p id="9cb4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当静态创建PV时，您必须首先创建一个存储设备，例如AWS EBS，它将由PersistentVolume使用。</p><p id="4445" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果群集无法为PersistentVolumeClaim н找到合适的PV，它可以完全为此PVC创建新的存储设备，这将是动态PV创建方式。</p><p id="44ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了实现这一点，PVC必须有一个<a class="ae lb" href="https://kubernetes.io/docs/concepts/storage/storage-classes/" rel="noopener ugc nofollow" target="_blank">存储类</a>设置相同，并且这个类必须得到集群的支持。</p><p id="134d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，对于AWS EKS，我们有<em class="kw">GP2</em>T3:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="0435" class="lk ll iq la b gy lm ln l lo lp">$ kubectl get storageclass<br/>NAME PROVISIONER AGE<br/>gp2 (default) kubernetes.io/aws-ebs 64d</span></pre><h1 id="f663" class="lq ll iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">存储类型</h1><p id="1d1a" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">为了更好地理解持久卷的概念，我们来看一下所有可用的存储:</p><ul class=""><li id="045c" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">节点本地存储(<code class="fe kx ky kz la b">emptyDir</code>和<code class="fe kx ky kz la b">hostPath</code>)</li><li id="1d15" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated">云卷(例如，<code class="fe kx ky kz la b">awsElasticBlockStore</code>、<code class="fe kx ky kz la b">gcePersistentDisk</code>和<code class="fe kx ky kz la b">azureDiskVolume</code>)</li><li id="3797" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated">文件共享卷，如网络文件系统</li><li id="54a6" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated">分布式文件系统(例如，CephFS、RBD和GlusterFS)</li><li id="3586" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated">特殊类型，如<code class="fe kx ky kz la b">PersistentVolumeClaim</code>、<code class="fe kx ky kz la b">secret</code>和<code class="fe kx ky kz la b">gitRepo</code></li></ul><p id="1fe0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kx ky kz la b">emptyDir</code>和<code class="fe kx ky kz la b">hostPath</code>直接连接到pod，并且仅当这样的pod处于活动状态时才能存储数据，而云卷、NFS和PersistentVolume独立于pod，并且将存储数据，直到这样的卷被删除。</p><h1 id="8cbb" class="lq ll iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">创建PersistentVolumeClaim</h1><h2 id="49b4" class="lk ll iq bd lr ng nh dn lv ni nj dp lz kj nk nl md kn nm nn mh kr no np ml nq bi translated">静态持续卷配置</h2><h2 id="fac3" class="lk ll iq bd lr ng nh dn lv ni nj dp lz kj nk nl md kn nm nn mh kr no np ml nq bi translated">创建一个EBS</h2><p id="e4f5" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">首先，对于静态资源调配，我们需要创建一个存储设备，在本例中，它将是AWS EBS，然后我们将创建一个使用此EBS的持久卷。</p><p id="48d7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个EBS:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="2262" class="lk ll iq la b gy lm ln l lo lp">$ aws ec2 --profile arseniy --region us-east-2 create-volume --availability-zone us-east-2a --size 50<br/>{<br/>“AvailabilityZone”: “us-east-2a”,<br/>“CreateTime”: “2020–07–29T13:10:12.000Z”,<br/>“Encrypted”: false,<br/>“Size”: 50,<br/>“SnapshotId”: “”,<br/>“State”: “creating”,<br/>“VolumeId”: “vol-0928650905a2491e2”,<br/>“Iops”: 150,<br/>“Tags”: [],<br/>“VolumeType”: “gp2”<br/>}</span></pre><p id="3469" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">存储其id—<em class="kw">“vol-0928650905 a 2491 e 2”</em>。</p><h2 id="8774" class="lk ll iq bd lr ng nh dn lv ni nj dp lz kj nk nl md kn nm nn mh kr no np ml nq bi translated">创建持久卷</h2><p id="2289" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">写一个清单文件，姑且称之为<code class="fe kx ky kz la b">pv-static.yaml</code>:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="2a79" class="lk ll iq la b gy lm ln l lo lp">apiVersion: v1<br/>kind: PersistentVolume<br/>metadata:<br/>  name: pv-static<br/>spec:<br/>  capacity:<br/>    storage: 5Gi<br/>  accessModes:<br/>    - ReadWriteOnce<br/>  storageClassName: gp2<br/>  awsElasticBlockStore:<br/>    fsType: ext4<br/>    volumeID: vol-0928650905a2491e2</span></pre><p id="fffd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里:</p><ul class=""><li id="c9c1" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated"><code class="fe kx ky kz la b">capacity</code>:存储大小</li><li id="6a10" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated"><code class="fe kx ky kz la b">accessModes</code>:接入类型，这里是<code class="fe kx ky kz la b">ReadWriteOnce</code>，表示该PV同一时间只能挂一个WorkerNode</li><li id="5bab" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated"><code class="fe kx ky kz la b">storageClassName</code>:存储访问，见下文</li><li id="60c7" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated"><code class="fe kx ky kz la b">awsElasticBlockStore</code>:使用的设备类型</li><li id="f064" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated"><code class="fe kx ky kz la b">fsType</code>:要在该卷上创建的文件系统类型</li><li id="ece9" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated"><code class="fe kx ky kz la b">volumeID</code>:AWS EBS光盘ID</li></ul><p id="9486" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建持久卷:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="893f" class="lk ll iq la b gy lm ln l lo lp">$ kubectl apply -f pv-static.yaml<br/>persistentvolume/pv-static created</span></pre><p id="59d4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查一下:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="d467" class="lk ll iq la b gy lm ln l lo lp">$ kubectl get pv<br/>NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE<br/>pv-static 5Gi RWO Retain Available 69s</span></pre><h2 id="33ea" class="lk ll iq bd lr ng nh dn lv ni nj dp lz kj nk nl md kn nm nn mh kr no np ml nq bi translated"><code class="fe kx ky kz la b">StorageClass</code></h2><p id="664d" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated"><code class="fe kx ky kz la b">storageClassName</code>参数将设置存储类型。</p><p id="e82d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">PVC和PV必须具有相同的类别，否则，PVC将找不到PV，并且这种PVC的状态将为<em class="kw">待定</em>。</p><p id="6db7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果PVC没有设置<code class="fe kx ky kz la b">StorageClass</code>，那么将使用默认值:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="af6c" class="lk ll iq la b gy lm ln l lo lp">$ kubectl get storageclass -o wide<br/>NAME PROVISIONER AGE<br/>gp2 (default) kubernetes.io/aws-ebs 65d</span></pre><p id="280a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在此期间，如果没有为PV设置<code class="fe kx ky kz la b">StorageClass</code>——此PV将被创建为没有类，并且我们具有默认类的PVC将无法使用此PV，并且“<strong class="ka ir"> <em class="kw">无法绑定到请求的卷“PV name”:storage class name与</em> </strong>不匹配”错误:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="efba" class="lk ll iq la b gy lm ln l lo lp">…<br/>Events:<br/>Type Reason Age From Message<br/> — — — — — — — — — — — — -<br/>Warning VolumeMismatch 12s (x17 over 4m2s) persistentvolume-controller Cannot bind to requested volume “pvname”: storageClassName does not match<br/>…</span></pre><p id="2792" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">参见文档<a class="ae lb" href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#class-1" rel="noopener ugc nofollow" target="_blank">此处&gt; &gt; &gt; </a>和<a class="ae lb" href="https://kubernetes.io/docs/concepts/storage/storage-classes/" rel="noopener ugc nofollow" target="_blank">此处&gt; &gt; &gt; </a>。</p><h2 id="ca2d" class="lk ll iq bd lr ng nh dn lv ni nj dp lz kj nk nl md kn nm nn mh kr no np ml nq bi translated">创建PersistentVolumeClaim</h2><p id="370a" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">现在，我们可以创建一个PersistentVolumeClaim，它将使用我们在上面创建的PersistentVolume到<code class="fe kx ky kz la b">pvc-static.yaml</code>文件:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="9d96" class="lk ll iq la b gy lm ln l lo lp">kind: PersistentVolumeClaim<br/>apiVersion: v1<br/>metadata:<br/>  name: pvc-static<br/>spec:<br/>  accessModes:<br/>    - ReadWriteOnce<br/>  resources:<br/>    requests:<br/>      storage: 5Gi<br/>  volumeName: pv-static</span></pre><p id="8b6e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建此PVC:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="f06e" class="lk ll iq la b gy lm ln l lo lp">$ kubectl apply -f pvc-static.yaml<br/>persistentvolumeclaim/pvc-static created</span></pre><p id="f968" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查一下:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="aed0" class="lk ll iq la b gy lm ln l lo lp">$ kubectl get pvc pvc-static<br/>NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE<br/>pvc-static Bound pv-static 5Gi RWO gp2 31s</span></pre><h2 id="dd4d" class="lk ll iq bd lr ng nh dn lv ni nj dp lz kj nk nl md kn nm nn mh kr no np ml nq bi translated">动态持续卷配置</h2><p id="a6e8" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">创建PersistentVolume的动态方法类似于静态方法，唯一的区别是您不需要手动创建AWS EBS和PersistentVolume资源，相反，您只需创建一个PersistentVolumeClaim对象，Kubernetes将通过AWS API创建一个EBS，并挂载到在Kubernetes集群中扮演WorkerNode角色的AWS EC2:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="8f94" class="lk ll iq la b gy lm ln l lo lp">kind: PersistentVolumeClaim<br/>apiVersion: v1<br/>metadata:<br/>  name: pvc-dynamic<br/>spec:<br/>  accessModes:<br/>    - ReadWriteOnce<br/>  resources:<br/>    requests:<br/>      storage: 5Gi</span></pre><p id="d763" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建此PVC:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="bbe0" class="lk ll iq la b gy lm ln l lo lp">$ kubectl apply -f pvc-dynamic.yaml<br/>persistentvolumeclaim/pvc-dynamic created</span></pre><p id="2a26" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查一下:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="efec" class="lk ll iq la b gy lm ln l lo lp">$ kubectl get pvc pvc-dynamic<br/>NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE<br/>pvc-dynamic Pending gp2 45s</span></pre><p id="baa1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好吧，但为什么它处于待定状态？检查其事件:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="38f3" class="lk ll iq la b gy lm ln l lo lp">$ kubectl describe pvc pvc-dynamic<br/>…<br/>Events:<br/>Type Reason Age From Message<br/> — — — — — — — — — — — — -<br/>Normal WaitForFirstConsumer 1s (x4 over 33s) persistentvolume-controller waiting for first consumer to be created before binding<br/>Mounted By: &lt;none&gt;</span></pre><h2 id="5f16" class="lk ll iq bd lr ng nh dn lv ni nj dp lz kj nk nl md kn nm nn mh kr no np ml nq bi translated"><code class="fe kx ky kz la b">WaitForFirstConsumer</code></h2><p id="1efc" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">让我们看看默认的<code class="fe kx ky kz la b">StorageClass</code>设置:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="c21e" class="lk ll iq la b gy lm ln l lo lp">$ kubectl describe sc gp2<br/>Name: gp2<br/>IsDefaultClass: Yes<br/>…<br/>Provisioner: kubernetes.io/aws-ebs<br/>Parameters: fsType=ext4,type=gp2<br/>…<br/>VolumeBindingMode: WaitForFirstConsumer<br/>Events: &lt;none&gt;</span></pre><p id="4de1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这里，<code class="fe kx ky kz la b"><a class="ae lb" href="https://kubernetes.io/docs/concepts/storage/storage-classes/#volume-binding-mode" rel="noopener ugc nofollow" target="_blank">VolumeBindingMode</a></code>定义了如何创建一个持久卷。使用<em class="kw"> Immediate </em>值，当请求者VPC出现时，将立即创建这样一个PV，但是使用<code class="fe kx ky kz la b"><em class="kw">WaitForFirstConsumer</em></code>值，如在本例中，Kubernetes将等待第一个消费者，如一个pod，它将请求此PV，然后根据该pod正在运行的WorkerNode的AvailbiltyZone，Kubernetes将创建一个新的PV和一个AWS EBS磁盘。</p><p id="2073" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们创建pod来消耗这些卷。</p><h1 id="8ee4" class="lq ll iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">在pod中使用PersistentVolumeClaim</h1><h2 id="d5f1" class="lk ll iq bd lr ng nh dn lv ni nj dp lz kj nk nl md kn nm nn mh kr no np ml nq bi translated">动态持续量声明</h2><p id="19c6" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">让我们描述一个将使用我们的动态PVC的pod:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="3c18" class="lk ll iq la b gy lm ln l lo lp">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  name: pv-dynamic-pod<br/>spec:<br/>  volumes:<br/>    - name: pv-dynamic-storage<br/>      persistentVolumeClaim:<br/>        claimName: pvc-dynamic<br/>  containers:<br/>    - name: pv-dynamic-container<br/>      image: nginx<br/>      ports:<br/>        - containerPort: 80<br/>          name: "nginx"<br/>      volumeMounts:<br/>        - mountPath: "/usr/share/nginx/html"<br/>          name: pv-dynamic-storage</span></pre><p id="3a85" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里:</p><ul class=""><li id="b479" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated"><code class="fe kx ky kz la b">volumes</code>:</li><li id="e5a8" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated"><code class="fe kx ky kz la b">persistentVolumeClaim</code>:</li><li id="16ac" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated"><code class="fe kx ky kz la b">claimName</code>:创建pod时需要的PVC名称</li><li id="60cb" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated"><code class="fe kx ky kz la b">containers</code>:</li><li id="d620" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated"><code class="fe kx ky kz la b">volumeMounts</code>:将<em class="kw"> pv-dynamic-storage </em>卷挂载到pod中的<code class="fe kx ky kz la b">/usr/share/nginx/html</code>目录</li></ul><p id="8633" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建它:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="144c" class="lk ll iq la b gy lm ln l lo lp">$ kubectl apply -f pv-pods.yaml<br/>pod/pv-dynamic-pod created</span></pre><p id="a4be" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">再次检查我们的PVC:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="d0e7" class="lk ll iq la b gy lm ln l lo lp">$ kubectl get pvc pvc-dynamic<br/>NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE<br/>pvc-dynamic Bound pvc-6d024b40-a239–4c35–8694-f060bd117053 5Gi RWO gp2 21h</span></pre><p id="fa3d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们可以看到一个ID为<em class="kw">PVC-6d 024 b 40-a239–4c 35–8694-f 060 BD 117053</em>的新卷—检查一下:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="d032" class="lk ll iq la b gy lm ln l lo lp">$ kubectl describe pvc pvc-dynamic<br/>Name: pvc-dynamic<br/>Namespace: default<br/>StorageClass: gp2<br/>Status: Bound<br/>Volume: pvc-6d024b40-a239–4c35–8694-f060bd117053<br/>…<br/>Finalizers: [kubernetes.io/pvc-protection]<br/>Capacity: 5Gi<br/>Access Modes: RWO<br/>VolumeMode: Filesystem<br/>Events: &lt;none&gt;<br/>Mounted By: pv-dynamic-pod</span></pre><p id="e306" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查音量:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="f01e" class="lk ll iq la b gy lm ln l lo lp">$ kubectl describe pv pvc-6d024b40-a239–4c35–8694-f060bd117053<br/>Name: pvc-6d024b40-a239–4c35–8694-f060bd117053<br/>…<br/>StorageClass: gp2<br/>Status: Bound<br/>Claim: default/pvc-dynamic<br/>Reclaim Policy: Delete<br/>Access Modes: RWO<br/>VolumeMode: Filesystem<br/>Capacity: 5Gi<br/>Node Affinity:<br/>Required Terms:<br/>Term 0: failure-domain.beta.kubernetes.io/zone in [us-east-2b]<br/>failure-domain.beta.kubernetes.io/region in [us-east-2]<br/>Message:<br/>Source:<br/>Type: AWSElasticBlockStore (a Persistent Disk resource in AWS)<br/>VolumeID: aws://us-east-2b/vol-040a5e004876f1a40<br/>FSType: ext4<br/>Partition: 0<br/>ReadOnly: false<br/>Events: &lt;none&gt;</span></pre><p id="5920" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以及AWS EBS<em class="kw">vol-040 a5e 004876 f1 a40</em>:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="576a" class="lk ll iq la b gy lm ln l lo lp">$ aws ec2 — profile arseniy — region us-east-2 describe-volumes — volume-ids vol-040a5e004876f1a40 — output json<br/>{<br/>“Volumes”: [<br/>{<br/>“Attachments”: [<br/>{<br/>“AttachTime”: “2020–07–30T11:08:29.000Z”,<br/>“Device”: “/dev/xvdcy”,<br/>“InstanceId”: “i-0a3225e9fe7cb7629”,<br/>“State”: “attached”,<br/>“VolumeId”: “vol-040a5e004876f1a40”,<br/>“DeleteOnTermination”: false<br/>}<br/>],<br/>…</span></pre><p id="3d54" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查吊舱内部:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="e111" class="lk ll iq la b gy lm ln l lo lp">$ kk exec -ti pv-dynamic-pod bash<br/>root@pv-dynamic-pod:/# lsblk<br/>NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT<br/>nvme0n1 259:0 0 50G 0 disk<br/>|-nvme0n1p1 259:1 0 50G 0 part /etc/hosts<br/>`-nvme0n1p128 259:2 0 1M 0 part<br/>nvme1n1 259:3 0 5G 0 disk /usr/share/nginx/html</span></pre><p id="a5ef" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw">nvme 1n 1</em>——这是我们的分区。</p><p id="948b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们写一些数据:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="7e93" class="lk ll iq la b gy lm ln l lo lp">root@pv-dynamic-pod:/# echo Test &gt; /usr/share/nginx/html/index.html</span></pre><p id="0414" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">放下吊舱:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="24b4" class="lk ll iq la b gy lm ln l lo lp">$ kk delete pod pv-dynamic-pod<br/>pod “pv-dynamic-pod” deleted</span></pre><p id="c3c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">重新创建它:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="9e9c" class="lk ll iq la b gy lm ln l lo lp">$ kubectl apply -f pv-pods.yaml<br/>pod/pv-dynamic-pod created</span></pre><p id="a1fb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查数据:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="2947" class="lk ll iq la b gy lm ln l lo lp">$ kk exec -ti pv-dynamic-pod cat /usr/share/nginx/html/index.html<br/>Test</span></pre><p id="8c34" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一切都还在原处。</p><h2 id="1186" class="lk ll iq bd lr ng nh dn lv ni nj dp lz kj nk nl md kn nm nn mh kr no np ml nq bi translated">静态PersistentVolumeClaim</h2><p id="61cb" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">现在，让我们尝试使用我们静态创建的PV。</p><p id="8250" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以使用同一个清单——<code class="fe kx ky kz la b">pv-static.yaml</code>:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="cfc5" class="lk ll iq la b gy lm ln l lo lp">apiVersion: v1<br/>kind: PersistentVolume<br/>metadata:<br/>  name: pv-static<br/>spec:<br/>  capacity:<br/>    storage: 5Gi<br/>  accessModes:<br/>    - ReadWriteOnce<br/>  storageClassName: gp2<br/>  awsElasticBlockStore:<br/>    fsType: ext4<br/>    volumeID: vol-0928650905a2491e2</span></pre><p id="8a3a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们使用PVC的<code class="fe kx ky kz la b">pvc-static.yaml</code>清单:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="9832" class="lk ll iq la b gy lm ln l lo lp">kind: PersistentVolumeClaim<br/>apiVersion: v1<br/>metadata:<br/>  name: pvc-static<br/>spec:<br/>  accessModes:<br/>    - ReadWriteOnce<br/>  resources:<br/>    requests:<br/>      storage: 5Gi<br/>  volumeName: pv-static</span></pre><p id="057c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建PV:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="f8a4" class="lk ll iq la b gy lm ln l lo lp">$ kk apply -f pv-static.yaml<br/>persistentvolume/pv-static created</span></pre><p id="66d7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查一下:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="4fd2" class="lk ll iq la b gy lm ln l lo lp">$ kk get pv<br/>NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE<br/>pv-static 5Gi RWO Retain Available gp2 58s<br/>…</span></pre><p id="04c5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建PVC:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="4c03" class="lk ll iq la b gy lm ln l lo lp">$ kk apply -f pvc-static.yaml<br/>persistentvolumeclaim/pvc-static created</span></pre><p id="56ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查一下:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="912a" class="lk ll iq la b gy lm ln l lo lp">$ kk get pvc pvc-static<br/>NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE<br/>pvc-static Bound pv-static 5Gi RWO gp2 9s</span></pre><p id="0058" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw">状态绑定</em>表示PVC能够找到其PV并成功连接。</p><h2 id="0cba" class="lk ll iq bd lr ng nh dn lv ni nj dp lz kj nk nl md kn nm nn mh kr no np ml nq bi translated">Pod <code class="fe kx ky kz la b">nodeAffinity</code></h2><p id="0ee3" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">接下来，我们需要确定一个AWS可用性区域，在该区域中我们为静态PV创建了AWS EBS:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="a643" class="lk ll iq la b gy lm ln l lo lp">$ aws ec2 — profile arseniy — region us-east-2 describe-volumes — volume-ids vol-0928650905a2491e2 — query '[Volumes[*].AvailabilityZone]' — output text<br/>us-east-2a</span></pre><p id="8606" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw"> us-east-2a </em> —好的，那么我们需要在同一个AvailabilityZone中的Kubernetes Worker节点上创建一个pod。</p><p id="cedb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建清单:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="e594" class="lk ll iq la b gy lm ln l lo lp">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  name: pv-static-pod<br/>spec:<br/>  affinity:<br/>    nodeAffinity:<br/>      requiredDuringSchedulingIgnoredDuringExecution:<br/>        nodeSelectorTerms:<br/>        - matchExpressions:<br/>          - key: failure-domain.beta.kubernetes.io/zone<br/>            operator: In<br/>            values:<br/>            - us-east-2a<br/>  volumes:<br/>    - name: pv-static-storage<br/>      persistentVolumeClaim:<br/>        claimName: pvc-static<br/>  containers:<br/>    - name: pv-static-container<br/>      image: nginx<br/>      ports:<br/>        - containerPort: 80<br/>          name: "nginx"<br/>      volumeMounts:<br/>        - mountPath: "/usr/share/nginx/html"<br/>          name: pv-static-storage</span></pre><p id="d323" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">与动态PVC相反，这里我们使用了<code class="fe kx ky kz la b">nodeAffinity</code>来指定我们想要使用来自<em class="kw"> s-east-2a </em> AZ的节点。</p><p id="c727" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建pod:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="91f3" class="lk ll iq la b gy lm ln l lo lp">$ kk apply -f pv-pod-stat.yaml<br/>pod/pv-static-pod created</span></pre><p id="9fcf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查事件:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="419f" class="lk ll iq la b gy lm ln l lo lp">0s Normal Scheduled Pod Successfully assigned default/pv-static-pod to ip-10–3–47–58.us-east-2.compute.internal<br/>0s Normal SuccessfulAttachVolume Pod AttachVolume.Attach succeeded for volume “pv-static”<br/>0s Normal Pulling Pod Pulling image “nginx”<br/>0s Normal Pulled Pod Successfully pulled image “nginx”<br/>0s Normal Created Pod Created container pv-static-container<br/>0s Normal Started Pod Started container pv-static-container</span></pre><p id="35d6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">pod中的分区:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="fb3e" class="lk ll iq la b gy lm ln l lo lp">$ kk exec -ti pv-static-pod bash<br/>root@pv-static-pod:/# lsblk<br/>NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT<br/>nvme0n1 259:0 0 50G 0 disk<br/>|-nvme0n1p1 259:1 0 50G 0 part /etc/hosts<br/>`-nvme0n1p128 259:2 0 1M 0 part<br/>nvme1n1 259:3 0 50G 0 disk /usr/share/nginx/html</span></pre><p id="077f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw"> nvme1n1 </em>已安装，所有工作正常。</p><h2 id="e997" class="lk ll iq bd lr ng nh dn lv ni nj dp lz kj nk nl md kn nm nn mh kr no np ml nq bi translated">持久卷<code class="fe kx ky kz la b">nodeAffinity</code></h2><p id="1453" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">另一个选择是与t相对的T2。</p><p id="7d57" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在创建将使用该PV的单元时，Kubernetes首先会检查哪些工作节点可用于连接该卷，然后在这样的节点上创建单元。</p><p id="c6a9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在pod的清单中删除<code class="fe kx ky kz la b">nodeAffinity</code>:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="d705" class="lk ll iq la b gy lm ln l lo lp">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  name: pv-static-pod<br/>spec:<br/>  volumes:<br/>    - name: pv-static-storage<br/>      persistentVolumeClaim:<br/>        claimName: pvc-static<br/>  containers:<br/>    - name: pv-static-container<br/>      image: nginx<br/>      ports:<br/>        - containerPort: 80<br/>          name: "nginx"<br/>      volumeMounts:<br/>        - mountPath: "/usr/share/nginx/html"<br/>          name: pv-static-storage</span></pre><p id="f004" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并添加到PV的清单中:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="17e3" class="lk ll iq la b gy lm ln l lo lp">apiVersion: v1<br/>kind: PersistentVolume<br/>metadata:<br/>  name: pv-static<br/>spec:<br/>  nodeAffinity:<br/>    required:<br/>      nodeSelectorTerms:<br/>      - matchExpressions:<br/>        - key: failure-domain.beta.kubernetes.io/zone<br/>          operator: In<br/>          values:<br/>          - us-east-2a    <br/>  capacity:<br/>    storage: 50Gi<br/>  accessModes:<br/>    - ReadWriteOnce<br/>  storageClassName: gp2<br/>  awsElasticBlockStore:<br/>    fsType: ext4<br/>    volumeID: vol-0928650905a2491e2</span></pre><p id="37cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建此PV:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="c9ec" class="lk ll iq la b gy lm ln l lo lp">$ kk apply -f pv-static.yaml<br/>persistentvolume/pv-static created</span></pre><p id="9126" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建它的PVC —这里没有任何改变:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="aabe" class="lk ll iq la b gy lm ln l lo lp">$ kk apply -f pvc-static.yaml<br/>persistentvolumeclaim/pvc-static created</span></pre><p id="f26c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建pod:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="744b" class="lk ll iq la b gy lm ln l lo lp">$ kk apply -f pv-pod-stat.yaml<br/>pod/pv-static-pod created</span></pre><p id="393c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查日志:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="4a06" class="lk ll iq la b gy lm ln l lo lp">0s Normal Scheduled Pod Successfully assigned default/pv-static-pod to ip-10–3–47–58.us-east-2.compute.internal<br/>0s Normal SuccessfulAttachVolume Pod AttachVolume.Attach succeeded for volume “pv-static”<br/>0s Normal Pulling Pod Pulling image “nginx”<br/>0s Normal Pulled Pod Successfully pulled image “nginx”<br/>0s Normal Created Pod Created container pv-static-container<br/>0s Normal Started Pod Started container pv-static-container</span></pre><h1 id="0a84" class="lq ll iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">删除PersistentVolume和PersistentVolumeClaim</h1><p id="f6ac" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">当用户想要删除当前由活动pod使用的PVC时，这样的PVC不会被立即删除，它将一直存在，直到相应的pod正在运行。</p><p id="223a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">类似地，当从持久卷声明中删除具有绑定的持久卷时，这样的PV将不会被删除，直到这样的绑定存在，例如直到其PVC存在。</p><h2 id="008d" class="lk ll iq bd lr ng nh dn lv ni nj dp lz kj nk nl md kn nm nn mh kr no np ml nq bi translated">改造</h2><p id="093c" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">这里的文档是<a class="ae lb" href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#reclaiming" rel="noopener ugc nofollow" target="_blank">&gt;&gt;&gt;</a>。</p><p id="fc46" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当我们想要完成PersistentVolume的工作时，我们可以从集群中删除它以释放相应的AWS EBS ( <em class="kw">回收</em>)。</p><p id="a954" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用于持久卷的<em class="kw">回收策略</em>向集群指定它与这种释放的卷有什么关系，并且可以具有<code class="fe kx ky kz la b">Retained</code>、<code class="fe kx ky kz la b">Recycled</code>或<code class="fe kx ky kz la b">Deleted</code>值。</p><h2 id="a2cb" class="lk ll iq bd lr ng nh dn lv ni nj dp lz kj nk nl md kn nm nn mh kr no np ml nq bi translated"><code class="fe kx ky kz la b">Retain</code></h2><p id="9d8d" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated"><code class="fe kx ky kz la b">Retain</code>策略允许我们手动清理磁盘。</p><p id="d192" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">删除相关的PersistentVolumeClaim后，PersistentVolume将不会被删除，并将被标记为“<em class="kw"> released </em>”，但它将可用于新的PersistentVolumeClaim，因为它仍保留以前的PersistentVolumeClaim中的一些数据。</p><p id="a6f9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要使其可供下次使用，您需要从群集中删除PersistentVolume对象。</p><h2 id="de7a" class="lk ll iq bd lr ng nh dn lv ni nj dp lz kj nk nl md kn nm nn mh kr no np ml nq bi translated"><code class="fe kx ky kz la b">Delete</code></h2><p id="6fe1" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">使用<code class="fe kx ky kz la b">Delete</code>值，当您删除一个PVC时，它将删除其对应的PersistentVolume和卷的设备，如AWS EBS、GCE PD或Azure Disk。</p><p id="551a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请记住，以动态方式创建的卷将从所使用的<code class="fe kx ky kz la b">StorageClass</code>继承策略，该策略默认设置为<code class="fe kx ky kz la b">Delete</code>。</p><h2 id="867d" class="lk ll iq bd lr ng nh dn lv ni nj dp lz kj nk nl md kn nm nn mh kr no np ml nq bi translated"><code class="fe kx ky kz la b">Recycle</code></h2><p id="c1d3" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">已弃用，用于通过常用<code class="fe kx ky kz la b">rm -rf</code>删除数据。</p><h2 id="75ed" class="lk ll iq bd lr ng nh dn lv ni nj dp lz kj nk nl md kn nm nn mh kr no np ml nq bi translated">删除PV和PVC —一个示例</h2><p id="9035" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">所以，我们有一个pod在运行:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="2021" class="lk ll iq la b gy lm ln l lo lp">$ kk get pod pv-static-pod<br/>NAME READY STATUS RESTARTS AGE<br/>pv-static-pod 1/1 Running 0 19s</span></pre><p id="4186" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用聚氯乙烯:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="3b07" class="lk ll iq la b gy lm ln l lo lp">$ kk get pvc pvc-static<br/>NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE<br/>pvc-static Bound pv-static 50Gi RWO gp2 19h</span></pre><p id="0bae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个PVC绑定到PV:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="5a98" class="lk ll iq la b gy lm ln l lo lp">$ kk get pv pv-static<br/>NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE<br/>pv-static 50Gi RWO Retain Bound default/pvc-static gp2 19h</span></pre><p id="7d9e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们的PV将其<code class="fe kx ky kz la b">RECLAIM POLICY</code>设置为<em class="kw">保留</em>——因此，在我们丢弃其PVC和PV后，所有数据都必须保留。</p><p id="db39" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们检查一下—添加一些数据:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="3567" class="lk ll iq la b gy lm ln l lo lp">$ kk exec -ti pv-static-pod bash<br/>root@pv-static-pod:/# echo Test &gt; /usr/share/nginx/html/test.txt<br/>root@pv-static-pod:/# cat /usr/share/nginx/html/test.txt<br/>Test</span></pre><p id="716e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">退出pod并删除它，然后删除它的PVC:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="eae3" class="lk ll iq la b gy lm ln l lo lp">$ kubectl delete pod pv-static-pod<br/>pod “pv-static-pod” deleted<br/>kubectl delete pvc pvc-static<br/>persistentvolumeclaim “pvc-static” deleted</span></pre><p id="26aa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查PV的状态:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="18e0" class="lk ll iq la b gy lm ln l lo lp">$ kubectl get pv<br/>NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE<br/>pv-static 50Gi RWO Retain Released default/pvc-static gp2 25s</span></pre><p id="606d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kx ky kz la b">STATUS</code> == <em class="kw">发布</em>，目前我们无法通过新的PVC重新连接该卷。</p><p id="77ed" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们检查一下—再次创建一个PVC:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="8796" class="lk ll iq la b gy lm ln l lo lp">$ kubectl apply -f pvc-static.yaml<br/>persistentvolumeclaim/pvc-static created</span></pre><p id="e2cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个pod:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="d380" class="lk ll iq la b gy lm ln l lo lp">$ kubectl apply -f pv-pod-stat.yaml<br/>pod/pv-static-pod created</span></pre><p id="59bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并检查其PVC状态:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="ec05" class="lk ll iq la b gy lm ln l lo lp">$ kubectl get pvc pvc-static<br/>NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE<br/>pvc-static Pending pv-static 0 gp2 59s</span></pre><p id="d055" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kx ky kz la b">STATUS</code>是<em class="kw">待定</em>。</p><p id="f61b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">删除pod、PVC，此时还要删除永久卷:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="db34" class="lk ll iq la b gy lm ln l lo lp">$ kubectl delete -f pv-pod-stat.yaml<br/>pod “pv-static-pod” deleted</span><span id="3cd4" class="lk ll iq la b gy nr ln l lo lp">$ kubectl delete -f pvc-static.yaml<br/>persistentvolumeclaim “pvc-static” deleted</span><span id="5d8e" class="lk ll iq la b gy nr ln l lo lp">$ kubectl delete -f pv-static.yaml<br/>persistentvolume “pv-static” deleted</span></pre><p id="d72b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从头再来:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="c33f" class="lk ll iq la b gy lm ln l lo lp">$ kubectl apply -f pv-static.yaml<br/>persistentvolume/pv-static created</span><span id="e259" class="lk ll iq la b gy nr ln l lo lp">$ kubectl apply -f pvc-static.yaml<br/>persistentvolumeclaim/pvc-static created</span><span id="4e19" class="lk ll iq la b gy nr ln l lo lp">$ kubectl apply -f pv-pod-stat.yaml<br/>pod/pv-static-pod created</span></pre><p id="6a81" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查PVC:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="8ab0" class="lk ll iq la b gy lm ln l lo lp">$ kubectl get pvc pvc-static<br/>NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE<br/>pvc-static Bound pv-static 50Gi RWO gp2 27s</span></pre><p id="5ee8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并检查我们之前添加的数据:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="6385" class="lk ll iq la b gy lm ln l lo lp">$ kubectl exec -ti pv-static-pod cat /usr/share/nginx/html/test.txt<br/>Test</span></pre><p id="5b57" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一切正常—数据仍在原处。</p><h2 id="d424" class="lk ll iq bd lr ng nh dn lv ni nj dp lz kj nk nl md kn nm nn mh kr no np ml nq bi translated">更改永久卷的回收策略</h2><p id="0b86" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">这里的文档是<a class="ae lb" href="https://kubernetes.io/docs/tasks/administer-cluster/change-pv-reclaim-policy/" rel="noopener ugc nofollow" target="_blank">&gt;&gt;&gt;</a>。</p><p id="fe70" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">目前，我们的PV具有<code class="fe kx ky kz la b">Retain</code>值:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="50e5" class="lk ll iq la b gy lm ln l lo lp">$ kubectl get pv pv-static -o jsonpath=’{.spec.persistentVolumeReclaimPolicy}’<br/>Retain</span></pre><p id="d9af" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">应用补丁—将其<code class="fe kx ky kz la b">persistentVolumeReclaimPolicy</code>参数更新为<code class="fe kx ky kz la b">Delete</code>值:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="9afb" class="lk ll iq la b gy lm ln l lo lp">$ kubectl patch pv pv-static -p ‘{“spec”:{“persistentVolumeReclaimPolicy”:”Delete”}}’<br/>persistentvolume/pv-static patched</span></pre><p id="e6e1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查一下:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="cb11" class="lk ll iq la b gy lm ln l lo lp">$ kubectl get pv pv-static -o jsonpath=’{.spec.persistentVolumeReclaimPolicy}’<br/>Delete</span></pre><p id="7c7b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">删除pod及其PVC:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="5a74" class="lk ll iq la b gy lm ln l lo lp">$ kubectl delete -f pv-pod-stat.yaml<br/>pod “pv-static-pod” deleted</span><span id="ef9b" class="lk ll iq la b gy nr ln l lo lp">$ kubectl delete -f pvc-static.yaml<br/>persistentvolumeclaim “pvc-static” deleted</span></pre><p id="b506" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查持久卷:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="75c7" class="lk ll iq la b gy lm ln l lo lp">$ kubectl get pv pv-static<br/>Error from server (NotFound): persistentvolumes “pv-static” not found</span></pre><p id="d8fe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以及用于本次PV的AWS EBS:</p><pre class="lc ld le lf gt lg la lh li aw lj bi"><span id="df5f" class="lk ll iq la b gy lm ln l lo lp">$ aws ec2 --profile arseniy --region us-east-2 describe-volumes --volume-ids vol-0928650905a2491e2</span></pre><p id="79af" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">出现错误(无效卷。NotFound)调用DescribeVolumes操作时:卷“vol-0928650905a2491e2”不存在。</p><p id="edf1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">其实就这些了。</p><h1 id="ccd5" class="lq ll iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">有用的链接</h1><ul class=""><li id="f1c1" class="ms mt iq ka b kb mn kf mo kj ns kn nt kr nu kv mx my mz na bi translated"><a class="ae lb" href="https://kubernetes.io/blog/2018/10/11/topology-aware-volume-provisioning-in-kubernetes/" rel="noopener ugc nofollow" target="_blank">Kubernetes中支持拓扑感知的卷供应</a></li><li id="d35d" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated"><a class="ae lb" href="https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/preexisting-pd" rel="noopener ugc nofollow" target="_blank">使用预先存在的永久磁盘作为永久卷</a></li><li id="e29e" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated"><a class="ae lb" href="https://cloud.google.com/kubernetes-engine/docs/concepts/persistent-volumes" rel="noopener ugc nofollow" target="_blank">具有永久磁盘的永久卷</a></li><li id="7998" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated"><a class="ae lb" href="https://cloud.netapp.com/blog/kubernetes-persistent-storage-why-where-and-how" rel="noopener ugc nofollow" target="_blank"> Kubernetes持久存储:原因、地点和方式</a></li><li id="a89a" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated"><a class="ae lb" href="https://blog.couchbase.com/stateful-containers-kubernetes-amazon-ebs/" rel="noopener ugc nofollow" target="_blank">Kubernetes上使用持久卷和Amazon EBS的有状态容器</a></li></ul></div><div class="ab cl nv nw hu nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="ij ik il im in"><p id="21f6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw">最初发布于</em> <a class="ae lb" href="https://rtfm.co.ua/en/kubernetes-persistentvolume-and-persistentvolumeclaim-an-overview-with-examples/" rel="noopener ugc nofollow" target="_blank"> <em class="kw"> RTFM: Linux、DevOps、系统管理</em> </a> <em class="kw">。</em></p></div></div>    
</body>
</html>