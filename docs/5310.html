<html>
<head>
<title>Golang — how to dynamically inject dependencies into the structure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">golang——如何向结构中动态注入依赖关系</h1>
<blockquote>原文：<a href="https://itnext.io/golang-runtime-service-options-dependencies-1c23b4ed95ae?source=collection_archive---------4-----------------------#2021-02-06">https://itnext.io/golang-runtime-service-options-dependencies-1c23b4ed95ae?source=collection_archive---------4-----------------------#2021-02-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/457046f44c35b6255981dd9858679f63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TVaB73J7oA37J_y3kEZ-qw.png"/></div></div></figure><p id="ea7e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如何在Go中动态地给“服务”注入依赖关系？</p><p id="dac8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该解决方案(方法)基于:</p><ol class=""><li id="e51c" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><code class="fe lf lg lh li b">variadic functions</code>(<a class="ae lj" href="https://yourbasic.org/golang/variadic-function/" rel="noopener ugc nofollow" target="_blank">)https://yourbasic.org/golang/variadic-function/</a>)和</li><li id="125a" class="kw kx iq ka b kb lk kf ll kj lm kn ln kr lo kv lb lc ld le bi translated"><code class="fe lf lg lh li b">self-referential functions</code>(<a class="ae lj" href="https://www.geeksforgeeks.org/self-referential-structures/" rel="noopener ugc nofollow" target="_blank">https://www.geeksforgeeks.org/self-referential-structures/</a>)。</li></ol><p id="e140" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">乍一看，这似乎有点混乱，但它实际上是一个简单的解决方案。<br/>这种方法可以用来初始化整个应用程序，并加载配置和其他服务。</p><p id="3987" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用<code class="fe lf lg lh li b">variadic function</code>:</p><pre class="lp lq lr ls gt lt li lu lv aw lw bi"><span id="6ad7" class="lx ly iq li b gy lz ma l mb mc">type Option func(*accs)</span><span id="c717" class="lx ly iq li b gy md ma l mb mc">func (f *accs) AddOptions(opts ...Option) {<br/>    for _, opt := range opts {<br/>        opt(f)<br/>    }<br/>}</span></pre><p id="7b2b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用<code class="fe lf lg lh li b">self-referential functions</code>:</p><pre class="lp lq lr ls gt lt li lu lv aw lw bi"><span id="bdab" class="lx ly iq li b gy lz ma l mb mc">func BindSubscriptions(v subscriptions.Client) Option {<br/>    return func(f *accs) {<br/>        f.srvSubscriptions = v<br/>    }<br/>}</span></pre><p id="8945" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，您应该创建主服务。在我们的片段中是<code class="fe lf lg lh li b">accounts</code>:</p><pre class="lp lq lr ls gt lt li lu lv aw lw bi"><span id="ed1c" class="lx ly iq li b gy lz ma l mb mc">accs := accounts.New()</span></pre><p id="f05f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">初始化第二个服务(它将是主服务的属性):</p><pre class="lp lq lr ls gt lt li lu lv aw lw bi"><span id="7d59" class="lx ly iq li b gy lz ma l mb mc">srvSubscriptions := subscriptions.New(111)</span></pre><p id="9e8d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">之后，您应该绑定第二个服务并为第一个服务设置属性:</p><pre class="lp lq lr ls gt lt li lu lv aw lw bi"><span id="e61b" class="lx ly iq li b gy lz ma l mb mc">sbs := accounts.BindSubscriptions(srvSubscriptions)<br/>accs.AddOptions(sbs)</span></pre><p id="822f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，我们处理业务逻辑(流程):</p><pre class="lp lq lr ls gt lt li lu lv aw lw bi"><span id="bc68" class="lx ly iq li b gy lz ma l mb mc">accs.Process(222)</span></pre><p id="a5c7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">同样，我们可以更改第二个服务中的任何属性(在我们的代码片段中是accounts或billing):set value = 222</p><p id="bc82" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，通过使用<code class="fe lf lg lh li b">variadic functions</code>，我们可以将一个或多个属性添加到第一个服务中:</p><pre class="lp lq lr ls gt lt li lu lv aw lw bi"><span id="4385" class="lx ly iq li b gy lz ma l mb mc">accs.AddOptions(sbs, bl)</span></pre><p id="c207" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者通过这种方式:</p><pre class="lp lq lr ls gt lt li lu lv aw lw bi"><span id="70cb" class="lx ly iq li b gy lz ma l mb mc">accs.AddOptions(sbs)<br/>accs.AddOptions(bl)</span></pre><p id="81c7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完整代码:</p><pre class="lp lq lr ls gt lt li lu lv aw lw bi"><span id="5f11" class="lx ly iq li b gy lz ma l mb mc">.<br/>├── cmd<br/>│   └── main.go<br/>├── pkg<br/>│   ├── accounts<br/>│   │   └── service.go<br/>│   ├── billing<br/>│   │   └── service.go<br/>│   └── subscriptions<br/>│       └── service.go<br/>└── README.md</span></pre><p id="2b09" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所有代码:</p><pre class="lp lq lr ls gt lt li lu lv aw lw bi"><span id="4b6f" class="lx ly iq li b gy lz ma l mb mc">package main</span><span id="0ed0" class="lx ly iq li b gy md ma l mb mc">import (<br/>    "github.com/yourUserName/projectName/pkg/billing"<br/>    "github.com/yourUserName/projectName/pkg/subscriptions"<br/>    "github.com/yourUserName/projectName/pkg/accounts"<br/>    "fmt"<br/>)</span><span id="183e" class="lx ly iq li b gy md ma l mb mc">func main() {<br/>    fmt.Println("Variant_1:")<br/>    variant1()</span><span id="18dd" class="lx ly iq li b gy md ma l mb mc">    fmt.Println("Variant_2:")<br/>    variant2()</span><span id="9ffe" class="lx ly iq li b gy md ma l mb mc">    fmt.Println("Variant_3:")<br/>    variant3()<br/>}<br/></span><span id="6bc5" class="lx ly iq li b gy md ma l mb mc">func variant1() {<br/>    accs := accounts.New()<br/>    srvAccounts := subscriptions.New(111)<br/>    sbs := accounts.BindSubscriptions(srvAccounts)    accs.AddOptions(sbs)<br/>    accs.Process(222)<br/>}</span><span id="9bb7" class="lx ly iq li b gy md ma l mb mc">func variant2() {<br/>    accs := accounts.New()</span><span id="7c42" class="lx ly iq li b gy md ma l mb mc">    srvAccounts := subscriptions.New(333)<br/>    srvBilling := billing.New()</span><span id="4a36" class="lx ly iq li b gy md ma l mb mc">    sbs := accounts.BindSubscriptions(srvAccounts)<br/>    bl := accounts.BindBilling(srvBilling)</span><span id="3415" class="lx ly iq li b gy md ma l mb mc">    accs.AddOptions(sbs, bl)</span><span id="0ce0" class="lx ly iq li b gy md ma l mb mc">    accs.Process(444)<br/>}</span><span id="f0b1" class="lx ly iq li b gy md ma l mb mc">func variant3() {<br/>    accs := accounts.New()</span><span id="e159" class="lx ly iq li b gy md ma l mb mc">    srvAccounts := subscriptions.New(555)<br/>    srvBilling := billing.New()</span><span id="652a" class="lx ly iq li b gy md ma l mb mc">    sbs := accounts.BindSubscriptions(srvAccounts)<br/>    bl := accounts.BindBilling(srvBilling)</span><span id="ba06" class="lx ly iq li b gy md ma l mb mc">    accs.AddOptions(sbs)<br/>    accs.AddOptions(bl)</span><span id="6219" class="lx ly iq li b gy md ma l mb mc">    accs.Process(777)<br/>}</span></pre><p id="ed1a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">输出结果:</p><pre class="lp lq lr ls gt lt li lu lv aw lw bi"><span id="73f7" class="lx ly iq li b gy lz ma l mb mc">Variant_1:<br/>        a.Prop (before): 111<br/>        a.Prop (after): 222</span><span id="3f02" class="lx ly iq li b gy md ma l mb mc">Variant_2:<br/>        a.Prop (before): 333<br/>        a.Prop (after): 444</span><span id="0cba" class="lx ly iq li b gy md ma l mb mc">Variant_3:<br/>        a.Prop (before): 555<br/>        a.Prop (after): 777</span></pre></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><p id="8107" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">来源回购:<a class="ae lj" href="https://github.com/romanitalian/go-service-options" rel="noopener ugc nofollow" target="_blank">https://github.com/romanitalian/go-service-options</a></p><p id="a92e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">公关是受欢迎的。</p></div></div>    
</body>
</html>