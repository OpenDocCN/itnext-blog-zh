<html>
<head>
<title>Manage Auto-generated Secrets In Your Helm Charts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">管理你的舵图中自动生成的秘密</h1>
<blockquote>原文：<a href="https://itnext.io/manage-auto-generated-secrets-in-your-helm-charts-5aee48ba6918?source=collection_archive---------1-----------------------#2021-09-26">https://itnext.io/manage-auto-generated-secrets-in-your-helm-charts-5aee48ba6918?source=collection_archive---------1-----------------------#2021-09-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/e35b4b8a5a877f6eff4b8239aa060cfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pB7lB7Fi74_-3cvq"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">埃里克·麦克林在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h1 id="2bca" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">为什么？</h1><p id="5111" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated"><a class="ae kc" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank"> Helm </a>允许您以模块化的方式打包您的Kubernetes应用程序，并根据用户的配置<a class="ae kc" href="https://helm.sh/docs/chart_template_guide/values_files/" rel="noopener ugc nofollow" target="_blank">“值文件”</a>应用不同的部署逻辑。在第一次部署时，我们通常需要生成随机密码(例如JWT /会话密码或随机密码)。我们可以选择让我们的舵图用户在舵图部署生命周期之外手动创建/管理这些秘密。但是如果舵图可以处理秘密自动生成的话就方便多了。然而，作为舵图部署的一部分，正确地自动生成和管理这些秘密并不容易。本文将讨论一些简单解决方案的潜在问题，并基于<a class="ae kc" href="https://helm.sh/docs/chart_template_guide/function_list/#lookup" rel="noopener ugc nofollow" target="_blank">头盔查找功能</a>提出一个更加灵活的解决方案。</p><h1 id="d022" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">用随机函数创造秘密</h1><p id="93fe" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">Helm提供了一系列<a class="ae kc" href="https://helm.sh/docs/chart_template_guide/function_list/#randalphanum-randalpha-randnumeric-and-randascii" rel="noopener ugc nofollow" target="_blank">随机字符串生成函数</a>，允许我们生成加密安全的随机字符串。一个简单的解决方案是使用randAlphaNum函数包含一个创建k8s secret对象的模板。</p><figure class="lz ma mb mc gt jr"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="70a4" class="pw-post-body-paragraph lb lc iq ld b le mf lg lh li mg lk ll lm mh lo lp lq mi ls lt lu mj lw lx ly ij bi translated">这个简单的解决方案看起来不错。但是当您以后尝试升级现有部署时会遇到麻烦，因为模板不知道集群中当前的机密数据，并且总是用新的随机值更新机密。</p><h1 id="d90e" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">有条件地创建秘密</h1><p id="bd32" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">更好的解决方案可能是检索现有的秘密数据，并且仅在秘密数据不存在时用新值创建秘密。</p><figure class="lz ma mb mc gt jr"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="6b97" class="pw-post-body-paragraph lb lc iq ld b le mf lg lh li mg lk ll lm mh lo lp lq mi ls lt lu mj lw lx ly ij bi translated">这里，我们不再总是将秘密数据设置为随机生成的值。相反，我们将尝试使用<a class="ae kc" href="https://helm.sh/docs/chart_template_guide/function_list/#lookup" rel="noopener ugc nofollow" target="_blank">查找函数</a>检索当前秘密值，并且仅在找不到现有秘密数据时将秘密数据设置为随机生成的值。</p><h1 id="17f2" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">设置掌舵资源策略</h1><p id="5b2a" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">我们现在有了一个解决方案，不仅可以用于初始部署，还可以用于后续升级。但是由于这个秘密是由Helm管理的，所以当你删除Helm部署时，它总是会被删除。这可能并不总是自动生成的秘密所期望的行为。</p><p id="f3fd" class="pw-post-body-paragraph lb lc iq ld b le mf lg lh li mg lk ll lm mh lo lp lq mi ls lt lu mj lw lx ly ij bi translated">对于helm管理的资源，通过<a class="ae kc" href="https://helm.sh/docs/howto/charts_tips_and_tricks/#tell-helm-not-to-uninstall-a-resource" rel="noopener ugc nofollow" target="_blank">` Helm . sh/resource-policy ` annotation</a>将资源策略设置为“保留”可以防止用户删除/卸载Helm部署时资源被删除。下面是一个使用资源策略注释在删除后保留我们的秘密资源的示例:</p><figure class="lz ma mb mc gt jr"><div class="bz fp l di"><div class="md me l"/></div></figure><h1 id="8580" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">允许用户提供的机密</h1><p id="3a51" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">尽管我们希望在大多数情况下自动生成密码，但我们可能仍然希望允许用户提供他们手动创建的密码，以使解决方案更加灵活。</p><p id="1e7e" class="pw-post-body-paragraph lb lc iq ld b le mf lg lh li mg lk ll lm mh lo lp lq mi ls lt lu mj lw lx ly ij bi translated">为了实现这一点，我们可以要求用户通过一个配置字段提供手动创建的秘密名称，例如<code class="fe mk ml mm mn b">.Values.manualSecretName</code>，并且仅在<code class="fe mk ml mm mn b">.Values.manualSecretName</code>为空时呈现我们自动生成的名称。</p><figure class="lz ma mb mc gt jr"><div class="bz fp l di"><div class="md me l"/></div></figure><h1 id="d1bc" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">关于查找函数的更多信息</h1><p id="3b29" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">Helm的<a class="ae kc" href="https://helm.sh/docs/chart_template_guide/function_list/#lookup" rel="noopener ugc nofollow" target="_blank">查找功能</a>是一个非常强大的工具，允许我们根据集群状态应用不同的部署逻辑。因为查找函数需要集群实时状态数据，所以请记住，当您执行以下操作时，它将始终返回空响应:</p><ul class=""><li id="c412" class="mo mp iq ld b le mf li mg lm mq lq mr lu ms ly mt mu mv mw bi translated">用<code class="fe mk ml mm mn b">helm template</code>运行你的图表</li><li id="5a6e" class="mo mp iq ld b le mx li my lm mz lq na lu nb ly mt mu mv mw bi translated">使用<code class="fe mk ml mm mn b">--dry-run</code>开关部署或升级您的图表</li></ul><h1 id="394a" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">结论</h1><p id="1a03" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">让你的头盔图在合适的地方自动为你的用户生成秘密会更方便。使用Helm的查找功能，我们可以检查集群的当前状态，以便以更加可靠和灵活的方式创建和管理Helm图表中的秘密。</p></div></div>    
</body>
</html>