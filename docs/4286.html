<html>
<head>
<title>Azure DevOps and React Native UI testing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure DevOps和React原生UI测试</h1>
<blockquote>原文：<a href="https://itnext.io/azure-devops-and-react-native-ui-testing-8144ba1a9eb?source=collection_archive---------2-----------------------#2020-05-30">https://itnext.io/azure-devops-and-react-native-ui-testing-8144ba1a9eb?source=collection_archive---------2-----------------------#2020-05-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/f92c3d7caa9d37e0f89b37565a1d7bc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C5Q-PkjHnA-FVKyCAySXHg.jpeg"/></div></div></figure><p id="7e23" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当今任何发展的一个关键组成部分是<a class="ae kz" href="https://docs.microsoft.com/en-us/azure/devops/learn/what-is-continuous-delivery" rel="noopener ugc nofollow" target="_blank">持续交付</a>:</p><blockquote class="la lb lc"><p id="704b" class="kb kc ld kd b ke kf kg kh ki kj kk kl le kn ko kp lf kr ks kt lg kv kw kx ky im bi translated">连续交付(CD)是从构建到生产环境的构建、测试、配置和部署过程</p></blockquote><p id="30f2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">本文描述了如何将UI测试作为CD过程的一部分与<a class="ae kz" href="https://azure.microsoft.com/en-us/services/devops/" rel="noopener ugc nofollow" target="_blank"> Azure DevOps </a>结合使用。Azure的好处是它可以用于任何项目。此外，在开源项目的情况下，微软在2018年宣布的免费计划看起来更有吸引力- <a class="ae kz" href="https://azure.microsoft.com/en-us/blog/announcing-azure-pipelines-with-unlimited-ci-cd-minutes-for-open-source/" rel="noopener ugc nofollow" target="_blank"> <em class="ld"> Azure Pipelines无限CI/CD分钟用于开源</em> </a>。</p><p id="43a3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您的React Native项目中还没有使用UI测试，最好查看React Native 文章中的<a class="ae kz" rel="noopener ugc nofollow" target="_blank" href="/pixels-matter-or-easy-ui-screenshot-testing-in-react-native-36c774cee3d1"> Pixels matter或easy UI screenshot testing，该文章介绍了UI快照的重要性以及如何开始使用它。</a></p><h1 id="51a0" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">入门指南</h1><p id="a4f9" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">将<a class="ae kz" href="https://github.com/rumax/react-native-PixelsCatcher" rel="noopener ugc nofollow" target="_blank"> PixelsCatcher </a>集成到<a class="ae kz" href="https://azure.microsoft.com/en-us/services/devops/" rel="noopener ugc nofollow" target="_blank"> Azure DevOps </a>中并自动化UI测试只需要几个步骤。要开始，您需要:</p><ul class=""><li id="fb95" class="mk ml it kd b ke kf ki kj km mm kq mn ku mo ky mp mq mr ms bi translated">集成了<a class="ae kz" href="https://github.com/rumax/react-native-PixelsCatcher" rel="noopener ugc nofollow" target="_blank">像素捕捉器</a>的工作项目</li><li id="6694" class="mk ml it kd b ke mt ki mu km mv kq mw ku mx ky mp mq mr ms bi translated"><a class="ae kz" href="https://azure.com" rel="noopener ugc nofollow" target="_blank"> Azure账户</a></li><li id="554c" class="mk ml it kd b ke mt ki mu km mv kq mw ku mx ky mp mq mr ms bi translated">azure如何工作以及什么是<a class="ae kz" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema?view=azure-devops&amp;tabs=schema%2Cparameter-schema" rel="noopener ugc nofollow" target="_blank"> YAML模式</a>的基本知识</li></ul><p id="9b65" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在是时候创建YAML模式并将其用于iOS UI快照了。</p><h1 id="5932" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">使用NodeJS并安装NPM依赖项</h1><p id="df57" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">Azure有一个预定义的任务，允许指定NodeJS版本:</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="ada7" class="nh li it nd b gy ni nj l nk nl">- task: NodeTool@0<br/>  displayName: 'Use Node <!-- -->12.x<!-- -->'<br/>  inputs:<br/>    versionSpec: '<!-- -->12.x<!-- -->'</span></pre><p id="f6f5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">以及运行脚本的可能性，这使得安装NPM依赖项成为可能:</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="d1ad" class="nh li it nd b gy ni nj l nk nl">- script: npm install<br/>  displayName: 'NPM Install'</span></pre><h1 id="e2fb" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">使用xCode</h1><p id="dec1" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">要编译项目并运行iOS模拟器，最好指定xCode版本，这可以在<code class="fe nm nn no nd b">xcode-select</code>工具的帮助下完成:</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="087f" class="nh li it nd b gy ni nj l nk nl">- script: sudo xcode-select --switch /Applications/Xcode_<!-- -->11.3.1<!-- -->.app/Contents/Developer displayName: 'Select xcode <!-- -->11.3<!-- -->'</span></pre><p id="12ab" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">或者使用runner提供的默认xCode。在这种情况下，在运行器升级后，您可能会得到一些错误，您将需要调整项目以使用xCode的新版本。</p><h1 id="aeb7" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">编译并运行</h1><p id="9061" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">Azure DevOps预定义了带有不同操作的任务，以便与xCode配合使用。另一种方法可能是使用命令行<code class="fe nm nn no nd b">xcrun xcodebuild</code>工具。我更喜欢第二种情况，因为它可以作为编译项目和运行测试的bash脚本来实现。这对于本地开发或者移植到另一个构建系统或者从另一个构建系统移植过来也很有用。实现是:</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="88b9" class="nh li it nd b gy ni nj l nk nl">- script: ./run_ios_debug.sh<br/>  displayName: 'Build and run UI tests'<br/>  workingDirectory: '$(Build.SourcesDirectory)'</span></pre><p id="7f15" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">其中<code class="fe nm nn no nd b">run_ios_debug.sh</code>是bash脚本可以是:</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="9460" class="nh li it nd b gy ni nj l nk nl">export FORCE_BUNDLING=1<br/>export RCT_NO_LAUNCH_PACKAGER=1</span><span id="a997" class="nh li it nd b gy np nj l nk nl">cd ios</span><span id="8433" class="nh li it nd b gy np nj l nk nl">xcrun xcodebuild \<br/>  -scheme demo \<br/>  -workspace demo.xcworkspace \<br/>  -configuration Debug \<br/>  -destination 'platform=iOS Simulator,name=iPhone 8 Plus,OS=13.3' \<br/>  -derivedDataPath $BUILD_PATH \<br/>  ENTRY_FILE="indexSnapshot.js" \<br/>  build</span><span id="2ef4" class="nh li it nd b gy np nj l nk nl">cd ..</span><span id="2194" class="nh li it nd b gy np nj l nk nl">./node_modules/.bin/pixels-catcher ios debug</span></pre><p id="2682" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">仅此而已。在这一步之后，UI快照与Azure DevOps集成，这就是运行UI测试所需的全部内容。</p><h1 id="1c38" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">发布测试结果</h1><p id="bbe3" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">Pixels Catcher生成JUnit测试报告，Azure Devops可以使用该报告来更好地概述测试。通过添加发布测试结果的任务:</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="8a91" class="nh li it nd b gy ni nj l nk nl">- task: PublishTestResults@2<br/>  condition: succeededOrFailed()<br/>  inputs:<br/>    testRunner: JUnit<br/>    testResultsFiles: '$(Build.SourcesDirectory)/junit.xml'</span></pre><p id="eadf" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您可以很容易地获得测试执行的细节:</p><figure class="my mz na nb gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nq"><img src="../Images/5fa73c536e908dbfeb2884fbf7d645eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1tvJPTcwzUr6QljYRS6wxQ.png"/></div></div></figure><h1 id="6be4" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">发布工件</h1><p id="6448" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">可以完成的最后一步是将结果发布到工件。如果一些测试失败，这是很方便的，可以准确地知道什么是错误的，以及组件/屏幕是如何呈现的。当然，检查日志并找到解释测试失败原因的错误消息是可能的:</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="b19a" class="nh li it nd b gy ni nj l nk nl">'WebViewTest' │ 'FAILED' │ 'Files mismatch with 87 pixels'</span></pre><p id="7bff" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">但是要确切知道发生了什么，需要一个实际的结果。幸运的是，在一个任务中上传实际结果、差异和参考图像很容易:</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="2655" class="nh li it nd b gy ni nj l nk nl">- publish: $(Build.SourcesDirectory)/snapshots/ios<br/>  condition: failed()<br/>  artifact: screenshots_ios<br/>  displayName: 'Test results'</span></pre><h1 id="433e" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">结论</h1><p id="45bb" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">YAML模式总共有30行代码，集成了<a class="ae kz" href="https://github.com/rumax/react-native-PixelsCatcher" rel="noopener ugc nofollow" target="_blank"> PixelsCatcher </a>和<a class="ae kz" href="https://azure.microsoft.com/en-us/services/devops/" rel="noopener ugc nofollow" target="_blank"> Azure DevOps </a>。但是从这一刻起，UI测试成为持续交付的一部分，使项目更加稳定，可预测，并允许在源代码发生任何变化后交付像素级完美的应用程序。</p><p id="8648" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">也可以用它Azure DevOps和Pixels Catcher搭配GitHub — <a class="ae kz" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/repos/github?view=azure-devops&amp;tabs=yaml" rel="noopener ugc nofollow" target="_blank">构建GitHub库</a>，这是<a class="ae kz" href="https://github.com/rumax/react-native-PixelsCatcher" rel="noopener ugc nofollow" target="_blank"> PixelsCatcher </a>本身的情况。你可以在一个<a class="ae kz" href="https://github.com/rumax/react-native-PixelsCatcher/tree/master/demo" rel="noopener ugc nofollow" target="_blank"> Pixels Catcher演示项目</a>中找到UI测试示例和Azure集成。</p><p id="638c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">感谢您的阅读，享受UI测试，为您的用户提供高质量的服务！</p></div></div>    
</body>
</html>