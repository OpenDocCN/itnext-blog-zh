<html>
<head>
<title>Barista — Enjoyable Espresso Android UI Tests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">咖啡师——愉快的Espresso Android UI测试</h1>
<blockquote>原文：<a href="https://itnext.io/barista-enjoyable-espresso-android-ui-tests-59d1620bd99c?source=collection_archive---------2-----------------------#2022-03-11">https://itnext.io/barista-enjoyable-espresso-android-ui-tests-59d1620bd99c?source=collection_archive---------2-----------------------#2022-03-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3a8a1294f15cde0d3e540154efebd140.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zjmEm7xPSCwDL2T6"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">咖啡师——提供美味浓缩咖啡的人</figcaption></figure><p id="7d4b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">咖啡师使开发UI测试更快、更容易、更可预测。它建立在Espresso之上，提供了一个简单明了的API，消除了常见Espresso任务的大部分样板文件和冗长。你和你的Android团队将毫不费力地编写测试。</p><p id="9d06" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Espresso对于UI测试来说是合理的，但是它有一些问题。代码冗长，API几乎不提供开箱即用的功能。大部分都需要定制。</p><h1 id="4f6a" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">咖啡师如何把事情简单化？</h1><p id="f092" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">首先，让我们看一个Expresso示例。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="bd95" class="mn lc iq mj b gy mo mp l mq mr">onView(withText("Button")).check(matches(isDisplayed()))<br/>onView(withId(R.id.button)).perform(click())</span></pre><p id="ab93" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这些例子非常<strong class="ke ir">冗长</strong>。做一些简单的事情需要很多代码。参数中有多个函数和参数。我们来观察一下咖啡师的替代方案。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="9132" class="mn lc iq mj b gy mo mp l mq mr">clickOn(R.id.button);<br/>assertDisplayed("Button");</span></pre><p id="81b2" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">代码直截了当，对于没有太多上下文的人来说，甚至对于非程序员来说，在更大的范围内更具可读性。</p><p id="2bff" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这些函数也可以与不同的参数一起使用，可以是字符串、视图id或字符串id。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="9449" class="mn lc iq mj b gy mo mp l mq mr">clickOn(R.id.button);<br/>clickOn(R.string.button_text);<br/>clickOn("Next");</span><span id="1431" class="mn lc iq mj b gy ms mp l mq mr">assertDisplayed("Hello world");<br/>assertDisplayed(R.string.hello_world);<br/>assertDisplayed(R.id.button);<br/>assertDisplayed(R.id.button, "Hello world")<br/>assertDisplayed(R.id.button, R.string.hello_world)</span></pre><h1 id="2889" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">复杂示例</h1><p id="dfa7" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">让我们来看一个完整的Espresso仪器测试。</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="409c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在咖啡师的选择是:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="eac8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">代码变得如此直观，以至于注释变得过时。<strong class="ke ir">代码成为文档。</strong></p><h1 id="e723" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">列出测试</h1><p id="9920" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">咖啡师很容易与列表互动。在Espresso上，这需要大量的代码，ListView和RecyclerView是有区别的，在Barista上，这两种方法是可以互换的。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="9d2d" class="mn lc iq mj b gy mo mp l mq mr">clickListItem(R.id.list, 4);<br/>clickListItemChild(R.id.list, 3, R.id.row_button);<br/>scrollListToPosition(R.id.list, 4);<br/>assertListItemCount(R.id.list, 5)<br/>assertListNotEmpty(R.id.list)<br/>assertDisplayedAtPosition(R.id.list, 0, "text");<br/>assertDisplayedAtPosition(R.id.list, 0, R.id.text_field, "text");<br/>assertDisplayedAtPosition(R.id.list, 0, R.string.hello_world);<br/>assertDisplayedAtPosition(R.id.list, 0, R.id.text_field, R.string.hello_world);<br/>assertCustomAssertionAtPosition(R.id.list, 0, customViewAssertion);<br/>clickSpinnerItem(R.id.spinner, 1);</span></pre><p id="edf7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在ScrollView中与Espresso交互需要滚动到每个视图，这不是很可靠。为了使测试更简单，咖啡师在与任何视图交互之前都会自动滚动，并且只在需要的时候才会这样做。</p><p id="e0a3" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Expresso也不能与<a class="ae la" href="https://stackoverflow.com/questions/35272953/espresso-scrolling-not-working-when-nestedscrollview-or-recyclerview-is-in-coor" rel="noopener ugc nofollow" target="_blank"> NestedScrollView </a>一起使用。</p><p id="161b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">当与ViewPager交互时，相同的视图可能在多个片段上。咖啡师只与展示的东西互动，所以可以避免AmbiguousViewMatcherException。</p><h1 id="f511" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">处理古怪的测试</h1><p id="bcf5" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">古怪的测试是一场噩梦。从测试环境的不同到视图没有在正确的时间出现，测试变得不可靠的原因有很多。咖啡师提供了一些注释来处理这个问题。</p><p id="9c68" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">测试需要确定性，但当一切都失败时，咖啡师会帮忙。注释允许定义测试运行的次数，如果通过了一次，就认为测试成功。</p><p id="77e0" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">可以使用<strong class="ke ir"> @Repeat </strong>注释，以便只有当所有执行都通过时，测试才通过。这对于测试的额外验证或者甚至是局部测试一个在持续集成中失败的不可靠的测试是有用的。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="123a" class="mn lc iq mj b gy mo mp l mq mr">// Use a RuleChain to wrap ActivityTestRule with a FlakyTestRule<br/>private ActivityTestRule&lt;FlakyActivity&gt; activityRule = new ActivityTestRule&lt;&gt;(FlakyActivity.class);<br/>private FlakyTestRule flakyRule = new FlakyTestRule();<br/><br/>@Rule<br/>public RuleChain chain = RuleChain.outerRule(flakyRule)<br/>    .around(activityRule);<br/><br/><br/>// Use @AllowFlaky to let flaky tests pass if they pass any time.<br/>@Test<br/>@AllowFlaky(attempts = 5)<br/>public void someFlakyTest() throws Exception {<br/>  // ...<br/>}<br/><br/>// Use @Repeat to avoid flaky tests from passing if any repetition fails.<br/>@Test<br/>@Repeat(times = 5)<br/>public void someImportantTest() throws Exception {<br/>  // ...<br/>}</span></pre></div><div class="ab cl mv mw hu mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ij ik il im in"><p id="5886" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">总之，Barista似乎是增加可读性和简化测试的一个很好的选择。因为它是建立在Espresso之上的，所以完全兼容，如果需要复杂的用例，Espresso仍然可以使用。咖啡师没有增加复杂性，因为它只是由直接调用Espresso的静态函数组成。用起来真的没什么风险。</p><p id="8c05" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">有关更多信息:</p><div class="nc nd gp gr ne nf"><a href="https://github.com/AdevintaSpain/Barista" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd ir gy z fp nk fr fs nl fu fw ip bi translated">GitHub-AdevintaSpain/咖啡师:提供优质浓缩咖啡的人</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">Barista使得开发UI测试更快、更容易、更可预测。建立在浓缩咖啡之上，它提供了一个简单的…</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">github.com</p></div></div><div class="no l"><div class="np l nq nr ns no nt jw nf"/></div></div></a></div><div class="nc nd gp gr ne nf"><a href="https://dev.to/adevintaspain/making-android-ui-testing-enjoyable-3a1n" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd ir gy z fp nk fr fs nl fu fw ip bi translated">让Android UI测试变得愉快</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">Android中的UI测试一直备受争议，原因有很多。测试很慢，因为它们必须在模拟器中运行…</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">开发到</p></div></div><div class="no l"><div class="nu l nq nr ns no nt jw nf"/></div></div></a></div></div></div>    
</body>
</html>