<html>
<head>
<title>Expose Open Policy Agent/Gatekeeper Constraint Violations for Kubernetes Applications with Prometheus and Grafana</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Prometheus和Grafana揭露Kubernetes应用程序违反开放策略代理/网关守护设备约束的情况</h1>
<blockquote>原文：<a href="https://itnext.io/expose-open-policy-agent-gatekeeper-constraint-violations-with-prometheus-and-grafana-6b7ac92ea07f?source=collection_archive---------1-----------------------#2021-06-16">https://itnext.io/expose-open-policy-agent-gatekeeper-constraint-violations-with-prometheus-and-grafana-6b7ac92ea07f?source=collection_archive---------1-----------------------#2021-06-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e1dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">TL；DR:在这篇博文中，我们讨论了一个解决方案，它给平台用户一个简洁的视图，显示使用Prometheus &amp; Grafana违反了哪些网守约束。</em></p><p id="f5de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae km" href="https://www.linkedin.com/in/andy-knapp-6a72b6108/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">安迪·纳普</strong> </a> <strong class="jp ir">和</strong> <a class="ae km" href="https://www.linkedin.com/in/muratcelep/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">穆拉特·塞莱普</strong> </a> <strong class="jp ir">曾在这篇博文中合作。</strong></p><p id="f9d2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">本文使用的文件/脚本可以在这里找到:</em><a class="ae km" href="https://github.com/mcelep/opa-scorecard" rel="noopener ugc nofollow" target="_blank"><em class="kl">https://github.com/mcelep/opa-scorecard</em></a></p><p id="6d05" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">刚开始使用Kubernetes的应用团队可能会觉得有点难，因为Kubernetes是一个安静复杂的大型生态系统(参见<a class="ae km" href="https://landscape.cncf.io/" rel="noopener ugc nofollow" target="_blank"> CNCF生态系统景观</a>)。此外，虽然Kubernetes开始成熟，但它仍在非常积极地开发中，并且它以比其他企业软件更快的速度不断获得新功能。最重要的是，Kubernetes平台部署到公司生态系统的其余部分(认证、授权、安全、网络、存储)是根据集成要求为每个公司量身定制的。因此，即使对于一个经验丰富的Kubernetes专家来说，在部署一个应用程序时，通常也要考虑很多事情，以满足安全性、弹性和性能需求。您如何确保运行在Kubernetes上的应用程序能够满足这些需求？</p><h2 id="289f" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">输入OPA/看门人</h2><p id="e58b" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated"><a class="ae km" href="https://www.openpolicyagent.org/" rel="noopener ugc nofollow" target="_blank">开放策略代理</a> (OPA)及其Kubernetes目标组件<a class="ae km" href="https://github.com/open-policy-agent/gatekeeper" rel="noopener ugc nofollow" target="_blank">看门人</a>为您提供了在Kubernetes集群上实施策略的方法。这里我们所说的策略，是您希望在贵公司的Kubernetes集群中看到的规则&amp;最佳实践&amp;行为的正式定义。当使用OPA时，你使用一种叫做<a class="ae km" href="https://www.openpolicyagent.org/docs/latest/policy-language/" rel="noopener ugc nofollow" target="_blank">减压阀</a>的领域特定语言来编写策略。这样，如果你试图在公司的内部wiki上用自由文本解释某项政策，你就不会有误解的空间。</p><p id="d15a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，在使用网关守护设备时，不同的策略可以有不同的执行操作。可能有某些政策被视为<strong class="jp ir">必须</strong>，而其他政策被视为<strong class="jp ir">必须</strong>。一个<strong class="jp ir">必须</strong>策略将阻止一个Kubernetes资源被接纳到一个集群中，而一个<strong class="jp ir">好到拥有</strong>策略只会导致平台用户应该注意的警告消息。</p><p id="e6c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇博文中，我们将讨论如何:</p><ul class=""><li id="2173" class="ll lm iq jp b jq jr ju jv jy ln kc lo kg lp kk lq lr ls lt bi translated">对K8S集群应用示例OPA策略，即所谓的网关守护设备约束</li><li id="4178" class="ll lm iq jp b jq lu ju lv jy lw kc lx kg ly kk lq lr ls lt bi translated">暴露违反关守约束的普罗米修斯度量</li><li id="027b" class="ll lm iq jp b jq lu ju lv jy lw kc lx kg ly kk lq lr ls lt bi translated">创建Grafana仪表板以显示有关违规的关键信息</li></ul><p id="dd1e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想了解更多关于在Kubernetes中执行政策的内容，请查看这篇文章。</p><h2 id="efd6" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">设计</h2><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi lz"><img src="../Images/2922d802b18b2d6966181bf694c81317.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cDz4plTn42lQEAZN.png"/></div></div></figure><p id="3aa6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们构建该系统的目的是为开发人员和平台用户提供有关OPA约束的见解，他们的应用程序可能会在给定的名称空间中违反这些约束。我们使用Grafana创建一个示例仪表板。Grafana从Prometheus获取创建仪表板所需的数据。我们已经编写了一个小的Go程序——在上图中描述为“违反约束的Prometheus Exporter”——来查询Kubernetes API是否违反约束，并以Prometheus格式公开数据。在我们的设置中，网关守护设备/OPA用于<a class="ae km" href="https://open-policy-agent.github.io/gatekeeper/website/docs/audit" rel="noopener ugc nofollow" target="_blank">审核</a>模式，我们不利用网关守护设备的功能来拒绝不符合策略预期的K8S资源。</p><h2 id="a1af" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">OPA约束</h2><p id="0f2f" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">每个公司对于在Kubernetes上运行的应用程序都有自己的一套要求。您可能听说过<em class="kl">生产就绪清单</em>的概念(简单地说，您希望在平台用户将应用程序部署到生产环境之前，为他们创建一个项目清单)。您希望拥有自己的基于减压阀的<em class="kl">生产准备清单</em>，以下链接可能会为您创建自己的清单提供一个良好的起点:</p><ul class=""><li id="5a6e" class="ll lm iq jp b jq jr ju jv jy ln kc lo kg lp kk lq lr ls lt bi translated"><a class="ae km" href="https://tanzu.vmware.com/developer/guides/kubernetes/app-enhancements-checklist/" rel="noopener ugc nofollow" target="_blank">Tanzu开发者中心应用就绪清单</a></li><li id="7796" class="ll lm iq jp b jq lu ju lv jy lw kc lx kg ly kk lq lr ls lt bi translated"><a class="ae km" href="https://learnk8s.io/production-best-practices" rel="noopener ugc nofollow" target="_blank">关于learnk8s.io的生产最佳实践</a></li><li id="e10d" class="ll lm iq jp b jq lu ju lv jy lw kc lx kg ly kk lq lr ls lt bi translated"><a class="ae km" href="https://www.replex.io/blog/kubernetes-in-production-readiness-checklist-and-best-practices" rel="noopener ugc nofollow" target="_blank">生产中的Kubernetes:关于replex.io的准备情况清单和最佳做法</a></li></ul><p id="1f75" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请记住，您将需要根据您的生产准备清单创建一个OPA策略，并且您可能无法使用OPA/减压阀涵盖清单中的所有问题。目标是关注基于Kubernetes资源定义容易提取的内容，例如K8S部署的副本数量。</p><p id="b564" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于我们的博文，我们将使用开源项目<a class="ae km" href="https://github.com/open-policy-agent/gatekeeper-library" rel="noopener ugc nofollow" target="_blank"> gatekeeper-library </a>，它包含了一组很好的示例约束。此外，项目结构在提供一个如何为你的公司管理OPA约束的例子的意义上是很有帮助的:用于创建OPA策略的减压阀语言应该进行彻底的单元测试，在<a class="ae km" href="https://github.com/open-policy-agent/gatekeeper-library/tree/master/src/general" rel="noopener ugc nofollow" target="_blank"> src文件夹</a>中，你可以找到纯Rego文件和单元测试。<a class="ae km" href="https://github.com/open-policy-agent/gatekeeper-library/tree/master/library/general" rel="noopener ugc nofollow" target="_blank">库文件夹</a>最终包含了从src文件夹中的rego文件创建的Gatekeeper约束模板。此外，每个模板都有一个示例约束，以及一些目标数据，这些数据会对约束产生积极和消极的结果。基于减压阀的策略可能会变得相当复杂，所以在我们看来，必须进行减压阀单元测试，涵盖愉快的和不愉快的路径。我们建议继续进行这个项目，并按照整个项目结构删除和添加代表贵公司需求的策略。使用这种方法，您可以实现代码的合规性，可以轻松地应用于各种环境。</p><p id="c630" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如前所述，可能有一些您不想直接实施的约束(必须或最好有):例如，在一个开发集群上，您可能不想实施<strong class="jp ir"> &gt; 1副本</strong>，或者在实施一个特定的约束之前，您可能想给平台用户足够的时间来采取必要的预防措施(而不是立即阻止他们的更改)。您可以使用<code class="fe ml mm mn mo b"><a class="ae km" href="https://open-policy-agent.github.io/gatekeeper/website/docs/violations#dry-run-enforcement-action" rel="noopener ugc nofollow" target="_blank">enforcementAction</a></code>来控制这种行为。默认情况下，<code class="fe ml mm mn mo b">enforcementAction</code>被设置为<code class="fe ml mm mn mo b">deny</code>，这就是我们所说的<strong class="jp ir">必须</strong>条件。在我们的例子中，我们将使用<code class="fe ml mm mn mo b">enforcementAction: dryrun</code>属性安装所有带有<strong class="jp ir">美好拥有</strong>条件的约束。这将确保我们不会直接影响K8S集群上运行的任何工作负载(对于这个场景，我们也可以使用<code class="fe ml mm mn mo b"><a class="ae km" href="https://open-policy-agent.github.io/gatekeeper/website/docs/violations#warn-enforcement-action" rel="noopener ugc nofollow" target="_blank">enforcementAction: warn</a></code>)。</p><h2 id="2b96" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">普罗米修斯出口商</h2><p id="1889" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">我们决定使用<a class="ae km" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank"> Prometheus </a>和<a class="ae km" href="https://grafana.com/" rel="noopener ugc nofollow" target="_blank"> Grafana </a>来收集约束违反度量并显示它们，因为这些都是很好且流行的开源工具。</p><p id="bb31" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了导出/发出普罗米修斯指标，我们用golang编写了一个小程序，使用了<a class="ae km" href="https://github.com/prometheus/client_golang" rel="noopener ugc nofollow" target="_blank">普罗米修斯Golang库</a>。这个程序使用Kubernetes API来发现应用于集群的所有约束，并导出某些指标。</p><p id="ca7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是一个衡量标准示例:</p><pre class="ma mb mc md gt mp mo mq mr aw ms bi"><span id="369e" class="kn ko iq mo b gy mt mu l mv mw">opa_scorecard_constraint_violations{kind="K8sAllowedRepos",name="repo-is-openpolicyagent",violating_kind="Pod",violating_name="utils",violating_namespace="default",violation_enforcement="dryrun",violation_msg="container &lt;utils&gt; has an invalid image repo &lt;mcelep/swiss-army-knife&gt;, allowed repos are [\"openpolicyagent\"]"} 1</span></pre><p id="2dad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">标签用于表示每个约束违反，我们稍后将在Grafana仪表板中使用这些标签。</p><p id="a8c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Prometheus exporter程序默认监听tcp端口<code class="fe ml mm mn mo b">9141</code>，并公开路径<code class="fe ml mm mn mo b">/metrics</code>上的度量。只要您的主文件夹中有一个有效的Kubernetes配置，它就可以在您的开发机器上本地运行(也就是说，如果您可以运行kubectl并且拥有正确的权限)。在集群上运行时，会传入一个<code class="fe ml mm mn mo b">incluster</code>参数，以便它知道在哪里查找集群凭证。导出程序每10秒钟连接到Kubernetes API，从Kubernetes API中抓取数据。</p><p id="2b99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们用<a class="ae km" href="https://medium.com/teamzerolabs/15-steps-to-write-an-application-prometheus-exporter-in-go-9746b4520e26" rel="noopener">这篇</a>博客文章作为代码的基础。</p><h2 id="f57e" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">演示</h2><p id="3731" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">让我们继续准备我们的组件，这样我们就有一个Grafana仪表板来显示违反了哪些约束，以及违反的数量是如何随时间变化的。</p><h2 id="ed6c" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">0)所需工具</h2><ul class=""><li id="8098" class="ll lm iq jp b jq lg ju lh jy mx kc my kg mz kk lq lr ls lt bi translated"><a class="ae km" href="https://git-scm.com/downloads" rel="noopener ugc nofollow" target="_blank"> Git </a>:需要一个git cli来检查回购协议</li><li id="4c71" class="ll lm iq jp b jq lu ju lv jy lw kc lx kg ly kk lq lr ls lt bi translated"><a class="ae km" href="https://kubernetes.io/docs/tasks/tools/" rel="noopener ugc nofollow" target="_blank"> Kubectl </a>和一个工作中的K8S集群</li><li id="22a1" class="ll lm iq jp b jq lu ju lv jy lw kc lx kg ly kk lq lr ls lt bi translated">Ytt :这是一个非常强大的yaml模板工具，在我们的设置中，它用于动态覆盖所有约束中的键/值对。它类似于Kustomize，比Kustomize更灵活，在一些<a class="ae km" href="https://tanzu.vmware.com/tanzu" rel="noopener ugc nofollow" target="_blank"> Tanzu </a>产品中大量使用。</li><li id="ce65" class="ll lm iq jp b jq lu ju lv jy lw kc lx kg ly kk lq lr ls lt bi translated">Kustomize :看门人——图书馆依赖于Kustomize，所以我们也需要它。</li><li id="2874" class="ll lm iq jp b jq lu ju lv jy lw kc lx kg ly kk lq lr ls lt bi translated">头盔:我们将使用头盔安装普罗米修斯和格拉法纳</li><li id="2bd4" class="ll lm iq jp b jq lu ju lv jy lw kc lx kg ly kk lq lr ls lt bi translated">可选:<a class="ae km" href="https://www.docker.com/products/docker-desktop" rel="noopener ugc nofollow" target="_blank"> Docker </a> : Docker只是可选的，因为我们已经在dockerhub上发布了所需的图像。</li></ul><h2 id="b9a3" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">1) Git子模块更新</h2><p id="3633" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">运行<code class="fe ml mm mn mo b">git submodule update --init</code>下载网关守护设备-库依赖关系。该命令将把<a class="ae km" href="https://github.com/open-policy-agent/gatekeeper-library" rel="noopener ugc nofollow" target="_blank">网关守护设备库</a>的依赖性下载到文件夹<code class="fe ml mm mn mo b">gatekeeper-library/library</code>中。</p><h2 id="0d02" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">2)安装运算放大器/网守</h2><p id="c1c2" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">如果你的K8S集群没有预装网守，你可以按照这里的说明<a class="ae km" href="https://open-policy-agent.github.io/gatekeeper/website/docs/install/" rel="noopener ugc nofollow" target="_blank">安装它。如果您熟悉helm，最简单的安装方法如下:</a></p><pre class="ma mb mc md gt mp mo mq mr aw ms bi"><span id="0d42" class="kn ko iq mo b gy mt mu l mv mw">helm repo add gatekeeper https://open-policy-agent.github.io/gatekeeper/charts<br/>helm install gatekeeper/gatekeeper --generate-name</span></pre><p id="777e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们已经使用<a class="ae km" href="https://tanzu.vmware.com/mission-control" rel="noopener ugc nofollow" target="_blank">Tanzu Mission Control(TMC)</a>来供应Kubernetes测试集群，TMC为我们提供了一个开箱即用的带有网关守护设备的集群，我们无需自己安装网关守护设备。</p><h2 id="b1ee" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">3)安装网关守护设备示例约束</h2><p id="4ddc" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">脚本<a class="ae km" href="https://github.com/mcelep/opa-scorecard/blob/390957c2564a1b9bbe8733c21a7a43acd0581ca3/gatekeeper-library/apply_gatekeeper_constraints.sh" rel="noopener ugc nofollow" target="_blank">gate keeper-library/apply _ gate keeper _ constraints . sh</a>使用kustomize创建约束模板，然后在集群上应用它们。因此，请确保k8s cli配置了正确的上下文。之后<a class="ae km" href="https://carvel.dev/ytt/" rel="noopener ugc nofollow" target="_blank"> Ytt </a>用于注射<code class="fe ml mm mn mo b">spec.enforcementAction: dryrun</code>以进行<a class="ae km" href="https://open-policy-agent.github.io/gatekeeper/website/docs/violations/#dry-run-enforcement-action" rel="noopener ugc nofollow" target="_blank">干运转</a>的强制动作。</p><p id="887e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用以下命令运行脚本:</p><pre class="ma mb mc md gt mp mo mq mr aw ms bi"><span id="e857" class="kn ko iq mo b gy mt mu l mv mw">cd gatekeeper-library &amp;&amp; ./apply_gatekeeper_constraints.sh</span></pre><h2 id="9fa5" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">4)安装普罗米修斯导出器</h2><p id="f5b4" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">在文件夹<a class="ae km" href="https://github.com/mcelep/opa-scorecard/tree/master/exporter-go" rel="noopener ugc nofollow" target="_blank"> exporter-go </a>中，有以Prometheus数据格式导出约束违反信息的程序的源代码。同一个文件夹还包含一个名为<a class="ae km" href="https://github.com/mcelep/opa-scorecard/blob/390957c2564a1b9bbe8733c21a7a43acd0581ca3/exporter-go/build_docker.sh" rel="noopener ugc nofollow" target="_blank"> build_docker.sh </a>的脚本，它构建一个容器并将其推送到<a class="ae km" href="https://hub.docker.com/r/mcelep/opa_scorecard_exporter" rel="noopener ugc nofollow" target="_blank">MC elep/opa _ score card _ exporter</a>。容器图像已经公开了，所以你唯一需要做的就是应用文件夹<a class="ae km" href="https://github.com/mcelep/opa-scorecard/tree/master/exporter-k8s-resources" rel="noopener ugc nofollow" target="_blank"> exporter-k8s-resources </a>中的资源。我们为部署K8S资源选择的目标名称空间是<code class="fe ml mm mn mo b">opa-exporter</code>。我们想要创建的K8S资源具有以下功能:</p><ul class=""><li id="e639" class="ll lm iq jp b jq jr ju jv jy ln kc lo kg lp kk lq lr ls lt bi translated"><code class="fe ml mm mn mo b">clusterrole.yaml</code> &amp; <code class="fe ml mm mn mo b">clusterrolebinding.yaml</code> - &gt;这些资源创建一个集群角色来访问组<code class="fe ml mm mn mo b">constraints.gatekeeper.sh</code>的所有资源，并为该集群角色创建一个绑定</li><li id="184d" class="ll lm iq jp b jq lu ju lv jy lw kc lx kg ly kk lq lr ls lt bi translated"><code class="fe ml mm mn mo b">deployment.yaml</code> - &gt;将运行容器映像的部署<code class="fe ml mm mn mo b">mcelep/opa_scorecard_exporter</code></li><li id="ce85" class="ll lm iq jp b jq lu ju lv jy lw kc lx kg ly kk lq lr ls lt bi translated"><code class="fe ml mm mn mo b">service.yaml</code> - &gt;一个带有注释<code class="fe ml mm mn mo b">prometheus.io/scrape-slow: "true"</code>的服务，以确保该服务被Prometheus获取</li></ul><p id="be60" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要应用这些K8S资源:</p><pre class="ma mb mc md gt mp mo mq mr aw ms bi"><span id="6fab" class="kn ko iq mo b gy mt mu l mv mw">kubectl create namespace opa-exporter &amp;&amp; kubectl -n opa-exporter apply -f exporter-k8s-resources</span></pre><h2 id="b7f5" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">安装kube-prometheus-stack</h2><p id="9493" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">为了安装普罗米修斯&amp;格拉夫纳，我们将使用一个名为<a class="ae km" href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack" rel="noopener ugc nofollow" target="_blank">的舵图表。文件夹</a><a class="ae km" rel="noopener ugc nofollow" target="_blank" href="/kube-prometheus-stack"> kube-prometheus-stack </a>包含该步骤的相关文件。</p><p id="b594" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除了Prometheus和Grafana，我们还想安装一个定制的Grafana仪表板，显示关于约束违反的有用指标。文件<a class="ae km" href="https://github.com/mcelep/opa-scorecard/blob/master/kube-prometheus-stack/cm-custom-dashboard.yaml" rel="noopener ugc nofollow" target="_blank">kube-Prometheus-stack/cm-custom-dashboard . YAML</a>包含了我们想要安装的仪表板配置，注意这个文件中的标签<code class="fe ml mm mn mo b">grafana_dashboard: "1"</code>。此标签用作Grafana的指令，以将此ConfigurationMap的内容作为仪表板源。文件<a class="ae km" href="https://github.com/mcelep/opa-scorecard/blob/master/kube-prometheus-stack/grafana-opa-dashboard.json" rel="noopener ugc nofollow" target="_blank">grafana-opa-dashboard . json</a>是从Grafana导出的原始JSON，我们使用该文件的内容将其嵌入到键<code class="fe ml mm mn mo b">opa-dashboard.json</code>下的configmap中。</p><p id="6cc2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装脚本<a class="ae km" href="https://github.com/mcelep/opa-scorecard/blob/master/kube-prometheus-stack/install.sh" rel="noopener ugc nofollow" target="_blank">kube-prometheus-stack/install . sh</a>从文件<a class="ae km" href="https://github.com/mcelep/opa-scorecard/blob/master/kube-prometheus-stack/cm-custom-dashboard.yaml" rel="noopener ugc nofollow" target="_blank">cm-custom-dashboard . YAML</a>创建一个配置图，然后使用helm将kube-Prometheus-stack图表安装到名称空间<code class="fe ml mm mn mo b">prometheus</code>中。</p><p id="f49f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行以下命令安装Prometheus &amp; Grafana:</p><pre class="ma mb mc md gt mp mo mq mr aw ms bi"><span id="5bef" class="kn ko iq mo b gy mt mu l mv mw">cd kube-prometheus-stack &amp;&amp; ./install.sh</span></pre><p id="e0cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">过了一会儿，所有Prometheus组件和Grafana都应该启动并运行了。</p><h2 id="fd6b" class="kn ko iq bd kp kq kr dn ks kt ku dp kv jy kw kx ky kc kz la lb kg lc ld le lf bi translated">6)登录Grafana</h2><p id="9bb7" class="pw-post-body-paragraph jn jo iq jp b jq lg js jt ju lh jw jx jy li ka kb kc lj ke kf kg lk ki kj kk ij bi translated">我们还没有为我们的Grafana安装提供入口或服务<code class="fe ml mm mn mo b">type: LoadBalancer</code>,所以访问我们的Grafana仪表板的简单方法是使用kubectl的端口转发。</p><p id="95a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">执行以下命令启动到Grafana的端口转发会话:</p><pre class="ma mb mc md gt mp mo mq mr aw ms bi"><span id="59f3" class="kn ko iq mo b gy mt mu l mv mw">kubectl -n prometheus port-forward $(kubectl -n prometheus get pod -l app.kubernetes.io/name=grafana -o name |  cut -d/ -f2)  3000:3000</span></pre><p id="6b14" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你现在可以用你的浏览器点击下面的网址:<code class="fe ml mm mn mo b">http://localhost:3000</code>，你应该会看到一个类似下面截图的欢迎界面。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi na"><img src="../Images/6b5ee757e5848b36ff522b424b8d5f21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*FfcWu8lf9zhFcMMA.png"/></div></div></figure><p id="448f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">截至本文撰写时，Grafana的默认用户名/密码是<code class="fe ml mm mn mo b">admin / prom-operator</code>。如果这些凭据不起作用，您也可以通过以下命令发现它们:</p><pre class="ma mb mc md gt mp mo mq mr aw ms bi"><span id="d951" class="kn ko iq mo b gy mt mu l mv mw">kubectl -n prometheus get secrets prometheus-grafana -o jsonpath='{.data.admin-user}' | base64 -d<br/>kubectl -n prometheus get secrets prometheus-grafana -o jsonpath='{.data.admin-password}' | base64 -d</span></pre><p id="f2ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">登录Grafana后，您可以通过<a class="ae km" href="http://localhost:3000/d/YBgRZG6Mz/opa-violations?orgId=1" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/d/ybgrzg 6 mz/OPA-violations直接进入OPA Dasboard。orgId=1 </a>(或者通过此链接搜索OPA仪表板:<a class="ae km" href="http://localhost:3000/dashboards?query=opa" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/dashboards？query=opa </a>)。</p><p id="905d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是我们创建的Grafana OPA仪表板的屏幕截图:</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi nb"><img src="../Images/aa00eaaafef39842bda4cbd69afdbcac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CcsCs7Dnt4xxnZa5.png"/></div></div></figure><p id="193c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以从仪表板上部的下拉菜单中选择一个目标命名空间。我们让仪表板变得非常简单，显然你可以无限扩展，并通过向<a class="ae km" href="https://github.com/mcelep/opa-scorecard" rel="noopener ugc nofollow" target="_blank">这个回购</a>发出拉取请求来随意共享你的仪表板。</p></div></div>    
</body>
</html>