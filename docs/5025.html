<html>
<head>
<title>Logging in Kubernetes with Loki and the PLG Stack</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用洛基和PLG堆栈登录Kubernetes</h1>
<blockquote>原文：<a href="https://itnext.io/logging-in-kubernetes-with-loki-and-the-plg-stack-93b27c90ec34?source=collection_archive---------0-----------------------#2020-11-19">https://itnext.io/logging-in-kubernetes-with-loki-and-the-plg-stack-93b27c90ec34?source=collection_archive---------0-----------------------#2020-11-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="41fd" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Loki是Grafana实验室的一个新的日志聚合系统。它被设计成具有成本效益且易于操作。在本文中，您将了解更多关于Loki的知识，以及如何在Kubernetes中使用PLG堆栈(Promtail、Loki、Grafana)进行登录。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/0eeb433e8464c31ae094cecfecf65229.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ma6tno4nqc5y9lQTS3vUzg.jpeg"/></div></div></figure><h1 id="f9fb" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">洛基是什么？</h1><p id="0e51" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">Loki是一个开源的多租户日志聚合系统。它可以与Grafana和Promtrail一起使用来收集和访问日志，<a class="ae mi" href="https://grafana.com/docs/loki/latest/overview/comparisons/" rel="noopener ugc nofollow" target="_blank">类似于ELK/EFK栈</a>。虽然人们可以使用Kibana和Elasticsearch进行高级数据分析和可视化，但基于Loki的日志堆栈侧重于轻量级和易于操作。</p><p id="2450" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">Loki提供了一种叫做<a class="ae mi" href="https://grafana.com/docs/loki/latest/logql" rel="noopener ugc nofollow" target="_blank"> LogQL </a>的查询语言，允许用户查询日志。它的灵感来自Prometheus的PromQL，可以认为是一个聚合日志源的分布式“grep”。</p><p id="c443" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">与传统日志记录系统的一个主要区别是，Loki只索引元数据，而不是日志的全部内容。所以索引变小了，减少了内存消耗，最终降低了成本。这种设计的一个缺点是，查询的性能可能不如将所有内容都编入索引并加载到内存中。</p><p id="4311" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">日志直接存储在云存储中，如亚马逊S3或GCS，而无需将文件存储在磁盘上。这简化了操作，并避免了磁盘空间不足等问题。</p><h1 id="f09b" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">使用Loki的8个好处</h1><p id="c31d" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">以下是在您的堆栈中使用Loki的一些主要优势:</p><ol class=""><li id="ec7d" class="mo mp it lo b lp mj ls mk lv mq lz mr md ms mh mt mu mv mw bi translated">易于使用:设置简单，易于操作。</li><li id="c653" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh mt mu mv mw bi translated">轻量级:它只索引元数据，而不是像EFK那样索引完整的日志消息。这使得Loki部署所需的RAM实例更便宜。</li><li id="0c92" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh mt mu mv mw bi translated">云原生:它与其他云原生工具<a class="ae mi" href="https://codersociety.com/blog/articles/cloud-native-tools" rel="noopener ugc nofollow" target="_blank">如Kubernetes配合得很好，像Pod标签这样的元数据是自动抓取和索引的。</a></li><li id="4423" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh mt mu mv mw bi translated">使用对象存储:它使用像亚马逊S3或GCS这样的对象存储，这通常比使用块存储更便宜。</li><li id="481c" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh mt mu mv mw bi translated">水平扩展:它可以作为单个二进制文件在本地运行，或者用于小规模操作，并且可以很容易地水平扩展用于大规模操作。</li><li id="ea7d" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh mt mu mv mw bi translated">Quorum consistency:它使用Dynamo风格的<a class="ae mi" href="https://grafana.com/docs/loki/latest/architecture/#quorum-consistency" rel="noopener ugc nofollow" target="_blank"> quorum consistency </a>进行读写操作，以保证统一的查询结果。</li><li id="0610" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh mt mu mv mw bi translated">多租户支持:通过一个租户ID支持<a class="ae mi" href="https://grafana.com/docs/loki/latest/overview/#multi-tenancy" rel="noopener ugc nofollow" target="_blank">多租户</a>，这样租户的数据是分开存储的。</li><li id="b4ae" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh mt mu mv mw bi translated">原生Grafana支持:它在Grafana中有原生支持(需要Grafana v6.0)。</li></ol><h1 id="ed47" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">洛基的使用案例</h1><p id="27ae" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">既然我们已经讨论了Loki的好处，让我们也来看看一些<a class="ae mi" href="https://grafana.com/blog/2020/05/12/an-only-slightly-technical-introduction-to-loki-the-prometheus-inspired-open-source-logging-system/#key-log-analysis-use-cases" rel="noopener ugc nofollow" target="_blank">流行的用例</a>。</p><p id="355c" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated"><strong class="lo iu">调试和故障排除</strong> : Loki通过提供与手头问题相关的有用信息，帮助开发团队更快地找到问题的根源。例如，很容易看出问题何时出现、具体发生了什么以及问题是如何产生的。</p><p id="0c26" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated"><strong class="lo iu">监控</strong>:普罗米修斯在工业上广泛用于监控。但是，您可以通过使用Loki监控您的日志来识别许多问题。例如，您可以使用它来关注网站的错误率，并在超过某个阈值时收到警报。</p><p id="d46f" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated"><strong class="lo iu">网络安全</strong> : Loki允许您识别公司系统中的威胁、问题和恶意活动。此外，它还能帮助您在系统遭到破坏后了解攻击的详细信息。</p><p id="0a70" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated"><strong class="lo iu">合规性</strong>:当法规要求公司保留审计日志时，Loki是一个可靠且安全的选择。</p><p id="0f9a" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated"><strong class="lo iu">商业智能</strong> : Loki帮助非技术团队理解日志数据，并为业务增长开发新的策略和想法。例如，营销人员可以使用数据进行转化率优化:他们可以看到客户来自哪里，哪些营销渠道工作得最好，哪些渠道需要改进。</p><h1 id="411f" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">PLG堆栈(Promtail、Loki和Grafana)</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/3cf579b0cc34e90e81a60417d9a686e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mxMfjdUBR-RGzvwA.png"/></div></div></figure><ul class=""><li id="b1bc" class="mo mp it lo b lp mj ls mk lv mq lz mr md ms mh nd mu mv mw bi translated"><a class="ae mi" href="https://grafana.com/docs/loki/latest/clients/promtail/" rel="noopener ugc nofollow" target="_blank"> Promtail </a>是一个代理，需要安装在运行您的应用程序或服务的每个节点上。它检测目标(如本地日志文件)，将标签附加到来自pod的日志流，并将它们发送到Loki。</li><li id="8d31" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh nd mu mv mw bi translated">洛基是PLG堆栈的核心。它负责存储日志数据。</li><li id="2e29" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh nd mu mv mw bi translated"><a class="ae mi" href="https://grafana.com/grafana/" rel="noopener ugc nofollow" target="_blank"> Grafana </a>是一个开源可视化平台，处理来自Loki的时间序列数据，并使日志可以在web用户界面中访问。</li></ul><h1 id="036b" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">Kubernetes的PLG堆栈入门</h1><p id="3b75" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">让我们从一些实际操作开始使用Loki。在这个例子中，我们将使用Loki栈来可视化Grafana中Kubernetes API服务器的日志。</p><p id="60e1" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">在开始之前，确保您已经启动并运行了Kubernetes集群，并且安装了<a class="ae mi" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank"> Helm </a>。当你一切就绪，我们可以安装洛基:</p><h1 id="a311" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">安装带舵的PLG烟囱</h1><p id="0bb1" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">创建一个Kubernetes命名空间，将PLG堆栈部署到:</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="bbab" class="nj kv it nf b gy nk nl l nm nn">$ kubectl create namespace loki</span></pre><p id="2968" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">添加洛基的头盔图<a class="ae mi" href="https://github.com/grafana/loki/tree/master/production/helm/loki" rel="noopener ugc nofollow" target="_blank">储存库</a>:</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="45df" class="nj kv it nf b gy nk nl l nm nn">$ helm repo add loki <a class="ae mi" href="https://grafana.github.io/loki/charts" rel="noopener ugc nofollow" target="_blank">https://grafana.github.io/loki/charts</a></span></pre><p id="7452" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">运行以下命令来更新存储库:</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="be50" class="nj kv it nf b gy nk nl l nm nn">$ helm repo update</span></pre><p id="5cc9" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">部署Loki堆栈:</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="1d21" class="nj kv it nf b gy nk nl l nm nn">$ helm upgrade --install loki loki/loki-stack --namespace=loki --set grafana.enabled=true</span></pre><p id="facc" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">这将把Loki、Grafana和Promtail安装到您的Kubernetes集群中。</p><p id="c6b1" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">检索登录Grafana的密码:</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="e878" class="nj kv it nf b gy nk nl l nm nn">$ kubectl get secret loki-grafana --namespace=loki -o jsonpath="{.data.admin-password}" | base64 --decode ; echo</span></pre><p id="5a85" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">生成的管理员密码将如下所示-&gt; <code class="fe no np nq nf b">jvjqUy2nhsHplVwrX8V05UgSDYEDz6pSiBZOCPHf</code></p><p id="95c4" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">最后，执行下面的命令来访问Grafana UI。</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="47d5" class="nj kv it nf b gy nk nl l nm nn">$ kubectl port-forward --namespace loki service/loki-grafana 3000:80</span></pre><p id="550a" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">现在打开你的浏览器，进入<a class="ae mi" href="http://localhost:3000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000 </a>。</p><p id="1674" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">使用用户名“admin”和之前获取的密码登录。</p><h1 id="0a87" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">格拉法纳的洛基</h1><p id="9020" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">我们安装的Grafana带有预先配置的Loki数据源。所以我们可以马上开始探索我们的Kubernetes日志:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/19d80f5e100d11e16eeec8d2785d5bd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-CVrAFFec5aP3nSn.png"/></div></div></figure><p id="f3ea" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">接下来，单击左侧的Explore选项卡。从数据源下拉列表中选择Loki。</p><p id="c846" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">点击日志标签下拉菜单&gt;容器&gt; kube-apiserver</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/6e1991730c1d54ccc64041cc48eaca22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cIq-4NJtgZVHfQm3.png"/></div></div></figure><p id="f632" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">现在，您应该在日志窗口中获得数据了！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/86466f36561267a16ef677a2444f7e51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JNwlrkq2D9td53_9.png"/></div></div></figure><p id="7a6f" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">向下滚动，您将在kube-apiserver日志中找到详细信息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/5cc9dd90be949fb9ab02a5e1ccc99008.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*FFKpQW_W7mBXLoce.png"/></div></div></figure><h1 id="9622" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">LogQL</h1><p id="1b85" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">LogQL提供了通过操作符过滤日志的功能。以下是支持的运算符列表:</p><ul class=""><li id="68ff" class="mo mp it lo b lp mj ls mk lv mq lz mr md ms mh nd mu mv mw bi translated"><code class="fe no np nq nf b">=:</code>完全相等。</li><li id="0e1f" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh nd mu mv mw bi translated"><code class="fe no np nq nf b">!=:</code>不平等。</li><li id="8a45" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh nd mu mv mw bi translated"><code class="fe no np nq nf b">=~:</code>正则表达式匹配。</li><li id="2f5a" class="mo mp it lo b lp mx ls my lv mz lz na md nb mh nd mu mv mw bi translated"><code class="fe no np nq nf b">!~:</code>正则表达式不匹配。</li></ul><p id="36cf" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">让我们在另一个查询中尝试一下。我们从搜索<code class="fe no np nq nf b">kube-apiserver</code>容器的所有日志开始。除此之外，我们还添加了过滤操作符，将结果限制为包含单词<code class="fe no np nq nf b">error</code>而不包含<code class="fe no np nq nf b">timeout</code>的日志:</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="c743" class="nj kv it nf b gy nk nl l nm nn">{container="kube-apiserver"} |= "error" != "timeout"</span></pre><p id="c2ea" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">这是一个设置和使用Loki和Grafana的简单例子。如果你想了解更多，请前往<a class="ae mi" href="https://grafana.com/docs/loki/latest/" rel="noopener ugc nofollow" target="_blank"> Loki文档</a>。</p><h1 id="fd37" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">包扎</h1><p id="366f" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">公司需要一种简单且经济高效的解决方案来收集、存储和分析分布式系统中应用和服务的日志文件。Loki可以帮助您<a class="ae mi" href="https://grafana.com/blog/2019/11/19/how-loki-helped-paytm-insider-save-75-of-logging-and-monitoring-costs/" rel="noopener ugc nofollow" target="_blank">显著降低生产环境中的日志记录和监控成本</a>。结合Promtail和Grafana，它提供了完整测井堆栈所需的所有功能，可以帮助您更快地发现和解决问题，并防止故障在未来发生。</p><p id="f304" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">你想知道洛基如何帮助你在你的软件系统中获得更多的内幕，削减成本和<a class="ae mi" href="https://codersociety.com/blog/articles/devops-success-in-organization" rel="noopener ugc nofollow" target="_blank">加强你公司的开发工作吗</a>？使用我们的<a class="ae mi" href="https://codersociety.com/contact" rel="noopener ugc nofollow" target="_blank">联系表</a>，我们将很快回复您。</p><p id="2942" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated">有关我们的最新见解和更新，<a class="ae mi" href="https://www.linkedin.com/company/codersociety" rel="noopener ugc nofollow" target="_blank">在LinkedIn上关注我们</a></p></div><div class="ab cl nt nu hx nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="im in io ip iq"><p id="5e76" class="pw-post-body-paragraph lm ln it lo b lp mj ju lr ls mk jx lu lv ml lx ly lz mm mb mc md mn mf mg mh im bi translated"><em class="oa">最初发表于</em><a class="ae mi" href="https://codersociety.com/blog/articles/loki-kubernetes-logging" rel="noopener ugc nofollow" target="_blank"><em class="oa">https://codersociety.com</em></a><em class="oa">。</em></p></div></div>    
</body>
</html>