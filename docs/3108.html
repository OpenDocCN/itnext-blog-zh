<html>
<head>
<title>Supercharging Helm</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">增压舵</h1>
<blockquote>原文：<a href="https://itnext.io/supercharging-helm-e0c69737a2d1?source=collection_archive---------4-----------------------#2019-10-04">https://itnext.io/supercharging-helm-e0c69737a2d1?source=collection_archive---------4-----------------------#2019-10-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8dfb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">调整你的舵练习</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/85a6a5efb7e1824b5ac4612370fe574d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jqa33nXxSSoYmzqjzUsKZg.jpeg"/></div></div></figure><p id="4b2d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你认真对待Kubernetes，我打赌你用的是Helm。这是显而易见的。一致性，额外的功能和一个伟大的CLI，都包装在一个非常有用的软件包。开箱即用，头盔是非常注重功能，你会看到几乎立即受益。</p><p id="7556" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然而，还是有一些问题。与许多Kubernetes工具一样，Helm在默认情况下是不安全的。它将安装其服务器端组件Tiller，拥有几乎无限的权力。这对恶意参与者来说是一个相当严重的攻击媒介。</p><p id="5c3a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在本文中，我将首先讨论降低Tiller给集群带来的风险的方法。其次，我将提供一些helm提供的技巧和鲜为人知的功能。让我们开始吧。</p><h1 id="9dfa" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">舵柄</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mi"><img src="../Images/537f6a7347451ff5f836a26453e55d19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*85RRq9Gtr9uDLjGV.jpg"/></div></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">蒂勒有现成的神力</figcaption></figure><p id="20cc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">舵柄是舵的问题。如果它坏了，被泄露了或者被删除了，你就有麻烦了。这就是头盔3中的<a class="ae mo" href="https://helm.sh/blog/helm-3-preview-pt2/" rel="noopener ugc nofollow" target="_blank">被移除的原因。然而，当我们被头盔2困住时，我们并不是完全无助的。</a></p><h2 id="306d" class="mp lr it bd ls mq mr dn lw ms mt dp ma ld mu mv mc lh mw mx me ll my mz mg na bi translated">名称空间特定的Tiller</h2><p id="fdac" class="pw-post-body-paragraph ku kv it kw b kx nb ju kz la nc jx lc ld nd lf lg lh ne lj lk ll nf ln lo lp im bi translated">我们的第一个缓解措施是为一个名称空间安装一个Tiller。这极大地限制了缺口的爆炸半径。你是怎么做到的？首先，蒂勒需要一个服务账户。如果你不熟悉Kubernetes中的<code class="fe ng nh ni nj b">ServiceAccount</code>资源，你可以在这里<a class="ae mo" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/" rel="noopener ugc nofollow" target="_blank">阅读。</a></p><h2 id="8e10" class="mp lr it bd ls mq mr dn lw ms mt dp ma ld mu mv mc lh mw mx me ll my mz mg na bi translated"><strong class="ak">配置RBAC </strong></h2><p id="1288" class="pw-post-body-paragraph ku kv it kw b kx nb ju kz la nc jx lc ld nd lf lg lh ne lj lk ll nf ln lo lp im bi translated">Tiller将需要您的名称空间中的大量权限。要向服务帐户添加权限，您首先需要一个<code class="fe ng nh ni nj b">Role</code>。</p><pre class="kj kk kl km gt nk nj nl nm aw nn bi"><span id="e148" class="mp lr it nj b gy no np l nq nr">kind: Role<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>metadata:  <br/>  name: tiller-role <br/>  namespace: my-namespace<br/>      rules:<br/>      - apiGroups: ["", "extensions", "apps"]  <br/>        resources: ["*"]  <br/>        verbs: ["*"]</span></pre><p id="34e8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">正如你所看到的，这个<code class="fe ng nh ni nj b">Role</code>被允许做它想做的任何事情，但是<em class="mn">只允许在<code class="fe ng nh ni nj b">my-namespace</code> <em class="mn">命名空间中做</em>。所以现在我们有了自己的角色，我们需要自己的<code class="fe ng nh ni nj b">ServiceAccount</code>。这个很简单。</em></p><pre class="kj kk kl km gt nk nj nl nm aw nn bi"><span id="2230" class="mp lr it nj b gy no np l nq nr">apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: tiller-service-account<br/>  namespace: my-namespace</span></pre><p id="0599" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">最后，你需要一点胶水。此刻你的<code class="fe ng nh ni nj b">Role</code>和你的<code class="fe ng nh ni nj b">ServiceAccount</code>是断开的。你需要一些东西把两者结合在一起。这是以<code class="fe ng nh ni nj b">RoleBinding</code>的形式出现的。</p><pre class="kj kk kl km gt nk nj nl nm aw nn bi"><span id="01bc" class="mp lr it nj b gy no np l nq nr">kind: RoleBinding<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>metadata:<br/>  name: tiller-role-binding<br/>  namespace: my-namespace<br/>subjects:<br/>- kind: ServiceAccount  <br/>  name: tiller-service-account<br/>  namespace: my-namespace<br/>  roleRef:  <br/>    kind: Role  <br/>    name: tiller-role <br/>    apiGroup: rbac.authorization.k8s.io</span></pre><p id="89b3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">所以我们创建了一个服务帐户，它可以做任何它想做的事情，但是只能在名称空间<code class="fe ng nh ni nj b">my-namespace</code>中。我们如何告诉赫尔姆使用这个？好了，CLI已经为您准备好了。</p><pre class="kj kk kl km gt nk nj nl nm aw nn bi"><span id="f7fc" class="mp lr it nj b gy no np l nq nr">helm init --service-account tiller-service-account --tiller-namespace my-namespace</span></pre><p id="5503" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">就是这样！您的tiller将非常适合部署到该名称空间中。如果遭到破坏，它会对您的名称空间造成严重破坏，但这不是集群范围的破坏(假设RBAC安全性没有漏洞……)。</p><h2 id="da8a" class="mp lr it bd ls mq mr dn lw ms mt dp ma ld mu mv mc lh mw mx me ll my mz mg na bi translated">没有舵柄</h2><p id="c1a6" class="pw-post-body-paragraph ku kv it kw b kx nb ju kz la nc jx lc ld nd lf lg lh ne lj lk ll nf ln lo lp im bi translated">凯尔西·海塔尔<a class="ae mo" href="https://github.com/kelseyhightower/nocode" rel="noopener ugc nofollow" target="_blank">说得很漂亮。</a></p><pre class="kj kk kl km gt nk nj nl nm aw nn bi"><span id="e44a" class="mp lr it nj b gy no np l nq nr">No code is the best way to write secure and reliable applications. Write nothing; deploy nowhere.</span></pre><p id="6975" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">只是不要使用舵柄。这很容易做到，并且需要尽可能少的配置。</p><pre class="kj kk kl km gt nk nj nl nm aw nn bi"><span id="aff9" class="mp lr it nj b gy no np l nq nr">helm init --client-only</span></pre><p id="11e1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然而，在《头盔2》中，这意味着你将无法使用一些我们将在本文后面介绍的更棒的功能。你需要使用<code class="fe ng nh ni nj b">helm template</code>来安装你的yaml，但是你仍然可以得到Helm提供的<a class="ae mo" href="https://dzone.com/articles/software-design-principles-dry-and-kiss" rel="noopener ugc nofollow" target="_blank"> DRY </a>的好处。</p><h2 id="5eb2" class="mp lr it bd ls mq mr dn lw ms mt dp ma ld mu mv mc lh mw mx me ll my mz mg na bi translated">等待3号舵</h2><p id="32e9" class="pw-post-body-paragraph ku kv it kw b kx nb ju kz la nc jx lc ld nd lf lg lh ne lj lk ll nf ln lo lp im bi translated">很多人选择在头盔3发布之前不使用头盔。正如我前面提到的，Helm 3没有任何舵柄，只是直接与k8s资源如<code class="fe ng nh ni nj b">ConfigMap</code>和<code class="fe ng nh ni nj b">Secret</code>接口，以跟踪你的发布。</p><p id="2812" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">头盔3被大大简化了，但是<a class="ae mo" href="https://medium.com/better-programming/helm-3-fun-with-the-new-beta-8f91c70891ff" rel="noopener">保留了很多你在头盔2中可能已经习惯的功能。测试版最近已经发布，所以生产版即将发布。如果你能等待，这可能是明智的。</a></p><h1 id="1cd2" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">舵尖</h1><p id="f146" class="pw-post-body-paragraph ku kv it kw b kx nb ju kz la nc jx lc ld nd lf lg lh ne lj lk ll nf ln lo lp im bi translated">Helm CLI附带了一系列出色的小功能和陷阱。这些都有很好的证明，但是我很少在同一个地方发现它们。在这一节中，我的目的是给你一些好的提示，以避免我陷入的同样的陷阱。</p><h2 id="5d91" class="mp lr it bd ls mq mr dn lw ms mt dp ma ld mu mv mc lh mw mx me ll my mz mg na bi translated">支持头盔升级胜过头盔安装</h2><p id="ab24" class="pw-post-body-paragraph ku kv it kw b kx nb ju kz la nc jx lc ld nd lf lg lh ne lj lk ll nf ln lo lp im bi translated">通常，我们可能会运行这样的东西…</p><pre class="kj kk kl km gt nk nj nl nm aw nn bi"><span id="18a2" class="mp lr it nj b gy no np l nq nr">helm install -f my-values.yaml ./path/to/my/chart --name something</span></pre><p id="1897" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这是在您的Kubernetes集群中安装某些东西的好方法，但是如果您再次尝试运行它会发生什么呢？一个错误，就是这样！那是因为<code class="fe ng nh ni nj b">helm install</code>也不会运行升级。为此，我们有了<code class="fe ng nh ni nj b">helm upgrade</code>。唉，什么都没装就跑不了<code class="fe ng nh ni nj b">helm upgrade</code>！或者……可以吗？</p><pre class="kj kk kl km gt nk nj nl nm aw nn bi"><span id="beab" class="mp lr it nj b gy no np l nq nr">helm upgrade something ./path/to/my/chart -f my-values.yaml --install</span></pre><p id="cd1a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当您运行这个命令时，如果不存在任何东西，它会自动为您安装。这对于CI/CD管道非常有用，因为您不需要在第一次安装时一直手动安装。只需运行并重新运行，次数不限！</p><h2 id="d188" class="mp lr it bd ls mq mr dn lw ms mt dp ma ld mu mv mc lh mw mx me ll my mz mg na bi translated">通过原子升级实现自动回滚</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/bec6f6eacf29596cf33a393a1f14b35c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*k3fCQwP9kgsay5E2.jpg"/></div></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">我在使用舵命令时发出的声音。</figcaption></figure><p id="eafb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">几个月前，helm在他们的cli中添加了一个新标志:<code class="fe ng nh ni nj b">--atomic</code>。如果你的升级失败，这个标志将自动运行一个舵回滚。这很棒，有几个原因。</p><ul class=""><li id="3fcb" class="nt nu it kw b kx ky la lb ld nv lh nw ll nx lp ny nz oa ob bi translated">如果你的首次展示失败了，你想尽快回到100%工作状态。</li><li id="0d86" class="nt nu it kw b kx oc la od ld oe lh of ll og lp ny nz oa ob bi translated">如果你让你的部署处于<code class="fe ng nh ni nj b">FAILED</code>状态，赫尔姆的行为可能<a class="ae mo" href="https://github.com/helm/helm/issues/1193" rel="noopener ugc nofollow" target="_blank">不可预测</a>。<code class="fe ng nh ni nj b">--atomic</code>将确保您的应用程序始终处于<code class="fe ng nh ni nj b">DEPLOYED</code>状态。</li></ul><p id="d1c9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">所以我们的命令看起来有点像这样:</p><pre class="kj kk kl km gt nk nj nl nm aw nn bi"><span id="729a" class="mp lr it nj b gy no np l nq nr">helm upgrade something ./path/to/my/chart -f my-values.yaml --install --atomic</span></pre><h2 id="5517" class="mp lr it bd ls mq mr dn lw ms mt dp ma ld mu mv mc lh mw mx me ll my mz mg na bi translated">舵试验</h2><p id="bd20" class="pw-post-body-paragraph ku kv it kw b kx nb ju kz la nc jx lc ld nd lf lg lh ne lj lk ll nf ln lo lp im bi translated">头盔中的测试没有被充分利用。此功能允许您确保应用程序正确运行。它可以是任何东西，从简单的冒烟测试到一套全面的端到端测试。</p><p id="a008" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">一些人认为这是一种混合的担忧。我们的包装经理也应该是我们的烟雾测试员吗？如果你是粉丝，这个功能是有的，如果你不感兴趣，它是可选的。使用它很简单，为了不重复我自己，我将简单地<a class="ae mo" href="https://github.com/helm/helm/blob/master/docs/chart_tests.md" rel="noopener ugc nofollow" target="_blank">提供一个链接</a>到github上优秀的helm文档。</p><h1 id="6195" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">掌舵离开！</h1><p id="2d49" class="pw-post-body-paragraph ku kv it kw b kx nb ju kz la nc jx lc ld nd lf lg lh ne lj lk ll nf ln lo lp im bi translated">Helm提供了一些很棒的功能，如果使用得当，它是任何成功的kubernetes操作的基石。</p></div><div class="ab cl oh oi hx oj" role="separator"><span class="ok bw bk ol om on"/><span class="ok bw bk ol om on"/><span class="ok bw bk ol om"/></div><div class="im in io ip iq"><p id="6680" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我经常在twitter上谈论Kubernetes、DevOps和良好的工程实践。</p></div></div>    
</body>
</html>