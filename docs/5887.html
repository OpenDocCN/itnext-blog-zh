<html>
<head>
<title>DirectX in NativeAOT</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">NativeAOT中的DirectX</h1>
<blockquote>原文：<a href="https://itnext.io/directx-in-nativeaot-2ce996a15c23?source=collection_archive---------1-----------------------#2021-06-21">https://itnext.io/directx-in-nativeaot-2ce996a15c23?source=collection_archive---------1-----------------------#2021-06-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b97662329077ede9da65170bc113353d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NRhA9Z66REgb7xtCWiuN7w.jpeg"/></div></div></figure><p id="749a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我一直在寻找各种有趣的项目，在那里我可以展示AOT本土的优势。所以今天我要写一下DirectX。从技术上讲，DirectX只是另一个COM库，因为我之前在native aut中写过关于<a class="ae kw" href="https://codevision.medium.com/using-com-in-nativeaot-131dbc0d559e" rel="noopener"> COM的文章，所以在这方面没有什么特别的。本文的新内容是，今天我将使用源代码生成器快速创建一个ComWrappers实例，以便在我的小应用程序中使用。</a></p><p id="c215" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">作为起点，我将再次从杰里米·屈尼的库开始。如果在任何时候你觉得无聊，直接去<a class="ae kw" href="https://github.com/kant2002/WInterop/tree/test-aot/src/Samples/CoreWindows/Direct2dDemo" rel="noopener ugc nofollow" target="_blank">源代码</a>并使用样本。</p><p id="e879" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">那么，当前需要什么来使NativeAOT和COM旋转呢？通常，我通过以下简单的步骤开始将应用程序移植到NativeAOT。我创建了一个新的空白ComWrappers类。</p><figure class="kx ky kz la gt jr"><div class="bz fp l di"><div class="lb lc l"/></div></figure><p id="bf24" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里是一个类，它将作为我将在应用程序中使用的所有COM对象的通用运行时可调用包装器。</p><figure class="kx ky kz la gt jr"><div class="bz fp l di"><div class="lb lc l"/></div></figure><p id="03a4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，我注册ComWrappers进行全局封送，这样所有COM interop都将被转发到新创建的ComWrappers。</p><figure class="kx ky kz la gt jr"><div class="bz fp l di"><div class="lb lc l"/></div></figure><p id="409c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后我运行应用程序，直到它在某个地方抛出。在目前的情况下，是在我的通用包装器接口到<code class="fe ld le lf lg b">Winterop.Direct2d.IFactory</code>的转换过程中。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lh"><img src="../Images/711185fe5b26d4b8e5b9a2b7f0788cbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G4lnuRKSGM82UbcOrugA3w.png"/></div></div></figure><p id="e328" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这意味着我应该在RCW上实现<code class="fe ld le lf lg b">Winterop.Direct2d.IFactory</code>,让那部分代码工作。这是通过在<code class="fe ld le lf lg b">UnversalWrappers</code>类上添加属性来实现的。该接口所需的所有实现将由<code class="fe ld le lf lg b"><a class="ae kw" href="https://www.nuget.org/packages/WinFormsComInterop.SourceGenerator/0.2.6" rel="noopener ugc nofollow" target="_blank">WinFormsComInterop.SourceGenerator</a></code> NuGet包完成。</p><figure class="kx ky kz la gt jr"><div class="bz fp l di"><div class="lb lc l"/></div></figure><p id="e281" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我再次运行构建，它失败了，并出现2个错误</p><p id="511a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe ld le lf lg b">error CS8121: An expression of type ‘IGeometry’ cannot be handled by a pattern of type ‘UniversalWrapper’<br/>error CS8121: An expression of type ‘IRenderingParams’ cannot be handled by a pattern of type ‘UniversalWrapper’.</code></p><p id="0597" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我添加了另外两个必需的接口。</p><figure class="kx ky kz la gt jr"><div class="bz fp l di"><div class="lb lc l"/></div></figure><p id="a333" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后我再次构建，它失败了，添加所需的接口。冲洗并重复。冲洗并重复。最后这个过程结束，并且构建成功。</p><figure class="kx ky kz la gt jr"><div class="bz fp l di"><div class="lb lc l"/></div></figure><p id="2bb5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我再次运行应用程序。你猜怎么着？</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="gh gi li"><img src="../Images/b761303e663a4803b4192b0c9ea40991.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/format:webp/1*JtD6sE6JUj011DEK2diSIQ.png"/></div></figure><p id="c15e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">再次崩溃。所以我使用属性<code class="fe ld le lf lg b">[RuntimeCallableWrapper(typeof(WInterop.DirectWrite.IFactory))]</code>添加了一个接口。一段时间后，它解决了，我们实现所有的接口，并再次运行应用程序。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lj"><img src="../Images/271dc6cb9e89da81713029d761ef9621.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NCBMJlJSB7whVWAFdvRbnA.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">示例中的最后一个屏幕</figcaption></figure><p id="ac1a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就是这样。现在，该应用程序可以在本地AOT环境中进行测试了。让我们运行<code class="fe ld le lf lg b">dotnet publish -c Release -r win-x64</code>并看看进展如何。嘿！起作用了。又是1，4 Mb的磁盘空间。</p><p id="070c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> P.S. </strong>我应该注意，我在这里公然滥用了ComWrappers，为了获得最佳效果，您应该遵循<a class="ae kw" href="https://github.com/microsoft/CsWinRT" rel="noopener ugc nofollow" target="_blank"> CsWinRT </a>的路径，使用ComWrappers的精简版本，并以稍微不同的方式构造代码生成，这不需要拥有全局ComWrapper实例。<a class="ae kw" href="https://github.com/kant2002/WinFormsComInterop" rel="noopener ugc nofollow" target="_blank">我的库和源代码生成器</a>服务于不同的目的——让旧的应用程序在原生AOT环境中工作。第二个目标是减轻运行它们的痛苦，如果有人愿意尝试的话。</p><p id="1207" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我会再次拿起武器！加入原力！通过使用本地AOT运行你的应用程序来帮助这个项目，万一有问题去<a class="ae kw" href="https://gitter.im/dotnet/corert" rel="noopener ugc nofollow" target="_blank">和在Gitter </a>聊天，在<a class="ae kw" href="https://github.com/dotnet/runtimelab" rel="noopener ugc nofollow" target="_blank"> Github repo </a>文件问题，这里的人非常有帮助。</p></div></div>    
</body>
</html>