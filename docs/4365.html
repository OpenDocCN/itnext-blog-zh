<html>
<head>
<title>Run slow RSpec files on Github Actions with parallel jobs using an auto split of the spec file by test examples</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过测试示例使用Spec文件的自动分割，在带有并行作业的Github操作上运行缓慢的RSpec文件</h1>
<blockquote>原文：<a href="https://itnext.io/run-slow-rspec-files-on-github-actions-with-parallel-jobs-using-an-auto-split-of-the-spec-file-by-6bee53e31fb4?source=collection_archive---------7-----------------------#2020-06-15">https://itnext.io/run-slow-rspec-files-on-github-actions-with-parallel-jobs-using-an-auto-split-of-the-spec-file-by-6bee53e31fb4?source=collection_archive---------7-----------------------#2020-06-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="7b88" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将您的CI构建任务在多台并行运行的机器之间进行分割是一个让您的CI测试更快的好方法，这将为构建特性带来更多的时间。Github Actions允许轻松运行并行作业。在上一篇文章中，我们解释了如何使用backpack Pro在GitHub Actions 上的并行作业之间<a class="ae kl" href="https://docs.knapsackpro.com/2019/how-to-run-rspec-on-github-actions-for-ruby-on-rails-app-using-parallel-jobs" rel="noopener ugc nofollow" target="_blank">有效地分割RSpec测试文件。今天，我们将展示如何解决缓慢的测试文件对整个构建时间产生负面影响的问题。</a></p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/ce3f03555cf9eb52efb4c50ffda699bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Z9Cq82N7GGiYqPpJ.jpeg"/></div></div></figure><h1 id="fad9" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">考虑一下分裂</h1><p id="afc2" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">假设您有一个包含30个RSpec规范文件的项目。每个文件包含多个测试实例。大多数文件都是相当健壮、快速的单元测试。假设还有一些较慢的文件，比如特性规格。也许一个这样的特征规格文件需要大约5分钟来执行。</p><p id="93b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我们在不同的并行机器上运行不同的spec文件时，我们努力在所有机器上获得相似的执行时间。在一个描述的场景中，即使我们运行30个并行的任务(每个任务只运行一个测试文件)，5分钟的特性规范也会成为整个构建的瓶颈。29台机器可能在几秒钟内完成它们的工作，但是直到剩下的1个节点执行完它的文件，整个构建才算完成。</p><h1 id="827f" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">分步解决</h1><p id="eb05" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">为了解决测试文件速度慢的问题，我们需要拆分文件中的内容。我们可以重构它，并确保测试实例存在于单独的、更小的测试文件中。但是这有两个问题:</p><p id="3ba4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，它需要工作。尽管在所描述的场景中确实很合理，但在现实生活中，通常不仅仅是一个文件引起问题。通常有许多缓慢而复杂的测试文件，它们有自己复杂的设置，比如嵌套的<code class="fe mb mc md me b">before</code>块、<code class="fe mb mc md me b">let</code>块等等。我们都见过他们(可能是他们以这种方式结束的原因)，不是吗？；-)像这样重构文件一点也不好玩，而且似乎总是有更多更重要的工作要做，至少从我们的经验来看是这样。</p><p id="4e3e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其次，我们认为代码组织应该基于其他考虑。如何创建文件和类很可能是遵循项目中商定的一些方法的结果。将类分成更小的类，以便CI构建可以运行得更快，这违反了您的惯例。对一些人来说，这可能比其他人更令人不安，但我们认为最好避免这种情况是公平的——如果有更好的方法来达到同样的目的…</p><h1 id="46dc" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">输入按测试实例划分</h1><p id="2933" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">如您所知，RSpec允许我们运行单个示例，而不是整个文件。我们决定利用这一点，通过从速度较慢的文件中收集关于单个例子的信息来解决瓶颈测试文件的问题。然后，这样的例子被动态地分布在并行节点之间，并单独运行，因此没有一个单独的文件会成为整个构建的瓶颈。重要的是，不需要额外的工作——这是由<code class="fe mb mc md me b">knapsack_pro</code> gem自动完成的。每个示例都在正确的上下文中运行，就像运行整个文件一样。</p><p id="9f6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你已经在队列模式下使用<a class="ae kl" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=how-to-run-slow-rspec-files-on-github-actions-with-parallel-jobs-by-doing-an-auto-split-of-the-spec-file-by-test-examples" rel="noopener ugc nofollow" target="_blank">backpack Pro</a>，你可以通过添加一个ENV变量到你的GitHub Actions工作流配置中来启用这个特性:<code class="fe mb mc md me b">KNAPSACK_PRO_RSPEC_SPLIT_BY_TEST_EXAMPLES: true</code>(请确保你运行的是最新版本的<code class="fe mb mc md me b">knapsack_pro</code> gem)。经过几次运行后，背包专业版将开始自动分裂你最慢的测试文件的个别例子。</p><p id="d4cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是使用RSpec的Rails项目的GitHub Actions工作流配置的完整示例:</p><pre class="kn ko kp kq gt mf me mg mh aw mi bi"><span id="c3fd" class="mj kz iq me b gy mk ml l mm mn"><em class="mo"># .github/workflows/main.yaml</em><br/><br/>name: Main<br/><br/>on: [push]<br/><br/>jobs:<br/>  test:<br/>    runs-on: ubuntu-latest<br/><br/>    <em class="mo"># If you need DB like PostgreSQL, Redis then define service below.</em><br/>    <em class="mo"># https://github.com/actions/example-services/tree/master/.github/workflows</em><br/>    services:<br/>      postgres:<br/>        image: postgres:10.8<br/>        env:<br/>          POSTGRES_USER: postgres<br/>          POSTGRES_PASSWORD: ""<br/>          POSTGRES_DB: postgres<br/>        ports:<br/>          - 5432:5432<br/>        <em class="mo"># needed because the postgres container does not provide a healthcheck</em><br/>        <em class="mo"># tmpfs makes DB faster by using RAM</em><br/>        options: &gt;-<br/>          --mount type=tmpfs,destination=/var/lib/postgresql/data<br/>          --health-cmd pg_isready<br/>          --health-interval 10s<br/>          --health-timeout 5s<br/>          --health-retries 5<br/>      redis:<br/>        image: redis<br/>        ports:<br/>          - 6379:6379<br/>        options: --entrypoint redis-server<br/><br/>    <em class="mo"># https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idstrategymatrix</em><br/>    strategy:<br/>      fail-fast: false<br/>      matrix:<br/>        <em class="mo"># Set N number of parallel jobs you want to run tests on.</em><br/>        <em class="mo"># Use higher number if you have slow tests to split them on more parallel jobs.</em><br/>        <em class="mo"># Remember to update ci_node_index below to 0..N-1</em><br/>        ci_node_total: [8]<br/>        <em class="mo"># set N-1 indexes for parallel jobs</em><br/>        <em class="mo"># When you run 2 parallel jobs then first job will have index 0, the second job will have index 1 etc</em><br/>        ci_node_index: [0, 1, 2, 3, 4, 5, 6, 7]<br/><br/>    steps:<br/>      - uses: actions/checkout@v2<br/><br/>      - name: Set up Ruby<br/>        uses: actions/setup-ruby@v1<br/>        with:<br/>          ruby-version: 2.6<br/><br/>      - uses: actions/cache@v2<br/>        with:<br/>          path: vendor/bundle<br/>          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}<br/>          restore-keys: |<br/>            ${{ runner.os }}-gems-<br/>      - name: Bundle install<br/>        env:<br/>          RAILS_ENV: test<br/>        run: |<br/>          bundle config path vendor/bundle<br/>          bundle install --jobs 4 --retry 3<br/>      - name: Create DB<br/>        env:<br/>          <em class="mo"># use localhost for the host here because we have specified a container for the job.</em><br/>          <em class="mo"># If we were running the job on the VM this would be postgres</em><br/>          PGHOST: localhost<br/>          PGUSER: postgres<br/>          RAILS_ENV: test<br/>        run: |<br/>          bin/rails db:prepare<br/>      - name: Run tests<br/>        env:<br/>          PGHOST: localhost<br/>          PGUSER: postgres<br/>          RAILS_ENV: test<br/>          KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC: ${{ secrets.KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC }}<br/>          KNAPSACK_PRO_CI_NODE_TOTAL: ${{ matrix.ci_node_total }}<br/>          KNAPSACK_PRO_CI_NODE_INDEX: ${{ matrix.ci_node_index }}<br/>          KNAPSACK_PRO_FIXED_QUEUE_SPLIT: true<br/>          KNAPSACK_PRO_RSPEC_SPLIT_BY_TEST_EXAMPLES: true<br/>          KNAPSACK_PRO_LOG_LEVEL: info<br/>        run: |<br/>          bundle exec rake knapsack_pro:queue:rspec</span></pre><p id="dbee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在下面的视频中找到更多细节:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="4230" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请在评论中告诉我们你对这个解决方案的看法。如果你想试试这个设置，你也可以参考我们的FAQ条目，解释<a class="ae kl" href="https://knapsackpro.com/faq/question/how-to-split-slow-rspec-test-files-by-test-examples-by-individual-it?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=how-to-run-slow-rspec-files-on-github-actions-with-parallel-jobs-by-doing-an-auto-split-of-the-spec-file-by-test-examples" rel="noopener ugc nofollow" target="_blank">如何分割慢速RSpec测试文件</a>。</p><p id="0c12" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一如既往，如果您在项目中遇到任何配置GitHub操作的问题，请不要犹豫，我们很乐意帮助您！</p></div><div class="ab cl mr ms hu mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="ij ik il im in"><p id="b3ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mo">原载于2020年6月15日https://docs.knapsackpro.com</em><em class="mo"/><a class="ae kl" href="https://docs.knapsackpro.com/2020/how-to-run-slow-rspec-files-on-github-actions-with-parallel-jobs-by-doing-an-auto-split-of-the-spec-file-by-test-examples" rel="noopener ugc nofollow" target="_blank"><em class="mo">。</em></a></p></div></div>    
</body>
</html>