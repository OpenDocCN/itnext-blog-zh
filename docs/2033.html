<html>
<head>
<title>Automating your Services with Knative and Solo.io Gloo</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Knative和Solo实现服务自动化</h1>
<blockquote>原文：<a href="https://itnext.io/knative-and-solo-io-gloo-2a877d456238?source=collection_archive---------4-----------------------#2019-03-19">https://itnext.io/knative-and-solo-io-gloo-2a877d456238?source=collection_archive---------4-----------------------#2019-03-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/f7483a638e159124d59d8a2cd96baa44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WKHmvJZIdUPxjmxl"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">由<a class="ae kf" href="https://unsplash.com/@_louisreed?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">路易·里德</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="e94c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Knative 被谈论了很多，尤其是它的功能如何在Kubernetes的基础上帮助提供更多标准构建块来构建微服务和无服务器之类的服务，例如，扩展到零和按需扩展。Knative高层有三个能力领域:构建、服务和事件。这篇文章将提供一些关于Knative Build和Knative Serving的例子。</p><p id="27b4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Knative Serving最初包含了所有的Istio，但只使用了Kubernetes集群入口的一小部分功能。最近Knative团队增加了Gloo作为Istio的替代产品。更多细节可在Solo.io的<a class="ae kf" href="https://medium.com/solo-io/gloo-knative-and-the-future-of-serverless-902b89f15c2c" rel="noopener"> Gloo、Knative和无服务器的未来</a>和<a class="ae kf" href="https://medium.com/solo-io/gloo-by-solo-io-is-the-first-alternative-to-istio-on-knative-324753586f3a" rel="noopener"> Gloo中获得，是Istio on Knative </a>的第一个替代方案。</p><p id="92a1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这篇文章展示了一个快速构建、服务和Gloo整合的例子。</p><p id="a410" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">所有的Kubernetes清单都位于下面的GitHub repo<a class="ae kf" href="https://github.com/scranton/helloworld-knative" rel="noopener ugc nofollow" target="_blank">https://github.com/scranton/helloworld-knative</a>中。我鼓励您使用GitHub库来帮助自己尝试这些例子。</p><h1 id="21eb" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">设置</h1><p id="5086" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">这些说明假设您正在本地运行一个全新的最近的<code class="fe mh mi mj mk b"><a class="ae kf" href="https://kubernetes.io/docs/setup/minikube/" rel="noopener ugc nofollow" target="_blank">minikube</a></code>安装，并且您在本地也有可用的<code class="fe mh mi mj mk b">kubectl</code>。</p><h2 id="164f" class="ml lf it bd lg mm mn dn lk mo mp dp lo kr mq mr ls kv ms mt lw kz mu mv ma mw bi translated">安装Gloo</h2><p id="f7d0" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">在Mac或Linux上，最快的选择是使用<a class="ae kf" href="https://bash.sh/" rel="noopener ugc nofollow" target="_blank">自制软件</a>。Gloo文档中的完整安装说明。</p><pre class="mx my mz na gt nb mk nc nd aw ne bi"><span id="1a56" class="ml lf it mk b gy nf ng l nh ni">brew install glooctl</span></pre><p id="2d8d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后假设你已经有了一个运行的<code class="fe mh mi mj mk b">minikube</code>，并且<code class="fe mh mi mj mk b">kubectl</code>是针对那个<code class="fe mh mi mj mk b">minikube</code>实例设置的，也就是说<code class="fe mh mi mj mk b">kubectl config current-context</code>返回<code class="fe mh mi mj mk b">minikube</code>，运行下面的代码来安装Gloo with Knative Serving。</p><pre class="mx my mz na gt nb mk nc nd aw ne bi"><span id="92a5" class="ml lf it mk b gy nf ng l nh ni">glooctl install knative</span></pre><h1 id="4773" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">部署现有的示例映像</h1><p id="95bc" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我已经构建了这个例子，并在我的<a class="ae kf" href="https://hub.docker.com/r/scottcranton/helloworld-go" rel="noopener ugc nofollow" target="_blank"> Docker Hub repo </a>中公开了这个图像。要使用Knative来提供这个现有的图像，只需要执行下面的命令。</p><pre class="mx my mz na gt nb mk nc nd aw ne bi"><span id="623d" class="ml lf it mk b gy nf ng l nh ni">kubectl apply --filename service.yaml</span></pre><p id="612f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">验证服务的域URL。应该是<code class="fe mh mi mj mk b">helloworld-go.default.example.com.</code></p><pre class="mx my mz na gt nb mk nc nd aw ne bi"><span id="b996" class="ml lf it mk b gy nf ng l nh ni">kubectl get kservice helloworld-go \<br/>  --namespace default \<br/>  --output<strong class="mk iu">=</strong>custom-columns<strong class="mk iu">=</strong>NAME:.metadata.name,DOMAIN:.status.domain</span></pre><p id="7052" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并调用服务。注意:只有在对minikube进行本地调用时才需要<code class="fe mh mi mj mk b">curl --connect-to</code>选项，因为该选项会将正确的主机和sni头添加到请求中，并将请求发送到从<code class="fe mh mi mj mk b">glooctl proxy address</code>返回的主机和端口对。</p><pre class="mx my mz na gt nb mk nc nd aw ne bi"><span id="94b3" class="ml lf it mk b gy nf ng l nh ni">curl --connect-to helloworld-go.default.example.com:80:<strong class="mk iu">$(</strong>glooctl proxy address --name clusteringress-proxy<strong class="mk iu">)</strong> <a class="ae kf" href="http://helloworld-go.default.example.com" rel="noopener ugc nofollow" target="_blank">http://helloworld-go.default.example.com</a></span></pre><p id="2ef6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要进行清理，请删除资源。</p><pre class="mx my mz na gt nb mk nc nd aw ne bi"><span id="0ba0" class="ml lf it mk b gy nf ng l nh ni">kubectl delete --filename service.yaml</span></pre><h1 id="29f2" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">本地构建，并使用Knative Serving进行部署</h1><p id="f1b0" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">使用您的Docker Hub用户名运行<code class="fe mh mi mj mk b">docker build</code>。</p><pre class="mx my mz na gt nb mk nc nd aw ne bi"><span id="15b0" class="ml lf it mk b gy nf ng l nh ni">docker build -t <strong class="mk iu">${</strong>DOCKER_USERNAME<strong class="mk iu">}</strong>/helloworld-go .<br/>docker push <strong class="mk iu">${</strong>DOCKER_USERNAME<strong class="mk iu">}</strong>/helloworld-go</span></pre><p id="9ba6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">部署服务。同样，确保您更新了<code class="fe mh mi mj mk b">service.yaml </code>文件中的用户名，即将图像参考<code class="fe mh mi mj mk b">docker.io/scottcranton/helloworld-go</code>替换为您的Docker Hub用户名。</p><pre class="mx my mz na gt nb mk nc nd aw ne bi"><span id="a719" class="ml lf it mk b gy nf ng l nh ni">kubectl apply --filename service.yaml</span></pre><p id="8c7b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">验证服务的域URL。应该是<code class="fe mh mi mj mk b">helloworld-go.default.example.com</code>。</p><pre class="mx my mz na gt nb mk nc nd aw ne bi"><span id="19a7" class="ml lf it mk b gy nf ng l nh ni">kubectl get kservice helloworld-go \<br/>  --namespace default \<br/>  --output<strong class="mk iu">=</strong>custom-columns<strong class="mk iu">=</strong>NAME:.metadata.name,DOMAIN:.status.domain</span></pre><p id="5ac6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并测试您的服务。</p><pre class="mx my mz na gt nb mk nc nd aw ne bi"><span id="591c" class="ml lf it mk b gy nf ng l nh ni">curl --connect-to helloworld-go.default.example.com:80:<strong class="mk iu">$(</strong>glooctl proxy address --name clusteringress-proxy<strong class="mk iu">)</strong> <a class="ae kf" href="http://helloworld-go.default.example.com" rel="noopener ugc nofollow" target="_blank">http://helloworld-go.default.example.com</a></span></pre><p id="702c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要进行清理，请删除资源。</p><pre class="mx my mz na gt nb mk nc nd aw ne bi"><span id="017c" class="ml lf it mk b gy nf ng l nh ni">kubectl delete --filename service.yaml</span></pre><h1 id="600c" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">使用主动构建进行构建，使用主动服务进行部署</h1><p id="87b3" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">要安装Knative Build，请执行以下操作。我使用的是<code class="fe mh mi mj mk b">kaniko</code>构建模板，所以你也需要安装它。</p><pre class="mx my mz na gt nb mk nc nd aw ne bi"><span id="6d72" class="ml lf it mk b gy nf ng l nh ni">kubectl apply \<br/>  --filename https://github.com/knative/build/releases/download/v0.4.0/build.yaml</span><span id="fb4f" class="ml lf it mk b gy nj ng l nh ni">kubectl apply \<br/>  --filename <a class="ae kf" href="https://raw.githubusercontent.com/knative/build-templates/master/kaniko/kaniko.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/knative/build-templates/master/kaniko/kaniko.yaml</a></span></pre><p id="373a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要验证Knative Build安装，请执行以下操作。</p><pre class="mx my mz na gt nb mk nc nd aw ne bi"><span id="551f" class="ml lf it mk b gy nf ng l nh ni">kubectl get pods --namespace knative-build</span></pre><p id="2ef8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我鼓励分叉我的示例GitHub库<a class="ae kf" href="https://github.com/scranton/helloworld-knative" rel="noopener ugc nofollow" target="_blank">https://github.com/scranton/helloworld-knative</a>，这样你就可以推送代码变更并在你的环境中看到它们。</p><p id="f2e7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为你的Docker Hub帐户创建一个Kubernetes秘密，让Knative build推广你的形象。您还需要注释这个秘密，以表明它是为Docker准备的。更多详情请参见<a class="ae kf" href="https://www.knative.dev/docs/build/auth/#guiding-credential-selection" rel="noopener ugc nofollow" target="_blank">指导凭证选择</a>。</p><pre class="mx my mz na gt nb mk nc nd aw ne bi"><span id="5259" class="ml lf it mk b gy nf ng l nh ni">kubectl create secret generic basic-user-pass \<br/>  --type<strong class="mk iu">=</strong>"kubernetes.io/basic-auth" \<br/>  --from-literal<strong class="mk iu">=</strong>username<strong class="mk iu">=${</strong>DOCKER_USERNAME<strong class="mk iu">}</strong> \<br/>  --from-literal<strong class="mk iu">=</strong>password<strong class="mk iu">=${</strong>DOCKER_PASSWORD<strong class="mk iu">}</strong></span><span id="cf51" class="ml lf it mk b gy nj ng l nh ni">kubectl annotate secret basic-user-pass \<br/>  build.knative.dev/docker-0<strong class="mk iu">=</strong>https://index.docker.io/v1/</span></pre><p id="e5f9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它应该会产生如下所示的秘密。</p><pre class="mx my mz na gt nb mk nc nd aw ne bi"><span id="dce1" class="ml lf it mk b gy nf ng l nh ni">kubectl describe secret basic-user-pass</span><span id="3779" class="ml lf it mk b gy nj ng l nh ni">Name:         basic-user-pass<br/>Namespace:    default<br/>Labels:       &lt;none&gt;<br/>Annotations:  build.knative.dev/docker-0: https://index.docker.io/v1/</span><span id="8576" class="ml lf it mk b gy nj ng l nh ni">Type:  kubernetes.io/basic-auth</span><span id="f996" class="ml lf it mk b gy nj ng l nh ni">Data<br/><strong class="mk iu">====</strong><br/>username:  12 bytes<br/>password:  24 bytes</span></pre><p id="86af" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">用您的GitHub和Docker用户名更新<code class="fe mh mi mj mk b">service-build.yaml</code>。这个清单将使用Knative Build创建一个使用<code class="fe mh mi mj mk b">kaniko-build</code>构建模板的映像，并使用Knative Serving和Gloo部署服务。</p><pre class="mx my mz na gt nb mk nc nd aw ne bi"><span id="5f16" class="ml lf it mk b gy nf ng l nh ni">apiVersion: serving.knative.dev/v1alpha1<br/>kind: Service<br/>metadata:<br/>  name: helloworld-go<br/>  namespace: default<br/>spec:<br/>  runLatest:<br/>    configuration:<br/>      build:<br/>        apiVersion: build.knative.dev/v1alpha1<br/>        kind: Build<br/>        metadata:<br/>          name: kaniko-build<br/>        spec:<br/>          serviceAccountName: build-bot<br/>          source:<br/>            git:<br/>              url: https://github.com/{ GitHub username }/helloworld-knative<br/>              revision: master<br/>          template:<br/>            name: kaniko<br/>            arguments:<br/>              - name: IMAGE<br/>                value: docker.io/{ Docker Hub username }/helloworld-go<br/>          timeout: 10m<br/>      revisionTemplate:<br/>        spec:<br/>          container:<br/>            image: docker.io/{ Docker Hub username }/helloworld-go<br/>            imagePullPolicy: Always<br/>            env:<br/>              - name: TARGET<br/>                value: "Go Sample v1"</span></pre><p id="eef4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要进行部署，请应用清单。</p><pre class="mx my mz na gt nb mk nc nd aw ne bi"><span id="0a2e" class="ml lf it mk b gy nf ng l nh ni">kubectl apply \<br/>  --filename serviceaccount.yaml \<br/>  --filename service-build.yaml</span></pre><p id="08b1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，您可以观察构建和部署的进行。</p><pre class="mx my mz na gt nb mk nc nd aw ne bi"><span id="4431" class="ml lf it mk b gy nf ng l nh ni">kubectl get pods --watch</span></pre><p id="a322" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦你看到所有的<code class="fe mh mi mj mk b">helloworld-go-0000x-deployment-....</code>吊舱都准备好了，那么你可以Ctrl+C来逃离手表，然后测试你的部署。</p><p id="cf2c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">验证服务的域URL。应该是<code class="fe mh mi mj mk b">helloworld-go.default.example.com.</code></p><pre class="mx my mz na gt nb mk nc nd aw ne bi"><span id="865b" class="ml lf it mk b gy nf ng l nh ni">kubectl get kservice helloworld-go \<br/>  --namespace default \<br/>  --output<strong class="mk iu">=</strong>custom-columns<strong class="mk iu">=</strong>NAME:.metadata.name,DOMAIN:.status.domain</span></pre><p id="a1e6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并测试您的服务。</p><pre class="mx my mz na gt nb mk nc nd aw ne bi"><span id="8037" class="ml lf it mk b gy nf ng l nh ni">curl --connect-to helloworld-go.default.example.com:80:<strong class="mk iu">$(</strong>glooctl proxy address --name clusteringress-proxy<strong class="mk iu">)</strong> <a class="ae kf" href="http://helloworld-go.default.example.com" rel="noopener ugc nofollow" target="_blank">http://helloworld-go.default.example.com</a></span></pre><h2 id="1a45" class="ml lf it bd lg mm mn dn lk mo mp dp lo kr mq mr ls kv ms mt lw kz mu mv ma mw bi translated">清除</h2><pre class="mx my mz na gt nb mk nc nd aw ne bi"><span id="94b9" class="ml lf it mk b gy nf ng l nh ni">kubectl delete \<br/>  --filename serviceaccount.yaml \<br/>  --filename service-build.yaml</span><span id="42ee" class="ml lf it mk b gy nj ng l nh ni">kubectl delete secret basic-user-pass</span></pre><h1 id="a541" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">摘要</h1><p id="00b7" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">希望这篇文章能让你体会到Gloo和Knative如何合作，为你提供一种在Kubernetes中按需构建和部署服务的方法。</p><h1 id="c878" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">请参见</h1><ul class=""><li id="7e6e" class="nk nl it ki b kj mc kn md kr nm kv nn kz no ld np nq nr ns bi translated"><a class="ae kf" href="https://github.com/knative/docs/blob/master/install/getting-started-knative-app.md" rel="noopener ugc nofollow" target="_blank">https://github . com/knative/docs/blob/master/install/getting-started-knative-app . MD</a></li><li id="da98" class="nk nl it ki b kj nt kn nu kr nv kv nw kz nx ld np nq nr ns bi translated"><a class="ae kf" href="https://github.com/knative/docs" rel="noopener ugc nofollow" target="_blank">https://github.com/knative/docs</a></li><li id="b936" class="nk nl it ki b kj nt kn nu kr nv kv nw kz nx ld np nq nr ns bi translated"><a class="ae kf" href="https://gloo.solo.io/getting_started/kubernetes/gloo_with_knative/" rel="noopener ugc nofollow" target="_blank">https://gloo . solo . io/getting _ started/kubernetes/gloo _ with _ knative/</a></li></ul></div></div>    
</body>
</html>