<html>
<head>
<title>TypeScript Utilities For Candid</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于偷拍的类型脚本实用程序</h1>
<blockquote>原文：<a href="https://itnext.io/typescript-utilities-for-candid-bf5bdd92a9a3?source=collection_archive---------3-----------------------#2021-11-16">https://itnext.io/typescript-utilities-for-candid-bf5bdd92a9a3?source=collection_archive---------3-----------------------#2021-11-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="632d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">与罐智能协定交互时处理可空、日期和Blob的函数集合。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/363cd9315d8341d1a2f1c8aa5330ac1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-zlHKiCIag6cmR5WO2Z_RQ.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Georgie Cobbs 在<a class="ae ky" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="1e90" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">为了将我们的web编辑器<a class="ae ky" href="https://deckdeckgo.com/" rel="noopener ugc nofollow" target="_blank"> DeckDeckGo </a>移植到<a class="ae ky" href="https://dfinity.org/" rel="noopener ugc nofollow" target="_blank"> DFINITY </a>的互联网计算机上，我用TypeScript开发了几个助手来与我们的罐式智能合同进行交互。</p><p id="8658" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如果这也能让你的生活变得更容易，以下是我最常用的。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="2e05" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">可空的</h1><p id="5187" class="pw-post-body-paragraph lg lh it li b lj mu ju ll lm mv jx lo lp mw lr ls lt mx lv lw lx my lz ma mb im bi translated">为可空类型生成的<a class="ae ky" href="https://smartcontracts.org/docs/candid-guide/candid-concepts.html" rel="noopener ugc nofollow" target="_blank">坦率的</a>描述并不完全符合我通常在JavaScript中为可选类型使用的描述(参见这篇<a class="ae ky" href="https://forum.dfinity.org/t/candid-code-generation-for-nullable-types/6820" rel="noopener ugc nofollow" target="_blank">帖子</a>了解原因和方法)。</p><p id="7027" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">例如，如果我们为这样一个<a class="ae ky" href="https://smartcontracts.org/docs/language-guide/motoko.html" rel="noopener ugc nofollow" target="_blank"> Motoko </a>代码片段生成一个接口:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="cc5b" class="ne md it na b gy nf ng l nh ni">actor Example {<br/>  public shared query func list(filter: ?Text) : async [Text] {<br/>    let results: [Text] = myFunction(filter);<br/>    return results;<br/>  };<br/>}</span></pre><p id="8e44" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">可选参数<code class="fe nj nk nl na b">filter</code>的定义不会被解释为可能是<code class="fe nj nk nl na b">undefined</code>的<code class="fe nj nk nl na b">string</code>，而是包含<code class="fe nj nk nl na b">string</code>或为空的单元素长度<code class="fe nj nk nl na b">array</code>。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="a987" class="ne md it na b gy nf ng l nh ni">export interface _SERVICE {<br/>  list: (arg_0: [] | [string]) =&gt; Promise&lt;Array&lt;string&gt;&gt;;<br/>}</span></pre><p id="a847" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">这就是我创建函数来来回转换可选值的原因。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="7835" class="ne md it na b gy nf ng l nh ni">export const toNullable = &lt;T&gt;(value?: T): [] | [T] =&gt; {<br/>  return value ? [value] : [];<br/>};<br/><br/>export const fromNullable = &lt;T&gt;(value: [] | [T]): T | undefined =&gt; {<br/>  return value?.[0];<br/>};</span></pre><p id="38ef" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><code class="fe nj nk nl na b">toNullable</code>将类型为<code class="fe nj nk nl na b">T</code>或<code class="fe nj nk nl na b">undefined</code>的对象转换为预期与IC交互的对象，<code class="fe nj nk nl na b">fromNullable</code>执行相反的操作。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="8eb3" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">日期</h1><p id="ae3c" class="pw-post-body-paragraph lg lh it li b lj mu ju ll lm mv jx lo lp mw lr ls lt mx lv lw lx my lz ma mb im bi translated">系统<a class="ae ky" href="https://smartcontracts.org/docs/base-libraries/Time.html" rel="noopener ugc nofollow" target="_blank">时间</a>(自1970–01–01以来的纳秒数)被解析为<code class="fe nj nk nl na b">bigint</code>并作为类型<code class="fe nj nk nl na b">Time</code>导出。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="3748" class="ne md it na b gy nf ng l nh ni">export type Time = bigint;</span></pre><p id="2737" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">要将JavaScript <code class="fe nj nk nl na b">Date</code>转换成大数，可以通过将秒乘以纳秒来实例化内置对象<a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/BigInt" rel="noopener ugc nofollow" target="_blank"> BigInt </a>。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="317f" class="ne md it na b gy nf ng l nh ni">export const toTimestamp = (value: Date): Time =&gt; {<br/>  return BigInt(value.getTime() * 1000 * 1000);<br/>};</span></pre><p id="af52" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">反过来，首先将大数字转换成原始的<a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number" rel="noopener ugc nofollow" target="_blank">数字</a>类型，然后将它分成秒。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="2459" class="ne md it na b gy nf ng l nh ni">export const fromTimestamp = (value: Time): Date =&gt; {<br/>  return new Date(Number(value) / (1000 * 1000));<br/>};</span></pre><p id="db90" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">为了支持<code class="fe nj nk nl na b">Nullable</code>时间戳值，我还创建了以下助手，它们扩展了转换器并返回适当的可选数组。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="d543" class="ne md it na b gy nf ng l nh ni">export const toNullableTimestamp = (value?: Date): [] | [Time] =&gt; {<br/>  const time: number | undefined = value?.getTime();<br/>  return value &amp;&amp; !isNaN(time) ? [toTimestamp(value)] : [];<br/>};</span><span id="b8e9" class="ne md it na b gy nm ng l nh ni">export const fromNullableTimestamp = <br/>       (value?: [] | [Time]): Date | undefined =&gt; {<br/>  return !isNaN(parseInt(`${value?.[0]}`)) ? <br/>            fromTimestamp(value[0]) : undefined;<br/>};</span></pre></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="9c94" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">一滴</h1><p id="753d" class="pw-post-body-paragraph lg lh it li b lj mu ju ll lm mv jx lo lp mw lr ls lt mx lv lw lx my lz ma mb im bi translated">二进制<a class="ae ky" href="https://smartcontracts.org/docs/base-libraries/Blob.html" rel="noopener ugc nofollow" target="_blank">斑点</a>在Candid中被描述为<code class="fe nj nk nl na b">numbers</code>的<code class="fe nj nk nl na b">Array</code>。为了在智能契约中保存非类型化数据(假设用例允许这样的风险)，同时仍然在前端保留类型，我们可以<code class="fe nj nk nl na b">stringify</code>对象，将它们转换成blobs，并将它们的内容作为二进制数据包含在<code class="fe nj nk nl na b">ArrayBuffer</code>中。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="0491" class="ne md it na b gy nf ng l nh ni">export const toArray = <br/>       async &lt;T&gt;(data: T): Promise&lt;Array&lt;number&gt;&gt; =&gt; {<br/>  const blob: Blob = new Blob([JSON.stringify(data)], <br/>                         {type: 'application/json; charset=utf-8'});<br/>  return [...new Uint8Array(await blob.arrayBuffer())];<br/>};</span></pre><p id="fa03" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">要将<code class="fe nj nk nl na b">numbers</code>的<code class="fe nj nk nl na b">Array</code>转换回特定的对象类型，可以再次使用<a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/API/Blob" rel="noopener ugc nofollow" target="_blank"> Blob </a>类型，但这一次将使用文本转换来解析结果。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="adef" class="ne md it na b gy nf ng l nh ni">export const fromArray = <br/>       async &lt;T&gt;(data: Array&lt;number&gt;): Promise&lt;T&gt; =&gt; {<br/>  const blob: Blob = new Blob([new Uint8Array(data)], <br/>                         {type: 'application/json; charset=utf-8'});<br/>  return JSON.parse(await blob.text());<br/>};</span></pre><p id="610b" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">这两种转换都是异步的，因为与blob对象交互需要解析JavaScript中的承诺。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="5013" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">进一步阅读</h1><p id="4de9" class="pw-post-body-paragraph lg lh it li b lj mu ju ll lm mv jx lo lp mw lr ls lt mx lv lw lx my lz ma mb im bi translated">想了解更多我们的项目吗？以下是自从我们用互联网计算机开始这个项目以来，我发表的博文列表:</p><ul class=""><li id="053d" class="nn no it li b lj lk lm ln lp np lt nq lx nr mb ns nt nu nv bi translated"><a class="ae ky" href="https://medium.com/geekculture/bye-bye-amazon-google-hello-web-3-0-b01bfe8f8783" rel="noopener">再见亚马逊&amp;谷歌，你好Web 3.0 </a></li><li id="861a" class="nn no it li b lj nw lm nx lp ny lt nz lx oa mb ns nt nu nv bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/dynamically-import-esm-modules-from-a-cdn-5a6f741e2a1c">从CDN动态导入ESM模块</a></li><li id="4e2e" class="nn no it li b lj nw lm nx lp ny lt nz lx oa mb ns nt nu nv bi translated"><a class="ae ky" href="https://medium.com/geekculture/internet-computer-web-app-decentralized-database-architecture-8647d1a437b8" rel="noopener">互联网计算机:Web App分散数据库架构</a></li><li id="48e4" class="nn no it li b lj nw lm nx lp ny lt nz lx oa mb ns nt nu nv bi translated"><a class="ae ky" href="https://javascript.plainenglish.io/singleton-factory-patterns-with-typescript-59e5a405531e" rel="noopener ugc nofollow" target="_blank">单例&amp;工厂模式带打字稿</a></li><li id="fa8f" class="nn no it li b lj nw lm nx lp ny lt nz lx oa mb ns nt nu nv bi translated"><a class="ae ky" href="https://javascript.plainenglish.io/getting-started-with-the-internet-computer-web-hosting-b9b748350fc2" rel="noopener ugc nofollow" target="_blank">托管在互联网上的电脑</a></li><li id="f804" class="nn no it li b lj nw lm nx lp ny lt nz lx oa mb ns nt nu nv bi translated"><a class="ae ky" href="https://medium.com/geekculture/we-received-a-grant-to-port-our-web-app-to-the-internet-computer-7be64806565a" rel="noopener">我们收到了一笔赠款，将我们的网络应用移植到互联网计算机上</a></li></ul></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="7bf2" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">保持联络</h1><p id="3d7c" class="pw-post-body-paragraph lg lh it li b lj mu ju ll lm mv jx lo lp mw lr ls lt mx lv lw lx my lz ma mb im bi translated">为了跟随我们的冒险，你可以开始观看我们的<a class="ae ky" href="https://github.com/deckgo/deckdeckgo" rel="noopener ugc nofollow" target="_blank"> GitHub回购</a> ⭐️和<a class="ae ky" href="http://eepurl.com/hKeMLD" rel="noopener ugc nofollow" target="_blank">注册</a>加入测试者的名单。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="d993" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="0ebc" class="pw-post-body-paragraph lg lh it li b lj mu ju ll lm mv jx lo lp mw lr ls lt mx lv lw lx my lz ma mb im bi translated">我希望这篇简短的博文和几个实用程序对你开始使用互联网计算机有用，这真的是一项有趣的技术。</p><p id="fc1b" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">到无限和更远的地方！</p><p id="bd87" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">大卫</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="0c6e" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">你可以通过<a class="ae ky" href="https://twitter.com/daviddalbusco" rel="noopener ugc nofollow" target="_blank"> Twitter </a>或我的<a class="ae ky" href="https://daviddalbusco.com/" rel="noopener ugc nofollow" target="_blank">网站</a>联系我。</p><p id="907f" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">尝试使用<a class="ae ky" href="https://deckdeckgo.com/" rel="noopener ugc nofollow" target="_blank"> DeckDeckGo </a>制作下一张幻灯片。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><a href="https://deckdeckgo.com"><div class="gh gi ob"><img src="../Images/d1292e4858d9cdb834769a6424ed937f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*nhgp2wHjZCVHRxor.png"/></div></a></figure></div></div>    
</body>
</html>