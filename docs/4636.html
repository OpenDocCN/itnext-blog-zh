<html>
<head>
<title>Database Migrations with DbUp</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用DbUp进行数据库迁移</h1>
<blockquote>原文：<a href="https://itnext.io/database-migrations-with-dbup-ca57aa2b3a68?source=collection_archive---------3-----------------------#2020-08-10">https://itnext.io/database-migrations-with-dbup-ca57aa2b3a68?source=collection_archive---------3-----------------------#2020-08-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="7801" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">管理数据库模式可能是一个具有挑战性的问题。这也是一个没有放之四海而皆准的解决方案的领域(不确定是否真的适用于任何事情)。解决方案包括从手动脚本管理、特定于数据库供应商的选项(例如用于Microsoft SQL Server 的<a class="ae kl" href="https://docs.microsoft.com/en-us/sql/relational-databases/data-tier-applications/data-tier-applications" rel="noopener ugc nofollow" target="_blank"> DACPAC)到迁移。这篇文章将着眼于使用</a><a class="ae kl" href="https://github.com/DbUp/DbUp" rel="noopener ugc nofollow" target="_blank"> DbUp </a>的基于迁移的方法的选择之一。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/7c78cbae99eafa6a43c592a961b1f930.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*87O4KNn-kKGPaXqK.jpg"/></div></div></figure><h2 id="c9c5" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">样本数据库</h2><p id="65a9" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">我需要一个样本数据库，所以我找到了我的一个帖子，让<a class="ae kl" href="https://elanderson.net/2018/09/getting-a-sample-sql-server-database/" rel="noopener ugc nofollow" target="_blank">获得一个样本SQL Server数据库</a>，引导我下载并恢复微软的WideWorldImporters样本数据库。</p><h2 id="dfaf" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">DbUp控制台应用</h2><p id="582a" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">DbUp有多种使用方式，在这个例子中，我们将从. NET核心控制台应用程序中使用它。从终端使用以下命令在您希望应用程序所在的目录中创建新的控制台应用程序。</p><pre class="kn ko kp kq gt lw lx ly lz aw ma bi"><span id="ff65" class="ky kz iq lx b gy mb mc l md me">dotnet new console</span></pre><p id="f31c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们可以使用下面的命令将DbUp NuGet包添加到示例项目中。在这种情况下，我们使用的是SQL Server包，但是有很多针对数据库提供者的包，所以请安装适合您的包。</p><pre class="kn ko kp kq gt lw lx ly lz aw ma bi"><span id="5bff" class="ky kz iq lx b gy mb mc l md me">dotnet add package dbup-sqlserver</span></pre><p id="3e15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，在Visual Studio中打开项目(或任何编辑器，但在Visual Studio中设置此示例更容易)。在<strong class="jp ir">程序</strong>类中，用以下代码替换所有代码。我们将在下面看到一些代码。</p><pre class="kn ko kp kq gt lw lx ly lz aw ma bi"><span id="59d5" class="ky kz iq lx b gy mb mc l md me">using System;<br/>using System.Linq;<br/>using System.Reflection;<br/>using DbUp;<br/><br/>namespace DbupTest<br/>{<br/>    class Program<br/>    {<br/>        static int Main(string[] args)<br/>        {<br/>            var connectionString =<br/>                args.FirstOrDefault()<br/>                ?? "Server=localhost; Database=WideWorldImporters; Trusted_connection=true";<br/><br/>            var upgrader =<br/>                DeployChanges.To<br/>                             .SqlDatabase(connectionString)<br/>                             .WithScriptsEmbeddedInAssembly(Assembly.GetExecutingAssembly())<br/>                             .LogToConsole()<br/>                             .Build();<br/><br/>            var result = upgrader.PerformUpgrade();<br/><br/>            if (!result.Successful)<br/>            {<br/>                Console.ForegroundColor = ConsoleColor.Red;<br/>                Console.WriteLine(result.Error);<br/>                Console.ResetColor();<br/>#if DEBUG<br/>                Console.ReadLine();<br/>#endif                <br/>                return -1;<br/>            }<br/><br/>            Console.ForegroundColor = ConsoleColor.Green;<br/>            Console.WriteLine("Success!");<br/>            Console.ResetColor();<br/><br/>            return 0;<br/>        }<br/>    }<br/>}</span></pre><p id="3735" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面的代码试图将SQL Server的连接字符串从终端传递给应用程序的第一个参数中提取出来，如果没有参数传入，则返回硬编码的值。这对我们的示例非常有用，但是我建议不要在生产中使用后备值。当您认为您的迁移已经成功运行，但是由于回退值而在错误的数据库上运行时，这总是糟糕的一天。</p><pre class="kn ko kp kq gt lw lx ly lz aw ma bi"><span id="3e80" class="ky kz iq lx b gy mb mc l md me">var connectionString = <br/>    args.FirstOrDefault() <br/>    ?? "Server=localhost; Database=WideWorldImporters; Trusted_connection=true";</span></pre><p id="e9b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一部分是所有设置的地方，包括部署到哪个数据库，在哪里找到要运行的脚本，以及在哪里记录日志。DbUp在这方面提供了很多选项，我建议查看更多信息部分下的<a class="ae kl" href="https://dbup.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">文档</a>以了解详细信息。</p><pre class="kn ko kp kq gt lw lx ly lz aw ma bi"><span id="f325" class="ky kz iq lx b gy mb mc l md me">var upgrader =<br/>    DeployChanges.To<br/>                 .SqlDatabase(connectionString)<br/>                 .WithScriptsEmbeddedInAssembly(Assembly.GetExecutingAssembly())<br/>                 .LogToConsole()<br/>                 .Build();</span></pre><p id="b69b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，下面是针对数据库实际执行脚本的地方。</p><pre class="kn ko kp kq gt lw lx ly lz aw ma bi"><span id="d94f" class="ky kz iq lx b gy mb mc l md me">var result = upgrader.PerformUpgrade();</span></pre><p id="2555" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该函数的其余部分处理向控制台显示脚本运行的结果。</p><h2 id="265d" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">添加脚本</h2><p id="70d7" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">请记住，我们使用的是嵌入式脚本选项，因此DbUp将查找所有以'结尾的嵌入式文件。sql。我在项目中添加了一个脚本目录，这样脚本就不会弄乱项目的根目录，但这不是必需的。不要以为文件的命名方式会控制脚本的执行顺序，所以要确保预先建立一个好的命名约定。对于我们的示例，我在脚本目录中添加了一个名为<strong class="jp ir"> 0001-TestScript.sql </strong>的文件。由于我们使用的是嵌入式脚本提供程序，所以在添加文件后，我们转到其属性并将<strong class="jp ir">构建动作</strong>设置为<strong class="jp ir">嵌入式资源</strong>是<strong class="jp ir">的关键</strong>。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/ea8a208237e79da8210bc8048de4a74b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1184/format:webp/0*J9siAj7HgGKKYCp8.png"/></div></figure><p id="aca1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，脚本文件本身除了选择一个值之外不做任何事情。</p><h2 id="ed6a" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">尝试一下</h2><p id="9959" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">此时，我们可以在Visual Studio中点击Run，它将执行我们的新脚本。输出如下所示。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mg"><img src="../Images/280227b7c426b06a137cdb0a5317d794.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Z1PRaUUiiMEuHues.png"/></div></div></figure><p id="1718" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们再次运行应用程序，它会告诉我们不需要执行新的脚本。与我遇到的所有基于迁移的解决方案一样，DbUp使用数据库中的一个表来记录已经运行的迁移。DbUp的默认表是<strong class="jp ir"> SchemaVersion </strong>，它由Id、ScriptName和Applied列组成。给定这种结构，重要的是要记住，如果您重命名已经在数据库上执行的脚本，DbUp会将其视为不同的脚本，并再次执行它。</p><h2 id="cc6b" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">包扎</h2><p id="d93c" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">在DbUp的文档中有一个哲学部分，其中一点是数据库是一组转换的结果，而不仅仅是它的新状态与旧状态的对比。这一点是我为什么喜欢基于迁移的方法的关键。</p><p id="d1c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查看DbUp <a class="ae kl" href="https://dbup.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">文档</a>和GitHub <a class="ae kl" href="https://github.com/DbUp/DbUp" rel="noopener ugc nofollow" target="_blank"> repo </a>了解更多信息。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><p id="bc81" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mo">最初发表于</em> <a class="ae kl" href="https://elanderson.net/2020/08/database-migrations-with-dbup/" rel="noopener ugc nofollow" target="_blank"> <em class="mo">埃里克·安德森</em> </a> <em class="mo">。</em></p></div></div>    
</body>
</html>