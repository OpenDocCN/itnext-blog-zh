<html>
<head>
<title>ASP.NET Core with Dapper</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">衣冠楚楚的ASP.NET核心</h1>
<blockquote>原文：<a href="https://itnext.io/asp-net-core-with-dapper-e58ca796da2b?source=collection_archive---------5-----------------------#2019-02-03">https://itnext.io/asp-net-core-with-dapper-e58ca796da2b?source=collection_archive---------5-----------------------#2019-02-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="864d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">实体框架核心一直是我最近发表的许多文章的核心。我认为这将是一个很好的改变，尝试实体框架核心的替代方案之一，并尝试一下<a class="ae kl" href="https://github.com/StackExchange/Dapper" rel="noopener ugc nofollow" target="_blank"> Dapper </a>。</p><p id="bea5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我试图找到一个很好的例子来说明像Dapper这样的微ORM和像Entity Framework Core这样的完整ORM之间的区别，但是我找到的所有这些都以一个选项优于另一个选项而告终。我并不是想说一个比另一个好，而是想给我的工具箱增加一个新工具。</p><p id="b38f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">基本上，差异似乎可以归结为微型ORM提供的功能比完整ORM少得多，但性能却更高。哪个是正确的选择将因项目而异。</p><h2 id="df95" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">示例项目</h2><p id="10ae" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">我们将使用一个新的Razor Pages应用程序作为示例应用程序的起点。它目前没有任何数据库访问设置。样本的起点代码可以在<a class="ae kl" href="https://github.com/elanderson/ASP.NET-Core-Dapper/tree/17b768f583d0572f19e306b4402ca2d8020eda35" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="73ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将使用为我的<a class="ae kl" href="https://github.com/elanderson/ASP.NET-Core-Entity-Framework" rel="noopener ugc nofollow" target="_blank">实体框架示例项目</a>中的SQL Server示例创建的现有数据库。下面是从该示例项目生成的Contacts表，以防您想要手动生成该表。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="18ae" class="km kn iq lp b gy lt lu l lv lw">CREATE TABLE [dbo].[Contacts] (<br/>    [Id]         INT            IDENTITY (1, 1) NOT NULL,<br/>    [Name]       NVARCHAR (MAX) NULL,<br/>    [Address]    NVARCHAR (MAX) NULL,<br/>    [City]       NVARCHAR (MAX) NULL,<br/>    [Subregion]  NVARCHAR (MAX) NULL,<br/>    [PostalCode] NVARCHAR (MAX) NULL,<br/>    [Phone]      NVARCHAR (MAX) NULL,<br/>    [Email]      NVARCHAR (MAX) NULL,<br/>    [Timestamp]  ROWVERSION     NULL<br/>);</span></pre><h2 id="af77" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">添加Dapper Nuget包</h2><p id="a550" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">使用您最喜欢的方式添加NuGet包，添加对Dapper包的引用。我将使用Visual Studio右键单击项目并选择<strong class="jp ir"> Manage NuGet Packages </strong>来完成此操作。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi lx"><img src="../Images/9253ecab27f6a654f7efab1d9b84b9af.png" data-original-src="https://miro.medium.com/v2/resize:fit:794/format:webp/0*Fe8QiGLflkxMDuEy.png"/></div></div></figure><p id="a91c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在下一个屏幕上，从<strong class="jp ir">浏览</strong>选项卡使用<strong class="jp ir">搜索框</strong>搜索<strong class="jp ir"> Dapper </strong>。选择<strong class="jp ir"> Dapper </strong>包，点击<strong class="jp ir">安装</strong>。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi mf"><img src="../Images/dc70d27c72e07233261d02c6652de96e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*edk0n54tFjnlRmCh.png"/></div></div></figure><h2 id="05ce" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">添加连接字符串配置</h2><p id="cfcc" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">我们将把数据库连接字符串存储在<strong class="jp ir"> appsettings.json </strong>文件中。打开文件并添加一个<strong class="jp ir"> ConnectionString </strong>部分，其中的<strong class="jp ir"> DefaultConnection </strong>包含数据库连接字符串。这种精确的设置不是必需的，我只是按照实体框架基础项目的配置方式进行设置。以下是我的完整配置文件，新的部分在顶部。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="d53b" class="km kn iq lp b gy lt lu l lv lw">{<br/>  "ConnectionStrings": {<br/>    "DefaultConnection": "Your connection string"<br/>  },<br/>  "Logging": {<br/>    "LogLevel": {<br/>      "Default": "Warning"<br/>    }<br/>  },<br/>  "AllowedHosts": "*"<br/>}</span></pre><h2 id="b3b1" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">接触模型</h2><p id="15da" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">在<strong class="jp ir"> Models </strong>文件夹中添加一个<strong class="jp ir"> Contact </strong>类，用于表示我们的数据。下面是我将在这个例子中使用的完整模型类。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="6baa" class="km kn iq lp b gy lt lu l lv lw">public class Contact<br/>{<br/>    public int Id { get; set; }<br/>    public string Name { get; set; }<br/>    public string Address { get; set; }<br/>    public string City { get; set; }<br/>    public string Subregion { get; set; }<br/>    public string PostalCode { get; set; }<br/>    public string Phone { get; set; }<br/>    public string Email { get; set; }<br/>}</span></pre><h2 id="a4dc" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">测试设置</h2><p id="f8da" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">为了简单起见，除了作为运行Dapper相关代码的一种方式，我不会处理任何UI。因此，我们将使用索引页面的页面模块来运行示例代码。这绝不是最佳实践设置的示例，只是为了在最简单的设置中演示Dapper。</p><p id="d157" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是通过构造函数注入的应用程序配置的完整页面模型。此时通过的所有更改都将在<strong class="jp ir"> OnGet </strong>函数中。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="5d94" class="km kn iq lp b gy lt lu l lv lw">public class IndexModel : PageModel<br/>{<br/>    private readonly IConfiguration _configuration;<br/><br/>    public IndexModel(IConfiguration configuration)<br/>    {<br/>        _configuration = configuration;<br/>    }<br/><br/>    public void OnGet()<br/>    {<br/><br/>    }<br/>}</span></pre><h2 id="a7fe" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">使用Dapper</h2><p id="e839" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">Dapper提供了许多来自<strong class="jp ir"> IDbConnection </strong>接口的扩展方法。对于本例，我们将使用这些扩展来检查特定的联系人是否存在，如果不存在，则插入它，最后从数据库中选择该联系人。</p><p id="5607" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一步是打开一个连接。在这个例子中，我们使用的是SQL Server，但是Dapper并不在乎，它将与任何一个ADO.NET供应商合作。以下代码使用来自<strong class="jp ir"> appsettings.json </strong>的连接字符串打开一个SQL连接。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="8e82" class="km kn iq lp b gy lt lu l lv lw">using (var connection = new SqlConnection(_configuration.GetConnectionString("DefaultConnection")))<br/>{<br/>    connection.Open();<br/>}</span></pre><p id="8af9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们将在Contacts表中查询特定联系人的ID。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="7988" class="km kn iq lp b gy lt lu l lv lw">if (connection.QueryFirstOrDefault&lt;int?&gt;(@"SELECT Id <br/>                                           FROM Contacts <br/>                                           WHERE Name = @Name",<br/>                                         new {Name = "Charlie Plumber"}) == null)<br/>{<br/>}</span></pre><p id="8eb8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如你从上面看到的，你所写的SQL没有什么特别的。对于这个查询，我们使用一个匿名类型将查询传递给一个名称过滤器，该过滤器将被转换为一个<strong class="jp ir"> SqlParameter </strong>以确保查询不会像SQL注入一样。请注意，SQL字符串中的参数名必须与传递给查询的对象的相应属性名相匹配。</p><p id="5831" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一个例子是contact insert，如果在前面的查询中没有找到该联系人。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="4f51" class="km kn iq lp b gy lt lu l lv lw">connection.Execute(@"INSERT INTO Contacts (Name, Address, City, Subregion, Email)<br/>                     VALUES (@Name, @Address, @City, @Subregion, @Email)",<br/>                   new Contact<br/>                   {<br/>                       Name = "Charlie Plumber",<br/>                       Address = "123 Main St",<br/>                       City = "Nashville",<br/>                       Subregion = "TN",<br/>                       Email = "cplumber@fake.com"<br/>                   });</span></pre><p id="c388" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">同样，SQL正是您所期望的，如果您熟悉SQL，这是Dapper的一个伟大之处。</p><p id="962a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后一个示例是前面所有示例的组合，其中一个select用于获取相关联系人的详细联系信息。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="0b81" class="km kn iq lp b gy lt lu l lv lw">using (var connection = new SqlConnection(_configuration.GetConnectionString("DefaultConnection")))<br/>{<br/>    connection.Open();<br/><br/>    if (connection<br/>           .QueryFirstOrDefault&lt;int?&gt;(@"SELECT Id <br/>                                        FROM Contacts <br/>                                        WHERE Name = @Name",<br/>                                      new {Name = "Charlie Plumber"}) == null)<br/>    {<br/>        connection.Execute(@"INSERT INTO Contacts (Name, Address, City, <br/>                                                   Subregion, Email) <br/>                             VALUES (@Name, @Address, @City, <br/>                                     @Subregion, @Email)",<br/>                           new Contact<br/>                           {<br/>                               Name = "Charlie Plumber",<br/>                               Address = "123 Main St",<br/>                               City = "Nashville",<br/>                               Subregion = "TN",<br/>                               Email = "cplumber@fake.com"<br/>                           });<br/>    }<br/><br/>    var charile = <br/>      connection.QueryFirstOrDefault&lt;Contact&gt;(@"SELECT Id, Name, Address, <br/>                                                       City, Subregion, Email <br/>                                                FROM Contacts <br/>                                                WHERE Name = @Name",<br/>                                              new {Name = "Charlie Plumber"});<br/>}</span></pre><h2 id="9adb" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">包扎</h2><p id="7843" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">和达帕的第一轮比赛很有趣。我在日常工作中写了很多SQL，所以看到显式的SQL和完整ORM的魔力还是挺不错的。我可以告诉你，通过做这个示例，我会想念Entity Framework的数据库创建和迁移功能。</p><p id="b45b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最终状态的代码可以在这里找到<a class="ae kl" href="https://github.com/elanderson/ASP.NET-Core-Dapper/tree/bbdd6da0eb88b6186035223de0b11724d8c29a5a" rel="noopener ugc nofollow" target="_blank"/>。</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><p id="0032" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mn">最初发表于</em> <a class="ae kl" href="https://elanderson.net/2019/02/asp-net-core-with-dapper/" rel="noopener ugc nofollow" target="_blank"> <em class="mn">埃里克·安德森</em> </a> <em class="mn">。</em></p></div></div>    
</body>
</html>