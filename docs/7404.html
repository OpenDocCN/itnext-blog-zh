<html>
<head>
<title>Administering clusters via Databricks API — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Databricks API管理集群—第1部分</h1>
<blockquote>原文：<a href="https://itnext.io/administering-clusters-via-databricks-api-342f5463378c?source=collection_archive---------1-----------------------#2022-09-13">https://itnext.io/administering-clusters-via-databricks-api-342f5463378c?source=collection_archive---------1-----------------------#2022-09-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="39b1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为管道和工作流构建预定义的集群变得很容易。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/7aa1cbf8aaf1b4aec7b465eb3cf3018c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Movu0uQNMlwdlEhUwGomLg.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated"><a class="ae lb" href="https://unsplash.com/@joetography?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">乔·杜德克</a>在<a class="ae lb" href="https://unsplash.com/s/photos/bricks?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="e33a" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">介绍</h1><p id="fecf" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">Databricks是一家站在大数据行业前沿的数据和AI公司。创新是平台的核心。Databricks platform擅长管理来自不同数据源的复杂集成，只需几次输入和鼠标点击。</p><p id="7912" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Databricks上的大量API端点可以与平台通信并执行联合功能。当有效地实现这些功能以促进业务增长时，它们将具有巨大的价值。</p><p id="5c53" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Databricks API的存在背后的动机是让团队以编程方式创作和管理他们的工作流，以执行一组不同的用例，并记录API返回的所有关键信息。</p><p id="7ca7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">API可以成为Databricks平台开发人员的强大工具。这个API为团队提供了开箱即用的广泛的项目交付产品。</p><p id="1c7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章是我们可以通过添加API组来扩展功能，从而开发复杂的管道/工作流的基础框架。本文的范围围绕着您(Databricks用户/开发人员)如何利用API组来处理特定于业务的用例。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/b38a57ef9568de9b3a32e8ae6e9c5795.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/format:webp/1*o_5QOE5KGFdk4v6-AvWhrg.png"/></div></figure><h1 id="4961" class="lj lk iq bd ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc mr me mf mg bi translated">先决条件</h1><p id="7583" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated"><strong class="jp ir"> 1。数据块的访问令牌。</strong></p><p id="ceb3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">令牌是访问Databricks API和查询端点的一种方式，也是一种推荐的身份验证选择。</p><p id="f351" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在UI中生成访问令牌的步骤:</p><p id="1fb2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">设置~访问令牌~创建新令牌</strong></p><p id="8f50" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 2。配置Databricks CLI。</strong></p><p id="47c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Databricks-CLI是一个位于所有API组之上的交互式shell，提供了与API命令组通信的通道。我们可以选择配置我们的资源，通过Databricks-CLI与平台上的隔离环境进行通信。</p><p id="ea4b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要配置令牌，您需要一台主机和一个令牌。我建议加<code class="fe ms mt mu mv b">--profile</code>标志，区分工作区和多个环境。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mw"><img src="../Images/7481338edf32b9ead9a11e701c80ce72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OpETlqa063xP0FDw5e1KdQ.png"/></div></div></figure><p id="0e1a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ms mt mu mv b">.databrickscfg</code>是本地保存配置的地方。Databricks-CLI在对端点进行API调用时会引用这些配置。</p><h1 id="8772" class="lj lk iq bd ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc mr me mf mg bi translated">集群API</h1><p id="27d1" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">Databricks平台运行在基于Databricks API构建的基础上。UI上的每一个可用特性都会在后台触发API来执行这项工作。</p><p id="5584" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Databricks提供的API组之一是集群API组，使用集群API的唯一目的是从管理级别管理集群，如以编程方式创建、列出、修改和删除。</p><h2 id="cd39" class="mx lk iq bd ll my mz dn lp na nb dp lt jy nc nd lx kc ne nf mb kg ng nh mf ni bi translated">创建集群:</h2><p id="426b" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">该特性可通过2.0版API调用api/2.0/clusters/create获得。端点需要完成操作的强制部分、带有访问令牌的头部和JSON有效负载(节点数量、策略、配置和其他特定于环境的信息)。</p><p id="478b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">集群创建的签名如下:</p><pre class="km kn ko kp gt nj mv nk nl aw nm bi"><span id="cda0" class="mx lk iq mv b gy nn no l np nq">curl --netrc -X POST --header "Authorization: Bearer your_token"<br/>https://dbc-a1b2345c-d6e7.cloud.databricks.com/api/2.0/clusters/create <br/>--data @create-cluster.json</span></pre><p id="ea8e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用承载访问令牌和JSON有效负载向平台提交POST调用。如果返回代码为200，则接收cluster_id的JSON响应，如果不成功，则返回详细的错误跟踪。</p><p id="b356" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们使用选择的编程语言:Python来重写curl命令。通过查看curl命令，我们需要传递数据和头。让我们打开配置文件并阅读。最好将变量中的输入模块化，以便在POST调用中传递它们。</p><pre class="km kn ko kp gt nj mv nk nl aw nm bi"><span id="0639" class="mx lk iq mv b gy nn no l np nq">import requests</span><span id="cea6" class="mx lk iq mv b gy nr no l np nq">json_file = "configs/policy.json"<br/>config_file = open(json_file, 'r')<br/>header = {'Authorization': 'Bearer your_token'}<br/>response = requests.post('https://dbr_url/api/2.0/clusters/create',<br/>                          data=config_file, headers=header)</span></pre><p id="01c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">响应:</strong></p><pre class="km kn ko kp gt nj mv nk nl aw nm bi"><span id="0b4a" class="mx lk iq mv b gy nn no l np nq">{"cluster_id": 1234-ax908t6-foods123}</span></pre><h2 id="d4d8" class="mx lk iq bd ll my mz dn lp na nb dp lt jy nc nd lx kc ne nf mb kg ng nh mf ni bi translated">删除集群</h2><p id="8046" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">如果在作业完成后不关闭Databricks使用的按需集群，它们的成本会很快变得很高。通过在操作完成后终止群集，我们可以控制我们的计算成本。如果管理不当，集群创建可能会导致意外成本和意外行为。正如我们已经看到的，可以创建和删除集群。我们可以在操作之间增加等待时间，为集群提供更多功能，并在作业完成时终止。</p><p id="1af7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我们需要手动启动和关闭几个集群时，这个操作很快就会变得非常耗时和昂贵。通过删除所有集群，可以节省时间和成本。</p><p id="3f53" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">集群删除API的签名如下:</p><pre class="km kn ko kp gt nj mv nk nl aw nm bi"><span id="3c56" class="mx lk iq mv b gy nn no l np nq">curl --netrc -X POST "Authorization: Bearer your_token"<br/>https://dbc-a1b2345c-d6e7.cloud.databricks.com/api/2.0/clusters/delete <br/>--data '{ "cluster_id": "1234-ax908t6-foods123" }'</span></pre><p id="54f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将curl重写为python，并将收集的集群id作为JSON数据显式传递，</p><pre class="km kn ko kp gt nj mv nk nl aw nm bi"><span id="5d6d" class="mx lk iq mv b gy nn no l np nq">data = {"cluster_id": 1234-567890-foods123}<br/>header = {'Authorization': 'Bearer {}'.format(self.token)}<br/>response = requests.post('https://dbr_url/api/2.0/clusters/delete',<br/>                           headers=header, json=data)</span></pre><p id="e889" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的策略是有效的，但它是不安全和不灵活的。需要手动收集cluster_id，并在下一个API调用中传递它们。</p><p id="9283" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过将我们的方法封装到一个类中，我们可以添加类似列表的数据集合，并收集迭代的返回值以调用后续操作。</p><h2 id="4e12" class="mx lk iq bd ll my mz dn lp na nb dp lt jy nc nd lx kc ne nf mb kg ng nh mf ni bi translated">完全码</h2><p id="3de8" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">将完整的操作包装到一个类中可以提供代码结构、安全性和对象隔离。</p><p id="bc5c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的项目结构如下:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/d11ae78f0d737fcf575aae7ae0702325.png" data-original-src="https://miro.medium.com/v2/resize:fit:332/format:webp/1*V7MajZipaG80RFx8LMnC0w.png"/></div></figure><p id="3a15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用python的configparser库来获取配置，以保持安全性最佳实践，并避免硬编码秘密。</p><pre class="km kn ko kp gt nj mv nk nl aw nm bi"><span id="e241" class="mx lk iq mv b gy nn no l np nq">import logging<br/>import requests<br/>from configparser import ConfigParser</span><span id="133f" class="mx lk iq mv b gy nr no l np nq">class databricks_AV(object):</span><span id="d9b5" class="mx lk iq mv b gy nr no l np nq">   def __init__(self, url, token) -&gt; Any:<br/>       self.url = url<br/>       self.token = token<br/>       self.cluster_id_list = []</span><span id="f50e" class="mx lk iq mv b gy nr no l np nq">   def cluster_creation(self):<br/>       config_json = "configs/policy.json"<br/>       config_file = open(config_json, 'r')<br/>       header = {'Authorization': 'Bearer {}'.format(self.token)}<br/>       response = requests.post(f'https://{self.url}/api/2.0/clusters/create',<br/>                                 data=config_file, headers=header)<br/>       cluster_id = response.json()['cluster_id']<br/>       self.cluster_id_list.append(cluster_id)<br/>       creation_status = response.text<br/>       logging.info(creation_status)<br/>       logging.info(self.cluster_id_list)<br/>       return response</span><span id="04f4" class="mx lk iq mv b gy nr no l np nq">   def cluster_deletion(self):<br/>       for id in self.cluster_id_list:<br/>       data = {"cluster_id": id}<br/>       header = {'Authorization': 'Bearer {}'.format(self.token)}<br/>       response = requests.post(f'https://{self.url}/api/2.0/clusters/delete',<br/>                                 headers=header, json=data)<br/>       deletion_status = response.text<br/>       logging.info(deletion_status)<br/>       return response</span><span id="a233" class="mx lk iq mv b gy nr no l np nq">if __name__ == '__main__':<br/>   parser = ConfigParser()<br/>   parser.read('properties.cfg')<br/>   AV = databricks_AV(parser.get('URL','dev_url'), parser.get('TOKEN','dev_token'))<br/>   AV.cluster_creation()<br/>   AV.cluster_deletion()</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nt"><img src="../Images/c66219dbc62acde9e028e39d839e337c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pGMJilqYKEOBYT-gg8ezkg.png"/></div></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nu"><img src="../Images/0159711afd153d27c58b5c24830c7cef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DPUGg3Iqcd19F85YU1cUHg.png"/></div></div></figure><h1 id="3f4c" class="lj lk iq bd ll lm mn lo lp lq mo ls lt lu mp lw lx ly mq ma mb mc mr me mf mg bi translated">结论</h1><p id="37c1" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">我们已经讨论了平台的主要部分，它处理所有的重物。所有的处理和计算都在集群中完成，集群构成了它的中枢。当您的基础设施包括工作流和自动化管道时，按需启动集群并关闭它们将是一个富有成效的步骤。平台开发人员可以拓宽他们对Databricks API如何工作以及端点如何相关的内部理解。</p><ul class=""><li id="cf3f" class="nv nw iq jp b jq jr ju jv jy nx kc ny kg nz kk oa ob oc od bi translated">配置是API连接的关键，标记概要文件有助于分解基于工作区的开发。</li><li id="e97f" class="nv nw iq jp b jq oe ju of jy og kc oh kg oi kk oa ob oc od bi translated">通过API组，我们能够按需创建和删除集群。通过将代码包装到类中以实现可重用性，从而将代码模块化。</li><li id="a45e" class="nv nw iq jp b jq oe ju of jy og kc oh kg oi kk oa ob oc od bi translated">端点从平台返回详细的响应，我们使用python JSON库对这些响应进行解析，并在类定义中使用配置解析从安全角度获取令牌和URL。</li></ul><p id="d7dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在LinkedIn或T2 Twitter上关注我，了解更多关于DataOps和MLOps相关的参考资料，如果你想了解这个框架或为其添加更多功能，请联系我。</p><p id="988e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">快乐编码。</p></div></div>    
</body>
</html>