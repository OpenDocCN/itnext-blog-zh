<html>
<head>
<title>Elasticsearch Backup using SLM and Restore with Amazon S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用SLM进行弹性搜索备份，使用亚马逊S3进行恢复</h1>
<blockquote>原文：<a href="https://itnext.io/elasticsearch-backup-using-slm-and-restore-on-amazon-s3-c42bd0c0fd26?source=collection_archive---------5-----------------------#2019-12-24">https://itnext.io/elasticsearch-backup-using-slm-and-restore-on-amazon-s3-c42bd0c0fd26?source=collection_archive---------5-----------------------#2019-12-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/9314d06785f24bcf9aae48abb7334949.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UWRC_yNe5XvZ3WhUw8nqBw.png"/></div></div></figure><p id="5b84" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将备份存储在生产服务器上的中并不是一个好主意。最好使用云数据存储服务，如AWS S3或其他一些服务。你也可以使用迷你像开源自托管对象存储与ZFS。我将演示如何将Elasticsearch数据备份到S3，并在其上创建保留策略。正如我之前提到的，我使用了两个脚本来管理s3中的备份生命周期，一个用于创建快照，另一个用于删除旧快照。但是快照生命周期管理(SLM)是Elasticsearch 7.5版本的一大特色。在这篇文章中，演示了如何配置S3和管理备份的生命周期。如果你想安装Elasticsearch并对其进行配置，只需遵循之前的<a class="ae kw" href="https://medium.com/@jasmedia/elasticsearch-backups-lifecycle-management-with-slm-8268366553a8" rel="noopener">文档</a>即可。</p><h1 id="763c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">创建S3存储桶</h1><p id="5cc5" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我希望你已经为S3创建了一个AWS帐户和IAM用户凭证。因此，让我们从创建一个S3存储桶来存储弹性搜索快照开始。转到AWS S3服务页面，单击“创建存储桶”按钮，为存储桶设置一个名称，然后按照步骤操作。</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ma"><img src="../Images/e17c044090c09fd8cd02e864cb0c00ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U1yqwE0Kw9BuhbnhrymhQA.png"/></div></div></figure><h1 id="0a95" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">在Elasticsearch密钥库中配置S3访问权限</h1><p id="2a98" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">接下来，将IAM用户凭证设置为Elasticsearch密钥库，以访问我们已经创建的S3存储桶。使用以下命令设置这些凭据。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="e44f" class="mk ky iq mg b gy ml mm l mn mo">bin/elasticsearch-keystore add s3.client.default.access_key<br/>bin/elasticsearch-keystore add s3.client.default.secret_key</span></pre><h1 id="84d5" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">安装S3插件</h1><p id="6259" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">您需要安装Elasticsearch s3-repository插件，只需运行命令:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="d735" class="mk ky iq mg b gy ml mm l mn mo">bin/elasticsearch-plugin install repository-s3</span></pre><p id="0211" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以检查是否安装了repository-s3。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="650d" class="mk ky iq mg b gy ml mm l mn mo">curl -X GET "localhost:9200/_cat/plugins?v&amp;s=component&amp;h=component,version,description&amp;pretty"</span></pre><p id="dd15" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">回答应该是这样的:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="977c" class="mk ky iq mg b gy ml mm l mn mo">component version description<br/>repository-s3 7.5.0 The S3 repository plugin adds S3 repositories</span></pre><h1 id="e0fe" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">配置备份存储库</h1><p id="76dd" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">使用s3存储桶设置备份存储库。</p><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="1a65" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">响应应为“已确认”:如果存储库创建成功，则为true。</p><h1 id="f796" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">配置SLM策略</h1><p id="5841" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">之后，在其上设置s3快照生命周期管理策略。设置备份时间、快照名称、存储库、索引和保留策略。</p><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="ff37" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，运行命令立即备份到s3。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="c1bf" class="mk ky iq mg b gy ml mm l mn mo">curl -X POST "localhost:9200/_slm/policy/my-s3-snapshots/_execute?pretty"</span></pre><p id="63ef" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果成功，您将获得带有快照名称的响应。你的S3水桶看起来像:</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mr"><img src="../Images/bf11d00a88ddc831bcc379ebdb0c84bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AMALMY6Z2khJ-qkHbPDhCw.png"/></div></div></figure><p id="3190" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们可以检查策略了。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="0bd9" class="mk ky iq mg b gy ml mm l mn mo">curl -X GET "localhost:9200/_slm/policy/my-s3-snapshots?human&amp;pretty"</span></pre><p id="4fe9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">答案应该是:</p><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="156e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该响应包含拍摄的快照数量、下一次快照时间以及SLM策略的许多其他详细信息。</p><h1 id="b57b" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">从快照恢复</h1><p id="e279" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">您将获得完整的快照列表，并记下您要恢复的快照名称。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="f683" class="mk ky iq mg b gy ml mm l mn mo">curl -X GET “localhost:9200/_snapshot/my_s3_repository/_all?pretty”</span></pre><p id="60a1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从Elasticsearch集群中删除一个索引以测试恢复过程。</p><p id="26fa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，列出集群中可用的索引。</p><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="09cd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">删除用于演示s3备份恢复的索引“hastags”。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="b7d2" class="mk ky iq mg b gy ml mm l mn mo">curl -X DELETE "localhost:9200/hashtags?pretty"</span></pre><p id="4354" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">只需运行上面的indices list命令来验证删除。现在是运行恢复命令的时候了:</p><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="5230" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果要将数据恢复到新的集群中，则不需要指定索引名称。否则，如果Elasticsearch集群中已经有一些可用的索引，您将得到一个错误消息“同名索引已经存在”。</p><p id="ed10" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，再次使用index list命令验证索引恢复。您可以看到索引恢复前后uuid的差异。</p><figure class="mb mc md me gt jr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="9125" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是在Elasticsearch上管理备份生命周期的最酷的方法。您还可以使用Kibana来配置生命周期策略。您可以使用上述存储库配置直接将快照恢复到新的Elasticsearch集群。</p><p id="bd7a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">干杯，</p></div></div>    
</body>
</html>