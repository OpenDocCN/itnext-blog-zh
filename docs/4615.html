<html>
<head>
<title>How to Build a Serverless Apollo GraphQL Server with AWS Lambda, Webpack and TypeScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用AWS Lambda、Webpack和TypeScript构建一个无服务器的Apollo GraphQL服务器</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-build-a-serverless-apollo-graphql-server-with-aws-lambda-webpack-and-typescript-64a377739208?source=collection_archive---------0-----------------------#2020-08-05">https://itnext.io/how-to-build-a-serverless-apollo-graphql-server-with-aws-lambda-webpack-and-typescript-64a377739208?source=collection_archive---------0-----------------------#2020-08-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/d81e6d03d1f9d29c21af8db793614824.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eqd5IINl2uTIGkdA4po_oQ.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">Hawaiʻi莫纳克亚山的星空(图片来源:<a class="ae kf" href="http://http://derekfong.me" rel="noopener ugc nofollow" target="_blank">方志伟</a></figcaption></figure><p id="1263" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我之前的文章中，我已经展示了<a class="ae kf" href="https://medium.com/free-code-camp/build-an-apollo-graphql-server-with-typescript-and-webpack-hot-module-replacement-hmr-3c339d05184f" rel="noopener">如何用<a class="ae kf" href="https://medium.com/better-programming/how-to-integrate-an-apollo-graphql-server-with-mongodb-and-typescript-code-generator-b029d821591" rel="noopener">一些我在开发阶段发现有用的常用工具集</a>构建一个“Hello World”Apollo graph QL服务器</a>。我希望您已经了解了我们的GraphQL之旅，现在到了您的Apollo服务器可以部署的时候了！</p><h1 id="4723" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">服务器或无服务器—交易是什么？</h1><figure class="md me mf mg gt ju gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/375746cab89aeef2f0dfcbcfcb426985.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/format:webp/1*LAuBD6ZqBqhNo_bllBHjHw.jpeg"/></div></figure><p id="f97b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为什么没有服务器？这可能是您公司的解决方案架构师为您即将到来的项目做出的决定，或者您听到了关于“现代无服务器方法”的<a class="ae kf" href="https://hackernoon.com/what-is-serverless-architecture-what-are-its-pros-and-cons-cc4b804022e9" rel="noopener ugc nofollow" target="_blank">好(或坏)</a>的事情，并且只是想尝试一下……无论您的理由是什么，我都会为您提供帮助😉</p><h1 id="85aa" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">步骤1:设置AWS环境</h1><p id="613e" class="pw-post-body-paragraph kg kh it ki b kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ml lb lc ld im bi translated">在开始动手编写代码之前，您需要在您的计算机上进行一些配置。我不得不说这一步并不有趣。也就是说，正确设置我们的部署配置至关重要，如果您遵循下面的关键步骤，完成配置应该不会花费太长时间。</p><p id="3453" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将在<a class="ae kf" href="https://aws.amazon.com/" rel="noopener ugc nofollow" target="_blank">亚马逊网络服务(AWS) </a>上部署我们的Apollo服务器。<a class="ae kf" href="https://portal.aws.amazon.com/billing/signup" rel="noopener ugc nofollow" target="_blank">创建一个AWS账户</a>，如果你还没有的话。虽然AWS是一个提供<a class="ae kf" href="https://aws.amazon.com/pricing" rel="noopener ugc nofollow" target="_blank">付费服务</a>的平台，但它也在<a class="ae kf" href="https://aws.amazon.com/free" rel="noopener ugc nofollow" target="_blank"> AWS免费层</a>下提供大量的免费使用，这应该足以涵盖本文中的使用。也就是说，您仍然需要了解<a class="ae kf" href="https://aws.amazon.com/pricing" rel="noopener ugc nofollow" target="_blank">定价</a>，并考虑<a class="ae kf" href="https://aws.amazon.com/premiumsupport/knowledge-center/free-tier-charges" rel="noopener ugc nofollow" target="_blank">制定计划来管理服务和消耗的资源</a>以<a class="ae kf" href="https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/checklistforunwantedcharges" rel="noopener ugc nofollow" target="_blank">避免意外费用</a>。</p><p id="a57b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦你设置好AWS账户，你需要<a class="ae kf" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install" rel="noopener ugc nofollow" target="_blank">在你的电脑上安装最新版本的AWS CLI </a>。安装完成后，您可以通过运行<code class="fe mm mn mo mp b">aws</code>命令来验证安装。例如，以下命令返回您计算机上安装的当前AWS CLI版本:</p><pre class="md me mf mg gt mq mp mr ms aw mt bi"><span id="165f" class="mu lf it mp b gy mv mw l mx my">$ aws --version</span><span id="6af1" class="mu lf it mp b gy mz mw l mx my">aws-cli/2.0.23 Python/3.7.4 Darwin/18.7.0 botocore/2.0.0</span></pre><p id="18e0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，您需要<a class="ae kf" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html" rel="noopener ugc nofollow" target="_blank">使用用户凭证配置AWS CLI</a>。基本上，您需要做的就是运行<code class="fe mm mn mo mp b">aws configure</code>命令，它会提示您输入四条信息:</p><ul class=""><li id="4262" class="na nb it ki b kj kk kn ko kr nc kv nd kz ne ld nf ng nh ni bi translated"><a class="ae kf" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html#cli-configure-quickstart-creds" rel="noopener ugc nofollow" target="_blank">访问密钥ID </a></li><li id="8ca9" class="na nb it ki b kj nj kn nk kr nl kv nm kz nn ld nf ng nh ni bi translated"><a class="ae kf" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html#cli-configure-quickstart-creds" rel="noopener ugc nofollow" target="_blank">秘密访问密钥</a></li><li id="be70" class="na nb it ki b kj nj kn nk kr nl kv nm kz nn ld nf ng nh ni bi translated"><a class="ae kf" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html#cli-configure-quickstart-region" rel="noopener ugc nofollow" target="_blank"> AWS区域</a></li><li id="732e" class="na nb it ki b kj nj kn nk kr nl kv nm kz nn ld nf ng nh ni bi translated"><a class="ae kf" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html#cli-configure-quickstart-format" rel="noopener ugc nofollow" target="_blank">输出格式</a></li></ul><p id="a4f7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">按照本<a class="ae kf" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart" rel="noopener ugc nofollow" target="_blank">快速入门指南</a>获取AWS CLI所需的值。<strong class="ki iu">作为</strong> <a class="ae kf" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#lock-away-credentials" rel="noopener ugc nofollow" target="_blank"> <strong class="ki iu">的最佳实践</strong> </a> <strong class="ki iu">，请务必在您</strong> <a class="ae kf" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/getting-started_create-admin-group.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ki iu">创建管理员IAM用户和组</strong> </a> <strong class="ki iu">时创建访问键。</strong></p><pre class="md me mf mg gt mq mp mr ms aw mt bi"><span id="0bed" class="mu lf it mp b gy mv mw l mx my">$ aws configure</span><span id="4ea3" class="mu lf it mp b gy mz mw l mx my">AWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLE<br/>AWS Secret Access Key [None]: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY<br/>Default region name [None]: us-west-2<br/>Default output format [None]: json</span></pre><p id="797d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">AWS CLI将此信息存储在凭证文件中名为<code class="fe mm mn mo mp b">default</code>的<a class="ae kf" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-profiles" rel="noopener ugc nofollow" target="_blank">配置文件</a>(一组设置)中。默认情况下，当您运行一个没有明确指定要使用的配置文件的<code class="fe mm mn mo mp b">aws</code> CLI命令时，会使用该配置文件中的信息。您可以通过运行<code class="fe mm mn mo mp b">aws configure list</code>命令来检查当前的配置数据:</p><pre class="md me mf mg gt mq mp mr ms aw mt bi"><span id="6776" class="mu lf it mp b gy mv mw l mx my">$ aws configure list</span><span id="e1fd" class="mu lf it mp b gy mz mw l mx my">Name                    Value             Type    Location</span><span id="3c44" class="mu lf it mp b gy mz mw l mx my">----                    -----             ----    --------</span><span id="ab19" class="mu lf it mp b gy mz mw l mx my">profile                &lt;not set&gt;             None    None</span><span id="26de" class="mu lf it mp b gy mz mw l mx my">access_key     ****************ABCD      config_file    ~/.aws/config</span><span id="b397" class="mu lf it mp b gy mz mw l mx my">secret_key     ****************ABCD      config_file    ~/.aws/config</span><span id="7ad2" class="mu lf it mp b gy mz mw l mx my">region                us-west-2              env    AWS_DEFAULT_REGION</span></pre><figure class="md me mf mg gt ju gh gi paragraph-image"><div class="gh gi no"><img src="../Images/aab9d087363efc2d8990169fe12b5be3.png" data-original-src="https://miro.medium.com/v2/resize:fit:952/format:webp/1*e3AWQ6qMLAACf75ZTrgsAg.jpeg"/></div></figure><p id="19cf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">唷~就是这样！您的计算机现在已设置为与AWS交互。</p><h1 id="e053" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">第二步:安装<code class="fe mm mn mo mp b">apollo-server-lambda</code></h1><figure class="md me mf mg gt ju gh gi paragraph-image"><div class="gh gi np"><img src="../Images/0f45761b95b3b741e6132967c7831242.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*bku2p1PhzcBBj-azpri-xw.jpeg"/></div></figure><p id="fac1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">创建一个名为<code class="fe mm mn mo mp b">demo-apollo-server-lambda</code>的新文件夹，初始化项目并安装<code class="fe mm mn mo mp b">apollo-server-lambda</code>。</p><pre class="md me mf mg gt mq mp mr ms aw mt bi"><span id="188a" class="mu lf it mp b gy mv mw l mx my">$ mkdir demo-apollo-server-lambda &amp;&amp; cd demo-apollo-server-lambda<br/>$ npm init --yes<br/>$ npm install --save apollo-server-lambda graphql</span></pre><p id="3dd5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因为我们使用TypeScript，我们需要安装<code class="fe mm mn mo mp b">typescript</code>作为开发依赖:</p><pre class="md me mf mg gt mq mp mr ms aw mt bi"><span id="81e8" class="mu lf it mp b gy mv mw l mx my">$ npm install --save-dev typescript</span></pre><p id="1079" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并为您的项目根创建一个<code class="fe mm mn mo mp b"><a class="ae kf" href="https://www.typescriptlang.org/docs/handbook/tsconfig-json.html" rel="noopener ugc nofollow" target="_blank">tsconfig.json</a></code>。</p><p id="1497" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">📄文件:<code class="fe mm mn mo mp b">tsconfig.json</code></p><figure class="md me mf mg gt ju"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="2312" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，在项目根目录下创建一个<code class="fe mm mn mo mp b">/src</code>文件夹。将<a class="ae kf" href="https://www.apollographql.com/docs/tutorial/schema" rel="noopener ugc nofollow" target="_blank"> GraphQL模式的类型定义</a> ( <code class="fe mm mn mo mp b">type-defs.ts</code>)和<a class="ae kf" href="https://www.apollographql.com/docs/tutorial/resolvers/" rel="noopener ugc nofollow" target="_blank">解析器</a> ( <code class="fe mm mn mo mp b">resolvers.ts</code>)添加到<code class="fe mm mn mo mp b">/src</code>文件夹中。</p><p id="037c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">📄文件:<code class="fe mm mn mo mp b">src/type-defs.ts</code></p><figure class="md me mf mg gt ju"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="b8b9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">📄文件:<code class="fe mm mn mo mp b">src/resolvers.ts</code></p><figure class="md me mf mg gt ju"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="a2fd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，在<code class="fe mm mn mo mp b">/src</code>文件夹中创建一个<code class="fe mm mn mo mp b">apollo-server.ts</code>。你可能会注意到这与我们用“传统”服务器方法设置Apollo服务器的<a class="ae kf" href="https://medium.com/free-code-camp/build-an-apollo-graphql-server-with-typescript-and-webpack-hot-module-replacement-hmr-3c339d05184f" rel="noopener">非常相似，除了我们没有用<code class="fe mm mn mo mp b">listen()</code>运行服务器，而是创建了一个处理程序并将其导出为<code class="fe mm mn mo mp b">graphqlHandler</code>。</a></p><p id="e0ff" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">📄文件:<code class="fe mm mn mo mp b">src/apollo-server.ts</code></p><figure class="md me mf mg gt ju"><div class="bz fp l di"><div class="nq nr l"/></div></figure><h1 id="1547" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">步骤3:安装无服务器框架</h1><p id="a4d9" class="pw-post-body-paragraph kg kh it ki b kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ml lb lc ld im bi translated">现在我们已经用TypeScript实现了Apollo服务器，但是我们如何“运行”服务器呢？与“传统”服务器不同，你不能简单地运行<code class="fe mm mn mo mp b">npm start</code>并期望我们的“无服务器”Apollo服务器神奇地响应任何传入的请求。我们需要将我们的Apollo服务器“转换”成我们的平台提供商(在我们的例子中是AWS)理解的无服务器功能(Lambdas)。为了实现这一点，你可以试着用强硬的方式去做，并自己去实现；或者，如果你像我一样是个懒人，我们不妨利用其他聪明人已经建立的框架。</p><h2 id="c470" class="mu lf it bd lg ns nt dn lk nu nv dp lo kr nw nx ls kv ny nz lw kz oa ob ma oc bi translated">介绍“<a class="ae kf" href="https://www.serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器框架</a></h2><p id="e02d" class="pw-post-body-paragraph kg kh it ki b kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ml lb lc ld im bi translated"><a class="ae kf" href="https://www.serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器框架</a>提供工具和组件，帮助<em class="od">开发、部署、故障排除和保护无服务器应用，同时大幅降低开销和成本</em>。它支持多种平台(例如AWS、Azure、Google Cloud等。)以及不同的编程语言和框架(如NodeJS、Python、Go、Java等。).<a class="ae kf" href="https://www.serverless.com/framework/docs" rel="noopener ugc nofollow" target="_blank">官方无服务器文档</a>提供了一些不错的教程和例子，所以如果你想了解更多关于无服务器框架的知识，一定要去看看。</p><p id="c0b1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">够了，没有服务器的谈话😝。现在我们需要安装来自NPM的<em class="od">无服务器框架</em>:</p><pre class="md me mf mg gt mq mp mr ms aw mt bi"><span id="0769" class="mu lf it mp b gy mv mw l mx my">$ npm install -g serverless</span></pre><p id="de05" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并在您的项目根中创建一个<code class="fe mm mn mo mp b">serverless.yml</code>。</p><p id="d226" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">📄文件:<code class="fe mm mn mo mp b">serverless.yml</code></p><figure class="md me mf mg gt ju"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="72ad" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe mm mn mo mp b">serverless.yml</code>非常简单:很可能你只需要替换<code class="fe mm mn mo mp b">services</code>和<code class="fe mm mn mo mp b">region</code>的值来满足你的需要。如果您需要配置的更多细节，请参考<code class="fe mm mn mo mp b"><a class="ae kf" href="https://www.serverless.com/framework/docs/providers/aws/guide/serverless.yml" rel="noopener ugc nofollow" target="_blank">serverless.yml</a></code> <a class="ae kf" href="https://www.serverless.com/framework/docs/providers/aws/guide/serverless.yml" rel="noopener ugc nofollow" target="_blank">参考</a>。</p><p id="b30a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在<code class="fe mm mn mo mp b">serverless.yml</code>中，你可能会注意到包含了一个<code class="fe mm mn mo mp b">serverless-webpack</code>插件，你可能会想为什么我们使用<a class="ae kf" href="https://webpack.js.org/" rel="noopener ugc nofollow" target="_blank"> Webpack </a>来编写服务器端代码？</p><p id="142b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">不像长期运行的服务器只启动一次，然后运行几天，无服务器Lambdas可能会在每次被调用时触发冷启动，因此较小的捆绑模块或多或少会有助于提高性能。克里斯·阿姆斯特朗写的这篇文章详细地解释了这个话题。</p><p id="f503" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要将<code class="fe mm mn mo mp b"><a class="ae kf" href="https://github.com/serverless-heaven/serverless-webpack" rel="noopener ugc nofollow" target="_blank">serverless-webpack</a></code>插件添加到我们的项目中，我们需要安装一些开发依赖包:</p><pre class="md me mf mg gt mq mp mr ms aw mt bi"><span id="340c" class="mu lf it mp b gy mv mw l mx my">$ npm install --save-dev serverless-webpack webpack webpack-node-externals ts-loader</span></pre><p id="93df" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并在您的项目根目录中创建一个<code class="fe mm mn mo mp b"><a class="ae kf" href="https://webpack.js.org/configuration" rel="noopener ugc nofollow" target="_blank">webpack.config.js</a></code>。</p><p id="6135" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">📄文件:<code class="fe mm mn mo mp b">webpack.config.js</code></p><figure class="md me mf mg gt ju"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="5c58" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在是时候部署我们的阿波罗服务器了！如果您正确地遵循了这些步骤并运行:</p><pre class="md me mf mg gt mq mp mr ms aw mt bi"><span id="a20c" class="mu lf it mp b gy mv mw l mx my">$ serverless deploy --stage prod</span></pre><p id="ea33" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe mm mn mo mp b">serverless</code>应该输出类似于这个例子的东西:</p><pre class="md me mf mg gt mq mp mr ms aw mt bi"><span id="2908" class="mu lf it mp b gy mv mw l mx my">$ serverless deploy --stage prod</span><span id="1824" class="mu lf it mp b gy mz mw l mx my">Serverless: Bundling with Webpack...<br/>Time: 3894ms<br/>Built at: 08/04/2020 9:53:38 PM<br/>Asset      Size  Chunks             Chunk Names<br/>src/apollo-server.js  10.6 KiB       0  [emitted]  src/apollo-server<br/>Entrypoint src/apollo-server = src/apollo-server.js<br/>[0] external "apollo-server-lambda" 42 bytes {0} [built]<br/>[1] ./src/apollo-server.ts 449 bytes {0} [built]<br/>[2] ./src/resolvers.ts 193 bytes {0} [built]<br/>[3] ./src/type-defs.ts 294 bytes {0} [built]<br/>Serverless: Package lock found - Using locked versions<br/>Serverless: Packing external modules: apollo-server-lambda@^2.16.1, graphql@^15.3.0<br/>Serverless: Packaging service...<br/>Serverless: Creating Stack...<br/>Serverless: Checking Stack create progress...<br/>........<br/>Serverless: Stack create finished...<br/>Serverless: Uploading CloudFormation file to S3...<br/>Serverless: Uploading artifacts...<br/>Serverless: Uploading service demo-apollo-server-lambda.zip file to S3 (6.07 MB)...<br/>Serverless: Validating template...<br/>Serverless: Updating Stack...<br/>Serverless: Checking Stack update progress...<br/>....................................<br/>Serverless: Stack update finished...<br/>Service Information<br/>service: demo-apollo-server-lambda<br/>stage: prod<br/>region: ap-southeast-2<br/>stack: demo-apollo-server-lambda-prod<br/>resources: 13<br/>api keys:<br/>None<br/>endpoints:<br/>POST - <a class="ae kf" href="https://abcde12345.execute-api.ap-southeast-2.amazonaws.com/prod/graphql" rel="noopener ugc nofollow" target="_blank">https://abcde12345.execute-api.ap-southeast-2.amazonaws.com/prod/graphql</a><br/>GET - <a class="ae kf" href="https://abcde12345.execute-api.ap-southeast-2.amazonaws.com/prod/graphql" rel="noopener ugc nofollow" target="_blank">https://abcde12345.execute-api.ap-southeast-2.amazonaws.com/prod/graphql</a><br/>functions:<br/>graphql: demo-apollo-server-lambda-prod-graphql<br/>layers:<br/>None</span></pre><p id="6ecb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意输出中的<code class="fe mm mn mo mp b">POST</code>端点。这是你的阿波罗服务器的网址。现在你可以尝试用诸如<a class="ae kf" href="https://learning.postman.com/docs/sending-requests/supported-api-frameworks/graphql" rel="noopener ugc nofollow" target="_blank"> Postman </a>或<a class="ae kf" href="https://developer.github.com/v4/guides/forming-calls/#communicating-with-graphql" rel="noopener ugc nofollow" target="_blank"> cURL </a>之类的工具查询你的Apollo服务器:</p><pre class="md me mf mg gt mq mp mr ms aw mt bi"><span id="4e0f" class="mu lf it mp b gy mv mw l mx my"># POST Request.<br/>query GetTestMessage {<br/>  testMessage<br/>}</span></pre><p id="7bc4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它应该用一个<code class="fe mm mn mo mp b">Hello World!</code>消息来响应。</p><pre class="md me mf mg gt mq mp mr ms aw mt bi"><span id="5cca" class="mu lf it mp b gy mv mw l mx my">{<br/>  "data": {<br/>    "testMessage": "Hello World!"<br/>  }<br/>}</span></pre><p id="7570" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">恭喜你！您已经成功部署了您的第一台无服务器Apollo服务器！</p><h1 id="3b0a" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">第四步:地方发展</h1><p id="f178" class="pw-post-body-paragraph kg kh it ki b kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ml lb lc ld im bi translated">现在我们已经用AWS Lambda部署了我们的Apollo服务器…但是如果我们需要更新或增强我们的服务器呢？“无服务器”是否意味着我们需要将每个代码变更都部署到AWS Lambda上以便进行测试？幸运的是，有一个无服务器插件可以在本地模拟AWS Lambda和API Gateway，以加快开发周期。</p><p id="b8cb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">启用这个插件是显而易见的。首先，安装NPM软件包:</p><pre class="md me mf mg gt mq mp mr ms aw mt bi"><span id="288f" class="mu lf it mp b gy mv mw l mx my">$ npm install --save-dev serverless-offline</span></pre><p id="700e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并将<code class="fe mm mn mo mp b">serverless-offline</code>插件添加到<code class="fe mm mn mo mp b">serverless.yml</code>，在<code class="fe mm mn mo mp b">serverless-webpack</code>之后:</p><p id="9c38" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">📄文件:<code class="fe mm mn mo mp b">serverless.yml</code></p><figure class="md me mf mg gt ju"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="eae4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">就是这样！现在如果你跑:</p><pre class="md me mf mg gt mq mp mr ms aw mt bi"><span id="c692" class="mu lf it mp b gy mv mw l mx my">$ serverless offline start</span></pre><p id="4b7f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您应该会看到类似如下的输出:</p><pre class="md me mf mg gt mq mp mr ms aw mt bi"><span id="2d07" class="mu lf it mp b gy mv mw l mx my">POST  <a class="ae kf" href="http://localhost:3000/dev/graphql" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/dev/graphql</a><br/>POST  <a class="ae kf" href="http://localhost:3000/2015-03-31/functions/graphql/invocations" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/2015-03-31/functions/graphql/invocations</a><br/>GET   <a class="ae kf" href="http://localhost:3000/dev/graphql" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/dev/graphql</a><br/>POST  <a class="ae kf" href="http://localhost:3000/2015-03-31/functions/graphql/invocations" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/2015-03-31/functions/graphql/invocations</a></span><span id="2ab0" class="mu lf it mp b gy mz mw l mx my"><br/>offline: [HTTP] server ready: http://localhost:3000 🚀<br/>offline:<br/>offline: Enter "rp" to replay the last request</span></pre><p id="8017" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，如果您尝试对<code class="fe mm mn mo mp b">http://localhost:3000/dev/graphql</code>、<br/>运行GraphQL <code class="fe mm mn mo mp b">testMessage</code>查询，您应该会得到相同的<code class="fe mm mn mo mp b">Hello World!</code>响应。</p><h1 id="9f70" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">步骤5:管理环境变量</h1><p id="7ee9" class="pw-post-body-paragraph kg kh it ki b kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ml lb lc ld im bi translated">在构建真实世界的应用程序时，您很可能必须处理特定于环境的配置，例如<code class="fe mm mn mo mp b">DEV</code> / <code class="fe mm mn mo mp b">PROD</code>环境的数据库连接字符串，或者不应该签入源代码控制的敏感信息，如数据库凭证。</p><figure class="md me mf mg gt ju gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/8f69bcbe240922f76fb4c35116b9b5c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*Nb4OMuKCTtNSTbJ7PPsfnQ.jpeg"/></div></figure><p id="7d93" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您一直在从事Node.js项目，我打赌您一直在使用(或者至少听说过)NPM包。对于<code class="fe mm mn mo mp b">serverless</code>项目，有一个类似于<code class="fe mm mn mo mp b">.env</code>的插件，帮助管理不同环境中的环境变量并将其预加载到无服务器中。所以让我们继续安装这个插件:</p><pre class="md me mf mg gt mq mp mr ms aw mt bi"><span id="672b" class="mu lf it mp b gy mv mw l mx my">$ npm install --save-dev serverless-dotenv-plugin</span></pre><p id="f053" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，将插件添加到<code class="fe mm mn mo mp b">serverless.yml</code>中，作为<code class="fe mm mn mo mp b">plugins</code>下的第一项。</p><p id="178a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">📄文件:<code class="fe mm mn mo mp b">serverless.yml</code></p><figure class="md me mf mg gt ju"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="e814" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，为了演示它如何跨不同的环境工作，在项目根目录下创建两个<code class="fe mm mn mo mp b">.env</code>文件:一个用于<code class="fe mm mn mo mp b">development</code>，另一个用于<code class="fe mm mn mo mp b">production</code>。</p><p id="fc01" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">📄文件:<code class="fe mm mn mo mp b">.env.development</code></p><figure class="md me mf mg gt ju"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="d7d6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">📄文件:<code class="fe mm mn mo mp b">.env.production</code></p><figure class="md me mf mg gt ju"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="5bab" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在<code class="fe mm mn mo mp b">src</code>下创建一个<code class="fe mm mn mo mp b">environment.ts</code>文件，类似于我们在上一篇文章中对<a class="ae kf" href="https://medium.com/free-code-camp/build-an-apollo-graphql-server-with-typescript-and-webpack-hot-module-replacement-hmr-3c339d05184f" rel="noopener">的操作:</a></p><p id="5a1e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">📄文件:<code class="fe mm mn mo mp b">src/environment.ts</code></p><figure class="md me mf mg gt ju"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="c609" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并更新<code class="fe mm mn mo mp b">src/resolvers.ts</code>以从<code class="fe mm mn mo mp b">environment.ts</code>获取值。</p><p id="5843" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">📄文件:<code class="fe mm mn mo mp b">src/resolvers.ts</code></p><figure class="md me mf mg gt ju"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="2f52" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe mm mn mo mp b">serverless-dotenv-plugin</code> <a class="ae kf" href="https://github.com/colynb/serverless-dotenv-plugin#automatic-env-file-resolution-as-of-verson-30-thanks-to-danilofuchs" rel="noopener ugc nofollow" target="_blank">根据您的目标环境</a>自动解析正确的 <code class="fe mm mn mo mp b"><a class="ae kf" href="https://github.com/colynb/serverless-dotenv-plugin#automatic-env-file-resolution-as-of-verson-30-thanks-to-danilofuchs" rel="noopener ugc nofollow" target="_blank">.env</a></code> <a class="ae kf" href="https://github.com/colynb/serverless-dotenv-plugin#automatic-env-file-resolution-as-of-verson-30-thanks-to-danilofuchs" rel="noopener ugc nofollow" target="_blank">文件。要查看实际情况，请尝试在本地启动服务器:</a></p><pre class="md me mf mg gt mq mp mr ms aw mt bi"><span id="8599" class="mu lf it mp b gy mv mw l mx my">$ serverless offline start</span></pre><p id="4121" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并尝试在<code class="fe mm mn mo mp b"><a class="ae kf" href="http://localhost:3000/dev/graphql:" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/dev/graphql</a></code> <a class="ae kf" href="http://localhost:3000/dev/graphql:" rel="noopener ugc nofollow" target="_blank"> : </a>上运行GraphQL <code class="fe mm mn mo mp b">testMessage</code>查询</p><pre class="md me mf mg gt mq mp mr ms aw mt bi"><span id="dc21" class="mu lf it mp b gy mv mw l mx my">query GetTestMessage {<br/>  testMessage<br/>}</span></pre><p id="7914" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您应该会得到以下响应:</p><pre class="md me mf mg gt mq mp mr ms aw mt bi"><span id="739e" class="mu lf it mp b gy mv mw l mx my">{<br/>  "data": {<br/>    "testMessage": "Secret message for DEV!"<br/>  }<br/>}</span></pre><p id="ffaf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，如果您尝试将更改部署到AWS Lambda上:</p><pre class="md me mf mg gt mq mp mr ms aw mt bi"><span id="1ab9" class="mu lf it mp b gy mv mw l mx my">$ NODE_ENV=production serverless deploy --stage prod</span></pre><p id="5cf2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并尝试在您的Lambda URL上运行相同的GraphQL <code class="fe mm mn mo mp b">testMessage</code>查询，您应该得到以下响应:</p><pre class="md me mf mg gt mq mp mr ms aw mt bi"><span id="efe9" class="mu lf it mp b gy mv mw l mx my">{<br/>  "data": {<br/>    "testMessage": "Secret message for PROD!"<br/>  }<br/>}</span></pre><p id="66db" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您登录到<a class="ae kf" href="https://aws.amazon.com/console" rel="noopener ugc nofollow" target="_blank"> AWS管理控制台</a>并查找您刚刚部署的Apollo Server Lambda，您应该看到来自<code class="fe mm mn mo mp b">.env.production</code>的环境变量被注入到您的<a class="ae kf" href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-envvars" rel="noopener ugc nofollow" target="_blank"> Apollo Server Lambda的环境变量</a>。</p><h1 id="a200" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">最后:清理</h1><p id="636e" class="pw-post-body-paragraph kg kh it ki b kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ml lb lc ld im bi translated">如本文开头所述，尽管AWS为其大部分服务提供免费等级使用，但如果您的应用程序使用量超过免费等级，仍会涉及定价。作为一个经验法则，总是积极主动地管理你的应用程序的使用，并移除任何不再使用的资源，以避免意外的费用。</p><p id="7a29" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上述<code class="fe mm mn mo mp b">serverless remove</code>命令应删除已部署的服务。</p><pre class="md me mf mg gt mq mp mr ms aw mt bi"><span id="e93f" class="mu lf it mp b gy mv mw l mx my">$ serverless remove --stage prod</span></pre><p id="9203" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并且您可以验证在<a class="ae kf" href="https://aws.amazon.com/console" rel="noopener ugc nofollow" target="_blank"> AWS管理控制台</a>中不应该留下部署足迹。</p><h1 id="268f" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">包扎</h1><p id="9c24" class="pw-post-body-paragraph kg kh it ki b kj mh kl km kn mi kp kq kr mj kt ku kv mk kx ky kz ml lb lc ld im bi translated">就这样了。我希望你喜欢读这篇文章:)</p><p id="cc91" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">源代码可以在GitHub上找到:<br/><a class="ae kf" href="https://github.com/derek-fong/demo-apollo-server-lambda" rel="noopener ugc nofollow" target="_blank">https://github.com/derek-fong/demo-apollo-server-lambda</a></p><p id="3a04" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我相信无服务器应用程序有很大的潜力。当无服务器方法开始流行起来的时候，看看未来几年在开发领域会发生什么会很有趣。然而，就像一般的软件开发一样，无服务器方法不是一个万灵药，在下一个项目采用无服务器之前，当您权衡每种部署策略的利弊时，您应该知道好的、坏的和不好的。</p><p id="8aee" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">喜欢读我的故事吗？请留下一些掌声👏🏻下面是我的一些其他关于GraphQL的文章，你可能会感兴趣:</p><ul class=""><li id="8001" class="na nb it ki b kj kk kn ko kr nc kv nd kz ne ld nf ng nh ni bi translated"><a class="ae kf" href="https://medium.com/free-code-camp/build-an-apollo-graphql-server-with-typescript-and-webpack-hot-module-replacement-hmr-3c339d05184f" rel="noopener">如何使用TypeScript和Webpack热模块替换构建Apollo GraphQL服务器</a></li><li id="839a" class="na nb it ki b kj nj kn nk kr nl kv nm kz nn ld nf ng nh ni bi translated"><a class="ae kf" href="https://medium.com/better-programming/how-to-integrate-an-apollo-graphql-server-with-mongodb-and-typescript-code-generator-b029d821591" rel="noopener">如何将Apollo GraphQL服务器与MongoDB和TypeScript代码生成器集成</a></li><li id="be55" class="na nb it ki b kj nj kn nk kr nl kv nm kz nn ld nf ng nh ni bi translated">…很快会有更多的选择！</li></ul><p id="e2d7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对我下一个主题的问题、反馈或建议？请在下面留言💁🏻‍♂️</p></div></div>    
</body>
</html>