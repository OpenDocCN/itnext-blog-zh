<html>
<head>
<title>ASP.NET Core with Azure B2C Auth</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有Azure B2C授权的ASP.NET核心</h1>
<blockquote>原文：<a href="https://itnext.io/asp-net-core-with-azure-b2c-auth-8874650ba12e?source=collection_archive---------5-----------------------#2019-04-14">https://itnext.io/asp-net-core-with-azure-b2c-auth-8874650ba12e?source=collection_archive---------5-----------------------#2019-04-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="db5a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不久前，我遇到了以前的一个同事，他们在谈论使用Azure的B2C来验证他们的应用程序。这听起来是个不错的解决方案。这篇博文将介绍如何获得Azure B2C设置，以及如何创建一个使用B2C进行授权的示例应用程序。</p><h1 id="e1bd" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">创建Azure Active Directory B2C</h1><p id="1182" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">这一切都假设你已经有一个Azure账户。如果你没有，你可以注册一个<a class="ae lo" href="https://azure.microsoft.com/en-us/offers/ms-azr-0044p/" rel="noopener ugc nofollow" target="_blank">免费试用</a>(不是附属链接)。注册后，前往<a class="ae lo" href="https://portal.azure.com/" rel="noopener ugc nofollow" target="_blank">蔚蓝门户</a>。</p><p id="917b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意:如果要使用Azure帐户上的默认Active Directory，可以跳过此部分。</p><p id="9ce3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在左上角点击<strong class="jp ir">创建资源</strong>链接。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi lp"><img src="../Images/50b947884c7f93f6c31bb73436129b72.png" data-original-src="https://miro.medium.com/v2/resize:fit:334/format:webp/0*CogELWW12cqRHN5X.png"/></div></figure><p id="6c37" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在搜索框中寻找Azure Active Directory B2C 。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi lx"><img src="../Images/17ad1428f0bd3f44f00e532f2391c2af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qa8bhVzC10mxMT6u.png"/></div></div></figure><p id="2524" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">选择Azure Active Directory B2C后，更多信息将加载到新面板的右侧。点击<strong class="jp ir">创建</strong>按钮继续。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/9dbc8c7e74c1e8551991d6a4231666d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1078/format:webp/0*tJ-7JDgIaGr7z_fO.png"/></div></figure><p id="fb9e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，选择是创建新的B2C租户还是使用现有的租户。我没有现有的租户，因此下面的流程将用于创建新租户。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi md"><img src="../Images/e3ae07e9facca3caa8399b1010802dcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:938/format:webp/0*6HQMj9JWIbZWAro7.png"/></div></figure><p id="039b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在下一个面板中，您需要输入组织名称和初始域名。输入有效值后，单击“创建”按钮。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi me"><img src="../Images/10d7bb9aa34237526271278b984d57ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:598/format:webp/0*yrlTBXetGleWVyJE.png"/></div></figure><h1 id="7b84" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">切换活动目录</h1><p id="6af6" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">既然新目录已经创建，我们需要切换到Azure门户中的新目录。在左侧面板中点击<strong class="jp ir"> Azure Active Directory </strong>。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/4a71e873e0ba02d1efcc49b7156b84f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:344/format:webp/0*VCiKHq--EVPnzsUK.png"/></div></figure><p id="8f77" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击<strong class="jp ir">开关目录</strong>链接。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/7f64751bb9d52710184b5ce965272800.png" data-original-src="https://miro.medium.com/v2/resize:fit:1062/format:webp/0*aP638BdWvBJXRVK8.png"/></div></figure><p id="1691" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个新的面板将显示在屏幕的右侧，其中列出了您可以使用的目录。选择您在上述步骤中创建的一个或您想要使用的现有的一个。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/773c226f20401546b6624a926feefe0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:690/format:webp/0*DaBi01gd2E2FZweE.png"/></div></figure><p id="d010" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用门户网站顶部中间的搜索框找到<strong class="jp ir"> Azure AD B2C </strong>。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/480f5f4e96e6b47cacb8745eb46c0b1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:962/format:webp/0*UB1Pr8kq8CovPNZ4.png"/></div></figure><h1 id="0a1a" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">示例应用程序</h1><p id="0633" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">在继续Azure方面之前，我们将创建我们的示例客户端应用程序。这个小小的迂回将使我更容易指出Azure中的哪些值需要放在应用程序配置中的什么位置。</p><p id="2d19" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要创建一个已经设置为使用Azure B2C的新web应用程序，请使用以下内容。在命令提示符下运行. NET CLI命令。如果您喜欢这种方式，也可以使用Visual Studio模板。</p><pre class="lq lr ls lt gt mj mk ml mm aw mn bi"><span id="64b6" class="mo km iq mk b gy mp mq l mr ms">dotnet new webapp --auth IndividualB2C</span></pre><p id="f411" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在生成的应用程序中，您的<strong class="jp ir"> appsettings.json </strong>将包含以下用于<strong class="jp ir"> AzureAdB2C </strong>的部分。</p><pre class="lq lr ls lt gt mj mk ml mm aw mn bi"><span id="a289" class="mo km iq mk b gy mp mq l mr ms">"AzureAdB2C": { <br/>    "Instance": "https://login.microsoftonline.com/tfp/",<br/>    "ClientId": "11111111-1111-1111-11111111111111111",<br/>    "CallbackPath": "/signin-oidc", <br/>    "Domain": "qualified.domain.name", <br/>    "SignUpSignInPolicyId": "", <br/>    "ResetPasswordPolicyId": "", <br/>    "EditProfilePolicyId": "" <br/>}</span></pre><h1 id="4c70" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">Azure AD B2C设置</h1><p id="6af1" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">回到Azure门户和Azure广告B2C服务页面。在<strong class="jp ir">概述</strong>页面中，我们需要注意的第一件事是<strong class="jp ir">域名</strong>，并使用它在我们的应用程序中设置一些配置值。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mt"><img src="../Images/e4e1dc983c41d252697d587626610214.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IE0tCZY3CWkdq4Se.png"/></div></div></figure><p id="6148" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在appsettings.json文件中，使用这个值作为您的<strong class="jp ir">域</strong>值。</p><pre class="lq lr ls lt gt mj mk ml mm aw mn bi"><span id="597c" class="mo km iq mk b gy mp mq l mr ms">"Domain": "TestingOrg3.onmicrosoft.com"</span></pre><p id="d07b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">子域也用于构建<strong class="jp ir">实例</strong>，如下所示。</p><pre class="lq lr ls lt gt mj mk ml mm aw mn bi"><span id="0669" class="mo km iq mk b gy mp mq l mr ms">"Instance": "https://TestingOrg3.b2clogin.com/tfp/"</span></pre><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/e80a45f054fb30702aa6bac5ebff2b5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:440/format:webp/0*Ycg2ChBfAeS80H67.png"/></div></figure><p id="85aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在加载面板上点击<strong class="jp ir">添加</strong>按钮。在新的应用程序面板上，我们需要给应用程序一个<strong class="jp ir">名称</strong>，选择客户端的类型，在我们的例子中是<strong class="jp ir"> Web App / Web API </strong>。接下来是<strong class="jp ir">回复URL </strong>，默认设置是您的基本url/sigin-oidc。我一开始把这个值弄乱了，得到了一些非常奇怪的错误。最后点击<strong class="jp ir">创建</strong>按钮。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mv"><img src="../Images/8f6d74ef1ab460e247e0a76826d46ee4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eVOJT0VYNl49genx.png"/></div></div></figure><p id="bc35" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建过程完成后，复制<strong class="jp ir">应用程序ID </strong>字段中的值，并将其用作appsettings.json文件中的<strong class="jp ir"> ClientId </strong>。</p><p id="fc87" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">回到Azure，选择<strong class="jp ir">用户流(策略)</strong>选项。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/e90dd2ec829f16574b906268c80d408f.png" data-original-src="https://miro.medium.com/v2/resize:fit:462/format:webp/0*_yit14HRlmQJMCWK.png"/></div></figure><p id="32ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在加载面板的顶部，点击<strong class="jp ir">新用户流</strong>按钮。下一个面板显示了可以添加的流的选择。我们正在制作的应用程序将使用<strong class="jp ir">注册和登录</strong>流程和<strong class="jp ir">密码休息</strong>流程。我只打算浏览第一个，但第二个非常相似。点击<strong class="jp ir">报名，签到</strong>喜欢。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/f25237d53bfcfff48453bfcfeaab66aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/0*S339kYdZaAMf61dy.png"/></div></figure><p id="d14a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在创建过程中，您需要为流设置一个<strong class="jp ir">名称</strong>，并选择对流有效的<strong class="jp ir">身份提供者</strong>。您还可以选择随此流收集的字段，以及哪些字段应该随索赔一起返回。设置好这些选项后，点击<strong class="jp ir">创建</strong>按钮。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi my"><img src="../Images/c682c67a1e9c659401080ed7ae639e1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3HrztqElVXfUHG4r.png"/></div></div></figure><p id="0a68" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">需要在appsettings.json文件中为<strong class="jp ir">signussigninpolicyid</strong>值输入该屏幕的<strong class="jp ir">名称</strong>。这是我在设置文件中设置的注册和重置密码策略。</p><pre class="lq lr ls lt gt mj mk ml mm aw mn bi"><span id="af6e" class="mo km iq mk b gy mp mq l mr ms">"SignUpSignInPolicyId": "B2C_1_SignInOut", <br/>"ResetPasswordPolicyId": "B2C_1_PasswordReset"</span></pre><h1 id="0173" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">运行示例</h1><p id="53a8" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">此时，您可以运行您的示例应用程序，并单击<strong class="jp ir">登录</strong>链接，您将看到一个类似下面的页面，该页面来自Azure B2C。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mz"><img src="../Images/83728d8cf38f1abefb70329f19f440d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uPU9UDeU9UwiTgK2.png"/></div></div></figure><p id="0d7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有很多方法可以定制用户将在Azure的相关流程下看到的页面。</p><h1 id="913e" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">包扎</h1><p id="1863" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">我在设置Azure B2C时遇到了不少问题。我希望这篇文章能帮助你们绕过我提到的一些问题。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><p id="34de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nh">原载于2019年4月14日elanderson.net</em><a class="ae lo" href="https://elanderson.net/2019/04/asp-net-core-with-azure-b2c-auth/" rel="noopener ugc nofollow" target="_blank"><em class="nh"/></a><em class="nh">。</em></p></div></div>    
</body>
</html>