<html>
<head>
<title>Adding basic-auth to Ingress-Nginx using Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform向Ingress-Nginx添加basic-auth</h1>
<blockquote>原文：<a href="https://itnext.io/adding-basic-auth-to-ingress-nginx-using-terraform-c9c09f857378?source=collection_archive---------0-----------------------#2022-05-01">https://itnext.io/adding-basic-auth-to-ingress-nginx-using-terraform-c9c09f857378?source=collection_archive---------0-----------------------#2022-05-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="bd26" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我一直在做一个内部任务，是关于在我们的<a class="ae kl" href="https://linkerd.io/" rel="noopener ugc nofollow" target="_blank"> linkerd </a>仪表板上添加一个认证层。对于那些不知道的人来说，<code class="fe km kn ko kp b">linkerd</code>在<a class="ae kl" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> kubernetes </a>中提供了轻量级服务网格功能，以及其他有用的开箱即用功能，如用于点对点加密的<a class="ae kl" href="https://www.cloudflare.com/learning/access-management/what-is-mutual-tls/" rel="noopener ugc nofollow" target="_blank"> mTLS </a>。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi kq"><img src="../Images/191ca4a5e5a789257da44795d45a10bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rw5UtkN4fSKRnGll6pNqoA.png"/></div></div></figure><p id="8d5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于我们的云基础设施，我们有一个完全声明性的策略，使用<a class="ae kl" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> terraform </a>和<a class="ae kl" href="https://terragrunt.gruntwork.io/" rel="noopener ugc nofollow" target="_blank"> terragrunt </a>描述<a class="ae kl" href="https://en.wikipedia.org/wiki/Infrastructure_as_code" rel="noopener ugc nofollow" target="_blank"> IaC </a>中的所有资源。所以作为任务的一部分，我必须使用terraform创建所有需要的资源，并使用terragrunt配置它们。我按照<a class="ae kl" href="https://kubernetes.github.io/ingress-nginx/" rel="noopener ugc nofollow" target="_blank"> ingress-nginx </a>的常规教程为<a class="ae kl" href="https://kubernetes.github.io/ingress-nginx/examples/auth/basic/" rel="noopener ugc nofollow" target="_blank">创建一个basic-auth模块</a>，因为我们已经使用ingress-nginx控制器来公开我们的服务，并使用它在我们的linkerd仪表板上设置<a class="ae kl" href="https://linkerd.io/2.11/tasks/exposing-dashboard/#nginx-with-basic-auth" rel="noopener ugc nofollow" target="_blank"> basic-auth。这相当简单，我在terraform中创建了一个</a><a class="ae kl" href="https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/password" rel="noopener ugc nofollow" target="_blank"> random_password </a>资源。我继续创建akubernetes_secret资源，使用用户名(比如admin)和生成的密码。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="lc ld l"/></div></figure><p id="2ecf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从表面上看，这可以很好地在kubernetes和<code class="fe km kn ko kp b">ingress-nginx</code>模块中创建资源。但是当我试图加载仪表板时，我无法通过！显然，密码不起作用，我不明白为什么！</p><div class="le lf gp gr lg lh"><a href="https://terragrunt.gruntwork.io/" rel="noopener  ugc nofollow" target="_blank"><div class="li ab fo"><div class="lj ab lk cl cj ll"><h2 class="bd ir gy z fp lm fr fs ln fu fw ip bi translated">Terragrunt | Terraform包装</h2><div class="lo l"><h3 class="bd b gy z fp lm fr fs ln fu fw dk translated">去掉重复的后端代码。定义如何在根目录中管理您的Terraform状态，并在…</h3></div><div class="lp l"><p class="bd b dl z fp lm fr fs ln fu fw dk translated">terragrunt.gruntwork.io</p></div></div><div class="lq l"><div class="lr l ls lt lu lq lv la lh"/></div></div></a></div><p id="0fb9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">深入研究之后，我意识到在nginx-ingress basic-auth教程中，密码是使用<code class="fe km kn ko kp b">htpasswd</code>实用程序生成的，然后在存储到kubernetes时被编码为<code class="fe km kn ko kp b">base64</code>。但是为什么我生成的密码不起作用呢？看着<code class="fe km kn ko kp b">htpasswd</code>的<a class="ae kl" href="https://httpd.apache.org/docs/2.4/programs/htpasswd.html" rel="noopener ugc nofollow" target="_blank">官方文档</a>，我开始知道这个工具使用<code class="fe km kn ko kp b">bcrypt</code>加密密码，一个<code class="fe km kn ko kp b">MD5.</code>的版本，突然我意识到我的错误和<a class="ae kl" href="https://www.terraform.io/language/functions/bcrypt" rel="noopener ugc nofollow" target="_blank">感谢terraform </a>的bcrypt函数，我不得不引入一个非常小的变化。我很惊讶这样一件小事有时会导致道路堵塞。我的<code class="fe km kn ko kp b">kubernetes_secret</code>资源的修改版本如下所示:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="lc ld l"/></div></figure><p id="29bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是所有的魔法！这个密码非常管用！</p><div class="le lf gp gr lg lh"><a href="https://www.terraform.io/language/functions/bcrypt" rel="noopener  ugc nofollow" target="_blank"><div class="li ab fo"><div class="lj ab lk cl cj ll"><h2 class="bd ir gy z fp lm fr fs ln fu fw ip bi translated">哈希公司的bcrypt - Functions -配置语言| Terraform</h2><div class="lo l"><h3 class="bd b gy z fp lm fr fs ln fu fw dk translated">搜索Terraform文档bcrypt使用Blowfish密码计算给定字符串的散列，返回一个字符串…</h3></div><div class="lp l"><p class="bd b dl z fp lm fr fs ln fu fw dk translated">www.terraform.io</p></div></div><div class="lq l"><div class="lw l ls lt lu lq lv la lh"/></div></div></a></div></div></div>    
</body>
</html>