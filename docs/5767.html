<html>
<head>
<title>Where is my iPhone?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我的iPhone在哪里？</h1>
<blockquote>原文：<a href="https://itnext.io/where-is-my-iphone-fb75e5bd380?source=collection_archive---------5-----------------------#2021-05-20">https://itnext.io/where-is-my-iphone-fb75e5bd380?source=collection_archive---------5-----------------------#2021-05-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3075" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">核心定位教程</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ba48254640f9c4117d86fb5d960f19eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XsZIlXC1YmUUr7X9"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@sylwiabartyzel?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">西尔维娅·巴蒂泽尔</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="63fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这篇文章是关于如何使用苹果的CoreLocation框架检索iPhone或iPad的地理位置的教程。</p><p id="1960" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我首先介绍了为设备位置的变化设置监听器的所有必要步骤。</p><p id="5581" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章的最后，我将把所有的东西打包成一个方便的联合发布器。</p><p id="8437" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你喜欢这篇文章，请给我买杯咖啡。</p><h2 id="d41c" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">位置管理器</h2><p id="77df" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">完成所有工作的主类是<code class="fe mt mu mv mw b">CLLocationManager</code>。我们来实例一个。</p><pre class="kj kk kl km gt mx mw my mz aw na bi"><span id="94e6" class="lv lw it mw b gy nb nc l nd ne">private let locationManager = CLLocationManager()</span></pre><p id="b390" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">需要一个代理来接收位置更新。</p><pre class="kj kk kl km gt mx mw my mz aw na bi"><span id="0f50" class="lv lw it mw b gy nb nc l nd ne">self.locationManager.delegate = self</span></pre><p id="2283" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该委托需要实现以下函数。我只是做了一个简单的例子，打印接收到的经度和纬度。</p><pre class="kj kk kl km gt mx mw my mz aw na bi"><span id="6ea4" class="lv lw it mw b gy nb nc l nd ne">func locationManager(_ manager: CLLocationManager, didUpdateLocations locations: [CLLocation]) {<br/>    guard let location = locations.last else { return }<br/>    print("Longitude: \(location.coordinate.longitude)")<br/>    print("Latitude: \(location.coordinate.latitude)")<br/>}</span></pre><p id="6600" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们设置所需的精度。有很多选项可以设置，我仍然需要弄清楚它们的行为。</p><pre class="kj kk kl km gt mx mw my mz aw na bi"><span id="4b5f" class="lv lw it mw b gy nb nc l nd ne">self.locationManager.desiredAccuracy = kCLLocationAccuracyBest</span></pre><p id="7907" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">准确性还与应用程序何时应该或允许跟踪位置有关。</p><p id="5b4d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以我的情况为例，我想跟踪位置，即使应用程序没有被积极使用。</p><p id="04fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">应用程序必须为此请求。因此，我们必须进行以下调用。</p><pre class="kj kk kl km gt mx mw my mz aw na bi"><span id="c8ba" class="lv lw it mw b gy nb nc l nd ne">self.locationManager.requestAlwaysAuthorization()</span></pre><p id="4112" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还需要在<code class="fe mt mu mv mw b">Info.plist</code>中设置一些键。这些都是必需的，没有它们要跟踪根本就不可用。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl nf"><img src="../Images/52677309d72ff04892157f67688de7c9.png" data-original-src="https://miro.medium.com/v2/format:webp/1*cq9I7YqFZZTGbmb-oPWqWQ.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">配置</figcaption></figure><p id="9396" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，当用户启动应用程序时，会提示她确认此请求。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl nf"><img src="../Images/8d30ba2c6fc5eae1f428123eb6ada833.png" data-original-src="https://miro.medium.com/v2/format:webp/1*_YlLDvvWggKXq8rZ_A3oug.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">请求授权</figcaption></figure><p id="7751" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">回到我们的代码，还需要一个步骤来实现这一切。</p><pre class="kj kk kl km gt mx mw my mz aw na bi"><span id="6f5d" class="lv lw it mw b gy nb nc l nd ne">self.locationManager.startUpdatingLocation()</span></pre><p id="8916" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">是的，就这些。我们完了。</p><h2 id="570d" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">包装它</h2><p id="4737" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">正如开始时所承诺的，我已经将完整的代码放入了一个实现合并发布器的类中。</p><p id="972d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您不确定我在这里说的是什么，请查看文档末尾的参考资料部分，以便进一步阅读。</p><pre class="kj kk kl km gt mx mw my mz aw na bi"><span id="5329" class="lv lw it mw b gy nb nc l nd ne">import Combine<br/>import CoreLocation<br/>import Foundation<br/><br/>class LocationPublisher: NSObject {<br/>    <br/>    typealias Output = (longitude: Double, latitude: Double)<br/>    typealias Failure = Never<br/>    <br/>    private let wrapped = PassthroughSubject&lt;(Output), Failure&gt;()<br/>    <br/>    private let locationManager = CLLocationManager()<br/>    <br/>    override init() {<br/>        super.init()<br/>        self.locationManager.delegate = self<br/>        self.locationManager.desiredAccuracy = kCLLocationAccuracyBest<br/>        self.locationManager.requestAlwaysAuthorization()<br/>        self.locationManager.startUpdatingLocation()<br/>    }<br/>}<br/><br/>extension LocationPublisher: CLLocationManagerDelegate {<br/>    func locationManager(_ manager: CLLocationManager, didUpdateLocations locations: [CLLocation]) {<br/>        guard let location = locations.last else { return }<br/>        wrapped.send((longitude: location.coordinate.longitude, latitude: location.coordinate.latitude))<br/>    }<br/>}<br/><br/>extension LocationPublisher: Publisher {<br/>    func receive&lt;Downstream: Subscriber&gt;(subscriber: Downstream) where Failure == Downstream.Failure, Output == Downstream.Input {<br/>        wrapped.subscribe(subscriber)<br/>    }<br/>}</span></pre><p id="d1d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每当位置改变时，发布者将发出经度和纬度的元组。</p><p id="13bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们只需要订阅这些变更来处理它们。</p><p id="6394" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这可以通过调用<code class="fe mt mu mv mw b">sink</code>并传递一个函数来实现。</p><pre class="kj kk kl km gt mx mw my mz aw na bi"><span id="1368" class="lv lw it mw b gy nb nc l nd ne">let locationPublisher = LocationPublisher()<br/>var cancellables = [AnyCancellable]()<br/>locationPublisher.sink(receiveValue: doSomething).store(in: &amp;cancellables)<br/><br/>func doSomething(location: (longitude: Double, latitude: Double)) {<br/>    print("Longitude: \(longitude)")<br/>    print("Latitude: \(latitude)")<br/>}</span></pre><p id="c7ec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">今天到此为止。我希望你喜欢这篇文章，并发现它很有用。</p><p id="66bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你喜欢这篇文章，请给我买杯咖啡。。</p><h2 id="c599" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">资源</h2><ul class=""><li id="3f57" class="ng nh it lb b lc mo lf mp li ni lm nj lq nk lu nl nm nn no bi translated"><a class="ae ky" href="https://developer.apple.com/documentation/corelocation/adding_location_services_to_your_app" rel="noopener ugc nofollow" target="_blank">向您的应用添加定位服务</a></li><li id="4b35" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><a class="ae ky" href="https://developer.apple.com/documentation/corelocation/choosing_the_location_services_authorization_to_request" rel="noopener ugc nofollow" target="_blank">选择位置服务授权请求</a></li><li id="46d3" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><a class="ae ky" href="https://developer.apple.com/documentation/combine" rel="noopener ugc nofollow" target="_blank">联合收割机</a></li></ul></div></div>    
</body>
</html>