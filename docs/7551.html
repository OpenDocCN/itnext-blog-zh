<html>
<head>
<title>How Code formatter implemented in Turtle Graphics</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">代码格式化程序如何在Turtle图形中实现</h1>
<blockquote>原文：<a href="https://itnext.io/how-code-formatter-implemented-in-turtle-graphics-475e8e4cf611?source=collection_archive---------1-----------------------#2022-11-03">https://itnext.io/how-code-formatter-implemented-in-turtle-graphics-475e8e4cf611?source=collection_archive---------1-----------------------#2022-11-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/30eea0b2c03342204880c759094d306a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mY684CG65R2nsO-92vZHJg.png"/></div></div></figure><p id="3555" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">大家好，在上一篇文章中，我介绍了Turtle Graphics Android应用程序项目的实现细节和关于脚本语言、编辑器、生成文档等的资源。在我发布该应用程序并获得2000多次下载以及良好的评级和反馈后，我决定添加对代码格式化的支持。在这篇文章中，我将详细讨论简单的代码格式化程序如何工作以及我如何在Turtle Graphics应用程序中实现</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="gh gi kw"><img src="../Images/237402a142f017c8e7f688addc7ed274.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/1*FHQ2x6jwQK0Pqj6ZTKPyow.gif"/></div></figure><p id="5b7e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">由于程序员代码格式化程序是我们日常工作中的一个重要工具，如果代码被格式化，它们会使代码更容易阅读，但是你有没有问问自己它是如何工作的？</p><p id="ff42" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在讨论代码格式化程序之前，让我们先讨论一下编译器如何将你的代码从文本表示成数据结构，以便对其进行处理，比如类型检查。</p><p id="1cb6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们从包含简单hello world示例的文件开始我们的故事</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="07ae" class="lg lh iq lc b gy li lj l lk ll">fun main() {<br/>   print("Hello, World!")<br/>}</span></pre><p id="9091" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第一步是读取这个文本文件，并将其转换成一个令牌列表，令牌是一个表示关键字、数字、括号、字符串等的类，例如在源代码中的这个位置</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="f309" class="lg lh iq lc b gy li lj l lk ll">data class Token (<br/>   val kind : TokenKind,<br/>   val literal : String,<br/>   val line : Int,<br/>)</span></pre><p id="55f1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还可以保存文件名、列的开始和结束，这样当我们想要报告错误时，我们可以提供关于位置的有用信息</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="f18a" class="lg lh iq lc b gy li lj l lk ll">Error in File Main Line 10: Missing semicolon :D</span></pre><p id="8efc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这一步称为扫描器、词法分析器或记号化器，最后我们会以记号列表结束</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="5ffd" class="lg lh iq lc b gy li lj l lk ll">{ FUN_KEYWORD, "fun", 1 }<br/>{ IDENTIFIER, "main", 1 }<br/>{ LEFT_PAREN, "(", 1 }<br/>{ RRIGHT_PAREN, ")", 1 }<br/>{ LEFT_BRACE, "{", 1 }<br/>{ IDENTIFIER, "print", 2 }<br/>{ LEFT_PAREN, "(", 2 }<br/>{ STRING, "Hello, World!", 2 }<br/>{ RRIGHT_PAREN, ")", 2 }<br/>{ RIGHT_BRACE, "}", 3 }</span></pre><p id="6d12" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">结果是令牌列表</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="36d4" class="lg lh iq lc b gy li lj l lk ll">val tokens : List&lt;Token&gt; = tokenizer(input)</span></pre><p id="699d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意，在这一步，我们可以检查一些错误，如未终止的字符串或字符，不支持的符号…等等</p><p id="58af" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这一步之后，你会忘记你的文本文件和处理这个令牌列表，现在我们应该根据我们的语言语法将一些令牌转换成节点，因为当我们看到FUN_KEYWORD时，这意味着我们将构建一个函数声明节点，我们需要名称、参数等</p><p id="2136" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这一步中，我们需要一个数据结构来表示程序，以便我们以后可以遍历和验证它，它被称为抽象语法树(AST)，AST中的每个节点表示语句，如If、While、函数声明、var声明等，或表达式，如赋值、一元等，每个节点存储所需的信息，以便在后面的步骤中使用，例如</p><p id="3149" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">函数声明</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="72c0" class="lg lh iq lc b gy li lj l lk ll">data class Function (<br/>   var name : String,<br/>   var arguments : List&lt;Argument&gt;,<br/>   var body : List&lt;Statement&gt;<br/>)</span></pre><p id="8368" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">变量声明</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="bccc" class="lg lh iq lc b gy li lj l lk ll">data class Var (<br/>   var name : String<br/>   var value : Expression<br/>)</span></pre><p id="bce1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这一步被称为解析，我们将最终得到一个AST对象，我们可以用它来遍历所有节点。</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="f422" class="lg lh iq lc b gy li lj l lk ll">var astNode = parse(tokens)</span></pre><p id="de44" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果语言是静态类型，如Java、C、Go…等，我们将转到类型检查器步骤，该步骤的目标是检查用户是否正确使用类型。例如，如果使用int类型声明一个变量，它应该只存储整数，如果条件必须是布尔类型或C语言中的整数，等等</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lm"><img src="../Images/82eec82bc4a0b81956c157a6bc2ebb32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b23u_cZedkmgiB1VPcptMw.png"/></div></div></figure><p id="9fc7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这一步之后，我们将得到相同的AST节点，但现在我们知道它是有效的，我们现在可以将它编译到任何目标或评估它，而且我们还可以进行格式化、静态分析、优化、检查代码样式等</p><p id="f417" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，假设我们希望所有开发人员在声明变量时不要在名称中使用_来检查我们是否会遍历AST节点以找到所有Var节点并检查它们</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="f5c5" class="lg lh iq lc b gy li lj l lk ll">fun checkVarDeclaration(node : Var) {<br/>   if (node.name.contains("_") {<br/>      reportError("Ops your variable name ${node.name} contains _")<br/>   }<br/>}</span></pre><p id="385c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是现在我们需要格式化它，那么如何做呢？同样，我们遍历我们的AST，对于每个节点，我们将它写回文本，但格式化为例如</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="cfbc" class="lg lh iq lc b gy li lj l lk ll">fun formatVarDeclaration(node : Var) : String {<br/>   var builder = StringBuilder()<br/>   builder.append(indentation)<br/>   builder.append("var ")<br/>   builder.append(node.name)<br/>   builder.append(" = ")<br/>   builder.append(formatValue(node.value))<br/>   builder.append("\n")   <br/>   return builder.toString()<br/>}</span></pre><p id="3e36" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这个简单的方法中，我们将节点重写为字符串，但使用正确的缩进，并在它后面添加一个新行，这样现在两个变量在同一行中声明，值也使用另一个函数格式化。您可以使用访问者设计模式来简化所有节点的处理。</p><p id="1542" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这一步的最后，我们得到了一个表示相同输入文件但经过格式化的字符串，然后我们把它写回到文件中。</p><p id="5043" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是代码格式化程序的基本实现，一个真正的产品代码格式化程序必须处理更多的情况，例如代码无效怎么办？，我应该只格式化有效的代码吗？我们是否应该在每次格式化或编译代码时阅读整个程序？</p><p id="87d3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在回到Turtle graphics，在这个项目中，我已经完成了之前所有需要的步骤，并有一个现成的AST，所以我只是用代码重写它，就像你在^_^上面看到的那样，我从UI读取它，格式化它，并在我的例子中写回UI</p><p id="69a9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你感兴趣并想读更多，我建议</p><ul class=""><li id="30bc" class="ln lo iq ka b kb kc kf kg kj lp kn lq kr lr kv ls lt lu lv bi translated">至少读一本编译器的书，比如手工解释器</li><li id="6c5c" class="ln lo iq ka b kb lw kf lx kj ly kn lz kr ma kv ls lt lu lv bi translated">阅读关于语言服务器端口(LSP)的信息</li><li id="a97d" class="ln lo iq ka b kb lw kf lx kj ly kn lz kr ma kv ls lt lu lv bi translated">观看作者安德斯·海尔斯伯格解释的Typescript编译器</li><li id="3bac" class="ln lo iq ka b kb lw kf lx kj ly kn lz kr ma kv ls lt lu lv bi translated">想一想，如果你有一个和AST一样的程序，你还能用它做些什么</li></ul><p id="53fb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我希望你喜欢我的文章，你可以找到我</p><p id="eca7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以在:<a class="ae mb" href="https://github.com/amrdeveloper" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir">GitHub</strong></a><a class="ae mb" href="https://www.linkedin.com/in/amrdeveloper/" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir">LinkedIn</strong></a><a class="ae mb" href="https://twitter.com/amrdeveloper" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir">Twitter</strong></a>上找到我。</p><p id="4f11" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">享受编程😋。</p></div></div>    
</body>
</html>