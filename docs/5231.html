<html>
<head>
<title>Using Firebase Analytics Server-Side</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Firebase分析服务器端</h1>
<blockquote>原文：<a href="https://itnext.io/using-firebase-analytics-server-side-64ffacafa6c3?source=collection_archive---------0-----------------------#2021-01-18">https://itnext.io/using-firebase-analytics-server-side-64ffacafa6c3?source=collection_archive---------0-----------------------#2021-01-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/7f79312038e59e31b52e712b8ced4db3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SFFbo8lkNxVQcmLrLDVRNw.png"/></div></div></figure><div class=""/><h1 id="59ba" class="jy jz jb bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">问题是</h1><p id="84dc" class="pw-post-body-paragraph kw kx jb ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">总的来说，Firebase致力于为<em class="lu">客户端</em>(例如web客户端和移动客户端)提供有用的库和API。不幸的是，这意味着它们对服务器端环境的支持不够强大。在服务器上使用Firebase的典型方式是通过<a class="ae lv" href="https://firebase.google.com/docs/reference/admin" rel="noopener ugc nofollow" target="_blank">Admin SDK</a>；然而，它不具备与客户端API同等的特性。我们在这篇文章中关注的缺失特性是缺乏服务器端Firebase分析支持。注意Firebase团队意识到了这个问题；检查这个<a class="ae lv" href="https://github.com/firebase/firebase-js-sdk/issues/2243" rel="noopener ugc nofollow" target="_blank"> Github问题</a>和这个<a class="ae lv" href="https://github.com/firebase/firebase-js-sdk/issues/2243" rel="noopener ugc nofollow" target="_blank"> Github问题</a>。</p><p id="3666" class="pw-post-body-paragraph kw kx jb ky b kz lw lb lc ld lx lf lg lh ly lj lk ll lz ln lo lp ma lr ls lt ij bi translated">让我们回忆一下。下面是如何使用Firebase JavaScript SDK从web客户端记录事件。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="64da" class="mk jz jb mg b gy ml mm l mn mo">import firebase from "firebase";</span><span id="9939" class="mk jz jb mg b gy mp mm l mn mo">const firebaseConfig = { ... };<br/>firebase.initializeApp(firebaseConfig);<br/>firebase.analytics().logEvent("test_event", { some_param: 5 });</span></pre><p id="088e" class="pw-post-body-paragraph kw kx jb ky b kz lw lb lc ld lx lf lg lh ly lj lk ll lz ln lo lp ma lr ls lt ij bi translated">那么，我们如何从服务器上做同样的事情呢？</p></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><h1 id="66e7" class="jy jz jb bd ka kb mx kd ke kf my kh ki kj mz kl km kn na kp kq kr nb kt ku kv bi translated">有旋度的解</h1><p id="d87c" class="pw-post-body-paragraph kw kx jb ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我们的实现只需要满足两个要求:</p><ol class=""><li id="c9c9" class="nc nd jb ky b kz lw ld lx lh ne ll nf lp ng lt nh ni nj nk bi translated">它需要实际上能够记录东西…当然。</li><li id="bccb" class="nc nd jb ky b kz nl ld nm lh nn ll no lp np lt nh ni nj nk bi translated">它需要能够在调试模式下记录事情，因此可以在<a class="ae lv" href="https://firebase.google.com/docs/analytics/debugview" rel="noopener ugc nofollow" target="_blank">调试视图</a>中查看记录的事件。否则调试起来就太难了！</li></ol><p id="4c44" class="pw-post-body-paragraph kw kx jb ky b kz lw lb lc ld lx lf lg lh ly lj lk ll lz ln lo lp ma lr ls lt ij bi translated">二话没说，你来做吧:</p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="fa11" class="pw-post-body-paragraph kw kx jb ky b kz lw lb lc ld lx lf lg lh ly lj lk ll lz ln lo lp ma lr ls lt ij bi translated">为了让这个curl命令工作，您需要做两件事:</p><ol class=""><li id="497a" class="nc nd jb ky b kz lw ld lx lh ne ll nf lp ng lt nh ni nj nk bi translated">您需要为<code class="fe ns nt nu mg b">tid</code> URL参数提供一个值。你应该为你的Firebase项目使用<code class="fe ns nt nu mg b">measurementId</code>。这个<a class="ae lv" href="https://firebase.google.com/docs/analytics/get-started" rel="noopener ugc nofollow" target="_blank">链接</a>告诉你如何得到它。</li><li id="d162" class="nc nd jb ky b kz nl ld nm lh nn ll no lp np lt nh ni nj nk bi translated">您需要为<code class="fe ns nt nu mg b">cid</code> URL参数提供一个值。如果您只是在测试，您可以通过查看Firebase JS SDK从网络选项卡中的浏览器发送的请求并从其中一个复制<code class="fe ns nt nu mg b">cid</code>来找到它。请注意，<code class="fe ns nt nu mg b">cid</code>将作为一个cookie包含在向您的web服务器发出的请求中，所以当您实际从您的服务器登录时，您应该从该cookie中获得<code class="fe ns nt nu mg b">cid</code>。</li></ol><p id="80a2" class="pw-post-body-paragraph kw kx jb ky b kz lw lb lc ld lx lf lg lh ly lj lk ll lz ln lo lp ma lr ls lt ij bi translated">其他一些需要注意的重要事项:</p><ol class=""><li id="c862" class="nc nd jb ky b kz lw ld lx lh ne ll nf lp ng lt nh ni nj nk bi translated"><code class="fe ns nt nu mg b">_dbg=1</code>在调试视图中显示日志。所以，如果你用正确的<code class="fe ns nt nu mg b">tid</code>和<code class="fe ns nt nu mg b">cid</code>运行这个curl，你应该能够(几乎)立即验证它是否工作。</li><li id="3cb8" class="nc nd jb ky b kz nl ld nm lh nn ll no lp np lt nh ni nj nk bi translated">我不确定是否所有的标题都是必要的，但我知道至少有一些是必要的(例如<code class="fe ns nt nu mg b">user-agent</code>)。如果你好奇的话，我会让你来解决这个问题。</li><li id="af2a" class="nc nd jb ky b kz nl ld nm lh nn ll no lp np lt nh ni nj nk bi translated"><code class="fe ns nt nu mg b">en</code>是事件名称。</li><li id="c3d7" class="nc nd jb ky b kz nl ld nm lh nn ll no lp np lt nh ni nj nk bi translated">您可以使用<code class="fe ns nt nu mg b">ep</code>来记录特定事件的参数。例如，如果您在请求中包含<code class="fe ns nt nu mg b">ep.param1=5&amp;ep.param2=6</code>，它在DebugView中将会是这样的。</li></ol><figure class="mb mc md me gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nv"><img src="../Images/977f9424d931c7dbec9461580a6311da.png" data-original-src="https://miro.medium.com/v2/resize:fit:684/format:webp/1*4H8bvof93YLqP3Ikdth3NA.png"/></div></div></figure><p id="7af9" class="pw-post-body-paragraph kw kx jb ky b kz lw lb lc ld lx lf lg lh ly lj lk ll lz ln lo lp ma lr ls lt ij bi translated">最后，请注意，我发送的请求大多遵循Google的<a class="ae lv" href="https://developers.google.com/analytics/devguides/collection/protocol/v1/reference" rel="noopener ugc nofollow" target="_blank">测量协议(通用分析)</a>。但是他们的参考并不完整——例如，他们没有提到<code class="fe ns nt nu mg b">ep</code>查询参数。我通过从浏览器手动检查Firebase JS SDK发送的请求来解决剩下的问题。</p></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><h1 id="6cd4" class="jy jz jb bd ka kb mx kd ke kf my kh ki kj mz kl km kn na kp kq kr nb kt ku kv bi translated">带代码的解决方案</h1><p id="3cea" class="pw-post-body-paragraph kw kx jb ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">现在您已经有了curl命令，您应该能够将它翻译成您选择的服务器语言的代码。下面，我提供了一个Node.js参考实现来帮助您解决这个问题。</p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="nq nr l"/></div></figure><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="nq nr l"/></div></figure></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><h1 id="bfb7" class="jy jz jb bd ka kb mx kd ke kf my kh ki kj mz kl km kn na kp kq kr nb kt ku kv bi translated">测量协议(Google Analytics 4)怎么样？</h1><p id="13de" class="pw-post-body-paragraph kw kx jb ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">该<a class="ae lv" href="https://developers.google.com/analytics/devguides/collection/protocol/ga4" rel="noopener ugc nofollow" target="_blank">协议</a>应该提供以下功能:</p><blockquote class="nw nx ny"><p id="5cdf" class="kw kx lu ky b kz lw lb lc ld lx lf lg nz ly lj lk oa lz ln lo ob ma lr ls lt ij bi translated">Google Analytics 4的Google Analytics测量协议允许开发人员通过HTTP请求将事件直接发送到Google Analytics服务器。这允许开发人员从任何支持HTTP的环境中测量用户如何与他们的业务交互。值得注意的是，这使得测量服务器到服务器的交互变得容易。</p></blockquote><p id="184e" class="pw-post-body-paragraph kw kx jb ky b kz lw lb lc ld lx lf lg lh ly lj lk ll lz ln lo lp ma lr ls lt ij bi translated">然而，我在遵循他们的文档时遇到了一些问题，这就是为什么我采用了上面描述的方法。让我们来看看他们的说明:</p><figure class="mb mc md me gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oc"><img src="../Images/f8f56523977f3bb09b2d507d3b442fdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0ukvCCWcu7N6JlrknkYfxw.png"/></div></div></figure><p id="cd51" class="pw-post-body-paragraph kw kx jb ky b kz lw lb lc ld lx lf lg lh ly lj lk ll lz ln lo lp ma lr ls lt ij bi translated">好的，看起来不太坏。但是，如果您导航到<strong class="ky jc">管理&gt;数据流</strong>来查找链接到Firebase的Google analytics属性，您会看到:</p><figure class="mb mc md me gt is gh gi paragraph-image"><div class="gh gi od"><img src="../Images/05518c47731903cebca02e225ebe89d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/1*Si506jM5h73Nc10JHijhWw.png"/></div></figure><p id="eba1" class="pw-post-body-paragraph kw kx jb ky b kz lw lb lc ld lx lf lg lh ly lj lk ll lz ln lo lp ma lr ls lt ij bi translated">我想我不能创造一个新的秘密。</p><p id="e3fb" class="pw-post-body-paragraph kw kx jb ky b kz lw lb lc ld lx lf lg lh ly lj lk ll lz ln lo lp ma lr ls lt ij bi translated">让我们假设我们以某种方式解决了这个问题，并进入下一步:</p><figure class="mb mc md me gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oe"><img src="../Images/034e5b61e3d1804961e8b799e1588505.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b0i5rVv4pOFdaHgqR3gdrQ.png"/></div></div></figure><p id="dafa" class="pw-post-body-paragraph kw kx jb ky b kz lw lb lc ld lx lf lg lh ly lj lk ll lz ln lo lp ma lr ls lt ij bi translated">好，所以我们需要一个<code class="fe ns nt nu mg b">app_instance_id</code>。但是似乎没有任何方法可以为web客户端获得一个<code class="fe ns nt nu mg b">app_instance_id</code>？</p><p id="c1ec" class="pw-post-body-paragraph kw kx jb ky b kz lw lb lc ld lx lf lg lh ly lj lk ll lz ln lo lp ma lr ls lt ij bi translated">最后，我没有看到任何文档说明如何让这个协议记录的事件显示在DebugView中。</p><p id="0a83" class="pw-post-body-paragraph kw kx jb ky b kz lw lb lc ld lx lf lg lh ly lj lk ll lz ln lo lp ma lr ls lt ij bi translated">公平地说，谷歌确实警告你“这是一个alpha API，可能会有变化。”</p></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><p id="13bd" class="pw-post-body-paragraph kw kx jb ky b kz lw lb lc ld lx lf lg lh ly lj lk ll lz ln lo lp ma lr ls lt ij bi translated">就是这样。希望你觉得这有用！</p></div></div>    
</body>
</html>