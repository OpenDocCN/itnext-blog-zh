<html>
<head>
<title>Managing a multi-site Cassandra cluster on multiple Kubernetes with CassKop / MultiCassKop</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用CassKop / MultiCassKop管理多个Kubernetes上的多站点Cassandra集群</h1>
<blockquote>原文：<a href="https://itnext.io/managing-a-multi-site-cassandra-cluster-on-multiple-kubernetes-with-casskop-multicasskop-cf407c297701?source=collection_archive---------3-----------------------#2019-11-29">https://itnext.io/managing-a-multi-site-cassandra-cluster-on-multiple-kubernetes-with-casskop-multicasskop-cf407c297701?source=collection_archive---------3-----------------------#2019-11-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="f63a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/Orange-OpenSource/cassandra-k8s-operator" rel="noopener ugc nofollow" target="_blank"> CassKop </a>是一个Kubernetes运营商，它使得在Kubernetes上运行Apache Cassandra变得很容易。它可以创建、配置和管理运行在Kubernetes上的Cassandra集群。</p><p id="510a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在之前的帖子中，<a class="ae kl" href="https://medium.com/@john.sanda" rel="noopener">约翰·桑达</a>和<a class="ae kl" href="https://medium.com/@cscetbon" rel="noopener">西里尔·斯特邦</a>已经谈到了卡斯科普:</p><ul class=""><li id="0fe9" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated"><a class="ae kl" href="https://medium.com/@john.sanda/deploying-cassandra-in-kubernetes-with-casskop-1f721586825b" rel="noopener">https://medium . com/@ John . Sanda/deploying-Cassandra-in-kubernetes-with-cass kop-1f 721586825 b</a></li><li id="b1ce" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated"><a class="ae kl" href="https://medium.com/@john.sanda/create-affinity-between-cassandra-and-kubernetes-5b2f72d23293" rel="noopener">https://medium . com/@ John . Sanda/create-affinity-between-Cassandra-and-kubernetes-5b 2f 72d 23293</a></li><li id="3d80" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated"><a class="ae kl" href="https://medium.com/@cscetbon/casskop-a-kubernetes-operator-for-cassandra-4125fcb7a199" rel="noopener">https://medium . com/@ cscetbon/cass kop-a-kubernetes-operator-for-Cassandra-4125 fcb7a 199</a></li></ul><p id="85bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">CassKop引入了一个新的定制资源定义，<code class="fe la lb lc ld b">CassandraCluster</code>,它允许您描述想要部署的Cassandra集群。<br/>这在单个Kubernetes集群中工作得很好，并且允许在单区域多AZ拓扑中部署Cassandra。</p><p id="c6a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是为了让我们的Cassandra集群具有更大的弹性，我们希望能够将它扩展到几个地区。为了用Kubernetes做到这一点，我们需要我们的Cassandra在不同地区独立部署的不同Kubernetes集群之上传播。</p><p id="14fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">今天，我们引入MultiCassKop，这是一个适合CassKop的新操作符。MultiCassKop是一个新的控制器，它将负责在几个不同的Kubernetes集群中创建<code class="fe la lb lc ld b">CassandraClusters</code> CRD对象，并且所有的Cassandra节点都将成为同一个环的一部分。</p><p id="aef3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">MultiCassKop使用新的自定义资源定义<code class="fe la lb lc ld b"><a class="ae kl" href="https://github.com/Orange-OpenSource/cassandra-k8s-operator/tree/master/multi-casskop" rel="noopener ugc nofollow" target="_blank">MultiCasskop</a></code>，它允许指定:</p><ul class=""><li id="d489" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">CassandraCluster对象的基</li><li id="c281" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">为我们要部署的每个kubernetes集群覆盖这个基本对象。</li></ul><p id="8c46" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">概述:<br/>多CassKop的目标是在不同地区部署Cassandra集群，每个地区运行一个独立的Kubernetes集群。<br/> Multi-Casskop通过<br/>管理来自其自身Multi-Casskop自定义资源的CassandraCluster对象的一致创建，确保每个本地Casskop部署的Cassandra节点将成为同一个Cassandra环的一部分。</p><h1 id="1152" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">假设</h1><p id="f453" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">这篇文章探讨了如何在两个不同的站点(k8s-cluster1和k8s-cluster2)上建立一个Cassandra集群。</p><p id="1c78" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">MultiCasskop需要每个Cassandra pod能够独立地相互对话，它们属于集群k8s-cluster1或k8s-cluster2。为了实现这一目标，我们依靠:</p><ul class=""><li id="1c70" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated"><a class="ae kl" href="https://www.projectcalico.org/why-bgp/" rel="noopener ugc nofollow" target="_blank"> Calico </a> <br/>带有可路由网络池的网络插件，它将通过BGP将我们的pod地址传播到我们的网络路由器。</li><li id="df43" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated"><a class="ae kl" href="https://github.com/kubernetes-sigs/external-dns" rel="noopener ugc nofollow" target="_blank">带RFC2136 <br/>的外部DNS </a>，这将使我们能够为我们的每个pod提供外部域名解析。</li></ul><p id="8930" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们已经配置了kubectl，可以访问我们的两个kubernetes集群k8s-cluster1和k8s-cluster2。</p><p id="65f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该图显示了每个组件的连接方式:</p><figure class="mi mj mk ml gt mm gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi mh"><img src="../Images/a0e41a5db0d3e2f02e5442d9321b7e0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L7RNCQEKa5SnyV_GRSFwbA.png"/></div></div></figure><p id="db2d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">MultiCassKop从迭代每个传入参数的上下文开始，然后注册控制器。<br/>控制器需要能够与MultiCasskop和CassandraCluster CRD对象交互。<br/>此外，控制器需要监视MultiCasskop，因为它需要对给定名称空间的那些对象上发生的任何变化做出反应。</p><h1 id="79c0" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">装置</h1><h1 id="68e2" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">在每个k8s集群上创建名称空间</h1><p id="f6a8" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">我们需要为集群k8s-cluster1和k8s-cluster2分别创建一个命名空间和一个预配置的Calico <code class="fe la lb lc ld b">routable-1</code> IP池。</p><p id="6a41" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">k8s-cluster1的示例:</p><pre class="mi mj mk ml gt mt ld mu mv aw mw bi"><span id="c082" class="mx lf iq ld b gy my mz l na nb">cat &lt;&lt;EOF | kubectl apply -f -<br/>apiVersion: v1<br/>kind: Namespace<br/>metadata:<br/> name: cassandra-demo<br/> annotations:<br/> "cni.projectcalico.org/ipv4pools": '\["routable-1"\]'<br/> labels:<br/> app: cassandra<br/>EOF<br/>kubens cassandra-demo</span></pre><h1 id="0d67" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">从k8s-cluster-1到k8s-cluster-2的引导API访问</h1><p id="62d6" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">多Casskop将部署在k8s-cluster-1中，更改您的kubectl上下文以指向该集群。</p><p id="9e5f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了允许我们的多CassKop控制器从k8s-cluster-1访问k8s-cluster-2，我们将使用来自<a class="ae kl" href="https://admiralty.io/" rel="noopener ugc nofollow" target="_blank"> Admiralty </a>的<a class="ae kl" href="https://github.com/admiraltyio/multicluster-service-account/releases/tag/v0.6.1" rel="noopener ugc nofollow" target="_blank"> kubemcsa </a>来将秘密从k8s-cluster-2导出到k8s-cluster1</p><pre class="mi mj mk ml gt mt ld mu mv aw mw bi"><span id="293b" class="mx lf iq ld b gy my mz l na nb">kubemcsa export --context=cluster2 --namespace cassandra-demo cassandra-operator --as k8s-cluster2 | kubectl apply -f -</span></pre><blockquote class="nc nd ne"><p id="2ade" class="jn jo nf jp b jq jr js jt ju jv jw jx ng jz ka kb nh kd ke kf ni kh ki kj kk ij bi translated"><em class="iq">这将在当前k8s集群(必须是k8s-cluster-1)中创建与k8s-cluster2中的<br/></em><strong class="jp ir"><em class="iq">Cassandra-operator</em></strong><em class="iq">命名空间</em><strong class="jp ir"><em class="iq">Cassandra-demo</em></strong><em class="iq">服务帐户关联的k8s秘密。<br/> /！\秘密将以名称</em><strong class="jp ir"><em class="iq">k8s-cluster 2</em></strong><em class="iq">创建，并且在启动多任务CRD定义中的多任务和<br/>时必须使用该名称，见下文</em></p></blockquote><h1 id="355c" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">安装CassKop</h1><p id="4f01" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">CassKop必须部署在每个目标Kubernetes集群上。</p><p id="6da0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为CassKop添加舵库</p><pre class="mi mj mk ml gt mt ld mu mv aw mw bi"><span id="2d2b" class="mx lf iq ld b gy my mz l na nb">$ helm repo add casskop https://Orange-OpenSource.github.io/cassandra-k8s-operator/helm<br/>$ helm repo update</span></pre><h1 id="3b1f" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">安装外部DNS</h1><p id="f47a" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/kubernetes-sigs/external-dns" rel="noopener ugc nofollow" target="_blank">外部DNS </a>必须安装在每个Kubernetes集群中。<br/>使用指向您的区域的自定义值配置您的外部DNS，并将其部署到您的名称空间中</p><pre class="mi mj mk ml gt mt ld mu mv aw mw bi"><span id="d44c" class="mx lf iq ld b gy my mz l na nb">helm install -f ~/private/externaldns-values.yaml --name casskop-dns external-dns</span></pre><p id="2d2f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">外部DNS的目标是侦听由CassKop创建的Kubernetes服务，并将在您的区域中为与该服务相关联的每个pod创建一个DNS条目。<br/>这意味着我们将能够为CassKop自动创建的每个Cassandra pods拥有一个外部DNS条目。</p><p id="29b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为我们的pod使用Calico可路由IP地址，所以可以从我们的集群外部访问它们。</p><h1 id="01ed" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">安装多层机箱</h1><p id="52bc" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">仅当满足先决条件时，才进行多机箱安装。</p><p id="ee21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">带舵展开。Multi-CassKop和CassKop共享相同的GitHub/helm repo和语义版本。</p><pre class="mi mj mk ml gt mt ld mu mv aw mw bi"><span id="75ab" class="mx lf iq ld b gy my mz l na nb">helm install --name multi-casskop casskop/multi-casskop --set k8s.local=k8s-cluster1 --set k8s.remote={k8s-cluster2}</span></pre><blockquote class="nc nd ne"><p id="c62f" class="jn jo nf jp b jq jr js jt ju jv jw jx ng jz ka kb nh kd ke kf ni kh ki kj kk ij bi translated"><em class="iq">如果您得到一个报错消息，说CRD已经存在，那么用</em> <code class="fe la lb lc ld b"><em class="iq">--no-hooks</em></code>重新播放它</p></blockquote><p id="ceef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动Multi-CassKop时，我们需要给出一些参数:</p><ul class=""><li id="d35d" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">k8s.local是我们在与这个集群对话时想要引用的k8s集群的名称。</li><li id="2d87" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">k8s.remote是我们想要连接的其他kubernetes的列表。</li></ul><blockquote class="nc nd ne"><p id="8383" class="jn jo nf jp b jq jr js jt ju jv jw jx ng jz ka kb nh kd ke kf ni kh ki kj kk ij bi translated"><em class="iq">此处使用的名称应与MultiCassKop CRD定义中使用的名称相映射)<br/></em><code class="fe la lb lc ld b"><em class="iq">k8s.remote</em></code><em class="iq">中的名称必须与使用kubemcsa命令导出的机密名称相匹配</em></p></blockquote><p id="35b1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动时，我们的MultiCassKop控制器应该记录类似如下的内容:</p><pre class="mi mj mk ml gt mt ld mu mv aw mw bi"><span id="dfc1" class="mx lf iq ld b gy my mz l na nb">time="2019-11-28T14:51:57Z" level=info msg="Configuring Client 1 for local cluster k8s-cluster1 (first in arg list). using local k8s api access"<br/>time="2019-11-28T14:51:57Z" level=info msg="Configuring Client 2 for distant cluster k8s-cluster2. using imported secret of same name"<br/>time="2019-11-28T14:51:57Z" level=info msg="Creating Controller"<br/>time="2019-11-28T14:51:57Z" level=info msg="Create Client 1 for Cluster k8s-cluster1"<br/>time="2019-11-28T14:51:57Z" level=info msg="Add CRDs to Cluster k8s-cluster1 Scheme"<br/>time="2019-11-28T14:51:57Z" level=info msg="Create Client 2 for Cluster k8s-cluster2"<br/>time="2019-11-28T14:51:58Z" level=info msg="Add CRDs to Cluster k8s-cluster2 Scheme"<br/>time="2019-11-28T14:51:58Z" level=info msg="Configuring Watch for MultiCasskop"<br/>time="2019-11-28T14:51:58Z" level=info msg="Configuring Watch for MultiCasskop"<br/>time="2019-11-28T14:51:58Z" level=info msg="Writing ready file."<br/>time="2019-11-28T14:51:58Z" level=info msg="Starting Manager."</span></pre><h1 id="027f" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">创建多通道CRD</h1><p id="d956" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">Multi-CassKop引入了一个新的自定义资源，并将负责在每个<br/> k8s集群中创建CassandraCluster资源。</p><p id="3b50" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">MultiCasskop的Spec字段有一个包含有效CassandraCluster对象的<code class="fe la lb lc ld b">base</code>参数。<br/>它还有一个<code class="fe la lb lc ld b">override</code>部分，允许根据目标集群覆盖CassandraCluster基本定义的特定部分<br/>。</p><p id="c802" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在<code class="fe la lb lc ld b">multi-casskop/samples/multi-casskop.yaml</code>文件中找到一个MultiCassKop的例子:</p><p id="d76e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个多教室的结构:</p><pre class="mi mj mk ml gt mt ld mu mv aw mw bi"><span id="2f2e" class="mx lf iq ld b gy my mz l na nb">apiVersion: db.orange.com/v1alpha1<br/>kind: MultiCasskop<br/>metadata:<br/>  name: multi-casskop-e2e<br/>spec:<br/>  # Add fields here<br/>  deleteCassandraCluster: <strong class="ld ir">true</strong><br/>  base:<br/>    &lt;The base of the CassandraCluster object you want Multi-CassKop to create&gt;<br/>    ...<br/>    status: #&lt;!!-- At this time the seedlist must be provided Manually. we know in advance the domain name<br/>            # it's the &lt;pod-name&gt;.&lt;your-external-dns-domain&gt;<br/>      seedlist:<br/>        - cassandra-e2e-dc1-rack1-0.my.zone.dns.net<br/>        - cassandra-e2e-dc1-rack1-1.my.zone.dns.net<br/>        - cassandra-e2e-dc2-rack4-0.my.zone.dns.net<br/>        - cassandra-e2e-dc2-rack4-1.my.zone.dns.net      <br/>  override:<br/>    k8s-cluster1: #&lt;!!-- here is the name which must correspond to the helm argument `k8s.local`<br/>      spec: #&lt;-- Here we defined overrides part for the CassandraCluster for the k8s-cluster1<br/>        pod:<br/>          annotations:<br/>            cni.projectcalico.org/ipv4pools: '["routable"]' #&lt;!-- If using external DNS, change with your current zone<br/>        topology:<br/>          dc:<br/>          ...<br/>    k8s-cluster2: #&lt;!!-- here is the name which must correspond to the helm argument `k8s.remote`<br/>      spec:<br/>        pod:<br/>          annotations:<br/>            cni.projectcalico.org/ipv4pools: '["routable"]' #&lt;!-- If using external DNS, change with your current zone<br/>        imagepullpolicy: IfNotPresent<br/>        topology:<br/>          dc:<br/>          ...</span></pre><p id="b515" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以通过以下方式创建集群:</p><pre class="mi mj mk ml gt mt ld mu mv aw mw bi"><span id="8efe" class="mx lf iq ld b gy my mz l na nb">k apply -f multi-casskop/samples/multi-casskop.yaml</span></pre><p id="f4e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，您可以看到MultiCassKop日志:</p><pre class="mi mj mk ml gt mt ld mu mv aw mw bi"><span id="703b" class="mx lf iq ld b gy my mz l na nb">time="2019-11-28T15:46:19Z" level=info msg="Just Update CassandraCluster, returning for now.." cluster=cassandra-e2e kubernetes=k8s-cluster1 namespace=cassandra-e2e<br/>time="2019-11-28T15:46:19Z" level=info msg="Cluster is not Ready, we requeue [phase= / action= / status=]" cluster=cassandra-e2e kubernetes=k8s-cluster1 namespace=cassandra-e2e<br/>time="2019-11-28T15:46:49Z" level=info msg="Cluster is not Ready, we requeue [phase=Initializing / action=Initializing / status=Ongoing]" cluster=cassandra-e2e kubernetes=k8s-cluster1 namespace=cassandra-e2e<br/>time="2019-11-28T15:47:19Z" level=info msg="Cluster is not Ready, we requeue [phase=Initializing / action=Initializing / status=Ongoing]" cluster=cassandra-e2e kubernetes=k8s-cluster1 namespace=cassandra-e2e<br/>time="2019-11-28T15:47:49Z" level=info msg="Cluster is not Ready, we requeue [phase=Initializing / action=Initializing /status=Ongoing]" cluster=cassandra-e2e kubernetes=k8s-cluster1 namespace=cassandra-e2e<br/>time="2019-11-28T15:47:19Z" level=info msg="Cluster is not Ready, we requeue [phase=Initializing / action=Initializing / status=Ongoing]" cluster=cassandra-e2e kubernetes=k8s-cluster1 namespace=cassandra-e2e<br/>time="2019-11-28T15:47:49Z" level=info msg="Cluster is not Ready, we requeue [phase=Initializing / action=Initializing / status=Ongoing]" cluster=cassandra-e2e kubernetes=k8s-cluster1 namespace=cassandra-e2e<br/>time="2019-11-28T15:48:19Z" level=info msg="Cluster is not Ready, we requeue [phase=Initializing / action=Initializing / status=Ongoing]" cluster=cassandra-e2e kubernetes=k8s-cluster1 namespace=cassandra-e2e<br/>time="2019-11-28T15:48:49Z" level=info msg="Cluster is not Ready, we requeue [phase=Initializing / action=Initializing / status=Ongoing]" cluster=cassandra-e2e kubernetes=k8s-cluster1 namespace=cassandra-e2e<br/>time="2019-11-28T15:49:19Z" level=info msg="Just Update CassandraCluster, returning for now.." cluster=cassandra-e2e kubernetes=k8s-cluster2 namespace=cassandra-e2e<br/>time="2019-11-28T15:49:49Z" level=info msg="Cluster is not Ready, we requeue [phase=Initializing / action=Initializing / status=Ongoing]" cluster=cassandra-e2e kubernetes=k8s-cluster2 namespace=cassandra-e2e<br/>time="2019-11-28T15:50:19Z" level=info msg="Cluster is not Ready, we requeue [phase=Initializing / action=Initializing / status=Ongoing]" cluster=cassandra-e2e kubernetes=k8s-cluster2 namespace=cassandra-e2e<br/>time="2019-11-28T15:50:49Z" level=info msg="Cluster is not Ready, we requeue [phase=Initializing / action=Initializing / status=Ongoing]" cluster=cassandra-e2e kubernetes=k8s-cluster2 namespace=cassandra-e2e<br/>time="2019-11-28T15:51:19Z" level=info msg="Cluster is not Ready, we requeue [phase=Initializing / action=Initializing / status=Ongoing]" cluster=cassandra-e2e kubernetes=k8s-cluster2 namespace=cassandra-e2e<br/>time="2019-11-28T15:51:49Z" level=info msg="Cluster is not Ready, we requeue [phase=Initializing / action=Initializing / status=Ongoing]" cluster=cassandra-e2e kubernetes=k8s-cluster2 namespace=cassandra-e2e</span></pre><p id="7250" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">操作顺序如下:</p><ul class=""><li id="b186" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">MultiCassKop首先在k8s-cluster1中创建CassandraCluster。</li><li id="6f82" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">然后本地CassKop开始创建相关的Cassandra集群。</li><li id="a4b4" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">当CassKop结束创建它的集群时，它用phase=Running更新CassandraCluster状态，这意味着<br/>一切正常</li><li id="190e" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">然后MultiCassKop开始在k8s-cluster2中创建另一个CassandraCluster</li><li id="bca9" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">然后本地CassKop开始创建相关的Cassandra集群。</li><li id="498a" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">由于配置了外部DNS名称的可路由种子列表，Cassandra pods通过连接到k8s-cluster1中已经存在的Cassandra节点来启动，目标是形成唯一的Cassandra环。</li></ul><p id="9857" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在结果中，我们可以看到每个集群都有所需的pod。</p><p id="678f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们进入其中一个创建的pod，我们可以看到nodetool看到两个集群的pod:</p><pre class="mi mj mk ml gt mt ld mu mv aw mw bi"><span id="195b" class="mx lf iq ld b gy my mz l na nb">cassandra@cassandra-e2e-dc1-rack2-0:/$ nodetool status<br/>Datacenter: dc1<br/>===============<br/>Status=Up/Down<br/>|/ State=Normal/Leaving/Joining/Moving<br/>--  Address         Load       Tokens       Owns (effective)  Host ID                               Rack<br/>UN  10.100.146.150  93.95 KiB  256          49.8%             cfabcef2-3f1b-492d-b028-0621eb672ec7  rack2<br/>UN  10.100.146.108  108.65 KiB  256          48.3%             d1185b37-af0a-42f9-ac3f-234e541f14f0  rack1<br/>Datacenter: dc2<br/>===============<br/>Status=Up/Down<br/>|/ State=Normal/Leaving/Joining/Moving<br/>--  Address         Load       Tokens       Owns (effective)  Host ID                               Rack<br/>UN  10.100.151.38   69.89 KiB  256          51.4%             ec9003e0-aa53-4150-b4bb-85193d9fa180  rack5<br/>UN  10.100.150.34   107.89 KiB  256          50.5%             a28c3c59-786f-41b6-8eca-ca7d7d14b6df  rack4</span><span id="80b6" class="mx lf iq ld b gy nj mz l na nb">cassandra@cassandra-e2e-dc1-rack2-0:/$</span></pre><h1 id="d4dd" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">删除卡珊德拉集群2</h1><p id="a07b" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">如果您已经将<code class="fe la lb lc ld b">deleteCassandraCluster</code>键设置为true，那么当删除<code class="fe la lb lc ld b">MultiCassKop</code>对象时，它将级联删除目标k8s簇中的<code class="fe la lb lc ld b">CassandraCluster </code>对象。然后每个本地卡斯克普将删除他们的<br/>卡珊德拉集群。</p><p id="4fe9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以在MultiCassKop日志中看到</p><pre class="mi mj mk ml gt mt ld mu mv aw mw bi"><span id="682f" class="mx lf iq ld b gy my mz l na nb">time="2019-11-28T15:44:00Z" level=info msg="Delete CassandraCluster" cluster=cassandra-e2e kubernetes=k8s-cluster1 namespace=cassandra-e2e<br/>time="2019-11-28T15:44:00Z" level=info msg="Delete CassandraCluster" cluster=cassandra-e2e kubernetes=k8s-cluster2 namespace=cassandra-e2e</span></pre></div></div>    
</body>
</html>