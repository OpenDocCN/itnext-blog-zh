<html>
<head>
<title>Elasticsearch Autocomplete for Django</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Django的Elasticsearch自动完成</h1>
<blockquote>原文：<a href="https://itnext.io/elasticsearch-autocomplete-for-django-9dffef1d3afb?source=collection_archive---------0-----------------------#2019-02-15">https://itnext.io/elasticsearch-autocomplete-for-django-9dffef1d3afb?source=collection_archive---------0-----------------------#2019-02-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="0f29" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你知道什么是Elasticsearch，想知道如何用它来改进你的网站搜索？</p><p id="95c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们从<a class="ae kl" href="https://medium.com/@s.lyapustin/django-polls-app-with-elasticsearch-ffc02b9e79d9" rel="noopener">上一篇文章</a>更新我们的搜索，使其具有自动完成功能。</p><h1 id="f356" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">什么是自动完成？</h1><p id="a490" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">自动完成是你的搜索表单的一个很好的特性，当用户试图在你的网站上写搜索查询时，你可以用建议来引导他。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/6de8d04d6372bd485542039dc20b1e02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*209COHJ1LFfInRPuWQFylQ.png"/></div></div></figure><h1 id="4a11" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">N-Grams</h1><p id="81bf" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">为了使用自动完成，我们会将用户输入发送到我们的后端，因为他们在输入字段中键入它。该输入通常包括各种组合的短语。</p><p id="78bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了得到最好的结果，我们需要使用<a class="ae kl" href="https://medium.com/programming-tid-bits/weekend-hacks-n-grams-f4398fc9d554" rel="noopener"><em class="mb">n-grams</em></a><em class="mb"/>到<em class="mb"> </em>对原文中的单词组合生成有效的索引。</p><p id="3c35" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将在搜索索引上创建一个额外的<strong class="jp ir"> EdgeNgramField </strong>字段来存储基于问题<strong class="jp ir"> question_text </strong>字段的数据:</p><pre class="lq lr ls lt gt mc md me mf aw mg bi"><span id="bce4" class="mh kn iq md b gy mi mj l mk ml"><strong class="md ir">class </strong>QuestionIndex(indexes.SearchIndex, indexes.Indexable):<br/>    ...<br/>    text_auto = indexes.EdgeNgramField(model_attr=<strong class="md ir">'question_text'</strong>)<br/>    ...</span></pre><p id="3194" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于我们已经更改了索引模式，因此需要重建索引:</p><pre class="lq lr ls lt gt mc md me mf aw mg bi"><span id="7ef9" class="mh kn iq md b gy mi mj l mk ml">./manage.py rebuild_index</span></pre><p id="fe0c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们可以使用Haystack<a class="ae kl" href="https://django-haystack.readthedocs.io/en/latest/searchqueryset_api.html#autocomplete" rel="noopener ugc nofollow" target="_blank">autocomplete()</a>方法进行查询:</p><pre class="lq lr ls lt gt mc md me mf aw mg bi"><span id="a7a6" class="mh kn iq md b gy mi mj l mk ml">SearchQuerySet().autocomplete(text_auto='old')</span></pre><p id="04f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另外，让我们稍微改变一下Haystack设置，这样我们的模型中的任何更新都会在出现时立即发送到Elasticsearch。因此，如果您添加、更新或删除问题，他们会立即发送到Elasticsearch:</p><pre class="lq lr ls lt gt mc md me mf aw mg bi"><span id="c4fe" class="mh kn iq md b gy mi mj l mk ml"># Update Search index in realtime (using models.db.signals)<br/>HAYSTACK_SIGNAL_PROCESSOR = <strong class="md ir">'haystack.signals.RealtimeSignalProcessor'</strong></span></pre><p id="da8a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这基本上是我们在弹性搜索/干草堆方面需要做的所有事情。</p><h1 id="8198" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">自动完成视图</h1><p id="ca07" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">为了处理自动完成请求，让我们创建一个端点<code class="fe mm mn mo md b">/autocomplete?q=&lt;&gt;</code>`，它将响应与用户输入相匹配的问题的JSON列表。</p><p id="b83c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，如果用户输入query <code class="fe mm mn mo md b">elastic djan</code>，它将使用适当问题列表的JSON列表进行响应。为了前任。：</p><pre class="lq lr ls lt gt mc md me mf aw mg bi"><span id="1d82" class="mh kn iq md b gy mi mj l mk ml">{<br/>  "results": <br/>    [<br/>      "Django Elasticsearch",<br/>      "Poll App with Elastcisearch and Django"<br/>]</span></pre><p id="534c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">视图非常简单，它接受<code class="fe mm mn mo md b">q</code> GET查询，进行自动完成搜索，并返回5个最相关问题的字符串表示作为JSON响应:</p><pre class="lq lr ls lt gt mc md me mf aw mg bi"><span id="89a1" class="mh kn iq md b gy mi mj l mk ml"><strong class="md ir">def </strong>autocomplete(request):<br/>    max_items = 5<br/>    q = request.GET.get(<strong class="md ir">'q'</strong>)<br/>    <strong class="md ir">if </strong>q:<br/>        sqs = SearchQuerySet().autocomplete(text_auto=q)<br/>        results = [str(result.object) <strong class="md ir">for </strong>result <strong class="md ir">in </strong>sqs[:max_items]]<br/>    <strong class="md ir">else</strong>:<br/>        results = []<br/><br/>    <strong class="md ir">return </strong>JsonResponse({<br/>        <strong class="md ir">'results'</strong>: results<br/>    })</span></pre><p id="3516" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们将该视图添加到<code class="fe mm mn mo md b">urls.py</code>文件中的<code class="fe mm mn mo md b">urlpatterns</code>:</p><pre class="lq lr ls lt gt mc md me mf aw mg bi"><span id="cf21" class="mh kn iq md b gy mi mj l mk ml">urlpatterns = [<br/>    ...<br/>    path(<strong class="md ir">'autocomplete/'</strong>, views.autocomplete, name=<strong class="md ir">'autocomplete'</strong>),<br/>]</span></pre><p id="b4c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">后端就是这样。</p><h1 id="67b2" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">在前端处理自动完成</h1><p id="8d67" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">有很多JS助手会这样做。我们将重用jQuery <a class="ae kl" href="https://github.com/inoks/django-polls-elasticsearch/blob/master/app/polls/static/polls/js/autocomplete.js" rel="noopener ugc nofollow" target="_blank">从草堆中自动完成</a><a class="ae kl" href="https://django-haystack.readthedocs.io/en/latest/autocomplete.html#example-implementation" rel="noopener ugc nofollow" target="_blank">示例</a>:</p><pre class="lq lr ls lt gt mc md me mf aw mg bi"><span id="3170" class="mh kn iq md b gy mi mj l mk ml">&lt;<strong class="md ir">form action="</strong>{% <strong class="md ir">url 'haystack_search' </strong>%}<strong class="md ir">" class="autocomplete"</strong>&gt;<br/>  &lt;<strong class="md ir">label for="q"</strong>&gt;Search&lt;/<strong class="md ir">label</strong>&gt;<br/>  &lt;<strong class="md ir">input id="q" name="q" type="text" autocomplete="off"</strong>&gt;<br/>  &lt;<strong class="md ir">input type="submit" value="Search!"</strong>&gt;<br/>&lt;/<strong class="md ir">form</strong>&gt;<br/><br/><br/>&lt;<strong class="md ir">script src="https://code.jquery.com/jquery-3.3.1.min.js"</strong>&gt;&lt;/<strong class="md ir">script</strong>&gt;<br/>&lt;<strong class="md ir">script src="</strong>{% <strong class="md ir">static 'polls/js/autocomplete.js' </strong>%}<strong class="md ir">"</strong>&gt;&lt;/<strong class="md ir">script</strong>&gt;<br/><br/>&lt;<strong class="md ir">script type="text/javascript"</strong>&gt;<br/>  <strong class="md ir">$</strong>(<strong class="md ir">function </strong>() {<br/>    <strong class="md ir"><em class="mb">window</em></strong>.<strong class="md ir">autocomplete </strong>= <strong class="md ir">new </strong><em class="mb">Autocomplete</em>({<br/>      <strong class="md ir">form_selector</strong>: <strong class="md ir">'.autocomplete'</strong>,<br/>      <strong class="md ir">url</strong>: <strong class="md ir">'</strong>{% <strong class="md ir">url 'polls:autocomplete' </strong>%}<strong class="md ir">'<br/>    </strong>});<br/>    <strong class="md ir"><em class="mb">window</em></strong>.<strong class="md ir">autocomplete</strong>.setup()<br/>  });<br/>&lt;/<strong class="md ir">script</strong>&gt;</span></pre><p id="0944" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在这里做什么？我们有一个带有输入字段的表单，这是我们的自动完成查询的来源。</p><p id="2880" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦用户输入的查询字符串超过3个符号，我们就向我们的<code class="fe mm mn mo md b">/autocomplete</code>端点发送一个请求，以便找到相关的内容。</p><p id="35b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们找到了什么—我们会将它显示在输入字段下，可以选择该字段进行搜索查询。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/7adb8282131d9f25ee3f6b4edae8d967.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/1*wRYhge1uchS3DDJOHvP4dw.png"/></div></figure><p id="35eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样。</p></div></div>    
</body>
</html>