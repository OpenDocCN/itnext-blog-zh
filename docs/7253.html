<html>
<head>
<title>Goodbye Sealed Secrets, hello SOPS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">再见密封的秘密，你好SOPS</h1>
<blockquote>原文：<a href="https://itnext.io/goodbye-sealed-secrets-hello-sops-3ee6a92662bb?source=collection_archive---------0-----------------------#2022-07-30">https://itnext.io/goodbye-sealed-secrets-hello-sops-3ee6a92662bb?source=collection_archive---------0-----------------------#2022-07-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/5f2bb41d01c1418ec43179e09ad16c11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KZbmpPjlYp3-D8KDKpV0aA.png"/></div></div></figure><div class=""/><div class=""><h2 id="c1d4" class="pw-subtitle-paragraph jy ja jb bd b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp dk translated">本教程将为您提供在shell、Kubernetes、Helm和Visual Studio代码中设置sop的所有步骤和命令。</h2></div><p id="9be3" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">我们假设您在Windows上使用WSL作为Linux环境。我们将在两者中设置标准操作程序。</p><p id="d777" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">想一头扎进去吗？点击<a class="ae lm" href="#8f5b" rel="noopener ugc nofollow">这里</a>直接跳转到安装部分。</p><p id="d0b9" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">安装盖:</p><ul class=""><li id="966f" class="ln lo jb ks b kt ku kw kx kz lp ld lq lh lr ll ls lt lu lv bi translated">壳</li><li id="e3c2" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated">舵</li><li id="8de6" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated">Visual Studio代码</li></ul><h1 id="3ad9" class="mb mc jb bd md me mf mg mh mi mj mk ml kh mm ki mn kk mo kl mp kn mq ko mr ms bi translated">什么是sop</h1><p id="a658" class="pw-post-body-paragraph kq kr jb ks b kt mt kc kv kw mu kf ky kz mv lb lc ld mw lf lg lh mx lj lk ll ij bi translated">Sops 是一个能够加密配置文件的二进制程序。但是Sops理解格式(JSON、YAML、INI等),并且只加密每一行的值(在一个键/值对中),而不是加密整个文件。</p><blockquote class="my mz na"><p id="6026" class="kq kr nb ks b kt ku kc kv kw kx kf ky nc la lb lc nd le lf lg ne li lj lk ll ij bi translated">目的是将包含敏感信息的加密配置存储到您的版本系统(Git、SVN等)中，然后能够毫不费力地使用这些加密文件。</p></blockquote><p id="ab81" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">sop提供了以下优势:</p><ol class=""><li id="ce3c" class="ln lo jb ks b kt ku kw kx kz lp ld lq lh lr ll nf lt lu lv bi translated">加密值而非密钥<br/>–即使加密也能保留文件结构</li><li id="ac79" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll nf lt lu lv bi translated">将加密文件安全保存到Git</li><li id="16a5" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll nf lt lu lv bi translated">无缝编辑加密文件<br/>–Sops将在您最喜欢的文本编辑器中打开文件的未加密版本<br/>–保存时，文件将自动使用新内容重新加密</li><li id="10fa" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll nf lt lu lv bi translated">加密特定的密钥，而不是整个文件<br/>–非常适合包含少量敏感信息的长配置文件。</li><li id="3f45" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll nf lt lu lv bi translated">使用所有的配置文件，而不仅仅是Kubernetes的秘密<br/>——可以加密你的头盔的<code class="fe ng nh ni nj b">values.yaml</code>文件，以安全地存储其中的敏感数据(密码等)</li><li id="0147" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll nf lt lu lv bi translated">Kubernetes中不需要后端<br/>-唯一的要求是在本地安装sop<br/>-管理加密文件将在本地完成</li><li id="cdd7" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll nf lt lu lv bi translated">所有主要工具都有插件来支持sop工作</li></ol><h2 id="cb24" class="nk mc jb bd md nl nm dn mh nn no dp ml kz np nq mn ld nr ns mp lh nt nu mr nv bi translated">Sops加密示例</h2><p id="7dc8" class="pw-post-body-paragraph kq kr jb ks b kt mt kc kv kw mu kf ky kz mv lb lc ld mw lf lg lh mx lj lk ll ij bi translated">假设我们有这个经典的Kubernetes秘密。秘密值不加密，而只编码为base64。</p><pre class="nw nx ny nz gt oa nj ob oc aw od bi"><span id="2261" class="nk mc jb nj b gy oe of l og oh"><strong class="nj jc">apiVersion</strong>: v1<br/><strong class="nj jc">data</strong>:<br/>  <strong class="nj jc">secret_value</strong>: U29wcyBydWxlcw== 📖<br/><strong class="nj jc">kind</strong>: Secret<br/><strong class="nj jc">metadata</strong>:<br/>  <strong class="nj jc">creationTimestamp</strong>: null<br/>  <strong class="nj jc">name</strong>: my-secret<br/>  <strong class="nj jc">namespace</strong>: default</span></pre><p id="d3ea" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">接受sop后，你会得到:</p><pre class="nw nx ny nz gt oa nj ob oc aw od bi"><span id="8039" class="nk mc jb nj b gy oe of l og oh"><strong class="nj jc">apiVersion</strong>: ENC[AES256_GCM,data:PFk=,iv:,[...]tag:G9mg==,type:str]🔒<br/><strong class="nj jc">data</strong>:<br/>    <strong class="nj jc">secret_value</strong>: ENC[AES256_GCM,data:Ex2KhoAlCG4w==,[...]🔒<br/><strong class="nj jc">kind</strong>: ENC[AES256_GCM,data:eW1JrnrV,[...]🔒<br/><strong class="nj jc">metadata</strong>:<br/>    <strong class="nj jc">creationTimestamp</strong>: null<br/>    <strong class="nj jc">name</strong>: ENC[AES256_GCM,data:fkWXVtQS/C62,iv:GCTfamtu4ixP4w=[...]🔒<br/>    <strong class="nj jc">namespace</strong>: ENC[AES256_GCM,data:J96kuhjMUA==,iv:QZMnvDGqX[...]🔒<br/><strong class="nj jc">sops</strong>:<br/>[...]</span></pre><p id="317c" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">如您所见，所有的值都被加密了。但是密钥仍然是明文。</p><p id="803f" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">sop也可以根据你给它的密钥加密特定的值。<br/>这里，假设我们想要<strong class="ks jc">仅</strong>加密“secret_value”密钥:</p><pre class="nw nx ny nz gt oa nj ob oc aw od bi"><span id="dae0" class="nk mc jb nj b gy oe of l og oh"><strong class="nj jc">apiVersion</strong>: v1📖<br/><strong class="nj jc">data</strong>:<br/>    <strong class="nj jc">secret_value</strong>: ENC[AES256_GCM,data:9VBm+32QSCOaU+9exohSg==[...]🔒<br/><strong class="nj jc">kind</strong>: Secret📖<br/><strong class="nj jc">metadata</strong>:<br/>    <strong class="nj jc">creationTimestamp</strong>: null<br/>    <strong class="nj jc">name</strong>: my-secret📖<br/>    <strong class="nj jc">namespace</strong>: default📖<br/><strong class="nj jc">sops</strong>:<br/>[...]</span></pre><p id="805d" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">只有“secret_value”值被加密。文件的其余部分保持不变。</p><h1 id="89c7" class="mb mc jb bd md me mf mg mh mi mj mk ml kh mm ki mn kk mo kl mp kn mq ko mr ms bi translated">为什么我们不再使用密封的秘密</h1><h2 id="0940" class="nk mc jb bd md nl nm dn mh nn no dp ml kz np nq mn ld nr ns mp lh nt nu mr nv bi translated">它是做什么的？</h2><p id="3418" class="pw-post-body-paragraph kq kr jb ks b kt mt kc kv kw mu kf ky kz mv lb lc ld mw lf lg lh mx lj lk ll ij bi translated">我们已经使用密封机密一年了，但现在是改变的时候了。这项(很酷的)技术允许你在磁盘上加密一个Kubernetes秘密，然后在GIT上提交。这样，即使黑客得到了你的存储库，他也无法访问你的秘密内容。</p><h2 id="90e9" class="nk mc jb bd md nl nm dn mh nn no dp ml kz np nq mn ld nr ns mp lh nt nu mr nv bi translated">为什么不完美？</h2><p id="8c64" class="pw-post-body-paragraph kq kr jb ks b kt mt kc kv kw mu kf ky kz mv lb lc ld mw lf lg lh mx lj lk ll ij bi translated">SealedSecret对于很多用例来说都很棒。但在我们看来，它确实有些不足:</p><ul class=""><li id="a88c" class="ln lo jb ks b kt ku kw kx kz lp ld lq lh lr ll ls lt lu lv bi translated">必须在集群中安装后端</li><li id="e11e" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated">证书轮换可能会变得复杂</li><li id="910f" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated">默认加密模式不允许将机密从一个名称空间移动到另一个名称空间</li><li id="610e" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll ls lt lu lv bi translated">在Kubernetes集群上，生成的秘密仍然是明文</li></ul><p id="82b2" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><strong class="ks jc">但是最有问题的部分是……</strong></p><blockquote class="my mz na"><p id="e4dc" class="kq kr nb ks b kt ku kc kv kw kx kf ky nc la lb lc nd le lf lg ne li lj lk ll ij bi translated">我们将敏感数据以纯文本形式存储在舵图中，例如舵图的“values.yaml”中的密码。<strong class="ks jc">这根本不在保密范围内。</strong></p></blockquote><h1 id="8f5b" class="mb mc jb bd md me mf mg mh mi mj mk ml kh mm ki mn kk mo kl mp kn mq ko mr ms bi translated">安装标准操作程序</h1><h2 id="dfbc" class="nk mc jb bd md nl nm dn mh nn no dp ml kz np nq mn ld nr ns mp lh nt nu mr nv bi translated">在WSL上安装Sops二进制文件</h2><p id="e4e3" class="pw-post-body-paragraph kq kr jb ks b kt mt kc kv kw mu kf ky kz mv lb lc ld mw lf lg lh mx lj lk ll ij bi translated">下载linux的二进制文件:<a class="ae lm" href="https://github.com/mozilla/sops/releases" rel="noopener ugc nofollow" target="_blank">https://github.com/mozilla/sops/releases</a></p><pre class="nw nx ny nz gt oa nj ob oc aw od bi"><span id="a4b8" class="nk mc jb nj b gy oe of l og oh">$ wget &lt;URL_OF_THE_BIN_FROM_GITHUB&gt;<br/>$ sudo mv sops-&lt;VERSION&gt; /usr/local/bin/sops</span></pre><h2 id="006c" class="nk mc jb bd md nl nm dn mh nn no dp ml kz np nq mn ld nr ns mp lh nt nu mr nv bi translated">安装年龄</h2><figure class="nw nx ny nz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oi"><img src="../Images/b3e3f4e94bdf04f655711cc54636b9f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2Wj6BlrIcYwgNQw-.png"/></div></div></figure><p id="03dc" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">Sops本身并不加密。它利用了其他加密技术，如PGP、AGE、GCP KMS、Azure key vault、Hashicorp Vault等</p><p id="6560" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">由于PGP有点过时，我们将安装新的版本:<strong class="ks jc">年龄</strong></p><p id="d6d2" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">年龄是加密文件的工具。它不关心文件本身的格式。为了只加密文件的值或部分，我们需要依赖sop。年龄只是Sops会用的一个工具。</p><p id="39cf" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">让我们安装年龄…</p><pre class="nw nx ny nz gt oa nj ob oc aw od bi"><span id="9f97" class="nk mc jb nj b gy oe of l og oh">$ AGE_VERSION=$(curl -s "<a class="ae lm" href="https://api.github.com/repos/FiloSottile/age/releases/latest" rel="noopener ugc nofollow" target="_blank">https://api.github.com/repos/FiloSottile/age/releases/latest</a>" | grep -Po '"tag_name": "(v.*)"' |grep -Po '[0-9].*[0-9]')</span><span id="b532" class="nk mc jb nj b gy oj of l og oh">$ curl -Lo age.tar.gz "<a class="ae lm" href="https://github.com/FiloSottile/age/releases/latest/download/age-v${AGE_VERSION}-linux-amd64.tar.gz" rel="noopener ugc nofollow" target="_blank">https://github.com/FiloSottile/age/releases/latest/download/age-v${AGE_VERSION}-linux-amd64.tar.gz</a>"</span><span id="1d2c" class="nk mc jb nj b gy oj of l og oh">$ tar xf age.tar.gz</span><span id="c6b2" class="nk mc jb nj b gy oj of l og oh">$ sudo mv age/age /usr/local/bin</span><span id="dc57" class="nk mc jb nj b gy oj of l og oh">$ sudo mv age/age-keygen /usr/local/bin</span></pre><h2 id="3eab" class="nk mc jb bd md nl nm dn mh nn no dp ml kz np nq mn ld nr ns mp lh nt nu mr nv bi translated">生成公钥和私钥</h2><p id="b2f6" class="pw-post-body-paragraph kq kr jb ks b kt mt kc kv kw mu kf ky kz mv lb lc ld mw lf lg lh mx lj lk ll ij bi translated">既然Age已经安装，您必须创建一个公钥和一个私钥。</p><pre class="nw nx ny nz gt oa nj ob oc aw od bi"><span id="1fbc" class="nk mc jb nj b gy oe of l og oh">$ age-keygen -o key.txt</span><span id="c879" class="nk mc jb nj b gy oj of l og oh">$ cat key.txt<br/># created: 2022-07-30T17:02:43+02:00<br/># public key: age1rdje4gwnm2cc6uu6lvggzjj8gktu4cw5ng8yyjhrluwvqq387cls58dsy4<br/>AGE-SECRET-KEY-18LMDYJRYZMRM52CYQA9MZW79M85CPR0HJHCASXF5ADT03KJ290HS88599E</span><span id="100f" class="nk mc jb nj b gy oj of l og oh">$ mkdir ~/.sops</span><span id="ea07" class="nk mc jb nj b gy oj of l og oh">$ mv ./key.txt ~/.sops</span></pre><p id="a4c1" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">由Age创建的▶️The私钥和公钥存储在文件<code class="fe ng nh ni nj b">key.txt</code>中。我们将这个文件移动到主文件夹中的一个<code class="fe ng nh ni nj b">.sops</code>目录中。</p><p id="09de" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">为了告诉sop一切都在哪里，将这些ENV变量添加到您的shell配置中(<code class="fe ng nh ni nj b">~/.bashrc</code>或<code class="fe ng nh ni nj b">~/.zshrc</code></p><pre class="nw nx ny nz gt oa nj ob oc aw od bi"><span id="023d" class="nk mc jb nj b gy oe of l og oh">export SOPS_AGE_KEY_FILE=$HOME/.sops/key.txt<br/>export EDITOR=nano # Replace by your favorite editor</span></pre><p id="0ed0" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">在继续之前不要忘记<code class="fe ng nh ni nj b">source</code>您的shell配置文件，或者至少打开一个新的shell。</p><h2 id="a913" class="nk mc jb bd md nl nm dn mh nn no dp ml kz np nq mn ld nr ns mp lh nt nu mr nv bi translated">测试sop和Age正在工作</h2><p id="fcc8" class="pw-post-body-paragraph kq kr jb ks b kt mt kc kv kw mu kf ky kz mv lb lc ld mw lf lg lh mx lj lk ll ij bi translated">让我们加密一个文件…</p><pre class="nw nx ny nz gt oa nj ob oc aw od bi"><span id="a410" class="nk mc jb nj b gy oe of l og oh"># Creating a test file<br/>$ echo "my-key: my-value" &gt; config.yaml</span><span id="0587" class="nk mc jb nj b gy oj of l og oh"># Encrypting the file<br/>sops --encrypt --age $(cat ~/.sops/key.txt |grep -oP "public key: \K(.*)") ./config.yaml</span></pre><p id="5134" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">▶️:我们使用了<code class="fe ng nh ni nj b">--age</code>参数来指定使用什么公钥。这里，我们依靠bash在运行时替换出现在<code class="fe ng nh ni nj b">key.txt</code>中的公钥。</p><p id="a24c" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">现在，要将文件保存到磁盘，只需简单的右重定向即可:</p><pre class="nw nx ny nz gt oa nj ob oc aw od bi"><span id="fb1d" class="nk mc jb nj b gy oe of l og oh">$ sops --encrypt --age $(cat ~/.sops/key.txt |grep -oP "public key: \K(.*)") ./config.yaml &gt; config_enc.yaml</span><span id="590c" class="nk mc jb nj b gy oj of l og oh">$ cat config_enc.yaml<br/>my-key: ENC[AES256_GCM,data:Jw1oRQcV8=,tag:Tzd/oUQ[...]==,type:str]<br/>sops:<br/>[...]</span><span id="bfca" class="nk mc jb nj b gy oj of l og oh"># Edit the file using Sops<br/>$ sops config_enc.yaml<br/>&lt;Your favorite editor should have opened&gt;<br/>&lt;The file in front of you should be unencrypted&gt;<br/>&lt;When saving, modifications you made will be encrypted&gt;</span></pre><blockquote class="my mz na"><p id="322c" class="kq kr nb ks b kt ku kc kv kw kx kf ky nc la lb lc nd le lf lg ne li lj lk ll ij bi translated">动态解密和重新加密是一个极好的特性。你甚至不知道文件被加密了。都是自动的！</p></blockquote><h1 id="76e0" class="mb mc jb bd md me mf mg mh mi mj mk ml kh mm ki mn kk mo kl mp kn mq ko mr ms bi translated">配置工具</h1><h2 id="c9d0" class="nk mc jb bd md nl nm dn mh nn no dp ml kz np nq mn ld nr ns mp lh nt nu mr nv bi translated">向您的解释器添加别名</h2><p id="4631" class="pw-post-body-paragraph kq kr jb ks b kt mt kc kv kw mu kf ky kz mv lb lc ld mw lf lg lh mx lj lk ll ij bi translated">这应该可以毫不费力地在bash和zsh上运行。</p><p id="dce0" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">由于加密文件的语法有点繁琐(因为你必须将Age公钥传递给Sops ),我们准备了一个别名，可以添加到你的<code class="fe ng nh ni nj b">.bashrc</code>或<code class="fe ng nh ni nj b">.zshrc</code></p><pre class="nw nx ny nz gt oa nj ob oc aw od bi"><span id="9b52" class="nk mc jb nj b gy oe of l og oh">function cypher {<br/>    filename=$(basename -- "$1")<br/>    extension="${filename##*.}"<br/>    filename="${filename%.*}"<br/>    sops --encrypt --age $(cat ~/.sops/key.txt |grep -oP "public key: \K(.*)") $2 $3 $1 &gt; "$filename.enc.$extension"<br/>}</span></pre><p id="3901" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">请记住，在尝试新别名之前，请始终<code class="fe ng nh ni nj b">source</code>保存您的个人资料。</p><p id="29a2" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><strong class="ks jc">用法:</strong></p><pre class="nw nx ny nz gt oa nj ob oc aw od bi"><span id="a34f" class="nk mc jb nj b gy oe of l og oh"># Creating test files<br/>$ echo "some_key: some_value" &gt; test_alias.yaml</span><span id="2e3d" class="nk mc jb nj b gy oj of l og oh"># Encrypting<br/>$ cypher test_alias.yaml</span><span id="8e8b" class="nk mc jb nj b gy oj of l og oh">$ ls<br/>test_alias.enc.yaml</span></pre></div><div class="ab cl ok ol hu om" role="separator"><span class="on bw bk oo op oq"/><span class="on bw bk oo op oq"/><span class="on bw bk oo op"/></div><div class="ij ik il im in"><p id="b87a" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">您也可以更新别名以就地编辑文件，而不生成新文件。这应该是这样的:</p><pre class="nw nx ny nz gt oa nj ob oc aw od bi"><span id="da72" class="nk mc jb nj b gy oe of l og oh">function cypher_inplace {<br/>    sops --encrypt --in-place --age $(cat ~/.sops/key.txt |grep -oP "public key: \K(.*)") $2 $3 $1<br/>}</span></pre></div><div class="ab cl ok ol hu om" role="separator"><span class="on bw bk oo op oq"/><span class="on bw bk oo op oq"/><span class="on bw bk oo op"/></div><div class="ij ik il im in"><p id="6bb9" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">要仅加密文件的一部分，必须使用正则表达式显式密钥。你<strong class="ks jc">不需要</strong>成为正则表达式大师来实现这一点。看看这个例子:</p><pre class="nw nx ny nz gt oa nj ob oc aw od bi"><span id="ce0c" class="nk mc jb nj b gy oe of l og oh">$ echo "key1: value1" &gt;  test_regex.yaml<br/>$ echo "key2: value2" &gt;&gt; test_regex.yaml<br/>$ echo "key3: value3" &gt;&gt; test_regex.yaml</span><span id="5d95" class="nk mc jb nj b gy oj of l og oh">$ cat test_regex.yaml<br/>key1: value1<br/>key2: value2<br/>key3: value3</span><span id="ad18" class="nk mc jb nj b gy oj of l og oh">$ cypher test_regex.yaml  --encrypted-regex='^(key1|key3)$'</span><span id="2943" class="nk mc jb nj b gy oj of l og oh">$ cat test_regex.enc.yaml<br/>key1: ENC[AES256_GCM,[...]tag:qHy9z22CIxcb9ykpPAWikQ==,type:str]<br/>key2: value2<br/>key3: ENC[AES256_GCM,data:3Faqn,[...]tag:1VB3/wrLekmg==,type:str]</span></pre><p id="e8da" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">如您所见，只有<code class="fe ng nh ni nj b">key1</code>和<code class="fe ng nh ni nj b">key3</code>的值被加密。<code class="fe ng nh ni nj b">key2</code>一直保持原样。</p><blockquote class="my mz na"><p id="46e0" class="kq kr nb ks b kt ku kc kv kw kx kf ky nc la lb lc nd le lf lg ne li lj lk ll ij bi translated">您可以添加任何想要的键，用<code class="fe ng nh ni nj b">|</code>分隔。例如<code class="fe ng nh ni nj b">--encrypted-regex='^(&lt;a_first_key&gt;|&lt;a_second_key&gt;|&lt;a_third_key&gt;)$</code></p></blockquote><h2 id="42a4" class="nk mc jb bd md nl nm dn mh nn no dp ml kz np nq mn ld nr ns mp lh nt nu mr nv bi translated">为Visual Studio代码安装sop</h2><p id="4dff" class="pw-post-body-paragraph kq kr jb ks b kt mt kc kv kw mu kf ky kz mv lb lc ld mw lf lg lh mx lj lk ll ij bi translated">正如我们所见，Sops允许无缝编辑加密文件。Visual Studio代码也可以做到这一点，只要它有一个Sops插件。</p><ol class=""><li id="894c" class="ln lo jb ks b kt ku kw kx kz lp ld lq lh lr ll nf lt lu lv bi translated">下载适用于Windows的Sops二进制文件(或者任何运行VS代码的操作系统)<br/>-<a class="ae lm" href="https://github.com/mozilla/sops/releases" rel="noopener ugc nofollow" target="_blank">https://github.com/mozilla/sops/releases</a></li><li id="1a90" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll nf lt lu lv bi translated">将二进制文件添加到操作系统路径<br/>——在Windows上是<code class="fe ng nh ni nj b">c:\Windows\system32</code><br/>——将其重命名为<code class="fe ng nh ni nj b">sops.exe</code></li><li id="1df8" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll nf lt lu lv bi translated">在VScode上，下载Sops插件<a class="ae lm" href="http://twitter.com/signageos/vscode-sops" rel="noopener ugc nofollow" target="_blank"> @signageos/vscode-sops </a>。<br/> -你不需要这么做，但是，要在VScode中配置插件，请转到<code class="fe ng nh ni nj b">file &gt; preferences &gt; settings &gt; plugins &gt; Sops</code></li><li id="9a68" class="ln lo jb ks b kt lw kw lx kz ly ld lz lh ma ll nf lt lu lv bi translated">将安装在linux (WSL)上的密钥复制到Windows分区</li></ol><pre class="nw nx ny nz gt oa nj ob oc aw od bi"><span id="69ce" class="nk mc jb nj b gy oe of l og oh">$ mkdir /mnt/c/Users/&lt;YOUR_WINDOWS_USERNAME&gt;/AppData/Roaming/sops/age -p</span><span id="d2a2" class="nk mc jb nj b gy oj of l og oh">$ cp ~/.sops/key.txt /mnt/c/Users/&lt;YOUR_WINDOWS_USERNAME&gt;/AppData/Roaming/sops/age/keys.txt</span></pre><p id="9654" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">▶️路径<code class="fe ng nh ni nj b">AppData/Roaming/sops/age</code>是VSCode期望你的密钥所在的地方。如果需要，可以在插件设置中进行配置。</p><h2 id="9100" class="nk mc jb bd md nl nm dn mh nn no dp ml kz np nq mn ld nr ns mp lh nt nu mr nv bi translated">安装舵的标准操作程序</h2><p id="fce6" class="pw-post-body-paragraph kq kr jb ks b kt mt kc kv kw mu kf ky kz mv lb lc ld mw lf lg lh mx lj lk ll ij bi translated">Sops的一个很大的优点是，你可以把纯文本的敏感数据放在你的舵图的<code class="fe ng nh ni nj b">values.yaml</code>中，然后简单地让Sops加密文件。</p><p id="3171" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">❗因此，该文件不能直接与头盔一起使用，因为它本身不能读取加密文件… <br/> ▶️️这就是为什么你应该安装这个头盔插件。它允许使用所有经典的helm命令，但当遇到加密文件时，它会自动解密并继续安装过程。</p><pre class="nw nx ny nz gt oa nj ob oc aw od bi"><span id="a33b" class="nk mc jb nj b gy oe of l og oh">$ helm plugin install <a class="ae lm" href="https://github.com/jkroepke/helm-secrets" rel="noopener ugc nofollow" target="_blank">https://github.com/jkroepke/helm-secrets</a> --version v3.14.0</span></pre><p id="b34c" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">要使用这个插件，你只需在helm二进制文件后添加单词<code class="fe ng nh ni nj b">secrets</code>。<br/>例如，当安装带有加密<code class="fe ng nh ni nj b">values.yaml</code>的舵图时:</p><pre class="nw nx ny nz gt oa nj ob oc aw od bi"><span id="3ad1" class="nk mc jb nj b gy oe of l og oh">$ helm secrets install minecraft-server itzg/minecraft</span></pre><h2 id="e49b" class="nk mc jb bd md nl nm dn mh nn no dp ml kz np nq mn ld nr ns mp lh nt nu mr nv bi translated">为Kubectl安装sop</h2><p id="03bb" class="pw-post-body-paragraph kq kr jb ks b kt mt kc kv kw mu kf ky kz mv lb lc ld mw lf lg lh mx lj lk ll ij bi translated">目前还没有什么好的解决方案来混合kubectl和sops。但是通过管道将sop输出到<code class="fe ng nh ni nj b">kubectl apply</code>非常简单。</p><pre class="nw nx ny nz gt oa nj ob oc aw od bi"><span id="27dd" class="nk mc jb nj b gy oe of l og oh">$ sops -d &lt;ENCRYPTED_FILE&gt;.yaml | kubectl apply -f -</span></pre></div><div class="ab cl ok ol hu om" role="separator"><span class="on bw bk oo op oq"/><span class="on bw bk oo op oq"/><span class="on bw bk oo op"/></div><div class="ij ik il im in"><p id="b101" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">感谢您遵循本教程。如果这有助于您设置Sops安装，请考虑提供👏。</p><p id="f9ea" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">作者:艾米莉·兰斯洛特</p><p id="f37b" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><a class="ae lm" href="https://stackoverflow.com/users/5512455/doctor" rel="noopener ugc nofollow" target="_blank">堆栈溢出</a></p><p id="5484" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">需要Kubernetes上的服务功能？不要再说了！现在就结帐<a class="ae lm" href="https://github.com/rememberSoftwares/gitfaas" rel="noopener ugc nofollow" target="_blank"> Gitfaas </a>！对所有人免费，对所有人开源。</p></div></div>    
</body>
</html>