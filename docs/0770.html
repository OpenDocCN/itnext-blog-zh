<html>
<head>
<title>Custom Social Auth flow with auth.nuxtjs.org</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用auth.nuxtjs.org自定义社交授权流</h1>
<blockquote>原文：<a href="https://itnext.io/custom-social-auth-flow-with-auth-nuxtjs-org-daa836676587?source=collection_archive---------0-----------------------#2018-05-25">https://itnext.io/custom-social-auth-flow-with-auth-nuxtjs-org-daa836676587?source=collection_archive---------0-----------------------#2018-05-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/52f8a96ac4cfe66aebe351bf41aab439.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-lIXGHKlXNI-x4ECuQSFzw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://entwickler.de/wp-content/uploads/2018/01/nuxt-900x450.png" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><p id="8289" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">nuxt-auth模块可以很好地处理本地和社交媒体登录，但是当你试图用本地API令牌交换社交登录令牌时，事情就变得糟糕了。nuxt验证模块不支持社交登录的自定义验证流。实际上，nuxt-auth做的是，它让你登录社交网络，但不允许你用自己的令牌交换社交令牌。因此，我创建了这个教程，使事情变得简单。</p><p id="3f09" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以下面是保持清洁的方法。首先，从我的github克隆基础应用。这是我之前关于nuxt-auth模块的教程。<a class="ae kc" href="https://medium.com/@rama41222/basic-authentication-using-auth-nuxt-js-e140859ab4c3" rel="noopener">查看我之前关于nuxt-auth的文章，获得下载项目的详细介绍。</a></p><p id="8eb0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我使用epic-spinners来加载动画。您可以使用以下命令安装epic spinners。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="052f" class="lk ll iq lg b gy lm ln l lo lp">npm install --save epic-spinners</span></pre><p id="f3b2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后在plugins文件夹中创建一个名为spinners.js的插件，将epic spinners包含到您的项目中。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="9720" class="lk ll iq lg b gy lm ln l lo lp">import Vue from 'vue'<br/>import { SemipolarSpinner } from 'epic-spinners'</span><span id="0c47" class="lk ll iq lg b gy lq ln l lo lp">Vue.component('semipolar-spinner', SemipolarSpinner)</span></pre><p id="8d2f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后将插件包含到nuxt.config.js中</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="a728" class="lk ll iq lg b gy lm ln l lo lp">plugins: ['~plugins/spinners.js'],</span></pre><h2 id="b953" class="lk ll iq bd lr ls lt dn lu lv lw dp lx ko ly lz ma ks mb mc md kw me mf mg mh bi translated">让我们从授权流程开始</h2><p id="1ebd" class="pw-post-body-paragraph kd ke iq kf b kg mi ki kj kk mj km kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated">这是我们将要做的。首先，我们让nuxt-auth插件登录一个社交网络。然后，我们将从facebook、google或任何其他平台获取回调收到的令牌。然后，我们会将该令牌发送到我们自己的服务器，并用本地令牌交换社交登录令牌。然后我们将在nuxt-auth模块中强制设置本地authtoken。这样做之后，我们必须将策略更改为local，最后您可以从自己的API获取本地用户。为了简洁起见，我们将为axios创建一个插件，并在axios插件中包含所有的标题。然后我们将把插件包含到项目中。</p><h2 id="4055" class="lk ll iq bd lr ls lt dn lu lv lw dp lx ko ly lz ma ks mb mc md kw me mf mg mh bi translated">第一</h2><p id="66bd" class="pw-post-body-paragraph kd ke iq kf b kg mi ki kj kk mj km kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated">您应该更改nuxt.auth配置以适应您的授权流。我是这样做的。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="7541" class="lk ll iq lg b gy lm ln l lo lp">auth: {<br/>  strategies: {<br/>    local: {<br/>      endpoints: {<br/>        login: {url: '/user/login', method: 'post', propertyName:      'token' },<br/>        logout: <strong class="lg ir">false</strong>,<br/>        user: {url: '/user/user', method: 'get', propertyName: 'data'},<br/>      },<br/>      tokenRequired: <strong class="lg ir">true</strong>,<br/>      tokenType: 'Bearer'<br/>    },<br/>    facebook: {<br/>      client_id: '',<br/>      userinfo_endpoint: <strong class="lg ir">false</strong>,<br/>      scope: ['public_profile', 'email'],<br/>      redirect_uri:'http://localhost:3000/callback'<br/>    },<br/>    google: {<br/>      client_id: '',<br/>      user:<strong class="lg ir">false</strong>,<br/>      redirect_uri:'http://localhost:3000/callback'<br/><br/>    },<br/>  },<br/>  redirect: {<br/>    login: '/?login=1',<br/>    logout: '/',<br/>  }<br/>},</span></pre><p id="dbbc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后添加API端点作为基础</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="321c" class="lk ll iq lg b gy lm ln l lo lp">axios: {<br/>     baseURL:'<a class="ae kc" href="https://aaa.com/api/v1'" rel="noopener ugc nofollow" target="_blank">https://aaa.com/api/v1'</a><br/>  },</span></pre><p id="e25b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我有目的地删除了配置的其余部分。完整配置请参考github。</p><h2 id="0b6d" class="lk ll iq bd lr ls lt dn lu lv lw dp lx ko ly lz ma ks mb mc md kw me mf mg mh bi translated">第二</h2><p id="cdd8" class="pw-post-body-paragraph kd ke iq kf b kg mi ki kj kk mj km kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated">让我们设置axios。在这里，我将创建一个插件来将所有的标题保存在一个地方。首先，在插件中创建一个名为axios.js的文件，并将其包含在nuxt.config.js中。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="1d7e" class="lk ll iq lg b gy lm ln l lo lp">plugins: [‘~plugins/axios.js’,’~plugins/spinners.js’]</span></pre><p id="5d06" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后将以下代码放入插件文件夹中的axios.js。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="82a6" class="lk ll iq lg b gy lm ln l lo lp">export default function ({$axios, redirect}) {<br/>    $axios.onRequest(config =&gt; {<br/>        config.headers['Content-Type'] = 'application/json';<br/>        config.headers['Access-Control-Allow-Origin'] = "*";<br/>    })<br/>}</span></pre><p id="44c9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你需要更多的标题，只需将它们包含在axios插件中，axios会在发送请求时自动插入标题。</p><p id="7e8a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们已经设置了axios。让我们创建自定义身份验证插件。在plugins文件夹中创建一个名为auth.js的新文件，并键入以下代码。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="8de3" class="lk ll iq lg b gy lm ln l lo lp">export default async function ({ app }) {<br/>    if (!app.$auth.loggedIn) {<br/>        return<br/>    }</span><span id="cc99" class="lk ll iq lg b gy lq ln l lo lp">const auth = app.$auth;</span><span id="9581" class="lk ll iq lg b gy lq ln l lo lp">const authStrategy = auth.strategy.name;<br/>    if(authStrategy === 'facebook' || authStrategy === 'google'){<br/>        const token = auth.getToken(authStrategy).substr(7)<br/>        const authStrategyConverted = authStrategy === 'facebook' ? 'fb' : 'google';<br/>        const url = `/user/signup/${authStrategyConverted}?token=${token}`;</span><span id="ee43" class="lk ll iq lg b gy lq ln l lo lp">try {<br/>            const {data} = await app.$axios.$post(url, null);<br/>            auth.setToken('local', "Bearer "+ data.access_token);<br/>            setTimeout( async () =&gt; {<br/>                auth.setStrategy('local');<br/>                setTimeout( async () =&gt; {<br/>                    await auth.fetchUser();<br/>                })<br/>            });<br/>        } catch (e) {<br/>            console.log(e);<br/>        }<br/>    }<br/>}</span></pre><p id="e1ab" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如您所知，nuxt-auth模块将登录状态保存在auth.loggedIn变量中。因此，首先我们必须检查用户是否已经登录。如果没有登录，这个方法应该退出。记住我之前告诉你的，我们应该在介入之前让nuxt-auth模块登录。然后，我们将把记录的状态复制到一个变量中，这样我们就不必在代码中重复$nuxt.auth。</p><p id="3500" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我进入策略。这很重要，因为我们正在定制社交媒体认证流程。您可以通过auth.strategy.name (app)从nuxt-auth访问当前记录的策略。$auth.strategy.name)。我们这样做，只是为了允许社交登录。然后通过auth.getToken(authStrategy)从nuxt-auth获取保存的社交登录访问令牌。substr(7)。这里auth.getToken('策略名')是内置于nuxt-auth的默认方法。有关更多信息，请参考文档。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="90ee" class="lk ll iq lg b gy lm ln l lo lp">const authStrategyConverted = authStrategy === 'facebook' ? 'fb' : 'google';<br/>const url = `/user/signup/${authStrategyConverted}?token=${token}`;</span></pre><p id="c861" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用上面的代码，我正在创建基于策略的url。然后向您的端点发送post调用以检索自定义令牌，并通过auth.setToken('strategy '，token)方法将本地令牌设置为Vuex。您的API必须获取社交令牌，检索相关用户信息，并发布访问令牌。这里的策略应该是本地化的。然后使用auth.setStrategy(' strategy ')方法将策略更改为local。</p><p id="d7f5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后将这个插件全局包含到nuxtjs中。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="b6e5" class="lk ll iq lg b gy lm ln l lo lp">plugins: ['~plugins/auth.js','~plugins/axios.js','~plugins/spinners.js']</span></pre><p id="e582" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里是回购的github链接。本教程到此结束，❤</p><p id="04bd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://github.com/rama41222/NuxtMedium.git" rel="noopener ugc nofollow" target="_blank"> GITHUB回购</a></p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="f479" class="lk ll iq lg b gy lm ln l lo lp">git clone <a class="ae kc" href="https://github.com/rama41222/NuxtMedium.git" rel="noopener ugc nofollow" target="_blank">https://github.com/rama41222/NuxtMedium.git</a></span></pre></div></div>    
</body>
</html>