<html>
<head>
<title>Raw Manifests, Helm, Kustomize</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">原始清单，头盔，Kustomize</h1>
<blockquote>原文：<a href="https://itnext.io/k8s-tips-manifests-helm-kustomize-12f72f878022?source=collection_archive---------0-----------------------#2021-04-01">https://itnext.io/k8s-tips-manifests-helm-kustomize-12f72f878022?source=collection_archive---------0-----------------------#2021-04-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1687" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在Kubernetes中部署应用程序的几种方式</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2017c3a1212fbc8746e8880425d12ec1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jaKfeeRC-UeXXzB3NttAeA.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@miracleday?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">埃琳娜·莫日维洛</a>在<a class="ae ky" href="https://unsplash.com/s/photos/installation?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="2b4f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将使用示例微服务应用程序<a class="ae ky" href="https://gitlab.com/voting-application/votingapp" rel="noopener ugc nofollow" target="_blank"> VotingApp </a>，并使用不同的方法和工具将其部署在Kubernetes中。我们将看到每一个的特点，这样你就可以有一个好主意，哪一个是最适合你的需求。</p><ul class=""><li id="db7a" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">使用yaml规范</li><li id="c7ec" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">通过<a class="ae ky" href="https://helm.sh" rel="noopener ugc nofollow" target="_blank">掌舵</a>图表</li><li id="ad68" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">使用<a class="ae ky" href="https://kustomize.io/" rel="noopener ugc nofollow" target="_blank"> Kustomize </a></li></ul><p id="3229" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">ℹ️如果你不知道VotingApp，请查看这篇介绍该应用程序及其不同版本的短文<a class="ae ky" href="https://lucjuggery.medium.com/the-votingapp-reloaded-e4f237b8f3bf" rel="noopener">。</a></p><p id="c0ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下面的部分中，我们将设置一个单节点<a class="ae ky" href="https://k0sproject.io/" rel="noopener ugc nofollow" target="_blank"> k0s </a> Kubernetes集群，并展示如何使用原始清单、<a class="ae ky" href="https://helm.sh" rel="noopener ugc nofollow" target="_blank"> helm </a>和<a class="ae ky" href="https://kustomize.io" rel="noopener ugc nofollow" target="_blank"> kustomize </a>部署不同版本的VotingApp。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="96c8" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">k0s单节点集群的设置</h1><p id="4910" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">首先，我们将在本地机器上快速设置一个Kubernetes集群。在本地运行Kubernetes真的很容易，因为有很多可用的解决方案。仅举几个例子:</p><ul class=""><li id="0861" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><a class="ae ky" href="https://k0sproject.io/" rel="noopener ugc nofollow" target="_blank"> k0s </a></li><li id="5bbd" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://k3s.io" rel="noopener ugc nofollow" target="_blank"> k3s </a></li><li id="0e96" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://microk8s.io/" rel="noopener ugc nofollow" target="_blank"> microK8s </a></li><li id="165e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">迷你库比</li><li id="eafe" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://kind.sigs.k8s.io/docs/" rel="noopener ugc nofollow" target="_blank">种类</a></li></ul><p id="07a8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们使用<a class="ae ky" href="https://k0sproject.io/" rel="noopener ugc nofollow" target="_blank"> k0s </a>并使用<a class="ae ky" href="https://vagrantup.com" rel="noopener ugc nofollow" target="_blank">流浪汉</a>和<a class="ae ky" href="https://virtualbox.org" rel="noopener ugc nofollow" target="_blank"> VirtualBox </a>进行安装。</p><p id="ae91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们创建一个新文件夹，并在其中添加下面的<code class="fe nn no np nq b">Vagrantfile</code>。</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="514a" class="nv mr it nq b gy nw nx l ny nz">Vagrant.configure("2") do |config|<br/> config.vm.box = "hashicorp/bionic64"<br/> config.vm.network "private_network", ip: "192.168.33.11"<br/> config.vm.provision "shell", inline: &lt;&lt;-SHELL<br/>  <!-- -->export K0S_VERSION=v0.12.0<br/>  curl -sSLf https://get.k0s.sh | sudo --preserve-env=K0S_VERSION sh<br/>  sudo k0s install controller --single<br/>  sudo systemctl start k0scontroller.service<br/> SHELL<br/>end</span></pre><p id="1941" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，在该文件夹中，我们运行以下命令，创建一个虚拟机并在其中安装k0s:</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="eae9" class="nv mr it nq b gy nw nx l ny nz">$ vagrant up</span></pre><p id="b517" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们在这个新创建的虚拟机中运行一个根shell:</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="b8f4" class="nv mr it nq b gy nw nx l ny nz">$ vagrant ssh</span><span id="0ce3" class="nv mr it nq b gy oa nx l ny nz">vagrant@vagrant:~$ sudo su -</span></pre><p id="afd8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用k0s附带的<code class="fe nn no np nq b">kubectl</code>客户机(非常方便的BTW ),我们可以用下面的命令看到我们的单节点集群(节点处于就绪状态大约需要一分钟):</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="45b8" class="nv mr it nq b gy nw nx l ny nz"># k0s kubectl get nodes<br/>NAME      STATUS   ROLES    AGE   VERSION<br/>vagrant   Ready    &lt;none&gt;   40s   v1.20.5-k0s1</span></pre><p id="a604" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们克隆VotingApp的<a class="ae ky" href="https://gitlab.com/voting-application/config.git" rel="noopener ugc nofollow" target="_blank">配置库</a>，并在其中导航:</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="d168" class="nv mr it nq b gy nw nx l ny nz"># git clone https://gitlab.com/voting-application/config.git<br/># cd config</span></pre><p id="465a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<strong class="lb iu">配置</strong>中有几个文件夹:每个文件夹都专用于一个我们可以用来部署VotingApp的工具:</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="7666" class="nv mr it nq b gy nw nx l ny nz"># tree -L 1 .<br/>.<br/>├── README.md<br/>├── compose<br/>├── helm<br/>├── kustomize<br/>├── manifests<br/>└── utils</span></pre><p id="5aa5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下一步中，我们将首先使用包含在<strong class="lb iu">manifest</strong>文件夹中的原始yaml规范来部署VotingApp。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="abbe" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">使用原始yaml规范进行部署</h1><p id="2c0d" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated"><em class="ob"> manifests </em>文件夹包含几个子文件夹，每个子文件夹包含给定版本的VotingApp (v1、v2和v3)的规范:</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="3553" class="nv mr it nq b gy nw nx l ny nz"># tree manifests<br/>manifests<br/>├── v1<br/>│   ├── db-deployment.yaml<br/>│   ├── db-service.yaml<br/>│   ├── redis-deployment.yaml<br/>│   ├── redis-service.yaml<br/>│   ├── result-deployment.yaml<br/>│   ├── result-service.yaml<br/>│   ├── vote-deployment.yaml<br/>│   ├── vote-service.yaml<br/>│   └── worker-deployment.yaml<br/>├── v2<br/>│   ├── db-deployment.yaml<br/>│   ├── db-service.yaml<br/>│   ├── redis-deployment.yaml<br/>│   ├── redis-service.yaml<br/>│   ├── result-deployment.yaml<br/>│   ├── result-service.yaml<br/>│   ├── result-ui-deployment.yaml<br/>│   ├── result-ui-service.yaml<br/>│   ├── vote-deployment.yaml<br/>│   ├── vote-service.yaml<br/>│   ├── vote-ui-deployment.yaml<br/>│   ├── vote-ui-service.yaml<br/>│   └── worker-deployment.yaml<br/>└── v3<br/>    ├── nats-deployment.yaml<br/>    ├── nats-service.yaml<br/>    ├── result-deployment.yaml<br/>    ├── result-service.yaml<br/>    ├── result-ui-deployment.yaml<br/>    ├── result-ui-service.yaml<br/>    ├── vote-deployment.yaml<br/>    ├── vote-service.yaml<br/>    ├── vote-ui-deployment.yaml<br/>    └── vote-ui-service.yaml</span></pre><p id="48f8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">manifest</strong>的每个子文件夹都包含定义相应版本组件的yaml文件。这里我们可以注意到的第一件事是:有相当多的重复，因为一些资源是几个版本共有的。</p><p id="ea3e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们想在v1版本中部署VotingApp，我们可以使用下面的命令:</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="fc1c" class="nv mr it nq b gy nw nx l ny nz"># k0s kubectl apply -f manifests/v1</span></pre><blockquote class="oc od oe"><p id="0d12" class="kz la ob lb b lc ld ju le lf lg jx lh of lj lk ll og ln lo lp oh lr ls lt lu im bi translated">注意:当用于文件夹时，命令<code class="fe nn no np nq b">kubectl apply -f</code>会考虑该文件夹的所有规格</p></blockquote><p id="e7fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">像往常一样，我们确保一切正常:</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="6b82" class="nv mr it nq b gy nw nx l ny nz"># k0s kubectl get deploy,po<br/>NAME                     READY   UP-TO-DATE   AVAILABLE   AGE<br/>deployment.apps/redis    1/1     1            1           19s<br/>deployment.apps/db       1/1     1            1           20s<br/>deployment.apps/worker   1/1     1            1           18s<br/>deployment.apps/vote     1/1     1            1           19s<br/>deployment.apps/result   1/1     1            1           19s</span><span id="a952" class="nv mr it nq b gy oa nx l ny nz">NAME                          READY   STATUS    RESTARTS   AGE<br/>pod/db-5db4758ff-48h2p        1/1     Running   0          20s<br/>pod/redis-7784f964f6-dfnwg    1/1     Running   0          19s<br/>pod/worker-5c44d48c6c-s57ss   1/1     Running   0          18s<br/>pod/vote-6c5bc5687f-m6th6     1/1     Running   0          19s<br/>pod/result-cd89cd84c-rm469    1/1     Running   0          19s</span></pre><p id="9873" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们可以使用虚拟机的IP和在<em class="ob"> vote-service.yaml </em>和<em class="ob"> result-service.yaml </em>中指定的节点端口访问web接口:<code class="fe nn no np nq b">vote</code>在端口31000上可访问，<code class="fe nn no np nq b">result</code>在端口31001上可访问。我们可以为一个项目投票并查看结果，这证实了整个应用程序运行良好。</p><div class="kj kk kl km gt ab cb"><figure class="oi kn oj ok ol om on paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/befed0cf18f5e6af4ee736481a8e64a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*P1m-Z93MX4DcJRd-ctTdbA.png"/></div></figure><figure class="oi kn oj ok ol om on paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/cb1ca6f3461752c608775fcd63e8de05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*6DuSkOLbVpixpwn0S_ZnPQ.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk oo di op oq translated">使用原始清单部署的VotingApp v1</figcaption></figure></div><p id="7df0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后可以使用以下命令删除该应用程序:</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="ed07" class="nv mr it nq b gy nw nx l ny nz"># k0s kubectl delete -f manifests/v1</span></pre><p id="5cc3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们需要部署VotingApp的另一个版本，我们必须运行与之前请求的版本相同的命令:</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="fd91" class="nv mr it nq b gy nw nx l ny nz"># k0s kubectl apply -f manifests/VERSION</span></pre><p id="0b04" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">直接使用yaml清单部署应用程序很简单，但它没有提供方便的功能来完全管理应用程序的生命周期或动态配置应用程序，这是<a class="ae ky" href="https://helm.sh" rel="noopener ugc nofollow" target="_blank"> Helm </a>真正发挥作用的领域。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="8724" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">带舵展开</h1><p id="7d1c" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">Helm 允许我们管理(定义、安装、升级)复杂的Kubernetes应用程序。这个工具通过Chart(一个包含整个应用程序规范的包)的概念，使得创建、版本化、共享和发布整个应用程序变得容易。Helm还提供了一种模板语言来动态配置应用程序。</p><p id="ea78" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<a class="ae ky" href="https://gitlab.com/voting-application/config" rel="noopener ugc nofollow" target="_blank">配置存储库</a>中，<em class="ob"> helm </em>文件夹包含VotingApp的图表。</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="06ca" class="nv mr it nq b gy nw nx l ny nz"># tree helm<br/>helm<br/>├── Chart.yaml<br/>├── templates<br/>│   ├── _helpers.tpl<br/>│   ├── db-deployment.yaml<br/>│   ├── db-service.yaml<br/>│   ├── nats-deployment.yaml<br/>│   ├── nats-service.yaml<br/>│   ├── redis-deployment.yaml<br/>│   ├── redis-service.yaml<br/>│   ├── result-deployment.yaml<br/>│   ├── result-service.yaml<br/>│   ├── result-ui-deployment.yaml<br/>│   ├── result-ui-service.yaml<br/>│   ├── vote-deployment.yaml<br/>│   ├── vote-service.yaml<br/>│   ├── vote-ui-deployment.yaml<br/>│   ├── vote-ui-service.yaml<br/>│   └── worker-deployment.yaml<br/>└── values.yaml</span></pre><p id="5e07" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ob">模板</em>文件夹包含每个微服务的规范。这些文件不能被Kubernetes直接使用，因为它们包含一些模板语言的元素，使得规范更加动态。让我们看几个例子。</p><ul class=""><li id="e8e0" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">投票部署的规范使用动态值来定义必须使用的图像(注册表+标记)。</li></ul><p id="b7e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意:每个<strong class="lb iu"> .Value.xyz </strong>都是对<em class="ob"> values.yaml </em>中定义的一个值的引用(稍后会详细介绍)</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="77ec" class="nv mr it nq b gy nw nx l ny nz"><strong class="nq iu"># cat templates/vote-deployment.yaml</strong><br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  labels:<br/>    app: vote<br/>  name: vote<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: vote<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: vote<br/>    spec:<br/>      containers:<br/>        - image: <strong class="nq iu">{{ .Values.registry }}/vote:{{ .Values.version }}</strong><br/>          name: vote<br/>          imagePullPolicy: Always<br/>          ports:<br/>            - containerPort: 80<br/>              name: vote</span></pre><ul class=""><li id="17be" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe nn no np nq b">vote</code>和<code class="fe nn no np nq b">result</code>服务使用模板语言来确保只有在部署了版本v1的情况下才通过节点端口服务公开它们(对于v2和v3，它们应该是ClusterIP类型)。</li></ul><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="cfaa" class="nv mr it nq b gy nw nx l ny nz"><strong class="nq iu"># cat templates/vote-service.yaml<br/></strong>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  labels:<br/>    app: result<br/>  name: result<br/>spec:<br/><strong class="nq iu">  {{ if eq .Values.version "v1" }}</strong><br/><strong class="nq iu">  type: NodePort<br/>  {{ end }}<br/></strong>  ports:<br/>    - name: "result-service"<br/>      port: 80<br/>      targetPort: 80<br/>      <strong class="nq iu">{{ if eq .Values.version "v1" }}<br/>      nodePort: 31001<br/>      {{ end }}</strong><br/>  selector:<br/>    app: result</span><span id="c940" class="nv mr it nq b gy oa nx l ny nz"><strong class="nq iu"># cat templates/result-service.yaml</strong><em class="ob"><br/></em>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  labels:<br/>    app: result<br/>  name: result<br/>spec:<br/><strong class="nq iu">  {{ if eq .Values.version "v1" }}</strong><br/><strong class="nq iu">  type: NodePort<br/>  {{ end }}</strong><br/>  ports:<br/>    - name: "result-service"<br/>      port: 80<br/>      targetPort: 80<br/>      <strong class="nq iu">{{ if eq .Values.version "v1" }}<br/>      nodePort: 31001<br/>      {{ end }}</strong><br/>  selector:<br/>    app: result</span></pre><ul class=""><li id="57f1" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">模板语言在<code class="fe nn no np nq b">worker</code>中也有两个用途:</li></ul><p id="8f35" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">-确保只为版本1和2部署工作进程(版本3使用NATS)</p><p id="67f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">-指定应使用的图像标签，因为每个工人的口味有一个标签(<code class="fe nn no np nq b">java</code>、<code class="fe nn no np nq b">go</code>和<code class="fe nn no np nq b">.dotnet</code>):</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="f21c" class="nv mr it nq b gy nw nx l ny nz"><strong class="nq iu"># cat templates/worker-deployment.yaml<br/>{{ if ne .Values.version "v3" }}<br/></strong>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  labels:<br/>    app: worker<br/>  name: worker<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: worker<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: worker<br/>    spec:<br/>      containers:<br/>        - image: <strong class="nq iu">{{.Values.registry}}/worker:{{.Values.worker.lang}}</strong><br/>          name: worker<br/>          imagePullPolicy: Always<br/><strong class="nq iu">{{ end }}</strong></span></pre><p id="2ce6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以上模板中引用的所有值都在<em class="ob"> values.yaml: </em>中定义</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="1d82" class="nv mr it nq b gy nw nx l ny nz"><strong class="nq iu"># cat values.yaml</strong><br/># Image registry<br/>registry:  registry.gitlab.com/voting-application</span><span id="1493" class="nv mr it nq b gy oa nx l ny nz"># Version of the VotingApp among v1, v2 and v3<br/>version: v2</span><span id="6485" class="nv mr it nq b gy oa nx l ny nz"># Version of the worker among Java, .NET and Go<br/>worker:<br/>  lang: go</span></pre><p id="52d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们使用Helm部署VotingApp(需要按照这些指令首先安装<em class="ob"> helm </em>二进制文件<a class="ae ky" href="https://helm.sh/docs/intro/install/" rel="noopener ugc nofollow" target="_blank">)。</a></p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="4947" class="nv mr it nq b gy nw nx l ny nz"># helm upgrade voting --install --values values.yaml .</span></pre><p id="9c5d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们得到类似于下面的结果:</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="088e" class="nv mr it nq b gy nw nx l ny nz">Release "voting" does not exist. Installing it now.<br/>NAME: voting<br/>LAST DEPLOYED: Wed Mar 31 21:02:07 2021<br/>NAMESPACE: default<br/>STATUS: deployed<br/>REVISION: 1<br/>TEST SUITE: None</span></pre><p id="15f0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在幕后，helm读取<code class="fe nn no np nq b">templates</code>文件夹中的规范，使用<em class="ob"> values.yaml </em>中的值创建真正的yaml清单(Kubernetes可以理解),并请求API服务器创建相应的资源。因此，前面的命令部署了应用程序的版本2。</p><p id="6b83" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们确保一切运行良好，检查所有的吊舱都处于<strong class="lb iu">运行</strong>状态:</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="a860" class="nv mr it nq b gy nw nx l ny nz"># k0s kubectl get deploy,pod<br/>NAME                        READY   UP-TO-DATE   AVAILABLE   AGE<br/>deployment.apps/redis       1/1     1            1           3m37s<br/>deployment.apps/db          1/1     1            1           3m37s<br/>deployment.apps/worker      1/1     1            1           3m37s<br/>deployment.apps/vote        1/1     1            1           3m37s<br/>deployment.apps/vote-ui     1/1     1            1           3m37s<br/>deployment.apps/result      1/1     1            1           3m37s<br/>deployment.apps/result-ui   1/1     1            1           3m37s</span><span id="e344" class="nv mr it nq b gy oa nx l ny nz">NAME                             READY   STATUS    RESTARTS   AGE<br/>pod/redis-7784f964f6-pst85       1/1     Running   0          3m37s<br/>pod/db-5db4758ff-mqzhk           1/1     Running   0          3m37s<br/>pod/worker-5c44d48c6c-jqnf5      1/1     Running   0          3m37s<br/>pod/vote-7fcd756c98-rckhm        1/1     Running   0          3m37s<br/>pod/vote-ui-78c77c7b8b-s6svv     1/1     Running   0          3m37s<br/>pod/result-6dcc7677fd-r4m25      1/1     Running   0          3m37s<br/>pod/result-ui-67d5445774-6xl9d   1/1     Running   0          3m37s</span></pre><p id="79fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我们可以访问<code class="fe nn no np nq b">vote-ui</code>和<code class="fe nn no np nq b">result-ui</code>界面:</p><div class="kj kk kl km gt ab cb"><figure class="oi kn oj ok ol om on paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/a2ae174122306949b3f7523cb3753c48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*fDMR0Z8saiPmF7_1YLDvHg.png"/></div></figure><figure class="oi kn oj ok ol om on paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/b368fada3e7e7c221ff2fea09768e3b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*HFvSe5xh8RAjMeSlOt1h5w.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk oo di op oq translated">使用Helm部署VotingApp版本2</figcaption></figure></div><p id="86cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意:第1版和第2/3版之间的前端只有微小的变化:一些标签有轻微的修改。</p><p id="e30d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">默认情况下，使用worker的<code class="fe nn no np nq b">Go</code>版本(在values.yaml的<em class="ob"> worker.lang </em>属性中定义)。我们可以确保查看工人规范:</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="ffca" class="nv mr it nq b gy nw nx l ny nz"># k0s kubectl get deploy/worker \<br/>  -o jsonpath="{ .spec.template.spec.containers[0].image }"</span><span id="a6cc" class="nv mr it nq b gy oa nx l ny nz">registry.gitlab.com/voting-application/<strong class="nq iu">worker:go</strong></span></pre><p id="141d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们想尝试一下<code class="fe nn no np nq b">dotnet</code>版本，我们只需要修改values.yaml文件，</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="104b" class="nv mr it nq b gy nw nx l ny nz">...<br/># Version of the worker among java, dotnet and go<br/>worker:<br/>  lang: <strong class="nq iu">dotnet</strong></span></pre><p id="af6a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">和升级应用程序，Helm将更新受<em class="ob">值变化影响的资源。</em></p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="b145" class="nv mr it nq b gy nw nx l ny nz"># helm upgrade voting --install --values values.yaml .</span></pre><p id="09af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们确保部署已正确更新，现在使用的是映像的<code class="fe nn no np nq b">dotnet</code>版本:</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="8445" class="nv mr it nq b gy nw nx l ny nz"># k0s kubectl get deploy/worker \<br/>  -o jsonpath="{ .spec.template.spec.containers[0].image }"</span><span id="6c89" class="nv mr it nq b gy oa nx l ny nz">registry.gitlab.com/voting-application/<strong class="nq iu">worker:dotnet</strong></span></pre><p id="05d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过访问<code class="fe nn no np nq b">vote-ui</code>和<code class="fe nn no np nq b">result-ui</code>网络界面，我们可以很容易地验证这个新版本是否如预期的那样工作。</p><p id="4878" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们想回到以前的版本，Helm也可以通过<code class="fe nn no np nq b">rollback</code>命令帮助我们，该命令使用以前的值创建一个新版本:</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="776f" class="nv mr it nq b gy nw nx l ny nz"># helm rollback voting<br/>Rollback was a success! Happy Helming!</span></pre><p id="b724" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同样，我们可以验证工人的<code class="fe nn no np nq b">Go</code>图像现在被使用，并且应用程序工作正常。</p><p id="88ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们想安装版本3的VotingApp，这没有问题。我们只需要更改values.yaml中的版本属性</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="761f" class="nv mr it nq b gy nw nx l ny nz">...<br/># Version of the VotingApp among v1, v2 and v3<br/>version: v3<br/>...</span></pre><p id="2f5b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">并升级应用程序:</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="b73c" class="nv mr it nq b gy nw nx l ny nz"># helm upgrade voting --install --values values.yaml .</span></pre><p id="2f37" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我们可以看到<code class="fe nn no np nq b">vote</code>和<code class="fe nn no np nq b">result</code>窗格已经更新，新的<code class="fe nn no np nq b">nats</code>窗格已经创建。此外，<code class="fe nn no np nq b">redis</code>、<code class="fe nn no np nq b">db</code>和<code class="fe nn no np nq b">worker</code>窗格已被删除，因为它们在VotingApp版本3中不再使用。</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="c7a8" class="nv mr it nq b gy nw nx l ny nz"># k0s kubectl get deploy,po<br/>NAME                        READY   UP-TO-DATE   AVAILABLE   AGE<br/>deployment.apps/result-ui   1/1     1            1           11m<br/>deployment.apps/vote-ui     1/1     1            1           11m<br/>deployment.apps/result      1/1     1            1           11m<br/>deployment.apps/vote        1/1     1            1           11m<br/>deployment.apps/nats        1/1     1            1           42s</span><span id="69ab" class="nv mr it nq b gy oa nx l ny nz">NAME                            READY   STATUS    RESTARTS   AGE<br/>pod/result-ui-6b4b6bdb9-xrjvj   1/1     Running   0          11m<br/>pod/vote-ui-856ddf9d5-px9tl     1/1     Running   0          11m<br/><strong class="nq iu">pod/result-7f6b5d9bb9-c42p5     1/1     Running   0          41s<br/>pod/vote-56db6bd44f-d4dpx       1/1     Running   0          41s<br/>pod/nats-b8dfd96c6-sgqvd        1/1     Running   0          41s</strong></span></pre><p id="0f2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我们可以删除该应用程序:</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="77fc" class="nv mr it nq b gy nw nx l ny nz"># helm uninstall voting</span></pre><p id="fa92" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如我们在这些例子中看到的，我们使用了同一套yaml文件，添加了一些模板，然后能够动态配置我们的VotingApp。很酷，对吧？</p><p id="e101" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们只通过一个简单的例子来说明Helm，但是这个工具绝对能够做更多的事情，正如你在<a class="ae ky" href="https://helm.sh" rel="noopener ugc nofollow" target="_blank">文档</a>中看到的那样。下一步，我们将说明如何使用<a class="ae ky" href="https://kutomize.io" rel="noopener ugc nofollow" target="_blank"> Kustomize </a>部署我们的应用程序。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="81f5" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">使用Kustomize进行部署</h1><p id="0e7f" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated"><a class="ae ky" href="https://kustomize.io/" rel="noopener ugc nofollow" target="_blank"> Kustomize </a>引入了一种无模板的方式来定制应用配置。它既可以作为独立的二进制文件，也可以作为<code class="fe nn no np nq b">kubectl</code>的原生特性。它基本上从yaml规范列表中定义了一个基线，并允许我们使用额外的资源来过载这个基线。让我们看看这在VotingApp的上下文中是如何工作的。</p><p id="a69b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<a class="ae ky" href="https://gitlab.com/voting-application/config" rel="noopener ugc nofollow" target="_blank">配置库</a>中，<em class="ob"> kustomize </em>文件夹包含几个子文件夹:</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="e076" class="nv mr it nq b gy nw nx l ny nz"># tree kustomize<br/>kustomize<br/>├── base<br/>│   ├── kustomization.yaml<br/>│   ├── result-deployment.yaml<br/>│   ├── result-service.yaml<br/>│   ├── vote-deployment.yaml<br/>│   └── vote-service.yaml<br/>└── overlays<br/>    ├── v1<br/>    │   ├── db-deployment.yaml<br/>    │   ├── db-service.yaml<br/>    │   ├── kustomization.yaml<br/>    │   ├── redis-deployment.yaml<br/>    │   ├── redis-service.yaml<br/>    │   └── worker-deployment.yaml<br/>    ├── v2<br/>    │   ├── db-deployment.yaml<br/>    │   ├── db-service.yaml<br/>    │   ├── front-services.yaml<br/>    │   ├── kustomization.yaml<br/>    │   ├── redis-deployment.yaml<br/>    │   ├── redis-service.yaml<br/>    │   ├── result-ui-deployment.yaml<br/>    │   ├── result-ui-service.yaml<br/>    │   ├── vote-ui-deployment.yaml<br/>    │   ├── vote-ui-service.yaml<br/>    │   └── worker-deployment.yaml<br/>    └── v3<br/>        ├── kustomization.yaml<br/>        ├── nats-deployment.yaml<br/>        ├── nats-service.yaml<br/>        ├── result-ui-deployment.yaml<br/>        ├── result-ui-service.yaml<br/>        ├── vote-ui-deployment.yaml<br/>        └── vote-ui-service.yaml</span></pre><ul class=""><li id="ceeb" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe nn no np nq b">base</code>子文件夹包含一些不同版本的VotingApp通用的规范(所有版本中只使用<code class="fe nn no np nq b">vote</code>和<code class="fe nn no np nq b">result</code>)。这个文件夹还包含<code class="fe nn no np nq b">kustomization.yaml</code>，它基本上列出了构成这个基线的规范。</li></ul><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="a79d" class="nv mr it nq b gy nw nx l ny nz"><strong class="nq iu"># cat base/kustomization.yaml<br/></strong>apiVersion: kustomize.config.k8s.io/v1beta1<br/>kind: Kustomization<br/>resources:<br/>- result-deployment.yaml<br/>- result-service.yaml<br/>- vote-deployment.yaml<br/>- vote-service.yaml</span></pre><p id="0a0c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe nn no np nq b">base</code>文件夹的旁边，有一个<code class="fe nn no np nq b">overlays</code>文件夹，其中包含了VotingApp每个版本的子文件夹。这些子文件夹中的每一个都包含额外的文件，这些文件用于重载存在于<code class="fe nn no np nq b">base</code>文件夹中的内容。</p><ul class=""><li id="ac7b" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe nn no np nq b">overlays/v1</code>是需要用来部署VotingApp版本1的文件夹。它在基本文件夹中的版本1的基础上定义了版本1所需的资源。通过一个<em class="ob"> kustomization.yaml </em>文件，它还定义了要应用于<code class="fe nn no np nq b">vote</code>和<code class="fe nn no np nq b">result</code>部署的补丁，因此投票和结果图像使用<strong class="lb iu"> v1 </strong>标签。</li></ul><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="db8d" class="nv mr it nq b gy nw nx l ny nz"><strong class="nq iu"># cat overlays/v1/kustomization.yaml<br/></strong>bases:<br/>  - ../../base<br/>resources:<br/>  - redis-deployment.yaml<br/>  - redis-service.yaml<br/>  - worker-deployment.yaml<br/>  - db-deployment.yaml<br/>  - db-service.yaml<br/>patches:<br/>  - target:<br/>      group: apps<br/>      version: v1<br/>      kind: Deployment<br/>      name: vote<br/>    patch: |-<br/>      - op: replace<br/>        path: /spec/template/spec/containers/0/image<br/>        value: registry.gitlab.com/voting-application/vote:v1<br/>  - target:<br/>      group: apps<br/>      version: v1<br/>      kind: Deployment<br/>      name: result<br/>    patch: |-<br/>      - op: replace<br/>        path: /spec/template/spec/containers/0/image<br/>        value: registry.gitlab.com/voting-application/result:v1</span></pre><p id="7dd2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">补丁部分看起来相当复杂，但基本上每个补丁“只是”引用一个资源，并沿其层次结构更改属性值。在这个例子中，投票和结果容器的图像被修改。</p><ul class=""><li id="1737" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe nn no np nq b">overlays/v2</code>是需要用来部署VotingApp版本2的文件夹。它在基本文件夹中的资源基础上定义了版本2所需的资源。通过一个<em class="ob"> kustomization.yaml </em>文件，它还定义了应用于基本文件夹中定义的资源的补丁。基本上，这些补丁允许为<code class="fe nn no np nq b">vote</code>和<code class="fe nn no np nq b">result</code>部署指定<strong class="lb iu"> v2 </strong>标签，它还将<code class="fe nn no np nq b">vote</code>和<code class="fe nn no np nq b">result</code>服务的类型更改为<strong class="lb iu">集群IP </strong>而不是<strong class="lb iu">节点端口</strong>。</li></ul><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="bfc5" class="nv mr it nq b gy nw nx l ny nz"><strong class="nq iu"># cat overlays/v2/kustomization.yaml<br/></strong>bases:<br/>  - ../../base<br/>resources:<br/>  - result-ui-deployment.yaml<br/>  - result-ui-service.yaml<br/>  - vote-ui-deployment.yaml<br/>  - vote-ui-service.yaml<br/>  - redis-deployment.yaml<br/>  - redis-service.yaml<br/>  - worker-deployment.yaml<br/>  - db-deployment.yaml<br/>  - db-service.yaml<br/>patches:<br/>  # Use v2 as image tag for vote Deployment<br/>  - target:<br/>      group: apps<br/>      version: v1<br/>      kind: Deployment<br/>      name: vote<br/>    patch: |-<br/>      - op: replace<br/>        path: /spec/template/spec/containers/0/image<br/>        value: registry.gitlab.com/voting-application/vote:v2<br/>  # Use v2 as image tag for result Deployment<br/>  - target:<br/>      group: apps<br/>      version: v1<br/>      kind: Deployment<br/>      name: result<br/>    patch: |-<br/>      - op: replace<br/>        path: /spec/template/spec/containers/0/image<br/>        value: registry.gitlab.com/voting-application/result:v2<br/>  # Change vote Service to ClusterIP type<br/>  - target:<br/>      kind: Service<br/>      name: vote<br/>    patch: |-<br/>      - op: replace<br/>        path: /spec/type<br/>        value: ClusterIP<br/>      - op: remove<br/>        path: /spec/ports/0/nodePort<br/>  # Change result Service to ClusterIP type<br/>  - target:<br/>      kind: Service<br/>      name: result<br/>    patch: |-<br/>      - op: replace<br/>        path: /spec/type<br/>        value: ClusterIP<br/>      - op: remove<br/>        path: /spec/ports/0/nodePort</span></pre><ul class=""><li id="648d" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe nn no np nq b">overlays/v3</code>是需要用来部署VotingApp版本3的文件夹。它在基本文件夹中的资源基础上定义了版本3所需的资源。通过一个<em class="ob"> kustomization.yaml </em>文件，它还定义了应用于基础文件夹中定义的资源的补丁。这些补丁与上面版本2中定义的补丁非常相似。</li></ul><p id="f256" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有了上下文设置，现在让我们试一试，用Kustomize部署VotingApp的第2版。这可以用下面的命令来完成，这个命令是标准的<code class="fe nn no np nq b">kubectl apply</code>，只是它使用了<code class="fe nn no np nq b">-k</code>标志:</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="449c" class="nv mr it nq b gy nw nx l ny nz"># k0s kubectl apply -k overlays/v2/</span></pre><p id="7246" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们可以访问VotingApp，再次为我们最喜欢的动物投票。</p><p id="d743" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成后，我们可以使用创建时使用的相同的<code class="fe nn no np nq b">-k</code>标志删除应用程序。</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="4960" class="nv mr it nq b gy nw nx l ny nz"># k0s kubectl delete -k overlays/v2</span></pre><p id="e7e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这种方法非常简洁，避免了太多的重复。正如我们所看到的，基本资源从不被修改，只有补丁被应用于它们以生成新的资源。</p><blockquote class="oc od oe"><p id="b73f" class="kz la ob lb b lc ld ju le lf lg jx lh of lj lk ll og ln lo lp oh lr ls lt lu im bi translated">Kustomize通常用于在不同的环境中部署相同的应用程序，每个环境都有一个覆盖层的子文件夹。</p></blockquote></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h2 id="0bc1" class="nv mr it bd ms or os dn mw ot ou dp na li ov ow nc lm ox oy ne lq oz pa ng pb bi translated">关键要点</h2><p id="d494" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">在本文中，我们概述了在Kubernetes中部署应用程序的主要方式:</p><ul class=""><li id="7eda" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">使用原始的yaml规范是管理应用程序最简单但可配置性较差的方法</li><li id="933e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">Helm是一种更加可配置的方法。它使用一种模板语言，动态值，并使管理应用程序的整个生命周期变得简单。除此之外，舵图可以很容易地分发，许多应用程序都可以通过舵图获得</li><li id="73c0" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">Kustomize是另一种方法，它允许通过一个基本文件夹定义同一个应用程序的几个版本，该基本文件夹可以通过使用额外的资源而过载。Kustomize可以通过多个覆盖子文件夹轻松管理一个应用程序的多个版本</li></ul><p id="cebc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">🔥VotingApp已经知道了过去几周的许多变化。不要犹豫，看看<a class="ae ky" href="https://gitlab.com/voting-application/config" rel="noopener ugc nofollow" target="_blank"> GitLab repo </a>。在这个演示应用程序的上下文中，你会找到更多关于Helm和Kustomize的信息和高级用法。</p></div></div>    
</body>
</html>