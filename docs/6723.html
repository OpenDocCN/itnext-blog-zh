<html>
<head>
<title>Building a Password Recovery service in OutSystems</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在外部系统中构建密码恢复服务</h1>
<blockquote>原文：<a href="https://itnext.io/building-a-password-recovery-service-in-outsystems-38ca0606e841?source=collection_archive---------1-----------------------#2022-02-08">https://itnext.io/building-a-password-recovery-service-in-outsystems-38ca0606e841?source=collection_archive---------1-----------------------#2022-02-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/82892b64b3c2dbd0ff930747fea873ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LZLu0n8p7EsaofWeik-zHA.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">根据<a class="ae kc" href="https://creativecommons.org/licenses/by/2.0/" rel="noopener ugc nofollow" target="_blank">知识共享2.0 </a>由<a class="ae kc" href="https://linktr.ee/wuestenigel" rel="noopener ugc nofollow" target="_blank"> Marco Verch </a>拍摄的照片</figcaption></figure><p id="4d23" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用电子邮件是允许用户重置密码的常见方式，通常有两个步骤，<em class="lb">忘记密码请求</em>和<em class="lb">重置密码</em>。</p><p id="1e8c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通常情况下，用户会参考一封电子邮件，应用程序会发送一条消息，其中包含一个带有令牌的链接，允许它确认用户就是他们所说的那个人，并继续注册新密码。</p><p id="7a10" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然而，对此有一些考虑。让我们使用<a class="ae kc" href="https://cheatsheetseries.owasp.org/cheatsheets/Forgot_Password_Cheat_Sheet.html#offline-methods" rel="noopener ugc nofollow" target="_blank"> OWASP忘记密码备忘单</a>作为参考。</p><h1 id="f827" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">忘记密码请求</h1><p id="5402" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">根据定义，该服务未经身份验证，任何人都可以多次使用。</p><p id="3307" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它不应该确认电子邮件是否与注册用户相关联。这带来了一个额外的挑战，如果用户有多个电子邮件帐户，并且不记得使用了哪个帐户，该怎么办？你可以找到很多关于这个话题的讨论。</p><p id="d8f7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有些人喜欢含糊的“电子邮件已发送，请检查您的收件箱”，即使没有发送任何消息，因为电子邮件地址与用户无关。</p><p id="268a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有些人使用更明确的“如果找到，将发送电子邮件…”并且只发送给与注册用户相关的电子邮件。</p><p id="6fbb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有些人喜欢总是向引用的电子邮件发送消息。一条消息表明没有注册用户与该电子邮件地址相关联，另一条消息包括恢复链接，如果该电子邮件地址实际上与用户相关联的话。这是完美的，如果用户有多个电子邮件帐户，并且不记得哪个被使用。</p><p id="68d3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了避免用户失望，我们将实现第三个选项。如果电子邮件地址与用户相关联，则<strong class="kf ir"> Token_Create </strong>方法仅返回恢复<strong class="kf ir"> URL </strong>。有了这个，你的应用程序可以决定发送哪个电子邮件版本。</p><p id="85bf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还需要防止滥发电子邮件帐户，稍后会有更多。</p><h1 id="c26e" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">URL令牌</h1><p id="c020" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">应该使用加密的安全随机数生成。令牌应该是全局唯一的，并且难以猜测，以使暴力或字典攻击变得非常困难。</p><p id="965e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">传统的加密API提供了一种方法来做到这一点。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mf"><img src="../Images/733b10354a50c626afb110f2ef203131.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oLsmFNIkqASoVGTMTlJsVQ.png"/></div></div></figure><p id="bb57" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">应该链接到一个单独的用户，并以一种安全的方式存储，这样即使数据库遭到破坏，您也无法重新生成一个有效的URL。</p><p id="f6a3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">应用程序将对令牌进行哈希处理，并且只存储哈希。我们可以使用一个简单的散列(没有盐或胡椒),因为由于令牌是唯一的，很难猜测，并且只使用一次，它可以防止字典和暴力攻击。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mk"><img src="../Images/473dd91330bcedc51e79f699ad8362e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kVEry0KI1gcFxaJTnZPQYA.png"/></div></div></figure><p id="e59c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">应该是短命的。通常令牌都有到期日期。</p><p id="1c2e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">应该有一个硬编码的URL，或者根据受信任域的列表来验证它。由于恢复URL很可能是根据应用程序的参数构建的，这将防止攻击者假冒您的URL链接，并将您的用户重定向到他们自己的重置密码页面。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ml"><img src="../Images/e52af418f0047414410fb0971531272d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yQyFYVZsRz6C3Bk4xpJRBQ.png"/></div></div></figure><h1 id="6074" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">垃圾邮件防范</h1><p id="ecee" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">攻击者可以使用您的密码恢复系统来骚扰和发送随机电子邮件地址，或者发送垃圾邮件给一个他知道该电子邮件的特定注册用户。</p><p id="e6bc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了防止这种情况，我们需要阻止针对特定电子邮件的多次尝试。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mm"><img src="../Images/b293b2aa9c6c5115cb4f11203eae40a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FXZ1cKjBSK8mZVQzHm6MrA.png"/></div></div></figure><p id="9a02" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">而且来自同一个IP地址的请求数量异常多。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/ed1f2cf08f273062ddaa9bbb90c15587.png" data-original-src="https://miro.medium.com/v2/resize:fit:1138/format:webp/1*-mDQEBQvHNpoXfHP2xcriQ.png"/></div></figure><p id="eaaf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这不是完全充分的证据，但它确实使事情对攻击者来说更加复杂。</p><h1 id="8cd6" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">推荐策略</h1><p id="d0be" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">当我们在URL中包含敏感信息时，我们必须考虑<a class="ae kc" href="https://portswigger.net/kb/issues/00500400_cross-domain-referer-leakage" rel="noopener ugc nofollow" target="_blank">跨域推荐人泄漏</a>的可能性。</p><p id="e96f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">每当您从服务器外部的资源(如图像、java脚本等)加载内容时，都会发生这种情况。</p><p id="c0c9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">浏览器包含一个referrer头，让拥有资源的服务器知道谁在请求它。</p><p id="f72a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现代浏览器通过在“Referrer-policy”上自动包括“strict-origin”(或类似的)头来限制这一点，这将只包括Referrer头上的域，而不是完整的URL。</p><p id="a999" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，如果我的重置密码页面上有一个外部图片，chrome会添加一个“严格来源”的推荐策略:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/b099f87b65a1b31f21bcd7fcc573b950.png" data-original-src="https://miro.medium.com/v2/resize:fit:820/format:webp/1*i7gp3S_nQzmBu7i2oDpjfg.png"/></div></figure><p id="f73e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并且仅泄漏“referer”报头上的域部分。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/0bb6941ef4ab16b9381e92496de63b0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:826/format:webp/1*x-AbFMv5ZIgXuf3HJeBaPw.png"/></div></figure><p id="c844" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然而，你不应该相信浏览器在做什么。</p><p id="f0b6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你应该在你的重置密码页面上包含一个“禁止推荐”的指示，以防你的应用程序从其他地方加载内容。类似于:</p><figure class="mg mh mi mj gt jr"><div class="bz fp l di"><div class="mq mr l"/></div></figure><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/fb986e374d1304ef07ac17d69c9a48be.png" data-original-src="https://miro.medium.com/v2/resize:fit:822/format:webp/1*oMEmzaQrVDnOQtTPHJYMVg.png"/></div></figure><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/636e55672958c778391891b7de7100ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:822/format:webp/1*dKhkOqYSUEZl_2d5_TCJCw.png"/></div></figure><h1 id="51af" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">更新密码</h1><p id="cfc2" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">一旦一切检查完毕，就只需要更新用户密码了。为此，您可以使用用户模块API，并且不要忘记删除已使用的令牌。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mt"><img src="../Images/879a27dd9ff59da20ddea946a62d0147.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vrPQY0EzK-KBcFVoo4j3bg.png"/></div></div></figure><p id="42a2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像往常一样，这个组件，演示和单元测试可以在<a class="ae kc" href="https://www.outsystems.com/forge/component-overview/12355/password-reset-service" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/6b44b1d3c4b7b1666e47d962773f51a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:544/format:webp/1*eKnCVObPaBIdWrUb1BnrIA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://www.outsystems.com/forge/component-overview/12355/password-reset-service" rel="noopener ugc nofollow" target="_blank">密码重置服务</a></figcaption></figure><p id="1a14" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">看看YouTube上的视频:</p><figure class="mg mh mi mj gt jr"><div class="bz fp l di"><div class="mv mr l"/></div></figure><p id="7600" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">…现在，去构建那些应用程序吧！</p></div></div>    
</body>
</html>