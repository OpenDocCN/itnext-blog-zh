<html>
<head>
<title>Taking Rails 6’s Action Mailbox for a Spin</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带着Rails 6的动作邮箱兜一圈</h1>
<blockquote>原文：<a href="https://itnext.io/taking-rails-6s-action-mailbox-for-a-spin-104d0e34d379?source=collection_archive---------3-----------------------#2020-03-18">https://itnext.io/taking-rails-6s-action-mailbox-for-a-spin-104d0e34d379?source=collection_archive---------3-----------------------#2020-03-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/6bf2fd5a414ff2f43efcb97402fe8969.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/format:webp/0*ChbhgrYhTCphOP7z.jpg"/></div></figure><p id="8ade" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">动作邮箱是<a class="ae ks" href="https://edgeguides.rubyonrails.org/6_0_release_notes.html" rel="noopener ugc nofollow" target="_blank"> Rails 6 </a>的新功能之一。<a class="ae ks" href="https://weblog.rubyonrails.org/2018/12/13/introducing-action-mailbox-for-rails-6/" rel="noopener ugc nofollow" target="_blank">摘自Basecamp 3 </a>，动作邮箱—“<em class="kt">将收到的电子邮件路由到类似控制器的邮箱，在Rails中进行处理。它附带了Mailgun、Mandrill、邮戳和SendGrid的入口。您还可以通过内置的Exim、Postfix和Qmail ingresses直接处理入站邮件。</em></p><p id="94c7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="kt">这些入站电子邮件使用Active Job异步路由到一个或多个专用邮箱，这些邮箱能够直接与您的域模型的其余部分进行交互。</em>【1】</p><p id="925b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在本文中，我将试用Action Mailbox，并编写一个简单的Rails 6应用程序来演示Action Mailbox。</p><h1 id="837a" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">设置</h1><p id="2226" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated">让我们使用下面的命令创建一个新的rails项目<strong class="jw ir"> action_mail_test </strong></p><blockquote class="lx ly lz"><p id="e618" class="ju jv kt jw b jx jy jz ka kb kc kd ke ma kg kh ki mb kk kl km mc ko kp kq kr ij bi translated">$rails新动作_邮件_测试</p></blockquote><p id="62d6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因为我将使用postgresql作为数据库，所以我在Gemfile中添加了<strong class="jw ir"> pg </strong> gem</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="7d9f" class="mm kv iq mi b gy mn mo l mp mq">gem 'pg', '1.2.2'</span></pre><p id="09e4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来是—</p><blockquote class="lx ly lz"><p id="4584" class="ju jv kt jw b jx jy jz ka kb kc kd ke ma kg kh ki mb kk kl km mc ko kp kq kr ij bi translated">$捆绑安装</p></blockquote><p id="93ba" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我更新了<strong class="jw ir"> database.yml </strong>来包含开发和测试数据库配置。因为这只是为了在开发环境中演示，所以我跳过了生产数据库配置。这个文件看起来如下—</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="ceba" class="mm kv iq mi b gy mn mo l mp mq">default: &amp;default<br/>  username: meraj<br/>  password:<br/>  adapter: postgresql<br/>  host: localhost<br/>  pool: 10<br/>  timeout: 5000<br/><br/>development:<br/>  &lt;&lt;: *default<br/>  database: mailbox_dev<br/><br/><em class="kt"># Warning: The database defined as "test" will be erased and<br/># re-generated from your development database when you run "rake".<br/># Do not set this db to the same as development or production.<br/></em>test:<br/>  &lt;&lt;: *default<br/>  database: mailbox_test</span></pre><p id="2241" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">配置好数据库后，我使用下面的命令创建了开发和测试数据库—</p><blockquote class="lx ly lz"><p id="1060" class="ju jv kt jw b jx jy jz ka kb kc kd ke ma kg kh ki mb kk kl km mc ko kp kq kr ij bi translated">$rails数据库:创建</p></blockquote><p id="cfcb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在是安装InboundEmail所需的迁移并确保设置活动存储的时候了。为此，我运行了以下命令—</p><blockquote class="lx ly lz"><p id="5246" class="ju jv kt jw b jx jy jz ka kb kc kd ke ma kg kh ki mb kk kl km mc ko kp kq kr ij bi translated">$ rails action_mailbox:安装</p><p id="a089" class="ju jv kt jw b jx jy jz ka kb kc kd ke ma kg kh ki mb kk kl km mc ko kp kq kr ij bi translated">将application_mailbox.rb复制到app/mailbox</p><p id="f10b" class="ju jv kt jw b jx jy jz ka kb kc kd ke ma kg kh ki mb kk kl km mc ko kp kq kr ij bi translated">创建应用程序/邮箱/应用程序_邮箱. rb</p><p id="77ff" class="ju jv kt jw b jx jy jz ka kb kc kd ke ma kg kh ki mb kk kl km mc ko kp kq kr ij bi translated">已从活动存储复制迁移20200318005908 _ create _ active _ storage _ tables . active _ storage . Rb</p><p id="09a2" class="ju jv kt jw b jx jy jz ka kb kc kd ke ma kg kh ki mb kk kl km mc ko kp kq kr ij bi translated">已从action_mailbox复制迁移20200318005909 _ create _ action _ mailbox _ tables . action _ mailbox . Rb</p></blockquote><p id="931c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">该命令生成了一些迁移文件。运行<strong class="jw ir"> rails db:migrate </strong>创建如下所示的四个表</p><figure class="md me mf mg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi mr"><img src="../Images/575c2d50bfa8512d4097de70d21c6321.png" data-original-src="https://miro.medium.com/v2/resize:fit:688/format:webp/1*goEEYPwe2Bhj_pCynaqUbA.png"/></div></div></figure><h1 id="9029" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">按指定路线发送</h1><p id="cc82" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated">在这个阶段，我在自动生成的文件<strong class="jw ir">app/mailbox/application _ mailbox . Rb</strong>中设置路由</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="3a2a" class="mm kv iq mi b gy mn mo l mp mq">class ApplicationMailbox &lt; ActionMailbox::Base<br/>  POSTS_REGEX = /meraj@funwriting.io/i<br/><br/>  <em class="kt"># routing /something/i =&gt; :somewhere<br/>  </em>routing POSTS_REGEX =&gt; :posts<br/>end</span></pre><p id="b5f3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我的意图是创建一些基于入口电子邮件的博客帖子。因此，这种路由实质上是为收到的电子邮件建立了一个路由，从<strong class="jw ir"> meraj@funwriting.io </strong>到<strong class="jw ir"> posts </strong>邮箱。</p><p id="3236" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">根据您的实际需要，您需要正确配置路由，这可能会更复杂。</p><h1 id="7327" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">生成邮箱</h1><p id="2ed2" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated">为了生成邮箱<strong class="jw ir">帖子</strong>，我发出了以下命令—</p><blockquote class="lx ly lz"><p id="b481" class="ju jv kt jw b jx jy jz ka kb kc kd ke ma kg kh ki mb kk kl km mc ko kp kq kr ij bi translated">$ rails生成邮箱帖子</p><p id="bd70" class="ju jv kt jw b jx jy jz ka kb kc kd ke ma kg kh ki mb kk kl km mc ko kp kq kr ij bi translated">在进程85759中通过Spring预加载程序运行</p><p id="2400" class="ju jv kt jw b jx jy jz ka kb kc kd ke ma kg kh ki mb kk kl km mc ko kp kq kr ij bi translated">创建app/mailbox/posts _ mailbox . Rb</p><p id="5730" class="ju jv kt jw b jx jy jz ka kb kc kd ke ma kg kh ki mb kk kl km mc ko kp kq kr ij bi translated">调用测试单元</p><p id="f690" class="ju jv kt jw b jx jy jz ka kb kc kd ke ma kg kh ki mb kk kl km mc ko kp kq kr ij bi translated">创建测试/邮箱/帖子_邮箱_测试. rb</p></blockquote><p id="b2e8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">除了<strong class="jw ir"> posts_mailbox.rb </strong>之外，它还生成了一个测试文件<strong class="jw ir"> posts_mailbox_test.rb </strong>。</p><h1 id="84b2" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">处理入站电子邮件</h1><p id="b1c3" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated">在<strong class="jw ir"> posts_mailbox.rb </strong>中唯一需要的方法是<strong class="jw ir"> process </strong>来处理收到的邮件。在这种情况下，我想自动生成一些博客文章，文章的标题设置为邮件的主题，正文设置为邮件的正文，所有者设置为邮件的from部分的名称。</p><p id="058f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为此，首先我生成了<strong class="jw ir"> Post </strong>模型，并运行相应的迁移以在数据库中创建<strong class="jw ir"> posts </strong>表</p><blockquote class="lx ly lz"><p id="2e4e" class="ju jv kt jw b jx jy jz ka kb kc kd ke ma kg kh ki mb kk kl km mc ko kp kq kr ij bi translated">$rails g模型文章标题:字符串主体:文本所有者:文本</p><p id="3c2e" class="ju jv kt jw b jx jy jz ka kb kc kd ke ma kg kh ki mb kk kl km mc ko kp kq kr ij bi translated">$rails db:迁移</p></blockquote><p id="aeba" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">同样，对于更实际的用法，所有者应该是来自用户表的某个id，可以使用电子邮件地址来查找。</p><p id="efe9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在创建了<strong class="jw ir"> posts </strong>表之后，我已经将下面的代码放到了<strong class="jw ir"> posts_mailbox.rb </strong>文件中—</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="fb4b" class="mm kv iq mi b gy mn mo l mp mq">class PostsMailbox &lt; ApplicationMailbox<br/>  before_processing :process_owner<br/><br/>  def process<br/>    Post.create(title: mail.subject, body: mail.body, owner: @owner)<br/>  end<br/><br/>  private<br/>  def process_owner<br/>    @owner = mail.from.first.split('@').first<br/>  end<br/>end</span></pre><p id="d426" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">基本上，它所做的是—</p><ul class=""><li id="9344" class="mw mx iq jw b jx jy kb kc kf my kj mz kn na kr nb nc nd ne bi translated"><strong class="jw ir">before _ processing filter</strong>—在<strong class="jw ir">进程</strong>方法执行之前运行，从<strong class="jw ir">邮件中提取名称部分(之前的部分@)</strong></li><li id="23fd" class="mw mx iq jw b jx nf kb ng kf nh kj ni kn nj kr nb nc nd ne bi translated"><strong class="jw ir"> process </strong>方法——创建一个<strong class="jw ir"> Post </strong>，标题设置为<strong class="jw ir"> mail.subject </strong>，正文设置为<strong class="jw ir"> mail.body </strong>，所有者设置为<strong class="jw ir"> @owner </strong>，由process_owner私有方法生成。</li></ul><h1 id="b092" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">本地测试</h1><p id="99c0" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated">我先启动了服务器—</p><blockquote class="lx ly lz"><p id="ae2a" class="ju jv kt jw b jx jy jz ka kb kc kd ke ma kg kh ki mb kk kl km mc ko kp kq kr ij bi translated">$rails服务器</p></blockquote><p id="bdaa" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Rails提供了一种便捷的方式来使用以下途径生成入站电子邮件—</p><p id="ca1a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><a class="ae ks" href="http://localhost:3000/rails/conductor/action_mailbox/inbound_emails/new" rel="noopener ugc nofollow" target="_blank">T35】http://localhost:3000/rails/conductor/action _ mailbox/inbound _ emails/newT37】</a></p><p id="b7ce" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">主机名</strong>(本地主机)和<strong class="jw ir">端口</strong> (3000)需要根据您的设置进行修改。但是这应该会弹出一个如下所示的漂亮的GUI</p><figure class="md me mf mg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi nk"><img src="../Images/7e4260cd14357e6a44eccb37a631c33d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ns_Pgq2w1ZTcVTLJduMVLQ.png"/></div></div></figure><p id="72f7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我通过点击“<strong class="jw ir">发送入站电子邮件</strong>”创建了一个样本帖子，包含上面截图中的信息</p><figure class="md me mf mg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi nl"><img src="../Images/c58966fd4b8bd4dbad6bee685676deae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CofCxwK1PMjXtDxlhp_YJg.png"/></div></div></figure><h1 id="937a" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">生产用途</h1><p id="bc73" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated">对于生产用途，您可能希望使用SendGrid或其他入口。如何配置这些入口在官方的<a class="ae ks" href="https://edgeguides.rubyonrails.org/action_mailbox_basics.html" rel="noopener ugc nofollow" target="_blank">操作邮箱基础</a>指南中有记录。</p><h1 id="694d" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated"><strong class="ak">焚烧收件箱</strong></h1><p id="b5aa" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated">默认情况下，已成功处理的收件箱邮件将在30天后被销毁。实际的焚化是通过计划在<code class="fe nm nn no mi b"><strong class="jw ir">config.action_mailbox.incinerate_after</strong></code>时间后运行的<code class="fe nm nn no mi b"><strong class="jw ir">IncinerationJob</strong></code>完成的。这个值默认设置为<code class="fe nm nn no mi b"><strong class="jw ir">30.days</strong></code>，但是您可以在您的<strong class="jw ir"> production.rb </strong>配置中更改它。</p><p id="5442" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在本文中，我试用了Rails 6的Action Mailbox，并试图通过编写一个示例应用程序来演示如何使用它。我希望这能帮助一些读者熟悉Rails 6的这个重要特性。该应用的源代码可以在我的GitHub上找到，链接如下:<a class="ae ks" href="https://github.com/imeraj/action_mailbox_test" rel="noopener ugc nofollow" target="_blank"><em class="kt">https://github.com/imeraj/action_mailbox_test</em></a></p><p id="6fcb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="kt">如需更多详细和深入的未来技术帖子，请关注我这里或上</em><a class="ae ks" href="https://twitter.com/meraj_enigma" rel="noopener ugc nofollow" target="_blank"><em class="kt">Twitter</em></a><em class="kt">。</em></p><h1 id="5c30" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">参考</h1><p id="1bb1" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated">[1]<a class="ae ks" href="https://edgeguides.rubyonrails.org/action_mailbox_basics.html" rel="noopener ugc nofollow" target="_blank">https://edge guides . ruby on rails . org/action _ mailbox _ basics . html</a></p></div></div>    
</body>
</html>