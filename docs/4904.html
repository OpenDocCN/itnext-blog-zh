<html>
<head>
<title>Helm: reusable chart — named templates, and a generic chart for multiple applications</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Helm:可重复使用的图表——命名模板，以及适用于多个应用程序的通用图表</h1>
<blockquote>原文：<a href="https://itnext.io/helm-reusable-chart-named-templates-and-a-generic-chart-for-multiple-applications-13d9b26e9244?source=collection_archive---------3-----------------------#2020-10-20">https://itnext.io/helm-reusable-chart-named-templates-and-a-generic-chart-for-multiple-applications-13d9b26e9244?source=collection_archive---------3-----------------------#2020-10-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/b9fc5e757427bf0e8c595eb166bc8f06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c1KpqjtxtNi87QQVRQnPvQ.jpeg"/></div></figure><p id="86f6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们的项目正在增长，越来越多的应用程序开始在AWS Elastic Kubernetes服务上运行。</p><p id="c834" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">最后，我们面对的问题已经在<a class="ae ks" href="https://rtfm.co.ua/helm-poshagovoe-sozdanie-charta-i-deplojmenta-iz-jenkins/" rel="noopener ugc nofollow" target="_blank">Helm:пошаговоесозданиечартаиелокментаиззJenkins</a>(<em class="kt">RUS</em>)—当使用大量类似的应用程序时，如何处理Kubernetes清单和helm模板？</p><p id="3534" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">尤其是现在，当我们从同一个存储库中部署了相同的代码，但是有三个相似的应用程序时。</p><p id="9f32" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">起初，我们只有一个，后来又增加了一个，现在我们正准备发布第三个。</p><p id="73f8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，他们的图表现在看起来如下:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="ef16" class="ld le iq kz b gy lf lg l lh li">$ tree -d k8s/<br/>k8s/<br/>├── app1-chart<br/>│ ├── charts<br/>│ ├── env<br/>│ │ ├── dev<br/>│ │ ├── dev-2<br/>│ │ └── prod<br/>│ └── templates<br/>└── app2-chart<br/>├── charts<br/>├── env<br/>│ ├── dev<br/>│ ├── prod<br/>│ └── stage<br/>└── templates</span></pre><p id="6f82" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以，现在我需要再次复制相同的图表？</p><p id="0174" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我一点也不喜欢这个想法，所以让我们更深入地了解一下Helm模板，并尝试创建一个图表来部署三个类似的应用程序。</p><h1 id="9690" class="lj le iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">内容</h1><ul class=""><li id="d469" class="mg mh iq jw b jx mi kb mj kf mk kj ml kn mm kr mn mo mp mq bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/helm-reusable-chart-named-templates-and-a-generic-chart-for-multiple-applications/#Deployment_%E2%80%93_the_file%E2%80%99s_structure" rel="noopener ugc nofollow" target="_blank">部署—文件的结构</a></li><li id="5b98" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/helm-reusable-chart-named-templates-and-a-generic-chart-for-multiple-applications/#Helm_Named_templates" rel="noopener ugc nofollow" target="_blank">头盔命名模板</a></li><li id="839c" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/helm-reusable-chart-named-templates-and-a-generic-chart-for-multiple-applications/#Common_labels" rel="noopener ugc nofollow" target="_blank">常见标签</a></li><li id="5910" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/helm-reusable-chart-named-templates-and-a-generic-chart-for-multiple-applications/#define" rel="noopener ugc nofollow" target="_blank">定义</a></li><li id="13c1" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/helm-reusable-chart-named-templates-and-a-generic-chart-for-multiple-applications/#include" rel="noopener ugc nofollow" target="_blank">包括</a></li><li id="0fd4" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/helm-reusable-chart-named-templates-and-a-generic-chart-for-multiple-applications/#indent_vs_nindent" rel="noopener ugc nofollow" target="_blank">缩进与非缩进</a></li><li id="cdd1" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/helm-reusable-chart-named-templates-and-a-generic-chart-for-multiple-applications/#Templates_inside_of_a_template" rel="noopener ugc nofollow" target="_blank">模板内部的模板</a></li><li id="6db8" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/helm-reusable-chart-named-templates-and-a-generic-chart-for-multiple-applications/#The_env_block_from_a_project%E2%80%99s_values_yaml_file" rel="noopener ugc nofollow" target="_blank">来自项目的values.yaml文件的env块</a></li><li id="a1f6" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/helm-reusable-chart-named-templates-and-a-generic-chart-for-multiple-applications/#The_rangeloop" rel="noopener ugc nofollow" target="_blank">范围循环</a></li><li id="6b18" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/helm-reusable-chart-named-templates-and-a-generic-chart-for-multiple-applications/#The_range_loop_with_variables" rel="noopener ugc nofollow" target="_blank">带变量的范围循环</a></li><li id="2925" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/helm-reusable-chart-named-templates-and-a-generic-chart-for-multiple-applications/#toYaml" rel="noopener ugc nofollow" target="_blank">托亚姆</a></li><li id="c711" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/helm-reusable-chart-named-templates-and-a-generic-chart-for-multiple-applications/#Whitespaces" rel="noopener ugc nofollow" target="_blank">空格</a></li><li id="8175" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/helm-reusable-chart-named-templates-and-a-generic-chart-for-multiple-applications/#Helm_tpl" rel="noopener ugc nofollow" target="_blank">舵tpl </a></li><li id="1358" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/helm-reusable-chart-named-templates-and-a-generic-chart-for-multiple-applications/#The_env_block_from_the_helpers_tpl" rel="noopener ugc nofollow" target="_blank">来自_helpers.tpl的env块</a></li><li id="9976" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/helm-reusable-chart-named-templates-and-a-generic-chart-for-multiple-applications/#if/else_%E2%80%94_flow_control" rel="noopener ugc nofollow" target="_blank"> if/else —流量控制</a></li><li id="b761" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/helm-reusable-chart-named-templates-and-a-generic-chart-for-multiple-applications/#The_env_block_from_an_external_file" rel="noopener ugc nofollow" target="_blank">来自外部文件的env块</a></li><li id="c5e6" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/helm-reusable-chart-named-templates-and-a-generic-chart-for-multiple-applications/#Excluding_a_template_from_the_chart" rel="noopener ugc nofollow" target="_blank">从图表中排除模板</a></li></ul><h1 id="dbd2" class="lj le iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">部署—文件的结构</h1><p id="642f" class="pw-post-body-paragraph ju jv iq jw b jx mi jz ka kb mj kd ke kf mw kh ki kj mx kl km kn my kp kq kr ij bi translated">为了考虑未来通用模板的结构，让我们检查哪些块将是所有应用程序通用和共享的，哪些块将是不同的，并将包含在模板中。</p><p id="ff49" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这里，我们将主要讨论<code class="fe mz na nb kz b">deployment.yaml</code>文件，其他的将会以类似的方式完成。</p><p id="7b66" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以:</p><ul class=""><li id="cb8b" class="mg mh iq jw b jx jy kb kc kf nc kj nd kn ne kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">deployment.yaml</code>文件:</li><li id="1620" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">metadata</code>:</li><li id="e112" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">name</code>:常用，从具体项目的<code class="fe mz na nb kz b">values.yaml</code>中取值</li><li id="f4fb" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">annotations</code> : common，我们这里只有<code class="fe mz na nb kz b">reloader.stakater.com/auto</code>，它将始终被设置为<em class="kt"> true </em>(不过，请查看<a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-configmap-and-secrets-data-auto-reload-in-pods/" rel="noopener ugc nofollow" target="_blank"> Kubernetes: ConfigMap和Secrets–pod中的数据自动重新加载</a>帖子，了解其他可用选项)</li><li id="d061" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">labels</code> : common，将在不同的地方使用，例如在下面的<code class="fe mz na nb kz b">spec.template.metadata.labels</code>中的同一个文件中，以及在带有Kubernetes Cronjobs的模板中，所以将标签移动到<code class="fe mz na nb kz b">_helpers.yaml</code>文件中是一个好主意</li><li id="2ba9" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">spec</code>:</li><li id="3e0e" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">replicas</code>:常用，从具体项目的<code class="fe mz na nb kz b">values.yaml</code>中取值</li><li id="d93b" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">strategy</code>:</li><li id="70c0" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated">type: common，从具体项目的<code class="fe mz na nb kz b">values.yaml</code>中取值</li><li id="1345" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">selector</code>:</li><li id="f9c9" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">matchLabels</code>:同样常见，也会在不同的地方使用，我们把它移到<code class="fe mz na nb kz b">_helpers.yaml</code></li><li id="e1f0" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">template</code>:</li><li id="96b5" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">metadata</code>:</li><li id="da71" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">labels</code>:取自<code class="fe mz na nb kz b">_helpers.yaml</code></li><li id="d301" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">spec</code>:</li><li id="b5db" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">containers</code>:</li><li id="57d6" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">name</code>:常用，从具体项目的<code class="fe mz na nb kz b">values.yaml</code>中取值</li><li id="7cfc" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">image</code>:常见，取自具体项目的<code class="fe mz na nb kz b">values.yaml</code></li><li id="6069" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">env</code>:本帖最有趣的部分:</li></ul><ol class=""><li id="5cfd" class="mg mh iq jw b jx jy kb kc kf nc kj nd kn ne kr nf mo mp mq bi translated">我们可以将它移动到每个项目<br/>的<code class="fe mz na nb kz b">values.yaml</code>中-优点:不需要指定值，因为它们可以在变量<br/>的<code class="fe mz na nb kz b">value</code>字段中直接设置-缺点:<br/> -我们的变量在所有项目中几乎是相同的-因此它们将被复制<br/> -由于我们有许多变量要添加<br/>，<code class="fe mz na nb kz b">values.yaml</code>将变得臃肿-并非所有变量都在<em class="kt">键:值</em>视图中 —一些将从<code class="fe mz na nb kz b">valueFrom.secretKeyRef.&lt;KUBE_SECRET_NAME&gt;</code>中获取其值，因此无法直接在<code class="fe mz na nb kz b">values.yaml</code>中设置其值</li><li id="442e" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr nf mo mp mq bi translated">另一种方法是使用<code class="fe mz na nb kz b">_helpers.yaml</code>文件，其中我们将有一组公共变量，每个变量都有自己的<code class="fe mz na nb kz b">if/then</code>——如果项目的<code class="fe mz na nb kz b">values.yaml</code>不包含变量值，那么这样的变量将不会被添加到通用模板中，因此不会因为添加新变量而破坏项目的部署</li><li id="af3c" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr nf mo mp mq bi translated">对于一个项目必须有自己的一组变量的情况，我们可以通过检查类似<code class="fe mz na nb kz b">if {{ .Values.chartSettings.customEnvs == true }}</code>的东西在<code class="fe mz na nb kz b">env</code>块前添加一个条件，并跳过从<code class="fe mz na nb kz b">_helpers.yaml</code>或<code class="fe mz na nb kz b">values.yaml</code>添加块，而是使用类似<code class="fe mz na nb kz b">tpl .File.Get project1/envs.yaml</code>的专用文件</li></ol><ul class=""><li id="c606" class="mg mh iq jw b jx jy kb kc kf nc kj nd kn ne kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">volumeMounts</code>:也可以有所不同，以后再考虑吧</li><li id="4f12" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">ports</code>:</li><li id="d52d" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">containerPort</code>:将总是，将从<code class="fe mz na nb kz b">values.yaml</code>中获取其值(顺便说一下，根本没有必要在这里添加它们，参见<a class="ae ks" href="https://medium.com/faun/should-i-configure-the-ports-in-kubernetes-deployment-c6b3817e495" rel="noopener">我应该在Kubernetes部署中配置端口吗？</a>帖子)</li><li id="115c" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">livenessProbe</code>、<code class="fe mz na nb kz b">readinessProbe</code>:将与<code class="fe mz na nb kz b">httpGet.path</code>和<code class="fe mz na nb kz b">httpGet.port</code>共用，因此可以移动到<code class="fe mz na nb kz b">_helpers.yaml</code>中，但也可以添加一个选项，通过带有<code class="fe mz na nb kz b">.File.Get</code>的外部文件包含它</li><li id="c406" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">resources</code>:</li><li id="2e87" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">requests.cpu</code>，<code class="fe mz na nb kz b">requests.memory</code>——嗯...我想会为所有人添加，但仍然是一个问题——需要以后再考虑查看<a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-evicted-pods-and-pods-quality-of-service/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:驱逐的pod和pod服务质量</a>帖子了解更多细节</li><li id="5183" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">limits.cpu</code>，<code class="fe mz na nb kz b">limits.memory</code>——所有人的记忆都会受到限制...或者不是...以后会想</li><li id="011b" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">volumes</code>:也可有所不同，留待以后再说</li><li id="736a" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">imagePullSecrets</code>:所有人都一样</li><li id="0714" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">hpa.yaml</code> -用于HPA</li><li id="69f0" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">network.yaml</code> -入口服务</li><li id="b3ea" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">secrets.yaml</code> -库伯内特的秘密</li><li id="f766" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">rbac.yaml</code> -将用户组附加到Helm在部署期间创建的c命名空间中</li><li id="3363" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">cronjobs.yaml</code> -库伯内特·克朗乔布斯</li><li id="f8bf" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">_helpers.tpl</code>——和我们的【助手】为<a class="ae ks" href="https://helm.sh/docs/chart_template_guide/named_templates/" rel="noopener ugc nofollow" target="_blank">掌舵命名的模板</a></li></ul><p id="4568" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以，基本上，主要观点如下:</p><ul class=""><li id="bede" class="mg mh iq jw b jx jy kb kc kf nc kj nd kn ne kr mn mo mp mq bi translated">在<code class="fe mz na nb kz b">templates</code>目录中带有模板的通用图表</li><li id="9987" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated">在<code class="fe mz na nb kz b">templates</code>中会保留<code class="fe mz na nb kz b">deployment.yaml</code>、<code class="fe mz na nb kz b">hpa.yaml</code>、<code class="fe mz na nb kz b">_helpers.tpl</code>等</li><li id="ddf5" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated">在<code class="fe mz na nb kz b">templates</code>附近会创建一个名为<code class="fe mz na nb kz b">projects</code>的附加目录</li><li id="bc20" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated">在里面——按项目名称分类</li><li id="275d" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><em class="kt">项目1 </em></li><li id="6caa" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><em class="kt">项目2 </em></li><li id="8a2b" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><em class="kt">项目3 </em></li><li id="07be" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated">并且在它们中的每一个里面都会有一个<code class="fe mz na nb kz b">env</code>目录</li><li id="3994" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated">带有<code class="fe mz na nb kz b">dev</code>、<code class="fe mz na nb kz b">stage</code>、<code class="fe mz na nb kz b">prod</code>目录</li><li id="b13b" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated">带专用<code class="fe mz na nb kz b">values.yaml</code>和<code class="fe mz na nb kz b">secrets.yaml</code>文件</li></ul><h1 id="ad1b" class="lj le iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">赫尔姆命名模板</h1><p id="7861" class="pw-post-body-paragraph ju jv iq jw b jx mi jz ka kb mj kd ke kf mw kh ki kj mx kl km kn my kp kq kr ij bi translated">关于命名模板的好帖子— <a class="ae ks" href="https://austindewey.com/2020/08/09/how-to-reduce-helm-chart-boilerplate-with-named-templates/" rel="noopener ugc nofollow" target="_blank">如何用命名模板减少舵图样板</a>(更多链接在本文末尾)。</p><p id="2b1b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">官方文档这里是<a class="ae ks" href="https://helm.sh/docs/chart_template_guide/named_templates/" rel="noopener ugc nofollow" target="_blank">&gt;&gt;&gt;</a>。</p><p id="8bb0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们想要移入<code class="fe mz na nb kz b">_helpers.yaml</code>的模板中的第一个块是<code class="fe mz na nb kz b">labels</code>。</p><p id="b10b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Helm中命名模板背后的一般思想是只编写一次代码，然后将它包含在我们需要该代码的每个地方。此外，这有助于减少模板的内容，使其更具可读性。</p><p id="5165" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">已命名的模板文件名以带<code class="fe mz na nb kz b">.tpl</code>扩展名的下划线开头。</p><p id="d4d9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">最常见的文件是我们将在本例中使用的<code class="fe mz na nb kz b">_helpers.tpl</code>。</p><p id="44f4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这个文件中的每个模板定义都以关键字<code class="fe mz na nb kz b">define</code>开始，以<code class="fe mz na nb kz b">end</code>结束。</p><p id="b6ae" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">命名模板的名称通常包括一个图表名称和一个描述模板的块，但也可以使用其他名称。例如，在我们的文件中，我们将使用<em class="kt">助手。&lt;块名</em>名。</p><p id="73ec" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里的一个不便之处是，你不能使用像<code class="fe mz na nb kz b">.Chart.Name</code>这样的值，但是你可以在里面创建一个Helm变量。不确定这一点，以后会看到，现在，将只是硬编码的<em class="kt">助手</em>。</p><h2 id="c6d1" class="ld le iq bd lk ng nh dn lo ni nj dp ls kf nk nl lw kj nm nn ma kn no np me nq bi translated">普通<code class="fe mz na nb kz b">labels</code></h2><p id="3462" class="pw-post-body-paragraph ju jv iq jw b jx mi jz ka kb mj kd ke kf mw kh ki kj mx kl km kn my kp kq kr ij bi translated">嗯，有哪些标签是好的呢？</p><ul class=""><li id="3152" class="mg mh iq jw b jx jy kb kc kf nc kj nd kn ne kr mn mo mp mq bi translated"><em class="kt">环境</em> — <em class="kt">开发</em>、<em class="kt">阶段</em>、<em class="kt">生产</em>——将从<code class="fe mz na nb kz b">values.yaml</code>设置</li><li id="1390" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><em class="kt"> appversion </em> —将在Jenkins中通过<code class="fe mz na nb kz b">--set</code>选项进行编译时设置</li></ul><p id="05da" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">想知道更多好主意，我们可以问谷歌—“<em class="kt">kubernetes推荐标签</em>”，第一个链接是<a class="ae ks" href="https://kubernetes.io/docs/concepts/overview/working-with-objects/common-labels/" rel="noopener ugc nofollow" target="_blank">推荐标签</a>。</p><p id="a90e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，检查舵文档中的<a class="ae ks" href="https://helm.sh/docs/chart_best_practices/labels/" rel="noopener ugc nofollow" target="_blank">标签和注释</a></p><p id="b484" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">另外，看看一些现有的图表可能是个好主意，例如<a class="ae ks" href="https://github.com/helm/charts/blob/0445fad8d8308f089f5fb6756a5570bc6d6f0bf5/stable/sonarqube/templates/deployment.yaml#L5" rel="noopener ugc nofollow" target="_blank">sonar cube/templates/deployment . YAML</a>。</p><p id="cd1e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，我们可以添加四个自定义标签:</p><ul class=""><li id="5343" class="mg mh iq jw b jx jy kb kc kf nc kj nd kn ne kr mn mo mp mq bi translated"><em class="kt">应用</em> : <code class="fe mz na nb kz b">{{ .Values.appConfig.appName }}</code>，将在<code class="fe mz na nb kz b">values.yaml</code>中为每个应用设定</li><li id="9794" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><em class="kt">版本</em> : <code class="fe mz na nb kz b">{{ .Chart.Version }}-{{ .Chart.AppVersion }}</code>，将由詹金斯设定</li><li id="1fc7" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><em class="kt">环境</em> : <code class="fe mz na nb kz b">{{ .Values.appConfig.appEnv }}</code>，将在<code class="fe mz na nb kz b">values.yaml</code>中为每个应用程序设置</li><li id="5d9f" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><em class="kt">被管理人</em> : <code class="fe mz na nb kz b">{{ .Release.Service }}</code>被掌舵人</li></ul><p id="f394" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果我们想要添加另一个——我们可以在一个地方完成，而不是更新所有使用<code class="fe mz na nb kz b">labels</code>的地方。</p><h2 id="fc41" class="ld le iq bd lk ng nh dn lo ni nj dp ls kf nk nl lw kj nm nn ma kn no np me nq bi translated"><code class="fe mz na nb kz b">define</code></h2><p id="7067" class="pw-post-body-paragraph ju jv iq jw b jx mi jz ka kb mj kd ke kf mw kh ki kj mx kl km kn my kp kq kr ij bi translated">回到我们的<code class="fe mz na nb kz b">_helpers.tpl</code>并描述我们的标签:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="64ce" class="ld le iq kz b gy lf lg l lh li">{{- define "helpers.labels" -}}<br/>application: {{ .Values.appConfig.appName }}<br/>version: {{ .Chart.Version }}-{{ .Chart.AppVersion }}<br/>environment: {{ .Values.appConfig.appEnv }}<br/>managed-by: {{ .Release.Service }}<br/>{{- end }}</span></pre><h2 id="6794" class="ld le iq bd lk ng nh dn lo ni nj dp ls kf nk nl lw kj nm nn ma kn no np me nq bi translated"><code class="fe mz na nb kz b">include</code></h2><p id="ec93" class="pw-post-body-paragraph ju jv iq jw b jx mi jz ka kb mj kd ke kf mw kh ki kj mx kl km kn my kp kq kr ij bi translated">然后，使用<code class="fe mz na nb kz b">include</code>，指定它必须包含在一般部署的模板中的位置:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="1d10" class="ld le iq kz b gy lf lg l lh li">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: {{ .Values.appConfig.appName }}-deployment<br/>  labels: {{- include "helpers.labels" . | nindent 4 }}<br/>...</span></pre><h2 id="5062" class="ld le iq bd lk ng nh dn lo ni nj dp ls kf nk nl lw kj nm nn ma kn no np me nq bi translated"><code class="fe mz na nb kz b">indent</code> vs <code class="fe mz na nb kz b">nindent</code></h2><ul class=""><li id="784a" class="mg mh iq jw b jx mi kb mj kf mk kj ml kn mm kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">indent</code> -只是会添加空格</li><li id="5385" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><code class="fe mz na nb kz b">nindent</code> -将添加空格加一个新的线符号</li></ul><p id="91c4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">也就是说，不要像这样写:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="d416" class="ld le iq kz b gy lf lg l lh li">...<br/>  labels: <br/>    {{- include "helpers.labels" . | indent 4 }}<br/>...</span></pre><p id="eec6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们可以在一行中设置它，避免在模板中键入空格:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="a937" class="ld le iq kz b gy lf lg l lh li">...<br/>labels: {{- include "helpers.labels" . | nindent 4 }}<br/>...</span></pre><p id="f292" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，这也起到了将YAML块添加到模板中的作用，将在下面看到它的作用。</p><p id="2191" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">回到命名模板——让我们对<code class="fe mz na nb kz b">spec.selector.matchLabels</code>做同样的事情——将它移动到一个专用模板，这样我们可以在以后重用它，例如在服务中。</p><p id="164c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<code class="fe mz na nb kz b">_helpers.tpl</code>中添加一个新块:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="d242" class="ld le iq kz b gy lf lg l lh li">...<br/>{{- define "helpers.selectorLabels" -}}<br/>application: {{ .Values.appConfig.appName }}<br/>{{- end }}</span></pre><p id="60c1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，我们只按应用程序名进行选择，以后我们可以更新它并包含任何其他选择器。</p><p id="9f87" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将其添加到部署中:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="e76a" class="ld le iq kz b gy lf lg l lh li">...<br/>  selector:<br/>    matchLabels:<br/>      {{- include "helpers.selectorLabels" . | nindent 6 }}<br/>  template:<br/>...</span></pre><h1 id="356f" class="lj le iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">模板中的模板</h1><p id="d13a" class="pw-post-body-paragraph ju jv iq jw b jx mi jz ka kb mj kd ke kf mw kh ki kj mx kl km kn my kp kq kr ij bi translated">我们来到了任务中最有趣的部分——将整个块添加到模板文件中。</p><p id="e1dd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以，在当前使用的模板中，我们有<code class="fe mz na nb kz b">env</code>块:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="b1e7" class="ld le iq kz b gy lf lg l lh li">...<br/>        env:<br/>        - name: APP_SECRET<br/>          valueFrom:<br/>            secretKeyRef:<br/>              name: app-backend-secrets<br/>              key: backend-app-secret<br/>        - name: AUTH_SECRET<br/>          valueFrom:<br/>            secretKeyRef:<br/>              name: app-backend-secrets<br/>              key: backend-auth-secret<br/>        - name: CLIENT_HOST<br/>          value: {{ .Values.appConfig.clientHost }}<br/>        - name: DATABASE_HOST<br/>          value: {{ .Values.appConfig.db.host }}<br/>        - name: DATABASE_SLAVE_HOST<br/>          value: {{ .Values.appConfig.db.slave }}<br/>        - name: DB_USERNAME<br/>          value: {{ .Values.appConfig.db.user }}<br/>        - name: INSTANA_AGENT_HOST<br/>          valueFrom:<br/>            fieldRef:<br/>              fieldPath: status.hostIP<br/>...</span></pre><p id="4412" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们希望将它移动到另一个文件中的一个块中，并将其包含在我们正在编写的新模板中。</p><h2 id="c079" class="ld le iq bd lk ng nh dn lo ni nj dp ls kf nk nl lw kj nm nn ma kn no np me nq bi translated">项目的<code class="fe mz na nb kz b">values.yaml</code>文件中的<code class="fe mz na nb kz b">env</code>块</h2><p id="e930" class="pw-post-body-paragraph ju jv iq jw b jx mi jz ka kb mj kd ke kf mw kh ki kj mx kl km kn my kp kq kr ij bi translated">让我们看看如何实现这一点。</p><p id="b828" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">首先，需要给<code class="fe mz na nb kz b">values.yaml</code>添加环境变量。</p><p id="d6ef" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建目录树:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="b02e" class="ld le iq kz b gy lf lg l lh li">$ mkdir -p projects/newapp/env/dev</span></pre><p id="ca4b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以及里面的文件— <code class="fe mz na nb kz b">values.yaml</code>和<code class="fe mz na nb kz b">secrets.yaml</code>:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="4365" class="ld le iq kz b gy lf lg l lh li">$ touch projects/newapp/env/dev/{values.yaml,secrets.yaml}</span></pre><p id="f1ff" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后，在<code class="fe mz na nb kz b">projects/newapp/env/dev/values.yaml</code>中创建一个名为<em class="kt"> environments </em>的列表，现在只有一个变量:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="e95d" class="ld le iq kz b gy lf lg l lh li">environments:    <br/>  - name: 'DATABASE_HOST'<br/>    value: 'dev.aurora.web.example.com'</span></pre><p id="bf75" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了能够使用<code class="fe mz na nb kz b">helm --debug --dry-run</code>测试模板，添加所有其他数据，如<code class="fe mz na nb kz b">{{ .Values.deployment.replicaCount }}</code>。</p><h2 id="77c3" class="ld le iq bd lk ng nh dn lo ni nj dp ls kf nk nl lw kj nm nn ma kn no np me nq bi translated"><code class="fe mz na nb kz b">range</code>循环</h2><p id="a081" class="pw-post-body-paragraph ju jv iq jw b jx mi jz ka kb mj kd ke kf mw kh ki kj mx kl km kn my kp kq kr ij bi translated">文档— <a class="ae ks" href="https://helm.sh/docs/chart_template_guide/control_structures/" rel="noopener ugc nofollow" target="_blank">流量控制</a>。</p><p id="bbb7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好例子— <a class="ae ks" href="https://kb.novaordis.com/index.php/Helm_Template_range" rel="noopener ugc nofollow" target="_blank">舵模板范围</a>。</p><p id="32d0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，我们有一个环境变量<code class="fe mz na nb kz b">DATABASE_HOST</code>，它的<em class="kt">dev.aurora.web.example.com</em>值在<code class="fe mz na nb kz b">values.yaml</code>中描述，它被设置为带有两个<em class="kt">键:值</em>对的列表元素:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="8f6a" class="ld le iq kz b gy lf lg l lh li">...<br/>  &lt;LIST_NAME&gt;:<br/>    - &lt;VAR_NAME&gt;: &lt;VAR_VALUE&gt;<br/>      &lt;VAR_NAME&gt;: &lt;VAR_VALUE&gt;<br/>...</span></pre><p id="89c2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后我们可以用下面的代码将它包含在通用模板中:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="c3b5" class="ld le iq kz b gy lf lg l lh li">...<br/>    spec:<br/>      containers:<br/>      - name: {{ .Values.appConfig.appName }}-pod<br/>        image: {{ .Values.deployment.image.repository }}/{{ .Values.deployment.image.name }}:{{ .Values.deployment.image.tag }}<br/>        env:<br/>        {{- range .Values.deployment.environments }}<br/>        - name: {{ .name }}                        <br/>          value: {{ .value }}<br/>        {{- end }}<br/>...</span></pre><p id="0280" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里:</p><ul class=""><li id="2f80" class="mg mh iq jw b jx jy kb kc kf nc kj nd kn ne kr mn mo mp mq bi translated">用键:值行迭代<code class="fe mz na nb kz b">environments</code>列表</li><li id="b533" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated">迭代列表中的每个元素，寻找VAR _ NAME<code class="fe mz na nb kz b">.name</code>——这将在name: <code class="fe mz na nb kz b">{{ .name }}</code>中设置</li><li id="4ab4" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated">迭代列表中的每个元素，寻找VAR _ NAME<code class="fe mz na nb kz b">.value</code>——这将在值:<code class="fe mz na nb kz b">{{ .value }}</code>中设置</li></ul><p id="026f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="046b" class="ld le iq kz b gy lf lg l lh li">$ helm upgrade --install eks-dev-1-newapp-backend --namespace eks-dev-1-newapp-backend-ns --create-namespace -f projects/newapp/env/dev/values.yaml --debug --dry-run .<br/>…<br/>spec:<br/>replicas: 2<br/>strategy:<br/>type:<br/>selector:<br/>matchLabels:<br/>application: newapp<br/>template:<br/>metadata:<br/>labels:<br/>application: newapp<br/>version: 0.1.0–1.16.0<br/>environment: dev<br/>managed-by: Helm<br/>spec:<br/>containers:<br/>- name: newapp-pod<br/>image: projectname/projectname:latest<br/>env:<br/>- name: DATABASE_HOST<br/>value: dev.aurora.web.example.com<br/>ports:<br/>- containerPort: 3001<br/>…</span></pre><p id="75c4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">顺便说一下，我们在这里看到了我们的标签。</p><p id="9681" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这是我们的环境变量:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="8317" class="ld le iq kz b gy lf lg l lh li">…<br/>env:<br/>- name: DATABASE_HOST<br/>value: dev.aurora.web.example.com<br/>…</span></pre><h2 id="4e02" class="ld le iq bd lk ng nh dn lo ni nj dp ls kf nk nl lw kj nm nn ma kn no np me nq bi translated">带变量的<code class="fe mz na nb kz b">range</code>循环</h2><p id="c3a6" class="pw-post-body-paragraph ju jv iq jw b jx mi jz ka kb mj kd ke kf mw kh ki kj mx kl km kn my kp kq kr ij bi translated">另一个解决方案是使用相同的循环，但是现在使用了<code class="fe mz na nb kz b">$key</code>和<code class="fe mz na nb kz b">$value</code>变量——在这种情况下，我们不依赖于<code class="fe mz na nb kz b">values.yaml</code>文件中的变量名，而是迭代每个变量:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="aef2" class="ld le iq kz b gy lf lg l lh li">...<br/>        {{- range $key, $value := .Values.deployment.environments }}<br/>        env:<br/>        - name: {{ $key }}<br/>          value: {{ $value }}<br/>        {{- end }}<br/>...</span></pre><p id="953c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更新<code class="fe mz na nb kz b">values.yaml</code>——现在我们的<code class="fe mz na nb kz b">environments</code>被设置为一个字典，包含我们的变量，就像一个<em class="kt">键:值</em>对一样，这里添加了另一个<code class="fe mz na nb kz b">DB_USERNAME</code>对，以使示例更具说明性:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="f0b9" class="ld le iq kz b gy lf lg l lh li">...<br/>  environments:  <br/>    DATABASE_HOST: 'dev.aurora.web.example.com'<br/>    DB_USERNAME: 'dbuser'<br/>...</span></pre><p id="3988" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="f711" class="ld le iq kz b gy lf lg l lh li">$ helm upgrade --install eks-dev-1-newapp-backend --namespace eks-dev-1-newapp-backend-ns --create-namespace -f projects/newapp/env/dev/values.yaml --debug --dry-run .<br/>…<br/>spec:<br/>containers:<br/>- name: newapp-pod<br/>image: projectname/projectname:latest<br/>env:<br/>- name: DATABASE_HOST<br/>value: dev.aurora.web.example.com<br/>- name: DB_USERNAME<br/>value: dbuser<br/>ports:<br/>- containerPort: 3001<br/>…</span></pre><h2 id="12a4" class="ld le iq bd lk ng nh dn lo ni nj dp ls kf nk nl lw kj nm nn ma kn no np me nq bi translated"><code class="fe mz na nb kz b">toYaml</code></h2><p id="633f" class="pw-post-body-paragraph ju jv iq jw b jx mi jz ka kb mj kd ke kf mw kh ki kj mx kl km kn my kp kq kr ij bi translated">但是让我们回忆一下我们最初的模板:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="64db" class="ld le iq kz b gy lf lg l lh li">...<br/>        - name: DATABASE_HOST<br/>          value: {{ .Values.backendConfig.db.host }}<br/>        - name: DB_USERNAME<br/>          value: {{ .Values.backendConfig.db.user }}<br/>        - name: DB_PASSWORD<br/>          valueFrom:<br/>            secretKeyRef:<br/>              name: projectname-backend-secrets<br/>              key: backend-db-password<br/>...</span></pre><p id="509d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里我们不能使用简单的循环，所以第三种解决方案将是在<code class="fe mz na nb kz b">values.yaml</code>中描述整个<code class="fe mz na nb kz b">env</code>块，然后通过使用<code class="fe mz na nb kz b">toYaml </code>将其包含在通用模板中。</p><p id="6bf7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更新<code class="fe mz na nb kz b">values.yaml</code>并在此设置块:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="f368" class="ld le iq kz b gy lf lg l lh li">environments:<br/>  - name: DATABASE_HOST<br/>    value: 'dev.aurora.web.example.com'<br/>  - name: DB_USERNAME<br/>    value: 'dbuser'<br/>  - name: DB_PASSWORD<br/>    valueFrom:<br/>      secretKeyRef:<br/>        name: projectname-backend-secrets<br/>        key: backend-db-password</span></pre><p id="fe27" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后将其包含到<code class="fe mz na nb kz b">env</code>块的通用模板中:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="89a4" class="ld le iq kz b gy lf lg l lh li">...<br/>      containers:<br/>      - name: {{ .Values.appConfig.appName }}-pod<br/>        image: {{ .Values.deployment.image.repository }}/{{ .Values.deployment.image.name }}:{{ .Values.deployment.image.tag }}<br/>        env: <br/>        {{- toYaml .Values.deployment.environments | nindent 8 }}<br/>...</span></pre><h2 id="0627" class="ld le iq bd lk ng nh dn lo ni nj dp ls kf nk nl lw kj nm nn ma kn no np me nq bi translated">空白</h2><p id="436d" class="pw-post-body-paragraph ju jv iq jw b jx mi jz ka kb mj kd ke kf mw kh ki kj mx kl km kn my kp kq kr ij bi translated">请注意，在<code class="fe mz na nb kz b">toYaml</code>之前和<code class="fe mz na nb kz b">{{</code>之后，我们设置了破折号“<code class="fe mz na nb kz b">-</code>”:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="a4ce" class="ld le iq kz b gy lf lg l lh li">{{- toYaml .Values.deployment.environments | nindent 8 }}</span></pre><p id="353e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">它用于删除要包含的块之前的空白，同时请记住，新行也是作为空白穿过的。</p><p id="8b16" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果从这里删除"<code class="fe mz na nb kz b">-</code>"我们将在结果清单中得到一个额外的换行符:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="1f55" class="ld le iq kz b gy lf lg l lh li">…<br/>env:<br/>- name: DATABASE_HOST<br/>value: dev.aurora.web.example.com<br/>- name: DB_USERNAME<br/>…</span></pre><p id="dfc7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">参见<a class="ae ks" href="https://helm.sh/docs/chart_template_guide/control_structures/" rel="noopener ugc nofollow" target="_blank">流程控制</a>上的<em class="kt">控制空格</em>以及<a class="ae ks" href="https://kb.novaordis.com/index.php/Helm_Templates#Directives_and_Whitespace_Handling" rel="noopener ugc nofollow" target="_blank">指令和空格处理</a>页面上的更多示例。</p><p id="76af" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里我们再次使用<code class="fe mz na nb kz b">nindent</code>在来自<code class="fe mz na nb kz b">.Values.deployment.environments</code>的每一行后添加新行。</p><h2 id="8bb5" class="ld le iq bd lk ng nh dn lo ni nj dp ls kf nk nl lw kj nm nn ma kn no np me nq bi translated">舵<code class="fe mz na nb kz b">tpl</code></h2><p id="7209" class="pw-post-body-paragraph ju jv iq jw b jx mi jz ka kb mj kd ke kf mw kh ki kj mx kl km kn my kp kq kr ij bi translated">还有一个解决方案——使用<code class="fe mz na nb kz b">tpl</code>功能。</p><p id="81c8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">与前一个不同——这一次我们可以在我们的<code class="fe mz na nb kz b">values.yaml</code>中使用类似<code class="fe mz na nb kz b">{{ .Release.Name }}</code>的指令，因为来自它的代码将被视为模板本身的一部分。</p><p id="fe02" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更新<code class="fe mz na nb kz b">values.yaml</code>:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="e5e5" class="ld le iq kz b gy lf lg l lh li">environments: |-<br/>  - name: RELEASE_NAME<br/>    value: {{ .Release.Name }}<br/>  - name: DATABASE_HOST<br/>    value: 'dev.aurora.web.example.com'<br/>  - name: DB_USERNAME<br/>    value: 'dbuser'<br/>  - name: DB_PASSWORD<br/>    valueFrom:<br/>      secretKeyRef:<br/>        name: projectname-backend-secrets<br/>        key: backend-db-password</span></pre><p id="a609" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">注意“<code class="fe mz na nb kz b">|-</code>”——我们将变量块描述为一个简单的字符串，并去掉了换行符。</p><p id="804e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将其添加到部署的模板中:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="6141" class="ld le iq kz b gy lf lg l lh li">...<br/>      containers:<br/>      - name: {{ .Values.appConfig.appName }}-pod<br/>        image: {{ .Values.deployment.image.repository }}/{{ .Values.deployment.image.name }}:{{ .Values.deployment.image.tag }}<br/>        env: <br/>        {{- tpl .Values.deployment.environments . | nindent 8 }}<br/>...</span></pre><p id="e4ad" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里我们将<code class="fe mz na nb kz b">.Values.deployment.environments</code>的内容传递给<code class="fe mz na nb kz b">tml</code>函数，以将其包含到模板中。</p><p id="d2be" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="4e17" class="ld le iq kz b gy lf lg l lh li">$ helm upgrade --install eks-dev-1-newapp-backend --namespace eks-dev-1-newapp-backend-ns --create-namespace -f projects/newapp/env/dev/values.yaml --debug --dry-run .<br/>…<br/>spec:<br/>containers:<br/>- name: newapp-pod<br/>image: projectname/projectname:latest<br/>env:<br/>- name: RELEASE_NAME<br/>value: eks-dev-1-newapp-backend<br/>- name: DATABASE_HOST<br/>value: ‘dev.aurora.web.example.com’<br/>- name: DB_USERNAME<br/>value: ‘dbuser’<br/>- name: DB_PASSWORD<br/>valueFrom:<br/>secretKeyRef:<br/>name: projectname-backend-secrets<br/>key: backend-db-password<br/>ports:<br/>- containerPort: 3001<br/>…</span></pre><h2 id="b342" class="ld le iq bd lk ng nh dn lo ni nj dp ls kf nk nl lw kj nm nn ma kn no np me nq bi translated"><code class="fe mz na nb kz b">_helpers.tpl</code>上的<code class="fe mz na nb kz b">env</code>挡</h2><p id="ca3f" class="pw-post-body-paragraph ju jv iq jw b jx mi jz ka kb mj kd ke kf mw kh ki kj mx kl km kn my kp kq kr ij bi translated">我们已经使用了这个文件，但是这次让我们添加一个条件来检查我们是否在<code class="fe mz na nb kz b">values.yaml</code>中设置了一些参数。</p><h2 id="b55a" class="ld le iq bd lk ng nh dn lo ni nj dp ls kf nk nl lw kj nm nn ma kn no np me nq bi translated"><code class="fe mz na nb kz b">if</code> / <code class="fe mz na nb kz b">else</code> —流量控制</h2><p id="4666" class="pw-post-body-paragraph ju jv iq jw b jx mi jz ka kb mj kd ke kf mw kh ki kj mx kl km kn my kp kq kr ij bi translated">在<code class="fe mz na nb kz b">_helpers.yaml</code>中定义<code class="fe mz na nb kz b">env</code>块的模板:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="13ff" class="ld le iq kz b gy lf lg l lh li">{{- define "helpers.environments" -}}<br/>- name: RELEASE_NAME<br/>  value: {{ .Release.Name }}<br/>{{- if .Values.appConfig.db.host }}<br/>- name: DATABASE_HOST<br/>  value: 'dev.aurora.web.example.com'<br/>{{- end }}<br/>{{- if .Values.appConfig.db.user }}<br/>- name: DB_USERNAME<br/>  value: 'dbuser'<br/>{{- end }}<br/>{{- if .Values.appConfig.db.password }}<br/>- name: DB_PASSWORD<br/>  valueFrom: <br/>    secretKeyRef:<br/>      name: projectname-backend-secrets<br/>      key: backend-db-password<br/>{{- end }}<br/>{{- end }}</span></pre><p id="73e5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这里，我们使用每个环境变量的<code class="fe mz na nb kz b">if/else</code>条件来检查我们是否为这个变量指定了一个值，它将被找到——然后这个变量将被添加到通用模板中。</p><p id="2b03" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用它，我们将能够扩展<code class="fe mz na nb kz b">helpers.environments</code>中的环境变量列表，而不用担心某些项目<code class="fe mz na nb kz b">values.yaml</code>对它没有价值，这会破坏它的部署。</p><p id="5525" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，将它包含到模板中:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="5743" class="ld le iq kz b gy lf lg l lh li">...<br/>      containers:<br/>      - name: {{ .Values.appConfig.appName }}-pod<br/>        image: {{ .Values.deployment.image.repository }}/{{ .Values.deployment.image.name }}:{{ .Values.deployment.image.tag }}<br/>        env: {{- include "helpers.environments" . | nindent 8 }}<br/>...</span></pre><p id="7714" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="ac27" class="ld le iq kz b gy lf lg l lh li">$ helm upgrade --install eks-dev-1-newapp-backend --namespace eks-dev-1-newapp-backend-ns --create-namespace -f projects/newapp/env/dev/values.yaml --debug --dry-run .<br/>…<br/>spec:<br/>containers:<br/>- name: newapp-pod<br/>image: projectname/projectname:latest<br/>env:<br/>- name: RELEASE_NAME<br/>value: eks-dev-1-newapp-backend<br/>- name: DATABASE_HOST<br/>value: ‘dev.aurora.web.example.com’<br/>- name: DB_USERNAME<br/>value: ‘dbuser’<br/>ports:<br/>- containerPort: 3001<br/>…</span></pre><p id="036c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">注意这里没有设置<code class="fe mz na nb kz b">DB_PASSWORD</code>,因为我们默认有<code class="fe mz na nb kz b">{{ .Release.Name }}</code>,我们在<code class="fe mz na nb kz b">values.yaml</code>中有<code class="fe mz na nb kz b">.Values.appConfig.db.host</code>和<code class="fe mz na nb kz b">.Values.appConfig.db.user</code>,但是<code class="fe mz na nb kz b">.Values.appConfig.db.password</code>设置有<a class="ae ks" href="https://rtfm.co.ua/en/helm-helm-secrets-sensitive-data-encryption-with-aws-kms-and-use-it-from-jenkins/" rel="noopener ugc nofollow" target="_blank">舵机密</a>,并且存储在我们现在根本没有使用的<code class="fe mz na nb kz b">secrets.yaml</code>文件中。</p><p id="428a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以，这里使用的<code class="fe mz na nb kz b">if/else</code>条件和头盔没有创建<code class="fe mz na nb kz b">DB_PASSWORD</code>变量。</p><h2 id="2a9a" class="ld le iq bd lk ng nh dn lo ni nj dp ls kf nk nl lw kj nm nn ma kn no np me nq bi translated">来自外部文件的<code class="fe mz na nb kz b">env</code>块</h2><p id="ec84" class="pw-post-body-paragraph ju jv iq jw b jx mi jz ka kb mj kd ke kf mw kh ki kj mx kl km kn my kp kq kr ij bi translated">我能找到的最新解决方案是将项目目录下的文件中的<code class="fe mz na nb kz b">env</code>包含进来。</p><p id="b0c5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们给<code class="fe mz na nb kz b">values.yaml</code>添加一个新选项，从<code class="fe mz na nb kz b">_helpers.tpl</code>中禁用<code class="fe mz na nb kz b">include</code>，称之为<code class="fe mz na nb kz b">customEnvs</code>，再添加一个选项，指定一个带有环境变量的文件的路径- <code class="fe mz na nb kz b">customEnvsFile</code>:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="eb67" class="ld le iq kz b gy lf lg l lh li">...<br/>deployment:<br/><br/>  customEnvs: true<br/>  customEnvsFile: 'projects/newapp/templates/environments.yaml'<br/>....</span></pre><p id="1fb2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，在部署模板中添加一个条件来检查<code class="fe mz na nb kz b">customEnvs</code>是否将被设置为<em class="kt">假</em>——然后通过<code class="fe mz na nb kz b">{{ else }}</code>我们将包括来自<code class="fe mz na nb kz b">_helpers.yaml</code>的先前模板:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="0412" class="ld le iq kz b gy lf lg l lh li">...<br/>        env:<br/>        {{- if .Values.deployment.customEnvs  }}<br/>          {{- .Files.Get .Values.deployment.customEnvsFile | nindent 8 }}<br/>        {{- else }}<br/>          {{- include "helpers.environments" . | nindent 8 }}<br/>        {{ end -}}<br/>        ports:<br/>...</span></pre><p id="ebb0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这将会工作，但只是因为我已经从<code class="fe mz na nb kz b">projects/newapp/templates/environments.yaml</code>中移除了<code class="fe mz na nb kz b">.Release.Name</code>:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="de45" class="ld le iq kz b gy lf lg l lh li">- name: DATABASE_HOST<br/>  value: 'dev.aurora.web.example.com'<br/>- name: DB_USERNAME<br/>  value: 'dbuser'<br/>- name: DB_PASSWORD<br/>  valueFrom:<br/>    secretKeyRef:<br/>      name: projectname-backend-secrets<br/>      key: backend-db-password</span></pre><p id="b9d6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这可以用已经熟悉的<code class="fe mz na nb kz b">tpl</code>功能解决。</p><p id="8360" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">回到<code class="fe mz na nb kz b">projects/newapp/templates/environments.yaml</code> -将<code class="fe mz na nb kz b">.Release.Name</code>调回来:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="54d9" class="ld le iq kz b gy lf lg l lh li">- name: RELEASE_NAME<br/>  value: {{ .Release.Name }}<br/>- name: DATABASE_HOST<br/>  value: 'dev.aurora.web.example.com'<br/>...</span></pre><p id="9111" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在部署模板中，添加<code class="fe mz na nb kz b">tpl</code>和<code class="fe mz na nb kz b">.Files.Get</code>，并将其参数括在括号中:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="0ebf" class="ld le iq kz b gy lf lg l lh li">...<br/>        {{- if .Values.deployment.customEnvs  }}<br/>          {{- tpl ( .Files.Get .Values.deployment.customEnvsFile ) . | nindent 8 }}<br/>        {{- else }} <br/>          {{- include "helpers.environments" . | nindent 8 }}<br/>        {{ end -}}<br/>...</span></pre><p id="d7bd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="bb11" class="ld le iq kz b gy lf lg l lh li">$ helm upgrade --install eks-dev-1-newapp-backend --namespace eks-dev-1-newapp-backend-ns --create-namespace -f projects/newapp/env/dev/values.yaml --debug --dry-run .<br/>…<br/>spec:<br/>containers:<br/>- name: newapp-pod\<br/>image: projectname/projectname:latest<br/>env:<br/>- name: RELEASE_NAME<br/>value: eks-dev-1-newapp-backend<br/>- name: DATABASE_HOST<br/>value: ‘dev.aurora.web.example.com’<br/>- name: DB_USERNAME<br/>value: ‘dbuser’<br/>- name: DB_PASSWORD<br/>valueFrom:<br/>secretKeyRef:<br/>name: projectname-backend-secrets<br/>key: backend-db-password<br/>ports:<br/>- containerPort: 3001<br/>…</span></pre><p id="5477" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于<code class="fe mz na nb kz b">volumes</code>，<code class="fe mz na nb kz b">volumesMounts</code>我们可以使用相同的方法。</p><p id="11a1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">总的来说，带有<code class="fe mz na nb kz b">_helpers.yaml</code>的解决方案看起来是可用的——将在新项目中测试它，看看它进展如何。</p><p id="e3c2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">整个部署模板现在:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="c596" class="ld le iq kz b gy lf lg l lh li">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: {{ .Values.appConfig.appName }}-deployment<br/>  labels: {{- include "helpers.labels" . | nindent 4 }}<br/>  annotations:<br/>    {{- if .Values.deployment.deploymentAnnotations }}<br/>      {{- toYaml .Values.deployment.deploymentAnnotations | nindent 6 }}<br/>    {{- end }}<br/>    reloader.stakater.com/auto: "true"<br/>spec:<br/>  replicas: {{ .Values.deployment.replicaCount }}<br/>  strategy:<br/>    type: {{ .Values.deployment.delpoyStrategy }}<br/>  selector:<br/>    matchLabels:<br/>      {{- include "helpers.selectorLabels" . | nindent 6 }}<br/>  template:<br/>    metadata:<br/>      labels: {{- include "helpers.labels" . | nindent 8 }}<br/>    spec:<br/>      containers:<br/>      - name: {{ .Values.appConfig.appName }}-pod<br/>        image: {{ .Values.deployment.image.repository }}/{{ .Values.deployment.image.name }}:{{ .Values.deployment.image.tag }}<br/>        env: <br/>        {{- if .Values.deployment.customEnvs  }}<br/>          {{- tpl ( .Files.Get .Values.deployment.customEnvsFile ) . | nindent 8 }}<br/>        {{- else }}<br/>          {{- include "helpers.environments" . | nindent 8 }}<br/>        {{ end -}}<br/>        ports:<br/>          - containerPort: {{ .Values.appConfig.port }}<br/>        {{- with .Values.deployment.livenessProbe }}<br/>        livenessProbe:<br/>          httpGet:<br/>            path: {{ .path }}<br/>            port: {{ .port }}<br/>          initialDelaySeconds: {{ .initDelay }}<br/>        {{- end }}<br/>        {{- with .Values.deployment.readinessProbe }}<br/>        readinessProbe:<br/>          httpGet:<br/>            path: {{ .path }}<br/>            port: {{ .port }}<br/>          initialDelaySeconds: {{ .initDelay }}<br/>        {{- end }}<br/>        resources:<br/>          requests:<br/>            cpu: {{ .Values.deployment.resources.requests.cpu | quote }}<br/>      imagePullSecrets:<br/>        - name: bttrm-docker-secret</span></pre><h1 id="956e" class="lj le iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">从图表中排除模板</h1><p id="17de" class="pw-post-body-paragraph ju jv iq jw b jx mi jz ka kb mj kd ke kf mw kh ki kj mx kl km kn my kp kq kr ij bi translated">最后一个想法是——我们如何从图表中排除一个模板文件。</p><p id="b989" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，让我们检查一下<code class="fe mz na nb kz b">cronjobs.yaml</code>文件:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="7023" class="ld le iq kz b gy lf lg l lh li">apiVersion: batch/v1beta1<br/>kind: CronJob<br/>metadata:<br/>  name: {{ .Values.appConfig.appName }}-cron<br/>  labels: {{- include "helpers.labels" . | nindent 4 }}<br/>spec: <br/>  schedule: {{ .Values.cronjobs.schedule | quote }}<br/>  startingDeadlineSeconds:  {{ .Values.cronjobs.startingDeadline }}<br/>  concurrencyPolicy: {{ .Values.cronjobs.concurrencyPolicy }}<br/>  jobTemplate:<br/>    spec:<br/>      template:<br/>        metadata:<br/>          labels: {{- include "helpers.labels" . | nindent 12 }}<br/>        spec:<br/>          containers:<br/>            - name: {{ .Values.appConfig.appName }}-cron<br/>              image: {{ .Values.deployment.image.repository }}/{{ .Values.deployment.image.name }}:{{ .Values.deployment.image.tag }}<br/>              env:<br/>              {{- if .Values.deployment.customEnvs  }}<br/>                {{- tpl ( .Files.Get .Values.deployment.customEnvsFile ) . | nindent 14 }}<br/>              {{- else }}<br/>                {{- include "helpers.environments" . | nindent 14 }}<br/>              {{ end -}}<br/>             command: ["npm"]<br/>              args: ["run", "cron:app"]<br/>          restartPolicy: Never<br/>          imagePullSecrets:<br/>              - name: bttrm-docker-secret</span></pre><p id="cb79" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">顺便说一下，这是我们的标签和从<code class="fe mz na nb kz b">_helpers.yaml</code>开始使用的<code class="fe mz na nb kz b">env</code>模块。</p><p id="5c37" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但并不是每个项目都有cronjobs。</p><p id="1385" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以，我们可以给<code class="fe mz na nb kz b">values.yaml</code> - <code class="fe mz na nb kz b">cronjobs.enabled</code>增加一个新的参数:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="6cf4" class="ld le iq kz b gy lf lg l lh li">...<br/>################<br/>### Cronjobs ###<br/>################ <br/>             <br/>cronjobs:     <br/>          <br/>  enabled: false<br/>  schedule: '*/15 * * * *'<br/>  startingDeadline: 10<br/>  concurrencyPolicy: 'Forbid'<br/>...</span></pre><p id="bdac" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后将整个模板的内容封装在一个<code class="fe mz na nb kz b">if/else</code>条件检查中:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="9f59" class="ld le iq kz b gy lf lg l lh li">{{- if .Values.cronjobs.enabled }}<br/>apiVersion: batch/v1beta1<br/>kind: CronJob<br/>metadata:<br/>  name: {{ .Values.appConfig.appName }}-cron<br/>  labels: {{- include "helpers.labels" . | nindent 4 }}<br/>...<br/>          imagePullSecrets:<br/>              - name: bttrm-docker-secret<br/>{{- end }}</span></pre><p id="2b2d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="0dc5" class="ld le iq kz b gy lf lg l lh li">$ helm upgrade --install eks-dev-1-newapp-backend --namespace eks-dev-1-newapp-backend-ns --create-namespace -f projects/newapp/env/dev/values.yaml --debug --dry-run .<br/>…<br/> — -<br/>Source: project-backend/templates/deployment.yaml<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>name: newapp-deployment<br/>…<br/>imagePullSecrets:<br/>- name: bttrm-docker-secret</span></pre><p id="da84" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">未添加任何cronjobs。</p><p id="26be" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加<code class="fe mz na nb kz b">--set cronjobs.enabled=true</code> -它们将被添加到发布中:</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="aa2b" class="ld le iq kz b gy lf lg l lh li">$ helm upgrade --install eks-dev-1-newapp-backend --namespace eks-dev-1-newapp-backend-ns --create-namespace -f projects/newapp/env/dev/values.yaml --debug --dry-run . — set cronjobs.enabled=true<br/>…<br/>imagePullSecrets:<br/>- name: bttrm-docker-secret<br/> — -<br/>Source: project-backend/templates/cronjobs.yaml<br/>apiVersion: batch/v1beta1<br/>kind: CronJob<br/>metadata:<br/>name: newapp-cron<br/>…<br/>imagePullSecrets:</span></pre><p id="2523" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">-名称:bttrm-docker-secret</p><p id="851a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="kt">“那都是乡亲们！</em>”</p><h1 id="887f" class="lj le iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">有用的链接</h1><ul class=""><li id="cdce" class="mg mh iq jw b jx mi kb mj kf mk kj ml kn mm kr mn mo mp mq bi translated"><a class="ae ks" href="https://hackernoon.com/the-art-of-the-helm-chart-patterns-from-the-official-kubernetes-charts-8a7cafa86d12" rel="noopener ugc nofollow" target="_blank">掌舵的艺术图表:来自官方Kubernetes图表的模式</a></li><li id="f2b1" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://www.arthurkoziel.com/writing-reusable-helm-charts/" rel="noopener ugc nofollow" target="_blank">编写可重复使用的舵图</a></li><li id="266d" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://austindewey.com/2020/08/09/how-to-reduce-helm-chart-boilerplate-with-named-templates/" rel="noopener ugc nofollow" target="_blank">如何用命名模板减少舵图样板</a></li><li id="d597" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://banzaicloud.com/blog/creating-helm-charts/" rel="noopener ugc nofollow" target="_blank">从基础到高级</a></li><li id="0ffc" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated">для·库贝涅斯·赫尔姆:чарта·шаблонизация</li><li id="78f7" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://lzone.de/cheat-sheet/Helm+Templates" rel="noopener ugc nofollow" target="_blank">头盔模板备忘单</a></li><li id="783e" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://cloudacademy.com/course/introduction-to-helm-1034/helm-templates/" rel="noopener ugc nofollow" target="_blank">头盔介绍——模板</a></li><li id="c6ae" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://kb.novaordis.com/index.php/Helm_Templates#Directives_and_Whitespace_Handling" rel="noopener ugc nofollow" target="_blank">头盔模板</a></li><li id="dcdd" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://austindewey.com/2018/12/28/helm-tricks-input-validation-with-required-and-fail/" rel="noopener ugc nofollow" target="_blank">掌舵技巧:带有“必需”和“失败”的输入验证</a></li><li id="dfd9" class="mg mh iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated"><a class="ae ks" href="https://www.alibabacloud.com/blog/helm-chart-and-template-basics---part-1_595489?spm=a2c65.11461447.0.0.51291b6aFbpqk1" rel="noopener ugc nofollow" target="_blank">舵图和模板基础—第1部分</a></li></ul></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><p id="287a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="kt">最初发布于</em> <a class="ae ks" href="https://rtfm.co.ua/en/helm-reusable-chart-named-templates-and-a-generic-chart-for-multiple-applications/" rel="noopener ugc nofollow" target="_blank"> <em class="kt"> RTFM: Linux，devo PSисистемноеадммиитиииииованниое</em></a>T18。</p></div></div>    
</body>
</html>