<html>
<head>
<title>Nginx Docker and Environment Variables</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Nginx Docker和环境变量</h1>
<blockquote>原文：<a href="https://itnext.io/nginx-docker-and-environment-variables-9753dfb5d41?source=collection_archive---------0-----------------------#2020-08-24">https://itnext.io/nginx-docker-and-environment-variables-9753dfb5d41?source=collection_archive---------0-----------------------#2020-08-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9368" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用perl模块读取环境变量</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/191ca4a5e5a789257da44795d45a10bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rw5UtkN4fSKRnGll6pNqoA.png"/></div></div></figure><p id="b95c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您在google上搜索Nginx docker和环境变量，您将最终得到<a class="ae lq" href="https://www.gnu.org/software/gettext/manual/html_node/envsubst-Invocation.html#:~:text=The%20envsubst%20program%20substitutes%20the%20values%20of%20environment%20variables.&amp;text=Output%20the%20variables%20occurring%20in%20shell%2Dformat%20.&amp;text=In%20normal%20operation%20mode%2C%20standard,replaced%20with%20the%20corresponding%20values." rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu"> envsubst </strong> </a>解决方法来将环境变量传递给docker容器。尽管这种变通方法可行，但它并不那么灵活，也不容易操作。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h2 id="378c" class="ly lz it bd ma mb mc dn md me mf dp mg ld mh mi mj lh mk ml mm ll mn mo mp mq bi translated">docker图像:</h2><p id="6994" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld mt lf lg lh mu lj lk ll mv ln lo lp im bi translated">我喜欢<strong class="kw iu">基于阿尔卑斯山的</strong>图像，因为它们重量轻且安全。你可能想知道为什么我使用支持<strong class="kw iu"> Perl </strong>的镜像，答案很简单:为了能够读取Nginx中的环境变量，需要运行在<strong class="kw iu"> Perl </strong>上的<code class="fe mw mx my mz b">nginx-mod-http-perl</code>模块！</p><pre class="kj kk kl km gt na mz nb nc aw nd bi"><span id="3771" class="ly lz it mz b gy ne nf l ng nh">FROM nginx:1.18.0-alpine-perl</span><span id="ecb3" class="ly lz it mz b gy ni nf l ng nh">RUN apk add --no-cache nginx-mod-http-perl</span><span id="43cc" class="ly lz it mz b gy ni nf l ng nh">COPY nginx.conf /etc/nginx/nginx.conf<br/>COPY default.conf /etc/nginx/conf.d/default.conf</span><span id="9684" class="ly lz it mz b gy ni nf l ng nh">EXPOSE 80/tcp<br/>EXPOSE 443/tcp</span><span id="da97" class="ly lz it mz b gy ni nf l ng nh">CMD ["/bin/sh", "-c", "exec nginx -g 'daemon off;';"]<br/>WORKDIR /usr/share/nginx/html</span></pre><h2 id="0b8d" class="ly lz it bd ma mb mc dn md me mf dp mg ld mh mi mj lh mk ml mm ll mn mo mp mq bi translated">Nginx配置</h2><p id="5684" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld mt lf lg lh mu lj lk ll mv ln lo lp im bi translated">Nginx主配置文件是<code class="fe mw mx my mz b">nginx.conf</code>，位于<code class="fe mw mx my mz b">/etc/nginx/nginx.conf</code>。我们使用这个文件来加载Nginx模块和配置环境变量。</p><p id="3b7c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">要加载该模块，只需使用以下代码行:</p><pre class="kj kk kl km gt na mz nb nc aw nd bi"><span id="a1f2" class="ly lz it mz b gy ne nf l ng nh">load_module "modules/ngx_http_perl_module.so";</span></pre><p id="cf8e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为您需要的每个环境变量定义一个变量:</p><pre class="kj kk kl km gt na mz nb nc aw nd bi"><span id="0e09" class="ly lz it mz b gy ne nf l ng nh">env ENV;<br/>env BACKEND;<br/>env FRONTEND;<br/>env FOO_BAR;</span></pre><p id="dcec" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为您定义的每个变量定义一个perl-set:</p><pre class="kj kk kl km gt na mz nb nc aw nd bi"><span id="f1ea" class="ly lz it mz b gy ne nf l ng nh">perl_set $ENV 'sub { return $ENV{"ENV"}; }';<br/>perl_set $BACKEND 'sub { return $ENV{"BACKEND"}; }';<br/>perl_set $FRONTEND 'sub { return $ENV{"FRONTEND"}; }';</span></pre><p id="2347" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你想了解更多关于<code class="fe mw mx my mz b">perl_set</code> r <a class="ae lq" href="http://nginx.org/en/docs/http/ngx_http_perl_module.html#perl_set" rel="noopener ugc nofollow" target="_blank">的信息，请阅读Nginx </a>的这篇文档。变量可以在任何其他。Nginx中的conf文件。要使用该变量，只需使用<code class="fe mw mx my mz b">${VARIABLE_NAME}</code>即可。</p><p id="2b4e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">要将变量传递给docker容器，请使用<code class="fe mw mx my mz b">-e</code>参数来传递它们。</p><pre class="kj kk kl km gt na mz nb nc aw nd bi"><span id="a3a1" class="ly lz it mz b gy ne nf l ng nh">docker run --rm -it --name foo -p 8080:80 -e "ENV=PROD" -e "FRONTEND=<a class="ae lq" href="https://crow-asfalt-impuls-tooling-app-test.azurewebsites.net" rel="noopener ugc nofollow" target="_blank">h</a>ttp://example.com" -e "BACKEND=http://api.example.com" foo</span></pre></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><p id="676a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">配置文件的完整工作示例:</p><h2 id="e128" class="ly lz it bd ma mb mc dn md me mf dp mg ld mh mi mj lh mk ml mm ll mn mo mp mq bi translated">nginx.conf</h2><pre class="kj kk kl km gt na mz nb nc aw nd bi"><span id="d5aa" class="ly lz it mz b gy ne nf l ng nh">worker_processes  1;</span><span id="7301" class="ly lz it mz b gy ni nf l ng nh">error_log /var/log/nginx/error.log warn;<br/>pid /var/run/nginx.pid;</span><span id="0385" class="ly lz it mz b gy ni nf l ng nh">load_module "modules/ngx_http_perl_module.so";</span><span id="23d0" class="ly lz it mz b gy ni nf l ng nh">env ENV;<br/>env BACKEND;<br/>env FRONTEND;</span><span id="28f6" class="ly lz it mz b gy ni nf l ng nh">events {<br/>    worker_connections 1024;<br/>}</span><span id="3023" class="ly lz it mz b gy ni nf l ng nh">http {<br/>    default_type application/octet-stream;</span><span id="4fd7" class="ly lz it mz b gy ni nf l ng nh">log_format main  '$remote_addr - $remote_user [$time_local] "$request" '<br/>              '$status $body_bytes_sent "$http_referer" '<br/>              '"$http_user_agent" "$http_x_forwarded_for"';<br/>    access_log /var/log/nginx/access.log  main;<br/>    <br/>    sendfile on;<br/>    keepalive_timeout 65;</span><span id="27c7" class="ly lz it mz b gy ni nf l ng nh">perl_set $ENV 'sub { return $ENV{"ENV"}; }';<br/>    perl_set $BACKEND 'sub { return $ENV{"BACKEND"}; }';<br/>    perl_set $FRONTEND 'sub { return $ENV{"FRONTEND"}; }';</span><span id="c606" class="ly lz it mz b gy ni nf l ng nh">include /etc/nginx/conf.d/*.conf;<br/>}</span></pre><h2 id="e072" class="ly lz it bd ma mb mc dn md me mf dp mg ld mh mi mj lh mk ml mm ll mn mo mp mq bi translated">默认. conf</h2><pre class="kj kk kl km gt na mz nb nc aw nd bi"><span id="cbec" class="ly lz it mz b gy ne nf l ng nh">server {    <br/>    listen       80;<br/>    server_name  localhost;</span><span id="eecc" class="ly lz it mz b gy ni nf l ng nh">resolver 1.1.1.1;</span><span id="26b5" class="ly lz it mz b gy ni nf l ng nh">location / {<br/>        root   /usr/share/nginx/html;<br/>        index  index.html index.htm;<br/>        proxy_pass ${FRONTEND}$request_uri;<br/>    }</span><span id="7eb3" class="ly lz it mz b gy ni nf l ng nh">location /api {        <br/>        proxy_pass ${BACKEND}$request_uri; <br/>        proxy_set_header X-Real-IP         $remote_addr;<br/>        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;<br/>        proxy_set_header X-Forwarded-Proto $scheme;<br/>        proxy_set_header X-Forwarded-Host  $host;<br/>        proxy_set_header X-Forwarded-Port  $server_port;<br/>        proxy_ssl_session_reuse off;<br/>        proxy_cache_bypass $http_upgrade;<br/>        proxy_redirect off;<br/>    }</span></pre><p id="8872" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意:在上面的例子中，我使用<code class="fe mw mx my mz b">resolver: 1.1.1.1</code>作为DNS解析器，因为我在Nginx中为反向代理设置传递动态变量。</p></div></div>    
</body>
</html>