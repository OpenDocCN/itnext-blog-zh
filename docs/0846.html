<html>
<head>
<title>Using Prometheus in Azure Kubernetes Service (AKS)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Azure Kubernetes服务中使用Prometheus(AKS)</h1>
<blockquote>原文：<a href="https://itnext.io/using-prometheus-in-azure-kubernetes-service-aks-ae22cada8dd9?source=collection_archive---------0-----------------------#2018-06-08">https://itnext.io/using-prometheus-in-azure-kubernetes-service-aks-ae22cada8dd9?source=collection_archive---------0-----------------------#2018-06-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/080d16e33b58699ecd0ad03130700cfd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-hzdcH9dZLcUiCaH9iUA5Q.png"/></div></div></figure><div class=""/><div class=""><h2 id="30d9" class="pw-subtitle-paragraph jy ja jb bd b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp dk translated">了解Prometheus运算符、自定义资源定义和kube-prometheus</h2></div><p id="2787" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">上周五在T4举行的创新日期间，我深入了解了普罗米修斯，以及如何利用它从Kubernetes上运行的应用程序中收集遥测数据</p><p id="1033" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">我用<a class="ae lm" href="https://docs.helm.sh" rel="noopener ugc nofollow" target="_blank">头盔</a>安装了普罗米修斯操作者和kube-prometheus。这是让普罗米修斯恢复运行的简单快捷的方法。但后来我对如何使用我的新普罗米修斯装置有点困惑。当我运行<code class="fe ln lo lp lq b">helm install</code>在我的集群中安装Prometheus时，到底发生了什么？部署了哪些资源，我如何使用它们？因此，我开始拆开头盔的模板，试验它所部署的资源，试图了解普罗米修斯操作员是如何工作的，以及安装kube-prometheus可以获得哪些额外的资源。以下是我学到的。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="ff72" class="ly lz jb bd ma mb mc md me mf mg mh mi kh mj ki mk kk ml kl mm kn mn ko mo mp bi translated">运算符和自定义资源定义</h1><p id="e9ea" class="pw-post-body-paragraph kq kr jb ks b kt mq kc kv kw mr kf ky kz ms lb lc ld mt lf lg lh mu lj lk ll ij bi translated">当你安装带头盔的普罗米修斯操作器时，你会得到一个<strong class="ks jc">操作器</strong>和一组<strong class="ks jc">自定义资源定义</strong>。首先让我们看看什么是运算符:</p><blockquote class="mv mw mx"><p id="d83b" class="kq kr my ks b kt ku kc kv kw kx kf ky mz la lb lc na le lf lg nb li lj lk ll ij bi translated">操作符是一种打包、部署和管理Kubernetes应用程序的方法。Kubernetes应用程序是一种既部署在Kubernetes上，又使用Kubernetes APIs和kubectl工具进行管理的应用程序。</p><p id="ed97" class="kq kr my ks b kt ku kc kv kw kx kf ky mz la lb lc na le lf lg nb li lj lk ll ij bi translated">为了能够充分利用Kubernetes，您需要一组内聚的API来扩展，以便服务和管理运行在Kubernetes上的应用程序。您可以将Operators视为在Kubernetes上管理这类应用程序的运行时。</p></blockquote><p id="bd13" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">在Kubernetes 1.7 <a class="ae lm" href="https://coreos.com/" rel="noopener ugc nofollow" target="_blank"> CoreOS </a>中还增加了<a class="ae lm" href="https://kubernetes.io/docs/tasks/access-kubernetes-api/extend-api-custom-resource-definitions/" rel="noopener ugc nofollow" target="_blank">自定义资源定义(CRD的)</a>。有了CRD的，Kubernetes API可以用额外的资源类型来扩展，以简化运行Kubernetes应用程序所需的配置。</p><h2 id="3083" class="nc lz jb bd ma nd ne dn me nf ng dp mi kz nh ni mk ld nj nk mm lh nl nm mo nn bi translated">普罗米修斯算子</h2><p id="3c4f" class="pw-post-body-paragraph kq kr jb ks b kt mq kc kv kw mr kf ky kz ms lb lc ld mt lf lg lh mu lj lk ll ij bi translated">Prometheus操作员使用3个CRD来大大简化在Kubernetes集群中运行Prometheus所需的配置。这三种类型是:</p><ul class=""><li id="f1b8" class="no np jb ks b kt ku kw kx kz nq ld nr lh ns ll nt nu nv nw bi translated"><code class="fe ln lo lp lq b"><strong class="ks jc">Prometheus</strong></code>，定义所需的普罗米修斯部署。操作员始终确保与资源定义匹配的部署正在运行。</li><li id="92d0" class="no np jb ks b kt nx kw ny kz nz ld oa lh ob ll nt nu nv nw bi translated"><code class="fe ln lo lp lq b"><strong class="ks jc">ServiceMonitor</strong></code>，它声明性地指定了应该如何监控服务组。操作员根据定义自动生成普罗米修斯刮削配置。</li><li id="9e0b" class="no np jb ks b kt nx kw ny kz nz ld oa lh ob ll nt nu nv nw bi translated"><code class="fe ln lo lp lq b"><strong class="ks jc">Alertmanager</strong></code>，定义所需的Alertmanager部署。操作员始终确保与资源定义匹配的部署正在运行。</li></ul><figure class="od oe of og gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oc"><img src="../Images/4a1328da9ed4fc571ee2fb3cd86b0d79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wQ3otqdDZjTxVavX.png"/></div></div><figcaption class="oh oi gj gh gi oj ok bd b be z dk translated">运营商工作流程和关系(<a class="ae lm" href="https://coreos.com/blog/the-prometheus-operator.html" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><p id="e8eb" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">当您部署一个<strong class="ks jc"> prometheus </strong>时，<strong class="ks jc"> prometheus操作员</strong>将确保在您的集群中有一个<strong class="ks jc"> prometheus服务器</strong>的新实例可用。一个<strong class="ks jc"> prometheus </strong>资源定义有一个<strong class="ks jc"> serviceMonitorSelector </strong>，它指定了<strong class="ks jc"> prometheus服务器</strong>的这个实例应该使用哪个<strong class="ks jc"> servicemonitor </strong>资源。一个<strong class="ks jc"> servicemonitor </strong>指定了<strong class="ks jc"> prometheus服务器</strong>应该如何监控一个服务或一组服务。<strong class="ks jc">普罗米修斯操作员</strong>将生成并应用<strong class="ks jc">普罗米修斯服务器</strong>所需的配置。</p><p id="6d45" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">当您在您的集群中安装<strong class="ks jc"> kubernetes操作符</strong>时，您将获得该操作符和上面提到的CRD操作符，但默认情况下，您不会获得任何<strong class="ks jc"> prometheus服务器</strong>或任何<strong class="ks jc">服务监视器</strong>实例。然而，要开始监视，您所要做的就是使用正确的serviceMonitorSelector部署prometheus资源，并部署servicemonitor资源。</p><p id="cc72" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">然而，有一个名为<a class="ae lm" href="https://github.com/coreos/prometheus-operator/tree/master/contrib/kube-prometheus" rel="noopener ugc nofollow" target="_blank">kube-prometheus</a><strong class="ks jc"/>的社区项目，它现在是github上<a class="ae lm" href="https://github.com/coreos/prometheus-operator" rel="noopener ugc nofollow" target="_blank"> prometheus操作员存储库</a>的一部分，它将为您提供一个Prometheus服务器，该服务器被配置为监控您的Kubernetes集群，包括一组<a class="ae lm" href="https://grafana.com/" rel="noopener ugc nofollow" target="_blank"> Grafana </a>仪表盘。</p><p id="4bf0" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">所以让我们继续在一个<a class="ae lm" href="https://docs.microsoft.com/en-us/azure/aks/" rel="noopener ugc nofollow" target="_blank"> Azure Kubernetes服务(AKS) </a>集群中安装<strong class="ks jc"> prometheus操作器</strong>和<strong class="ks jc"> kube-prometheus </strong>。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="6c71" class="ly lz jb bd ma mb mc md me mf mg mh mi kh mj ki mk kk ml kl mm kn mn ko mo mp bi translated">连接和设置舵</h1><p id="79a4" class="pw-post-body-paragraph kq kr jb ks b kt mq kc kv kw mr kf ky kz ms lb lc ld mt lf lg lh mu lj lk ll ij bi translated">通过运行以下命令连接到您的群集:</p><pre class="od oe of og gt ol lq om on aw oo bi"><span id="1a12" class="nc lz jb lq b gy op oq l or os">az login</span></pre><p id="7dfc" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">通过运行以下命令列出您的订阅:</p><pre class="od oe of og gt ol lq om on aw oo bi"><span id="04dc" class="nc lz jb lq b gy op oq l or os">az account list</span></pre><p id="1352" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">通过运行以下命令选择您的AKS群集所在的订阅:</p><pre class="od oe of og gt ol lq om on aw oo bi"><span id="2fc4" class="nc lz jb lq b gy op oq l or os">az account set --subscription &lt;subscription-id&gt;</span></pre><p id="d6a4" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">通过运行以下命令获取<code class="fe ln lo lp lq b">kubectl</code>连接到AKS集群所需的凭据:</p><pre class="od oe of og gt ol lq om on aw oo bi"><span id="b83c" class="nc lz jb lq b gy op oq l or os">az aks get-credentials --name &lt;aks-cluster-name&gt; --resource-group &lt;aks-cluster-resource-group&gt;</span></pre><p id="e0c2" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">如果本地没有安装<a class="ae lm" href="https://docs.helm.sh" rel="noopener ugc nofollow" target="_blank"> HELM </a>，从<a class="ae lm" href="https://github.com/kubernetes/helm" rel="noopener ugc nofollow" target="_blank">这个github库</a>下载合适的二进制文件。</p><p id="85d4" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">如果您的集群运行中尚未安装<a class="ae lm" href="https://docs.helm.sh" rel="noopener ugc nofollow" target="_blank">舵</a>:</p><pre class="od oe of og gt ol lq om on aw oo bi"><span id="6833" class="nc lz jb lq b gy op oq l or os">helm init</span></pre><p id="40ee" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">接下来将CoreOS repo添加到HELM:</p><pre class="od oe of og gt ol lq om on aw oo bi"><span id="b5ed" class="nc lz jb lq b gy op oq l or os">helm repo add coreos <a class="ae lm" href="https://s3-eu-west-1.amazonaws.com/coreos-charts/stable/" rel="noopener ugc nofollow" target="_blank">https://s3-eu-west-1.amazonaws.com/coreos-charts/stable/</a></span></pre><h1 id="da17" class="ly lz jb bd ma mb ot md me mf ou mh mi kh ov ki mk kk ow kl mm kn ox ko mo mp bi translated">安装Prometheus操作员和kube-prometheus</h1><p id="b651" class="pw-post-body-paragraph kq kr jb ks b kt mq kc kv kw mr kf ky kz ms lb lc ld mt lf lg lh mu lj lk ll ij bi translated">AKS支持<a class="ae lm" href="https://azure.microsoft.com/en-us/blog/azure-kubernetes-service-aks-ga-new-regions-new-features-new-productivity/" rel="noopener ugc nofollow" target="_blank">是最近添加的</a>，但是如果您仍然有一个集群没有RBAC支持，您可以告诉HELM安装这些图表而不使用RBAC:</p><pre class="od oe of og gt ol lq om on aw oo bi"><span id="5c22" class="nc lz jb lq b gy op oq l or os">helm install coreos/prometheus-operator --name prometheus-operator --namespace monitoring --set rbacEnable=false</span><span id="ee1a" class="nc lz jb lq b gy oy oq l or os">helm install coreos/kube-prometheus --name kube-prometheus --set global.rbacEnable=false --namespace monitoring<!-- --> </span></pre><p id="bd9f" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">或者和RBAC一起:</p><pre class="od oe of og gt ol lq om on aw oo bi"><span id="ffba" class="nc lz jb lq b gy op oq l or os">helm install coreos/prometheus-operator --name prometheus-operator --namespace monitoring</span><span id="d42e" class="nc lz jb lq b gy oy oq l or os">helm install coreos/kube-prometheus --name kube-prometheus --namespace monitoring</span></pre><p id="5c5d" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">现在，您已经在集群中安装了prometheus操作员和kube-prometheus。让我们来看看我们得到了什么:</p><h2 id="e665" class="nc lz jb bd ma nd ne dn me nf ng dp mi kz nh ni mk ld nj nk mm lh nl nm mo nn bi translated">普罗米修斯资源公司</h2><pre class="od oe of og gt ol lq om on aw oo bi"><span id="43d3" class="nc lz jb lq b gy op oq l or os">kubectl get prometheus --all-namespaces -l release=kube-prometheus</span><span id="314d" class="nc lz jb lq b gy oy oq l or os">NAMESPACE    NAME              AGE<br/>monitoring   kube-prometheus   1h</span></pre><h2 id="1741" class="nc lz jb bd ma nd ne dn me nf ng dp mi kz nh ni mk ld nj nk mm lh nl nm mo nn bi translated">服务监视器资源</h2><pre class="od oe of og gt ol lq om on aw oo bi"><span id="fb05" class="nc lz jb lq b gy op oq l or os">kubectl get servicemonitor --all-namespaces -l release=kube-prometheus</span><span id="a533" class="nc lz jb lq b gy oy oq l or os">NAMESPACE    NAME                                               AGE<br/>monitoring   kube-prometheus                                    1h<br/>monitoring   kube-prometheus-alertmanager                       1h<br/>monitoring   kube-prometheus-exporter-kube-controller-manager   1h<br/>monitoring   kube-prometheus-exporter-kube-dns                  1h<br/>monitoring   kube-prometheus-exporter-kube-etcd                 1h<br/>monitoring   kube-prometheus-exporter-kube-scheduler            1h<br/>monitoring   kube-prometheus-exporter-kube-state                1h<br/>monitoring   kube-prometheus-exporter-kubelets                  1h<br/>monitoring   kube-prometheus-exporter-kubernetes                1h<br/>monitoring   kube-prometheus-exporter-node                      1h<br/>monitoring   kube-prometheus-grafana                            1h<br/>monitoring   prometheus-operator                                1h</span></pre><h2 id="2c8f" class="nc lz jb bd ma nd ne dn me nf ng dp mi kz nh ni mk ld nj nk mm lh nl nm mo nn bi translated">服务资源</h2><pre class="od oe of og gt ol lq om on aw oo bi"><span id="c5c7" class="nc lz jb lq b gy op oq l or os">kubectl get service --all-namespaces -l release=kube-prometheus -o=custom-columns=NAMESPACE:.metadata.namespace,NAME:.metadata.name</span><span id="6ccf" class="nc lz jb lq b gy oy oq l or os">NAMESPACE     NAME<br/>kube-system   kube-prometheus-exporter-kube-controller-manager<br/>kube-system   kube-prometheus-exporter-kube-dns<br/>kube-system   kube-prometheus-exporter-kube-etcd<br/>kube-system   kube-prometheus-exporter-kube-scheduler<br/>monitoring    kube-prometheus<br/>monitoring    kube-prometheus-alertmanager<br/>monitoring    kube-prometheus-exporter-kube-state<br/>monitoring    kube-prometheus-exporter-node<br/>monitoring    kube-prometheus-grafana</span></pre><p id="224d" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">通过安装kube-prometheus，您得到了一个prometheus服务器(一个<strong class="ks jc"> prometheus </strong>资源)和一组<strong class="ks jc">服务监视器</strong>资源，允许您监视您的集群本身。安装kube-prometheus还为您提供了一个<a class="ae lm" href="https://grafana.com/" rel="noopener ugc nofollow" target="_blank"> Grafana </a>实例，该实例连接到prometheus服务器并具有一组预配置的仪表板。</p><p id="7fec" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">你还有一堆叫做<code class="fe ln lo lp lq b">kube-prometheus-exporter-*</code>的<strong class="ks jc">服务</strong>和相应的<strong class="ks jc">服务监视器</strong>。这些服务公开了<strong class="ks jc"> pods </strong>，这些pods使Prometheus可以使用来自您的节点和其他kubernetes组件的指标。例如，让我们看看<code class="fe ln lo lp lq b">kube-prometheus-exporter-node</code></p><p id="6174" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">有一种服务叫做<code class="fe ln lo lp lq b">kube-prometheus-exporter-node</code>:</p><pre class="od oe of og gt ol lq om on aw oo bi"><span id="dd88" class="nc lz jb lq b gy op oq l or os">kubectl get service --all-namespaces -l component=node-exporter -o=custom-columns=NAMESPACE:.metadata.namespace,NAME:.metadata.name<br/>NAMESPACE    NAME<br/>monitoring   kube-prometheus-exporter-node</span></pre><p id="7965" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">它提供了对一组叫做<code class="fe ln lo lp lq b">kube-prometheus-exporter-node-*</code>的吊舱的访问:</p><pre class="od oe of og gt ol lq om on aw oo bi"><span id="7480" class="nc lz jb lq b gy op oq l or os">kubectl get pod --all-namespaces -l component=node-exporter -o=custom-columns=NAMESPACE:.metadata.namespace,NAME:.metadata.name<br/>NAMESPACE    NAME<br/>monitoring   kube-prometheus-exporter-node-b7v4g<br/>monitoring   kube-prometheus-exporter-node-xz9xw<br/>monitoring   kube-prometheus-exporter-node-zxl64</span></pre><p id="42ee" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">这些pod被部署为守护程序集，这意味着我们集群中的每个节点都将有一个该pod的实例:</p><pre class="od oe of og gt ol lq om on aw oo bi"><span id="863e" class="nc lz jb lq b gy op oq l or os">kubectl get daemonset --all-namespaces  -l component=node-exporter -o=custom-columns=NAMESPACE:.metadata.namespace,NAME:.metadata.name<br/>NAMESPACE    NAME<br/>monitoring   kube-prometheus-exporter-node</span></pre><p id="e712" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">还部署了<strong class="ks jc"> servicemonitor </strong>，它被配置为监视<code class="fe ln lo lp lq b">monitoring</code>名称空间中具有标签<code class="fe ln lo lp lq b">app=exporter-node</code>和标签<code class="fe ln lo lp lq b">node-exporter</code>的服务的<code class="fe ln lo lp lq b">metrics</code>端口</p><pre class="od oe of og gt ol lq om on aw oo bi"><span id="47b9" class="nc lz jb lq b gy op oq l or os">kubectl describe servicemonitor kube-prometheus-exporter-node --namespace monitoring<br/>Name:         kube-prometheus-exporter-node<br/>Namespace:    monitoring<br/>Labels:       app=exporter-node<br/>              chart=exporter-node-0.3.2<br/>              component=node-exporter<br/>              heritage=Tiller<br/>              prometheus=kube-prometheus<br/>              release=kube-prometheus<br/>...<br/>Spec:<br/>  Endpoints:<br/>    Interval:  15s<br/>    <strong class="lq jc">Port:      metrics</strong><br/>  Job Label:   component<br/>  Namespace Selector:<br/>    Match Names:<br/>      <strong class="lq jc">monitoring</strong><br/>  Selector:<br/>    Match Labels:<strong class="lq jc"><br/>      App:        exporter-node<br/>      Component:  node-exporter</strong><br/>Events:           &lt;none&gt;</span></pre><p id="7b71" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><code class="fe ln lo lp lq b">kube-prometheus-exporter-node</code>服务有这些标签，因此它的<code class="fe ln lo lp lq b">metrics</code>端口将被Prometheus监控:</p><pre class="od oe of og gt ol lq om on aw oo bi"><span id="e25f" class="nc lz jb lq b gy op oq l or os">kubectl describe service kube-prometheus-exporter-node --namespace monitoring<br/>Name:              kube-prometheus-exporter-node<br/><strong class="lq jc">Namespace:</strong>         <strong class="lq jc">monitoring</strong><br/><strong class="lq jc">Labels: </strong>           <strong class="lq jc">app=exporter-node</strong><br/>                   chart=exporter-node-0.3.2<br/>                   <strong class="lq jc">component=node-exporter</strong><br/>                   heritage=Tiller<br/>                   release=kube-prometheus<br/>Annotations:       &lt;none&gt;<br/>Selector:          app=kube-prometheus-exporter-node,component=node-exporter,release=kube-prometheus<br/>Type:              ClusterIP<br/>IP:                10.0.120.251<br/>Port:              metrics  9100/TCP<br/><strong class="lq jc">TargetPort:        metrics/TCP<br/>Endpoints:         10.240.0.4:9100,10.240.0.5:9100,10.240.0.6:9100</strong><br/>Session Affinity:  None<br/>Events:            &lt;none&gt;</span></pre><p id="fa49" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">这允许Prometheus server从每个节点获取指标:</p><figure class="od oe of og gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oz"><img src="../Images/87574ff7753c680f5cbd98f7972ed035.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A3iG3-wrWQenErqaA9McvQ.png"/></div></div><figcaption class="oh oi gj gh gi oj ok bd b be z dk translated">kube-Prometheus-exporter-节点概述</figcaption></figure><h1 id="8353" class="ly lz jb bd ma mb ot md me mf ou mh mi kh ov ki mk kk ow kl mm kn ox ko mo mp bi translated">查看指标</h1><p id="3af3" class="pw-post-body-paragraph kq kr jb ks b kt mq kc kv kw mr kf ky kz ms lb lc ld mt lf lg lh mu lj lk ll ij bi translated">要访问Prometheus，我们必须连接到集群中运行Prometheus服务器的pod。我们可以通过使用<code class="fe ln lo lp lq b">kubectl port-forward</code>将本地主机上的一个端口转发到集群中的一个特定pod来实现这一点。运行下面的命令:</p><pre class="od oe of og gt ol lq om on aw oo bi"><span id="a4f4" class="nc lz jb lq b gy op oq l or os">kubectl --namespace monitoring port-forward $(kubectl get pod --namespace monitoring -l prometheus=kube-prometheus -l app=prometheus -o template --template "{{(index .items 0).metadata.name}}") 9090:9090</span></pre><p id="ff18" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">在浏览器中打开<a class="ae lm" href="http://localhost:9090/targets" rel="noopener ugc nofollow" target="_blank">http://localhost:9090/targets</a>。在这里，您可以看到Prometheus正在从哪些端点收集指标。如果我们仔细看看节点导出器目标e，会看到Prometheus正在我们的3个节点中的每一个上抓取端口<code class="fe ln lo lp lq b">9100</code>上的<code class="fe ln lo lp lq b">/metrics</code>端点。</p><figure class="od oe of og gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pa"><img src="../Images/83ae6a44692e5269dd52756ca50d4da2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a2uktM__dBIXcI45uJfbTg.png"/></div></div><figcaption class="oh oi gj gh gi oj ok bd b be z dk translated">Prometheus删除了节点导出程序端点</figcaption></figure><h2 id="2829" class="nc lz jb bd ma nd ne dn me nf ng dp mi kz nh ni mk ld nj nk mm lh nl nm mo nn bi translated">格拉夫纳</h2><p id="8018" class="pw-post-body-paragraph kq kr jb ks b kt mq kc kv kw mr kf ky kz ms lb lc ld mt lf lg lh mu lj lk ll ij bi translated">Kube-prometheus包括Grafana，要查看它，您首先需要通过在bash提示符下运行以下命令来获取用户名和密码:</p><pre class="od oe of og gt ol lq om on aw oo bi"><span id="29dc" class="nc lz jb lq b gy op oq l or os">echo username:$(kubectl get secret --namespace monitoring kube-prometheus-grafana -o jsonpath="{.data.user}"|base64 --decode;echo)<br/>echo password:$(kubectl get secret --namespace monitoring kube-prometheus-grafana -o jsonpath="{.data.password}"|base64 --decode;echo)</span></pre><p id="010f" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">接下来运行下面的命令，将端口<code class="fe ln lo lp lq b">3000</code>转发到承载Grafana的pod:</p><pre class="od oe of og gt ol lq om on aw oo bi"><span id="1eef" class="nc lz jb lq b gy op oq l or os">kubectl --namespace monitoring port-forward $(kubectl get pod --namespace monitoring -l app=kube-prometheus-grafana -o template --template "{{(index .items 0).metadata.name}}") 3000:3000</span></pre><p id="5949" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">打开<a class="ae lm" href="http://localhost:3000/login" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/log in</a>，使用检索到的用户名和密码。登录后，单击页面左上角的控制面板下拉列表:</p><figure class="od oe of og gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pb"><img src="../Images/2b3dee083bcf671dd28cac381fbe203d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OdC_NDpXCn7yLHfO0U0jag.png"/></div></div><figcaption class="oh oi gj gh gi oj ok bd b be z dk translated">仪表板下拉菜单</figcaption></figure><p id="aa08" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">并选择<code class="fe ln lo lp lq b">Nodes</code>仪表盘:</p><figure class="od oe of og gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/080d16e33b58699ecd0ad03130700cfd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-hzdcH9dZLcUiCaH9iUA5Q.png"/></div></div><figcaption class="oh oi gj gh gi oj ok bd b be z dk translated">节点仪表板</figcaption></figure><p id="eba0" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">在仪表板的左上方，您可以选择想要查看其指标的<code class="fe ln lo lp lq b">server</code>。<code class="fe ln lo lp lq b">server</code>是集群中的<code class="fe ln lo lp lq b">node</code>,从中获取指标。</p><p id="1258" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">作为kube-prometheus的一部分安装的每一个<strong class="ks jc">服务监视器</strong>都为prometheus提供了特定的指标。Grafana有许多默认的仪表板，使用这些指标来显示图表。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><p id="072a" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">现在你知道当你使用HELM安装prometheus操作器和kube-prometheus时发生了什么，以及操作器和自定义资源定义如何允许你监视kubernetes本身，你可以开始用你自己的<strong class="ks jc">服务监视器</strong>自定义和扩展Prometheus。</p></div></div>    
</body>
</html>