<html>
<head>
<title>How to view application-metrics in Kiali</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Kiali中查看应用指标</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-view-application-metrics-in-kiali-482bd1733942?source=collection_archive---------3-----------------------#2019-03-06">https://itnext.io/how-to-view-application-metrics-in-kiali-482bd1733942?source=collection_archive---------3-----------------------#2019-03-06</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><p id="5aea" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">多亏了<a class="km kn ep" href="https://medium.com/u/ba87ae253897?source=post_page-----482bd1733942--------------------------------" rel="noopener" target="_blank">乔尔·塔克沃里安</a>和<a class="ae ko" href="https://medium.com/kialiproject" rel="noopener">基亚利团队</a>中其他人的工作，基亚利现在能够展示应用指标的定制遥测仪表板。这些控制面板可用于应用程序和工作负载。</p><figure class="kq kr ks kt gu ku gi gj paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gi gj kp"><img src="../Images/85f7855aeb79a1b00a3bc2345b3618bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l3KSEam_T5A23jE4d1LMyg.png"/></div></div><figcaption class="lb lc gk gi gj ld le bd b be z dk translated">具有自定义指标(“Quarkus指标”)的工作负载的屏幕截图</figcaption></figure><p id="b97d" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">此功能在Kiali版中提供。要使用它，您需要一个能够以Prometheus文本格式公开遥测数据的运行时。在我们开始之前，让我们看看这一切是如何工作的。</p><p id="3acb" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">下图用黄色显示已部署的应用程序，用绿色显示Prometheus数据库，用蓝绿色显示与Kiali相关的资源。图表下方描述了项目之间的线条。</p><figure class="kq kr ks kt gu ku gi gj paragraph-image"><div class="gi gj lf"><img src="../Images/418bbb68ae2f1f2d3628137126fa9466.png" data-original-src="https://miro.medium.com/v2/resize:fit:1234/format:webp/1*SoFw1uOzSMd4WHW29E0qbg.png"/></div><figcaption class="lb lc gk gi gj ld le bd b be z dk translated">仪表板功能的架构</figcaption></figure><p id="7166" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">安装Kiali时，系统中会安装一个新的自定义资源定义(CRD)<em class="lg">【monitoring dashboard . monitoring . Kiali . io</em>。除此之外，还为流行的运行时部署了许多仪表板定义的定制资源，如<a class="ae ko" href="https://quarkus.io" rel="noopener ugc nofollow" target="_blank"> Quarkus </a>、<a class="ae ko" href="https:://thorntail.io/" rel="noopener ugc nofollow" target="_blank"> Thorntail </a>、<a class="ae ko" href="https://vertx.io" rel="noopener ugc nofollow" target="_blank"> Vert。X </a>或Node.js <em class="lg"> (*1) </em>。这些定义显示在白色的蓝绿色方框中。<br/>为你自己的项目创建这样的定制资源也是很容易的——我们稍后会讲到。Kiali使用这些定制资源作为模板来填充UI中的实际仪表板选项卡(洋红色线条)。</p><p id="aec1" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">在下一步中，您需要向被检测应用程序的Kubernetes部署对象添加附加信息:</p><pre class="kq kr ks kt gu lh li lj lk aw ll bi"><span id="f4a2" class="lm ln ir li b gz lo lp l lq lr"><strong class="li is">apiVersion</strong>: extensions/v1beta1<br/><strong class="li is">kind</strong>: Deployment<br/>[...]<br/><strong class="li is">spec</strong>:<br/>  <strong class="li is">template</strong>:<br/>    <strong class="li is">metadata</strong>:<br/>      <strong class="li is">annotations</strong>:<br/>        <strong class="li is">kiali.io/runtimes</strong>: quarkus,my-app<br/>        <strong class="li is">prometheus.io/port</strong>: "9080"<br/>        <strong class="li is">prometheus.io/scheme</strong>: http<br/>        <strong class="li is">prometheus.io/scrape</strong>: "true"</span></pre><p id="c2ff" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated"><em class="lg">kiali.io/runtimes</em>注释<em class="lg"> (*2) </em>定义了在Kiali控制台中显示的仪表板，在图中用棕色线表示。<br/><em class="lg"/>的人指示普罗米修斯要取数据(<em class="lg">刮</em>)，用什么方式(<em class="lg">方案</em>)，在什么端口(<em class="lg">端口</em>)。如果您不指定一个<em class="lg">路径</em>，Prometheus将从您的应用程序上的<em class="lg"> /metrics </em>端点开始抓取。普罗米修斯<a class="ae ko" href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config" rel="noopener ugc nofollow" target="_blank">文档包含选项的完整列表</a>。<br/>图中绿色实线表示刮削。</p><p id="f2ab" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">现在，让我们看看如何编写自定义仪表板定义。为此，我在我的应用程序中定义了一个计数器，并通过<a class="ae ko" href="https://github.com/eclipse/microprofile-metrics" rel="noopener ugc nofollow" target="_blank"> MicroProfile Metrics </a>公开它。</p><pre class="kq kr ks kt gu lh li lj lk aw ll bi"><span id="d1c6" class="lm ln ir li b gz lo lp l lq lr">$ curl  -HAccept:text/plain localhost:8080/metrics/application<br/><em class="lg"># TYPE application:ratings_endpoint_get_rating counter<br/></em>application:ratings_endpoint_get_rating 2.0</span></pre><p id="9c87" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">有了这些信息，我们现在就可以创建自定义资源了。创建一个新文件<em class="lg"> myApp.yaml </em>并添加以下内容(或者更好:什么与你的应用匹配):</p><pre class="kq kr ks kt gu lh li lj lk aw ll bi"><span id="9749" class="lm ln ir li b gz lo lp l lq lr"><strong class="li is">apiVersion</strong>: "monitoring.kiali.io/v1alpha1"<br/><strong class="li is">kind</strong>: MonitoringDashboard<br/><strong class="li is">metadata</strong>:<br/>  <strong class="li is">name</strong>: my-app<br/><strong class="li is">spec</strong>:<br/>  <strong class="li is">title</strong>: App Rating<br/>  <strong class="li is">charts</strong>:<br/>    - <strong class="li is">name</strong>: "Ratings calls"<br/>      <strong class="li is">unit</strong>: ""<br/>      <strong class="li is">spans</strong>: 6<br/>      <strong class="li is">metricName</strong>: "application:ratings_endpoint_get_rating"<br/>      <strong class="li is">dataType</strong>: "raw"<br/>    - <strong class="li is">name</strong>: "Ratings rate"<br/>      <strong class="li is">unit</strong>: ""<br/>      <strong class="li is">spans</strong>: 6<br/>      <strong class="li is">metricName</strong>: "application:ratings_endpoint_get_rating"<br/>      <strong class="li is">dataType</strong>: "rate"</span></pre><p id="00c2" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">为了使这个仪表板定义对所有名称空间可用，通过<em class="lg">ku bectl apply-f myapp . YAML-n istio-system部署它。</em>如果您将它部署到除<em class="lg"> istio-system </em>之外的名称空间，它将仅可用于该名称空间中的部署。</p><p id="c855" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">下一次屏幕刷新后，您将看到两个控制面板的两个选项卡:</p><figure class="kq kr ks kt gu ku gi gj paragraph-image"><div class="gi gj ls"><img src="../Images/3adbe745289d67f9739e0b80d2a8cae4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1262/format:webp/1*cvvydCbnMPRIXYgoMjQLdg.png"/></div><figcaption class="lb lc gk gi gj ld le bd b be z dk translated">我们的新仪表板“应用评级”现已可见</figcaption></figure><p id="2e7e" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">上面的定义具有仪表板的名称，因为它出现在部署的<em class="lg"> metadata.name </em>中。<em class="lg"> Spec.title </em>显示选项卡的标题，下面显示各个图表。跨度决定了图表的宽度(由于Bootstrap使用了，因此全宽为12个跨度<a class="ae ko" href="https://www.w3schools.com/bootstrap4/bootstrap_grid_system.asp" rel="noopener ugc nofollow" target="_blank">),名称和单位为自由文本。显然,“metricName”提供了指标的名称。在我们的例子中，我只使用了一次。在第一种情况下，它显示原始数据(即计数器被碰撞的频率)。第二种情况显示变化率(即除以时间的变化率)。<br/>源文件</a><a class="ae ko" href="https://github.com/kiali/kiali/blob/master/kubernetes/kiali_monitoring_types.go" rel="noopener ugc nofollow" target="_blank">kiali _ monitoring _ types . go</a>显示了其他可用选项，但最好还是看一下<a class="ae ko" href="https://github.com/kiali/kiali/tree/master/deploy/dashboards" rel="noopener ugc nofollow" target="_blank">提供的仪表板定义示例</a>。</p><h2 id="3cd5" class="lm ln ir bd lt lu lv dn lw lx ly dp lz jz ma mb mc kd md me mf kh mg mh mi mj bi translated">来自未知的流量？</h2><p id="f83e" class="pw-post-body-paragraph jo jp ir jq b jr mk jt ju jv ml jx jy jz mm kb kc kd mn kf kg kh mo kj kk kl ik bi translated">如果你在一个简单的Istio环境中运行上述程序，一旦你标记了你的抓取应用，你可能会突然看到来自未知的流量进入它们。这是因为默认的Istio规则没有将其过滤掉。我已经更新了<a class="ae ko" rel="noopener ugc nofollow" target="_blank" href="/where-does-the-unknown-taffic-in-istio-come-from-4a9a7e4454c3">关于这个主题的文章</a>，其中也展示了如何在Istio配置中重新配置规则。<br/>此外，您还可以使用Kiali 0.15中新的“隐藏”功能来隐藏UI中的未知流量。</p><h2 id="94f0" class="lm ln ir bd lt lu lv dn lw lx ly dp lz jz ma mb mc kd md me mf kh mg mh mi mj bi translated">结论</h2><p id="a31d" class="pw-post-body-paragraph jo jp ir jq b jr mk jt ju jv ml jx jy jz mm kb kc kd mn kf kg kh mo kj kk kl ik bi translated">新的仪表板功能让您可以看到对您重要的实际应用程序的指标。您可以在Kiali中轻松查看这些数据，但由于该功能使数据在Prometheus中可用，因此也可以使用Prometheus UI或Grafana等其他工具查看数据。由于该特性完全不依赖于Istio(它只使用自带的Prometheus)，我可以想象它可以很容易地放入一个单独的模块中，由其他工具引入。</p><h2 id="3ec1" class="lm ln ir bd lt lu lv dn lw lx ly dp lz jz ma mb mc kd md me mf kh mg mh mi mj bi translated">脚注</h2><p id="86df" class="pw-post-body-paragraph jo jp ir jq b jr mk jt ju jv ml jx jy jz mm kb kc kd mn kf kg kh mo kj kk kl ik bi translated">*)1在0.15版本中，您必须手动安装它们，而在0.16版本以后，安装程序会负责安装。要安装定义，请转到<a class="ae ko" href="https://github.com/kiali/kiali/tree/v0.15.0/deploy/dashboards" rel="noopener ugc nofollow" target="_blank">https://github . com/kiali/kiali/tree/v 0 . 15 . 0/deploy/dashboards</a>并通过<em class="lg"> kubectl apply -f * </em>安装文件</p><p id="2c01" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">*2)在我使用的版本中，逗号后面不能有空格来分隔多个定义。这个要求以后会放宽。</p></div></div>    
</body>
</html>