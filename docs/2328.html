<html>
<head>
<title>Test-driven develop your API with Jest &amp; SuperTest in Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">测试驱动使用Node.js中的Jest &amp; SuperTest开发您的API</h1>
<blockquote>原文：<a href="https://itnext.io/test-driven-develop-your-api-with-jest-supertest-in-node-js-7e1c6489b0a6?source=collection_archive---------1-----------------------#2019-05-07">https://itnext.io/test-driven-develop-your-api-with-jest-supertest-in-node-js-7e1c6489b0a6?source=collection_archive---------1-----------------------#2019-05-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/e8c26adc696241ffb924387835c6ee9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eQsKQZYYDdhuaygffOW7SQ.png"/></div></div></figure><div class=""/><p id="5d80" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae kz" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>已经成为后端的热门选择。像<a class="ae kz" href="https://expressjs.com/" rel="noopener ugc nofollow" target="_blank"> Express </a>这样的框架使得快速构建一个强大的API变得很容易。如果你提供了一个(公共的)API，那么你要确保代码的改变不会破坏你的API。确保这一点的一种方法是编写定期执行的测试(例如，在合并拉请求之前)。</p><p id="3c73" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们将使用以下技术:</p><ul class=""><li id="d4ad" class="la lb je kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated"><strong class="kd jf"> SuperTest </strong>调用我们的API routes，因为它提供了一个易于使用的API来发送节点中的HTTP请求</li><li id="44f8" class="la lb je kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">Jest 作为测试框架，因为它为JavaScript项目提供了很好的测试体验</li><li id="34a1" class="la lb je kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated"><strong class="kd jf"> TypeScript </strong>(可选)，因为它极大地提高了开发人员的生产力</li></ul></div><div class="ab cl lo lp hx lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="im in io ip iq"><h2 id="c954" class="lv lw je bd lx ly lz dn ma mb mc dp md km me mf mg kq mh mi mj ku mk ml mm mn bi translated">如何用JavaScript / TypeScript编写API测试</h2><ol class=""><li id="9c1a" class="la lb je kd b ke mo ki mp km mq kq mr ku ms ky mt lg lh li bi translated"><strong class="kd jf">安装必要的依赖关系</strong> : <code class="fe mu mv mw mx b">npm install <strong class="kd jf">jest</strong> <strong class="kd jf">supertest</strong> @types/jest @types/supertest ts-jest --save=dev</code>。类型和<em class="my"> ts-jest </em>不是必需的，但如果使用TypeScript，则推荐使用。还可以使用<code class="fe mu mv mw mx b">-g</code>标志全局安装Jest。</li><li id="719f" class="la lb je kd b ke lj ki lk km ll kq lm ku ln ky mt lg lh li bi translated">在一个单独的文件中(推荐)或者在你的<em class="my"> package.json </em>中创建一个Jest配置。</li><li id="8d25" class="la lb je kd b ke lj ki lk km ll kq lm ku ln ky mt lg lh li bi translated"><strong class="kd jf">创建一个包含Jest应该运行的规格文件</strong>(例如<em class="my">测试</em>)的文件夹。</li><li id="0cfe" class="la lb je kd b ke lj ki lk km ll kq lm ku ln ky mt lg lh li bi translated">使用Jest &amp; SuperTest 编写您的测试。您应该一致地命名您的测试文件(例如<em class="my"> user-routes.spec.ts </em>)。</li><li id="767f" class="la lb je kd b ke lj ki lk km ll kq lm ku ln ky mt lg lh li bi translated"><strong class="kd jf">使用Jest </strong> : <code class="fe mu mv mw mx b">jest</code>运行测试一次，或者使用<code class="fe mu mv mw mx b">jest --<a class="ae kz" href="https://jestjs.io/docs/en/cli#watch" rel="noopener ugc nofollow" target="_blank">watchAll</a></code>启用观察模式。</li><li id="69c1" class="la lb je kd b ke lj ki lk km ll kq lm ku ln ky mt lg lh li bi translated">可选:<strong class="kd jf">使用<code class="fe mu mv mw mx b"><a class="ae kz" href="https://jestjs.io/docs/en/cli.html#--coverageboolean" rel="noopener ugc nofollow" target="_blank">--coverage</a></code>标志测量测试覆盖率</strong>。为了确保测试覆盖率只上升不下降，我们可以设置阈值。如果没有达到阈值，Jest将失败。您可以通过自定义Jest配置中的<code class="fe mu mv mw mx b"><a class="ae kz" href="https://jestjs.io/docs/en/configuration#coveragethreshold-object" rel="noopener ugc nofollow" target="_blank">coverageThreshold</a></code>来配置目录、文件类型甚至单个文件的阈值。</li><li id="95d0" class="la lb je kd b ke lj ki lk km ll kq lm ku ln ky mt lg lh li bi translated">可选:创建一个<a class="ae kz" href="https://jestjs.io/docs/en/configuration#globalsetup-string" rel="noopener ugc nofollow" target="_blank"> <strong class="kd jf"> globalSetup </strong> </a>和一个<a class="ae kz" href="https://jestjs.io/docs/en/configuration#globalteardown-string" rel="noopener ugc nofollow" target="_blank"><strong class="kd jf">global tear down</strong></a><strong class="kd jf">文件</strong>，分别在所有测试执行前/后执行一次。这个想法是执行一次繁重的清理工作。用例:创建一个数据库/用户/授权&amp;最后删除测试执行过程中创建的所有东西。</li><li id="e2e1" class="la lb je kd b ke lj ki lk km ll kq lm ku ln ky mt lg lh li bi translated">可选:<strong class="kd jf">用命令<code class="fe mu mv mw mx b">npm install <strong class="kd jf"><em class="my">typescript</em></strong> --save=dev</code>安装类型脚本</strong>。TypeScript是现代JavaScript项目的最佳选择，因为它提供了类型安全，并允许开发人员甚至在旧浏览器中使用现代功能。如果你有Java或C#背景，那么TypeScript会更好用。</li></ol><p id="886e" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面是一个单独文件中的示例<strong class="kd jf"> Jest </strong> <strong class="kd jf">配置</strong>:</p><pre class="mz na nb nc gt nd mx ne nf aw ng bi"><span id="5a1d" class="lv lw je mx b gy nh ni l nj nk">module.exports = {<br/> // preset: 'ts-jest', // use this if you are using TypeScript<br/> globalSetup: './jest.global-setup.js', // optional: will be called once before all tests are executed<br/> // globalTeardown: './jest.global-teardown.js', // optional: will be called once after all tests are executed<br/>  coverageThreshold: {<br/>    global: {<br/>      branches: 80,<br/>      functions: 80,<br/>      lines: 80,<br/>      statements: 80<br/>    }<br/>  } // optional: let Jest fail if thresholds are not met<br/>};</span></pre><p id="ac3b" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">以下是测试登录功能的示例<strong class="kd jf"> SuperAgent规格</strong>:</p><pre class="mz na nb nc gt nd mx ne nf aw ng bi"><span id="b633" class="lv lw je mx b gy nh ni l nj nk"><strong class="mx jf">import request from 'supertest';</strong><br/>const app = require('../app'); // our Node application</span><span id="f57a" class="lv lw je mx b gy nl ni l nj nk"><strong class="mx jf"><em class="my">describe</em></strong>('Login', () =&gt; {</span><span id="c476" class="lv lw je mx b gy nl ni l nj nk"><em class="my"> </em><strong class="mx jf"><em class="my">it</em></strong>('succeeds with correct credentials', async () =&gt; {<br/>   const response = await post(`login`, demoUser)<br/>     .expect(200);<br/>    expect(res.body.user.email).toBe(demoUser.email);<br/>  });</span><span id="9c31" class="lv lw je mx b gy nl ni l nj nk"><em class="my"> </em><strong class="mx jf"><em class="my">it</em></strong>('fails with invalid credentials', async () =&gt; {<br/>   const user = {email:'notarealmail@mycompany.com', password: 'somepassword'};<br/>   await post(`login`, user)<br/>     .expect(401);<br/>  });</span><span id="4724" class="lv lw je mx b gy nl ni l nj nk"><em class="my"> </em><strong class="mx jf"><em class="my">it</em></strong>('fails with missing credentials', async () =&gt; {<br/>   const user = {};<br/>   await post(`login`, user)<br/>     .expect(401);<br/>  });</span><span id="9ec1" class="lv lw je mx b gy nl ni l nj nk">});</span><span id="1277" class="lv lw je mx b gy nl ni l nj nk">// a helper function to make a POST request.<br/>export function post(url, body){<br/>  const httpRequest = request(app).post(url);<br/>  httpRequest.send(body);<br/>  httpRequest.set('Accept', 'application/json')<br/>  httpRequest.set('Origin', '<a class="ae kz" href="http://localhost:3000'" rel="noopener ugc nofollow" target="_blank">http://localhost:3000'</a>)<br/>  return httpRequest;<br/>}</span></pre><p id="aee4" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这里有一个示例<strong class="kd jf"> globalSetup </strong>文件(<em class="my"> globalTeardown </em>工作方式相同)。在本例中，我用MongoDB创建了一个新的数据库，用于我的API测试。如您所见，导出了一个异步函数。</p><pre class="mz na nb nc gt nd mx ne nf aw ng bi"><span id="1d94" class="lv lw je mx b gy nh ni l nj nk">/**<br/> * Connect to the test database (and create if it does not exist yet).<br/> * Creates all necessary MongoDB collections.<br/> */<br/>export default async () =&gt; {<br/>  const collections = ['user', 'company', ...];<br/>  const dbManager = await getDemoDB();<br/>  for (let collection of collections) {<br/>    await dbManager.db.createCollection(collection);<br/>   }<br/>  await prepareDatabase();<br/>}</span></pre></div><div class="ab cl lo lp hx lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="im in io ip iq"><h2 id="0899" class="lv lw je bd lx ly lz dn ma mb mc dp md km me mf mg kq mh mi mj ku mk ml mm mn bi translated">如何在Jest中禁用并发性(并行执行)</h2><p id="0905" class="pw-post-body-paragraph kb kc je kd b ke mo kg kh ki mp kk kl km nm ko kp kq nn ks kt ku no kw kx ky im bi translated">默认情况下，Jest会检测它应该并发运行多少个测试。这将加速测试，因为测试可以并行运行。然而，如果您的测试相互依赖，或者如果您想要更稳定的结果，这可能是一个问题。在这种情况下，您可以使用<code class="fe mu mv mw mx b">--<a class="ae kz" href="https://jestjs.io/docs/en/cli#runinband" rel="noopener ugc nofollow" target="_blank">runInBand</a></code>选项按顺序进行Jest运行测试。</p></div><div class="ab cl lo lp hx lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="im in io ip iq"><h2 id="6cdd" class="lv lw je bd lx ly lz dn ma mb mc dp md km me mf mg kq mh mi mj ku mk ml mm mn bi translated">使用您的IDE (IntelliJ，Visual Studio代码)运行Jest测试</h2><p id="3d12" class="pw-post-body-paragraph kb kc je kd b ke mo kg kh ki mp kk kl km nm ko kp kq nn ks kt ku no kw kx ky im bi translated">Jetbrains(<strong class="kd jf">IntelliJ IDEA/web storm</strong>…)的开发者创建了一个<a class="ae kz" href="https://www.jetbrains.com/help/idea/running-unit-tests-on-jest.html" rel="noopener ugc nofollow" target="_blank"> <strong class="kd jf"> Jest插件</strong> </a>，它允许你直接从你的IDE运行测试。如果你使用的是<strong class="kd jf"> Visual Studio代码</strong>，你可以很容易地<strong class="kd jf">创建一个启动配置</strong>，你可以在里面执行它。你需要做的就是在你的<strong class="kd jf">中创建一个<a class="ae kz" href="https://code.visualstudio.com/docs/editor/debugging#_launch-configurations" rel="noopener ugc nofollow" target="_blank"> <strong class="kd jf"> launch.json </strong> </a>文件。vscode </strong>文件夹，并添加以下配置:</p><pre class="mz na nb nc gt nd mx ne nf aw ng bi"><span id="e5d1" class="lv lw je mx b gy nh ni l nj nk">{<br/>      "type": "node",<br/>      "request": "launch",<br/>      "name": "Jest: Run all",<br/>      "program": "${workspaceFolder}/node_modules/.bin/jest",<br/>      "args": [],<br/>      "console": "integratedTerminal",<br/>      "internalConsoleOptions": "neverOpen",<br/>      "disableOptimisticBPs": true<br/>    },<br/>    {<br/>      "type": "node",<br/>      "request": "launch",<br/>      "name": "Jest: Run current File",<br/>      "program": "${workspaceFolder}/node_modules/.bin/jest",<br/>      "args": [<br/>        "${relativeFile}"<br/>      ],<br/>      "console": "integratedTerminal",<br/>      "internalConsoleOptions": "neverOpen",<br/>      "disableOptimisticBPs": true<br/>    }<br/>}</span></pre></div><div class="ab cl lo lp hx lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="im in io ip iq"><h2 id="a673" class="lv lw je bd lx ly lz dn ma mb mc dp md km me mf mg kq mh mi mj ku mk ml mm mn bi translated">结论</h2><p id="b1c5" class="pw-post-body-paragraph kb kc je kd b ke mo kg kh ki mp kk kl km nm ko kp kq nn ks kt ku no kw kx ky im bi translated">感谢阅读这篇文章。如您所见，用JavaScript编写API测试很容易。<a class="ae kz" rel="noopener ugc nofollow" target="_blank" href="/how-to-use-jest-in-angular-aka-make-unit-testing-great-again-e4be2d2e92d1">正如我在帖子中提到的在Angular项目中使用Jest</a>,<strong class="kd jf">Jest</strong>再次证明了它可以在任何类型的JavaScript项目中使用。TypeScript 有助于使代码更加整洁，并通过静态类型更快地识别问题。并且<strong class="kd jf"> SuperTest </strong>允许我们在测试中轻松地发出HTTP请求。你用什么来写Node.js的API测试？请在评论中告诉我。</p></div></div>    
</body>
</html>