<html>
<head>
<title>Where does the ‘unknown’ traffic in Istio come from (updated)?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Istio中的‘未知’流量从何而来(更新)？</h1>
<blockquote>原文：<a href="https://itnext.io/where-does-the-unknown-taffic-in-istio-come-from-4a9a7e4454c3?source=collection_archive---------4-----------------------#2018-10-09">https://itnext.io/where-does-the-unknown-taffic-in-istio-come-from-4a9a7e4454c3?source=collection_archive---------4-----------------------#2018-10-09</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><p id="714a" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">(根据我的同事<a class="ae km" href="http://twitter.com/jotak" rel="noopener ugc nofollow" target="_blank"> Joel </a>的评论和发现更新)</p><p id="b481" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">当您使用<a class="ae km" href="https://istio.io/" rel="noopener ugc nofollow" target="_blank"> Istio </a>并可能安装了<a class="ae km" href="https://www.kiali.io/" rel="noopener ugc nofollow" target="_blank"> Kiali </a>时，您可能会发现有时数据来自“未知”:</p><figure class="ko kp kq kr gu ks gi gj paragraph-image"><div class="gi gj kn"><img src="../Images/a21d1aef4572d835dd35cfe2532a7bb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:622/format:webp/1*iCoFIg_RLHZciGA4seDFsg.png"/></div></figure><p id="ef71" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">不要担心，这不是黑客向您的服务发送数据。最有可能的情况是，Istio记录的服务和工作负载的流量不是来自部署了Envoy代理的源pod，因此不是网格的一部分。</p><p id="00a5" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated"><strong class="jq is">入口流量</strong></p><p id="6e79" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">Istio希望流量通过<em class="kv">入口网关</em>。当您看到“未知”流量时，可以简单地使用标准Kubernetes入口或OpenShift路由将流量从外部发送到Istio。</p><p id="e94b" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">您可能认为这不是问题，因为流量到达您的服务，然后从那里也是网格的一部分。这多半是真的。</p><p id="ba14" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">但是你也错过了流量控制、报头重写、入口网关和服务之间的相互TLS的机会。</p><p id="cea1" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated"><strong class="jq is">内部流量</strong></p><p id="1252" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">“未知”流量的另一个来源是(Kubernetes)集群内的(正常)pod，它们没有部署Envoy sidecar，因此不属于网状网络。</p><p id="5a0c" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">例如，从kubelet或Prometheus调用您的应用程序中的/health或/metrics可能会引发这种情况。</p><p id="e153" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">您可以通过调整match子句来修改Istio-config规则，从而过滤掉此流量(根据Istio版本，关于kube-probe的部分可能已经存在:</p><pre class="ko kp kq kr gu kw kx ky kz aw la bi"><span id="0b0a" class="lb lc ir kx b gz ld le l lf lg">$ kubectl edit rules.config.istio.io promhttp -n istio-system<br/><br/>[...]<br/><strong class="kx is">match</strong>: (context.protocol == "http" || context.protocol == "grpc") &amp;&amp;<br/> (match((request.useragent | "-"), "kube-probe*") == false) &amp;&amp;   <br/> (match((request.useragent | "-"), "Prometheus*")  == false)</span></pre><p id="ad67" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">这上面有一个针对Istio 的<a class="ae km" href="https://github.com/istio/istio/pull/12251" rel="noopener ugc nofollow" target="_blank">公开的PR。</a></p><p id="0834" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated"><strong class="jq is">处理“未知”流量</strong></p><p id="8744" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">随着时间的推移，您希望将所有服务迁移到网格上。如果您担心这种未知流量，您还可以使用<a class="ae km" href="https://istio.io/docs/tasks/policy-enforcement/denial-and-list/#simple-denials" rel="noopener ugc nofollow" target="_blank"> Istio规则将该流量列入黑名单</a>。</p></div></div>    
</body>
</html>