<html>
<head>
<title>High Available VPC architecture in CloudFormation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云形成中的高可用VPC架构</h1>
<blockquote>原文：<a href="https://itnext.io/high-available-vpc-architecture-in-cloudformation-2f4d8a86f4d2?source=collection_archive---------3-----------------------#2019-02-27">https://itnext.io/high-available-vpc-architecture-in-cloudformation-2f4d8a86f4d2?source=collection_archive---------3-----------------------#2019-02-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><blockquote class="jq jr js"><p id="f243" class="jt ju jv jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr im bi translated">在本教程中，我将解释如何设置一个安全和高可用性的虚拟私有云架构，并使用CloudFormation自动设置。我们将在这个VPC中托管一个基本的高可用性应用程序。<br/>我们还会考虑成本，这意味着我们不会让非关键资源高度可用。</p></blockquote><h1 id="6a20" class="ks kt it bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">AWS中的高可用性</h1><p id="392f" class="pw-post-body-paragraph jt ju it jw b jx lq jz ka kb lr kd ke ls lt kh ki lu lv kl km lw lx kp kq kr im bi translated">在AWS中，您可以在不同的地区部署资源和使用服务，如eu-west-1 (EU Ireland)、us-east-1 (US N. Virgina)等。<a class="ae ly" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html" rel="noopener ugc nofollow" target="_blank">每个AWS区域由多个可用区域组成</a>。可用性区域(AZ)由一个或多个高度安全的数据中心组成。可用性区域彼此相距数十/数百英里。由于AZ之间的距离，两个区域几乎不可能因为地震、海啸、攻击等灾难而同时停机。<br/>在AWS的世界中,“高可用性”一词意味着当一个AZ关闭时，您的基础架构将保持可用。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi lz"><img src="../Images/1f9ee8b9fbc5050228614f3c65eb0259.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qFiTkaYZVVnPDcZ3NOlp5Q.jpeg"/></div></div></figure><h1 id="74b7" class="ks kt it bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">VPC建筑</h1><p id="fb6e" class="pw-post-body-paragraph jt ju it jw b jx lq jz ka kb lr kd ke ls lt kh ki lu lv kl km lw lx kp kq kr im bi translated">让我们看看我们的架构，并讨论每个组件。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi ml"><img src="../Images/654ce56fcf9145fae4fd2b644c13a34e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AEadiFq0fHsq8MbZNaqycg.png"/></div></div></figure><h2 id="0bc4" class="mm kt it bd ku mn mo dn ky mp mq dp lc ls mr ms lg lu mt mu lk lw mv mw lo mx bi translated">基础设施方面</h2><ul class=""><li id="a57e" class="my mz it jw b jx lq kb lr ls na lu nb lw nc kr nd ne nf ng bi translated"><strong class="jw iu"> VPC </strong>:亚马逊虚拟私有云让你可以提供亚马逊网络服务(AWS)云的一个逻辑隔离部分，你可以在那里启动AWS资源。您必须以CIDR块的形式为VPC指定一个IPv4地址范围(如10.0.0.0/16)。VPC跨越一个区域中的所有可用性区域。我们的设置需要1个VPC。</li><li id="1a69" class="my mz it jw b jx nh kb ni ls nj lu nk lw nl kr nd ne nf ng bi translated"><strong class="jw iu">子网</strong>:一个VPC包含多个子网。子网可以是公共的，也可以是私有的，并且跨越一个可用性区域。子网也有一个CIDR块，它是VPC CIDR的子集。<br/> →我们的设置需要四个子网。我们将使用两个公共子网和两个私有子网，每个子网位于不同的可用性区域。如果一个区域发生故障，我们仍有公共和私有子网可用。</li><li id="5a7e" class="my mz it jw b jx nh kb ni ls nj lu nk lw nl kr nd ne nf ng bi translated"><strong class="jw iu"> IGW </strong>:互联网网关是一种资源，可让您的VPC接入互联网。每个通过IGW通向internet (0.0.0.0/0)的子网都是公共子网。该子网中的资源可以与internet通信。<br/> →我们只需要部署一个IGW，因为它本身具有高可用性，并且没有带宽限制。</li><li id="7912" class="my mz it jw b jx nh kb ni ls nj lu nk lw nl kr nd ne nf ng bi translated"><strong class="jw iu"> NAT网关</strong>:在公共VPC子网中使用NAT网关，以支持来自私有子网实例的出站互联网流量。私有子网需要一条通过NAT网关到达互联网的路由。<br/> →出于成本考虑，我们将只部署一个NAT网关。其结果是，当部署NAT的可用区域出现故障时，私有子网中的实例将无法访问互联网。<br/>这对我们的应用程序来说并不重要，应用程序将继续工作。这就是为什么我们更喜欢手动启动新的NAT网关，而不是使其高度可用，但是当然可以在每个可用性区域部署一个NAT网关。</li><li id="ffc1" class="my mz it jw b jx nh kb ni ls nj lu nk lw nl kr nd ne nf ng bi translated"><strong class="jw iu">堡垒主机</strong>:堡垒主机是一个安全的公共实例，充当SSH网关。我们可以通过SSH连接到这个公共实例，从这个实例内部，我们可以使用私有IP通过SSH连接到私有实例。bastion主机由一个安全组保护，该安全组可以限制对实例的SSH访问。<br/> →我们将部署一台堡垒主机。同样，当运行该实例的可用性区域关闭时，该实例也将关闭。但是就像NAT网关一样，我们的应用程序不会受到影响，我们决定让bastion主机不具有高可用性。在可用性区域中断的情况下，我们可以在工作AZ的公共子网内启动EC2。<br/>您可以使用自动扩展使您的bastion主机高度可用。</li><li id="7b12" class="my mz it jw b jx nh kb ni ls nj lu nk lw nl kr nd ne nf ng bi translated"><strong class="jw iu">路由表</strong>:路由表包含一组称为路由的规则，用于确定网络流量的流向。VPC中的每个子网必须与一个路由表相关联；该表控制子网的路由。一个子网一次只能与一个路由表相关联，但是您可以将多个子网与同一个路由表相关联。<br/> →路由表是替代路由器的AWS提供的高可用服务。我们需要对它们进行配置，但不一定要让它们高度可用。</li><li id="a8c7" class="my mz it jw b jx nh kb ni ls nj lu nk lw nl kr nd ne nf ng bi translated"><strong class="jw iu">安全组</strong>:安全组包含允许谁可以访问该安全组所属资源的规则。在我们的例子中，我们为ALB(每个人都可以在端口80上访问)、bastion主机(每个人都可以在端口22上SSH)和EC2实例(只有ALB可以在端口80上访问实例)设置了一个安全组。<br/> →安全组是高可用性资源。我们不需要考虑让它们在我们的环境中高度可用。</li></ul><h2 id="a529" class="mm kt it bd ku mn mo dn ky mp mq dp lc ls mr ms lg lu mt mu lk lw mv mw lo mx bi translated">应用程序端</h2><ul class=""><li id="0972" class="my mz it jw b jx lq kb lr ls na lu nb lw nc kr nd ne nf ng bi translated"><strong class="jw iu"> EC2 </strong>:我们的应用程序，一个基本的Apache web服务器托管在一个EC2实例上。<br/> →我们将在不同的子网中部署两个EC2实例，因为当部署EC2的AZ(以及相应的子网)关闭时，EC2将不可用。</li><li id="a244" class="my mz it jw b jx nh kb ni ls nj lu nk lw nl kr nd ne nf ng bi translated"><strong class="jw iu">应用负载均衡器</strong>:ALB将对我们的两个EC2实例的流量进行负载均衡。如果其中一个出现故障，ALB会将所有流量路由到健康的实例。我们可以通过为我们的实例实现自动缩放来使这变得更高级，但是这超出了本教程的范围。<br/> →我们只需要部署一个ALB。在底层，ALB由多个子网中的多个ec2和AZ组成。如果一个AZ关闭，ALB不会受到影响。由于AWS的智能实现，该服务具有高可用性。</li></ul><h1 id="2967" class="ks kt it bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">云的形成</h1><p id="c6db" class="pw-post-body-paragraph jt ju it jw b jx lq jz ka kb lr kd ke ls lt kh ki lu lv kl km lw lx kp kq kr im bi translated">设置整个环境的CloudFormation模板在我的GitHub 上有<a class="ae ly" href="https://github.com/lvthillo/aws-private-ha-app-setup" rel="noopener ugc nofollow" target="_blank">。随意叉/星模板。</a></p><p id="f48d" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ls kg kh ki lu kk kl km lw ko kp kq kr im bi translated">模板将创建我们在前一章中讨论过的资源。在这里，您还可以检查路由表的配置是如何实现的。GitHub自述文件还包含了一个完整的列表，列出了哪些资源将在你的亚马逊账户中创建。</p><ol class=""><li id="484e" class="my mz it jw b jx jy kb kc ls nm lu nn lw no kr np ne nf ng bi translated"><a class="ae ly" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html" rel="noopener ugc nofollow" target="_blank">安装AWS CLI </a></li><li id="1b99" class="my mz it jw b jx nh kb ni ls nj lu nk lw nl kr np ne nf ng bi translated"><a class="ae ly" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html" rel="noopener ugc nofollow" target="_blank">配置AWS CLI </a></li><li id="5394" class="my mz it jw b jx nh kb ni ls nj lu nk lw nl kr np ne nf ng bi translated"><a class="ae ly" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html" rel="noopener ugc nofollow" target="_blank">创建一个AWS密钥对</a></li><li id="15df" class="my mz it jw b jx nh kb ni ls nj lu nk lw nl kr np ne nf ng bi translated"><a class="ae ly" href="https://github.com/lvthillo/aws-private-ha-app-setup" rel="noopener ugc nofollow" target="_blank">派生/克隆存储库</a></li><li id="c998" class="my mz it jw b jx nh kb ni ls nj lu nk lw nl kr np ne nf ng bi translated">用您的个人值更新<a class="ae ly" href="https://github.com/lvthillo/aws-private-ha-app-setup/blob/master/parameters.json" rel="noopener ugc nofollow" target="_blank"> parameters.json </a></li><li id="0bc5" class="my mz it jw b jx nh kb ni ls nj lu nk lw nl kr np ne nf ng bi translated">部署堆栈:</li></ol><pre class="ma mb mc md gt nq nr ns nt aw nu bi"><span id="ed5c" class="mm kt it nr b gy nv nw l nx ny">$ aws cloudformation create-stack --stack-name vpc-demo --template-body file://template.yaml --parameters file://parameters.json</span></pre><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi nz"><img src="../Images/27856ae6e531b9b6fcc4717b4f360048.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wBlUf2aV-SRQ99fdLtcQ_A.png"/></div></div></figure><p id="6105" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ls kg kh ki lu kk kl km lw ko kp kq kr im bi translated">检查访问ALB的URL，并检查您是否可以访问该应用程序。你也可以检查你是否能使用堡垒主机。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi oa"><img src="../Images/02916dc6c23404ed0b1754308c61a82f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v2PhLt8hNYglC2UP0kCZ7Q.png"/></div></div><figcaption class="ob oc gj gh gi od oe bd b be z dk translated">ALB将我们路由到两个EC2实例中的一个</figcaption></figure><p id="4fde" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke ls kg kh ki lu kk kl km lw ko kp kq kr im bi translated"><em class="jv">备注:模板在欧盟-西方-1和美国-东方-1地区进行测试。如果某个映射包含问题。请随意打开一个拉取请求。</em></p><h1 id="853f" class="ks kt it bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">结论</h1><p id="6b7e" class="pw-post-body-paragraph jt ju it jw b jx lq jz ka kb lr kd ke ls lt kh ki lu lv kl km lw lx kp kq kr im bi translated">我们已经了解了高可用性在AWS领域意味着什么。<br/>之后，我们检查了一个成本优化的高可用性AWS环境，其中包含一个应用程序负载平衡器和两个EC2来托管web应用程序。我希望你喜欢这个教程！</p><figure class="ma mb mc md gt me gh gi paragraph-image"><a href="https://www.buymeacoffee.com/dZb8fLN"><div class="gh gi of"><img src="../Images/83dc7212ef8502659c81086ad58b8d96.png" data-original-src="https://miro.medium.com/v2/resize:fit:340/format:webp/1*bk_C8Um34KavCkO2yzMCZg.png"/></div></a><figcaption class="ob oc gj gh gi od oe bd b be z dk translated">如果真的对你有帮助…:)</figcaption></figure></div></div>    
</body>
</html>