<html>
<head>
<title>How to use Knative to Automate an Application Build on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Knative在Kubernetes上自动构建应用程序</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-use-knative-to-automate-an-application-build-on-kubernetes-904034341f9f?source=collection_archive---------3-----------------------#2019-04-05">https://itnext.io/how-to-use-knative-to-automate-an-application-build-on-kubernetes-904034341f9f?source=collection_archive---------3-----------------------#2019-04-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/486bf58cad0f640ffdc49ccc8086689e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iHjv93H0K9Ujvvg2bFbLow@2x.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://pixabay.com/de/photos/hafen-terminal-kr%C3%A4ne-2668402/" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae kf" href="https://pixabay.com/de/users/inproperstyle-617761/" rel="noopener ugc nofollow" target="_blank"> Inproperstyle </a>拍摄</figcaption></figure><p id="af23" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">近年来，没有其他技术像应用程序容器一样对它产生如此大的影响。但是它们是如何建造的呢？我将在本文中使用Knative Build组件回答这个问题，并展示如何从中受益。</p><p id="ec91" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">基于我以前的文章，我们使用了<a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/deploy-a-kubernetes-cluster-on-openstack-using-kubespray-39b230b13d62"> Kubernetes集群</a>和<a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/how-to-use-knative-on-kubernetes-to-deploy-a-serverless-application-582d62fa2a9f"> Knative安装</a>。</p><h1 id="7faa" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">Knative Build</h1><p id="2ad8" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">Knative Build组件允许您基于源代码构建容器映像。构建的图像可以由Kubernetes集群使用，例如在Knative服务组件中。它运行在集群上，由Kubernetes自定义资源定义(CRD)实现。容器映像的设计具有优化的大小，并提供更好的运行时性能。Knative Build不是一个全面的CI/CD解决方案，但允许提供可以集成到现有CI/CD解决方案中的构造块。</p><p id="03a3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Knative构建API提供了以下三种主要类型:</p><ul class=""><li id="3961" class="mh mi it ki b kj kk kn ko kr mj kv mk kz ml ld mm mn mo mp bi translated"><strong class="ki iu">构建</strong>表示一个容器映像的构建。构建由一个源和一组步骤组成。步骤可以挂载卷以在它们之间共享数据。可以通过实例化BuildTemplate来创建构建。</li><li id="8ccd" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated"><strong class="ki iu"> BuildTemplate </strong>是一个可以用来在一个名称空间内轻松创建构建的模板。</li><li id="9d22" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated"><strong class="ki iu"> ClusterBuildTemplate </strong>是一个模板，可以用来轻松地创建在整个Kubernetes集群中可用的构建。</li></ul><p id="3aca" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">目前，可以从以下三个来源获取构建数据:</p><ul class=""><li id="32ce" class="mh mi it ki b kj kk kn ko kr mj kv mk kz ml ld mm mn mo mp bi translated"><code class="fe mv mw mx my b">git</code> -一个Git仓库。</li><li id="6f76" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated"><code class="fe mv mw mx my b">gcs</code> -一个归档的Google云存储。</li><li id="e2cc" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated"><code class="fe mv mw mx my b">custom</code>——一个容器形象。</li></ul><p id="8935" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了安全使用源代码，Knative Build系统提供了两种<a class="ae kf" href="https://www.knative.dev/docs/build/auth/" rel="noopener ugc nofollow" target="_blank">身份验证类型</a>:</p><ul class=""><li id="8160" class="mh mi it ki b kj kk kn ko kr mj kv mk kz ml ld mm mn mo mp bi translated"><code class="fe mv mw mx my b">kubernetes.io/basic-auth</code>通过用户名和密码。</li><li id="ebe5" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated"><code class="fe mv mw mx my b">kubernetes.io/ssh-auth</code>通过SSH-私钥。</li></ul><h1 id="d80f" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">要求</h1><p id="97d3" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">在这个例子中，我们将基于<a class="ae kf" href="https://github.com/knative/docs/tree/master/docs/serving/samples/hello-world/helloworld-go" rel="noopener ugc nofollow" target="_blank">hello world“Golang”示例</a>构建一个容器图像。</p><p id="4c8c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">建造的另一部分将是<a class="ae kf" href="https://github.com/GoogleContainerTools/kaniko" rel="noopener ugc nofollow" target="_blank">卡尼科</a>。要从标准docker文件创建映像，通常需要交互访问docker守护进程，而守护进程本身需要机器上的root访问权限才能运行。这使得在不访问Docker守护进程的情况下，很难在Kubernetes集群上构建映像。为了解决这个问题，谷歌开发了Kaniko工具。它提供了一个执行器，可以在Kubernetes集群上运行的容器中构建容器映像。想要深入了解Kaniko技术，请点击<a class="ae kf" href="https://cloud.google.com/blog/products/gcp/introducing-kaniko-build-container-images-in-kubernetes-and-google-container-builder-even-without-root-access" rel="noopener ugc nofollow" target="_blank"> Kaniko文档链接</a>。</p><p id="a89f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们的映像构建的第二部分是访问容器注册中心，如<a class="ae kf" href="https://hub.docker.com" rel="noopener ugc nofollow" target="_blank"> Docker Hub </a>。您需要创建一个帐户并向Kubernetes提供凭据。要创建帐户，您可以点击链接到<a class="ae kf" href="https://docs.docker.com/docker-id/" rel="noopener ugc nofollow" target="_blank"> Docker Hub文档</a>。</p><h1 id="ab57" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">构建准备</h1><p id="0c77" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">现在我们可以开始为我们的Knative build提供Docker Hub凭证和服务帐户。我们必须创建两个yaml文件<code class="fe mv mw mx my b">docker-secret.yaml</code>和<code class="fe mv mw mx my b">service-account.yaml</code>。</p><p id="23de" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe mv mw mx my b">docker-secret.yaml</code>的内容，需要生成一个base64字符串作为用户名和密码。</p><figure class="na nb nc nd gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mz"><img src="../Images/fbcba3be4574f7742bb7bbd6746b9a4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KlsjZfDdL7txoaJ0rMRu6A.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">来自<a class="ae kf" href="https://github.com/meteatamel/knative-tutorial/blob/master/docs/10-dockerbuild.md" rel="noopener ugc nofollow" target="_blank"> Github </a>的<a class="ae kf" href="https://github.com/meteatamel" rel="noopener ugc nofollow" target="_blank"> Mete Atamel </a>的配置示例</figcaption></figure><p id="dc30" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要创建服务帐户，请在<code class="fe mv mw mx my b">service-account.yaml</code>中添加以下内容:</p><figure class="na nb nc nd gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ne"><img src="../Images/fa960bdf06a3c3c415d733d8735d9296.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZDNjkzMc2Nm_rl7uratgag.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">来自<a class="ae kf" href="https://github.com/meteatamel/knative-tutorial/blob/master/docs/10-dockerbuild.md" rel="noopener ugc nofollow" target="_blank"> Github </a>的<a class="ae kf" href="https://github.com/meteatamel" rel="noopener ugc nofollow" target="_blank"> Mete Atamel </a>的配置示例</figcaption></figure><p id="d635" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们准备在Kubernetes上应用文件。</p><figure class="na nb nc nd gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nf"><img src="../Images/315aac21e25590db76610e6917cf4555.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C3eOqPF9DqlnZW5gLZY_Dg.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">来自<a class="ae kf" href="https://github.com/meteatamel/knative-tutorial/blob/master/docs/10-dockerbuild.md" rel="noopener ugc nofollow" target="_blank"> Github </a>的<a class="ae kf" href="https://github.com/meteatamel" rel="noopener ugc nofollow" target="_blank"> Mete Atamel </a>的配置示例</figcaption></figure><p id="32fb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在应用之后，我们准备好查看我们构建的yaml文件。</p><h1 id="cc86" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">容器映像构建</h1><p id="417d" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">为了创建容器映像构建，我们需要一个额外的yaml文件<code class="fe mv mw mx my b">build-helloworld-go.yaml</code>,包含以下内容。我们使用Knative API端点<code class="fe mv mw mx my b">build.knative.dev/v1alpha1</code>和种类类型“Build”。yaml文件的另一个重要部分是“spec”。它包括我们之前创建的服务帐户“build-bot”的serviceAccountName。除此之外，我们还可以看到helloworld-go示例的github源代码以及描述如何使用Kaniko执行器的构建步骤。在执行程序执行后，图像被推送到Docker Hub。</p><figure class="na nb nc nd gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ng"><img src="../Images/24de3fca92b1040cfd31365e1b605a2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7vOa0-piR3j3EZlmWRQ4Rg.png"/></div></div></figure><p id="42a1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">yaml-file可以用下面的命令执行。</p><figure class="na nb nc nd gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nh"><img src="../Images/4664d6328d79b4e1ac5b34dc1d87012c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6T7dSFBNHbB0nNn97xYj_A.png"/></div></div></figure><p id="2948" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在应用命令后，我们可以通过<code class="fe mv mw mx my b">kubectl get pods</code>检查pod。</p><figure class="na nb nc nd gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ni"><img src="../Images/0c76af9929e66d978908e4c8f5ded19a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TWdmXVwAj7RoWV6JpgoVcg.png"/></div></div></figure><p id="a3b0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您还可以观察到容器映像构建的日志输出以及到Docker Hub注册表的上传。</p><figure class="na nb nc nd gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nj"><img src="../Images/1d3ef1f2e04ae7307b641a4dcdef7e0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BudS4HWF5RVx88v5MuBVgw.png"/></div></div></figure><p id="36ef" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后两行显示，我们的形象建设是成功的，这是推到Docker枢纽。<code class="fe mv mw mx my b">kubectl get pods</code>也表明我们的构建已经完成。</p><figure class="na nb nc nd gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nk"><img src="../Images/012ae470c088b2f563c71e3595c17413.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BXJFbtIB-4guD9Zb3N2FdQ.png"/></div></div></figure><h1 id="ff10" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="1517" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">这个例子展示了在Kubernetes集群上使用Knative Build和Kaniko构建容器映像并将其推入映像注册中心是多么容易。为了测试，我还使用了Open Telekom Cloud的图像注册中心，在那里需要为图像推送向yaml文件添加一个参数。下面可以看到一个改编的yaml文件。所有其他命令都不需要更改。</p><figure class="na nb nc nd gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nl"><img src="../Images/420bd2afc04be758ba418c658c4bf178.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NemW3jevy87gDLFNkEMROQ.png"/></div></div></figure><p id="a326" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">通过将image build与Knative Build集成，可以在Kubernetes集群上简单明了地映射完整的工作流。由于其模块化，构建也可以很容易地集成到现有的CI/CD管道中。在以后的文章中，我将讨论Kantive事件和流水线。</p><p id="75e5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">[1] Knative。<em class="nm"> Knative构建组件</em>:<em class="nm"/><a class="ae kf" href="https://github.com/knative/docs/blob/release-0.5/docs/reference/build.md#build" rel="noopener ugc nofollow" target="_blank">https://github . com/Knative/docs/blob/release-0.5/docs/reference/Build . MD # Build</a></p><p id="aadc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">[2] Knative。<em class="nm"> Knative构建组件</em>:<em class="nm"/><a class="ae kf" href="https://github.com/knative/docs/blob/release-0.5/docs/reference/build.md#buildtemplate" rel="noopener ugc nofollow" target="_blank">https://github . com/Knative/docs/blob/release-0.5/docs/reference/Build . MD # Build template</a></p><p id="cf58" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">[3] Knative。<em class="nm"> Knative构建组件</em>:<em class="nm"/><a class="ae kf" href="https://github.com/knative/docs/blob/release-0.5/docs/reference/build.md#clusterbuildtemplate" rel="noopener ugc nofollow" target="_blank">https://github . com/Knative/docs/blob/release-0.5/docs/reference/Build . MD # clusterbuildtemplate</a></p></div></div>    
</body>
</html>