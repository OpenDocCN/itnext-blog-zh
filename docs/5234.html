<html>
<head>
<title>.NET Decimal DataType in gRPC</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">。gRPC中的. NET十进制数据类型</h1>
<blockquote>原文：<a href="https://itnext.io/net-decimal-datatype-in-grpc-51c2ddb1c153?source=collection_archive---------3-----------------------#2021-01-18">https://itnext.io/net-decimal-datatype-in-grpc-51c2ddb1c153?source=collection_archive---------3-----------------------#2021-01-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="499c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">中的十进制数据类型的完整工作示例的分步指南。网络gRPC</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a73f807515bee8c8a7534360e07407f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y3yY8DDEAKnwcew9G3jaNw.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">图片由<a class="ae ky" href="https://pixabay.com/users/geralt-9301/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=5594879" rel="noopener ugc nofollow" target="_blank">格尔德·奥特曼</a>来自<a class="ae ky" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=5594879" rel="noopener ugc nofollow" target="_blank">皮克斯拜</a></figcaption></figure><p id="72b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你查看协议缓冲区(protobuf) <a class="ae ky" href="https://developers.google.com/protocol-buffers/docs/proto#scalar" rel="noopener ugc nofollow" target="_blank">语言指南，</a>你会看到它只支持<strong class="lb iu">浮点型</strong>和<strong class="lb iu">双精度型</strong>实数型<a class="ae ky" href="https://en.wikipedia.org/wiki/Real_number" rel="noopener ugc nofollow" target="_blank">。在大多数情况下，他们是好的。但是，如果您的部分数据包含货币值，它们就不是理想的选择，因为它们不精确。</a></p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="8ca7" class="ma mb it lw b gy mc md l me mf">&gt; 3.99d * 5<br/>19.950000000000003</span></pre><p id="c210" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们预计是19.95，但经过计算后是19.950000000000003，这就是为什么它们对货币价值没有好处。</p><blockquote class="mg mh mi"><p id="1db1" class="kz la mj lb b lc ld ju le lf lg jx lh mk lj lk ll ml ln lo lp mm lr ls lt lu im bi translated"><strong class="lb iu">为什么我的数字，比如0.1 + 0.2，加起来不是一个很好的整数0.3，而是我得到一个奇怪的结果，比如0.3000000000000004？</strong></p><p id="0690" class="kz la mj lb b lc ld ju le lf lg jx lh mk lj lk ll ml ln lo lp mm lr ls lt lu im bi translated">因为在内部，计算机使用的是一种格式(<a class="ae ky" href="https://floating-point-gui.de/formats/binary/" rel="noopener ugc nofollow" target="_blank">二进制</a> <a class="ae ky" href="https://floating-point-gui.de/formats/fp/" rel="noopener ugc nofollow" target="_blank">浮点</a>)，根本无法准确表示0.1、0.2或者0.3 <em class="it">这样的数字</em>。</p><p id="bc02" class="kz la mj lb b lc ld ju le lf lg jx lh mk lj lk ll ml ln lo lp mm lr ls lt lu im bi translated">当代码被编译或解释时，你的“0.1”已经被舍入到该格式中最接近的数字，这导致一个小的<a class="ae ky" href="https://floating-point-gui.de/errors/rounding/" rel="noopener ugc nofollow" target="_blank">舍入误差</a>，甚至在计算发生之前。<br/>——<a class="ae ky" href="https://floating-point-gui.de/basic/" rel="noopener ugc nofollow" target="_blank">https://floating-point-gui.de/basic/</a></p></blockquote><p id="952f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">C#十进制数据类型<a class="ae ky" href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/builtin-types/floating-point-numeric-types#characteristics-of-the-floating-point-types" rel="noopener ugc nofollow" target="_blank">提供28–29位数精度</a>。作为示例，请看下面的代码:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="05f2" class="ma mb it lw b gy mc md l me mf">&gt; decimal d1 = 3.99M;<br/>&gt; d1 * 5<br/>19.95</span></pre></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h2 id="6978" class="ma mb it bd mu mv mw dn mx my mz dp na li nb nc nd lm ne nf ng lq nh ni nj nk bi translated">在gRPC中为实现十进制。网</h2><p id="af92" class="pw-post-body-paragraph kz la it lb b lc nl ju le lf nm jx lh li nn lk ll lm no lo lp lq np ls lt lu im bi translated">Protobuf不支持任何类似decimal的东西，但是我们可以为它实现自定义类型！</p><blockquote class="mg mh mi"><p id="de30" class="kz la mj lb b lc ld ju le lf lg jx lh mk lj lk ll ml ln lo lp mm lr ls lt lu im bi translated"><em class="it">💡对于这个例子，我在中使用grpc的模板项目。净5。您可以通过在您想要的终端/命令行中执行</em> <code class="fe nq nr ns lw b"><em class="it">dotnet new grpc</em></code> <em class="it">来创建模板项目。</em></p></blockquote><p id="afc1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建一个新的<code class="fe nq nr ns lw b">protobuf</code>文件，在您的Protos目录中将其命名为<code class="fe nq nr ns lw b">customTypes.proto</code>,并将以下代码放入其中。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="050e" class="ma mb it lw b gy mc md l me mf">syntax = "proto3";<br/><br/>option csharp_namespace = "YourNameSpace";<br/><br/>package customTypes;<br/><br/>// Example: 12345.6789 -&gt; { units = 12345, nanos = 678900000 }<br/>message DecimalValue {<br/><br/>  // Whole units part of the amount<br/>  int64 units = 1;<br/><br/>  // Nano units of the amount (10^-9)<br/>  // Must be same sign as units<br/>  sfixed32 nanos = 2;<br/>}</span></pre><p id="de44" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开项目的<code class="fe nq nr ns lw b">csproj</code>文件，确保创建的文件配置如下:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="a059" class="ma mb it lw b gy mc md l me mf">&lt;ItemGroup&gt;<br/>    &lt;Protobuf Include="Protos\greet.proto" GrpcServices="Server"  ProtoRoot="Protos\"/&gt;<br/>  &lt;/ItemGroup&gt;<br/><br/>  &lt;ItemGroup&gt;<br/>    &lt;Protobuf Include="Protos\customTypes.proto" GrpcServices="Both" ProtoRoot="Protos\"/&gt;<br/>  &lt;/ItemGroup&gt;</span></pre><ul class=""><li id="766f" class="nt nu it lb b lc ld lf lg li nv lm nw lq nx lu ny nz oa ob bi translated">💡这实际上说明了。NET编译和生成。NET代码从您的Protobuf文件。</li><li id="c59f" class="nt nu it lb b lc oc lf od li oe lm of lq og lu ny nz oa ob bi translated">属性很重要，确保它指向你保存原型文件的地方。</li></ul><p id="0a5c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，在您想要使用十进制值的服务原型文件中，导入<code class="fe nq nr ns lw b">customTypes.proto</code>并使用如下的<code class="fe nq nr ns lw b">DecimalValue</code>类型:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="f7ec" class="ma mb it lw b gy mc md l me mf">syntax = "proto3";<br/><br/>option csharp_namespace = "YourNameSpace";<br/><br/>package greet;<br/><br/>import "customTypes.proto";<br/><br/>// The greeting service definition.<br/>service Greeter {<br/>  // Sends a greeting<br/>  rpc SayHello (HelloRequest) returns (HelloReply);<br/>}<br/><br/>// The request message containing the user's name.<br/>message HelloRequest {<br/>  string name = 1;<br/>}<br/><br/>// The response message containing the greetings.<br/>message HelloReply {<br/>  string message = 1;<br/>  customTypes.DecimalValue Value = 2;<br/>}</span></pre><p id="8961" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">之前我说过。NET Build会把你的原型文件编译成。NET代码。这个编译器的好处是它为它生成了一个分部类<a class="ae ky" href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/classes-and-structs/partial-classes-and-methods" rel="noopener ugc nofollow" target="_blank">,正因为如此，很容易扩展这个类型。</a></p><p id="05b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以在这里看到部分生成的代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh oi l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">从Protobuf生成的代码</figcaption></figure><p id="6cfb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，您需要创建一个分部类，并将其命名为我们刚刚创建的CustomType:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="830f" class="ma mb it lw b gy mc md l me mf">namespace YourNameSpace<br/>{<br/>    public partial class DecimalValue<br/>    {<br/>        private const decimal NanoFactor = 1_000_000_000;<br/>        public DecimalValue(long units, int nanos)<br/>        {<br/>            Units = units;<br/>            Nanos = nanos;<br/>        }<br/><br/>        public static implicit operator decimal(DecimalValue grpcDecimal)<br/>        {<br/>            return grpcDecimal.Units + grpcDecimal.Nanos / NanoFactor;<br/>        }<br/><br/>        public static implicit operator DecimalValue(decimal value)<br/>        {<br/>            var units = decimal.ToInt64(value);<br/>            var nanos = decimal.ToInt32((value - units) * NanoFactor);<br/>            return new DecimalValue(units, nanos);<br/>        }<br/>    }<br/>}</span></pre><p id="fd99" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用这个类中定义的<code class="fe nq nr ns lw b">implicit</code>运算符，。NET会自动将<code class="fe nq nr ns lw b">DecimalValue</code>转换为<code class="fe nq nr ns lw b">Decimal</code>和wise-verse。例如，在这个实例中，<code class="fe nq nr ns lw b">3.99M * 5</code>的十进制值被分配给一个<code class="fe nq nr ns lw b">DecimalValue</code>属性。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/fa06c0725b47bcbfe5c2b82eb8dbc9e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*cFOS4yYGmSSHpcRMkmc9Iw.gif"/></div></div></figure></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h2 id="0416" class="ma mb it bd mu mv mw dn mx my mz dp na li nb nc nd lm ne nf ng lq nh ni nj nk bi translated">结论</h2><p id="5a43" class="pw-post-body-paragraph kz la it lb b lc nl ju le lf nm jx lh li nn lk ll lm no lo lp lq np ls lt lu im bi translated">gRPC和protbuf在性能和功能方面都非常出色，并且具有不可思议的。NET支持，您可以更灵活地根据自己的需要扩展服务。</p><p id="87d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想要这个项目的完整工作示例，请随意克隆我的回购与以下地址:</p><p id="30a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://github.com/0x414c49/dotnet-grpc-decimal-example" rel="noopener ugc nofollow" target="_blank">https://github.com/0x414c49/dotnet-grpc-decimal-example</a></p></div></div>    
</body>
</html>