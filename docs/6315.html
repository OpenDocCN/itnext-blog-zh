<html>
<head>
<title>Monitoring/logging your K8S NodeJS applications using elasticsearch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用elasticsearch监控/记录K8S NodeJS应用程序</h1>
<blockquote>原文：<a href="https://itnext.io/monitoring-logging-your-k8s-nodejs-applications-using-elasticsearch-cf40dc1eac66?source=collection_archive---------3-----------------------#2021-10-15">https://itnext.io/monitoring-logging-your-k8s-nodejs-applications-using-elasticsearch-cf40dc1eac66?source=collection_archive---------3-----------------------#2021-10-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/4fbf4b9cd5f40a0a8a83797a1177fbe6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-S1GQyEpdnmWqkHC.png"/></div></div></figure><p id="8d3c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw">关于如何使用elasticsearch </em>设置登录和监控Kubernetes上的NodeJS应用程序所需的一切的快速指南</p><p id="8fd7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们最近将我们的应用程序堆栈转移到了Kubernetes。虽然我们立即受益于它的优势，但我们突然缺少NodeJS微服务的集中式应用程序级日志。以前，我们的Express API完全能够自己提供这些数据。现在，当多个pod同时运行时，聚合这些数据变得更加困难。</p><p id="ad3a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这引发了对理想工具的网络搜索，以使我们更好地了解性能以及可能发生的任何错误。鉴于我们是一家初创公司(<a class="ae kx" href="http://www.bullswap.com" rel="noopener ugc nofollow" target="_blank">www.bullswap.com</a>)，我们更倾向于一种廉价的云无关的开源解决方案，这就是我们最终选择elasticsearch (Elasticsearch，Kibana，APM Server)的原因。</p><p id="a19d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">由于Kubernetes和Elasticsearch变化如此之快，要获得正确的信息并不容易。这就是为什么我们想分享我们的最终结果如下，所以你不必去同样的麻烦。</p><p id="9c62" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">要求</strong></p><ul class=""><li id="e8ea" class="ky kz iq ka b kb kc kf kg kj la kn lb kr lc kv ld le lf lg bi translated">Kubectl访问最新的K8S集群，具有足够的容量来处理至少3GB的额外RAM使用</li><li id="117a" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">NodeJS应用程序</li></ul><p id="39d9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们在设置什么？</p><ul class=""><li id="89ad" class="ky kz iq ka b kb kc kf kg kj la kn lb kr lc kv ld le lf lg bi translated">弹性搜索集群:<a class="ae kx" href="https://www.elastic.co/" rel="noopener ugc nofollow" target="_blank">https://www.elastic.co/</a></li><li id="09de" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">Kibana:提供弹性搜索数据的可视化</li><li id="ca0f" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">APM服务器:从APM代理接收数据，并将其转换成ElasticSearch文档</li><li id="7034" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">将NodeJS服务转换成APM代理</li></ul><p id="32d3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您看到的所有代码都应该放在yaml文件中，并使用<code class="fe lm ln lo lp b">kubectl apply -f {file_name}</code>来执行</p><p id="0b36" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">设置Elasticsearch </strong> <br/>为了将所有内容与常规名称空间分开，我们首先设置一个新的名称空间。</p><figure class="lq lr ls lt gt jr"><div class="bz fp l di"><div class="lu lv l"/></div></figure><p id="adbc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们使用了在本教程<a class="ae kx" href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-elasticsearch-fluentd-and-kibana-efk-logging-stack-on-kubernetes" rel="noopener ugc nofollow" target="_blank">中找到的大量配置来建立一个包含三个statefulsets的elasticsearch服务。该设置由以下yaml文件描述:</a></p><figure class="lq lr ls lt gt jr"><div class="bz fp l di"><div class="lu lv l"/></div></figure><p id="6565" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这应该慢慢开始部署三个新的吊舱。一旦他们都开始迅速看一眼其中一个的日志，以检查一切都很好:)。</p><p id="1fd2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">设置Kibana </strong> <br/>现在是开始使用Kibana的时候了。在这里，我们需要建立一个新的服务，由kibana映像的一个副本部署组成。</p><figure class="lq lr ls lt gt jr"><div class="bz fp l di"><div class="lu lv l"/></div></figure><p id="54d3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在应用/创建yaml文件并允许pod准备就绪后，您应该能够测试它是否正常工作。<br/>您可以通过查找pod名称并将其转发到本地主机的端口来实现。</p><p id="d6af" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe lm ln lo lp b">kubectl port-forward kibana-xyz123456789 5601:5601--namespace=kube-logging</code></p><p id="d74a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">导航到<code class="fe lm ln lo lp b">localhost:5601</code>应该会显示加载Kibana界面。如果Kibana通知您没有可用的数据，您可以放心，因为这是完全正常的😊。</p><p id="4797" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当一切看起来正常时，设置一个负载平衡器/入口会很有用，这样您就可以从互联网访问Kibana。但是，如果您这样做，请确保安全措施到位。</p><p id="9f32" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">设置APM服务器</strong> <br/>我感谢<a class="ae kx" href="https://medium.com/logistimo-engineering-blog/how-did-i-use-apm-in-kubernetes-ecosystem-8f22d52beb03" rel="noopener">这篇文章</a>让我走上了正确的道路。由于它不再是最新的，您可以在下面找到我们的配置。</p><figure class="lq lr ls lt gt jr"><div class="bz fp l di"><div class="lu lv l"/></div></figure><p id="41db" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在应用/创建yaml文件并允许pod准备就绪后，您应该能够通过查看日志来测试它是否正确连接到elasticsearch。</p><p id="c81e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">最后一步:发送下面的数据</strong> <br/>应该是第一个加载到NodeJS应用程序中的<code class="fe lm ln lo lp b">require</code>。当将它添加到express服务器时，您会立即开始接收关于如何处理事务(http请求)的日志。您可以找到有用的信息，例如</p><ul class=""><li id="3e47" class="ky kz iq ka b kb kc kf kg kj la kn lb kr lc kv ld le lf lg bi translated">哪些外部服务(如数据库或API)会导致应用程序延迟。</li><li id="5770" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">哪些API调用很慢</li><li id="962f" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">错误发生的位置和频率</li><li id="9c47" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">NodeJS CPU使用率</li><li id="cfcc" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi">…</li></ul><figure class="lq lr ls lt gt jr"><div class="bz fp l di"><div class="lu lv l"/></div></figure><p id="00df" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">向您的服务器发送几个请求，您应该会看到一个服务出现在Kibana中。(Observability &gt; APM) <br/>单击它，您应该能够看到事务、吞吐量和延迟的一个很好的概览。如果由于任何原因，这种情况没有发生，我建议你看看:</p><ul class=""><li id="22a6" class="ky kz iq ka b kb kc kf kg kj la kn lb kr lc kv ld le lf lg bi translated">NodeJS日志(APM的连接问题将记录在这里)</li><li id="276d" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">APM日志(与elasticsearch相关的问题将在这里讨论)</li></ul><p id="baee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在express服务器的情况下，你经常会发现很多错误，例如发送500个错误。因此，elasticsearch不会将其视为错误。虽然您能够根据HTTP状态代码进行区分，但是在处理不成功的事件时，添加以下代码行是有意义的。这样，它将被视为一个错误。</p><p id="5657" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe lm ln lo lp b">apm.captureError(error);</code></p><p id="d85d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一定要探索Elasticsearch/Kibana/APM服务器的可能性，因为它可以做更多的事情！</p><p id="951a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们希望这篇文章对一些人有用。我们的目标是为你节省我们为<a class="ae kx" href="https://dev.toour%20construction%20equipment%20rental%20platform" rel="noopener ugc nofollow" target="_blank">https://www.bullswap.com</a>计算的时间。</p></div><div class="ab cl lw lx hu ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="ij ik il im in"><p id="b84b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw">最初发布于2021年10月15日</em><a class="ae kx" href="https://dev.to/thijsdieltjens/monitoringlogging-your-k8s-nodejs-applications-30k7" rel="noopener ugc nofollow" target="_blank"><em class="kw">https://dev . to</em></a><em class="kw">。</em></p></div></div>    
</body>
</html>