<html>
<head>
<title>Istio Control Plane Upgrades using Canary Deployments</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用金丝雀部署升级Istio控制平面</h1>
<blockquote>原文：<a href="https://itnext.io/istio-control-plane-upgrades-using-canary-deployments-1dca34df38b6?source=collection_archive---------4-----------------------#2020-08-04">https://itnext.io/istio-control-plane-upgrades-using-canary-deployments-1dca34df38b6?source=collection_archive---------4-----------------------#2020-08-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="3d90" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">合著:</em><a class="ae km" href="https://www.linkedin.com/in/omar-steitieh/" rel="noopener ugc nofollow" target="_blank"><em class="kl"/></a></p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi kn"><img src="../Images/c6dd8a3164433bb0007fe17281da7c4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2E7fCVnMs2ZTJpGQx2TN_A.jpeg"/></div></div></figure><h1 id="58ee" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">概观</h1><p id="027e" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">Istio版本1.5.x中包含了支持控制平面canary部署的新功能。本博客旨在演示此功能，以下步骤假设您已在集群中安装并运行版本1.6以上。</p><p id="ef92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">部署策略介绍；蓝绿色、淡黄色和更多颜色可以在这里找到<a class="ae km" href="https://dev.to/mostlyjason/intro-to-deployment-strategies-blue-green-canary-and-more-3a3" rel="noopener ugc nofollow" target="_blank"/></p><p id="a357" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Istio服务网格有两个主要组件:控制平面和数据平面</p><h2 id="3056" class="mc la iq bd lb md me dn lf mf mg dp lj jy mh mi ln kc mj mk lr kg ml mm lv mn bi translated">制导机</h2><p id="b926" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">控制平面负责服务发现、路由配置、提供服务对服务以及终端用户身份验证。通过维护CA和生成证书，它还允许数据平面中的安全mTLS通信。从1.5.x开始，控制平面组件被整合到一个名为istiod的服务中。</p><h2 id="366f" class="mc la iq bd lb md me dn lf mf mg dp lj jy mh mi ln kc mj mk lr kg ml mm lv mn bi translated">数据平面</h2><p id="2cf1" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">数据平面由Envoy代理组成，这些代理作为侧柜部署到集群中每个支持Istio的pod。它们拦截来自pod中主容器的任何传入或传出请求有两个目的；首先，它们提供加密，控制pod之间的通信，其次，它们提供所有网络流量的遥测。</p><p id="1854" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将部署第二个Istio控制平面，用于管理名称空间中的金丝雀流量。</p><h1 id="c81b" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">入门指南</h1><h2 id="7a6f" class="mc la iq bd lb md me dn lf mf mg dp lj jy mh mi ln kc mj mk lr kg ml mm lv mn bi translated">制导机</h2><p id="e338" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">您当前正在运行一个现有的Istio控制平面。要部署金丝雀控制平面，您必须设置<code class="fe mo mp mq mr b">revision</code>字段。这可以使用istioctl CLI工具安装方法或通过使用istio-operator来完成。</p><p id="ec88" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">组织示例:</em></p><pre class="ko kp kq kr gt ms mr mt mu aw mv bi"><span id="c3ba" class="mc la iq mr b gy mw mx l my mz">istioctl install --set revision=canary</span></pre><p id="6f66" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当使用istioctl安装Istio时，除非另外指定，否则将自动应用默认概要文件，要使用自定义概要文件，我们的首选方法是使用IstioOperator资源进行部署。可在此处<a class="ae km" href="https://istio.io/latest/docs/setup/additional-setup/config-profiles/" rel="noopener ugc nofollow" target="_blank">查看预先配置的配置文件。</a></p><p id="8d39" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl"> istio运算符示例:</em></p><pre class="ko kp kq kr gt ms mr mt mu aw mv bi"><span id="7746" class="mc la iq mr b gy mw mx l my mz">apiVersion: install.istio.io/v1alpha1<br/>kind: <a class="ae km" href="https://istio.io/latest/docs/reference/config/istio.operator.v1alpha1/" rel="noopener ugc nofollow" target="_blank">IstioOperator</a><br/>metadata:<br/>  name: istio-canary<br/>  namespace: istio-system<br/>spec:<br/>  ...  <br/>  revision: canary<br/>  ...</span></pre><p id="ac42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">注意:IstioOperator可用的选项可以在</em> <a class="ae km" href="https://istio.io/latest/docs/reference/config/istio.operator.v1alpha1/" rel="noopener ugc nofollow" target="_blank"> <em class="kl">这里</em> </a>查看</p><p id="c431" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦应用，将创建第二个控制平面。现有版本和canary版本都将在集群中运行。</p><pre class="ko kp kq kr gt ms mr mt mu aw mv bi"><span id="34ab" class="mc la iq mr b gy mw mx l my mz">NAME                           READY   STATUS    RESTARTS  AGE<br/>istiod-7f7d5496cf-ltff2         1/1    Running   0        5m45s<br/>istiod-canary-7f7d5496cf-ltff2  1/1    Running   0          15s</span></pre><p id="335b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当canary istiod pod运行时，值得一提的是,<code class="fe mo mp mq mr b">ingress</code>和<code class="fe mo mp mq mr b">egress</code>网关pod都将升级到新版本，旧的pod将被终止——这令人惊讶，因为现在群集中的所有数据平面代理都不具备版本奇偶校验。因此，<strong class="jp ir">强烈建议</strong>检查版本之间的变更日志！</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h2 id="72ae" class="mc la iq bd lb md me dn lf mf mg dp lj jy mh mi ln kc mj mk lr kg ml mm lv mn bi translated">数据平面</h2><p id="ed58" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">创建金丝雀控制平面对数据平面没有影响。要将你的边车<code class="fe mo mp mq mr b">istio-proxy</code>升级到新版控制面板，请采取以下步骤。</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/499baf1b0d5b120152fcf16607292210.png" data-original-src="https://miro.medium.com/v2/resize:fit:846/format:webp/1*YF8AmJl73UnkDBW-o_if0w.png"/></div></figure><p id="e63c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">移除现有的名称空间标签<code class="fe mo mp mq mr b">istio-injection</code>并添加新标签<code class="fe mo mp mq mr b">istio.io/rev=canary</code>。</p><p id="1b98" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这可以通过以下命令完成:</p><pre class="ko kp kq kr gt ms mr mt mu aw mv bi"><span id="353d" class="mc la iq mr b gy mw mx l my mz">kubectl label namespace &lt;namespace&gt; istio-injection- istio.io/rev=canary</span></pre><p id="40d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">注意:必须删除</em> <code class="fe mo mp mq mr b"><em class="kl">istio-injection</em></code> <em class="kl">标签，因为为了向后兼容，它优先于</em> <code class="fe mo mp mq mr b"><em class="kl">istio.io/rev</em></code> <em class="kl">标签。</em></p><p id="76bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">更新名称空间标签后，您需要重启pod以触发重新进样:</p><pre class="ko kp kq kr gt ms mr mt mu aw mv bi"><span id="5b3c" class="mc la iq mr b gy mw mx l my mz">kubectl rollout restart deployment -n &lt;namespace&gt;</span></pre><p id="18bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦吊舱被重新创建，它们将被配置为指向新的canary Istio控制平面。</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/84fb39acad0a2c24fdd3ed3704e064a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:846/format:webp/1*u5dx4BFYnK_lk6K9GA29HA.png"/></div></figure><p id="a3e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过对其中一个重新启动的pod运行以下命令，确认pod现在正在使用Istio控制面板的canary版本:</p><pre class="ko kp kq kr gt ms mr mt mu aw mv bi"><span id="60a8" class="mc la iq mr b gy mw mx l my mz">$ istioctl proxy-config endpoints &lt;pod&gt;.&lt;namespace&gt; --cluster xds-grpc -ojson | grep hostname</span></pre><p id="943d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">预期产出:</p><p id="cd8f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mo mp mq mr b"><em class="kl">“hostname”: “istiod-canary.istio-system.svc”</em></code></p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/05ddbf00e477d779a29d01850bf09458.png" data-original-src="https://miro.medium.com/v2/resize:fit:846/format:webp/1*j6vDThwFdq8oSk7iq7M4IQ.png"/></div></figure><p id="e844" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在成功测试新的控制面板版本后，继续使用相同的方法将升级推广到其余的集群工作负载。</p><h1 id="6c3e" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">摘要</h1><p id="281b" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">选择使用Istio canary发行版时需要考虑的要点:</p><ul class=""><li id="4f92" class="ni nj iq jp b jq jr ju jv jy nk kc nl kg nm kk nn no np nq bi translated"><strong class="jp ir">推广canary版本</strong> —我们建议使用该版本作为修订版。这使得每个命名空间都具有所使用的控制平面版本的显式标签。</li><li id="0fad" class="ni nj iq jp b jq nr ju ns jy nt kc nu kg nv kk nn no np nq bi translated"><strong class="jp ir">潜在停机时间</strong> —必须考虑<code class="fe mo mp mq mr b">ingress</code>和<code class="fe mo mp mq mr b">egress</code>网关。<code class="fe mo mp mq mr b">istio-proxy</code> sidecars之间可能的版本差异可能会引入影响代理流量的重大变化，并需要重新部署之前的控制平面。</li><li id="c90c" class="ni nj iq jp b jq nr ju ns jy nt kc nu kg nv kk nn no np nq bi translated"><strong class="jp ir">采用前验证修订版</strong> —如果出现问题，重新启动名称空间中的所有pod可能会造成很大的影响。考虑扩展部署，以测试与新控制面板版本通信的新pod。</li></ul><p id="3649" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">注意:本文中的所有内容都是使用Istio 1.6.5在我们的Raspberry Pi Kubernetes集群上测试的，该集群是使用</em><a class="ae km" href="https://github.com/raspbernetes" rel="noopener ugc nofollow" target="_blank"><em class="kl">raspberretes</em></a><em class="kl">项目构建的。</em></p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><p id="cadd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你觉得这有用吗？发表评论或给我们点赞！</p></div></div>    
</body>
</html>