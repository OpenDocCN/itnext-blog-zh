<html>
<head>
<title>AWS Windows Kubernetes Nodes with kops</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS Windows Kubernetes带kop的节点</h1>
<blockquote>原文：<a href="https://itnext.io/aws-windows-kubernetes-nodes-with-kops-a2accb9ea483?source=collection_archive---------4-----------------------#2019-03-26">https://itnext.io/aws-windows-kubernetes-nodes-with-kops-a2accb9ea483?source=collection_archive---------4-----------------------#2019-03-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="72d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如何为Kubernetes集群创建kops管理的Windows节点。</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div class="ab gu cl kq"><img src="../Images/95925c416fa80e150213c98c12add27b.png" data-original-src="https://miro.medium.com/v2/format:webp/1*HkNEavL1N_5IHv2wsvK9uA.jpeg"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">我们回来是为了让这变得稍微容易一点！</figcaption></figure><p id="ce21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我首先声明，这或多或少是我几周前写的一篇文章的后续文章。本文的目的是分享我是如何创建一个完全可管理和可操作的kops Windows实例组的。本文还将强调上一篇文章中提到的一些错误/失误，主要是纠正使用<code class="fe ky kz la lb b">l2bridge</code>法兰绒网络解决方案而不是<code class="fe ky kz la lb b">overlay</code>法兰绒解决方案。</p><p id="ea7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本文将对您的设置做一些假设和/或限制:<br/> 1)您正在使用，或将需要在<code class="fe ky kz la lb b">overlay</code>(也称为<code class="fe ky kz la lb b">vxlan</code>)模式下使用法兰绒，我无法让<code class="fe ky kz la lb b">host-gw</code>模式正常工作。你的kops管理的AWS集群使用S3作为后端。你正在使用至少是<code class="fe ky kz la lb b">1.14.0</code>的Kubernetes版本。<br/> 4)你需要使用Windows 1809，因为<code class="fe ky kz la lb b">overlay</code>无法在任何更低版本的Windows上运行。</p><p id="a472" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所有这些问题都解决了，让我们开始吧。</p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="a48d" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">集群设置</h1><p id="2583" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">如果您还没有kops管理的AWS Kubernetes集群，请创建一个。此时唯一重要的集群创建参数是您的Kubernetes版本<code class="fe ky kz la lb b">1.14.0+</code>和您的网络插件<code class="fe ky kz la lb b">flannel</code>。继续运行您的集群，确保一切正常。</p><p id="c024" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您的集群没有在<code class="fe ky kz la lb b">1.14</code>上出现，那么您很可能需要在<code class="fe ky kz la lb b">kubeAPIServer</code>下设置您的<code class="fe ky kz la lb b">admissionControl</code>。这是因为kops还不支持<code class="fe ky kz la lb b">1.14</code>，所以我们需要手动设置。</p><pre class="kl km kn ko gt mm lb mn mo aw mp bi"><span id="6783" class="mq lk iq lb b gy mr ms l mt mu">kubeAPIServer:<br/>  admissionControl:<br/>  - NamespaceLifecycle<br/>  - LimitRanger<br/>  - ServiceAccount<br/>  - PersistentVolumeLabel<br/>  - DefaultStorageClass<br/>  - ResourceQuota<br/>  - DefaultTolerationSeconds</span></pre><p id="fb37" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦您的集群启动，我们将需要对我们的法兰绒DaemonSet和配置进行一些小的修改。编辑您的法兰绒DaemonSet，<code class="fe ky kz la lb b">kubectl edit ds -n kube-system kube-flannel-ds</code>如果您使用所有默认设置，并在DaemonSet的<code class="fe ky kz la lb b">nodeSelector</code>下添加<code class="fe ky kz la lb b">kubernetes.io/os: linux</code>。这将防止法兰绒容器被调度到我们的Windows节点上。</p><pre class="kl km kn ko gt mm lb mn mo aw mp bi"><span id="2851" class="mq lk iq lb b gy mr ms l mt mu">...<br/>nodeSelector:<br/>  beta.kubernetes.io/arch: amd64<br/>  kubernetes.io/os: linux<br/>...</span></pre><p id="2b73" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们不希望在Windows节点上使用法兰绒容器的原因很简单，因为它们无法工作，我们需要在Windows节点上运行法兰绒，同时运行kubelet和kube-proxy服务。</p><p id="f82a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦您的DaemonSet被修改，我们需要对法兰绒的配置做一些细微的更改，它由两个文件<code class="fe ky kz la lb b">cni-conf.json</code>和<code class="fe ky kz la lb b">net-conf.json</code>组成。这两者都在<code class="fe ky kz la lb b">kube-system</code>名称空间下的<code class="fe ky kz la lb b">kube-flannel-cfg</code>配置图中定义。这些文件应该类似于下面的文件，除了<code class="fe ky kz la lb b">net-conf.json</code>的<code class="fe ky kz la lb b">Network</code>字段，对于您的集群可能有所不同:</p><pre class="kl km kn ko gt mm lb mn mo aw mp bi"><span id="9dd0" class="mq lk iq lb b gy mr ms l mt mu">apiVersion: v1<br/>data:<br/>  cni-conf.json: |<br/>    {<br/>      "name": "vxlan0",<br/>      "type": "flannel",<br/>      "delegate": {<br/>        "forceAddress": true,<br/>        "isDefaultGateway": true,<br/>        "hairpinMode": true<br/>      }<br/>    }<br/>  net-conf.json: |-<br/>    {<br/>      "Network": "100.64.0.0/10",<br/>      "Backend": {<br/>        "Name": "vxlan0",<br/>        "Type": "vxlan",<br/>        "VNI": 4096,<br/>        "Port": 4789<br/>    }<br/>  }<br/>kind: ConfigMap<br/>...</span></pre><p id="8947" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您对法兰绒设置的更改现已完成，但我们还需要完成一项任务，以便法兰绒在Windows上正常工作。法兰绒使用分配给DaemonSet中每个法兰绒Pod的法兰绒服务帐户向Kubernetes进行认证。但是，法兰绒不会在我们的Windows节点上作为Pod运行，所以我们需要为Windows节点生成一个kubeconfig文件，以便从kops S3州存储中提取，供法兰绒使用。</p><p id="0993" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我不会在这里深入讨论如何为ServiceAccount生成kubeconfig文件，但是如果您需要一些指导，我会参考<a class="ae kx" href="https://github.com/zlabjp/kubernetes-scripts/blob/master/create-kubeconfig" rel="noopener ugc nofollow" target="_blank">这个脚本</a>。或者，如果你懒的话，你也可以把你的管理库配置文件复制到S3州立存储中，供Windows调用。这显然是一个安全风险，但是如果您只是为了一个概念验证项目而遵循这一点，那就没问题了。</p><p id="987c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">法兰绒的kubeconfig需要放在您的集群的基本S3前缀下的<code class="fe ky kz la lb b">serviceaccount/flannel.kcfg</code>下。默认kops状态存储设置下的完整路径应该类似于<code class="fe ky kz la lb b">s3://$BUCKET/clusterconfigs/$CLUSTER/serviceaccount/flannel.kcfg</code>。</p><p id="e8d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我们需要为节点添加一些额外的角色策略，以便Windows节点的启动脚本可以正常工作。我们的Windows节点需要能够读取AWS EC2标签，以及能够读取我们刚刚上传的法兰绒服务帐户文件:</p><pre class="kl km kn ko gt mm lb mn mo aw mp bi"><span id="53b7" class="mq lk iq lb b gy mr ms l mt mu">additionalPolicies:<br/>  node: |<br/>    [<br/>      {<br/>        "Effect": "Allow",<br/>        "Action": ["ec2:DescribeTags"],<br/>        "Resource": ["*"]<br/>      },<br/>      {<br/>        "Effect": "Allow",<br/>        "Action": ["s3:*"],<br/>        "Resource": [<br/>          "arn:aws:s3:::$BUCKET/clusterconfigs/$CLUSTER/serviceaccount/flannel.kcfg"<br/>        ]<br/>      }<br/>    ]</span></pre><p id="35ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">kops管理的Kubernetes集群的设置到此结束，现在是实际创建Windows InstanceGroup的时候了。如果您还没有这样做，请继续将更改应用到集群，并执行滚动更新，以确保一切正常进行。</p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="b472" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">Windows节点安装程序</h1><p id="1781" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">这是容易的部分，因为Windows节点的配置相当简单。第一步是确定您需要使用的AMI的id。显然，它需要是一个Windows映像，但更重要的是，它需要是版本1809。理论上，启动脚本可以在任何Windows 1809版本上运行，但是我只在带有容器映像的基本1809上测试过。</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/d2f4b5ed82ac66e19e1f0f1ccb5c8e3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1362/format:webp/1*xmZonKiPoNz2yUKvxK51aw.png"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">服务器1809与容器，您的AMI id可能会有所不同，由于不同的地区。</figcaption></figure><p id="9188" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我们需要添加一些自定义用户数据。Kops实际上会为这个实例组生成用户数据，但是Windows将不能使用这些数据。我们已经在PowerShell中编写了我们自己的“nodeup”脚本，它将安装所有需要的服务并正确启动Windows节点，所以在<code class="fe ky kz la lb b">additionalUserData</code>下，我们只需要添加:</p><pre class="kl km kn ko gt mm lb mn mo aw mp bi"><span id="1a59" class="mq lk iq lb b gy mr ms l mt mu">additionalUserData:<br/>- content: |<br/>    &lt;powershell&gt;<br/>      wget <a class="ae kx" href="https://raw.githubusercontent.com/ccpgames/platform-kube-windows-nodeup/master/powershell/Kubernetes/nodeup.ps1" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/ccpgames/platform-kube-windows-nodeup/master/powershell/Kubernetes/nodeup.ps1</a> -OutFile c:/nodeup.ps1<br/>      c:/nodeup.ps1<br/>    &lt;/powershell&gt;<br/>name: nodeup<br/>type: text/cloud-config</span></pre><p id="ed0e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦设置了用户数据，您就可以开始部署Windows节点了！保存更改并更新集群。我们发现，使用这个脚本，一个Windows节点加入集群只需要不到四分钟的时间。</p><p id="f2d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这些节点将填充有几个节点标签和两个节点污点，一个用于操作系统，另一个用于操作系统的版本。这些污点的自动分配可以通过给nodeup.ps1脚本的<code class="fe ky kz la lb b">AutoGenerateWindowsTaints</code>一个假标志来禁用。如果你想这样做，你的<code class="fe ky kz la lb b">additionalUserData</code>将类似于下面的方块。</p><pre class="kl km kn ko gt mm lb mn mo aw mp bi"><span id="c1f2" class="mq lk iq lb b gy mr ms l mt mu">additionalUserData:<br/>- content: |<br/>  &lt;powershell&gt;<br/>    wget <a class="ae kx" href="https://raw.githubusercontent.com/ccpgames/platform-kube-windows-nodeup/master/powershell/Kubernetes/nodeup.ps1" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/ccpgames/platform-kube-windows-nodeup/master/powershell/Kubernetes/nodeup.ps1</a> -OutFile c:/nodeup.ps1<br/>    c:/nodeup.ps1 -AutoGenerateWindowsTaints:$false<br/>  &lt;/powershell&gt;<br/>name: nodeup<br/>type: text/cloud-config</span></pre><p id="d88b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">注意</strong>:nodeup . PS1脚本中可能还有一些漏洞，所以如果你发现有些地方不适合你，请在这里<a class="ae kx" href="https://github.com/ccpgames/platform-kube-windows-nodeup" rel="noopener ugc nofollow" target="_blank">创建一个问题或请求项目。</a></p></div></div>    
</body>
</html>