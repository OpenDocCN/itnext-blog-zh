<html>
<head>
<title>AWS: Route53 Private Hosted Zones — hiding domains from the Internet</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS: Route53私有托管区域—对互联网隐藏域</h1>
<blockquote>原文：<a href="https://itnext.io/aws-route53-private-hosted-zones-hiding-domains-from-the-internet-2e4bcdb780d8?source=collection_archive---------7-----------------------#2021-07-26">https://itnext.io/aws-route53-private-hosted-zones-hiding-domains-from-the-internet-2e4bcdb780d8?source=collection_archive---------7-----------------------#2021-07-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/4db53edc2d31ceaf0cc5efaa8b7bac60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8QppZuMnRQSngTE4H4UqzA.png"/></div></div></figure><p id="bfbc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">AWS Route53中的<a class="ae kw" href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/hosted-zones-private.html" rel="noopener ugc nofollow" target="_blank">私有托管区域</a>允许限制对域的DNS记录的访问，从而使<a class="ae kw" href="https://resources.infosecinstitute.com/topic/dns-enumeration-techniques-in-linux/" rel="noopener ugc nofollow" target="_blank"> DNS枚举</a>(或DNS蛮力)无法访问，当攻击者检查域中的可用记录以了解端点列表来检查它们的漏洞时。</p><p id="0de1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于这样的攻击，有很多实用程序如<a class="ae kw" href="https://github.com/fwaeytens/dnsenum" rel="noopener ugc nofollow" target="_blank"> DNSEnum </a>、<a class="ae kw" href="https://github.com/darkoperator/dnsrecon" rel="noopener ugc nofollow" target="_blank"> DNSRecon </a>、<a class="ae kw" href="http://ha.ckers.org/fierce/" rel="noopener ugc nofollow" target="_blank">凶</a>，甚至还有一个众所周知的带有<code class="fe kx ky kz la b"><a class="ae kw" href="https://nmap.org/nsedoc/scripts/dns-brute.html" rel="noopener ugc nofollow" target="_blank">dns-brute</a></code>脚本的Nmap。</p><p id="74fd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用私有域区域的想法是，只能从AWS帐户中有限的一组VPC内部访问它们，但不能从Internet访问它们。</p><h1 id="2a98" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">AWS VPC DNS</h1><p id="8966" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">首先，让我们检查一下DNS在AWS VPC是如何工作的:在每个VPC中，我们都有一个地址<em class="me"> *.0.1 </em> —这是它的网关，另一个地址是<em class="me"> *.0.2 </em> —这是VPC的默认DNS。</p><p id="fdbf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，我们有一个10.0.6.0/24 CIDR的VPC。因此，对于此VPC，我们可以访问10.0.6.2以获取有关域的信息:</p><pre class="mf mg mh mi gt mj la mk ml aw mm bi"><span id="733f" class="mn lc iq la b gy mo mp l mq mr">admin@bttrm-stage-console:~$ dig @10.0.6.2 ya.ru +short<br/>87.250.250.242</span></pre><p id="0d7d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是AWS VPC中服务的默认DNS，尽管您可以自己配置。</p><p id="153b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我们的例子中，我们在一些旧服务器上运行<code class="fe kx ky kz la b">dnsmasq</code>,应用程序首先会尝试从中获取信息，然后才会转到VPC的DNS:</p><pre class="mf mg mh mi gt mj la mk ml aw mm bi"><span id="a86d" class="mn lc iq la b gy mo mp l mq mr">admin@bttrm-stage-console:~$ cat /etc/resolv.conf<br/>domain us-east-2.compute.internal<br/>search us-east-2.compute.internal<br/>nameserver 127.0.0.1<br/>nameserver 10.0.6.2<br/>nameserver 1.1.1.1</span></pre><p id="30e3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更多信息请参见<a class="ae kw" href="https://rtfm.co.ua/dns-ustanovka-bind-dns-load-balancing-i-network-based-routing-cherez-view/#DNS_AWS" rel="noopener ugc nofollow" target="_blank"> DNS: установка BIND、DNS负载平衡и基于网络的路由через视图</a>和<a class="ae kw" href="https://rtfm.co.ua/dns-dnsmasq-i-poryadok-razresheniya-domyon-iz-resolv-conf/" rel="noopener ugc nofollow" target="_blank">DNS:DNS masqипорядокразрешениядомёнизresolv . conf</a>帖子(均为俄语)或文档— <a class="ae kw" href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/resolver.html" rel="noopener ugc nofollow" target="_blank">解析VPC和您的网络之间的DNS查询</a>。</p><p id="d645" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请记住，要使VPC中的DNS正常工作，该VPC必须启用选项<code class="fe kx ky kz la b">enableDnsHostnames</code>和<code class="fe kx ky kz la b">enableDnsSupport</code>。此外，Route 53健康检查和路由策略也有一些限制。更多信息请参见<a class="ae kw" href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/hosted-zone-private-considerations.html" rel="noopener ugc nofollow" target="_blank">使用私有托管区域</a>时的注意事项。</p><h1 id="a0d2" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">AWS路由53私有托管区域</h1><p id="cf36" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">现在，当我们知道了AWS VPC中的DNS是如何工作的，让我们创建一个专用DNS区域。</p><p id="eaa8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">转到Route53，创建一个新区域，将其类型设置为<em class="me">私有托管区域</em>:</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/98a49c1837a6ec935c9660d2bb9d720e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0h2Ck3kzn5O2EquU.png"/></div></div></figure><p id="fe70" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面，您将看到可用于选择AWS区域和其中的VPC的新选项，从这里可以访问该DNS区域:</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/650325f8da3d95d35de38420951f3f7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IGQ77mxPq8ZzFJp8.png"/></div></div></figure><p id="c9bc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，当创建区域时，在其中添加一些记录:</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mt"><img src="../Images/6852b5f209fcf1d5fdd35c6e4171d2f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dJKMZQsHp73rIfV7.png"/></div></div></figure><p id="272f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，让我们添加一条记录，该记录将被指向我们的一个临时服务器—<em class="me">app 1 . stage . mobilebackend . BM . local</em>:</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/608d16b41525156254a77bf233e2afbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hU6lL7pUiyqzwYk5.png"/></div></div></figure><p id="3f55" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并检查它是否可用于位于VPC的另一个临时服务器:</p><pre class="mf mg mh mi gt mj la mk ml aw mm bi"><span id="3ba7" class="mn lc iq la b gy mo mp l mq mr">admin@bttrm-stage-console:~$ dig app1.stage.mobilebackend.bm.local +short<br/>10.0.6.68</span></pre><p id="86e1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者使用<code class="fe kx ky kz la b"><a class="ae kw" href="https://linux.die.net/man/8/dnstracer" rel="noopener ugc nofollow" target="_blank">dnstracer</a></code>实用程序:</p><pre class="mf mg mh mi gt mj la mk ml aw mm bi"><span id="2d4e" class="mn lc iq la b gy mo mp l mq mr">admin@bttrm-stage-console:~$ dnstracer app1.stage.mobilebackend.bm.localTracing to app1.stage.mobilebackend.bm.local[a] via 10.0.6.2, maximum of 3 retries<br/>10.0.6.2 (10.0.6.2) Got answer</span></pre><p id="830e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们从10 . 0 . 6 . 2——VPC DNS服务器——那里得到了我们的响应，正如我们所料。</p><p id="8a9f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，试着从办公室到达这个区域:</p><pre class="mf mg mh mi gt mj la mk ml aw mm bi"><span id="47ce" class="mn lc iq la b gy mo mp l mq mr">15:06:02 [setevoy@setevoy-arch-work ~] $ dig app1.stage.mobilebackend.bm.local<br/>; &lt;&lt;&gt;&gt; DiG 9.16.18 &lt;&lt;&gt;&gt; app1.stage.mobilebackend.bm.local<br/>;; global options: +cmd<br/>;; Got answer:<br/>;; WARNING: .local is reserved for Multicast DNS<br/>;; You are currently testing what happens when an mDNS query is leaked to DNS<br/>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NXDOMAIN, id: 27027<br/>;; flags: qr rd ra ad; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1<br/>;; OPT PSEUDOSECTION:<br/>; EDNS: version: 0, flags:; udp: 512<br/>;; QUESTION SECTION:<br/>;app1.stage.mobilebackend.bm.local. IN A</span></pre><p id="66c6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">全世界对这个DNS区域一无所知。</p><p id="3262" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">顺便说一句，可以将相同的DNS区域创建为公共和私有，即所谓的“拆分视图DNS”。参见<a class="ae kw" href="https://aws.amazon.com/ru/premiumsupport/knowledge-center/internal-version-website/" rel="noopener ugc nofollow" target="_blank">如何使用Route 53访问我的网站的内部版本，该版本使用与我的公共网站相同的域名？</a> и <a class="ae kw" href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/hosted-zone-private-considerations.html#hosted-zone-private-considerations-split-view-dns" rel="noopener ugc nofollow" target="_blank">拆分视图DNS </a>。</p><p id="c670" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成了。</p></div><div class="ab cl mv mw hu mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ij ik il im in"><p id="f385" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="me">最初发布于</em> <a class="ae kw" href="https://rtfm.co.ua/en/aws-route53-private-hosted-zones-hiding-domains-from-the-internet/" rel="noopener ugc nofollow" target="_blank"> <em class="me"> RTFM: Linux、DevOps、系统管理</em> </a> <em class="me">。</em></p></div></div>    
</body>
</html>