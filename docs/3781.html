<html>
<head>
<title>Jenkins-X Istio Flagger Canary Deployment</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">詹金斯-X Istio弗拉格加那利部署</h1>
<blockquote>原文：<a href="https://itnext.io/jenkins-x-istio-flagger-canary-deployment-9d5e187c2334?source=collection_archive---------2-----------------------#2020-02-24">https://itnext.io/jenkins-x-istio-flagger-canary-deployment-9d5e187c2334?source=collection_archive---------2-----------------------#2020-02-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2b38" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">我们使用Jenkins X的方式将金丝雀部署到Kubernetes集群中</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4abbbf22130dac68843d78a5cc5ca4c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yfK29TbgrIhralvpZzKPDw.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/photos/4NZlogMPIp0" rel="noopener ugc nofollow" target="_blank">https://unsplash.com/photos/4NZlogMPIp0</a></figcaption></figure><h2 id="c1e4" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">部件</h2><ol class=""><li id="15a1" class="lv lw it lx b ly lz ma mb li mc lm md lq me mf mg mh mi mj bi translated"><a class="ae ky" href="https://medium.com/@wuestkamp/kubernetes-canary-deployment-1-gitlab-ci-518f9fdaa7ed?" rel="noopener">用GitlabCI+GitOps/人工进近展开金丝雀</a></li><li id="9a62" class="lv lw it lx b ly mk ma ml li mm lm mn lq mo mf mg mh mi mj bi translated"><a class="ae ky" href="https://codeburst.io/kubernetes-canary-deployment-2-argo-rollouts-5e68e99b4fa3?source=friends_link&amp;sk=58557d4fa81ff77382e59e1258c06d61" rel="noopener" target="_blank">金丝雀部署与阿尔戈推出</a></li><li id="c773" class="lv lw it lx b ly mk ma ml li mm lm mn lq mo mf mg mh mi mj bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/kubernetes-istio-canary-deployment-5ecfd7920e1c?source=friends_link&amp;sk=2be48393ac175a2199bf5d486cb91acf">使用Istio进行金丝雀部署</a></li><li id="820a" class="lv lw it lx b ly mk ma ml li mm lm mn lq mo mf mg mh mi mj bi translated">(本文)</li></ol><h1 id="91c0" class="mp la it bd lb mq mr ms le mt mu mv lh jz mw ka ll kc mx kd lp kf my kg lt mz bi translated">我们在这里做什么？</h1><p id="be49" class="pw-post-body-paragraph na nb it lx b ly lz ju nc ma mb jx nd li ne nf ng lm nh ni nj lq nk nl nm mf im bi translated">我们将逐步创建一个Jenkins X k8s集群和一个Python测试应用程序。您可以跟随或只是阅读，查看图像和结果，了解JenkinsX+Flagger+Istio Canary部署工作流，并决定是否值得深入研究。</p><h2 id="f485" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">金丝雀部署</h2><p id="9711" class="pw-post-body-paragraph na nb it lx b ly lz ju nc ma mb jx nd li ne nf ng lm nh ni nj lq nk nl nm mf im bi translated"><a class="ae ky" href="https://medium.com/@wuestkamp/kubernetes-canary-deployment-1-gitlab-ci-518f9fdaa7ed?source=friends_link&amp;sk=4f3b424099f4f973f634bda75e397254" rel="noopener">请务必阅读第1部分</a>，其中我们简要解释了什么是金丝雀部署。在那里，我们还展示了如何使用普通的Kubernetes资源来实现它们。</p><h2 id="7508" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">詹金斯X</h2><p id="69ae" class="pw-post-body-paragraph na nb it lx b ly lz ju nc ma mb jx nd li ne nf ng lm nh ni nj lq nk nl nm mf im bi translated">这篇文章假设你已经对Jenkins X有所了解，否则你可以在这里做。</p><h2 id="6543" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">伊斯迪奥</h2><p id="fa87" class="pw-post-body-paragraph na nb it lx b ly lz ju nc ma mb jx nd li ne nf ng lm nh ni nj lq nk nl nm mf im bi translated">本文假设您已经知道Istio是什么。如果你还不知道，你可以<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/kubernetes-istio-simply-visually-explained-58a7d158b83f?source=friends_link&amp;sk=378ed718d2d6cfd09e6d23c7616cba81">看看这个</a>。为了更好地理解，您还应该阅读第3部分,其中我们使用了简单的Istio进行Canary部署。</p><h2 id="c074" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">野生鸢尾花</h2><blockquote class="nn no np"><p id="3e5c" class="na nb nq lx b ly nr ju nc ma ns jx nd nt nu nf ng nv nw ni nj nx ny nl nm mf im bi translated">Flagger是一家Kubernetes运营商，使用Istio、Linkerd、App Mesh、NGINX、Contour或Gloo路由实现流量转移，并使用Prometheus metrics进行金丝雀分析，从而自动推广金丝雀部署。canary分析可以用webhooks扩展，用于运行验收测试、负载测试或任何其他定制验证。(<a class="ae ky" href="https://github.com/weaveworks/flagger" rel="noopener ugc nofollow" target="_blank">来源</a>)</p></blockquote><h1 id="5b35" class="mp la it bd lb mq mr ms le mt mu mv lh jz mw ka ll kc mx kd lp kf my kg lt mz bi translated">创建测试基础设施和应用程序</h1><p id="52ab" class="pw-post-body-paragraph na nb it lx b ly lz ju nc ma mb jx nd li ne nf ng lm nh ni nj lq nk nl nm mf im bi translated">我们将使用Jenkins X命令行工具<code class="fe nz oa ob oc b">jx</code>创建一个Kubernetes集群、Github存储库和一个quickstart应用程序。这对于快速原型制作非常有用。</p><h2 id="1af8" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">詹金斯X k8s星团</h2><p id="1ca1" class="pw-post-body-paragraph na nb it lx b ly lz ju nc ma mb jx nd li ne nf ng lm nh ni nj lq nk nl nm mf im bi translated">首先我们创建一个Jenkins X集群，这里我们使用Gcloud:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="2fe6" class="kz la it oc b gy oh oi l oj ok">jx create cluster gke -n jenkinsx --machine-type n1-standard-4</span></pre><p id="43ca" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">你应该选择“无服务器Jenkins X Pipelines with Tekton”类型，用你的Github账户连接所有东西。这将自动为登台和生产环境创建两个Github存储库。</p><p id="4ec5" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">接下来，我们安装一些插件:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="2a7b" class="kz la it oc b gy oh oi l oj ok">jx create addon istio<br/>jx create addon flagger<br/>jx create addon prometheus</span></pre><p id="1214" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">如果您遇到Istio不工作的问题(我在Prometheus中丢失了<code class="fe nz oa ob oc b">istio_requests_total</code>指标),那么您可以手动安装Istio:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="dcf0" class="kz la it oc b gy oh oi l oj ok">istioctl manifest generate --set values.kiali.enabled=true --set values.tracing.enabled=true --set values.grafana.enabled=true --set values.prometheus.enabled=true &gt; istio.yaml</span><span id="f12a" class="kz la it oc b gy ol oi l oj ok">kubectl -f istio.yaml install</span></pre><p id="fb73" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">通过<code class="fe nz oa ob oc b">jx</code>安装的Flagger将自动启用命名空间<code class="fe nz oa ob oc b">jx-production</code>中的Istio边车注入。为了证实这一点:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="0ef3" class="kz la it oc b gy oh oi l oj ok">kubectl get ns -L istio-injection</span></pre><p id="73a6" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">将标签<code class="fe nz oa ob oc b">istio-injection: enabled</code>添加到任何应该注入Istio sidecar的名称空间。</p><h2 id="a627" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">测试应用程序/快速入门</h2><p id="1f36" class="pw-post-body-paragraph na nb it lx b ly lz ju nc ma mb jx nd li ne nf ng lm nh ni nj lq nk nl nm mf im bi translated">现在等待命名空间<code class="fe nz oa ob oc b">kube-system</code>中的<code class="fe nz oa ob oc b">jxing-nginx-ingress-controller</code>分配一个外部IP。然后创建一个简单的python应用程序:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="0527" class="kz la it oc b gy oh oi l oj ok">jx create quickstart --project-name python-test</span></pre><p id="0dfb" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">选择<code class="fe nz oa ob oc b">python-http</code>作为类型。但是您可以选择任何内容，因为Canary部署适用于每种类型。尽管它应该提供简单的HTTP端点用于测试。</p><p id="4fa5" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">Jenkins X会自动为应用程序创建Github存储库。</p><p id="56c1" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">我修改了生成的<code class="fe nz oa ob oc b">app.py</code>中的<code class="fe nz oa ob oc b">do_GET</code>方法，以便返回文本而不是图像:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="d60e" class="kz la it oc b gy oh oi l oj ok">def do_GET(self):<br/>  self.send_response(200)<br/>  self.send_header('Content-type','text/html')<br/>  self.end_headers()<br/>  # Send the html message<br/>  output = 'v1'<br/>  self.wfile.write(output.encode('utf-8'))<br/>  return</span></pre><h2 id="a96d" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">环境</h2><p id="5ff3" class="pw-post-body-paragraph na nb it lx b ly lz ju nc ma mb jx nd li ne nf ng lm nh ni nj lq nk nl nm mf im bi translated">Jenkins X将默认创建三个环境(<code class="fe nz oa ob oc b">jx get env</code>):</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/988d45370f6622b2b24e968b24ada335.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*97adQKIGiuK2k3FBacy84Q.png"/></div></div></figure><p id="3f01" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">环境有自己的Git存储库，其中的一切都是通过GitOps配置的。环境实际上被配置为舵图，并通过一个<code class="fe nz oa ob oc b">requirements.yaml</code>引用安装在其中的所有应用程序+版本。</p><h1 id="29e4" class="mp la it bd lb mq mr ms le mt mu mv lh jz mw ka ll kc mx kd lp kf my kg lt mz bi translated">初始部署</h1><p id="09eb" class="pw-post-body-paragraph na nb it lx b ly lz ju nc ma mb jx nd li ne nf ng lm nh ni nj lq nk nl nm mf im bi translated">当创建新的快速启动应用程序或导入现有应用程序(<code class="fe nz oa ob oc b">jx import</code>)时，它将在暂存环境中作为版本<code class="fe nz oa ob oc b">0.0.1</code>发布。这是因为对于分段环境，PROMOTE设置为Auto。我们可以将此视为Jenkins X自动创建和合并的暂存存储库上的拉请求。我们可以看到所有渠道活动都在进行:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="f4ed" class="kz la it oc b gy oh oi l oj ok">jx get activities -w</span></pre><p id="dfa9" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">管道成功后，我们可以检查可用的应用程序:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="d9d2" class="kz la it oc b gy oh oi l oj ok">jx get applications</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/4fda533a8606ab7175ab54913c1d6852.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*car56FMJb-686CiX2Qk4xw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Jenkins X自动与Semver版本控制一起工作</figcaption></figure><p id="680d" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">目前，我们看到版本<code class="fe nz oa ob oc b">0.0.1</code>已经部署到staging，还没有投入生产。我们可以通过以下内容来证实这一点:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="f87f" class="kz la it oc b gy oh oi l oj ok">kubectl -n jx-staging get all       # shows the app<br/>kubectl -n jx-production get all    # shows nothing</span></pre><p id="f3bf" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">我们应该能够通过提供的URL打开访问分期应用程序:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/30735beb7f8a42001563f75c4a324523.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*btM5nlafhZDiLCixtdP9ag.png"/></div></div></figure><h2 id="cbe2" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">提升到生产</h2><p id="ed17" class="pw-post-body-paragraph na nb it lx b ly lz ju nc ma mb jx nd li ne nf ng lm nh ni nj lq nk nl nm mf im bi translated">(在投入生产之前，我引入了另一个变化，将版本推到了<code class="fe nz oa ob oc b">0.0.2</code>)</p><p id="b6a6" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">提升到生产环境，其中“提升”可视为“部署”。通过<code class="fe nz oa ob oc b">jx get env</code>我们可以看到生产需要人工提升，所以我们做:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="e13d" class="kz la it oc b gy oh oi l oj ok">jx promote --version 0.0.2 --env production</span></pre><p id="1144" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">这将在Jenkins X production Github存储库中自动创建一个Pull请求。现在<code class="fe nz oa ob oc b">jx get applications</code>将展示0.0.2版本的筹备和生产:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/7008fc95c8fe76e4cf8cd82a7c0ec9e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bk9l2FeXnCsPeUFylzMGtw.png"/></div></div></figure><p id="e282" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">我们还可以通过手动更改生产环境的repo中的<code class="fe nz oa ob oc b">requirements.yaml</code>文件来升级到生产环境。</p><h1 id="dd6b" class="mp la it bd lb mq mr ms le mt mu mv lh jz mw ka ll kc mx kd lp kf my kg lt mz bi translated">为生产环境启用Canary</h1><p id="dd63" class="pw-post-body-paragraph na nb it lx b ly lz ju nc ma mb jx nd li ne nf ng lm nh ni nj lq nk nl nm mf im bi translated">目前，生产或准备阶段的部署不是使用Canary完成的，而是通过Kubernetes滚动部署完成的。</p><p id="49eb" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">在我们的Python测试应用程序repo中，Jenkins X自动创建了舵图。如果我们打开文件<code class="fe nz oa ob oc b">charts/APP_NAME/values.yaml</code>,我们可以看到各种Flagger金丝雀选项:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="f124" class="kz la it oc b gy oh oi l oj ok"><em class="nq"># Canary deployments<br/># If enabled, Istio and Flagger need to be installed in the cluster<br/></em><strong class="oc iu">canary:<br/>  enabled: </strong>false<br/>  <strong class="oc iu">progressDeadlineSeconds: </strong>60<br/>  <strong class="oc iu">canaryAnalysis:<br/>    interval: </strong>"1m"<br/>    <strong class="oc iu">threshold: </strong>5<br/>    <strong class="oc iu">maxWeight: </strong>60<br/>    <strong class="oc iu">stepWeight: </strong>20<br/>    <em class="nq"># WARNING: Canary deployments will fail and rollback if there is no traffic that will generate the below specified metrics.<br/>    </em><strong class="oc iu">metrics:<br/>      requestSuccessRate:<br/>        threshold: </strong>99<br/>        <strong class="oc iu">interval: </strong>"1m"<br/>      <strong class="oc iu">requestDuration:<br/>        threshold: </strong>1000<br/>        <strong class="oc iu">interval: </strong>"1m"<br/>  <em class="nq"># The host is using Istio Gateway and is currently not auto-generated<br/>  # Please overwrite the `canary.host` in `values.yaml` in each environment repository (e.g., staging, production)<br/>  </em><strong class="oc iu">host: </strong>acme.com</span></pre><p id="8cae" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">使用上述设置，一个成功的Canary部署将需要大约3分钟，每个步骤1分钟:20%，40%，60%。</p><p id="db4c" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">尽管默认情况下金丝雀通过<code class="fe nz oa ob oc b">canary: enabled: false</code>被禁用。</p><p id="4723" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">我们可以在每个Jenkins X环境中覆盖这些值，我在生产报告<code class="fe nz oa ob oc b">environment-jenkinsx-production.</code>中就是这么做的。覆盖Python应用程序的值是可行的，因为环境存储库本身就是掌舵图，并通过<code class="fe nz oa ob oc b">requirements.yaml</code>引用所有部署的应用程序。我在回购<code class="fe nz oa ob oc b">environment-jenkinsx-production</code>中的<code class="fe nz oa ob oc b">env/values.yaml</code>中添加了以下内容:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="1a6f" class="kz la it oc b gy oh oi l oj ok"><strong class="oc iu">...</strong><br/><strong class="oc iu">jenkinsx-istio-canary-python-test:</strong><br/>  <strong class="oc iu">canary:</strong><br/>    <strong class="oc iu">enabled:</strong> true<br/>    <strong class="oc iu">host:</strong> jenkinsx-istio-canary-python-test.35.204.67.7.nip.io</span></pre><ul class=""><li id="ea5f" class="lv lw it lx b ly nr ma ns li oq lm or lq os mf ot mh mi mj bi translated">域<code class="fe nz oa ob oc b">xxx.IP_ADDRESS.nip.io</code>将简单地重定向到IP_ADDRESS。非常适合简单的域名测试</li><li id="c7a6" class="lv lw it lx b ly mk ma ml li mm lm mn lq mo mf ot mh mi mj bi translated"><code class="fe nz oa ob oc b">host:</code>将是Istio主机名，通过它可以接受请求。使用<code class="fe nz oa ob oc b">kubectl -n istio-system get svc</code>查找您的Istio网关外部IP地址。您需要确保在<code class="fe nz oa ob oc b">host:</code>下指定的域名重定向到Istio网关外部IP。</li></ul><p id="66a8" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">在生产环境repo中进行更改将自动触发Jenkins X中的构建，请检查:<code class="fe nz oa ob oc b">jx get activity</code></p><p id="19e2" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">等到所有活动都成功。我们现在应该看到自动创建的Istio VirtualService和Gateway:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="23e7" class="kz la it oc b gy oh oi l oj ok">kubectl -n jx-production get virtualservices.networking.istio.io,gateways.networking.istio.io</span></pre><blockquote class="nn no np"><p id="42ad" class="na nb nq lx b ly nr ju nc ma ns jx nd nt nu nf ng nv nw ni nj nx ny nl nm mf im bi translated">请注意，第一次升级时，它不会像金丝雀一样工作，因为它需要与以前的版本数据进行比较，但从第二次升级开始，它将会工作。(<a class="ae ky" href="https://jenkins-x.io/docs/managing-jx/tutorials/progressive-delivery/" rel="noopener ugc nofollow" target="_blank">来源</a>)</p></blockquote><p id="aa22" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">我们现在应该能够在指定的主机<code class="fe nz oa ob oc b">jenkinsx-istio-canary-python-test.35.204.67.7.nip.io</code>上通过Istio访问我们的生产应用程序:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/37ba826e5692eca6a0556215fac40076.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BMEbz-giGvuVOzAYW31i5Q.png"/></div></div></figure><h1 id="e631" class="mp la it bd lb mq mr ms le mt mu mv lh jz mw ka ll kc mx kd lp kf my kg lt mz bi translated">打开Flagger Grafana仪表板</h1><p id="4882" class="pw-post-body-paragraph na nb it lx b ly lz ju nc ma mb jx nd li ne nf ng lm nh ni nj lq nk nl nm mf im bi translated">Flagger将在<code class="fe nz oa ob oc b">istio-system</code>名称空间中安装Grafana，因此我们可以:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="1bdd" class="kz la it oc b gy oh oi l oj ok">kubectl port-forward -n istio-system service/flagger-grafana 3000:80<br/># admin:admin</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ov"><img src="../Images/7425304338cfc5adf4eca0f95bd716d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vY95I47XZqvudbvo0LIDyA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Flagger配有Grafana和仪表板</figcaption></figure><p id="bf49" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">在Grafana中，转到Istio仪表板并输入:</p><ul class=""><li id="96bf" class="lv lw it lx b ly nr ma ns li oq lm or lq os mf ot mh mi mj bi translated">命名空间:<code class="fe nz oa ob oc b">jx-production</code></li><li id="2e06" class="lv lw it lx b ly mk ma ml li mm lm mn lq mo mf ot mh mi mj bi translated">主要:<code class="fe nz oa ob oc b">jx-jenkinsx-istio-canary-python-test-primary</code></li><li id="fe58" class="lv lw it lx b ly mk ma ml li mm lm mn lq mo mf ot mh mi mj bi translated">金丝雀:<code class="fe nz oa ob oc b">jx-jenkinsx-istio-canary-python-test-canary</code></li></ul><p id="189a" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">primary和canary是服务的名称。这些是在部署期间启用Canary时自动创建的。</p><p id="9e5e" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">如果您缺少<code class="fe nz oa ob oc b">istio_requests_total</code>指标，请确保Istio安装正确，可以手动安装，而不是通过<code class="fe nz oa ob oc b">jx</code>安装。</p><h1 id="4d2b" class="mp la it bd lb mq mr ms le mt mu mv lh jz mw ka ll kc mx kd lp kf my kg lt mz bi translated">Flagger Canary工作流程和分析</h1><p id="68dc" class="pw-post-body-paragraph na nb it lx b ly lz ju nc ma mb jx nd li ne nf ng lm nh ni nj lq nk nl nm mf im bi translated">在Python应用程序的掌舵图中，我们有多个可以配置的设置(<a class="ae ky" href="https://docs.flagger.app/usage/progressive-delivery" rel="noopener ugc nofollow" target="_blank">查看此处</a>了解大多数设置的解释):</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="14cf" class="kz la it oc b gy oh oi l oj ok"><strong class="oc iu">canary:<br/>  enabled: </strong>false # false, but we set to true in prod env git repo<br/>  <strong class="oc iu">progressDeadlineSeconds: </strong>60<br/>  <strong class="oc iu">canaryAnalysis:<br/>    interval: </strong>"1m"<br/>    <strong class="oc iu">threshold: </strong>5<br/>    <strong class="oc iu">maxWeight: </strong>60<br/>    <strong class="oc iu">stepWeight: </strong>20<br/>    <em class="nq"># WARNING: Canary deployments will fail and rollback if there is no traffic that will generate the below specified metrics.<br/>    </em><strong class="oc iu">metrics:<br/>      requestSuccessRate:<br/>        threshold: </strong>99<br/>        <strong class="oc iu">interval: </strong>"1m"<br/>      <strong class="oc iu">requestDuration:<br/>        threshold: </strong>1000<br/>        <strong class="oc iu">interval: </strong>"1m"</span></pre><p id="6407" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">我们应该根据金丝雀的应用需求来调整这些。Flagger将执行自动指标分析，并且只有在满足要求的情况下才会继续部署。</p><p id="cdd6" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">要查看Canary部署的当前状态，请查看Flagger资源:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="e712" class="kz la it oc b gy oh oi l oj ok">kubectl -n jx-production get canaries.flagger.app</span></pre><h1 id="2b7b" class="mp la it bd lb mq mr ms le mt mu mv lh jz mw ka ll kc mx kd lp kf my kg lt mz bi translated">执行金丝雀部署</h1><h2 id="c9d3" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">部署变更</h2><p id="3fe3" class="pw-post-body-paragraph na nb it lx b ly lz ju nc ma mb jx nd li ne nf ng lm nh ni nj lq nk nl nm mf im bi translated">现在我们修改应用程序<code class="fe nz oa ob oc b">app.py</code>来返回不同的GET请求文本。在app repo中为master创建一个Pull请求并将其合并。Jenkins X会自动将其部署到暂存区。</p><p id="a27c" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">现在，将其手动升级到生产环境，拷贝正在登台运行的版本号。我现在是0.0.6，因为我在这之间做了一些改变。</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="230a" class="kz la it oc b gy oh oi l oj ok">jx promote --version 0.0.6 --env production</span></pre><p id="4f19" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">监控金丝雀状态:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="ec43" class="kz la it oc b gy oh oi l oj ok">kubectl -n jx-production get events --field-selector involvedObject.kind=Canary --sort-by='{.lastTimestamp}'</span></pre><h2 id="848c" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">金丝雀从重量20%开始</h2><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="15e0" class="kz la it oc b gy oh oi l oj ok">2m39s       Normal    Synced   Canary   Advance jx-jenkinsx-istio-canary-python-test.jx-production canary <strong class="oc iu">weight 20</strong></span></pre><p id="35e7" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">我们将生产Istio端点置于while循环中，这导致20%的请求到达新版本:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ow"><img src="../Images/6ced408e671746574ec0cbccca5bc278.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BeqO_if-crZ1xzzs03nzxA.png"/></div></div></figure><h2 id="08db" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">金丝雀失败(没有足够的流量)</h2><p id="1982" class="pw-post-body-paragraph na nb it lx b ly lz ju nc ma mb jx nd li ne nf ng lm nh ni nj lq nk nl nm mf im bi translated">我们需要确保足够的流量到达端点，否则Flagger的Canary分析将失败，并启动回滚:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ox"><img src="../Images/b65d23ffd39f8cb95aa8acab80ed90c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ruGDrwUU1_k_hHarACEPOg.png"/></div></div></figure><p id="9b4c" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">如果没有满足定义的需求，Canary也会失败。</p><h2 id="366e" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">金丝雀重量40%</h2><p id="859b" class="pw-post-body-paragraph na nb it lx b ly lz ju nc ma mb jx nd li ne nf ng lm nh ni nj lq nk nl nm mf im bi translated">如果有足够多的成功流量点击应用程序，Flagger将提高到40%:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="77ea" class="kz la it oc b gy oh oi l oj ok">108s        Normal    Synced   Canary   Advance jx-jenkinsx-istio-canary-python-test.jx-production canary <strong class="oc iu">weight 40</strong></span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oy"><img src="../Images/822e15e7ed75ade09e3e110cee8d5d93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PkhWU2nrzWXcU2yqldT6ig.png"/></div></div></figure><h2 id="4eed" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">金丝雀体重60%</h2><p id="321c" class="pw-post-body-paragraph na nb it lx b ly lz ju nc ma mb jx nd li ne nf ng lm nh ni nj lq nk nl nm mf im bi translated">如果有足够多的成功流量点击应用程序，Flagger将提高到60%:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="e827" class="kz la it oc b gy oh oi l oj ok">60s         Normal    Synced   Canary   Advance jx-jenkinsx-istio-canary-python-test.jx-production canary <strong class="oc iu">weight 60</strong></span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oz"><img src="../Images/b7a9f206576453264dbb7aec763e2c38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HR57bzs44hZjnQ-O0fohzw.png"/></div></div></figure><h2 id="6cd7" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">金丝雀的成功</h2><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="efdc" class="kz la it oc b gy oh oi l oj ok">25s         Normal    Synced   Canary   Routing all traffic to primary</span></pre><p id="2ef8" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">所有请求都命中新版本:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pa"><img src="../Images/1dc9e587cbf54c56da4e428f50825941.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GGrmfEtVxmPUnCIi9fyhWQ.png"/></div></div></figure><h1 id="6c84" class="mp la it bd lb mq mr ms le mt mu mv lh jz mw ka ll kc mx kd lp kf my kg lt mz bi translated">概述</h1><p id="ea92" class="pw-post-body-paragraph na nb it lx b ly lz ju nc ma mb jx nd li ne nf ng lm nh ni nj lq nk nl nm mf im bi translated">Jenkins X可以相对容易地配置为与Istio和Flagger一起运行，用于Canary部署。我在通过<code class="fe nz oa ob oc b">jx create addon istio</code>安装Istio时遇到了问题，不得不手动安装。</p><p id="1c26" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">我没有使用过Flagger配置，但是使用默认配置似乎很好。我认为，一旦人们对Jenkins X及其提议的工作流程有了更多的了解，就会减少大量的手工或重复性工作。</p><p id="8669" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">同样，如果没有Jenkins X，我认为Flagger和Istio对于Canary部署来说是一个强大的组合，我可能很快就会自己探索它。</p><h1 id="4ea0" class="mp la it bd lb mq mr ms le mt mu mv lh jz mw ka ll kc mx kd lp kf my kg lt mz bi translated">更多/来源</h1><p id="335a" class="pw-post-body-paragraph na nb it lx b ly lz ju nc ma mb jx nd li ne nf ng lm nh ni nj lq nk nl nm mf im bi translated"><a class="ae ky" href="https://jenkins-x.io/docs/managing-jx/tutorials/progressive-delivery/" rel="noopener ugc nofollow" target="_blank">https://Jenkins-x . io/docs/managing-JX/tutorials/progressive-delivery</a></p><p id="e73a" class="pw-post-body-paragraph na nb it lx b ly nr ju nc ma ns jx nd li nu nf ng lm nw ni nj lq ny nl nm mf im bi translated">https://docs.flagger.app/usage/progressive-delivery<a class="ae ky" href="https://docs.flagger.app/usage/progressive-delivery" rel="noopener ugc nofollow" target="_blank"/></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pb pc l"/></div></figure><h1 id="0639" class="mp la it bd lb mq mr ms le mt mu mv lh jz mw ka ll kc mx kd lp kf my kg lt mz bi translated">成为Kubernetes认证</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><a href="https://killer.sh"><div class="gh gi pd"><img src="../Images/cf3901a56841fcb55f9e4e17b9f07672.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Kbj17_6VncUuoBqNsAzzg.png"/></div></a><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://killer.sh" rel="noopener ugc nofollow" target="_blank"> https://killer.sh </a></figcaption></figure></div></div>    
</body>
</html>